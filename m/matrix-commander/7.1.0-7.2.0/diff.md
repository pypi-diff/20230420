# Comparing `tmp/matrix-commander-7.1.0.tar.gz` & `tmp/matrix-commander-7.2.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "matrix-commander-7.1.0.tar", last modified: Wed Apr 19 16:02:04 2023, max compression
+gzip compressed data, was "matrix-commander-7.2.0.tar", last modified: Thu Apr 20 11:30:29 2023, max compression
```

## Comparing `matrix-commander-7.1.0.tar` & `matrix-commander-7.2.0.tar`

### file list

```diff
@@ -1,21 +1,21 @@
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-19 16:02:04.712000 matrix-commander-7.1.0/
--rw-rw-r--   0 user      (1000) user      (1000)    35149 2022-05-22 12:47:05.000000 matrix-commander-7.1.0/LICENSE
--rw-rw-r--   0 user      (1000) user      (1000)       29 2022-05-29 22:34:19.000000 matrix-commander-7.1.0/MANIFEST.in
--rw-r--r--   0 user      (1000) user      (1000)   124887 2023-04-19 16:02:04.713000 matrix-commander-7.1.0/PKG-INFO
--rw-rw-r--   0 user      (1000) user      (1000)     2397 2022-12-11 20:36:11.000000 matrix-commander-7.1.0/PyPi-Instructions.md
--rw-r--r--   0 user      (1000) user      (1000)   121486 2023-04-19 16:01:12.000000 matrix-commander-7.1.0/README.md
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-19 16:02:04.710000 matrix-commander-7.1.0/matrix_commander/
--rw-rw-r--   0 user      (1000) user      (1000)       35 2022-05-26 15:24:28.000000 matrix-commander-7.1.0/matrix_commander/__init__.py
--rwxr-xr-x   0 user      (1000) user      (1000)     1409 2022-12-12 12:36:26.000000 matrix-commander-7.1.0/matrix_commander/matrix-commander-tui
--rwxr-xr-x   0 user      (1000) user      (1000)   356160 2023-04-19 16:01:35.000000 matrix-commander-7.1.0/matrix_commander/matrix_commander.py
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-19 16:02:04.711000 matrix-commander-7.1.0/matrix_commander.egg-info/
--rw-rw-r--   0 user      (1000) user      (1000)   124887 2023-04-19 16:02:04.000000 matrix-commander-7.1.0/matrix_commander.egg-info/PKG-INFO
--rw-rw-r--   0 user      (1000) user      (1000)      440 2023-04-19 16:02:04.000000 matrix-commander-7.1.0/matrix_commander.egg-info/SOURCES.txt
--rw-rw-r--   0 user      (1000) user      (1000)        1 2023-04-19 16:02:04.000000 matrix-commander-7.1.0/matrix_commander.egg-info/dependency_links.txt
--rw-rw-r--   0 user      (1000) user      (1000)       59 2023-04-19 16:02:04.000000 matrix-commander-7.1.0/matrix_commander.egg-info/entry_points.txt
--rw-rw-r--   0 user      (1000) user      (1000)      128 2023-04-19 16:02:04.000000 matrix-commander-7.1.0/matrix_commander.egg-info/requires.txt
--rw-rw-r--   0 user      (1000) user      (1000)       17 2023-04-19 16:02:04.000000 matrix-commander-7.1.0/matrix_commander.egg-info/top_level.txt
--rw-rw-r--   0 user      (1000) user      (1000)       85 2022-05-26 08:19:14.000000 matrix-commander-7.1.0/pyproject.toml
--rw-r--r--   0 user      (1000) user      (1000)     1379 2023-04-19 16:02:04.714000 matrix-commander-7.1.0/setup.cfg
-drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-19 16:02:04.712000 matrix-commander-7.1.0/tests/
--rwxrwxr-x   0 user      (1000) user      (1000)     2068 2022-10-15 11:32:09.000000 matrix-commander-7.1.0/tests/test-send.py
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-20 11:30:29.056000 matrix-commander-7.2.0/
+-rw-rw-r--   0 user      (1000) user      (1000)    35149 2022-05-22 12:47:05.000000 matrix-commander-7.2.0/LICENSE
+-rw-rw-r--   0 user      (1000) user      (1000)       29 2022-05-29 22:34:19.000000 matrix-commander-7.2.0/MANIFEST.in
+-rw-r--r--   0 user      (1000) user      (1000)   126033 2023-04-20 11:30:29.056000 matrix-commander-7.2.0/PKG-INFO
+-rw-rw-r--   0 user      (1000) user      (1000)     2397 2022-12-11 20:36:11.000000 matrix-commander-7.2.0/PyPi-Instructions.md
+-rw-r--r--   0 user      (1000) user      (1000)   122632 2023-04-20 11:29:58.000000 matrix-commander-7.2.0/README.md
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-20 11:30:29.049000 matrix-commander-7.2.0/matrix_commander/
+-rw-rw-r--   0 user      (1000) user      (1000)       35 2022-05-26 15:24:28.000000 matrix-commander-7.2.0/matrix_commander/__init__.py
+-rwxr-xr-x   0 user      (1000) user      (1000)     1409 2022-12-12 12:36:26.000000 matrix-commander-7.2.0/matrix_commander/matrix-commander-tui
+-rwxr-xr-x   0 user      (1000) user      (1000)   360846 2023-04-20 11:30:06.000000 matrix-commander-7.2.0/matrix_commander/matrix_commander.py
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-20 11:30:29.054000 matrix-commander-7.2.0/matrix_commander.egg-info/
+-rw-rw-r--   0 user      (1000) user      (1000)   126033 2023-04-20 11:30:29.000000 matrix-commander-7.2.0/matrix_commander.egg-info/PKG-INFO
+-rw-rw-r--   0 user      (1000) user      (1000)      440 2023-04-20 11:30:29.000000 matrix-commander-7.2.0/matrix_commander.egg-info/SOURCES.txt
+-rw-rw-r--   0 user      (1000) user      (1000)        1 2023-04-20 11:30:29.000000 matrix-commander-7.2.0/matrix_commander.egg-info/dependency_links.txt
+-rw-rw-r--   0 user      (1000) user      (1000)       59 2023-04-20 11:30:29.000000 matrix-commander-7.2.0/matrix_commander.egg-info/entry_points.txt
+-rw-rw-r--   0 user      (1000) user      (1000)      128 2023-04-20 11:30:29.000000 matrix-commander-7.2.0/matrix_commander.egg-info/requires.txt
+-rw-rw-r--   0 user      (1000) user      (1000)       17 2023-04-20 11:30:29.000000 matrix-commander-7.2.0/matrix_commander.egg-info/top_level.txt
+-rw-rw-r--   0 user      (1000) user      (1000)       85 2022-05-26 08:19:14.000000 matrix-commander-7.2.0/pyproject.toml
+-rw-r--r--   0 user      (1000) user      (1000)     1379 2023-04-20 11:30:29.057000 matrix-commander-7.2.0/setup.cfg
+drwxr-xr-x   0 user      (1000) user      (1000)        0 2023-04-20 11:30:29.054000 matrix-commander-7.2.0/tests/
+-rwxrwxr-x   0 user      (1000) user      (1000)     2068 2022-10-15 11:32:09.000000 matrix-commander-7.2.0/tests/test-send.py
```

### Comparing `matrix-commander-7.1.0/LICENSE` & `matrix-commander-7.2.0/LICENSE`

 * *Files identical despite different names*

### Comparing `matrix-commander-7.1.0/PKG-INFO` & `matrix-commander-7.2.0/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: matrix-commander
-Version: 7.1.0
+Version: 7.2.0
 Summary: A simple command-line Matrix client
 Home-page: https://github.com/8go/matrix-commander
 Author: 8go
 Project-URL: Bug Tracker, https://github.com/8go/matrix-commander/issues
 Project-URL: repository, https://github.com/8go/matrix-commander
 Keywords: Matrix,chat,messaging
 Classifier: Programming Language :: Python :: 3.8
@@ -261,14 +261,15 @@
 - Joining rooms
 - Leaving rooms
 - Forgetting rooms
 - Inviting other users to rooms
 - Banning from rooms
 - Unbanning from rooms
 - Kicking from rooms
+- Accepting room invites
 - Supports renaming of device
 - Supports getting and setting display name
 - Supports getting and setting presence
 - Uploading, downloading, and deleting to/from resource depository
 - Listing your devices
 - Listing discovery info
 - Listing available login methods supported by server
@@ -708,14 +709,19 @@
     --user '@user1:example.com' --password 'user1-password'
 $ # delete a message with event id 'someEventId'
 # matrix-commander --room-redact '!someroomId1:example.com' 'someEventId'
 $ # delete 2 images from 2 rooms
 $ matrix-commander --room-redact \
     '\!someroomId1:example.com' '\$someEventId1' 'Image deleted, obsolete info'
     '\!someroomId2:example.com' '\$someEventId2' 'Image deleted, outdated'
+$ # list room invitations
+$ matrix-commander --listen once --room-invites list
+$ # accepting room invitations, automatically joining rooms to which one is 
+$ # invited to
+$ matrix-commander --listen forever --room-invites list+join
 $ # print its own user id
 $ matrix-commander --whoami
 $ # skip SSL certificate verification for a homeserver without SSL
 $ matrix-commander --no-ssl -m "also working without Let's Encrypt SSL"
 $ # use your own SSL certificate for a homeserver with SSL and local certs
 $ matrix-commander --ssl-certificate mycert.crt -m "using my own cert"
 $ # download and decrypt media files like images, audio, PDF, etc.
@@ -1894,22 +1900,33 @@
                         listen' and '--tail'. All other arguments like '--get-
                         room-info' will print no output.
   --room-invites [LIST|JOIN|LIST+JOIN]
                         List room invitations and/or join invited rooms.
                         Details:: This option takes zero or one argument. If
                         no argument is given, 'list' is assumed which will
                         list all room invitation events as they are received.
-                        'join' will join the room(s) each time a room
-                        invitation is received. 'list+join' will do both, list
-                        the invitations as well as automatically join the
-                        rooms to which an invitation was received. This option
-                        only has effect if listening once or forever! So use '
-                        --listen once' or '--listen forever' together with
-                        this option. Don't confuse this option with --room-
-                        invite.
+                        Listing will print the room id and other information
+                        to standard output. 'join' will join the room(s) each
+                        time a room invitation is received. 'list+join' will
+                        do both, list the invitations as well as automatically
+                        join the rooms to which an invitation was received. '
+                        --room-invites' can be combined with '--listen'. If
+                        and only if '--listen forever' is used, will the
+                        program listen continuously for room invites. In all
+                        other cases, the program only looks for room
+                        invitation events once; and it does so before any
+                        possible listening to messages. Warning: events are
+                        usually delivered once. So, if you listen for and list
+                        invites you will get them and list them the first time
+                        you run '--room-invites list'. On the second run of '
+                        --room-invites list' the events will not be replayed
+                        and not be listed. Hence, if you list the invites, you
+                        might want to store the output (room id) so that you
+                        can join the room later with '--room-join' for
+                        example. Don't confuse this option with --room-invite.
   -v [PRINT|CHECK], -V [PRINT|CHECK], --version [PRINT|CHECK]
                         Print version information or check for updates.
                         Details:: This option takes zero or one argument. If
                         no argument is given, 'print' is assumed which will
                         print the version of the currently installed
                         'PROG_WITHOUT_EXT' package. 'check' is the
                         alternative. '{CHECK}' connects to https://pypi.org
@@ -1917,15 +1934,15 @@
                         There is no 'calling home' on every run, only a 'check
                         pypi.org' upon request. Your privacy is protected. The
                         new release is neither downloaded, nor installed. It
                         just informs you. After printing version information
                         the program will continue to run. This is useful for
                         having version number in the log files.
 
-You are running version 7.1.0 2023-04-19. Enjoy, star on Github and contribute
+You are running version 7.2.0 2023-04-20. Enjoy, star on Github and contribute
 by submitting a Pull Request. Also have a look at matrix-commander-tui.
 ```
 
 # Autocompletion
 
 Tab completion is provided for shells (e.g. bash), courtesy of @mizlan).
```

### Comparing `matrix-commander-7.1.0/PyPi-Instructions.md` & `matrix-commander-7.2.0/PyPi-Instructions.md`

 * *Files identical despite different names*

### Comparing `matrix-commander-7.1.0/README.md` & `matrix-commander-7.2.0/README.md`

 * *Files 1% similar despite different names*

```diff
@@ -193,14 +193,15 @@
 - Joining rooms
 - Leaving rooms
 - Forgetting rooms
 - Inviting other users to rooms
 - Banning from rooms
 - Unbanning from rooms
 - Kicking from rooms
+- Accepting room invites
 - Supports renaming of device
 - Supports getting and setting display name
 - Supports getting and setting presence
 - Uploading, downloading, and deleting to/from resource depository
 - Listing your devices
 - Listing discovery info
 - Listing available login methods supported by server
@@ -640,14 +641,19 @@
     --user '@user1:example.com' --password 'user1-password'
 $ # delete a message with event id 'someEventId'
 # matrix-commander --room-redact '!someroomId1:example.com' 'someEventId'
 $ # delete 2 images from 2 rooms
 $ matrix-commander --room-redact \
     '\!someroomId1:example.com' '\$someEventId1' 'Image deleted, obsolete info'
     '\!someroomId2:example.com' '\$someEventId2' 'Image deleted, outdated'
+$ # list room invitations
+$ matrix-commander --listen once --room-invites list
+$ # accepting room invitations, automatically joining rooms to which one is 
+$ # invited to
+$ matrix-commander --listen forever --room-invites list+join
 $ # print its own user id
 $ matrix-commander --whoami
 $ # skip SSL certificate verification for a homeserver without SSL
 $ matrix-commander --no-ssl -m "also working without Let's Encrypt SSL"
 $ # use your own SSL certificate for a homeserver with SSL and local certs
 $ matrix-commander --ssl-certificate mycert.crt -m "using my own cert"
 $ # download and decrypt media files like images, audio, PDF, etc.
@@ -1826,22 +1832,33 @@
                         listen' and '--tail'. All other arguments like '--get-
                         room-info' will print no output.
   --room-invites [LIST|JOIN|LIST+JOIN]
                         List room invitations and/or join invited rooms.
                         Details:: This option takes zero or one argument. If
                         no argument is given, 'list' is assumed which will
                         list all room invitation events as they are received.
-                        'join' will join the room(s) each time a room
-                        invitation is received. 'list+join' will do both, list
-                        the invitations as well as automatically join the
-                        rooms to which an invitation was received. This option
-                        only has effect if listening once or forever! So use '
-                        --listen once' or '--listen forever' together with
-                        this option. Don't confuse this option with --room-
-                        invite.
+                        Listing will print the room id and other information
+                        to standard output. 'join' will join the room(s) each
+                        time a room invitation is received. 'list+join' will
+                        do both, list the invitations as well as automatically
+                        join the rooms to which an invitation was received. '
+                        --room-invites' can be combined with '--listen'. If
+                        and only if '--listen forever' is used, will the
+                        program listen continuously for room invites. In all
+                        other cases, the program only looks for room
+                        invitation events once; and it does so before any
+                        possible listening to messages. Warning: events are
+                        usually delivered once. So, if you listen for and list
+                        invites you will get them and list them the first time
+                        you run '--room-invites list'. On the second run of '
+                        --room-invites list' the events will not be replayed
+                        and not be listed. Hence, if you list the invites, you
+                        might want to store the output (room id) so that you
+                        can join the room later with '--room-join' for
+                        example. Don't confuse this option with --room-invite.
   -v [PRINT|CHECK], -V [PRINT|CHECK], --version [PRINT|CHECK]
                         Print version information or check for updates.
                         Details:: This option takes zero or one argument. If
                         no argument is given, 'print' is assumed which will
                         print the version of the currently installed
                         'PROG_WITHOUT_EXT' package. 'check' is the
                         alternative. '{CHECK}' connects to https://pypi.org
@@ -1849,15 +1866,15 @@
                         There is no 'calling home' on every run, only a 'check
                         pypi.org' upon request. Your privacy is protected. The
                         new release is neither downloaded, nor installed. It
                         just informs you. After printing version information
                         the program will continue to run. This is useful for
                         having version number in the log files.
 
-You are running version 7.1.0 2023-04-19. Enjoy, star on Github and contribute
+You are running version 7.2.0 2023-04-20. Enjoy, star on Github and contribute
 by submitting a Pull Request. Also have a look at matrix-commander-tui.
 ```
 
 # Autocompletion
 
 Tab completion is provided for shells (e.g. bash), courtesy of @mizlan).
```

#### html2text {}

```diff
@@ -102,157 +102,157 @@
 sent messages - Supports creating private DM rooms (thanks to PR from
 @murlock1000) - Supports DM (direct messaging), sending DMs, listening for DMs
 - Listing of joined rooms - Listing of members of given room(s) - Receiving
 messages forever - Receiving messages once - Receiving last messages -
 Receiving or skipping its own messages - Receiving and downloading media files
 - including automatic decryption - Creating new rooms - Joining rooms - Leaving
 rooms - Forgetting rooms - Inviting other users to rooms - Banning from rooms -
-Unbanning from rooms - Kicking from rooms - Supports renaming of device -
-Supports getting and setting display name - Supports getting and setting
-presence - Uploading, downloading, and deleting to/from resource depository -
-Listing your devices - Listing discovery info - Listing available login methods
-supported by server - Supports skipping SSL verification to use HTTP instead of
-HTTPS - Supports providing local SSL certificate files - Supports notification
-via OS of received messages - Supports periodic execution via crontab -
-Supports room aliases - Supports multiple output formats like `text` (for human
-consumption) and `json` (for machine consumption and further processing) -
-Provides PID files - Logging (at various levels) - In-source documentation -
-Can be run as a service - Smart tab completion for shells like bash (thanks to
-PR from @mizlan :clap:) - TUI tool for building commands (`matrix-commander-
-tui`) - More than 90 options - More than 300 stars :stars: on Github - Easy
-installation, available through `pip`, i.e. available in [PyPi](https://
-pypi.org/project/matrix-commander/) store - Easy installation, available as
-docker image on [Docker Hub](https://hub.docker.com/r/matrixcommander/matrix-
-commander) (thanks to PR from @pataquets :clap:) - Easy installation, available
-in Nix repository as reproducible [Nix package](https://search.nixos.org/
-packages?query=matrix-commander) - Callable from the terminal, from shells like
-`bash`, etc. - Callable from Python programs via the entry point (function)
-`main`. - Open source - Free, GPL3+ license # First Run, Set Up, Credentials
-File, End-to-end Encryption On the first run `matrix-commander` must be
-executed with the `--login` argument and the corresponding secondary arguments.
-This creates a credentials.json file. The credentials.json file stores:
-homeserver, user id, access token, device id, and default room id. On the first
-run, the --login run, it asks some questions if not everything is provided by
-arguments, creates the token and device id and stores everything in the
-credentials.json file. If desired, all arguments can be provided via arguments
-to that log in can be performed fully in batch. Since the credentials file
-holds an access token it should be protected and secured. One can use different
-credential files for different users or different rooms. On creation the
-credentials file will by default be created in the local directory, so the
-users sees it right away. This is fine if you have only one or a few credential
-files, but for better maintainability it is suggested to place your credentials
-files into directory $HOME/.config/matrix-commander/. When the program looks
-for a credentials file it will first look in local directory and then as
-secondary choice it will look in directory $HOME/.config/matrix-commander/. If
-you want to re-use an existing device id and an existing access token, you can
-do so as well, just manually edit the credentials file. However, for end-to-end
-encryption this will NOT work. End-to-end encryption (e2ee) is enabled by
-default. It cannot be turned off. Wherever possible end-to-end encryption will
-be used. For e2ee to work efficiently a `store` directory is needed to store
-e2ee data persistently. The default location for the store directory is a local
-directory named `store`. Alternatively, as a secondary choice the program looks
-for a store directory in $HOME/.local/shared/matrix-commander/store/. The user
-can always specify a different location via the --store argument. The `store`
-directory will usually be created on the first run. For specific use cases end-
-to-end encryption can be disabled. Please see description of flag `--plain` for
-details. From the second time the program is run, and on all future runs it
-will use the homeserver, user id and access token found in the credentials file
-to log into the Matrix account. Now this program can be used to easily send
-simple text messages, images, and so forth to the just configured room. #
-Verification As second step after the `--login`, it is recommended to perform
-an emoji verification by running `--verify`. Verification is always
-interactive, because the emojis need to be confirmed via the keyboard. If
-desired `--login` and `--verify` can be done in the same first run. The program
-can accept verification request and verify other devices via emojis. See `--
-verify` in help for more details. # Room Operations, Actions on Rooms The
-program can create rooms, join, leave and forget rooms. It can also send
-invitations to join rooms to others (given that user has the appropriate
-permissions) as well as ban, unban and kick other users from rooms. # Sending
-Messages to send can be provided 1) in the command line (-m or --message) 2) as
-input from the keyboard (if there is no other input or command) 3) through a
-pipe from stdin (|), i.e. piped in from another program. For sending messages
-the program supports various text formats: 1) text: default 2) html: HTML
-formatted text 3) markdown: MarkDown formatted text 4) code: used a block of
-fixed-sized font, ideal for ASCII art or tables, bash outputs, etc. 5)
-notification 6) split: splits messages into multiple units at given pattern
-Photos and images that can be sent. That includes files like .jpg, .gif, .png
-or .svg. Arbitrary files like .txt, .pdf, .doc, audio files like .mp3 or video
-files like .mp4 can also be sent. Matrix events like sending an emoji reaction,
-replying as a thread, message edits can be sent. # Listening, Receiving One can
-listen to one or multiple rooms. Received messages will be displayed on the
-screen. If desired, optionally, you can be notified of incoming messages
-through the operating system standard notification system, usually a small pop-
-up window. Messages can be received or listened to various ways: 1) Forever:
-the program runs forever, listens forever, and prints all messages as they
-arrive in real-time. 2) Once: the program prints all the messages that are
-waiting in the queue, i.e. all messages that have been sent in, and after
-printing them the program terminates. 3) Tail: prints the last N read or unread
-messages of one or multiple specified rooms and after printing them the program
-terminates. When listening to messages you can also choose to download and
-decrypt media. Say, someone is sending a song. The mp3 file can be downloaded
-and automatically decrypted for you. # Dependencies and Installation - If you
-install via `pip`, then `pip` will take care of most of the dependencies. - See
-https://pypi.org/project/matrix-commander - Usually `pip install matrix-
-commander` will do the trick. - But, note that even if you install via `pip`
-you must have a) Python 3.8+ and b) `libolm` installed. See `PyPi-
-Instructions.md`. - Run `python -V` to get your Python version number and
-assure that it is 3.8+. - For e2ee support, python-olm is needed which requires
-the libolm C library (version 3.x). See also https://gitlab.matrix.org/matrix-
-org/olm. Make sure that version 3 is installed. Version 2 will not work. To
-install `libolm` do this: - On Debian, Ubuntu and Debian/Ubuntu derivative
-distributions: `sudo apt install libolm-dev` - On Fedora or Fedora derivative
-distributions do: `sudo dnf install libolm-devel` - On MacOS use brew: `brew
-install libolm` - For macOS Monterey 12.4 (21F79) (Apple M1 Pro) and similar
-please follow these steps for installation: - Install `libolm`, `dbus` and
-`libmagic` using Homebrew: - `brew install libolm dbus libmagic` - Install
-`matrix-commander` using this command: - `pip3 install --global-
-option=build_ext --global-option="-I/opt/homebrew/include/" --global-option="-
-L/opt/homebrew/lib/" matrix-commander` - For more details see Issue #79. Thanks
-to @KizzyCode for the contribution. - For macOS x86_64 and similar please
-follow these steps for installation: - `brew install libolm dbus libmagic` -
-`pip3 install poetry` - `pip3 install --global-option=build_ext --global-
-option="-I/usr/local/include/" --global-option="-L/usr/local/lib/" matrix-
-commander` - Notice that the Link and Include directories between ARM (M1,
-etc.) and x86-64 are different. So, check for example where file `olm.h` is
-located on your hard disk. That gives you a hint which Include directory to
-use. - For more details see Issue #103. Thanks to @johannes87 for the
-contribution. - If you install a docker image: `matrix-commander` is available
-on [Docker Hub](https://hub.docker.com/r/matrixcommander/matrix-commander) and
-hence easy to install as docker image (:clap: to @pataquets for his PR).
-Install via `docker pull matrixcommander/matrix-commander`. - If you install it
-via `git` or via file download then these are the dependencies that you must
-take care of: - Python 3.8 or higher installed (3.7 will NOT work) - libolm-dev
-must be installed as it is required by matrix-nio - libolm-dev on Debian/
-Ubuntu, libolm-devel on Fedora, libolm on MacOS - matrix-nio must be installed,
-see https://github.com/poljar/matrix-nio - pip3 install --user --upgrade
-matrix-nio[e2e] - python3 package markdown must be installed to support
-MarkDown format - pip3 install --user --upgrade markdown - python3 package
-emoji must be installed to support emojis in text messages - pip3 install --
-user --upgrade emoji - python3 package python_magic must be installed to
-support image sending - pip3 install --user --upgrade python_magic - if (and
-only if) you want OS notification support, then the python3 package notify2 and
-dbus-python should be installed - pip3 install --user --upgrade dbus-python #
-optional - pip3 install --user --upgrade notify2 # optional - python3 package
-urllib must be installed to support media download - pip3 install --user --
-upgrade urllib - python3 package pyxdg must be installed to support `XDG_*` env
-vars. Be careful. Multiple packages install in the same directory `xdg` and
-overwrite each other. These packages can be conflicting. Specifically, packages
-`pyxdg` and `xdg` collide. If you already have `xdg` installed you cannot just
-simply install `pyxdg`; in this case you should opt for a separate Python
-environment. - pip3 install --user --upgrade pyxdg - `matrix_commander/
-matrix_commander.py` file must be installed, and should have execution
-permissions - chmod 755 matrix_commander.py - `matrix_commander/matrix-
-commander` file is recommended for the install, and should have execution
-permissions - chmod 755 matrix-commander - for a full list or requirements look
-at the `requirements.txt` file - run `pip install -r requirements.txt` to
-automatically install all required Python packages - if you e.g. run on a
-headless server and don't want dbus-python and notify2, please remove the
-corresponding 2 lines from the `requirements.txt` file - Installing
-dependencies of `matrix-commander-tui` - `matrix-commander-tui` requires that
-you install `vipe` from the package `moreutils`. - Read https://
+Unbanning from rooms - Kicking from rooms - Accepting room invites - Supports
+renaming of device - Supports getting and setting display name - Supports
+getting and setting presence - Uploading, downloading, and deleting to/from
+resource depository - Listing your devices - Listing discovery info - Listing
+available login methods supported by server - Supports skipping SSL
+verification to use HTTP instead of HTTPS - Supports providing local SSL
+certificate files - Supports notification via OS of received messages -
+Supports periodic execution via crontab - Supports room aliases - Supports
+multiple output formats like `text` (for human consumption) and `json` (for
+machine consumption and further processing) - Provides PID files - Logging (at
+various levels) - In-source documentation - Can be run as a service - Smart tab
+completion for shells like bash (thanks to PR from @mizlan :clap:) - TUI tool
+for building commands (`matrix-commander-tui`) - More than 90 options - More
+than 300 stars :stars: on Github - Easy installation, available through `pip`,
+i.e. available in [PyPi](https://pypi.org/project/matrix-commander/) store -
+Easy installation, available as docker image on [Docker Hub](https://
+hub.docker.com/r/matrixcommander/matrix-commander) (thanks to PR from
+@pataquets :clap:) - Easy installation, available in Nix repository as
+reproducible [Nix package](https://search.nixos.org/packages?query=matrix-
+commander) - Callable from the terminal, from shells like `bash`, etc. -
+Callable from Python programs via the entry point (function) `main`. - Open
+source - Free, GPL3+ license # First Run, Set Up, Credentials File, End-to-end
+Encryption On the first run `matrix-commander` must be executed with the `--
+login` argument and the corresponding secondary arguments. This creates a
+credentials.json file. The credentials.json file stores: homeserver, user id,
+access token, device id, and default room id. On the first run, the --login
+run, it asks some questions if not everything is provided by arguments, creates
+the token and device id and stores everything in the credentials.json file. If
+desired, all arguments can be provided via arguments to that log in can be
+performed fully in batch. Since the credentials file holds an access token it
+should be protected and secured. One can use different credential files for
+different users or different rooms. On creation the credentials file will by
+default be created in the local directory, so the users sees it right away.
+This is fine if you have only one or a few credential files, but for better
+maintainability it is suggested to place your credentials files into directory
+$HOME/.config/matrix-commander/. When the program looks for a credentials file
+it will first look in local directory and then as secondary choice it will look
+in directory $HOME/.config/matrix-commander/. If you want to re-use an existing
+device id and an existing access token, you can do so as well, just manually
+edit the credentials file. However, for end-to-end encryption this will NOT
+work. End-to-end encryption (e2ee) is enabled by default. It cannot be turned
+off. Wherever possible end-to-end encryption will be used. For e2ee to work
+efficiently a `store` directory is needed to store e2ee data persistently. The
+default location for the store directory is a local directory named `store`.
+Alternatively, as a secondary choice the program looks for a store directory in
+$HOME/.local/shared/matrix-commander/store/. The user can always specify a
+different location via the --store argument. The `store` directory will usually
+be created on the first run. For specific use cases end-to-end encryption can
+be disabled. Please see description of flag `--plain` for details. From the
+second time the program is run, and on all future runs it will use the
+homeserver, user id and access token found in the credentials file to log into
+the Matrix account. Now this program can be used to easily send simple text
+messages, images, and so forth to the just configured room. # Verification As
+second step after the `--login`, it is recommended to perform an emoji
+verification by running `--verify`. Verification is always interactive, because
+the emojis need to be confirmed via the keyboard. If desired `--login` and `--
+verify` can be done in the same first run. The program can accept verification
+request and verify other devices via emojis. See `--verify` in help for more
+details. # Room Operations, Actions on Rooms The program can create rooms,
+join, leave and forget rooms. It can also send invitations to join rooms to
+others (given that user has the appropriate permissions) as well as ban, unban
+and kick other users from rooms. # Sending Messages to send can be provided 1)
+in the command line (-m or --message) 2) as input from the keyboard (if there
+is no other input or command) 3) through a pipe from stdin (|), i.e. piped in
+from another program. For sending messages the program supports various text
+formats: 1) text: default 2) html: HTML formatted text 3) markdown: MarkDown
+formatted text 4) code: used a block of fixed-sized font, ideal for ASCII art
+or tables, bash outputs, etc. 5) notification 6) split: splits messages into
+multiple units at given pattern Photos and images that can be sent. That
+includes files like .jpg, .gif, .png or .svg. Arbitrary files like .txt, .pdf,
+.doc, audio files like .mp3 or video files like .mp4 can also be sent. Matrix
+events like sending an emoji reaction, replying as a thread, message edits can
+be sent. # Listening, Receiving One can listen to one or multiple rooms.
+Received messages will be displayed on the screen. If desired, optionally, you
+can be notified of incoming messages through the operating system standard
+notification system, usually a small pop-up window. Messages can be received or
+listened to various ways: 1) Forever: the program runs forever, listens
+forever, and prints all messages as they arrive in real-time. 2) Once: the
+program prints all the messages that are waiting in the queue, i.e. all
+messages that have been sent in, and after printing them the program
+terminates. 3) Tail: prints the last N read or unread messages of one or
+multiple specified rooms and after printing them the program terminates. When
+listening to messages you can also choose to download and decrypt media. Say,
+someone is sending a song. The mp3 file can be downloaded and automatically
+decrypted for you. # Dependencies and Installation - If you install via `pip`,
+then `pip` will take care of most of the dependencies. - See https://pypi.org/
+project/matrix-commander - Usually `pip install matrix-commander` will do the
+trick. - But, note that even if you install via `pip` you must have a) Python
+3.8+ and b) `libolm` installed. See `PyPi-Instructions.md`. - Run `python -V`
+to get your Python version number and assure that it is 3.8+. - For e2ee
+support, python-olm is needed which requires the libolm C library (version
+3.x). See also https://gitlab.matrix.org/matrix-org/olm. Make sure that version
+3 is installed. Version 2 will not work. To install `libolm` do this: - On
+Debian, Ubuntu and Debian/Ubuntu derivative distributions: `sudo apt install
+libolm-dev` - On Fedora or Fedora derivative distributions do: `sudo dnf
+install libolm-devel` - On MacOS use brew: `brew install libolm` - For macOS
+Monterey 12.4 (21F79) (Apple M1 Pro) and similar please follow these steps for
+installation: - Install `libolm`, `dbus` and `libmagic` using Homebrew: - `brew
+install libolm dbus libmagic` - Install `matrix-commander` using this command:
+- `pip3 install --global-option=build_ext --global-option="-I/opt/homebrew/
+include/" --global-option="-L/opt/homebrew/lib/" matrix-commander` - For more
+details see Issue #79. Thanks to @KizzyCode for the contribution. - For macOS
+x86_64 and similar please follow these steps for installation: - `brew install
+libolm dbus libmagic` - `pip3 install poetry` - `pip3 install --global-
+option=build_ext --global-option="-I/usr/local/include/" --global-option="-L/
+usr/local/lib/" matrix-commander` - Notice that the Link and Include
+directories between ARM (M1, etc.) and x86-64 are different. So, check for
+example where file `olm.h` is located on your hard disk. That gives you a hint
+which Include directory to use. - For more details see Issue #103. Thanks to
+@johannes87 for the contribution. - If you install a docker image: `matrix-
+commander` is available on [Docker Hub](https://hub.docker.com/r/
+matrixcommander/matrix-commander) and hence easy to install as docker image (:
+clap: to @pataquets for his PR). Install via `docker pull matrixcommander/
+matrix-commander`. - If you install it via `git` or via file download then
+these are the dependencies that you must take care of: - Python 3.8 or higher
+installed (3.7 will NOT work) - libolm-dev must be installed as it is required
+by matrix-nio - libolm-dev on Debian/Ubuntu, libolm-devel on Fedora, libolm on
+MacOS - matrix-nio must be installed, see https://github.com/poljar/matrix-nio
+- pip3 install --user --upgrade matrix-nio[e2e] - python3 package markdown must
+be installed to support MarkDown format - pip3 install --user --upgrade
+markdown - python3 package emoji must be installed to support emojis in text
+messages - pip3 install --user --upgrade emoji - python3 package python_magic
+must be installed to support image sending - pip3 install --user --upgrade
+python_magic - if (and only if) you want OS notification support, then the
+python3 package notify2 and dbus-python should be installed - pip3 install --
+user --upgrade dbus-python # optional - pip3 install --user --upgrade notify2 #
+optional - python3 package urllib must be installed to support media download -
+pip3 install --user --upgrade urllib - python3 package pyxdg must be installed
+to support `XDG_*` env vars. Be careful. Multiple packages install in the same
+directory `xdg` and overwrite each other. These packages can be conflicting.
+Specifically, packages `pyxdg` and `xdg` collide. If you already have `xdg`
+installed you cannot just simply install `pyxdg`; in this case you should opt
+for a separate Python environment. - pip3 install --user --upgrade pyxdg -
+`matrix_commander/matrix_commander.py` file must be installed, and should have
+execution permissions - chmod 755 matrix_commander.py - `matrix_commander/
+matrix-commander` file is recommended for the install, and should have
+execution permissions - chmod 755 matrix-commander - for a full list or
+requirements look at the `requirements.txt` file - run `pip install -
+r requirements.txt` to automatically install all required Python packages - if
+you e.g. run on a headless server and don't want dbus-python and notify2,
+please remove the corresponding 2 lines from the `requirements.txt` file -
+Installing dependencies of `matrix-commander-tui` - `matrix-commander-tui`
+requires that you install `vipe` from the package `moreutils`. - Read https://
 www.putorius.net/moreutils.html for installation instructions. - As an
 alternative you could also install `vipe.sh` from https://github.com/0mp/
 vipe.sh/blob/master/vipe.sh. - `matrix-commander-tui` requires that you install
 `fzf`. - Read https://github.com/junegunn/fzf#installation for installation
 instructions. # Documentation and Resources - There are 4 level of details for
 the documentation. In sorted order from short summary to long details: - Just
 the options, no explanation: `matrix-commander --usage` or [online](https://
@@ -393,16 +393,19 @@
 '\!someroomId2:example.com' $ matrix-commander --delete-device "QBUAZIFURK" --
 password 'mc-password' $ matrix-commander --delete-device "QBUAZIFURK"
 "AUIECTSRND" \ --user '@user1:example.com' --password 'user1-password' $ #
 delete a message with event id 'someEventId' # matrix-commander --room-redact
 '!someroomId1:example.com' 'someEventId' $ # delete 2 images from 2 rooms $
 matrix-commander --room-redact \ '\!someroomId1:example.com' '\$someEventId1'
 'Image deleted, obsolete info' '\!someroomId2:example.com' '\$someEventId2'
-'Image deleted, outdated' $ # print its own user id $ matrix-commander --whoami
-$ # skip SSL certificate verification for a homeserver without SSL $ matrix-
+'Image deleted, outdated' $ # list room invitations $ matrix-commander --listen
+once --room-invites list $ # accepting room invitations, automatically joining
+rooms to which one is $ # invited to $ matrix-commander --listen forever --
+room-invites list+join $ # print its own user id $ matrix-commander --whoami $
+# skip SSL certificate verification for a homeserver without SSL $ matrix-
 commander --no-ssl -m "also working without Let's Encrypt SSL" $ # use your own
 SSL certificate for a homeserver with SSL and local certs $ matrix-commander --
 ssl-certificate mycert.crt -m "using my own cert" $ # download and decrypt
 media files like images, audio, PDF, etc. $ # and store downloaded files in
 directory "mymedia" $ matrix-commander --listen forever --listen-self --
 download-media mymedia $ # create rooms without name and topic, just with
 alias, use a simple alias $ matrix-commander --room-create roomAlias1 $ # don't
@@ -1170,33 +1173,41 @@
 provide data exactly as in the Matrix Specification. If no data is available
 that corresponds exactly with the Matrix Specification, no data will be
 printed. In short, currently '--json-spec' only provides outputs for '-
 - listen' and '--tail'. All other arguments like '--get- room-info' will print
 no output. --room-invites [LIST|JOIN|LIST+JOIN] List room invitations and/or
 join invited rooms. Details:: This option takes zero or one argument. If no
 argument is given, 'list' is assumed which will list all room invitation events
-as they are received. 'join' will join the room(s) each time a room invitation
-is received. 'list+join' will do both, list the invitations as well as
-automatically join the rooms to which an invitation was received. This option
-only has effect if listening once or forever! So use ' --listen once' or '--
-listen forever' together with this option. Don't confuse this option with --
-room- invite. -v [PRINT|CHECK], -V [PRINT|CHECK], --version [PRINT|CHECK] Print
-version information or check for updates. Details:: This option takes zero or
-one argument. If no argument is given, 'print' is assumed which will print the
-version of the currently installed 'PROG_WITHOUT_EXT' package. 'check' is the
-alternative. '{CHECK}' connects to https://pypi.org and gets the version number
-of latest stable release. There is no 'calling home' on every run, only a
-'check pypi.org' upon request. Your privacy is protected. The new release is
-neither downloaded, nor installed. It just informs you. After printing version
-information the program will continue to run. This is useful for having version
-number in the log files. You are running version 7.1.0 2023-04-19. Enjoy, star
-on Github and contribute by submitting a Pull Request. Also have a look at
-matrix-commander-tui. ``` # Autocompletion Tab completion is provided for
-shells (e.g. bash), courtesy of @mizlan). Here is a sample snapshot of tab
-completion in action: ![tab completion screenshot](screenshots/
+as they are received. Listing will print the room id and other information to
+standard output. 'join' will join the room(s) each time a room invitation is
+received. 'list+join' will do both, list the invitations as well as
+automatically join the rooms to which an invitation was received. ' --room-
+invites' can be combined with '--listen'. If and only if '--listen forever' is
+used, will the program listen continuously for room invites. In all other
+cases, the program only looks for room invitation events once; and it does so
+before any possible listening to messages. Warning: events are usually
+delivered once. So, if you listen for and list invites you will get them and
+list them the first time you run '--room-invites list'. On the second run of '
+--room-invites list' the events will not be replayed and not be listed. Hence,
+if you list the invites, you might want to store the output (room id) so that
+you can join the room later with '--room-join' for example. Don't confuse this
+option with --room-invite. -v [PRINT|CHECK], -V [PRINT|CHECK], --version
+[PRINT|CHECK] Print version information or check for updates. Details:: This
+option takes zero or one argument. If no argument is given, 'print' is assumed
+which will print the version of the currently installed 'PROG_WITHOUT_EXT'
+package. 'check' is the alternative. '{CHECK}' connects to https://pypi.org and
+gets the version number of latest stable release. There is no 'calling home' on
+every run, only a 'check pypi.org' upon request. Your privacy is protected. The
+new release is neither downloaded, nor installed. It just informs you. After
+printing version information the program will continue to run. This is useful
+for having version number in the log files. You are running version 7.2.0 2023-
+04-20. Enjoy, star on Github and contribute by submitting a Pull Request. Also
+have a look at matrix-commander-tui. ``` # Autocompletion Tab completion is
+provided for shells (e.g. bash), courtesy of @mizlan). Here is a sample
+snapshot of tab completion in action: ![tab completion screenshot](screenshots/
 tab_complete.png) # Performance and Speed - `matrix-commander` is written in
 Python and hence rather on the slow side - It is not thread-safe. One cannot
 just simply run multiple instances at the same time. However, with very careful
 set-up one can run multiple instances, but that is not the target use case. See
 [Issue #31](https://github.com/8go/matrix-commander/issues/31). - Where
 possible bundle several actions together into a single call. For example if one
 wants to send 8 images, then it is significantly faster to call `matrix-
```

### Comparing `matrix-commander-7.1.0/matrix_commander/matrix-commander-tui` & `matrix-commander-7.2.0/matrix_commander/matrix-commander-tui`

 * *Files identical despite different names*

### Comparing `matrix-commander-7.1.0/matrix_commander/matrix_commander.py` & `matrix-commander-7.2.0/matrix_commander/matrix_commander.py`

 * *Files 2% similar despite different names*

```diff
@@ -206,16 +206,16 @@
 00000cd0: 6b65 6e45 7272 6f72 0a0a 2020 2020 4841  kenError..    HA
 00000ce0: 5645 5f4f 5045 4e49 4420 3d20 5472 7565  VE_OPENID = True
 00000cf0: 0a65 7863 6570 7420 496d 706f 7274 4572  .except ImportEr
 00000d00: 726f 723a 0a20 2020 2048 4156 455f 4f50  ror:.    HAVE_OP
 00000d10: 454e 4944 203d 2046 616c 7365 0a0a 2320  ENID = False..# 
 00000d20: 7665 7273 696f 6e20 6e75 6d62 6572 0a56  version number.V
 00000d30: 4552 5349 4f4e 203d 2022 3230 3233 2d30  ERSION = "2023-0
-00000d40: 342d 3139 220a 5645 5253 494f 4e4e 5220  4-19".VERSIONNR 
-00000d50: 3d20 2237 2e31 2e30 220a 2320 6d61 7472  = "7.1.0".# matr
+00000d40: 342d 3230 220a 5645 5253 494f 4e4e 5220  4-20".VERSIONNR 
+00000d50: 3d20 2237 2e32 2e30 220a 2320 6d61 7472  = "7.2.0".# matr
 00000d60: 6978 2d63 6f6d 6d61 6e64 6572 3b20 666f  ix-commander; fo
 00000d70: 7220 6261 636b 7761 7264 7320 636f 6d70  r backwards comp
 00000d80: 6974 6162 696c 6974 7920 7265 706c 6163  itability replac
 00000d90: 6520 5f20 7769 7468 202d 0a50 524f 475f  e _ with -.PROG_
 00000da0: 5749 5448 4f55 545f 4558 5420 3d20 6f73  WITHOUT_EXT = os
 00000db0: 2e70 6174 682e 7370 6c69 7465 7874 286f  .path.splitext(o
 00000dc0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
@@ -1241,21020 +1241,21313 @@
 00004d80: 6469 7374 7269 6275 7469 6f6e 2822 6d61  distribution("ma
 00004d90: 7472 6978 2d6e 696f 2229 2e76 6572 7369  trix-nio").versi
 00004da0: 6f6e 0a20 2020 2023 2076 6572 7369 6f6e  on.    # version
 00004db0: 2069 6e63 6f6d 7061 7469 6269 6c69 7479   incompatibility
 00004dc0: 2062 6574 7765 656e 206d 6174 7269 782d   between matrix-
 00004dd0: 6e69 6f20 302e 3139 2e30 2061 6e64 2030  nio 0.19.0 and 0
 00004de0: 2e32 302b 0a20 2020 2023 2068 7474 7073  .20+.    # https
-00004df0: 3a2f 2f6d 7472 782e 7379 7465 732e 6e65  ://mtrx.sytes.ne
-00004e00: 742f 4f49 756b 4b42 5555 7050 7341 6242  t/OIukKBUUpPsAbB
-00004e10: 4742 7875 4b56 4945 6f0a 2020 2020 2320  GBxuKVIEo.    # 
-00004e20: 7365 7276 6572 5f6e 616d 6520 3d20 226d  server_name = "m
-00004e30: 7472 782e 7379 7465 732e 6e65 7422 0a20  trx.sytes.net". 
-00004e40: 2020 2023 206d 6564 6961 5f69 6420 3d20     # media_id = 
-00004e50: 224f 4975 6b4b 4255 5570 5073 4162 4245  "OIukKBUUpPsAbBE
-00004e60: 4742 7875 4b56 4945 6f22 0a20 2020 2023  GBxuKVIEo".    #
-00004e70: 206d 6174 7269 782d 6e69 6f20 7630 2e31   matrix-nio v0.1
-00004e80: 392e 3020 6861 733a 2064 6f77 6e6c 6f61  9.0 has: downloa
-00004e90: 6428 7365 7276 6572 5f6e 616d 653a 2073  d(server_name: s
-00004ea0: 7472 2c20 6d65 6469 615f 6964 3a20 7374  tr, media_id: st
-00004eb0: 722c 202e 2e29 0a20 2020 2023 2063 6f6e  r, ..).    # con
-00004ec0: 7665 7274 206d 7863 2074 6f20 7365 7276  vert mxc to serv
-00004ed0: 6572 5f6e 616d 6520 616e 6420 6d65 6469  er_name and medi
-00004ee0: 615f 6964 0a20 2020 2023 2076 302e 3230  a_id.    # v0.20
-00004ef0: 2b20 3a20 7265 7370 203d 2061 7761 6974  + : resp = await
-00004f00: 2063 6c69 656e 742e 646f 776e 6c6f 6164   client.download
-00004f10: 286d 7863 3d6d 7863 2c20 6669 6c65 6e61  (mxc=mxc, filena
-00004f20: 6d65 3d66 696c 656e 616d 6529 0a20 2020  me=filename).   
-00004f30: 2023 2076 302e 3139 2d20 3a20 7265 7370   # v0.19- : resp
-00004f40: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00004f50: 646f 776e 6c6f 6164 280a 2020 2020 2320  download(.    # 
-00004f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f70: 2020 2020 7365 7276 6572 5f6e 616d 653d      server_name=
-00004f80: 7365 7276 6572 5f6e 616d 652c 206d 6564  server_name, med
-00004f90: 6961 5f69 643d 6d65 6469 615f 6964 2c0a  ia_id=media_id,.
-00004fa0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-00004fb0: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-00004fc0: 6d65 3d66 696c 656e 616d 6529 0a20 2020  me=filename).   
-00004fd0: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-00004fe0: 646f 776e 6c6f 6164 5f6d 7863 2069 6e70  download_mxc inp
-00004ff0: 7574 206d 7863 2069 7320 7b6d 7863 7d2e  ut mxc is {mxc}.
-00005000: 2229 0a20 2020 2069 6620 6e69 6f5f 7665  ").    if nio_ve
-00005010: 7273 696f 6e2e 7374 6172 7473 7769 7468  rsion.startswith
-00005020: 2822 302e 3122 293a 2020 2320 6c69 6b65  ("0.1"):  # like
-00005030: 2030 2e31 390a 2020 2020 2020 2020 6773   0.19.        gs
-00005040: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
-00005050: 2020 2020 2020 2066 2259 6f75 2061 7265         f"You are
-00005060: 2072 756e 6e69 6e67 206d 6174 7269 782d   running matrix-
-00005070: 6e69 6f20 7665 7273 696f 6e20 7b6e 696f  nio version {nio
-00005080: 5f76 6572 7369 6f6e 7d2e 2022 0a20 2020  _version}. ".   
-00005090: 2020 2020 2020 2020 2022 596f 7520 7368           "You sh
-000050a0: 6f75 6c64 2062 6520 7275 6e6e 696e 6720  ould be running 
-000050b0: 7665 7273 696f 6e20 302e 3230 2b2e 2055  version 0.20+. U
-000050c0: 7064 6174 6520 6966 206e 6563 6573 7361  pdate if necessa
-000050d0: 7279 2e20 220a 2020 2020 2020 2020 290a  ry. ".        ).
-000050e0: 2020 2020 2020 2020 7572 6c20 3d20 7572          url = ur
-000050f0: 6c70 6172 7365 286d 7863 290a 2020 2020  lparse(mxc).    
-00005100: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00005110: 2866 2264 6f77 6e6c 6f61 645f 6d78 6320  (f"download_mxc 
-00005120: 696e 7075 7420 7572 6c20 6973 207b 7572  input url is {ur
-00005130: 6c7d 2e22 290a 2020 2020 2020 2020 7265  l}.").        re
-00005140: 7370 6f6e 7365 203d 2061 7761 6974 2063  sponse = await c
-00005150: 6c69 656e 742e 646f 776e 6c6f 6164 280a  lient.download(.
-00005160: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-00005170: 6572 5f6e 616d 653d 7572 6c2e 6e65 746c  er_name=url.netl
-00005180: 6f63 2c0a 2020 2020 2020 2020 2020 2020  oc,.            
-00005190: 6d65 6469 615f 6964 3d75 726c 2e70 6174  media_id=url.pat
-000051a0: 682e 7374 7269 7028 222f 2229 2c0a 2020  h.strip("/"),.  
-000051b0: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-000051c0: 6d65 3d66 696c 656e 616d 652c 0a20 2020  me=filename,.   
-000051d0: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
-000051e0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-000051f0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00005200: 2020 2066 2259 6f75 2061 7265 2072 756e     f"You are run
-00005210: 6e69 6e67 206d 6174 7269 782d 6e69 6f20  ning matrix-nio 
-00005220: 7665 7273 696f 6e20 7b6e 696f 5f76 6572  version {nio_ver
-00005230: 7369 6f6e 7d2e 2047 7265 6174 2122 0a20  sion}. Great!". 
-00005240: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00005250: 2072 6573 706f 6e73 6520 3d20 6177 6169   response = awai
-00005260: 7420 636c 6965 6e74 2e64 6f77 6e6c 6f61  t client.downloa
-00005270: 6428 6d78 633d 6d78 632c 2066 696c 656e  d(mxc=mxc, filen
-00005280: 616d 653d 6669 6c65 6e61 6d65 290a 2020  ame=filename).  
-00005290: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-000052a0: 2264 6f77 6e6c 6f61 645f 6d78 6320 7265  "download_mxc re
-000052b0: 7370 6f6e 7365 2069 7320 7b72 6573 706f  sponse is {respo
-000052c0: 6e73 657d 2e22 290a 2020 2020 7265 7475  nse}.").    retu
-000052d0: 726e 2072 6573 706f 6e73 650a 0a0a 636c  rn response...cl
-000052e0: 6173 7320 4361 6c6c 6261 636b 7328 6f62  ass Callbacks(ob
-000052f0: 6a65 6374 293a 0a20 2020 2022 2222 436c  ject):.    """Cl
-00005300: 6173 7320 746f 2070 6173 7320 636c 6965  ass to pass clie
-00005310: 6e74 2074 6f20 6361 6c6c 6261 636b 206d  nt to callback m
-00005320: 6574 686f 6473 2e22 2222 0a0a 2020 2020  ethods."""..    
-00005330: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00005340: 662c 2063 6c69 656e 7429 3a0a 2020 2020  f, client):.    
-00005350: 2020 2020 2222 2253 746f 7265 2041 7379      """Store Asy
-00005360: 6e63 436c 6965 6e74 2e22 2222 0a20 2020  ncClient.""".   
-00005370: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00005380: 203d 2063 6c69 656e 740a 0a20 2020 2061   = client..    a
-00005390: 7379 6e63 2064 6566 2069 6e76 6974 655f  sync def invite_
-000053a0: 6361 6c6c 6261 636b 2873 656c 662c 2072  callback(self, r
-000053b0: 6f6f 6d2c 2065 7665 6e74 293a 0a20 2020  oom, event):.   
-000053c0: 2020 2020 2022 2222 4861 6e64 6c65 2061       """Handle a
-000053d0: 6e20 696e 636f 6d69 6e67 2069 6e76 6974  n incoming invit
-000053e0: 6520 6576 656e 742e 0a0a 2020 2020 2020  e event...      
-000053f0: 2020 4966 2061 6e20 696e 7669 7465 2069    If an invite i
-00005400: 7320 7265 6365 6976 6564 2c20 7468 656e  s received, then
-00005410: 206c 6973 7420 6f72 206a 6f69 6e20 7468   list or join th
-00005420: 6520 726f 6f6d 2073 7065 6369 6669 6564  e room specified
-00005430: 0a20 2020 2020 2020 2069 6e20 7468 6520  .        in the 
-00005440: 696e 7669 7465 2e0a 2020 2020 2020 2020  invite..        
-00005450: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00005460: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00005470: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00005480: 2020 2020 2020 2020 2020 2066 226d 6573             f"mes
-00005490: 7361 6765 5f63 616c 6c62 6163 6b28 293a  sage_callback():
-000054a0: 2066 6f72 2072 6f6f 6d20 7b72 6f6f 6d7d   for room {room}
-000054b0: 2072 6563 6569 7665 6420 7468 6973 2022   received this "
-000054c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000054d0: 2066 2265 7665 6e74 3a20 7479 7065 3a20   f"event: type: 
-000054e0: 7b74 7970 6528 6576 656e 7429 7d2c 2022  {type(event)}, "
-000054f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005500: 2066 2265 7665 6e74 3a20 7b65 7665 6e74   f"event: {event
-00005510: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00005520: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00005530: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00005540: 2020 2020 2020 2020 2020 2066 2247 6f74             f"Got
-00005550: 2069 6e76 6974 6520 746f 2072 6f6f 6d20   invite to room 
-00005560: 7b72 6f6f 6d2e 726f 6f6d 5f69 647d 2066  {room.room_id} f
-00005570: 726f 6d20 7b65 7665 6e74 2e73 656e 6465  rom {event.sende
-00005580: 727d 2e22 0a20 2020 2020 2020 2020 2020  r}.".           
-00005590: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-000055a0: 2320 6c69 7374 0a20 2020 2020 2020 2020  # list.         
-000055b0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-000055c0: 2020 2020 2020 2020 6773 2e70 612e 726f          gs.pa.ro
-000055d0: 6f6d 5f69 6e76 6974 6573 2e6c 6f77 6572  om_invites.lower
-000055e0: 2829 203d 3d20 494e 5649 5445 535f 4c49  () == INVITES_LI
-000055f0: 5354 0a20 2020 2020 2020 2020 2020 2020  ST.             
-00005600: 2020 206f 7220 6773 2e70 612e 726f 6f6d     or gs.pa.room
-00005610: 5f69 6e76 6974 6573 2e6c 6f77 6572 2829  _invites.lower()
-00005620: 203d 3d20 494e 5649 5445 535f 4c49 5354   == INVITES_LIST
-00005630: 5f4a 4f49 4e0a 2020 2020 2020 2020 2020  _JOIN.          
-00005640: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00005650: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
-00005660: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
-00005670: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
-00005680: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-00005690: 2020 7465 7874 203d 2066 227b 726f 6f6d    text = f"{room
-000056a0: 2e72 6f6f 6d5f 6964 7d22 0a20 2020 2020  .room_id}".     
-000056b0: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
-000056c0: 7573 6520 7468 6520 6469 6374 696f 6e61  use the dictiona
-000056d0: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
-000056e0: 2020 2020 6a73 6f6e 5f6d 6178 203d 207b      json_max = {
-000056f0: 2272 6f6f 6d5f 6964 223a 2072 6f6f 6d2e  "room_id": room.
-00005700: 726f 6f6d 5f69 647d 0a20 2020 2020 2020  room_id}.       
-00005710: 2020 2020 2020 2020 206a 736f 6e5f 203d           json_ =
-00005720: 206a 736f 6e5f 6d61 782e 636f 7079 2829   json_max.copy()
-00005730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005740: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
-00005750: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00005760: 2020 7072 696e 745f 6f75 7470 7574 280a    print_output(.
-00005770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005780: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
-00005790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000057a0: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
-000057b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000057c0: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
-000057d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000057e0: 2020 2020 2020 6a73 6f6e 5f6d 6178 3d6a        json_max=j
-000057f0: 736f 6e5f 6d61 782c 0a20 2020 2020 2020  son_max,.       
-00005800: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-00005810: 6e5f 7370 6563 3d6a 736f 6e5f 7370 6563  n_spec=json_spec
-00005820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00005830: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00005840: 2023 206a 6f69 6e0a 2020 2020 2020 2020   # join.        
-00005850: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-00005860: 2020 2020 2020 2020 2067 732e 7061 2e72           gs.pa.r
-00005870: 6f6f 6d5f 696e 7669 7465 732e 6c6f 7765  oom_invites.lowe
-00005880: 7228 2920 3d3d 2049 4e56 4954 4553 5f4a  r() == INVITES_J
-00005890: 4f49 4e0a 2020 2020 2020 2020 2020 2020  OIN.            
-000058a0: 2020 2020 6f72 2067 732e 7061 2e72 6f6f      or gs.pa.roo
-000058b0: 6d5f 696e 7669 7465 732e 6c6f 7765 7228  m_invites.lower(
-000058c0: 2920 3d3d 2049 4e56 4954 4553 5f4c 4953  ) == INVITES_LIS
-000058d0: 545f 4a4f 494e 0a20 2020 2020 2020 2020  T_JOIN.         
-000058e0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-000058f0: 2020 2020 2020 7265 7375 6c74 203d 2061        result = a
-00005900: 7761 6974 2073 656c 662e 636c 6965 6e74  wait self.client
-00005910: 2e6a 6f69 6e28 726f 6f6d 2e72 6f6f 6d5f  .join(room.room_
-00005920: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
-00005930: 2020 2020 6966 2074 7970 6528 7265 7375      if type(resu
-00005940: 6c74 2920 3d3d 204a 6f69 6e45 7272 6f72  lt) == JoinError
-00005950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00005960: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-00005970: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00005980: 2020 2020 2020 2020 2020 2020 6622 4532              f"E2
-00005990: 3439 3a20 4572 726f 7220 6a6f 696e 696e  49: Error joinin
-000059a0: 6720 726f 6f6d 207b 726f 6f6d 2e72 6f6f  g room {room.roo
-000059b0: 6d5f 6964 7d3a 2022 0a20 2020 2020 2020  m_id}: ".       
-000059c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059d0: 2066 227b 7265 7375 6c74 2e6d 6573 7361   f"{result.messa
-000059e0: 6765 7d22 2c0a 2020 2020 2020 2020 2020  ge}",.          
-000059f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00005a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a10: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-00005a20: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00005a30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00005a40: 2020 2020 2020 2020 2020 2020 2320 5375              # Su
-00005a50: 6363 6573 7366 756c 6c79 206a 6f69 6e65  ccessfully joine
-00005a60: 6420 726f 6f6d 0a20 2020 2020 2020 2020  d room.         
-00005a70: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00005a80: 672e 696e 666f 2866 224a 6f69 6e65 6420  g.info(f"Joined 
-00005a90: 726f 6f6d 207b 726f 6f6d 2e72 6f6f 6d5f  room {room.room_
-00005aa0: 6964 7d20 7375 6363 6573 7366 756c 6c79  id} successfully
-00005ab0: 2e22 290a 0a20 2020 2020 2020 2065 7863  .")..        exc
-00005ac0: 6570 7420 4261 7365 4578 6365 7074 696f  ept BaseExceptio
-00005ad0: 6e3a 0a20 2020 2020 2020 2020 2020 2067  n:.            g
-00005ae0: 732e 6c6f 672e 6465 6275 6728 2248 6572  s.log.debug("Her
-00005af0: 6520 6973 2074 6865 2074 7261 6365 6261  e is the traceba
-00005b00: 636b 2e5c 6e22 202b 2074 7261 6365 6261  ck.\n" + traceba
-00005b10: 636b 2e66 6f72 6d61 745f 6578 6328 2929  ck.format_exc())
-00005b20: 0a0a 2020 2020 2320 6163 636f 7264 696e  ..    # accordin
-00005b30: 6720 746f 2070 796c 616d 613a 2066 756e  g to pylama: fun
-00005b40: 6374 696f 6e20 746f 6f20 636f 6d70 6c65  ction too comple
-00005b50: 783a 2043 3930 3120 2320 6e6f 7161 3a20  x: C901 # noqa: 
-00005b60: 4339 3031 0a20 2020 2061 7379 6e63 2064  C901.    async d
-00005b70: 6566 206d 6573 7361 6765 5f63 616c 6c62  ef message_callb
-00005b80: 6163 6b28 7365 6c66 2c20 726f 6f6d 3a20  ack(self, room: 
-00005b90: 4d61 7472 6978 526f 6f6d 2c20 6576 656e  MatrixRoom, even
-00005ba0: 7429 3a20 2023 206e 6f71 613a 2043 3930  t):  # noqa: C90
-00005bb0: 310a 2020 2020 2020 2020 2222 2248 616e  1.        """Han
-00005bc0: 646c 6520 616c 6c20 6576 656e 7473 206f  dle all events o
-00005bd0: 6620 7479 7065 2052 6f6f 6d4d 6573 7361  f type RoomMessa
-00005be0: 6765 2e0a 0a20 2020 2020 2020 2049 6e63  ge...        Inc
-00005bf0: 6c75 6465 7320 6576 656e 7473 206c 696b  ludes events lik
-00005c00: 6520 526f 6f6d 4d65 7373 6167 6554 6578  e RoomMessageTex
-00005c10: 742c 2052 6f6f 6d4d 6573 7361 6765 496d  t, RoomMessageIm
-00005c20: 6167 652c 2065 7463 2e0a 2020 2020 2020  age, etc..      
-00005c30: 2020 2222 220a 2020 2020 2020 2020 7472    """.        tr
-00005c40: 793a 0a20 2020 2020 2020 2020 2020 2067  y:.            g
-00005c50: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-00005c60: 2020 2020 2020 2020 2020 2020 2066 226d               f"m
-00005c70: 6573 7361 6765 5f63 616c 6c62 6163 6b28  essage_callback(
-00005c80: 293a 2066 6f72 2072 6f6f 6d20 7b72 6f6f  ): for room {roo
-00005c90: 6d7d 2072 6563 6569 7665 6420 7468 6973  m} received this
-00005ca0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00005cb0: 2020 2066 2265 7665 6e74 3a20 7479 7065     f"event: type
-00005cc0: 3a20 7b74 7970 6528 6576 656e 7429 7d2c  : {type(event)},
-00005cd0: 2065 7665 6e74 5f69 643a 207b 6576 656e   event_id: {even
-00005ce0: 742e 6576 656e 745f 6964 7d2c 2022 0a20  t.event_id}, ". 
-00005cf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00005d00: 2265 7665 6e74 3a20 7b65 7665 6e74 7d22  "event: {event}"
-00005d10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00005d20: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00005d30: 7420 6773 2e70 612e 6c69 7374 656e 5f73  t gs.pa.listen_s
-00005d40: 656c 663a 0a20 2020 2020 2020 2020 2020  elf:.           
-00005d50: 2020 2020 2069 6620 6576 656e 742e 7365       if event.se
-00005d60: 6e64 6572 203d 3d20 7365 6c66 2e63 6c69  nder == self.cli
-00005d70: 656e 742e 7573 6572 3a0a 2020 2020 2020  ent.user:.      
-00005d80: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00005d90: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00005da0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00005db0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-00005dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005dd0: 2020 2020 2066 2253 6b69 7070 696e 6720       f"Skipping 
-00005de0: 6d65 7373 6167 6520 7365 6e74 2062 7920  message sent by 
-00005df0: 6d79 7365 6c66 3a20 7b65 7665 6e74 2e62  myself: {event.b
-00005e00: 6f64 797d 220a 2020 2020 2020 2020 2020  ody}".          
-00005e10: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00005e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e30: 2020 2020 6578 6365 7074 2041 7474 7269      except Attri
-00005e40: 6275 7465 4572 726f 723a 2020 2320 646f  buteError:  # do
-00005e50: 6573 206e 6f74 2068 6176 6520 2e62 6f64  es not have .bod
-00005e60: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-00005e70: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00005e80: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00005e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ea0: 2020 2020 6622 536b 6970 7069 6e67 206d      f"Skipping m
-00005eb0: 6573 7361 6765 2073 656e 7420 6279 206d  essage sent by m
-00005ec0: 7973 656c 663a 207b 6576 656e 747d 220a  yself: {event}".
-00005ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ee0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00005ef0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00005f00: 7475 726e 0a0a 2020 2020 2020 2020 2020  turn..          
-00005f10: 2020 2320 6d69 6c6c 6973 6563 2073 696e    # millisec sin
-00005f20: 6365 2031 3937 300a 2020 2020 2020 2020  ce 1970.        
-00005f30: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00005f40: 2866 2265 7665 6e74 2e73 6572 7665 725f  (f"event.server_
-00005f50: 7469 6d65 7374 616d 7020 3d20 7b65 7665  timestamp = {eve
-00005f60: 6e74 2e73 6572 7665 725f 7469 6d65 7374  nt.server_timest
-00005f70: 616d 707d 2229 0a20 2020 2020 2020 2020  amp}").         
-00005f80: 2020 2074 696d 6573 7461 6d70 203d 2064     timestamp = d
-00005f90: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
-00005fa0: 2e66 726f 6d74 696d 6573 7461 6d70 280a  .fromtimestamp(.
+00004df0: 3a2f 2f6d 6174 7269 782e 6578 616d 706c  ://matrix.exampl
+00004e00: 652e 636f 6d2f 4162 6331 3233 0a20 2020  e.com/Abc123.   
+00004e10: 2023 2073 6572 7665 725f 6e61 6d65 203d   # server_name =
+00004e20: 2022 6d61 7472 6978 2e65 7861 6d70 6c65   "matrix.example
+00004e30: 2e63 6f6d 220a 2020 2020 2320 6d65 6469  .com".    # medi
+00004e40: 615f 6964 203d 2022 4162 6331 3233 220a  a_id = "Abc123".
+00004e50: 2020 2020 2320 6d61 7472 6978 2d6e 696f      # matrix-nio
+00004e60: 2076 302e 3139 2e30 2068 6173 3a20 646f   v0.19.0 has: do
+00004e70: 776e 6c6f 6164 2873 6572 7665 725f 6e61  wnload(server_na
+00004e80: 6d65 3a20 7374 722c 206d 6564 6961 5f69  me: str, media_i
+00004e90: 643a 2073 7472 2c20 2e2e 290a 2020 2020  d: str, ..).    
+00004ea0: 2320 636f 6e76 6572 7420 6d78 6320 746f  # convert mxc to
+00004eb0: 2073 6572 7665 725f 6e61 6d65 2061 6e64   server_name and
+00004ec0: 206d 6564 6961 5f69 640a 2020 2020 2320   media_id.    # 
+00004ed0: 7630 2e32 302b 203a 2072 6573 7020 3d20  v0.20+ : resp = 
+00004ee0: 6177 6169 7420 636c 6965 6e74 2e64 6f77  await client.dow
+00004ef0: 6e6c 6f61 6428 6d78 633d 6d78 632c 2066  nload(mxc=mxc, f
+00004f00: 696c 656e 616d 653d 6669 6c65 6e61 6d65  ilename=filename
+00004f10: 290a 2020 2020 2320 7630 2e31 392d 203a  ).    # v0.19- :
+00004f20: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
+00004f30: 6965 6e74 2e64 6f77 6e6c 6f61 6428 0a20  ient.download(. 
+00004f40: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+00004f50: 2020 2020 2020 2020 2073 6572 7665 725f           server_
+00004f60: 6e61 6d65 3d73 6572 7665 725f 6e61 6d65  name=server_name
+00004f70: 2c20 6d65 6469 615f 6964 3d6d 6564 6961  , media_id=media
+00004f80: 5f69 642c 0a20 2020 2023 2020 2020 2020  _id,.    #      
+00004f90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00004fa0: 696c 656e 616d 653d 6669 6c65 6e61 6d65  ilename=filename
+00004fb0: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
+00004fc0: 7567 2866 2264 6f77 6e6c 6f61 645f 6d78  ug(f"download_mx
+00004fd0: 6320 696e 7075 7420 6d78 6320 6973 207b  c input mxc is {
+00004fe0: 6d78 637d 2e22 290a 2020 2020 6966 206e  mxc}.").    if n
+00004ff0: 696f 5f76 6572 7369 6f6e 2e73 7461 7274  io_version.start
+00005000: 7377 6974 6828 2230 2e31 2229 3a20 2023  swith("0.1"):  #
+00005010: 206c 696b 6520 302e 3139 0a20 2020 2020   like 0.19.     
+00005020: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
+00005030: 2020 2020 2020 2020 2020 2020 6622 596f              f"Yo
+00005040: 7520 6172 6520 7275 6e6e 696e 6720 6d61  u are running ma
+00005050: 7472 6978 2d6e 696f 2076 6572 7369 6f6e  trix-nio version
+00005060: 207b 6e69 6f5f 7665 7273 696f 6e7d 2e20   {nio_version}. 
+00005070: 220a 2020 2020 2020 2020 2020 2020 2259  ".            "Y
+00005080: 6f75 2073 686f 756c 6420 6265 2072 756e  ou should be run
+00005090: 6e69 6e67 2076 6572 7369 6f6e 2030 2e32  ning version 0.2
+000050a0: 302b 2e20 5570 6461 7465 2069 6620 6e65  0+. Update if ne
+000050b0: 6365 7373 6172 792e 2022 0a20 2020 2020  cessary. ".     
+000050c0: 2020 2029 0a20 2020 2020 2020 2075 726c     ).        url
+000050d0: 203d 2075 726c 7061 7273 6528 6d78 6329   = urlparse(mxc)
+000050e0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+000050f0: 6465 6275 6728 6622 646f 776e 6c6f 6164  debug(f"download
+00005100: 5f6d 7863 2069 6e70 7574 2075 726c 2069  _mxc input url i
+00005110: 7320 7b75 726c 7d2e 2229 0a20 2020 2020  s {url}.").     
+00005120: 2020 2072 6573 706f 6e73 6520 3d20 6177     response = aw
+00005130: 6169 7420 636c 6965 6e74 2e64 6f77 6e6c  ait client.downl
+00005140: 6f61 6428 0a20 2020 2020 2020 2020 2020  oad(.           
+00005150: 2073 6572 7665 725f 6e61 6d65 3d75 726c   server_name=url
+00005160: 2e6e 6574 6c6f 632c 0a20 2020 2020 2020  .netloc,.       
+00005170: 2020 2020 206d 6564 6961 5f69 643d 7572       media_id=ur
+00005180: 6c2e 7061 7468 2e73 7472 6970 2822 2f22  l.path.strip("/"
+00005190: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+000051a0: 696c 656e 616d 653d 6669 6c65 6e61 6d65  ilename=filename
+000051b0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+000051c0: 656c 7365 3a0a 2020 2020 2020 2020 6773  else:.        gs
+000051d0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+000051e0: 2020 2020 2020 2020 6622 596f 7520 6172          f"You ar
+000051f0: 6520 7275 6e6e 696e 6720 6d61 7472 6978  e running matrix
+00005200: 2d6e 696f 2076 6572 7369 6f6e 207b 6e69  -nio version {ni
+00005210: 6f5f 7665 7273 696f 6e7d 2e20 4772 6561  o_version}. Grea
+00005220: 7421 220a 2020 2020 2020 2020 290a 2020  t!".        ).  
+00005230: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+00005240: 2061 7761 6974 2063 6c69 656e 742e 646f   await client.do
+00005250: 776e 6c6f 6164 286d 7863 3d6d 7863 2c20  wnload(mxc=mxc, 
+00005260: 6669 6c65 6e61 6d65 3d66 696c 656e 616d  filename=filenam
+00005270: 6529 0a20 2020 2067 732e 6c6f 672e 6465  e).    gs.log.de
+00005280: 6275 6728 6622 646f 776e 6c6f 6164 5f6d  bug(f"download_m
+00005290: 7863 2072 6573 706f 6e73 6520 6973 207b  xc response is {
+000052a0: 7265 7370 6f6e 7365 7d2e 2229 0a20 2020  response}.").   
+000052b0: 2072 6574 7572 6e20 7265 7370 6f6e 7365   return response
+000052c0: 0a0a 0a63 6c61 7373 2043 616c 6c62 6163  ...class Callbac
+000052d0: 6b73 286f 626a 6563 7429 3a0a 2020 2020  ks(object):.    
+000052e0: 2222 2243 6c61 7373 2074 6f20 7061 7373  """Class to pass
+000052f0: 2063 6c69 656e 7420 746f 2063 616c 6c62   client to callb
+00005300: 6163 6b20 6d65 7468 6f64 732e 2222 220a  ack methods.""".
+00005310: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00005320: 5f28 7365 6c66 2c20 636c 6965 6e74 293a  _(self, client):
+00005330: 0a20 2020 2020 2020 2022 2222 5374 6f72  .        """Stor
+00005340: 6520 4173 796e 6343 6c69 656e 742e 2222  e AsyncClient.""
+00005350: 220a 2020 2020 2020 2020 7365 6c66 2e63  ".        self.c
+00005360: 6c69 656e 7420 3d20 636c 6965 6e74 0a0a  lient = client..
+00005370: 2020 2020 6173 796e 6320 6465 6620 696e      async def in
+00005380: 7669 7465 5f63 616c 6c62 6163 6b28 7365  vite_callback(se
+00005390: 6c66 2c20 726f 6f6d 2c20 6576 656e 7429  lf, room, event)
+000053a0: 3a0a 2020 2020 2020 2020 2222 2248 616e  :.        """Han
+000053b0: 646c 6520 616e 2069 6e63 6f6d 696e 6720  dle an incoming 
+000053c0: 696e 7669 7465 2065 7665 6e74 2e0a 0a20  invite event... 
+000053d0: 2020 2020 2020 2049 6620 616e 2069 6e76         If an inv
+000053e0: 6974 6520 6973 2072 6563 6569 7665 642c  ite is received,
+000053f0: 2074 6865 6e20 6c69 7374 206f 7220 6a6f   then list or jo
+00005400: 696e 2074 6865 2072 6f6f 6d20 7370 6563  in the room spec
+00005410: 6966 6965 640a 2020 2020 2020 2020 696e  ified.        in
+00005420: 2074 6865 2069 6e76 6974 652e 0a20 2020   the invite..   
+00005430: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00005440: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00005450: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+00005460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005470: 6622 6d65 7373 6167 655f 6361 6c6c 6261  f"message_callba
+00005480: 636b 2829 3a20 666f 7220 726f 6f6d 207b  ck(): for room {
+00005490: 726f 6f6d 7d20 7265 6365 6976 6564 2074  room} received t
+000054a0: 6869 7320 220a 2020 2020 2020 2020 2020  his ".          
+000054b0: 2020 2020 2020 6622 6576 656e 743a 2074        f"event: t
+000054c0: 7970 653a 207b 7479 7065 2865 7665 6e74  ype: {type(event
+000054d0: 297d 2c20 220a 2020 2020 2020 2020 2020  )}, ".          
+000054e0: 2020 2020 2020 6622 6576 656e 743a 207b        f"event: {
+000054f0: 6576 656e 747d 220a 2020 2020 2020 2020  event}".        
+00005500: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00005510: 2020 2320 5468 6572 6520 6172 6520 4d55    # There are MU
+00005520: 4c54 4950 4c45 2065 7665 6e74 7320 7265  LTIPLE events re
+00005530: 6365 6976 6564 210a 2020 2020 2020 2020  ceived!.        
+00005540: 2020 2020 2320 6576 656e 7420 313a 0a20      # event 1:. 
+00005550: 2020 2020 2020 2020 2020 2023 2049 6e76             # Inv
+00005560: 6974 654d 656d 6265 7245 7665 6e74 2873  iteMemberEvent(s
+00005570: 6f75 7263 653d 7b27 7479 7065 273a 2027  ource={'type': '
+00005580: 6d2e 726f 6f6d 2e6d 656d 6265 7227 2c0a  m.room.member',.
+00005590: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+000055a0: 2773 7461 7465 5f6b 6579 273a 2027 406a  'state_key': '@j
+000055b0: 616e 653a 6d61 7472 6978 2e65 7861 6d70  ane:matrix.examp
+000055c0: 6c65 2e63 6f6d 272c 0a20 2020 2020 2020  le.com',.       
+000055d0: 2020 2020 2023 2020 2027 7365 6e64 6572       #   'sender
+000055e0: 273a 2027 406a 616e 653a 6d61 7472 6978  ': '@jane:matrix
+000055f0: 2e65 7861 6d70 6c65 2e63 6f6d 277d 2c0a  .example.com'},.
+00005600: 2020 2020 2020 2020 2020 2020 2320 7365              # se
+00005610: 6e64 6572 3d27 406a 616e 653a 6d61 7472  nder='@jane:matr
+00005620: 6978 2e65 7861 6d70 6c65 2e63 6f6d 272c  ix.example.com',
+00005630: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00005640: 7461 7465 5f6b 6579 3d27 406a 616e 653a  tate_key='@jane:
+00005650: 6d61 7472 6978 2e65 7861 6d70 6c65 2e63  matrix.example.c
+00005660: 6f6d 272c 0a20 2020 2020 2020 2020 2020  om',.           
+00005670: 2023 206d 656d 6265 7273 6869 703d 276a   # membership='j
+00005680: 6f69 6e27 2c0a 2020 2020 2020 2020 2020  oin',.          
+00005690: 2020 2320 7072 6576 5f6d 656d 6265 7273    # prev_members
+000056a0: 6869 703d 4e6f 6e65 2c0a 2020 2020 2020  hip=None,.      
+000056b0: 2020 2020 2020 2320 636f 6e74 656e 743d        # content=
+000056c0: 7b27 6d65 6d62 6572 7368 6970 273a 2027  {'membership': '
+000056d0: 6a6f 696e 272c 2027 6469 7370 6c61 796e  join', 'displayn
+000056e0: 616d 6527 3a20 274d 272c 0a20 2020 2020  ame': 'M',.     
+000056f0: 2020 2020 2020 2023 2020 2027 6176 6174         #   'avat
+00005700: 6172 5f75 726c 273a 2027 2e2e 2e27 7d2c  ar_url': '...'},
+00005710: 2070 7265 765f 636f 6e74 656e 743d 4e6f   prev_content=No
+00005720: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00005730: 2320 6576 656e 7420 323a 0a20 2020 2020  # event 2:.     
+00005740: 2020 2020 2020 2023 2049 6e76 6974 654d         # InviteM
+00005750: 656d 6265 7245 7665 6e74 2873 6f75 7263  emberEvent(sourc
+00005760: 653d 7b27 7479 7065 273a 2027 6d2e 726f  e={'type': 'm.ro
+00005770: 6f6d 2e6d 656d 6265 7227 2c0a 2020 2020  om.member',.    
+00005780: 2020 2020 2020 2020 2320 2020 2773 656e          #   'sen
+00005790: 6465 7227 3a20 2740 6a61 6e65 3a6d 6174  der': '@jane:mat
+000057a0: 7269 782e 6578 616d 706c 652e 636f 6d27  rix.example.com'
+000057b0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000057c0: 2020 2773 7461 7465 5f6b 6579 273a 2027    'state_key': '
+000057d0: 406a 6f68 6e3a 6d61 7472 6978 2e65 7861  @john:matrix.exa
+000057e0: 6d70 6c65 2e63 6f6d 272c 0a20 2020 2020  mple.com',.     
+000057f0: 2020 2020 2020 2023 2020 2027 6f72 6967         #   'orig
+00005800: 696e 5f73 6572 7665 725f 7473 273a 2031  in_server_ts': 1
+00005810: 3638 3139 3836 3339 3037 3738 2c0a 2020  681986390778,.  
+00005820: 2020 2020 2020 2020 2020 2320 2020 2775            #   'u
+00005830: 6e73 6967 6e65 6427 3a20 7b27 7265 706c  nsigned': {'repl
+00005840: 6163 6573 5f73 7461 7465 273a 2027 2478  aces_state': '$x
+00005850: 7878 272c 0a20 2020 2020 2020 2020 2020  xx',.           
+00005860: 2023 2020 2020 2020 2027 7072 6576 5f63   #       'prev_c
+00005870: 6f6e 7465 6e74 273a 207b 276d 656d 6265  ontent': {'membe
+00005880: 7273 6869 7027 3a20 276c 6561 7665 277d  rship': 'leave'}
+00005890: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000058a0: 2020 2020 2020 2770 7265 765f 7365 6e64        'prev_send
+000058b0: 6572 273a 2027 406a 6f68 6e3a 6d61 7472  er': '@john:matr
+000058c0: 6978 2e65 7861 6d70 6c65 2e63 6f6d 272c  ix.example.com',
+000058d0: 2027 6167 6527 3a20 3133 3033 377d 2c0a   'age': 13037},.
+000058e0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+000058f0: 2765 7665 6e74 5f69 6427 3a20 2778 7878  'event_id': 'xxx
+00005900: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00005910: 2320 7365 6e64 6572 3d27 406a 616e 653a  # sender='@jane:
+00005920: 6d61 7472 6978 2e65 7861 6d70 6c65 2e63  matrix.example.c
+00005930: 6f6d 272c 0a20 2020 2020 2020 2020 2020  om',.           
+00005940: 2023 2073 7461 7465 5f6b 6579 3d27 406a   # state_key='@j
+00005950: 6f68 6e3a 6d61 7472 6978 2e65 7861 6d70  ohn:matrix.examp
+00005960: 6c65 2e63 6f6d 272c 0a20 2020 2020 2020  le.com',.       
+00005970: 2020 2020 2023 206d 656d 6265 7273 6869       # membershi
+00005980: 703d 2769 6e76 6974 6527 2c0a 2020 2020  p='invite',.    
+00005990: 2020 2020 2020 2020 2320 7072 6576 5f6d          # prev_m
+000059a0: 656d 6265 7273 6869 703d 276c 6561 7665  embership='leave
+000059b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+000059c0: 2063 6f6e 7465 6e74 3d7b 276d 656d 6265   content={'membe
+000059d0: 7273 6869 7027 3a20 2769 6e76 6974 6527  rship': 'invite'
+000059e0: 2c20 2764 6973 706c 6179 6e61 6d65 273a  , 'displayname':
+000059f0: 2027 626f 7427 2c0a 2020 2020 2020 2020   'bot',.        
+00005a00: 2020 2020 2320 2020 2761 7661 7461 725f      #   'avatar_
+00005a10: 7572 6c27 3a20 2778 7878 277d 2c20 7072  url': 'xxx'}, pr
+00005a20: 6576 5f63 6f6e 7465 6e74 3d7b 276d 656d  ev_content={'mem
+00005a30: 6265 7273 6869 7027 3a20 276c 6561 7665  bership': 'leave
+00005a40: 277d 290a 0a20 2020 2020 2020 2020 2020  '})..           
+00005a50: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+00005a60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00005a70: 2247 6f74 2069 6e76 6974 6520 6576 656e  "Got invite even
+00005a80: 7420 666f 7220 726f 6f6d 207b 726f 6f6d  t for room {room
+00005a90: 2e72 6f6f 6d5f 6964 7d20 6672 6f6d 2022  .room_id} from "
+00005aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005ab0: 2066 227b 6576 656e 742e 7365 6e64 6572   f"{event.sender
+00005ac0: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
+00005ad0: 2020 2020 2066 2245 7665 6e74 2073 686f       f"Event sho
+00005ae0: 7773 206d 656d 6265 7273 6869 7020 6173  ws membership as
+00005af0: 2027 7b65 7665 6e74 2e6d 656d 6265 7273   '{event.members
+00005b00: 6869 707d 272e 220a 2020 2020 2020 2020  hip}'.".        
+00005b10: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00005b20: 2020 2069 6620 6576 656e 742e 6d65 6d62     if event.memb
+00005b30: 6572 7368 6970 203d 3d20 2269 6e76 6974  ership == "invit
+00005b40: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00005b50: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00005b60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00005b70: 2020 2020 2020 2245 7665 6e74 2077 696c        "Event wil
+00005b80: 6c20 6265 2070 726f 6365 7373 6564 2062  l be processed b
+00005b90: 6563 6175 7365 2069 7420 7368 6f77 7320  ecause it shows 
+00005ba0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00005bb0: 2020 2020 2020 6622 6d65 6d62 6572 7368        f"membersh
+00005bc0: 6970 2061 7320 277b 6576 656e 742e 6d65  ip as '{event.me
+00005bd0: 6d62 6572 7368 6970 7d27 2e22 0a20 2020  mbership}'.".   
+00005be0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00005bf0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00005c00: 206c 6973 740a 2020 2020 2020 2020 2020   list.          
+00005c10: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+00005c20: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00005c30: 732e 7061 2e72 6f6f 6d5f 696e 7669 7465  s.pa.room_invite
+00005c40: 7320 3d3d 2049 4e56 4954 4553 5f4c 4953  s == INVITES_LIS
+00005c50: 540a 2020 2020 2020 2020 2020 2020 2020  T.              
+00005c60: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
+00005c70: 6f6f 6d5f 696e 7669 7465 7320 3d3d 2049  oom_invites == I
+00005c80: 4e56 4954 4553 5f4c 4953 545f 4a4f 494e  NVITES_LIST_JOIN
+00005c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005ca0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00005cb0: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
+00005cc0: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
+00005cd0: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
+00005ce0: 666c 6167 0a20 2020 2020 2020 2020 2020  flag.           
+00005cf0: 2020 2020 2020 2020 2074 6578 7420 3d20           text = 
+00005d00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00005d10: 2020 2020 2020 2020 2020 6622 7b72 6f6f            f"{roo
+00005d20: 6d2e 726f 6f6d 5f69 647d 7b53 4550 7d6d  m.room_id}{SEP}m
+00005d30: 2e72 6f6f 6d2e 6d65 6d62 6572 220a 2020  .room.member".  
+00005d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d50: 2020 2020 2020 6622 7b53 4550 7d7b 6576        f"{SEP}{ev
+00005d60: 656e 742e 6d65 6d62 6572 7368 6970 7d22  ent.membership}"
+00005d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005d80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00005d90: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
+00005da0: 7573 6520 7468 6520 6469 6374 696f 6e61  use the dictiona
+00005db0: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+00005dc0: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+00005dd0: 203d 207b 2272 6f6f 6d5f 6964 223a 2072   = {"room_id": r
+00005de0: 6f6f 6d2e 726f 6f6d 5f69 647d 0a20 2020  oom.room_id}.   
+00005df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e00: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
+00005e10: 287b 2265 7665 6e74 223a 2022 6d2e 726f  ({"event": "m.ro
+00005e20: 6f6d 2e6d 656d 6265 7222 7d29 0a20 2020  om.member"}).   
+00005e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e40: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
+00005e50: 287b 226d 656d 6265 7273 6869 7022 3a20  ({"membership": 
+00005e60: 6576 656e 742e 6d65 6d62 6572 7368 6970  event.membership
+00005e70: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+00005e80: 2020 2020 2020 206a 736f 6e5f 203d 206a         json_ = j
+00005e90: 736f 6e5f 6d61 782e 636f 7079 2829 0a20  son_max.copy(). 
+00005ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005eb0: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
+00005ec0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00005ed0: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
+00005ee0: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+00005ef0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00005f00: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
+00005f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f20: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
+00005f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f40: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
+00005f50: 6e5f 2c0a 2020 2020 2020 2020 2020 2020  n_,.            
+00005f60: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00005f70: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
+00005f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f90: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
+00005fa0: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
 00005fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fc0: 696e 7428 6576 656e 742e 7365 7276 6572  int(event.server
-00005fd0: 5f74 696d 6573 7461 6d70 202f 2031 3030  _timestamp / 100
-00005fe0: 3029 0a20 2020 2020 2020 2020 2020 2029  0).            )
-00005ff0: 2020 2320 7365 6320 7369 6e63 6520 3139    # sec since 19
-00006000: 3730 0a20 2020 2020 2020 2020 2020 2065  70.            e
-00006010: 7665 6e74 5f64 6174 6574 696d 6520 3d20  vent_datetime = 
-00006020: 7469 6d65 7374 616d 702e 7374 7266 7469  timestamp.strfti
-00006030: 6d65 2822 2559 2d25 6d2d 2564 2025 483a  me("%Y-%m-%d %H:
-00006040: 254d 3a25 5322 290a 2020 2020 2020 2020  %M:%S").        
-00006050: 2020 2020 2320 652e 672e 2032 3032 302d      # e.g. 2020-
-00006060: 3038 2d30 3620 3137 3a33 303a 3138 0a20  08-06 17:30:18. 
-00006070: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00006080: 672e 6465 6275 6728 6622 6576 656e 745f  g.debug(f"event_
-00006090: 6461 7465 7469 6d65 203d 207b 6576 656e  datetime = {even
-000060a0: 745f 6461 7465 7469 6d65 7d22 290a 0a20  t_datetime}").. 
-000060b0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-000060c0: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
-000060d0: 526f 6f6d 4d65 7373 6167 654d 6564 6961  RoomMessageMedia
-000060e0: 293a 2020 2320 666f 7220 616c 6c20 6d65  ):  # for all me
-000060f0: 6469 6120 6576 656e 7473 0a20 2020 2020  dia events.     
-00006100: 2020 2020 2020 2020 2020 206d 7863 203d             mxc =
-00006110: 2065 7665 6e74 2e75 726c 2020 2320 6d65   event.url  # me
-00006120: 6469 6120 6d78 630a 2020 2020 2020 2020  dia mxc.        
-00006130: 2020 2020 2020 2020 7572 6c20 3d20 6177          url = aw
-00006140: 6169 7420 7365 6c66 2e63 6c69 656e 742e  ait self.client.
-00006150: 6d78 635f 746f 5f68 7474 7028 6d78 6329  mxc_to_http(mxc)
-00006160: 2020 2320 6d65 6469 6120 7572 6c0a 2020    # media url.  
-00006170: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-00006180: 2e6c 6f67 2e64 6562 7567 2866 2248 5454  .log.debug(f"HTT
-00006190: 5020 5552 4c20 6f66 206d 6564 6961 2069  P URL of media i
-000061a0: 7320 3a20 7b75 726c 7d22 290a 2020 2020  s : {url}").    
-000061b0: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
-000061c0: 7572 6c20 3d20 2220 5b22 202b 2075 726c  url = " [" + url
-000061d0: 202b 2022 5d22 0a20 2020 2020 2020 2020   + "]".         
-000061e0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-000061f0: 646f 776e 6c6f 6164 5f6d 6564 6961 2021  download_media !
-00006200: 3d20 2222 3a0a 2020 2020 2020 2020 2020  = "":.          
-00006210: 2020 2020 2020 2020 2020 2320 646f 776e            # down
-00006220: 6c6f 6164 2075 6e65 6e63 7279 7074 6564  load unencrypted
-00006230: 2f70 6c61 696e 206d 6564 6961 2066 696c  /plain media fil
-00006240: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00006250: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
-00006260: 6974 2064 6f77 6e6c 6f61 645f 6d78 6328  it download_mxc(
-00006270: 7365 6c66 2e63 6c69 656e 742c 206d 7863  self.client, mxc
-00006280: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006290: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-000062a0: 6e63 6528 7265 7370 2c20 446f 776e 6c6f  nce(resp, Downlo
-000062b0: 6164 4572 726f 7229 3a0a 2020 2020 2020  adError):.      
-000062c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062d0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-000062e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062f0: 2020 2020 2020 2020 2020 2020 2245 3130              "E10
-00006300: 353a 2022 0a20 2020 2020 2020 2020 2020  5: ".           
-00006310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006320: 2066 2264 6f77 6e6c 6f61 6420 6f66 2055   f"download of U
-00006330: 5249 2027 7b6d 7863 7d27 2074 6f20 6c6f  RI '{mxc}' to lo
-00006340: 6361 6c20 6669 6c65 2022 0a20 2020 2020  cal file ".     
-00006350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006360: 2020 2020 2020 2066 2266 6169 6c65 6420         f"failed 
-00006370: 7769 7468 2072 6573 706f 6e73 6520 7b70  with response {p
-00006380: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-00006390: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-000063a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063b0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000063c0: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-000063d0: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-000063e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000063f0: 2020 2020 2020 206d 7367 5f75 726c 202b         msg_url +
-00006400: 3d20 2220 5b44 6f77 6e6c 6f61 6420 6f66  = " [Download of
-00006410: 206d 6564 6961 2066 696c 6520 6661 696c   media file fail
-00006420: 6564 5d22 0a20 2020 2020 2020 2020 2020  ed]".           
-00006430: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00006440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006450: 2020 2020 2020 206d 6564 6961 5f64 6174         media_dat
-00006460: 6120 3d20 7265 7370 2e62 6f64 790a 2020  a = resp.body.  
-00006470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006480: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
-00006490: 2063 686f 6f73 655f 6176 6169 6c61 626c   choose_availabl
-000064a0: 655f 6669 6c65 6e61 6d65 280a 2020 2020  e_filename(.    
-000064b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064c0: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
-000064d0: 6a6f 696e 2867 732e 7061 2e64 6f77 6e6c  join(gs.pa.downl
-000064e0: 6f61 645f 6d65 6469 612c 2065 7665 6e74  oad_media, event
-000064f0: 2e62 6f64 7929 0a20 2020 2020 2020 2020  .body).         
-00006500: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00006510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006520: 2020 2020 2020 2020 2061 7379 6e63 2077           async w
-00006530: 6974 6820 6169 6f66 696c 6573 2e6f 7065  ith aiofiles.ope
-00006540: 6e28 6669 6c65 6e61 6d65 2c20 2277 6222  n(filename, "wb"
-00006550: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00006560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006570: 2020 2020 6177 6169 7420 662e 7772 6974      await f.writ
-00006580: 6528 6d65 6469 615f 6461 7461 290a 2020  e(media_data).  
-00006590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065a0: 2020 2020 2020 2020 2020 2320 5365 7420            # Set 
-000065b0: 6174 696d 6520 616e 6420 6d74 696d 6520  atime and mtime 
-000065c0: 6f66 2066 696c 6520 746f 2065 7665 6e74  of file to event
-000065d0: 2074 696d 6573 7461 6d70 0a20 2020 2020   timestamp.     
-000065e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065f0: 2020 2020 2020 206f 732e 7574 696d 6528         os.utime(
-00006600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006620: 2066 696c 656e 616d 652c 0a20 2020 2020   filename,.     
-00006630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006640: 2020 2020 2020 2020 2020 206e 733d 2828             ns=((
-00006650: 6576 656e 742e 7365 7276 6572 5f74 696d  event.server_tim
-00006660: 6573 7461 6d70 202a 2031 3030 3030 3030  estamp * 1000000
-00006670: 2c29 202a 2032 292c 0a20 2020 2020 2020  ,) * 2),.       
-00006680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006690: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000066a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000066b0: 7367 5f75 726c 202b 3d20 6622 205b 446f  sg_url += f" [Do
-000066c0: 776e 6c6f 6164 6564 206d 6564 6961 2066  wnloaded media f
-000066d0: 696c 6520 746f 207b 6669 6c65 6e61 6d65  ile to {filename
-000066e0: 7d5d 220a 0a20 2020 2020 2020 2020 2020  }]"..           
-000066f0: 2069 6620 6973 696e 7374 616e 6365 2865   if isinstance(e
-00006700: 7665 6e74 2c20 526f 6f6d 456e 6372 7970  vent, RoomEncryp
-00006710: 7465 644d 6564 6961 293a 2020 2320 666f  tedMedia):  # fo
-00006720: 7220 616c 6c20 6532 6520 6d65 6469 610a  r all e2e media.
-00006730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006740: 6d78 6320 3d20 6576 656e 742e 7572 6c20  mxc = event.url 
-00006750: 2023 206d 6564 6961 206d 7863 0a20 2020   # media mxc.   
-00006760: 2020 2020 2020 2020 2020 2020 2075 726c               url
-00006770: 203d 2061 7761 6974 2073 656c 662e 636c   = await self.cl
-00006780: 6965 6e74 2e6d 7863 5f74 6f5f 6874 7470  ient.mxc_to_http
-00006790: 286d 7863 2920 2023 206d 6564 6961 2075  (mxc)  # media u
-000067a0: 726c 0a20 2020 2020 2020 2020 2020 2020  rl.             
-000067b0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-000067c0: 6622 4854 5450 2055 524c 206f 6620 6d65  f"HTTP URL of me
-000067d0: 6469 6120 6973 203a 207b 7572 6c7d 2229  dia is : {url}")
-000067e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000067f0: 206d 7367 5f75 726c 203d 2022 205b 2220   msg_url = " [" 
-00006800: 2b20 7572 6c20 2b20 225d 220a 2020 2020  + url + "]".    
-00006810: 2020 2020 2020 2020 2020 2020 6966 2067              if g
-00006820: 732e 7061 2e64 6f77 6e6c 6f61 645f 6d65  s.pa.download_me
-00006830: 6469 6120 213d 2022 223a 0a20 2020 2020  dia != "":.     
-00006840: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006850: 2064 6f77 6e6c 6f61 6420 656e 6372 7970   download encryp
-00006860: 7465 6420 6d65 6469 6120 6669 6c65 0a20  ted media file. 
-00006870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006880: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
-00006890: 646f 776e 6c6f 6164 5f6d 7863 2873 656c  download_mxc(sel
-000068a0: 662e 636c 6965 6e74 2c20 6d78 6329 0a20  f.client, mxc). 
-000068b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068c0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000068d0: 2872 6573 702c 2044 6f77 6e6c 6f61 6445  (resp, DownloadE
-000068e0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000068f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00006900: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00006910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006920: 2020 2020 2020 2020 2022 4531 3036 3a20           "E106: 
-00006930: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00006940: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00006950: 646f 776e 6c6f 6164 206f 6620 5552 4920  download of URI 
-00006960: 277b 6d78 637d 2720 746f 206c 6f63 616c  '{mxc}' to local
-00006970: 2066 696c 6520 220a 2020 2020 2020 2020   file ".        
-00006980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006990: 2020 2020 6622 6661 696c 6564 2077 6974      f"failed wit
-000069a0: 6820 7265 7370 6f6e 7365 207b 7072 6976  h response {priv
-000069b0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-000069c0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-000069d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000069f0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
-00006a00: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-00006a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a20: 2020 2020 6d73 675f 7572 6c20 2b3d 2022      msg_url += "
-00006a30: 205b 446f 776e 6c6f 6164 206f 6620 6d65   [Download of me
-00006a40: 6469 6120 6669 6c65 2066 6169 6c65 645d  dia file failed]
-00006a50: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00006a60: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00006a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a80: 2020 2020 6d65 6469 615f 6461 7461 203d      media_data =
-00006a90: 2072 6573 702e 626f 6479 0a20 2020 2020   resp.body.     
-00006aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ab0: 2020 2066 696c 656e 616d 6520 3d20 6368     filename = ch
-00006ac0: 6f6f 7365 5f61 7661 696c 6162 6c65 5f66  oose_available_f
-00006ad0: 696c 656e 616d 6528 0a20 2020 2020 2020  ilename(.       
-00006ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006af0: 2020 2020 206f 732e 7061 7468 2e6a 6f69       os.path.joi
-00006b00: 6e28 6773 2e70 612e 646f 776e 6c6f 6164  n(gs.pa.download
-00006b10: 5f6d 6564 6961 2c20 6576 656e 742e 626f  _media, event.bo
-00006b20: 6479 290a 2020 2020 2020 2020 2020 2020  dy).            
-00006b30: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00006b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b50: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-00006b60: 2061 696f 6669 6c65 732e 6f70 656e 2866   aiofiles.open(f
-00006b70: 696c 656e 616d 652c 2022 7762 2229 2061  ilename, "wb") a
-00006b80: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
+00005fc0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00005fd0: 2020 2023 206a 6f69 6e0a 2020 2020 2020     # join.      
+00005fe0: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
+00005ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006000: 2020 2067 732e 7061 2e72 6f6f 6d5f 696e     gs.pa.room_in
+00006010: 7669 7465 7320 3d3d 2049 4e56 4954 4553  vites == INVITES
+00006020: 5f4a 4f49 4e0a 2020 2020 2020 2020 2020  _JOIN.          
+00006030: 2020 2020 2020 2020 2020 6f72 2067 732e            or gs.
+00006040: 7061 2e72 6f6f 6d5f 696e 7669 7465 7320  pa.room_invites 
+00006050: 3d3d 2049 4e56 4954 4553 5f4c 4953 545f  == INVITES_LIST_
+00006060: 4a4f 494e 0a20 2020 2020 2020 2020 2020  JOIN.           
+00006070: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00006080: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00006090: 6c74 203d 2061 7761 6974 2073 656c 662e  lt = await self.
+000060a0: 636c 6965 6e74 2e6a 6f69 6e28 726f 6f6d  client.join(room
+000060b0: 2e72 6f6f 6d5f 6964 290a 2020 2020 2020  .room_id).      
+000060c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000060d0: 2074 7970 6528 7265 7375 6c74 2920 3d3d   type(result) ==
+000060e0: 204a 6f69 6e45 7272 6f72 3a0a 2020 2020   JoinError:.    
+000060f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006100: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+00006110: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006120: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00006130: 4532 3439 3a20 4572 726f 7220 6a6f 696e  E249: Error join
+00006140: 696e 6720 726f 6f6d 207b 726f 6f6d 2e72  ing room {room.r
+00006150: 6f6f 6d5f 6964 7d3a 2022 0a20 2020 2020  oom_id}: ".     
+00006160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006170: 2020 2020 2020 2066 227b 7265 7375 6c74         f"{result
+00006180: 2e6d 6573 7361 6765 7d22 2c0a 2020 2020  .message}",.    
+00006190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061a0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000061b0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+000061c0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+000061d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006200: 2020 2320 5375 6363 6573 7366 756c 6c79    # Successfully
+00006210: 206a 6f69 6e65 6420 726f 6f6d 0a20 2020   joined room.   
+00006220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006230: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+00006240: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006250: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00006260: 4a6f 696e 6564 2072 6f6f 6d20 7b72 6f6f  Joined room {roo
+00006270: 6d2e 726f 6f6d 5f69 647d 2073 7563 6365  m.room_id} succe
+00006280: 7373 6675 6c6c 792e 220a 2020 2020 2020  ssfully.".      
+00006290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000062b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000062c0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+000062d0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+000062e0: 2020 2020 2020 2020 2245 7665 6e74 2077          "Event w
+000062f0: 696c 6c20 6265 2073 6b69 7070 6564 2062  ill be skipped b
+00006300: 6563 6175 7365 2069 7420 7368 6f77 7320  ecause it shows 
+00006310: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00006320: 2020 2020 2020 6622 6d65 6d62 6572 7368        f"membersh
+00006330: 6970 2061 7320 277b 6576 656e 742e 6d65  ip as '{event.me
+00006340: 6d62 6572 7368 6970 7d27 2e22 0a20 2020  mbership}'.".   
+00006350: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00006360: 2020 2020 2020 2020 6578 6365 7074 2042          except B
+00006370: 6173 6545 7863 6570 7469 6f6e 3a0a 2020  aseException:.  
+00006380: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00006390: 2e64 6562 7567 2822 4865 7265 2069 7320  .debug("Here is 
+000063a0: 7468 6520 7472 6163 6562 6163 6b2e 5c6e  the traceback.\n
+000063b0: 2220 2b20 7472 6163 6562 6163 6b2e 666f  " + traceback.fo
+000063c0: 726d 6174 5f65 7863 2829 290a 0a20 2020  rmat_exc())..   
+000063d0: 2023 2061 6363 6f72 6469 6e67 2074 6f20   # according to 
+000063e0: 7079 6c61 6d61 3a20 6675 6e63 7469 6f6e  pylama: function
+000063f0: 2074 6f6f 2063 6f6d 706c 6578 3a20 4339   too complex: C9
+00006400: 3031 2023 206e 6f71 613a 2043 3930 310a  01 # noqa: C901.
+00006410: 2020 2020 6173 796e 6320 6465 6620 6d65      async def me
+00006420: 7373 6167 655f 6361 6c6c 6261 636b 2873  ssage_callback(s
+00006430: 656c 662c 2072 6f6f 6d3a 204d 6174 7269  elf, room: Matri
+00006440: 7852 6f6f 6d2c 2065 7665 6e74 293a 2020  xRoom, event):  
+00006450: 2320 6e6f 7161 3a20 4339 3031 0a20 2020  # noqa: C901.   
+00006460: 2020 2020 2022 2222 4861 6e64 6c65 2061       """Handle a
+00006470: 6c6c 2065 7665 6e74 7320 6f66 2074 7970  ll events of typ
+00006480: 6520 526f 6f6d 4d65 7373 6167 652e 0a0a  e RoomMessage...
+00006490: 2020 2020 2020 2020 496e 636c 7564 6573          Includes
+000064a0: 2065 7665 6e74 7320 6c69 6b65 2052 6f6f   events like Roo
+000064b0: 6d4d 6573 7361 6765 5465 7874 2c20 526f  mMessageText, Ro
+000064c0: 6f6d 4d65 7373 6167 6549 6d61 6765 2c20  omMessageImage, 
+000064d0: 6574 632e 0a20 2020 2020 2020 2022 2222  etc..        """
+000064e0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+000064f0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00006500: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00006510: 2020 2020 2020 2020 6622 6d65 7373 6167          f"messag
+00006520: 655f 6361 6c6c 6261 636b 2829 3a20 666f  e_callback(): fo
+00006530: 7220 726f 6f6d 207b 726f 6f6d 7d20 7265  r room {room} re
+00006540: 6365 6976 6564 2074 6869 7320 220a 2020  ceived this ".  
+00006550: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00006560: 6576 656e 743a 2074 7970 653a 207b 7479  event: type: {ty
+00006570: 7065 2865 7665 6e74 297d 2c20 6576 656e  pe(event)}, even
+00006580: 745f 6964 3a20 7b65 7665 6e74 2e65 7665  t_id: {event.eve
+00006590: 6e74 5f69 647d 2c20 220a 2020 2020 2020  nt_id}, ".      
+000065a0: 2020 2020 2020 2020 2020 6622 6576 656e            f"even
+000065b0: 743a 207b 6576 656e 747d 220a 2020 2020  t: {event}".    
+000065c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000065d0: 2020 2020 2020 6966 206e 6f74 2067 732e        if not gs.
+000065e0: 7061 2e6c 6973 7465 6e5f 7365 6c66 3a0a  pa.listen_self:.
+000065f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006600: 6966 2065 7665 6e74 2e73 656e 6465 7220  if event.sender 
+00006610: 3d3d 2073 656c 662e 636c 6965 6e74 2e75  == self.client.u
+00006620: 7365 723a 0a20 2020 2020 2020 2020 2020  ser:.           
+00006630: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00006640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006650: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00006660: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00006670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006680: 6622 536b 6970 7069 6e67 206d 6573 7361  f"Skipping messa
+00006690: 6765 2073 656e 7420 6279 206d 7973 656c  ge sent by mysel
+000066a0: 663a 207b 6576 656e 742e 626f 6479 7d22  f: {event.body}"
+000066b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000066c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000066d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000066e0: 7863 6570 7420 4174 7472 6962 7574 6545  xcept AttributeE
+000066f0: 7272 6f72 3a20 2023 2064 6f65 7320 6e6f  rror:  # does no
+00006700: 7420 6861 7665 202e 626f 6479 0a20 2020  t have .body.   
+00006710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006720: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00006730: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00006740: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00006750: 2253 6b69 7070 696e 6720 6d65 7373 6167  "Skipping messag
+00006760: 6520 7365 6e74 2062 7920 6d79 7365 6c66  e sent by myself
+00006770: 3a20 7b65 7665 6e74 7d22 0a20 2020 2020  : {event}".     
+00006780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006790: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000067a0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+000067b0: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+000067c0: 696c 6c69 7365 6320 7369 6e63 6520 3139  illisec since 19
+000067d0: 3730 0a20 2020 2020 2020 2020 2020 2067  70.            g
+000067e0: 732e 6c6f 672e 6465 6275 6728 6622 6576  s.log.debug(f"ev
+000067f0: 656e 742e 7365 7276 6572 5f74 696d 6573  ent.server_times
+00006800: 7461 6d70 203d 207b 6576 656e 742e 7365  tamp = {event.se
+00006810: 7276 6572 5f74 696d 6573 7461 6d70 7d22  rver_timestamp}"
+00006820: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
+00006830: 6d65 7374 616d 7020 3d20 6461 7465 7469  mestamp = dateti
+00006840: 6d65 2e64 6174 6574 696d 652e 6672 6f6d  me.datetime.from
+00006850: 7469 6d65 7374 616d 7028 0a20 2020 2020  timestamp(.     
+00006860: 2020 2020 2020 2020 2020 2069 6e74 2865             int(e
+00006870: 7665 6e74 2e73 6572 7665 725f 7469 6d65  vent.server_time
+00006880: 7374 616d 7020 2f20 3130 3030 290a 2020  stamp / 1000).  
+00006890: 2020 2020 2020 2020 2020 2920 2023 2073            )  # s
+000068a0: 6563 2073 696e 6365 2031 3937 300a 2020  ec since 1970.  
+000068b0: 2020 2020 2020 2020 2020 6576 656e 745f            event_
+000068c0: 6461 7465 7469 6d65 203d 2074 696d 6573  datetime = times
+000068d0: 7461 6d70 2e73 7472 6674 696d 6528 2225  tamp.strftime("%
+000068e0: 592d 256d 2d25 6420 2548 3a25 4d3a 2553  Y-%m-%d %H:%M:%S
+000068f0: 2229 0a20 2020 2020 2020 2020 2020 2023  ").            #
+00006900: 2065 2e67 2e20 3230 3230 2d30 382d 3036   e.g. 2020-08-06
+00006910: 2031 373a 3330 3a31 380a 2020 2020 2020   17:30:18.      
+00006920: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00006930: 7567 2866 2265 7665 6e74 5f64 6174 6574  ug(f"event_datet
+00006940: 696d 6520 3d20 7b65 7665 6e74 5f64 6174  ime = {event_dat
+00006950: 6574 696d 657d 2229 0a0a 2020 2020 2020  etime}")..      
+00006960: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00006970: 6e63 6528 6576 656e 742c 2052 6f6f 6d4d  nce(event, RoomM
+00006980: 6573 7361 6765 4d65 6469 6129 3a20 2023  essageMedia):  #
+00006990: 2066 6f72 2061 6c6c 206d 6564 6961 2065   for all media e
+000069a0: 7665 6e74 730a 2020 2020 2020 2020 2020  vents.          
+000069b0: 2020 2020 2020 6d78 6320 3d20 6576 656e        mxc = even
+000069c0: 742e 7572 6c20 2023 206d 6564 6961 206d  t.url  # media m
+000069d0: 7863 0a20 2020 2020 2020 2020 2020 2020  xc.             
+000069e0: 2020 2075 726c 203d 2061 7761 6974 2073     url = await s
+000069f0: 656c 662e 636c 6965 6e74 2e6d 7863 5f74  elf.client.mxc_t
+00006a00: 6f5f 6874 7470 286d 7863 2920 2023 206d  o_http(mxc)  # m
+00006a10: 6564 6961 2075 726c 0a20 2020 2020 2020  edia url.       
+00006a20: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00006a30: 6465 6275 6728 6622 4854 5450 2055 524c  debug(f"HTTP URL
+00006a40: 206f 6620 6d65 6469 6120 6973 203a 207b   of media is : {
+00006a50: 7572 6c7d 2229 0a20 2020 2020 2020 2020  url}").         
+00006a60: 2020 2020 2020 206d 7367 5f75 726c 203d         msg_url =
+00006a70: 2022 205b 2220 2b20 7572 6c20 2b20 225d   " [" + url + "]
+00006a80: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00006a90: 2020 6966 2067 732e 7061 2e64 6f77 6e6c    if gs.pa.downl
+00006aa0: 6f61 645f 6d65 6469 6120 213d 2022 223a  oad_media != "":
+00006ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006ac0: 2020 2020 2023 2064 6f77 6e6c 6f61 6420       # download 
+00006ad0: 756e 656e 6372 7970 7465 642f 706c 6169  unencrypted/plai
+00006ae0: 6e20 6d65 6469 6120 6669 6c65 0a20 2020  n media file.   
+00006af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b00: 2072 6573 7020 3d20 6177 6169 7420 646f   resp = await do
+00006b10: 776e 6c6f 6164 5f6d 7863 2873 656c 662e  wnload_mxc(self.
+00006b20: 636c 6965 6e74 2c20 6d78 6329 0a20 2020  client, mxc).   
+00006b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b40: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00006b50: 6573 702c 2044 6f77 6e6c 6f61 6445 7272  esp, DownloadErr
+00006b60: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00006b70: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00006b80: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
 00006b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ba0: 2061 7761 6974 2066 2e77 7269 7465 280a   await f.write(.
+00006ba0: 2020 2020 2020 2022 4531 3035 3a20 220a         "E105: ".
 00006bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bd0: 6372 7970 746f 2e61 7474 6163 686d 656e  crypto.attachmen
-00006be0: 7473 2e64 6563 7279 7074 5f61 7474 6163  ts.decrypt_attac
-00006bf0: 686d 656e 7428 0a20 2020 2020 2020 2020  hment(.         
+00006bc0: 2020 2020 2020 2020 2020 2020 6622 646f              f"do
+00006bd0: 776e 6c6f 6164 206f 6620 5552 4920 277b  wnload of URI '{
+00006be0: 6d78 637d 2720 746f 206c 6f63 616c 2066  mxc}' to local f
+00006bf0: 696c 6520 220a 2020 2020 2020 2020 2020  ile ".          
 00006c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c10: 2020 2020 2020 2020 2020 206d 6564 6961             media
-00006c20: 5f64 6174 612c 0a20 2020 2020 2020 2020  _data,.         
-00006c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c40: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00006c50: 2e73 6f75 7263 655b 2263 6f6e 7465 6e74  .source["content
-00006c60: 225d 5b22 6669 6c65 225d 5b22 6b65 7922  "]["file"]["key"
-00006c70: 5d5b 0a20 2020 2020 2020 2020 2020 2020  ][.             
-00006c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c90: 2020 2020 2020 2020 2020 2022 6b22 0a20             "k". 
-00006ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006cc0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00006c10: 2020 6622 6661 696c 6564 2077 6974 6820    f"failed with 
+00006c20: 7265 7370 6f6e 7365 207b 7072 6976 6163  response {privac
+00006c30: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00006c40: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
+00006c50: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00006c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c70: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+00006c80: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+00006c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ca0: 2020 6d73 675f 7572 6c20 2b3d 2022 205b    msg_url += " [
+00006cb0: 446f 776e 6c6f 6164 206f 6620 6d65 6469  Download of medi
+00006cc0: 6120 6669 6c65 2066 6169 6c65 645d 220a  a file failed]".
 00006cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ce0: 2020 2020 2020 2020 2020 6576 656e 742e            event.
-00006cf0: 736f 7572 6365 5b22 636f 6e74 656e 7422  source["content"
-00006d00: 5d5b 2266 696c 6522 5d5b 2268 6173 6865  ]["file"]["hashe
-00006d10: 7322 5d5b 0a20 2020 2020 2020 2020 2020  s"][.           
+00006ce0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00006cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d00: 2020 6d65 6469 615f 6461 7461 203d 2072    media_data = r
+00006d10: 6573 702e 626f 6479 0a20 2020 2020 2020  esp.body.       
 00006d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d30: 2020 2020 2020 2020 2020 2020 2022 7368               "sh
-00006d40: 6132 3536 220a 2020 2020 2020 2020 2020  a256".          
-00006d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d60: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00006d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d90: 2065 7665 6e74 2e73 6f75 7263 655b 2263   event.source["c
-00006da0: 6f6e 7465 6e74 225d 5b22 6669 6c65 225d  ontent"]["file"]
-00006db0: 5b22 6976 225d 2c0a 2020 2020 2020 2020  ["iv"],.        
+00006d30: 2066 696c 656e 616d 6520 3d20 6368 6f6f   filename = choo
+00006d40: 7365 5f61 7661 696c 6162 6c65 5f66 696c  se_available_fil
+00006d50: 656e 616d 6528 0a20 2020 2020 2020 2020  ename(.         
+00006d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d70: 2020 206f 732e 7061 7468 2e6a 6f69 6e28     os.path.join(
+00006d80: 6773 2e70 612e 646f 776e 6c6f 6164 5f6d  gs.pa.download_m
+00006d90: 6564 6961 2c20 6576 656e 742e 626f 6479  edia, event.body
+00006da0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00006db0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
 00006dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006dd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00006de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006df0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00006e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e10: 2020 2020 2320 5365 7420 6174 696d 6520      # Set atime 
-00006e20: 616e 6420 6d74 696d 6520 6f66 2066 696c  and mtime of fil
-00006e30: 6520 746f 2065 7665 6e74 2074 696d 6573  e to event times
-00006e40: 7461 6d70 0a20 2020 2020 2020 2020 2020  tamp.           
-00006e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e60: 206f 732e 7574 696d 6528 0a20 2020 2020   os.utime(.     
-00006e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e80: 2020 2020 2020 2020 2020 2066 696c 656e             filen
-00006e90: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-00006ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006eb0: 2020 2020 206e 733d 2828 6576 656e 742e       ns=((event.
-00006ec0: 7365 7276 6572 5f74 696d 6573 7461 6d70  server_timestamp
-00006ed0: 202a 2031 3030 3030 3030 2c29 202a 2032   * 1000000,) * 2
-00006ee0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00006ef0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00006f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006f10: 2020 2020 2020 2020 206d 7367 5f75 726c           msg_url
-00006f20: 202b 3d20 280a 2020 2020 2020 2020 2020   += (.          
+00006dd0: 2020 2020 6173 796e 6320 7769 7468 2061      async with a
+00006de0: 696f 6669 6c65 732e 6f70 656e 2866 696c  iofiles.open(fil
+00006df0: 656e 616d 652c 2022 7762 2229 2061 7320  ename, "wb") as 
+00006e00: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+00006e10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00006e20: 7761 6974 2066 2e77 7269 7465 286d 6564  wait f.write(med
+00006e30: 6961 5f64 6174 6129 0a20 2020 2020 2020  ia_data).       
+00006e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e50: 2020 2020 2023 2053 6574 2061 7469 6d65       # Set atime
+00006e60: 2061 6e64 206d 7469 6d65 206f 6620 6669   and mtime of fi
+00006e70: 6c65 2074 6f20 6576 656e 7420 7469 6d65  le to event time
+00006e80: 7374 616d 700a 2020 2020 2020 2020 2020  stamp.          
+00006e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ea0: 2020 6f73 2e75 7469 6d65 280a 2020 2020    os.utime(.    
+00006eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ec0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00006ed0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00006ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ef0: 2020 2020 2020 6e73 3d28 2865 7665 6e74        ns=((event
+00006f00: 2e73 6572 7665 725f 7469 6d65 7374 616d  .server_timestam
+00006f10: 7020 2a20 3130 3030 3030 302c 2920 2a20  p * 1000000,) * 
+00006f20: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
 00006f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f40: 2020 2220 5b44 6f77 6e6c 6f61 6465 6420    " [Downloaded 
-00006f50: 616e 6420 6465 6372 7970 7465 6420 6d65  and decrypted me
-00006f60: 6469 6120 220a 2020 2020 2020 2020 2020  dia ".          
-00006f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f80: 2020 6622 6669 6c65 2074 6f20 7b66 696c    f"file to {fil
-00006f90: 656e 616d 657d 5d22 0a20 2020 2020 2020  ename}]".       
-00006fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fb0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00006fc0: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-00006fd0: 656e 742c 2052 6f6f 6d4d 6573 7361 6765  ent, RoomMessage
-00006fe0: 4175 6469 6f29 3a0a 2020 2020 2020 2020  Audio):.        
-00006ff0: 2020 2020 2020 2020 6d73 6720 3d20 2252          msg = "R
-00007000: 6563 6569 7665 6420 6175 6469 6f3a 2022  eceived audio: "
-00007010: 202b 2065 7665 6e74 2e62 6f64 7920 2b20   + event.body + 
-00007020: 6d73 675f 7572 6c0a 2020 2020 2020 2020  msg_url.        
-00007030: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00007040: 6e63 6528 6576 656e 742c 2052 6f6f 6d4d  nce(event, RoomM
-00007050: 6573 7361 6765 456d 6f74 6529 3a0a 2020  essageEmote):.  
-00007060: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00007070: 6720 3d20 2252 6563 6569 7665 6420 656d  g = "Received em
-00007080: 6f74 653a 2022 202b 2065 7665 6e74 2e62  ote: " + event.b
-00007090: 6f64 790a 2020 2020 2020 2020 2020 2020  ody.            
-000070a0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-000070b0: 6576 656e 742c 2052 6f6f 6d4d 6573 7361  event, RoomMessa
-000070c0: 6765 4669 6c65 293a 0a20 2020 2020 2020  geFile):.       
-000070d0: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
-000070e0: 5265 6365 6976 6564 2066 696c 653a 2022  Received file: "
-000070f0: 202b 2065 7665 6e74 2e62 6f64 7920 2b20   + event.body + 
-00007100: 6d73 675f 7572 6c0a 2020 2020 2020 2020  msg_url.        
-00007110: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00007120: 6e63 6528 6576 656e 742c 2052 6f6f 6d4d  nce(event, RoomM
-00007130: 6573 7361 6765 466f 726d 6174 7465 6429  essageFormatted)
-00007140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007150: 2020 6d73 6720 3d20 6576 656e 742e 626f    msg = event.bo
-00007160: 6479 0a20 2020 2020 2020 2020 2020 2065  dy.            e
-00007170: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
-00007180: 7665 6e74 2c20 526f 6f6d 4d65 7373 6167  vent, RoomMessag
-00007190: 6549 6d61 6765 293a 0a20 2020 2020 2020  eImage):.       
-000071a0: 2020 2020 2020 2020 2023 2055 7375 616c           # Usual
-000071b0: 6c79 2062 6f64 7920 6973 2073 6f6d 6574  ly body is somet
-000071c0: 6869 6e67 206c 696b 6520 2269 6d61 6765  hing like "image
-000071d0: 2e73 7667 220a 2020 2020 2020 2020 2020  .svg".          
-000071e0: 2020 2020 2020 6d73 6720 3d20 2252 6563        msg = "Rec
-000071f0: 6569 7665 6420 696d 6167 653a 2022 202b  eived image: " +
-00007200: 2065 7665 6e74 2e62 6f64 7920 2b20 6d73   event.body + ms
-00007210: 675f 7572 6c0a 2020 2020 2020 2020 2020  g_url.          
-00007220: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00007230: 6528 6576 656e 742c 2052 6f6f 6d4d 6573  e(event, RoomMes
-00007240: 7361 6765 4e6f 7469 6365 293a 0a20 2020  sageNotice):.   
-00007250: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00007260: 203d 2065 7665 6e74 2e62 6f64 7920 2023   = event.body  #
-00007270: 2045 7874 7261 6374 2074 6865 206d 6573   Extract the mes
-00007280: 7361 6765 2074 6578 740a 2020 2020 2020  sage text.      
-00007290: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-000072a0: 7461 6e63 6528 6576 656e 742c 2052 6f6f  tance(event, Roo
-000072b0: 6d4d 6573 7361 6765 5465 7874 293a 0a20  mMessageText):. 
+00006f40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00006f50: 2020 2020 2020 2020 2020 6d73 675f 7572            msg_ur
+00006f60: 6c20 2b3d 2066 2220 5b44 6f77 6e6c 6f61  l += f" [Downloa
+00006f70: 6465 6420 6d65 6469 6120 6669 6c65 2074  ded media file t
+00006f80: 6f20 7b66 696c 656e 616d 657d 5d22 0a0a  o {filename}]"..
+00006f90: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00006fa0: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+00006fb0: 2052 6f6f 6d45 6e63 7279 7074 6564 4d65   RoomEncryptedMe
+00006fc0: 6469 6129 3a20 2023 2066 6f72 2061 6c6c  dia):  # for all
+00006fd0: 2065 3265 206d 6564 6961 0a20 2020 2020   e2e media.     
+00006fe0: 2020 2020 2020 2020 2020 206d 7863 203d             mxc =
+00006ff0: 2065 7665 6e74 2e75 726c 2020 2320 6d65   event.url  # me
+00007000: 6469 6120 6d78 630a 2020 2020 2020 2020  dia mxc.        
+00007010: 2020 2020 2020 2020 7572 6c20 3d20 6177          url = aw
+00007020: 6169 7420 7365 6c66 2e63 6c69 656e 742e  ait self.client.
+00007030: 6d78 635f 746f 5f68 7474 7028 6d78 6329  mxc_to_http(mxc)
+00007040: 2020 2320 6d65 6469 6120 7572 6c0a 2020    # media url.  
+00007050: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00007060: 2e6c 6f67 2e64 6562 7567 2866 2248 5454  .log.debug(f"HTT
+00007070: 5020 5552 4c20 6f66 206d 6564 6961 2069  P URL of media i
+00007080: 7320 3a20 7b75 726c 7d22 290a 2020 2020  s : {url}").    
+00007090: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
+000070a0: 7572 6c20 3d20 2220 5b22 202b 2075 726c  url = " [" + url
+000070b0: 202b 2022 5d22 0a20 2020 2020 2020 2020   + "]".         
+000070c0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
+000070d0: 646f 776e 6c6f 6164 5f6d 6564 6961 2021  download_media !
+000070e0: 3d20 2222 3a0a 2020 2020 2020 2020 2020  = "":.          
+000070f0: 2020 2020 2020 2020 2020 2320 646f 776e            # down
+00007100: 6c6f 6164 2065 6e63 7279 7074 6564 206d  load encrypted m
+00007110: 6564 6961 2066 696c 650a 2020 2020 2020  edia file.      
+00007120: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00007130: 7370 203d 2061 7761 6974 2064 6f77 6e6c  sp = await downl
+00007140: 6f61 645f 6d78 6328 7365 6c66 2e63 6c69  oad_mxc(self.cli
+00007150: 656e 742c 206d 7863 290a 2020 2020 2020  ent, mxc).      
+00007160: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00007170: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+00007180: 2c20 446f 776e 6c6f 6164 4572 726f 7229  , DownloadError)
+00007190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000071a0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+000071b0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+000071c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071d0: 2020 2020 2245 3130 363a 2022 0a20 2020      "E106: ".   
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 2020 2020 2020 2020 2066 2264 6f77 6e6c           f"downl
+00007200: 6f61 6420 6f66 2055 5249 2027 7b6d 7863  oad of URI '{mxc
+00007210: 7d27 2074 6f20 6c6f 6361 6c20 6669 6c65  }' to local file
+00007220: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00007230: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007240: 2266 6169 6c65 6420 7769 7468 2072 6573  "failed with res
+00007250: 706f 6e73 6520 7b70 7269 7661 6379 5f66  ponse {privacy_f
+00007260: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+00007270: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00007280: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00007290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072a0: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+000072b0: 7420 2b3d 2031 0a20 2020 2020 2020 2020  t += 1.         
 000072c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000072d0: 7367 203d 2065 7665 6e74 2e62 6f64 7920  sg = event.body 
-000072e0: 2023 2045 7874 7261 6374 2074 6865 206d   # Extract the m
-000072f0: 6573 7361 6765 2074 6578 740a 2020 2020  essage text.    
-00007300: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00007310: 6e73 7461 6e63 6528 6576 656e 742c 2052  nstance(event, R
-00007320: 6f6f 6d4d 6573 7361 6765 556e 6b6e 6f77  oomMessageUnknow
-00007330: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-00007340: 2020 2020 6d73 6720 3d20 2252 6563 6569      msg = "Recei
-00007350: 7665 6420 726f 6f6d 206d 6573 7361 6765  ved room message
-00007360: 206f 6620 756e 6b6e 6f77 6e20 7479 7065   of unknown type
-00007370: 3a20 2220 2b20 6576 656e 742e 6d73 6774  : " + event.msgt
-00007380: 7970 650a 2020 2020 2020 2020 2020 2020  ype.            
-00007390: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-000073a0: 6576 656e 742c 2052 6f6f 6d4d 6573 7361  event, RoomMessa
-000073b0: 6765 5669 6465 6f29 3a0a 2020 2020 2020  geVideo):.      
-000073c0: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-000073d0: 2252 6563 6569 7665 6420 7669 6465 6f3a  "Received video:
-000073e0: 2022 202b 2065 7665 6e74 2e62 6f64 7920   " + event.body 
-000073f0: 2b20 6d73 675f 7572 6c0a 2020 2020 2020  + msg_url.      
-00007400: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00007410: 7461 6e63 6528 6576 656e 742c 2052 6f6f  tance(event, Roo
-00007420: 6d45 6e63 7279 7074 6564 4175 6469 6f29  mEncryptedAudio)
-00007430: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007440: 2020 6d73 6720 3d20 2252 6563 6569 7665    msg = "Receive
-00007450: 6420 656e 6372 7970 7465 6420 6175 6469  d encrypted audi
-00007460: 6f3a 2022 202b 2065 7665 6e74 2e62 6f64  o: " + event.bod
-00007470: 7920 2b20 6d73 675f 7572 6c0a 2020 2020  y + msg_url.    
-00007480: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00007490: 6e73 7461 6e63 6528 6576 656e 742c 2052  nstance(event, R
-000074a0: 6f6f 6d45 6e63 7279 7074 6564 4669 6c65  oomEncryptedFile
-000074b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000074c0: 2020 206d 7367 203d 2022 5265 6365 6976     msg = "Receiv
-000074d0: 6564 2065 6e63 7279 7074 6564 2066 696c  ed encrypted fil
-000074e0: 653a 2022 202b 2065 7665 6e74 2e62 6f64  e: " + event.bod
-000074f0: 7920 2b20 6d73 675f 7572 6c0a 2020 2020  y + msg_url.    
-00007500: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00007510: 6e73 7461 6e63 6528 6576 656e 742c 2052  nstance(event, R
-00007520: 6f6f 6d45 6e63 7279 7074 6564 496d 6167  oomEncryptedImag
-00007530: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00007540: 2020 2020 2320 5573 7561 6c6c 7920 626f      # Usually bo
-00007550: 6479 2069 7320 736f 6d65 7468 696e 6720  dy is something 
-00007560: 6c69 6b65 2022 696d 6167 652e 7376 6722  like "image.svg"
+000072d0: 7367 5f75 726c 202b 3d20 2220 5b44 6f77  sg_url += " [Dow
+000072e0: 6e6c 6f61 6420 6f66 206d 6564 6961 2066  nload of media f
+000072f0: 696c 6520 6661 696c 6564 5d22 0a20 2020  ile failed]".   
+00007300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007310: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00007320: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00007330: 6564 6961 5f64 6174 6120 3d20 7265 7370  edia_data = resp
+00007340: 2e62 6f64 790a 2020 2020 2020 2020 2020  .body.          
+00007350: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00007360: 6c65 6e61 6d65 203d 2063 686f 6f73 655f  lename = choose_
+00007370: 6176 6169 6c61 626c 655f 6669 6c65 6e61  available_filena
+00007380: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
+00007390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000073a0: 6f73 2e70 6174 682e 6a6f 696e 2867 732e  os.path.join(gs.
+000073b0: 7061 2e64 6f77 6e6c 6f61 645f 6d65 6469  pa.download_medi
+000073c0: 612c 2065 7665 6e74 2e62 6f64 7929 0a20  a, event.body). 
+000073d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000073e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000073f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007400: 2061 7379 6e63 2077 6974 6820 6169 6f66   async with aiof
+00007410: 696c 6573 2e6f 7065 6e28 6669 6c65 6e61  iles.open(filena
+00007420: 6d65 2c20 2277 6222 2920 6173 2066 3a0a  me, "wb") as f:.
+00007430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007440: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00007450: 7420 662e 7772 6974 6528 0a20 2020 2020  t f.write(.     
+00007460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007470: 2020 2020 2020 2020 2020 2063 7279 7074             crypt
+00007480: 6f2e 6174 7461 6368 6d65 6e74 732e 6465  o.attachments.de
+00007490: 6372 7970 745f 6174 7461 6368 6d65 6e74  crypt_attachment
+000074a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000074b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000074c0: 2020 2020 2020 6d65 6469 615f 6461 7461        media_data
+000074d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000074e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000074f0: 2020 2020 2020 6576 656e 742e 736f 7572        event.sour
+00007500: 6365 5b22 636f 6e74 656e 7422 5d5b 2266  ce["content"]["f
+00007510: 696c 6522 5d5b 226b 6579 225d 5b0a 2020  ile"]["key"][.  
+00007520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007540: 2020 2020 2020 226b 220a 2020 2020 2020        "k".      
+00007550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007560: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
 00007570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007580: 206d 7367 203d 2022 5265 6365 6976 6564   msg = "Received
-00007590: 2065 6e63 7279 7074 6564 2069 6d61 6765   encrypted image
-000075a0: 3a20 2220 2b20 6576 656e 742e 626f 6479  : " + event.body
-000075b0: 202b 206d 7367 5f75 726c 0a20 2020 2020   + msg_url.     
-000075c0: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-000075d0: 7374 616e 6365 2865 7665 6e74 2c20 526f  stance(event, Ro
-000075e0: 6f6d 456e 6372 7970 7465 6456 6964 656f  omEncryptedVideo
-000075f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00007600: 2020 206d 7367 203d 2022 5265 6365 6976     msg = "Receiv
-00007610: 6564 2065 6e63 7279 7074 6564 2076 6964  ed encrypted vid
-00007620: 656f 3a20 2220 2b20 6576 656e 742e 626f  eo: " + event.bo
-00007630: 6479 202b 206d 7367 5f75 726c 0a20 2020  dy + msg_url.   
-00007640: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00007650: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
-00007660: 526f 6f6d 4d65 7373 6167 654d 6564 6961  RoomMessageMedia
-00007670: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00007680: 2020 2023 2074 6869 7320 7368 6f75 6c64     # this should
-00007690: 206e 6576 6572 2062 6520 7265 6163 6865   never be reache
-000076a0: 642c 2074 6869 7320 6973 2061 2062 6173  d, this is a bas
-000076b0: 6520 636c 6173 730a 2020 2020 2020 2020  e class.        
-000076c0: 2020 2020 2020 2020 2320 6974 2073 686f          # it sho
-000076d0: 756c 6420 6265 2061 2061 7564 696f 2c20  uld be a audio, 
-000076e0: 696d 6167 652c 2076 6964 656f 2c20 6574  image, video, et
-000076f0: 632e 0a20 2020 2020 2020 2020 2020 2020  c..             
-00007700: 2020 2023 2050 7574 2068 6572 6520 6174     # Put here at
-00007710: 2074 6865 2065 6e64 2061 7320 6465 6665   the end as defe
-00007720: 6e73 6976 6520 7072 6f67 7261 6d6d 696e  nsive programmin
-00007730: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-00007740: 2020 6d73 6720 3d20 2252 6563 6569 7665    msg = "Receive
-00007750: 6420 6d65 6469 613a 2022 202b 2065 7665  d media: " + eve
-00007760: 6e74 2e62 6f64 7920 2b20 6d73 675f 7572  nt.body + msg_ur
-00007770: 6c0a 2020 2020 2020 2020 2020 2020 656c  l.            el
-00007780: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-00007790: 656e 742c 2052 6f6f 6d45 6e63 7279 7074  ent, RoomEncrypt
-000077a0: 6564 4d65 6469 6129 3a0a 2020 2020 2020  edMedia):.      
-000077b0: 2020 2020 2020 2020 2020 2320 7468 6973            # this
-000077c0: 2073 686f 756c 6420 6e65 7665 7220 6265   should never be
-000077d0: 2072 6561 6368 6564 2c20 7468 6973 2069   reached, this i
-000077e0: 7320 6120 6261 7365 2063 6c61 7373 0a20  s a base class. 
-000077f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007800: 2069 7420 7368 6f75 6c64 2062 6520 6120   it should be a 
-00007810: 6175 6469 6f2c 2069 6d61 6765 2c20 7669  audio, image, vi
-00007820: 6465 6f2c 2065 7463 2e0a 2020 2020 2020  deo, etc..      
-00007830: 2020 2020 2020 2020 2020 2320 5075 7420            # Put 
-00007840: 6865 7265 2061 7420 7468 6520 656e 6420  here at the end 
-00007850: 6173 2064 6566 656e 7369 7665 2070 726f  as defensive pro
-00007860: 6772 616d 6d69 6e67 0a20 2020 2020 2020  gramming.       
-00007870: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
-00007880: 5265 6365 6976 6564 2065 6e63 7279 7074  Received encrypt
-00007890: 6564 206d 6564 6961 3a20 2220 2b20 6576  ed media: " + ev
-000078a0: 656e 742e 626f 6479 202b 206d 7367 5f75  ent.body + msg_u
-000078b0: 726c 0a20 2020 2020 2020 2020 2020 2065  rl.            e
-000078c0: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
-000078d0: 7665 6e74 2c20 526f 6f6d 4d65 6d62 6572  vent, RoomMember
-000078e0: 4576 656e 7429 3a0a 2020 2020 2020 2020  Event):.        
-000078f0: 2020 2020 2020 2020 6d73 6720 3d20 280a          msg = (.
-00007900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007910: 2020 2020 2252 6563 6569 7665 6420 726f      "Received ro
-00007920: 6f6d 2d6d 656d 6265 7220 6576 656e 743a  om-member event:
-00007930: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00007940: 2020 2020 2020 2066 2273 656e 6465 723a         f"sender:
-00007950: 207b 6576 656e 742e 7365 6e64 6572 7d2c   {event.sender},
-00007960: 206f 7065 7261 7469 6f6e 3a20 7b65 7665   operation: {eve
-00007970: 6e74 2e6d 656d 6265 7273 6869 707d 220a  nt.membership}".
-00007980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007990: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-000079a0: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-000079b0: 656e 742c 2052 6f6f 6d45 6e63 7279 7074  ent, RoomEncrypt
-000079c0: 696f 6e45 7665 6e74 293a 0a20 2020 2020  ionEvent):.     
-000079d0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-000079e0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-000079f0: 2020 2020 2020 2022 5265 6365 6976 6564         "Received
-00007a00: 2072 6f6f 6d2d 656e 6372 7970 7469 6f6e   room-encryption
-00007a10: 2065 7665 6e74 3a20 220a 2020 2020 2020   event: ".      
-00007a20: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00007a30: 7365 6e64 6572 3a20 7b65 7665 6e74 2e73  sender: {event.s
-00007a40: 656e 6465 727d 220a 2020 2020 2020 2020  ender}".        
-00007a50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00007a60: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00007a70: 7461 6e63 6528 6576 656e 742c 2052 6f6f  tance(event, Roo
-00007a80: 6d41 6c69 6173 4576 656e 7429 3a0a 2020  mAliasEvent):.  
-00007a90: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00007aa0: 6720 3d20 280a 2020 2020 2020 2020 2020  g = (.          
-00007ab0: 2020 2020 2020 2020 2020 2252 6563 6569            "Recei
-00007ac0: 7665 6420 726f 6f6d 2d61 6c69 6173 2065  ved room-alias e
-00007ad0: 7665 6e74 3a20 7365 6e64 6572 3a20 220a  vent: sender: ".
-00007ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007af0: 2020 2020 6622 7b65 7665 6e74 2e73 656e      f"{event.sen
-00007b00: 6465 727d 2c20 616c 6961 733a 207b 6576  der}, alias: {ev
-00007b10: 656e 742e 6361 6e6f 6e69 6361 6c5f 616c  ent.canonical_al
-00007b20: 6961 737d 220a 2020 2020 2020 2020 2020  ias}".          
-00007b30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00007b40: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00007b50: 6e63 6528 6576 656e 742c 2052 6f6f 6d4e  nce(event, RoomN
-00007b60: 616d 6545 7665 6e74 293a 0a20 2020 2020  ameEvent):.     
-00007b70: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-00007b80: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00007b90: 2020 2020 2020 2022 5265 6365 6976 6564         "Received
-00007ba0: 2072 6f6f 6d2d 6e61 6d65 2065 7665 6e74   room-name event
-00007bb0: 3a20 7365 6e64 6572 3a20 220a 2020 2020  : sender: ".    
-00007bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007bd0: 6622 7b65 7665 6e74 2e73 656e 6465 727d  f"{event.sender}
-00007be0: 2c20 726f 6f6d 206e 616d 653a 207b 6576  , room name: {ev
-00007bf0: 656e 742e 6e61 6d65 7d22 0a20 2020 2020  ent.name}".     
-00007c00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007c10: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00007c20: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
-00007c30: 5265 6461 6374 6564 4576 656e 7429 3a0a  RedactedEvent):.
-00007c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c50: 6d73 6720 3d20 280a 2020 2020 2020 2020  msg = (.        
-00007c60: 2020 2020 2020 2020 2020 2020 2252 6563              "Rec
-00007c70: 6569 7665 6420 7265 6461 6374 6564 2065  eived redacted e
-00007c80: 7665 6e74 3a20 220a 2020 2020 2020 2020  vent: ".        
-00007c90: 2020 2020 2020 2020 2020 2020 6622 7365              f"se
-00007ca0: 6e64 6572 3a20 7b65 7665 6e74 2e73 656e  nder: {event.sen
-00007cb0: 6465 727d 2c20 220a 2020 2020 2020 2020  der}, ".        
-00007cc0: 2020 2020 2020 2020 2020 2020 6622 7479              f"ty
-00007cd0: 7065 3a20 7b65 7665 6e74 2e74 7970 657d  pe: {event.type}
-00007ce0: 2c20 7265 6461 6374 6572 3a20 7b65 7665  , redacter: {eve
-00007cf0: 6e74 2e72 6564 6163 7465 727d 220a 2020  nt.redacter}".  
-00007d00: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00007d10: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00007d20: 2069 7369 6e73 7461 6e63 6528 6576 656e   isinstance(even
-00007d30: 742c 2052 6564 6163 7469 6f6e 4576 656e  t, RedactionEven
-00007d40: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00007d50: 2020 2020 6d73 6720 3d20 280a 2020 2020      msg = (.    
-00007d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d70: 2252 6563 6569 7665 6420 7265 6461 6374  "Received redact
-00007d80: 696f 6e20 6576 656e 743a 2022 0a20 2020  ion event: ".   
-00007d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007da0: 2066 2273 656e 6465 723a 207b 6576 656e   f"sender: {even
-00007db0: 742e 7365 6e64 6572 7d2c 2022 0a20 2020  t.sender}, ".   
-00007dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007dd0: 2066 2272 6564 6163 7473 3a20 7b65 7665   f"redacts: {eve
-00007de0: 6e74 2e72 6564 6163 7473 7d22 0a20 2020  nt.redacts}".   
-00007df0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00007e00: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00007e10: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
-00007e20: 2c20 556e 6b6e 6f77 6e45 7665 6e74 293a  , UnknownEvent):
-00007e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007e40: 2069 6620 6576 656e 742e 7479 7065 203d   if event.type =
-00007e50: 3d20 226d 2e72 6561 6374 696f 6e22 3a0a  = "m.reaction":.
-00007e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e70: 2020 2020 6d73 6720 3d20 280a 2020 2020      msg = (.    
-00007e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e90: 2020 2020 2252 6563 6569 7665 6420 6120      "Received a 
-00007ea0: 7265 6163 7469 6f6e 2c20 616e 2065 6d6f  reaction, an emo
-00007eb0: 6a69 3a20 220a 2020 2020 2020 2020 2020  ji: ".          
-00007ec0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00007ed0: 7b65 7665 6e74 2e73 6f75 7263 655b 2763  {event.source['c
-00007ee0: 6f6e 7465 6e74 275d 5b27 6d2e 7265 6c61  ontent']['m.rela
-00007ef0: 7465 735f 746f 275d 5b27 6b65 7927 5d7d  tes_to']['key']}
-00007f00: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00007f10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00007f20: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00007f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f40: 2020 6d73 6720 3d20 6622 5265 6365 6976    msg = f"Receiv
-00007f50: 6564 2075 6e6b 6e6f 776e 2065 7665 6e74  ed unknown event
-00007f60: 3a20 7b65 7665 6e74 7d22 0a20 2020 2020  : {event}".     
-00007f70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00007f80: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00007f90: 203d 2066 2252 6563 6569 7665 6420 756e   = f"Received un
-00007fa0: 6b6e 6f77 6e20 6576 656e 743a 207b 6576  known event: {ev
-00007fb0: 656e 747d 220a 0a20 2020 2020 2020 2020  ent}"..         
-00007fc0: 2020 2023 2069 6620 6576 656e 745b 2774     # if event['t
-00007fd0: 7970 6527 5d20 3d3d 2022 6d2e 726f 6f6d  ype'] == "m.room
-00007fe0: 2e6d 6573 7361 6765 223a 0a20 2020 2020  .message":.     
-00007ff0: 2020 2020 2020 2023 2020 2020 6966 2065         #    if e
-00008000: 7665 6e74 5b27 636f 6e74 656e 7427 5d5b  vent['content'][
-00008010: 276d 7367 7479 7065 275d 203d 3d20 226d  'msgtype'] == "m
-00008020: 2e74 6578 7422 3a0a 2020 2020 2020 2020  .text":.        
-00008030: 2020 2020 2320 2020 2020 2020 2063 6f6e      #        con
-00008040: 7465 6e74 203d 2065 7665 6e74 5b27 636f  tent = event['co
-00008050: 6e74 656e 7427 5d5b 2762 6f64 7927 5d0a  ntent']['body'].
-00008060: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00008070: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00008080: 2020 2023 2020 2020 2020 2020 646f 776e     #        down
-00008090: 6c6f 6164 5f75 726c 203d 2061 7069 2e67  load_url = api.g
-000080a0: 6574 5f64 6f77 6e6c 6f61 645f 7572 6c28  et_download_url(
-000080b0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-000080c0: 2020 2020 2020 2020 2020 6576 656e 745b            event[
-000080d0: 2763 6f6e 7465 6e74 275d 5b27 7572 6c27  'content']['url'
-000080e0: 5d29 0a20 2020 2020 2020 2020 2020 2023  ]).            #
-000080f0: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
-00008100: 3d20 646f 776e 6c6f 6164 5f75 726c 0a20  = download_url. 
-00008110: 2020 2020 2020 2020 2020 2023 2065 6c73             # els
-00008120: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00008130: 2020 2020 636f 6e74 656e 7420 3d20 225c      content = "\
-00008140: 6e7b 7b20 2220 2b20 6576 656e 745b 2774  n{{ " + event['t
-00008150: 7970 6527 5d20 2b20 2220 6576 656e 7420  ype'] + " event 
-00008160: 7d7d 5c6e 220a 2020 2020 2020 2020 2020  }}\n".          
-00008170: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00008180: 2274 7970 6528 6d73 6729 203d 207b 7479  "type(msg) = {ty
-00008190: 7065 286d 7367 297d 2e20 6d73 6720 6973  pe(msg)}. msg is
-000081a0: 2061 2073 7472 696e 6722 290a 2020 2020   a string").    
-000081b0: 2020 2020 2020 2020 7365 6e64 6572 5f6e          sender_n
-000081c0: 6963 6b20 3d20 726f 6f6d 2e75 7365 725f  ick = room.user_
-000081d0: 6e61 6d65 2865 7665 6e74 2e73 656e 6465  name(event.sende
-000081e0: 7229 0a20 2020 2020 2020 2020 2020 2069  r).            i
-000081f0: 6620 6e6f 7420 7365 6e64 6572 5f6e 6963  f not sender_nic
-00008200: 6b3a 2020 2320 636f 6e76 6572 7420 4066  k:  # convert @f
-00008210: 6f6f 3a6d 6174 2e69 6f20 696e 746f 2066  oo:mat.io into f
-00008220: 6f6f 0a20 2020 2020 2020 2020 2020 2020  oo.             
-00008230: 2020 2073 656e 6465 725f 6e69 636b 203d     sender_nick =
-00008240: 2075 7365 725f 6964 5f74 6f5f 7368 6f72   user_id_to_shor
-00008250: 745f 7573 6572 5f6e 616d 6528 6576 656e  t_user_name(even
-00008260: 742e 7365 6e64 6572 290a 2020 2020 2020  t.sender).      
-00008270: 2020 2020 2020 726f 6f6d 5f6e 6963 6b20        room_nick 
-00008280: 3d20 726f 6f6d 2e64 6973 706c 6179 5f6e  = room.display_n
-00008290: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
-000082a0: 6966 2072 6f6f 6d5f 6e69 636b 2069 6e20  if room_nick in 
-000082b0: 284e 6f6e 652c 2022 222c 2022 456d 7074  (None, "", "Empt
-000082c0: 7920 526f 6f6d 2229 3a0a 2020 2020 2020  y Room"):.      
-000082d0: 2020 2020 2020 2020 2020 726f 6f6d 5f6e            room_n
-000082e0: 6963 6b20 3d20 2255 6e64 6574 6572 6d69  ick = "Undetermi
-000082f0: 6e65 6422 0a20 2020 2020 2020 2020 2020  ned".           
-00008300: 2069 6620 6773 2e70 612e 7072 696e 745f   if gs.pa.print_
-00008310: 6576 656e 745f 6964 3a0a 2020 2020 2020  event_id:.      
-00008320: 2020 2020 2020 2020 2020 6576 656e 745f            event_
-00008330: 6964 5f64 6574 6169 6c20 3d20 6622 207c  id_detail = f" |
-00008340: 207b 6576 656e 742e 6576 656e 745f 6964   {event.event_id
-00008350: 7d22 0a20 2020 2020 2020 2020 2020 2065  }".            e
-00008360: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00008370: 2020 2020 2065 7665 6e74 5f69 645f 6465       event_id_de
-00008380: 7461 696c 203d 2022 220a 2020 2020 2020  tail = "".      
-00008390: 2020 2020 2020 2320 5072 6576 656e 7420        # Prevent 
-000083a0: 6661 6b69 6e67 206d 6573 7361 6765 7320  faking messages 
-000083b0: 6279 2070 7265 6669 7869 6e67 2065 6163  by prefixing eac
-000083c0: 6820 6c69 6e65 206f 6620 6120 6d75 6c74  h line of a mult
-000083d0: 696c 696e 650a 2020 2020 2020 2020 2020  iline.          
-000083e0: 2020 2320 6d65 7373 6167 6520 7769 7468    # message with
-000083f0: 2073 7061 6365 2e0a 2020 2020 2020 2020   space..        
-00008400: 2020 2020 6669 7865 645f 6d73 6720 3d20      fixed_msg = 
-00008410: 7265 2e73 7562 2822 5c6e 222c 2022 5c6e  re.sub("\n", "\n
-00008420: 2020 2020 222c 206d 7367 290a 2020 2020      ", msg).    
-00008430: 2020 2020 2020 2020 636f 6d70 6c65 7465          complete
-00008440: 5f6d 7367 203d 2028 0a20 2020 2020 2020  _msg = (.       
-00008450: 2020 2020 2020 2020 2022 4d65 7373 6167           "Messag
-00008460: 6520 7265 6365 6976 6564 2066 6f72 2072  e received for r
-00008470: 6f6f 6d20 220a 2020 2020 2020 2020 2020  oom ".          
-00008480: 2020 2020 2020 6622 7b72 6f6f 6d5f 6e69        f"{room_ni
-00008490: 636b 7d20 5b7b 726f 6f6d 2e72 6f6f 6d5f  ck} [{room.room_
-000084a0: 6964 7d5d 207c 2022 0a20 2020 2020 2020  id}] | ".       
-000084b0: 2020 2020 2020 2020 2066 2273 656e 6465           f"sende
-000084c0: 7220 7b73 656e 6465 725f 6e69 636b 7d20  r {sender_nick} 
-000084d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000084e0: 2020 6622 5b7b 6576 656e 742e 7365 6e64    f"[{event.send
-000084f0: 6572 7d5d 207c 207b 6576 656e 745f 6461  er}] | {event_da
-00008500: 7465 7469 6d65 7d22 0a20 2020 2020 2020  tetime}".       
-00008510: 2020 2020 2020 2020 2066 227b 6576 656e           f"{even
-00008520: 745f 6964 5f64 6574 6169 6c7d 207c 207b  t_id_detail} | {
-00008530: 6669 7865 645f 6d73 677d 220a 2020 2020  fixed_msg}".    
-00008540: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00008550: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00008560: 7567 2863 6f6d 706c 6574 655f 6d73 6729  ug(complete_msg)
-00008570: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
-00008580: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
-00008590: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
-000085a0: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
-000085b0: 2020 2020 2020 7465 7874 203d 2063 6f6d        text = com
-000085c0: 706c 6574 655f 6d73 6720 2023 2070 7269  plete_msg  # pri
-000085d0: 6e74 2074 6865 2072 6563 6569 7665 6420  nt the received 
-000085e0: 6d65 7373 6167 650a 2020 2020 2020 2020  message.        
-000085f0: 2020 2020 6a73 6f6e 5f20 3d20 7b22 736f      json_ = {"so
-00008600: 7572 6365 223a 2065 7665 6e74 2e73 6f75  urce": event.sou
-00008610: 7263 657d 0a20 2020 2020 2020 2020 2020  rce}.           
-00008620: 206a 736f 6e5f 2e75 7064 6174 6528 7b22   json_.update({"
-00008630: 726f 6f6d 223a 2072 6f6f 6d7d 290a 2020  room": room}).  
-00008640: 2020 2020 2020 2020 2020 6a73 6f6e 5f2e            json_.
-00008650: 7570 6461 7465 287b 2272 6f6f 6d5f 6469  update({"room_di
-00008660: 7370 6c61 795f 6e61 6d65 223a 2072 6f6f  splay_name": roo
-00008670: 6d2e 6469 7370 6c61 795f 6e61 6d65 7d29  m.display_name})
-00008680: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-00008690: 6e5f 2e75 7064 6174 6528 7b22 7365 6e64  n_.update({"send
-000086a0: 6572 5f6e 6963 6b22 3a20 7365 6e64 6572  er_nick": sender
-000086b0: 5f6e 6963 6b7d 290a 2020 2020 2020 2020  _nick}).        
-000086c0: 2020 2020 6a73 6f6e 5f2e 7570 6461 7465      json_.update
-000086d0: 287b 2265 7665 6e74 5f64 6174 6574 696d  ({"event_datetim
-000086e0: 6522 3a20 6576 656e 745f 6461 7465 7469  e": event_dateti
-000086f0: 6d65 7d29 0a20 2020 2020 2020 2020 2020  me}).           
-00008700: 206a 736f 6e5f 6d61 7820 3d20 6576 656e   json_max = even
-00008710: 742e 5f5f 6469 6374 5f5f 0a20 2020 2020  t.__dict__.     
-00008720: 2020 2020 2020 206a 736f 6e5f 6d61 782e         json_max.
-00008730: 7570 6461 7465 287b 2272 6f6f 6d22 3a20  update({"room": 
-00008740: 726f 6f6d 7d29 0a20 2020 2020 2020 2020  room}).         
-00008750: 2020 206a 736f 6e5f 6d61 782e 7570 6461     json_max.upda
-00008760: 7465 287b 2272 6f6f 6d5f 6469 7370 6c61  te({"room_displa
-00008770: 795f 6e61 6d65 223a 2072 6f6f 6d2e 6469  y_name": room.di
-00008780: 7370 6c61 795f 6e61 6d65 7d29 0a20 2020  splay_name}).   
-00008790: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-000087a0: 782e 7570 6461 7465 287b 2273 656e 6465  x.update({"sende
-000087b0: 725f 6e69 636b 223a 2073 656e 6465 725f  r_nick": sender_
-000087c0: 6e69 636b 7d29 0a20 2020 2020 2020 2020  nick}).         
-000087d0: 2020 206a 736f 6e5f 6d61 782e 7570 6461     json_max.upda
-000087e0: 7465 287b 2265 7665 6e74 5f64 6174 6574  te({"event_datet
-000087f0: 696d 6522 3a20 6576 656e 745f 6461 7465  ime": event_date
-00008800: 7469 6d65 7d29 0a20 2020 2020 2020 2020  time}).         
-00008810: 2020 206a 736f 6e5f 7370 6563 203d 2065     json_spec = e
-00008820: 7665 6e74 2e73 6f75 7263 650a 2020 2020  vent.source.    
-00008830: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
-00008840: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-00008850: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
-00008860: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-00008870: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
-00008880: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00008890: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
-000088a0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-000088b0: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
-000088c0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-000088d0: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
-000088e0: 6563 2c0a 2020 2020 2020 2020 2020 2020  ec,.            
-000088f0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00008900: 6620 6773 2e70 612e 6f73 5f6e 6f74 6966  f gs.pa.os_notif
-00008910: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00008920: 2020 2061 7661 7461 725f 7572 6c20 3d20     avatar_url = 
-00008930: 6177 6169 7420 6765 745f 6176 6174 6172  await get_avatar
-00008940: 5f75 726c 2873 656c 662e 636c 6965 6e74  _url(self.client
-00008950: 2c20 6576 656e 742e 7365 6e64 6572 290a  , event.sender).
-00008960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008970: 6e6f 7469 6679 280a 2020 2020 2020 2020  notify(.        
-00008980: 2020 2020 2020 2020 2020 2020 6622 4672              f"Fr
-00008990: 6f6d 207b 726f 6f6d 2e75 7365 725f 6e61  om {room.user_na
-000089a0: 6d65 2865 7665 6e74 2e73 656e 6465 7229  me(event.sender)
-000089b0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-000089c0: 2020 2020 2020 2020 6d73 675b 3a31 3630          msg[:160
-000089d0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000089e0: 2020 2020 2020 2061 7661 7461 725f 7572         avatar_ur
-000089f0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-00008a00: 2020 2029 0a0a 2020 2020 2020 2020 6578     )..        ex
-00008a10: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
-00008a20: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00008a30: 6773 2e6c 6f67 2e64 6562 7567 2822 4865  gs.log.debug("He
-00008a40: 7265 2069 7320 7468 6520 7472 6163 6562  re is the traceb
-00008a50: 6163 6b2e 5c6e 2220 2b20 7472 6163 6562  ack.\n" + traceb
-00008a60: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
-00008a70: 290a 0a20 2020 2023 2061 6363 6f72 6469  )..    # accordi
-00008a80: 6e67 2074 6f20 6c69 6e74 6572 3a20 6675  ng to linter: fu
-00008a90: 6e63 7469 6f6e 2069 7320 746f 6f20 636f  nction is too co
-00008aa0: 6d70 6c65 782c 2043 3930 310a 2020 2020  mplex, C901.    
-00008ab0: 6173 796e 6320 6465 6620 746f 5f64 6576  async def to_dev
-00008ac0: 6963 655f 6361 6c6c 6261 636b 2873 656c  ice_callback(sel
-00008ad0: 662c 2065 7665 6e74 293a 2020 2320 6e6f  f, event):  # no
-00008ae0: 7161 3a20 4339 3031 0a20 2020 2020 2020  qa: C901.       
-00008af0: 2022 2222 4861 6e64 6c65 2065 7665 6e74   """Handle event
-00008b00: 7320 7365 6e74 2074 6f20 6465 7669 6365  s sent to device
-00008b10: 2e22 2222 0a20 2020 2020 2020 2074 7279  .""".        try
-00008b20: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00008b30: 6965 6e74 203d 2073 656c 662e 636c 6965  ient = self.clie
-00008b40: 6e74 0a0a 2020 2020 2020 2020 2020 2020  nt..            
-00008b50: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
-00008b60: 656e 742c 204b 6579 5665 7269 6669 6361  ent, KeyVerifica
-00008b70: 7469 6f6e 5374 6172 7429 3a20 2023 2066  tionStart):  # f
-00008b80: 6972 7374 2073 7465 700a 2020 2020 2020  irst step.      
-00008b90: 2020 2020 2020 2020 2020 2222 2266 6972            """fir
-00008ba0: 7374 2073 7465 703a 2072 6563 6569 7665  st step: receive
-00008bb0: 204b 6579 5665 7269 6669 6361 7469 6f6e   KeyVerification
-00008bc0: 5374 6172 740a 2020 2020 2020 2020 2020  Start.          
-00008bd0: 2020 2020 2020 4b65 7956 6572 6966 6963        KeyVerific
-00008be0: 6174 696f 6e53 7461 7274 280a 2020 2020  ationStart(.    
-00008bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c00: 736f 7572 6365 3d7b 2763 6f6e 7465 6e74  source={'content
-00008c10: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00008c20: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00008c30: 276d 6574 686f 6427 3a20 276d 2e73 6173  'method': 'm.sas
-00008c40: 2e76 3127 2c0a 2020 2020 2020 2020 2020  .v1',.          
-00008c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c60: 2020 2027 6672 6f6d 5f64 6576 6963 6527     'from_device'
-00008c70: 3a20 2744 4556 4943 4549 4458 5927 2c0a  : 'DEVICEIDXY',.
-00008c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c90: 2020 2020 2020 2020 2020 2020 2027 6b65               'ke
-00008ca0: 795f 6167 7265 656d 656e 745f 7072 6f74  y_agreement_prot
-00008cb0: 6f63 6f6c 7327 3a0a 2020 2020 2020 2020  ocols':.        
-00008cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008cd0: 2020 2020 2020 2020 5b27 6375 7276 6532          ['curve2
-00008ce0: 3535 3139 2d68 6b64 662d 7368 6132 3536  5519-hkdf-sha256
-00008cf0: 272c 2027 6375 7276 6532 3535 3139 275d  ', 'curve25519']
-00008d00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008d10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00008d20: 6861 7368 6573 273a 205b 2773 6861 3235  hashes': ['sha25
-00008d30: 3627 5d2c 0a20 2020 2020 2020 2020 2020  6'],.           
-00008d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d50: 2020 276d 6573 7361 6765 5f61 7574 6865    'message_authe
-00008d60: 6e74 6963 6174 696f 6e5f 636f 6465 7327  ntication_codes'
-00008d70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d90: 2020 5b27 686b 6466 2d68 6d61 632d 7368    ['hkdf-hmac-sh
-00008da0: 6132 3536 272c 2027 686d 6163 2d73 6861  a256', 'hmac-sha
-00008db0: 3235 3627 5d2c 0a20 2020 2020 2020 2020  256'],.         
-00008dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008dd0: 2020 2020 2773 686f 7274 5f61 7574 6865      'short_authe
-00008de0: 6e74 6963 6174 696f 6e5f 7374 7269 6e67  ntication_string
-00008df0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00008e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e10: 2020 205b 2764 6563 696d 616c 272c 2027     ['decimal', '
-00008e20: 656d 6f6a 6927 5d2c 0a20 2020 2020 2020  emoji'],.       
-00008e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e40: 2020 2020 2020 2774 7261 6e73 6163 7469        'transacti
-00008e50: 6f6e 5f69 6427 3a20 2753 6f6d 6554 7849  on_id': 'SomeTxI
-00008e60: 6427 0a20 2020 2020 2020 2020 2020 2020  d'.             
-00008e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e80: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00008e90: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00008ea0: 7479 7065 273a 2027 6d2e 6b65 792e 7665  type': 'm.key.ve
-00008eb0: 7269 6669 6361 7469 6f6e 2e73 7461 7274  rification.start
-00008ec0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00008ed0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00008ee0: 7365 6e64 6572 273a 2027 4075 7365 7232  sender': '@user2
-00008ef0: 3a65 7861 6d70 6c65 2e6f 7267 270a 2020  :example.org'.  
-00008f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f10: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-00008f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f30: 2073 656e 6465 723d 2740 7573 6572 323a   sender='@user2:
-00008f40: 6578 616d 706c 652e 6f72 6727 2c0a 2020  example.org',.  
-00008f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f60: 2020 7472 616e 7361 6374 696f 6e5f 6964    transaction_id
-00008f70: 3d27 536f 6d65 5478 4964 272c 0a20 2020  ='SomeTxId',.   
-00008f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f90: 2066 726f 6d5f 6465 7669 6365 3d27 4445   from_device='DE
-00008fa0: 5649 4345 4944 5859 272c 0a20 2020 2020  VICEIDXY',.     
-00008fb0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00008fc0: 6574 686f 643d 276d 2e73 6173 2e76 3127  ethod='m.sas.v1'
-00008fd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008fe0: 2020 2020 2020 6b65 795f 6167 7265 656d        key_agreem
-00008ff0: 656e 745f 7072 6f74 6f63 6f6c 733d 5b0a  ent_protocols=[.
-00009000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009010: 2020 2020 2020 2020 2763 7572 7665 3235          'curve25
-00009020: 3531 392d 686b 6466 2d73 6861 3235 3627  519-hkdf-sha256'
-00009030: 2c20 2763 7572 7665 3235 3531 3927 5d2c  , 'curve25519'],
-00009040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009050: 2020 2020 2068 6173 6865 733d 5b27 7368       hashes=['sh
-00009060: 6132 3536 275d 2c0a 2020 2020 2020 2020  a256'],.        
-00009070: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-00009080: 6167 655f 6175 7468 656e 7469 6361 7469  age_authenticati
-00009090: 6f6e 5f63 6f64 6573 3d5b 0a20 2020 2020  on_codes=[.     
-000090a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000090b0: 2020 2027 686b 6466 2d68 6d61 632d 7368     'hkdf-hmac-sh
-000090c0: 6132 3536 272c 2027 686d 6163 2d73 6861  a256', 'hmac-sha
-000090d0: 3235 3627 5d2c 0a20 2020 2020 2020 2020  256'],.         
-000090e0: 2020 2020 2020 2020 2020 2073 686f 7274             short
-000090f0: 5f61 7574 6865 6e74 6963 6174 696f 6e5f  _authentication_
-00009100: 7374 7269 6e67 3d5b 2764 6563 696d 616c  string=['decimal
-00009110: 272c 2027 656d 6f6a 6927 5d29 0a20 2020  ', 'emoji']).   
-00009120: 2020 2020 2020 2020 2020 2020 2022 2222               """
-00009130: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00009140: 2020 6966 2022 656d 6f6a 6922 206e 6f74    if "emoji" not
-00009150: 2069 6e20 6576 656e 742e 7368 6f72 745f   in event.short_
-00009160: 6175 7468 656e 7469 6361 7469 6f6e 5f73  authentication_s
-00009170: 7472 696e 673a 0a20 2020 2020 2020 2020  tring:.         
-00009180: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00009190: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-000091a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091b0: 2022 4531 3037 3a20 220a 2020 2020 2020   "E107: ".      
-000091c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091d0: 2020 224f 7468 6572 2064 6576 6963 6520    "Other device 
-000091e0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-000091f0: 2065 6d6f 6a69 2076 6572 6966 6963 6174   emoji verificat
-00009200: 696f 6e2e 2022 0a20 2020 2020 2020 2020  ion. ".         
-00009210: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009220: 227b 6576 656e 742e 7368 6f72 745f 6175  "{event.short_au
-00009230: 7468 656e 7469 6361 7469 6f6e 5f73 7472  thentication_str
-00009240: 696e 677d 2e22 0a20 2020 2020 2020 2020  ing}.".         
-00009250: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00007580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007590: 2020 2020 2065 7665 6e74 2e73 6f75 7263       event.sourc
+000075a0: 655b 2263 6f6e 7465 6e74 225d 5b22 6669  e["content"]["fi
+000075b0: 6c65 225d 5b22 6861 7368 6573 225d 5b0a  le"]["hashes"][.
+000075c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075e0: 2020 2020 2020 2020 2273 6861 3235 3622          "sha256"
+000075f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007610: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00007620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007630: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00007640: 742e 736f 7572 6365 5b22 636f 6e74 656e  t.source["conten
+00007650: 7422 5d5b 2266 696c 6522 5d5b 2269 7622  t"]["file"]["iv"
+00007660: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00007670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007680: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00007690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000076a0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000076b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000076c0: 2053 6574 2061 7469 6d65 2061 6e64 206d   Set atime and m
+000076d0: 7469 6d65 206f 6620 6669 6c65 2074 6f20  time of file to 
+000076e0: 6576 656e 7420 7469 6d65 7374 616d 700a  event timestamp.
+000076f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007700: 2020 2020 2020 2020 2020 2020 6f73 2e75              os.u
+00007710: 7469 6d65 280a 2020 2020 2020 2020 2020  time(.          
+00007720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007730: 2020 2020 2020 6669 6c65 6e61 6d65 2c0a        filename,.
+00007740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007760: 6e73 3d28 2865 7665 6e74 2e73 6572 7665  ns=((event.serve
+00007770: 725f 7469 6d65 7374 616d 7020 2a20 3130  r_timestamp * 10
+00007780: 3030 3030 302c 2920 2a20 3229 2c0a 2020  00000,) * 2),.  
+00007790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000077b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077c0: 2020 2020 6d73 675f 7572 6c20 2b3d 2028      msg_url += (
+000077d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000077e0: 2020 2020 2020 2020 2020 2020 2022 205b               " [
+000077f0: 446f 776e 6c6f 6164 6564 2061 6e64 2064  Downloaded and d
+00007800: 6563 7279 7074 6564 206d 6564 6961 2022  ecrypted media "
+00007810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007820: 2020 2020 2020 2020 2020 2020 2066 2266               f"f
+00007830: 696c 6520 746f 207b 6669 6c65 6e61 6d65  ile to {filename
+00007840: 7d5d 220a 2020 2020 2020 2020 2020 2020  }]".            
+00007850: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00007860: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00007870: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
+00007880: 526f 6f6d 4d65 7373 6167 6541 7564 696f  RoomMessageAudio
+00007890: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000078a0: 2020 206d 7367 203d 2022 5265 6365 6976     msg = "Receiv
+000078b0: 6564 2061 7564 696f 3a20 2220 2b20 6576  ed audio: " + ev
+000078c0: 656e 742e 626f 6479 202b 206d 7367 5f75  ent.body + msg_u
+000078d0: 726c 0a20 2020 2020 2020 2020 2020 2065  rl.            e
+000078e0: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
+000078f0: 7665 6e74 2c20 526f 6f6d 4d65 7373 6167  vent, RoomMessag
+00007900: 6545 6d6f 7465 293a 0a20 2020 2020 2020  eEmote):.       
+00007910: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
+00007920: 5265 6365 6976 6564 2065 6d6f 7465 3a20  Received emote: 
+00007930: 2220 2b20 6576 656e 742e 626f 6479 0a20  " + event.body. 
+00007940: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00007950: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+00007960: 2c20 526f 6f6d 4d65 7373 6167 6546 696c  , RoomMessageFil
+00007970: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00007980: 2020 2020 6d73 6720 3d20 2252 6563 6569      msg = "Recei
+00007990: 7665 6420 6669 6c65 3a20 2220 2b20 6576  ved file: " + ev
+000079a0: 656e 742e 626f 6479 202b 206d 7367 5f75  ent.body + msg_u
+000079b0: 726c 0a20 2020 2020 2020 2020 2020 2065  rl.            e
+000079c0: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
+000079d0: 7665 6e74 2c20 526f 6f6d 4d65 7373 6167  vent, RoomMessag
+000079e0: 6546 6f72 6d61 7474 6564 293a 0a20 2020  eFormatted):.   
+000079f0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00007a00: 203d 2065 7665 6e74 2e62 6f64 790a 2020   = event.body.  
+00007a10: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00007a20: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+00007a30: 2052 6f6f 6d4d 6573 7361 6765 496d 6167   RoomMessageImag
+00007a40: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00007a50: 2020 2020 2320 5573 7561 6c6c 7920 626f      # Usually bo
+00007a60: 6479 2069 7320 736f 6d65 7468 696e 6720  dy is something 
+00007a70: 6c69 6b65 2022 696d 6167 652e 7376 6722  like "image.svg"
+00007a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007a90: 206d 7367 203d 2022 5265 6365 6976 6564   msg = "Received
+00007aa0: 2069 6d61 6765 3a20 2220 2b20 6576 656e   image: " + even
+00007ab0: 742e 626f 6479 202b 206d 7367 5f75 726c  t.body + msg_url
+00007ac0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00007ad0: 6620 6973 696e 7374 616e 6365 2865 7665  f isinstance(eve
+00007ae0: 6e74 2c20 526f 6f6d 4d65 7373 6167 654e  nt, RoomMessageN
+00007af0: 6f74 6963 6529 3a0a 2020 2020 2020 2020  otice):.        
+00007b00: 2020 2020 2020 2020 6d73 6720 3d20 6576          msg = ev
+00007b10: 656e 742e 626f 6479 2020 2320 4578 7472  ent.body  # Extr
+00007b20: 6163 7420 7468 6520 6d65 7373 6167 6520  act the message 
+00007b30: 7465 7874 0a20 2020 2020 2020 2020 2020  text.           
+00007b40: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00007b50: 2865 7665 6e74 2c20 526f 6f6d 4d65 7373  (event, RoomMess
+00007b60: 6167 6554 6578 7429 3a0a 2020 2020 2020  ageText):.      
+00007b70: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+00007b80: 6576 656e 742e 626f 6479 2020 2320 4578  event.body  # Ex
+00007b90: 7472 6163 7420 7468 6520 6d65 7373 6167  tract the messag
+00007ba0: 6520 7465 7874 0a20 2020 2020 2020 2020  e text.         
+00007bb0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00007bc0: 6365 2865 7665 6e74 2c20 526f 6f6d 4d65  ce(event, RoomMe
+00007bd0: 7373 6167 6555 6e6b 6e6f 776e 293a 0a20  ssageUnknown):. 
+00007be0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00007bf0: 7367 203d 2022 5265 6365 6976 6564 2072  sg = "Received r
+00007c00: 6f6f 6d20 6d65 7373 6167 6520 6f66 2075  oom message of u
+00007c10: 6e6b 6e6f 776e 2074 7970 653a 2022 202b  nknown type: " +
+00007c20: 2065 7665 6e74 2e6d 7367 7479 7065 0a20   event.msgtype. 
+00007c30: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00007c40: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+00007c50: 2c20 526f 6f6d 4d65 7373 6167 6556 6964  , RoomMessageVid
+00007c60: 656f 293a 0a20 2020 2020 2020 2020 2020  eo):.           
+00007c70: 2020 2020 206d 7367 203d 2022 5265 6365       msg = "Rece
+00007c80: 6976 6564 2076 6964 656f 3a20 2220 2b20  ived video: " + 
+00007c90: 6576 656e 742e 626f 6479 202b 206d 7367  event.body + msg
+00007ca0: 5f75 726c 0a20 2020 2020 2020 2020 2020  _url.           
+00007cb0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00007cc0: 2865 7665 6e74 2c20 526f 6f6d 456e 6372  (event, RoomEncr
+00007cd0: 7970 7465 6441 7564 696f 293a 0a20 2020  yptedAudio):.   
+00007ce0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00007cf0: 203d 2022 5265 6365 6976 6564 2065 6e63   = "Received enc
+00007d00: 7279 7074 6564 2061 7564 696f 3a20 2220  rypted audio: " 
+00007d10: 2b20 6576 656e 742e 626f 6479 202b 206d  + event.body + m
+00007d20: 7367 5f75 726c 0a20 2020 2020 2020 2020  sg_url.         
+00007d30: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00007d40: 6365 2865 7665 6e74 2c20 526f 6f6d 456e  ce(event, RoomEn
+00007d50: 6372 7970 7465 6446 696c 6529 3a0a 2020  cryptedFile):.  
+00007d60: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00007d70: 6720 3d20 2252 6563 6569 7665 6420 656e  g = "Received en
+00007d80: 6372 7970 7465 6420 6669 6c65 3a20 2220  crypted file: " 
+00007d90: 2b20 6576 656e 742e 626f 6479 202b 206d  + event.body + m
+00007da0: 7367 5f75 726c 0a20 2020 2020 2020 2020  sg_url.         
+00007db0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00007dc0: 6365 2865 7665 6e74 2c20 526f 6f6d 456e  ce(event, RoomEn
+00007dd0: 6372 7970 7465 6449 6d61 6765 293a 0a20  cryptedImage):. 
+00007de0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00007df0: 2055 7375 616c 6c79 2062 6f64 7920 6973   Usually body is
+00007e00: 2073 6f6d 6574 6869 6e67 206c 696b 6520   something like 
+00007e10: 2269 6d61 6765 2e73 7667 220a 2020 2020  "image.svg".    
+00007e20: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00007e30: 3d20 2252 6563 6569 7665 6420 656e 6372  = "Received encr
+00007e40: 7970 7465 6420 696d 6167 653a 2022 202b  ypted image: " +
+00007e50: 2065 7665 6e74 2e62 6f64 7920 2b20 6d73   event.body + ms
+00007e60: 675f 7572 6c0a 2020 2020 2020 2020 2020  g_url.          
+00007e70: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00007e80: 6528 6576 656e 742c 2052 6f6f 6d45 6e63  e(event, RoomEnc
+00007e90: 7279 7074 6564 5669 6465 6f29 3a0a 2020  ryptedVideo):.  
+00007ea0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00007eb0: 6720 3d20 2252 6563 6569 7665 6420 656e  g = "Received en
+00007ec0: 6372 7970 7465 6420 7669 6465 6f3a 2022  crypted video: "
+00007ed0: 202b 2065 7665 6e74 2e62 6f64 7920 2b20   + event.body + 
+00007ee0: 6d73 675f 7572 6c0a 2020 2020 2020 2020  msg_url.        
+00007ef0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00007f00: 6e63 6528 6576 656e 742c 2052 6f6f 6d4d  nce(event, RoomM
+00007f10: 6573 7361 6765 4d65 6469 6129 3a0a 2020  essageMedia):.  
+00007f20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00007f30: 7468 6973 2073 686f 756c 6420 6e65 7665  this should neve
+00007f40: 7220 6265 2072 6561 6368 6564 2c20 7468  r be reached, th
+00007f50: 6973 2069 7320 6120 6261 7365 2063 6c61  is is a base cla
+00007f60: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00007f70: 2020 2023 2069 7420 7368 6f75 6c64 2062     # it should b
+00007f80: 6520 6120 6175 6469 6f2c 2069 6d61 6765  e a audio, image
+00007f90: 2c20 7669 6465 6f2c 2065 7463 2e0a 2020  , video, etc..  
+00007fa0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00007fb0: 5075 7420 6865 7265 2061 7420 7468 6520  Put here at the 
+00007fc0: 656e 6420 6173 2064 6566 656e 7369 7665  end as defensive
+00007fd0: 2070 726f 6772 616d 6d69 6e67 0a20 2020   programming.   
+00007fe0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00007ff0: 203d 2022 5265 6365 6976 6564 206d 6564   = "Received med
+00008000: 6961 3a20 2220 2b20 6576 656e 742e 626f  ia: " + event.bo
+00008010: 6479 202b 206d 7367 5f75 726c 0a20 2020  dy + msg_url.   
+00008020: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
+00008030: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
+00008040: 526f 6f6d 456e 6372 7970 7465 644d 6564  RoomEncryptedMed
+00008050: 6961 293a 0a20 2020 2020 2020 2020 2020  ia):.           
+00008060: 2020 2020 2023 2074 6869 7320 7368 6f75       # this shou
+00008070: 6c64 206e 6576 6572 2062 6520 7265 6163  ld never be reac
+00008080: 6865 642c 2074 6869 7320 6973 2061 2062  hed, this is a b
+00008090: 6173 6520 636c 6173 730a 2020 2020 2020  ase class.      
+000080a0: 2020 2020 2020 2020 2020 2320 6974 2073            # it s
+000080b0: 686f 756c 6420 6265 2061 2061 7564 696f  hould be a audio
+000080c0: 2c20 696d 6167 652c 2076 6964 656f 2c20  , image, video, 
+000080d0: 6574 632e 0a20 2020 2020 2020 2020 2020  etc..           
+000080e0: 2020 2020 2023 2050 7574 2068 6572 6520       # Put here 
+000080f0: 6174 2074 6865 2065 6e64 2061 7320 6465  at the end as de
+00008100: 6665 6e73 6976 6520 7072 6f67 7261 6d6d  fensive programm
+00008110: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+00008120: 2020 2020 6d73 6720 3d20 2252 6563 6569      msg = "Recei
+00008130: 7665 6420 656e 6372 7970 7465 6420 6d65  ved encrypted me
+00008140: 6469 613a 2022 202b 2065 7665 6e74 2e62  dia: " + event.b
+00008150: 6f64 7920 2b20 6d73 675f 7572 6c0a 2020  ody + msg_url.  
+00008160: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00008170: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+00008180: 2052 6f6f 6d4d 656d 6265 7245 7665 6e74   RoomMemberEvent
+00008190: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000081a0: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
+000081b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000081c0: 5265 6365 6976 6564 2072 6f6f 6d2d 6d65  Received room-me
+000081d0: 6d62 6572 2065 7665 6e74 3a20 220a 2020  mber event: ".  
+000081e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081f0: 2020 6622 7365 6e64 6572 3a20 7b65 7665    f"sender: {eve
+00008200: 6e74 2e73 656e 6465 727d 2c20 6f70 6572  nt.sender}, oper
+00008210: 6174 696f 6e3a 207b 6576 656e 742e 6d65  ation: {event.me
+00008220: 6d62 6572 7368 6970 7d22 0a20 2020 2020  mbership}".     
+00008230: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00008240: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
+00008250: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
+00008260: 526f 6f6d 456e 6372 7970 7469 6f6e 4576  RoomEncryptionEv
+00008270: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+00008280: 2020 2020 2020 6d73 6720 3d20 280a 2020        msg = (.  
+00008290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082a0: 2020 2252 6563 6569 7665 6420 726f 6f6d    "Received room
+000082b0: 2d65 6e63 7279 7074 696f 6e20 6576 656e  -encryption even
+000082c0: 743a 2022 0a20 2020 2020 2020 2020 2020  t: ".           
+000082d0: 2020 2020 2020 2020 2066 2273 656e 6465           f"sende
+000082e0: 723a 207b 6576 656e 742e 7365 6e64 6572  r: {event.sender
+000082f0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00008300: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00008310: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00008320: 2865 7665 6e74 2c20 526f 6f6d 416c 6961  (event, RoomAlia
+00008330: 7345 7665 6e74 293a 0a20 2020 2020 2020  sEvent):.       
+00008340: 2020 2020 2020 2020 206d 7367 203d 2028           msg = (
+00008350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008360: 2020 2020 2022 5265 6365 6976 6564 2072       "Received r
+00008370: 6f6f 6d2d 616c 6961 7320 6576 656e 743a  oom-alias event:
+00008380: 2073 656e 6465 723a 2022 0a20 2020 2020   sender: ".     
+00008390: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000083a0: 227b 6576 656e 742e 7365 6e64 6572 7d2c  "{event.sender},
+000083b0: 2061 6c69 6173 3a20 7b65 7665 6e74 2e63   alias: {event.c
+000083c0: 616e 6f6e 6963 616c 5f61 6c69 6173 7d22  anonical_alias}"
+000083d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000083e0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+000083f0: 6c69 6620 6973 696e 7374 616e 6365 2865  lif isinstance(e
+00008400: 7665 6e74 2c20 526f 6f6d 4e61 6d65 4576  vent, RoomNameEv
+00008410: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+00008420: 2020 2020 2020 6d73 6720 3d20 280a 2020        msg = (.  
+00008430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008440: 2020 2252 6563 6569 7665 6420 726f 6f6d    "Received room
+00008450: 2d6e 616d 6520 6576 656e 743a 2073 656e  -name event: sen
+00008460: 6465 723a 2022 0a20 2020 2020 2020 2020  der: ".         
+00008470: 2020 2020 2020 2020 2020 2066 227b 6576             f"{ev
+00008480: 656e 742e 7365 6e64 6572 7d2c 2072 6f6f  ent.sender}, roo
+00008490: 6d20 6e61 6d65 3a20 7b65 7665 6e74 2e6e  m name: {event.n
+000084a0: 616d 657d 220a 2020 2020 2020 2020 2020  ame}".          
+000084b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000084c0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+000084d0: 6e63 6528 6576 656e 742c 2052 6564 6163  nce(event, Redac
+000084e0: 7465 6445 7665 6e74 293a 0a20 2020 2020  tedEvent):.     
+000084f0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00008500: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00008510: 2020 2020 2020 2022 5265 6365 6976 6564         "Received
+00008520: 2072 6564 6163 7465 6420 6576 656e 743a   redacted event:
+00008530: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00008540: 2020 2020 2020 2066 2273 656e 6465 723a         f"sender:
+00008550: 207b 6576 656e 742e 7365 6e64 6572 7d2c   {event.sender},
+00008560: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00008570: 2020 2020 2020 2066 2274 7970 653a 207b         f"type: {
+00008580: 6576 656e 742e 7479 7065 7d2c 2072 6564  event.type}, red
+00008590: 6163 7465 723a 207b 6576 656e 742e 7265  acter: {event.re
+000085a0: 6461 6374 6572 7d22 0a20 2020 2020 2020  dacter}".       
+000085b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000085c0: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
+000085d0: 7374 616e 6365 2865 7665 6e74 2c20 5265  stance(event, Re
+000085e0: 6461 6374 696f 6e45 7665 6e74 293a 0a20  dactionEvent):. 
+000085f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00008600: 7367 203d 2028 0a20 2020 2020 2020 2020  sg = (.         
+00008610: 2020 2020 2020 2020 2020 2022 5265 6365             "Rece
+00008620: 6976 6564 2072 6564 6163 7469 6f6e 2065  ived redaction e
+00008630: 7665 6e74 3a20 220a 2020 2020 2020 2020  vent: ".        
+00008640: 2020 2020 2020 2020 2020 2020 6622 7365              f"se
+00008650: 6e64 6572 3a20 7b65 7665 6e74 2e73 656e  nder: {event.sen
+00008660: 6465 727d 2c20 220a 2020 2020 2020 2020  der}, ".        
+00008670: 2020 2020 2020 2020 2020 2020 6622 7265              f"re
+00008680: 6461 6374 733a 207b 6576 656e 742e 7265  dacts: {event.re
+00008690: 6461 6374 737d 220a 2020 2020 2020 2020  dacts}".        
+000086a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000086b0: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+000086c0: 7461 6e63 6528 6576 656e 742c 2055 6e6b  tance(event, Unk
+000086d0: 6e6f 776e 4576 656e 7429 3a0a 2020 2020  nownEvent):.    
+000086e0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+000086f0: 7665 6e74 2e74 7970 6520 3d3d 2022 6d2e  vent.type == "m.
+00008700: 7265 6163 7469 6f6e 223a 0a20 2020 2020  reaction":.     
+00008710: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00008720: 7367 203d 2028 0a20 2020 2020 2020 2020  sg = (.         
+00008730: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00008740: 5265 6365 6976 6564 2061 2072 6561 6374  Received a react
+00008750: 696f 6e2c 2061 6e20 656d 6f6a 693a 2022  ion, an emoji: "
+00008760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008770: 2020 2020 2020 2020 2066 227b 6576 656e           f"{even
+00008780: 742e 736f 7572 6365 5b27 636f 6e74 656e  t.source['conten
+00008790: 7427 5d5b 276d 2e72 656c 6174 6573 5f74  t']['m.relates_t
+000087a0: 6f27 5d5b 276b 6579 275d 7d22 0a20 2020  o']['key']}".   
+000087b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087c0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000087d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000087e0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+000087f0: 203d 2066 2252 6563 6569 7665 6420 756e   = f"Received un
+00008800: 6b6e 6f77 6e20 6576 656e 743a 207b 6576  known event: {ev
+00008810: 656e 747d 220a 2020 2020 2020 2020 2020  ent}".          
+00008820: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00008830: 2020 2020 2020 2020 6d73 6720 3d20 6622          msg = f"
+00008840: 5265 6365 6976 6564 2075 6e6b 6e6f 776e  Received unknown
+00008850: 2065 7665 6e74 3a20 7b65 7665 6e74 7d22   event: {event}"
+00008860: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00008870: 6966 2065 7665 6e74 5b27 7479 7065 275d  if event['type']
+00008880: 203d 3d20 226d 2e72 6f6f 6d2e 6d65 7373   == "m.room.mess
+00008890: 6167 6522 3a0a 2020 2020 2020 2020 2020  age":.          
+000088a0: 2020 2320 2020 2069 6620 6576 656e 745b    #    if event[
+000088b0: 2763 6f6e 7465 6e74 275d 5b27 6d73 6774  'content']['msgt
+000088c0: 7970 6527 5d20 3d3d 2022 6d2e 7465 7874  ype'] == "m.text
+000088d0: 223a 0a20 2020 2020 2020 2020 2020 2023  ":.            #
+000088e0: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
+000088f0: 3d20 6576 656e 745b 2763 6f6e 7465 6e74  = event['content
+00008900: 275d 5b27 626f 6479 275d 0a20 2020 2020  ']['body'].     
+00008910: 2020 2020 2020 2023 2020 2020 656c 7365         #    else
+00008920: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00008930: 2020 2020 2020 2064 6f77 6e6c 6f61 645f         download_
+00008940: 7572 6c20 3d20 6170 692e 6765 745f 646f  url = api.get_do
+00008950: 776e 6c6f 6164 5f75 726c 280a 2020 2020  wnload_url(.    
+00008960: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00008970: 2020 2020 2065 7665 6e74 5b27 636f 6e74       event['cont
+00008980: 656e 7427 5d5b 2775 726c 275d 290a 2020  ent']['url']).  
+00008990: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+000089a0: 2020 2063 6f6e 7465 6e74 203d 2064 6f77     content = dow
+000089b0: 6e6c 6f61 645f 7572 6c0a 2020 2020 2020  nload_url.      
+000089c0: 2020 2020 2020 2320 656c 7365 3a0a 2020        # else:.  
+000089d0: 2020 2020 2020 2020 2020 2320 2020 2063            #    c
+000089e0: 6f6e 7465 6e74 203d 2022 5c6e 7b7b 2022  ontent = "\n{{ "
+000089f0: 202b 2065 7665 6e74 5b27 7479 7065 275d   + event['type']
+00008a00: 202b 2022 2065 7665 6e74 207d 7d5c 6e22   + " event }}\n"
+00008a10: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00008a20: 6c6f 672e 6465 6275 6728 6622 7479 7065  log.debug(f"type
+00008a30: 286d 7367 2920 3d20 7b74 7970 6528 6d73  (msg) = {type(ms
+00008a40: 6729 7d2e 206d 7367 2069 7320 6120 7374  g)}. msg is a st
+00008a50: 7269 6e67 2229 0a20 2020 2020 2020 2020  ring").         
+00008a60: 2020 2073 656e 6465 725f 6e69 636b 203d     sender_nick =
+00008a70: 2072 6f6f 6d2e 7573 6572 5f6e 616d 6528   room.user_name(
+00008a80: 6576 656e 742e 7365 6e64 6572 290a 2020  event.sender).  
+00008a90: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00008aa0: 2073 656e 6465 725f 6e69 636b 3a20 2023   sender_nick:  #
+00008ab0: 2063 6f6e 7665 7274 2040 666f 6f3a 6d61   convert @foo:ma
+00008ac0: 742e 696f 2069 6e74 6f20 666f 6f0a 2020  t.io into foo.  
+00008ad0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00008ae0: 6e64 6572 5f6e 6963 6b20 3d20 7573 6572  nder_nick = user
+00008af0: 5f69 645f 746f 5f73 686f 7274 5f75 7365  _id_to_short_use
+00008b00: 725f 6e61 6d65 2865 7665 6e74 2e73 656e  r_name(event.sen
+00008b10: 6465 7229 0a20 2020 2020 2020 2020 2020  der).           
+00008b20: 2072 6f6f 6d5f 6e69 636b 203d 2072 6f6f   room_nick = roo
+00008b30: 6d2e 6469 7370 6c61 795f 6e61 6d65 0a20  m.display_name. 
+00008b40: 2020 2020 2020 2020 2020 2069 6620 726f             if ro
+00008b50: 6f6d 5f6e 6963 6b20 696e 2028 4e6f 6e65  om_nick in (None
+00008b60: 2c20 2222 2c20 2245 6d70 7479 2052 6f6f  , "", "Empty Roo
+00008b70: 6d22 293a 0a20 2020 2020 2020 2020 2020  m"):.           
+00008b80: 2020 2020 2072 6f6f 6d5f 6e69 636b 203d       room_nick =
+00008b90: 2022 556e 6465 7465 726d 696e 6564 220a   "Undetermined".
+00008ba0: 2020 2020 2020 2020 2020 2020 6966 2067              if g
+00008bb0: 732e 7061 2e70 7269 6e74 5f65 7665 6e74  s.pa.print_event
+00008bc0: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+00008bd0: 2020 2020 2065 7665 6e74 5f69 645f 6465       event_id_de
+00008be0: 7461 696c 203d 2066 2220 7c20 7b65 7665  tail = f" | {eve
+00008bf0: 6e74 2e65 7665 6e74 5f69 647d 220a 2020  nt.event_id}".  
+00008c00: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00008c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c20: 6576 656e 745f 6964 5f64 6574 6169 6c20  event_id_detail 
+00008c30: 3d20 2222 0a20 2020 2020 2020 2020 2020  = "".           
+00008c40: 2023 2050 7265 7665 6e74 2066 616b 696e   # Prevent fakin
+00008c50: 6720 6d65 7373 6167 6573 2062 7920 7072  g messages by pr
+00008c60: 6566 6978 696e 6720 6561 6368 206c 696e  efixing each lin
+00008c70: 6520 6f66 2061 206d 756c 7469 6c69 6e65  e of a multiline
+00008c80: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+00008c90: 6573 7361 6765 2077 6974 6820 7370 6163  essage with spac
+00008ca0: 652e 0a20 2020 2020 2020 2020 2020 2066  e..            f
+00008cb0: 6978 6564 5f6d 7367 203d 2072 652e 7375  ixed_msg = re.su
+00008cc0: 6228 225c 6e22 2c20 225c 6e20 2020 2022  b("\n", "\n    "
+00008cd0: 2c20 6d73 6729 0a20 2020 2020 2020 2020  , msg).         
+00008ce0: 2020 2063 6f6d 706c 6574 655f 6d73 6720     complete_msg 
+00008cf0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00008d00: 2020 2020 224d 6573 7361 6765 2072 6563      "Message rec
+00008d10: 6569 7665 6420 666f 7220 726f 6f6d 2022  eived for room "
+00008d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008d30: 2066 227b 726f 6f6d 5f6e 6963 6b7d 205b   f"{room_nick} [
+00008d40: 7b72 6f6f 6d2e 726f 6f6d 5f69 647d 5d20  {room.room_id}] 
+00008d50: 7c20 220a 2020 2020 2020 2020 2020 2020  | ".            
+00008d60: 2020 2020 6622 7365 6e64 6572 207b 7365      f"sender {se
+00008d70: 6e64 6572 5f6e 6963 6b7d 2022 0a20 2020  nder_nick} ".   
+00008d80: 2020 2020 2020 2020 2020 2020 2066 225b               f"[
+00008d90: 7b65 7665 6e74 2e73 656e 6465 727d 5d20  {event.sender}] 
+00008da0: 7c20 7b65 7665 6e74 5f64 6174 6574 696d  | {event_datetim
+00008db0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
+00008dc0: 2020 2020 6622 7b65 7665 6e74 5f69 645f      f"{event_id_
+00008dd0: 6465 7461 696c 7d20 7c20 7b66 6978 6564  detail} | {fixed
+00008de0: 5f6d 7367 7d22 0a20 2020 2020 2020 2020  _msg}".         
+00008df0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00008e00: 2067 732e 6c6f 672e 6465 6275 6728 636f   gs.log.debug(co
+00008e10: 6d70 6c65 7465 5f6d 7367 290a 2020 2020  mplete_msg).    
+00008e20: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
+00008e30: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
+00008e40: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
+00008e50: 666c 6167 0a20 2020 2020 2020 2020 2020  flag.           
+00008e60: 2074 6578 7420 3d20 636f 6d70 6c65 7465   text = complete
+00008e70: 5f6d 7367 2020 2320 7072 696e 7420 7468  _msg  # print th
+00008e80: 6520 7265 6365 6976 6564 206d 6573 7361  e received messa
+00008e90: 6765 0a20 2020 2020 2020 2020 2020 206a  ge.            j
+00008ea0: 736f 6e5f 203d 207b 2273 6f75 7263 6522  son_ = {"source"
+00008eb0: 3a20 6576 656e 742e 736f 7572 6365 7d0a  : event.source}.
+00008ec0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00008ed0: 5f2e 7570 6461 7465 287b 2272 6f6f 6d22  _.update({"room"
+00008ee0: 3a20 726f 6f6d 7d29 0a20 2020 2020 2020  : room}).       
+00008ef0: 2020 2020 206a 736f 6e5f 2e75 7064 6174       json_.updat
+00008f00: 6528 7b22 726f 6f6d 5f64 6973 706c 6179  e({"room_display
+00008f10: 5f6e 616d 6522 3a20 726f 6f6d 2e64 6973  _name": room.dis
+00008f20: 706c 6179 5f6e 616d 657d 290a 2020 2020  play_name}).    
+00008f30: 2020 2020 2020 2020 6a73 6f6e 5f2e 7570          json_.up
+00008f40: 6461 7465 287b 2273 656e 6465 725f 6e69  date({"sender_ni
+00008f50: 636b 223a 2073 656e 6465 725f 6e69 636b  ck": sender_nick
+00008f60: 7d29 0a20 2020 2020 2020 2020 2020 206a  }).            j
+00008f70: 736f 6e5f 2e75 7064 6174 6528 7b22 6576  son_.update({"ev
+00008f80: 656e 745f 6461 7465 7469 6d65 223a 2065  ent_datetime": e
+00008f90: 7665 6e74 5f64 6174 6574 696d 657d 290a  vent_datetime}).
+00008fa0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00008fb0: 5f6d 6178 203d 2065 7665 6e74 2e5f 5f64  _max = event.__d
+00008fc0: 6963 745f 5f0a 2020 2020 2020 2020 2020  ict__.          
+00008fd0: 2020 6a73 6f6e 5f6d 6178 2e75 7064 6174    json_max.updat
+00008fe0: 6528 7b22 726f 6f6d 223a 2072 6f6f 6d7d  e({"room": room}
+00008ff0: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
+00009000: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
+00009010: 726f 6f6d 5f64 6973 706c 6179 5f6e 616d  room_display_nam
+00009020: 6522 3a20 726f 6f6d 2e64 6973 706c 6179  e": room.display
+00009030: 5f6e 616d 657d 290a 2020 2020 2020 2020  _name}).        
+00009040: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
+00009050: 6174 6528 7b22 7365 6e64 6572 5f6e 6963  ate({"sender_nic
+00009060: 6b22 3a20 7365 6e64 6572 5f6e 6963 6b7d  k": sender_nick}
+00009070: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
+00009080: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
+00009090: 6576 656e 745f 6461 7465 7469 6d65 223a  event_datetime":
+000090a0: 2065 7665 6e74 5f64 6174 6574 696d 657d   event_datetime}
+000090b0: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
+000090c0: 6f6e 5f73 7065 6320 3d20 6576 656e 742e  on_spec = event.
+000090d0: 736f 7572 6365 0a20 2020 2020 2020 2020  source.         
+000090e0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
+000090f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009100: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
+00009110: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00009120: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
+00009130: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
+00009140: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
+00009150: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+00009160: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
+00009170: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
+00009180: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
+00009190: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000091a0: 2020 2020 2020 2020 2020 6966 2067 732e            if gs.
+000091b0: 7061 2e6f 735f 6e6f 7469 6679 3a0a 2020  pa.os_notify:.  
+000091c0: 2020 2020 2020 2020 2020 2020 2020 6176                av
+000091d0: 6174 6172 5f75 726c 203d 2061 7761 6974  atar_url = await
+000091e0: 2067 6574 5f61 7661 7461 725f 7572 6c28   get_avatar_url(
+000091f0: 7365 6c66 2e63 6c69 656e 742c 2065 7665  self.client, eve
+00009200: 6e74 2e73 656e 6465 7229 0a20 2020 2020  nt.sender).     
+00009210: 2020 2020 2020 2020 2020 206e 6f74 6966             notif
+00009220: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
+00009230: 2020 2020 2020 2066 2246 726f 6d20 7b72         f"From {r
+00009240: 6f6f 6d2e 7573 6572 5f6e 616d 6528 6576  oom.user_name(ev
+00009250: 656e 742e 7365 6e64 6572 297d 222c 0a20  ent.sender)}",. 
 00009260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009270: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00009280: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-00009290: 7761 6974 2063 6c69 656e 742e 6163 6365  wait client.acce
-000092a0: 7074 5f6b 6579 5f76 6572 6966 6963 6174  pt_key_verificat
-000092b0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-000092c0: 2020 2020 2020 2020 2065 7665 6e74 2e74           event.t
-000092d0: 7261 6e73 6163 7469 6f6e 5f69 640a 2020  ransaction_id.  
-000092e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000092f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009300: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-00009310: 7370 2c20 546f 4465 7669 6365 4572 726f  sp, ToDeviceErro
-00009320: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00009330: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00009340: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00009350: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00009360: 3130 383a 2022 0a20 2020 2020 2020 2020  108: ".         
-00009370: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00009380: 6163 6365 7074 5f6b 6579 5f76 6572 6966  accept_key_verif
-00009390: 6963 6174 696f 6e20 6661 696c 6564 2077  ication failed w
-000093a0: 6974 6820 6572 726f 7220 220a 2020 2020  ith error ".    
-000093b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093c0: 2020 2020 6622 277b 7072 6976 6163 795f      f"'{privacy_
-000093d0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-000093e0: 297d 272e 220a 2020 2020 2020 2020 2020  )}'.".          
-000093f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00009400: 2020 2020 2020 2020 2020 2020 2073 6173               sas
-00009410: 203d 2063 6c69 656e 742e 6b65 795f 7665   = client.key_ve
-00009420: 7269 6669 6361 7469 6f6e 735b 6576 656e  rifications[even
-00009430: 742e 7472 616e 7361 6374 696f 6e5f 6964  t.transaction_id
-00009440: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
-00009450: 2020 2074 6f64 6576 6963 655f 6d73 6720     todevice_msg 
-00009460: 3d20 7361 732e 7368 6172 655f 6b65 7928  = sas.share_key(
-00009470: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009480: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00009490: 6c69 656e 742e 746f 5f64 6576 6963 6528  lient.to_device(
-000094a0: 746f 6465 7669 6365 5f6d 7367 290a 2020  todevice_msg).  
-000094b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000094c0: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-000094d0: 2c20 546f 4465 7669 6365 4572 726f 7229  , ToDeviceError)
-000094e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000094f0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-00009500: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00009510: 2020 2020 2020 2020 2020 2020 2245 3130              "E10
-00009520: 393a 2022 0a20 2020 2020 2020 2020 2020  9: ".           
-00009530: 2020 2020 2020 2020 2020 2020 2022 746f               "to
-00009540: 5f64 6576 6963 6520 6661 696c 6564 2077  _device failed w
-00009550: 6974 6820 6572 726f 7220 220a 2020 2020  ith error ".    
-00009560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009570: 2020 2020 6622 277b 7072 6976 6163 795f      f"'{privacy_
-00009580: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00009590: 297d 272e 220a 2020 2020 2020 2020 2020  )}'.".          
-000095a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-000095b0: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-000095c0: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
-000095d0: 4b65 7956 6572 6966 6963 6174 696f 6e43  KeyVerificationC
-000095e0: 616e 6365 6c29 3a20 2023 2061 6e79 7469  ancel):  # anyti
-000095f0: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-00009600: 2020 2022 2222 6174 2061 6e79 2074 696d     """at any tim
-00009610: 653a 2072 6563 6569 7665 204b 6579 5665  e: receive KeyVe
-00009620: 7269 6669 6361 7469 6f6e 4361 6e63 656c  rificationCancel
-00009630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009640: 204b 6579 5665 7269 6669 6361 7469 6f6e   KeyVerification
-00009650: 4361 6e63 656c 2873 6f75 7263 653d 7b0a  Cancel(source={.
-00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009670: 2020 2020 2763 6f6e 7465 6e74 273a 207b      'content': {
-00009680: 2763 6f64 6527 3a20 276d 2e6d 6973 6d61  'code': 'm.misma
-00009690: 7463 6865 645f 7361 7327 2c0a 2020 2020  tched_sas',.    
+00009270: 2020 206d 7367 5b3a 3136 305d 2c0a 2020     msg[:160],.  
+00009280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009290: 2020 6176 6174 6172 5f75 726c 2c0a 2020    avatar_url,.  
+000092a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000092b0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+000092c0: 4261 7365 4578 6365 7074 696f 6e3a 0a20  BaseException:. 
+000092d0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+000092e0: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
+000092f0: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
+00009300: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
+00009310: 6f72 6d61 745f 6578 6328 2929 0a0a 2020  ormat_exc())..  
+00009320: 2020 2320 6163 636f 7264 696e 6720 746f    # according to
+00009330: 206c 696e 7465 723a 2066 756e 6374 696f   linter: functio
+00009340: 6e20 6973 2074 6f6f 2063 6f6d 706c 6578  n is too complex
+00009350: 2c20 4339 3031 0a20 2020 2061 7379 6e63  , C901.    async
+00009360: 2064 6566 2074 6f5f 6465 7669 6365 5f63   def to_device_c
+00009370: 616c 6c62 6163 6b28 7365 6c66 2c20 6576  allback(self, ev
+00009380: 656e 7429 3a20 2023 206e 6f71 613a 2043  ent):  # noqa: C
+00009390: 3930 310a 2020 2020 2020 2020 2222 2248  901.        """H
+000093a0: 616e 646c 6520 6576 656e 7473 2073 656e  andle events sen
+000093b0: 7420 746f 2064 6576 6963 652e 2222 220a  t to device.""".
+000093c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000093d0: 2020 2020 2020 2020 2063 6c69 656e 7420           client 
+000093e0: 3d20 7365 6c66 2e63 6c69 656e 740a 0a20  = self.client.. 
+000093f0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00009400: 696e 7374 616e 6365 2865 7665 6e74 2c20  instance(event, 
+00009410: 4b65 7956 6572 6966 6963 6174 696f 6e53  KeyVerificationS
+00009420: 7461 7274 293a 2020 2320 6669 7273 7420  tart):  # first 
+00009430: 7374 6570 0a20 2020 2020 2020 2020 2020  step.           
+00009440: 2020 2020 2022 2222 6669 7273 7420 7374       """first st
+00009450: 6570 3a20 7265 6365 6976 6520 4b65 7956  ep: receive KeyV
+00009460: 6572 6966 6963 6174 696f 6e53 7461 7274  erificationStart
+00009470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009480: 204b 6579 5665 7269 6669 6361 7469 6f6e   KeyVerification
+00009490: 5374 6172 7428 0a20 2020 2020 2020 2020  Start(.         
+000094a0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+000094b0: 653d 7b27 636f 6e74 656e 7427 3a0a 2020  e={'content':.  
+000094c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094d0: 2020 2020 2020 2020 2020 7b27 6d65 7468            {'meth
+000094e0: 6f64 273a 2027 6d2e 7361 732e 7631 272c  od': 'm.sas.v1',
+000094f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009500: 2020 2020 2020 2020 2020 2020 2020 2766                'f
+00009510: 726f 6d5f 6465 7669 6365 273a 2027 4445  rom_device': 'DE
+00009520: 5649 4345 4944 5859 272c 0a20 2020 2020  VICEIDXY',.     
+00009530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009540: 2020 2020 2020 2020 276b 6579 5f61 6772          'key_agr
+00009550: 6565 6d65 6e74 5f70 726f 746f 636f 6c73  eement_protocols
+00009560: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00009570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009580: 2020 205b 2763 7572 7665 3235 3531 392d     ['curve25519-
+00009590: 686b 6466 2d73 6861 3235 3627 2c20 2763  hkdf-sha256', 'c
+000095a0: 7572 7665 3235 3531 3927 5d2c 0a20 2020  urve25519'],.   
+000095b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095c0: 2020 2020 2020 2020 2020 2768 6173 6865            'hashe
+000095d0: 7327 3a20 5b27 7368 6132 3536 275d 2c0a  s': ['sha256'],.
+000095e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095f0: 2020 2020 2020 2020 2020 2020 2027 6d65               'me
+00009600: 7373 6167 655f 6175 7468 656e 7469 6361  ssage_authentica
+00009610: 7469 6f6e 5f63 6f64 6573 273a 0a20 2020  tion_codes':.   
+00009620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009630: 2020 2020 2020 2020 2020 2020 205b 2768               ['h
+00009640: 6b64 662d 686d 6163 2d73 6861 3235 3627  kdf-hmac-sha256'
+00009650: 2c20 2768 6d61 632d 7368 6132 3536 275d  , 'hmac-sha256']
+00009660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009670: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009680: 7368 6f72 745f 6175 7468 656e 7469 6361  short_authentica
+00009690: 7469 6f6e 5f73 7472 696e 6727 3a0a 2020  tion_string':.  
 000096a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096b0: 2020 2020 2020 2020 2020 2020 2772 6561              'rea
-000096c0: 736f 6e27 3a20 274d 6973 6d61 7463 6865  son': 'Mismatche
-000096d0: 6420 6175 7468 656e 7469 6361 7469 6f6e  d authentication
-000096e0: 2073 7472 696e 6727 2c0a 2020 2020 2020   string',.      
-000096f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009700: 2020 2020 2020 2020 2020 2774 7261 6e73            'trans
-00009710: 6163 7469 6f6e 5f69 6427 3a20 2753 6f6d  action_id': 'Som
-00009720: 6554 7849 6427 7d2c 0a20 2020 2020 2020  eTxId'},.       
-00009730: 2020 2020 2020 2020 2020 2020 2027 7479               'ty
-00009740: 7065 273a 2027 6d2e 6b65 792e 7665 7269  pe': 'm.key.veri
-00009750: 6669 6361 7469 6f6e 2e63 616e 6365 6c27  fication.cancel'
-00009760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009770: 2020 2020 2020 2773 656e 6465 7227 3a20        'sender': 
-00009780: 2740 7573 6572 323a 6578 616d 706c 652e  '@user2:example.
-00009790: 6f72 6727 7d2c 0a20 2020 2020 2020 2020  org'},.         
-000097a0: 2020 2020 2020 2020 2020 2073 656e 6465             sende
-000097b0: 723d 2740 7573 6572 323a 6578 616d 706c  r='@user2:exampl
-000097c0: 652e 6f72 6727 2c0a 2020 2020 2020 2020  e.org',.        
-000097d0: 2020 2020 2020 2020 2020 2020 7472 616e              tran
-000097e0: 7361 6374 696f 6e5f 6964 3d27 536f 6d65  saction_id='Some
-000097f0: 5478 4964 272c 0a20 2020 2020 2020 2020  TxId',.         
-00009800: 2020 2020 2020 2020 2020 2063 6f64 653d             code=
-00009810: 276d 2e6d 6973 6d61 7463 6865 645f 7361  'm.mismatched_sa
-00009820: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00009830: 2020 2020 2020 2020 7265 6173 6f6e 3d27          reason='
-00009840: 4d69 736d 6174 6368 6564 2073 686f 7274  Mismatched short
-00009850: 2061 7574 6865 6e74 6963 6174 696f 6e20   authentication 
-00009860: 7374 7269 6e67 2729 0a20 2020 2020 2020  string').       
-00009870: 2020 2020 2020 2020 2022 2222 0a0a 2020           """..  
-00009880: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00009890: 5468 6572 6520 6973 206e 6f20 6e65 6564  There is no need
-000098a0: 2074 6f20 6973 7375 6520 610a 2020 2020   to issue a.    
-000098b0: 2020 2020 2020 2020 2020 2020 2320 636c              # cl
-000098c0: 6965 6e74 2e63 616e 6365 6c5f 6b65 795f  ient.cancel_key_
-000098d0: 7665 7269 6669 6361 7469 6f6e 2874 785f  verification(tx_
-000098e0: 6964 2c20 7265 6a65 6374 3d46 616c 7365  id, reject=False
-000098f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009900: 2020 2320 6865 7265 2e20 5468 6520 5341    # here. The SA
-00009910: 5320 666c 6f77 2069 7320 616c 7265 6164  S flow is alread
-00009920: 7920 6361 6e63 656c 6c65 642e 0a20 2020  y cancelled..   
-00009930: 2020 2020 2020 2020 2020 2020 2023 2057               # W
-00009940: 6520 6f6e 6c79 206e 6565 6420 746f 2069  e only need to i
-00009950: 6e66 6f72 6d20 7468 6520 7573 6572 2e0a  nform the user..
-00009960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009970: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-00009980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009990: 2020 2245 3131 303a 2022 0a20 2020 2020    "E110: ".     
-000099a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000099b0: 2256 6572 6966 6963 6174 696f 6e20 6861  "Verification ha
-000099c0: 7320 6265 656e 2063 616e 6365 6c6c 6564  s been cancelled
-000099d0: 2062 7920 7b65 7665 6e74 2e73 656e 6465   by {event.sende
-000099e0: 727d 2022 0a20 2020 2020 2020 2020 2020  r} ".           
-000099f0: 2020 2020 2020 2020 2066 2766 6f72 2072           f'for r
-00009a00: 6561 736f 6e20 227b 6576 656e 742e 7265  eason "{event.re
-00009a10: 6173 6f6e 7d22 2e27 0a20 2020 2020 2020  ason}".'.       
-00009a20: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00009a30: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00009a40: 6e73 7461 6e63 6528 6576 656e 742c 204b  nstance(event, K
-00009a50: 6579 5665 7269 6669 6361 7469 6f6e 4b65  eyVerificationKe
-00009a60: 7929 3a20 2023 2073 6563 6f6e 6420 7374  y):  # second st
-00009a70: 6570 0a20 2020 2020 2020 2020 2020 2020  ep.             
-00009a80: 2020 2022 2222 5365 636f 6e64 2073 7465     """Second ste
-00009a90: 7020 6973 2074 6f20 7265 6365 6976 6520  p is to receive 
-00009aa0: 4b65 7956 6572 6966 6963 6174 696f 6e4b  KeyVerificationK
-00009ab0: 6579 0a20 2020 2020 2020 2020 2020 2020  ey.             
-00009ac0: 2020 204b 6579 5665 7269 6669 6361 7469     KeyVerificati
-00009ad0: 6f6e 4b65 7928 0a20 2020 2020 2020 2020  onKey(.         
-00009ae0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00009af0: 653d 7b27 636f 6e74 656e 7427 3a20 7b0a  e={'content': {.
-00009b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b10: 2020 2020 2020 2020 2020 2020 276b 6579              'key
-00009b20: 273a 2027 536f 6d65 4372 7970 746f 4b65  ': 'SomeCryptoKe
-00009b30: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-00009b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b50: 2774 7261 6e73 6163 7469 6f6e 5f69 6427  'transaction_id'
-00009b60: 3a20 2753 6f6d 6554 7849 6427 7d2c 0a20  : 'SomeTxId'},. 
-00009b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b80: 2020 2020 2020 2027 7479 7065 273a 2027         'type': '
-00009b90: 6d2e 6b65 792e 7665 7269 6669 6361 7469  m.key.verificati
-00009ba0: 6f6e 2e6b 6579 272c 0a20 2020 2020 2020  on.key',.       
-00009bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009bc0: 2027 7365 6e64 6572 273a 2027 4075 7365   'sender': '@use
-00009bd0: 7232 3a65 7861 6d70 6c65 2e6f 7267 270a  r2:example.org'.
-00009be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009bf0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00009c00: 2020 2020 2020 2020 2020 2073 656e 6465             sende
-00009c10: 723d 2740 7573 6572 323a 6578 616d 706c  r='@user2:exampl
-00009c20: 652e 6f72 6727 2c0a 2020 2020 2020 2020  e.org',.        
-00009c30: 2020 2020 2020 2020 2020 2020 7472 616e              tran
-00009c40: 7361 6374 696f 6e5f 6964 3d27 536f 6d65  saction_id='Some
-00009c50: 5478 4964 272c 0a20 2020 2020 2020 2020  TxId',.         
-00009c60: 2020 2020 2020 2020 2020 206b 6579 3d27             key='
-00009c70: 536f 6d65 4372 7970 746f 4b65 7927 290a  SomeCryptoKey').
-00009c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c90: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-00009ca0: 2020 2020 7361 7320 3d20 636c 6965 6e74      sas = client
-00009cb0: 2e6b 6579 5f76 6572 6966 6963 6174 696f  .key_verificatio
-00009cc0: 6e73 5b65 7665 6e74 2e74 7261 6e73 6163  ns[event.transac
-00009cd0: 7469 6f6e 5f69 645d 0a0a 2020 2020 2020  tion_id]..      
-00009ce0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00009cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009d00: 2020 2020 2066 227b 7361 732e 6765 745f       f"{sas.get_
-00009d10: 656d 6f6a 6928 297d 222c 0a20 2020 2020  emoji()}",.     
-00009d20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00009d30: 696c 653d 7379 732e 7374 646f 7574 2c0a  ile=sys.stdout,.
-00009d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d50: 2020 2020 666c 7573 683d 5472 7565 2c0a      flush=True,.
-00009d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d70: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00009d80: 2020 2079 6e20 3d20 696e 7075 7428 2244     yn = input("D
-00009d90: 6f20 7468 6520 656d 6f6a 6973 206d 6174  o the emojis mat
-00009da0: 6368 3f20 2859 2f4e 2920 2843 2066 6f72  ch? (Y/N) (C for
-00009db0: 2043 616e 6365 6c29 2022 290a 2020 2020   Cancel) ").    
-00009dc0: 2020 2020 2020 2020 2020 2020 6966 2079              if y
-00009dd0: 6e2e 6c6f 7765 7228 2920 3d3d 2022 7922  n.lower() == "y"
-00009de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009df0: 2020 2020 2020 7072 696e 7428 0a20 2020        print(.   
-00009e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e10: 2020 2020 2022 4d61 7463 6821 2054 6865       "Match! The
-00009e20: 2076 6572 6966 6963 6174 696f 6e20 666f   verification fo
-00009e30: 7220 7468 6973 2022 0a20 2020 2020 2020  r this ".       
-00009e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e50: 2022 6465 7669 6365 2077 696c 6c20 6265   "device will be
-00009e60: 2061 6363 6570 7465 642e 222c 0a20 2020   accepted.",.   
-00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e80: 2020 2020 2066 696c 653d 7379 732e 7374       file=sys.st
-00009e90: 646f 7574 2c0a 2020 2020 2020 2020 2020  dout,.          
-00009ea0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-00009eb0: 7573 683d 5472 7565 2c0a 2020 2020 2020  ush=True,.      
-00009ec0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00009ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ee0: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
-00009ef0: 2063 6c69 656e 742e 636f 6e66 6972 6d5f   client.confirm_
-00009f00: 7368 6f72 745f 6175 7468 5f73 7472 696e  short_auth_strin
-00009f10: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00009f20: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00009f30: 2e74 7261 6e73 6163 7469 6f6e 5f69 640a  .transaction_id.
-00009f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f50: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00009f60: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-00009f70: 6e73 7461 6e63 6528 7265 7370 2c20 546f  nstance(resp, To
-00009f80: 4465 7669 6365 4572 726f 7229 3a0a 2020  DeviceError):.  
-00009f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fa0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-00009fb0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00009fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fd0: 2245 3131 313a 2022 0a20 2020 2020 2020  "E111: ".       
-00009fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ff0: 2020 2020 2022 636f 6e66 6972 6d5f 7368       "confirm_sh
-0000a000: 6f72 745f 6175 7468 5f73 7472 696e 6720  ort_auth_string 
-0000a010: 6661 696c 6564 2077 6974 6820 220a 2020  failed with ".  
-0000a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a030: 2020 2020 2020 2020 2020 6622 6572 726f            f"erro
-0000a040: 7220 277b 7072 6976 6163 795f 6669 6c74  r '{privacy_filt
-0000a050: 6572 2873 7472 2872 6573 7029 297d 272e  er(str(resp))}'.
-0000a060: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000a070: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000a080: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0000a090: 2079 6e2e 6c6f 7765 7228 2920 3d3d 2022   yn.lower() == "
-0000a0a0: 6e22 3a20 2023 206e 6f2c 2064 6f6e 2774  n":  # no, don't
-0000a0b0: 206d 6174 6368 2c20 7265 6a65 6374 0a20   match, reject. 
-0000a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0d0: 2020 2070 7269 6e74 280a 2020 2020 2020     print(.      
-0000a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0f0: 2020 224e 6f20 6d61 7463 6821 2044 6576    "No match! Dev
-0000a100: 6963 6520 7769 6c6c 204e 4f54 2062 6520  ice will NOT be 
-0000a110: 7665 7269 6669 6564 2e20 220a 2020 2020  verified. ".    
-0000a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a130: 2020 2020 2256 6572 6966 6963 6174 696f      "Verificatio
-0000a140: 6e20 7769 6c6c 2062 6520 7265 6a65 6374  n will be reject
-0000a150: 6564 2e22 2c0a 2020 2020 2020 2020 2020  ed.",.          
-0000a160: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000a170: 6c65 3d73 7973 2e73 7464 6572 722c 0a20  le=sys.stderr,. 
-0000a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a190: 2020 2020 2020 2066 6c75 7368 3d54 7275         flush=Tru
-0000a1a0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000a1b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000a1c0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0000a1d0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-0000a1e0: 2e63 616e 6365 6c5f 6b65 795f 7665 7269  .cancel_key_veri
-0000a1f0: 6669 6361 7469 6f6e 280a 2020 2020 2020  fication(.      
-0000a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a210: 2020 6576 656e 742e 7472 616e 7361 6374    event.transact
-0000a220: 696f 6e5f 6964 2c20 7265 6a65 6374 3d54  ion_id, reject=T
-0000a230: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0000a240: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000a250: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000a260: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-0000a270: 2c20 546f 4465 7669 6365 4572 726f 7229  , ToDeviceError)
-0000a280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a290: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0000a2a0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-0000a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2c0: 2020 2020 2245 3131 323a 2022 0a20 2020      "E112: ".   
-0000a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2e0: 2020 2020 2020 2020 2022 6361 6e63 656c           "cancel
-0000a2f0: 5f6b 6579 5f76 6572 6966 6963 6174 696f  _key_verificatio
-0000a300: 6e20 6661 696c 6564 2077 6974 6820 220a  n failed with ".
-0000a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a320: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
-0000a330: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-0000a340: 7472 2872 6573 7029 297d 272e 220a 2020  tr(resp))}'.".  
-0000a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a360: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000a370: 2020 2020 2020 2020 656c 7365 3a20 2023          else:  #
-0000a380: 2043 206f 7220 616e 7974 6869 6e67 2066   C or anything f
-0000a390: 6f72 2063 616e 6365 6c0a 2020 2020 2020  or cancel.      
-0000a3a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0000a3b0: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-0000a3c0: 2020 2020 2020 2020 2020 2020 2022 4361               "Ca
-0000a3d0: 6e63 656c 6c65 6420 6279 2075 7365 7221  ncelled by user!
-0000a3e0: 2056 6572 6966 6963 6174 696f 6e20 7769   Verification wi
-0000a3f0: 6c6c 2062 6520 6361 6e63 656c 6c65 642e  ll be cancelled.
-0000a400: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000a410: 2020 2020 2020 2020 2020 2066 696c 653d             file=
-0000a420: 7379 732e 7374 6465 7272 2c0a 2020 2020  sys.stderr,.    
-0000a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a440: 2020 2020 666c 7573 683d 5472 7565 2c0a      flush=True,.
-0000a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a460: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000a470: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
-0000a480: 2061 7761 6974 2063 6c69 656e 742e 6361   await client.ca
-0000a490: 6e63 656c 5f6b 6579 5f76 6572 6966 6963  ncel_key_verific
-0000a4a0: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
-0000a4b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000a4c0: 7665 6e74 2e74 7261 6e73 6163 7469 6f6e  vent.transaction
-0000a4d0: 5f69 642c 2072 656a 6563 743d 4661 6c73  _id, reject=Fals
-0000a4e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000a4f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000a500: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000a510: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
-0000a520: 546f 4465 7669 6365 4572 726f 7229 3a0a  ToDeviceError):.
-0000a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a540: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-0000a550: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a570: 2020 2245 3131 333a 2022 0a20 2020 2020    "E113: ".     
-0000a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a590: 2020 2020 2020 2022 6361 6e63 656c 5f6b         "cancel_k
-0000a5a0: 6579 5f76 6572 6966 6963 6174 696f 6e20  ey_verification 
-0000a5b0: 6661 696c 6564 2077 6974 6820 220a 2020  failed with ".  
-0000a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a5d0: 2020 2020 2020 2020 2020 6622 277b 7072            f"'{pr
-0000a5e0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-0000a5f0: 2872 6573 7029 297d 272e 220a 2020 2020  (resp))}'.".    
-0000a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a610: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000a620: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-0000a630: 6365 2865 7665 6e74 2c20 4b65 7956 6572  ce(event, KeyVer
-0000a640: 6966 6963 6174 696f 6e4d 6163 293a 2020  ificationMac):  
-0000a650: 2320 7468 6972 6420 7374 6570 0a20 2020  # third step.   
-0000a660: 2020 2020 2020 2020 2020 2020 2022 2222               """
-0000a670: 5468 6972 6420 7374 6570 2069 7320 746f  Third step is to
-0000a680: 2072 6563 6569 7665 204b 6579 5665 7269   receive KeyVeri
-0000a690: 6669 6361 7469 6f6e 4d61 630a 2020 2020  ficationMac.    
-0000a6a0: 2020 2020 2020 2020 2020 2020 4b65 7956              KeyV
-0000a6b0: 6572 6966 6963 6174 696f 6e4d 6163 280a  erificationMac(.
-0000a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6d0: 2020 2020 736f 7572 6365 3d7b 2763 6f6e      source={'con
-0000a6e0: 7465 6e74 273a 207b 0a20 2020 2020 2020  tent': {.       
-0000a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a700: 2027 6d61 6327 3a20 7b27 6564 3235 3531   'mac': {'ed2551
-0000a710: 393a 4445 5649 4345 4944 5859 273a 2027  9:DEVICEIDXY': '
-0000a720: 536f 6d65 4b65 7931 272c 0a20 2020 2020  SomeKey1',.     
-0000a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a740: 2020 2020 2020 2020 2020 2027 6564 3235             'ed25
-0000a750: 3531 393a 536f 6d65 4b65 7932 273a 2027  519:SomeKey2': '
-0000a760: 536f 6d65 4b65 7933 277d 2c0a 2020 2020  SomeKey3'},.    
-0000a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a780: 2020 2020 276b 6579 7327 3a20 2753 6f6d      'keys': 'Som
-0000a790: 6543 7279 7074 6f4b 6579 3427 2c0a 2020  eCryptoKey4',.  
-0000a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7b0: 2020 2020 2020 2774 7261 6e73 6163 7469        'transacti
-0000a7c0: 6f6e 5f69 6427 3a20 2753 6f6d 6554 7849  on_id': 'SomeTxI
-0000a7d0: 6427 7d2c 0a20 2020 2020 2020 2020 2020  d'},.           
-0000a7e0: 2020 2020 2020 2020 2020 2020 2027 7479               'ty
-0000a7f0: 7065 273a 2027 6d2e 6b65 792e 7665 7269  pe': 'm.key.veri
-0000a800: 6669 6361 7469 6f6e 2e6d 6163 272c 0a20  fication.mac',. 
-0000a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a820: 2020 2020 2020 2027 7365 6e64 6572 273a         'sender':
-0000a830: 2027 4075 7365 7232 3a65 7861 6d70 6c65   '@user2:example
-0000a840: 2e6f 7267 277d 2c0a 2020 2020 2020 2020  .org'},.        
-0000a850: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-0000a860: 6572 3d27 4075 7365 7232 3a65 7861 6d70  er='@user2:examp
-0000a870: 6c65 2e6f 7267 272c 0a20 2020 2020 2020  le.org',.       
-0000a880: 2020 2020 2020 2020 2020 2020 2074 7261               tra
-0000a890: 6e73 6163 7469 6f6e 5f69 643d 2753 6f6d  nsaction_id='Som
-0000a8a0: 6554 7849 6427 2c0a 2020 2020 2020 2020  eTxId',.        
-0000a8b0: 2020 2020 2020 2020 2020 2020 6d61 633d              mac=
-0000a8c0: 7b27 6564 3235 3531 393a 4445 5649 4345  {'ed25519:DEVICE
-0000a8d0: 4944 5859 273a 2027 536f 6d65 4b65 7931  IDXY': 'SomeKey1
-0000a8e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0000a8f0: 2020 2020 2020 2020 2020 2020 2765 6432              'ed2
-0000a900: 3535 3139 3a53 6f6d 654b 6579 3227 3a20  5519:SomeKey2': 
-0000a910: 2753 6f6d 654b 6579 3327 7d2c 0a20 2020  'SomeKey3'},.   
-0000a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a930: 206b 6579 733d 2753 6f6d 6543 7279 7074   keys='SomeCrypt
-0000a940: 6f4b 6579 3427 290a 2020 2020 2020 2020  oKey4').        
-0000a950: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000a960: 2020 2020 2020 2020 2020 2020 7361 7320              sas 
-0000a970: 3d20 636c 6965 6e74 2e6b 6579 5f76 6572  = client.key_ver
-0000a980: 6966 6963 6174 696f 6e73 5b65 7665 6e74  ifications[event
-0000a990: 2e74 7261 6e73 6163 7469 6f6e 5f69 645d  .transaction_id]
-0000a9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a9b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000a9c0: 2020 2020 2020 2020 2020 746f 6465 7669            todevi
-0000a9d0: 6365 5f6d 7367 203d 2073 6173 2e67 6574  ce_msg = sas.get
-0000a9e0: 5f6d 6163 2829 0a20 2020 2020 2020 2020  _mac().         
-0000a9f0: 2020 2020 2020 2065 7863 6570 7420 4c6f         except Lo
-0000aa00: 6361 6c50 726f 746f 636f 6c45 7272 6f72  calProtocolError
-0000aa10: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0000aa20: 2020 2020 2020 2020 2020 2023 2065 2e67             # e.g
-0000aa30: 2e20 6974 206d 6967 6874 2068 6176 6520  . it might have 
-0000aa40: 6265 656e 2063 616e 6365 6c6c 6564 2062  been cancelled b
-0000aa50: 7920 6f75 7273 656c 7665 730a 2020 2020  y ourselves.    
-0000aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa70: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-0000aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa90: 2020 2020 2020 2245 3131 343a 2022 0a20        "E114: ". 
-0000aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aab0: 2020 2020 2020 2066 2243 616e 6365 6c6c         f"Cancell
-0000aac0: 6564 206f 7220 7072 6f74 6f63 6f6c 2065  ed or protocol e
-0000aad0: 7272 6f72 3a20 5265 6173 6f6e 3a20 7b65  rror: Reason: {e
-0000aae0: 7d2e 5c6e 220a 2020 2020 2020 2020 2020  }.\n".          
-0000aaf0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0000ab00: 5665 7269 6669 6361 7469 6f6e 2077 6974  Verification wit
-0000ab10: 6820 7b65 7665 6e74 2e73 656e 6465 727d  h {event.sender}
-0000ab20: 206e 6f74 2063 6f6e 636c 7564 6564 2e20   not concluded. 
-0000ab30: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000ab40: 2020 2020 2020 2020 2020 2254 7279 2061            "Try a
-0000ab50: 6761 696e 3f22 0a20 2020 2020 2020 2020  gain?".         
-0000ab60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000ab70: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000ab80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000ab90: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-0000aba0: 6169 7420 636c 6965 6e74 2e74 6f5f 6465  ait client.to_de
-0000abb0: 7669 6365 2874 6f64 6576 6963 655f 6d73  vice(todevice_ms
-0000abc0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-0000abd0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000abe0: 616e 6365 2872 6573 702c 2054 6f44 6576  ance(resp, ToDev
-0000abf0: 6963 6545 7272 6f72 293a 0a20 2020 2020  iceError):.     
+000096b0: 2020 2020 2020 2020 2020 2020 2020 5b27                ['
+000096c0: 6465 6369 6d61 6c27 2c20 2765 6d6f 6a69  decimal', 'emoji
+000096d0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+000096e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096f0: 2027 7472 616e 7361 6374 696f 6e5f 6964   'transaction_id
+00009700: 273a 2027 536f 6d65 5478 4964 270a 2020  ': 'SomeTxId'.  
+00009710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009720: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00009730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009740: 2020 2020 2020 2020 2020 2774 7970 6527            'type'
+00009750: 3a20 276d 2e6b 6579 2e76 6572 6966 6963  : 'm.key.verific
+00009760: 6174 696f 6e2e 7374 6172 7427 2c0a 2020  ation.start',.  
+00009770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009780: 2020 2020 2020 2020 2020 2773 656e 6465            'sende
+00009790: 7227 3a20 2740 7573 6572 323a 6578 616d  r': '@user2:exam
+000097a0: 706c 652e 6f72 6727 0a20 2020 2020 2020  ple.org'.       
+000097b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097c0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000097d0: 2020 2020 2020 2020 2020 2020 7365 6e64              send
+000097e0: 6572 3d27 4075 7365 7232 3a65 7861 6d70  er='@user2:examp
+000097f0: 6c65 2e6f 7267 272c 0a20 2020 2020 2020  le.org',.       
+00009800: 2020 2020 2020 2020 2020 2020 2074 7261               tra
+00009810: 6e73 6163 7469 6f6e 5f69 643d 2753 6f6d  nsaction_id='Som
+00009820: 6554 7849 6427 2c0a 2020 2020 2020 2020  eTxId',.        
+00009830: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00009840: 5f64 6576 6963 653d 2744 4556 4943 4549  _device='DEVICEI
+00009850: 4458 5927 2c0a 2020 2020 2020 2020 2020  DXY',.          
+00009860: 2020 2020 2020 2020 2020 6d65 7468 6f64            method
+00009870: 3d27 6d2e 7361 732e 7631 272c 0a20 2020  ='m.sas.v1',.   
+00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009890: 206b 6579 5f61 6772 6565 6d65 6e74 5f70   key_agreement_p
+000098a0: 726f 746f 636f 6c73 3d5b 0a20 2020 2020  rotocols=[.     
+000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098c0: 2020 2027 6375 7276 6532 3535 3139 2d68     'curve25519-h
+000098d0: 6b64 662d 7368 6132 3536 272c 2027 6375  kdf-sha256', 'cu
+000098e0: 7276 6532 3535 3139 275d 2c0a 2020 2020  rve25519'],.    
+000098f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009900: 6861 7368 6573 3d5b 2773 6861 3235 3627  hashes=['sha256'
+00009910: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00009920: 2020 2020 2020 206d 6573 7361 6765 5f61         message_a
+00009930: 7574 6865 6e74 6963 6174 696f 6e5f 636f  uthentication_co
+00009940: 6465 733d 5b0a 2020 2020 2020 2020 2020  des=[.          
+00009950: 2020 2020 2020 2020 2020 2020 2020 2768                'h
+00009960: 6b64 662d 686d 6163 2d73 6861 3235 3627  kdf-hmac-sha256'
+00009970: 2c20 2768 6d61 632d 7368 6132 3536 275d  , 'hmac-sha256']
+00009980: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009990: 2020 2020 2020 7368 6f72 745f 6175 7468        short_auth
+000099a0: 656e 7469 6361 7469 6f6e 5f73 7472 696e  entication_strin
+000099b0: 673d 5b27 6465 6369 6d61 6c27 2c20 2765  g=['decimal', 'e
+000099c0: 6d6f 6a69 275d 290a 2020 2020 2020 2020  moji']).        
+000099d0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
+000099e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000099f0: 2265 6d6f 6a69 2220 6e6f 7420 696e 2065  "emoji" not in e
+00009a00: 7665 6e74 2e73 686f 7274 5f61 7574 6865  vent.short_authe
+00009a10: 6e74 6963 6174 696f 6e5f 7374 7269 6e67  ntication_string
+00009a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009a30: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+00009a40: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00009a50: 2020 2020 2020 2020 2020 2020 2245 3130              "E10
+00009a60: 373a 2022 0a20 2020 2020 2020 2020 2020  7: ".           
+00009a70: 2020 2020 2020 2020 2020 2020 2022 4f74               "Ot
+00009a80: 6865 7220 6465 7669 6365 2064 6f65 7320  her device does 
+00009a90: 6e6f 7420 7375 7070 6f72 7420 656d 6f6a  not support emoj
+00009aa0: 6920 7665 7269 6669 6361 7469 6f6e 2e20  i verification. 
+00009ab0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00009ac0: 2020 2020 2020 2020 2020 6622 7b65 7665            f"{eve
+00009ad0: 6e74 2e73 686f 7274 5f61 7574 6865 6e74  nt.short_authent
+00009ae0: 6963 6174 696f 6e5f 7374 7269 6e67 7d2e  ication_string}.
+00009af0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00009b00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00009b10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00009b20: 726e 0a20 2020 2020 2020 2020 2020 2020  rn.             
+00009b30: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+00009b40: 636c 6965 6e74 2e61 6363 6570 745f 6b65  client.accept_ke
+00009b50: 795f 7665 7269 6669 6361 7469 6f6e 280a  y_verification(.
+00009b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b70: 2020 2020 6576 656e 742e 7472 616e 7361      event.transa
+00009b80: 6374 696f 6e5f 6964 0a20 2020 2020 2020  ction_id.       
+00009b90: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00009ba0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00009bb0: 696e 7374 616e 6365 2872 6573 702c 2054  instance(resp, T
+00009bc0: 6f44 6576 6963 6545 7272 6f72 293a 0a20  oDeviceError):. 
+00009bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009be0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00009bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009c00: 2020 2020 2020 2020 2022 4531 3038 3a20           "E108: 
+00009c10: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00009c20: 2020 2020 2020 2020 2020 2261 6363 6570            "accep
+00009c30: 745f 6b65 795f 7665 7269 6669 6361 7469  t_key_verificati
+00009c40: 6f6e 2066 6169 6c65 6420 7769 7468 2065  on failed with e
+00009c50: 7272 6f72 2022 0a20 2020 2020 2020 2020  rror ".         
+00009c60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009c70: 2227 7b70 7269 7661 6379 5f66 696c 7465  "'{privacy_filte
+00009c80: 7228 7374 7228 7265 7370 2929 7d27 2e22  r(str(resp))}'."
+00009c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009ca0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00009cb0: 2020 2020 2020 2020 7361 7320 3d20 636c          sas = cl
+00009cc0: 6965 6e74 2e6b 6579 5f76 6572 6966 6963  ient.key_verific
+00009cd0: 6174 696f 6e73 5b65 7665 6e74 2e74 7261  ations[event.tra
+00009ce0: 6e73 6163 7469 6f6e 5f69 645d 0a0a 2020  nsaction_id]..  
+00009cf0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00009d00: 6465 7669 6365 5f6d 7367 203d 2073 6173  device_msg = sas
+00009d10: 2e73 6861 7265 5f6b 6579 2829 0a20 2020  .share_key().   
+00009d20: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00009d30: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
+00009d40: 2e74 6f5f 6465 7669 6365 2874 6f64 6576  .to_device(todev
+00009d50: 6963 655f 6d73 6729 0a20 2020 2020 2020  ice_msg).       
+00009d60: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00009d70: 7374 616e 6365 2872 6573 702c 2054 6f44  stance(resp, ToD
+00009d80: 6576 6963 6545 7272 6f72 293a 0a20 2020  eviceError):.   
+00009d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009da0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00009db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009dc0: 2020 2020 2020 2022 4531 3039 3a20 220a         "E109: ".
+00009dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009de0: 2020 2020 2020 2020 2274 6f5f 6465 7669          "to_devi
+00009df0: 6365 2066 6169 6c65 6420 7769 7468 2065  ce failed with e
+00009e00: 7272 6f72 2022 0a20 2020 2020 2020 2020  rror ".         
+00009e10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009e20: 2227 7b70 7269 7661 6379 5f66 696c 7465  "'{privacy_filte
+00009e30: 7228 7374 7228 7265 7370 2929 7d27 2e22  r(str(resp))}'."
+00009e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009e50: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00009e60: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00009e70: 6e63 6528 6576 656e 742c 204b 6579 5665  nce(event, KeyVe
+00009e80: 7269 6669 6361 7469 6f6e 4361 6e63 656c  rificationCancel
+00009e90: 293a 2020 2320 616e 7974 696d 650a 2020  ):  # anytime.  
+00009ea0: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+00009eb0: 2261 7420 616e 7920 7469 6d65 3a20 7265  "at any time: re
+00009ec0: 6365 6976 6520 4b65 7956 6572 6966 6963  ceive KeyVerific
+00009ed0: 6174 696f 6e43 616e 6365 6c0a 2020 2020  ationCancel.    
+00009ee0: 2020 2020 2020 2020 2020 2020 4b65 7956              KeyV
+00009ef0: 6572 6966 6963 6174 696f 6e43 616e 6365  erificationCance
+00009f00: 6c28 736f 7572 6365 3d7b 0a20 2020 2020  l(source={.     
+00009f10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00009f20: 636f 6e74 656e 7427 3a20 7b27 636f 6465  content': {'code
+00009f30: 273a 2027 6d2e 6d69 736d 6174 6368 6564  ': 'm.mismatched
+00009f40: 5f73 6173 272c 0a20 2020 2020 2020 2020  _sas',.         
+00009f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f60: 2020 2020 2020 2027 7265 6173 6f6e 273a         'reason':
+00009f70: 2027 4d69 736d 6174 6368 6564 2061 7574   'Mismatched aut
+00009f80: 6865 6e74 6963 6174 696f 6e20 7374 7269  hentication stri
+00009f90: 6e67 272c 0a20 2020 2020 2020 2020 2020  ng',.           
+00009fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009fb0: 2020 2020 2027 7472 616e 7361 6374 696f       'transactio
+00009fc0: 6e5f 6964 273a 2027 536f 6d65 5478 4964  n_id': 'SomeTxId
+00009fd0: 277d 2c0a 2020 2020 2020 2020 2020 2020  '},.            
+00009fe0: 2020 2020 2020 2020 2774 7970 6527 3a20          'type': 
+00009ff0: 276d 2e6b 6579 2e76 6572 6966 6963 6174  'm.key.verificat
+0000a000: 696f 6e2e 6361 6e63 656c 272c 0a20 2020  ion.cancel',.   
+0000a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a020: 2027 7365 6e64 6572 273a 2027 4075 7365   'sender': '@use
+0000a030: 7232 3a65 7861 6d70 6c65 2e6f 7267 277d  r2:example.org'}
+0000a040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a050: 2020 2020 2020 7365 6e64 6572 3d27 4075        sender='@u
+0000a060: 7365 7232 3a65 7861 6d70 6c65 2e6f 7267  ser2:example.org
+0000a070: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0000a080: 2020 2020 2020 2074 7261 6e73 6163 7469         transacti
+0000a090: 6f6e 5f69 643d 2753 6f6d 6554 7849 6427  on_id='SomeTxId'
+0000a0a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a0b0: 2020 2020 2020 636f 6465 3d27 6d2e 6d69        code='m.mi
+0000a0c0: 736d 6174 6368 6564 5f73 6173 272c 0a20  smatched_sas',. 
+0000a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0e0: 2020 2072 6561 736f 6e3d 274d 6973 6d61     reason='Misma
+0000a0f0: 7463 6865 6420 7368 6f72 7420 6175 7468  tched short auth
+0000a100: 656e 7469 6361 7469 6f6e 2073 7472 696e  entication strin
+0000a110: 6727 290a 2020 2020 2020 2020 2020 2020  g').            
+0000a120: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+0000a130: 2020 2020 2020 2020 2023 2054 6865 7265           # There
+0000a140: 2069 7320 6e6f 206e 6565 6420 746f 2069   is no need to i
+0000a150: 7373 7565 2061 0a20 2020 2020 2020 2020  ssue a.         
+0000a160: 2020 2020 2020 2023 2063 6c69 656e 742e         # client.
+0000a170: 6361 6e63 656c 5f6b 6579 5f76 6572 6966  cancel_key_verif
+0000a180: 6963 6174 696f 6e28 7478 5f69 642c 2072  ication(tx_id, r
+0000a190: 656a 6563 743d 4661 6c73 6529 0a20 2020  eject=False).   
+0000a1a0: 2020 2020 2020 2020 2020 2020 2023 2068               # h
+0000a1b0: 6572 652e 2054 6865 2053 4153 2066 6c6f  ere. The SAS flo
+0000a1c0: 7720 6973 2061 6c72 6561 6479 2063 616e  w is already can
+0000a1d0: 6365 6c6c 6564 2e0a 2020 2020 2020 2020  celled..        
+0000a1e0: 2020 2020 2020 2020 2320 5765 206f 6e6c          # We onl
+0000a1f0: 7920 6e65 6564 2074 6f20 696e 666f 726d  y need to inform
+0000a200: 2074 6865 2075 7365 722e 0a20 2020 2020   the user..     
+0000a210: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0000a220: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
+0000a230: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
+0000a240: 3130 3a20 220a 2020 2020 2020 2020 2020  10: ".          
+0000a250: 2020 2020 2020 2020 2020 6622 5665 7269            f"Veri
+0000a260: 6669 6361 7469 6f6e 2068 6173 2062 6565  fication has bee
+0000a270: 6e20 6361 6e63 656c 6c65 6420 6279 207b  n cancelled by {
+0000a280: 6576 656e 742e 7365 6e64 6572 7d20 220a  event.sender} ".
+0000a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2a0: 2020 2020 6627 666f 7220 7265 6173 6f6e      f'for reason
+0000a2b0: 2022 7b65 7665 6e74 2e72 6561 736f 6e7d   "{event.reason}
+0000a2c0: 222e 270a 2020 2020 2020 2020 2020 2020  ".'.            
+0000a2d0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000a2e0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0000a2f0: 6365 2865 7665 6e74 2c20 4b65 7956 6572  ce(event, KeyVer
+0000a300: 6966 6963 6174 696f 6e4b 6579 293a 2020  ificationKey):  
+0000a310: 2320 7365 636f 6e64 2073 7465 700a 2020  # second step.  
+0000a320: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+0000a330: 2253 6563 6f6e 6420 7374 6570 2069 7320  "Second step is 
+0000a340: 746f 2072 6563 6569 7665 204b 6579 5665  to receive KeyVe
+0000a350: 7269 6669 6361 7469 6f6e 4b65 790a 2020  rificationKey.  
+0000a360: 2020 2020 2020 2020 2020 2020 2020 4b65                Ke
+0000a370: 7956 6572 6966 6963 6174 696f 6e4b 6579  yVerificationKey
+0000a380: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000a390: 2020 2020 2020 736f 7572 6365 3d7b 2763        source={'c
+0000a3a0: 6f6e 7465 6e74 273a 207b 0a20 2020 2020  ontent': {.     
+0000a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3c0: 2020 2020 2020 2027 6b65 7927 3a20 2753         'key': 'S
+0000a3d0: 6f6d 6543 7279 7074 6f4b 6579 272c 0a20  omeCryptoKey',. 
+0000a3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3f0: 2020 2020 2020 2020 2020 2027 7472 616e             'tran
+0000a400: 7361 6374 696f 6e5f 6964 273a 2027 536f  saction_id': 'So
+0000a410: 6d65 5478 4964 277d 2c0a 2020 2020 2020  meTxId'},.      
+0000a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a430: 2020 2774 7970 6527 3a20 276d 2e6b 6579    'type': 'm.key
+0000a440: 2e76 6572 6966 6963 6174 696f 6e2e 6b65  .verification.ke
+0000a450: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+0000a460: 2020 2020 2020 2020 2020 2020 2773 656e              'sen
+0000a470: 6465 7227 3a20 2740 7573 6572 323a 6578  der': '@user2:ex
+0000a480: 616d 706c 652e 6f72 6727 0a20 2020 2020  ample.org'.     
+0000a490: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0000a4a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a4b0: 2020 2020 2020 7365 6e64 6572 3d27 4075        sender='@u
+0000a4c0: 7365 7232 3a65 7861 6d70 6c65 2e6f 7267  ser2:example.org
+0000a4d0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0000a4e0: 2020 2020 2020 2074 7261 6e73 6163 7469         transacti
+0000a4f0: 6f6e 5f69 643d 2753 6f6d 6554 7849 6427  on_id='SomeTxId'
+0000a500: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a510: 2020 2020 2020 6b65 793d 2753 6f6d 6543        key='SomeC
+0000a520: 7279 7074 6f4b 6579 2729 0a20 2020 2020  ryptoKey').     
+0000a530: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
+0000a540: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000a550: 6173 203d 2063 6c69 656e 742e 6b65 795f  as = client.key_
+0000a560: 7665 7269 6669 6361 7469 6f6e 735b 6576  verifications[ev
+0000a570: 656e 742e 7472 616e 7361 6374 696f 6e5f  ent.transaction_
+0000a580: 6964 5d0a 0a20 2020 2020 2020 2020 2020  id]..           
+0000a590: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
+0000a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5b0: 6622 7b73 6173 2e67 6574 5f65 6d6f 6a69  f"{sas.get_emoji
+0000a5c0: 2829 7d22 2c0a 2020 2020 2020 2020 2020  ()}",.          
+0000a5d0: 2020 2020 2020 2020 2020 6669 6c65 3d73            file=s
+0000a5e0: 7973 2e73 7464 6f75 742c 0a20 2020 2020  ys.stdout,.     
+0000a5f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000a600: 6c75 7368 3d54 7275 652c 0a20 2020 2020  lush=True,.     
+0000a610: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000a620: 2020 2020 2020 2020 2020 2020 2020 796e                yn
+0000a630: 203d 2069 6e70 7574 2822 446f 2074 6865   = input("Do the
+0000a640: 2065 6d6f 6a69 7320 6d61 7463 683f 2028   emojis match? (
+0000a650: 592f 4e29 2028 4320 666f 7220 4361 6e63  Y/N) (C for Canc
+0000a660: 656c 2920 2229 0a20 2020 2020 2020 2020  el) ").         
+0000a670: 2020 2020 2020 2069 6620 796e 2e6c 6f77         if yn.low
+0000a680: 6572 2829 203d 3d20 2279 223a 0a20 2020  er() == "y":.   
+0000a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6a0: 2070 7269 6e74 280a 2020 2020 2020 2020   print(.        
+0000a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6c0: 224d 6174 6368 2120 5468 6520 7665 7269  "Match! The veri
+0000a6d0: 6669 6361 7469 6f6e 2066 6f72 2074 6869  fication for thi
+0000a6e0: 7320 220a 2020 2020 2020 2020 2020 2020  s ".            
+0000a6f0: 2020 2020 2020 2020 2020 2020 2264 6576              "dev
+0000a700: 6963 6520 7769 6c6c 2062 6520 6163 6365  ice will be acce
+0000a710: 7074 6564 2e22 2c0a 2020 2020 2020 2020  pted.",.        
+0000a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a730: 6669 6c65 3d73 7973 2e73 7464 6f75 742c  file=sys.stdout,
+0000a740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a750: 2020 2020 2020 2020 2066 6c75 7368 3d54           flush=T
+0000a760: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0000a770: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000a780: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000a790: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+0000a7a0: 6e74 2e63 6f6e 6669 726d 5f73 686f 7274  nt.confirm_short
+0000a7b0: 5f61 7574 685f 7374 7269 6e67 280a 2020  _auth_string(.  
+0000a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7d0: 2020 2020 2020 6576 656e 742e 7472 616e        event.tran
+0000a7e0: 7361 6374 696f 6e5f 6964 0a20 2020 2020  saction_id.     
+0000a7f0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000a800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a810: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000a820: 6365 2872 6573 702c 2054 6f44 6576 6963  ce(resp, ToDevic
+0000a830: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+0000a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a850: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0000a860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a870: 2020 2020 2020 2020 2020 2022 4531 3131             "E111
+0000a880: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+0000a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a8a0: 2263 6f6e 6669 726d 5f73 686f 7274 5f61  "confirm_short_a
+0000a8b0: 7574 685f 7374 7269 6e67 2066 6169 6c65  uth_string faile
+0000a8c0: 6420 7769 7468 2022 0a20 2020 2020 2020  d with ".       
+0000a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a8e0: 2020 2020 2066 2265 7272 6f72 2027 7b70       f"error '{p
+0000a8f0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+0000a900: 7228 7265 7370 2929 7d27 2e22 0a20 2020  r(resp))}'.".   
+0000a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a920: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000a930: 2020 2020 2020 2065 6c69 6620 796e 2e6c         elif yn.l
+0000a940: 6f77 6572 2829 203d 3d20 226e 223a 2020  ower() == "n":  
+0000a950: 2320 6e6f 2c20 646f 6e27 7420 6d61 7463  # no, don't matc
+0000a960: 682c 2072 656a 6563 740a 2020 2020 2020  h, reject.      
+0000a970: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000a980: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
+0000a990: 2020 2020 2020 2020 2020 2020 2022 4e6f               "No
+0000a9a0: 206d 6174 6368 2120 4465 7669 6365 2077   match! Device w
+0000a9b0: 696c 6c20 4e4f 5420 6265 2076 6572 6966  ill NOT be verif
+0000a9c0: 6965 642e 2022 0a20 2020 2020 2020 2020  ied. ".         
+0000a9d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000a9e0: 5665 7269 6669 6361 7469 6f6e 2077 696c  Verification wil
+0000a9f0: 6c20 6265 2072 656a 6563 7465 642e 222c  l be rejected.",
+0000aa00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aa10: 2020 2020 2020 2020 2066 696c 653d 7379           file=sy
+0000aa20: 732e 7374 6465 7272 2c0a 2020 2020 2020  s.stderr,.      
+0000aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa40: 2020 666c 7573 683d 5472 7565 2c0a 2020    flush=True,.  
+0000aa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000aa70: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+0000aa80: 7761 6974 2063 6c69 656e 742e 6361 6e63  wait client.canc
+0000aa90: 656c 5f6b 6579 5f76 6572 6966 6963 6174  el_key_verificat
+0000aaa0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+0000aab0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+0000aac0: 6e74 2e74 7261 6e73 6163 7469 6f6e 5f69  nt.transaction_i
+0000aad0: 642c 2072 656a 6563 743d 5472 7565 0a20  d, reject=True. 
+0000aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aaf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000ab00: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0000ab10: 7374 616e 6365 2872 6573 702c 2054 6f44  stance(resp, ToD
+0000ab20: 6576 6963 6545 7272 6f72 293a 0a20 2020  eviceError):.   
+0000ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab40: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+0000ab50: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000ab60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000ab70: 4531 3132 3a20 220a 2020 2020 2020 2020  E112: ".        
+0000ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab90: 2020 2020 2263 616e 6365 6c5f 6b65 795f      "cancel_key_
+0000aba0: 7665 7269 6669 6361 7469 6f6e 2066 6169  verification fai
+0000abb0: 6c65 6420 7769 7468 2022 0a20 2020 2020  led with ".     
+0000abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000abd0: 2020 2020 2020 2066 2227 7b70 7269 7661         f"'{priva
+0000abe0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+0000abf0: 7370 2929 7d27 2e22 0a20 2020 2020 2020  sp))}'.".       
 0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac10: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-0000ac20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ac30: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
-0000ac40: 3135 3a20 220a 2020 2020 2020 2020 2020  15: ".          
-0000ac50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac60: 2020 2274 6f5f 6465 7669 6365 2066 6169    "to_device fai
-0000ac70: 6c65 6420 7769 7468 2065 7272 6f72 2022  led with error "
-0000ac80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ac90: 2020 2020 2020 2020 2020 2020 2066 2227               f"'
-0000aca0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0000acb0: 7374 7228 7265 7370 2929 7d27 2e22 0a20  str(resp))}'.". 
-0000acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000acd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000ace0: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-0000acf0: 6c6f 672e 696e 666f 280a 2020 2020 2020  log.info(.      
-0000ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad10: 2020 6622 7361 732e 7765 5f73 7461 7274    f"sas.we_start
-0000ad20: 6564 5f69 7420 3d20 7b73 6173 2e77 655f  ed_it = {sas.we_
-0000ad30: 7374 6172 7465 645f 6974 7d5c 6e22 0a20  started_it}\n". 
-0000ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad50: 2020 2020 2020 2066 2273 6173 2e73 6173         f"sas.sas
-0000ad60: 5f61 6363 6570 7465 6420 3d20 7b73 6173  _accepted = {sas
-0000ad70: 2e73 6173 5f61 6363 6570 7465 647d 5c6e  .sas_accepted}\n
-0000ad80: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000ad90: 2020 2020 2020 2020 2020 6622 7361 732e            f"sas.
-0000ada0: 6361 6e63 656c 6564 203d 207b 7361 732e  canceled = {sas.
-0000adb0: 6361 6e63 656c 6564 7d5c 6e22 0a20 2020  canceled}\n".   
-0000adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000add0: 2020 2020 2066 2273 6173 2e74 696d 6564       f"sas.timed
-0000ade0: 5f6f 7574 203d 207b 7361 732e 7469 6d65  _out = {sas.time
-0000adf0: 645f 6f75 747d 5c6e 220a 2020 2020 2020  d_out}\n".      
-0000ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae10: 2020 6622 7361 732e 7665 7269 6669 6564    f"sas.verified
-0000ae20: 203d 207b 7361 732e 7665 7269 6669 6564   = {sas.verified
-0000ae30: 7d5c 6e22 0a20 2020 2020 2020 2020 2020  }\n".           
-0000ae40: 2020 2020 2020 2020 2020 2020 2066 2273               f"s
-0000ae50: 6173 2e76 6572 6966 6965 645f 6465 7669  as.verified_devi
-0000ae60: 6365 7320 3d20 7b73 6173 2e76 6572 6966  ces = {sas.verif
-0000ae70: 6965 645f 6465 7669 6365 737d 5c6e 220a  ied_devices}\n".
-0000ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae90: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000aea0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0000aeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aec0: 2020 2020 2020 2020 2022 456d 6f6a 6920           "Emoji 
-0000aed0: 7665 7269 6669 6361 7469 6f6e 2077 6173  verification was
-0000aee0: 2073 7563 6365 7373 6675 6c21 5c6e 220a   successful!\n".
-0000aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af00: 2020 2020 2020 2020 2256 6572 6966 7920          "Verify 
-0000af10: 7769 7468 206f 7468 6572 2064 6576 6963  with other devic
-0000af20: 6573 206f 7220 6869 7420 436f 6e74 726f  es or hit Contro
-0000af30: 6c2d 4320 746f 2022 0a20 2020 2020 2020  l-C to ".       
-0000af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af50: 2022 636f 6e74 696e 7565 2e22 2c0a 2020   "continue.",.  
-0000af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af70: 2020 2020 2020 6669 6c65 3d73 7973 2e73        file=sys.s
-0000af80: 7464 6f75 742c 0a20 2020 2020 2020 2020  tdout,.         
-0000af90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000afa0: 6c75 7368 3d54 7275 652c 0a20 2020 2020  lush=True,.     
-0000afb0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000afc0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000afd0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000afe0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-0000aff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b000: 2020 2020 2022 4531 3136 3a20 220a 2020       "E116: ".  
-0000b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b020: 2020 6622 5265 6365 6976 6564 2075 6e65    f"Received une
-0000b030: 7870 6563 7465 6420 6576 656e 7420 7479  xpected event ty
-0000b040: 7065 207b 7479 7065 2865 7665 6e74 297d  pe {type(event)}
-0000b050: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0000b060: 2020 2020 2020 2020 6622 4576 656e 7420          f"Event 
-0000b070: 6973 207b 6576 656e 747d 2e20 4576 656e  is {event}. Even
-0000b080: 7420 7769 6c6c 2062 6520 6967 6e6f 7265  t will be ignore
-0000b090: 642e 220a 2020 2020 2020 2020 2020 2020  d.".            
-0000b0a0: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
-0000b0b0: 6365 7074 2042 6173 6545 7863 6570 7469  cept BaseExcepti
-0000b0c0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-0000b0d0: 6773 2e6c 6f67 2e64 6562 7567 2822 4865  gs.log.debug("He
-0000b0e0: 7265 2069 7320 7468 6520 7472 6163 6562  re is the traceb
-0000b0f0: 6163 6b2e 5c6e 2220 2b20 7472 6163 6562  ack.\n" + traceb
-0000b100: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
-0000b110: 290a 0a0a 6465 6620 6e6f 7469 6679 2874  )...def notify(t
-0000b120: 6974 6c65 3a20 7374 722c 2063 6f6e 7465  itle: str, conte
-0000b130: 6e74 3a20 7374 722c 2069 6d61 6765 5f75  nt: str, image_u
-0000b140: 726c 3a20 7374 7229 3a0a 2020 2020 2222  rl: str):.    ""
-0000b150: 224e 6f74 6966 7920 4f53 206f 6620 6d65  "Notify OS of me
-0000b160: 7373 6167 6520 7265 6365 6970 742e 0a0a  ssage receipt...
-0000b170: 2020 2020 4966 2074 6865 2073 7973 7465      If the syste
-0000b180: 6d20 6973 2072 756e 6e69 6e67 2068 6561  m is running hea
-0000b190: 646c 6573 7320 6f72 2061 6e79 2070 726f  dless or any pro
-0000b1a0: 626c 656d 2068 6170 7065 6e73 2077 6974  blem happens wit
-0000b1b0: 680a 2020 2020 6f70 6572 6174 696e 6720  h.    operating 
-0000b1c0: 7379 7374 656d 206e 6f74 6966 6963 6174  system notificat
-0000b1d0: 696f 6e73 2c20 6967 6e6f 7265 2069 742e  ions, ignore it.
-0000b1e0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-0000b1f0: 6e6f 7420 4841 5645 5f4e 4f54 4946 593a  not HAVE_NOTIFY:
-0000b200: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0000b210: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-0000b220: 2020 2020 2022 5731 3030 3a20 220a 2020       "W100: ".  
-0000b230: 2020 2020 2020 2020 2020 226e 6f74 6966            "notif
-0000b240: 7932 206f 7220 6462 7573 2069 7320 6e6f  y2 or dbus is no
-0000b250: 7420 696e 7374 616c 6c65 642e 204e 6f74  t installed. Not
-0000b260: 6966 6963 6174 696f 6e73 2077 696c 6c20  ifications will 
-0000b270: 6e6f 7420 6265 2022 0a20 2020 2020 2020  not be ".       
-0000b280: 2020 2020 2022 6469 7370 6c61 7965 642e       "displayed.
-0000b290: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0000b2a0: 4d61 6b65 2073 7572 6520 7468 6174 206e  Make sure that n
-0000b2b0: 6f74 6966 7932 2061 6e64 2064 6275 7320  otify2 and dbus 
-0000b2c0: 6172 6520 696e 7374 616c 6c65 6420 6f72  are installed or
-0000b2d0: 2072 656d 6f76 6520 7468 6520 220a 2020   remove the ".  
-0000b2e0: 2020 2020 2020 2020 2020 222d 2d6f 732d            "--os-
-0000b2f0: 6e6f 7469 6679 206f 7074 696f 6e2e 220a  notify option.".
-0000b300: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000b310: 2020 6773 2e77 6172 6e5f 636f 756e 7420    gs.warn_count 
-0000b320: 2b3d 2031 0a20 2020 2020 2020 2072 6574  += 1.        ret
-0000b330: 7572 6e0a 2020 2020 7472 793a 0a20 2020  urn.    try:.   
-0000b340: 2020 2020 2069 6620 696d 6167 655f 7572       if image_ur
-0000b350: 6c3a 0a20 2020 2020 2020 2020 2020 206e  l:.            n
-0000b360: 6f74 7573 6564 2c20 6176 6174 6172 5f66  otused, avatar_f
-0000b370: 696c 6520 3d20 7465 6d70 6669 6c65 2e6d  ile = tempfile.m
-0000b380: 6b73 7465 6d70 2829 0a20 2020 2020 2020  kstemp().       
-0000b390: 2020 2020 2075 726c 6c69 622e 7265 7175       urllib.requ
-0000b3a0: 6573 742e 7572 6c72 6574 7269 6576 6528  est.urlretrieve(
-0000b3b0: 696d 6167 655f 7572 6c2c 2061 7661 7461  image_url, avata
-0000b3c0: 725f 6669 6c65 290a 2020 2020 2020 2020  r_file).        
-0000b3d0: 2020 2020 2320 544f 444f 3a20 636c 6561      # TODO: clea
-0000b3e0: 6e75 7020 7465 6d70 2066 696c 6573 3f20  nup temp files? 
-0000b3f0: 696e 2063 6c65 616e 7570 2829 3f0a 2020  in cleanup()?.  
-0000b400: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000b410: 2020 2020 2020 2020 2320 4963 6f6e 206e          # Icon n
-0000b420: 616d 6520 226e 6f74 6966 6963 6174 696f  ame "notificatio
-0000b430: 6e2d 6d65 7373 6167 652d 494d 2220 7769  n-message-IM" wi
-0000b440: 6c6c 2077 6f72 6b20 6f6e 2055 6275 6e74  ll work on Ubunt
-0000b450: 750a 2020 2020 2020 2020 2020 2020 2320  u.            # 
-0000b460: 6275 7420 6e6f 7420 616c 6c20 706c 6174  but not all plat
-0000b470: 666f 726d 730a 2020 2020 2020 2020 2020  forms.          
-0000b480: 2020 6176 6174 6172 5f66 696c 6520 3d20    avatar_file = 
-0000b490: 226e 6f74 6966 6963 6174 696f 6e2d 6d65  "notification-me
-0000b4a0: 7373 6167 652d 494d 220a 2020 2020 2020  ssage-IM".      
-0000b4b0: 2020 6e6f 7469 6679 322e 696e 6974 2850    notify2.init(P
-0000b4c0: 524f 475f 5749 5448 4f55 545f 4558 5429  ROG_WITHOUT_EXT)
-0000b4d0: 0a20 2020 2020 2020 206e 6f74 6966 7932  .        notify2
-0000b4e0: 2e4e 6f74 6966 6963 6174 696f 6e28 7469  .Notification(ti
-0000b4f0: 746c 652c 2063 6f6e 7465 6e74 2c20 6176  tle, content, av
-0000b500: 6174 6172 5f66 696c 6529 2e73 686f 7728  atar_file).show(
-0000b510: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
-0000b520: 2e64 6562 7567 2866 2253 686f 7765 6420  .debug(f"Showed 
-0000b530: 6e6f 7469 6669 6361 7469 6f6e 2066 6f72  notification for
-0000b540: 207b 7469 746c 657d 2e22 290a 2020 2020   {title}.").    
-0000b550: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0000b560: 2061 7320 653a 0a20 2020 2020 2020 2067   as e:.        g
-0000b570: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0000b580: 2020 2020 2020 2020 2066 2253 686f 7769           f"Showi
-0000b590: 6e67 206e 6f74 6966 6963 6174 696f 6e20  ng notification 
-0000b5a0: 666f 7220 7b74 6974 6c65 7d20 6661 696c  for {title} fail
-0000b5b0: 6564 2e20 4578 6365 7074 696f 6e3a 207b  ed. Exception: {
-0000b5c0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
-0000b5d0: 6622 5c6e 4865 7265 2069 7320 7468 6520  f"\nHere is the 
-0000b5e0: 7472 6163 6562 6163 6b3a 5c6e 7b74 7261  traceback:\n{tra
-0000b5f0: 6365 6261 636b 2e66 6f72 6d61 745f 6578  ceback.format_ex
-0000b600: 6328 297d 220a 2020 2020 2020 2020 290a  c()}".        ).
-0000b610: 2020 2020 2020 2020 7061 7373 0a0a 0a61          pass...a
-0000b620: 7379 6e63 2064 6566 2067 6574 5f61 7661  sync def get_ava
-0000b630: 7461 725f 7572 6c28 636c 6965 6e74 3a20  tar_url(client: 
-0000b640: 4173 796e 6343 6c69 656e 742c 2075 7365  AsyncClient, use
-0000b650: 725f 6964 3a20 7374 7229 202d 3e20 7374  r_id: str) -> st
-0000b660: 723a 0a20 2020 2022 2222 4765 7420 6874  r:.    """Get ht
-0000b670: 7470 7320 6176 6174 6172 2055 524c 2066  tps avatar URL f
-0000b680: 6f72 2075 7365 7220 7573 6572 5f69 642e  or user user_id.
-0000b690: 0a0a 2020 2020 5265 7475 726e 7320 5552  ..    Returns UR
-0000b6a0: 4c20 6f72 204e 6f6e 6520 6966 2075 7365  L or None if use
-0000b6b0: 7220 6861 7320 6e6f 2061 7661 7461 720a  r has no avatar.
-0000b6c0: 2020 2020 2222 220a 2020 2020 6176 6174      """.    avat
-0000b6d0: 6172 5f75 726c 203d 204e 6f6e 6520 2023  ar_url = None  #
-0000b6e0: 2064 6566 6175 6c74 0a20 2020 2072 6573   default.    res
-0000b6f0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-0000b700: 2e67 6574 5f61 7661 7461 7228 7573 6572  .get_avatar(user
-0000b710: 5f69 6429 0a20 2020 2069 6620 6973 696e  _id).    if isin
-0000b720: 7374 616e 6365 2872 6573 702c 2050 726f  stance(resp, Pro
-0000b730: 6669 6c65 4765 7441 7661 7461 7252 6573  fileGetAvatarRes
-0000b740: 706f 6e73 6529 3a0a 2020 2020 2020 2020  ponse):.        
-0000b750: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0000b760: 2020 2020 2020 2020 2020 2250 726f 6669            "Profi
-0000b770: 6c65 4765 7441 7661 7461 7252 6573 706f  leGetAvatarRespo
-0000b780: 6e73 652e 2052 6573 706f 6e73 6520 6973  nse. Response is
-0000b790: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-0000b7a0: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
-0000b7b0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-0000b7c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000b7d0: 2061 7661 7461 725f 6d78 6320 3d20 7265   avatar_mxc = re
-0000b7e0: 7370 2e61 7661 7461 725f 7572 6c0a 2020  sp.avatar_url.  
-0000b7f0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0000b800: 7567 2866 2261 7661 7461 725f 6d78 6320  ug(f"avatar_mxc 
-0000b810: 6973 207b 6176 6174 6172 5f6d 7863 7d22  is {avatar_mxc}"
-0000b820: 290a 2020 2020 2020 2020 6966 2061 7661  ).        if ava
-0000b830: 7461 725f 6d78 633a 2020 2320 636f 756c  tar_mxc:  # coul
-0000b840: 6420 6265 204e 6f6e 6520 6966 206e 6f20  d be None if no 
-0000b850: 6176 6174 6172 0a20 2020 2020 2020 2020  avatar.         
-0000b860: 2020 2061 7661 7461 725f 7572 6c20 3d20     avatar_url = 
-0000b870: 6177 6169 7420 636c 6965 6e74 2e6d 7863  await client.mxc
-0000b880: 5f74 6f5f 6874 7470 2861 7661 7461 725f  _to_http(avatar_
-0000b890: 6d78 6329 0a20 2020 2065 6c73 653a 0a20  mxc).    else:. 
-0000b8a0: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
-0000b8b0: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-0000b8c0: 6622 4661 696c 6564 2067 6574 7469 6e67  f"Failed getting
-0000b8d0: 2061 7661 7461 7220 6672 6f6d 2073 6572   avatar from ser
-0000b8e0: 7665 722e 207b 7072 6976 6163 795f 6669  ver. {privacy_fi
-0000b8f0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0000b900: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0000b910: 6773 2e6c 6f67 2e64 6562 7567 2866 2261  gs.log.debug(f"a
-0000b920: 7661 7461 725f 7572 6c20 6973 207b 6176  vatar_url is {av
-0000b930: 6174 6172 5f75 726c 7d22 290a 2020 2020  atar_url}").    
-0000b940: 7265 7475 726e 2061 7661 7461 725f 7572  return avatar_ur
-0000b950: 6c0a 0a0a 6465 6620 6372 6561 7465 5f70  l...def create_p
-0000b960: 6964 5f66 696c 6528 2920 2d3e 204e 6f6e  id_file() -> Non
-0000b970: 653a 0a20 2020 2022 2222 5772 6974 6520  e:.    """Write 
-0000b980: 5049 4420 746f 2064 6973 6b2e 0a0a 2020  PID to disk...  
-0000b990: 2020 4966 2070 6f73 7369 626c 6520 6372    If possible cr
-0000b9a0: 6561 7465 2061 2050 4944 2066 696c 652e  eate a PID file.
-0000b9b0: 2054 6869 7320 6973 206e 6f74 2065 7373   This is not ess
-0000b9c0: 656e 7469 616c 2e0a 2020 2020 536f 2c20  ential..    So, 
-0000b9d0: 6966 2069 7420 6661 696c 7320 7468 6572  if it fails ther
-0000b9e0: 6520 6973 206e 6f20 7072 6f62 6c65 6d2e  e is no problem.
-0000b9f0: 2054 6865 2050 4944 2066 696c 6520 6361   The PID file ca
-0000ba00: 6e0a 2020 2020 6265 2068 656c 7066 756c  n.    be helpful
-0000ba10: 2074 6f20 7365 6e64 2061 206b 696c 6c20   to send a kill 
-0000ba20: 7369 676e 616c 206f 7220 7369 6d69 6c61  signal or simila
-0000ba30: 7220 746f 2074 6865 2070 726f 6365 7373  r to the process
-0000ba40: 2e0a 2020 2020 452e 672e 2074 6f20 7374  ..    E.g. to st
-0000ba50: 6f70 206c 6973 7465 6e69 6e67 2e0a 2020  op listening..  
-0000ba60: 2020 4265 6361 7573 6520 7468 6520 7573    Because the us
-0000ba70: 6572 2063 616e 2073 7461 7274 2073 6576  er can start sev
-0000ba80: 6572 616c 2070 726f 6365 7373 6573 2061  eral processes a
-0000ba90: 7420 7468 6520 7361 6d65 2074 696d 652c  t the same time,
-0000baa0: 0a20 2020 206a 7573 7420 6861 7669 6e67  .    just having
-0000bab0: 206f 6e65 2050 4944 2066 696c 6520 6973   one PID file is
-0000bac0: 206e 6f74 2061 6363 6570 7461 626c 6520   not acceptable 
-0000bad0: 6265 6361 7573 6520 6120 6e65 776c 7920  because a newly 
-0000bae0: 7374 6172 7465 640a 2020 2020 7072 6f63  started.    proc
-0000baf0: 6573 7320 776f 756c 6420 6f76 6572 7772  ess would overwr
-0000bb00: 6974 6520 7468 6520 7072 6576 696f 7573  ite the previous
-0000bb10: 2050 4944 2066 696c 652e 2057 6520 7573   PID file. We us
-0000bb20: 6520 5555 4944 7320 746f 206d 616b 650a  e UUIDs to make.
-0000bb30: 2020 2020 6561 6368 2050 4944 2066 696c      each PID fil
-0000bb40: 6520 756e 6971 7565 2e0a 2020 2020 2222  e unique..    ""
-0000bb50: 220a 2020 2020 7472 793a 0a20 2020 2020  ".    try:.     
-0000bb60: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
-0000bb70: 682e 6578 6973 7473 2850 4944 5f44 4952  h.exists(PID_DIR
-0000bb80: 5f44 4546 4155 4c54 293a 0a20 2020 2020  _DEFAULT):.     
-0000bb90: 2020 2020 2020 206f 732e 6d6b 6469 7228         os.mkdir(
-0000bba0: 5049 445f 4449 525f 4445 4641 554c 5429  PID_DIR_DEFAULT)
-0000bbb0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-0000bbc0: 6c6f 672e 6465 6275 6728 6622 4372 6561  log.debug(f"Crea
-0000bbd0: 7465 2064 6972 6563 746f 7279 207b 5049  te directory {PI
-0000bbe0: 445f 4449 525f 4445 4641 554c 547d 2066  D_DIR_DEFAULT} f
-0000bbf0: 6f72 2050 4944 2066 696c 652e 2229 0a20  or PID file."). 
-0000bc00: 2020 2020 2020 2070 6964 203d 206f 732e         pid = os.
-0000bc10: 6765 7470 6964 2829 0a20 2020 2020 2020  getpid().       
-0000bc20: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-0000bc30: 5472 7969 6e67 2074 6f20 6372 6561 7465  Trying to create
-0000bc40: 2061 2050 4944 2066 696c 6520 746f 2073   a PID file to s
-0000bc50: 746f 7265 2070 726f 6365 7373 2069 6420  tore process id 
-0000bc60: 7b70 6964 7d2e 2229 0a20 2020 2020 2020  {pid}.").       
-0000bc70: 2077 6974 6820 6f70 656e 2850 4944 5f46   with open(PID_F
-0000bc80: 494c 455f 4445 4641 554c 542c 2022 7722  ILE_DEFAULT, "w"
-0000bc90: 2920 6173 2066 3a20 2023 206f 7665 7277  ) as f:  # overw
-0000bca0: 7269 7465 0a20 2020 2020 2020 2020 2020  rite.           
-0000bcb0: 2066 2e77 7269 7465 2873 7472 2870 6964   f.write(str(pid
-0000bcc0: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
-0000bcd0: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
-0000bce0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-0000bcf0: 2020 2020 2020 2020 2020 2066 2753 7563             f'Suc
-0000bd00: 6365 7373 6675 6c6c 7920 6372 6561 7465  cessfully create
-0000bd10: 6420 5049 4420 6669 6c65 2022 7b50 4944  d PID file "{PID
-0000bd20: 5f46 494c 455f 4445 4641 554c 547d 2220  _FILE_DEFAULT}" 
-0000bd30: 270a 2020 2020 2020 2020 2020 2020 6622  '.            f"
-0000bd40: 746f 2073 746f 7265 2070 726f 6365 7373  to store process
-0000bd50: 2069 6420 7b70 6964 7d2e 220a 2020 2020   id {pid}.".    
-0000bd60: 2020 2020 290a 2020 2020 6578 6365 7074      ).    except
-0000bd70: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-0000bd80: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0000bd90: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-0000bda0: 4661 696c 6564 2074 6f20 6372 6561 7465  Failed to create
-0000bdb0: 2050 4944 2066 696c 6520 227b 5049 445f   PID file "{PID_
-0000bdc0: 4649 4c45 5f44 4546 4155 4c54 7d22 2027  FILE_DEFAULT}" '
-0000bdd0: 0a20 2020 2020 2020 2020 2020 2066 2274  .            f"t
-0000bde0: 6f20 7374 6f72 6520 7072 6f63 6573 7320  o store process 
-0000bdf0: 6964 207b 6f73 2e67 6574 7069 6428 297d  id {os.getpid()}
-0000be00: 2e22 0a20 2020 2020 2020 2029 0a0a 0a64  .".        )...d
-0000be10: 6566 2064 656c 6574 655f 7069 645f 6669  ef delete_pid_fi
-0000be20: 6c65 2829 202d 3e20 4e6f 6e65 3a0a 2020  le() -> None:.  
-0000be30: 2020 2222 2252 656d 6f76 6520 5049 4420    """Remove PID 
-0000be40: 6669 6c65 2066 726f 6d20 6469 736b 2e0a  file from disk..
-0000be50: 0a20 2020 2043 6c65 616e 2075 7020 6279  .    Clean up by
-0000be60: 2072 656d 6f76 696e 6720 5049 4420 6669   removing PID fi
-0000be70: 6c65 2e0a 2020 2020 4974 206d 6967 6874  le..    It might
-0000be80: 206e 6f74 2065 7869 7374 2e20 536f 2c20   not exist. So, 
-0000be90: 6967 6e6f 7265 2066 6169 6c75 7265 732e  ignore failures.
-0000bea0: 0a20 2020 2022 2222 0a20 2020 2074 7279  .    """.    try
-0000beb0: 3a0a 2020 2020 2020 2020 6f73 2e72 656d  :.        os.rem
-0000bec0: 6f76 6528 5049 445f 4649 4c45 5f44 4546  ove(PID_FILE_DEF
-0000bed0: 4155 4c54 290a 2020 2020 6578 6365 7074  AULT).    except
-0000bee0: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-0000bef0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-0000bf00: 2866 2746 6169 6c65 6420 746f 2072 656d  (f'Failed to rem
-0000bf10: 6f76 6520 5049 4420 6669 6c65 2022 7b50  ove PID file "{P
-0000bf20: 4944 5f46 494c 455f 4445 4641 554c 547d  ID_FILE_DEFAULT}
-0000bf30: 222e 2729 0a0a 0a64 6566 2063 6c65 616e  ".')...def clean
-0000bf40: 7570 2829 202d 3e20 4e6f 6e65 3a0a 2020  up() -> None:.  
-0000bf50: 2020 2222 2243 6c65 616e 7570 2062 6566    """Cleanup bef
-0000bf60: 6f72 6520 7175 6974 696e 6720 7072 6f67  ore quiting prog
-0000bf70: 7261 6d2e 2222 220a 2020 2020 6773 2e6c  ram.""".    gs.l
-0000bf80: 6f67 2e64 6562 7567 2822 436c 6561 6e75  og.debug("Cleanu
-0000bf90: 703a 2063 6c65 616e 696e 6720 7570 2e22  p: cleaning up."
-0000bfa0: 290a 2020 2020 6465 6c65 7465 5f70 6964  ).    delete_pid
-0000bfb0: 5f66 696c 6528 290a 0a0a 6465 6620 6372  _file()...def cr
-0000bfc0: 6564 656e 7469 616c 735f 6578 6973 7428  edentials_exist(
-0000bfd0: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
-0000bfe0: 5f70 6174 683a 204f 7074 696f 6e61 6c5b  _path: Optional[
-0000bff0: 7374 725d 203d 204e 6f6e 6529 202d 3e20  str] = None) -> 
-0000c000: 626f 6f6c 3a0a 2020 2020 2222 2244 6574  bool:.    """Det
-0000c010: 6572 6d69 6e65 2069 6620 6372 6564 656e  ermine if creden
-0000c020: 7469 616c 7320 6669 6c65 2061 6c72 6561  tials file alrea
-0000c030: 6479 2065 7869 7374 732e 2222 220a 2020  dy exists.""".  
-0000c040: 2020 6966 206e 6f74 2063 7265 6465 6e74    if not credent
-0000c050: 6961 6c73 5f66 696c 655f 7061 7468 3a0a  ials_file_path:.
-0000c060: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
-0000c070: 616c 735f 6669 6c65 5f70 6174 6820 3d20  als_file_path = 
-0000c080: 6465 7465 726d 696e 655f 6372 6564 656e  determine_creden
-0000c090: 7469 616c 735f 6669 6c65 2829 0a20 2020  tials_file().   
-0000c0a0: 2072 6574 7572 6e20 6f73 2e70 6174 682e   return os.path.
-0000c0b0: 6578 6973 7473 2863 7265 6465 6e74 6961  exists(credentia
-0000c0c0: 6c73 5f66 696c 655f 7061 7468 290a 0a0a  ls_file_path)...
-0000c0d0: 6465 6620 7374 6f72 655f 6578 6973 7473  def store_exists
-0000c0e0: 2873 746f 7265 5f64 6972 5f70 6174 683a  (store_dir_path:
-0000c0f0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-0000c100: 204e 6f6e 6529 202d 3e20 626f 6f6c 3a0a   None) -> bool:.
-0000c110: 2020 2020 2222 2244 6574 6572 6d69 6e65      """Determine
-0000c120: 2069 6620 7374 6f72 6520 6469 7220 616c   if store dir al
-0000c130: 7265 6164 7920 6578 6973 7473 2e22 2222  ready exists."""
-0000c140: 0a20 2020 2069 6620 6e6f 7420 7374 6f72  .    if not stor
-0000c150: 655f 6469 725f 7061 7468 3a0a 2020 2020  e_dir_path:.    
-0000c160: 2020 2020 7374 6f72 655f 6469 725f 7061      store_dir_pa
-0000c170: 7468 203d 2064 6574 6572 6d69 6e65 5f73  th = determine_s
-0000c180: 746f 7265 5f64 6972 2829 0a20 2020 2072  tore_dir().    r
-0000c190: 6574 7572 6e20 6f73 2e70 6174 682e 6973  eturn os.path.is
-0000c1a0: 6469 7228 7374 6f72 655f 6469 725f 7061  dir(store_dir_pa
-0000c1b0: 7468 290a 0a0a 6465 6620 7374 6f72 655f  th)...def store_
-0000c1c0: 6372 6561 7465 2873 746f 7265 5f64 6972  create(store_dir
-0000c1d0: 5f70 6174 683a 204f 7074 696f 6e61 6c5b  _path: Optional[
-0000c1e0: 7374 725d 203d 204e 6f6e 6529 202d 3e20  str] = None) -> 
-0000c1f0: 4e6f 6e65 3a0a 2020 2020 2222 2243 7265  None:.    """Cre
-0000c200: 6174 6520 7374 6f72 6520 6469 722e 2222  ate store dir.""
-0000c210: 220a 2020 2020 6966 206e 6f74 2073 746f  ".    if not sto
-0000c220: 7265 5f64 6972 5f70 6174 683a 0a20 2020  re_dir_path:.   
-0000c230: 2020 2020 2073 746f 7265 5f64 6972 5f70       store_dir_p
-0000c240: 6174 6820 3d20 6465 7465 726d 696e 655f  ath = determine_
-0000c250: 7374 6f72 655f 6469 7228 290a 2020 2020  store_dir().    
-0000c260: 6f73 2e6d 616b 6564 6972 7328 7374 6f72  os.makedirs(stor
-0000c270: 655f 6469 725f 7061 7468 290a 2020 2020  e_dir_path).    
-0000c280: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
-0000c290: 2020 2020 2066 2254 6865 2070 6572 7369       f"The persi
-0000c2a0: 7374 656e 7420 7374 6f72 6167 6520 6469  stent storage di
-0000c2b0: 7265 6374 6f72 7920 7b73 746f 7265 5f64  rectory {store_d
-0000c2c0: 6972 5f70 6174 687d 2022 0a20 2020 2020  ir_path} ".     
-0000c2d0: 2020 2022 7761 7320 6372 6561 7465 6420     "was created 
-0000c2e0: 666f 7220 796f 752e 220a 2020 2020 290a  for you.".    ).
-0000c2f0: 0a0a 6465 6620 7374 6f72 655f 6465 6c65  ..def store_dele
-0000c300: 7465 2873 746f 7265 5f64 6972 5f70 6174  te(store_dir_pat
-0000c310: 683a 204f 7074 696f 6e61 6c5b 7374 725d  h: Optional[str]
-0000c320: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
-0000c330: 3a0a 2020 2020 2222 2244 656c 6574 6520  :.    """Delete 
-0000c340: 7374 6f72 6520 6469 722e 2222 220a 2020  store dir.""".  
-0000c350: 2020 6966 206e 6f74 2073 746f 7265 5f64    if not store_d
-0000c360: 6972 5f70 6174 683a 0a20 2020 2020 2020  ir_path:.       
-0000c370: 2073 746f 7265 5f64 6972 5f70 6174 6820   store_dir_path 
-0000c380: 3d20 6465 7465 726d 696e 655f 7374 6f72  = determine_stor
-0000c390: 655f 6469 7228 290a 2020 2020 6f73 2e72  e_dir().    os.r
-0000c3a0: 6d64 6972 2873 746f 7265 5f64 6972 5f70  mdir(store_dir_p
-0000c3b0: 6174 6829 0a20 2020 2067 732e 6c6f 672e  ath).    gs.log.
-0000c3c0: 696e 666f 280a 2020 2020 2020 2020 6622  info(.        f"
-0000c3d0: 5468 6520 7065 7273 6973 7465 6e74 2073  The persistent s
-0000c3e0: 746f 7261 6765 2064 6972 6563 746f 7279  torage directory
-0000c3f0: 207b 7374 6f72 655f 6469 725f 7061 7468   {store_dir_path
-0000c400: 7d20 220a 2020 2020 2020 2020 2277 6173  } ".        "was
-0000c410: 2064 656c 6574 6564 2066 6f72 2079 6f75   deleted for you
-0000c420: 2e22 0a20 2020 2029 0a0a 0a64 6566 2077  .".    )...def w
-0000c430: 7269 7465 5f63 7265 6465 6e74 6961 6c73  rite_credentials
-0000c440: 5f74 6f5f 6469 736b 280a 2020 2020 686f  _to_disk(.    ho
-0000c450: 6d65 7365 7276 6572 2c20 7573 6572 5f69  meserver, user_i
-0000c460: 642c 2064 6576 6963 655f 6964 2c20 6163  d, device_id, ac
-0000c470: 6365 7373 5f74 6f6b 656e 2c20 726f 6f6d  cess_token, room
-0000c480: 5f69 642c 2063 7265 6465 6e74 6961 6c73  _id, credentials
-0000c490: 5f66 696c 650a 2920 2d3e 204e 6f6e 653a  _file.) -> None:
-0000c4a0: 0a20 2020 2022 2222 5772 6974 6520 7468  .    """Write th
-0000c4b0: 6520 7265 7175 6972 6564 206c 6f67 696e  e required login
-0000c4c0: 2064 6574 6169 6c73 2074 6f20 6469 736b   details to disk
-0000c4d0: 2e0a 0a20 2020 2054 6869 7320 6669 6c65  ...    This file
-0000c4e0: 2063 616e 206c 6174 6572 2062 6520 7573   can later be us
-0000c4f0: 6564 2066 6f72 206c 6f67 6769 6e67 2069  ed for logging i
-0000c500: 6e0a 2020 2020 7769 7468 6f75 7420 7573  n.    without us
-0000c510: 696e 6720 6120 7061 7373 776f 7264 2e0a  ing a password..
-0000c520: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
-0000c530: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
-0000c540: 2020 2020 2020 686f 6d65 7365 7276 6572        homeserver
-0000c550: 203a 2073 7472 0a20 2020 2020 2020 2020   : str.         
-0000c560: 2020 2055 524c 206f 6620 686f 6d65 7365     URL of homese
-0000c570: 7276 6572 2c20 652e 672e 2022 6874 7470  rver, e.g. "http
-0000c580: 733a 2f2f 6d61 7472 6978 2e65 7861 6d70  s://matrix.examp
-0000c590: 6c65 2e6f 7267 220a 2020 2020 2020 2020  le.org".        
-0000c5a0: 7573 6572 5f69 6420 3a20 7374 720a 2020  user_id : str.  
-0000c5b0: 2020 2020 2020 2020 2020 6675 6c6c 2075            full u
-0000c5c0: 7365 7220 6964 2c20 652e 672e 2022 4075  ser id, e.g. "@u
-0000c5d0: 7365 723a 6578 616d 706c 652e 6f72 6722  ser:example.org"
-0000c5e0: 0a20 2020 2020 2020 2064 6576 6963 655f  .        device_
-0000c5f0: 6964 203a 2073 7472 0a20 2020 2020 2020  id : str.       
-0000c600: 2020 2020 2064 6576 6963 6520 6964 2c20       device id, 
-0000c610: 3130 2075 7070 6572 6361 7365 206c 6574  10 uppercase let
-0000c620: 7465 7273 0a20 2020 2020 2020 2061 6363  ters.        acc
-0000c630: 6573 735f 746f 6b65 6e20 3a20 7374 720a  ess_token : str.
-0000c640: 2020 2020 2020 2020 2020 2020 6163 6365              acce
-0000c650: 7373 2074 6f6b 656e 2c20 6c6f 6e67 2063  ss token, long c
-0000c660: 7279 7074 6f67 7261 7068 6963 2061 6363  ryptographic acc
-0000c670: 6573 7320 746f 6b65 6e0a 2020 2020 2020  ess token.      
-0000c680: 2020 726f 6f6d 5f69 6420 3a20 7374 720a    room_id : str.
-0000c690: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000c6a0: 206f 6620 726f 6f6d 2077 6865 7265 206d   of room where m
-0000c6b0: 6573 7361 6765 2077 696c 6c20 6265 2073  essage will be s
-0000c6c0: 656e 7420 746f 2c0a 2020 2020 2020 2020  ent to,.        
-0000c6d0: 2020 2020 652e 672e 2022 2153 6f6d 6552      e.g. "!SomeR
-0000c6e0: 6f6f 6d49 6453 7472 696e 673a 6578 616d  oomIdString:exam
-0000c6f0: 706c 652e 6f72 6722 0a20 2020 2020 2020  ple.org".       
-0000c700: 2020 2020 2075 7365 7220 6d75 7374 2062       user must b
-0000c710: 6520 6d65 6d62 6572 206f 6620 7468 6520  e member of the 
-0000c720: 7072 6f76 6964 6564 2072 6f6f 6d0a 2020  provided room.  
-0000c730: 2020 2020 2020 6372 6564 656e 7469 616c        credential
-0000c740: 735f 6669 6c65 203a 2073 7472 0a20 2020  s_file : str.   
-0000c750: 2020 2020 2020 2020 206e 616d 652f 7061           name/pa
-0000c760: 7468 206f 6620 6669 6c65 2077 6865 7265  th of file where
-0000c770: 2074 6f20 7374 6f72 650a 2020 2020 2020   to store.      
-0000c780: 2020 2020 2020 6372 6564 656e 7469 616c        credential
-0000c790: 7320 696e 666f 726d 6174 696f 6e0a 0a20  s information.. 
-0000c7a0: 2020 2022 2222 0a20 2020 2023 206f 7065     """.    # ope
-0000c7b0: 6e20 7468 6520 6372 6564 656e 7469 616c  n the credential
-0000c7c0: 7320 6669 6c65 2069 6e20 7772 6974 652d  s file in write-
-0000c7d0: 6d6f 6465 0a20 2020 2077 6974 6820 6f70  mode.    with op
-0000c7e0: 656e 2863 7265 6465 6e74 6961 6c73 5f66  en(credentials_f
-0000c7f0: 696c 652c 2022 7722 2920 6173 2066 3a0a  ile, "w") as f:.
-0000c800: 2020 2020 2020 2020 2320 7772 6974 6520          # write 
-0000c810: 7468 6520 6c6f 6769 6e20 6465 7461 696c  the login detail
-0000c820: 7320 746f 2064 6973 6b0a 2020 2020 2020  s to disk.      
-0000c830: 2020 6a73 6f6e 2e64 756d 7028 0a20 2020    json.dump(.   
-0000c840: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0000c850: 2020 2020 2020 2020 2020 2023 2065 2e67             # e.g
-0000c860: 2e20 2268 7474 7073 3a2f 2f6d 6174 7269  . "https://matri
-0000c870: 782e 6578 616d 706c 652e 6f72 6722 0a20  x.example.org". 
-0000c880: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000c890: 686f 6d65 7365 7276 6572 223a 2068 6f6d  homeserver": hom
-0000c8a0: 6573 6572 7665 722c 0a20 2020 2020 2020  eserver,.       
-0000c8b0: 2020 2020 2020 2020 2023 2064 6576 6963           # devic
-0000c8c0: 6520 4944 2c20 3130 2075 7070 6572 6361  e ID, 10 upperca
-0000c8d0: 7365 206c 6574 7465 7273 0a20 2020 2020  se letters.     
-0000c8e0: 2020 2020 2020 2020 2020 2022 6465 7669             "devi
-0000c8f0: 6365 5f69 6422 3a20 6465 7669 6365 5f69  ce_id": device_i
-0000c900: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0000c910: 2020 2023 2065 2e67 2e20 2240 7573 6572     # e.g. "@user
-0000c920: 3a65 7861 6d70 6c65 2e6f 7267 220a 2020  :example.org".  
-0000c930: 2020 2020 2020 2020 2020 2020 2020 2275                "u
-0000c940: 7365 725f 6964 223a 2075 7365 725f 6964  ser_id": user_id
-0000c950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c960: 2020 2320 652e 672e 2022 2153 6f6d 6552    # e.g. "!SomeR
-0000c970: 6f6f 6d49 6453 7472 696e 673a 6578 616d  oomIdString:exam
-0000c980: 706c 652e 6f72 6722 0a20 2020 2020 2020  ple.org".       
-0000c990: 2020 2020 2020 2020 2022 726f 6f6d 5f69           "room_i
-0000c9a0: 6422 3a20 726f 6f6d 5f69 642c 0a20 2020  d": room_id,.   
-0000c9b0: 2020 2020 2020 2020 2020 2020 2023 206c               # l
-0000c9c0: 6f6e 6720 6372 7970 746f 6772 6170 6869  ong cryptographi
-0000c9d0: 6320 6163 6365 7373 2074 6f6b 656e 0a20  c access token. 
-0000c9e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000c9f0: 6163 6365 7373 5f74 6f6b 656e 223a 2061  access_token": a
-0000ca00: 6363 6573 735f 746f 6b65 6e2c 0a20 2020  ccess_token,.   
-0000ca10: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-0000ca20: 2020 2020 2020 2020 662c 0a20 2020 2020          f,.     
-0000ca30: 2020 2029 0a0a 0a64 6566 2072 6561 645f     )...def read_
-0000ca40: 6372 6564 656e 7469 616c 735f 6672 6f6d  credentials_from
-0000ca50: 5f64 6973 6b28 6372 6564 656e 7469 616c  _disk(credential
-0000ca60: 735f 6669 6c65 2920 2d3e 2064 6963 743a  s_file) -> dict:
-0000ca70: 0a20 2020 2022 2222 5265 6164 2074 6865  .    """Read the
-0000ca80: 2072 6571 7569 7265 6420 6c6f 6769 6e20   required login 
-0000ca90: 6465 7461 696c 7320 6672 6f6d 2064 6973  details from dis
-0000caa0: 6b2e 0a0a 2020 2020 4974 2063 616e 2074  k...    It can t
-0000cab0: 6865 6e20 6265 2075 7365 6420 746f 206c  hen be used to l
-0000cac0: 6f67 2069 6e20 7769 7468 6f75 7420 7573  og in without us
-0000cad0: 696e 6720 6120 7061 7373 776f 7264 2e0a  ing a password..
-0000cae0: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
-0000caf0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
-0000cb00: 2020 6372 6564 656e 7469 616c 735f 6669    credentials_fi
-0000cb10: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
-0000cb20: 206e 616d 652f 7061 7468 206f 6620 6669   name/path of fi
-0000cb30: 6c65 2074 6f20 7265 6164 2063 7265 6465  le to read crede
-0000cb40: 6e74 6961 6c73 2069 6e66 6f72 6d61 7469  ntials informati
-0000cb50: 6f6e 2066 726f 6d0a 0a20 2020 2022 2222  on from..    """
-0000cb60: 0a20 2020 2023 206f 7065 6e20 7468 6520  .    # open the 
-0000cb70: 6669 6c65 2069 6e20 7265 6164 2d6f 6e6c  file in read-onl
-0000cb80: 7920 6d6f 6465 0a20 2020 2067 732e 6c6f  y mode.    gs.lo
-0000cb90: 672e 6465 6275 6728 2253 7461 7274 696e  g.debug("Startin
-0000cba0: 6720 746f 2072 6561 6420 6372 6564 656e  g to read creden
-0000cbb0: 7469 616c 7320 6669 6c65 2e22 290a 2020  tials file.").  
-0000cbc0: 2020 7769 7468 206f 7065 6e28 6372 6564    with open(cred
-0000cbd0: 656e 7469 616c 735f 6669 6c65 2c20 2272  entials_file, "r
-0000cbe0: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
-0000cbf0: 2063 6469 6374 203d 206a 736f 6e2e 6c6f   cdict = json.lo
-0000cc00: 6164 2866 290a 2020 2020 6773 2e6c 6f67  ad(f).    gs.log
-0000cc10: 2e64 6562 7567 2822 4669 6e69 7368 6564  .debug("Finished
-0000cc20: 2072 6561 6469 6e67 2063 7265 6465 6e74   reading credent
-0000cc30: 6961 6c73 2066 696c 652e 2229 0a20 2020  ials file.").   
-0000cc40: 2072 6574 7572 6e20 6364 6963 740a 0a0a   return cdict...
-0000cc50: 6465 6620 6465 7465 726d 696e 655f 6372  def determine_cr
-0000cc60: 6564 656e 7469 616c 735f 6669 6c65 2829  edentials_file()
-0000cc70: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
-0000cc80: 4465 7465 726d 696e 6520 7468 6520 7472  Determine the tr
-0000cc90: 7565 2066 696c 656e 616d 6520 6f66 2063  ue filename of c
-0000cca0: 7265 6465 6e74 6961 6c73 2066 696c 652e  redentials file.
-0000ccb0: 0a0a 2020 2020 5265 7475 726e 7320 6669  ..    Returns fi
-0000ccc0: 6c65 6e61 6d65 2077 6974 6820 6675 6c6c  lename with full
-0000ccd0: 2070 6174 6820 6f72 204e 6f6e 652e 0a0a   path or None...
-0000cce0: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
-0000ccf0: 6e20 6368 6563 6b73 2069 6620 6120 6372  n checks if a cr
-0000cd00: 6564 656e 7469 616c 7320 6669 6c65 2065  edentials file e
-0000cd10: 7869 7374 732e 2049 6620 6e6f 2c20 6974  xists. If no, it
-0000cd20: 2077 696c 6c20 6173 6b0a 2020 2020 7573   will ask.    us
-0000cd30: 6572 2071 7565 7374 696f 6e73 2072 6567  er questions reg
-0000cd40: 7261 6469 6e67 206c 6f67 696e 2c20 7374  rading login, st
-0000cd50: 6f72 6520 7468 6520 696e 666f 2069 6e20  ore the info in 
-0000cd60: 6120 6e65 776c 7920 6372 6561 7465 640a  a newly created.
-0000cd70: 2020 2020 6372 6564 656e 7469 616c 7320      credentials 
-0000cd80: 6669 6c65 2061 6e64 2065 7869 742e 0a0a  file and exit...
-0000cd90: 2020 2020 4966 2061 2063 7265 6465 6e74      If a credent
-0000cda0: 6961 6c73 2066 696c 6520 6578 6973 7473  ials file exists
-0000cdb0: 2c20 6974 2077 696c 6c20 7265 6164 2069  , it will read i
-0000cdc0: 742c 206c 6f67 2069 6e74 6f20 4d61 7472  t, log into Matr
-0000cdd0: 6978 2c0a 2020 2020 7365 6e64 2061 206d  ix,.    send a m
-0000cde0: 6573 7361 6765 2061 6e64 2065 7869 742e  essage and exit.
-0000cdf0: 0a0a 2020 2020 5468 6520 6372 6564 656e  ..    The creden
-0000ce00: 7469 616c 2066 696c 6520 7769 6c6c 2062  tial file will b
-0000ce10: 6520 6c6f 6f6b 6564 2066 6f72 2074 6865  e looked for the
-0000ce20: 2066 6f6c 6c6f 7769 6e67 2077 6179 3a0a   following way:.
-0000ce30: 2020 2020 6129 2069 6620 6120 7061 7468      a) if a path
-0000ce40: 2028 652e 672e 2022 2e2e 2f63 7265 642e   (e.g. "../cred.
-0000ce50: 6a73 6f6e 2229 2069 7320 7370 6563 6966  json") is specif
-0000ce60: 6965 6420 7769 7468 202d 7420 6974 2077  ied with -t it w
-0000ce70: 696c 6c20 6265 206c 6f6f 6b65 640a 2020  ill be looked.  
-0000ce80: 2020 2020 2066 6f72 2074 6865 7265 2e20       for there. 
-0000ce90: 456e 6420 6f66 2073 6561 7263 682e 0a20  End of search.. 
-0000cea0: 2020 2062 2920 6966 206f 6e6c 7920 6120     b) if only a 
-0000ceb0: 6669 6c65 6e61 6d65 2077 6974 686f 7574  filename without
-0000cec0: 2070 6174 6820 2865 2e67 2e20 2263 7265   path (e.g. "cre
-0000ced0: 642e 6a73 6f6e 2229 2069 7320 7370 6563  d.json") is spec
-0000cee0: 6966 6965 640a 2020 2020 2020 2066 6972  ified.       fir
-0000cef0: 7374 206c 6f6f 6b20 696e 2074 6865 2063  st look in the c
-0000cf00: 7572 7265 6e74 206c 6f63 616c 2064 6972  urrent local dir
-0000cf10: 6563 746f 7279 2c20 6966 2066 6f75 6e64  ectory, if found
-0000cf20: 2075 7365 2069 740a 2020 2020 6329 2069   use it.    c) i
-0000cf30: 6620 6f6e 6c79 2061 2066 696c 656e 616d  f only a filenam
-0000cf40: 6520 7769 7468 6f75 7420 7061 7468 2028  e without path (
-0000cf50: 652e 672e 2022 6372 6564 2e6a 736f 6e22  e.g. "cred.json"
-0000cf60: 2920 6973 2073 7065 6369 6669 6564 0a20  ) is specified. 
-0000cf70: 2020 2020 2020 616e 6420 6974 2063 616e        and it can
-0000cf80: 6e6f 7420 6265 2066 6f75 6e64 2069 6e20  not be found in 
-0000cf90: 7468 6520 6375 7272 656e 7420 6c6f 6361  the current loca
-0000cfa0: 6c20 6469 7265 6374 6f72 792c 2074 6865  l directory, the
-0000cfb0: 6e0a 2020 2020 2020 206c 6f6f 6b20 666f  n.       look fo
-0000cfc0: 7220 6974 2069 6e20 6469 7265 6374 6f72  r it in director
-0000cfd0: 7920 2448 4f4d 452f 2e63 6f6e 6669 672f  y $HOME/.config/
-0000cfe0: 6d61 7472 6978 2d63 6f6d 6d61 6e64 6572  matrix-commander
-0000cff0: 2f0a 2020 2020 544c 4452 3a20 6f6e 2066  /.    TLDR: on f
-0000d000: 6972 7374 2072 756e 2069 7420 7769 6c6c  irst run it will
-0000d010: 2062 6520 7772 6974 7465 6e20 746f 2063   be written to c
-0000d020: 7572 7265 6e74 206c 6f63 616c 2064 6972  urrent local dir
-0000d030: 6563 746f 7279 0a20 2020 2020 2020 6f72  ectory.       or
-0000d040: 2074 6f20 7061 7468 2073 7065 6369 6669   to path specifi
-0000d050: 6564 2077 6974 6820 2d2d 6372 6564 656e  ed with --creden
-0000d060: 7469 616c 7320 636f 6d6d 616e 6420 6c69  tials command li
-0000d070: 6e65 2061 7267 756d 656e 742e 0a20 2020  ne argument..   
-0000d080: 2020 2020 4f6e 2066 7572 7468 6572 2072      On further r
-0000d090: 6561 6473 2c20 7072 6f67 7261 6d20 7769  eads, program wi
-0000d0a0: 6c6c 206c 6f6f 6b20 696e 2063 7572 7265  ll look in curre
-0000d0b0: 6e74 6c79 206c 6f63 616c 2064 6972 6563  ntly local direc
-0000d0c0: 746f 7279 0a20 2020 2020 2020 6f72 2069  tory.       or i
-0000d0d0: 6e20 7061 7468 2073 7065 6369 6669 6564  n path specified
-0000d0e0: 2077 6974 6820 2d2d 6372 6564 656e 7469   with --credenti
-0000d0f0: 616c 7320 636f 6d6d 616e 6420 6c69 6e65  als command line
-0000d100: 2061 7267 756d 656e 742e 0a20 2020 2020   argument..     
-0000d110: 2020 4966 206e 6f74 2066 6f75 6e64 2074    If not found t
-0000d120: 6865 7265 2028 616e 6420 6f6e 6c79 2066  here (and only f
-0000d130: 696c 656e 616d 6520 7769 7468 6f75 7420  ilename without 
-0000d140: 7061 7468 2067 6976 656e 292c 0a20 2020  path given),.   
-0000d150: 2020 2020 6173 2061 2073 6563 6f6e 6461      as a seconda
-0000d160: 7279 2063 686f 6963 6520 7072 6f67 7261  ry choice progra
-0000d170: 6d20 7769 6c6c 206c 6f6f 6b20 666f 7220  m will look for 
-0000d180: 6974 2069 6e0a 2020 2020 2020 2064 6972  it in.       dir
-0000d190: 6563 746f 7279 2024 484f 4d45 2f2e 636f  ectory $HOME/.co
-0000d1a0: 6e66 6967 2f6d 6174 7269 782d 636f 6d6d  nfig/matrix-comm
-0000d1b0: 616e 6465 722f 0a0a 2020 2020 2222 220a  ander/..    """.
-0000d1c0: 2020 2020 6372 6564 656e 7469 616c 735f      credentials_
-0000d1d0: 6669 6c65 203d 2067 732e 7061 2e63 7265  file = gs.pa.cre
-0000d1e0: 6465 6e74 6961 6c73 2020 2320 6465 6661  dentials  # defa
-0000d1f0: 756c 7420 6c6f 6361 7469 6f6e 0a20 2020  ult location.   
-0000d200: 2069 6620 286e 6f74 206f 732e 7061 7468   if (not os.path
-0000d210: 2e69 7366 696c 6528 6773 2e70 612e 6372  .isfile(gs.pa.cr
-0000d220: 6564 656e 7469 616c 7329 2920 616e 6420  edentials)) and 
-0000d230: 280a 2020 2020 2020 2020 6773 2e70 612e  (.        gs.pa.
-0000d240: 6372 6564 656e 7469 616c 7320 3d3d 206f  credentials == o
-0000d250: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-0000d260: 6773 2e70 612e 6372 6564 656e 7469 616c  gs.pa.credential
-0000d270: 7329 0a20 2020 2029 3a0a 2020 2020 2020  s).    ):.      
-0000d280: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-0000d290: 2020 2020 2020 2020 2020 2020 2243 7265              "Cre
-0000d2a0: 6465 6e74 6961 6c73 2066 696c 6520 646f  dentials file do
-0000d2b0: 6573 206e 6f74 2065 7869 7374 206c 6f63  es not exist loc
-0000d2c0: 616c 6c79 2e20 220a 2020 2020 2020 2020  ally. ".        
-0000d2d0: 2020 2020 2246 696c 6520 6e61 6d65 2068      "File name h
-0000d2e0: 6173 206e 6f20 7061 7468 2e22 0a20 2020  as no path.".   
-0000d2f0: 2020 2020 2029 0a20 2020 2020 2020 2063       ).        c
-0000d300: 7265 6465 6e74 6961 6c73 5f66 696c 6520  redentials_file 
-0000d310: 3d20 4352 4544 454e 5449 414c 535f 4449  = CREDENTIALS_DI
-0000d320: 525f 4c41 5354 5245 534f 5254 202b 2022  R_LASTRESORT + "
-0000d330: 2f22 202b 2067 732e 7061 2e63 7265 6465  /" + gs.pa.crede
-0000d340: 6e74 6961 6c73 0a20 2020 2020 2020 2067  ntials.        g
-0000d350: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0000d360: 2020 2020 2020 2020 2066 2754 7279 696e           f'Tryin
-0000d370: 6720 7061 7468 2022 7b63 7265 6465 6e74  g path "{credent
-0000d380: 6961 6c73 5f66 696c 657d 2220 6173 206c  ials_file}" as l
-0000d390: 6173 7420 7265 736f 7274 2e20 270a 2020  ast resort. '.  
-0000d3a0: 2020 2020 2020 2020 2020 2253 7567 6765            "Sugge
-0000d3b0: 7374 696e 6720 746f 206c 6f6f 6b20 666f  sting to look fo
-0000d3c0: 7220 6974 2074 6865 7265 2e22 0a20 2020  r it there.".   
-0000d3d0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-0000d3e0: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
-0000d3f0: 2863 7265 6465 6e74 6961 6c73 5f66 696c  (credentials_fil
-0000d400: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0000d410: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0000d420: 2020 2020 2020 2020 2020 2020 2020 2257                "W
-0000d430: 6520 666f 756e 6420 7468 6520 6669 6c65  e found the file
-0000d440: 2e20 4974 2065 7869 7374 7320 696e 2074  . It exists in t
-0000d450: 6865 206c 6173 7420 7265 736f 7274 2022  he last resort "
-0000d460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d470: 2066 2764 6972 6563 746f 7279 2022 7b63   f'directory "{c
-0000d480: 7265 6465 6e74 6961 6c73 5f66 696c 657d  redentials_file}
-0000d490: 222e 2027 0a20 2020 2020 2020 2020 2020  ". '.           
-0000d4a0: 2020 2020 2022 5375 6767 6573 7469 6e67       "Suggesting
-0000d4b0: 2074 6f20 7573 6520 7468 6973 206f 6e65   to use this one
-0000d4c0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-0000d4d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000d4e0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-0000d4f0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-0000d500: 2020 2020 2020 2020 2022 4669 6c65 2064           "File d
-0000d510: 6f65 7320 6e6f 7420 6578 6973 7473 2065  oes not exists e
-0000d520: 6974 6865 7220 696e 2074 6865 206c 6173  ither in the las
-0000d530: 7420 7265 736f 7274 2022 0a20 2020 2020  t resort ".     
-0000d540: 2020 2020 2020 2020 2020 2022 6469 7265             "dire
-0000d550: 6374 6f72 7920 6f72 2074 6865 206c 6f63  ctory or the loc
-0000d560: 616c 2064 6972 6563 746f 7279 2e20 220a  al directory. ".
-0000d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d580: 2246 696c 6520 6e6f 7420 666f 756e 6420  "File not found 
-0000d590: 616e 7977 6865 7265 2e20 4f6e 6520 7769  anywhere. One wi
-0000d5a0: 6c6c 2068 6176 6520 746f 2062 6520 220a  ll have to be ".
-0000d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5c0: 2263 7265 6174 6564 2e20 536f 2077 6520  "created. So we 
-0000d5d0: 7375 6767 6573 7420 7468 6520 6c6f 6361  suggest the loca
-0000d5e0: 6c20 6469 7265 6374 6f72 792e 220a 2020  l directory.".  
-0000d5f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000d600: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
-0000d610: 616c 735f 6669 6c65 203d 2067 732e 7061  als_file = gs.pa
-0000d620: 2e63 7265 6465 6e74 6961 6c73 0a20 2020  .credentials.   
-0000d630: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
-0000d640: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
-0000d650: 2867 732e 7061 2e63 7265 6465 6e74 6961  (gs.pa.credentia
-0000d660: 6c73 293a 0a20 2020 2020 2020 2020 2020  ls):.           
-0000d670: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-0000d680: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000d690: 4372 6564 656e 7469 616c 7320 6669 6c65  Credentials file
-0000d6a0: 2065 7869 7374 6564 2e20 220a 2020 2020   existed. ".    
-0000d6b0: 2020 2020 2020 2020 2020 2020 2253 6f20              "So 
-0000d6c0: 7468 6973 2069 7320 7468 6520 6f6e 6520  this is the one 
-0000d6d0: 7765 2073 7567 6765 7374 2074 6f20 7573  we suggest to us
-0000d6e0: 652e 2022 0a20 2020 2020 2020 2020 2020  e. ".           
-0000d6f0: 2020 2020 2066 2266 696c 653a 207b 6372       f"file: {cr
-0000d700: 6564 656e 7469 616c 735f 6669 6c65 7d22  edentials_file}"
-0000d710: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000d720: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000d730: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0000d740: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0000d750: 2020 2020 2020 2022 4372 6564 656e 7469         "Credenti
-0000d760: 616c 7320 6669 6c65 2077 6173 2073 7065  als file was spe
-0000d770: 6369 6669 6564 2077 6974 6820 6675 6c6c  cified with full
-0000d780: 2070 6174 682e 2022 0a20 2020 2020 2020   path. ".       
-0000d790: 2020 2020 2020 2020 2022 536f 2077 6520           "So we 
-0000d7a0: 7375 6767 6573 7420 7468 6174 206f 6e65  suggest that one
-0000d7b0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0000d7c0: 2020 2020 6622 6669 6c65 3a20 7b63 7265      f"file: {cre
-0000d7d0: 6465 6e74 6961 6c73 5f66 696c 657d 220a  dentials_file}".
-0000d7e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000d7f0: 2020 2320 5468 6520 7265 7475 726e 6564    # The returned
-0000d800: 2066 696c 6520 2877 6974 6820 6f72 2077   file (with or w
-0000d810: 6974 686f 7574 2070 6174 6829 2020 6d69  ithout path)  mi
-0000d820: 6768 7420 6f72 206d 6967 6874 206e 6f74  ght or might not
-0000d830: 2065 7869 7374 2e0a 2020 2020 2320 4275   exist..    # Bu
-0000d840: 7420 6966 2069 7420 646f 6573 206e 6f74  t if it does not
-0000d850: 2065 7869 7374 2c20 6974 2069 7320 6569   exist, it is ei
-0000d860: 7468 6572 2061 2066 756c 6c20 7061 7468  ther a full path
-0000d870: 2c20 6f72 206c 6f63 616c 2e0a 2020 2020  , or local..    
-0000d880: 2320 5765 2064 6f20 6e6f 7420 7761 6e74  # We do not want
-0000d890: 2074 6f20 7265 7475 726e 2074 6865 206c   to return the l
-0000d8a0: 6173 7420 7265 736f 7274 2070 6174 6820  ast resort path 
-0000d8b0: 6966 2069 7420 646f 6573 206e 6f74 2065  if it does not e
-0000d8c0: 7869 7374 2c0a 2020 2020 2320 736f 2074  xist,.    # so t
-0000d8d0: 6861 7420 7768 656e 2069 7420 6973 2063  hat when it is c
-0000d8e0: 7265 6174 6564 2069 7420 6973 2063 7265  reated it is cre
-0000d8f0: 6174 6564 2077 6865 7265 2073 7065 6369  ated where speci
-0000d900: 6669 6361 6c6c 7920 7370 6563 6966 6965  fically specifie
-0000d910: 640a 2020 2020 2320 6f72 2069 6e20 6c6f  d.    # or in lo
-0000d920: 6361 6c20 6469 7220 2862 7574 206e 6f74  cal dir (but not
-0000d930: 2069 6e20 6c61 7374 2072 6573 6f72 7420   in last resort 
-0000d940: 6469 7220 7e2f 2e63 6f6e 6669 672f 2e2e  dir ~/.config/..
-0000d950: 2e29 0a20 2020 2072 6574 7572 6e20 6372  .).    return cr
-0000d960: 6564 656e 7469 616c 735f 6669 6c65 0a0a  edentials_file..
-0000d970: 0a64 6566 2064 6574 6572 6d69 6e65 5f73  .def determine_s
-0000d980: 746f 7265 5f64 6972 2829 202d 3e20 7374  tore_dir() -> st
-0000d990: 723a 0a20 2020 2022 2222 4465 7465 726d  r:.    """Determ
-0000d9a0: 696e 6520 7468 6520 7472 7565 2066 756c  ine the true ful
-0000d9b0: 6c20 6469 7265 6374 6f72 7920 6e61 6d65  l directory name
-0000d9c0: 206f 6620 7374 6f72 6520 6469 7265 6374   of store direct
-0000d9d0: 6f72 792e 0a0a 2020 2020 5265 7475 726e  ory...    Return
-0000d9e0: 7320 6669 6c65 6e61 6d65 2077 6974 6820  s filename with 
-0000d9f0: 6675 6c6c 2070 6174 6820 2861 2064 6972  full path (a dir
-0000da00: 2920 6f72 204e 6f6e 652e 0a0a 2020 2020  ) or None...    
-0000da10: 466f 7220 6869 7374 6f72 6963 2072 6561  For historic rea
-0000da20: 736f 6e73 3a0a 2020 2020 4966 202d 2d65  sons:.    If --e
-0000da30: 6e63 7279 7074 6564 2028 656e 6372 7970  ncrypted (encryp
-0000da40: 7465 6429 2069 7320 4e4f 5420 7475 726e  ted) is NOT turn
-0000da50: 6564 206f 6e2c 2072 6574 7572 6e20 4e6f  ed on, return No
-0000da60: 6e65 2e0a 0a20 2020 2054 6865 2073 746f  ne...    The sto
-0000da70: 7265 2070 6174 6820 7769 6c6c 2062 6520  re path will be 
-0000da80: 6c6f 6f6b 6564 2066 6f72 2074 6865 2066  looked for the f
-0000da90: 6f6c 6c6f 7769 6e67 2077 6179 3a0a 2020  ollowing way:.  
-0000daa0: 2020 6773 2e70 612e 7374 6f72 6520 7072    gs.pa.store pr
-0000dab0: 6f76 6964 6573 2065 6974 6865 7220 6465  ovides either de
-0000dac0: 6661 756c 7420 7661 6c75 6520 6f72 2075  fault value or u
-0000dad0: 7365 7220 7370 6563 6966 6965 6420 7661  ser specified va
-0000dae0: 6c75 650a 2020 2020 6129 2046 6972 7374  lue.    a) First
-0000daf0: 206c 6f6f 6b65 6420 6174 2064 6566 6175   looked at defau
-0000db00: 6c74 2f73 7065 6369 6669 6564 2076 616c  lt/specified val
-0000db10: 7565 2e20 4966 2064 6972 2065 7869 7374  ue. If dir exist
-0000db20: 732c 0a20 2020 2020 2020 7573 6520 6974  s,.       use it
-0000db30: 2c20 656e 6420 6f66 2073 6561 7263 682e  , end of search.
-0000db40: 0a20 2020 2062 2920 6966 206c 6173 742d  .    b) if last-
-0000db50: 7265 736f 7274 2073 746f 7265 2064 6972  resort store dir
-0000db60: 2065 7869 7374 732c 2075 7365 2069 742c   exists, use it,
-0000db70: 2065 6e64 206f 6620 7365 6172 6368 2e0a   end of search..
-0000db80: 2020 2020 6329 2069 6620 6f6e 6c79 2061      c) if only a
-0000db90: 2064 6972 6e61 6d65 2077 6974 686f 7574   dirname without
-0000dba0: 2070 6174 6820 2865 2e67 2e20 2273 746f   path (e.g. "sto
-0000dbb0: 7265 2229 2069 7320 7370 6563 6966 6965  re") is specifie
-0000dbc0: 640a 2020 2020 2020 2061 6e64 2069 7420  d.       and it 
-0000dbd0: 6361 6e6e 6f74 2062 6520 666f 756e 6420  cannot be found 
-0000dbe0: 696e 2074 6865 2063 7572 7265 6e74 206c  in the current l
-0000dbf0: 6f63 616c 2064 6972 6563 746f 7279 2c20  ocal directory, 
-0000dc00: 7468 656e 0a20 2020 2020 2020 6c6f 6f6b  then.       look
-0000dc10: 2066 6f72 2069 7420 696e 206c 6173 742d   for it in last-
-0000dc20: 7265 736f 7274 2070 6174 682e 0a20 2020  resort path..   
-0000dc30: 2054 4c44 523a 2054 6865 2070 726f 6772   TLDR: The progr
-0000dc40: 616d 2077 696c 6c20 6c6f 6f6b 2069 6e20  am will look in 
-0000dc50: 7061 7468 2073 7065 6369 6669 6564 2077  path specified w
-0000dc60: 6974 6820 2d2d 7374 6f72 650a 2020 2020  ith --store.    
-0000dc70: 2020 2063 6f6d 6d61 6e64 206c 696e 6520     command line 
-0000dc80: 6172 6775 6d65 6e74 2e20 4966 206e 6f74  argument. If not
-0000dc90: 2066 6f75 6e64 2074 6865 7265 2069 6e20   found there in 
-0000dca0: 6465 6661 756c 740a 2020 2020 2020 206c  default.       l
-0000dcb0: 6f63 616c 2064 6972 2e20 4966 206e 6f74  ocal dir. If not
-0000dcc0: 2066 6f75 6e64 2074 6865 7265 2069 6e20   found there in 
-0000dcd0: 6c61 7374 2d72 6573 6f72 7420 6469 722e  last-resort dir.
-0000dce0: 0a20 2020 2020 2020 4966 206e 6f74 2066  .       If not f
-0000dcf0: 6f75 6e64 2074 6865 7265 2028 616e 6420  ound there (and 
-0000dd00: 6f6e 6c79 2064 6972 6e61 6d65 2077 6974  only dirname wit
-0000dd10: 686f 7574 2070 6174 6820 6769 7665 6e29  hout path given)
-0000dd20: 2c0a 2020 2020 2020 2061 7320 6120 6669  ,.       as a fi
-0000dd30: 6e61 6c20 6368 6f69 6365 2c20 7468 6520  nal choice, the 
-0000dd40: 7072 6f67 7261 6d20 7769 6c6c 206c 6f6f  program will loo
-0000dd50: 6b20 666f 7220 6974 2069 6e0a 2020 2020  k for it in.    
-0000dd60: 2020 206c 6173 7420 7265 736f 7274 2070     last resort p
-0000dd70: 6174 682e 0a20 2020 2049 6620 6e6f 7420  ath..    If not 
-0000dd80: 666f 756e 6420 616e 7977 6865 7265 2c20  found anywhere, 
-0000dd90: 6974 2077 696c 6c20 7265 7475 726e 2064  it will return d
-0000dda0: 6566 6175 6c74 2f73 7065 6369 6669 6564  efault/specified
-0000ddb0: 2076 616c 7565 2e0a 0a20 2020 2022 2222   value...    """
-0000ddc0: 0a20 2020 2069 6620 6e6f 7420 6773 2e70  .    if not gs.p
-0000ddd0: 612e 7374 6f72 653a 0a20 2020 2020 2020  a.store:.       
-0000dde0: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-0000ddf0: 2069 6620 6e6f 7420 6773 2e70 612e 656e   if not gs.pa.en
-0000de00: 6372 7970 7465 643a 0a20 2020 2020 2020  crypted:.       
-0000de10: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-0000de20: 2070 6172 6773 5f73 746f 7265 5f6e 6f72   pargs_store_nor
-0000de30: 6d20 3d20 6f73 2e70 6174 682e 6e6f 726d  m = os.path.norm
-0000de40: 7061 7468 2867 732e 7061 2e73 746f 7265  path(gs.pa.store
-0000de50: 2920 2023 206e 6f72 6d61 696c 7a65 6420  )  # normailzed 
-0000de60: 666f 7220 6875 6d61 6e73 0a20 2020 2069  for humans.    i
-0000de70: 6620 6f73 2e70 6174 682e 6973 6469 7228  f os.path.isdir(
-0000de80: 6773 2e70 612e 7374 6f72 6529 3a0a 2020  gs.pa.store):.  
-0000de90: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0000dea0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0000deb0: 2246 6f75 6e64 2061 6e20 6578 6973 7469  "Found an existi
-0000dec0: 6e67 2073 746f 7265 2069 6e20 6469 7265  ng store in dire
-0000ded0: 6374 6f72 7920 220a 2020 2020 2020 2020  ctory ".        
-0000dee0: 2020 2020 6627 227b 7061 7267 735f 7374      f'"{pargs_st
-0000def0: 6f72 655f 6e6f 726d 7d22 2028 6c6f 6361  ore_norm}" (loca
-0000df00: 6c20 6f72 2061 7267 756d 656e 7473 292e  l or arguments).
-0000df10: 2027 0a20 2020 2020 2020 2020 2020 2022   '.            "
-0000df20: 4974 2077 696c 6c20 6265 2075 7365 642e  It will be used.
-0000df30: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0000df40: 2020 2020 7265 7475 726e 2070 6172 6773      return pargs
-0000df50: 5f73 746f 7265 5f6e 6f72 6d0a 2020 2020  _store_norm.    
-0000df60: 6966 2067 732e 7061 2e73 746f 7265 2021  if gs.pa.store !
-0000df70: 3d20 5354 4f52 455f 4449 525f 4445 4641  = STORE_DIR_DEFA
-0000df80: 554c 5420 616e 6420 6773 2e70 612e 7374  ULT and gs.pa.st
-0000df90: 6f72 6520 213d 206f 732e 7061 7468 2e62  ore != os.path.b
-0000dfa0: 6173 656e 616d 6528 0a20 2020 2020 2020  asename(.       
-0000dfb0: 2067 732e 7061 2e73 746f 7265 0a20 2020   gs.pa.store.   
-0000dfc0: 2029 3a0a 2020 2020 2020 2020 6773 2e6c   ):.        gs.l
-0000dfd0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-0000dfe0: 2020 2020 2020 6627 5374 6f72 6520 6469        f'Store di
-0000dff0: 7265 6374 6f72 7920 227b 7061 7267 735f  rectory "{pargs_
-0000e000: 7374 6f72 655f 6e6f 726d 7d22 2077 6173  store_norm}" was
-0000e010: 2073 7065 6369 6669 6564 2062 7920 270a   specified by '.
-0000e020: 2020 2020 2020 2020 2020 2020 2275 7365              "use
-0000e030: 722c 2069 7420 6973 2061 2064 6972 6563  r, it is a direc
-0000e040: 746f 7279 2077 6974 6820 6120 7061 7468  tory with a path
-0000e050: 2c20 6275 7420 7468 6520 6469 7265 6374  , but the direct
-0000e060: 6f72 7920 220a 2020 2020 2020 2020 2020  ory ".          
-0000e070: 2020 2264 6f65 7320 6e6f 7420 6578 6973    "does not exis
-0000e080: 742e 2022 0a20 2020 2020 2020 2029 0a20  t. ".        ). 
-0000e090: 2020 2020 2020 2023 2066 616c 6c20 7468         # fall th
-0000e0a0: 726f 7567 6820 746f 7761 7264 7320 656e  rough towards en
-0000e0b0: 6469 6e67 206f 6620 6675 6e63 7469 6f6e  ding of function
-0000e0c0: 2074 6f20 7072 696e 7420 616e 6420 7265   to print and re
-0000e0d0: 7475 726e 2076 616c 7565 0a20 2020 2020  turn value.     
-0000e0e0: 2020 2023 2063 7265 6174 6520 696e 2074     # create in t
-0000e0f0: 6865 2073 7065 6369 6669 6564 2c20 6469  he specified, di
-0000e100: 7265 6374 6f72 7920 7769 7468 2070 6174  rectory with pat
-0000e110: 680a 2020 2020 6966 2067 732e 7061 2e73  h.    if gs.pa.s
-0000e120: 746f 7265 203d 3d20 5354 4f52 455f 4449  tore == STORE_DI
-0000e130: 525f 4445 4641 554c 5420 616e 6420 6f73  R_DEFAULT and os
-0000e140: 2e70 6174 682e 6973 6469 7228 0a20 2020  .path.isdir(.   
-0000e150: 2020 2020 2053 544f 5245 5f44 4952 5f4c       STORE_DIR_L
-0000e160: 4153 5452 4553 4f52 540a 2020 2020 293a  ASTRESORT.    ):
-0000e170: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0000e180: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0000e190: 2020 2022 5374 6f72 6520 7761 7320 6e6f     "Store was no
-0000e1a0: 7420 666f 756e 6420 696e 2064 6566 6175  t found in defau
-0000e1b0: 6c74 206c 6f63 616c 2064 6972 6563 746f  lt local directo
-0000e1c0: 7279 2e20 220a 2020 2020 2020 2020 2020  ry. ".          
-0000e1d0: 2020 2242 7574 2066 6f75 6e64 2061 6e20    "But found an 
-0000e1e0: 6578 6973 7469 6e67 2073 746f 7265 2064  existing store d
-0000e1f0: 6972 6563 746f 7279 2069 6e20 220a 2020  irectory in ".  
-0000e200: 2020 2020 2020 2020 2020 6627 227b 5354            f'"{ST
-0000e210: 4f52 455f 4449 525f 4c41 5354 5245 534f  ORE_DIR_LASTRESO
-0000e220: 5254 7d22 2064 6972 6563 746f 7279 2e20  RT}" directory. 
-0000e230: 270a 2020 2020 2020 2020 2020 2020 2249  '.            "I
-0000e240: 7420 7769 6c6c 2062 6520 7573 6564 2e22  t will be used."
-0000e250: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000e260: 2020 2072 6574 7572 6e20 5354 4f52 455f     return STORE_
-0000e270: 4449 525f 4c41 5354 5245 534f 5254 0a0a  DIR_LASTRESORT..
-0000e280: 2020 2020 6966 2067 732e 7061 2e73 746f      if gs.pa.sto
-0000e290: 7265 203d 3d20 6f73 2e70 6174 682e 6261  re == os.path.ba
-0000e2a0: 7365 6e61 6d65 2867 732e 7061 2e73 746f  sename(gs.pa.sto
-0000e2b0: 7265 293a 0a20 2020 2020 2020 2067 732e  re):.        gs.
-0000e2c0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0000e2d0: 2020 2020 2020 2066 2753 746f 7265 2064         f'Store d
-0000e2e0: 6972 6563 746f 7279 2022 7b70 6172 6773  irectory "{pargs
-0000e2f0: 5f73 746f 7265 5f6e 6f72 6d7d 2220 6973  _store_norm}" is
-0000e300: 206a 7573 7420 6120 6e61 6d65 2027 0a20   just a name '. 
-0000e310: 2020 2020 2020 2020 2020 2022 7769 7468             "with
-0000e320: 6f75 7420 6120 7061 7468 2e20 416c 7265  out a path. Alre
-0000e330: 6164 7920 6c6f 6f6b 6564 206c 6f63 616c  ady looked local
-0000e340: 6c79 2c20 6275 7420 6e6f 7420 666f 756e  ly, but not foun
-0000e350: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
-0000e360: 226c 6f63 616c 6c79 2e20 536f 206e 6f77  "locally. So now
-0000e370: 206c 6f6f 6b69 6e67 2066 6f72 2069 7420   looking for it 
-0000e380: 696e 206c 6173 742d 7265 736f 7274 2070  in last-resort p
-0000e390: 6174 682e 220a 2020 2020 2020 2020 290a  ath.".        ).
-0000e3a0: 2020 2020 2020 2020 6c61 7374 5f72 6573          last_res
-0000e3b0: 6f72 7420 3d20 6f73 2e70 6174 682e 6e6f  ort = os.path.no
-0000e3c0: 726d 7061 7468 280a 2020 2020 2020 2020  rmpath(.        
-0000e3d0: 2020 2020 5354 4f52 455f 5041 5448 5f4c      STORE_PATH_L
-0000e3e0: 4153 5452 4553 4f52 5420 2b20 222f 2220  ASTRESORT + "/" 
-0000e3f0: 2b20 6773 2e70 612e 7374 6f72 650a 2020  + gs.pa.store.  
-0000e400: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000e410: 6966 206f 732e 7061 7468 2e69 7364 6972  if os.path.isdir
-0000e420: 286c 6173 745f 7265 736f 7274 293a 0a20  (last_resort):. 
-0000e430: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-0000e440: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-0000e450: 2020 2020 2020 2020 2022 466f 756e 6420           "Found 
-0000e460: 616e 2065 7869 7374 696e 6720 7374 6f72  an existing stor
-0000e470: 6520 6469 7265 6374 6f72 7920 696e 2022  e directory in "
-0000e480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e490: 2066 2722 7b6c 6173 745f 7265 736f 7274   f'"{last_resort
-0000e4a0: 7d22 2064 6972 6563 746f 7279 2e20 4974  }" directory. It
-0000e4b0: 2077 696c 6c20 6265 2075 7365 642e 270a   will be used.'.
-0000e4c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0000e4d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000e4e0: 206c 6173 745f 7265 736f 7274 0a0a 2020   last_resort..  
-0000e4f0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-0000e500: 2020 2020 2020 2020 2253 746f 7265 2064          "Store d
-0000e510: 6972 6563 746f 7279 2077 6173 206e 6f74  irectory was not
-0000e520: 2066 6f75 6e64 2061 6e79 7768 6572 652e   found anywhere.
-0000e530: 2048 656e 6365 2c20 7765 2077 696c 6c20   Hence, we will 
-0000e540: 7375 6767 6573 7420 220a 2020 2020 2020  suggest ".      
-0000e550: 2020 6627 227b 7061 7267 735f 7374 6f72    f'"{pargs_stor
-0000e560: 655f 6e6f 726d 7d22 2028 6c6f 6361 6c20  e_norm}" (local 
-0000e570: 6469 7265 6374 6f72 7929 2061 7320 7374  directory) as st
-0000e580: 6f72 6520 6469 7265 6374 6f72 792e 270a  ore directory.'.
-0000e590: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
-0000e5a0: 2070 6172 6773 5f73 746f 7265 5f6e 6f72   pargs_store_nor
-0000e5b0: 6d20 2023 2063 7265 6174 6520 696e 2074  m  # create in t
-0000e5c0: 6865 2073 7065 6369 6669 6564 2c20 6c6f  he specified, lo
-0000e5d0: 6361 6c20 6469 7220 7769 7468 6f75 7420  cal dir without 
-0000e5e0: 7061 7468 0a0a 0a61 7379 6e63 2064 6566  path...async def
-0000e5f0: 2064 6574 6572 6d69 6e65 5f64 6d5f 726f   determine_dm_ro
-0000e600: 6f6d 7328 0a20 2020 2075 7365 7273 3a20  oms(.    users: 
-0000e610: 6c69 7374 2c20 636c 6965 6e74 3a20 4173  list, client: As
-0000e620: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
-0000e630: 6e74 6961 6c73 3a20 6469 6374 0a29 202d  ntials: dict.) -
-0000e640: 3e20 6c69 7374 3a0a 2020 2020 2222 2244  > list:.    """D
-0000e650: 6574 6572 6d69 6e65 2074 6865 2072 6f6f  etermine the roo
-0000e660: 6d73 2074 6f20 7365 6e64 2074 6f2e 0a0a  ms to send to...
-0000e670: 2020 2020 5573 6572 7320 6361 6e20 6265      Users can be
-0000e680: 2073 7065 6369 6669 6564 2077 6974 6820   specified with 
-0000e690: 2d2d 7573 6572 2066 6f72 2073 656e 6420  --user for send 
-0000e6a0: 616e 6420 6c69 7374 656e 206f 7065 7261  and listen opera
-0000e6b0: 7469 6f6e 732e 0a20 2020 2054 6865 7365  tions..    These
-0000e6c0: 2072 6f6f 6d73 2077 6520 6c61 6265 6c20   rooms we label 
-0000e6d0: 444d 2028 6469 7265 6374 206d 6573 7361  DM (direct messa
-0000e6e0: 6769 6e67 2920 726f 6f6d 732e 0a20 2020  ging) rooms..   
-0000e6f0: 2042 7920 7468 6174 2077 6520 6d65 616e   By that we mean
-0000e700: 7320 726f 6f6d 7320 7468 6174 206f 6e6c  s rooms that onl
-0000e710: 7920 6861 7665 2032 206d 656d 6265 7273  y have 2 members
-0000e720: 2c20 616e 6420 7468 6573 6520 7477 6f0a  , and these two.
-0000e730: 2020 2020 6d65 6d62 6572 7320 6265 696e      members bein
-0000e740: 6720 7468 6520 7365 6e64 6572 2061 6e64  g the sender and
-0000e750: 2074 6865 2072 6563 6970 6965 6e74 2069   the recipient i
-0000e760: 6e20 7175 6573 7469 6f6e 2e0a 2020 2020  n question..    
-0000e770: 5765 2064 6f20 6e6f 7420 6361 7265 2061  We do not care a
-0000e780: 626f 7574 2027 6973 5f67 726f 7570 2720  bout 'is_group' 
-0000e790: 6f72 2027 6973 5f64 6972 6563 7427 2066  or 'is_direct' f
-0000e7a0: 6c61 6773 2028 6869 6e74 7329 2e0a 0a20  lags (hints)... 
-0000e7b0: 2020 2049 6620 6769 7665 6e20 6120 7573     If given a us
-0000e7c0: 6572 2061 6e64 206b 6e6f 776e 2074 6865  er and known the
-0000e7d0: 2073 656e 6465 722c 2077 6520 7472 7920   sender, we try 
-0000e7e0: 746f 2066 696e 6420 6120 6d61 7463 6869  to find a matchi
-0000e7f0: 6e67 2072 6f6f 6d2e 0a20 2020 2054 6865  ng room..    The
-0000e800: 7265 206d 6967 6874 2062 6520 302c 2031  re might be 0, 1
-0000e810: 2c20 6f72 206d 6f72 6520 6d61 7463 6869  , or more matchi
-0000e820: 6e67 2072 6f6f 6d73 2e20 4966 2030 2c20  ng rooms. If 0, 
-0000e830: 7468 656e 2067 6976 6572 2065 7272 6f72  then giver error
-0000e840: 0a20 2020 2061 6e64 2074 6865 2075 7365  .    and the use
-0000e850: 7220 7368 6f75 6c64 2072 756e 202d 2d72  r should run --r
-0000e860: 6f6f 6d2d 696e 7669 7465 2066 6972 7374  oom-invite first
-0000e870: 2e20 6966 2031 2066 6f75 6e64 2c20 7573  . if 1 found, us
-0000e880: 6520 6974 2e0a 2020 2020 4966 206d 6f72  e it..    If mor
-0000e890: 6520 7468 616e 2031 2066 6f75 6e64 2c20  e than 1 found, 
-0000e8a0: 6a75 7374 2075 7365 2031 206f 6620 7468  just use 1 of th
-0000e8b0: 656d 2061 7262 6974 7261 7269 6c79 2e0a  em arbitrarily..
-0000e8c0: 0a20 2020 2054 6865 2073 7465 7073 2061  .    The steps a
-0000e8d0: 7265 3a0a 2020 2020 2d20 6765 7420 616c  re:.    - get al
-0000e8e0: 6c20 726f 6f6d 7320 7768 6572 6520 7365  l rooms where se
-0000e8f0: 6e64 6572 2069 7320 6d65 6d62 6572 0a20  nder is member. 
-0000e900: 2020 202d 2067 6574 2061 6c6c 206d 656d     - get all mem
-0000e910: 6265 7273 2074 6f20 7468 6573 6520 726f  bers to these ro
-0000e920: 6f6d 730a 2020 2020 2d20 6368 6563 6b20  oms.    - check 
-0000e930: 6966 2074 6865 7265 2069 7320 6120 726f  if there is a ro
-0000e940: 6f6d 2077 6974 6820 6a75 7374 2032 206d  om with just 2 m
-0000e950: 656d 6265 7273 2061 6e64 2074 6865 6d0a  embers and them.
-0000e960: 2020 2020 2020 6265 696e 6720 7365 6e64        being send
-0000e970: 6572 2061 6e64 2072 6563 6970 6965 6e74  er and recipient
-0000e980: 2028 7573 6572 2066 726f 6d20 7573 6572   (user from user
-0000e990: 7320 6172 6729 0a0a 2020 2020 496e 206f  s arg)..    In o
-0000e9a0: 7264 6572 2074 6f20 6d61 7463 6820 6120  rder to match a 
-0000e9b0: 7573 6572 2074 6f20 6120 526f 6f6d 4d65  user to a RoomMe
-0000e9c0: 6d62 6572 2077 6520 616c 6c6f 7720 3320  mber we allow 3 
-0000e9d0: 6368 6f69 6365 733a 0a20 2020 202d 2075  choices:.    - u
-0000e9e0: 7365 725f 6964 3a20 7065 7266 6563 7420  ser_id: perfect 
-0000e9f0: 6d61 7463 682c 2069 7320 756e 6971 7565  match, is unique
-0000ea00: 2c20 6675 6c6c 2075 7365 7220 6964 2c20  , full user id, 
-0000ea10: 652e 672e 2022 4075 7365 723a 6578 616d  e.g. "@user:exam
-0000ea20: 706c 652e 6f72 6722 0a20 2020 202d 2075  ple.org".    - u
-0000ea30: 7365 725f 6964 2077 6974 686f 7574 2068  ser_id without h
-0000ea40: 6f6d 6573 6572 7665 7220 646f 6d61 696e  omeserver domain
-0000ea50: 3a20 7061 7274 6961 6c20 7573 6572 2069  : partial user i
-0000ea60: 642c 2065 2e67 2e20 2240 7573 6572 220a  d, e.g. "@user".
-0000ea70: 2020 2020 2020 7468 6973 2070 6172 7469        this parti
-0000ea80: 616c 2075 7365 7220 7769 6c6c 2062 6520  al user will be 
-0000ea90: 636f 6d70 6c65 7465 6420 6279 2061 6464  completed by add
-0000eaa0: 696e 6720 7468 6520 686f 6d65 7365 7276  ing the homeserv
-0000eab0: 6572 206f 6620 7468 650a 2020 2020 2020  er of the.      
-0000eac0: 7365 6e64 6572 2074 6f20 7468 6520 656e  sender to the en
-0000ead0: 642c 2069 2e65 2e20 6173 7375 6d69 6e67  d, i.e. assuming
-0000eae0: 2074 6861 7420 7365 6e64 6572 2061 6e64   that sender and
-0000eaf0: 2072 6563 6569 7665 7220 6172 6520 6f6e   receiver are on
-0000eb00: 2074 6865 0a20 2020 2020 2073 616d 6520   the.      same 
-0000eb10: 686f 6d65 7365 7276 6572 2e0a 2020 2020  homeserver..    
-0000eb20: 2d20 6469 7370 6c61 7920 6e61 6d65 3a20  - display name: 
-0000eb30: 6265 2063 6172 6566 756c 2c20 6469 7370  be careful, disp
-0000eb40: 6c61 7920 6e61 6d65 7320 6172 6520 4e4f  lay names are NO
-0000eb50: 5420 756e 6971 7565 2c20 796f 7520 636f  T unique, you co
-0000eb60: 756c 6420 6265 0a20 2020 2020 206d 6973  uld be.      mis
-0000eb70: 7461 6b65 6e20 616e 6420 6279 2065 7272  taken and by err
-0000eb80: 6f72 2073 656e 6420 746f 2074 6865 2077  or send to the w
-0000eb90: 726f 6e67 2070 6572 736f 6e2e 0a20 2020  rong person..   
-0000eba0: 2020 2027 2d2d 6a6f 696e 6564 2d6d 656d     '--joined-mem
-0000ebb0: 6265 7273 2022 2a22 2720 7368 6f77 7320  bers "*"' shows 
-0000ebc0: 796f 7520 7468 6520 6469 7370 6c61 7920  you the display 
-0000ebd0: 6e61 6d65 7320 696e 2074 6865 206d 6964  names in the mid
-0000ebe0: 646c 6520 636f 6c75 6d6e 0a0a 2020 2020  dle column..    
-0000ebf0: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
-0000ec00: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-0000ec10: 2075 7365 7273 3a20 6c69 7374 2873 7472   users: list(str
-0000ec20: 293a 206c 6973 7420 6f66 2075 7365 725f  ): list of user_
-0000ec30: 6964 730a 2020 2020 2020 2020 2020 2020  ids.            
-0000ec40: 7472 7920 746f 2066 696e 6420 6120 6d61  try to find a ma
-0000ec50: 7463 6869 6e67 2044 4d20 726f 6f6d 2066  tching DM room f
-0000ec60: 6f72 2065 6163 6820 7573 6572 0a20 2020  or each user.   
-0000ec70: 2020 2020 2063 6c69 656e 743a 2041 7379       client: Asy
-0000ec80: 6e63 436c 6965 6e74 3a20 636c 6965 6e74  ncClient: client
-0000ec90: 2c20 616c 6c6f 7773 2061 7320 746f 2071  , allows as to q
-0000eca0: 7565 7279 2074 6865 2073 6572 7665 720a  uery the server.
-0000ecb0: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
-0000ecc0: 616c 733a 2064 6963 743a 2061 6c6c 6f77  als: dict: allow
-0000ecd0: 7320 746f 2067 6574 2074 6865 2075 7365  s to get the use
-0000ece0: 725f 6964 206f 6620 7365 6e64 6572 0a0a  r_id of sender..
-0000ecf0: 2020 2020 5265 7475 726e 7320 6120 6c69      Returns a li
-0000ed00: 7374 206f 6620 666f 756e 6420 444d 2072  st of found DM r
-0000ed10: 6f6f 6d73 2e20 4c69 7374 206d 6179 2062  ooms. List may b
-0000ed20: 6520 656d 7074 7920 6966 206e 6f20 6d61  e empty if no ma
-0000ed30: 7463 6865 7320 7765 7265 0a20 2020 2066  tches were.    f
-0000ed40: 6f75 6e64 2e0a 0a20 2020 2022 2222 0a20  ound...    """. 
-0000ed50: 2020 2072 6f6f 6d73 203d 205b 5d0a 2020     rooms = [].  
-0000ed60: 2020 6966 206e 6f74 2075 7365 7273 3a0a    if not users:.
-0000ed70: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0000ed80: 6562 7567 2866 2252 6f6f 6d28 7329 2066  ebug(f"Room(s) f
-0000ed90: 726f 6d20 2d2d 7573 6572 3a20 7b72 6f6f  rom --user: {roo
-0000eda0: 6d73 7d2c 206e 6f20 7573 6572 7320 7765  ms}, no users we
-0000edb0: 7265 2073 7065 6369 6669 6564 2e22 290a  re specified.").
-0000edc0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-0000edd0: 6f6f 6d73 0a20 2020 2073 656e 6465 7220  ooms.    sender 
-0000ede0: 3d20 6372 6564 656e 7469 616c 735b 2275  = credentials["u
-0000edf0: 7365 725f 6964 225d 2020 2320 7768 6f20  ser_id"]  # who 
-0000ee00: 616d 2069 0a20 2020 2067 732e 6c6f 672e  am i.    gs.log.
-0000ee10: 6465 6275 6728 6622 5472 7969 6e67 2074  debug(f"Trying t
-0000ee20: 6f20 6765 7420 6d65 6d62 6572 7320 666f  o get members fo
-0000ee30: 7220 616c 6c20 726f 6f6d 7320 6f66 2073  r all rooms of s
-0000ee40: 656e 6465 723a 207b 7365 6e64 6572 7d22  ender: {sender}"
-0000ee50: 290a 2020 2020 7265 7370 203d 2061 7761  ).    resp = awa
-0000ee60: 6974 2063 6c69 656e 742e 6a6f 696e 6564  it client.joined
-0000ee70: 5f72 6f6f 6d73 2829 0a20 2020 2069 6620  _rooms().    if 
-0000ee80: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-0000ee90: 204a 6f69 6e65 6452 6f6f 6d73 4572 726f   JoinedRoomsErro
-0000eea0: 7229 3a0a 2020 2020 2020 2020 6773 2e6c  r):.        gs.l
-0000eeb0: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-0000eec0: 2020 2020 2020 2245 3131 373a 2022 0a20        "E117: ". 
-0000eed0: 2020 2020 2020 2020 2020 2066 226a 6f69             f"joi
-0000eee0: 6e65 645f 726f 6f6d 7320 6661 696c 6564  ned_rooms failed
-0000eef0: 2077 6974 6820 7b70 7269 7661 6379 5f66   with {privacy_f
-0000ef00: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-0000ef10: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
-0000ef20: 2022 4e6f 7420 6162 6c65 2074 6f20 220a   "Not able to ".
-0000ef30: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-0000ef40: 2061 6c6c 2072 6f6f 6d73 2e20 220a 2020   all rooms. ".  
-0000ef50: 2020 2020 2020 2020 2020 6622 4e6f 7420            f"Not 
-0000ef60: 6162 6c65 2074 6f20 6669 6e64 2044 4d20  able to find DM 
-0000ef70: 726f 6f6d 7320 666f 7220 7365 6e64 6572  rooms for sender
-0000ef80: 207b 7365 6e64 6572 7d2e 2022 0a20 2020   {sender}. ".   
-0000ef90: 2020 2020 2020 2020 2066 224e 6f74 2061           f"Not a
-0000efa0: 626c 6520 746f 2073 656e 6420 746f 2072  ble to send to r
-0000efb0: 6563 6569 7665 7273 207b 7573 6572 737d  eceivers {users}
-0000efc0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-0000efd0: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-0000efe0: 7420 2b3d 2031 0a20 2020 2020 2020 2073  t += 1.        s
-0000eff0: 656e 6465 7272 6f6f 6d73 203d 205b 5d0a  enderrooms = [].
-0000f000: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000f010: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-0000f020: 2020 2020 2020 2020 2020 2020 6622 6a6f              f"jo
-0000f030: 696e 6564 5f72 6f6f 6d73 2073 7563 6365  ined_rooms succe
-0000f040: 7373 6675 6c20 7769 7468 207b 7072 6976  ssful with {priv
-0000f050: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-0000f060: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-0000f070: 290a 2020 2020 2020 2020 7365 6e64 6572  ).        sender
-0000f080: 726f 6f6d 7320 3d20 7265 7370 2e72 6f6f  rooms = resp.roo
-0000f090: 6d73 0a20 2020 2072 6f6f 6d5f 666f 756e  ms.    room_foun
-0000f0a0: 645f 666f 725f 7573 6572 7320 3d20 5b5d  d_for_users = []
-0000f0b0: 0a20 2020 2066 6f72 2072 6f6f 6d20 696e  .    for room in
-0000f0c0: 2073 656e 6465 7272 6f6f 6d73 3a0a 2020   senderrooms:.  
-0000f0d0: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
-0000f0e0: 6974 2063 6c69 656e 742e 6a6f 696e 6564  it client.joined
-0000f0f0: 5f6d 656d 6265 7273 2872 6f6f 6d29 0a20  _members(room). 
-0000f100: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000f110: 616e 6365 2872 6573 702c 204a 6f69 6e65  ance(resp, Joine
-0000f120: 644d 656d 6265 7273 4572 726f 7229 3a0a  dMembersError):.
-0000f130: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-0000f140: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-0000f150: 2020 2020 2020 2020 2020 2245 3131 383a            "E118:
-0000f160: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0000f170: 2020 2066 226a 6f69 6e65 645f 6d65 6d62     f"joined_memb
-0000f180: 6572 7320 6661 696c 6564 2077 6974 6820  ers failed with 
-0000f190: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0000f1a0: 7374 7228 7265 7370 2929 7d2e 2022 0a20  str(resp))}. ". 
-0000f1b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000f1c0: 4e6f 7420 6162 6c65 2074 6f20 220a 2020  Not able to ".  
-0000f1d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0000f1e0: 6765 7420 726f 6f6d 206d 656d 6265 7273  get room members
-0000f1f0: 2066 6f72 2072 6f6f 6d20 7b72 6f6f 6d7d   for room {room}
-0000f200: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0000f210: 2020 2020 6622 4e6f 7420 6162 6c65 2074      f"Not able t
-0000f220: 6f20 6669 6e64 2044 4d20 726f 6f6d 7320  o find DM rooms 
-0000f230: 666f 7220 7365 6e64 6572 207b 7365 6e64  for sender {send
-0000f240: 6572 7d2e 2022 0a20 2020 2020 2020 2020  er}. ".         
-0000f250: 2020 2020 2020 2066 224e 6f74 2061 626c         f"Not abl
-0000f260: 6520 746f 2073 656e 6420 746f 2073 6f6d  e to send to som
-0000f270: 6520 6f66 2074 6865 7365 2072 6563 6569  e of these recei
-0000f280: 7665 7273 207b 7573 6572 737d 2e22 0a20  vers {users}.". 
-0000f290: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000f2a0: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-0000f2b0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0000f2c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000f2d0: 2020 2020 2023 2072 6573 702e 726f 6f6d       # resp.room
-0000f2e0: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-0000f2f0: 2320 7265 7370 2e6d 656d 6265 7273 203d  # resp.members =
-0000f300: 204c 6973 745b 526f 6f6d 4d65 6d62 6572   List[RoomMember
-0000f310: 5d20 3b20 526f 6f6d 4d65 6d62 6572 0a20  ] ; RoomMember. 
-0000f320: 2020 2020 2020 2020 2020 2023 206d 656d             # mem
-0000f330: 6265 722e 7573 6572 5f69 640a 2020 2020  ber.user_id.    
-0000f340: 2020 2020 2020 2020 2320 6d65 6d62 6572          # member
-0000f350: 2e64 6973 706c 6179 5f6e 616d 650a 2020  .display_name.  
-0000f360: 2020 2020 2020 2020 2020 2320 6d65 6d62            # memb
-0000f370: 6572 2e61 7661 7461 725f 7572 6c0a 2020  er.avatar_url.  
-0000f380: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0000f390: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-0000f3a0: 2020 2020 2020 2020 6622 6a6f 696e 6564          f"joined
-0000f3b0: 5f6d 656d 6265 7273 2073 7563 6365 7373  _members success
-0000f3c0: 6675 6c20 7769 7468 207b 7072 6976 6163  ful with {privac
-0000f3d0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-0000f3e0: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
-0000f3f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000f400: 6966 2072 6573 702e 6d65 6d62 6572 7320  if resp.members 
-0000f410: 616e 6420 6c65 6e28 7265 7370 2e6d 656d  and len(resp.mem
-0000f420: 6265 7273 2920 3d3d 2032 3a0a 2020 2020  bers) == 2:.    
-0000f430: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0000f440: 6573 702e 6d65 6d62 6572 735b 305d 2e75  esp.members[0].u
-0000f450: 7365 725f 6964 203d 3d20 7365 6e64 6572  ser_id == sender
-0000f460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f470: 2020 2020 2020 2320 736e 6472 203d 2072        # sndr = r
-0000f480: 6573 702e 6d65 6d62 6572 735b 305d 0a20  esp.members[0]. 
-0000f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4a0: 2020 2072 6376 7220 3d20 7265 7370 2e6d     rcvr = resp.m
-0000f4b0: 656d 6265 7273 5b31 5d0a 2020 2020 2020  embers[1].      
-0000f4c0: 2020 2020 2020 2020 2020 656c 6966 2072            elif r
-0000f4d0: 6573 702e 6d65 6d62 6572 735b 315d 2e75  esp.members[1].u
-0000f4e0: 7365 725f 6964 203d 3d20 7365 6e64 6572  ser_id == sender
-0000f4f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f500: 2020 2020 2020 2320 736e 6472 203d 2072        # sndr = r
-0000f510: 6573 702e 6d65 6d62 6572 735b 315d 0a20  esp.members[1]. 
-0000f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f530: 2020 2072 6376 7220 3d20 7265 7370 2e6d     rcvr = resp.m
-0000f540: 656d 6265 7273 5b30 5d0a 2020 2020 2020  embers[0].      
-0000f550: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f570: 2020 2020 2320 736e 6472 203d 204e 6f6e      # sndr = Non
-0000f580: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000f590: 2020 2020 2020 7263 7672 203d 204e 6f6e        rcvr = Non
-0000f5a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000f5b0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-0000f5c0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000f5d0: 2020 2020 2020 2020 2020 2020 2245 3131              "E11
-0000f5e0: 393a 2022 0a20 2020 2020 2020 2020 2020  9: ".           
-0000f5f0: 2020 2020 2020 2020 2020 2020 2066 2253               f"S
-0000f600: 656e 6465 7220 646f 6573 206e 6f74 206d  ender does not m
-0000f610: 6174 6368 207b 7072 6976 6163 795f 6669  atch {privacy_fi
-0000f620: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0000f630: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000f640: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000f650: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-0000f660: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-0000f670: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000f680: 7220 7573 6572 2069 6e20 7573 6572 733a  r user in users:
-0000f690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f6a0: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
-0000f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6c0: 2020 7263 7672 0a20 2020 2020 2020 2020    rcvr.         
-0000f6d0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000f6e0: 6e64 2075 7365 7220 3d3d 2072 6376 722e  nd user == rcvr.
-0000f6f0: 7573 6572 5f69 640a 2020 2020 2020 2020  user_id.        
-0000f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f710: 6f72 2073 686f 7274 5f75 7365 725f 6e61  or short_user_na
-0000f720: 6d65 5f74 6f5f 7573 6572 5f69 6428 7573  me_to_user_id(us
-0000f730: 6572 2c20 6372 6564 656e 7469 616c 7329  er, credentials)
-0000f740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f750: 2020 2020 2020 2020 203d 3d20 7263 7672           == rcvr
-0000f760: 2e75 7365 725f 6964 0a20 2020 2020 2020  .user_id.       
-0000f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f780: 206f 7220 7573 6572 203d 3d20 7263 7672   or user == rcvr
-0000f790: 2e64 6973 706c 6179 5f6e 616d 650a 2020  .display_name.  
-0000f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7b0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0000f7c0: 2020 2020 2020 2020 2020 2020 2072 6f6f               roo
-0000f7d0: 6d5f 666f 756e 645f 666f 725f 7573 6572  m_found_for_user
-0000f7e0: 732e 6170 7065 6e64 2875 7365 7229 0a20  s.append(user). 
-0000f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f800: 2020 2020 2020 2072 6f6f 6d73 2e61 7070         rooms.app
-0000f810: 656e 6428 7265 7370 2e72 6f6f 6d5f 6964  end(resp.room_id
-0000f820: 290a 2020 2020 666f 7220 7573 6572 2069  ).    for user i
-0000f830: 6e20 7573 6572 733a 0a20 2020 2020 2020  n users:.       
-0000f840: 2069 6620 7573 6572 206e 6f74 2069 6e20   if user not in 
-0000f850: 726f 6f6d 5f66 6f75 6e64 5f66 6f72 5f75  room_found_for_u
-0000f860: 7365 7273 3a0a 2020 2020 2020 2020 2020  sers:.          
-0000f870: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-0000f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f890: 2245 3132 303a 2022 0a20 2020 2020 2020  "E120: ".       
-0000f8a0: 2020 2020 2020 2020 2022 526f 6f6d 2873           "Room(s
-0000f8b0: 2920 7765 7265 2073 7065 6369 6669 6564  ) were specified
-0000f8c0: 2066 6f72 2061 2044 4d20 2864 6972 6563   for a DM (direc
-0000f8d0: 7420 6d65 7373 6167 696e 6729 2022 0a20  t messaging) ". 
-0000f8e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000f8f0: 7365 6e64 206f 7065 7261 7469 6f6e 2076  send operation v
-0000f900: 6961 202d 2d72 6f6f 6d2e 2042 7574 206e  ia --room. But n
-0000f910: 6f20 444d 2072 6f6f 6d20 7761 7320 220a  o DM room was ".
-0000f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f930: 6622 666f 756e 6420 666f 7220 7573 6572  f"found for user
-0000f940: 2027 7b75 7365 727d 272e 2022 0a20 2020   '{user}'. ".   
-0000f950: 2020 2020 2020 2020 2020 2020 2022 5472               "Tr
-0000f960: 7920 7365 7474 696e 6720 7570 2061 2072  y setting up a r
-0000f970: 6f6f 6d20 6669 7273 7420 7669 6120 2d2d  oom first via --
-0000f980: 726f 6f6d 2d63 7265 6174 6520 616e 6420  room-create and 
-0000f990: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000f9a0: 2020 222d 2d72 6f6f 6d2d 696e 7669 7465    "--room-invite
-0000f9b0: 206f 7074 696f 6e20 6f72 202d 2d72 6f6f   option or --roo
-0000f9c0: 6d2d 646d 2d63 7265 6174 652e 220a 2020  m-dm-create.".  
-0000f9d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000f9e0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-0000f9f0: 6f75 6e74 202b 3d20 310a 2020 2020 726f  ount += 1.    ro
-0000fa00: 6f6d 7320 3d20 6c69 7374 2864 6963 742e  oms = list(dict.
-0000fa10: 6672 6f6d 6b65 7973 2872 6f6f 6d73 2929  fromkeys(rooms))
-0000fa20: 2020 2320 7265 6d6f 7665 2064 7570 6c69    # remove dupli
-0000fa30: 6361 7465 7320 696e 206c 6973 740a 2020  cates in list.  
-0000fa40: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-0000fa50: 2252 6f6f 6d28 7329 2066 726f 6d20 2d2d  "Room(s) from --
-0000fa60: 7573 6572 3a20 7b72 6f6f 6d73 7d22 290a  user: {rooms}").
-0000fa70: 2020 2020 7265 7475 726e 2072 6f6f 6d73      return rooms
-0000fa80: 0a0a 0a61 7379 6e63 2064 6566 2064 6574  ...async def det
-0000fa90: 6572 6d69 6e65 5f72 6f6f 6d73 280a 2020  ermine_rooms(.  
-0000faa0: 2020 726f 6f6d 5f69 643a 2073 7472 2c20    room_id: str, 
-0000fab0: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-0000fac0: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-0000fad0: 3a20 6469 6374 0a29 202d 3e20 6c69 7374  : dict.) -> list
-0000fae0: 3a0a 2020 2020 2222 2244 6574 6572 6d69  :.    """Determi
-0000faf0: 6e65 2074 6865 2072 6f6f 6d20 746f 2073  ne the room to s
-0000fb00: 656e 6420 746f 2e0a 0a20 2020 2041 7267  end to...    Arg
-0000fb10: 756d 656e 7473 3a0a 2020 2020 2d2d 2d2d  uments:.    ----
-0000fb20: 2d2d 2d2d 2d0a 2020 2020 726f 6f6d 5f69  -----.    room_i
-0000fb30: 6420 3a20 726f 6f6d 2066 726f 6d20 6372  d : room from cr
-0000fb40: 6564 656e 7469 616c 7320 6669 6c65 0a0a  edentials file..
-0000fb50: 2020 2020 4c6f 6f6b 2061 7420 726f 6f6d      Look at room
-0000fb60: 2066 726f 6d20 6372 6564 656e 7469 616c   from credential
-0000fb70: 7320 6669 6c65 2061 6e64 2061 7420 726f  s file and at ro
-0000fb80: 6f6d 7320 6672 6f6d 2063 6f6d 6d61 6e64  oms from command
-0000fb90: 206c 696e 650a 2020 2020 616e 6420 7072   line.    and pr
-0000fba0: 6570 6172 6573 2061 2064 6566 696e 6974  epares a definit
-0000fbb0: 6520 6c69 7374 206f 6620 726f 6f6d 732e  e list of rooms.
-0000fbc0: 0a0a 2020 2020 4e65 773a 2041 6c73 6f20  ..    New: Also 
-0000fbd0: 6c6f 6f6b 2061 7420 2d2d 7573 6572 2e20  look at --user. 
-0000fbe0: 466f 7220 444d 2028 6469 7265 6374 206d  For DM (direct m
-0000fbf0: 6573 7361 6769 6e67 292c 2064 6573 7469  essaging), desti
-0000fc00: 6e61 7469 6f6e 730a 2020 2020 6172 6520  nations.    are 
-0000fc10: 7370 6563 6966 6965 6420 7669 6120 2d2d  specified via --
-0000fc20: 7573 6572 2e20 466f 7220 6576 6572 7920  user. For every 
-0000fc30: 7573 6572 2066 6f75 6e64 2c20 7365 6520  user found, see 
-0000fc40: 6966 2074 6865 7265 2069 7320 610a 2020  if there is a.  
-0000fc50: 2020 2244 4d22 2072 6f6f 6d2c 2061 2072    "DM" room, a r
-0000fc60: 6f6f 6d20 7769 7468 206f 6e6c 7920 3220  oom with only 2 
-0000fc70: 6d65 6d62 6572 7320 2873 656e 6465 7220  members (sender 
-0000fc80: 616e 6420 7265 6369 7069 656e 7429 2e0a  and recipient)..
-0000fc90: 2020 2020 4966 2073 7563 6820 6120 2244      If such a "D
-0000fca0: 4d22 2072 6f6f 6d20 6973 2066 6f75 6e64  M" room is found
-0000fcb0: 2c20 6164 6420 6974 2074 6f20 7468 6520  , add it to the 
-0000fcc0: 6765 6e65 7261 6c20 726f 6f6d 7320 6c69  general rooms li
-0000fcd0: 7374 0a20 2020 2074 6861 7420 6973 2072  st.    that is r
-0000fce0: 6574 7572 6e65 642e 0a0a 2020 2020 4d69  eturned...    Mi
-0000fcf0: 7869 6e67 2061 6e64 206d 6174 6368 696e  xing and matchin
-0000fd00: 6720 6f66 202d 2d72 6f6f 6d20 616e 6420  g of --room and 
-0000fd10: 2d2d 7573 6572 2069 7320 706f 7373 6962  --user is possib
-0000fd20: 6c65 2e0a 2020 2020 2d2d 726f 6f6d 2052  le..    --room R
-0000fd30: 3120 5232 202d 2d75 7365 7220 5531 2055  1 R2 --user U1 U
-0000fd40: 3220 6d69 6768 7420 6c65 6164 2074 6f20  2 might lead to 
-0000fd50: 3420 726f 6f6d 7320 696e 2074 6f74 616c  4 rooms in total
-0000fd60: 2e0a 2020 2020 4966 206e 6f20 2244 4d22  ..    If no "DM"
-0000fd70: 2072 6f6f 6d20 6973 2066 6f75 6e64 2074   room is found t
-0000fd80: 6865 6e20 6769 7665 2065 7272 6f72 2061  hen give error a
-0000fd90: 6e64 2074 656c 6c20 7573 6572 2074 6f20  nd tell user to 
-0000fda0: 646f 0a20 2020 202d 2d72 6f6f 6d2d 696e  do.    --room-in
-0000fdb0: 7669 7465 2066 6972 7374 2e0a 0a20 2020  vite first...   
-0000fdc0: 2052 6574 7572 6e20 6c69 7374 206f 6620   Return list of 
-0000fdd0: 726f 6f6d 7320 746f 2073 656e 6420 746f  rooms to send to
-0000fde0: 2e20 5265 7475 726e 6564 206c 6973 7420  . Returned list 
-0000fdf0: 6973 206e 6576 6572 2065 6d70 7479 2e0a  is never empty..
-0000fe00: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-0000fe10: 6e6f 7420 6773 2e70 612e 726f 6f6d 2061  not gs.pa.room a
-0000fe20: 6e64 206e 6f74 2067 732e 7061 2e75 7365  nd not gs.pa.use
-0000fe30: 723a 0a20 2020 2020 2020 2067 732e 6c6f  r:.        gs.lo
-0000fe40: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-0000fe50: 2020 2020 2022 526f 6f6d 2069 6420 7761       "Room id wa
-0000fe60: 7320 7072 6f76 6964 6564 2076 6961 2063  s provided via c
-0000fe70: 7265 6465 6e74 6961 6c73 2066 696c 652e  redentials file.
-0000fe80: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0000fe90: 4e6f 2072 6f6f 6d73 2067 6976 656e 2069  No rooms given i
-0000fea0: 6e20 636f 6d6d 616e 6473 206c 696e 652e  n commands line.
-0000feb0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0000fec0: 4e6f 2075 7365 7273 2067 6976 656e 2069  No users given i
-0000fed0: 6e20 636f 6d6d 616e 6420 6c69 6e65 2066  n command line f
-0000fee0: 6f72 2044 4d20 726f 6f6d 732e 2022 0a20  or DM rooms. ". 
-0000fef0: 2020 2020 2020 2020 2020 2066 2753 6574             f'Set
-0000ff00: 7469 6e67 2072 6f6f 6d73 2074 6f20 227b  ting rooms to "{
-0000ff10: 726f 6f6d 5f69 647d 222e 270a 2020 2020  room_id}".'.    
-0000ff20: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-0000ff30: 7475 726e 205b 726f 6f6d 5f69 645d 2020  turn [room_id]  
-0000ff40: 2320 6c69 7374 206f 6620 310a 2020 2020  # list of 1.    
-0000ff50: 726f 6f6d 7320 3d20 5b5d 0a20 2020 2069  rooms = [].    i
-0000ff60: 6620 6773 2e70 612e 726f 6f6d 3a0a 2020  f gs.pa.room:.  
-0000ff70: 2020 2020 2020 666f 7220 726f 6f6d 2069        for room i
-0000ff80: 6e20 6773 2e70 612e 726f 6f6d 3a0a 2020  n gs.pa.room:.  
-0000ff90: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
-0000ffa0: 6420 3d20 726f 6f6d 2e72 6570 6c61 6365  d = room.replace
-0000ffb0: 2872 225c 2122 2c20 2221 2229 2020 2320  (r"\!", "!")  # 
-0000ffc0: 7265 6d6f 7665 2070 6f73 7369 626c 6520  remove possible 
-0000ffd0: 6573 6361 7065 0a20 2020 2020 2020 2020  escape.         
-0000ffe0: 2020 2072 6f6f 6d73 2e61 7070 656e 6428     rooms.append(
-0000fff0: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
-00010000: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-00010010: 526f 6f6d 2873 2920 6672 6f6d 202d 2d72  Room(s) from --r
-00010020: 6f6f 6d3a 207b 726f 6f6d 737d 2229 0a20  oom: {rooms}"). 
-00010030: 2020 2072 6f6f 6d73 202b 3d20 6177 6169     rooms += awai
-00010040: 7420 6465 7465 726d 696e 655f 646d 5f72  t determine_dm_r
-00010050: 6f6f 6d73 2867 732e 7061 2e75 7365 722c  ooms(gs.pa.user,
-00010060: 2063 6c69 656e 742c 2063 7265 6465 6e74   client, credent
-00010070: 6961 6c73 290a 2020 2020 6773 2e6c 6f67  ials).    gs.log
-00010080: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00010090: 2252 6f6f 6d28 7329 206f 7220 7573 6572  "Room(s) or user
-000100a0: 2873 2920 7765 7265 2070 726f 7669 6465  (s) were provide
-000100b0: 6420 7669 6120 636f 6d6d 616e 6420 6c69  d via command li
-000100c0: 6e65 2e20 220a 2020 2020 2020 2020 224f  ne. ".        "O
-000100d0: 7665 7277 7269 7469 6e67 2072 6f6f 6d20  verwriting room 
-000100e0: 6964 2066 726f 6d20 6372 6564 656e 7469  id from credenti
-000100f0: 616c 7320 6669 6c65 2022 0a20 2020 2020  als file ".     
-00010100: 2020 2066 2777 6974 6820 726f 6f6d 7320     f'with rooms 
-00010110: 227b 726f 6f6d 737d 2220 270a 2020 2020  "{rooms}" '.    
-00010120: 2020 2020 2266 726f 6d20 636f 6d6d 616e      "from comman
-00010130: 6420 6c69 6e65 2e22 0a20 2020 2029 0a20  d line.".    ). 
-00010140: 2020 2072 6574 7572 6e20 726f 6f6d 730a     return rooms.
-00010150: 0a0a 6173 796e 6320 6465 6620 6d61 705f  ..async def map_
-00010160: 726f 6f6d 696e 666f 5f74 6f5f 726f 6f6d  roominfo_to_room
-00010170: 6964 2863 6c69 656e 743a 2041 7379 6e63  id(client: Async
-00010180: 436c 6965 6e74 2c20 696e 666f 3a20 7374  Client, info: st
-00010190: 7229 202d 3e20 7374 723a 0a20 2020 2022  r) -> str:.    "
-000101a0: 2222 4174 7465 6d70 7420 746f 2063 6f6e  ""Attempt to con
-000101b0: 7665 7274 2072 6f6f 6d20 696e 666f 2074  vert room info t
-000101c0: 6f20 726f 6f6d 5f69 642e 0a0a 2020 2020  o room_id...    
-000101d0: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
-000101e0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6c69  --------.    cli
-000101f0: 656e 7420 3a20 6e69 6f20 636c 6965 6e74  ent : nio client
-00010200: 0a20 2020 2069 6e66 6f20 3a20 7374 720a  .    info : str.
-00010210: 2020 2020 2020 2020 6361 6e20 6265 2061          can be a
-00010220: 2063 616e 6f6e 6963 616c 2061 6c69 6173   canonical alias
-00010230: 2069 6e20 7468 6520 666f 726d 206f 6620   in the form of 
-00010240: 2723 736f 6d65 526f 6f6d 416c 6961 733a  '#someRoomAlias:
-00010250: 6578 616d 706c 652e 636f 6d27 0a20 2020  example.com'.   
-00010260: 2020 2020 2063 616e 2062 6520 6120 6361       can be a ca
-00010270: 6e6f 6e69 6361 6c20 726f 6f6d 5f69 6420  nonical room_id 
-00010280: 696e 2074 6865 2066 6f72 6d20 6f66 2027  in the form of '
-00010290: 2173 6f6d 6552 6f6f 6d49 643a 6578 616d  !someRoomId:exam
-000102a0: 706c 652e 636f 6d27 0a20 2020 2020 2020  ple.com'.       
-000102b0: 2063 616e 2062 6520 6120 7368 6f72 7420   can be a short 
-000102c0: 616c 6961 7320 696e 2074 6865 2066 6f72  alias in the for
-000102d0: 6d20 6f66 2027 736f 6d65 526f 6f6d 416c  m of 'someRoomAl
-000102e0: 6961 7327 0a20 2020 2020 2020 2063 616e  ias'.        can
-000102f0: 2062 6520 6120 7368 6f72 7420 616c 6961   be a short alia
-00010300: 7320 696e 2074 6865 2066 6f72 6d20 6f66  s in the form of
-00010310: 2027 2373 6f6d 6552 6f6f 6d41 6c69 6173   '#someRoomAlias
-00010320: 270a 2020 2020 2020 2020 6361 6e20 6265  '.        can be
-00010330: 2061 2073 686f 7274 2072 6f6f 6d20 6964   a short room id
-00010340: 2069 6e20 7468 6520 666f 726d 206f 6620   in the form of 
-00010350: 2721 736f 6d65 526f 6f6d 4964 270a 0a20  '!someRoomId'.. 
-00010360: 2020 2052 6574 7572 6e20 636f 7272 6573     Return corres
-00010370: 706f 6e64 696e 6720 6675 6c6c 2072 6f6f  ponding full roo
-00010380: 6d5f 6964 2028 2169 643a 7361 6d70 6c65  m_id (!id:sample
-00010390: 2e63 6f6d 2920 6f72 206f 7220 7261 6973  .com) or or rais
-000103a0: 6573 2065 7863 6570 7469 6f6e 2e0a 0a20  es exception... 
-000103b0: 2020 2022 2222 0a20 2020 2072 6920 3d20     """.    ri = 
-000103c0: 696e 666f 2e73 7472 6970 2829 0a20 2020  info.strip().   
-000103d0: 2072 6920 3d20 7269 2e72 6570 6c61 6365   ri = ri.replace
-000103e0: 2872 225c 2122 2c20 2221 2229 2020 2320  (r"\!", "!")  # 
-000103f0: 7265 6d6f 7665 2070 6f73 7369 626c 6520  remove possible 
-00010400: 6573 6361 7065 0a20 2020 2069 6620 280a  escape.    if (.
-00010410: 2020 2020 2020 2020 7269 2069 6e20 284e          ri in (N
-00010420: 6f6e 652c 2022 222c 2022 2122 2c20 2223  one, "", "!", "#
-00010430: 2229 0a20 2020 2020 2020 206f 7220 7269  ").        or ri
-00010440: 2e73 7461 7274 7377 6974 6828 223a 2229  .startswith(":")
-00010450: 0a20 2020 2020 2020 206f 7220 7269 2e63  .        or ri.c
-00010460: 6f75 6e74 2822 3a22 2920 3e20 310a 2020  ount(":") > 1.  
-00010470: 2020 2020 2020 6f72 2072 692e 7374 6172        or ri.star
-00010480: 7473 7769 7468 2822 4022 290a 2020 2020  tswith("@").    
-00010490: 2020 2020 6f72 2022 2322 2069 6e20 7269      or "#" in ri
-000104a0: 5b31 3a5d 0a20 2020 2020 2020 206f 7220  [1:].        or 
-000104b0: 616e 7928 656c 656d 2069 6e20 7269 2066  any(elem in ri f
-000104c0: 6f72 2065 6c65 6d20 696e 2022 5b5d 7b7d  or elem in "[]{}
-000104d0: 2022 2920 2023 2064 6f65 7320 6974 2063   ")  # does it c
-000104e0: 6f6e 7461 696e 2062 6164 2063 6861 7273  ontain bad chars
-000104f0: 3f0a 2020 2020 2020 2020 6f72 2028 0a20  ?.        or (. 
-00010500: 2020 2020 2020 2020 2020 206e 6f74 2072             not r
-00010510: 692e 7374 6172 7473 7769 7468 2822 2122  i.startswith("!"
-00010520: 2920 616e 6420 6e6f 7420 7269 2e73 7461  ) and not ri.sta
-00010530: 7274 7377 6974 6828 2223 2229 2061 6e64  rtswith("#") and
-00010540: 2022 3a22 2069 6e20 7269 0a20 2020 2020   ":" in ri.     
-00010550: 2020 2029 2020 2320 616c 6961 733a 7361     )  # alias:sa
-00010560: 6d70 6c65 2e63 6f6d 0a20 2020 2029 3a0a  mple.com.    ):.
-00010570: 2020 2020 2020 2020 6572 7220 3d20 280a          err = (.
-00010580: 2020 2020 2020 2020 2020 2020 2245 3132              "E12
-00010590: 313a 2022 0a20 2020 2020 2020 2020 2020  1: ".           
-000105a0: 2066 2249 6e76 616c 6964 2072 6f6f 6d20   f"Invalid room 
-000105b0: 7370 6563 6966 6963 6174 696f 6e2e 2027  specification. '
-000105c0: 7b69 6e66 6f7d 2720 287b 7269 7d29 2069  {info}' ({ri}) i
-000105d0: 7320 6e65 6974 6865 7220 220a 2020 2020  s neither ".    
-000105e0: 2020 2020 2020 2020 2261 2076 616c 6964          "a valid
-000105f0: 2072 6f6f 6d20 6964 206e 6f72 2061 2076   room id nor a v
-00010600: 616c 6964 2072 6f6f 6d20 616c 6961 732e  alid room alias.
-00010610: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00010620: 2020 2020 7261 6973 6520 4d61 7472 6978      raise Matrix
-00010630: 436f 6d6d 616e 6465 7245 7272 6f72 2865  CommanderError(e
-00010640: 7272 2920 6672 6f6d 204e 6f6e 650a 2020  rr) from None.  
-00010650: 2020 6966 206e 6f74 2072 692e 7374 6172    if not ri.star
-00010660: 7473 7769 7468 2822 2122 293a 0a20 2020  tswith("!"):.   
-00010670: 2020 2020 2023 2027 736f 6d65 526f 6f6d       # 'someRoom
-00010680: 416c 6961 7327 206f 7220 2723 736f 6d65  Alias' or '#some
-00010690: 526f 6f6d 416c 6961 7327 206f 7220 2723  RoomAlias' or '#
-000106a0: 736f 6d65 526f 6f6d 416c 6961 733a 7361  someRoomAlias:sa
-000106b0: 6d70 6c65 2e63 6f6d 270a 2020 2020 2020  mple.com'.      
-000106c0: 2020 6966 2022 3a22 206e 6f74 2069 6e20    if ":" not in 
-000106d0: 7269 3a20 2023 2027 736f 6d65 526f 6f6d  ri:  # 'someRoom
-000106e0: 416c 6961 7327 206f 7220 2723 736f 6d65  Alias' or '#some
-000106f0: 526f 6f6d 416c 6961 7327 0a20 2020 2020  RoomAlias'.     
-00010700: 2020 2020 2020 2072 6920 3d20 7368 6f72         ri = shor
-00010710: 745f 726f 6f6d 5f61 6c69 6173 5f74 6f5f  t_room_alias_to_
-00010720: 726f 6f6d 5f61 6c69 6173 2872 692c 2067  room_alias(ri, g
-00010730: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00010740: 2020 2020 2020 2072 6920 3d20 6177 6169         ri = awai
-00010750: 7420 6d61 705f 726f 6f6d 616c 6961 735f  t map_roomalias_
-00010760: 746f 5f72 6f6f 6d69 6428 636c 6965 6e74  to_roomid(client
-00010770: 2c20 7269 290a 2020 2020 2020 2020 7265  , ri).        re
-00010780: 7475 726e 2072 690a 2020 2020 6966 2022  turn ri.    if "
-00010790: 3a22 206e 6f74 2069 6e20 7269 3a0a 2020  :" not in ri:.  
-000107a0: 2020 2020 2020 2320 2721 736f 6d65 526f        # '!someRo
-000107b0: 6f6d 4964 270a 2020 2020 2020 2020 7269  omId'.        ri
-000107c0: 203d 2072 6920 2b20 223a 2220 2b20 6465   = ri + ":" + de
-000107d0: 6661 756c 745f 686f 6d65 7365 7276 6572  fault_homeserver
-000107e0: 2867 732e 6372 6564 656e 7469 616c 7329  (gs.credentials)
-000107f0: 0a20 2020 2072 6574 7572 6e20 7269 0a0a  .    return ri..
-00010800: 0a61 7379 6e63 2064 6566 206d 6170 5f72  .async def map_r
-00010810: 6f6f 6d61 6c69 6173 5f74 6f5f 726f 6f6d  oomalias_to_room
-00010820: 6964 2863 6c69 656e 742c 2061 6c69 6173  id(client, alias
-00010830: 2920 2d3e 2073 7472 3a0a 2020 2020 2222  ) -> str:.    ""
-00010840: 2241 7474 656d 7074 2074 6f20 636f 6e76  "Attempt to conv
-00010850: 6572 7420 726f 6f6d 2061 6c69 6173 2074  ert room alias t
-00010860: 6f20 726f 6f6d 5f69 642e 0a0a 2020 2020  o room_id...    
-00010870: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
-00010880: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6c69  --------.    cli
-00010890: 656e 7420 3a20 6e69 6f20 636c 6965 6e74  ent : nio client
-000108a0: 0a20 2020 2061 6c69 6173 203a 2063 616e  .    alias : can
-000108b0: 2062 6520 616e 2061 6c69 6173 2069 6e20   be an alias in 
-000108c0: 7468 6520 666f 726d 206f 6620 2723 736f  the form of '#so
-000108d0: 6d65 526f 6f6d 416c 6961 733a 6578 616d  meRoomAlias:exam
-000108e0: 706c 652e 636f 6d27 0a20 2020 2020 2020  ple.com'.       
-000108f0: 2063 616e 2061 6c73 6f20 6265 2061 2072   can also be a r
-00010900: 6f6f 6d5f 6964 2069 6e20 7468 6520 666f  oom_id in the fo
-00010910: 726d 206f 6620 2721 736f 6d65 526f 6f6d  rm of '!someRoom
-00010920: 4964 3a65 7861 6d70 6c65 2e63 6f6d 270a  Id:example.com'.
-00010930: 0a20 2020 2072 6f6f 6d5f 6964 203a 2072  .    room_id : r
-00010940: 6f6f 6d20 6672 6f6d 2063 7265 6465 6e74  oom from credent
-00010950: 6961 6c73 2066 696c 650a 0a20 2020 2049  ials file..    I
-00010960: 6620 616e 2061 6c69 6173 2074 7279 2074  f an alias try t
-00010970: 6f20 6765 7420 7468 6520 636f 7272 6573  o get the corres
-00010980: 706f 6e64 696e 6720 726f 6f6d 5f69 642e  ponding room_id.
-00010990: 0a20 2020 2049 6620 616e 7974 6869 6e67  .    If anything
-000109a0: 2066 6169 6c73 2069 7420 7265 7475 726e   fails it return
-000109b0: 7320 7468 6520 6f72 6967 696e 616c 2069  s the original i
-000109c0: 6e70 7574 2e0a 0a20 2020 2052 6574 7572  nput...    Retur
-000109d0: 6e20 636f 7272 6573 706f 6e64 696e 6720  n corresponding 
-000109e0: 726f 6f6d 5f69 6420 6f72 206f 6e20 6661  room_id or on fa
-000109f0: 696c 7572 6520 7468 6520 6f72 6967 696e  ilure the origin
-00010a00: 616c 2061 6c69 6173 2e0a 0a20 2020 2022  al alias...    "
-00010a10: 2222 0a20 2020 2072 6574 203d 2061 6c69  "".    ret = ali
-00010a20: 6173 0a20 2020 2069 6620 6973 5f72 6f6f  as.    if is_roo
-00010a30: 6d5f 616c 6961 7328 616c 6961 7329 3a0a  m_alias(alias):.
-00010a40: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-00010a50: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
-00010a60: 5f72 6573 6f6c 7665 5f61 6c69 6173 2861  _resolve_alias(a
-00010a70: 6c69 6173 290a 2020 2020 2020 2020 6966  lias).        if
-00010a80: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-00010a90: 2c20 526f 6f6d 5265 736f 6c76 6541 6c69  , RoomResolveAli
-00010aa0: 6173 4572 726f 7229 3a0a 2020 2020 2020  asError):.      
-00010ab0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-00010ac0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00010ad0: 2020 2020 2245 3132 323a 2022 0a20 2020      "E122: ".   
-00010ae0: 2020 2020 2020 2020 2020 2020 2066 2272               f"r
-00010af0: 6f6f 6d5f 7265 736f 6c76 655f 616c 6961  oom_resolve_alia
-00010b00: 7320 666f 7220 616c 6961 7320 7b61 6c69  s for alias {ali
-00010b10: 6173 7d20 6661 696c 6564 2077 6974 6820  as} failed with 
-00010b20: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00010b30: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
-00010b40: 7465 7228 7374 7228 7265 7370 2929 7d2e  ter(str(resp))}.
-00010b50: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00010b60: 2020 2066 2254 7279 696e 6720 6f70 6572     f"Trying oper
-00010b70: 6174 696f 6e20 7769 7468 2069 6e70 7574  ation with input
-00010b80: 207b 616c 6961 737d 2061 6e79 7761 792e   {alias} anyway.
-00010b90: 204d 6967 6874 2066 6169 6c2e 220a 2020   Might fail.".  
-00010ba0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00010bb0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-00010bc0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-00010bd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010be0: 2020 2020 7265 7420 3d20 7265 7370 2e72      ret = resp.r
-00010bf0: 6f6f 6d5f 6964 0a20 2020 2020 2020 2020  oom_id.         
-00010c00: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00010c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010c20: 2066 274d 6170 7065 6420 726f 6f6d 2061   f'Mapped room a
-00010c30: 6c69 6173 2022 7b61 6c69 6173 7d22 2074  lias "{alias}" t
-00010c40: 6f20 726f 6f6d 2069 6420 227b 7265 747d  o room id "{ret}
-00010c50: 222e 2027 0a20 2020 2020 2020 2020 2020  ". '.           
-00010c60: 2020 2020 2066 2228 7b72 6573 702e 726f       f"({resp.ro
-00010c70: 6f6d 5f61 6c69 6173 7d2c 207b 7265 7370  om_alias}, {resp
-00010c80: 2e72 6f6f 6d5f 6964 7d29 2e22 0a20 2020  .room_id}).".   
-00010c90: 2020 2020 2020 2020 2029 0a20 2020 2072           ).    r
-00010ca0: 6574 7572 6e20 7265 740a 0a0a 6465 6620  eturn ret...def 
-00010cb0: 6465 6661 756c 745f 686f 6d65 7365 7276  default_homeserv
-00010cc0: 6572 2863 7265 6465 6e74 6961 6c73 3a20  er(credentials: 
-00010cd0: 6469 6374 293a 0a20 2020 2022 2222 4765  dict):.    """Ge
-00010ce0: 7420 7468 6520 6465 6661 756c 7420 686f  t the default ho
-00010cf0: 6d65 7365 7276 6572 2028 646f 6d61 696e  meserver (domain
-00010d00: 2920 6672 6f6d 2074 6865 2063 7265 6465  ) from the crede
-00010d10: 6e74 6961 6c73 2066 696c 652e 0a20 2020  ntials file..   
-00010d20: 2055 7365 2074 6865 2075 7365 725f 6964   Use the user_id
-00010d30: 2c20 6e6f 7420 7468 6520 726f 6f6d 5f69  , not the room_i
-00010d40: 642e 2054 6865 2072 6f6f 6d5f 6964 2063  d. The room_id c
-00010d50: 6f75 6c64 2062 6520 6f6e 2061 0a20 2020  ould be on a.   
-00010d60: 2064 6966 6665 7265 6e74 2073 6572 7665   different serve
-00010d70: 7220 6f77 6e65 6420 6279 2073 6f6d 656f  r owned by someo
-00010d80: 6e65 2065 6c73 652e 2075 7365 725f 6964  ne else. user_id
-00010d90: 206d 616b 6573 206d 6f72 6520 7365 6e73   makes more sens
-00010da0: 652e 0a20 2020 2022 2222 0a20 2020 2075  e..    """.    u
-00010db0: 7365 7220 3d20 6372 6564 656e 7469 616c  ser = credential
-00010dc0: 735b 2275 7365 725f 6964 225d 2020 2320  s["user_id"]  # 
-00010dd0: 7768 6f20 616d 2069 0a20 2020 2068 6f6d  who am i.    hom
-00010de0: 6573 6572 7665 7220 3d20 7573 6572 2e70  eserver = user.p
-00010df0: 6172 7469 7469 6f6e 2822 3a22 295b 325d  artition(":")[2]
-00010e00: 0a20 2020 2072 6574 7572 6e20 686f 6d65  .    return home
-00010e10: 7365 7276 6572 2020 2320 6d61 7472 6978  server  # matrix
-00010e20: 2e65 7861 6d70 6c65 2e63 6f6d 0a0a 0a64  .example.com...d
-00010e30: 6566 2073 686f 7274 5f72 6f6f 6d5f 616c  ef short_room_al
-00010e40: 6961 735f 746f 5f72 6f6f 6d5f 616c 6961  ias_to_room_alia
-00010e50: 7328 7368 6f72 745f 726f 6f6d 5f61 6c69  s(short_room_ali
-00010e60: 6173 3a20 7374 722c 2063 7265 6465 6e74  as: str, credent
-00010e70: 6961 6c73 3a20 6469 6374 293a 0a20 2020  ials: dict):.   
-00010e80: 2022 2222 436f 6e76 6572 7420 2753 6f6d   """Convert 'Som
-00010e90: 6552 6f6f 6d41 6c69 6173 2720 746f 2027  eRoomAlias' to '
-00010ea0: 2723 536f 6d65 546f 6f6d 416c 6961 733a  '#SomeToomAlias:
-00010eb0: 6d61 7472 6978 2e65 7861 6d70 6c65 2e63  matrix.example.c
-00010ec0: 6f6d 272e 0a20 2020 2043 6f6e 7665 7274  om'..    Convert
-00010ed0: 7320 7368 6f72 7420 6361 6e6f 6e69 6361  s short canonica
-00010ee0: 6c20 6c6f 6361 6c20 726f 6f6d 2061 6c69  l local room ali
-00010ef0: 6173 2074 6f20 6675 6c6c 2072 6f6f 6d20  as to full room 
-00010f00: 616c 6961 732e 0a20 2020 2022 2222 0a20  alias..    """. 
-00010f10: 2020 2069 6620 7368 6f72 745f 726f 6f6d     if short_room
-00010f20: 5f61 6c69 6173 2069 6e20 284e 6f6e 652c  _alias in (None,
-00010f30: 2022 2229 3a0a 2020 2020 2020 2020 6572   ""):.        er
-00010f40: 7220 3d20 2245 3132 343a 2022 2022 496e  r = "E124: " "In
-00010f50: 7661 6c69 6420 726f 6f6d 2061 6c69 6173  valid room alias
-00010f60: 2e20 416c 6961 7320 6973 206e 6f6e 6520  . Alias is none 
-00010f70: 6f72 2065 6d70 7479 2e22 0a20 2020 2020  or empty.".     
-00010f80: 2020 2072 6169 7365 204d 6174 7269 7843     raise MatrixC
-00010f90: 6f6d 6d61 6e64 6572 4572 726f 7228 6572  ommanderError(er
-00010fa0: 7229 2066 726f 6d20 4e6f 6e65 0a20 2020  r) from None.   
-00010fb0: 2069 6620 7368 6f72 745f 726f 6f6d 5f61   if short_room_a
-00010fc0: 6c69 6173 5b30 5d20 3d3d 2022 2322 3a0a  lias[0] == "#":.
-00010fd0: 2020 2020 2020 2020 7265 7420 3d20 7368          ret = sh
-00010fe0: 6f72 745f 726f 6f6d 5f61 6c69 6173 202b  ort_room_alias +
-00010ff0: 2022 3a22 202b 2064 6566 6175 6c74 5f68   ":" + default_h
-00011000: 6f6d 6573 6572 7665 7228 6372 6564 656e  omeserver(creden
-00011010: 7469 616c 7329 0a20 2020 2065 6c73 653a  tials).    else:
-00011020: 0a20 2020 2020 2020 2072 6574 203d 2022  .        ret = "
-00011030: 2322 202b 2073 686f 7274 5f72 6f6f 6d5f  #" + short_room_
-00011040: 616c 6961 7320 2b20 223a 2220 2b20 6465  alias + ":" + de
-00011050: 6661 756c 745f 686f 6d65 7365 7276 6572  fault_homeserver
-00011060: 2863 7265 6465 6e74 6961 6c73 290a 2020  (credentials).  
-00011070: 2020 7265 7475 726e 2072 6574 0a0a 0a64    return ret...d
-00011080: 6566 2072 6f6f 6d5f 616c 6961 735f 746f  ef room_alias_to
-00011090: 5f73 686f 7274 5f72 6f6f 6d5f 616c 6961  _short_room_alia
-000110a0: 7328 726f 6f6d 5f61 6c69 6173 3a20 7374  s(room_alias: st
-000110b0: 722c 2063 7265 6465 6e74 6961 6c73 3a20  r, credentials: 
-000110c0: 6469 6374 293a 0a20 2020 2022 2222 436f  dict):.    """Co
-000110d0: 6e76 6572 7420 2723 536f 6d65 546f 6f6d  nvert '#SomeToom
-000110e0: 416c 6961 733a 6d61 7472 6978 2e65 7861  Alias:matrix.exa
-000110f0: 6d70 6c65 2e63 6f6d 2720 746f 2027 536f  mple.com' to 'So
-00011100: 6d65 526f 6f6d 416c 6961 7327 2e0a 2020  meRoomAlias'..  
-00011110: 2020 436f 6e76 6572 7473 2066 756c 6c20    Converts full 
-00011120: 726f 6f6d 2061 6c69 6173 2074 6f20 7368  room alias to sh
-00011130: 6f72 7420 6361 6e6f 6e69 6361 6c20 6c6f  ort canonical lo
-00011140: 6361 6c20 726f 6f6d 2061 6c69 6173 2e0a  cal room alias..
-00011150: 2020 2020 2222 220a 2020 2020 7265 7475      """.    retu
-00011160: 726e 2072 6f6f 6d5f 616c 6961 732e 7370  rn room_alias.sp
-00011170: 6c69 7428 223a 2229 5b30 5d5b 313a 5d0a  lit(":")[0][1:].
-00011180: 0a0a 6465 6620 7573 6572 5f69 645f 746f  ..def user_id_to
-00011190: 5f73 686f 7274 5f75 7365 725f 6e61 6d65  _short_user_name
-000111a0: 2875 7365 725f 6964 3a20 7374 7229 3a0a  (user_id: str):.
-000111b0: 2020 2020 2222 2243 6f6e 7665 7274 2027      """Convert '
-000111c0: 4073 6f6d 6575 7365 723a 6d61 7472 6978  @someuser:matrix
-000111d0: 2e65 7861 6d70 6c65 2e63 6f6d 2720 746f  .example.com' to
-000111e0: 2027 736f 6d65 7573 6572 272e 0a20 2020   'someuser'..   
-000111f0: 2043 6f6e 7665 7274 2066 756c 6c20 7573   Convert full us
-00011200: 6572 5f69 6420 746f 2075 7365 7220 6e69  er_id to user ni
-00011210: 636b 206e 616d 652e 0a20 2020 2022 2222  ck name..    """
-00011220: 0a20 2020 2072 6574 7572 6e20 7573 6572  .    return user
-00011230: 5f69 642e 7370 6c69 7428 223a 2229 5b30  _id.split(":")[0
-00011240: 5d5b 313a 5d0a 0a0a 6465 6620 7368 6f72  ][1:]...def shor
-00011250: 745f 7573 6572 5f6e 616d 655f 746f 5f75  t_user_name_to_u
-00011260: 7365 725f 6964 2873 686f 7274 5f75 7365  ser_id(short_use
-00011270: 723a 2073 7472 2c20 6372 6564 656e 7469  r: str, credenti
-00011280: 616c 733a 2064 6963 7429 3a0a 2020 2020  als: dict):.    
-00011290: 2222 2243 6f6e 7665 7274 2027 736f 6d65  """Convert 'some
-000112a0: 7573 6572 2720 746f 2027 4073 6f6d 6575  user' to '@someu
-000112b0: 7365 723a 6d61 7472 6978 2e65 7861 6d70  ser:matrix.examp
-000112c0: 6c65 2e63 6f6d 272e 0a20 2020 2043 6f6e  le.com'..    Con
-000112d0: 7665 7274 2075 7365 7220 6e69 636b 206e  vert user nick n
-000112e0: 616d 6520 746f 2066 756c 6c20 7573 6572  ame to full user
-000112f0: 5f69 642e 0a20 2020 2022 2222 0a20 2020  _id..    """.   
-00011300: 2072 6574 7572 6e20 2240 2220 2b20 7368   return "@" + sh
-00011310: 6f72 745f 7573 6572 202b 2022 3a22 202b  ort_user + ":" +
-00011320: 2064 6566 6175 6c74 5f68 6f6d 6573 6572   default_homeser
-00011330: 7665 7228 6372 6564 656e 7469 616c 7329  ver(credentials)
-00011340: 0a0a 0a64 6566 2069 735f 726f 6f6d 5f61  ...def is_room_a
-00011350: 6c69 6173 2872 6f6f 6d5f 6964 3a20 7374  lias(room_id: st
-00011360: 7229 202d 3e20 626f 6f6c 3a0a 2020 2020  r) -> bool:.    
-00011370: 2222 2244 6574 6572 6d69 6e65 2069 6620  """Determine if 
-00011380: 726f 6f6d 2069 6465 6e74 6966 6965 7220  room identifier 
-00011390: 6973 2061 2072 6f6f 6d20 616c 6961 732e  is a room alias.
-000113a0: 0a0a 2020 2020 526f 6f6d 2061 6c69 6173  ..    Room alias
-000113b0: 6573 2061 7265 206f 6620 7379 6e74 6178  es are of syntax
-000113c0: 3a20 2373 6f6d 6561 6c69 6173 3a73 6f6d  : #somealias:som
-000113d0: 6573 6572 7665 720a 2020 2020 5468 6973  eserver.    This
-000113e0: 2069 7320 6e6f 7420 616e 2065 7868 6175   is not an exhau
-000113f0: 7374 6976 6520 6368 6563 6b21 0a0a 2020  stive check!..  
-00011400: 2020 2222 220a 2020 2020 6966 2028 0a20    """.    if (. 
-00011410: 2020 2020 2020 2072 6f6f 6d5f 6964 0a20         room_id. 
-00011420: 2020 2020 2020 2061 6e64 206c 656e 2872         and len(r
-00011430: 6f6f 6d5f 6964 2920 3e20 330a 2020 2020  oom_id) > 3.    
-00011440: 2020 2020 616e 6420 2872 6f6f 6d5f 6964      and (room_id
-00011450: 5b30 5d20 3d3d 2022 2322 290a 2020 2020  [0] == "#").    
-00011460: 2020 2020 616e 6420 2822 2322 206e 6f74      and ("#" not
-00011470: 2069 6e20 726f 6f6d 5f69 645b 313a 5d29   in room_id[1:])
-00011480: 0a20 2020 2020 2020 2061 6e64 2028 223a  .        and (":
-00011490: 2220 696e 2072 6f6f 6d5f 6964 290a 2020  " in room_id).  
-000114a0: 2020 2020 2020 616e 6420 726f 6f6d 5f69        and room_i
-000114b0: 642e 636f 756e 7428 223a 2229 203d 3d20  d.count(":") == 
-000114c0: 310a 2020 2020 2020 2020 616e 6420 2822  1.        and ("
-000114d0: 2022 206e 6f74 2069 6e20 726f 6f6d 5f69   " not in room_i
-000114e0: 6429 0a20 2020 2020 2020 2061 6e64 206e  d).        and n
-000114f0: 6f74 2061 6e79 2865 6c65 6d20 696e 2072  ot any(elem in r
-00011500: 6f6f 6d5f 6964 2066 6f72 2065 6c65 6d20  oom_id for elem 
-00011510: 696e 2022 5b5d 7b7d 2022 2920 2023 2063  in "[]{} ")  # c
-00011520: 6f6e 7461 696e 7320 6261 6420 6368 6172  ontains bad char
-00011530: 733f 0a20 2020 2029 3a0a 2020 2020 2020  s?.    ):.      
-00011540: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
-00011550: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011560: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
-00011570: 6566 2069 735f 726f 6f6d 5f69 6428 726f  ef is_room_id(ro
-00011580: 6f6d 5f69 643a 2073 7472 2920 2d3e 2062  om_id: str) -> b
-00011590: 6f6f 6c3a 0a20 2020 2022 2222 4465 7465  ool:.    """Dete
-000115a0: 726d 696e 6520 6966 2072 6f6f 6d20 6964  rmine if room id
-000115b0: 656e 7469 6669 6572 2069 7320 6120 7661  entifier is a va
-000115c0: 6c69 6420 726f 6f6d 2069 642e 0a0a 2020  lid room id...  
-000115d0: 2020 526f 6f6d 2069 6473 2061 7265 206f    Room ids are o
-000115e0: 6620 7379 6e74 6178 3a20 2173 6f6d 6561  f syntax: !somea
-000115f0: 6c69 6173 3a73 6f6d 6573 6572 7665 720a  lias:someserver.
-00011600: 2020 2020 5468 6973 2069 7320 6e6f 7420      This is not 
-00011610: 616e 2065 7868 6175 7374 6976 6520 6368  an exhaustive ch
-00011620: 6563 6b21 0a0a 2020 2020 2222 220a 2020  eck!..    """.  
-00011630: 2020 6966 2028 0a20 2020 2020 2020 2072    if (.        r
-00011640: 6f6f 6d5f 6964 0a20 2020 2020 2020 2061  oom_id.        a
-00011650: 6e64 206c 656e 2872 6f6f 6d5f 6964 2920  nd len(room_id) 
-00011660: 3e20 330a 2020 2020 2020 2020 616e 6420  > 3.        and 
-00011670: 2872 6f6f 6d5f 6964 5b30 5d20 3d3d 2022  (room_id[0] == "
-00011680: 2122 290a 2020 2020 2020 2020 616e 6420  !").        and 
-00011690: 2822 2322 206e 6f74 2069 6e20 726f 6f6d  ("#" not in room
-000116a0: 5f69 6429 0a20 2020 2020 2020 2061 6e64  _id).        and
-000116b0: 2028 223a 2220 696e 2072 6f6f 6d5f 6964   (":" in room_id
-000116c0: 290a 2020 2020 2020 2020 616e 6420 726f  ).        and ro
-000116d0: 6f6d 5f69 642e 636f 756e 7428 223a 2229  om_id.count(":")
-000116e0: 203d 3d20 310a 2020 2020 2020 2020 616e   == 1.        an
-000116f0: 6420 2822 2022 206e 6f74 2069 6e20 726f  d (" " not in ro
-00011700: 6f6d 5f69 6429 0a20 2020 2029 3a0a 2020  om_id).    ):.  
-00011710: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00011720: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
-00011730: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-00011740: 0a0a 0a64 6566 2069 735f 726f 6f6d 2872  ...def is_room(r
-00011750: 6f6f 6d5f 6964 3a20 7374 7229 202d 3e20  oom_id: str) -> 
-00011760: 626f 6f6c 3a0a 2020 2020 2222 2244 6574  bool:.    """Det
-00011770: 6572 6d69 6e65 2069 6620 726f 6f6d 2069  ermine if room i
-00011780: 6420 6973 2061 2076 616c 6964 2072 6f6f  d is a valid roo
-00011790: 6d20 6964 206f 7220 6120 7661 6c69 6420  m id or a valid 
-000117a0: 726f 6f6d 2061 6c69 6173 2e0a 0a20 2020  room alias...   
-000117b0: 2054 6869 7320 6973 206e 6f74 2061 6e20   This is not an 
-000117c0: 6578 6861 7573 7469 7665 2063 6865 636b  exhaustive check
-000117d0: 210a 0a20 2020 2022 2222 0a20 2020 2072  !..    """.    r
-000117e0: 6574 7572 6e20 6973 5f72 6f6f 6d5f 6964  eturn is_room_id
-000117f0: 2872 6f6f 6d5f 6964 2920 6f72 2069 735f  (room_id) or is_
-00011800: 726f 6f6d 5f61 6c69 6173 2872 6f6f 6d5f  room_alias(room_
-00011810: 6964 290a 0a0a 6465 6620 6973 5f73 686f  id)...def is_sho
-00011820: 7274 5f72 6f6f 6d5f 616c 6961 7328 726f  rt_room_alias(ro
-00011830: 6f6d 5f69 643a 2073 7472 2920 2d3e 2062  om_id: str) -> b
-00011840: 6f6f 6c3a 0a20 2020 2022 2222 4465 7465  ool:.    """Dete
-00011850: 726d 696e 6520 6966 2072 6f6f 6d20 6964  rmine if room id
-00011860: 656e 7469 6669 6572 2069 7320 6120 6c6f  entifier is a lo
-00011870: 6361 6c20 7061 7274 206f 6620 6361 6e6f  cal part of cano
-00011880: 6e69 6361 6c20 726f 6f6d 2061 6c69 6173  nical room alias
-00011890: 2e0a 0a20 2020 204c 6f63 616c 2070 6172  ...    Local par
-000118a0: 7473 206f 6620 6361 6e6f 6e69 6361 6c20  ts of canonical 
-000118b0: 726f 6f6d 2061 6c69 6173 6573 2061 7265  room aliases are
-000118c0: 206f 6620 7379 6e74 6178 3a20 736f 6d65   of syntax: some
-000118d0: 616c 6961 730a 0a20 2020 204e 6f77 2061  alias..    Now a
-000118e0: 6c73 6f20 616c 6c6f 7769 6e67 2023 736f  lso allowing #so
-000118f0: 6d65 616c 6961 730a 0a20 2020 2022 2222  mealias..    """
-00011900: 0a20 2020 2069 6620 280a 2020 2020 2020  .    if (.      
-00011910: 2020 726f 6f6d 5f69 640a 2020 2020 2020    room_id.      
-00011920: 2020 616e 6420 6c65 6e28 726f 6f6d 5f69    and len(room_i
-00011930: 6429 203e 2030 0a20 2020 2020 2020 2061  d) > 0.        a
-00011940: 6e64 2072 6f6f 6d5f 6964 2021 3d20 2223  nd room_id != "#
-00011950: 220a 2020 2020 2020 2020 616e 6420 2822  ".        and ("
-00011960: 3a22 206e 6f74 2069 6e20 726f 6f6d 5f69  :" not in room_i
-00011970: 6429 0a20 2020 2020 2020 2061 6e64 2028  d).        and (
-00011980: 2223 2220 6e6f 7420 696e 2072 6f6f 6d5f  "#" not in room_
-00011990: 6964 5b31 3a5d 290a 2020 2020 2020 2020  id[1:]).        
-000119a0: 616e 6420 286e 6f74 2072 6f6f 6d5f 6964  and (not room_id
-000119b0: 2e73 7461 7274 7377 6974 6828 2221 2229  .startswith("!")
-000119c0: 290a 2020 2020 2020 2020 616e 6420 286e  ).        and (n
-000119d0: 6f74 2072 6f6f 6d5f 6964 2e73 7461 7274  ot room_id.start
-000119e0: 7377 6974 6828 2240 2229 290a 2020 2020  swith("@")).    
-000119f0: 2020 2020 616e 6420 2822 2022 206e 6f74      and (" " not
-00011a00: 2069 6e20 726f 6f6d 5f69 6429 0a20 2020   in room_id).   
-00011a10: 2029 3a0a 2020 2020 2020 2020 7265 7475   ):.        retu
-00011a20: 726e 2054 7275 650a 2020 2020 656c 7365  rn True.    else
-00011a30: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00011a40: 2046 616c 7365 0a0a 0a64 6566 2069 735f   False...def is_
-00011a50: 7573 6572 5f69 6428 7573 6572 5f69 643a  user_id(user_id:
-00011a60: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
-00011a70: 2020 2022 2222 4465 7465 726d 696e 6520     """Determine 
-00011a80: 6966 2075 7365 7220 6964 656e 7469 6669  if user identifi
-00011a90: 6572 2069 7320 6120 7661 6c69 6420 7573  er is a valid us
-00011aa0: 6572 2069 642e 0a0a 2020 2020 5573 6572  er id...    User
-00011ab0: 2069 6473 2061 7265 206f 6620 7379 6e74   ids are of synt
-00011ac0: 6178 3a20 4073 6f6d 6575 7365 723a 736f  ax: @someuser:so
-00011ad0: 6d65 7365 7276 6572 0a20 2020 2054 6869  meserver.    Thi
-00011ae0: 7320 6973 206e 6f74 2061 6e20 6578 6861  s is not an exha
-00011af0: 7573 7469 7665 2063 6865 636b 210a 0a20  ustive check!.. 
-00011b00: 2020 2022 2222 0a20 2020 2069 6620 280a     """.    if (.
-00011b10: 2020 2020 2020 2020 7573 6572 5f69 640a          user_id.
-00011b20: 2020 2020 2020 2020 616e 6420 6c65 6e28          and len(
-00011b30: 7573 6572 5f69 6429 203e 2033 0a20 2020  user_id) > 3.   
-00011b40: 2020 2020 2061 6e64 2028 7573 6572 5f69       and (user_i
-00011b50: 645b 305d 203d 3d20 2240 2229 0a20 2020  d[0] == "@").   
-00011b60: 2020 2020 2061 6e64 2028 223a 2220 696e       and (":" in
-00011b70: 2075 7365 725f 6964 290a 2020 2020 2020   user_id).      
-00011b80: 2020 616e 6420 2822 2022 206e 6f74 2069    and (" " not i
-00011b90: 6e20 7573 6572 5f69 6429 0a20 2020 2029  n user_id).    )
-00011ba0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00011bb0: 2054 7275 650a 2020 2020 656c 7365 3a0a   True.    else:.
-00011bc0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00011bd0: 616c 7365 0a0a 0a64 6566 2069 735f 7368  alse...def is_sh
-00011be0: 6f72 745f 7573 6572 5f69 6428 7573 6572  ort_user_id(user
-00011bf0: 5f69 643a 2073 7472 2920 2d3e 2062 6f6f  _id: str) -> boo
-00011c00: 6c3a 0a20 2020 2022 2222 4465 7465 726d  l:.    """Determ
-00011c10: 696e 6520 6966 2075 7365 7220 6964 656e  ine if user iden
-00011c20: 7469 6669 6572 2069 7320 6120 7661 6c69  tifier is a vali
-00011c30: 6420 7368 6f72 7420 7573 6572 2069 642e  d short user id.
-00011c40: 0a0a 2020 2020 5368 6f72 7420 7573 6572  ..    Short user
-00011c50: 2069 6473 2061 7265 206f 6620 7379 6e74   ids are of synt
-00011c60: 6178 3a20 736f 6d65 7573 6572 0a20 2020  ax: someuser.   
-00011c70: 2054 6869 7320 6973 206e 6f74 2061 6e20   This is not an 
-00011c80: 6578 6861 7573 7469 7665 2063 6865 636b  exhaustive check
-00011c90: 210a 0a20 2020 2022 2222 0a20 2020 2069  !..    """.    i
-00011ca0: 6620 280a 2020 2020 2020 2020 7573 6572  f (.        user
-00011cb0: 5f69 640a 2020 2020 2020 2020 616e 6420  _id.        and 
-00011cc0: 6c65 6e28 7573 6572 5f69 6429 203e 2030  len(user_id) > 0
-00011cd0: 0a20 2020 2020 2020 2061 6e64 2028 223a  .        and (":
-00011ce0: 2220 6e6f 7420 696e 2075 7365 725f 6964  " not in user_id
-00011cf0: 290a 2020 2020 2020 2020 616e 6420 2822  ).        and ("
-00011d00: 4022 206e 6f74 2069 6e20 7573 6572 5f69  @" not in user_i
-00011d10: 6429 0a20 2020 2020 2020 2061 6e64 2028  d).        and (
-00011d20: 2220 2220 6e6f 7420 696e 2075 7365 725f  " " not in user_
-00011d30: 6964 290a 2020 2020 293a 0a20 2020 2020  id).    ):.     
-00011d40: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
-00011d50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00011d60: 2072 6574 7572 6e20 4661 6c73 650a 0a0a   return False...
-00011d70: 6465 6620 6973 5f70 6172 7469 616c 5f75  def is_partial_u
-00011d80: 7365 725f 6964 2875 7365 725f 6964 3a20  ser_id(user_id: 
-00011d90: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
-00011da0: 2020 2222 2244 6574 6572 6d69 6e65 2069    """Determine i
-00011db0: 6620 7573 6572 2069 6465 6e74 6966 6965  f user identifie
-00011dc0: 7220 6973 2061 2076 616c 6964 2061 6262  r is a valid abb
-00011dd0: 7265 7669 6174 6564 2075 7365 7220 6964  reviated user id
-00011de0: 2e0a 0a20 2020 2041 6262 7265 762e 2075  ...    Abbrev. u
-00011df0: 7365 7220 6964 7320 6172 6520 6f66 2073  ser ids are of s
-00011e00: 796e 7461 783a 2040 736f 6d65 7573 6572  yntax: @someuser
-00011e10: 0a20 2020 2054 6869 7320 6973 206e 6f74  .    This is not
-00011e20: 2061 6e20 6578 6861 7573 7469 7665 2063   an exhaustive c
-00011e30: 6865 636b 210a 0a20 2020 2022 2222 0a20  heck!..    """. 
-00011e40: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-00011e50: 7573 6572 5f69 640a 2020 2020 2020 2020  user_id.        
-00011e60: 616e 6420 6c65 6e28 7573 6572 5f69 6429  and len(user_id)
-00011e70: 203e 2031 0a20 2020 2020 2020 2061 6e64   > 1.        and
-00011e80: 2028 7573 6572 5f69 645b 305d 203d 3d20   (user_id[0] == 
-00011e90: 2240 2229 0a20 2020 2020 2020 2061 6e64  "@").        and
-00011ea0: 2028 223a 2220 6e6f 7420 696e 2075 7365   (":" not in use
-00011eb0: 725f 6964 290a 2020 2020 2020 2020 616e  r_id).        an
-00011ec0: 6420 2822 2022 206e 6f74 2069 6e20 7573  d (" " not in us
-00011ed0: 6572 5f69 6429 0a20 2020 2029 3a0a 2020  er_id).    ):.  
-00011ee0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00011ef0: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
-00011f00: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-00011f10: 0a0a 0a64 6566 2069 735f 7573 6572 2875  ...def is_user(u
-00011f20: 7365 725f 6964 3a20 7374 7229 202d 3e20  ser_id: str) -> 
-00011f30: 626f 6f6c 3a0a 2020 2020 2222 2244 6574  bool:.    """Det
-00011f40: 6572 6d69 6e65 2069 6620 7573 6572 2069  ermine if user i
-00011f50: 6420 6973 2061 2076 616c 6964 2075 7365  d is a valid use
-00011f60: 7220 6964 206f 7220 6120 7661 6c69 6420  r id or a valid 
-00011f70: 7368 6f72 7420 7573 6572 2069 642e 0a0a  short user id...
-00011f80: 2020 2020 5468 6973 2069 7320 6e6f 7420      This is not 
-00011f90: 616e 2065 7868 6175 7374 6976 6520 6368  an exhaustive ch
-00011fa0: 6563 6b21 0a0a 2020 2020 2222 220a 2020  eck!..    """.  
-00011fb0: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
-00011fc0: 2020 2069 735f 7573 6572 5f69 6428 7573     is_user_id(us
-00011fd0: 6572 5f69 6429 0a20 2020 2020 2020 206f  er_id).        o
-00011fe0: 7220 6973 5f70 6172 7469 616c 5f75 7365  r is_partial_use
-00011ff0: 725f 6964 2875 7365 725f 6964 290a 2020  r_id(user_id).  
-00012000: 2020 2020 2020 6f72 2069 735f 7368 6f72        or is_shor
-00012010: 745f 7573 6572 5f69 6428 7573 6572 5f69  t_user_id(user_i
-00012020: 6429 0a20 2020 2029 0a0a 0a61 7379 6e63  d).    )...async
-00012030: 2064 6566 2061 6374 696f 6e5f 726f 6f6d   def action_room
-00012040: 5f64 6d5f 6372 6561 7465 2863 6c69 656e  _dm_create(clien
-00012050: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-00012060: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-00012070: 7429 3a0a 2020 2020 2222 2243 7265 6174  t):.    """Creat
-00012080: 6520 6120 6469 7265 6374 206d 6573 7361  e a direct messa
-00012090: 6765 2028 444d 2920 726f 6f6d 2077 6869  ge (DM) room whi
-000120a0: 6c65 2061 6c72 6561 6479 2062 6569 6e67  le already being
-000120b0: 206c 6f67 6765 6420 696e 2e0a 0a20 2020   logged in...   
-000120c0: 2041 6674 6572 2063 7265 6174 696e 6720   After creating 
-000120d0: 7468 6520 7072 6976 6174 6520 444d 2072  the private DM r
-000120e0: 6f6f 6d20 6974 2069 6e76 6974 6573 2074  oom it invites t
-000120f0: 6865 206f 7468 6572 2075 7365 7220 746f  he other user to
-00012100: 2069 742e 0a0a 2020 2020 4172 6775 6d65   it...    Argume
-00012110: 6e74 733a 0a20 2020 202d 2d2d 2d2d 2d2d  nts:.    -------
-00012120: 2d2d 0a20 2020 2063 6c69 656e 743a 2041  --.    client: A
-00012130: 7379 6e63 436c 6965 6e74 3a20 6e69 6f20  syncClient: nio 
-00012140: 636c 6965 6e74 2c20 616c 6c6f 7773 2061  client, allows a
-00012150: 7320 746f 2071 7565 7279 2074 6865 2073  s to query the s
-00012160: 6572 7665 720a 2020 2020 6372 6564 656e  erver.    creden
-00012170: 7469 616c 733a 2064 6963 743a 2061 6c6c  tials: dict: all
-00012180: 6f77 7320 746f 2067 6574 2074 6865 2075  ows to get the u
-00012190: 7365 725f 6964 206f 6620 7365 6e64 6572  ser_id of sender
-000121a0: 2c20 6574 630a 2020 2020 2222 220a 2020  , etc.    """.  
-000121b0: 2020 2320 7573 6572 7320 3a20 6c69 7374    # users : list
-000121c0: 206f 6620 7573 6572 7320 746f 2063 7265   of users to cre
-000121d0: 6174 6520 444d 2072 6f6f 6d73 2077 6974  ate DM rooms wit
-000121e0: 680a 2020 2020 2320 726f 6f6d 5f61 6c69  h.    # room_ali
-000121f0: 6173 6573 203a 206c 6973 7420 6f66 2072  ases : list of r
-00012200: 6f6f 6d20 616c 6961 7365 7320 696e 2074  oom aliases in t
-00012210: 6865 2066 6f72 6d20 6f66 2022 7361 6d70  he form of "samp
-00012220: 6c65 416c 6961 7322 0a20 2020 2023 2020  leAlias".    #  
-00012230: 2020 2020 2020 2054 6865 7365 2061 6c69         These ali
-00012240: 6173 6573 2077 696c 6c20 7468 656e 2062  ases will then b
-00012250: 6520 7573 6564 2062 7920 7468 6520 7365  e used by the se
-00012260: 7276 6572 2061 6e64 0a20 2020 2023 2020  rver and.    #  
-00012270: 2020 2020 2020 2074 6865 2073 6572 7665         the serve
-00012280: 7220 6372 6561 7465 7320 7468 6520 6465  r creates the de
-00012290: 6669 6e69 7465 2061 6c69 6173 2069 6e20  finite alias in 
-000122a0: 7468 6520 666f 726d 0a20 2020 2023 2020  the form.    #  
-000122b0: 2020 2020 2020 206f 6620 2223 7361 6d70         of "#samp
-000122c0: 6c65 416c 6961 733a 6578 616d 706c 652e  leAlias:example.
-000122d0: 636f 6d22 2066 726f 6d20 6974 2e0a 2020  com" from it..  
-000122e0: 2020 2320 2020 2020 2020 2020 5765 2070    #         We p
-000122f0: 6572 6d69 7420 2223 7361 6d70 6c65 416c  ermit "#sampleAl
-00012300: 6961 733a 6578 616d 706c 652e 636f 6d22  ias:example.com"
-00012310: 2061 6e64 2064 6f77 6e73 6361 6c65 2069   and downscale i
-00012320: 7420 746f 0a20 2020 2023 2020 2020 2020  t to.    #      
-00012330: 2020 2022 7361 6d70 6c65 416c 6961 7322     "sampleAlias"
-00012340: 2e0a 2020 2020 2320 6e61 6d65 7320 3a20  ..    # names : 
-00012350: 6c69 7374 206f 6620 6e61 6d65 7320 666f  list of names fo
-00012360: 7220 726f 6f6d 730a 2020 2020 2320 746f  r rooms.    # to
-00012370: 7069 6320 3a20 726f 6f6d 2074 6f70 6963  pic : room topic
-00012380: 730a 0a20 2020 2075 7365 7273 203d 2067  s..    users = g
-00012390: 732e 7061 2e72 6f6f 6d5f 646d 5f63 7265  s.pa.room_dm_cre
-000123a0: 6174 650a 2020 2020 726f 6f6d 5f61 6c69  ate.    room_ali
-000123b0: 6173 6573 203d 2067 732e 7061 2e61 6c69  ases = gs.pa.ali
-000123c0: 6173 0a20 2020 206e 616d 6573 203d 2067  as.    names = g
-000123d0: 732e 7061 2e6e 616d 650a 2020 2020 746f  s.pa.name.    to
-000123e0: 7069 6373 203d 2067 732e 7061 2e74 6f70  pics = gs.pa.top
-000123f0: 6963 0a20 2020 2074 7279 3a0a 2020 2020  ic.    try:.    
-00012400: 2020 2020 696e 6465 7820 3d20 300a 2020      index = 0.  
-00012410: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00012420: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00012430: 6627 5472 7969 6e67 2074 6f20 6372 6561  f'Trying to crea
-00012440: 7465 2044 4d20 726f 6f6d 7320 7769 7468  te DM rooms with
-00012450: 2075 7365 7273 2022 7b75 7365 7273 7d22   users "{users}"
-00012460: 2c20 270a 2020 2020 2020 2020 2020 2020  , '.            
-00012470: 6627 726f 6f6d 2061 6c69 6173 6573 2022  f'room aliases "
-00012480: 7b72 6f6f 6d5f 616c 6961 7365 737d 222c  {room_aliases}",
-00012490: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-000124a0: 276e 616d 6573 2022 7b6e 616d 6573 7d22  'names "{names}"
-000124b0: 2c20 616e 6420 746f 7069 6373 2022 7b74  , and topics "{t
-000124c0: 6f70 6963 737d 222e 270a 2020 2020 2020  opics}".'.      
-000124d0: 2020 290a 2020 2020 2020 2020 666f 7220    ).        for 
-000124e0: 7573 6572 2069 6e20 7573 6572 733a 0a20  user in users:. 
-000124f0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00012500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012510: 616c 6961 7320 3d20 726f 6f6d 5f61 6c69  alias = room_ali
-00012520: 6173 6573 5b69 6e64 6578 5d0a 2020 2020  ases[index].    
-00012530: 2020 2020 2020 2020 2020 2020 616c 6961              alia
-00012540: 7320 3d20 616c 6961 732e 7265 706c 6163  s = alias.replac
-00012550: 6528 7222 5c21 222c 2022 2122 2920 2023  e(r"\!", "!")  #
-00012560: 2072 656d 6f76 6520 706f 7373 6962 6c65   remove possible
-00012570: 2065 7363 6170 650a 2020 2020 2020 2020   escape.        
-00012580: 2020 2020 2020 2020 2320 616c 6961 7320          # alias 
-00012590: 6973 2061 2074 7275 6520 616c 6961 732c  is a true alias,
-000125a0: 206e 6f74 2061 2072 6f6f 6d20 6964 0a20   not a room id. 
-000125b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000125c0: 2069 6620 6279 206d 6973 7461 6b65 2075   if by mistake u
-000125d0: 7365 7220 6861 7320 6769 7665 6e20 6675  ser has given fu
-000125e0: 6c6c 2072 6f6f 6d20 616c 6961 732c 2073  ll room alias, s
-000125f0: 686f 7274 656e 2069 740a 2020 2020 2020  horten it.      
-00012600: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
-00012610: 726f 6f6d 5f61 6c69 6173 2861 6c69 6173  room_alias(alias
-00012620: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012630: 2020 2020 2020 2061 6c69 6173 203d 2072         alias = r
-00012640: 6f6f 6d5f 616c 6961 735f 746f 5f73 686f  oom_alias_to_sho
-00012650: 7274 5f72 6f6f 6d5f 616c 6961 7328 616c  rt_room_alias(al
-00012660: 6961 732c 2063 7265 6465 6e74 6961 6c73  ias, credentials
-00012670: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-00012680: 6365 7074 2028 496e 6465 7845 7272 6f72  cept (IndexError
-00012690: 2c20 5479 7065 4572 726f 7229 3a0a 2020  , TypeError):.  
-000126a0: 2020 2020 2020 2020 2020 2020 2020 616c                al
-000126b0: 6961 7320 3d20 2222 0a20 2020 2020 2020  ias = "".       
-000126c0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000126d0: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
-000126e0: 206e 616d 6573 5b69 6e64 6578 5d0a 2020   names[index].  
-000126f0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00012700: 2028 496e 6465 7845 7272 6f72 2c20 5479   (IndexError, Ty
-00012710: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
-00012720: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
-00012730: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
-00012740: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00012750: 2020 2020 2074 6f70 6963 203d 2074 6f70       topic = top
-00012760: 6963 735b 696e 6465 785d 0a20 2020 2020  ics[index].     
-00012770: 2020 2020 2020 2065 7863 6570 7420 2849         except (I
-00012780: 6e64 6578 4572 726f 722c 2054 7970 6545  ndexError, TypeE
-00012790: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-000127a0: 2020 2020 2020 2074 6f70 6963 203d 2022         topic = "
-000127b0: 220a 2020 2020 2020 2020 2020 2020 616c  ".            al
-000127c0: 6961 7320 3d20 616c 6961 732e 7374 7269  ias = alias.stri
-000127d0: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-000127e0: 616c 6961 7320 3d20 4e6f 6e65 2069 6620  alias = None if 
-000127f0: 616c 6961 7320 3d3d 2022 2220 656c 7365  alias == "" else
-00012800: 2061 6c69 6173 0a20 2020 2020 2020 2020   alias.         
-00012810: 2020 206e 616d 6520 3d20 6e61 6d65 2e73     name = name.s
-00012820: 7472 6970 2829 0a20 2020 2020 2020 2020  trip().         
-00012830: 2020 206e 616d 6520 3d20 4e6f 6e65 2069     name = None i
-00012840: 6620 6e61 6d65 203d 3d20 2222 2065 6c73  f name == "" els
-00012850: 6520 6e61 6d65 0a20 2020 2020 2020 2020  e name.         
-00012860: 2020 2074 6f70 6963 203d 2074 6f70 6963     topic = topic
-00012870: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
-00012880: 2020 2020 2074 6f70 6963 203d 204e 6f6e       topic = Non
-00012890: 6520 6966 2074 6f70 6963 203d 3d20 2222  e if topic == ""
-000128a0: 2065 6c73 6520 746f 7069 630a 2020 2020   else topic.    
-000128b0: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-000128c0: 2e70 6c61 696e 3a0a 2020 2020 2020 2020  .plain:.        
-000128d0: 2020 2020 2020 2020 656e 6372 7970 7420          encrypt 
-000128e0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-000128f0: 2020 2020 2020 2020 696e 6974 6961 6c5f          initial_
-00012900: 7374 6174 6520 3d20 2829 0a20 2020 2020  state = ().     
-00012910: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00012920: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-00012930: 7279 7074 203d 2054 7275 650a 2020 2020  rypt = True.    
-00012940: 2020 2020 2020 2020 2020 2020 696e 6974              init
-00012950: 6961 6c5f 7374 6174 6520 3d20 5b45 6e61  ial_state = [Ena
-00012960: 626c 6545 6e63 7279 7074 696f 6e42 7569  bleEncryptionBui
-00012970: 6c64 6572 2829 2e61 735f 6469 6374 2829  lder().as_dict()
-00012980: 5d0a 2020 2020 2020 2020 2020 2020 6773  ].            gs
-00012990: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-000129a0: 2020 2020 2020 2020 2020 2020 6627 4372              f'Cr
-000129b0: 6561 7469 6e67 2044 4d20 726f 6f6d 2077  eating DM room w
-000129c0: 6974 6820 7573 6572 2022 7b75 7365 727d  ith user "{user}
-000129d0: 222c 2027 0a20 2020 2020 2020 2020 2020  ", '.           
-000129e0: 2020 2020 2066 2772 6f6f 6d20 616c 6961       f'room alia
-000129f0: 7320 227b 616c 6961 737d 222c 2027 0a20  s "{alias}", '. 
-00012a00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012a10: 276e 616d 6520 227b 6e61 6d65 7d22 2c20  'name "{name}", 
-00012a20: 746f 7069 6320 227b 746f 7069 637d 2220  topic "{topic}" 
-00012a30: 616e 6420 270a 2020 2020 2020 2020 2020  and '.          
-00012a40: 2020 2020 2020 6627 656e 6372 7970 7465        f'encrypte
-00012a50: 6420 227b 656e 6372 7970 747d 222e 270a  d "{encrypt}".'.
-00012a60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00012a70: 2020 2020 2020 2020 2020 2320 6e69 6f27            # nio'
-00012a80: 7320 726f 6f6d 5f63 7265 6174 6520 646f  s room_create do
-00012a90: 6573 204e 4f54 2061 6363 6570 7420 2223  es NOT accept "#
-00012aa0: 666f 6f3a 6578 616d 706c 652e 636f 6d22  foo:example.com"
-00012ab0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00012ac0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-00012ad0: 2e72 6f6f 6d5f 6372 6561 7465 280a 2020  .room_create(.  
-00012ae0: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00012af0: 6961 733d 616c 6961 732c 2020 2320 6465  ias=alias,  # de
-00012b00: 7369 7265 6420 6361 6e6f 6e69 6361 6c20  sired canonical 
-00012b10: 616c 6961 7320 6c6f 6361 6c20 7061 7274  alias local part
-00012b20: 2c20 652e 672e 2066 6f6f 0a20 2020 2020  , e.g. foo.     
-00012b30: 2020 2020 2020 2020 2020 2076 6973 6962             visib
-00012b40: 696c 6974 793d 526f 6f6d 5669 7369 6269  ility=RoomVisibi
-00012b50: 6c69 7479 2e70 7269 7661 7465 2c0a 2020  lity.private,.  
-00012b60: 2020 2020 2020 2020 2020 2020 2020 6973                is
-00012b70: 5f64 6972 6563 743d 5472 7565 2c0a 2020  _direct=True,.  
-00012b80: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00012b90: 6573 6574 3d52 6f6f 6d50 7265 7365 742e  eset=RoomPreset.
-00012ba0: 7072 6976 6174 655f 6368 6174 2c0a 2020  private_chat,.  
-00012bb0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00012bc0: 7669 7465 3d7b 7573 6572 7d2c 2020 2320  vite={user},  # 
-00012bd0: 696e 7669 7465 2074 6865 2075 7365 7220  invite the user 
-00012be0: 746f 2074 6865 2044 4d0a 2020 2020 2020  to the DM.      
-00012bf0: 2020 2020 2020 2020 2020 6e61 6d65 3d6e            name=n
-00012c00: 616d 652c 2020 2320 726f 6f6d 206e 616d  ame,  # room nam
-00012c10: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00012c20: 2020 746f 7069 633d 746f 7069 632c 2020    topic=topic,  
-00012c30: 2320 726f 6f6d 2074 6f70 6963 0a20 2020  # room topic.   
-00012c40: 2020 2020 2020 2020 2020 2020 2069 6e69               ini
-00012c50: 7469 616c 5f73 7461 7465 3d69 6e69 7469  tial_state=initi
-00012c60: 616c 5f73 7461 7465 2c0a 2020 2020 2020  al_state,.      
-00012c70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00012c80: 2020 2020 2320 2261 6c69 6173 3122 2077      # "alias1" w
-00012c90: 696c 6c20 6372 6561 7465 2061 2022 2361  ill create a "#a
-00012ca0: 6c69 6173 313a 6578 616d 706c 652e 636f  lias1:example.co
-00012cb0: 6d22 0a20 2020 2020 2020 2020 2020 2069  m".            i
-00012cc0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-00012cd0: 702c 2052 6f6f 6d43 7265 6174 6545 7272  p, RoomCreateErr
-00012ce0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00012cf0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-00012d00: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00012d10: 2020 2020 2020 2022 4531 3235 3a20 220a         "E125: ".
-00012d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d30: 2020 2020 2252 6f6f 6d5f 6372 6561 7465      "Room_create
-00012d40: 2066 6169 6c65 6420 7769 7468 2072 6573   failed with res
-00012d50: 706f 6e73 653a 2022 0a20 2020 2020 2020  ponse: ".       
-00012d60: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-00012d70: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-00012d80: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
-00012d90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00012da0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-00012db0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-00012dc0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00012dd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012de0: 2020 6966 2061 6c69 6173 3a0a 2020 2020    if alias:.    
-00012df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e00: 6675 6c6c 5f61 6c69 6173 203d 2073 686f  full_alias = sho
-00012e10: 7274 5f72 6f6f 6d5f 616c 6961 735f 746f  rt_room_alias_to
-00012e20: 5f72 6f6f 6d5f 616c 6961 7328 0a20 2020  _room_alias(.   
-00012e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e40: 2020 2020 2061 6c69 6173 2c20 6372 6564       alias, cred
-00012e50: 656e 7469 616c 730a 2020 2020 2020 2020  entials.        
-00012e60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00012e70: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00012e80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00012e90: 2020 2020 2020 2020 6675 6c6c 5f61 6c69          full_ali
-00012ea0: 6173 203d 204e 6f6e 650a 2020 2020 2020  as = None.      
-00012eb0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00012ec0: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00012ed0: 2020 2020 2020 2020 2020 2066 2743 7265             f'Cre
-00012ee0: 6174 6564 2044 4d20 726f 6f6d 2077 6974  ated DM room wit
-00012ef0: 6820 726f 6f6d 2069 6420 227b 7265 7370  h room id "{resp
-00012f00: 2e72 6f6f 6d5f 6964 7d22 2c20 270a 2020  .room_id}", '.  
-00012f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f20: 2020 6627 7368 6f72 7420 616c 6961 7320    f'short alias 
-00012f30: 227b 7a6e 2861 6c69 6173 297d 222c 2027  "{zn(alias)}", '
-00012f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012f50: 2020 2020 2066 2766 756c 6c20 616c 6961       f'full alia
-00012f60: 7320 227b 7a6e 2866 756c 6c5f 616c 6961  s "{zn(full_alia
-00012f70: 7329 7d22 2061 6e64 2027 0a20 2020 2020  s)}" and '.     
-00012f80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012f90: 2765 6e63 7279 7074 6564 2022 7b65 6e63  'encrypted "{enc
-00012fa0: 7279 7074 7d22 2e27 0a20 2020 2020 2020  rypt}".'.       
-00012fb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012fc0: 2020 2020 2020 2020 2020 2023 206f 7574             # out
-00012fd0: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-00012fe0: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-00012ff0: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-00013000: 2020 2020 2020 2020 7465 7874 203d 2028          text = (
-00013010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013020: 2020 2020 2066 227b 7265 7370 2e72 6f6f       f"{resp.roo
-00013030: 6d5f 6964 7d7b 5345 507d 7b7a 6e28 616c  m_id}{SEP}{zn(al
-00013040: 6961 7329 7d7b 5345 507d 7b7a 6e28 6675  ias)}{SEP}{zn(fu
-00013050: 6c6c 5f61 6c69 6173 297d 220a 2020 2020  ll_alias)}".    
-00013060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013070: 6622 7b53 4550 7d7b 7a6e 286e 616d 6529  f"{SEP}{zn(name)
-00013080: 7d7b 5345 507d 7b7a 6e28 746f 7069 6329  }{SEP}{zn(topic)
-00013090: 7d7b 5345 507d 7b65 6e63 7279 7074 7d22  }{SEP}{encrypt}"
-000130a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000130b0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000130c0: 2020 2023 204f 626a 6563 7420 6f66 2074     # Object of t
-000130d0: 7970 6520 526f 6f6d 4372 6561 7465 5265  ype RoomCreateRe
-000130e0: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
-000130f0: 4f4e 0a20 2020 2020 2020 2020 2020 2020  ON.             
-00013100: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
-00013110: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
-00013120: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
-00013130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013140: 6a73 6f6e 5f6d 6178 203d 2072 6573 702e  json_max = resp.
-00013150: 5f5f 6469 6374 5f5f 0a20 2020 2020 2020  __dict__.       
-00013160: 2020 2020 2020 2020 2023 2072 6573 7020           # resp 
-00013170: 6861 7320 6f6e 6c79 2031 2075 7365 6675  has only 1 usefu
-00013180: 6c20 7573 6566 756c 206d 656d 6265 723a  l useful member:
-00013190: 2072 6f6f 6d5f 6964 0a20 2020 2020 2020   room_id.       
-000131a0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-000131b0: 782e 7570 6461 7465 287b 2261 6c69 6173  x.update({"alias
-000131c0: 223a 2061 6c69 6173 7d29 2020 2320 6164  ": alias})  # ad
-000131d0: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
-000131e0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-000131f0: 6e5f 6d61 782e 7570 6461 7465 287b 2261  n_max.update({"a
-00013200: 6c69 6173 5f66 756c 6c22 3a20 6675 6c6c  lias_full": full
-00013210: 5f61 6c69 6173 7d29 0a20 2020 2020 2020  _alias}).       
-00013220: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00013230: 782e 7570 6461 7465 287b 226e 616d 6522  x.update({"name"
-00013240: 3a20 6e61 6d65 7d29 0a20 2020 2020 2020  : name}).       
-00013250: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00013260: 782e 7570 6461 7465 287b 2274 6f70 6963  x.update({"topic
-00013270: 223a 2074 6f70 6963 7d29 0a20 2020 2020  ": topic}).     
-00013280: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00013290: 6d61 782e 7570 6461 7465 287b 2265 6e63  max.update({"enc
-000132a0: 7279 7074 6564 223a 2065 6e63 7279 7074  rypted": encrypt
-000132b0: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
-000132c0: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
-000132d0: 6d61 782e 636f 7079 2829 0a20 2020 2020  max.copy().     
-000132e0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-000132f0: 2e70 6f70 2822 7472 616e 7370 6f72 745f  .pop("transport_
-00013300: 7265 7370 6f6e 7365 2229 0a20 2020 2020  response").     
-00013310: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00013320: 7370 6563 203d 204e 6f6e 650a 2020 2020  spec = None.    
-00013330: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00013340: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-00013350: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-00013360: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
-00013370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013380: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
-00013390: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-000133a0: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
-000133b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133c0: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-000133d0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-000133e0: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
-000133f0: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
-00013400: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00013410: 2020 2020 2020 2020 2020 696e 6465 7820            index 
-00013420: 3d20 696e 6465 7820 2b20 310a 2020 2020  = index + 1.    
-00013430: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00013440: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00013450: 2e65 7272 6f72 2822 4531 3236 3a20 2220  .error("E126: " 
-00013460: 2244 4d20 726f 6f6d 2063 7265 6174 696f  "DM room creatio
-00013470: 6e20 6661 696c 6564 2e20 536f 7272 792e  n failed. Sorry.
-00013480: 2229 0a20 2020 2020 2020 2067 732e 6572  ").        gs.er
-00013490: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-000134a0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-000134b0: 6728 2248 6572 6520 6973 2074 6865 2074  g("Here is the t
-000134c0: 7261 6365 6261 636b 2e5c 6e22 202b 2074  raceback.\n" + t
-000134d0: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
-000134e0: 6578 6328 2929 0a0a 0a61 7379 6e63 2064  exc())...async d
-000134f0: 6566 2061 6374 696f 6e5f 726f 6f6d 5f63  ef action_room_c
-00013500: 7265 6174 6528 636c 6965 6e74 3a20 4173  reate(client: As
-00013510: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
-00013520: 6e74 6961 6c73 3a20 6469 6374 293a 0a20  ntials: dict):. 
-00013530: 2020 2022 2222 4372 6561 7465 206f 6e65     """Create one
-00013540: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-00013550: 6d73 2077 6869 6c65 2061 6c72 6561 6479  ms while already
-00013560: 2062 6569 6e67 206c 6f67 6765 6420 696e   being logged in
-00013570: 2e0a 0a20 2020 2041 7267 756d 656e 7473  ...    Arguments
-00013580: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a  :.    ---------.
-00013590: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
-000135a0: 6343 6c69 656e 743a 206e 696f 2063 6c69  cClient: nio cli
-000135b0: 656e 742c 2061 6c6c 6f77 7320 6173 2074  ent, allows as t
-000135c0: 6f20 7175 6572 7920 7468 6520 7365 7276  o query the serv
-000135d0: 6572 0a20 2020 2063 7265 6465 6e74 6961  er.    credentia
-000135e0: 6c73 3a20 6469 6374 3a20 616c 6c6f 7773  ls: dict: allows
-000135f0: 2074 6f20 6765 7420 7468 6520 7573 6572   to get the user
-00013600: 5f69 6420 6f66 2073 656e 6465 722c 2065  _id of sender, e
-00013610: 7463 0a20 2020 2022 2222 0a20 2020 2023  tc.    """.    #
-00013620: 2072 6f6f 6d5f 616c 6961 7365 7320 3a20   room_aliases : 
-00013630: 6c69 7374 206f 6620 726f 6f6d 2061 6c69  list of room ali
-00013640: 6173 6573 2069 6e20 7468 6520 666f 726d  ases in the form
-00013650: 206f 6620 2273 616d 706c 6541 6c69 6173   of "sampleAlias
-00013660: 220a 2020 2020 2320 2020 2020 2020 2020  ".    #         
-00013670: 5468 6573 6520 616c 6961 7365 7320 7769  These aliases wi
-00013680: 6c6c 2074 6865 6e20 6265 2075 7365 6420  ll then be used 
-00013690: 6279 2074 6865 2073 6572 7665 7220 616e  by the server an
-000136a0: 640a 2020 2020 2320 2020 2020 2020 2020  d.    #         
-000136b0: 7468 6520 7365 7276 6572 2063 7265 6174  the server creat
-000136c0: 6573 2074 6865 2064 6566 696e 6974 6520  es the definite 
-000136d0: 616c 6961 7320 696e 2074 6865 2066 6f72  alias in the for
-000136e0: 6d0a 2020 2020 2320 2020 2020 2020 2020  m.    #         
-000136f0: 6f66 2022 2373 616d 706c 6541 6c69 6173  of "#sampleAlias
-00013700: 3a65 7861 6d70 6c65 2e63 6f6d 2220 6672  :example.com" fr
-00013710: 6f6d 2069 742e 0a20 2020 2023 2020 2020  om it..    #    
-00013720: 2020 2020 2057 6520 7065 726d 6974 2022       We permit "
-00013730: 2373 616d 706c 6541 6c69 6173 3a65 7861  #sampleAlias:exa
-00013740: 6d70 6c65 2e63 6f6d 2220 616e 6420 646f  mple.com" and do
-00013750: 776e 7363 616c 6520 6974 2074 6f0a 2020  wnscale it to.  
-00013760: 2020 2320 2020 2020 2020 2020 2273 616d    #         "sam
-00013770: 706c 6541 6c69 6173 222e 0a20 2020 2023  pleAlias"..    #
-00013780: 206e 616d 6573 203a 206c 6973 7420 6f66   names : list of
-00013790: 206e 616d 6573 2066 6f72 2072 6f6f 6d73   names for rooms
-000137a0: 0a20 2020 2023 2074 6f70 6963 7320 3a20  .    # topics : 
-000137b0: 6c69 7374 206f 6620 726f 6f6d 2074 6f70  list of room top
-000137c0: 6963 730a 0a20 2020 2072 6f6f 6d5f 616c  ics..    room_al
-000137d0: 6961 7365 7320 3d20 6773 2e70 612e 726f  iases = gs.pa.ro
-000137e0: 6f6d 5f63 7265 6174 650a 2020 2020 6e61  om_create.    na
-000137f0: 6d65 7320 3d20 6773 2e70 612e 6e61 6d65  mes = gs.pa.name
-00013800: 0a20 2020 2074 6f70 6963 7320 3d20 6773  .    topics = gs
-00013810: 2e70 612e 746f 7069 630a 2020 2020 7472  .pa.topic.    tr
-00013820: 793a 0a20 2020 2020 2020 2069 6e64 6578  y:.        index
-00013830: 203d 2030 0a20 2020 2020 2020 2067 732e   = 0.        gs.
-00013840: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00013850: 2020 2020 2020 2066 2754 7279 696e 6720         f'Trying 
-00013860: 746f 2063 7265 6174 6520 726f 6f6d 7320  to create rooms 
-00013870: 7769 7468 2072 6f6f 6d20 616c 6961 7365  with room aliase
-00013880: 7320 227b 726f 6f6d 5f61 6c69 6173 6573  s "{room_aliases
-00013890: 7d22 2c20 270a 2020 2020 2020 2020 2020  }", '.          
-000138a0: 2020 6627 6e61 6d65 7320 227b 6e61 6d65    f'names "{name
-000138b0: 737d 222c 2061 6e64 2074 6f70 6963 7320  s}", and topics 
-000138c0: 227b 746f 7069 6373 7d22 2e27 0a20 2020  "{topics}".'.   
-000138d0: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
-000138e0: 6f72 2061 6c69 6173 2069 6e20 726f 6f6d  or alias in room
-000138f0: 5f61 6c69 6173 6573 3a0a 2020 2020 2020  _aliases:.      
-00013900: 2020 2020 2020 616c 6961 7320 3d20 616c        alias = al
-00013910: 6961 732e 7265 706c 6163 6528 7222 5c21  ias.replace(r"\!
-00013920: 222c 2022 2122 2920 2023 2072 656d 6f76  ", "!")  # remov
-00013930: 6520 706f 7373 6962 6c65 2065 7363 6170  e possible escap
-00013940: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00013950: 616c 6961 7320 6973 2061 2074 7275 6520  alias is a true 
-00013960: 616c 6961 732c 206e 6f74 2061 2072 6f6f  alias, not a roo
-00013970: 6d20 6964 0a20 2020 2020 2020 2020 2020  m id.           
-00013980: 2023 2069 6620 6279 206d 6973 7461 6b65   # if by mistake
-00013990: 2075 7365 7220 6861 7320 6769 7665 6e20   user has given 
-000139a0: 6675 6c6c 2072 6f6f 6d20 616c 6961 732c  full room alias,
-000139b0: 2073 686f 7274 656e 2069 740a 2020 2020   shorten it.    
-000139c0: 2020 2020 2020 2020 6966 2069 735f 726f          if is_ro
-000139d0: 6f6d 5f61 6c69 6173 2861 6c69 6173 293a  om_alias(alias):
-000139e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000139f0: 2061 6c69 6173 203d 2072 6f6f 6d5f 616c   alias = room_al
-00013a00: 6961 735f 746f 5f73 686f 7274 5f72 6f6f  ias_to_short_roo
-00013a10: 6d5f 616c 6961 7328 616c 6961 732c 2063  m_alias(alias, c
-00013a20: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00013a30: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00013a40: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-00013a50: 6520 3d20 6e61 6d65 735b 696e 6465 785d  e = names[index]
-00013a60: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00013a70: 6570 7420 2849 6e64 6578 4572 726f 722c  ept (IndexError,
-00013a80: 2054 7970 6545 7272 6f72 293a 0a20 2020   TypeError):.   
-00013a90: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-00013aa0: 6520 3d20 2222 0a20 2020 2020 2020 2020  e = "".         
-00013ab0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00013ac0: 2020 2020 2020 2020 746f 7069 6320 3d20          topic = 
-00013ad0: 746f 7069 6373 5b69 6e64 6578 5d0a 2020  topics[index].  
-00013ae0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00013af0: 2028 496e 6465 7845 7272 6f72 2c20 5479   (IndexError, Ty
-00013b00: 7065 4572 726f 7229 3a0a 2020 2020 2020  peError):.      
-00013b10: 2020 2020 2020 2020 2020 746f 7069 6320            topic 
-00013b20: 3d20 2222 0a20 2020 2020 2020 2020 2020  = "".           
-00013b30: 2061 6c69 6173 203d 2061 6c69 6173 2e73   alias = alias.s
-00013b40: 7472 6970 2829 0a20 2020 2020 2020 2020  trip().         
-00013b50: 2020 2061 6c69 6173 203d 204e 6f6e 6520     alias = None 
-00013b60: 6966 2061 6c69 6173 203d 3d20 2222 2065  if alias == "" e
-00013b70: 6c73 6520 616c 6961 730a 2020 2020 2020  lse alias.      
-00013b80: 2020 2020 2020 6e61 6d65 203d 206e 616d        name = nam
-00013b90: 652e 7374 7269 7028 290a 2020 2020 2020  e.strip().      
-00013ba0: 2020 2020 2020 6e61 6d65 203d 204e 6f6e        name = Non
-00013bb0: 6520 6966 206e 616d 6520 3d3d 2022 2220  e if name == "" 
-00013bc0: 656c 7365 206e 616d 650a 2020 2020 2020  else name.      
-00013bd0: 2020 2020 2020 746f 7069 6320 3d20 746f        topic = to
-00013be0: 7069 632e 7374 7269 7028 290a 2020 2020  pic.strip().    
-00013bf0: 2020 2020 2020 2020 746f 7069 6320 3d20          topic = 
-00013c00: 4e6f 6e65 2069 6620 746f 7069 6320 3d3d  None if topic ==
-00013c10: 2022 2220 656c 7365 2074 6f70 6963 0a20   "" else topic. 
-00013c20: 2020 2020 2020 2020 2020 2069 6620 6773             if gs
-00013c30: 2e70 612e 706c 6169 6e3a 0a20 2020 2020  .pa.plain:.     
-00013c40: 2020 2020 2020 2020 2020 2065 6e63 7279             encry
-00013c50: 7074 203d 2046 616c 7365 0a20 2020 2020  pt = False.     
-00013c60: 2020 2020 2020 2020 2020 2069 6e69 7469             initi
-00013c70: 616c 5f73 7461 7465 203d 2028 290a 2020  al_state = ().  
-00013c80: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ca0: 656e 6372 7970 7420 3d20 5472 7565 0a20  encrypt = True. 
-00013cb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00013cc0: 6e69 7469 616c 5f73 7461 7465 203d 205b  nitial_state = [
-00013cd0: 456e 6162 6c65 456e 6372 7970 7469 6f6e  EnableEncryption
-00013ce0: 4275 696c 6465 7228 292e 6173 5f64 6963  Builder().as_dic
-00013cf0: 7428 295d 0a20 2020 2020 2020 2020 2020  t()].           
-00013d00: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-00013d10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013d20: 2743 7265 6174 696e 6720 726f 6f6d 2077  'Creating room w
-00013d30: 6974 6820 726f 6f6d 2061 6c69 6173 2022  ith room alias "
-00013d40: 7b61 6c69 6173 7d22 2c20 270a 2020 2020  {alias}", '.    
-00013d50: 2020 2020 2020 2020 2020 2020 6627 6e61              f'na
-00013d60: 6d65 2022 7b6e 616d 657d 222c 2074 6f70  me "{name}", top
-00013d70: 6963 2022 7b74 6f70 6963 7d22 2061 6e64  ic "{topic}" and
-00013d80: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00013d90: 2020 2066 2765 6e63 7279 7074 6564 2022     f'encrypted "
-00013da0: 7b65 6e63 7279 7074 7d22 2e27 0a20 2020  {encrypt}".'.   
-00013db0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00013dc0: 2020 2020 2020 2023 206e 696f 2773 2072         # nio's r
-00013dd0: 6f6f 6d5f 6372 6561 7465 2064 6f65 7320  oom_create does 
-00013de0: 4e4f 5420 6163 6365 7074 2022 2366 6f6f  NOT accept "#foo
-00013df0: 3a65 7861 6d70 6c65 2e63 6f6d 220a 2020  :example.com".  
-00013e00: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
-00013e10: 2061 7761 6974 2063 6c69 656e 742e 726f   await client.ro
-00013e20: 6f6d 5f63 7265 6174 6528 0a20 2020 2020  om_create(.     
-00013e30: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
-00013e40: 3d61 6c69 6173 2c20 2023 2064 6573 6972  =alias,  # desir
-00013e50: 6564 2063 616e 6f6e 6963 616c 2061 6c69  ed canonical ali
-00013e60: 6173 206c 6f63 616c 2070 6172 742c 2065  as local part, e
-00013e70: 2e67 2e20 666f 6f0a 2020 2020 2020 2020  .g. foo.        
-00013e80: 2020 2020 2020 2020 6e61 6d65 3d6e 616d          name=nam
-00013e90: 652c 2020 2320 726f 6f6d 206e 616d 650a  e,  # room name.
-00013ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013eb0: 746f 7069 633d 746f 7069 632c 2020 2320  topic=topic,  # 
-00013ec0: 726f 6f6d 2074 6f70 6963 0a20 2020 2020  room topic.     
-00013ed0: 2020 2020 2020 2020 2020 2069 6e69 7469             initi
-00013ee0: 616c 5f73 7461 7465 3d69 6e69 7469 616c  al_state=initial
-00013ef0: 5f73 7461 7465 2c0a 2020 2020 2020 2020  _state,.        
-00013f00: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00013f10: 2020 2320 2261 6c69 6173 3122 2077 696c    # "alias1" wil
-00013f20: 6c20 6372 6561 7465 2061 2022 2361 6c69  l create a "#ali
-00013f30: 6173 313a 6578 616d 706c 652e 636f 6d22  as1:example.com"
-00013f40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013f50: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-00013f60: 2052 6f6f 6d43 7265 6174 6545 7272 6f72   RoomCreateError
-00013f70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013f80: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-00013f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013fa0: 2020 2020 2022 4531 3237 3a20 220a 2020       "E127: ".  
-00013fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fc0: 2020 2252 6f6f 6d5f 6372 6561 7465 2066    "Room_create f
-00013fd0: 6169 6c65 6420 7769 7468 2072 6573 706f  ailed with respo
-00013fe0: 6e73 653a 2022 0a20 2020 2020 2020 2020  nse: ".         
-00013ff0: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
-00014000: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00014010: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00014020: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00014030: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-00014040: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-00014050: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00014060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014070: 6966 2061 6c69 6173 3a0a 2020 2020 2020  if alias:.      
-00014080: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-00014090: 6c6c 5f61 6c69 6173 203d 2073 686f 7274  ll_alias = short
-000140a0: 5f72 6f6f 6d5f 616c 6961 735f 746f 5f72  _room_alias_to_r
-000140b0: 6f6f 6d5f 616c 6961 7328 0a20 2020 2020  oom_alias(.     
-000140c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140d0: 2020 2061 6c69 6173 2c20 6372 6564 656e     alias, creden
-000140e0: 7469 616c 730a 2020 2020 2020 2020 2020  tials.          
-000140f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00014100: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00014110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014120: 2020 2020 2020 6675 6c6c 5f61 6c69 6173        full_alias
-00014130: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00014140: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
-00014150: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-00014160: 2020 2020 2020 2020 2066 2743 7265 6174           f'Creat
-00014170: 6564 2072 6f6f 6d20 7769 7468 2072 6f6f  ed room with roo
-00014180: 6d20 6964 2022 7b72 6573 702e 726f 6f6d  m id "{resp.room
-00014190: 5f69 647d 222c 2027 0a20 2020 2020 2020  _id}", '.       
-000141a0: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-000141b0: 686f 7274 2061 6c69 6173 2022 7b7a 6e28  hort alias "{zn(
-000141c0: 616c 6961 7329 7d22 2c20 270a 2020 2020  alias)}", '.    
-000141d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141e0: 6627 6675 6c6c 2061 6c69 6173 2022 7b7a  f'full alias "{z
-000141f0: 6e28 6675 6c6c 5f61 6c69 6173 297d 2220  n(full_alias)}" 
-00014200: 616e 6420 270a 2020 2020 2020 2020 2020  and '.          
-00014210: 2020 2020 2020 2020 2020 6627 656e 6372            f'encr
-00014220: 7970 7465 6420 227b 656e 6372 7970 747d  ypted "{encrypt}
-00014230: 222e 270a 2020 2020 2020 2020 2020 2020  ".'.            
-00014240: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00014250: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
-00014260: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
-00014270: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
-00014280: 6167 0a20 2020 2020 2020 2020 2020 2020  ag.             
-00014290: 2020 2074 6578 7420 3d20 280a 2020 2020     text = (.    
-000142a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142b0: 6622 7b72 6573 702e 726f 6f6d 5f69 647d  f"{resp.room_id}
-000142c0: 7b53 4550 7d7b 7a6e 2861 6c69 6173 297d  {SEP}{zn(alias)}
-000142d0: 7b53 4550 7d7b 7a6e 2866 756c 6c5f 616c  {SEP}{zn(full_al
-000142e0: 6961 7329 7d22 0a20 2020 2020 2020 2020  ias)}".         
-000142f0: 2020 2020 2020 2020 2020 2066 227b 5345             f"{SE
-00014300: 507d 7b7a 6e28 6e61 6d65 297d 7b53 4550  P}{zn(name)}{SEP
-00014310: 7d7b 7a6e 2874 6f70 6963 297d 7b53 4550  }{zn(topic)}{SEP
-00014320: 7d7b 656e 6372 7970 747d 220a 2020 2020  }{encrypt}".    
-00014330: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00014340: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00014350: 4f62 6a65 6374 206f 6620 7479 7065 2052  Object of type R
-00014360: 6f6f 6d43 7265 6174 6552 6573 706f 6e73  oomCreateRespons
-00014370: 6520 6973 206e 6f74 204a 534f 4e0a 2020  e is not JSON.  
-00014380: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00014390: 7365 7269 616c 697a 6162 6c65 2c20 6865  serializable, he
-000143a0: 6e63 6520 7765 2075 7365 2074 6865 2064  nce we use the d
-000143b0: 6963 7469 6f6e 6172 792e 0a20 2020 2020  ictionary..     
-000143c0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-000143d0: 6d61 7820 3d20 7265 7370 2e5f 5f64 6963  max = resp.__dic
-000143e0: 745f 5f0a 2020 2020 2020 2020 2020 2020  t__.            
-000143f0: 2020 2020 2320 7265 7370 2068 6173 206f      # resp has o
-00014400: 6e6c 7920 3120 7573 6566 756c 2075 7365  nly 1 useful use
-00014410: 6675 6c20 6d65 6d62 6572 3a20 726f 6f6d  ful member: room
-00014420: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-00014430: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
-00014440: 6174 6528 7b22 616c 6961 7322 3a20 616c  ate({"alias": al
-00014450: 6961 737d 2920 2023 2061 6464 2064 6963  ias})  # add dic
-00014460: 7420 6974 656d 730a 2020 2020 2020 2020  t items.        
-00014470: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-00014480: 2e75 7064 6174 6528 7b22 616c 6961 735f  .update({"alias_
-00014490: 6675 6c6c 223a 2066 756c 6c5f 616c 6961  full": full_alia
-000144a0: 737d 290a 2020 2020 2020 2020 2020 2020  s}).            
-000144b0: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
-000144c0: 6174 6528 7b22 6e61 6d65 223a 206e 616d  ate({"name": nam
-000144d0: 657d 290a 2020 2020 2020 2020 2020 2020  e}).            
-000144e0: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
-000144f0: 6174 6528 7b22 746f 7069 6322 3a20 746f  ate({"topic": to
-00014500: 7069 637d 290a 2020 2020 2020 2020 2020  pic}).          
-00014510: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
-00014520: 7064 6174 6528 7b22 656e 6372 7970 7465  pdate({"encrypte
-00014530: 6422 3a20 656e 6372 7970 747d 290a 2020  d": encrypt}).  
-00014540: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00014550: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
-00014560: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-00014570: 2020 2020 2020 6a73 6f6e 5f2e 706f 7028        json_.pop(
-00014580: 2274 7261 6e73 706f 7274 5f72 6573 706f  "transport_respo
-00014590: 6e73 6522 290a 2020 2020 2020 2020 2020  nse").          
-000145a0: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
-000145b0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-000145c0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
-000145d0: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
-000145e0: 2020 2020 2020 2020 2067 732e 7061 2e6f           gs.pa.o
-000145f0: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
-00014600: 2020 2020 2020 2020 2020 2074 6578 743d             text=
-00014610: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
-00014620: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
-00014630: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
-00014640: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00014650: 6d61 783d 6a73 6f6e 5f6d 6178 2c0a 2020  max=json_max,.  
-00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014670: 2020 6a73 6f6e 5f73 7065 633d 6a73 6f6e    json_spec=json
-00014680: 5f73 7065 632c 0a20 2020 2020 2020 2020  _spec,.         
-00014690: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000146a0: 2020 2020 2069 6e64 6578 203d 2069 6e64       index = ind
-000146b0: 6578 202b 2031 0a20 2020 2065 7863 6570  ex + 1.    excep
-000146c0: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
-000146d0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-000146e0: 7228 2245 3132 383a 2022 2022 526f 6f6d  r("E128: " "Room
-000146f0: 2063 7265 6174 696f 6e20 6661 696c 6564   creation failed
-00014700: 2e20 536f 7272 792e 2229 0a20 2020 2020  . Sorry.").     
-00014710: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-00014720: 2b3d 2031 0a20 2020 2020 2020 2067 732e  += 1.        gs.
-00014730: 6c6f 672e 6465 6275 6728 2248 6572 6520  log.debug("Here 
-00014740: 6973 2074 6865 2074 7261 6365 6261 636b  is the traceback
-00014750: 2e5c 6e22 202b 2074 7261 6365 6261 636b  .\n" + traceback
-00014760: 2e66 6f72 6d61 745f 6578 6328 2929 0a0a  .format_exc())..
-00014770: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
-00014780: 6e5f 726f 6f6d 5f6a 6f69 6e28 636c 6965  n_room_join(clie
-00014790: 6e74 2c20 6372 6564 656e 7469 616c 7329  nt, credentials)
-000147a0: 3a0a 2020 2020 2222 224a 6f69 6e20 6f6e  :.    """Join on
-000147b0: 6520 6f72 206d 756c 7469 706c 6520 726f  e or multiple ro
-000147c0: 6f6d 732e 2222 220a 2020 2020 726f 6f6d  oms.""".    room
-000147d0: 7320 3d20 6773 2e70 612e 726f 6f6d 5f6a  s = gs.pa.room_j
-000147e0: 6f69 6e0a 2020 2020 7472 793a 0a20 2020  oin.    try:.   
-000147f0: 2020 2020 2066 6f72 2072 6f6f 6d5f 6964       for room_id
-00014800: 2069 6e20 726f 6f6d 733a 0a20 2020 2020   in rooms:.     
-00014810: 2020 2020 2020 2023 2072 6f6f 6d5f 6964         # room_id
-00014820: 2063 616e 2062 6520 2372 6f6f 6d41 6c69   can be #roomAli
-00014830: 6173 206f 7220 2172 6f6f 6d49 640a 2020  as or !roomId.  
-00014840: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00014850: 2e64 6562 7567 2866 2750 7265 7061 7269  .debug(f'Prepari
-00014860: 6e67 2074 6f20 6a6f 696e 2072 6f6f 6d20  ng to join room 
-00014870: 227b 726f 6f6d 5f69 647d 222e 2729 0a20  "{room_id}".'). 
-00014880: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-00014890: 6964 203d 2061 7761 6974 206d 6170 5f72  id = await map_r
-000148a0: 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f 6d69  oominfo_to_roomi
-000148b0: 6428 636c 6965 6e74 2c20 726f 6f6d 5f69  d(client, room_i
-000148c0: 6429 0a20 2020 2020 2020 2020 2020 2067  d).            g
-000148d0: 732e 6c6f 672e 6465 6275 6728 6627 4a6f  s.log.debug(f'Jo
-000148e0: 696e 696e 6720 726f 6f6d 2022 7b72 6f6f  ining room "{roo
-000148f0: 6d5f 6964 7d22 2e27 290a 2020 2020 2020  m_id}".').      
-00014900: 2020 2020 2020 7265 7370 203d 2061 7761        resp = awa
-00014910: 6974 2063 6c69 656e 742e 6a6f 696e 2872  it client.join(r
-00014920: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
-00014930: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00014940: 6528 7265 7370 2c20 4a6f 696e 4572 726f  e(resp, JoinErro
-00014950: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00014960: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00014970: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00014980: 2020 2020 2020 2245 3132 393a 2022 2066        "E129: " f
-00014990: 226a 6f69 6e20 6661 696c 6564 2077 6974  "join failed wit
-000149a0: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
-000149b0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-000149c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000149d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000149e0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-000149f0: 2031 0a20 2020 2020 2020 2020 2020 2065   1.            e
-00014a00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00014a10: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-00014a20: 2866 274a 6f69 6e65 6420 726f 6f6d 2022  (f'Joined room "
-00014a30: 7b72 6f6f 6d5f 6964 7d22 2073 7563 6365  {room_id}" succe
-00014a40: 7373 6675 6c6c 792e 2729 0a20 2020 2065  ssfully.').    e
-00014a50: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-00014a60: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00014a70: 6572 726f 7228 2245 3133 303a 2022 2022  error("E130: " "
-00014a80: 4a6f 696e 696e 6720 726f 6f6d 7320 6661  Joining rooms fa
-00014a90: 696c 6564 2e20 536f 7272 792e 2229 0a20  iled. Sorry."). 
-00014aa0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-00014ab0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00014ac0: 2067 732e 6c6f 672e 6465 6275 6728 2248   gs.log.debug("H
-00014ad0: 6572 6520 6973 2074 6865 2074 7261 6365  ere is the trace
-00014ae0: 6261 636b 2e5c 6e22 202b 2074 7261 6365  back.\n" + trace
-00014af0: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
-00014b00: 2929 0a0a 0a61 7379 6e63 2064 6566 2061  ))...async def a
-00014b10: 6374 696f 6e5f 726f 6f6d 5f6c 6561 7665  ction_room_leave
-00014b20: 2863 6c69 656e 742c 2063 7265 6465 6e74  (client, credent
-00014b30: 6961 6c73 293a 0a20 2020 2022 2222 4c65  ials):.    """Le
-00014b40: 6176 6520 6f6e 6520 6f72 206d 756c 7469  ave one or multi
-00014b50: 706c 6520 726f 6f6d 732e 2222 220a 2020  ple rooms.""".  
-00014b60: 2020 726f 6f6d 7320 3d20 6773 2e70 612e    rooms = gs.pa.
-00014b70: 726f 6f6d 5f6c 6561 7665 0a20 2020 2074  room_leave.    t
-00014b80: 7279 3a0a 2020 2020 2020 2020 666f 7220  ry:.        for 
-00014b90: 726f 6f6d 5f69 6420 696e 2072 6f6f 6d73  room_id in rooms
-00014ba0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00014bb0: 726f 6f6d 5f69 6420 6361 6e20 6265 2023  room_id can be #
-00014bc0: 726f 6f6d 416c 6961 7320 6f72 2021 726f  roomAlias or !ro
-00014bd0: 6f6d 4964 0a20 2020 2020 2020 2020 2020  omId.           
-00014be0: 2067 732e 6c6f 672e 6465 6275 6728 6627   gs.log.debug(f'
-00014bf0: 5072 6570 6172 696e 6720 746f 206c 6561  Preparing to lea
-00014c00: 7665 2072 6f6f 6d20 227b 726f 6f6d 5f69  ve room "{room_i
-00014c10: 647d 222e 2729 0a20 2020 2020 2020 2020  d}".').         
-00014c20: 2020 2072 6f6f 6d5f 6964 203d 2061 7761     room_id = awa
-00014c30: 6974 206d 6170 5f72 6f6f 6d69 6e66 6f5f  it map_roominfo_
-00014c40: 746f 5f72 6f6f 6d69 6428 636c 6965 6e74  to_roomid(client
-00014c50: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
-00014c60: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00014c70: 6275 6728 6627 4c65 6176 696e 6720 726f  bug(f'Leaving ro
-00014c80: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e27  om "{room_id}".'
-00014c90: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00014ca0: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-00014cb0: 742e 726f 6f6d 5f6c 6561 7665 2872 6f6f  t.room_leave(roo
-00014cc0: 6d5f 6964 290a 2020 2020 2020 2020 2020  m_id).          
-00014cd0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00014ce0: 7265 7370 2c20 526f 6f6d 4c65 6176 6545  resp, RoomLeaveE
-00014cf0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00014d00: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00014d10: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00014d20: 2020 2020 2020 2020 2022 4531 3331 3a20           "E131: 
-00014d30: 2220 6622 4c65 6176 6520 6661 696c 6564  " f"Leave failed
-00014d40: 2077 6974 6820 7b70 7269 7661 6379 5f66   with {privacy_f
-00014d50: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-00014d60: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00014d70: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00014d80: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-00014d90: 7420 2b3d 2031 0a20 2020 2020 2020 2020  t += 1.         
-00014da0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00014db0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00014dc0: 696e 666f 2866 274c 6566 7420 726f 6f6d  info(f'Left room
-00014dd0: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 290a   "{room_id}".').
-00014de0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00014df0: 7469 6f6e 3a0a 2020 2020 2020 2020 6773  tion:.        gs
-00014e00: 2e6c 6f67 2e65 7272 6f72 2822 4531 3332  .log.error("E132
-00014e10: 3a20 2220 2252 6f6f 6d20 6c65 6176 6520  : " "Room leave 
-00014e20: 6661 696c 6564 2e20 536f 7272 792e 2229  failed. Sorry.")
-00014e30: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
-00014e40: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00014e50: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00014e60: 2248 6572 6520 6973 2074 6865 2074 7261  "Here is the tra
-00014e70: 6365 6261 636b 2e5c 6e22 202b 2074 7261  ceback.\n" + tra
-00014e80: 6365 6261 636b 2e66 6f72 6d61 745f 6578  ceback.format_ex
-00014e90: 6328 2929 0a0a 0a61 7379 6e63 2064 6566  c())...async def
-00014ea0: 2061 6374 696f 6e5f 726f 6f6d 5f66 6f72   action_room_for
-00014eb0: 6765 7428 636c 6965 6e74 2c20 6372 6564  get(client, cred
-00014ec0: 656e 7469 616c 7329 3a0a 2020 2020 2222  entials):.    ""
-00014ed0: 2246 6f72 6765 7420 6f6e 6520 6f72 206d  "Forget one or m
-00014ee0: 756c 7469 706c 6520 726f 6f6d 732e 2222  ultiple rooms.""
-00014ef0: 220a 2020 2020 726f 6f6d 7320 3d20 6773  ".    rooms = gs
-00014f00: 2e70 612e 726f 6f6d 5f66 6f72 6765 740a  .pa.room_forget.
-00014f10: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00014f20: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
-00014f30: 726f 6f6d 733a 0a20 2020 2020 2020 2020  rooms:.         
-00014f40: 2020 2023 2072 6f6f 6d5f 6964 2063 616e     # room_id can
-00014f50: 2062 6520 2372 6f6f 6d41 6c69 6173 206f   be #roomAlias o
-00014f60: 7220 2172 6f6f 6d49 640a 2020 2020 2020  r !roomId.      
-00014f70: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00014f80: 7567 2866 2750 7265 7061 7269 6e67 2074  ug(f'Preparing t
-00014f90: 6f20 666f 7267 6574 2072 6f6f 6d20 227b  o forget room "{
-00014fa0: 726f 6f6d 5f69 647d 222e 2729 0a20 2020  room_id}".').   
-00014fb0: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
-00014fc0: 203d 2061 7761 6974 206d 6170 5f72 6f6f   = await map_roo
-00014fd0: 6d69 6e66 6f5f 746f 5f72 6f6f 6d69 6428  minfo_to_roomid(
-00014fe0: 636c 6965 6e74 2c20 726f 6f6d 5f69 6429  client, room_id)
-00014ff0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00015000: 6c6f 672e 6465 6275 6728 6627 466f 7267  log.debug(f'Forg
-00015010: 6574 7469 6e67 2072 6f6f 6d20 227b 726f  etting room "{ro
-00015020: 6f6d 5f69 647d 222e 2729 0a20 2020 2020  om_id}".').     
-00015030: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-00015040: 6169 7420 636c 6965 6e74 2e72 6f6f 6d5f  ait client.room_
-00015050: 666f 7267 6574 2872 6f6f 6d5f 6964 290a  forget(room_id).
-00015060: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00015070: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
-00015080: 526f 6f6d 466f 7267 6574 4572 726f 7229  RoomForgetError)
-00015090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000150a0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-000150b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150c0: 2020 2020 2245 3133 333a 2022 2066 2246      "E133: " f"F
-000150d0: 6f72 6765 7420 6661 696c 6564 2077 6974  orget failed wit
-000150e0: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
-000150f0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-00015100: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00015110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015120: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-00015130: 2031 0a20 2020 2020 2020 2020 2020 2065   1.            e
-00015140: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00015150: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-00015160: 2866 2746 6f72 676f 7420 726f 6f6d 2022  (f'Forgot room "
-00015170: 7b72 6f6f 6d5f 6964 7d22 2e27 290a 2020  {room_id}".').  
-00015180: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00015190: 6f6e 3a0a 2020 2020 2020 2020 6773 2e6c  on:.        gs.l
-000151a0: 6f67 2e65 7272 6f72 2822 4531 3334 3a20  og.error("E134: 
-000151b0: 2220 2252 6f6f 6d20 666f 7267 6574 2066  " "Room forget f
-000151c0: 6169 6c65 642e 2053 6f72 7279 2e22 290a  ailed. Sorry.").
-000151d0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-000151e0: 6562 7567 2822 4865 7265 2069 7320 7468  ebug("Here is th
-000151f0: 6520 7472 6163 6562 6163 6b2e 5c6e 2220  e traceback.\n" 
-00015200: 2b20 7472 6163 6562 6163 6b2e 666f 726d  + traceback.form
-00015210: 6174 5f65 7863 2829 290a 0a0a 6173 796e  at_exc())...asyn
-00015220: 6320 6465 6620 6163 7469 6f6e 5f72 6f6f  c def action_roo
-00015230: 6d5f 696e 7669 7465 2863 6c69 656e 742c  m_invite(client,
-00015240: 2063 7265 6465 6e74 6961 6c73 293a 0a20   credentials):. 
-00015250: 2020 2022 2222 496e 7669 7465 206f 6e65     """Invite one
-00015260: 206f 7220 6d75 6c74 6970 6c65 2075 7365   or multiple use
-00015270: 7273 2074 6f20 6f6e 6520 6f72 206d 756c  rs to one or mul
-00015280: 7469 706c 6520 726f 6f6d 732e 2222 220a  tiple rooms.""".
-00015290: 2020 2020 726f 6f6d 7320 3d20 6773 2e70      rooms = gs.p
-000152a0: 612e 726f 6f6d 5f69 6e76 6974 650a 2020  a.room_invite.  
-000152b0: 2020 7573 6572 7320 3d20 6773 2e70 612e    users = gs.pa.
-000152c0: 7573 6572 0a20 2020 2074 7279 3a0a 2020  user.    try:.  
-000152d0: 2020 2020 2020 666f 7220 726f 6f6d 5f69        for room_i
-000152e0: 6420 696e 2072 6f6f 6d73 3a0a 2020 2020  d in rooms:.    
-000152f0: 2020 2020 2020 2020 2320 726f 6f6d 5f69          # room_i
-00015300: 6420 6361 6e20 6265 2023 726f 6f6d 416c  d can be #roomAl
-00015310: 6961 7320 6f72 2021 726f 6f6d 4964 0a20  ias or !roomId. 
-00015320: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00015330: 672e 6465 6275 6728 6627 5072 6570 6172  g.debug(f'Prepar
-00015340: 696e 6720 746f 2069 6e76 6974 6520 746f  ing to invite to
-00015350: 2072 6f6f 6d20 227b 726f 6f6d 5f69 647d   room "{room_id}
-00015360: 222e 2729 0a20 2020 2020 2020 2020 2020  ".').           
-00015370: 2072 6f6f 6d5f 6964 203d 2061 7761 6974   room_id = await
-00015380: 206d 6170 5f72 6f6f 6d69 6e66 6f5f 746f   map_roominfo_to
-00015390: 5f72 6f6f 6d69 6428 636c 6965 6e74 2c20  _roomid(client, 
-000153a0: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
-000153b0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-000153c0: 6728 6627 496e 7669 7469 6e67 2074 6f20  g(f'Inviting to 
-000153d0: 726f 6f6d 2022 7b72 6f6f 6d5f 6964 7d22  room "{room_id}"
-000153e0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-000153f0: 666f 7220 7573 6572 2069 6e20 7573 6572  for user in user
-00015400: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00015410: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00015420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015430: 2020 2020 2066 2749 6e76 6974 696e 6720       f'Inviting 
-00015440: 7573 6572 2022 7b75 7365 727d 2220 746f  user "{user}" to
-00015450: 2072 6f6f 6d20 7769 7468 2027 0a20 2020   room with '.   
-00015460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015470: 2066 2772 6f6f 6d20 616c 6961 7320 227b   f'room alias "{
-00015480: 726f 6f6d 5f69 647d 222e 270a 2020 2020  room_id}".'.    
-00015490: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000154a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000154b0: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-000154c0: 742e 726f 6f6d 5f69 6e76 6974 6528 726f  t.room_invite(ro
-000154d0: 6f6d 5f69 642c 2075 7365 7229 0a20 2020  om_id, user).   
-000154e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000154f0: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-00015500: 2052 6f6f 6d49 6e76 6974 6545 7272 6f72   RoomInviteError
-00015510: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00015520: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00015530: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00015540: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
-00015550: 3335 3a20 220a 2020 2020 2020 2020 2020  35: ".          
-00015560: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00015570: 726f 6f6d 5f69 6e76 6974 6520 6661 696c  room_invite fail
-00015580: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
-00015590: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-000155a0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
-000155b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000155c0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000155d0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-000155e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000155f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00015600: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00015610: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
+0000ac10: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000ac20: 2020 2065 6c73 653a 2020 2320 4320 6f72     else:  # C or
+0000ac30: 2061 6e79 7468 696e 6720 666f 7220 6361   anything for ca
+0000ac40: 6e63 656c 0a20 2020 2020 2020 2020 2020  ncel.           
+0000ac50: 2020 2020 2020 2020 2070 7269 6e74 280a           print(.
+0000ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac70: 2020 2020 2020 2020 2243 616e 6365 6c6c          "Cancell
+0000ac80: 6564 2062 7920 7573 6572 2120 5665 7269  ed by user! Veri
+0000ac90: 6669 6361 7469 6f6e 2077 696c 6c20 6265  fication will be
+0000aca0: 2063 616e 6365 6c6c 6564 2e22 2c0a 2020   cancelled.",.  
+0000acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acc0: 2020 2020 2020 6669 6c65 3d73 7973 2e73        file=sys.s
+0000acd0: 7464 6572 722c 0a20 2020 2020 2020 2020  tderr,.         
+0000ace0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000acf0: 6c75 7368 3d54 7275 652c 0a20 2020 2020  lush=True,.     
+0000ad00: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000ad10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ad20: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
+0000ad30: 7420 636c 6965 6e74 2e63 616e 6365 6c5f  t client.cancel_
+0000ad40: 6b65 795f 7665 7269 6669 6361 7469 6f6e  key_verification
+0000ad50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000ad60: 2020 2020 2020 2020 2020 6576 656e 742e            event.
+0000ad70: 7472 616e 7361 6374 696f 6e5f 6964 2c20  transaction_id, 
+0000ad80: 7265 6a65 6374 3d46 616c 7365 0a20 2020  reject=False.   
+0000ad90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ada0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000adb0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000adc0: 616e 6365 2872 6573 702c 2054 6f44 6576  ance(resp, ToDev
+0000add0: 6963 6545 7272 6f72 293a 0a20 2020 2020  iceError):.     
+0000ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000adf0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+0000ae00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ae10: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
+0000ae20: 3133 3a20 220a 2020 2020 2020 2020 2020  13: ".          
+0000ae30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae40: 2020 2263 616e 6365 6c5f 6b65 795f 7665    "cancel_key_ve
+0000ae50: 7269 6669 6361 7469 6f6e 2066 6169 6c65  rification faile
+0000ae60: 6420 7769 7468 2022 0a20 2020 2020 2020  d with ".       
+0000ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae80: 2020 2020 2066 2227 7b70 7269 7661 6379       f"'{privacy
+0000ae90: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+0000aea0: 2929 7d27 2e22 0a20 2020 2020 2020 2020  ))}'.".         
+0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000aec0: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+0000aed0: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
+0000aee0: 656e 742c 204b 6579 5665 7269 6669 6361  ent, KeyVerifica
+0000aef0: 7469 6f6e 4d61 6329 3a20 2023 2074 6869  tionMac):  # thi
+0000af00: 7264 2073 7465 700a 2020 2020 2020 2020  rd step.        
+0000af10: 2020 2020 2020 2020 2222 2254 6869 7264          """Third
+0000af20: 2073 7465 7020 6973 2074 6f20 7265 6365   step is to rece
+0000af30: 6976 6520 4b65 7956 6572 6966 6963 6174  ive KeyVerificat
+0000af40: 696f 6e4d 6163 0a20 2020 2020 2020 2020  ionMac.         
+0000af50: 2020 2020 2020 204b 6579 5665 7269 6669         KeyVerifi
+0000af60: 6361 7469 6f6e 4d61 6328 0a20 2020 2020  cationMac(.     
+0000af70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000af80: 6f75 7263 653d 7b27 636f 6e74 656e 7427  ource={'content'
+0000af90: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+0000afa0: 2020 2020 2020 2020 2020 2020 276d 6163              'mac
+0000afb0: 273a 207b 2765 6432 3535 3139 3a44 4556  ': {'ed25519:DEV
+0000afc0: 4943 4549 4458 5927 3a20 2753 6f6d 654b  ICEIDXY': 'SomeK
+0000afd0: 6579 3127 2c0a 2020 2020 2020 2020 2020  ey1',.          
+0000afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aff0: 2020 2020 2020 2765 6432 3535 3139 3a53        'ed25519:S
+0000b000: 6f6d 654b 6579 3227 3a20 2753 6f6d 654b  omeKey2': 'SomeK
+0000b010: 6579 3327 7d2c 0a20 2020 2020 2020 2020  ey3'},.         
+0000b020: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000b030: 6b65 7973 273a 2027 536f 6d65 4372 7970  keys': 'SomeCryp
+0000b040: 746f 4b65 7934 272c 0a20 2020 2020 2020  toKey4',.       
+0000b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b060: 2027 7472 616e 7361 6374 696f 6e5f 6964   'transaction_id
+0000b070: 273a 2027 536f 6d65 5478 4964 277d 2c0a  ': 'SomeTxId'},.
+0000b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b090: 2020 2020 2020 2020 2774 7970 6527 3a20          'type': 
+0000b0a0: 276d 2e6b 6579 2e76 6572 6966 6963 6174  'm.key.verificat
+0000b0b0: 696f 6e2e 6d61 6327 2c0a 2020 2020 2020  ion.mac',.      
+0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0d0: 2020 2773 656e 6465 7227 3a20 2740 7573    'sender': '@us
+0000b0e0: 6572 323a 6578 616d 706c 652e 6f72 6727  er2:example.org'
+0000b0f0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+0000b100: 2020 2020 2020 2073 656e 6465 723d 2740         sender='@
+0000b110: 7573 6572 323a 6578 616d 706c 652e 6f72  user2:example.or
+0000b120: 6727 2c0a 2020 2020 2020 2020 2020 2020  g',.            
+0000b130: 2020 2020 2020 2020 7472 616e 7361 6374          transact
+0000b140: 696f 6e5f 6964 3d27 536f 6d65 5478 4964  ion_id='SomeTxId
+0000b150: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0000b160: 2020 2020 2020 206d 6163 3d7b 2765 6432         mac={'ed2
+0000b170: 3535 3139 3a44 4556 4943 4549 4458 5927  5519:DEVICEIDXY'
+0000b180: 3a20 2753 6f6d 654b 6579 3127 2c0a 2020  : 'SomeKey1',.  
+0000b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1a0: 2020 2020 2020 2027 6564 3235 3531 393a         'ed25519:
+0000b1b0: 536f 6d65 4b65 7932 273a 2027 536f 6d65  SomeKey2': 'Some
+0000b1c0: 4b65 7933 277d 2c0a 2020 2020 2020 2020  Key3'},.        
+0000b1d0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+0000b1e0: 3d27 536f 6d65 4372 7970 746f 4b65 7934  ='SomeCryptoKey4
+0000b1f0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0000b200: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+0000b210: 2020 2020 2020 2073 6173 203d 2063 6c69         sas = cli
+0000b220: 656e 742e 6b65 795f 7665 7269 6669 6361  ent.key_verifica
+0000b230: 7469 6f6e 735b 6576 656e 742e 7472 616e  tions[event.tran
+0000b240: 7361 6374 696f 6e5f 6964 5d0a 2020 2020  saction_id].    
+0000b250: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000b260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b270: 2020 2020 2074 6f64 6576 6963 655f 6d73       todevice_ms
+0000b280: 6720 3d20 7361 732e 6765 745f 6d61 6328  g = sas.get_mac(
+0000b290: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000b2a0: 2020 6578 6365 7074 204c 6f63 616c 5072    except LocalPr
+0000b2b0: 6f74 6f63 6f6c 4572 726f 7220 6173 2065  otocolError as e
+0000b2c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b2d0: 2020 2020 2020 2320 652e 672e 2069 7420        # e.g. it 
+0000b2e0: 6d69 6768 7420 6861 7665 2062 6565 6e20  might have been 
+0000b2f0: 6361 6e63 656c 6c65 6420 6279 206f 7572  cancelled by our
+0000b300: 7365 6c76 6573 0a20 2020 2020 2020 2020  selves.         
+0000b310: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0000b320: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
+0000b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b340: 2022 4531 3134 3a20 220a 2020 2020 2020   "E114: ".      
+0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b360: 2020 6622 4361 6e63 656c 6c65 6420 6f72    f"Cancelled or
+0000b370: 2070 726f 746f 636f 6c20 6572 726f 723a   protocol error:
+0000b380: 2052 6561 736f 6e3a 207b 657d 2e5c 6e22   Reason: {e}.\n"
+0000b390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b3a0: 2020 2020 2020 2020 2066 2256 6572 6966           f"Verif
+0000b3b0: 6963 6174 696f 6e20 7769 7468 207b 6576  ication with {ev
+0000b3c0: 656e 742e 7365 6e64 6572 7d20 6e6f 7420  ent.sender} not 
+0000b3d0: 636f 6e63 6c75 6465 642e 2022 0a20 2020  concluded. ".   
+0000b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3f0: 2020 2020 2022 5472 7920 6167 6169 6e3f       "Try again?
+0000b400: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000b410: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000b420: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b440: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
+0000b450: 6c69 656e 742e 746f 5f64 6576 6963 6528  lient.to_device(
+0000b460: 746f 6465 7669 6365 5f6d 7367 290a 2020  todevice_msg).  
+0000b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b480: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000b490: 7265 7370 2c20 546f 4465 7669 6365 4572  resp, ToDeviceEr
+0000b4a0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000b4b0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+0000b4c0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4e0: 2020 2020 2020 2020 2245 3131 353a 2022          "E115: "
+0000b4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b500: 2020 2020 2020 2020 2020 2020 2022 746f               "to
+0000b510: 5f64 6576 6963 6520 6661 696c 6564 2077  _device failed w
+0000b520: 6974 6820 6572 726f 7220 220a 2020 2020  ith error ".    
+0000b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b540: 2020 2020 2020 2020 6622 277b 7072 6976          f"'{priv
+0000b550: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+0000b560: 6573 7029 297d 272e 220a 2020 2020 2020  esp))}'.".      
+0000b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b580: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000b590: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
+0000b5a0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+0000b5b0: 2020 2020 2020 2020 2020 2020 2066 2273               f"s
+0000b5c0: 6173 2e77 655f 7374 6172 7465 645f 6974  as.we_started_it
+0000b5d0: 203d 207b 7361 732e 7765 5f73 7461 7274   = {sas.we_start
+0000b5e0: 6564 5f69 747d 5c6e 220a 2020 2020 2020  ed_it}\n".      
+0000b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b600: 2020 6622 7361 732e 7361 735f 6163 6365    f"sas.sas_acce
+0000b610: 7074 6564 203d 207b 7361 732e 7361 735f  pted = {sas.sas_
+0000b620: 6163 6365 7074 6564 7d5c 6e22 0a20 2020  accepted}\n".   
+0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b640: 2020 2020 2066 2273 6173 2e63 616e 6365       f"sas.cance
+0000b650: 6c65 6420 3d20 7b73 6173 2e63 616e 6365  led = {sas.cance
+0000b660: 6c65 647d 5c6e 220a 2020 2020 2020 2020  led}\n".        
+0000b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b680: 6622 7361 732e 7469 6d65 645f 6f75 7420  f"sas.timed_out 
+0000b690: 3d20 7b73 6173 2e74 696d 6564 5f6f 7574  = {sas.timed_out
+0000b6a0: 7d5c 6e22 0a20 2020 2020 2020 2020 2020  }\n".           
+0000b6b0: 2020 2020 2020 2020 2020 2020 2066 2273               f"s
+0000b6c0: 6173 2e76 6572 6966 6965 6420 3d20 7b73  as.verified = {s
+0000b6d0: 6173 2e76 6572 6966 6965 647d 5c6e 220a  as.verified}\n".
+0000b6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6f0: 2020 2020 2020 2020 6622 7361 732e 7665          f"sas.ve
+0000b700: 7269 6669 6564 5f64 6576 6963 6573 203d  rified_devices =
+0000b710: 207b 7361 732e 7665 7269 6669 6564 5f64   {sas.verified_d
+0000b720: 6576 6963 6573 7d5c 6e22 0a20 2020 2020  evices}\n".     
+0000b730: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000b740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b750: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
+0000b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b770: 2020 2020 2245 6d6f 6a69 2076 6572 6966      "Emoji verif
+0000b780: 6963 6174 696f 6e20 7761 7320 7375 6363  ication was succ
+0000b790: 6573 7366 756c 215c 6e22 0a20 2020 2020  essful!\n".     
+0000b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7b0: 2020 2022 5665 7269 6679 2077 6974 6820     "Verify with 
+0000b7c0: 6f74 6865 7220 6465 7669 6365 7320 6f72  other devices or
+0000b7d0: 2068 6974 2043 6f6e 7472 6f6c 2d43 2074   hit Control-C t
+0000b7e0: 6f20 220a 2020 2020 2020 2020 2020 2020  o ".            
+0000b7f0: 2020 2020 2020 2020 2020 2020 2263 6f6e              "con
+0000b800: 7469 6e75 652e 222c 0a20 2020 2020 2020  tinue.",.       
+0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b820: 2066 696c 653d 7379 732e 7374 646f 7574   file=sys.stdout
+0000b830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b840: 2020 2020 2020 2020 2020 666c 7573 683d            flush=
+0000b850: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000b860: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000b870: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000b880: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+0000b890: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+0000b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8b0: 2245 3131 363a 2022 0a20 2020 2020 2020  "E116: ".       
+0000b8c0: 2020 2020 2020 2020 2020 2020 2066 2252               f"R
+0000b8d0: 6563 6569 7665 6420 756e 6578 7065 6374  eceived unexpect
+0000b8e0: 6564 2065 7665 6e74 2074 7970 6520 7b74  ed event type {t
+0000b8f0: 7970 6528 6576 656e 7429 7d2e 2022 0a20  ype(event)}. ". 
+0000b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b910: 2020 2066 2245 7665 6e74 2069 7320 7b65     f"Event is {e
+0000b920: 7665 6e74 7d2e 2045 7665 6e74 2077 696c  vent}. Event wil
+0000b930: 6c20 6265 2069 676e 6f72 6564 2e22 0a20  l be ignored.". 
+0000b940: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000b950: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000b960: 4261 7365 4578 6365 7074 696f 6e3a 0a20  BaseException:. 
+0000b970: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0000b980: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
+0000b990: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
+0000b9a0: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
+0000b9b0: 6f72 6d61 745f 6578 6328 2929 0a0a 0a64  ormat_exc())...d
+0000b9c0: 6566 206e 6f74 6966 7928 7469 746c 653a  ef notify(title:
+0000b9d0: 2073 7472 2c20 636f 6e74 656e 743a 2073   str, content: s
+0000b9e0: 7472 2c20 696d 6167 655f 7572 6c3a 2073  tr, image_url: s
+0000b9f0: 7472 293a 0a20 2020 2022 2222 4e6f 7469  tr):.    """Noti
+0000ba00: 6679 204f 5320 6f66 206d 6573 7361 6765  fy OS of message
+0000ba10: 2072 6563 6569 7074 2e0a 0a20 2020 2049   receipt...    I
+0000ba20: 6620 7468 6520 7379 7374 656d 2069 7320  f the system is 
+0000ba30: 7275 6e6e 696e 6720 6865 6164 6c65 7373  running headless
+0000ba40: 206f 7220 616e 7920 7072 6f62 6c65 6d20   or any problem 
+0000ba50: 6861 7070 656e 7320 7769 7468 0a20 2020  happens with.   
+0000ba60: 206f 7065 7261 7469 6e67 2073 7973 7465   operating syste
+0000ba70: 6d20 6e6f 7469 6669 6361 7469 6f6e 732c  m notifications,
+0000ba80: 2069 676e 6f72 6520 6974 2e0a 2020 2020   ignore it..    
+0000ba90: 2222 220a 2020 2020 6966 206e 6f74 2048  """.    if not H
+0000baa0: 4156 455f 4e4f 5449 4659 3a0a 2020 2020  AVE_NOTIFY:.    
+0000bab0: 2020 2020 6773 2e6c 6f67 2e77 6172 6e69      gs.log.warni
+0000bac0: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+0000bad0: 2257 3130 303a 2022 0a20 2020 2020 2020  "W100: ".       
+0000bae0: 2020 2020 2022 6e6f 7469 6679 3220 6f72       "notify2 or
+0000baf0: 2064 6275 7320 6973 206e 6f74 2069 6e73   dbus is not ins
+0000bb00: 7461 6c6c 6564 2e20 4e6f 7469 6669 6361  talled. Notifica
+0000bb10: 7469 6f6e 7320 7769 6c6c 206e 6f74 2062  tions will not b
+0000bb20: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+0000bb30: 2264 6973 706c 6179 6564 2e20 220a 2020  "displayed. ".  
+0000bb40: 2020 2020 2020 2020 2020 224d 616b 6520            "Make 
+0000bb50: 7375 7265 2074 6861 7420 6e6f 7469 6679  sure that notify
+0000bb60: 3220 616e 6420 6462 7573 2061 7265 2069  2 and dbus are i
+0000bb70: 6e73 7461 6c6c 6564 206f 7220 7265 6d6f  nstalled or remo
+0000bb80: 7665 2074 6865 2022 0a20 2020 2020 2020  ve the ".       
+0000bb90: 2020 2020 2022 2d2d 6f73 2d6e 6f74 6966       "--os-notif
+0000bba0: 7920 6f70 7469 6f6e 2e22 0a20 2020 2020  y option.".     
+0000bbb0: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
+0000bbc0: 7761 726e 5f63 6f75 6e74 202b 3d20 310a  warn_count += 1.
+0000bbd0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0000bbe0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000bbf0: 6966 2069 6d61 6765 5f75 726c 3a0a 2020  if image_url:.  
+0000bc00: 2020 2020 2020 2020 2020 6e6f 7475 7365            notuse
+0000bc10: 642c 2061 7661 7461 725f 6669 6c65 203d  d, avatar_file =
+0000bc20: 2074 656d 7066 696c 652e 6d6b 7374 656d   tempfile.mkstem
+0000bc30: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
+0000bc40: 7572 6c6c 6962 2e72 6571 7565 7374 2e75  urllib.request.u
+0000bc50: 726c 7265 7472 6965 7665 2869 6d61 6765  rlretrieve(image
+0000bc60: 5f75 726c 2c20 6176 6174 6172 5f66 696c  _url, avatar_fil
+0000bc70: 6529 0a20 2020 2020 2020 2020 2020 2023  e).            #
+0000bc80: 2054 4f44 4f3a 2063 6c65 616e 7570 2074   TODO: cleanup t
+0000bc90: 656d 7020 6669 6c65 733f 2069 6e20 636c  emp files? in cl
+0000bca0: 6561 6e75 7028 293f 0a20 2020 2020 2020  eanup()?.       
+0000bcb0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000bcc0: 2020 2023 2049 636f 6e20 6e61 6d65 2022     # Icon name "
+0000bcd0: 6e6f 7469 6669 6361 7469 6f6e 2d6d 6573  notification-mes
+0000bce0: 7361 6765 2d49 4d22 2077 696c 6c20 776f  sage-IM" will wo
+0000bcf0: 726b 206f 6e20 5562 756e 7475 0a20 2020  rk on Ubuntu.   
+0000bd00: 2020 2020 2020 2020 2023 2062 7574 206e           # but n
+0000bd10: 6f74 2061 6c6c 2070 6c61 7466 6f72 6d73  ot all platforms
+0000bd20: 0a20 2020 2020 2020 2020 2020 2061 7661  .            ava
+0000bd30: 7461 725f 6669 6c65 203d 2022 6e6f 7469  tar_file = "noti
+0000bd40: 6669 6361 7469 6f6e 2d6d 6573 7361 6765  fication-message
+0000bd50: 2d49 4d22 0a20 2020 2020 2020 206e 6f74  -IM".        not
+0000bd60: 6966 7932 2e69 6e69 7428 5052 4f47 5f57  ify2.init(PROG_W
+0000bd70: 4954 484f 5554 5f45 5854 290a 2020 2020  ITHOUT_EXT).    
+0000bd80: 2020 2020 6e6f 7469 6679 322e 4e6f 7469      notify2.Noti
+0000bd90: 6669 6361 7469 6f6e 2874 6974 6c65 2c20  fication(title, 
+0000bda0: 636f 6e74 656e 742c 2061 7661 7461 725f  content, avatar_
+0000bdb0: 6669 6c65 292e 7368 6f77 2829 0a20 2020  file).show().   
+0000bdc0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+0000bdd0: 6728 6622 5368 6f77 6564 206e 6f74 6966  g(f"Showed notif
+0000bde0: 6963 6174 696f 6e20 666f 7220 7b74 6974  ication for {tit
+0000bdf0: 6c65 7d2e 2229 0a20 2020 2065 7863 6570  le}.").    excep
+0000be00: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0000be10: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+0000be20: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0000be30: 2020 2020 6622 5368 6f77 696e 6720 6e6f      f"Showing no
+0000be40: 7469 6669 6361 7469 6f6e 2066 6f72 207b  tification for {
+0000be50: 7469 746c 657d 2066 6169 6c65 642e 2045  title} failed. E
+0000be60: 7863 6570 7469 6f6e 3a20 7b65 7d22 0a20  xception: {e}". 
+0000be70: 2020 2020 2020 2020 2020 2066 225c 6e48             f"\nH
+0000be80: 6572 6520 6973 2074 6865 2074 7261 6365  ere is the trace
+0000be90: 6261 636b 3a5c 6e7b 7472 6163 6562 6163  back:\n{tracebac
+0000bea0: 6b2e 666f 726d 6174 5f65 7863 2829 7d22  k.format_exc()}"
+0000beb0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000bec0: 2020 2070 6173 730a 0a0a 6173 796e 6320     pass...async 
+0000bed0: 6465 6620 6765 745f 6176 6174 6172 5f75  def get_avatar_u
+0000bee0: 726c 2863 6c69 656e 743a 2041 7379 6e63  rl(client: Async
+0000bef0: 436c 6965 6e74 2c20 7573 6572 5f69 643a  Client, user_id:
+0000bf00: 2073 7472 2920 2d3e 2073 7472 3a0a 2020   str) -> str:.  
+0000bf10: 2020 2222 2247 6574 2068 7474 7073 2061    """Get https a
+0000bf20: 7661 7461 7220 5552 4c20 666f 7220 7573  vatar URL for us
+0000bf30: 6572 2075 7365 725f 6964 2e0a 0a20 2020  er user_id...   
+0000bf40: 2052 6574 7572 6e73 2055 524c 206f 7220   Returns URL or 
+0000bf50: 4e6f 6e65 2069 6620 7573 6572 2068 6173  None if user has
+0000bf60: 206e 6f20 6176 6174 6172 0a20 2020 2022   no avatar.    "
+0000bf70: 2222 0a20 2020 2061 7661 7461 725f 7572  "".    avatar_ur
+0000bf80: 6c20 3d20 4e6f 6e65 2020 2320 6465 6661  l = None  # defa
+0000bf90: 756c 740a 2020 2020 7265 7370 203d 2061  ult.    resp = a
+0000bfa0: 7761 6974 2063 6c69 656e 742e 6765 745f  wait client.get_
+0000bfb0: 6176 6174 6172 2875 7365 725f 6964 290a  avatar(user_id).
+0000bfc0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000bfd0: 6528 7265 7370 2c20 5072 6f66 696c 6547  e(resp, ProfileG
+0000bfe0: 6574 4176 6174 6172 5265 7370 6f6e 7365  etAvatarResponse
+0000bff0: 293a 0a20 2020 2020 2020 2067 732e 6c6f  ):.        gs.lo
+0000c000: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0000c010: 2020 2020 2022 5072 6f66 696c 6547 6574       "ProfileGet
+0000c020: 4176 6174 6172 5265 7370 6f6e 7365 2e20  AvatarResponse. 
+0000c030: 5265 7370 6f6e 7365 2069 733a 2022 0a20  Response is: ". 
+0000c040: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
+0000c050: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+0000c060: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+0000c070: 2020 290a 2020 2020 2020 2020 6176 6174    ).        avat
+0000c080: 6172 5f6d 7863 203d 2072 6573 702e 6176  ar_mxc = resp.av
+0000c090: 6174 6172 5f75 726c 0a20 2020 2020 2020  atar_url.       
+0000c0a0: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
+0000c0b0: 6176 6174 6172 5f6d 7863 2069 7320 7b61  avatar_mxc is {a
+0000c0c0: 7661 7461 725f 6d78 637d 2229 0a20 2020  vatar_mxc}").   
+0000c0d0: 2020 2020 2069 6620 6176 6174 6172 5f6d       if avatar_m
+0000c0e0: 7863 3a20 2023 2063 6f75 6c64 2062 6520  xc:  # could be 
+0000c0f0: 4e6f 6e65 2069 6620 6e6f 2061 7661 7461  None if no avata
+0000c100: 720a 2020 2020 2020 2020 2020 2020 6176  r.            av
+0000c110: 6174 6172 5f75 726c 203d 2061 7761 6974  atar_url = await
+0000c120: 2063 6c69 656e 742e 6d78 635f 746f 5f68   client.mxc_to_h
+0000c130: 7474 7028 6176 6174 6172 5f6d 7863 290a  ttp(avatar_mxc).
+0000c140: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000c150: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
+0000c160: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
+0000c170: 6c65 6420 6765 7474 696e 6720 6176 6174  led getting avat
+0000c180: 6172 2066 726f 6d20 7365 7276 6572 2e20  ar from server. 
+0000c190: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
+0000c1a0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
+0000c1b0: 2020 2020 2029 0a20 2020 2067 732e 6c6f       ).    gs.lo
+0000c1c0: 672e 6465 6275 6728 6622 6176 6174 6172  g.debug(f"avatar
+0000c1d0: 5f75 726c 2069 7320 7b61 7661 7461 725f  _url is {avatar_
+0000c1e0: 7572 6c7d 2229 0a20 2020 2072 6574 7572  url}").    retur
+0000c1f0: 6e20 6176 6174 6172 5f75 726c 0a0a 0a64  n avatar_url...d
+0000c200: 6566 2063 7265 6174 655f 7069 645f 6669  ef create_pid_fi
+0000c210: 6c65 2829 202d 3e20 4e6f 6e65 3a0a 2020  le() -> None:.  
+0000c220: 2020 2222 2257 7269 7465 2050 4944 2074    """Write PID t
+0000c230: 6f20 6469 736b 2e0a 0a20 2020 2049 6620  o disk...    If 
+0000c240: 706f 7373 6962 6c65 2063 7265 6174 6520  possible create 
+0000c250: 6120 5049 4420 6669 6c65 2e20 5468 6973  a PID file. This
+0000c260: 2069 7320 6e6f 7420 6573 7365 6e74 6961   is not essentia
+0000c270: 6c2e 0a20 2020 2053 6f2c 2069 6620 6974  l..    So, if it
+0000c280: 2066 6169 6c73 2074 6865 7265 2069 7320   fails there is 
+0000c290: 6e6f 2070 726f 626c 656d 2e20 5468 6520  no problem. The 
+0000c2a0: 5049 4420 6669 6c65 2063 616e 0a20 2020  PID file can.   
+0000c2b0: 2062 6520 6865 6c70 6675 6c20 746f 2073   be helpful to s
+0000c2c0: 656e 6420 6120 6b69 6c6c 2073 6967 6e61  end a kill signa
+0000c2d0: 6c20 6f72 2073 696d 696c 6172 2074 6f20  l or similar to 
+0000c2e0: 7468 6520 7072 6f63 6573 732e 0a20 2020  the process..   
+0000c2f0: 2045 2e67 2e20 746f 2073 746f 7020 6c69   E.g. to stop li
+0000c300: 7374 656e 696e 672e 0a20 2020 2042 6563  stening..    Bec
+0000c310: 6175 7365 2074 6865 2075 7365 7220 6361  ause the user ca
+0000c320: 6e20 7374 6172 7420 7365 7665 7261 6c20  n start several 
+0000c330: 7072 6f63 6573 7365 7320 6174 2074 6865  processes at the
+0000c340: 2073 616d 6520 7469 6d65 2c0a 2020 2020   same time,.    
+0000c350: 6a75 7374 2068 6176 696e 6720 6f6e 6520  just having one 
+0000c360: 5049 4420 6669 6c65 2069 7320 6e6f 7420  PID file is not 
+0000c370: 6163 6365 7074 6162 6c65 2062 6563 6175  acceptable becau
+0000c380: 7365 2061 206e 6577 6c79 2073 7461 7274  se a newly start
+0000c390: 6564 0a20 2020 2070 726f 6365 7373 2077  ed.    process w
+0000c3a0: 6f75 6c64 206f 7665 7277 7269 7465 2074  ould overwrite t
+0000c3b0: 6865 2070 7265 7669 6f75 7320 5049 4420  he previous PID 
+0000c3c0: 6669 6c65 2e20 5765 2075 7365 2055 5549  file. We use UUI
+0000c3d0: 4473 2074 6f20 6d61 6b65 0a20 2020 2065  Ds to make.    e
+0000c3e0: 6163 6820 5049 4420 6669 6c65 2075 6e69  ach PID file uni
+0000c3f0: 7175 652e 0a20 2020 2022 2222 0a20 2020  que..    """.   
+0000c400: 2074 7279 3a0a 2020 2020 2020 2020 6966   try:.        if
+0000c410: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
+0000c420: 7374 7328 5049 445f 4449 525f 4445 4641  sts(PID_DIR_DEFA
+0000c430: 554c 5429 3a0a 2020 2020 2020 2020 2020  ULT):.          
+0000c440: 2020 6f73 2e6d 6b64 6972 2850 4944 5f44    os.mkdir(PID_D
+0000c450: 4952 5f44 4546 4155 4c54 290a 2020 2020  IR_DEFAULT).    
+0000c460: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0000c470: 6562 7567 2866 2243 7265 6174 6520 6469  ebug(f"Create di
+0000c480: 7265 6374 6f72 7920 7b50 4944 5f44 4952  rectory {PID_DIR
+0000c490: 5f44 4546 4155 4c54 7d20 666f 7220 5049  _DEFAULT} for PI
+0000c4a0: 4420 6669 6c65 2e22 290a 2020 2020 2020  D file.").      
+0000c4b0: 2020 7069 6420 3d20 6f73 2e67 6574 7069    pid = os.getpi
+0000c4c0: 6428 290a 2020 2020 2020 2020 6773 2e6c  d().        gs.l
+0000c4d0: 6f67 2e64 6562 7567 2866 2254 7279 696e  og.debug(f"Tryin
+0000c4e0: 6720 746f 2063 7265 6174 6520 6120 5049  g to create a PI
+0000c4f0: 4420 6669 6c65 2074 6f20 7374 6f72 6520  D file to store 
+0000c500: 7072 6f63 6573 7320 6964 207b 7069 647d  process id {pid}
+0000c510: 2e22 290a 2020 2020 2020 2020 7769 7468  .").        with
+0000c520: 206f 7065 6e28 5049 445f 4649 4c45 5f44   open(PID_FILE_D
+0000c530: 4546 4155 4c54 2c20 2277 2229 2061 7320  EFAULT, "w") as 
+0000c540: 663a 2020 2320 6f76 6572 7772 6974 650a  f:  # overwrite.
+0000c550: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
+0000c560: 6974 6528 7374 7228 7069 6429 290a 2020  ite(str(pid)).  
+0000c570: 2020 2020 2020 2020 2020 662e 636c 6f73            f.clos
+0000c580: 6528 290a 2020 2020 2020 2020 6773 2e6c  e().        gs.l
+0000c590: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0000c5a0: 2020 2020 2020 6627 5375 6363 6573 7366        f'Successf
+0000c5b0: 756c 6c79 2063 7265 6174 6564 2050 4944  ully created PID
+0000c5c0: 2066 696c 6520 227b 5049 445f 4649 4c45   file "{PID_FILE
+0000c5d0: 5f44 4546 4155 4c54 7d22 2027 0a20 2020  _DEFAULT}" '.   
+0000c5e0: 2020 2020 2020 2020 2066 2274 6f20 7374           f"to st
+0000c5f0: 6f72 6520 7072 6f63 6573 7320 6964 207b  ore process id {
+0000c600: 7069 647d 2e22 0a20 2020 2020 2020 2029  pid}.".        )
+0000c610: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+0000c620: 7074 696f 6e3a 0a20 2020 2020 2020 2067  ption:.        g
+0000c630: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+0000c640: 2020 2020 2020 2020 2066 2746 6169 6c65           f'Faile
+0000c650: 6420 746f 2063 7265 6174 6520 5049 4420  d to create PID 
+0000c660: 6669 6c65 2022 7b50 4944 5f46 494c 455f  file "{PID_FILE_
+0000c670: 4445 4641 554c 547d 2220 270a 2020 2020  DEFAULT}" '.    
+0000c680: 2020 2020 2020 2020 6622 746f 2073 746f          f"to sto
+0000c690: 7265 2070 726f 6365 7373 2069 6420 7b6f  re process id {o
+0000c6a0: 732e 6765 7470 6964 2829 7d2e 220a 2020  s.getpid()}.".  
+0000c6b0: 2020 2020 2020 290a 0a0a 6465 6620 6465        )...def de
+0000c6c0: 6c65 7465 5f70 6964 5f66 696c 6528 2920  lete_pid_file() 
+0000c6d0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0000c6e0: 5265 6d6f 7665 2050 4944 2066 696c 6520  Remove PID file 
+0000c6f0: 6672 6f6d 2064 6973 6b2e 0a0a 2020 2020  from disk...    
+0000c700: 436c 6561 6e20 7570 2062 7920 7265 6d6f  Clean up by remo
+0000c710: 7669 6e67 2050 4944 2066 696c 652e 0a20  ving PID file.. 
+0000c720: 2020 2049 7420 6d69 6768 7420 6e6f 7420     It might not 
+0000c730: 6578 6973 742e 2053 6f2c 2069 676e 6f72  exist. So, ignor
+0000c740: 6520 6661 696c 7572 6573 2e0a 2020 2020  e failures..    
+0000c750: 2222 220a 2020 2020 7472 793a 0a20 2020  """.    try:.   
+0000c760: 2020 2020 206f 732e 7265 6d6f 7665 2850       os.remove(P
+0000c770: 4944 5f46 494c 455f 4445 4641 554c 5429  ID_FILE_DEFAULT)
+0000c780: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+0000c790: 7074 696f 6e3a 0a20 2020 2020 2020 2067  ption:.        g
+0000c7a0: 732e 6c6f 672e 6465 6275 6728 6627 4661  s.log.debug(f'Fa
+0000c7b0: 696c 6564 2074 6f20 7265 6d6f 7665 2050  iled to remove P
+0000c7c0: 4944 2066 696c 6520 227b 5049 445f 4649  ID file "{PID_FI
+0000c7d0: 4c45 5f44 4546 4155 4c54 7d22 2e27 290a  LE_DEFAULT}".').
+0000c7e0: 0a0a 6465 6620 636c 6561 6e75 7028 2920  ..def cleanup() 
+0000c7f0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0000c800: 436c 6561 6e75 7020 6265 666f 7265 2071  Cleanup before q
+0000c810: 7569 7469 6e67 2070 726f 6772 616d 2e22  uiting program."
+0000c820: 2222 0a20 2020 2067 732e 6c6f 672e 6465  "".    gs.log.de
+0000c830: 6275 6728 2243 6c65 616e 7570 3a20 636c  bug("Cleanup: cl
+0000c840: 6561 6e69 6e67 2075 702e 2229 0a20 2020  eaning up.").   
+0000c850: 2064 656c 6574 655f 7069 645f 6669 6c65   delete_pid_file
+0000c860: 2829 0a0a 0a64 6566 2063 7265 6465 6e74  ()...def credent
+0000c870: 6961 6c73 5f65 7869 7374 2863 7265 6465  ials_exist(crede
+0000c880: 6e74 6961 6c73 5f66 696c 655f 7061 7468  ntials_file_path
+0000c890: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0000c8a0: 3d20 4e6f 6e65 2920 2d3e 2062 6f6f 6c3a  = None) -> bool:
+0000c8b0: 0a20 2020 2022 2222 4465 7465 726d 696e  .    """Determin
+0000c8c0: 6520 6966 2063 7265 6465 6e74 6961 6c73  e if credentials
+0000c8d0: 2066 696c 6520 616c 7265 6164 7920 6578   file already ex
+0000c8e0: 6973 7473 2e22 2222 0a20 2020 2069 6620  ists.""".    if 
+0000c8f0: 6e6f 7420 6372 6564 656e 7469 616c 735f  not credentials_
+0000c900: 6669 6c65 5f70 6174 683a 0a20 2020 2020  file_path:.     
+0000c910: 2020 2063 7265 6465 6e74 6961 6c73 5f66     credentials_f
+0000c920: 696c 655f 7061 7468 203d 2064 6574 6572  ile_path = deter
+0000c930: 6d69 6e65 5f63 7265 6465 6e74 6961 6c73  mine_credentials
+0000c940: 5f66 696c 6528 290a 2020 2020 7265 7475  _file().    retu
+0000c950: 726e 206f 732e 7061 7468 2e65 7869 7374  rn os.path.exist
+0000c960: 7328 6372 6564 656e 7469 616c 735f 6669  s(credentials_fi
+0000c970: 6c65 5f70 6174 6829 0a0a 0a64 6566 2073  le_path)...def s
+0000c980: 746f 7265 5f65 7869 7374 7328 7374 6f72  tore_exists(stor
+0000c990: 655f 6469 725f 7061 7468 3a20 4f70 7469  e_dir_path: Opti
+0000c9a0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+0000c9b0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2022  ) -> bool:.    "
+0000c9c0: 2222 4465 7465 726d 696e 6520 6966 2073  ""Determine if s
+0000c9d0: 746f 7265 2064 6972 2061 6c72 6561 6479  tore dir already
+0000c9e0: 2065 7869 7374 732e 2222 220a 2020 2020   exists.""".    
+0000c9f0: 6966 206e 6f74 2073 746f 7265 5f64 6972  if not store_dir
+0000ca00: 5f70 6174 683a 0a20 2020 2020 2020 2073  _path:.        s
+0000ca10: 746f 7265 5f64 6972 5f70 6174 6820 3d20  tore_dir_path = 
+0000ca20: 6465 7465 726d 696e 655f 7374 6f72 655f  determine_store_
+0000ca30: 6469 7228 290a 2020 2020 7265 7475 726e  dir().    return
+0000ca40: 206f 732e 7061 7468 2e69 7364 6972 2873   os.path.isdir(s
+0000ca50: 746f 7265 5f64 6972 5f70 6174 6829 0a0a  tore_dir_path)..
+0000ca60: 0a64 6566 2073 746f 7265 5f63 7265 6174  .def store_creat
+0000ca70: 6528 7374 6f72 655f 6469 725f 7061 7468  e(store_dir_path
+0000ca80: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0000ca90: 3d20 4e6f 6e65 2920 2d3e 204e 6f6e 653a  = None) -> None:
+0000caa0: 0a20 2020 2022 2222 4372 6561 7465 2073  .    """Create s
+0000cab0: 746f 7265 2064 6972 2e22 2222 0a20 2020  tore dir.""".   
+0000cac0: 2069 6620 6e6f 7420 7374 6f72 655f 6469   if not store_di
+0000cad0: 725f 7061 7468 3a0a 2020 2020 2020 2020  r_path:.        
+0000cae0: 7374 6f72 655f 6469 725f 7061 7468 203d  store_dir_path =
+0000caf0: 2064 6574 6572 6d69 6e65 5f73 746f 7265   determine_store
+0000cb00: 5f64 6972 2829 0a20 2020 206f 732e 6d61  _dir().    os.ma
+0000cb10: 6b65 6469 7273 2873 746f 7265 5f64 6972  kedirs(store_dir
+0000cb20: 5f70 6174 6829 0a20 2020 2067 732e 6c6f  _path).    gs.lo
+0000cb30: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
+0000cb40: 6622 5468 6520 7065 7273 6973 7465 6e74  f"The persistent
+0000cb50: 2073 746f 7261 6765 2064 6972 6563 746f   storage directo
+0000cb60: 7279 207b 7374 6f72 655f 6469 725f 7061  ry {store_dir_pa
+0000cb70: 7468 7d20 220a 2020 2020 2020 2020 2277  th} ".        "w
+0000cb80: 6173 2063 7265 6174 6564 2066 6f72 2079  as created for y
+0000cb90: 6f75 2e22 0a20 2020 2029 0a0a 0a64 6566  ou.".    )...def
+0000cba0: 2073 746f 7265 5f64 656c 6574 6528 7374   store_delete(st
+0000cbb0: 6f72 655f 6469 725f 7061 7468 3a20 4f70  ore_dir_path: Op
+0000cbc0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0000cbd0: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+0000cbe0: 2022 2222 4465 6c65 7465 2073 746f 7265   """Delete store
+0000cbf0: 2064 6972 2e22 2222 0a20 2020 2069 6620   dir.""".    if 
+0000cc00: 6e6f 7420 7374 6f72 655f 6469 725f 7061  not store_dir_pa
+0000cc10: 7468 3a0a 2020 2020 2020 2020 7374 6f72  th:.        stor
+0000cc20: 655f 6469 725f 7061 7468 203d 2064 6574  e_dir_path = det
+0000cc30: 6572 6d69 6e65 5f73 746f 7265 5f64 6972  ermine_store_dir
+0000cc40: 2829 0a20 2020 206f 732e 726d 6469 7228  ().    os.rmdir(
+0000cc50: 7374 6f72 655f 6469 725f 7061 7468 290a  store_dir_path).
+0000cc60: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
+0000cc70: 0a20 2020 2020 2020 2066 2254 6865 2070  .        f"The p
+0000cc80: 6572 7369 7374 656e 7420 7374 6f72 6167  ersistent storag
+0000cc90: 6520 6469 7265 6374 6f72 7920 7b73 746f  e directory {sto
+0000cca0: 7265 5f64 6972 5f70 6174 687d 2022 0a20  re_dir_path} ". 
+0000ccb0: 2020 2020 2020 2022 7761 7320 6465 6c65         "was dele
+0000ccc0: 7465 6420 666f 7220 796f 752e 220a 2020  ted for you.".  
+0000ccd0: 2020 290a 0a0a 6465 6620 7772 6974 655f    )...def write_
+0000cce0: 6372 6564 656e 7469 616c 735f 746f 5f64  credentials_to_d
+0000ccf0: 6973 6b28 0a20 2020 2068 6f6d 6573 6572  isk(.    homeser
+0000cd00: 7665 722c 2075 7365 725f 6964 2c20 6465  ver, user_id, de
+0000cd10: 7669 6365 5f69 642c 2061 6363 6573 735f  vice_id, access_
+0000cd20: 746f 6b65 6e2c 2072 6f6f 6d5f 6964 2c20  token, room_id, 
+0000cd30: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
+0000cd40: 0a29 202d 3e20 4e6f 6e65 3a0a 2020 2020  .) -> None:.    
+0000cd50: 2222 2257 7269 7465 2074 6865 2072 6571  """Write the req
+0000cd60: 7569 7265 6420 6c6f 6769 6e20 6465 7461  uired login deta
+0000cd70: 696c 7320 746f 2064 6973 6b2e 0a0a 2020  ils to disk...  
+0000cd80: 2020 5468 6973 2066 696c 6520 6361 6e20    This file can 
+0000cd90: 6c61 7465 7220 6265 2075 7365 6420 666f  later be used fo
+0000cda0: 7220 6c6f 6767 696e 6720 696e 0a20 2020  r logging in.   
+0000cdb0: 2077 6974 686f 7574 2075 7369 6e67 2061   without using a
+0000cdc0: 2070 6173 7377 6f72 642e 0a0a 2020 2020   password...    
+0000cdd0: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
+0000cde0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0000cdf0: 2068 6f6d 6573 6572 7665 7220 3a20 7374   homeserver : st
+0000ce00: 720a 2020 2020 2020 2020 2020 2020 5552  r.            UR
+0000ce10: 4c20 6f66 2068 6f6d 6573 6572 7665 722c  L of homeserver,
+0000ce20: 2065 2e67 2e20 2268 7474 7073 3a2f 2f6d   e.g. "https://m
+0000ce30: 6174 7269 782e 6578 616d 706c 652e 6f72  atrix.example.or
+0000ce40: 6722 0a20 2020 2020 2020 2075 7365 725f  g".        user_
+0000ce50: 6964 203a 2073 7472 0a20 2020 2020 2020  id : str.       
+0000ce60: 2020 2020 2066 756c 6c20 7573 6572 2069       full user i
+0000ce70: 642c 2065 2e67 2e20 2240 7573 6572 3a65  d, e.g. "@user:e
+0000ce80: 7861 6d70 6c65 2e6f 7267 220a 2020 2020  xample.org".    
+0000ce90: 2020 2020 6465 7669 6365 5f69 6420 3a20      device_id : 
+0000cea0: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
+0000ceb0: 6465 7669 6365 2069 642c 2031 3020 7570  device id, 10 up
+0000cec0: 7065 7263 6173 6520 6c65 7474 6572 730a  percase letters.
+0000ced0: 2020 2020 2020 2020 6163 6365 7373 5f74          access_t
+0000cee0: 6f6b 656e 203a 2073 7472 0a20 2020 2020  oken : str.     
+0000cef0: 2020 2020 2020 2061 6363 6573 7320 746f         access to
+0000cf00: 6b65 6e2c 206c 6f6e 6720 6372 7970 746f  ken, long crypto
+0000cf10: 6772 6170 6869 6320 6163 6365 7373 2074  graphic access t
+0000cf20: 6f6b 656e 0a20 2020 2020 2020 2072 6f6f  oken.        roo
+0000cf30: 6d5f 6964 203a 2073 7472 0a20 2020 2020  m_id : str.     
+0000cf40: 2020 2020 2020 206e 616d 6520 6f66 2072         name of r
+0000cf50: 6f6f 6d20 7768 6572 6520 6d65 7373 6167  oom where messag
+0000cf60: 6520 7769 6c6c 2062 6520 7365 6e74 2074  e will be sent t
+0000cf70: 6f2c 0a20 2020 2020 2020 2020 2020 2065  o,.            e
+0000cf80: 2e67 2e20 2221 536f 6d65 526f 6f6d 4964  .g. "!SomeRoomId
+0000cf90: 5374 7269 6e67 3a65 7861 6d70 6c65 2e6f  String:example.o
+0000cfa0: 7267 220a 2020 2020 2020 2020 2020 2020  rg".            
+0000cfb0: 7573 6572 206d 7573 7420 6265 206d 656d  user must be mem
+0000cfc0: 6265 7220 6f66 2074 6865 2070 726f 7669  ber of the provi
+0000cfd0: 6465 6420 726f 6f6d 0a20 2020 2020 2020  ded room.       
+0000cfe0: 2063 7265 6465 6e74 6961 6c73 5f66 696c   credentials_fil
+0000cff0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+0000d000: 2020 2020 6e61 6d65 2f70 6174 6820 6f66      name/path of
+0000d010: 2066 696c 6520 7768 6572 6520 746f 2073   file where to s
+0000d020: 746f 7265 0a20 2020 2020 2020 2020 2020  tore.           
+0000d030: 2063 7265 6465 6e74 6961 6c73 2069 6e66   credentials inf
+0000d040: 6f72 6d61 7469 6f6e 0a0a 2020 2020 2222  ormation..    ""
+0000d050: 220a 2020 2020 2320 6f70 656e 2074 6865  ".    # open the
+0000d060: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+0000d070: 6520 696e 2077 7269 7465 2d6d 6f64 650a  e in write-mode.
+0000d080: 2020 2020 7769 7468 206f 7065 6e28 6372      with open(cr
+0000d090: 6564 656e 7469 616c 735f 6669 6c65 2c20  edentials_file, 
+0000d0a0: 2277 2229 2061 7320 663a 0a20 2020 2020  "w") as f:.     
+0000d0b0: 2020 2023 2077 7269 7465 2074 6865 206c     # write the l
+0000d0c0: 6f67 696e 2064 6574 6169 6c73 2074 6f20  ogin details to 
+0000d0d0: 6469 736b 0a20 2020 2020 2020 206a 736f  disk.        jso
+0000d0e0: 6e2e 6475 6d70 280a 2020 2020 2020 2020  n.dump(.        
+0000d0f0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0000d100: 2020 2020 2020 2320 652e 672e 2022 6874        # e.g. "ht
+0000d110: 7470 733a 2f2f 6d61 7472 6978 2e65 7861  tps://matrix.exa
+0000d120: 6d70 6c65 2e6f 7267 220a 2020 2020 2020  mple.org".      
+0000d130: 2020 2020 2020 2020 2020 2268 6f6d 6573            "homes
+0000d140: 6572 7665 7222 3a20 686f 6d65 7365 7276  erver": homeserv
+0000d150: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0000d160: 2020 2020 2320 6465 7669 6365 2049 442c      # device ID,
+0000d170: 2031 3020 7570 7065 7263 6173 6520 6c65   10 uppercase le
+0000d180: 7474 6572 730a 2020 2020 2020 2020 2020  tters.          
+0000d190: 2020 2020 2020 2264 6576 6963 655f 6964        "device_id
+0000d1a0: 223a 2064 6576 6963 655f 6964 2c0a 2020  ": device_id,.  
+0000d1b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000d1c0: 652e 672e 2022 4075 7365 723a 6578 616d  e.g. "@user:exam
+0000d1d0: 706c 652e 6f72 6722 0a20 2020 2020 2020  ple.org".       
+0000d1e0: 2020 2020 2020 2020 2022 7573 6572 5f69           "user_i
+0000d1f0: 6422 3a20 7573 6572 5f69 642c 0a20 2020  d": user_id,.   
+0000d200: 2020 2020 2020 2020 2020 2020 2023 2065               # e
+0000d210: 2e67 2e20 2221 536f 6d65 526f 6f6d 4964  .g. "!SomeRoomId
+0000d220: 5374 7269 6e67 3a65 7861 6d70 6c65 2e6f  String:example.o
+0000d230: 7267 220a 2020 2020 2020 2020 2020 2020  rg".            
+0000d240: 2020 2020 2272 6f6f 6d5f 6964 223a 2072      "room_id": r
+0000d250: 6f6f 6d5f 6964 2c0a 2020 2020 2020 2020  oom_id,.        
+0000d260: 2020 2020 2020 2020 2320 6c6f 6e67 2063          # long c
+0000d270: 7279 7074 6f67 7261 7068 6963 2061 6363  ryptographic acc
+0000d280: 6573 7320 746f 6b65 6e0a 2020 2020 2020  ess token.      
+0000d290: 2020 2020 2020 2020 2020 2261 6363 6573            "acces
+0000d2a0: 735f 746f 6b65 6e22 3a20 6163 6365 7373  s_token": access
+0000d2b0: 5f74 6f6b 656e 2c0a 2020 2020 2020 2020  _token,.        
+0000d2c0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0000d2d0: 2020 2066 2c0a 2020 2020 2020 2020 290a     f,.        ).
+0000d2e0: 0a0a 6465 6620 7265 6164 5f63 7265 6465  ..def read_crede
+0000d2f0: 6e74 6961 6c73 5f66 726f 6d5f 6469 736b  ntials_from_disk
+0000d300: 2863 7265 6465 6e74 6961 6c73 5f66 696c  (credentials_fil
+0000d310: 6529 202d 3e20 6469 6374 3a0a 2020 2020  e) -> dict:.    
+0000d320: 2222 2252 6561 6420 7468 6520 7265 7175  """Read the requ
+0000d330: 6972 6564 206c 6f67 696e 2064 6574 6169  ired login detai
+0000d340: 6c73 2066 726f 6d20 6469 736b 2e0a 0a20  ls from disk... 
+0000d350: 2020 2049 7420 6361 6e20 7468 656e 2062     It can then b
+0000d360: 6520 7573 6564 2074 6f20 6c6f 6720 696e  e used to log in
+0000d370: 2077 6974 686f 7574 2075 7369 6e67 2061   without using a
+0000d380: 2070 6173 7377 6f72 642e 0a0a 2020 2020   password...    
+0000d390: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
+0000d3a0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 7265  --------.    cre
+0000d3b0: 6465 6e74 6961 6c73 5f66 696c 6520 3a20  dentials_file : 
+0000d3c0: 7374 720a 2020 2020 2020 2020 6e61 6d65  str.        name
+0000d3d0: 2f70 6174 6820 6f66 2066 696c 6520 746f  /path of file to
+0000d3e0: 2072 6561 6420 6372 6564 656e 7469 616c   read credential
+0000d3f0: 7320 696e 666f 726d 6174 696f 6e20 6672  s information fr
+0000d400: 6f6d 0a0a 2020 2020 2222 220a 2020 2020  om..    """.    
+0000d410: 2320 6f70 656e 2074 6865 2066 696c 6520  # open the file 
+0000d420: 696e 2072 6561 642d 6f6e 6c79 206d 6f64  in read-only mod
+0000d430: 650a 2020 2020 6773 2e6c 6f67 2e64 6562  e.    gs.log.deb
+0000d440: 7567 2822 5374 6172 7469 6e67 2074 6f20  ug("Starting to 
+0000d450: 7265 6164 2063 7265 6465 6e74 6961 6c73  read credentials
+0000d460: 2066 696c 652e 2229 0a20 2020 2077 6974   file.").    wit
+0000d470: 6820 6f70 656e 2863 7265 6465 6e74 6961  h open(credentia
+0000d480: 6c73 5f66 696c 652c 2022 7222 2920 6173  ls_file, "r") as
+0000d490: 2066 3a0a 2020 2020 2020 2020 6364 6963   f:.        cdic
+0000d4a0: 7420 3d20 6a73 6f6e 2e6c 6f61 6428 6629  t = json.load(f)
+0000d4b0: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
+0000d4c0: 6728 2246 696e 6973 6865 6420 7265 6164  g("Finished read
+0000d4d0: 696e 6720 6372 6564 656e 7469 616c 7320  ing credentials 
+0000d4e0: 6669 6c65 2e22 290a 2020 2020 7265 7475  file.").    retu
+0000d4f0: 726e 2063 6469 6374 0a0a 0a64 6566 2064  rn cdict...def d
+0000d500: 6574 6572 6d69 6e65 5f63 7265 6465 6e74  etermine_credent
+0000d510: 6961 6c73 5f66 696c 6528 2920 2d3e 2073  ials_file() -> s
+0000d520: 7472 3a0a 2020 2020 2222 2244 6574 6572  tr:.    """Deter
+0000d530: 6d69 6e65 2074 6865 2074 7275 6520 6669  mine the true fi
+0000d540: 6c65 6e61 6d65 206f 6620 6372 6564 656e  lename of creden
+0000d550: 7469 616c 7320 6669 6c65 2e0a 0a20 2020  tials file...   
+0000d560: 2052 6574 7572 6e73 2066 696c 656e 616d   Returns filenam
+0000d570: 6520 7769 7468 2066 756c 6c20 7061 7468  e with full path
+0000d580: 206f 7220 4e6f 6e65 2e0a 0a20 2020 2054   or None...    T
+0000d590: 6869 7320 6675 6e63 7469 6f6e 2063 6865  his function che
+0000d5a0: 636b 7320 6966 2061 2063 7265 6465 6e74  cks if a credent
+0000d5b0: 6961 6c73 2066 696c 6520 6578 6973 7473  ials file exists
+0000d5c0: 2e20 4966 206e 6f2c 2069 7420 7769 6c6c  . If no, it will
+0000d5d0: 2061 736b 0a20 2020 2075 7365 7220 7175   ask.    user qu
+0000d5e0: 6573 7469 6f6e 7320 7265 6772 6164 696e  estions regradin
+0000d5f0: 6720 6c6f 6769 6e2c 2073 746f 7265 2074  g login, store t
+0000d600: 6865 2069 6e66 6f20 696e 2061 206e 6577  he info in a new
+0000d610: 6c79 2063 7265 6174 6564 0a20 2020 2063  ly created.    c
+0000d620: 7265 6465 6e74 6961 6c73 2066 696c 6520  redentials file 
+0000d630: 616e 6420 6578 6974 2e0a 0a20 2020 2049  and exit...    I
+0000d640: 6620 6120 6372 6564 656e 7469 616c 7320  f a credentials 
+0000d650: 6669 6c65 2065 7869 7374 732c 2069 7420  file exists, it 
+0000d660: 7769 6c6c 2072 6561 6420 6974 2c20 6c6f  will read it, lo
+0000d670: 6720 696e 746f 204d 6174 7269 782c 0a20  g into Matrix,. 
+0000d680: 2020 2073 656e 6420 6120 6d65 7373 6167     send a messag
+0000d690: 6520 616e 6420 6578 6974 2e0a 0a20 2020  e and exit...   
+0000d6a0: 2054 6865 2063 7265 6465 6e74 6961 6c20   The credential 
+0000d6b0: 6669 6c65 2077 696c 6c20 6265 206c 6f6f  file will be loo
+0000d6c0: 6b65 6420 666f 7220 7468 6520 666f 6c6c  ked for the foll
+0000d6d0: 6f77 696e 6720 7761 793a 0a20 2020 2061  owing way:.    a
+0000d6e0: 2920 6966 2061 2070 6174 6820 2865 2e67  ) if a path (e.g
+0000d6f0: 2e20 222e 2e2f 6372 6564 2e6a 736f 6e22  . "../cred.json"
+0000d700: 2920 6973 2073 7065 6369 6669 6564 2077  ) is specified w
+0000d710: 6974 6820 2d74 2069 7420 7769 6c6c 2062  ith -t it will b
+0000d720: 6520 6c6f 6f6b 6564 0a20 2020 2020 2020  e looked.       
+0000d730: 666f 7220 7468 6572 652e 2045 6e64 206f  for there. End o
+0000d740: 6620 7365 6172 6368 2e0a 2020 2020 6229  f search..    b)
+0000d750: 2069 6620 6f6e 6c79 2061 2066 696c 656e   if only a filen
+0000d760: 616d 6520 7769 7468 6f75 7420 7061 7468  ame without path
+0000d770: 2028 652e 672e 2022 6372 6564 2e6a 736f   (e.g. "cred.jso
+0000d780: 6e22 2920 6973 2073 7065 6369 6669 6564  n") is specified
+0000d790: 0a20 2020 2020 2020 6669 7273 7420 6c6f  .       first lo
+0000d7a0: 6f6b 2069 6e20 7468 6520 6375 7272 656e  ok in the curren
+0000d7b0: 7420 6c6f 6361 6c20 6469 7265 6374 6f72  t local director
+0000d7c0: 792c 2069 6620 666f 756e 6420 7573 6520  y, if found use 
+0000d7d0: 6974 0a20 2020 2063 2920 6966 206f 6e6c  it.    c) if onl
+0000d7e0: 7920 6120 6669 6c65 6e61 6d65 2077 6974  y a filename wit
+0000d7f0: 686f 7574 2070 6174 6820 2865 2e67 2e20  hout path (e.g. 
+0000d800: 2263 7265 642e 6a73 6f6e 2229 2069 7320  "cred.json") is 
+0000d810: 7370 6563 6966 6965 640a 2020 2020 2020  specified.      
+0000d820: 2061 6e64 2069 7420 6361 6e6e 6f74 2062   and it cannot b
+0000d830: 6520 666f 756e 6420 696e 2074 6865 2063  e found in the c
+0000d840: 7572 7265 6e74 206c 6f63 616c 2064 6972  urrent local dir
+0000d850: 6563 746f 7279 2c20 7468 656e 0a20 2020  ectory, then.   
+0000d860: 2020 2020 6c6f 6f6b 2066 6f72 2069 7420      look for it 
+0000d870: 696e 2064 6972 6563 746f 7279 2024 484f  in directory $HO
+0000d880: 4d45 2f2e 636f 6e66 6967 2f6d 6174 7269  ME/.config/matri
+0000d890: 782d 636f 6d6d 616e 6465 722f 0a20 2020  x-commander/.   
+0000d8a0: 2054 4c44 523a 206f 6e20 6669 7273 7420   TLDR: on first 
+0000d8b0: 7275 6e20 6974 2077 696c 6c20 6265 2077  run it will be w
+0000d8c0: 7269 7474 656e 2074 6f20 6375 7272 656e  ritten to curren
+0000d8d0: 7420 6c6f 6361 6c20 6469 7265 6374 6f72  t local director
+0000d8e0: 790a 2020 2020 2020 206f 7220 746f 2070  y.       or to p
+0000d8f0: 6174 6820 7370 6563 6966 6965 6420 7769  ath specified wi
+0000d900: 7468 202d 2d63 7265 6465 6e74 6961 6c73  th --credentials
+0000d910: 2063 6f6d 6d61 6e64 206c 696e 6520 6172   command line ar
+0000d920: 6775 6d65 6e74 2e0a 2020 2020 2020 204f  gument..       O
+0000d930: 6e20 6675 7274 6865 7220 7265 6164 732c  n further reads,
+0000d940: 2070 726f 6772 616d 2077 696c 6c20 6c6f   program will lo
+0000d950: 6f6b 2069 6e20 6375 7272 656e 746c 7920  ok in currently 
+0000d960: 6c6f 6361 6c20 6469 7265 6374 6f72 790a  local directory.
+0000d970: 2020 2020 2020 206f 7220 696e 2070 6174         or in pat
+0000d980: 6820 7370 6563 6966 6965 6420 7769 7468  h specified with
+0000d990: 202d 2d63 7265 6465 6e74 6961 6c73 2063   --credentials c
+0000d9a0: 6f6d 6d61 6e64 206c 696e 6520 6172 6775  ommand line argu
+0000d9b0: 6d65 6e74 2e0a 2020 2020 2020 2049 6620  ment..       If 
+0000d9c0: 6e6f 7420 666f 756e 6420 7468 6572 6520  not found there 
+0000d9d0: 2861 6e64 206f 6e6c 7920 6669 6c65 6e61  (and only filena
+0000d9e0: 6d65 2077 6974 686f 7574 2070 6174 6820  me without path 
+0000d9f0: 6769 7665 6e29 2c0a 2020 2020 2020 2061  given),.       a
+0000da00: 7320 6120 7365 636f 6e64 6172 7920 6368  s a secondary ch
+0000da10: 6f69 6365 2070 726f 6772 616d 2077 696c  oice program wil
+0000da20: 6c20 6c6f 6f6b 2066 6f72 2069 7420 696e  l look for it in
+0000da30: 0a20 2020 2020 2020 6469 7265 6374 6f72  .       director
+0000da40: 7920 2448 4f4d 452f 2e63 6f6e 6669 672f  y $HOME/.config/
+0000da50: 6d61 7472 6978 2d63 6f6d 6d61 6e64 6572  matrix-commander
+0000da60: 2f0a 0a20 2020 2022 2222 0a20 2020 2063  /..    """.    c
+0000da70: 7265 6465 6e74 6961 6c73 5f66 696c 6520  redentials_file 
+0000da80: 3d20 6773 2e70 612e 6372 6564 656e 7469  = gs.pa.credenti
+0000da90: 616c 7320 2023 2064 6566 6175 6c74 206c  als  # default l
+0000daa0: 6f63 6174 696f 6e0a 2020 2020 6966 2028  ocation.    if (
+0000dab0: 6e6f 7420 6f73 2e70 6174 682e 6973 6669  not os.path.isfi
+0000dac0: 6c65 2867 732e 7061 2e63 7265 6465 6e74  le(gs.pa.credent
+0000dad0: 6961 6c73 2929 2061 6e64 2028 0a20 2020  ials)) and (.   
+0000dae0: 2020 2020 2067 732e 7061 2e63 7265 6465       gs.pa.crede
+0000daf0: 6e74 6961 6c73 203d 3d20 6f73 2e70 6174  ntials == os.pat
+0000db00: 682e 6261 7365 6e61 6d65 2867 732e 7061  h.basename(gs.pa
+0000db10: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
+0000db20: 2020 293a 0a20 2020 2020 2020 2067 732e    ):.        gs.
+0000db30: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0000db40: 2020 2020 2020 2022 4372 6564 656e 7469         "Credenti
+0000db50: 616c 7320 6669 6c65 2064 6f65 7320 6e6f  als file does no
+0000db60: 7420 6578 6973 7420 6c6f 6361 6c6c 792e  t exist locally.
+0000db70: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0000db80: 4669 6c65 206e 616d 6520 6861 7320 6e6f  File name has no
+0000db90: 2070 6174 682e 220a 2020 2020 2020 2020   path.".        
+0000dba0: 290a 2020 2020 2020 2020 6372 6564 656e  ).        creden
+0000dbb0: 7469 616c 735f 6669 6c65 203d 2043 5245  tials_file = CRE
+0000dbc0: 4445 4e54 4941 4c53 5f44 4952 5f4c 4153  DENTIALS_DIR_LAS
+0000dbd0: 5452 4553 4f52 5420 2b20 222f 2220 2b20  TRESORT + "/" + 
+0000dbe0: 6773 2e70 612e 6372 6564 656e 7469 616c  gs.pa.credential
+0000dbf0: 730a 2020 2020 2020 2020 6773 2e6c 6f67  s.        gs.log
+0000dc00: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0000dc10: 2020 2020 6627 5472 7969 6e67 2070 6174      f'Trying pat
+0000dc20: 6820 227b 6372 6564 656e 7469 616c 735f  h "{credentials_
+0000dc30: 6669 6c65 7d22 2061 7320 6c61 7374 2072  file}" as last r
+0000dc40: 6573 6f72 742e 2027 0a20 2020 2020 2020  esort. '.       
+0000dc50: 2020 2020 2022 5375 6767 6573 7469 6e67       "Suggesting
+0000dc60: 2074 6f20 6c6f 6f6b 2066 6f72 2069 7420   to look for it 
+0000dc70: 7468 6572 652e 220a 2020 2020 2020 2020  there.".        
+0000dc80: 290a 2020 2020 2020 2020 6966 206f 732e  ).        if os.
+0000dc90: 7061 7468 2e69 7366 696c 6528 6372 6564  path.isfile(cred
+0000dca0: 656e 7469 616c 735f 6669 6c65 293a 0a20  entials_file):. 
+0000dcb0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0000dcc0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0000dcd0: 2020 2020 2020 2020 2022 5765 2066 6f75           "We fou
+0000dce0: 6e64 2074 6865 2066 696c 652e 2049 7420  nd the file. It 
+0000dcf0: 6578 6973 7473 2069 6e20 7468 6520 6c61  exists in the la
+0000dd00: 7374 2072 6573 6f72 7420 220a 2020 2020  st resort ".    
+0000dd10: 2020 2020 2020 2020 2020 2020 6627 6469              f'di
+0000dd20: 7265 6374 6f72 7920 227b 6372 6564 656e  rectory "{creden
+0000dd30: 7469 616c 735f 6669 6c65 7d22 2e20 270a  tials_file}". '.
+0000dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd50: 2253 7567 6765 7374 696e 6720 746f 2075  "Suggesting to u
+0000dd60: 7365 2074 6869 7320 6f6e 652e 220a 2020  se this one.".  
+0000dd70: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000dd80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000dd90: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0000dda0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0000ddb0: 2020 2020 2246 696c 6520 646f 6573 206e      "File does n
+0000ddc0: 6f74 2065 7869 7374 7320 6569 7468 6572  ot exists either
+0000ddd0: 2069 6e20 7468 6520 6c61 7374 2072 6573   in the last res
+0000dde0: 6f72 7420 220a 2020 2020 2020 2020 2020  ort ".          
+0000ddf0: 2020 2020 2020 2264 6972 6563 746f 7279        "directory
+0000de00: 206f 7220 7468 6520 6c6f 6361 6c20 6469   or the local di
+0000de10: 7265 6374 6f72 792e 2022 0a20 2020 2020  rectory. ".     
+0000de20: 2020 2020 2020 2020 2020 2022 4669 6c65             "File
+0000de30: 206e 6f74 2066 6f75 6e64 2061 6e79 7768   not found anywh
+0000de40: 6572 652e 204f 6e65 2077 696c 6c20 6861  ere. One will ha
+0000de50: 7665 2074 6f20 6265 2022 0a20 2020 2020  ve to be ".     
+0000de60: 2020 2020 2020 2020 2020 2022 6372 6561             "crea
+0000de70: 7465 642e 2053 6f20 7765 2073 7567 6765  ted. So we sugge
+0000de80: 7374 2074 6865 206c 6f63 616c 2064 6972  st the local dir
+0000de90: 6563 746f 7279 2e22 0a20 2020 2020 2020  ectory.".       
+0000dea0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000deb0: 2020 2063 7265 6465 6e74 6961 6c73 5f66     credentials_f
+0000dec0: 696c 6520 3d20 6773 2e70 612e 6372 6564  ile = gs.pa.cred
+0000ded0: 656e 7469 616c 730a 2020 2020 656c 7365  entials.    else
+0000dee0: 3a0a 2020 2020 2020 2020 6966 206f 732e  :.        if os.
+0000def0: 7061 7468 2e69 7366 696c 6528 6773 2e70  path.isfile(gs.p
+0000df00: 612e 6372 6564 656e 7469 616c 7329 3a0a  a.credentials):.
+0000df10: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0000df20: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0000df30: 2020 2020 2020 2020 2020 2243 7265 6465            "Crede
+0000df40: 6e74 6961 6c73 2066 696c 6520 6578 6973  ntials file exis
+0000df50: 7465 642e 2022 0a20 2020 2020 2020 2020  ted. ".         
+0000df60: 2020 2020 2020 2022 536f 2074 6869 7320         "So this 
+0000df70: 6973 2074 6865 206f 6e65 2077 6520 7375  is the one we su
+0000df80: 6767 6573 7420 746f 2075 7365 2e20 220a  ggest to use. ".
+0000df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfa0: 6622 6669 6c65 3a20 7b63 7265 6465 6e74  f"file: {credent
+0000dfb0: 6961 6c73 5f66 696c 657d 220a 2020 2020  ials_file}".    
+0000dfc0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000dfd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000dfe0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0000dff0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000e000: 2020 2243 7265 6465 6e74 6961 6c73 2066    "Credentials f
+0000e010: 696c 6520 7761 7320 7370 6563 6966 6965  ile was specifie
+0000e020: 6420 7769 7468 2066 756c 6c20 7061 7468  d with full path
+0000e030: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0000e040: 2020 2020 2253 6f20 7765 2073 7567 6765      "So we sugge
+0000e050: 7374 2074 6861 7420 6f6e 652e 2022 0a20  st that one. ". 
+0000e060: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000e070: 2266 696c 653a 207b 6372 6564 656e 7469  "file: {credenti
+0000e080: 616c 735f 6669 6c65 7d22 0a20 2020 2020  als_file}".     
+0000e090: 2020 2020 2020 2029 0a20 2020 2023 2054         ).    # T
+0000e0a0: 6865 2072 6574 7572 6e65 6420 6669 6c65  he returned file
+0000e0b0: 2028 7769 7468 206f 7220 7769 7468 6f75   (with or withou
+0000e0c0: 7420 7061 7468 2920 206d 6967 6874 206f  t path)  might o
+0000e0d0: 7220 6d69 6768 7420 6e6f 7420 6578 6973  r might not exis
+0000e0e0: 742e 0a20 2020 2023 2042 7574 2069 6620  t..    # But if 
+0000e0f0: 6974 2064 6f65 7320 6e6f 7420 6578 6973  it does not exis
+0000e100: 742c 2069 7420 6973 2065 6974 6865 7220  t, it is either 
+0000e110: 6120 6675 6c6c 2070 6174 682c 206f 7220  a full path, or 
+0000e120: 6c6f 6361 6c2e 0a20 2020 2023 2057 6520  local..    # We 
+0000e130: 646f 206e 6f74 2077 616e 7420 746f 2072  do not want to r
+0000e140: 6574 7572 6e20 7468 6520 6c61 7374 2072  eturn the last r
+0000e150: 6573 6f72 7420 7061 7468 2069 6620 6974  esort path if it
+0000e160: 2064 6f65 7320 6e6f 7420 6578 6973 742c   does not exist,
+0000e170: 0a20 2020 2023 2073 6f20 7468 6174 2077  .    # so that w
+0000e180: 6865 6e20 6974 2069 7320 6372 6561 7465  hen it is create
+0000e190: 6420 6974 2069 7320 6372 6561 7465 6420  d it is created 
+0000e1a0: 7768 6572 6520 7370 6563 6966 6963 616c  where specifical
+0000e1b0: 6c79 2073 7065 6369 6669 6564 0a20 2020  ly specified.   
+0000e1c0: 2023 206f 7220 696e 206c 6f63 616c 2064   # or in local d
+0000e1d0: 6972 2028 6275 7420 6e6f 7420 696e 206c  ir (but not in l
+0000e1e0: 6173 7420 7265 736f 7274 2064 6972 207e  ast resort dir ~
+0000e1f0: 2f2e 636f 6e66 6967 2f2e 2e2e 290a 2020  /.config/...).  
+0000e200: 2020 7265 7475 726e 2063 7265 6465 6e74    return credent
+0000e210: 6961 6c73 5f66 696c 650a 0a0a 6465 6620  ials_file...def 
+0000e220: 6465 7465 726d 696e 655f 7374 6f72 655f  determine_store_
+0000e230: 6469 7228 2920 2d3e 2073 7472 3a0a 2020  dir() -> str:.  
+0000e240: 2020 2222 2244 6574 6572 6d69 6e65 2074    """Determine t
+0000e250: 6865 2074 7275 6520 6675 6c6c 2064 6972  he true full dir
+0000e260: 6563 746f 7279 206e 616d 6520 6f66 2073  ectory name of s
+0000e270: 746f 7265 2064 6972 6563 746f 7279 2e0a  tore directory..
+0000e280: 0a20 2020 2052 6574 7572 6e73 2066 696c  .    Returns fil
+0000e290: 656e 616d 6520 7769 7468 2066 756c 6c20  ename with full 
+0000e2a0: 7061 7468 2028 6120 6469 7229 206f 7220  path (a dir) or 
+0000e2b0: 4e6f 6e65 2e0a 0a20 2020 2046 6f72 2068  None...    For h
+0000e2c0: 6973 746f 7269 6320 7265 6173 6f6e 733a  istoric reasons:
+0000e2d0: 0a20 2020 2049 6620 2d2d 656e 6372 7970  .    If --encryp
+0000e2e0: 7465 6420 2865 6e63 7279 7074 6564 2920  ted (encrypted) 
+0000e2f0: 6973 204e 4f54 2074 7572 6e65 6420 6f6e  is NOT turned on
+0000e300: 2c20 7265 7475 726e 204e 6f6e 652e 0a0a  , return None...
+0000e310: 2020 2020 5468 6520 7374 6f72 6520 7061      The store pa
+0000e320: 7468 2077 696c 6c20 6265 206c 6f6f 6b65  th will be looke
+0000e330: 6420 666f 7220 7468 6520 666f 6c6c 6f77  d for the follow
+0000e340: 696e 6720 7761 793a 0a20 2020 2067 732e  ing way:.    gs.
+0000e350: 7061 2e73 746f 7265 2070 726f 7669 6465  pa.store provide
+0000e360: 7320 6569 7468 6572 2064 6566 6175 6c74  s either default
+0000e370: 2076 616c 7565 206f 7220 7573 6572 2073   value or user s
+0000e380: 7065 6369 6669 6564 2076 616c 7565 0a20  pecified value. 
+0000e390: 2020 2061 2920 4669 7273 7420 6c6f 6f6b     a) First look
+0000e3a0: 6564 2061 7420 6465 6661 756c 742f 7370  ed at default/sp
+0000e3b0: 6563 6966 6965 6420 7661 6c75 652e 2049  ecified value. I
+0000e3c0: 6620 6469 7220 6578 6973 7473 2c0a 2020  f dir exists,.  
+0000e3d0: 2020 2020 2075 7365 2069 742c 2065 6e64       use it, end
+0000e3e0: 206f 6620 7365 6172 6368 2e0a 2020 2020   of search..    
+0000e3f0: 6229 2069 6620 6c61 7374 2d72 6573 6f72  b) if last-resor
+0000e400: 7420 7374 6f72 6520 6469 7220 6578 6973  t store dir exis
+0000e410: 7473 2c20 7573 6520 6974 2c20 656e 6420  ts, use it, end 
+0000e420: 6f66 2073 6561 7263 682e 0a20 2020 2063  of search..    c
+0000e430: 2920 6966 206f 6e6c 7920 6120 6469 726e  ) if only a dirn
+0000e440: 616d 6520 7769 7468 6f75 7420 7061 7468  ame without path
+0000e450: 2028 652e 672e 2022 7374 6f72 6522 2920   (e.g. "store") 
+0000e460: 6973 2073 7065 6369 6669 6564 0a20 2020  is specified.   
+0000e470: 2020 2020 616e 6420 6974 2063 616e 6e6f      and it canno
+0000e480: 7420 6265 2066 6f75 6e64 2069 6e20 7468  t be found in th
+0000e490: 6520 6375 7272 656e 7420 6c6f 6361 6c20  e current local 
+0000e4a0: 6469 7265 6374 6f72 792c 2074 6865 6e0a  directory, then.
+0000e4b0: 2020 2020 2020 206c 6f6f 6b20 666f 7220         look for 
+0000e4c0: 6974 2069 6e20 6c61 7374 2d72 6573 6f72  it in last-resor
+0000e4d0: 7420 7061 7468 2e0a 2020 2020 544c 4452  t path..    TLDR
+0000e4e0: 3a20 5468 6520 7072 6f67 7261 6d20 7769  : The program wi
+0000e4f0: 6c6c 206c 6f6f 6b20 696e 2070 6174 6820  ll look in path 
+0000e500: 7370 6563 6966 6965 6420 7769 7468 202d  specified with -
+0000e510: 2d73 746f 7265 0a20 2020 2020 2020 636f  -store.       co
+0000e520: 6d6d 616e 6420 6c69 6e65 2061 7267 756d  mmand line argum
+0000e530: 656e 742e 2049 6620 6e6f 7420 666f 756e  ent. If not foun
+0000e540: 6420 7468 6572 6520 696e 2064 6566 6175  d there in defau
+0000e550: 6c74 0a20 2020 2020 2020 6c6f 6361 6c20  lt.       local 
+0000e560: 6469 722e 2049 6620 6e6f 7420 666f 756e  dir. If not foun
+0000e570: 6420 7468 6572 6520 696e 206c 6173 742d  d there in last-
+0000e580: 7265 736f 7274 2064 6972 2e0a 2020 2020  resort dir..    
+0000e590: 2020 2049 6620 6e6f 7420 666f 756e 6420     If not found 
+0000e5a0: 7468 6572 6520 2861 6e64 206f 6e6c 7920  there (and only 
+0000e5b0: 6469 726e 616d 6520 7769 7468 6f75 7420  dirname without 
+0000e5c0: 7061 7468 2067 6976 656e 292c 0a20 2020  path given),.   
+0000e5d0: 2020 2020 6173 2061 2066 696e 616c 2063      as a final c
+0000e5e0: 686f 6963 652c 2074 6865 2070 726f 6772  hoice, the progr
+0000e5f0: 616d 2077 696c 6c20 6c6f 6f6b 2066 6f72  am will look for
+0000e600: 2069 7420 696e 0a20 2020 2020 2020 6c61   it in.       la
+0000e610: 7374 2072 6573 6f72 7420 7061 7468 2e0a  st resort path..
+0000e620: 2020 2020 4966 206e 6f74 2066 6f75 6e64      If not found
+0000e630: 2061 6e79 7768 6572 652c 2069 7420 7769   anywhere, it wi
+0000e640: 6c6c 2072 6574 7572 6e20 6465 6661 756c  ll return defaul
+0000e650: 742f 7370 6563 6966 6965 6420 7661 6c75  t/specified valu
+0000e660: 652e 0a0a 2020 2020 2222 220a 2020 2020  e...    """.    
+0000e670: 6966 206e 6f74 2067 732e 7061 2e73 746f  if not gs.pa.sto
+0000e680: 7265 3a0a 2020 2020 2020 2020 7265 7475  re:.        retu
+0000e690: 726e 204e 6f6e 650a 2020 2020 6966 206e  rn None.    if n
+0000e6a0: 6f74 2067 732e 7061 2e65 6e63 7279 7074  ot gs.pa.encrypt
+0000e6b0: 6564 3a0a 2020 2020 2020 2020 7265 7475  ed:.        retu
+0000e6c0: 726e 204e 6f6e 650a 2020 2020 7061 7267  rn None.    parg
+0000e6d0: 735f 7374 6f72 655f 6e6f 726d 203d 206f  s_store_norm = o
+0000e6e0: 732e 7061 7468 2e6e 6f72 6d70 6174 6828  s.path.normpath(
+0000e6f0: 6773 2e70 612e 7374 6f72 6529 2020 2320  gs.pa.store)  # 
+0000e700: 6e6f 726d 6169 6c7a 6564 2066 6f72 2068  normailzed for h
+0000e710: 756d 616e 730a 2020 2020 6966 206f 732e  umans.    if os.
+0000e720: 7061 7468 2e69 7364 6972 2867 732e 7061  path.isdir(gs.pa
+0000e730: 2e73 746f 7265 293a 0a20 2020 2020 2020  .store):.       
+0000e740: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0000e750: 2020 2020 2020 2020 2020 2022 466f 756e             "Foun
+0000e760: 6420 616e 2065 7869 7374 696e 6720 7374  d an existing st
+0000e770: 6f72 6520 696e 2064 6972 6563 746f 7279  ore in directory
+0000e780: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+0000e790: 2722 7b70 6172 6773 5f73 746f 7265 5f6e  '"{pargs_store_n
+0000e7a0: 6f72 6d7d 2220 286c 6f63 616c 206f 7220  orm}" (local or 
+0000e7b0: 6172 6775 6d65 6e74 7329 2e20 270a 2020  arguments). '.  
+0000e7c0: 2020 2020 2020 2020 2020 2249 7420 7769            "It wi
+0000e7d0: 6c6c 2062 6520 7573 6564 2e22 0a20 2020  ll be used.".   
+0000e7e0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0000e7f0: 6574 7572 6e20 7061 7267 735f 7374 6f72  eturn pargs_stor
+0000e800: 655f 6e6f 726d 0a20 2020 2069 6620 6773  e_norm.    if gs
+0000e810: 2e70 612e 7374 6f72 6520 213d 2053 544f  .pa.store != STO
+0000e820: 5245 5f44 4952 5f44 4546 4155 4c54 2061  RE_DIR_DEFAULT a
+0000e830: 6e64 2067 732e 7061 2e73 746f 7265 2021  nd gs.pa.store !
+0000e840: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+0000e850: 6d65 280a 2020 2020 2020 2020 6773 2e70  me(.        gs.p
+0000e860: 612e 7374 6f72 650a 2020 2020 293a 0a20  a.store.    ):. 
+0000e870: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+0000e880: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+0000e890: 2066 2753 746f 7265 2064 6972 6563 746f   f'Store directo
+0000e8a0: 7279 2022 7b70 6172 6773 5f73 746f 7265  ry "{pargs_store
+0000e8b0: 5f6e 6f72 6d7d 2220 7761 7320 7370 6563  _norm}" was spec
+0000e8c0: 6966 6965 6420 6279 2027 0a20 2020 2020  ified by '.     
+0000e8d0: 2020 2020 2020 2022 7573 6572 2c20 6974         "user, it
+0000e8e0: 2069 7320 6120 6469 7265 6374 6f72 7920   is a directory 
+0000e8f0: 7769 7468 2061 2070 6174 682c 2062 7574  with a path, but
+0000e900: 2074 6865 2064 6972 6563 746f 7279 2022   the directory "
+0000e910: 0a20 2020 2020 2020 2020 2020 2022 646f  .            "do
+0000e920: 6573 206e 6f74 2065 7869 7374 2e20 220a  es not exist. ".
+0000e930: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000e940: 2020 2320 6661 6c6c 2074 6872 6f75 6768    # fall through
+0000e950: 2074 6f77 6172 6473 2065 6e64 696e 6720   towards ending 
+0000e960: 6f66 2066 756e 6374 696f 6e20 746f 2070  of function to p
+0000e970: 7269 6e74 2061 6e64 2072 6574 7572 6e20  rint and return 
+0000e980: 7661 6c75 650a 2020 2020 2020 2020 2320  value.        # 
+0000e990: 6372 6561 7465 2069 6e20 7468 6520 7370  create in the sp
+0000e9a0: 6563 6966 6965 642c 2064 6972 6563 746f  ecified, directo
+0000e9b0: 7279 2077 6974 6820 7061 7468 0a20 2020  ry with path.   
+0000e9c0: 2069 6620 6773 2e70 612e 7374 6f72 6520   if gs.pa.store 
+0000e9d0: 3d3d 2053 544f 5245 5f44 4952 5f44 4546  == STORE_DIR_DEF
+0000e9e0: 4155 4c54 2061 6e64 206f 732e 7061 7468  AULT and os.path
+0000e9f0: 2e69 7364 6972 280a 2020 2020 2020 2020  .isdir(.        
+0000ea00: 5354 4f52 455f 4449 525f 4c41 5354 5245  STORE_DIR_LASTRE
+0000ea10: 534f 5254 0a20 2020 2029 3a0a 2020 2020  SORT.    ):.    
+0000ea20: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0000ea30: 280a 2020 2020 2020 2020 2020 2020 2253  (.            "S
+0000ea40: 746f 7265 2077 6173 206e 6f74 2066 6f75  tore was not fou
+0000ea50: 6e64 2069 6e20 6465 6661 756c 7420 6c6f  nd in default lo
+0000ea60: 6361 6c20 6469 7265 6374 6f72 792e 2022  cal directory. "
+0000ea70: 0a20 2020 2020 2020 2020 2020 2022 4275  .            "Bu
+0000ea80: 7420 666f 756e 6420 616e 2065 7869 7374  t found an exist
+0000ea90: 696e 6720 7374 6f72 6520 6469 7265 6374  ing store direct
+0000eaa0: 6f72 7920 696e 2022 0a20 2020 2020 2020  ory in ".       
+0000eab0: 2020 2020 2066 2722 7b53 544f 5245 5f44       f'"{STORE_D
+0000eac0: 4952 5f4c 4153 5452 4553 4f52 547d 2220  IR_LASTRESORT}" 
+0000ead0: 6469 7265 6374 6f72 792e 2027 0a20 2020  directory. '.   
+0000eae0: 2020 2020 2020 2020 2022 4974 2077 696c           "It wil
+0000eaf0: 6c20 6265 2075 7365 642e 220a 2020 2020  l be used.".    
+0000eb00: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0000eb10: 7475 726e 2053 544f 5245 5f44 4952 5f4c  turn STORE_DIR_L
+0000eb20: 4153 5452 4553 4f52 540a 0a20 2020 2069  ASTRESORT..    i
+0000eb30: 6620 6773 2e70 612e 7374 6f72 6520 3d3d  f gs.pa.store ==
+0000eb40: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0000eb50: 6528 6773 2e70 612e 7374 6f72 6529 3a0a  e(gs.pa.store):.
+0000eb60: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0000eb70: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0000eb80: 2020 6627 5374 6f72 6520 6469 7265 6374    f'Store direct
+0000eb90: 6f72 7920 227b 7061 7267 735f 7374 6f72  ory "{pargs_stor
+0000eba0: 655f 6e6f 726d 7d22 2069 7320 6a75 7374  e_norm}" is just
+0000ebb0: 2061 206e 616d 6520 270a 2020 2020 2020   a name '.      
+0000ebc0: 2020 2020 2020 2277 6974 686f 7574 2061        "without a
+0000ebd0: 2070 6174 682e 2041 6c72 6561 6479 206c   path. Already l
+0000ebe0: 6f6f 6b65 6420 6c6f 6361 6c6c 792c 2062  ooked locally, b
+0000ebf0: 7574 206e 6f74 2066 6f75 6e64 2022 0a20  ut not found ". 
+0000ec00: 2020 2020 2020 2020 2020 2022 6c6f 6361             "loca
+0000ec10: 6c6c 792e 2053 6f20 6e6f 7720 6c6f 6f6b  lly. So now look
+0000ec20: 696e 6720 666f 7220 6974 2069 6e20 6c61  ing for it in la
+0000ec30: 7374 2d72 6573 6f72 7420 7061 7468 2e22  st-resort path."
+0000ec40: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0000ec50: 2020 206c 6173 745f 7265 736f 7274 203d     last_resort =
+0000ec60: 206f 732e 7061 7468 2e6e 6f72 6d70 6174   os.path.normpat
+0000ec70: 6828 0a20 2020 2020 2020 2020 2020 2053  h(.            S
+0000ec80: 544f 5245 5f50 4154 485f 4c41 5354 5245  TORE_PATH_LASTRE
+0000ec90: 534f 5254 202b 2022 2f22 202b 2067 732e  SORT + "/" + gs.
+0000eca0: 7061 2e73 746f 7265 0a20 2020 2020 2020  pa.store.       
+0000ecb0: 2029 0a20 2020 2020 2020 2069 6620 6f73   ).        if os
+0000ecc0: 2e70 6174 682e 6973 6469 7228 6c61 7374  .path.isdir(last
+0000ecd0: 5f72 6573 6f72 7429 3a0a 2020 2020 2020  _resort):.      
+0000ece0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0000ecf0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0000ed00: 2020 2020 2246 6f75 6e64 2061 6e20 6578      "Found an ex
+0000ed10: 6973 7469 6e67 2073 746f 7265 2064 6972  isting store dir
+0000ed20: 6563 746f 7279 2069 6e20 220a 2020 2020  ectory in ".    
+0000ed30: 2020 2020 2020 2020 2020 2020 6627 227b              f'"{
+0000ed40: 6c61 7374 5f72 6573 6f72 747d 2220 6469  last_resort}" di
+0000ed50: 7265 6374 6f72 792e 2049 7420 7769 6c6c  rectory. It will
+0000ed60: 2062 6520 7573 6564 2e27 0a20 2020 2020   be used.'.     
+0000ed70: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000ed80: 2020 2020 2072 6574 7572 6e20 6c61 7374       return last
+0000ed90: 5f72 6573 6f72 740a 0a20 2020 2067 732e  _resort..    gs.
+0000eda0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0000edb0: 2020 2022 5374 6f72 6520 6469 7265 6374     "Store direct
+0000edc0: 6f72 7920 7761 7320 6e6f 7420 666f 756e  ory was not foun
+0000edd0: 6420 616e 7977 6865 7265 2e20 4865 6e63  d anywhere. Henc
+0000ede0: 652c 2077 6520 7769 6c6c 2073 7567 6765  e, we will sugge
+0000edf0: 7374 2022 0a20 2020 2020 2020 2066 2722  st ".        f'"
+0000ee00: 7b70 6172 6773 5f73 746f 7265 5f6e 6f72  {pargs_store_nor
+0000ee10: 6d7d 2220 286c 6f63 616c 2064 6972 6563  m}" (local direc
+0000ee20: 746f 7279 2920 6173 2073 746f 7265 2064  tory) as store d
+0000ee30: 6972 6563 746f 7279 2e27 0a20 2020 2029  irectory.'.    )
+0000ee40: 0a20 2020 2072 6574 7572 6e20 7061 7267  .    return parg
+0000ee50: 735f 7374 6f72 655f 6e6f 726d 2020 2320  s_store_norm  # 
+0000ee60: 6372 6561 7465 2069 6e20 7468 6520 7370  create in the sp
+0000ee70: 6563 6966 6965 642c 206c 6f63 616c 2064  ecified, local d
+0000ee80: 6972 2077 6974 686f 7574 2070 6174 680a  ir without path.
+0000ee90: 0a0a 6173 796e 6320 6465 6620 6465 7465  ..async def dete
+0000eea0: 726d 696e 655f 646d 5f72 6f6f 6d73 280a  rmine_dm_rooms(.
+0000eeb0: 2020 2020 7573 6572 733a 206c 6973 742c      users: list,
+0000eec0: 2063 6c69 656e 743a 2041 7379 6e63 436c   client: AsyncCl
+0000eed0: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
+0000eee0: 733a 2064 6963 740a 2920 2d3e 206c 6973  s: dict.) -> lis
+0000eef0: 743a 0a20 2020 2022 2222 4465 7465 726d  t:.    """Determ
+0000ef00: 696e 6520 7468 6520 726f 6f6d 7320 746f  ine the rooms to
+0000ef10: 2073 656e 6420 746f 2e0a 0a20 2020 2055   send to...    U
+0000ef20: 7365 7273 2063 616e 2062 6520 7370 6563  sers can be spec
+0000ef30: 6966 6965 6420 7769 7468 202d 2d75 7365  ified with --use
+0000ef40: 7220 666f 7220 7365 6e64 2061 6e64 206c  r for send and l
+0000ef50: 6973 7465 6e20 6f70 6572 6174 696f 6e73  isten operations
+0000ef60: 2e0a 2020 2020 5468 6573 6520 726f 6f6d  ..    These room
+0000ef70: 7320 7765 206c 6162 656c 2044 4d20 2864  s we label DM (d
+0000ef80: 6972 6563 7420 6d65 7373 6167 696e 6729  irect messaging)
+0000ef90: 2072 6f6f 6d73 2e0a 2020 2020 4279 2074   rooms..    By t
+0000efa0: 6861 7420 7765 206d 6561 6e73 2072 6f6f  hat we means roo
+0000efb0: 6d73 2074 6861 7420 6f6e 6c79 2068 6176  ms that only hav
+0000efc0: 6520 3220 6d65 6d62 6572 732c 2061 6e64  e 2 members, and
+0000efd0: 2074 6865 7365 2074 776f 0a20 2020 206d   these two.    m
+0000efe0: 656d 6265 7273 2062 6569 6e67 2074 6865  embers being the
+0000eff0: 2073 656e 6465 7220 616e 6420 7468 6520   sender and the 
+0000f000: 7265 6369 7069 656e 7420 696e 2071 7565  recipient in que
+0000f010: 7374 696f 6e2e 0a20 2020 2057 6520 646f  stion..    We do
+0000f020: 206e 6f74 2063 6172 6520 6162 6f75 7420   not care about 
+0000f030: 2769 735f 6772 6f75 7027 206f 7220 2769  'is_group' or 'i
+0000f040: 735f 6469 7265 6374 2720 666c 6167 7320  s_direct' flags 
+0000f050: 2868 696e 7473 292e 0a0a 2020 2020 4966  (hints)...    If
+0000f060: 2067 6976 656e 2061 2075 7365 7220 616e   given a user an
+0000f070: 6420 6b6e 6f77 6e20 7468 6520 7365 6e64  d known the send
+0000f080: 6572 2c20 7765 2074 7279 2074 6f20 6669  er, we try to fi
+0000f090: 6e64 2061 206d 6174 6368 696e 6720 726f  nd a matching ro
+0000f0a0: 6f6d 2e0a 2020 2020 5468 6572 6520 6d69  om..    There mi
+0000f0b0: 6768 7420 6265 2030 2c20 312c 206f 7220  ght be 0, 1, or 
+0000f0c0: 6d6f 7265 206d 6174 6368 696e 6720 726f  more matching ro
+0000f0d0: 6f6d 732e 2049 6620 302c 2074 6865 6e20  oms. If 0, then 
+0000f0e0: 6769 7665 7220 6572 726f 720a 2020 2020  giver error.    
+0000f0f0: 616e 6420 7468 6520 7573 6572 2073 686f  and the user sho
+0000f100: 756c 6420 7275 6e20 2d2d 726f 6f6d 2d69  uld run --room-i
+0000f110: 6e76 6974 6520 6669 7273 742e 2069 6620  nvite first. if 
+0000f120: 3120 666f 756e 642c 2075 7365 2069 742e  1 found, use it.
+0000f130: 0a20 2020 2049 6620 6d6f 7265 2074 6861  .    If more tha
+0000f140: 6e20 3120 666f 756e 642c 206a 7573 7420  n 1 found, just 
+0000f150: 7573 6520 3120 6f66 2074 6865 6d20 6172  use 1 of them ar
+0000f160: 6269 7472 6172 696c 792e 0a0a 2020 2020  bitrarily...    
+0000f170: 5468 6520 7374 6570 7320 6172 653a 0a20  The steps are:. 
+0000f180: 2020 202d 2067 6574 2061 6c6c 2072 6f6f     - get all roo
+0000f190: 6d73 2077 6865 7265 2073 656e 6465 7220  ms where sender 
+0000f1a0: 6973 206d 656d 6265 720a 2020 2020 2d20  is member.    - 
+0000f1b0: 6765 7420 616c 6c20 6d65 6d62 6572 7320  get all members 
+0000f1c0: 746f 2074 6865 7365 2072 6f6f 6d73 0a20  to these rooms. 
+0000f1d0: 2020 202d 2063 6865 636b 2069 6620 7468     - check if th
+0000f1e0: 6572 6520 6973 2061 2072 6f6f 6d20 7769  ere is a room wi
+0000f1f0: 7468 206a 7573 7420 3220 6d65 6d62 6572  th just 2 member
+0000f200: 7320 616e 6420 7468 656d 0a20 2020 2020  s and them.     
+0000f210: 2062 6569 6e67 2073 656e 6465 7220 616e   being sender an
+0000f220: 6420 7265 6369 7069 656e 7420 2875 7365  d recipient (use
+0000f230: 7220 6672 6f6d 2075 7365 7273 2061 7267  r from users arg
+0000f240: 290a 0a20 2020 2049 6e20 6f72 6465 7220  )..    In order 
+0000f250: 746f 206d 6174 6368 2061 2075 7365 7220  to match a user 
+0000f260: 746f 2061 2052 6f6f 6d4d 656d 6265 7220  to a RoomMember 
+0000f270: 7765 2061 6c6c 6f77 2033 2063 686f 6963  we allow 3 choic
+0000f280: 6573 3a0a 2020 2020 2d20 7573 6572 5f69  es:.    - user_i
+0000f290: 643a 2070 6572 6665 6374 206d 6174 6368  d: perfect match
+0000f2a0: 2c20 6973 2075 6e69 7175 652c 2066 756c  , is unique, ful
+0000f2b0: 6c20 7573 6572 2069 642c 2065 2e67 2e20  l user id, e.g. 
+0000f2c0: 2240 7573 6572 3a65 7861 6d70 6c65 2e6f  "@user:example.o
+0000f2d0: 7267 220a 2020 2020 2d20 7573 6572 5f69  rg".    - user_i
+0000f2e0: 6420 7769 7468 6f75 7420 686f 6d65 7365  d without homese
+0000f2f0: 7276 6572 2064 6f6d 6169 6e3a 2070 6172  rver domain: par
+0000f300: 7469 616c 2075 7365 7220 6964 2c20 652e  tial user id, e.
+0000f310: 672e 2022 4075 7365 7222 0a20 2020 2020  g. "@user".     
+0000f320: 2074 6869 7320 7061 7274 6961 6c20 7573   this partial us
+0000f330: 6572 2077 696c 6c20 6265 2063 6f6d 706c  er will be compl
+0000f340: 6574 6564 2062 7920 6164 6469 6e67 2074  eted by adding t
+0000f350: 6865 2068 6f6d 6573 6572 7665 7220 6f66  he homeserver of
+0000f360: 2074 6865 0a20 2020 2020 2073 656e 6465   the.      sende
+0000f370: 7220 746f 2074 6865 2065 6e64 2c20 692e  r to the end, i.
+0000f380: 652e 2061 7373 756d 696e 6720 7468 6174  e. assuming that
+0000f390: 2073 656e 6465 7220 616e 6420 7265 6365   sender and rece
+0000f3a0: 6976 6572 2061 7265 206f 6e20 7468 650a  iver are on the.
+0000f3b0: 2020 2020 2020 7361 6d65 2068 6f6d 6573        same homes
+0000f3c0: 6572 7665 722e 0a20 2020 202d 2064 6973  erver..    - dis
+0000f3d0: 706c 6179 206e 616d 653a 2062 6520 6361  play name: be ca
+0000f3e0: 7265 6675 6c2c 2064 6973 706c 6179 206e  reful, display n
+0000f3f0: 616d 6573 2061 7265 204e 4f54 2075 6e69  ames are NOT uni
+0000f400: 7175 652c 2079 6f75 2063 6f75 6c64 2062  que, you could b
+0000f410: 650a 2020 2020 2020 6d69 7374 616b 656e  e.      mistaken
+0000f420: 2061 6e64 2062 7920 6572 726f 7220 7365   and by error se
+0000f430: 6e64 2074 6f20 7468 6520 7772 6f6e 6720  nd to the wrong 
+0000f440: 7065 7273 6f6e 2e0a 2020 2020 2020 272d  person..      '-
+0000f450: 2d6a 6f69 6e65 642d 6d65 6d62 6572 7320  -joined-members 
+0000f460: 222a 2227 2073 686f 7773 2079 6f75 2074  "*"' shows you t
+0000f470: 6865 2064 6973 706c 6179 206e 616d 6573  he display names
+0000f480: 2069 6e20 7468 6520 6d69 6464 6c65 2063   in the middle c
+0000f490: 6f6c 756d 6e0a 0a20 2020 2041 7267 756d  olumn..    Argum
+0000f4a0: 656e 7473 3a0a 2020 2020 2d2d 2d2d 2d2d  ents:.    ------
+0000f4b0: 2d2d 2d0a 2020 2020 2020 2020 7573 6572  ---.        user
+0000f4c0: 733a 206c 6973 7428 7374 7229 3a20 6c69  s: list(str): li
+0000f4d0: 7374 206f 6620 7573 6572 5f69 6473 0a20  st of user_ids. 
+0000f4e0: 2020 2020 2020 2020 2020 2074 7279 2074             try t
+0000f4f0: 6f20 6669 6e64 2061 206d 6174 6368 696e  o find a matchin
+0000f500: 6720 444d 2072 6f6f 6d20 666f 7220 6561  g DM room for ea
+0000f510: 6368 2075 7365 720a 2020 2020 2020 2020  ch user.        
+0000f520: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
+0000f530: 656e 743a 2063 6c69 656e 742c 2061 6c6c  ent: client, all
+0000f540: 6f77 7320 6173 2074 6f20 7175 6572 7920  ows as to query 
+0000f550: 7468 6520 7365 7276 6572 0a20 2020 2020  the server.     
+0000f560: 2020 2063 7265 6465 6e74 6961 6c73 3a20     credentials: 
+0000f570: 6469 6374 3a20 616c 6c6f 7773 2074 6f20  dict: allows to 
+0000f580: 6765 7420 7468 6520 7573 6572 5f69 6420  get the user_id 
+0000f590: 6f66 2073 656e 6465 720a 0a20 2020 2052  of sender..    R
+0000f5a0: 6574 7572 6e73 2061 206c 6973 7420 6f66  eturns a list of
+0000f5b0: 2066 6f75 6e64 2044 4d20 726f 6f6d 732e   found DM rooms.
+0000f5c0: 204c 6973 7420 6d61 7920 6265 2065 6d70   List may be emp
+0000f5d0: 7479 2069 6620 6e6f 206d 6174 6368 6573  ty if no matches
+0000f5e0: 2077 6572 650a 2020 2020 666f 756e 642e   were.    found.
+0000f5f0: 0a0a 2020 2020 2222 220a 2020 2020 726f  ..    """.    ro
+0000f600: 6f6d 7320 3d20 5b5d 0a20 2020 2069 6620  oms = [].    if 
+0000f610: 6e6f 7420 7573 6572 733a 0a20 2020 2020  not users:.     
+0000f620: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0000f630: 6622 526f 6f6d 2873 2920 6672 6f6d 202d  f"Room(s) from -
+0000f640: 2d75 7365 723a 207b 726f 6f6d 737d 2c20  -user: {rooms}, 
+0000f650: 6e6f 2075 7365 7273 2077 6572 6520 7370  no users were sp
+0000f660: 6563 6966 6965 642e 2229 0a20 2020 2020  ecified.").     
+0000f670: 2020 2072 6574 7572 6e20 726f 6f6d 730a     return rooms.
+0000f680: 2020 2020 7365 6e64 6572 203d 2063 7265      sender = cre
+0000f690: 6465 6e74 6961 6c73 5b22 7573 6572 5f69  dentials["user_i
+0000f6a0: 6422 5d20 2023 2077 686f 2061 6d20 690a  d"]  # who am i.
+0000f6b0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0000f6c0: 2866 2254 7279 696e 6720 746f 2067 6574  (f"Trying to get
+0000f6d0: 206d 656d 6265 7273 2066 6f72 2061 6c6c   members for all
+0000f6e0: 2072 6f6f 6d73 206f 6620 7365 6e64 6572   rooms of sender
+0000f6f0: 3a20 7b73 656e 6465 727d 2229 0a20 2020  : {sender}").   
+0000f700: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
+0000f710: 6965 6e74 2e6a 6f69 6e65 645f 726f 6f6d  ient.joined_room
+0000f720: 7328 290a 2020 2020 6966 2069 7369 6e73  s().    if isins
+0000f730: 7461 6e63 6528 7265 7370 2c20 4a6f 696e  tance(resp, Join
+0000f740: 6564 526f 6f6d 7345 7272 6f72 293a 0a20  edRoomsError):. 
+0000f750: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+0000f760: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0000f770: 2022 4531 3137 3a20 220a 2020 2020 2020   "E117: ".      
+0000f780: 2020 2020 2020 6622 6a6f 696e 6564 5f72        f"joined_r
+0000f790: 6f6f 6d73 2066 6169 6c65 6420 7769 7468  ooms failed with
+0000f7a0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+0000f7b0: 2873 7472 2872 6573 7029 297d 2e20 220a  (str(resp))}. ".
+0000f7c0: 2020 2020 2020 2020 2020 2020 224e 6f74              "Not
+0000f7d0: 2061 626c 6520 746f 2022 0a20 2020 2020   able to ".     
+0000f7e0: 2020 2020 2020 2022 6765 7420 616c 6c20         "get all 
+0000f7f0: 726f 6f6d 732e 2022 0a20 2020 2020 2020  rooms. ".       
+0000f800: 2020 2020 2066 224e 6f74 2061 626c 6520       f"Not able 
+0000f810: 746f 2066 696e 6420 444d 2072 6f6f 6d73  to find DM rooms
+0000f820: 2066 6f72 2073 656e 6465 7220 7b73 656e   for sender {sen
+0000f830: 6465 727d 2e20 220a 2020 2020 2020 2020  der}. ".        
+0000f840: 2020 2020 6622 4e6f 7420 6162 6c65 2074      f"Not able t
+0000f850: 6f20 7365 6e64 2074 6f20 7265 6365 6976  o send to receiv
+0000f860: 6572 7320 7b75 7365 7273 7d2e 220a 2020  ers {users}.".  
+0000f870: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f880: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+0000f890: 310a 2020 2020 2020 2020 7365 6e64 6572  1.        sender
+0000f8a0: 726f 6f6d 7320 3d20 5b5d 0a20 2020 2065  rooms = [].    e
+0000f8b0: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
+0000f8c0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0000f8d0: 2020 2020 2020 2066 226a 6f69 6e65 645f         f"joined_
+0000f8e0: 726f 6f6d 7320 7375 6363 6573 7366 756c  rooms successful
+0000f8f0: 2077 6974 6820 7b70 7269 7661 6379 5f66   with {privacy_f
+0000f900: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+0000f910: 7d22 0a20 2020 2020 2020 2029 0a20 2020  }".        ).   
+0000f920: 2020 2020 2073 656e 6465 7272 6f6f 6d73       senderrooms
+0000f930: 203d 2072 6573 702e 726f 6f6d 730a 2020   = resp.rooms.  
+0000f940: 2020 726f 6f6d 5f66 6f75 6e64 5f66 6f72    room_found_for
+0000f950: 5f75 7365 7273 203d 205b 5d0a 2020 2020  _users = [].    
+0000f960: 666f 7220 726f 6f6d 2069 6e20 7365 6e64  for room in send
+0000f970: 6572 726f 6f6d 733a 0a20 2020 2020 2020  errooms:.       
+0000f980: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
+0000f990: 6965 6e74 2e6a 6f69 6e65 645f 6d65 6d62  ient.joined_memb
+0000f9a0: 6572 7328 726f 6f6d 290a 2020 2020 2020  ers(room).      
+0000f9b0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000f9c0: 7265 7370 2c20 4a6f 696e 6564 4d65 6d62  resp, JoinedMemb
+0000f9d0: 6572 7345 7272 6f72 293a 0a20 2020 2020  ersError):.     
+0000f9e0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+0000f9f0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0000fa00: 2020 2020 2022 4531 3138 3a20 220a 2020       "E118: ".  
+0000fa10: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0000fa20: 6a6f 696e 6564 5f6d 656d 6265 7273 2066  joined_members f
+0000fa30: 6169 6c65 6420 7769 7468 207b 7072 6976  ailed with {priv
+0000fa40: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+0000fa50: 6573 7029 297d 2e20 220a 2020 2020 2020  esp))}. ".      
+0000fa60: 2020 2020 2020 2020 2020 224e 6f74 2061            "Not a
+0000fa70: 626c 6520 746f 2022 0a20 2020 2020 2020  ble to ".       
+0000fa80: 2020 2020 2020 2020 2066 2267 6574 2072           f"get r
+0000fa90: 6f6f 6d20 6d65 6d62 6572 7320 666f 7220  oom members for 
+0000faa0: 726f 6f6d 207b 726f 6f6d 7d2e 2022 0a20  room {room}. ". 
+0000fab0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000fac0: 224e 6f74 2061 626c 6520 746f 2066 696e  "Not able to fin
+0000fad0: 6420 444d 2072 6f6f 6d73 2066 6f72 2073  d DM rooms for s
+0000fae0: 656e 6465 7220 7b73 656e 6465 727d 2e20  ender {sender}. 
+0000faf0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000fb00: 2020 6622 4e6f 7420 6162 6c65 2074 6f20    f"Not able to 
+0000fb10: 7365 6e64 2074 6f20 736f 6d65 206f 6620  send to some of 
+0000fb20: 7468 6573 6520 7265 6365 6976 6572 7320  these receivers 
+0000fb30: 7b75 7365 7273 7d2e 220a 2020 2020 2020  {users}.".      
+0000fb40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000fb50: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+0000fb60: 202b 3d20 310a 2020 2020 2020 2020 656c   += 1.        el
+0000fb70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000fb80: 2320 7265 7370 2e72 6f6f 6d5f 6964 0a20  # resp.room_id. 
+0000fb90: 2020 2020 2020 2020 2020 2023 2072 6573             # res
+0000fba0: 702e 6d65 6d62 6572 7320 3d20 4c69 7374  p.members = List
+0000fbb0: 5b52 6f6f 6d4d 656d 6265 725d 203b 2052  [RoomMember] ; R
+0000fbc0: 6f6f 6d4d 656d 6265 720a 2020 2020 2020  oomMember.      
+0000fbd0: 2020 2020 2020 2320 6d65 6d62 6572 2e75        # member.u
+0000fbe0: 7365 725f 6964 0a20 2020 2020 2020 2020  ser_id.         
+0000fbf0: 2020 2023 206d 656d 6265 722e 6469 7370     # member.disp
+0000fc00: 6c61 795f 6e61 6d65 0a20 2020 2020 2020  lay_name.       
+0000fc10: 2020 2020 2023 206d 656d 6265 722e 6176       # member.av
+0000fc20: 6174 6172 5f75 726c 0a20 2020 2020 2020  atar_url.       
+0000fc30: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+0000fc40: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0000fc50: 2020 2066 226a 6f69 6e65 645f 6d65 6d62     f"joined_memb
+0000fc60: 6572 7320 7375 6363 6573 7366 756c 2077  ers successful w
+0000fc70: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
+0000fc80: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+0000fc90: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000fca0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+0000fcb0: 7370 2e6d 656d 6265 7273 2061 6e64 206c  sp.members and l
+0000fcc0: 656e 2872 6573 702e 6d65 6d62 6572 7329  en(resp.members)
+0000fcd0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+0000fce0: 2020 2020 2020 2069 6620 7265 7370 2e6d         if resp.m
+0000fcf0: 656d 6265 7273 5b30 5d2e 7573 6572 5f69  embers[0].user_i
+0000fd00: 6420 3d3d 2073 656e 6465 723a 0a20 2020  d == sender:.   
+0000fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd20: 2023 2073 6e64 7220 3d20 7265 7370 2e6d   # sndr = resp.m
+0000fd30: 656d 6265 7273 5b30 5d0a 2020 2020 2020  embers[0].      
+0000fd40: 2020 2020 2020 2020 2020 2020 2020 7263                rc
+0000fd50: 7672 203d 2072 6573 702e 6d65 6d62 6572  vr = resp.member
+0000fd60: 735b 315d 0a20 2020 2020 2020 2020 2020  s[1].           
+0000fd70: 2020 2020 2065 6c69 6620 7265 7370 2e6d       elif resp.m
+0000fd80: 656d 6265 7273 5b31 5d2e 7573 6572 5f69  embers[1].user_i
+0000fd90: 6420 3d3d 2073 656e 6465 723a 0a20 2020  d == sender:.   
+0000fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdb0: 2023 2073 6e64 7220 3d20 7265 7370 2e6d   # sndr = resp.m
+0000fdc0: 656d 6265 7273 5b31 5d0a 2020 2020 2020  embers[1].      
+0000fdd0: 2020 2020 2020 2020 2020 2020 2020 7263                rc
+0000fde0: 7672 203d 2072 6573 702e 6d65 6d62 6572  vr = resp.member
+0000fdf0: 735b 305d 0a20 2020 2020 2020 2020 2020  s[0].           
+0000fe00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000fe10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000fe20: 2073 6e64 7220 3d20 4e6f 6e65 0a20 2020   sndr = None.   
+0000fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe40: 2072 6376 7220 3d20 4e6f 6e65 0a20 2020   rcvr = None.   
+0000fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe60: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0000fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe80: 2020 2020 2020 2022 4531 3139 3a20 220a         "E119: ".
+0000fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fea0: 2020 2020 2020 2020 6622 5365 6e64 6572          f"Sender
+0000feb0: 2064 6f65 7320 6e6f 7420 6d61 7463 6820   does not match 
+0000fec0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
+0000fed0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
+0000fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fef0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0000ff00: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+0000ff10: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+0000ff20: 2020 2020 2020 2020 2066 6f72 2075 7365           for use
+0000ff30: 7220 696e 2075 7365 7273 3a0a 2020 2020  r in users:.    
+0000ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff50: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+0000ff60: 2020 2020 2020 2020 2020 2020 2072 6376               rcv
+0000ff70: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0000ff80: 2020 2020 2020 2020 2020 616e 6420 7573            and us
+0000ff90: 6572 203d 3d20 7263 7672 2e75 7365 725f  er == rcvr.user_
+0000ffa0: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
+0000ffb0: 2020 2020 2020 2020 2020 206f 7220 7368             or sh
+0000ffc0: 6f72 745f 7573 6572 5f6e 616d 655f 746f  ort_user_name_to
+0000ffd0: 5f75 7365 725f 6964 2875 7365 722c 2063  _user_id(user, c
+0000ffe0: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+0000fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010000: 2020 2020 3d3d 2072 6376 722e 7573 6572      == rcvr.user
+00010010: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
+00010020: 2020 2020 2020 2020 2020 2020 6f72 2075              or u
+00010030: 7365 7220 3d3d 2072 6376 722e 6469 7370  ser == rcvr.disp
+00010040: 6c61 795f 6e61 6d65 0a20 2020 2020 2020  lay_name.       
+00010050: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00010060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010070: 2020 2020 2020 2020 726f 6f6d 5f66 6f75          room_fou
+00010080: 6e64 5f66 6f72 5f75 7365 7273 2e61 7070  nd_for_users.app
+00010090: 656e 6428 7573 6572 290a 2020 2020 2020  end(user).      
+000100a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100b0: 2020 726f 6f6d 732e 6170 7065 6e64 2872    rooms.append(r
+000100c0: 6573 702e 726f 6f6d 5f69 6429 0a20 2020  esp.room_id).   
+000100d0: 2066 6f72 2075 7365 7220 696e 2075 7365   for user in use
+000100e0: 7273 3a0a 2020 2020 2020 2020 6966 2075  rs:.        if u
+000100f0: 7365 7220 6e6f 7420 696e 2072 6f6f 6d5f  ser not in room_
+00010100: 666f 756e 645f 666f 725f 7573 6572 733a  found_for_users:
+00010110: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00010120: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00010130: 2020 2020 2020 2020 2020 2022 4531 3230             "E120
+00010140: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00010150: 2020 2020 2252 6f6f 6d28 7329 2077 6572      "Room(s) wer
+00010160: 6520 7370 6563 6966 6965 6420 666f 7220  e specified for 
+00010170: 6120 444d 2028 6469 7265 6374 206d 6573  a DM (direct mes
+00010180: 7361 6769 6e67 2920 220a 2020 2020 2020  saging) ".      
+00010190: 2020 2020 2020 2020 2020 2273 656e 6420            "send 
+000101a0: 6f70 6572 6174 696f 6e20 7669 6120 2d2d  operation via --
+000101b0: 726f 6f6d 2e20 4275 7420 6e6f 2044 4d20  room. But no DM 
+000101c0: 726f 6f6d 2077 6173 2022 0a20 2020 2020  room was ".     
+000101d0: 2020 2020 2020 2020 2020 2066 2266 6f75             f"fou
+000101e0: 6e64 2066 6f72 2075 7365 7220 277b 7573  nd for user '{us
+000101f0: 6572 7d27 2e20 220a 2020 2020 2020 2020  er}'. ".        
+00010200: 2020 2020 2020 2020 2254 7279 2073 6574          "Try set
+00010210: 7469 6e67 2075 7020 6120 726f 6f6d 2066  ting up a room f
+00010220: 6972 7374 2076 6961 202d 2d72 6f6f 6d2d  irst via --room-
+00010230: 6372 6561 7465 2061 6e64 2022 0a20 2020  create and ".   
+00010240: 2020 2020 2020 2020 2020 2020 2022 2d2d               "--
+00010250: 726f 6f6d 2d69 6e76 6974 6520 6f70 7469  room-invite opti
+00010260: 6f6e 206f 7220 2d2d 726f 6f6d 2d64 6d2d  on or --room-dm-
+00010270: 6372 6561 7465 2e22 0a20 2020 2020 2020  create.".       
+00010280: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00010290: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+000102a0: 2b3d 2031 0a20 2020 2072 6f6f 6d73 203d  += 1.    rooms =
+000102b0: 206c 6973 7428 6469 6374 2e66 726f 6d6b   list(dict.fromk
+000102c0: 6579 7328 726f 6f6d 7329 2920 2023 2072  eys(rooms))  # r
+000102d0: 656d 6f76 6520 6475 706c 6963 6174 6573  emove duplicates
+000102e0: 2069 6e20 6c69 7374 0a20 2020 2067 732e   in list.    gs.
+000102f0: 6c6f 672e 6465 6275 6728 6622 526f 6f6d  log.debug(f"Room
+00010300: 2873 2920 6672 6f6d 202d 2d75 7365 723a  (s) from --user:
+00010310: 207b 726f 6f6d 737d 2229 0a20 2020 2072   {rooms}").    r
+00010320: 6574 7572 6e20 726f 6f6d 730a 0a0a 6173  eturn rooms...as
+00010330: 796e 6320 6465 6620 6465 7465 726d 696e  ync def determin
+00010340: 655f 726f 6f6d 7328 0a20 2020 2072 6f6f  e_rooms(.    roo
+00010350: 6d5f 6964 3a20 7374 722c 2063 6c69 656e  m_id: str, clien
+00010360: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
+00010370: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
+00010380: 740a 2920 2d3e 206c 6973 743a 0a20 2020  t.) -> list:.   
+00010390: 2022 2222 4465 7465 726d 696e 6520 7468   """Determine th
+000103a0: 6520 726f 6f6d 2074 6f20 7365 6e64 2074  e room to send t
+000103b0: 6f2e 0a0a 2020 2020 4172 6775 6d65 6e74  o...    Argument
+000103c0: 733a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  s:.    ---------
+000103d0: 0a20 2020 2072 6f6f 6d5f 6964 203a 2072  .    room_id : r
+000103e0: 6f6f 6d20 6672 6f6d 2063 7265 6465 6e74  oom from credent
+000103f0: 6961 6c73 2066 696c 650a 0a20 2020 204c  ials file..    L
+00010400: 6f6f 6b20 6174 2072 6f6f 6d20 6672 6f6d  ook at room from
+00010410: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+00010420: 6520 616e 6420 6174 2072 6f6f 6d73 2066  e and at rooms f
+00010430: 726f 6d20 636f 6d6d 616e 6420 6c69 6e65  rom command line
+00010440: 0a20 2020 2061 6e64 2070 7265 7061 7265  .    and prepare
+00010450: 7320 6120 6465 6669 6e69 7465 206c 6973  s a definite lis
+00010460: 7420 6f66 2072 6f6f 6d73 2e0a 0a20 2020  t of rooms...   
+00010470: 204e 6577 3a20 416c 736f 206c 6f6f 6b20   New: Also look 
+00010480: 6174 202d 2d75 7365 722e 2046 6f72 2044  at --user. For D
+00010490: 4d20 2864 6972 6563 7420 6d65 7373 6167  M (direct messag
+000104a0: 696e 6729 2c20 6465 7374 696e 6174 696f  ing), destinatio
+000104b0: 6e73 0a20 2020 2061 7265 2073 7065 6369  ns.    are speci
+000104c0: 6669 6564 2076 6961 202d 2d75 7365 722e  fied via --user.
+000104d0: 2046 6f72 2065 7665 7279 2075 7365 7220   For every user 
+000104e0: 666f 756e 642c 2073 6565 2069 6620 7468  found, see if th
+000104f0: 6572 6520 6973 2061 0a20 2020 2022 444d  ere is a.    "DM
+00010500: 2220 726f 6f6d 2c20 6120 726f 6f6d 2077  " room, a room w
+00010510: 6974 6820 6f6e 6c79 2032 206d 656d 6265  ith only 2 membe
+00010520: 7273 2028 7365 6e64 6572 2061 6e64 2072  rs (sender and r
+00010530: 6563 6970 6965 6e74 292e 0a20 2020 2049  ecipient)..    I
+00010540: 6620 7375 6368 2061 2022 444d 2220 726f  f such a "DM" ro
+00010550: 6f6d 2069 7320 666f 756e 642c 2061 6464  om is found, add
+00010560: 2069 7420 746f 2074 6865 2067 656e 6572   it to the gener
+00010570: 616c 2072 6f6f 6d73 206c 6973 740a 2020  al rooms list.  
+00010580: 2020 7468 6174 2069 7320 7265 7475 726e    that is return
+00010590: 6564 2e0a 0a20 2020 204d 6978 696e 6720  ed...    Mixing 
+000105a0: 616e 6420 6d61 7463 6869 6e67 206f 6620  and matching of 
+000105b0: 2d2d 726f 6f6d 2061 6e64 202d 2d75 7365  --room and --use
+000105c0: 7220 6973 2070 6f73 7369 626c 652e 0a20  r is possible.. 
+000105d0: 2020 202d 2d72 6f6f 6d20 5231 2052 3220     --room R1 R2 
+000105e0: 2d2d 7573 6572 2055 3120 5532 206d 6967  --user U1 U2 mig
+000105f0: 6874 206c 6561 6420 746f 2034 2072 6f6f  ht lead to 4 roo
+00010600: 6d73 2069 6e20 746f 7461 6c2e 0a20 2020  ms in total..   
+00010610: 2049 6620 6e6f 2022 444d 2220 726f 6f6d   If no "DM" room
+00010620: 2069 7320 666f 756e 6420 7468 656e 2067   is found then g
+00010630: 6976 6520 6572 726f 7220 616e 6420 7465  ive error and te
+00010640: 6c6c 2075 7365 7220 746f 2064 6f0a 2020  ll user to do.  
+00010650: 2020 2d2d 726f 6f6d 2d69 6e76 6974 6520    --room-invite 
+00010660: 6669 7273 742e 0a0a 2020 2020 5265 7475  first...    Retu
+00010670: 726e 206c 6973 7420 6f66 2072 6f6f 6d73  rn list of rooms
+00010680: 2074 6f20 7365 6e64 2074 6f2e 2052 6574   to send to. Ret
+00010690: 7572 6e65 6420 6c69 7374 2069 7320 6e65  urned list is ne
+000106a0: 7665 7220 656d 7074 792e 0a0a 2020 2020  ver empty...    
+000106b0: 2222 220a 2020 2020 6966 206e 6f74 2067  """.    if not g
+000106c0: 732e 7061 2e72 6f6f 6d20 616e 6420 6e6f  s.pa.room and no
+000106d0: 7420 6773 2e70 612e 7573 6572 3a0a 2020  t gs.pa.user:.  
+000106e0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+000106f0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00010700: 2252 6f6f 6d20 6964 2077 6173 2070 726f  "Room id was pro
+00010710: 7669 6465 6420 7669 6120 6372 6564 656e  vided via creden
+00010720: 7469 616c 7320 6669 6c65 2e20 220a 2020  tials file. ".  
+00010730: 2020 2020 2020 2020 2020 224e 6f20 726f            "No ro
+00010740: 6f6d 7320 6769 7665 6e20 696e 2063 6f6d  oms given in com
+00010750: 6d61 6e64 7320 6c69 6e65 2e20 220a 2020  mands line. ".  
+00010760: 2020 2020 2020 2020 2020 224e 6f20 7573            "No us
+00010770: 6572 7320 6769 7665 6e20 696e 2063 6f6d  ers given in com
+00010780: 6d61 6e64 206c 696e 6520 666f 7220 444d  mand line for DM
+00010790: 2072 6f6f 6d73 2e20 220a 2020 2020 2020   rooms. ".      
+000107a0: 2020 2020 2020 6627 5365 7474 696e 6720        f'Setting 
+000107b0: 726f 6f6d 7320 746f 2022 7b72 6f6f 6d5f  rooms to "{room_
+000107c0: 6964 7d22 2e27 0a20 2020 2020 2020 2029  id}".'.        )
+000107d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000107e0: 5b72 6f6f 6d5f 6964 5d20 2023 206c 6973  [room_id]  # lis
+000107f0: 7420 6f66 2031 0a20 2020 2072 6f6f 6d73  t of 1.    rooms
+00010800: 203d 205b 5d0a 2020 2020 6966 2067 732e   = [].    if gs.
+00010810: 7061 2e72 6f6f 6d3a 0a20 2020 2020 2020  pa.room:.       
+00010820: 2066 6f72 2072 6f6f 6d20 696e 2067 732e   for room in gs.
+00010830: 7061 2e72 6f6f 6d3a 0a20 2020 2020 2020  pa.room:.       
+00010840: 2020 2020 2072 6f6f 6d5f 6964 203d 2072       room_id = r
+00010850: 6f6f 6d2e 7265 706c 6163 6528 7222 5c21  oom.replace(r"\!
+00010860: 222c 2022 2122 2920 2023 2072 656d 6f76  ", "!")  # remov
+00010870: 6520 706f 7373 6962 6c65 2065 7363 6170  e possible escap
+00010880: 650a 2020 2020 2020 2020 2020 2020 726f  e.            ro
+00010890: 6f6d 732e 6170 7065 6e64 2872 6f6f 6d5f  oms.append(room_
+000108a0: 6964 290a 2020 2020 2020 2020 6773 2e6c  id).        gs.l
+000108b0: 6f67 2e64 6562 7567 2866 2252 6f6f 6d28  og.debug(f"Room(
+000108c0: 7329 2066 726f 6d20 2d2d 726f 6f6d 3a20  s) from --room: 
+000108d0: 7b72 6f6f 6d73 7d22 290a 2020 2020 726f  {rooms}").    ro
+000108e0: 6f6d 7320 2b3d 2061 7761 6974 2064 6574  oms += await det
+000108f0: 6572 6d69 6e65 5f64 6d5f 726f 6f6d 7328  ermine_dm_rooms(
+00010900: 6773 2e70 612e 7573 6572 2c20 636c 6965  gs.pa.user, clie
+00010910: 6e74 2c20 6372 6564 656e 7469 616c 7329  nt, credentials)
+00010920: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
+00010930: 6728 0a20 2020 2020 2020 2022 526f 6f6d  g(.        "Room
+00010940: 2873 2920 6f72 2075 7365 7228 7329 2077  (s) or user(s) w
+00010950: 6572 6520 7072 6f76 6964 6564 2076 6961  ere provided via
+00010960: 2063 6f6d 6d61 6e64 206c 696e 652e 2022   command line. "
+00010970: 0a20 2020 2020 2020 2022 4f76 6572 7772  .        "Overwr
+00010980: 6974 696e 6720 726f 6f6d 2069 6420 6672  iting room id fr
+00010990: 6f6d 2063 7265 6465 6e74 6961 6c73 2066  om credentials f
+000109a0: 696c 6520 220a 2020 2020 2020 2020 6627  ile ".        f'
+000109b0: 7769 7468 2072 6f6f 6d73 2022 7b72 6f6f  with rooms "{roo
+000109c0: 6d73 7d22 2027 0a20 2020 2020 2020 2022  ms}" '.        "
+000109d0: 6672 6f6d 2063 6f6d 6d61 6e64 206c 696e  from command lin
+000109e0: 652e 220a 2020 2020 290a 2020 2020 7265  e.".    ).    re
+000109f0: 7475 726e 2072 6f6f 6d73 0a0a 0a61 7379  turn rooms...asy
+00010a00: 6e63 2064 6566 206d 6170 5f72 6f6f 6d69  nc def map_roomi
+00010a10: 6e66 6f5f 746f 5f72 6f6f 6d69 6428 636c  nfo_to_roomid(cl
+00010a20: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+00010a30: 742c 2069 6e66 6f3a 2073 7472 2920 2d3e  t, info: str) ->
+00010a40: 2073 7472 3a0a 2020 2020 2222 2241 7474   str:.    """Att
+00010a50: 656d 7074 2074 6f20 636f 6e76 6572 7420  empt to convert 
+00010a60: 726f 6f6d 2069 6e66 6f20 746f 2072 6f6f  room info to roo
+00010a70: 6d5f 6964 2e0a 0a20 2020 2041 7267 756d  m_id...    Argum
+00010a80: 656e 7473 3a0a 2020 2020 2d2d 2d2d 2d2d  ents:.    ------
+00010a90: 2d2d 2d0a 2020 2020 636c 6965 6e74 203a  ---.    client :
+00010aa0: 206e 696f 2063 6c69 656e 740a 2020 2020   nio client.    
+00010ab0: 696e 666f 203a 2073 7472 0a20 2020 2020  info : str.     
+00010ac0: 2020 2063 616e 2062 6520 6120 6361 6e6f     can be a cano
+00010ad0: 6e69 6361 6c20 616c 6961 7320 696e 2074  nical alias in t
+00010ae0: 6865 2066 6f72 6d20 6f66 2027 2373 6f6d  he form of '#som
+00010af0: 6552 6f6f 6d41 6c69 6173 3a65 7861 6d70  eRoomAlias:examp
+00010b00: 6c65 2e63 6f6d 270a 2020 2020 2020 2020  le.com'.        
+00010b10: 6361 6e20 6265 2061 2063 616e 6f6e 6963  can be a canonic
+00010b20: 616c 2072 6f6f 6d5f 6964 2069 6e20 7468  al room_id in th
+00010b30: 6520 666f 726d 206f 6620 2721 736f 6d65  e form of '!some
+00010b40: 526f 6f6d 4964 3a65 7861 6d70 6c65 2e63  RoomId:example.c
+00010b50: 6f6d 270a 2020 2020 2020 2020 6361 6e20  om'.        can 
+00010b60: 6265 2061 2073 686f 7274 2061 6c69 6173  be a short alias
+00010b70: 2069 6e20 7468 6520 666f 726d 206f 6620   in the form of 
+00010b80: 2773 6f6d 6552 6f6f 6d41 6c69 6173 270a  'someRoomAlias'.
+00010b90: 2020 2020 2020 2020 6361 6e20 6265 2061          can be a
+00010ba0: 2073 686f 7274 2061 6c69 6173 2069 6e20   short alias in 
+00010bb0: 7468 6520 666f 726d 206f 6620 2723 736f  the form of '#so
+00010bc0: 6d65 526f 6f6d 416c 6961 7327 0a20 2020  meRoomAlias'.   
+00010bd0: 2020 2020 2063 616e 2062 6520 6120 7368       can be a sh
+00010be0: 6f72 7420 726f 6f6d 2069 6420 696e 2074  ort room id in t
+00010bf0: 6865 2066 6f72 6d20 6f66 2027 2173 6f6d  he form of '!som
+00010c00: 6552 6f6f 6d49 6427 0a0a 2020 2020 5265  eRoomId'..    Re
+00010c10: 7475 726e 2063 6f72 7265 7370 6f6e 6469  turn correspondi
+00010c20: 6e67 2066 756c 6c20 726f 6f6d 5f69 6420  ng full room_id 
+00010c30: 2821 6964 3a73 616d 706c 652e 636f 6d29  (!id:sample.com)
+00010c40: 206f 7220 6f72 2072 6169 7365 7320 6578   or or raises ex
+00010c50: 6365 7074 696f 6e2e 0a0a 2020 2020 2222  ception...    ""
+00010c60: 220a 2020 2020 7269 203d 2069 6e66 6f2e  ".    ri = info.
+00010c70: 7374 7269 7028 290a 2020 2020 7269 203d  strip().    ri =
+00010c80: 2072 692e 7265 706c 6163 6528 7222 5c21   ri.replace(r"\!
+00010c90: 222c 2022 2122 2920 2023 2072 656d 6f76  ", "!")  # remov
+00010ca0: 6520 706f 7373 6962 6c65 2065 7363 6170  e possible escap
+00010cb0: 650a 2020 2020 6966 2028 0a20 2020 2020  e.    if (.     
+00010cc0: 2020 2072 6920 696e 2028 4e6f 6e65 2c20     ri in (None, 
+00010cd0: 2222 2c20 2221 222c 2022 2322 290a 2020  "", "!", "#").  
+00010ce0: 2020 2020 2020 6f72 2072 692e 7374 6172        or ri.star
+00010cf0: 7473 7769 7468 2822 3a22 290a 2020 2020  tswith(":").    
+00010d00: 2020 2020 6f72 2072 692e 636f 756e 7428      or ri.count(
+00010d10: 223a 2229 203e 2031 0a20 2020 2020 2020  ":") > 1.       
+00010d20: 206f 7220 7269 2e73 7461 7274 7377 6974   or ri.startswit
+00010d30: 6828 2240 2229 0a20 2020 2020 2020 206f  h("@").        o
+00010d40: 7220 2223 2220 696e 2072 695b 313a 5d0a  r "#" in ri[1:].
+00010d50: 2020 2020 2020 2020 6f72 2061 6e79 2865          or any(e
+00010d60: 6c65 6d20 696e 2072 6920 666f 7220 656c  lem in ri for el
+00010d70: 656d 2069 6e20 225b 5d7b 7d20 2229 2020  em in "[]{} ")  
+00010d80: 2320 646f 6573 2069 7420 636f 6e74 6169  # does it contai
+00010d90: 6e20 6261 6420 6368 6172 733f 0a20 2020  n bad chars?.   
+00010da0: 2020 2020 206f 7220 280a 2020 2020 2020       or (.      
+00010db0: 2020 2020 2020 6e6f 7420 7269 2e73 7461        not ri.sta
+00010dc0: 7274 7377 6974 6828 2221 2229 2061 6e64  rtswith("!") and
+00010dd0: 206e 6f74 2072 692e 7374 6172 7473 7769   not ri.startswi
+00010de0: 7468 2822 2322 2920 616e 6420 223a 2220  th("#") and ":" 
+00010df0: 696e 2072 690a 2020 2020 2020 2020 2920  in ri.        ) 
+00010e00: 2023 2061 6c69 6173 3a73 616d 706c 652e   # alias:sample.
+00010e10: 636f 6d0a 2020 2020 293a 0a20 2020 2020  com.    ):.     
+00010e20: 2020 2065 7272 203d 2028 0a20 2020 2020     err = (.     
+00010e30: 2020 2020 2020 2022 4531 3231 3a20 220a         "E121: ".
+00010e40: 2020 2020 2020 2020 2020 2020 6622 496e              f"In
+00010e50: 7661 6c69 6420 726f 6f6d 2073 7065 6369  valid room speci
+00010e60: 6669 6361 7469 6f6e 2e20 277b 696e 666f  fication. '{info
+00010e70: 7d27 2028 7b72 697d 2920 6973 206e 6569  }' ({ri}) is nei
+00010e80: 7468 6572 2022 0a20 2020 2020 2020 2020  ther ".         
+00010e90: 2020 2022 6120 7661 6c69 6420 726f 6f6d     "a valid room
+00010ea0: 2069 6420 6e6f 7220 6120 7661 6c69 6420   id nor a valid 
+00010eb0: 726f 6f6d 2061 6c69 6173 2e22 0a20 2020  room alias.".   
+00010ec0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00010ed0: 6169 7365 204d 6174 7269 7843 6f6d 6d61  aise MatrixComma
+00010ee0: 6e64 6572 4572 726f 7228 6572 7229 2066  nderError(err) f
+00010ef0: 726f 6d20 4e6f 6e65 0a20 2020 2069 6620  rom None.    if 
+00010f00: 6e6f 7420 7269 2e73 7461 7274 7377 6974  not ri.startswit
+00010f10: 6828 2221 2229 3a0a 2020 2020 2020 2020  h("!"):.        
+00010f20: 2320 2773 6f6d 6552 6f6f 6d41 6c69 6173  # 'someRoomAlias
+00010f30: 2720 6f72 2027 2373 6f6d 6552 6f6f 6d41  ' or '#someRoomA
+00010f40: 6c69 6173 2720 6f72 2027 2373 6f6d 6552  lias' or '#someR
+00010f50: 6f6f 6d41 6c69 6173 3a73 616d 706c 652e  oomAlias:sample.
+00010f60: 636f 6d27 0a20 2020 2020 2020 2069 6620  com'.        if 
+00010f70: 223a 2220 6e6f 7420 696e 2072 693a 2020  ":" not in ri:  
+00010f80: 2320 2773 6f6d 6552 6f6f 6d41 6c69 6173  # 'someRoomAlias
+00010f90: 2720 6f72 2027 2373 6f6d 6552 6f6f 6d41  ' or '#someRoomA
+00010fa0: 6c69 6173 270a 2020 2020 2020 2020 2020  lias'.          
+00010fb0: 2020 7269 203d 2073 686f 7274 5f72 6f6f    ri = short_roo
+00010fc0: 6d5f 616c 6961 735f 746f 5f72 6f6f 6d5f  m_alias_to_room_
+00010fd0: 616c 6961 7328 7269 2c20 6773 2e63 7265  alias(ri, gs.cre
+00010fe0: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
+00010ff0: 2020 7269 203d 2061 7761 6974 206d 6170    ri = await map
+00011000: 5f72 6f6f 6d61 6c69 6173 5f74 6f5f 726f  _roomalias_to_ro
+00011010: 6f6d 6964 2863 6c69 656e 742c 2072 6929  omid(client, ri)
+00011020: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00011030: 7269 0a20 2020 2069 6620 223a 2220 6e6f  ri.    if ":" no
+00011040: 7420 696e 2072 693a 0a20 2020 2020 2020  t in ri:.       
+00011050: 2023 2027 2173 6f6d 6552 6f6f 6d49 6427   # '!someRoomId'
+00011060: 0a20 2020 2020 2020 2072 6920 3d20 7269  .        ri = ri
+00011070: 202b 2022 3a22 202b 2064 6566 6175 6c74   + ":" + default
+00011080: 5f68 6f6d 6573 6572 7665 7228 6773 2e63  _homeserver(gs.c
+00011090: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+000110a0: 7265 7475 726e 2072 690a 0a0a 6173 796e  return ri...asyn
+000110b0: 6320 6465 6620 6d61 705f 726f 6f6d 616c  c def map_roomal
+000110c0: 6961 735f 746f 5f72 6f6f 6d69 6428 636c  ias_to_roomid(cl
+000110d0: 6965 6e74 2c20 616c 6961 7329 202d 3e20  ient, alias) -> 
+000110e0: 7374 723a 0a20 2020 2022 2222 4174 7465  str:.    """Atte
+000110f0: 6d70 7420 746f 2063 6f6e 7665 7274 2072  mpt to convert r
+00011100: 6f6f 6d20 616c 6961 7320 746f 2072 6f6f  oom alias to roo
+00011110: 6d5f 6964 2e0a 0a20 2020 2041 7267 756d  m_id...    Argum
+00011120: 656e 7473 3a0a 2020 2020 2d2d 2d2d 2d2d  ents:.    ------
+00011130: 2d2d 2d0a 2020 2020 636c 6965 6e74 203a  ---.    client :
+00011140: 206e 696f 2063 6c69 656e 740a 2020 2020   nio client.    
+00011150: 616c 6961 7320 3a20 6361 6e20 6265 2061  alias : can be a
+00011160: 6e20 616c 6961 7320 696e 2074 6865 2066  n alias in the f
+00011170: 6f72 6d20 6f66 2027 2373 6f6d 6552 6f6f  orm of '#someRoo
+00011180: 6d41 6c69 6173 3a65 7861 6d70 6c65 2e63  mAlias:example.c
+00011190: 6f6d 270a 2020 2020 2020 2020 6361 6e20  om'.        can 
+000111a0: 616c 736f 2062 6520 6120 726f 6f6d 5f69  also be a room_i
+000111b0: 6420 696e 2074 6865 2066 6f72 6d20 6f66  d in the form of
+000111c0: 2027 2173 6f6d 6552 6f6f 6d49 643a 6578   '!someRoomId:ex
+000111d0: 616d 706c 652e 636f 6d27 0a0a 2020 2020  ample.com'..    
+000111e0: 726f 6f6d 5f69 6420 3a20 726f 6f6d 2066  room_id : room f
+000111f0: 726f 6d20 6372 6564 656e 7469 616c 7320  rom credentials 
+00011200: 6669 6c65 0a0a 2020 2020 4966 2061 6e20  file..    If an 
+00011210: 616c 6961 7320 7472 7920 746f 2067 6574  alias try to get
+00011220: 2074 6865 2063 6f72 7265 7370 6f6e 6469   the correspondi
+00011230: 6e67 2072 6f6f 6d5f 6964 2e0a 2020 2020  ng room_id..    
+00011240: 4966 2061 6e79 7468 696e 6720 6661 696c  If anything fail
+00011250: 7320 6974 2072 6574 7572 6e73 2074 6865  s it returns the
+00011260: 206f 7269 6769 6e61 6c20 696e 7075 742e   original input.
+00011270: 0a0a 2020 2020 5265 7475 726e 2063 6f72  ..    Return cor
+00011280: 7265 7370 6f6e 6469 6e67 2072 6f6f 6d5f  responding room_
+00011290: 6964 206f 7220 6f6e 2066 6169 6c75 7265  id or on failure
+000112a0: 2074 6865 206f 7269 6769 6e61 6c20 616c   the original al
+000112b0: 6961 732e 0a0a 2020 2020 2222 220a 2020  ias...    """.  
+000112c0: 2020 7265 7420 3d20 616c 6961 730a 2020    ret = alias.  
+000112d0: 2020 6966 2069 735f 726f 6f6d 5f61 6c69    if is_room_ali
+000112e0: 6173 2861 6c69 6173 293a 0a20 2020 2020  as(alias):.     
+000112f0: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+00011300: 636c 6965 6e74 2e72 6f6f 6d5f 7265 736f  client.room_reso
+00011310: 6c76 655f 616c 6961 7328 616c 6961 7329  lve_alias(alias)
+00011320: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00011330: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
+00011340: 6d52 6573 6f6c 7665 416c 6961 7345 7272  mResolveAliasErr
+00011350: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00011360: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00011370: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00011380: 4531 3232 3a20 220a 2020 2020 2020 2020  E122: ".        
+00011390: 2020 2020 2020 2020 6622 726f 6f6d 5f72          f"room_r
+000113a0: 6573 6f6c 7665 5f61 6c69 6173 2066 6f72  esolve_alias for
+000113b0: 2061 6c69 6173 207b 616c 6961 737d 2066   alias {alias} f
+000113c0: 6169 6c65 6420 7769 7468 2022 0a20 2020  ailed with ".   
+000113d0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+000113e0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+000113f0: 7472 2872 6573 7029 297d 2e20 220a 2020  tr(resp))}. ".  
+00011400: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00011410: 5472 7969 6e67 206f 7065 7261 7469 6f6e  Trying operation
+00011420: 2077 6974 6820 696e 7075 7420 7b61 6c69   with input {ali
+00011430: 6173 7d20 616e 7977 6179 2e20 4d69 6768  as} anyway. Migh
+00011440: 7420 6661 696c 2e22 0a20 2020 2020 2020  t fail.".       
+00011450: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00011460: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00011470: 2b3d 2031 0a20 2020 2020 2020 2065 6c73  += 1.        els
+00011480: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00011490: 6574 203d 2072 6573 702e 726f 6f6d 5f69  et = resp.room_i
+000114a0: 640a 2020 2020 2020 2020 2020 2020 6773  d.            gs
+000114b0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+000114c0: 2020 2020 2020 2020 2020 2020 6627 4d61              f'Ma
+000114d0: 7070 6564 2072 6f6f 6d20 616c 6961 7320  pped room alias 
+000114e0: 227b 616c 6961 737d 2220 746f 2072 6f6f  "{alias}" to roo
+000114f0: 6d20 6964 2022 7b72 6574 7d22 2e20 270a  m id "{ret}". '.
+00011500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011510: 6622 287b 7265 7370 2e72 6f6f 6d5f 616c  f"({resp.room_al
+00011520: 6961 737d 2c20 7b72 6573 702e 726f 6f6d  ias}, {resp.room
+00011530: 5f69 647d 292e 220a 2020 2020 2020 2020  _id}).".        
+00011540: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
+00011550: 2072 6574 0a0a 0a64 6566 2064 6566 6175   ret...def defau
+00011560: 6c74 5f68 6f6d 6573 6572 7665 7228 6372  lt_homeserver(cr
+00011570: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
+00011580: 3a0a 2020 2020 2222 2247 6574 2074 6865  :.    """Get the
+00011590: 2064 6566 6175 6c74 2068 6f6d 6573 6572   default homeser
+000115a0: 7665 7220 2864 6f6d 6169 6e29 2066 726f  ver (domain) fro
+000115b0: 6d20 7468 6520 6372 6564 656e 7469 616c  m the credential
+000115c0: 7320 6669 6c65 2e0a 2020 2020 5573 6520  s file..    Use 
+000115d0: 7468 6520 7573 6572 5f69 642c 206e 6f74  the user_id, not
+000115e0: 2074 6865 2072 6f6f 6d5f 6964 2e20 5468   the room_id. Th
+000115f0: 6520 726f 6f6d 5f69 6420 636f 756c 6420  e room_id could 
+00011600: 6265 206f 6e20 610a 2020 2020 6469 6666  be on a.    diff
+00011610: 6572 656e 7420 7365 7276 6572 206f 776e  erent server own
+00011620: 6564 2062 7920 736f 6d65 6f6e 6520 656c  ed by someone el
+00011630: 7365 2e20 7573 6572 5f69 6420 6d61 6b65  se. user_id make
+00011640: 7320 6d6f 7265 2073 656e 7365 2e0a 2020  s more sense..  
+00011650: 2020 2222 220a 2020 2020 7573 6572 203d    """.    user =
+00011660: 2063 7265 6465 6e74 6961 6c73 5b22 7573   credentials["us
+00011670: 6572 5f69 6422 5d20 2023 2077 686f 2061  er_id"]  # who a
+00011680: 6d20 690a 2020 2020 686f 6d65 7365 7276  m i.    homeserv
+00011690: 6572 203d 2075 7365 722e 7061 7274 6974  er = user.partit
+000116a0: 696f 6e28 223a 2229 5b32 5d0a 2020 2020  ion(":")[2].    
+000116b0: 7265 7475 726e 2068 6f6d 6573 6572 7665  return homeserve
+000116c0: 7220 2023 206d 6174 7269 782e 6578 616d  r  # matrix.exam
+000116d0: 706c 652e 636f 6d0a 0a0a 6465 6620 7368  ple.com...def sh
+000116e0: 6f72 745f 726f 6f6d 5f61 6c69 6173 5f74  ort_room_alias_t
+000116f0: 6f5f 726f 6f6d 5f61 6c69 6173 2873 686f  o_room_alias(sho
+00011700: 7274 5f72 6f6f 6d5f 616c 6961 733a 2073  rt_room_alias: s
+00011710: 7472 2c20 6372 6564 656e 7469 616c 733a  tr, credentials:
+00011720: 2064 6963 7429 3a0a 2020 2020 2222 2243   dict):.    """C
+00011730: 6f6e 7665 7274 2027 536f 6d65 526f 6f6d  onvert 'SomeRoom
+00011740: 416c 6961 7327 2074 6f20 2727 2353 6f6d  Alias' to ''#Som
+00011750: 6554 6f6f 6d41 6c69 6173 3a6d 6174 7269  eToomAlias:matri
+00011760: 782e 6578 616d 706c 652e 636f 6d27 2e0a  x.example.com'..
+00011770: 2020 2020 436f 6e76 6572 7473 2073 686f      Converts sho
+00011780: 7274 2063 616e 6f6e 6963 616c 206c 6f63  rt canonical loc
+00011790: 616c 2072 6f6f 6d20 616c 6961 7320 746f  al room alias to
+000117a0: 2066 756c 6c20 726f 6f6d 2061 6c69 6173   full room alias
+000117b0: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+000117c0: 2073 686f 7274 5f72 6f6f 6d5f 616c 6961   short_room_alia
+000117d0: 7320 696e 2028 4e6f 6e65 2c20 2222 293a  s in (None, ""):
+000117e0: 0a20 2020 2020 2020 2065 7272 203d 2022  .        err = "
+000117f0: 4531 3234 3a20 2220 2249 6e76 616c 6964  E124: " "Invalid
+00011800: 2072 6f6f 6d20 616c 6961 732e 2041 6c69   room alias. Ali
+00011810: 6173 2069 7320 6e6f 6e65 206f 7220 656d  as is none or em
+00011820: 7074 792e 220a 2020 2020 2020 2020 7261  pty.".        ra
+00011830: 6973 6520 4d61 7472 6978 436f 6d6d 616e  ise MatrixComman
+00011840: 6465 7245 7272 6f72 2865 7272 2920 6672  derError(err) fr
+00011850: 6f6d 204e 6f6e 650a 2020 2020 6966 2073  om None.    if s
+00011860: 686f 7274 5f72 6f6f 6d5f 616c 6961 735b  hort_room_alias[
+00011870: 305d 203d 3d20 2223 223a 0a20 2020 2020  0] == "#":.     
+00011880: 2020 2072 6574 203d 2073 686f 7274 5f72     ret = short_r
+00011890: 6f6f 6d5f 616c 6961 7320 2b20 223a 2220  oom_alias + ":" 
+000118a0: 2b20 6465 6661 756c 745f 686f 6d65 7365  + default_homese
+000118b0: 7276 6572 2863 7265 6465 6e74 6961 6c73  rver(credentials
+000118c0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+000118d0: 2020 2020 7265 7420 3d20 2223 2220 2b20      ret = "#" + 
+000118e0: 7368 6f72 745f 726f 6f6d 5f61 6c69 6173  short_room_alias
+000118f0: 202b 2022 3a22 202b 2064 6566 6175 6c74   + ":" + default
+00011900: 5f68 6f6d 6573 6572 7665 7228 6372 6564  _homeserver(cred
+00011910: 656e 7469 616c 7329 0a20 2020 2072 6574  entials).    ret
+00011920: 7572 6e20 7265 740a 0a0a 6465 6620 726f  urn ret...def ro
+00011930: 6f6d 5f61 6c69 6173 5f74 6f5f 7368 6f72  om_alias_to_shor
+00011940: 745f 726f 6f6d 5f61 6c69 6173 2872 6f6f  t_room_alias(roo
+00011950: 6d5f 616c 6961 733a 2073 7472 2c20 6372  m_alias: str, cr
+00011960: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
+00011970: 3a0a 2020 2020 2222 2243 6f6e 7665 7274  :.    """Convert
+00011980: 2027 2353 6f6d 6554 6f6f 6d41 6c69 6173   '#SomeToomAlias
+00011990: 3a6d 6174 7269 782e 6578 616d 706c 652e  :matrix.example.
+000119a0: 636f 6d27 2074 6f20 2753 6f6d 6552 6f6f  com' to 'SomeRoo
+000119b0: 6d41 6c69 6173 272e 0a20 2020 2043 6f6e  mAlias'..    Con
+000119c0: 7665 7274 7320 6675 6c6c 2072 6f6f 6d20  verts full room 
+000119d0: 616c 6961 7320 746f 2073 686f 7274 2063  alias to short c
+000119e0: 616e 6f6e 6963 616c 206c 6f63 616c 2072  anonical local r
+000119f0: 6f6f 6d20 616c 6961 732e 0a20 2020 2022  oom alias..    "
+00011a00: 2222 0a20 2020 2072 6574 7572 6e20 726f  "".    return ro
+00011a10: 6f6d 5f61 6c69 6173 2e73 706c 6974 2822  om_alias.split("
+00011a20: 3a22 295b 305d 5b31 3a5d 0a0a 0a64 6566  :")[0][1:]...def
+00011a30: 2075 7365 725f 6964 5f74 6f5f 7368 6f72   user_id_to_shor
+00011a40: 745f 7573 6572 5f6e 616d 6528 7573 6572  t_user_name(user
+00011a50: 5f69 643a 2073 7472 293a 0a20 2020 2022  _id: str):.    "
+00011a60: 2222 436f 6e76 6572 7420 2740 736f 6d65  ""Convert '@some
+00011a70: 7573 6572 3a6d 6174 7269 782e 6578 616d  user:matrix.exam
+00011a80: 706c 652e 636f 6d27 2074 6f20 2773 6f6d  ple.com' to 'som
+00011a90: 6575 7365 7227 2e0a 2020 2020 436f 6e76  euser'..    Conv
+00011aa0: 6572 7420 6675 6c6c 2075 7365 725f 6964  ert full user_id
+00011ab0: 2074 6f20 7573 6572 206e 6963 6b20 6e61   to user nick na
+00011ac0: 6d65 2e0a 2020 2020 2222 220a 2020 2020  me..    """.    
+00011ad0: 7265 7475 726e 2075 7365 725f 6964 2e73  return user_id.s
+00011ae0: 706c 6974 2822 3a22 295b 305d 5b31 3a5d  plit(":")[0][1:]
+00011af0: 0a0a 0a64 6566 2073 686f 7274 5f75 7365  ...def short_use
+00011b00: 725f 6e61 6d65 5f74 6f5f 7573 6572 5f69  r_name_to_user_i
+00011b10: 6428 7368 6f72 745f 7573 6572 3a20 7374  d(short_user: st
+00011b20: 722c 2063 7265 6465 6e74 6961 6c73 3a20  r, credentials: 
+00011b30: 6469 6374 293a 0a20 2020 2022 2222 436f  dict):.    """Co
+00011b40: 6e76 6572 7420 2773 6f6d 6575 7365 7227  nvert 'someuser'
+00011b50: 2074 6f20 2740 736f 6d65 7573 6572 3a6d   to '@someuser:m
+00011b60: 6174 7269 782e 6578 616d 706c 652e 636f  atrix.example.co
+00011b70: 6d27 2e0a 2020 2020 436f 6e76 6572 7420  m'..    Convert 
+00011b80: 7573 6572 206e 6963 6b20 6e61 6d65 2074  user nick name t
+00011b90: 6f20 6675 6c6c 2075 7365 725f 6964 2e0a  o full user_id..
+00011ba0: 2020 2020 2222 220a 2020 2020 7265 7475      """.    retu
+00011bb0: 726e 2022 4022 202b 2073 686f 7274 5f75  rn "@" + short_u
+00011bc0: 7365 7220 2b20 223a 2220 2b20 6465 6661  ser + ":" + defa
+00011bd0: 756c 745f 686f 6d65 7365 7276 6572 2863  ult_homeserver(c
+00011be0: 7265 6465 6e74 6961 6c73 290a 0a0a 6465  redentials)...de
+00011bf0: 6620 6973 5f72 6f6f 6d5f 616c 6961 7328  f is_room_alias(
+00011c00: 726f 6f6d 5f69 643a 2073 7472 2920 2d3e  room_id: str) ->
+00011c10: 2062 6f6f 6c3a 0a20 2020 2022 2222 4465   bool:.    """De
+00011c20: 7465 726d 696e 6520 6966 2072 6f6f 6d20  termine if room 
+00011c30: 6964 656e 7469 6669 6572 2069 7320 6120  identifier is a 
+00011c40: 726f 6f6d 2061 6c69 6173 2e0a 0a20 2020  room alias...   
+00011c50: 2052 6f6f 6d20 616c 6961 7365 7320 6172   Room aliases ar
+00011c60: 6520 6f66 2073 796e 7461 783a 2023 736f  e of syntax: #so
+00011c70: 6d65 616c 6961 733a 736f 6d65 7365 7276  mealias:someserv
+00011c80: 6572 0a20 2020 2054 6869 7320 6973 206e  er.    This is n
+00011c90: 6f74 2061 6e20 6578 6861 7573 7469 7665  ot an exhaustive
+00011ca0: 2063 6865 636b 210a 0a20 2020 2022 2222   check!..    """
+00011cb0: 0a20 2020 2069 6620 280a 2020 2020 2020  .    if (.      
+00011cc0: 2020 726f 6f6d 5f69 640a 2020 2020 2020    room_id.      
+00011cd0: 2020 616e 6420 6c65 6e28 726f 6f6d 5f69    and len(room_i
+00011ce0: 6429 203e 2033 0a20 2020 2020 2020 2061  d) > 3.        a
+00011cf0: 6e64 2028 726f 6f6d 5f69 645b 305d 203d  nd (room_id[0] =
+00011d00: 3d20 2223 2229 0a20 2020 2020 2020 2061  = "#").        a
+00011d10: 6e64 2028 2223 2220 6e6f 7420 696e 2072  nd ("#" not in r
+00011d20: 6f6f 6d5f 6964 5b31 3a5d 290a 2020 2020  oom_id[1:]).    
+00011d30: 2020 2020 616e 6420 2822 3a22 2069 6e20      and (":" in 
+00011d40: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
+00011d50: 2061 6e64 2072 6f6f 6d5f 6964 2e63 6f75   and room_id.cou
+00011d60: 6e74 2822 3a22 2920 3d3d 2031 0a20 2020  nt(":") == 1.   
+00011d70: 2020 2020 2061 6e64 2028 2220 2220 6e6f       and (" " no
+00011d80: 7420 696e 2072 6f6f 6d5f 6964 290a 2020  t in room_id).  
+00011d90: 2020 2020 2020 616e 6420 6e6f 7420 616e        and not an
+00011da0: 7928 656c 656d 2069 6e20 726f 6f6d 5f69  y(elem in room_i
+00011db0: 6420 666f 7220 656c 656d 2069 6e20 225b  d for elem in "[
+00011dc0: 5d7b 7d20 2229 2020 2320 636f 6e74 6169  ]{} ")  # contai
+00011dd0: 6e73 2062 6164 2063 6861 7273 3f0a 2020  ns bad chars?.  
+00011de0: 2020 293a 0a20 2020 2020 2020 2072 6574    ):.        ret
+00011df0: 7572 6e20 5472 7565 0a20 2020 2065 6c73  urn True.    els
+00011e00: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00011e10: 6e20 4661 6c73 650a 0a0a 6465 6620 6973  n False...def is
+00011e20: 5f72 6f6f 6d5f 6964 2872 6f6f 6d5f 6964  _room_id(room_id
+00011e30: 3a20 7374 7229 202d 3e20 626f 6f6c 3a0a  : str) -> bool:.
+00011e40: 2020 2020 2222 2244 6574 6572 6d69 6e65      """Determine
+00011e50: 2069 6620 726f 6f6d 2069 6465 6e74 6966   if room identif
+00011e60: 6965 7220 6973 2061 2076 616c 6964 2072  ier is a valid r
+00011e70: 6f6f 6d20 6964 2e0a 0a20 2020 2052 6f6f  oom id...    Roo
+00011e80: 6d20 6964 7320 6172 6520 6f66 2073 796e  m ids are of syn
+00011e90: 7461 783a 2021 736f 6d65 616c 6961 733a  tax: !somealias:
+00011ea0: 736f 6d65 7365 7276 6572 0a20 2020 2054  someserver.    T
+00011eb0: 6869 7320 6973 206e 6f74 2061 6e20 6578  his is not an ex
+00011ec0: 6861 7573 7469 7665 2063 6865 636b 210a  haustive check!.
+00011ed0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+00011ee0: 280a 2020 2020 2020 2020 726f 6f6d 5f69  (.        room_i
+00011ef0: 640a 2020 2020 2020 2020 616e 6420 6c65  d.        and le
+00011f00: 6e28 726f 6f6d 5f69 6429 203e 2033 0a20  n(room_id) > 3. 
+00011f10: 2020 2020 2020 2061 6e64 2028 726f 6f6d         and (room
+00011f20: 5f69 645b 305d 203d 3d20 2221 2229 0a20  _id[0] == "!"). 
+00011f30: 2020 2020 2020 2061 6e64 2028 2223 2220         and ("#" 
+00011f40: 6e6f 7420 696e 2072 6f6f 6d5f 6964 290a  not in room_id).
+00011f50: 2020 2020 2020 2020 616e 6420 2822 3a22          and (":"
+00011f60: 2069 6e20 726f 6f6d 5f69 6429 0a20 2020   in room_id).   
+00011f70: 2020 2020 2061 6e64 2072 6f6f 6d5f 6964       and room_id
+00011f80: 2e63 6f75 6e74 2822 3a22 2920 3d3d 2031  .count(":") == 1
+00011f90: 0a20 2020 2020 2020 2061 6e64 2028 2220  .        and (" 
+00011fa0: 2220 6e6f 7420 696e 2072 6f6f 6d5f 6964  " not in room_id
+00011fb0: 290a 2020 2020 293a 0a20 2020 2020 2020  ).    ):.       
+00011fc0: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
+00011fd0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+00011fe0: 6574 7572 6e20 4661 6c73 650a 0a0a 6465  eturn False...de
+00011ff0: 6620 6973 5f72 6f6f 6d28 726f 6f6d 5f69  f is_room(room_i
+00012000: 643a 2073 7472 2920 2d3e 2062 6f6f 6c3a  d: str) -> bool:
+00012010: 0a20 2020 2022 2222 4465 7465 726d 696e  .    """Determin
+00012020: 6520 6966 2072 6f6f 6d20 6964 2069 7320  e if room id is 
+00012030: 6120 7661 6c69 6420 726f 6f6d 2069 6420  a valid room id 
+00012040: 6f72 2061 2076 616c 6964 2072 6f6f 6d20  or a valid room 
+00012050: 616c 6961 732e 0a0a 2020 2020 5468 6973  alias...    This
+00012060: 2069 7320 6e6f 7420 616e 2065 7868 6175   is not an exhau
+00012070: 7374 6976 6520 6368 6563 6b21 0a0a 2020  stive check!..  
+00012080: 2020 2222 220a 2020 2020 7265 7475 726e    """.    return
+00012090: 2069 735f 726f 6f6d 5f69 6428 726f 6f6d   is_room_id(room
+000120a0: 5f69 6429 206f 7220 6973 5f72 6f6f 6d5f  _id) or is_room_
+000120b0: 616c 6961 7328 726f 6f6d 5f69 6429 0a0a  alias(room_id)..
+000120c0: 0a64 6566 2069 735f 7368 6f72 745f 726f  .def is_short_ro
+000120d0: 6f6d 5f61 6c69 6173 2872 6f6f 6d5f 6964  om_alias(room_id
+000120e0: 3a20 7374 7229 202d 3e20 626f 6f6c 3a0a  : str) -> bool:.
+000120f0: 2020 2020 2222 2244 6574 6572 6d69 6e65      """Determine
+00012100: 2069 6620 726f 6f6d 2069 6465 6e74 6966   if room identif
+00012110: 6965 7220 6973 2061 206c 6f63 616c 2070  ier is a local p
+00012120: 6172 7420 6f66 2063 616e 6f6e 6963 616c  art of canonical
+00012130: 2072 6f6f 6d20 616c 6961 732e 0a0a 2020   room alias...  
+00012140: 2020 4c6f 6361 6c20 7061 7274 7320 6f66    Local parts of
+00012150: 2063 616e 6f6e 6963 616c 2072 6f6f 6d20   canonical room 
+00012160: 616c 6961 7365 7320 6172 6520 6f66 2073  aliases are of s
+00012170: 796e 7461 783a 2073 6f6d 6561 6c69 6173  yntax: somealias
+00012180: 0a0a 2020 2020 4e6f 7720 616c 736f 2061  ..    Now also a
+00012190: 6c6c 6f77 696e 6720 2373 6f6d 6561 6c69  llowing #someali
+000121a0: 6173 0a0a 2020 2020 2222 220a 2020 2020  as..    """.    
+000121b0: 6966 2028 0a20 2020 2020 2020 2072 6f6f  if (.        roo
+000121c0: 6d5f 6964 0a20 2020 2020 2020 2061 6e64  m_id.        and
+000121d0: 206c 656e 2872 6f6f 6d5f 6964 2920 3e20   len(room_id) > 
+000121e0: 300a 2020 2020 2020 2020 616e 6420 726f  0.        and ro
+000121f0: 6f6d 5f69 6420 213d 2022 2322 0a20 2020  om_id != "#".   
+00012200: 2020 2020 2061 6e64 2028 223a 2220 6e6f       and (":" no
+00012210: 7420 696e 2072 6f6f 6d5f 6964 290a 2020  t in room_id).  
+00012220: 2020 2020 2020 616e 6420 2822 2322 206e        and ("#" n
+00012230: 6f74 2069 6e20 726f 6f6d 5f69 645b 313a  ot in room_id[1:
+00012240: 5d29 0a20 2020 2020 2020 2061 6e64 2028  ]).        and (
+00012250: 6e6f 7420 726f 6f6d 5f69 642e 7374 6172  not room_id.star
+00012260: 7473 7769 7468 2822 2122 2929 0a20 2020  tswith("!")).   
+00012270: 2020 2020 2061 6e64 2028 6e6f 7420 726f       and (not ro
+00012280: 6f6d 5f69 642e 7374 6172 7473 7769 7468  om_id.startswith
+00012290: 2822 4022 2929 0a20 2020 2020 2020 2061  ("@")).        a
+000122a0: 6e64 2028 2220 2220 6e6f 7420 696e 2072  nd (" " not in r
+000122b0: 6f6f 6d5f 6964 290a 2020 2020 293a 0a20  oom_id).    ):. 
+000122c0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+000122d0: 7565 0a20 2020 2065 6c73 653a 0a20 2020  ue.    else:.   
+000122e0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+000122f0: 650a 0a0a 6465 6620 6973 5f75 7365 725f  e...def is_user_
+00012300: 6964 2875 7365 725f 6964 3a20 7374 7229  id(user_id: str)
+00012310: 202d 3e20 626f 6f6c 3a0a 2020 2020 2222   -> bool:.    ""
+00012320: 2244 6574 6572 6d69 6e65 2069 6620 7573  "Determine if us
+00012330: 6572 2069 6465 6e74 6966 6965 7220 6973  er identifier is
+00012340: 2061 2076 616c 6964 2075 7365 7220 6964   a valid user id
+00012350: 2e0a 0a20 2020 2055 7365 7220 6964 7320  ...    User ids 
+00012360: 6172 6520 6f66 2073 796e 7461 783a 2040  are of syntax: @
+00012370: 736f 6d65 7573 6572 3a73 6f6d 6573 6572  someuser:someser
+00012380: 7665 720a 2020 2020 5468 6973 2069 7320  ver.    This is 
+00012390: 6e6f 7420 616e 2065 7868 6175 7374 6976  not an exhaustiv
+000123a0: 6520 6368 6563 6b21 0a0a 2020 2020 2222  e check!..    ""
+000123b0: 220a 2020 2020 6966 2028 0a20 2020 2020  ".    if (.     
+000123c0: 2020 2075 7365 725f 6964 0a20 2020 2020     user_id.     
+000123d0: 2020 2061 6e64 206c 656e 2875 7365 725f     and len(user_
+000123e0: 6964 2920 3e20 330a 2020 2020 2020 2020  id) > 3.        
+000123f0: 616e 6420 2875 7365 725f 6964 5b30 5d20  and (user_id[0] 
+00012400: 3d3d 2022 4022 290a 2020 2020 2020 2020  == "@").        
+00012410: 616e 6420 2822 3a22 2069 6e20 7573 6572  and (":" in user
+00012420: 5f69 6429 0a20 2020 2020 2020 2061 6e64  _id).        and
+00012430: 2028 2220 2220 6e6f 7420 696e 2075 7365   (" " not in use
+00012440: 725f 6964 290a 2020 2020 293a 0a20 2020  r_id).    ):.   
+00012450: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00012460: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00012470: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00012480: 0a0a 6465 6620 6973 5f73 686f 7274 5f75  ..def is_short_u
+00012490: 7365 725f 6964 2875 7365 725f 6964 3a20  ser_id(user_id: 
+000124a0: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
+000124b0: 2020 2222 2244 6574 6572 6d69 6e65 2069    """Determine i
+000124c0: 6620 7573 6572 2069 6465 6e74 6966 6965  f user identifie
+000124d0: 7220 6973 2061 2076 616c 6964 2073 686f  r is a valid sho
+000124e0: 7274 2075 7365 7220 6964 2e0a 0a20 2020  rt user id...   
+000124f0: 2053 686f 7274 2075 7365 7220 6964 7320   Short user ids 
+00012500: 6172 6520 6f66 2073 796e 7461 783a 2073  are of syntax: s
+00012510: 6f6d 6575 7365 720a 2020 2020 5468 6973  omeuser.    This
+00012520: 2069 7320 6e6f 7420 616e 2065 7868 6175   is not an exhau
+00012530: 7374 6976 6520 6368 6563 6b21 0a0a 2020  stive check!..  
+00012540: 2020 2222 220a 2020 2020 6966 2028 0a20    """.    if (. 
+00012550: 2020 2020 2020 2075 7365 725f 6964 0a20         user_id. 
+00012560: 2020 2020 2020 2061 6e64 206c 656e 2875         and len(u
+00012570: 7365 725f 6964 2920 3e20 300a 2020 2020  ser_id) > 0.    
+00012580: 2020 2020 616e 6420 2822 3a22 206e 6f74      and (":" not
+00012590: 2069 6e20 7573 6572 5f69 6429 0a20 2020   in user_id).   
+000125a0: 2020 2020 2061 6e64 2028 2240 2220 6e6f       and ("@" no
+000125b0: 7420 696e 2075 7365 725f 6964 290a 2020  t in user_id).  
+000125c0: 2020 2020 2020 616e 6420 2822 2022 206e        and (" " n
+000125d0: 6f74 2069 6e20 7573 6572 5f69 6429 0a20  ot in user_id). 
+000125e0: 2020 2029 3a0a 2020 2020 2020 2020 7265     ):.        re
+000125f0: 7475 726e 2054 7275 650a 2020 2020 656c  turn True.    el
+00012600: 7365 3a0a 2020 2020 2020 2020 7265 7475  se:.        retu
+00012610: 726e 2046 616c 7365 0a0a 0a64 6566 2069  rn False...def i
+00012620: 735f 7061 7274 6961 6c5f 7573 6572 5f69  s_partial_user_i
+00012630: 6428 7573 6572 5f69 643a 2073 7472 2920  d(user_id: str) 
+00012640: 2d3e 2062 6f6f 6c3a 0a20 2020 2022 2222  -> bool:.    """
+00012650: 4465 7465 726d 696e 6520 6966 2075 7365  Determine if use
+00012660: 7220 6964 656e 7469 6669 6572 2069 7320  r identifier is 
+00012670: 6120 7661 6c69 6420 6162 6272 6576 6961  a valid abbrevia
+00012680: 7465 6420 7573 6572 2069 642e 0a0a 2020  ted user id...  
+00012690: 2020 4162 6272 6576 2e20 7573 6572 2069    Abbrev. user i
+000126a0: 6473 2061 7265 206f 6620 7379 6e74 6178  ds are of syntax
+000126b0: 3a20 4073 6f6d 6575 7365 720a 2020 2020  : @someuser.    
+000126c0: 5468 6973 2069 7320 6e6f 7420 616e 2065  This is not an e
+000126d0: 7868 6175 7374 6976 6520 6368 6563 6b21  xhaustive check!
+000126e0: 0a0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+000126f0: 2028 0a20 2020 2020 2020 2075 7365 725f   (.        user_
+00012700: 6964 0a20 2020 2020 2020 2061 6e64 206c  id.        and l
+00012710: 656e 2875 7365 725f 6964 2920 3e20 310a  en(user_id) > 1.
+00012720: 2020 2020 2020 2020 616e 6420 2875 7365          and (use
+00012730: 725f 6964 5b30 5d20 3d3d 2022 4022 290a  r_id[0] == "@").
+00012740: 2020 2020 2020 2020 616e 6420 2822 3a22          and (":"
+00012750: 206e 6f74 2069 6e20 7573 6572 5f69 6429   not in user_id)
+00012760: 0a20 2020 2020 2020 2061 6e64 2028 2220  .        and (" 
+00012770: 2220 6e6f 7420 696e 2075 7365 725f 6964  " not in user_id
+00012780: 290a 2020 2020 293a 0a20 2020 2020 2020  ).    ):.       
+00012790: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
+000127a0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+000127b0: 6574 7572 6e20 4661 6c73 650a 0a0a 6465  eturn False...de
+000127c0: 6620 6973 5f75 7365 7228 7573 6572 5f69  f is_user(user_i
+000127d0: 643a 2073 7472 2920 2d3e 2062 6f6f 6c3a  d: str) -> bool:
+000127e0: 0a20 2020 2022 2222 4465 7465 726d 696e  .    """Determin
+000127f0: 6520 6966 2075 7365 7220 6964 2069 7320  e if user id is 
+00012800: 6120 7661 6c69 6420 7573 6572 2069 6420  a valid user id 
+00012810: 6f72 2061 2076 616c 6964 2073 686f 7274  or a valid short
+00012820: 2075 7365 7220 6964 2e0a 0a20 2020 2054   user id...    T
+00012830: 6869 7320 6973 206e 6f74 2061 6e20 6578  his is not an ex
+00012840: 6861 7573 7469 7665 2063 6865 636b 210a  haustive check!.
+00012850: 0a20 2020 2022 2222 0a20 2020 2072 6574  .    """.    ret
+00012860: 7572 6e20 280a 2020 2020 2020 2020 6973  urn (.        is
+00012870: 5f75 7365 725f 6964 2875 7365 725f 6964  _user_id(user_id
+00012880: 290a 2020 2020 2020 2020 6f72 2069 735f  ).        or is_
+00012890: 7061 7274 6961 6c5f 7573 6572 5f69 6428  partial_user_id(
+000128a0: 7573 6572 5f69 6429 0a20 2020 2020 2020  user_id).       
+000128b0: 206f 7220 6973 5f73 686f 7274 5f75 7365   or is_short_use
+000128c0: 725f 6964 2875 7365 725f 6964 290a 2020  r_id(user_id).  
+000128d0: 2020 290a 0a0a 6173 796e 6320 6465 6620    )...async def 
+000128e0: 6163 7469 6f6e 5f72 6f6f 6d5f 646d 5f63  action_room_dm_c
+000128f0: 7265 6174 6528 636c 6965 6e74 3a20 4173  reate(client: As
+00012900: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
+00012910: 6e74 6961 6c73 3a20 6469 6374 293a 0a20  ntials: dict):. 
+00012920: 2020 2022 2222 4372 6561 7465 2061 2064     """Create a d
+00012930: 6972 6563 7420 6d65 7373 6167 6520 2844  irect message (D
+00012940: 4d29 2072 6f6f 6d20 7768 696c 6520 616c  M) room while al
+00012950: 7265 6164 7920 6265 696e 6720 6c6f 6767  ready being logg
+00012960: 6564 2069 6e2e 0a0a 2020 2020 4166 7465  ed in...    Afte
+00012970: 7220 6372 6561 7469 6e67 2074 6865 2070  r creating the p
+00012980: 7269 7661 7465 2044 4d20 726f 6f6d 2069  rivate DM room i
+00012990: 7420 696e 7669 7465 7320 7468 6520 6f74  t invites the ot
+000129a0: 6865 7220 7573 6572 2074 6f20 6974 2e0a  her user to it..
+000129b0: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
+000129c0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
+000129d0: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
+000129e0: 6c69 656e 743a 206e 696f 2063 6c69 656e  lient: nio clien
+000129f0: 742c 2061 6c6c 6f77 7320 6173 2074 6f20  t, allows as to 
+00012a00: 7175 6572 7920 7468 6520 7365 7276 6572  query the server
+00012a10: 0a20 2020 2063 7265 6465 6e74 6961 6c73  .    credentials
+00012a20: 3a20 6469 6374 3a20 616c 6c6f 7773 2074  : dict: allows t
+00012a30: 6f20 6765 7420 7468 6520 7573 6572 5f69  o get the user_i
+00012a40: 6420 6f66 2073 656e 6465 722c 2065 7463  d of sender, etc
+00012a50: 0a20 2020 2022 2222 0a20 2020 2023 2075  .    """.    # u
+00012a60: 7365 7273 203a 206c 6973 7420 6f66 2075  sers : list of u
+00012a70: 7365 7273 2074 6f20 6372 6561 7465 2044  sers to create D
+00012a80: 4d20 726f 6f6d 7320 7769 7468 0a20 2020  M rooms with.   
+00012a90: 2023 2072 6f6f 6d5f 616c 6961 7365 7320   # room_aliases 
+00012aa0: 3a20 6c69 7374 206f 6620 726f 6f6d 2061  : list of room a
+00012ab0: 6c69 6173 6573 2069 6e20 7468 6520 666f  liases in the fo
+00012ac0: 726d 206f 6620 2273 616d 706c 6541 6c69  rm of "sampleAli
+00012ad0: 6173 220a 2020 2020 2320 2020 2020 2020  as".    #       
+00012ae0: 2020 5468 6573 6520 616c 6961 7365 7320    These aliases 
+00012af0: 7769 6c6c 2074 6865 6e20 6265 2075 7365  will then be use
+00012b00: 6420 6279 2074 6865 2073 6572 7665 7220  d by the server 
+00012b10: 616e 640a 2020 2020 2320 2020 2020 2020  and.    #       
+00012b20: 2020 7468 6520 7365 7276 6572 2063 7265    the server cre
+00012b30: 6174 6573 2074 6865 2064 6566 696e 6974  ates the definit
+00012b40: 6520 616c 6961 7320 696e 2074 6865 2066  e alias in the f
+00012b50: 6f72 6d0a 2020 2020 2320 2020 2020 2020  orm.    #       
+00012b60: 2020 6f66 2022 2373 616d 706c 6541 6c69    of "#sampleAli
+00012b70: 6173 3a65 7861 6d70 6c65 2e63 6f6d 2220  as:example.com" 
+00012b80: 6672 6f6d 2069 742e 0a20 2020 2023 2020  from it..    #  
+00012b90: 2020 2020 2020 2057 6520 7065 726d 6974         We permit
+00012ba0: 2022 2373 616d 706c 6541 6c69 6173 3a65   "#sampleAlias:e
+00012bb0: 7861 6d70 6c65 2e63 6f6d 2220 616e 6420  xample.com" and 
+00012bc0: 646f 776e 7363 616c 6520 6974 2074 6f0a  downscale it to.
+00012bd0: 2020 2020 2320 2020 2020 2020 2020 2273      #         "s
+00012be0: 616d 706c 6541 6c69 6173 222e 0a20 2020  ampleAlias"..   
+00012bf0: 2023 206e 616d 6573 203a 206c 6973 7420   # names : list 
+00012c00: 6f66 206e 616d 6573 2066 6f72 2072 6f6f  of names for roo
+00012c10: 6d73 0a20 2020 2023 2074 6f70 6963 203a  ms.    # topic :
+00012c20: 2072 6f6f 6d20 746f 7069 6373 0a0a 2020   room topics..  
+00012c30: 2020 7573 6572 7320 3d20 6773 2e70 612e    users = gs.pa.
+00012c40: 726f 6f6d 5f64 6d5f 6372 6561 7465 0a20  room_dm_create. 
+00012c50: 2020 2072 6f6f 6d5f 616c 6961 7365 7320     room_aliases 
+00012c60: 3d20 6773 2e70 612e 616c 6961 730a 2020  = gs.pa.alias.  
+00012c70: 2020 6e61 6d65 7320 3d20 6773 2e70 612e    names = gs.pa.
+00012c80: 6e61 6d65 0a20 2020 2074 6f70 6963 7320  name.    topics 
+00012c90: 3d20 6773 2e70 612e 746f 7069 630a 2020  = gs.pa.topic.  
+00012ca0: 2020 7472 793a 0a20 2020 2020 2020 2069    try:.        i
+00012cb0: 6e64 6578 203d 2030 0a20 2020 2020 2020  ndex = 0.       
+00012cc0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+00012cd0: 2020 2020 2020 2020 2020 2066 2754 7279             f'Try
+00012ce0: 696e 6720 746f 2063 7265 6174 6520 444d  ing to create DM
+00012cf0: 2072 6f6f 6d73 2077 6974 6820 7573 6572   rooms with user
+00012d00: 7320 227b 7573 6572 737d 222c 2027 0a20  s "{users}", '. 
+00012d10: 2020 2020 2020 2020 2020 2066 2772 6f6f             f'roo
+00012d20: 6d20 616c 6961 7365 7320 227b 726f 6f6d  m aliases "{room
+00012d30: 5f61 6c69 6173 6573 7d22 2c20 270a 2020  _aliases}", '.  
+00012d40: 2020 2020 2020 2020 2020 6627 6e61 6d65            f'name
+00012d50: 7320 227b 6e61 6d65 737d 222c 2061 6e64  s "{names}", and
+00012d60: 2074 6f70 6963 7320 227b 746f 7069 6373   topics "{topics
+00012d70: 7d22 2e27 0a20 2020 2020 2020 2029 0a20  }".'.        ). 
+00012d80: 2020 2020 2020 2066 6f72 2075 7365 7220         for user 
+00012d90: 696e 2075 7365 7273 3a0a 2020 2020 2020  in users:.      
+00012da0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00012db0: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
+00012dc0: 203d 2072 6f6f 6d5f 616c 6961 7365 735b   = room_aliases[
+00012dd0: 696e 6465 785d 0a20 2020 2020 2020 2020  index].         
+00012de0: 2020 2020 2020 2061 6c69 6173 203d 2061         alias = a
+00012df0: 6c69 6173 2e72 6570 6c61 6365 2872 225c  lias.replace(r"\
+00012e00: 2122 2c20 2221 2229 2020 2320 7265 6d6f  !", "!")  # remo
+00012e10: 7665 2070 6f73 7369 626c 6520 6573 6361  ve possible esca
+00012e20: 7065 0a20 2020 2020 2020 2020 2020 2020  pe.             
+00012e30: 2020 2023 2061 6c69 6173 2069 7320 6120     # alias is a 
+00012e40: 7472 7565 2061 6c69 6173 2c20 6e6f 7420  true alias, not 
+00012e50: 6120 726f 6f6d 2069 640a 2020 2020 2020  a room id.      
+00012e60: 2020 2020 2020 2020 2020 2320 6966 2062            # if b
+00012e70: 7920 6d69 7374 616b 6520 7573 6572 2068  y mistake user h
+00012e80: 6173 2067 6976 656e 2066 756c 6c20 726f  as given full ro
+00012e90: 6f6d 2061 6c69 6173 2c20 7368 6f72 7465  om alias, shorte
+00012ea0: 6e20 6974 0a20 2020 2020 2020 2020 2020  n it.           
+00012eb0: 2020 2020 2069 6620 6973 5f72 6f6f 6d5f       if is_room_
+00012ec0: 616c 6961 7328 616c 6961 7329 3a0a 2020  alias(alias):.  
+00012ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ee0: 2020 616c 6961 7320 3d20 726f 6f6d 5f61    alias = room_a
+00012ef0: 6c69 6173 5f74 6f5f 7368 6f72 745f 726f  lias_to_short_ro
+00012f00: 6f6d 5f61 6c69 6173 2861 6c69 6173 2c20  om_alias(alias, 
+00012f10: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00012f20: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00012f30: 2849 6e64 6578 4572 726f 722c 2054 7970  (IndexError, Typ
+00012f40: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00012f50: 2020 2020 2020 2020 2061 6c69 6173 203d           alias =
+00012f60: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
+00012f70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00012f80: 2020 2020 206e 616d 6520 3d20 6e61 6d65       name = name
+00012f90: 735b 696e 6465 785d 0a20 2020 2020 2020  s[index].       
+00012fa0: 2020 2020 2065 7863 6570 7420 2849 6e64       except (Ind
+00012fb0: 6578 4572 726f 722c 2054 7970 6545 7272  exError, TypeErr
+00012fc0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00012fd0: 2020 2020 206e 616d 6520 3d20 2222 0a20       name = "". 
+00012fe0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00012ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013000: 746f 7069 6320 3d20 746f 7069 6373 5b69  topic = topics[i
+00013010: 6e64 6578 5d0a 2020 2020 2020 2020 2020  ndex].          
+00013020: 2020 6578 6365 7074 2028 496e 6465 7845    except (IndexE
+00013030: 7272 6f72 2c20 5479 7065 4572 726f 7229  rror, TypeError)
+00013040: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013050: 2020 746f 7069 6320 3d20 2222 0a20 2020    topic = "".   
+00013060: 2020 2020 2020 2020 2061 6c69 6173 203d           alias =
+00013070: 2061 6c69 6173 2e73 7472 6970 2829 0a20   alias.strip(). 
+00013080: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
+00013090: 203d 204e 6f6e 6520 6966 2061 6c69 6173   = None if alias
+000130a0: 203d 3d20 2222 2065 6c73 6520 616c 6961   == "" else alia
+000130b0: 730a 2020 2020 2020 2020 2020 2020 6e61  s.            na
+000130c0: 6d65 203d 206e 616d 652e 7374 7269 7028  me = name.strip(
+000130d0: 290a 2020 2020 2020 2020 2020 2020 6e61  ).            na
+000130e0: 6d65 203d 204e 6f6e 6520 6966 206e 616d  me = None if nam
+000130f0: 6520 3d3d 2022 2220 656c 7365 206e 616d  e == "" else nam
+00013100: 650a 2020 2020 2020 2020 2020 2020 746f  e.            to
+00013110: 7069 6320 3d20 746f 7069 632e 7374 7269  pic = topic.stri
+00013120: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
+00013130: 746f 7069 6320 3d20 4e6f 6e65 2069 6620  topic = None if 
+00013140: 746f 7069 6320 3d3d 2022 2220 656c 7365  topic == "" else
+00013150: 2074 6f70 6963 0a20 2020 2020 2020 2020   topic.         
+00013160: 2020 2069 6620 6773 2e70 612e 706c 6169     if gs.pa.plai
+00013170: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+00013180: 2020 2065 6e63 7279 7074 203d 2046 616c     encrypt = Fal
+00013190: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+000131a0: 2020 2069 6e69 7469 616c 5f73 7461 7465     initial_state
+000131b0: 203d 2028 290a 2020 2020 2020 2020 2020   = ().          
+000131c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000131d0: 2020 2020 2020 2020 656e 6372 7970 7420          encrypt 
+000131e0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+000131f0: 2020 2020 2020 2069 6e69 7469 616c 5f73         initial_s
+00013200: 7461 7465 203d 205b 456e 6162 6c65 456e  tate = [EnableEn
+00013210: 6372 7970 7469 6f6e 4275 696c 6465 7228  cryptionBuilder(
+00013220: 292e 6173 5f64 6963 7428 295d 0a20 2020  ).as_dict()].   
+00013230: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00013240: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00013250: 2020 2020 2020 2066 2743 7265 6174 696e         f'Creatin
+00013260: 6720 444d 2072 6f6f 6d20 7769 7468 2075  g DM room with u
+00013270: 7365 7220 227b 7573 6572 7d22 2c20 270a  ser "{user}", '.
+00013280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013290: 6627 726f 6f6d 2061 6c69 6173 2022 7b61  f'room alias "{a
+000132a0: 6c69 6173 7d22 2c20 270a 2020 2020 2020  lias}", '.      
+000132b0: 2020 2020 2020 2020 2020 6627 6e61 6d65            f'name
+000132c0: 2022 7b6e 616d 657d 222c 2074 6f70 6963   "{name}", topic
+000132d0: 2022 7b74 6f70 6963 7d22 2061 6e64 2027   "{topic}" and '
+000132e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000132f0: 2066 2765 6e63 7279 7074 6564 2022 7b65   f'encrypted "{e
+00013300: 6e63 7279 7074 7d22 2e27 0a20 2020 2020  ncrypt}".'.     
+00013310: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00013320: 2020 2020 2023 206e 696f 2773 2072 6f6f       # nio's roo
+00013330: 6d5f 6372 6561 7465 2064 6f65 7320 4e4f  m_create does NO
+00013340: 5420 6163 6365 7074 2022 2366 6f6f 3a65  T accept "#foo:e
+00013350: 7861 6d70 6c65 2e63 6f6d 220a 2020 2020  xample.com".    
+00013360: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+00013370: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
+00013380: 5f63 7265 6174 6528 0a20 2020 2020 2020  _create(.       
+00013390: 2020 2020 2020 2020 2061 6c69 6173 3d61           alias=a
+000133a0: 6c69 6173 2c20 2023 2064 6573 6972 6564  lias,  # desired
+000133b0: 2063 616e 6f6e 6963 616c 2061 6c69 6173   canonical alias
+000133c0: 206c 6f63 616c 2070 6172 742c 2065 2e67   local part, e.g
+000133d0: 2e20 666f 6f0a 2020 2020 2020 2020 2020  . foo.          
+000133e0: 2020 2020 2020 7669 7369 6269 6c69 7479        visibility
+000133f0: 3d52 6f6f 6d56 6973 6962 696c 6974 792e  =RoomVisibility.
+00013400: 7072 6976 6174 652c 0a20 2020 2020 2020  private,.       
+00013410: 2020 2020 2020 2020 2069 735f 6469 7265           is_dire
+00013420: 6374 3d54 7275 652c 0a20 2020 2020 2020  ct=True,.       
+00013430: 2020 2020 2020 2020 2070 7265 7365 743d           preset=
+00013440: 526f 6f6d 5072 6573 6574 2e70 7269 7661  RoomPreset.priva
+00013450: 7465 5f63 6861 742c 0a20 2020 2020 2020  te_chat,.       
+00013460: 2020 2020 2020 2020 2069 6e76 6974 653d           invite=
+00013470: 7b75 7365 727d 2c20 2023 2069 6e76 6974  {user},  # invit
+00013480: 6520 7468 6520 7573 6572 2074 6f20 7468  e the user to th
+00013490: 6520 444d 0a20 2020 2020 2020 2020 2020  e DM.           
+000134a0: 2020 2020 206e 616d 653d 6e61 6d65 2c20       name=name, 
+000134b0: 2023 2072 6f6f 6d20 6e61 6d65 0a20 2020   # room name.   
+000134c0: 2020 2020 2020 2020 2020 2020 2074 6f70               top
+000134d0: 6963 3d74 6f70 6963 2c20 2023 2072 6f6f  ic=topic,  # roo
+000134e0: 6d20 746f 7069 630a 2020 2020 2020 2020  m topic.        
+000134f0: 2020 2020 2020 2020 696e 6974 6961 6c5f          initial_
+00013500: 7374 6174 653d 696e 6974 6961 6c5f 7374  state=initial_st
+00013510: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
+00013520: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
+00013530: 2022 616c 6961 7331 2220 7769 6c6c 2063   "alias1" will c
+00013540: 7265 6174 6520 6120 2223 616c 6961 7331  reate a "#alias1
+00013550: 3a65 7861 6d70 6c65 2e63 6f6d 220a 2020  :example.com".  
+00013560: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00013570: 6e73 7461 6e63 6528 7265 7370 2c20 526f  nstance(resp, Ro
+00013580: 6f6d 4372 6561 7465 4572 726f 7229 3a0a  omCreateError):.
+00013590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135a0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+000135b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135c0: 2020 2245 3132 353a 2022 0a20 2020 2020    "E125: ".     
+000135d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000135e0: 526f 6f6d 5f63 7265 6174 6520 6661 696c  Room_create fail
+000135f0: 6564 2077 6974 6820 7265 7370 6f6e 7365  ed with response
+00013600: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00013610: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
+00013620: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00013630: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+00013640: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00013650: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
+00013660: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+00013670: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013680: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00013690: 616c 6961 733a 0a20 2020 2020 2020 2020  alias:.         
+000136a0: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
+000136b0: 616c 6961 7320 3d20 7368 6f72 745f 726f  alias = short_ro
+000136c0: 6f6d 5f61 6c69 6173 5f74 6f5f 726f 6f6d  om_alias_to_room
+000136d0: 5f61 6c69 6173 280a 2020 2020 2020 2020  _alias(.        
+000136e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136f0: 616c 6961 732c 2063 7265 6465 6e74 6961  alias, credentia
+00013700: 6c73 0a20 2020 2020 2020 2020 2020 2020  ls.             
+00013710: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00013720: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013740: 2020 2066 756c 6c5f 616c 6961 7320 3d20     full_alias = 
+00013750: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00013760: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+00013770: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013780: 2020 2020 2020 6627 4372 6561 7465 6420        f'Created 
+00013790: 444d 2072 6f6f 6d20 7769 7468 2072 6f6f  DM room with roo
+000137a0: 6d20 6964 2022 7b72 6573 702e 726f 6f6d  m id "{resp.room
+000137b0: 5f69 647d 222c 2027 0a20 2020 2020 2020  _id}", '.       
+000137c0: 2020 2020 2020 2020 2020 2020 2066 2773               f's
+000137d0: 686f 7274 2061 6c69 6173 2022 7b7a 6e28  hort alias "{zn(
+000137e0: 616c 6961 7329 7d22 2c20 270a 2020 2020  alias)}", '.    
+000137f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013800: 6627 6675 6c6c 2061 6c69 6173 2022 7b7a  f'full alias "{z
+00013810: 6e28 6675 6c6c 5f61 6c69 6173 297d 2220  n(full_alias)}" 
+00013820: 616e 6420 270a 2020 2020 2020 2020 2020  and '.          
+00013830: 2020 2020 2020 2020 2020 6627 656e 6372            f'encr
+00013840: 7970 7465 6420 227b 656e 6372 7970 747d  ypted "{encrypt}
+00013850: 222e 270a 2020 2020 2020 2020 2020 2020  ".'.            
+00013860: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00013870: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+00013880: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
+00013890: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
+000138a0: 6167 0a20 2020 2020 2020 2020 2020 2020  ag.             
+000138b0: 2020 2074 6578 7420 3d20 280a 2020 2020     text = (.    
+000138c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138d0: 6622 7b72 6573 702e 726f 6f6d 5f69 647d  f"{resp.room_id}
+000138e0: 7b53 4550 7d7b 7a6e 2861 6c69 6173 297d  {SEP}{zn(alias)}
+000138f0: 7b53 4550 7d7b 7a6e 2866 756c 6c5f 616c  {SEP}{zn(full_al
+00013900: 6961 7329 7d22 0a20 2020 2020 2020 2020  ias)}".         
+00013910: 2020 2020 2020 2020 2020 2066 227b 5345             f"{SE
+00013920: 507d 7b7a 6e28 6e61 6d65 297d 7b53 4550  P}{zn(name)}{SEP
+00013930: 7d7b 7a6e 2874 6f70 6963 297d 7b53 4550  }{zn(topic)}{SEP
+00013940: 7d7b 656e 6372 7970 747d 220a 2020 2020  }{encrypt}".    
+00013950: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013960: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00013970: 4f62 6a65 6374 206f 6620 7479 7065 2052  Object of type R
+00013980: 6f6f 6d43 7265 6174 6552 6573 706f 6e73  oomCreateRespons
+00013990: 6520 6973 206e 6f74 204a 534f 4e0a 2020  e is not JSON.  
+000139a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000139b0: 7365 7269 616c 697a 6162 6c65 2c20 6865  serializable, he
+000139c0: 6e63 6520 7765 2075 7365 2074 6865 2064  nce we use the d
+000139d0: 6963 7469 6f6e 6172 792e 0a20 2020 2020  ictionary..     
+000139e0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+000139f0: 6d61 7820 3d20 7265 7370 2e5f 5f64 6963  max = resp.__dic
+00013a00: 745f 5f0a 2020 2020 2020 2020 2020 2020  t__.            
+00013a10: 2020 2020 2320 7265 7370 2068 6173 206f      # resp has o
+00013a20: 6e6c 7920 3120 7573 6566 756c 2075 7365  nly 1 useful use
+00013a30: 6675 6c20 6d65 6d62 6572 3a20 726f 6f6d  ful member: room
+00013a40: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
+00013a50: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
+00013a60: 6174 6528 7b22 616c 6961 7322 3a20 616c  ate({"alias": al
+00013a70: 6961 737d 2920 2023 2061 6464 2064 6963  ias})  # add dic
+00013a80: 7420 6974 656d 730a 2020 2020 2020 2020  t items.        
+00013a90: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+00013aa0: 2e75 7064 6174 6528 7b22 616c 6961 735f  .update({"alias_
+00013ab0: 6675 6c6c 223a 2066 756c 6c5f 616c 6961  full": full_alia
+00013ac0: 737d 290a 2020 2020 2020 2020 2020 2020  s}).            
+00013ad0: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
+00013ae0: 6174 6528 7b22 6e61 6d65 223a 206e 616d  ate({"name": nam
+00013af0: 657d 290a 2020 2020 2020 2020 2020 2020  e}).            
+00013b00: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
+00013b10: 6174 6528 7b22 746f 7069 6322 3a20 746f  ate({"topic": to
+00013b20: 7069 637d 290a 2020 2020 2020 2020 2020  pic}).          
+00013b30: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
+00013b40: 7064 6174 6528 7b22 656e 6372 7970 7465  pdate({"encrypte
+00013b50: 6422 3a20 656e 6372 7970 747d 290a 2020  d": encrypt}).  
+00013b60: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+00013b70: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
+00013b80: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+00013b90: 2020 2020 2020 6a73 6f6e 5f2e 706f 7028        json_.pop(
+00013ba0: 2274 7261 6e73 706f 7274 5f72 6573 706f  "transport_respo
+00013bb0: 6e73 6522 290a 2020 2020 2020 2020 2020  nse").          
+00013bc0: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
+00013bd0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00013be0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
+00013bf0: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
+00013c00: 2020 2020 2020 2020 2067 732e 7061 2e6f           gs.pa.o
+00013c10: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+00013c20: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+00013c30: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
+00013c40: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
+00013c50: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
+00013c60: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00013c70: 6d61 783d 6a73 6f6e 5f6d 6178 2c0a 2020  max=json_max,.  
+00013c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c90: 2020 6a73 6f6e 5f73 7065 633d 6a73 6f6e    json_spec=json
+00013ca0: 5f73 7065 632c 0a20 2020 2020 2020 2020  _spec,.         
+00013cb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00013cc0: 2020 2020 2069 6e64 6578 203d 2069 6e64       index = ind
+00013cd0: 6578 202b 2031 0a20 2020 2065 7863 6570  ex + 1.    excep
+00013ce0: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+00013cf0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00013d00: 7228 2245 3132 363a 2022 2022 444d 2072  r("E126: " "DM r
+00013d10: 6f6f 6d20 6372 6561 7469 6f6e 2066 6169  oom creation fai
+00013d20: 6c65 642e 2053 6f72 7279 2e22 290a 2020  led. Sorry.").  
+00013d30: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
+00013d40: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+00013d50: 6773 2e6c 6f67 2e64 6562 7567 2822 4865  gs.log.debug("He
+00013d60: 7265 2069 7320 7468 6520 7472 6163 6562  re is the traceb
+00013d70: 6163 6b2e 5c6e 2220 2b20 7472 6163 6562  ack.\n" + traceb
+00013d80: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
+00013d90: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
+00013da0: 7469 6f6e 5f72 6f6f 6d5f 6372 6561 7465  tion_room_create
+00013db0: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
+00013dc0: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
+00013dd0: 733a 2064 6963 7429 3a0a 2020 2020 2222  s: dict):.    ""
+00013de0: 2243 7265 6174 6520 6f6e 6520 6f72 206d  "Create one or m
+00013df0: 756c 7469 706c 6520 726f 6f6d 7320 7768  ultiple rooms wh
+00013e00: 696c 6520 616c 7265 6164 7920 6265 696e  ile already bein
+00013e10: 6720 6c6f 6767 6564 2069 6e2e 0a0a 2020  g logged in...  
+00013e20: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
+00013e30: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063   ---------.    c
+00013e40: 6c69 656e 743a 2041 7379 6e63 436c 6965  lient: AsyncClie
+00013e50: 6e74 3a20 6e69 6f20 636c 6965 6e74 2c20  nt: nio client, 
+00013e60: 616c 6c6f 7773 2061 7320 746f 2071 7565  allows as to que
+00013e70: 7279 2074 6865 2073 6572 7665 720a 2020  ry the server.  
+00013e80: 2020 6372 6564 656e 7469 616c 733a 2064    credentials: d
+00013e90: 6963 743a 2061 6c6c 6f77 7320 746f 2067  ict: allows to g
+00013ea0: 6574 2074 6865 2075 7365 725f 6964 206f  et the user_id o
+00013eb0: 6620 7365 6e64 6572 2c20 6574 630a 2020  f sender, etc.  
+00013ec0: 2020 2222 220a 2020 2020 2320 726f 6f6d    """.    # room
+00013ed0: 5f61 6c69 6173 6573 203a 206c 6973 7420  _aliases : list 
+00013ee0: 6f66 2072 6f6f 6d20 616c 6961 7365 7320  of room aliases 
+00013ef0: 696e 2074 6865 2066 6f72 6d20 6f66 2022  in the form of "
+00013f00: 7361 6d70 6c65 416c 6961 7322 0a20 2020  sampleAlias".   
+00013f10: 2023 2020 2020 2020 2020 2054 6865 7365   #         These
+00013f20: 2061 6c69 6173 6573 2077 696c 6c20 7468   aliases will th
+00013f30: 656e 2062 6520 7573 6564 2062 7920 7468  en be used by th
+00013f40: 6520 7365 7276 6572 2061 6e64 0a20 2020  e server and.   
+00013f50: 2023 2020 2020 2020 2020 2074 6865 2073   #         the s
+00013f60: 6572 7665 7220 6372 6561 7465 7320 7468  erver creates th
+00013f70: 6520 6465 6669 6e69 7465 2061 6c69 6173  e definite alias
+00013f80: 2069 6e20 7468 6520 666f 726d 0a20 2020   in the form.   
+00013f90: 2023 2020 2020 2020 2020 206f 6620 2223   #         of "#
+00013fa0: 7361 6d70 6c65 416c 6961 733a 6578 616d  sampleAlias:exam
+00013fb0: 706c 652e 636f 6d22 2066 726f 6d20 6974  ple.com" from it
+00013fc0: 2e0a 2020 2020 2320 2020 2020 2020 2020  ..    #         
+00013fd0: 5765 2070 6572 6d69 7420 2223 7361 6d70  We permit "#samp
+00013fe0: 6c65 416c 6961 733a 6578 616d 706c 652e  leAlias:example.
+00013ff0: 636f 6d22 2061 6e64 2064 6f77 6e73 6361  com" and downsca
+00014000: 6c65 2069 7420 746f 0a20 2020 2023 2020  le it to.    #  
+00014010: 2020 2020 2020 2022 7361 6d70 6c65 416c         "sampleAl
+00014020: 6961 7322 2e0a 2020 2020 2320 6e61 6d65  ias"..    # name
+00014030: 7320 3a20 6c69 7374 206f 6620 6e61 6d65  s : list of name
+00014040: 7320 666f 7220 726f 6f6d 730a 2020 2020  s for rooms.    
+00014050: 2320 746f 7069 6373 203a 206c 6973 7420  # topics : list 
+00014060: 6f66 2072 6f6f 6d20 746f 7069 6373 0a0a  of room topics..
+00014070: 2020 2020 726f 6f6d 5f61 6c69 6173 6573      room_aliases
+00014080: 203d 2067 732e 7061 2e72 6f6f 6d5f 6372   = gs.pa.room_cr
+00014090: 6561 7465 0a20 2020 206e 616d 6573 203d  eate.    names =
+000140a0: 2067 732e 7061 2e6e 616d 650a 2020 2020   gs.pa.name.    
+000140b0: 746f 7069 6373 203d 2067 732e 7061 2e74  topics = gs.pa.t
+000140c0: 6f70 6963 0a20 2020 2074 7279 3a0a 2020  opic.    try:.  
+000140d0: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
+000140e0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000140f0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+00014100: 2020 6627 5472 7969 6e67 2074 6f20 6372    f'Trying to cr
+00014110: 6561 7465 2072 6f6f 6d73 2077 6974 6820  eate rooms with 
+00014120: 726f 6f6d 2061 6c69 6173 6573 2022 7b72  room aliases "{r
+00014130: 6f6f 6d5f 616c 6961 7365 737d 222c 2027  oom_aliases}", '
+00014140: 0a20 2020 2020 2020 2020 2020 2066 276e  .            f'n
+00014150: 616d 6573 2022 7b6e 616d 6573 7d22 2c20  ames "{names}", 
+00014160: 616e 6420 746f 7069 6373 2022 7b74 6f70  and topics "{top
+00014170: 6963 737d 222e 270a 2020 2020 2020 2020  ics}".'.        
+00014180: 290a 2020 2020 2020 2020 666f 7220 616c  ).        for al
+00014190: 6961 7320 696e 2072 6f6f 6d5f 616c 6961  ias in room_alia
+000141a0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
+000141b0: 2061 6c69 6173 203d 2061 6c69 6173 2e72   alias = alias.r
+000141c0: 6570 6c61 6365 2872 225c 2122 2c20 2221  eplace(r"\!", "!
+000141d0: 2229 2020 2320 7265 6d6f 7665 2070 6f73  ")  # remove pos
+000141e0: 7369 626c 6520 6573 6361 7065 0a20 2020  sible escape.   
+000141f0: 2020 2020 2020 2020 2023 2061 6c69 6173           # alias
+00014200: 2069 7320 6120 7472 7565 2061 6c69 6173   is a true alias
+00014210: 2c20 6e6f 7420 6120 726f 6f6d 2069 640a  , not a room id.
+00014220: 2020 2020 2020 2020 2020 2020 2320 6966              # if
+00014230: 2062 7920 6d69 7374 616b 6520 7573 6572   by mistake user
+00014240: 2068 6173 2067 6976 656e 2066 756c 6c20   has given full 
+00014250: 726f 6f6d 2061 6c69 6173 2c20 7368 6f72  room alias, shor
+00014260: 7465 6e20 6974 0a20 2020 2020 2020 2020  ten it.         
+00014270: 2020 2069 6620 6973 5f72 6f6f 6d5f 616c     if is_room_al
+00014280: 6961 7328 616c 6961 7329 3a0a 2020 2020  ias(alias):.    
+00014290: 2020 2020 2020 2020 2020 2020 616c 6961              alia
+000142a0: 7320 3d20 726f 6f6d 5f61 6c69 6173 5f74  s = room_alias_t
+000142b0: 6f5f 7368 6f72 745f 726f 6f6d 5f61 6c69  o_short_room_ali
+000142c0: 6173 2861 6c69 6173 2c20 6372 6564 656e  as(alias, creden
+000142d0: 7469 616c 7329 0a20 2020 2020 2020 2020  tials).         
+000142e0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000142f0: 2020 2020 2020 2020 6e61 6d65 203d 206e          name = n
+00014300: 616d 6573 5b69 6e64 6578 5d0a 2020 2020  ames[index].    
+00014310: 2020 2020 2020 2020 6578 6365 7074 2028          except (
+00014320: 496e 6465 7845 7272 6f72 2c20 5479 7065  IndexError, Type
+00014330: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00014340: 2020 2020 2020 2020 6e61 6d65 203d 2022          name = "
+00014350: 220a 2020 2020 2020 2020 2020 2020 7472  ".            tr
+00014360: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00014370: 2020 2074 6f70 6963 203d 2074 6f70 6963     topic = topic
+00014380: 735b 696e 6465 785d 0a20 2020 2020 2020  s[index].       
+00014390: 2020 2020 2065 7863 6570 7420 2849 6e64       except (Ind
+000143a0: 6578 4572 726f 722c 2054 7970 6545 7272  exError, TypeErr
+000143b0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000143c0: 2020 2020 2074 6f70 6963 203d 2022 220a       topic = "".
+000143d0: 2020 2020 2020 2020 2020 2020 616c 6961              alia
+000143e0: 7320 3d20 616c 6961 732e 7374 7269 7028  s = alias.strip(
+000143f0: 290a 2020 2020 2020 2020 2020 2020 616c  ).            al
+00014400: 6961 7320 3d20 4e6f 6e65 2069 6620 616c  ias = None if al
+00014410: 6961 7320 3d3d 2022 2220 656c 7365 2061  ias == "" else a
+00014420: 6c69 6173 0a20 2020 2020 2020 2020 2020  lias.           
+00014430: 206e 616d 6520 3d20 6e61 6d65 2e73 7472   name = name.str
+00014440: 6970 2829 0a20 2020 2020 2020 2020 2020  ip().           
+00014450: 206e 616d 6520 3d20 4e6f 6e65 2069 6620   name = None if 
+00014460: 6e61 6d65 203d 3d20 2222 2065 6c73 6520  name == "" else 
+00014470: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+00014480: 2074 6f70 6963 203d 2074 6f70 6963 2e73   topic = topic.s
+00014490: 7472 6970 2829 0a20 2020 2020 2020 2020  trip().         
+000144a0: 2020 2074 6f70 6963 203d 204e 6f6e 6520     topic = None 
+000144b0: 6966 2074 6f70 6963 203d 3d20 2222 2065  if topic == "" e
+000144c0: 6c73 6520 746f 7069 630a 2020 2020 2020  lse topic.      
+000144d0: 2020 2020 2020 6966 2067 732e 7061 2e70        if gs.pa.p
+000144e0: 6c61 696e 3a0a 2020 2020 2020 2020 2020  lain:.          
+000144f0: 2020 2020 2020 656e 6372 7970 7420 3d20        encrypt = 
+00014500: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00014510: 2020 2020 2020 696e 6974 6961 6c5f 7374        initial_st
+00014520: 6174 6520 3d20 2829 0a20 2020 2020 2020  ate = ().       
+00014530: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014540: 2020 2020 2020 2020 2020 2065 6e63 7279             encry
+00014550: 7074 203d 2054 7275 650a 2020 2020 2020  pt = True.      
+00014560: 2020 2020 2020 2020 2020 696e 6974 6961            initia
+00014570: 6c5f 7374 6174 6520 3d20 5b45 6e61 626c  l_state = [Enabl
+00014580: 6545 6e63 7279 7074 696f 6e42 7569 6c64  eEncryptionBuild
+00014590: 6572 2829 2e61 735f 6469 6374 2829 5d0a  er().as_dict()].
+000145a0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+000145b0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+000145c0: 2020 2020 2020 2020 2020 6627 4372 6561            f'Crea
+000145d0: 7469 6e67 2072 6f6f 6d20 7769 7468 2072  ting room with r
+000145e0: 6f6f 6d20 616c 6961 7320 227b 616c 6961  oom alias "{alia
+000145f0: 737d 222c 2027 0a20 2020 2020 2020 2020  s}", '.         
+00014600: 2020 2020 2020 2066 276e 616d 6520 227b         f'name "{
+00014610: 6e61 6d65 7d22 2c20 746f 7069 6320 227b  name}", topic "{
+00014620: 746f 7069 637d 2220 616e 6420 270a 2020  topic}" and '.  
+00014630: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00014640: 656e 6372 7970 7465 6420 227b 656e 6372  encrypted "{encr
+00014650: 7970 747d 222e 270a 2020 2020 2020 2020  ypt}".'.        
+00014660: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00014670: 2020 2320 6e69 6f27 7320 726f 6f6d 5f63    # nio's room_c
+00014680: 7265 6174 6520 646f 6573 204e 4f54 2061  reate does NOT a
+00014690: 6363 6570 7420 2223 666f 6f3a 6578 616d  ccept "#foo:exam
+000146a0: 706c 652e 636f 6d22 0a20 2020 2020 2020  ple.com".       
+000146b0: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
+000146c0: 7420 636c 6965 6e74 2e72 6f6f 6d5f 6372  t client.room_cr
+000146d0: 6561 7465 280a 2020 2020 2020 2020 2020  eate(.          
+000146e0: 2020 2020 2020 616c 6961 733d 616c 6961        alias=alia
+000146f0: 732c 2020 2320 6465 7369 7265 6420 6361  s,  # desired ca
+00014700: 6e6f 6e69 6361 6c20 616c 6961 7320 6c6f  nonical alias lo
+00014710: 6361 6c20 7061 7274 2c20 652e 672e 2066  cal part, e.g. f
+00014720: 6f6f 0a20 2020 2020 2020 2020 2020 2020  oo.             
+00014730: 2020 206e 616d 653d 6e61 6d65 2c20 2023     name=name,  #
+00014740: 2072 6f6f 6d20 6e61 6d65 0a20 2020 2020   room name.     
+00014750: 2020 2020 2020 2020 2020 2074 6f70 6963             topic
+00014760: 3d74 6f70 6963 2c20 2023 2072 6f6f 6d20  =topic,  # room 
+00014770: 746f 7069 630a 2020 2020 2020 2020 2020  topic.          
+00014780: 2020 2020 2020 696e 6974 6961 6c5f 7374        initial_st
+00014790: 6174 653d 696e 6974 6961 6c5f 7374 6174  ate=initial_stat
+000147a0: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+000147b0: 0a20 2020 2020 2020 2020 2020 2023 2022  .            # "
+000147c0: 616c 6961 7331 2220 7769 6c6c 2063 7265  alias1" will cre
+000147d0: 6174 6520 6120 2223 616c 6961 7331 3a65  ate a "#alias1:e
+000147e0: 7861 6d70 6c65 2e63 6f6d 220a 2020 2020  xample.com".    
+000147f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00014800: 7461 6e63 6528 7265 7370 2c20 526f 6f6d  tance(resp, Room
+00014810: 4372 6561 7465 4572 726f 7229 3a0a 2020  CreateError):.  
+00014820: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00014830: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014850: 2245 3132 373a 2022 0a20 2020 2020 2020  "E127: ".       
+00014860: 2020 2020 2020 2020 2020 2020 2022 526f               "Ro
+00014870: 6f6d 5f63 7265 6174 6520 6661 696c 6564  om_create failed
+00014880: 2077 6974 6820 7265 7370 6f6e 7365 3a20   with response: 
+00014890: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000148a0: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+000148b0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+000148c0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
+000148d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000148e0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+000148f0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+00014900: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014910: 2020 2020 2020 2020 2020 2069 6620 616c             if al
+00014920: 6961 733a 0a20 2020 2020 2020 2020 2020  ias:.           
+00014930: 2020 2020 2020 2020 2066 756c 6c5f 616c           full_al
+00014940: 6961 7320 3d20 7368 6f72 745f 726f 6f6d  ias = short_room
+00014950: 5f61 6c69 6173 5f74 6f5f 726f 6f6d 5f61  _alias_to_room_a
+00014960: 6c69 6173 280a 2020 2020 2020 2020 2020  lias(.          
+00014970: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00014980: 6961 732c 2063 7265 6465 6e74 6961 6c73  ias, credentials
+00014990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000149a0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000149b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149d0: 2066 756c 6c5f 616c 6961 7320 3d20 4e6f   full_alias = No
+000149e0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+000149f0: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
+00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a10: 2020 2020 6627 4372 6561 7465 6420 726f      f'Created ro
+00014a20: 6f6d 2077 6974 6820 726f 6f6d 2069 6420  om with room id 
+00014a30: 227b 7265 7370 2e72 6f6f 6d5f 6964 7d22  "{resp.room_id}"
+00014a40: 2c20 270a 2020 2020 2020 2020 2020 2020  , '.            
+00014a50: 2020 2020 2020 2020 6627 7368 6f72 7420          f'short 
+00014a60: 616c 6961 7320 227b 7a6e 2861 6c69 6173  alias "{zn(alias
+00014a70: 297d 222c 2027 0a20 2020 2020 2020 2020  )}", '.         
+00014a80: 2020 2020 2020 2020 2020 2066 2766 756c             f'ful
+00014a90: 6c20 616c 6961 7320 227b 7a6e 2866 756c  l alias "{zn(ful
+00014aa0: 6c5f 616c 6961 7329 7d22 2061 6e64 2027  l_alias)}" and '
+00014ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ac0: 2020 2020 2066 2765 6e63 7279 7074 6564       f'encrypted
+00014ad0: 2022 7b65 6e63 7279 7074 7d22 2e27 0a20   "{encrypt}".'. 
+00014ae0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00014af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014b00: 2023 206f 7574 7075 7420 666f 726d 6174   # output format
+00014b10: 2063 6f6e 7472 6f6c 6c65 6420 7669 6120   controlled via 
+00014b20: 2d2d 6f75 7470 7574 2066 6c61 670a 2020  --output flag.  
+00014b30: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00014b40: 7874 203d 2028 0a20 2020 2020 2020 2020  xt = (.         
+00014b50: 2020 2020 2020 2020 2020 2066 227b 7265             f"{re
+00014b60: 7370 2e72 6f6f 6d5f 6964 7d7b 5345 507d  sp.room_id}{SEP}
+00014b70: 7b7a 6e28 616c 6961 7329 7d7b 5345 507d  {zn(alias)}{SEP}
+00014b80: 7b7a 6e28 6675 6c6c 5f61 6c69 6173 297d  {zn(full_alias)}
+00014b90: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00014ba0: 2020 2020 2020 6622 7b53 4550 7d7b 7a6e        f"{SEP}{zn
+00014bb0: 286e 616d 6529 7d7b 5345 507d 7b7a 6e28  (name)}{SEP}{zn(
+00014bc0: 746f 7069 6329 7d7b 5345 507d 7b65 6e63  topic)}{SEP}{enc
+00014bd0: 7279 7074 7d22 0a20 2020 2020 2020 2020  rypt}".         
+00014be0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00014bf0: 2020 2020 2020 2020 2023 204f 626a 6563           # Objec
+00014c00: 7420 6f66 2074 7970 6520 526f 6f6d 4372  t of type RoomCr
+00014c10: 6561 7465 5265 7370 6f6e 7365 2069 7320  eateResponse is 
+00014c20: 6e6f 7420 4a53 4f4e 0a20 2020 2020 2020  not JSON.       
+00014c30: 2020 2020 2020 2020 2023 2073 6572 6961           # seria
+00014c40: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
+00014c50: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
+00014c60: 6e61 7279 2e0a 2020 2020 2020 2020 2020  nary..          
+00014c70: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
+00014c80: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
+00014c90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00014ca0: 2072 6573 7020 6861 7320 6f6e 6c79 2031   resp has only 1
+00014cb0: 2075 7365 6675 6c20 7573 6566 756c 206d   useful useful m
+00014cc0: 656d 6265 723a 2072 6f6f 6d5f 6964 0a20  ember: room_id. 
+00014cd0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00014ce0: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+00014cf0: 2261 6c69 6173 223a 2061 6c69 6173 7d29  "alias": alias})
+00014d00: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
+00014d10: 6d73 0a20 2020 2020 2020 2020 2020 2020  ms.             
+00014d20: 2020 206a 736f 6e5f 6d61 782e 7570 6461     json_max.upda
+00014d30: 7465 287b 2261 6c69 6173 5f66 756c 6c22  te({"alias_full"
+00014d40: 3a20 6675 6c6c 5f61 6c69 6173 7d29 0a20  : full_alias}). 
+00014d50: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00014d60: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+00014d70: 226e 616d 6522 3a20 6e61 6d65 7d29 0a20  "name": name}). 
+00014d80: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00014d90: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+00014da0: 2274 6f70 6963 223a 2074 6f70 6963 7d29  "topic": topic})
+00014db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014dc0: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
+00014dd0: 287b 2265 6e63 7279 7074 6564 223a 2065  ({"encrypted": e
+00014de0: 6e63 7279 7074 7d29 0a20 2020 2020 2020  ncrypt}).       
+00014df0: 2020 2020 2020 2020 206a 736f 6e5f 203d           json_ =
+00014e00: 206a 736f 6e5f 6d61 782e 636f 7079 2829   json_max.copy()
+00014e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014e20: 206a 736f 6e5f 2e70 6f70 2822 7472 616e   json_.pop("tran
+00014e30: 7370 6f72 745f 7265 7370 6f6e 7365 2229  sport_response")
+00014e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014e50: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
+00014e60: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00014e70: 2020 7072 696e 745f 6f75 7470 7574 280a    print_output(.
+00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e90: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
+00014ea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014eb0: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
+00014ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ed0: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
+00014ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014ef0: 2020 2020 2020 6a73 6f6e 5f6d 6178 3d6a        json_max=j
+00014f00: 736f 6e5f 6d61 782c 0a20 2020 2020 2020  son_max,.       
+00014f10: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00014f20: 6e5f 7370 6563 3d6a 736f 6e5f 7370 6563  n_spec=json_spec
+00014f30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014f40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00014f50: 696e 6465 7820 3d20 696e 6465 7820 2b20  index = index + 
+00014f60: 310a 2020 2020 6578 6365 7074 2045 7863  1.    except Exc
+00014f70: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00014f80: 6773 2e6c 6f67 2e65 7272 6f72 2822 4531  gs.log.error("E1
+00014f90: 3238 3a20 2220 2252 6f6f 6d20 6372 6561  28: " "Room crea
+00014fa0: 7469 6f6e 2066 6169 6c65 642e 2053 6f72  tion failed. Sor
+00014fb0: 7279 2e22 290a 2020 2020 2020 2020 6773  ry.").        gs
+00014fc0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+00014fd0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00014fe0: 6562 7567 2822 4865 7265 2069 7320 7468  ebug("Here is th
+00014ff0: 6520 7472 6163 6562 6163 6b2e 5c6e 2220  e traceback.\n" 
+00015000: 2b20 7472 6163 6562 6163 6b2e 666f 726d  + traceback.form
+00015010: 6174 5f65 7863 2829 290a 0a0a 6173 796e  at_exc())...asyn
+00015020: 6320 6465 6620 6163 7469 6f6e 5f72 6f6f  c def action_roo
+00015030: 6d5f 6a6f 696e 2863 6c69 656e 742c 2063  m_join(client, c
+00015040: 7265 6465 6e74 6961 6c73 293a 0a20 2020  redentials):.   
+00015050: 2022 2222 4a6f 696e 206f 6e65 206f 7220   """Join one or 
+00015060: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2e22  multiple rooms."
+00015070: 2222 0a20 2020 2072 6f6f 6d73 203d 2067  "".    rooms = g
+00015080: 732e 7061 2e72 6f6f 6d5f 6a6f 696e 0a20  s.pa.room_join. 
+00015090: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000150a0: 666f 7220 726f 6f6d 5f69 6420 696e 2072  for room_id in r
+000150b0: 6f6f 6d73 3a0a 2020 2020 2020 2020 2020  ooms:.          
+000150c0: 2020 2320 726f 6f6d 5f69 6420 6361 6e20    # room_id can 
+000150d0: 6265 2023 726f 6f6d 416c 6961 7320 6f72  be #roomAlias or
+000150e0: 2021 726f 6f6d 4964 0a20 2020 2020 2020   !roomId.       
+000150f0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00015100: 6728 6627 5072 6570 6172 696e 6720 746f  g(f'Preparing to
+00015110: 206a 6f69 6e20 726f 6f6d 2022 7b72 6f6f   join room "{roo
+00015120: 6d5f 6964 7d22 2e27 290a 2020 2020 2020  m_id}".').      
+00015130: 2020 2020 2020 726f 6f6d 5f69 6420 3d20        room_id = 
+00015140: 6177 6169 7420 6d61 705f 726f 6f6d 696e  await map_roomin
+00015150: 666f 5f74 6f5f 726f 6f6d 6964 2863 6c69  fo_to_roomid(cli
+00015160: 656e 742c 2072 6f6f 6d5f 6964 290a 2020  ent, room_id).  
+00015170: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00015180: 2e64 6562 7567 2866 274a 6f69 6e69 6e67  .debug(f'Joining
+00015190: 2072 6f6f 6d20 227b 726f 6f6d 5f69 647d   room "{room_id}
+000151a0: 222e 2729 0a20 2020 2020 2020 2020 2020  ".').           
+000151b0: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
+000151c0: 6965 6e74 2e6a 6f69 6e28 726f 6f6d 5f69  ient.join(room_i
+000151d0: 6429 0a20 2020 2020 2020 2020 2020 2069  d).            i
+000151e0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+000151f0: 702c 204a 6f69 6e45 7272 6f72 293a 0a20  p, JoinError):. 
+00015200: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00015210: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+00015220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015230: 2022 4531 3239 3a20 2220 6622 6a6f 696e   "E129: " f"join
+00015240: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
+00015250: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+00015260: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+00015270: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00015280: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
+00015290: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+000152a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000152b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152c0: 6773 2e6c 6f67 2e69 6e66 6f28 6627 4a6f  gs.log.info(f'Jo
+000152d0: 696e 6564 2072 6f6f 6d20 227b 726f 6f6d  ined room "{room
+000152e0: 5f69 647d 2220 7375 6363 6573 7366 756c  _id}" successful
+000152f0: 6c79 2e27 290a 2020 2020 6578 6365 7074  ly.').    except
+00015300: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00015310: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+00015320: 2822 4531 3330 3a20 2220 224a 6f69 6e69  ("E130: " "Joini
+00015330: 6e67 2072 6f6f 6d73 2066 6169 6c65 642e  ng rooms failed.
+00015340: 2053 6f72 7279 2e22 290a 2020 2020 2020   Sorry.").      
+00015350: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00015360: 3d20 310a 2020 2020 2020 2020 6773 2e6c  = 1.        gs.l
+00015370: 6f67 2e64 6562 7567 2822 4865 7265 2069  og.debug("Here i
+00015380: 7320 7468 6520 7472 6163 6562 6163 6b2e  s the traceback.
+00015390: 5c6e 2220 2b20 7472 6163 6562 6163 6b2e  \n" + traceback.
+000153a0: 666f 726d 6174 5f65 7863 2829 290a 0a0a  format_exc())...
+000153b0: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
+000153c0: 5f72 6f6f 6d5f 6c65 6176 6528 636c 6965  _room_leave(clie
+000153d0: 6e74 2c20 6372 6564 656e 7469 616c 7329  nt, credentials)
+000153e0: 3a0a 2020 2020 2222 224c 6561 7665 206f  :.    """Leave o
+000153f0: 6e65 206f 7220 6d75 6c74 6970 6c65 2072  ne or multiple r
+00015400: 6f6f 6d73 2e22 2222 0a20 2020 2072 6f6f  ooms.""".    roo
+00015410: 6d73 203d 2067 732e 7061 2e72 6f6f 6d5f  ms = gs.pa.room_
+00015420: 6c65 6176 650a 2020 2020 7472 793a 0a20  leave.    try:. 
+00015430: 2020 2020 2020 2066 6f72 2072 6f6f 6d5f         for room_
+00015440: 6964 2069 6e20 726f 6f6d 733a 0a20 2020  id in rooms:.   
+00015450: 2020 2020 2020 2020 2023 2072 6f6f 6d5f           # room_
+00015460: 6964 2063 616e 2062 6520 2372 6f6f 6d41  id can be #roomA
+00015470: 6c69 6173 206f 7220 2172 6f6f 6d49 640a  lias or !roomId.
+00015480: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00015490: 6f67 2e64 6562 7567 2866 2750 7265 7061  og.debug(f'Prepa
+000154a0: 7269 6e67 2074 6f20 6c65 6176 6520 726f  ring to leave ro
+000154b0: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e27  om "{room_id}".'
+000154c0: 290a 2020 2020 2020 2020 2020 2020 726f  ).            ro
+000154d0: 6f6d 5f69 6420 3d20 6177 6169 7420 6d61  om_id = await ma
+000154e0: 705f 726f 6f6d 696e 666f 5f74 6f5f 726f  p_roominfo_to_ro
+000154f0: 6f6d 6964 2863 6c69 656e 742c 2072 6f6f  omid(client, roo
+00015500: 6d5f 6964 290a 2020 2020 2020 2020 2020  m_id).          
+00015510: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+00015520: 274c 6561 7669 6e67 2072 6f6f 6d20 227b  'Leaving room "{
+00015530: 726f 6f6d 5f69 647d 222e 2729 0a20 2020  room_id}".').   
+00015540: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00015550: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
+00015560: 6d5f 6c65 6176 6528 726f 6f6d 5f69 6429  m_leave(room_id)
+00015570: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00015580: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
+00015590: 2052 6f6f 6d4c 6561 7665 4572 726f 7229   RoomLeaveError)
+000155a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000155b0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+000155c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155d0: 2020 2020 2245 3133 313a 2022 2066 224c      "E131: " f"L
+000155e0: 6561 7665 2066 6169 6c65 6420 7769 7468  eave failed with
+000155f0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+00015600: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+00015610: 2020 2020 2020 2020 2020 2020 2020 290a                ).
 00015620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015630: 6627 5573 6572 2022 7b75 7365 727d 2220  f'User "{user}" 
-00015640: 7761 7320 7375 6363 6573 7366 756c 6c79  was successfully
-00015650: 2069 6e76 6974 6564 2027 0a20 2020 2020   invited '.     
-00015660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015670: 2020 2066 2774 6f20 726f 6f6d 2022 7b72     f'to room "{r
-00015680: 6f6f 6d5f 6964 7d22 2e27 0a20 2020 2020  oom_id}".'.     
-00015690: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000156a0: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
-000156b0: 7074 696f 6e3a 0a20 2020 2020 2020 2067  ption:.        g
-000156c0: 732e 6c6f 672e 6572 726f 7228 2245 3133  s.log.error("E13
-000156d0: 363a 2022 2022 5573 6572 2069 6e76 6974  6: " "User invit
-000156e0: 6520 6661 696c 6564 2e20 536f 7272 792e  e failed. Sorry.
-000156f0: 2229 0a20 2020 2020 2020 2067 732e 6c6f  ").        gs.lo
-00015700: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
-00015710: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
-00015720: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
-00015730: 6f72 6d61 745f 6578 6328 2929 0a0a 0a61  ormat_exc())...a
-00015740: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-00015750: 726f 6f6d 5f62 616e 2863 6c69 656e 742c  room_ban(client,
-00015760: 2063 7265 6465 6e74 6961 6c73 293a 0a20   credentials):. 
-00015770: 2020 2022 2222 4261 6e20 6f6e 6520 6f72     """Ban one or
-00015780: 206d 756c 7469 706c 6520 7573 6572 7320   multiple users 
-00015790: 6672 6f6d 206f 6e65 206f 7220 6d75 6c74  from one or mult
-000157a0: 6970 6c65 2072 6f6f 6d73 2e22 2222 0a20  iple rooms.""". 
-000157b0: 2020 2072 6f6f 6d73 203d 2067 732e 7061     rooms = gs.pa
-000157c0: 2e72 6f6f 6d5f 6261 6e0a 2020 2020 7573  .room_ban.    us
-000157d0: 6572 7320 3d20 6773 2e70 612e 7573 6572  ers = gs.pa.user
-000157e0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-000157f0: 2020 666f 7220 726f 6f6d 5f69 6420 696e    for room_id in
-00015800: 2072 6f6f 6d73 3a0a 2020 2020 2020 2020   rooms:.        
-00015810: 2020 2020 2320 726f 6f6d 5f69 6420 6361      # room_id ca
-00015820: 6e20 6265 2023 726f 6f6d 416c 6961 7320  n be #roomAlias 
-00015830: 6f72 2021 726f 6f6d 4964 0a20 2020 2020  or !roomId.     
-00015840: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00015850: 6275 6728 6627 5072 6570 6172 696e 6720  bug(f'Preparing 
-00015860: 746f 2062 616e 2069 6e20 726f 6f6d 2022  to ban in room "
-00015870: 7b72 6f6f 6d5f 6964 7d22 2e27 290a 2020  {room_id}".').  
-00015880: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
-00015890: 6420 3d20 6177 6169 7420 6d61 705f 726f  d = await map_ro
-000158a0: 6f6d 696e 666f 5f74 6f5f 726f 6f6d 6964  ominfo_to_roomid
-000158b0: 2863 6c69 656e 742c 2072 6f6f 6d5f 6964  (client, room_id
-000158c0: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-000158d0: 2e6c 6f67 2e64 6562 7567 2866 2742 616e  .log.debug(f'Ban
-000158e0: 6e69 6e67 2074 6f20 726f 6f6d 2022 7b72  ning to room "{r
-000158f0: 6f6f 6d5f 6964 7d22 2e27 290a 2020 2020  oom_id}".').    
-00015900: 2020 2020 2020 2020 666f 7220 7573 6572          for user
-00015910: 2069 6e20 7573 6572 733a 0a20 2020 2020   in users:.     
-00015920: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00015930: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-00015940: 2020 2020 2020 2020 2020 2020 2066 2742               f'B
-00015950: 616e 6e69 6e67 2075 7365 7220 227b 7573  anning user "{us
-00015960: 6572 7d22 2066 726f 6d20 726f 6f6d 2077  er}" from room w
-00015970: 6974 6820 270a 2020 2020 2020 2020 2020  ith '.          
-00015980: 2020 2020 2020 2020 2020 6627 726f 6f6d            f'room
-00015990: 2061 6c69 6173 2022 7b72 6f6f 6d5f 6964   alias "{room_id
-000159a0: 7d22 2e27 0a20 2020 2020 2020 2020 2020  }".'.           
-000159b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000159c0: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-000159d0: 6169 7420 636c 6965 6e74 2e72 6f6f 6d5f  ait client.room_
-000159e0: 6261 6e28 726f 6f6d 5f69 642c 2075 7365  ban(room_id, use
-000159f0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00015a00: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00015a10: 2872 6573 702c 2052 6f6f 6d42 616e 4572  (resp, RoomBanEr
-00015a20: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00015a30: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00015a40: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-00015a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a60: 2245 3133 373a 2022 0a20 2020 2020 2020  "E137: ".       
-00015a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a80: 2066 2272 6f6f 6d5f 6261 6e20 6661 696c   f"room_ban fail
-00015a90: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
-00015aa0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-00015ab0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
-00015ac0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00015ad0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00015ae0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00015af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00015b10: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00015b20: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
-00015b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b40: 6627 5573 6572 2022 7b75 7365 727d 2220  f'User "{user}" 
-00015b50: 7761 7320 7375 6363 6573 7366 756c 6c79  was successfully
-00015b60: 2062 616e 6e65 6420 270a 2020 2020 2020   banned '.      
-00015b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b80: 2020 6627 6672 6f6d 2072 6f6f 6d20 227b    f'from room "{
-00015b90: 726f 6f6d 5f69 647d 222e 270a 2020 2020  room_id}".'.    
-00015ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bb0: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-00015bc0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00015bd0: 6773 2e6c 6f67 2e65 7272 6f72 2822 4531  gs.log.error("E1
-00015be0: 3338 3a20 2220 2255 7365 7220 6261 6e20  38: " "User ban 
-00015bf0: 6661 696c 6564 2e20 536f 7272 792e 2229  failed. Sorry.")
-00015c00: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00015c10: 6465 6275 6728 2248 6572 6520 6973 2074  debug("Here is t
-00015c20: 6865 2074 7261 6365 6261 636b 2e5c 6e22  he traceback.\n"
-00015c30: 202b 2074 7261 6365 6261 636b 2e66 6f72   + traceback.for
-00015c40: 6d61 745f 6578 6328 2929 0a0a 0a61 7379  mat_exc())...asy
-00015c50: 6e63 2064 6566 2061 6374 696f 6e5f 726f  nc def action_ro
-00015c60: 6f6d 5f75 6e62 616e 2863 6c69 656e 742c  om_unban(client,
-00015c70: 2063 7265 6465 6e74 6961 6c73 293a 0a20   credentials):. 
-00015c80: 2020 2022 2222 556e 6261 6e20 6f6e 6520     """Unban one 
-00015c90: 6f72 206d 756c 7469 706c 6520 7573 6572  or multiple user
-00015ca0: 7320 6672 6f6d 206f 6e65 206f 7220 6d75  s from one or mu
-00015cb0: 6c74 6970 6c65 2072 6f6f 6d73 2e22 2222  ltiple rooms."""
-00015cc0: 0a20 2020 2072 6f6f 6d73 203d 2067 732e  .    rooms = gs.
-00015cd0: 7061 2e72 6f6f 6d5f 756e 6261 6e0a 2020  pa.room_unban.  
-00015ce0: 2020 7573 6572 7320 3d20 6773 2e70 612e    users = gs.pa.
-00015cf0: 7573 6572 0a20 2020 2074 7279 3a0a 2020  user.    try:.  
-00015d00: 2020 2020 2020 666f 7220 726f 6f6d 5f69        for room_i
-00015d10: 6420 696e 2072 6f6f 6d73 3a0a 2020 2020  d in rooms:.    
-00015d20: 2020 2020 2020 2020 2320 726f 6f6d 5f69          # room_i
-00015d30: 6420 6361 6e20 6265 2023 726f 6f6d 416c  d can be #roomAl
-00015d40: 6961 7320 6f72 2021 726f 6f6d 4964 0a20  ias or !roomId. 
-00015d50: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00015d60: 672e 6465 6275 6728 6627 5072 6570 6172  g.debug(f'Prepar
-00015d70: 696e 6720 746f 2075 6e62 616e 2069 6e20  ing to unban in 
-00015d80: 726f 6f6d 2022 7b72 6f6f 6d5f 6964 7d22  room "{room_id}"
-00015d90: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-00015da0: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
-00015db0: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
-00015dc0: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
-00015dd0: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
-00015de0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00015df0: 2866 2755 6e62 616e 6e69 6e67 2074 6f20  (f'Unbanning to 
-00015e00: 726f 6f6d 2022 7b72 6f6f 6d5f 6964 7d22  room "{room_id}"
-00015e10: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-00015e20: 666f 7220 7573 6572 2069 6e20 7573 6572  for user in user
-00015e30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00015e40: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00015e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015e60: 2020 2020 2066 2755 6e62 616e 6e69 6e67       f'Unbanning
-00015e70: 2075 7365 7220 227b 7573 6572 7d22 2066   user "{user}" f
-00015e80: 726f 6d20 726f 6f6d 2077 6974 6820 270a  rom room with '.
-00015e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ea0: 2020 2020 6627 726f 6f6d 2061 6c69 6173      f'room alias
-00015eb0: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 0a20   "{room_id}".'. 
-00015ec0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00015ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ee0: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
-00015ef0: 6965 6e74 2e72 6f6f 6d5f 756e 6261 6e28  ient.room_unban(
-00015f00: 726f 6f6d 5f69 642c 2075 7365 7229 0a20  room_id, user). 
-00015f10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015f20: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-00015f30: 702c 2052 6f6f 6d55 6e62 616e 4572 726f  p, RoomUnbanErro
-00015f40: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00015f50: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00015f60: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00015f70: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00015f80: 3133 393a 2022 0a20 2020 2020 2020 2020  139: ".         
-00015f90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00015fa0: 2272 6f6f 6d5f 756e 6261 6e20 6661 696c  "room_unban fail
-00015fb0: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
-00015fc0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-00015fd0: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
-00015fe0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00015ff0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00016000: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00016010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016020: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00016030: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00016040: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
-00016050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016060: 6627 5573 6572 2022 7b75 7365 727d 2220  f'User "{user}" 
-00016070: 7761 7320 7375 6363 6573 7366 756c 6c79  was successfully
-00016080: 2075 6e62 616e 6e65 6420 270a 2020 2020   unbanned '.    
-00016090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160a0: 2020 2020 6627 6672 6f6d 2072 6f6f 6d20      f'from room 
-000160b0: 227b 726f 6f6d 5f69 647d 222e 270a 2020  "{room_id}".'.  
-000160c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160d0: 2020 290a 2020 2020 6578 6365 7074 2045    ).    except E
-000160e0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-000160f0: 2020 6773 2e6c 6f67 2e65 7272 6f72 2822    gs.log.error("
-00016100: 4531 3430 3a20 2220 2255 7365 7220 756e  E140: " "User un
-00016110: 6261 6e20 6661 696c 6564 2e20 536f 7272  ban failed. Sorr
-00016120: 792e 2229 0a20 2020 2020 2020 2067 732e  y.").        gs.
-00016130: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-00016140: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00016150: 6275 6728 2248 6572 6520 6973 2074 6865  bug("Here is the
-00016160: 2074 7261 6365 6261 636b 2e5c 6e22 202b   traceback.\n" +
-00016170: 2074 7261 6365 6261 636b 2e66 6f72 6d61   traceback.forma
-00016180: 745f 6578 6328 2929 0a0a 0a61 7379 6e63  t_exc())...async
-00016190: 2064 6566 2061 6374 696f 6e5f 726f 6f6d   def action_room
-000161a0: 5f6b 6963 6b28 636c 6965 6e74 2c20 6372  _kick(client, cr
-000161b0: 6564 656e 7469 616c 7329 3a0a 2020 2020  edentials):.    
-000161c0: 2222 224b 6963 6b20 6f6e 6520 6f72 206d  """Kick one or m
-000161d0: 756c 7469 706c 6520 7573 6572 7320 6672  ultiple users fr
-000161e0: 6f6d 206f 6e65 206f 7220 6d75 6c74 6970  om one or multip
-000161f0: 6c65 2072 6f6f 6d73 2e22 2222 0a20 2020  le rooms.""".   
-00016200: 2072 6f6f 6d73 203d 2067 732e 7061 2e72   rooms = gs.pa.r
-00016210: 6f6f 6d5f 6b69 636b 0a20 2020 2075 7365  oom_kick.    use
-00016220: 7273 203d 2067 732e 7061 2e75 7365 720a  rs = gs.pa.user.
-00016230: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00016240: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
-00016250: 726f 6f6d 733a 0a20 2020 2020 2020 2020  rooms:.         
-00016260: 2020 2023 2072 6f6f 6d5f 6964 2063 616e     # room_id can
-00016270: 2062 6520 2372 6f6f 6d41 6c69 6173 206f   be #roomAlias o
-00016280: 7220 2172 6f6f 6d49 640a 2020 2020 2020  r !roomId.      
-00016290: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-000162a0: 7567 2866 2750 7265 7061 7269 6e67 2074  ug(f'Preparing t
-000162b0: 6f20 6b69 636b 696e 6720 6f66 6620 726f  o kicking off ro
-000162c0: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e27  om "{room_id}".'
-000162d0: 290a 2020 2020 2020 2020 2020 2020 726f  ).            ro
-000162e0: 6f6d 5f69 6420 3d20 6177 6169 7420 6d61  om_id = await ma
-000162f0: 705f 726f 6f6d 696e 666f 5f74 6f5f 726f  p_roominfo_to_ro
-00016300: 6f6d 6964 2863 6c69 656e 742c 2072 6f6f  omid(client, roo
-00016310: 6d5f 6964 290a 2020 2020 2020 2020 2020  m_id).          
-00016320: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00016330: 274b 6963 6b69 6e67 206f 6666 2072 6f6f  'Kicking off roo
-00016340: 6d20 227b 726f 6f6d 5f69 647d 222e 2729  m "{room_id}".')
-00016350: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00016360: 2075 7365 7220 696e 2075 7365 7273 3a0a   user in users:.
-00016370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016380: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-00016390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163a0: 2020 6627 4b69 636b 696e 6720 7573 6572    f'Kicking user
-000163b0: 2022 7b75 7365 727d 2220 6672 6f6d 2072   "{user}" from r
-000163c0: 6f6f 6d20 7769 7468 2027 0a20 2020 2020  oom with '.     
-000163d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000163e0: 2772 6f6f 6d20 616c 6961 7320 227b 726f  'room alias "{ro
-000163f0: 6f6d 5f69 647d 222e 270a 2020 2020 2020  om_id}".'.      
-00016400: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00016410: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-00016420: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-00016430: 726f 6f6d 5f6b 6963 6b28 726f 6f6d 5f69  room_kick(room_i
-00016440: 642c 2075 7365 7229 0a20 2020 2020 2020  d, user).       
-00016450: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00016460: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
-00016470: 6d4b 6963 6b45 7272 6f72 293a 0a20 2020  mKickError):.   
-00016480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016490: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-000164a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164b0: 2020 2020 2020 2022 4531 3431 3a20 220a         "E141: ".
-000164c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164d0: 2020 2020 2020 2020 6622 726f 6f6d 5f6b          f"room_k
-000164e0: 6963 6b20 6661 696c 6564 2077 6974 6820  ick failed with 
-000164f0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-00016500: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-00016510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016520: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00016530: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-00016540: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00016550: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00016560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016570: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
-00016580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016590: 2020 2020 2020 2020 6627 5573 6572 2022          f'User "
-000165a0: 7b75 7365 727d 2220 7761 7320 7375 6363  {user}" was succ
-000165b0: 6573 7366 756c 6c79 206b 6963 6b65 6420  essfully kicked 
-000165c0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000165d0: 2020 2020 2020 2020 2020 6627 6672 6f6d            f'from
-000165e0: 2072 6f6f 6d20 227b 726f 6f6d 5f69 647d   room "{room_id}
-000165f0: 222e 270a 2020 2020 2020 2020 2020 2020  ".'.            
-00016600: 2020 2020 2020 2020 290a 2020 2020 6578          ).    ex
-00016610: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-00016620: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00016630: 7272 6f72 2822 4531 3432 3a20 2220 2255  rror("E142: " "U
-00016640: 7365 7220 6b69 636b 2066 6169 6c65 642e  ser kick failed.
-00016650: 2053 6f72 7279 2e22 290a 2020 2020 2020   Sorry.").      
-00016660: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00016670: 3d20 310a 2020 2020 2020 2020 6773 2e6c  = 1.        gs.l
-00016680: 6f67 2e64 6562 7567 2822 4865 7265 2069  og.debug("Here i
-00016690: 7320 7468 6520 7472 6163 6562 6163 6b2e  s the traceback.
-000166a0: 5c6e 2220 2b20 7472 6163 6562 6163 6b2e  \n" + traceback.
-000166b0: 666f 726d 6174 5f65 7863 2829 290a 0a0a  format_exc())...
-000166c0: 2320 6163 636f 7264 696e 6720 746f 206c  # according to l
-000166d0: 696e 7465 723a 2066 756e 6374 696f 6e20  inter: function 
-000166e0: 6973 2074 6f6f 2063 6f6d 706c 6578 2c20  is too complex, 
-000166f0: 4339 3031 0a61 7379 6e63 2064 6566 2073  C901.async def s
-00016700: 656e 645f 6576 656e 7428 636c 6965 6e74  end_event(client
-00016710: 2c20 726f 6f6d 732c 2065 7665 6e74 293a  , rooms, event):
-00016720: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
-00016730: 2020 2022 2222 5072 6f63 6573 7320 6576     """Process ev
-00016740: 656e 742e 0a0a 2020 2020 4172 6775 6d65  ent...    Argume
-00016750: 6e74 733a 0a20 2020 202d 2d2d 2d2d 2d2d  nts:.    -------
-00016760: 2d2d 0a20 2020 2063 6c69 656e 7420 3a20  --.    client : 
-00016770: 436c 6965 6e74 0a20 2020 2072 6f6f 6d73  Client.    rooms
-00016780: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-00016790: 6c69 7374 206f 6620 726f 6f6d 5f69 642d  list of room_id-
-000167a0: 730a 2020 2020 6576 656e 7420 3a20 7374  s.    event : st
-000167b0: 720a 2020 2020 2020 2020 6669 6c65 206e  r.        file n
-000167c0: 616d 6520 6f66 2065 7665 6e74 2066 726f  ame of event fro
-000167d0: 6d20 2d2d 6576 656e 7420 6172 6775 6d65  m --event argume
-000167e0: 6e74 0a0a 2020 2020 2222 220a 2020 2020  nt..    """.    
-000167f0: 6966 206e 6f74 2072 6f6f 6d73 3a0a 2020  if not rooms:.  
-00016800: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
-00016810: 6f28 0a20 2020 2020 2020 2020 2020 2022  o(.            "
-00016820: 4e6f 2072 6f6f 6d73 2061 7265 2067 6976  No rooms are giv
-00016830: 656e 2e20 5468 6973 2073 686f 756c 6420  en. This should 
-00016840: 6e6f 7420 6861 7070 656e 2e20 220a 2020  not happen. ".  
-00016850: 2020 2020 2020 2020 2020 224d 6179 6265            "Maybe
-00016860: 2079 6f75 7220 444d 2072 6f6f 6d73 2073   your DM rooms s
-00016870: 7065 6369 6669 6564 2076 6961 202d 2d75  pecified via --u
-00016880: 7365 7220 7765 7265 206e 6f74 2066 6f75  ser were not fou
-00016890: 6e64 2e20 220a 2020 2020 2020 2020 2020  nd. ".          
-000168a0: 2020 2254 6869 7320 6669 6c65 2069 7320    "This file is 
-000168b0: 6265 696e 6720 6472 6f70 7065 6420 616e  being dropped an
-000168c0: 6420 4e4f 5420 7365 6e74 2e22 0a20 2020  d NOT sent.".   
-000168d0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-000168e0: 6574 7572 6e0a 0a20 2020 2069 6620 6576  eturn..    if ev
-000168f0: 656e 7420 3d3d 2022 2d22 3a20 2023 202d  ent == "-":  # -
-00016900: 206d 6561 6e73 2072 6561 6420 6173 2070   means read as p
-00016910: 6970 6520 6672 6f6d 2073 7464 696e 0a20  ipe from stdin. 
-00016920: 2020 2020 2020 206a 736f 6e64 6174 6120         jsondata 
-00016930: 3d20 7379 732e 7374 6469 6e2e 6275 6666  = sys.stdin.buff
-00016940: 6572 2e72 6561 6428 292e 6465 636f 6465  er.read().decode
-00016950: 2829 2020 2320 6269 6e61 7279 2072 6561  ()  # binary rea
-00016960: 640a 2020 2020 656c 7365 3a0a 2020 2020  d.    else:.    
-00016970: 2020 2020 7769 7468 206f 7065 6e28 6576      with open(ev
-00016980: 656e 742c 2022 7222 2920 6173 2066 696c  ent, "r") as fil
-00016990: 653a 0a20 2020 2020 2020 2020 2020 206a  e:.            j
-000169a0: 736f 6e64 6174 6120 3d20 6669 6c65 2e72  sondata = file.r
-000169b0: 6561 6428 290a 2020 2020 6773 2e6c 6f67  ead().    gs.log
-000169c0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-000169d0: 6622 7b6c 656e 286a 736f 6e64 6174 6129  f"{len(jsondata)
-000169e0: 7d20 6279 7465 7320 6f66 2065 7665 6e74  } bytes of event
-000169f0: 2064 6174 6120 7265 6164 2066 726f 6d20   data read from 
-00016a00: 6669 6c65 207b 6576 656e 747d 2e22 0a20  file {event}.". 
-00016a10: 2020 2029 0a20 2020 2067 732e 6c6f 672e     ).    gs.log.
-00016a20: 6465 6275 6728 6622 4576 656e 7420 7b65  debug(f"Event {e
-00016a30: 7665 6e74 7d20 636f 6e74 6169 6e73 2074  vent} contains t
-00016a40: 6869 7320 4a53 4f4e 2064 6174 613a 207b  his JSON data: {
-00016a50: 6a73 6f6e 6461 7461 7d22 290a 0a20 2020  jsondata}")..   
-00016a60: 2069 6620 6e6f 7420 6a73 6f6e 6461 7461   if not jsondata
-00016a70: 2e73 7472 6970 2829 3a0a 2020 2020 2020  .strip():.      
-00016a80: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-00016a90: 2020 2020 2020 2020 2020 2020 2245 7665              "Eve
-00016aa0: 6e74 2069 7320 656d 7074 792e 2054 6869  nt is empty. Thi
-00016ab0: 7320 6576 656e 7420 6973 2062 6569 6e67  s event is being
-00016ac0: 2064 726f 7070 6564 2061 6e64 204e 4f54   dropped and NOT
-00016ad0: 2073 656e 742e 220a 2020 2020 2020 2020   sent.".        
-00016ae0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00016af0: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-00016b00: 2020 2063 6f6e 7465 6e74 5f6a 736f 6e20     content_json 
-00016b10: 3d20 6a73 6f6e 2e6c 6f61 6473 286a 736f  = json.loads(jso
-00016b20: 6e64 6174 6129 0a20 2020 2020 2020 206d  ndata).        m
-00016b30: 6573 7361 6765 5f74 7970 6520 3d20 636f  essage_type = co
-00016b40: 6e74 656e 745f 6a73 6f6e 5b22 7479 7065  ntent_json["type
-00016b50: 225d 0a20 2020 2020 2020 2063 6f6e 7465  "].        conte
-00016b60: 6e74 203d 2063 6f6e 7465 6e74 5f6a 736f  nt = content_jso
-00016b70: 6e5b 2263 6f6e 7465 6e74 225d 0a20 2020  n["content"].   
-00016b80: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00016b90: 6e3a 0a20 2020 2020 2020 2067 732e 6c6f  n:.        gs.lo
-00016ba0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00016bb0: 2020 2020 2022 4531 3433 3a20 220a 2020       "E143: ".  
-00016bc0: 2020 2020 2020 2020 2020 2245 7665 6e74            "Event
-00016bd0: 2069 7320 6e6f 7420 6120 7661 6c69 6420   is not a valid 
-00016be0: 4a53 4f4e 206f 626a 6563 7420 6f72 206e  JSON object or n
-00016bf0: 6f74 206f 6620 4d61 7472 6978 204a 534f  ot of Matrix JSO
-00016c00: 4e20 666f 726d 6174 2e20 220a 2020 2020  N format. ".    
-00016c10: 2020 2020 2020 2020 2254 6869 7320 6576          "This ev
-00016c20: 656e 7420 6973 2062 6569 6e67 2064 726f  ent is being dro
-00016c30: 7070 6564 2061 6e64 204e 4f54 2073 656e  pped and NOT sen
-00016c40: 742e 220a 2020 2020 2020 2020 290a 2020  t.".        ).  
-00016c50: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00016c60: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-00016c70: 6773 2e6c 6f67 2e64 6562 7567 2822 4865  gs.log.debug("He
-00016c80: 7265 2069 7320 7468 6520 7472 6163 6562  re is the traceb
-00016c90: 6163 6b2e 5c6e 2220 2b20 7472 6163 6562  ack.\n" + traceb
-00016ca0: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
-00016cb0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00016cc0: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-00016cd0: 2020 2066 6f72 2072 6f6f 6d5f 6964 2069     for room_id i
-00016ce0: 6e20 726f 6f6d 733a 0a20 2020 2020 2020  n rooms:.       
-00016cf0: 2020 2020 2072 6f6f 6d5f 6964 203d 2061       room_id = a
-00016d00: 7761 6974 206d 6170 5f72 6f6f 6d69 6e66  wait map_roominf
-00016d10: 6f5f 746f 5f72 6f6f 6d69 6428 636c 6965  o_to_roomid(clie
-00016d20: 6e74 2c20 726f 6f6d 5f69 6429 0a20 2020  nt, room_id).   
-00016d30: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
-00016d40: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
-00016d50: 6d5f 7365 6e64 280a 2020 2020 2020 2020  m_send(.        
-00016d60: 2020 2020 2020 2020 726f 6f6d 5f69 642c          room_id,
-00016d70: 206d 6573 7361 6765 5f74 7970 653d 6d65   message_type=me
-00016d80: 7373 6167 655f 7479 7065 2c20 636f 6e74  ssage_type, cont
-00016d90: 656e 743d 636f 6e74 656e 740a 2020 2020  ent=content.    
-00016da0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00016db0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00016dc0: 6e63 6528 7265 7370 2c20 526f 6f6d 5365  nce(resp, RoomSe
-00016dd0: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
-00016de0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00016df0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-00016e00: 2020 2020 2020 2020 2020 2020 2245 3134              "E14
-00016e10: 343a 2022 0a20 2020 2020 2020 2020 2020  4: ".           
-00016e20: 2020 2020 2020 2020 2022 726f 6f6d 5f73           "room_s
-00016e30: 656e 6420 6661 696c 6564 2077 6974 6820  end failed with 
-00016e40: 6572 726f 7220 220a 2020 2020 2020 2020  error ".        
-00016e50: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
-00016e60: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-00016e70: 7472 2872 6573 7029 297d 272e 220a 2020  tr(resp))}'.".  
-00016e80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00016e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ea0: 2320 6773 2e65 7272 5f63 6f75 6e74 202b  # gs.err_count +
-00016eb0: 3d20 3120 2320 6e6f 7420 6e65 6564 6564  = 1 # not needed
-00016ec0: 2c20 7769 6c6c 2072 6169 7365 2065 7863  , will raise exc
-00016ed0: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
-00016ee0: 2020 2020 2020 2023 2069 6e20 666f 6c6c         # in foll
-00016ef0: 6f77 696e 6720 6c69 6e65 206f 6620 636f  owing line of co
-00016f00: 6465 0a20 2020 2020 2020 2020 2020 2067  de.            g
-00016f10: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
-00016f20: 2020 2020 2020 2020 2020 2020 6627 5468              f'Th
-00016f30: 6973 2065 7665 6e74 2077 6173 2073 656e  is event was sen
-00016f40: 743a 2022 7b65 7665 6e74 7d22 2074 6f20  t: "{event}" to 
-00016f50: 726f 6f6d 2022 7b72 6573 702e 726f 6f6d  room "{resp.room
-00016f60: 5f69 647d 2220 270a 2020 2020 2020 2020  _id}" '.        
-00016f70: 2020 2020 2020 2020 6627 6173 2065 7665          f'as eve
-00016f80: 6e74 2022 7b72 6573 702e 6576 656e 745f  nt "{resp.event_
-00016f90: 6964 7d22 2e27 0a20 2020 2020 2020 2020  id}".'.         
-00016fa0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00016fb0: 2069 6620 6773 2e70 612e 7072 696e 745f   if gs.pa.print_
-00016fc0: 6576 656e 745f 6964 3a0a 2020 2020 2020  event_id:.      
-00016fd0: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
-00016fe0: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
-00016ff0: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
-00017000: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
-00017010: 2020 2020 2020 2074 6578 7420 3d20 6622         text = f"
-00017020: 7b72 6573 702e 6576 656e 745f 6964 7d7b  {resp.event_id}{
-00017030: 5345 507d 7b72 6573 702e 726f 6f6d 5f69  SEP}{resp.room_i
-00017040: 647d 7b53 4550 7d7b 6576 656e 747d 220a  d}{SEP}{event}".
-00017050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017060: 2320 4f62 6a65 6374 206f 6620 7479 7065  # Object of type
-00017070: 2052 6f6f 6d43 7265 6174 6552 6573 706f   RoomCreateRespo
-00017080: 6e73 6520 6973 206e 6f74 204a 534f 4e0a  nse is not JSON.
-00017090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170a0: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
-000170b0: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
-000170c0: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
-000170d0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-000170e0: 6e5f 6d61 7820 3d20 7265 7370 2e5f 5f64  n_max = resp.__d
-000170f0: 6963 745f 5f0a 2020 2020 2020 2020 2020  ict__.          
-00017100: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
-00017110: 7064 6174 6528 7b22 6576 656e 7422 3a20  pdate({"event": 
-00017120: 6576 656e 747d 2920 2023 2061 6464 2064  event})  # add d
-00017130: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
-00017140: 2020 2020 2020 2020 2020 6a73 6f6e 5f20            json_ 
-00017150: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
-00017160: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00017170: 2020 6a73 6f6e 5f2e 706f 7028 2274 7261    json_.pop("tra
-00017180: 6e73 706f 7274 5f72 6573 706f 6e73 6522  nsport_response"
-00017190: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000171a0: 2020 6a73 6f6e 5f73 7065 6320 3d20 4e6f    json_spec = No
-000171b0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-000171c0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
-000171d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000171e0: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
-000171f0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00017200: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
-00017210: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017220: 2020 2020 2020 6a73 6f6e 5f3d 6a73 6f6e        json_=json
-00017230: 5f2c 0a20 2020 2020 2020 2020 2020 2020  _,.             
-00017240: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
-00017250: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
-00017260: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00017270: 6f6e 5f73 7065 633d 6a73 6f6e 5f73 7065  on_spec=json_spe
-00017280: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-00017290: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000172a0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-000172b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000172c0: 2754 6869 7320 6576 656e 7420 7761 7320  'This event was 
-000172d0: 7365 6e74 3a20 227b 6576 656e 747d 2220  sent: "{event}" 
-000172e0: 287b 636f 6e74 656e 747d 2920 270a 2020  ({content}) '.  
-000172f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00017300: 746f 2072 6f6f 6d20 227b 726f 6f6d 5f69  to room "{room_i
-00017310: 647d 222e 2027 0a20 2020 2020 2020 2020  d}". '.         
-00017320: 2020 2020 2020 2066 2252 6573 706f 6e73         f"Respons
-00017330: 653a 2065 7665 6e74 5f69 643d 7b72 6573  e: event_id={res
-00017340: 702e 6576 656e 745f 6964 7d2c 2072 6f6f  p.event_id}, roo
-00017350: 6d5f 6964 3d7b 7265 7370 2e72 6f6f 6d5f  m_id={resp.room_
-00017360: 6964 7d2c 2022 0a20 2020 2020 2020 2020  id}, ".         
-00017370: 2020 2020 2020 2066 2266 756c 6c20 7265         f"full re
-00017380: 7370 6f6e 7365 3a20 7b70 7269 7661 6379  sponse: {privacy
-00017390: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-000173a0: 2929 7d2e 2022 0a20 2020 2020 2020 2020  ))}. ".         
-000173b0: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
-000173c0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-000173d0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-000173e0: 2245 3134 353a 2022 2066 2245 7665 6e74  "E145: " f"Event
-000173f0: 2073 656e 6420 6f66 2066 696c 6520 7b65   send of file {e
-00017400: 7665 6e74 7d20 6661 696c 6564 2e20 536f  vent} failed. So
-00017410: 7272 792e 2229 0a20 2020 2020 2020 2067  rry.").        g
-00017420: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00017430: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00017440: 6465 6275 6728 2248 6572 6520 6973 2074  debug("Here is t
-00017450: 6865 2074 7261 6365 6261 636b 2e5c 6e22  he traceback.\n"
-00017460: 202b 2074 7261 6365 6261 636b 2e66 6f72   + traceback.for
-00017470: 6d61 745f 6578 6328 2929 0a0a 0a23 2061  mat_exc())...# a
-00017480: 6363 6f72 6469 6e67 2074 6f20 6c69 6e74  ccording to lint
-00017490: 6572 3a20 6675 6e63 7469 6f6e 2069 7320  er: function is 
-000174a0: 746f 6f20 636f 6d70 6c65 782c 2043 3930  too complex, C90
-000174b0: 310a 6173 796e 6320 6465 6620 7365 6e64  1.async def send
-000174c0: 5f66 696c 6528 636c 6965 6e74 2c20 726f  _file(client, ro
-000174d0: 6f6d 732c 2066 696c 6529 3a20 2023 206e  oms, file):  # n
-000174e0: 6f71 613a 2043 3930 310a 2020 2020 2222  oqa: C901.    ""
-000174f0: 2250 726f 6365 7373 2066 696c 652e 0a0a  "Process file...
-00017500: 2020 2020 5570 6c6f 6164 2066 696c 6520      Upload file 
-00017510: 746f 2073 6572 7665 7220 616e 6420 7468  to server and th
-00017520: 656e 2073 656e 6420 6c69 6e6b 2074 6f20  en send link to 
-00017530: 726f 6f6d 732e 0a20 2020 2057 6f72 6b73  rooms..    Works
-00017540: 2061 6e64 2074 6573 7465 6420 666f 7220   and tested for 
-00017550: 2e70 6466 2c20 2e74 7874 2c20 2e6f 6767  .pdf, .txt, .ogg
-00017560: 2c20 2e77 6176 2e0a 2020 2020 416c 6c20  , .wav..    All 
-00017570: 7468 6573 6520 6669 6c65 2074 7970 6573  these file types
-00017580: 2061 7265 2074 7265 6174 6564 2074 6865   are treated the
-00017590: 2073 616d 652e 0a0a 2020 2020 446f 206e   same...    Do n
-000175a0: 6f74 2075 7365 2074 6869 7320 6675 6e63  ot use this func
-000175b0: 7469 6f6e 2066 6f72 2069 6d61 6765 732e  tion for images.
-000175c0: 0a20 2020 2055 7365 2074 6865 2073 656e  .    Use the sen
-000175d0: 645f 696d 6167 6528 2920 6675 6e63 7469  d_image() functi
-000175e0: 6f6e 2066 6f72 2069 6d61 6765 732e 0a0a  on for images...
-000175f0: 2020 2020 4d61 7472 6978 2068 6173 2074      Matrix has t
-00017600: 7970 6573 2066 6f72 2061 7564 696f 2061  ypes for audio a
-00017610: 6e64 2076 6964 656f 2028 616e 6420 696d  nd video (and im
-00017620: 6167 6520 616e 6420 6669 6c65 292e 0a20  age and file).. 
-00017630: 2020 2053 6565 3a20 226d 7367 7479 7065     See: "msgtype
-00017640: 2220 3d3d 2022 6d2e 696d 6167 6522 2c20  " == "m.image", 
-00017650: 6d2e 6175 6469 6f2c 206d 2e76 6964 656f  m.audio, m.video
-00017660: 2c20 6d2e 6669 6c65 0a0a 2020 2020 4172  , m.file..    Ar
-00017670: 6775 6d65 6e74 733a 0a20 2020 202d 2d2d  guments:.    ---
-00017680: 2d2d 2d2d 2d2d 0a20 2020 2063 6c69 656e  ------.    clien
-00017690: 7420 3a20 436c 6965 6e74 0a20 2020 2072  t : Client.    r
-000176a0: 6f6f 6d73 203a 206c 6973 740a 2020 2020  ooms : list.    
-000176b0: 2020 2020 6c69 7374 206f 6620 726f 6f6d      list of room
-000176c0: 5f69 642d 730a 2020 2020 6669 6c65 203a  _id-s.    file :
-000176d0: 2073 7472 0a20 2020 2020 2020 2066 696c   str.        fil
-000176e0: 6520 6e61 6d65 206f 6620 6669 6c65 2066  e name of file f
-000176f0: 726f 6d20 2d2d 6669 6c65 2061 7267 756d  rom --file argum
-00017700: 656e 740a 0a20 2020 2054 6869 7320 6973  ent..    This is
-00017710: 2061 2077 6f72 6b69 6e67 2065 7861 6d70   a working examp
-00017720: 6c65 2066 6f72 2061 2050 4446 2066 696c  le for a PDF fil
-00017730: 652e 0a20 2020 2049 7420 6361 6e20 6265  e..    It can be
-00017740: 2076 6965 7765 6420 6f72 2064 6f77 6e6c   viewed or downl
-00017750: 6f61 6465 6420 6672 6f6d 3a0a 2020 2020  oaded from:.    
-00017760: 6874 7470 733a 2f2f 6d61 7472 6978 2e65  https://matrix.e
-00017770: 7861 6d70 6c65 2e63 6f6d 2f5f 6d61 7472  xample.com/_matr
-00017780: 6978 2f6d 6564 6961 2f72 302f 646f 776e  ix/media/r0/down
-00017790: 6c6f 6164 2f0a 2020 2020 2020 2020 6578  load/.        ex
-000177a0: 616d 706c 652e 636f 6d2f 536f 6d65 5374  ample.com/SomeSt
-000177b0: 7261 6e67 6555 7269 4b65 790a 2020 2020  rangeUriKey.    
-000177c0: 7b0a 2020 2020 2020 2020 2274 7970 6522  {.        "type"
-000177d0: 3a20 226d 2e72 6f6f 6d2e 6d65 7373 6167  : "m.room.messag
-000177e0: 6522 2c0a 2020 2020 2020 2020 2273 656e  e",.        "sen
-000177f0: 6465 7222 3a20 2240 736f 6d65 7573 6572  der": "@someuser
-00017800: 3a65 7861 6d70 6c65 2e63 6f6d 222c 0a20  :example.com",. 
-00017810: 2020 2020 2020 2022 636f 6e74 656e 7422         "content"
-00017820: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00017830: 2262 6f64 7922 3a20 2265 7861 6d70 6c65  "body": "example
-00017840: 2e70 6466 222c 0a20 2020 2020 2020 2020  .pdf",.         
-00017850: 2020 2022 696e 666f 223a 207b 0a20 2020     "info": {.   
-00017860: 2020 2020 2020 2020 2020 2020 2022 7369               "si
-00017870: 7a65 223a 2036 3330 3132 3334 2c0a 2020  ze": 6301234,.  
-00017880: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00017890: 696d 6574 7970 6522 3a20 2261 7070 6c69  imetype": "appli
-000178a0: 6361 7469 6f6e 2f70 6466 220a 2020 2020  cation/pdf".    
-000178b0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-000178c0: 2020 2020 2020 2020 2020 2022 6d73 6774             "msgt
-000178d0: 7970 6522 3a20 226d 2e66 696c 6522 2c0a  ype": "m.file",.
-000178e0: 2020 2020 2020 2020 2020 2020 2275 726c              "url
-000178f0: 223a 2022 6d78 633a 2f2f 6578 616d 706c  ": "mxc://exampl
-00017900: 652e 636f 6d2f 536f 6d65 5374 7261 6e67  e.com/SomeStrang
-00017910: 6555 7269 4b65 7922 0a20 2020 2020 2020  eUriKey".       
-00017920: 207d 2c0a 2020 2020 2020 2020 226f 7269   },.        "ori
-00017930: 6769 6e5f 7365 7276 6572 5f74 7322 3a20  gin_server_ts": 
-00017940: 3135 3935 3130 3030 3030 3030 302c 0a20  1595100000000,. 
-00017950: 2020 2020 2020 2022 756e 7369 676e 6564         "unsigned
-00017960: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00017970: 2022 6167 6522 3a20 3130 3030 2c0a 2020   "age": 1000,.  
-00017980: 2020 2020 2020 2020 2020 2274 7261 6e73            "trans
-00017990: 6163 7469 6f6e 5f69 6422 3a20 2253 6f6d  action_id": "Som
-000179a0: 6554 7849 6430 3132 3334 3536 3722 0a20  eTxId01234567". 
-000179b0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000179c0: 2020 2265 7665 6e74 5f69 6422 3a20 2224    "event_id": "$
-000179d0: 536f 6d65 4576 656e 7449 6430 3132 3334  SomeEventId01234
-000179e0: 3536 3737 3839 4162 6364 6566 3031 3233  567789Abcdef0123
-000179f0: 3435 3637 3822 2c0a 2020 2020 2020 2020  45678",.        
-00017a00: 2272 6f6f 6d5f 6964 223a 2022 2153 6f6d  "room_id": "!Som
-00017a10: 6552 6f6f 6d49 643a 6578 616d 706c 652e  eRoomId:example.
-00017a20: 636f 6d22 0a20 2020 207d 0a0a 2020 2020  com".    }..    
-00017a30: 2222 220a 2020 2020 6966 206e 6f74 2072  """.    if not r
-00017a40: 6f6f 6d73 3a0a 2020 2020 2020 2020 6773  ooms:.        gs
-00017a50: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
-00017a60: 2020 2020 2020 2022 4e6f 2072 6f6f 6d73         "No rooms
-00017a70: 2061 7265 2067 6976 656e 2e20 5468 6973   are given. This
-00017a80: 2073 686f 756c 6420 6e6f 7420 6861 7070   should not happ
-00017a90: 656e 2e20 220a 2020 2020 2020 2020 2020  en. ".          
-00017aa0: 2020 224d 6179 6265 2079 6f75 7220 444d    "Maybe your DM
-00017ab0: 2072 6f6f 6d73 2073 7065 6369 6669 6564   rooms specified
-00017ac0: 2076 6961 202d 2d75 7365 7220 7765 7265   via --user were
-00017ad0: 206e 6f74 2066 6f75 6e64 2e20 220a 2020   not found. ".  
-00017ae0: 2020 2020 2020 2020 2020 2254 6869 7320            "This 
-00017af0: 6669 6c65 2069 7320 6265 696e 6720 6472  file is being dr
-00017b00: 6f70 7065 6420 616e 6420 4e4f 5420 7365  opped and NOT se
-00017b10: 6e74 2e22 0a20 2020 2020 2020 2029 0a20  nt.".        ). 
-00017b20: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00017b30: 2020 2023 2066 6f72 206d 6f72 6520 636f     # for more co
-00017b40: 6d6d 656e 7473 206f 6e20 686f 7720 746f  mments on how to
-00017b50: 2074 7265 6174 2070 6970 6520 6f6e 2073   treat pipe on s
-00017b60: 7464 696e 2070 6c65 6173 6520 7265 6164  tdin please read
-00017b70: 2074 6865 0a20 2020 2023 2063 6f6d 6d65   the.    # comme
-00017b80: 6e74 7320 696e 2073 656e 645f 696d 6167  nts in send_imag
-00017b90: 6528 290a 0a20 2020 2069 6620 6669 6c65  e()..    if file
-00017ba0: 203d 3d20 222d 223a 2020 2320 2d20 6d65   == "-":  # - me
-00017bb0: 616e 7320 7265 6164 2061 7320 7069 7065  ans read as pipe
-00017bc0: 2066 726f 6d20 7374 6469 6e0a 2020 2020   from stdin.    
-00017bd0: 2020 2020 6973 5069 7065 203d 2054 7275      isPipe = Tru
-00017be0: 650a 2020 2020 2020 2020 6669 6e5f 6275  e.        fin_bu
-00017bf0: 6620 3d20 7379 732e 7374 6469 6e2e 6275  f = sys.stdin.bu
-00017c00: 6666 6572 2e72 6561 6428 290a 2020 2020  ffer.read().    
-00017c10: 2020 2020 6c65 6e5f 6669 6e5f 6275 6620      len_fin_buf 
-00017c20: 3d20 6c65 6e28 6669 6e5f 6275 6629 0a20  = len(fin_buf). 
-00017c30: 2020 2020 2020 2066 696c 6520 3d20 226d         file = "m
-00017c40: 632d 2220 2b20 7374 7228 7575 6964 2e75  c-" + str(uuid.u
-00017c50: 7569 6434 2829 2920 2b20 222e 746d 7022  uid4()) + ".tmp"
-00017c60: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00017c70: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00017c80: 2020 2066 227b 6c65 6e5f 6669 6e5f 6275     f"{len_fin_bu
-00017c90: 667d 2062 7974 6573 206f 6620 6669 6c65  f} bytes of file
-00017ca0: 2064 6174 6120 7265 6164 2066 726f 6d20   data read from 
-00017cb0: 7374 6469 6e2e 2022 0a20 2020 2020 2020  stdin. ".       
-00017cc0: 2020 2020 2066 2754 656d 706f 7261 7279       f'Temporary
-00017cd0: 2066 696c 6520 227b 6669 6c65 7d22 2077   file "{file}" w
-00017ce0: 6173 2063 7265 6174 6564 2066 6f72 2066  as created for f
-00017cf0: 696c 652e 270a 2020 2020 2020 2020 290a  ile.'.        ).
-00017d00: 2020 2020 2020 2020 666f 7574 203d 206f          fout = o
-00017d10: 7065 6e28 6669 6c65 2c20 2277 6222 290a  pen(file, "wb").
-00017d20: 2020 2020 2020 2020 666f 7574 2e77 7269          fout.wri
-00017d30: 7465 2866 696e 5f62 7566 290a 2020 2020  te(fin_buf).    
-00017d40: 2020 2020 666f 7574 2e63 6c6f 7365 2829      fout.close()
-00017d50: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00017d60: 2020 2069 7350 6970 6520 3d20 4661 6c73     isPipe = Fals
-00017d70: 650a 0a20 2020 2069 6620 6e6f 7420 6f73  e..    if not os
-00017d80: 2e70 6174 682e 6973 6669 6c65 2866 696c  .path.isfile(fil
-00017d90: 6529 3a0a 2020 2020 2020 2020 6773 2e6c  e):.        gs.l
-00017da0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00017db0: 2020 2020 2020 6622 4669 6c65 207b 6669        f"File {fi
-00017dc0: 6c65 7d20 6973 206e 6f74 2061 2066 696c  le} is not a fil
-00017dd0: 652e 2044 6f65 736e 2774 2065 7869 7374  e. Doesn't exist
-00017de0: 206f 7220 220a 2020 2020 2020 2020 2020   or ".          
-00017df0: 2020 2269 7320 6120 6469 7265 6374 6f72    "is a director
-00017e00: 792e 2022 0a20 2020 2020 2020 2020 2020  y. ".           
-00017e10: 2022 5468 6973 2066 696c 6520 6973 2062   "This file is b
-00017e20: 6569 6e67 2064 726f 7070 6564 2061 6e64  eing dropped and
-00017e30: 204e 4f54 2073 656e 742e 220a 2020 2020   NOT sent.".    
-00017e40: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00017e50: 7475 726e 0a0a 2020 2020 2320 2320 7265  turn..    # # re
-00017e60: 7374 7269 6374 2074 6f20 2274 7874 222c  strict to "txt",
-00017e70: 2022 7064 6622 2c20 226d 7033 222c 2022   "pdf", "mp3", "
-00017e80: 6f67 6722 2c20 2277 6176 222c 202e 2e2e  ogg", "wav", ...
-00017e90: 0a20 2020 2023 2069 6620 6e6f 7420 7265  .    # if not re
-00017ea0: 2e6d 6174 6368 2822 5e2e 7064 6624 7c5e  .match("^.pdf$|^
-00017eb0: 2e74 7874 247c 5e2e 646f 6324 7c5e 2e78  .txt$|^.doc$|^.x
-00017ec0: 6c73 247c 5e2e 6d6f 6269 247c 5e2e 6d70  ls$|^.mobi$|^.mp
-00017ed0: 3324 222c 0a20 2020 2023 2020 2020 2020  3$",.    #      
-00017ee0: 2020 2020 2020 2020 2020 6f73 2e70 6174            os.pat
-00017ef0: 682e 7370 6c69 7465 7874 2866 696c 6529  h.splitext(file)
-00017f00: 5b31 5d2e 6c6f 7765 7228 2929 3a0a 2020  [1].lower()):.  
-00017f10: 2020 2320 2020 2067 732e 6c6f 672e 6465    #    gs.log.de
-00017f20: 6275 6728 6622 4669 6c65 207b 6669 6c65  bug(f"File {file
-00017f30: 7d20 6973 206e 6f74 2061 2070 6572 6d69  } is not a permi
-00017f40: 7474 6564 2066 696c 6520 7479 7065 2e20  tted file type. 
-00017f50: 5368 6f75 6c64 2062 6520 220a 2020 2020  Should be ".    
-00017f60: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00017f70: 2020 222e 7064 662c 202e 7478 742c 202e    ".pdf, .txt, .
-00017f80: 646f 632c 202e 786c 732c 202e 6d6f 6269  doc, .xls, .mobi
-00017f90: 206f 7220 2e6d 7033 202e 2e2e 2022 0a20   or .mp3 ... ". 
-00017fa0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00017fb0: 2020 2020 2066 225b 7b6f 732e 7061 7468       f"[{os.path
-00017fc0: 2e73 706c 6974 6578 7428 6669 6c65 295b  .splitext(file)[
-00017fd0: 315d 2e6c 6f77 6572 2829 7d5d 220a 2020  1].lower()}]".  
-00017fe0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-00017ff0: 2020 2020 2254 6869 7320 6669 6c65 2069      "This file i
-00018000: 7320 6265 696e 6720 6472 6f70 7065 6420  s being dropped 
-00018010: 616e 6420 4e4f 5420 7365 6e74 2e22 290a  and NOT sent.").
-00018020: 2020 2020 2320 2020 2072 6574 7572 6e0a      #    return.
-00018030: 0a20 2020 2023 2027 6170 706c 6963 6174  .    # 'applicat
-00018040: 696f 6e2f 7064 6627 2022 706c 6169 6e2f  ion/pdf' "plain/
-00018050: 7465 7874 2220 2261 7564 696f 2f6f 6767  text" "audio/ogg
-00018060: 220a 2020 2020 6d69 6d65 5f74 7970 6520  ".    mime_type 
-00018070: 3d20 6d61 6769 632e 6672 6f6d 5f66 696c  = magic.from_fil
-00018080: 6528 6669 6c65 2c20 6d69 6d65 3d54 7275  e(file, mime=Tru
-00018090: 6529 0a20 2020 2023 2069 6620 2828 6e6f  e).    # if ((no
-000180a0: 7420 6d69 6d65 5f74 7970 652e 7374 6172  t mime_type.star
-000180b0: 7473 7769 7468 2822 6170 706c 6963 6174  tswith("applicat
-000180c0: 696f 6e2f 2229 2920 616e 640a 2020 2020  ion/")) and.    
-000180d0: 2320 2020 2020 2020 2028 6e6f 7420 6d69  #        (not mi
-000180e0: 6d65 5f74 7970 652e 7374 6172 7473 7769  me_type.startswi
-000180f0: 7468 2822 706c 6169 6e2f 2229 2920 616e  th("plain/")) an
-00018100: 640a 2020 2020 2320 2020 2020 2020 2028  d.    #        (
-00018110: 6e6f 7420 6d69 6d65 5f74 7970 652e 7374  not mime_type.st
-00018120: 6172 7473 7769 7468 2822 6175 6469 6f2f  artswith("audio/
-00018130: 2229 2929 3a0a 2020 2020 2320 2020 2067  "))):.    #    g
-00018140: 732e 6c6f 672e 6465 6275 6728 6622 4669  s.log.debug(f"Fi
-00018150: 6c65 207b 6669 6c65 7d20 646f 6573 206e  le {file} does n
-00018160: 6f74 2068 6176 6520 616e 2061 6363 6570  ot have an accep
-00018170: 7465 6420 6d69 6d65 2074 7970 652e 2022  ted mime type. "
-00018180: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-00018190: 2020 2020 2020 2022 5368 6f75 6c64 2062         "Should b
-000181a0: 6520 736f 6d65 7468 696e 6720 6c69 6b65  e something like
-000181b0: 2061 7070 6c69 6361 7469 6f6e 2f70 6466   application/pdf
-000181c0: 2e20 220a 2020 2020 2320 2020 2020 2020  . ".    #       
-000181d0: 2020 2020 2020 2020 2020 6622 466f 756e            f"Foun
-000181e0: 6420 6d69 6d65 2074 7970 6520 7b6d 696d  d mime type {mim
-000181f0: 655f 7479 7065 7d2e 2022 0a20 2020 2023  e_type}. ".    #
-00018200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018210: 2022 5468 6973 2066 696c 6520 6973 2062   "This file is b
-00018220: 6569 6e67 2064 726f 7070 6564 2061 6e64  eing dropped and
-00018230: 204e 4f54 2073 656e 742e 2229 0a20 2020   NOT sent.").   
-00018240: 2023 2020 2020 7265 7475 726e 0a0a 2020   #    return..  
-00018250: 2020 2320 6669 7273 7420 646f 2061 6e20    # first do an 
-00018260: 7570 6c6f 6164 206f 6620 6669 6c65 2c20  upload of file, 
-00018270: 7365 6520 7570 6c6f 6164 2829 2064 6f63  see upload() doc
-00018280: 756d 656e 7461 7469 6f6e 0a20 2020 2023  umentation.    #
-00018290: 2068 7474 703a 2f2f 6d61 7472 6978 2d6e   http://matrix-n
-000182a0: 696f 2e72 6561 6474 6865 646f 6373 2e69  io.readthedocs.i
-000182b0: 6f2f 656e 2f6c 6174 6573 742f 6e69 6f2e  o/en/latest/nio.
-000182c0: 6874 6d6c 236e 696f 2e41 7379 6e63 436c  html#nio.AsyncCl
-000182d0: 6965 6e74 2e75 706c 6f61 640a 2020 2020  ient.upload.    
-000182e0: 2320 7468 656e 2073 656e 6420 5552 4920  # then send URI 
-000182f0: 6f66 2075 706c 6f61 6420 746f 2072 6f6f  of upload to roo
-00018300: 6d0a 0a20 2020 2066 696c 655f 7374 6174  m..    file_stat
-00018310: 203d 2061 7761 6974 2061 696f 6669 6c65   = await aiofile
-00018320: 732e 6f73 2e73 7461 7428 6669 6c65 290a  s.os.stat(file).
-00018330: 2020 2020 6173 796e 6320 7769 7468 2061      async with a
-00018340: 696f 6669 6c65 732e 6f70 656e 2866 696c  iofiles.open(fil
-00018350: 652c 2022 722b 6222 2920 6173 2066 3a0a  e, "r+b") as f:.
-00018360: 2020 2020 2020 2020 7265 7370 2c20 6465          resp, de
-00018370: 6372 7970 7469 6f6e 5f6b 6579 7320 3d20  cryption_keys = 
-00018380: 6177 6169 7420 636c 6965 6e74 2e75 706c  await client.upl
-00018390: 6f61 6428 0a20 2020 2020 2020 2020 2020  oad(.           
-000183a0: 2066 2c0a 2020 2020 2020 2020 2020 2020   f,.            
-000183b0: 636f 6e74 656e 745f 7479 7065 3d6d 696d  content_type=mim
-000183c0: 655f 7479 7065 2c20 2023 2061 7070 6c69  e_type,  # appli
-000183d0: 6361 7469 6f6e 2f70 6466 0a20 2020 2020  cation/pdf.     
-000183e0: 2020 2020 2020 2066 696c 656e 616d 653d         filename=
-000183f0: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-00018400: 2866 696c 6529 2c0a 2020 2020 2020 2020  (file),.        
-00018410: 2020 2020 6669 6c65 7369 7a65 3d66 696c      filesize=fil
-00018420: 655f 7374 6174 2e73 745f 7369 7a65 2c0a  e_stat.st_size,.
-00018430: 2020 2020 2020 2020 2020 2020 656e 6372              encr
-00018440: 7970 743d 5472 7565 2c0a 2020 2020 2020  ypt=True,.      
-00018450: 2020 290a 2020 2020 6966 2069 7369 6e73    ).    if isins
-00018460: 7461 6e63 6528 7265 7370 2c20 5570 6c6f  tance(resp, Uplo
-00018470: 6164 5265 7370 6f6e 7365 293a 0a20 2020  adResponse):.   
-00018480: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00018490: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
-000184a0: 4669 6c65 2077 6173 2075 706c 6f61 6465  File was uploade
-000184b0: 6420 7375 6363 6573 7366 756c 6c79 2074  d successfully t
-000184c0: 6f20 7365 7276 6572 2e20 5265 7370 6f6e  o server. Respon
-000184d0: 7365 2069 733a 2022 0a20 2020 2020 2020  se is: ".       
-000184e0: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
-000184f0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00018500: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
-00018510: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00018520: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
-00018530: 2020 2020 2020 2020 2066 2254 6865 2070           f"The p
-00018540: 726f 6772 616d 207b 5052 4f47 5f57 4954  rogram {PROG_WIT
-00018550: 485f 4558 547d 2066 6169 6c65 6420 746f  H_EXT} failed to
-00018560: 2075 706c 6f61 642e 2022 0a20 2020 2020   upload. ".     
-00018570: 2020 2020 2020 2022 506c 6561 7365 2072         "Please r
-00018580: 6574 7279 2e20 5468 6973 2063 6f75 6c64  etry. This could
-00018590: 2062 6520 7465 6d70 6f72 6172 7920 6973   be temporary is
-000185a0: 7375 6520 6f6e 2022 0a20 2020 2020 2020  sue on ".       
-000185b0: 2020 2020 2022 796f 7572 2073 6572 7665       "your serve
-000185c0: 722e 2022 0a20 2020 2020 2020 2020 2020  r. ".           
-000185d0: 2022 536f 7272 792e 220a 2020 2020 2020   "Sorry.".      
-000185e0: 2020 290a 2020 2020 2020 2020 6773 2e6c    ).        gs.l
-000185f0: 6f67 2e69 6e66 6f28 0a20 2020 2020 2020  og.info(.       
-00018600: 2020 2020 2066 2766 696c 653d 227b 6669       f'file="{fi
-00018610: 6c65 7d22 3b20 6d69 6d65 5f74 7970 653d  le}"; mime_type=
-00018620: 227b 6d69 6d65 5f74 7970 657d 223b 2027  "{mime_type}"; '
-00018630: 0a20 2020 2020 2020 2020 2020 2066 2766  .            f'f
-00018640: 696c 6573 7369 7a65 3d22 7b66 696c 655f  ilessize="{file_
-00018650: 7374 6174 2e73 745f 7369 7a65 7d22 270a  stat.st_size}"'.
-00018660: 2020 2020 2020 2020 2020 2020 6622 4661              f"Fa
-00018670: 696c 6564 2074 6f20 7570 6c6f 6164 3a20  iled to upload: 
-00018680: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-00018690: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-000186a0: 2020 2020 2029 0a0a 2020 2020 2320 6465       )..    # de
-000186b0: 7465 726d 696e 6520 6d73 675f 7479 7065  termine msg_type
-000186c0: 3a0a 2020 2020 6966 206d 696d 655f 7479  :.    if mime_ty
-000186d0: 7065 2e73 7461 7274 7377 6974 6828 2261  pe.startswith("a
-000186e0: 7564 696f 2f22 293a 0a20 2020 2020 2020  udio/"):.       
-000186f0: 206d 7367 5f74 7970 6520 3d20 226d 2e61   msg_type = "m.a
-00018700: 7564 696f 220a 2020 2020 656c 6966 206d  udio".    elif m
-00018710: 696d 655f 7479 7065 2e73 7461 7274 7377  ime_type.startsw
-00018720: 6974 6828 2276 6964 656f 2f22 293a 0a20  ith("video/"):. 
-00018730: 2020 2020 2020 206d 7367 5f74 7970 6520         msg_type 
-00018740: 3d20 226d 2e76 6964 656f 220a 2020 2020  = "m.video".    
-00018750: 656c 7365 3a0a 2020 2020 2020 2020 6d73  else:.        ms
-00018760: 675f 7479 7065 203d 2022 6d2e 6669 6c65  g_type = "m.file
-00018770: 220a 0a20 2020 2063 6f6e 7465 6e74 203d  "..    content =
-00018780: 207b 0a20 2020 2020 2020 2022 626f 6479   {.        "body
-00018790: 223a 206f 732e 7061 7468 2e62 6173 656e  ": os.path.basen
-000187a0: 616d 6528 6669 6c65 292c 2020 2320 6465  ame(file),  # de
-000187b0: 7363 7269 7074 6976 6520 7469 746c 650a  scriptive title.
-000187c0: 2020 2020 2020 2020 2269 6e66 6f22 3a20          "info": 
-000187d0: 7b22 7369 7a65 223a 2066 696c 655f 7374  {"size": file_st
-000187e0: 6174 2e73 745f 7369 7a65 2c20 226d 696d  at.st_size, "mim
-000187f0: 6574 7970 6522 3a20 6d69 6d65 5f74 7970  etype": mime_typ
-00018800: 657d 2c0a 2020 2020 2020 2020 226d 7367  e},.        "msg
-00018810: 7479 7065 223a 206d 7367 5f74 7970 652c  type": msg_type,
-00018820: 0a20 2020 2020 2020 2022 6669 6c65 223a  .        "file":
-00018830: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-00018840: 7572 6c22 3a20 7265 7370 2e63 6f6e 7465  url": resp.conte
-00018850: 6e74 5f75 7269 2c0a 2020 2020 2020 2020  nt_uri,.        
-00018860: 2020 2020 226b 6579 223a 2064 6563 7279      "key": decry
-00018870: 7074 696f 6e5f 6b65 7973 5b22 6b65 7922  ption_keys["key"
-00018880: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-00018890: 6976 223a 2064 6563 7279 7074 696f 6e5f  iv": decryption_
-000188a0: 6b65 7973 5b22 6976 225d 2c0a 2020 2020  keys["iv"],.    
-000188b0: 2020 2020 2020 2020 2268 6173 6865 7322          "hashes"
-000188c0: 3a20 6465 6372 7970 7469 6f6e 5f6b 6579  : decryption_key
-000188d0: 735b 2268 6173 6865 7322 5d2c 0a20 2020  s["hashes"],.   
-000188e0: 2020 2020 2020 2020 2022 7622 3a20 6465           "v": de
-000188f0: 6372 7970 7469 6f6e 5f6b 6579 735b 2276  cryption_keys["v
-00018900: 225d 2c0a 2020 2020 2020 2020 7d2c 0a20  "],.        },. 
-00018910: 2020 207d 0a0a 2020 2020 6966 2069 7350     }..    if isP
-00018920: 6970 653a 0a20 2020 2020 2020 2023 2072  ipe:.        # r
-00018930: 6d20 7465 6d70 2066 696c 650a 2020 2020  m temp file.    
-00018940: 2020 2020 6f73 2e72 656d 6f76 6528 6669      os.remove(fi
-00018950: 6c65 290a 0a20 2020 2074 7279 3a0a 2020  le)..    try:.  
-00018960: 2020 2020 2020 666f 7220 726f 6f6d 5f69        for room_i
-00018970: 6420 696e 2072 6f6f 6d73 3a0a 2020 2020  d in rooms:.    
-00018980: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
-00018990: 3d20 6177 6169 7420 6d61 705f 726f 6f6d  = await map_room
-000189a0: 696e 666f 5f74 6f5f 726f 6f6d 6964 2863  info_to_roomid(c
-000189b0: 6c69 656e 742c 2072 6f6f 6d5f 6964 290a  lient, room_id).
-000189c0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-000189d0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-000189e0: 726f 6f6d 5f73 656e 6428 0a20 2020 2020  room_send(.     
-000189f0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-00018a00: 6964 2c20 6d65 7373 6167 655f 7479 7065  id, message_type
-00018a10: 3d22 6d2e 726f 6f6d 2e6d 6573 7361 6765  ="m.room.message
-00018a20: 222c 2063 6f6e 7465 6e74 3d63 6f6e 7465  ", content=conte
-00018a30: 6e74 0a20 2020 2020 2020 2020 2020 2029  nt.            )
-00018a40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00018a50: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-00018a60: 2052 6f6f 6d53 656e 6445 7272 6f72 293a   RoomSendError):
-00018a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018a80: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-00018a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018aa0: 2020 2022 4531 3436 3a20 220a 2020 2020     "E146: ".    
-00018ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ac0: 2272 6f6f 6d5f 7365 6e64 2066 6169 6c65  "room_send faile
-00018ad0: 6420 7769 7468 2065 7272 6f72 2022 0a20  d with error ". 
-00018ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018af0: 2020 2066 2227 7b70 7269 7661 6379 5f66     f"'{privacy_f
-00018b00: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-00018b10: 7d27 2e22 0a20 2020 2020 2020 2020 2020  }'.".           
-00018b20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00018b30: 2020 2020 2020 2023 2067 732e 6572 725f         # gs.err_
-00018b40: 636f 756e 7420 2b3d 2031 2023 206e 6f74  count += 1 # not
-00018b50: 206e 6565 6465 642c 2077 696c 6c20 7261   needed, will ra
-00018b60: 6973 6520 6578 6365 7074 696f 6e0a 2020  ise exception.  
-00018b70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00018b80: 696e 2066 6f6c 6c6f 7769 6e67 206c 696e  in following lin
-00018b90: 6520 6f66 2063 6f64 650a 2020 2020 2020  e of code.      
-00018ba0: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
-00018bb0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00018bc0: 2020 2066 2754 6869 7320 6669 6c65 2077     f'This file w
-00018bd0: 6173 2073 656e 743a 2022 7b66 696c 657d  as sent: "{file}
-00018be0: 2220 746f 2072 6f6f 6d20 227b 7265 7370  " to room "{resp
-00018bf0: 2e72 6f6f 6d5f 6964 7d22 2027 0a20 2020  .room_id}" '.   
-00018c00: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
-00018c10: 7320 6576 656e 7420 227b 7265 7370 2e65  s event "{resp.e
-00018c20: 7665 6e74 5f69 647d 222e 270a 2020 2020  vent_id}".'.    
-00018c30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00018c40: 2020 2020 2020 6966 2067 732e 7061 2e70        if gs.pa.p
-00018c50: 7269 6e74 5f65 7665 6e74 5f69 643a 0a20  rint_event_id:. 
-00018c60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00018c70: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
-00018c80: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
-00018c90: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
-00018ca0: 2020 2020 2020 2020 2020 2020 7465 7874              text
-00018cb0: 203d 2066 227b 7265 7370 2e65 7665 6e74   = f"{resp.event
-00018cc0: 5f69 647d 7b53 4550 7d7b 7265 7370 2e72  _id}{SEP}{resp.r
-00018cd0: 6f6f 6d5f 6964 7d7b 5345 507d 7b66 696c  oom_id}{SEP}{fil
-00018ce0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
-00018cf0: 2020 2020 2320 4f62 6a65 6374 206f 6620      # Object of 
-00018d00: 7479 7065 2052 6f6f 6d43 7265 6174 6552  type RoomCreateR
-00018d10: 6573 706f 6e73 6520 6973 206e 6f74 204a  esponse is not J
-00018d20: 534f 4e0a 2020 2020 2020 2020 2020 2020  SON.            
-00018d30: 2020 2020 2320 7365 7269 616c 697a 6162      # serializab
-00018d40: 6c65 2c20 6865 6e63 6520 7765 2075 7365  le, hence we use
-00018d50: 2074 6865 2064 6963 7469 6f6e 6172 792e   the dictionary.
-00018d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018d70: 206a 736f 6e5f 6d61 7820 3d20 7265 7370   json_max = resp
-00018d80: 2e5f 5f64 6963 745f 5f0a 2020 2020 2020  .__dict__.      
-00018d90: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
-00018da0: 6178 2e75 7064 6174 6528 7b22 6669 6c65  ax.update({"file
-00018db0: 223a 2066 696c 657d 2920 2023 2061 6464  ": file})  # add
-00018dc0: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
-00018dd0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00018de0: 5f20 3d20 6a73 6f6e 5f6d 6178 2e63 6f70  _ = json_max.cop
-00018df0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00018e00: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
-00018e10: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
-00018e20: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-00018e30: 2020 2020 6a73 6f6e 5f73 7065 6320 3d20      json_spec = 
-00018e40: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00018e50: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
-00018e60: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00018e70: 2020 2020 2020 2067 732e 7061 2e6f 7574         gs.pa.out
-00018e80: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
-00018e90: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
-00018ea0: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
-00018eb0: 2020 2020 2020 2020 6a73 6f6e 5f3d 6a73          json_=js
-00018ec0: 6f6e 5f2c 0a20 2020 2020 2020 2020 2020  on_,.           
-00018ed0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00018ee0: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
-00018ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f00: 6a73 6f6e 5f73 7065 633d 6a73 6f6e 5f73  json_spec=json_s
-00018f10: 7065 632c 0a20 2020 2020 2020 2020 2020  pec,.           
-00018f20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00018f30: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00018f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018f50: 2066 2754 6869 7320 6669 6c65 2077 6173   f'This file was
-00018f60: 2073 656e 743a 2022 7b66 696c 657d 2220   sent: "{file}" 
-00018f70: 746f 2072 6f6f 6d20 227b 726f 6f6d 5f69  to room "{room_i
-00018f80: 647d 222e 2027 0a20 2020 2020 2020 2020  d}". '.         
-00018f90: 2020 2020 2020 2066 2252 6573 706f 6e73         f"Respons
-00018fa0: 653a 2065 7665 6e74 5f69 643d 7b72 6573  e: event_id={res
-00018fb0: 702e 6576 656e 745f 6964 7d2c 2072 6f6f  p.event_id}, roo
-00018fc0: 6d5f 6964 3d7b 7265 7370 2e72 6f6f 6d5f  m_id={resp.room_
-00018fd0: 6964 7d2c 2022 0a20 2020 2020 2020 2020  id}, ".         
-00018fe0: 2020 2020 2020 2066 2266 756c 6c20 7265         f"full re
-00018ff0: 7370 6f6e 7365 3a20 7b70 7269 7661 6379  sponse: {privacy
-00019000: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-00019010: 2929 7d2e 2022 0a20 2020 2020 2020 2020  ))}. ".         
-00019020: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
-00019030: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00019040: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-00019050: 2245 3134 373a 2022 2066 2246 696c 6520  "E147: " f"File 
-00019060: 7365 6e64 206f 6620 6669 6c65 207b 6669  send of file {fi
-00019070: 6c65 7d20 6661 696c 6564 2e20 536f 7272  le} failed. Sorr
-00019080: 792e 2229 0a20 2020 2020 2020 2067 732e  y.").        gs.
-00019090: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-000190a0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-000190b0: 6275 6728 2248 6572 6520 6973 2074 6865  bug("Here is the
-000190c0: 2074 7261 6365 6261 636b 2e5c 6e22 202b   traceback.\n" +
-000190d0: 2074 7261 6365 6261 636b 2e66 6f72 6d61   traceback.forma
-000190e0: 745f 6578 6328 2929 0a0a 0a23 2061 6363  t_exc())...# acc
-000190f0: 6f72 6469 6e67 2074 6f20 6c69 6e74 6572  ording to linter
-00019100: 3a20 6675 6e63 7469 6f6e 2069 7320 746f  : function is to
-00019110: 6f20 636f 6d70 6c65 782c 2043 3930 310a  o complex, C901.
-00019120: 6173 796e 6320 6465 6620 7365 6e64 5f69  async def send_i
-00019130: 6d61 6765 2863 6c69 656e 742c 2072 6f6f  mage(client, roo
-00019140: 6d73 2c20 696d 6167 6529 3a20 2023 206e  ms, image):  # n
-00019150: 6f71 613a 2043 3930 310a 2020 2020 2222  oqa: C901.    ""
-00019160: 2250 726f 6365 7373 2069 6d61 6765 2e0a  "Process image..
-00019170: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
-00019180: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
-00019190: 2020 636c 6965 6e74 203a 2043 6c69 656e    client : Clien
-000191a0: 740a 2020 2020 726f 6f6d 7320 3a20 6c69  t.    rooms : li
-000191b0: 7374 0a20 2020 2020 2020 206c 6973 7420  st.        list 
-000191c0: 6f66 2072 6f6f 6d5f 6964 2d73 0a20 2020  of room_id-s.   
-000191d0: 2069 6d61 6765 203a 2073 7472 0a20 2020   image : str.   
-000191e0: 2020 2020 2066 696c 6520 6e61 6d65 206f       file name o
-000191f0: 6620 696d 6167 6520 6672 6f6d 202d 2d69  f image from --i
-00019200: 6d61 6765 2061 7267 756d 656e 740a 0a20  mage argument.. 
-00019210: 2020 2054 6869 7320 6973 2061 2077 6f72     This is a wor
-00019220: 6b69 6e67 2065 7861 6d70 6c65 2066 6f72  king example for
-00019230: 2061 204a 5047 2069 6d61 6765 2e0a 2020   a JPG image..  
-00019240: 2020 4974 2063 616e 2062 6520 7669 6577    It can be view
-00019250: 6564 206f 7220 646f 776e 6c6f 6164 6564  ed or downloaded
-00019260: 2066 726f 6d3a 0a20 2020 2068 7474 7073   from:.    https
-00019270: 3a2f 2f6d 6174 7269 782e 6578 616d 706c  ://matrix.exampl
-00019280: 652e 636f 6d2f 5f6d 6174 7269 782f 6d65  e.com/_matrix/me
-00019290: 6469 612f 7230 2f64 6f77 6e6c 6f61 642f  dia/r0/download/
-000192a0: 0a20 2020 2020 2020 2065 7861 6d70 6c65  .        example
-000192b0: 2e63 6f6d 2f53 6f6d 6553 7472 616e 6765  .com/SomeStrange
-000192c0: 5572 694b 6579 0a20 2020 207b 0a20 2020  UriKey.    {.   
-000192d0: 2020 2020 2022 7479 7065 223a 2022 6d2e       "type": "m.
-000192e0: 726f 6f6d 2e6d 6573 7361 6765 222c 0a20  room.message",. 
-000192f0: 2020 2020 2020 2022 7365 6e64 6572 223a         "sender":
-00019300: 2022 4073 6f6d 6575 7365 723a 6578 616d   "@someuser:exam
-00019310: 706c 652e 636f 6d22 2c0a 2020 2020 2020  ple.com",.      
-00019320: 2020 2263 6f6e 7465 6e74 223a 207b 0a20    "content": {. 
-00019330: 2020 2020 2020 2020 2020 2022 626f 6479             "body
-00019340: 223a 2022 736f 6d65 696d 6167 652e 6a70  ": "someimage.jp
-00019350: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
-00019360: 2269 6e66 6f22 3a20 7b0a 2020 2020 2020  "info": {.      
-00019370: 2020 2020 2020 2020 2020 2273 697a 6522            "size"
-00019380: 3a20 3534 3230 2c0a 2020 2020 2020 2020  : 5420,.        
-00019390: 2020 2020 2020 2020 226d 696d 6574 7970          "mimetyp
-000193a0: 6522 3a20 2269 6d61 6765 2f6a 7065 6722  e": "image/jpeg"
-000193b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000193c0: 2020 2274 6875 6d62 6e61 696c 5f69 6e66    "thumbnail_inf
-000193d0: 6f22 3a20 7b0a 2020 2020 2020 2020 2020  o": {.          
-000193e0: 2020 2020 2020 2020 2020 2277 223a 2031            "w": 1
-000193f0: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00019400: 2020 2020 2020 2020 2268 223a 2031 3030          "h": 100
-00019410: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019420: 2020 2020 2020 226d 696d 6574 7970 6522        "mimetype"
-00019430: 3a20 2269 6d61 6765 2f6a 7065 6722 2c0a  : "image/jpeg",.
-00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019450: 2020 2020 2273 697a 6522 3a20 3231 3036      "size": 2106
-00019460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019470: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-00019480: 2020 2020 2277 223a 2031 3030 2c0a 2020      "w": 100,.  
-00019490: 2020 2020 2020 2020 2020 2020 2020 2268                "h
-000194a0: 223a 2031 3030 2c0a 2020 2020 2020 2020  ": 100,.        
-000194b0: 2020 2020 2020 2020 2274 6875 6d62 6e61          "thumbna
-000194c0: 696c 5f75 726c 223a 2022 6d78 633a 2f2f  il_url": "mxc://
-000194d0: 6578 616d 706c 652e 636f 6d2f 536f 6d65  example.com/Some
-000194e0: 5374 7261 6e67 6554 6875 6d62 6e61 696c  StrangeThumbnail
-000194f0: 5572 694b 6579 220a 2020 2020 2020 2020  UriKey".        
-00019500: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00019510: 2020 2022 6d73 6774 7970 6522 3a20 226d     "msgtype": "m
-00019520: 2e69 6d61 6765 222c 0a20 2020 2020 2020  .image",.       
-00019530: 2020 2020 2022 7572 6c22 3a20 226d 7863       "url": "mxc
-00019540: 3a2f 2f65 7861 6d70 6c65 2e63 6f6d 2f53  ://example.com/S
-00019550: 6f6d 6553 7472 616e 6765 5572 694b 6579  omeStrangeUriKey
-00019560: 220a 2020 2020 2020 2020 7d2c 0a20 2020  ".        },.   
-00019570: 2020 2020 2022 6f72 6967 696e 5f73 6572       "origin_ser
-00019580: 7665 725f 7473 223a 2031 3233 3435 3637  ver_ts": 1234567
-00019590: 3839 3031 3233 3435 3736 2c0a 2020 2020  8901234576,.    
-000195a0: 2020 2020 2275 6e73 6967 6e65 6422 3a20      "unsigned": 
-000195b0: 7b0a 2020 2020 2020 2020 2020 2020 2261  {.            "a
-000195c0: 6765 223a 2032 3638 0a20 2020 2020 2020  ge": 268.       
-000195d0: 207d 2c0a 2020 2020 2020 2020 2265 7665   },.        "eve
-000195e0: 6e74 5f69 6422 3a20 2224 736b 6468 474a  nt_id": "$skdhGJ
-000195f0: 4b68 6779 7235 3438 3635 3459 5472 3736  Khgyr548654YTr76
-00019600: 3559 6979 3538 5459 5222 2c0a 2020 2020  5Yiy58TYR",.    
-00019610: 2020 2020 2272 6f6f 6d5f 6964 223a 2022      "room_id": "
-00019620: 214a 4b48 6779 4847 6679 7448 4746 6a68  !JKHgyHGfytHGFjh
-00019630: 6766 593a 6578 616d 706c 652e 636f 6d22  gfY:example.com"
-00019640: 0a20 2020 207d 0a0a 2020 2020 2222 220a  .    }..    """.
-00019650: 2020 2020 6966 206e 6f74 2072 6f6f 6d73      if not rooms
-00019660: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00019670: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00019680: 2020 2020 2020 2257 3130 313a 2022 0a20        "W101: ". 
-00019690: 2020 2020 2020 2020 2020 2022 4e6f 2072             "No r
-000196a0: 6f6f 6d73 2061 7265 2067 6976 656e 2e20  ooms are given. 
-000196b0: 5468 6973 2073 686f 756c 6420 6e6f 7420  This should not 
-000196c0: 6861 7070 656e 2e20 220a 2020 2020 2020  happen. ".      
-000196d0: 2020 2020 2020 224d 6179 6265 2079 6f75        "Maybe you
-000196e0: 7220 444d 2072 6f6f 6d73 2073 7065 6369  r DM rooms speci
-000196f0: 6669 6564 2076 6961 202d 2d75 7365 7220  fied via --user 
-00019700: 7765 7265 206e 6f74 2066 6f75 6e64 2e20  were not found. 
-00019710: 220a 2020 2020 2020 2020 2020 2020 2254  ".            "T
-00019720: 6869 7320 696d 6167 6520 6973 2062 6569  his image is bei
-00019730: 6e67 2064 726f 7070 6564 2061 6e64 204e  ng dropped and N
-00019740: 4f54 2073 656e 742e 220a 2020 2020 2020  OT sent.".      
-00019750: 2020 290a 2020 2020 2020 2020 6773 2e77    ).        gs.w
-00019760: 6172 6e5f 636f 756e 7420 2b3d 2031 0a20  arn_count += 1. 
-00019770: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00019780: 2020 2023 2068 6f77 2074 6f20 7472 6561     # how to trea
-00019790: 7420 7069 7065 206f 6e20 7374 6469 6e3f  t pipe on stdin?
-000197a0: 0a20 2020 2023 2061 696f 6669 6c65 732e  .    # aiofiles.
-000197b0: 6f70 656e 2873 7973 2e73 7464 696e 2c20  open(sys.stdin, 
-000197c0: 2272 2b62 2229 2064 6f65 7320 6e6f 7420  "r+b") does not 
-000197d0: 776f 726b 2c20 7772 6f6e 6720 7479 7065  work, wrong type
-000197e0: 2e0a 2020 2020 2320 6169 6f66 696c 6573  ..    # aiofiles
-000197f0: 2e6f 7065 6e28 7379 732e 7374 6469 6e2e  .open(sys.stdin.
-00019800: 6275 6666 6572 2c20 2272 2b62 2229 2064  buffer, "r+b") d
-00019810: 6f65 7320 6e6f 7420 776f 726b 2c20 7772  oes not work, wr
-00019820: 6f6e 6720 7479 7065 2e0a 2020 2020 2320  ong type..    # 
-00019830: 6169 6f66 696c 6573 2e6f 7065 6e28 272f  aiofiles.open('/
-00019840: 6465 762f 7374 6469 6e27 2c20 6d6f 6465  dev/stdin', mode
-00019850: 3d27 7262 2729 2066 6169 6c73 2077 6974  ='rb') fails wit
-00019860: 6820 6572 726f 723a 0a20 2020 2023 2020  h error:.    #  
-00019870: 2020 696f 2e55 6e73 7570 706f 7274 6564    io.Unsupported
-00019880: 4f70 6572 6174 696f 6e3a 2046 696c 6520  Operation: File 
-00019890: 6f72 2073 7472 6561 6d20 6973 206e 6f74  or stream is not
-000198a0: 2073 6565 6b61 626c 650a 2020 2020 2320   seekable.    # 
-000198b0: 7374 6469 6e2c 205f 203d 2061 7761 6974  stdin, _ = await
-000198c0: 2061 696f 636f 6e73 6f6c 652e 6765 745f   aioconsole.get_
-000198d0: 7374 616e 6461 7264 5f73 7472 6561 6d73  standard_streams
-000198e0: 2829 2061 6c73 6f20 6661 696c 6573 0a20  () also failes. 
-000198f0: 2020 2023 2048 656e 6365 2049 2073 6565     # Hence I see
-00019900: 206e 6f20 7761 7920 746f 2064 6972 6563   no way to direc
-00019910: 746c 7920 6861 6e64 2073 7464 696e 2074  tly hand stdin t
-00019920: 6f20 6169 6f66 696c 6573 2e0a 2020 2020  o aiofiles..    
-00019930: 2320 5072 6f62 6c65 6d3a 2049 2063 616e  # Problem: I can
-00019940: 6e6f 7420 636f 6d62 696e 6520 7468 6520  not combine the 
-00019950: 3320 7468 696e 6773 3a0a 2020 2020 2320  3 things:.    # 
-00019960: 2020 2073 7464 696e 202b 2061 696f 6669     stdin + aiofi
-00019970: 6c65 7320 2b20 6e69 6f2e 4173 796e 6343  les + nio.AsyncC
-00019980: 6c69 656e 742e 7570 6c6f 6164 2829 0a20  lient.upload(). 
-00019990: 2020 2023 2053 696e 6365 2049 2063 6f75     # Since I cou
-000199a0: 6c64 206e 6f74 206f 7665 7263 6f6d 6520  ld not overcome 
-000199b0: 7468 6973 2070 726f 626c 656d 2049 2067  this problem I g
-000199c0: 656e 6572 6174 6520 6120 7465 6d70 6f72  enerate a tempor
-000199d0: 6172 7920 6669 6c65 0a0a 2020 2020 6966  ary file..    if
-000199e0: 2069 6d61 6765 203d 3d20 222d 223a 2020   image == "-":  
-000199f0: 2320 2d20 6d65 616e 7320 7265 6164 2061  # - means read a
-00019a00: 7320 7069 7065 2066 726f 6d20 7374 6469  s pipe from stdi
-00019a10: 6e0a 2020 2020 2020 2020 6973 5069 7065  n.        isPipe
-00019a20: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00019a30: 6669 6e5f 6275 6620 3d20 7379 732e 7374  fin_buf = sys.st
-00019a40: 6469 6e2e 6275 6666 6572 2e72 6561 6428  din.buffer.read(
-00019a50: 290a 2020 2020 2020 2020 6c65 6e5f 6669  ).        len_fi
-00019a60: 6e5f 6275 6620 3d20 6c65 6e28 6669 6e5f  n_buf = len(fin_
-00019a70: 6275 6629 0a20 2020 2020 2020 2069 6d61  buf).        ima
-00019a80: 6765 203d 2022 6d63 2d22 202b 2073 7472  ge = "mc-" + str
-00019a90: 2875 7569 642e 7575 6964 3428 2929 202b  (uuid.uuid4()) +
-00019aa0: 2022 2e74 6d70 220a 2020 2020 2020 2020   ".tmp".        
-00019ab0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-00019ac0: 2020 2020 2020 2020 2020 6622 7b6c 656e            f"{len
-00019ad0: 5f66 696e 5f62 7566 7d20 6279 7465 7320  _fin_buf} bytes 
-00019ae0: 6f66 2069 6d61 6765 2064 6174 6120 7265  of image data re
-00019af0: 6164 2066 726f 6d20 7374 6469 6e2e 2022  ad from stdin. "
-00019b00: 0a20 2020 2020 2020 2020 2020 2066 2754  .            f'T
-00019b10: 656d 706f 7261 7279 2066 696c 6520 227b  emporary file "{
-00019b20: 696d 6167 657d 2220 7761 7320 6372 6561  image}" was crea
-00019b30: 7465 6420 666f 7220 696d 6167 652e 270a  ted for image.'.
-00019b40: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00019b50: 2020 666f 7574 203d 206f 7065 6e28 696d    fout = open(im
-00019b60: 6167 652c 2022 7762 2229 0a20 2020 2020  age, "wb").     
-00019b70: 2020 2066 6f75 742e 7772 6974 6528 6669     fout.write(fi
-00019b80: 6e5f 6275 6629 0a20 2020 2020 2020 2066  n_buf).        f
-00019b90: 6f75 742e 636c 6f73 6528 290a 2020 2020  out.close().    
-00019ba0: 656c 7365 3a0a 2020 2020 2020 2020 6973  else:.        is
-00019bb0: 5069 7065 203d 2046 616c 7365 0a0a 2020  Pipe = False..  
-00019bc0: 2020 6966 206e 6f74 206f 732e 7061 7468    if not os.path
-00019bd0: 2e69 7366 696c 6528 696d 6167 6529 3a0a  .isfile(image):.
-00019be0: 2020 2020 2020 2020 6773 2e6c 6f67 2e77          gs.log.w
-00019bf0: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-00019c00: 2020 2020 2257 3130 323a 2022 0a20 2020      "W102: ".   
-00019c10: 2020 2020 2020 2020 2066 2249 6d61 6765           f"Image
-00019c20: 2066 696c 6520 7b69 6d61 6765 7d20 6973   file {image} is
-00019c30: 206e 6f74 2061 2066 696c 652e 2044 6f65   not a file. Doe
-00019c40: 736e 2774 2065 7869 7374 206f 7220 220a  sn't exist or ".
-00019c50: 2020 2020 2020 2020 2020 2020 2269 7320              "is 
-00019c60: 6120 6469 7265 6374 6f72 792e 2022 0a20  a directory. ". 
-00019c70: 2020 2020 2020 2020 2020 2022 5468 6973             "This
-00019c80: 2069 6d61 6765 2069 7320 6265 696e 6720   image is being 
-00019c90: 6472 6f70 7065 6420 616e 6420 4e4f 5420  dropped and NOT 
-00019ca0: 7365 6e74 2e22 0a20 2020 2020 2020 2029  sent.".        )
-00019cb0: 0a20 2020 2020 2020 2067 732e 7761 726e  .        gs.warn
-00019cc0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-00019cd0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00019ce0: 2320 2262 6d70 222c 2022 6769 6622 2c20  # "bmp", "gif", 
-00019cf0: 226a 7067 222c 2022 6a70 6567 222c 2022  "jpg", "jpeg", "
-00019d00: 706e 6722 2c20 2270 626d 222c 2022 7067  png", "pbm", "pg
-00019d10: 6d22 2c20 2270 706d 222c 2022 7862 6d22  m", "ppm", "xbm"
-00019d20: 2c20 2278 706d 222c 0a20 2020 2023 2022  , "xpm",.    # "
-00019d30: 7469 6666 222c 2022 7765 6270 222c 2022  tiff", "webp", "
-00019d40: 7376 6722 2c0a 0a20 2020 2023 2073 7667  svg",..    # svg
-00019d50: 2066 696c 6573 2061 7265 206e 6f74 2073   files are not s
-00019d60: 686f 776e 2069 6e20 456c 656d 656e 742c  hown in Element,
-00019d70: 2068 656e 6365 2073 656e 6420 5356 4720   hence send SVG 
-00019d80: 6669 6c65 7320 6173 2066 696c 6573 2077  files as files w
-00019d90: 6974 6820 2d66 0a20 2020 2069 6620 6e6f  ith -f.    if no
-00019da0: 7420 6973 5069 7065 2061 6e64 206e 6f74  t isPipe and not
-00019db0: 2072 652e 6d61 7463 6828 0a20 2020 2020   re.match(.     
-00019dc0: 2020 2022 5e2e 6a70 6724 7c5e 2e6a 7065     "^.jpg$|^.jpe
-00019dd0: 6724 7c5e 2e67 6966 247c 5e2e 706e 6724  g$|^.gif$|^.png$
-00019de0: 7c5e 2e73 7667 2422 2c0a 2020 2020 2020  |^.svg$",.      
-00019df0: 2020 6f73 2e70 6174 682e 7370 6c69 7465    os.path.splite
-00019e00: 7874 2869 6d61 6765 295b 315d 2e6c 6f77  xt(image)[1].low
-00019e10: 6572 2829 2c0a 2020 2020 293a 0a20 2020  er(),.    ):.   
-00019e20: 2020 2020 2067 732e 6c6f 672e 7761 726e       gs.log.warn
-00019e30: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-00019e40: 2022 5731 3033 3a20 220a 2020 2020 2020   "W103: ".      
-00019e50: 2020 2020 2020 6622 496d 6167 6520 6669        f"Image fi
-00019e60: 6c65 207b 696d 6167 657d 2069 7320 6e6f  le {image} is no
-00019e70: 7420 616e 2069 6d61 6765 2066 696c 652e  t an image file.
-00019e80: 2053 686f 756c 6420 6265 2022 0a20 2020   Should be ".   
-00019e90: 2020 2020 2020 2020 2022 2e6a 7067 2c20           ".jpg, 
-00019ea0: 2e6a 7065 672c 202e 6769 662c 206f 7220  .jpeg, .gif, or 
-00019eb0: 2e70 6e67 2e20 220a 2020 2020 2020 2020  .png. ".        
-00019ec0: 2020 2020 6622 466f 756e 6420 5b7b 6f73      f"Found [{os
-00019ed0: 2e70 6174 682e 7370 6c69 7465 7874 2869  .path.splitext(i
-00019ee0: 6d61 6765 295b 315d 2e6c 6f77 6572 2829  mage)[1].lower()
-00019ef0: 7d5d 2e20 220a 2020 2020 2020 2020 2020  }]. ".          
-00019f00: 2020 2254 6869 7320 696d 6167 6520 6973    "This image is
-00019f10: 2062 6569 6e67 2064 726f 7070 6564 2061   being dropped a
-00019f20: 6e64 204e 4f54 2073 656e 742e 220a 2020  nd NOT sent.".  
-00019f30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00019f40: 6773 2e77 6172 6e5f 636f 756e 7420 2b3d  gs.warn_count +=
-00019f50: 2031 0a20 2020 2020 2020 2072 6574 7572   1.        retur
-00019f60: 6e0a 0a20 2020 2023 2027 6170 706c 6963  n..    # 'applic
-00019f70: 6174 696f 6e2f 7064 6627 2022 696d 6167  ation/pdf' "imag
-00019f80: 652f 6a70 6567 220a 2020 2020 2320 7376  e/jpeg".    # sv
-00019f90: 6720 6d69 6d65 2d74 7970 6520 6973 2022  g mime-type is "
-00019fa0: 696d 6167 652f 7376 672b 786d 6c22 0a20  image/svg+xml". 
-00019fb0: 2020 206d 696d 655f 7479 7065 203d 206d     mime_type = m
-00019fc0: 6167 6963 2e66 726f 6d5f 6669 6c65 2869  agic.from_file(i
-00019fd0: 6d61 6765 2c20 6d69 6d65 3d54 7275 6529  mage, mime=True)
-00019fe0: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-00019ff0: 6728 6622 496d 6167 6520 6669 6c65 206d  g(f"Image file m
-0001a000: 696d 652d 7479 7065 2069 7320 7b6d 696d  ime-type is {mim
-0001a010: 655f 7479 7065 7d22 290a 2020 2020 6966  e_type}").    if
-0001a020: 206e 6f74 206d 696d 655f 7479 7065 2e73   not mime_type.s
-0001a030: 7461 7274 7377 6974 6828 2269 6d61 6765  tartswith("image
-0001a040: 2f22 293a 0a20 2020 2020 2020 2067 732e  /"):.        gs.
-0001a050: 6c6f 672e 7761 726e 696e 6728 0a20 2020  log.warning(.   
-0001a060: 2020 2020 2020 2020 2022 5731 3034 3a20           "W104: 
-0001a070: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-0001a080: 496d 6167 6520 6669 6c65 207b 696d 6167  Image file {imag
-0001a090: 657d 2064 6f65 7320 6e6f 7420 6861 7665  e} does not have
-0001a0a0: 2061 6e20 696d 6167 6520 6d69 6d65 2074   an image mime t
-0001a0b0: 7970 652e 2022 0a20 2020 2020 2020 2020  ype. ".         
-0001a0c0: 2020 2022 5368 6f75 6c64 2062 6520 736f     "Should be so
-0001a0d0: 6d65 7468 696e 6720 6c69 6b65 2069 6d61  mething like ima
-0001a0e0: 6765 2f6a 7065 672e 2022 0a20 2020 2020  ge/jpeg. ".     
-0001a0f0: 2020 2020 2020 2066 2246 6f75 6e64 206d         f"Found m
-0001a100: 696d 6520 7479 7065 207b 6d69 6d65 5f74  ime type {mime_t
-0001a110: 7970 657d 2e20 220a 2020 2020 2020 2020  ype}. ".        
-0001a120: 2020 2020 2254 6869 7320 696d 6167 6520      "This image 
-0001a130: 6973 2062 6569 6e67 2064 726f 7070 6564  is being dropped
-0001a140: 2061 6e64 204e 4f54 2073 656e 742e 220a   and NOT sent.".
-0001a150: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001a160: 2020 6773 2e77 6172 6e5f 636f 756e 7420    gs.warn_count 
-0001a170: 2b3d 2031 0a20 2020 2020 2020 2072 6574  += 1.        ret
-0001a180: 7572 6e0a 0a20 2020 2069 6620 6d69 6d65  urn..    if mime
-0001a190: 5f74 7970 652e 7374 6172 7473 7769 7468  _type.startswith
-0001a1a0: 2822 696d 6167 652f 7376 6722 293a 0a20  ("image/svg"):. 
-0001a1b0: 2020 2020 2020 2067 732e 6c6f 672e 7761         gs.log.wa
-0001a1c0: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
-0001a1d0: 2020 2022 5731 3035 3a20 220a 2020 2020     "W105: ".    
-0001a1e0: 2020 2020 2020 2020 2254 6865 7265 2069          "There i
-0001a1f0: 7320 6120 6275 6720 696e 2045 6c65 6d65  s a bug in Eleme
-0001a200: 6e74 2070 7265 7665 6e74 696e 6720 7072  nt preventing pr
-0001a210: 6576 6965 7773 206f 6620 5356 4720 696d  eviews of SVG im
-0001a220: 6167 6573 2e20 220a 2020 2020 2020 2020  ages. ".        
-0001a230: 2020 2020 2241 6c74 6572 6e61 7469 7665      "Alternative
-0001a240: 6c79 2079 6f75 206d 6179 2073 656e 6420  ly you may send 
-0001a250: 5356 4720 6669 6c65 7320 6173 2066 696c  SVG files as fil
-0001a260: 6573 2076 6961 202d 662e 220a 2020 2020  es via -f.".    
-0001a270: 2020 2020 290a 2020 2020 2020 2020 7769      ).        wi
-0001a280: 6474 6820 3d20 3130 3020 2023 2069 6e20  dth = 100  # in 
-0001a290: 7069 7865 6c0a 2020 2020 2020 2020 6865  pixel.        he
-0001a2a0: 6967 6874 203d 2031 3030 0a20 2020 2020  ight = 100.     
-0001a2b0: 2020 2023 2050 7974 686f 6e20 626c 7572     # Python blur
-0001a2c0: 6861 7368 2070 6163 6b61 6765 2064 6f65  hash package doe
-0001a2d0: 7320 6e6f 7420 776f 726b 206f 6e20 5356  s not work on SV
-0001a2e0: 470a 2020 2020 2020 2020 2320 626c 7572  G.        # blur
-0001a2f0: 6861 7368 3a20 736f 6d65 2072 616e 646f  hash: some rando
-0001a300: 6d20 636f 6c6f 7266 756c 2069 6d61 6765  m colorful image
-0001a310: 0a20 2020 2020 2020 2062 6c75 7268 6173  .        blurhas
-0001a320: 6820 3d20 2255 4c48 5f43 3a30 4847 467d  h = "ULH_C:0HGF}
-0001a330: 422e 246b 3a50 4c56 4738 7a7d 2434 3b6f  B.$k:PLVG8z}$4;o
-0001a340: 3f7e 4951 3a39 2479 4222 0a20 2020 2020  ?~IQ:9$yB".     
-0001a350: 2020 2062 6c75 7268 6173 6820 3d20 4e6f     blurhash = No
-0001a360: 6e65 2020 2320 7368 6f77 7320 7475 726e  ne  # shows turn
-0001a370: 696e 6720 6369 7263 6c65 2066 6f72 6576  ing circle forev
-0001a380: 6572 2069 6e20 456c 656d 656e 7420 6475  er in Element du
-0001a390: 6520 746f 2062 7567 0a20 2020 2065 6c73  e to bug.    els
-0001a3a0: 653a 0a20 2020 2020 2020 2069 6d20 3d20  e:.        im = 
-0001a3b0: 496d 6167 652e 6f70 656e 2869 6d61 6765  Image.open(image
-0001a3c0: 2920 2023 2074 6869 7320 7769 6c6c 2066  )  # this will f
-0001a3d0: 6169 6c20 666f 7220 5356 4720 6669 6c65  ail for SVG file
-0001a3e0: 730a 2020 2020 2020 2020 2877 6964 7468  s.        (width
-0001a3f0: 2c20 6865 6967 6874 2920 3d20 696d 2e73  , height) = im.s
-0001a400: 697a 6520 2023 2069 6d2e 7369 7a65 2072  ize  # im.size r
-0001a410: 6574 7572 6e73 2028 7769 6474 682c 6865  eturns (width,he
-0001a420: 6967 6874 2920 7475 706c 650a 2020 2020  ight) tuple.    
-0001a430: 2020 2020 626c 7572 6861 7368 203d 204e      blurhash = N
-0001a440: 6f6e 650a 0a20 2020 2023 2066 6972 7374  one..    # first
-0001a450: 2064 6f20 616e 2075 706c 6f61 6420 6f66   do an upload of
-0001a460: 2069 6d61 6765 2c20 7365 6520 7570 6c6f   image, see uplo
-0001a470: 6164 2829 2064 6f63 756d 656e 7461 7469  ad() documentati
-0001a480: 6f6e 0a20 2020 2023 2068 7474 703a 2f2f  on.    # http://
-0001a490: 6d61 7472 6978 2d6e 696f 2e72 6561 6474  matrix-nio.readt
-0001a4a0: 6865 646f 6373 2e69 6f2f 656e 2f6c 6174  hedocs.io/en/lat
-0001a4b0: 6573 742f 6e69 6f2e 6874 6d6c 236e 696f  est/nio.html#nio
-0001a4c0: 2e41 7379 6e63 436c 6965 6e74 2e75 706c  .AsyncClient.upl
-0001a4d0: 6f61 640a 2020 2020 2320 7468 656e 2073  oad.    # then s
-0001a4e0: 656e 6420 5552 4920 6f66 2075 706c 6f61  end URI of uploa
-0001a4f0: 6420 746f 2072 6f6f 6d0a 2020 2020 2320  d to room.    # 
-0001a500: 4e6f 7465 2074 6861 7420 656e 6372 7970  Note that encryp
-0001a510: 7465 6420 7570 6c6f 6164 2077 6f72 6b73  ted upload works
-0001a520: 2065 7665 6e20 7769 7468 2075 6e65 6e63   even with unenc
-0001a530: 7279 7074 6564 2f70 6c61 696e 2072 6f6f  rypted/plain roo
-0001a540: 6d73 3b20 7468 650a 2020 2020 2320 6465  ms; the.    # de
-0001a550: 6372 7970 7469 6f6e 206b 6579 7320 7769  cryption keys wi
-0001a560: 6c6c 206e 6f74 2062 6520 7072 6f74 6563  ll not be protec
-0001a570: 7465 642c 206f 6276 696f 7573 6c79 2c20  ted, obviously, 
-0001a580: 6275 7420 6e6f 2073 7065 6369 616c 0a20  but no special. 
-0001a590: 2020 2023 2074 7265 6174 6d65 6e74 2069     # treatment i
-0001a5a0: 7320 7265 7175 6972 6564 2e0a 0a20 2020  s required...   
-0001a5b0: 2066 696c 655f 7374 6174 203d 2061 7761   file_stat = awa
-0001a5c0: 6974 2061 696f 6669 6c65 732e 6f73 2e73  it aiofiles.os.s
-0001a5d0: 7461 7428 696d 6167 6529 0a20 2020 2061  tat(image).    a
-0001a5e0: 7379 6e63 2077 6974 6820 6169 6f66 696c  sync with aiofil
-0001a5f0: 6573 2e6f 7065 6e28 696d 6167 652c 2022  es.open(image, "
-0001a600: 722b 6222 2920 6173 2066 3a0a 2020 2020  r+b") as f:.    
-0001a610: 2020 2020 7265 7370 2c20 6465 6372 7970      resp, decryp
-0001a620: 7469 6f6e 5f6b 6579 7320 3d20 6177 6169  tion_keys = awai
-0001a630: 7420 636c 6965 6e74 2e75 706c 6f61 6428  t client.upload(
-0001a640: 0a20 2020 2020 2020 2020 2020 2066 2c0a  .            f,.
-0001a650: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001a660: 656e 745f 7479 7065 3d6d 696d 655f 7479  ent_type=mime_ty
-0001a670: 7065 2c20 2023 2069 6d61 6765 2f6a 7065  pe,  # image/jpe
-0001a680: 670a 2020 2020 2020 2020 2020 2020 6669  g.            fi
-0001a690: 6c65 6e61 6d65 3d6f 732e 7061 7468 2e62  lename=os.path.b
-0001a6a0: 6173 656e 616d 6528 696d 6167 6529 2c0a  asename(image),.
-0001a6b0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-0001a6c0: 7369 7a65 3d66 696c 655f 7374 6174 2e73  size=file_stat.s
-0001a6d0: 745f 7369 7a65 2c0a 2020 2020 2020 2020  t_size,.        
-0001a6e0: 2020 2020 656e 6372 7970 743d 5472 7565      encrypt=True
-0001a6f0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0001a700: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-0001a710: 7370 2c20 5570 6c6f 6164 5265 7370 6f6e  sp, UploadRespon
-0001a720: 7365 293a 0a20 2020 2020 2020 2067 732e  se):.        gs.
-0001a730: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0001a740: 2020 2020 2020 2022 496d 6167 6520 7761         "Image wa
-0001a750: 7320 7570 6c6f 6164 6564 2073 7563 6365  s uploaded succe
-0001a760: 7373 6675 6c6c 7920 746f 2073 6572 7665  ssfully to serve
-0001a770: 722e 2022 0a20 2020 2020 2020 2020 2020  r. ".           
-0001a780: 2066 2252 6573 706f 6e73 6520 6973 3a20   f"Response is: 
-0001a790: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0001a7a0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-0001a7b0: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
-0001a7c0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0001a7d0: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-0001a7e0: 2020 6622 5468 6520 7072 6f67 7261 6d20    f"The program 
-0001a7f0: 7b50 524f 475f 5749 5448 5f45 5854 7d20  {PROG_WITH_EXT} 
-0001a800: 6661 696c 6564 2074 6f20 7570 6c6f 6164  failed to upload
-0001a810: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0001a820: 2250 6c65 6173 6520 7265 7472 792e 2054  "Please retry. T
-0001a830: 6869 7320 636f 756c 6420 6265 2074 656d  his could be tem
-0001a840: 706f 7261 7279 2069 7373 7565 206f 6e20  porary issue on 
-0001a850: 220a 2020 2020 2020 2020 2020 2020 2279  ".            "y
-0001a860: 6f75 7220 7365 7276 6572 2e20 220a 2020  our server. ".  
-0001a870: 2020 2020 2020 2020 2020 2253 6f72 7279            "Sorry
-0001a880: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-0001a890: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-0001a8a0: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-0001a8b0: 6669 6c65 3d22 7b69 6d61 6765 7d22 3b20  file="{image}"; 
-0001a8c0: 6d69 6d65 5f74 7970 653d 227b 6d69 6d65  mime_type="{mime
-0001a8d0: 5f74 7970 657d 223b 2027 0a20 2020 2020  _type}"; '.     
-0001a8e0: 2020 2020 2020 2066 2766 696c 6573 7369         f'filessi
-0001a8f0: 7a65 3d22 7b66 696c 655f 7374 6174 2e73  ze="{file_stat.s
-0001a900: 745f 7369 7a65 7d22 270a 2020 2020 2020  t_size}"'.      
-0001a910: 2020 2020 2020 6622 4661 696c 6564 2074        f"Failed t
-0001a920: 6f20 7570 6c6f 6164 3a20 7b70 7269 7661  o upload: {priva
-0001a930: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0001a940: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
-0001a950: 0a0a 2020 2020 2320 544f 444f 2063 6f6d  ..    # TODO com
-0001a960: 7075 7465 2074 6875 6d62 6e61 696c 2c20  pute thumbnail, 
-0001a970: 7570 6c6f 6164 2074 6875 6d62 6e61 696c  upload thumbnail
-0001a980: 2074 6f20 5365 7276 6572 0a20 2020 2023   to Server.    #
-0001a990: 2054 4f44 4f20 6164 6420 7468 756d 626e   TODO add thumbn
-0001a9a0: 6169 6c20 696e 666f 2074 6f20 6063 6f6e  ail info to `con
-0001a9b0: 7465 6e74 600a 0a20 2020 2063 6f6e 7465  tent`..    conte
-0001a9c0: 6e74 203d 207b 0a20 2020 2020 2020 2022  nt = {.        "
-0001a9d0: 626f 6479 223a 206f 732e 7061 7468 2e62  body": os.path.b
-0001a9e0: 6173 656e 616d 6528 696d 6167 6529 2c20  asename(image), 
-0001a9f0: 2023 2064 6573 6372 6970 7469 7665 2074   # descriptive t
-0001aa00: 6974 6c65 0a20 2020 2020 2020 2022 696e  itle.        "in
-0001aa10: 666f 223a 207b 0a20 2020 2020 2020 2020  fo": {.         
-0001aa20: 2020 2022 7369 7a65 223a 2066 696c 655f     "size": file_
-0001aa30: 7374 6174 2e73 745f 7369 7a65 2c0a 2020  stat.st_size,.  
-0001aa40: 2020 2020 2020 2020 2020 226d 696d 6574            "mimet
-0001aa50: 7970 6522 3a20 6d69 6d65 5f74 7970 652c  ype": mime_type,
-0001aa60: 0a20 2020 2020 2020 2020 2020 2023 2022  .            # "
-0001aa70: 7468 756d 626e 6169 6c5f 696e 666f 223a  thumbnail_info":
-0001aa80: 204e 6f6e 652c 2020 2320 544f 444f 0a20   None,  # TODO. 
-0001aa90: 2020 2020 2020 2020 2020 2022 7722 3a20             "w": 
-0001aaa0: 7769 6474 682c 2020 2320 7769 6474 6820  width,  # width 
-0001aab0: 696e 2070 6978 656c 0a20 2020 2020 2020  in pixel.       
-0001aac0: 2020 2020 2022 6822 3a20 6865 6967 6874       "h": height
-0001aad0: 2c20 2023 2068 6569 6768 7420 696e 2070  ,  # height in p
-0001aae0: 6978 656c 0a20 2020 2020 2020 2020 2020  ixel.           
-0001aaf0: 2023 2022 7468 756d 626e 6169 6c5f 7572   # "thumbnail_ur
-0001ab00: 6c22 3a20 4e6f 6e65 2c20 2023 2054 4f44  l": None,  # TOD
-0001ab10: 4f0a 2020 2020 2020 2020 2020 2020 2278  O.            "x
-0001ab20: 797a 2e61 6d6f 7267 616e 2e62 6c75 7268  yz.amorgan.blurh
-0001ab30: 6173 6822 3a20 626c 7572 6861 7368 0a20  ash": blurhash. 
-0001ab40: 2020 2020 2020 2020 2020 2023 2022 7468             # "th
-0001ab50: 756d 626e 6169 6c5f 6669 6c65 223a 204e  umbnail_file": N
-0001ab60: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
-0001ab70: 2020 2020 2020 2020 226d 7367 7479 7065          "msgtype
-0001ab80: 223a 2022 6d2e 696d 6167 6522 2c0a 2020  ": "m.image",.  
-0001ab90: 2020 2020 2020 2266 696c 6522 3a20 7b0a        "file": {.
-0001aba0: 2020 2020 2020 2020 2020 2020 2275 726c              "url
-0001abb0: 223a 2072 6573 702e 636f 6e74 656e 745f  ": resp.content_
-0001abc0: 7572 692c 0a20 2020 2020 2020 2020 2020  uri,.           
-0001abd0: 2022 6b65 7922 3a20 6465 6372 7970 7469   "key": decrypti
-0001abe0: 6f6e 5f6b 6579 735b 226b 6579 225d 2c0a  on_keys["key"],.
-0001abf0: 2020 2020 2020 2020 2020 2020 2269 7622              "iv"
-0001ac00: 3a20 6465 6372 7970 7469 6f6e 5f6b 6579  : decryption_key
-0001ac10: 735b 2269 7622 5d2c 0a20 2020 2020 2020  s["iv"],.       
-0001ac20: 2020 2020 2022 6861 7368 6573 223a 2064       "hashes": d
-0001ac30: 6563 7279 7074 696f 6e5f 6b65 7973 5b22  ecryption_keys["
-0001ac40: 6861 7368 6573 225d 2c0a 2020 2020 2020  hashes"],.      
-0001ac50: 2020 2020 2020 2276 223a 2064 6563 7279        "v": decry
-0001ac60: 7074 696f 6e5f 6b65 7973 5b22 7622 5d2c  ption_keys["v"],
-0001ac70: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-0001ac80: 7d0a 0a20 2020 2069 6620 6973 5069 7065  }..    if isPipe
-0001ac90: 3a0a 2020 2020 2020 2020 2320 726d 2074  :.        # rm t
-0001aca0: 656d 7020 6669 6c65 0a20 2020 2020 2020  emp file.       
-0001acb0: 206f 732e 7265 6d6f 7665 2869 6d61 6765   os.remove(image
-0001acc0: 290a 0a20 2020 2074 7279 3a0a 2020 2020  )..    try:.    
-0001acd0: 2020 2020 666f 7220 726f 6f6d 5f69 6420      for room_id 
-0001ace0: 696e 2072 6f6f 6d73 3a0a 2020 2020 2020  in rooms:.      
-0001acf0: 2020 2020 2020 726f 6f6d 5f69 6420 3d20        room_id = 
-0001ad00: 6177 6169 7420 6d61 705f 726f 6f6d 696e  await map_roomin
-0001ad10: 666f 5f74 6f5f 726f 6f6d 6964 2863 6c69  fo_to_roomid(cli
-0001ad20: 656e 742c 2072 6f6f 6d5f 6964 290a 2020  ent, room_id).  
-0001ad30: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
-0001ad40: 2061 7761 6974 2063 6c69 656e 742e 726f   await client.ro
-0001ad50: 6f6d 5f73 656e 6428 0a20 2020 2020 2020  om_send(.       
-0001ad60: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
-0001ad70: 2c20 6d65 7373 6167 655f 7479 7065 3d22  , message_type="
-0001ad80: 6d2e 726f 6f6d 2e6d 6573 7361 6765 222c  m.room.message",
-0001ad90: 2063 6f6e 7465 6e74 3d63 6f6e 7465 6e74   content=content
-0001ada0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001adb0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0001adc0: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
-0001add0: 6f6f 6d53 656e 6445 7272 6f72 293a 0a20  oomSendError):. 
-0001ade0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0001adf0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-0001ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae10: 2022 4531 3438 3a20 220a 2020 2020 2020   "E148: ".      
-0001ae20: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-0001ae30: 6f6f 6d5f 7365 6e64 2066 6169 6c65 6420  oom_send failed 
-0001ae40: 7769 7468 2065 7272 6f72 2022 0a20 2020  with error ".   
-0001ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae60: 2066 2227 7b70 7269 7661 6379 5f66 696c   f"'{privacy_fil
-0001ae70: 7465 7228 7374 7228 7265 7370 2929 7d27  ter(str(resp))}'
-0001ae80: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-0001ae90: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001aea0: 2020 2020 2023 2067 732e 6572 725f 636f       # gs.err_co
-0001aeb0: 756e 7420 2b3d 2031 2023 206e 6f74 206e  unt += 1 # not n
-0001aec0: 6565 6465 642c 2077 696c 6c20 7261 6973  eeded, will rais
-0001aed0: 6520 6578 6365 7074 696f 6e0a 2020 2020  e exception.    
-0001aee0: 2020 2020 2020 2020 2020 2020 2320 696e              # in
-0001aef0: 2066 6f6c 6c6f 7769 6e67 206c 696e 6520   following line 
-0001af00: 6f66 2063 6f64 650a 2020 2020 2020 2020  of code.        
-0001af10: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
-0001af20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001af30: 2066 2754 6869 7320 696d 6167 6520 6669   f'This image fi
-0001af40: 6c65 2077 6173 2073 656e 743a 2022 7b69  le was sent: "{i
-0001af50: 6d61 6765 7d22 2027 0a20 2020 2020 2020  mage}" '.       
-0001af60: 2020 2020 2020 2020 2066 2774 6f20 726f           f'to ro
-0001af70: 6f6d 2022 7b72 6573 702e 726f 6f6d 5f69  om "{resp.room_i
-0001af80: 647d 2220 270a 2020 2020 2020 2020 2020  d}" '.          
-0001af90: 2020 2020 2020 6627 6173 2065 7665 6e74        f'as event
-0001afa0: 2022 7b72 6573 702e 6576 656e 745f 6964   "{resp.event_id
-0001afb0: 7d22 2e27 0a20 2020 2020 2020 2020 2020  }".'.           
-0001afc0: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-0001afd0: 6620 6773 2e70 612e 7072 696e 745f 6576  f gs.pa.print_ev
-0001afe0: 656e 745f 6964 3a0a 2020 2020 2020 2020  ent_id:.        
-0001aff0: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-0001b000: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
-0001b010: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
-0001b020: 666c 6167 0a20 2020 2020 2020 2020 2020  flag.           
-0001b030: 2020 2020 2074 6578 7420 3d20 6622 7b72       text = f"{r
-0001b040: 6573 702e 6576 656e 745f 6964 7d7b 5345  esp.event_id}{SE
-0001b050: 507d 7b72 6573 702e 726f 6f6d 5f69 647d  P}{resp.room_id}
-0001b060: 7b53 4550 7d7b 696d 6167 657d 220a 2020  {SEP}{image}".  
-0001b070: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001b080: 4f62 6a65 6374 206f 6620 7479 7065 2052  Object of type R
-0001b090: 6f6f 6d43 7265 6174 6552 6573 706f 6e73  oomCreateRespons
-0001b0a0: 6520 6973 206e 6f74 204a 534f 4e0a 2020  e is not JSON.  
-0001b0b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001b0c0: 7365 7269 616c 697a 6162 6c65 2c20 6865  serializable, he
-0001b0d0: 6e63 6520 7765 2075 7365 2074 6865 2064  nce we use the d
-0001b0e0: 6963 7469 6f6e 6172 792e 0a20 2020 2020  ictionary..     
-0001b0f0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0001b100: 6d61 7820 3d20 7265 7370 2e5f 5f64 6963  max = resp.__dic
-0001b110: 745f 5f0a 2020 2020 2020 2020 2020 2020  t__.            
-0001b120: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
-0001b130: 6174 6528 7b22 696d 6167 6522 3a20 696d  ate({"image": im
-0001b140: 6167 657d 2920 2023 2061 6464 2064 6963  age})  # add dic
-0001b150: 7420 6974 656d 730a 2020 2020 2020 2020  t items.        
-0001b160: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
-0001b170: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
-0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b190: 6a73 6f6e 5f2e 706f 7028 2274 7261 6e73  json_.pop("trans
-0001b1a0: 706f 7274 5f72 6573 706f 6e73 6522 290a  port_response").
-0001b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1c0: 6a73 6f6e 5f73 7065 6320 3d20 4e6f 6e65  json_spec = None
-0001b1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b1e0: 2070 7269 6e74 5f6f 7574 7075 7428 0a20   print_output(. 
-0001b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b200: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
-0001b210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b220: 2020 2020 2074 6578 743d 7465 7874 2c0a       text=text,.
-0001b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b240: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
-0001b250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b260: 2020 2020 206a 736f 6e5f 6d61 783d 6a73       json_max=js
-0001b270: 6f6e 5f6d 6178 2c0a 2020 2020 2020 2020  on_max,.        
-0001b280: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0001b290: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
-0001b2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b2b0: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
-0001b2c0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0001b2d0: 2020 2020 2020 2020 2020 2020 2066 2754               f'T
-0001b2e0: 6869 7320 696d 6167 6520 6669 6c65 2077  his image file w
-0001b2f0: 6173 2073 656e 743a 2022 7b69 6d61 6765  as sent: "{image
-0001b300: 7d22 2027 0a20 2020 2020 2020 2020 2020  }" '.           
-0001b310: 2020 2020 2066 2774 6f20 726f 6f6d 2022       f'to room "
-0001b320: 7b72 6f6f 6d5f 6964 7d22 2e20 270a 2020  {room_id}". '.  
-0001b330: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001b340: 5265 7370 6f6e 7365 3a20 6576 656e 745f  Response: event_
-0001b350: 6964 3d7b 7265 7370 2e65 7665 6e74 5f69  id={resp.event_i
-0001b360: 647d 2c20 726f 6f6d 5f69 643d 7b72 6573  d}, room_id={res
-0001b370: 702e 726f 6f6d 5f69 647d 2c20 220a 2020  p.room_id}, ".  
-0001b380: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001b390: 6675 6c6c 2072 6573 706f 6e73 653a 207b  full response: {
-0001b3a0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-0001b3b0: 7472 2872 6573 7029 297d 2e20 220a 2020  tr(resp))}. ".  
-0001b3c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001b3d0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0001b3e0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-0001b3f0: 2e65 7272 6f72 2822 4531 3439 3a20 2220  .error("E149: " 
-0001b400: 6622 496d 6167 6520 7365 6e64 206f 6620  f"Image send of 
-0001b410: 6669 6c65 207b 696d 6167 657d 2066 6169  file {image} fai
-0001b420: 6c65 642e 2053 6f72 7279 2e22 290a 2020  led. Sorry.").  
-0001b430: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-0001b440: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-0001b450: 6773 2e6c 6f67 2e64 6562 7567 2822 4865  gs.log.debug("He
-0001b460: 7265 2069 7320 7468 6520 7472 6163 6562  re is the traceb
-0001b470: 6163 6b2e 5c6e 2220 2b20 7472 6163 6562  ack.\n" + traceb
-0001b480: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
-0001b490: 290a 0a0a 2320 6163 636f 7264 696e 6720  )...# according 
-0001b4a0: 746f 206c 696e 7465 723a 2066 756e 6374  to linter: funct
-0001b4b0: 696f 6e20 6973 2074 6f6f 2063 6f6d 706c  ion is too compl
-0001b4c0: 6578 2c20 4339 3031 0a61 7379 6e63 2064  ex, C901.async d
-0001b4d0: 6566 2073 656e 645f 6d65 7373 6167 6528  ef send_message(
-0001b4e0: 636c 6965 6e74 2c20 726f 6f6d 732c 206d  client, rooms, m
-0001b4f0: 6573 7361 6765 293a 2020 2320 6e6f 7161  essage):  # noqa
-0001b500: 3a20 4339 3031 0a20 2020 2022 2222 5072  : C901.    """Pr
-0001b510: 6f63 6573 7320 6d65 7373 6167 652e 0a0a  ocess message...
-0001b520: 2020 2020 466f 726d 6174 206d 6573 7361      Format messa
-0001b530: 6765 2061 6363 6f72 6469 6e67 2074 6f20  ge according to 
-0001b540: 696e 7374 7275 6374 696f 6e73 2066 726f  instructions fro
-0001b550: 6d20 636f 6d6d 616e 6420 6c69 6e65 2061  m command line a
-0001b560: 7267 756d 656e 7473 2e0a 2020 2020 5468  rguments..    Th
-0001b570: 656e 2073 656e 6420 7468 6520 6f6e 6520  en send the one 
-0001b580: 6d65 7373 6167 6520 746f 2061 6c6c 2072  message to all r
-0001b590: 6f6f 6d73 2e0a 0a20 2020 2041 7267 756d  ooms...    Argum
-0001b5a0: 656e 7473 3a0a 2020 2020 2d2d 2d2d 2d2d  ents:.    ------
-0001b5b0: 2d2d 2d0a 2020 2020 636c 6965 6e74 203a  ---.    client :
-0001b5c0: 2043 6c69 656e 740a 2020 2020 726f 6f6d   Client.    room
-0001b5d0: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
-0001b5e0: 206c 6973 7420 6f66 2072 6f6f 6d5f 6964   list of room_id
-0001b5f0: 2d73 0a20 2020 206d 6573 7361 6765 203a  -s.    message :
-0001b600: 2073 7472 0a20 2020 2020 2020 206d 6573   str.        mes
-0001b610: 7361 6765 2074 6f20 7365 6e64 2061 7320  sage to send as 
-0001b620: 7265 6164 2066 726f 6d20 2d6d 2c20 7069  read from -m, pi
-0001b630: 7065 206f 7220 6b65 7962 6f61 7264 0a20  pe or keyboard. 
-0001b640: 2020 2020 2020 206d 6573 7361 6765 2069         message i
-0001b650: 7320 7769 7468 6f75 7420 6d69 6d65 2066  s without mime f
-0001b660: 6f72 6d61 7474 696e 670a 0a20 2020 2022  ormatting..    "
-0001b670: 2222 0a20 2020 2069 6620 6e6f 7420 726f  "".    if not ro
-0001b680: 6f6d 733a 0a20 2020 2020 2020 2067 732e  oms:.        gs.
-0001b690: 6c6f 672e 696e 666f 280a 2020 2020 2020  log.info(.      
-0001b6a0: 2020 2020 2020 224e 6f20 726f 6f6d 7320        "No rooms 
-0001b6b0: 6172 6520 6769 7665 6e2e 2054 6869 7320  are given. This 
-0001b6c0: 7368 6f75 6c64 206e 6f74 2068 6170 7065  should not happe
-0001b6d0: 6e2e 2022 0a20 2020 2020 2020 2020 2020  n. ".           
-0001b6e0: 2022 4d61 7962 6520 796f 7572 2044 4d20   "Maybe your DM 
-0001b6f0: 726f 6f6d 7320 7370 6563 6966 6965 6420  rooms specified 
-0001b700: 7669 6120 2d2d 7573 6572 2077 6572 6520  via --user were 
-0001b710: 6e6f 7420 666f 756e 642e 2022 0a20 2020  not found. ".   
-0001b720: 2020 2020 2020 2020 2022 5468 6973 2074           "This t
-0001b730: 6578 7420 6d65 7373 6167 6520 6973 2062  ext message is b
-0001b740: 6569 6e67 2064 726f 7070 6564 2061 6e64  eing dropped and
-0001b750: 204e 4f54 2073 656e 742e 220a 2020 2020   NOT sent.".    
-0001b760: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-0001b770: 7475 726e 0a20 2020 2023 2072 656d 6f76  turn.    # remov
-0001b780: 6520 6c65 6164 696e 6720 414e 4420 7472  e leading AND tr
-0001b790: 6169 6c69 6e67 206e 6577 6c69 6e65 7320  ailing newlines 
-0001b7a0: 746f 2062 6561 7574 6966 790a 2020 2020  to beautify.    
-0001b7b0: 6d65 7373 6167 6520 3d20 6d65 7373 6167  message = messag
-0001b7c0: 652e 7374 7269 7028 225c 6e22 290a 0a20  e.strip("\n").. 
-0001b7d0: 2020 2069 6620 6d65 7373 6167 652e 7374     if message.st
-0001b7e0: 7269 7028 2920 3d3d 2022 223a 0a20 2020  rip() == "":.   
-0001b7f0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0001b800: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
-0001b810: 5468 6520 6d65 7373 6167 6520 6973 2065  The message is e
-0001b820: 6d70 7479 2e20 220a 2020 2020 2020 2020  mpty. ".        
-0001b830: 2020 2020 2254 6869 7320 6d65 7373 6167      "This messag
-0001b840: 6520 6973 2062 6569 6e67 2064 726f 7070  e is being dropp
-0001b850: 6564 2061 6e64 204e 4f54 2073 656e 742e  ed and NOT sent.
-0001b860: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0001b870: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0001b880: 6966 2067 732e 7061 2e6e 6f74 6963 653a  if gs.pa.notice:
-0001b890: 0a20 2020 2020 2020 2063 6f6e 7465 6e74  .        content
-0001b8a0: 203d 207b 226d 7367 7479 7065 223a 2022   = {"msgtype": "
-0001b8b0: 6d2e 6e6f 7469 6365 227d 0a20 2020 2065  m.notice"}.    e
-0001b8c0: 6c73 653a 0a20 2020 2020 2020 2063 6f6e  lse:.        con
-0001b8d0: 7465 6e74 203d 207b 226d 7367 7479 7065  tent = {"msgtype
-0001b8e0: 223a 2022 6d2e 7465 7874 227d 0a0a 2020  ": "m.text"}..  
-0001b8f0: 2020 6966 2067 732e 7061 2e63 6f64 653a    if gs.pa.code:
-0001b900: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-0001b910: 6465 6275 6728 2753 656e 6469 6e67 206d  debug('Sending m
-0001b920: 6573 7361 6765 2069 6e20 666f 726d 6174  essage in format
-0001b930: 2022 636f 6465 222e 2729 0a20 2020 2020   "code".').     
-0001b940: 2020 2066 6f72 6d61 7474 6564 5f6d 6573     formatted_mes
-0001b950: 7361 6765 203d 2022 3c70 7265 3e3c 636f  sage = "<pre><co
-0001b960: 6465 3e22 202b 206d 6573 7361 6765 202b  de>" + message +
-0001b970: 2022 5c6e 3c2f 636f 6465 3e3c 2f70 7265   "\n</code></pre
-0001b980: 3e5c 6e22 0a20 2020 2020 2020 2063 6f6e  >\n".        con
-0001b990: 7465 6e74 5b22 666f 726d 6174 225d 203d  tent["format"] =
-0001b9a0: 2022 6f72 672e 6d61 7472 6978 2e63 7573   "org.matrix.cus
-0001b9b0: 746f 6d2e 6874 6d6c 2220 2023 2061 6464  tom.html"  # add
-0001b9c0: 2074 6f20 6469 6374 0a20 2020 2020 2020   to dict.       
-0001b9d0: 2063 6f6e 7465 6e74 5b22 666f 726d 6174   content["format
-0001b9e0: 7465 645f 626f 6479 225d 203d 2066 6f72  ted_body"] = for
-0001b9f0: 6d61 7474 6564 5f6d 6573 7361 6765 0a20  matted_message. 
-0001ba00: 2020 2020 2020 2023 206e 6578 7420 6c69         # next li
-0001ba10: 6e65 3a20 776f 726b 2d61 726f 756e 6420  ne: work-around 
-0001ba20: 666f 7220 456c 656d 656e 7420 416e 6472  for Element Andr
-0001ba30: 6f69 640a 2020 2020 2020 2020 6d65 7373  oid.        mess
-0001ba40: 6167 6520 3d20 2260 6060 5c6e 2220 2b20  age = "```\n" + 
-0001ba50: 6d65 7373 6167 6520 2b20 225c 6e60 6060  message + "\n```
-0001ba60: 2220 2023 2074 6f20 666f 726d 6174 2069  "  # to format i
-0001ba70: 7420 6173 2063 6f64 650a 2020 2020 656c  t as code.    el
-0001ba80: 6966 2067 732e 7061 2e6d 6172 6b64 6f77  if gs.pa.markdow
-0001ba90: 6e3a 0a20 2020 2020 2020 2067 732e 6c6f  n:.        gs.lo
-0001baa0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-0001bab0: 2020 2020 2022 436f 6e76 6572 7469 6e67       "Converting
-0001bac0: 206d 6573 7361 6765 2066 726f 6d20 4d61   message from Ma
-0001bad0: 726b 446f 776e 2069 6e74 6f20 4854 4d4c  rkDown into HTML
-0001bae0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0001baf0: 2753 656e 6469 6e67 206d 6573 7361 6765  'Sending message
-0001bb00: 2069 6e20 666f 726d 6174 2022 6d61 726b   in format "mark
-0001bb10: 646f 776e 222e 270a 2020 2020 2020 2020  down".'.        
-0001bb20: 290a 2020 2020 2020 2020 2320 652e 672e  ).        # e.g.
-0001bb30: 2063 6f6e 7665 7274 7320 6672 6f6d 2022   converts from "
-0001bb40: 2d61 6263 2220 746f 2022 3c75 6c3e 3c6c  -abc" to "<ul><l
-0001bb50: 693e 6162 633c 2f6c 693e 3c2f 756c 3e22  i>abc</li></ul>"
-0001bb60: 0a20 2020 2020 2020 2066 6f72 6d61 7474  .        formatt
-0001bb70: 6564 5f6d 6573 7361 6765 203d 206d 6172  ed_message = mar
-0001bb80: 6b64 6f77 6e28 6d65 7373 6167 6529 0a20  kdown(message). 
-0001bb90: 2020 2020 2020 2063 6f6e 7465 6e74 5b22         content["
-0001bba0: 666f 726d 6174 225d 203d 2022 6f72 672e  format"] = "org.
-0001bbb0: 6d61 7472 6978 2e63 7573 746f 6d2e 6874  matrix.custom.ht
-0001bbc0: 6d6c 2220 2023 2061 6464 2074 6f20 6469  ml"  # add to di
-0001bbd0: 6374 0a20 2020 2020 2020 2063 6f6e 7465  ct.        conte
-0001bbe0: 6e74 5b22 666f 726d 6174 7465 645f 626f  nt["formatted_bo
-0001bbf0: 6479 225d 203d 2066 6f72 6d61 7474 6564  dy"] = formatted
-0001bc00: 5f6d 6573 7361 6765 0a20 2020 2065 6c69  _message.    eli
-0001bc10: 6620 6773 2e70 612e 6874 6d6c 3a0a 2020  f gs.pa.html:.  
-0001bc20: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0001bc30: 7567 2827 5365 6e64 696e 6720 6d65 7373  ug('Sending mess
-0001bc40: 6167 6520 696e 2066 6f72 6d61 7420 2268  age in format "h
-0001bc50: 746d 6c22 2e27 290a 2020 2020 2020 2020  tml".').        
-0001bc60: 666f 726d 6174 7465 645f 6d65 7373 6167  formatted_messag
-0001bc70: 6520 3d20 6d65 7373 6167 6520 2023 2074  e = message  # t
-0001bc80: 6865 2073 616d 6520 666f 7220 7468 6520  he same for the 
-0001bc90: 7469 6d65 2062 6569 6e67 0a20 2020 2020  time being.     
-0001bca0: 2020 2063 6f6e 7465 6e74 5b22 666f 726d     content["form
-0001bcb0: 6174 225d 203d 2022 6f72 672e 6d61 7472  at"] = "org.matr
-0001bcc0: 6978 2e63 7573 746f 6d2e 6874 6d6c 2220  ix.custom.html" 
-0001bcd0: 2023 2061 6464 2074 6f20 6469 6374 0a20   # add to dict. 
-0001bce0: 2020 2020 2020 2063 6f6e 7465 6e74 5b22         content["
-0001bcf0: 666f 726d 6174 7465 645f 626f 6479 225d  formatted_body"]
-0001bd00: 203d 2066 6f72 6d61 7474 6564 5f6d 6573   = formatted_mes
-0001bd10: 7361 6765 0a20 2020 2065 6c69 6620 6773  sage.    elif gs
-0001bd20: 2e70 612e 656d 6f6a 697a 653a 0a20 2020  .pa.emojize:.   
-0001bd30: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-0001bd40: 6728 2753 656e 6469 6e67 206d 6573 7361  g('Sending messa
-0001bd50: 6765 2069 6e20 666f 726d 6174 2022 656d  ge in format "em
-0001bd60: 6f6a 697a 6564 222e 2729 0a20 2020 2020  ojized".').     
-0001bd70: 2020 2066 6f72 6d61 7474 6564 5f6d 6573     formatted_mes
-0001bd80: 7361 6765 203d 2065 6d6f 6a69 2e65 6d6f  sage = emoji.emo
-0001bd90: 6a69 7a65 280a 2020 2020 2020 2020 2020  jize(.          
-0001bda0: 2020 6d65 7373 6167 650a 2020 2020 2020    message.      
-0001bdb0: 2020 2920 2023 2063 6f6e 7665 7274 2065    )  # convert e
-0001bdc0: 6d6f 6a69 2073 686f 7274 636f 6465 7320  moji shortcodes 
-0001bdd0: 6966 2070 7265 7365 6e74 0a20 2020 2020  if present.     
-0001bde0: 2020 2063 6f6e 7465 6e74 5b22 666f 726d     content["form
-0001bdf0: 6174 225d 203d 2022 6f72 672e 6d61 7472  at"] = "org.matr
-0001be00: 6978 2e63 7573 746f 6d2e 6874 6d6c 2220  ix.custom.html" 
-0001be10: 2023 2061 6464 2074 6f20 6469 6374 0a20   # add to dict. 
-0001be20: 2020 2020 2020 2063 6f6e 7465 6e74 5b22         content["
-0001be30: 666f 726d 6174 7465 645f 626f 6479 225d  formatted_body"]
-0001be40: 203d 2066 6f72 6d61 7474 6564 5f6d 6573   = formatted_mes
-0001be50: 7361 6765 0a20 2020 2065 6c73 653a 0a20  sage.    else:. 
-0001be60: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0001be70: 6275 6728 2753 656e 6469 6e67 206d 6573  bug('Sending mes
-0001be80: 7361 6765 2069 6e20 666f 726d 6174 2022  sage in format "
-0001be90: 7465 7874 222e 2729 0a20 2020 2063 6f6e  text".').    con
-0001bea0: 7465 6e74 5b22 626f 6479 225d 203d 206d  tent["body"] = m
-0001beb0: 6573 7361 6765 0a0a 2020 2020 7472 793a  essage..    try:
-0001bec0: 0a20 2020 2020 2020 2066 6f72 2072 6f6f  .        for roo
-0001bed0: 6d5f 6964 2069 6e20 726f 6f6d 733a 0a20  m_id in rooms:. 
-0001bee0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-0001bef0: 6964 203d 2061 7761 6974 206d 6170 5f72  id = await map_r
-0001bf00: 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f 6d69  oominfo_to_roomi
-0001bf10: 6428 636c 6965 6e74 2c20 726f 6f6d 5f69  d(client, room_i
-0001bf20: 6429 0a20 2020 2020 2020 2020 2020 2072  d).            r
-0001bf30: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-0001bf40: 6e74 2e72 6f6f 6d5f 7365 6e64 280a 2020  nt.room_send(.  
-0001bf50: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-0001bf60: 6f6d 5f69 642c 0a20 2020 2020 2020 2020  om_id,.         
-0001bf70: 2020 2020 2020 206d 6573 7361 6765 5f74         message_t
-0001bf80: 7970 653d 226d 2e72 6f6f 6d2e 6d65 7373  ype="m.room.mess
-0001bf90: 6167 6522 2c0a 2020 2020 2020 2020 2020  age",.          
-0001bfa0: 2020 2020 2020 636f 6e74 656e 743d 636f        content=co
-0001bfb0: 6e74 656e 742c 0a20 2020 2020 2020 2020  ntent,.         
-0001bfc0: 2020 2020 2020 2069 676e 6f72 655f 756e         ignore_un
-0001bfd0: 7665 7269 6669 6564 5f64 6576 6963 6573  verified_devices
-0001bfe0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-0001bff0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001c000: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-0001c010: 6573 702c 2052 6f6f 6d53 656e 6445 7272  esp, RoomSendErr
-0001c020: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0001c030: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-0001c040: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0001c050: 2020 2020 2020 2022 4531 3530 3a20 220a         "E150: ".
-0001c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c070: 2020 2020 2272 6f6f 6d5f 7365 6e64 2066      "room_send f
-0001c080: 6169 6c65 6420 7769 7468 2065 7272 6f72  ailed with error
-0001c090: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0001c0a0: 2020 2020 2020 2066 2227 7b70 7269 7661         f"'{priva
-0001c0b0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0001c0c0: 7370 2929 7d27 2e22 0a20 2020 2020 2020  sp))}'.".       
-0001c0d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001c0e0: 2020 2020 2020 2020 2020 2023 2067 732e             # gs.
-0001c0f0: 6572 725f 636f 756e 7420 2b3d 2031 2023  err_count += 1 #
-0001c100: 206e 6f74 206e 6565 6465 642c 2077 696c   not needed, wil
-0001c110: 6c20 7261 6973 6520 6578 6365 7074 696f  l raise exceptio
-0001c120: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0001c130: 2020 2320 696e 2066 6f6c 6c6f 7769 6e67    # in following
-0001c140: 206c 696e 6520 6f66 2063 6f64 650a 2020   line of code.  
-0001c150: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0001c160: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-0001c170: 2020 2020 2020 2066 2754 6869 7320 6d65         f'This me
-0001c180: 7373 6167 6520 7761 7320 7365 6e74 3a20  ssage was sent: 
-0001c190: 227b 6d65 7373 6167 657d 2220 746f 2072  "{message}" to r
-0001c1a0: 6f6f 6d20 227b 7265 7370 2e72 6f6f 6d5f  oom "{resp.room_
-0001c1b0: 6964 7d22 2027 0a20 2020 2020 2020 2020  id}" '.         
-0001c1c0: 2020 2020 2020 2066 2761 7320 6576 656e         f'as even
-0001c1d0: 7420 227b 7265 7370 2e65 7665 6e74 5f69  t "{resp.event_i
-0001c1e0: 647d 222e 270a 2020 2020 2020 2020 2020  d}".'.          
-0001c1f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001c200: 6966 2067 732e 7061 2e70 7269 6e74 5f65  if gs.pa.print_e
-0001c210: 7665 6e74 5f69 643a 0a20 2020 2020 2020  vent_id:.       
-0001c220: 2020 2020 2020 2020 2023 206f 7574 7075           # outpu
-0001c230: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
-0001c240: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
-0001c250: 2066 6c61 670a 2020 2020 2020 2020 2020   flag.          
-0001c260: 2020 2020 2020 7465 7874 203d 2066 227b        text = f"{
-0001c270: 7265 7370 2e65 7665 6e74 5f69 647d 7b53  resp.event_id}{S
-0001c280: 4550 7d7b 7265 7370 2e72 6f6f 6d5f 6964  EP}{resp.room_id
-0001c290: 7d7b 5345 507d 7b6d 6573 7361 6765 7d22  }{SEP}{message}"
-0001c2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c2b0: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
-0001c2c0: 6520 526f 6f6d 4372 6561 7465 5265 7370  e RoomCreateResp
-0001c2d0: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
-0001c2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c2f0: 2023 2073 6572 6961 6c69 7a61 626c 652c   # serializable,
-0001c300: 2068 656e 6365 2077 6520 7573 6520 7468   hence we use th
-0001c310: 6520 6469 6374 696f 6e61 7279 2e0a 2020  e dictionary..  
-0001c320: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-0001c330: 6f6e 5f6d 6178 203d 2072 6573 702e 5f5f  on_max = resp.__
-0001c340: 6469 6374 5f5f 0a20 2020 2020 2020 2020  dict__.         
-0001c350: 2020 2020 2020 206a 736f 6e5f 6d61 782e         json_max.
-0001c360: 7570 6461 7465 287b 226d 6573 7361 6765  update({"message
-0001c370: 223a 206d 6573 7361 6765 7d29 2020 2320  ": message})  # 
-0001c380: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
-0001c390: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-0001c3a0: 736f 6e5f 203d 206a 736f 6e5f 6d61 782e  son_ = json_max.
-0001c3b0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-0001c3c0: 2020 2020 2020 206a 736f 6e5f 2e70 6f70         json_.pop
-0001c3d0: 2822 7472 616e 7370 6f72 745f 7265 7370  ("transport_resp
-0001c3e0: 6f6e 7365 2229 0a20 2020 2020 2020 2020  onse").         
-0001c3f0: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
-0001c400: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0001c410: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
-0001c420: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-0001c430: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
-0001c440: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-0001c450: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0001c460: 3d74 6578 742c 0a20 2020 2020 2020 2020  =text,.         
-0001c470: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0001c480: 3d6a 736f 6e5f 2c0a 2020 2020 2020 2020  =json_,.        
-0001c490: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0001c4a0: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
-0001c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c4c0: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-0001c4d0: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
-0001c4e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001c4f0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0001c500: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0001c510: 2020 2020 6627 5468 6973 206d 6573 7361      f'This messa
-0001c520: 6765 2077 6173 2073 656e 743a 2022 7b6d  ge was sent: "{m
-0001c530: 6573 7361 6765 7d22 2074 6f20 726f 6f6d  essage}" to room
-0001c540: 2022 7b72 6f6f 6d5f 6964 7d22 2e20 270a   "{room_id}". '.
-0001c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c560: 6622 5265 7370 6f6e 7365 3a20 6576 656e  f"Response: even
-0001c570: 745f 6964 3d7b 7265 7370 2e65 7665 6e74  t_id={resp.event
-0001c580: 5f69 647d 2c20 726f 6f6d 5f69 643d 7b72  _id}, room_id={r
-0001c590: 6573 702e 726f 6f6d 5f69 647d 2c20 220a  esp.room_id}, ".
-0001c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5b0: 6622 6675 6c6c 2072 6573 706f 6e73 653a  f"full response:
-0001c5c0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
-0001c5d0: 2873 7472 2872 6573 7029 297d 2e20 220a  (str(resp))}. ".
-0001c5e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001c5f0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0001c600: 6f6e 3a0a 2020 2020 2020 2020 6773 2e6c  on:.        gs.l
-0001c610: 6f67 2e65 7272 6f72 2822 4531 3531 3a20  og.error("E151: 
-0001c620: 2220 224d 6573 7361 6765 2073 656e 6420  " "Message send 
-0001c630: 6661 696c 6564 2e20 536f 7272 792e 2229  failed. Sorry.")
-0001c640: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
-0001c650: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0001c660: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0001c670: 2248 6572 6520 6973 2074 6865 2074 7261  "Here is the tra
-0001c680: 6365 6261 636b 2e5c 6e22 202b 2074 7261  ceback.\n" + tra
-0001c690: 6365 6261 636b 2e66 6f72 6d61 745f 6578  ceback.format_ex
-0001c6a0: 6328 2929 0a0a 0a61 7379 6e63 2064 6566  c())...async def
-0001c6b0: 2073 7472 6561 6d5f 6d65 7373 6167 6573   stream_messages
-0001c6c0: 5f66 726f 6d5f 7069 7065 2863 6c69 656e  _from_pipe(clien
-0001c6d0: 742c 2072 6f6f 6d73 293a 0a20 2020 2022  t, rooms):.    "
-0001c6e0: 2222 5265 6164 2069 6e70 7574 2066 726f  ""Read input fro
-0001c6f0: 6d20 7069 7065 2069 6620 6176 6169 6c61  m pipe if availa
-0001c700: 626c 652e 0a0a 2020 2020 5265 6164 2070  ble...    Read p
-0001c710: 6970 6520 6c69 6e65 2062 7920 6c69 6e65  ipe line by line
-0001c720: 2e20 466f 7220 6561 6368 206c 696e 6520  . For each line 
-0001c730: 7265 6365 6976 6564 2c20 696d 6d65 6469  received, immedi
-0001c740: 6174 656c 790a 2020 2020 7365 6e64 2069  ately.    send i
-0001c750: 742e 0a0a 2020 2020 4172 6775 6d65 6e74  t...    Argument
-0001c760: 733a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  s:.    ---------
-0001c770: 0a20 2020 2063 6c69 656e 7420 3a20 436c  .    client : Cl
-0001c780: 6965 6e74 0a20 2020 2072 6f6f 6d73 203a  ient.    rooms :
-0001c790: 206c 6973 7420 6f66 2072 6f6f 6d5f 6964   list of room_id
-0001c7a0: 730a 0a20 2020 2022 2222 0a20 2020 2073  s..    """.    s
-0001c7b0: 7464 696e 5f72 6561 6479 203d 2073 656c  tdin_ready = sel
-0001c7c0: 6563 742e 7365 6c65 6374 285b 7379 732e  ect.select([sys.
-0001c7d0: 7374 6469 6e2c 5d2c 205b 5d2c 205b 5d2c  stdin,], [], [],
-0001c7e0: 2030 2e30 295b 2020 2320 6e6f 7161 0a20   0.0)[  # noqa. 
-0001c7f0: 2020 2020 2020 2030 0a20 2020 205d 2020         0.    ]  
-0001c800: 2320 6e6f 7161 0a20 2020 2069 6620 6e6f  # noqa.    if no
-0001c810: 7420 7374 6469 6e5f 7265 6164 793a 0a20  t stdin_ready:. 
-0001c820: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0001c830: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0001c840: 2022 7374 6469 6e20 6973 206e 6f74 2072   "stdin is not r
-0001c850: 6561 6479 2066 6f72 2073 7472 6561 6d69  eady for streami
-0001c860: 6e67 2e20 220a 2020 2020 2020 2020 2020  ng. ".          
-0001c870: 2020 2241 2070 6970 6520 636f 756c 6420    "A pipe could 
-0001c880: 6265 2075 7365 642c 2062 7574 2070 6970  be used, but pip
-0001c890: 6520 636f 756c 6420 6265 2065 6d70 7479  e could be empty
-0001c8a0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-0001c8b0: 2273 7464 696e 2063 6f75 6c64 2061 6c73  "stdin could als
-0001c8c0: 6f20 6265 2061 206b 6579 626f 6172 642e  o be a keyboard.
-0001c8d0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0001c8e0: 656c 7365 3a0a 2020 2020 2020 2020 6773  else:.        gs
-0001c8f0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0001c900: 2020 2020 2020 2020 2273 7464 696e 2069          "stdin i
-0001c910: 7320 7265 6164 792e 2053 6f6d 6574 6869  s ready. Somethi
-0001c920: 6e67 2022 0a20 2020 2020 2020 2020 2020  ng ".           
-0001c930: 2022 6973 2064 6566 696e 6974 656c 7920   "is definitely 
-0001c940: 7069 7065 6420 696e 746f 2070 726f 6772  piped into progr
-0001c950: 616d 2066 726f 6d20 7374 6469 6e2e 2022  am from stdin. "
-0001c960: 0a20 2020 2020 2020 2020 2020 2022 5265  .            "Re
-0001c970: 6164 696e 6720 6d65 7373 6167 6520 6672  ading message fr
-0001c980: 6f6d 2073 7464 696e 2070 6970 652e 220a  om stdin pipe.".
-0001c990: 2020 2020 2020 2020 290a 2020 2020 6966          ).    if
-0001c9a0: 2028 286e 6f74 2073 7464 696e 5f72 6561   ((not stdin_rea
-0001c9b0: 6479 2920 616e 6420 286e 6f74 2073 7973  dy) and (not sys
-0001c9c0: 2e73 7464 696e 2e69 7361 7474 7928 2929  .stdin.isatty())
-0001c9d0: 2920 6f72 2073 7464 696e 5f72 6561 6479  ) or stdin_ready
-0001c9e0: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-0001c9f0: 2073 7973 2e73 7464 696e 2e69 7361 7474   sys.stdin.isatt
-0001ca00: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-0001ca10: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-0001ca20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001ca30: 5069 7065 2077 6173 2064 6566 696e 6974  Pipe was definit
-0001ca40: 656c 7920 7573 6564 2c20 6275 7420 7069  ely used, but pi
-0001ca50: 7065 206d 6967 6874 2062 6520 656d 7074  pe might be empt
-0001ca60: 792e 2022 0a20 2020 2020 2020 2020 2020  y. ".           
-0001ca70: 2020 2020 2022 5472 7969 6e67 2074 6f20       "Trying to 
-0001ca80: 7265 6164 2066 726f 6d20 7069 7065 2069  read from pipe i
-0001ca90: 6e20 616e 7920 6361 7365 2e22 0a20 2020  n any case.".   
-0001caa0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001cab0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001cac0: 2020 2020 666f 7220 6c69 6e65 2069 6e20      for line in 
-0001cad0: 7379 732e 7374 6469 6e3a 0a20 2020 2020  sys.stdin:.     
-0001cae0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0001caf0: 2073 656e 645f 6d65 7373 6167 6528 636c   send_message(cl
-0001cb00: 6965 6e74 2c20 726f 6f6d 732c 206c 696e  ient, rooms, lin
-0001cb10: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0001cb20: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0001cb30: 2255 7369 6e67 2064 6174 6120 6672 6f6d  "Using data from
-0001cb40: 2073 7464 696e 2070 6970 6520 7374 7265   stdin pipe stre
-0001cb50: 616d 2061 7320 6d65 7373 6167 652e 2229  am as message.")
-0001cb60: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0001cb70: 454f 4645 7272 6f72 3a20 2023 2045 4f46  EOFError:  # EOF
-0001cb80: 2077 6865 6e20 7265 6164 696e 6720 6120   when reading a 
-0001cb90: 6c69 6e65 0a20 2020 2020 2020 2020 2020  line.           
-0001cba0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001cbc0: 5265 6164 696e 6720 6672 6f6d 2073 7464  Reading from std
-0001cbd0: 696e 2072 6573 756c 7465 6420 696e 2045  in resulted in E
-0001cbe0: 4f46 2e20 5468 6973 2063 616e 2068 6170  OF. This can hap
-0001cbf0: 7065 6e20 220a 2020 2020 2020 2020 2020  pen ".          
-0001cc00: 2020 2020 2020 2277 6865 6e20 6120 7069        "when a pi
-0001cc10: 7065 2077 6173 2075 7365 642c 2062 7574  pe was used, but
-0001cc20: 2074 6865 2070 6970 6520 6973 2065 6d70   the pipe is emp
-0001cc30: 7479 2e20 220a 2020 2020 2020 2020 2020  ty. ".          
-0001cc40: 2020 2020 2020 224e 6f20 6d65 7373 6167        "No messag
-0001cc50: 6520 7769 6c6c 2062 6520 6765 6e65 7261  e will be genera
-0001cc60: 7465 642e 220a 2020 2020 2020 2020 2020  ted.".          
-0001cc70: 2020 290a 2020 2020 2020 2020 6578 6365    ).        exce
-0001cc80: 7074 2055 6e69 636f 6465 4465 636f 6465  pt UnicodeDecode
-0001cc90: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001cca0: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
-0001ccb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ccc0: 2252 6561 6469 6e67 2066 726f 6d20 7374  "Reading from st
-0001ccd0: 6469 6e20 7265 7375 6c74 6564 2069 6e20  din resulted in 
-0001cce0: 556e 6963 6f64 6544 6563 6f64 6545 7272  UnicodeDecodeErr
-0001ccf0: 6f72 2e20 5468 6973 2022 0a20 2020 2020  or. This ".     
-0001cd00: 2020 2020 2020 2020 2020 2022 6361 6e20             "can 
-0001cd10: 6861 7070 656e 2069 6620 796f 7520 7472  happen if you tr
-0001cd20: 7920 746f 2070 6970 6520 6269 6e61 7279  y to pipe binary
-0001cd30: 2064 6174 6120 666f 7220 6120 7465 7874   data for a text
-0001cd40: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0001cd50: 2020 2022 6d65 7373 6167 652e 2046 6f72     "message. For
-0001cd60: 2061 2074 6578 7420 6d65 7373 6167 6520   a text message 
-0001cd70: 6f6e 6c79 2070 6970 6520 7465 7874 2076  only pipe text v
-0001cd80: 6961 2073 7464 696e 2c20 220a 2020 2020  ia stdin, ".    
-0001cd90: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
-0001cda0: 2062 696e 6172 7920 6461 7461 2e20 4e6f   binary data. No
-0001cdb0: 206d 6573 7361 6765 2077 696c 6c20 6265   message will be
-0001cdc0: 2067 656e 6572 6174 6564 2e22 0a20 2020   generated.".   
-0001cdd0: 2020 2020 2020 2020 2029 0a0a 0a64 6566           )...def
-0001cde0: 2067 6574 5f6d 6573 7361 6765 735f 6672   get_messages_fr
-0001cdf0: 6f6d 5f70 6970 6528 2920 2d3e 206c 6973  om_pipe() -> lis
-0001ce00: 743a 0a20 2020 2022 2222 5265 6164 2069  t:.    """Read i
-0001ce10: 6e70 7574 2066 726f 6d20 7069 7065 2069  nput from pipe i
-0001ce20: 6620 6176 6169 6c61 626c 652e 0a0a 2020  f available...  
-0001ce30: 2020 5265 7475 726e 205b 5d20 6966 206e    Return [] if n
-0001ce40: 6f20 696e 7075 7420 6176 6169 6c61 626c  o input availabl
-0001ce50: 6520 6f6e 2070 6970 6520 7374 6469 6e2e  e on pipe stdin.
-0001ce60: 0a20 2020 2052 6574 7572 6e20 5b22 736f  .    Return ["so
-0001ce70: 6d65 2d6d 7367 225d 2069 6620 696e 7075  me-msg"] if inpu
-0001ce80: 7420 6973 2061 7661 696c 626c 652e 0a20  t is availble.. 
-0001ce90: 2020 204d 6967 6874 2061 6c73 6f20 7265     Might also re
-0001cea0: 7475 726e 205b 2222 5d20 6f66 2063 6f75  turn [""] of cou
-0001ceb0: 7273 6520 6966 2022 2220 7761 7320 696e  rse if "" was in
-0001cec0: 2070 6970 652e 0a20 2020 2043 7572 7265   pipe..    Curre
-0001ced0: 6e74 6c79 2074 6865 7265 2069 7320 6174  ntly there is at
-0001cee0: 206d 6f73 7420 3120 6d73 6720 696e 2074   most 1 msg in t
-0001cef0: 6865 2072 6574 7572 6e65 6420 6c69 7374  he returned list
-0001cf00: 2e0a 2020 2020 2222 220a 2020 2020 6d65  ..    """.    me
-0001cf10: 7373 6167 6573 203d 205b 5d0a 2020 2020  ssages = [].    
-0001cf20: 7374 6469 6e5f 7265 6164 7920 3d20 7365  stdin_ready = se
-0001cf30: 6c65 6374 2e73 656c 6563 7428 5b73 7973  lect.select([sys
-0001cf40: 2e73 7464 696e 2c5d 2c20 5b5d 2c20 5b5d  .stdin,], [], []
-0001cf50: 2c20 302e 3029 5b20 2023 206e 6f71 610a  , 0.0)[  # noqa.
-0001cf60: 2020 2020 2020 2020 300a 2020 2020 5d20          0.    ] 
-0001cf70: 2023 206e 6f71 610a 2020 2020 6966 206e   # noqa.    if n
-0001cf80: 6f74 2073 7464 696e 5f72 6561 6479 3a0a  ot stdin_ready:.
-0001cf90: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0001cfa0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-0001cfb0: 2020 2273 7464 696e 2069 7320 6e6f 7420    "stdin is not 
-0001cfc0: 7265 6164 7920 666f 7220 7265 6164 696e  ready for readin
-0001cfd0: 672e 2022 0a20 2020 2020 2020 2020 2020  g. ".           
-0001cfe0: 2022 4120 7069 7065 2063 6f75 6c64 2062   "A pipe could b
-0001cff0: 6520 7573 6564 2c20 6275 7420 7069 7065  e used, but pipe
-0001d000: 2063 6f75 6c64 2062 6520 656d 7074 792c   could be empty,
-0001d010: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0001d020: 7374 6469 6e20 636f 756c 6420 616c 736f  stdin could also
-0001d030: 2062 6520 6120 6b65 7962 6f61 7264 2e22   be a keyboard."
-0001d040: 0a20 2020 2020 2020 2029 0a20 2020 2065  .        ).    e
-0001d050: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
-0001d060: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0001d070: 2020 2020 2020 2022 7374 6469 6e20 6973         "stdin is
-0001d080: 2072 6561 6479 2e20 536f 6d65 7468 696e   ready. Somethin
-0001d090: 6720 220a 2020 2020 2020 2020 2020 2020  g ".            
-0001d0a0: 2269 7320 6465 6669 6e69 7465 6c79 2070  "is definitely p
-0001d0b0: 6970 6564 2069 6e74 6f20 7072 6f67 7261  iped into progra
-0001d0c0: 6d20 6672 6f6d 2073 7464 696e 2e20 220a  m from stdin. ".
-0001d0d0: 2020 2020 2020 2020 2020 2020 2252 6561              "Rea
-0001d0e0: 6469 6e67 206d 6573 7361 6765 2066 726f  ding message fro
-0001d0f0: 6d20 7374 6469 6e20 7069 7065 2e22 0a20  m stdin pipe.". 
-0001d100: 2020 2020 2020 2029 0a20 2020 2069 6620         ).    if 
-0001d110: 2828 6e6f 7420 7374 6469 6e5f 7265 6164  ((not stdin_read
-0001d120: 7929 2061 6e64 2028 6e6f 7420 7379 732e  y) and (not sys.
-0001d130: 7374 6469 6e2e 6973 6174 7479 2829 2929  stdin.isatty()))
-0001d140: 206f 7220 7374 6469 6e5f 7265 6164 793a   or stdin_ready:
-0001d150: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001d160: 7379 732e 7374 6469 6e2e 6973 6174 7479  sys.stdin.isatty
-0001d170: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001d180: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0001d190: 2020 2020 2020 2020 2020 2020 2020 2250                "P
-0001d1a0: 6970 6520 7761 7320 6465 6669 6e69 7465  ipe was definite
-0001d1b0: 6c79 2075 7365 642c 2062 7574 2070 6970  ly used, but pip
-0001d1c0: 6520 6d69 6768 7420 6265 2065 6d70 7479  e might be empty
-0001d1d0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0001d1e0: 2020 2020 2254 7279 696e 6720 746f 2072      "Trying to r
-0001d1f0: 6561 6420 6672 6f6d 2070 6970 6520 696e  ead from pipe in
-0001d200: 2061 6e79 2063 6173 652e 220a 2020 2020   any case.".    
-0001d210: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001d220: 2020 6d65 7373 6167 6520 3d20 2222 0a20    message = "". 
-0001d230: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001d240: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
-0001d250: 2069 6e20 7379 732e 7374 6469 6e3a 0a20   in sys.stdin:. 
-0001d260: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001d270: 6573 7361 6765 202b 3d20 6c69 6e65 0a20  essage += line. 
-0001d280: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-0001d290: 672e 6465 6275 6728 2255 7369 6e67 2064  g.debug("Using d
-0001d2a0: 6174 6120 6672 6f6d 2073 7464 696e 2070  ata from stdin p
-0001d2b0: 6970 6520 6173 206d 6573 7361 6765 2e22  ipe as message."
-0001d2c0: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
-0001d2d0: 7373 6167 6573 2e61 7070 656e 6428 6d65  ssages.append(me
-0001d2e0: 7373 6167 6529 0a20 2020 2020 2020 2065  ssage).        e
-0001d2f0: 7863 6570 7420 454f 4645 7272 6f72 3a20  xcept EOFError: 
-0001d300: 2023 2045 4f46 2077 6865 6e20 7265 6164   # EOF when read
-0001d310: 696e 6720 6120 6c69 6e65 0a20 2020 2020  ing a line.     
-0001d320: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0001d330: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0001d340: 2020 2020 2022 5265 6164 696e 6720 6672       "Reading fr
-0001d350: 6f6d 2073 7464 696e 2072 6573 756c 7465  om stdin resulte
-0001d360: 6420 696e 2045 4f46 2e20 5468 6973 2063  d in EOF. This c
-0001d370: 616e 2068 6170 7065 6e20 220a 2020 2020  an happen ".    
-0001d380: 2020 2020 2020 2020 2020 2020 2277 6865              "whe
-0001d390: 6e20 6120 7069 7065 2077 6173 2075 7365  n a pipe was use
-0001d3a0: 642c 2062 7574 2074 6865 2070 6970 6520  d, but the pipe 
-0001d3b0: 6973 2065 6d70 7479 2e20 220a 2020 2020  is empty. ".    
-0001d3c0: 2020 2020 2020 2020 2020 2020 224e 6f20              "No 
-0001d3d0: 6d65 7373 6167 6520 7769 6c6c 2062 6520  message will be 
-0001d3e0: 6765 6e65 7261 7465 642e 220a 2020 2020  generated.".    
-0001d3f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001d400: 2020 6578 6365 7074 2055 6e69 636f 6465    except Unicode
-0001d410: 4465 636f 6465 4572 726f 723a 0a20 2020  DecodeError:.   
-0001d420: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0001d430: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-0001d440: 2020 2020 2020 2252 6561 6469 6e67 2066        "Reading f
-0001d450: 726f 6d20 7374 6469 6e20 7265 7375 6c74  rom stdin result
-0001d460: 6564 2069 6e20 556e 6963 6f64 6544 6563  ed in UnicodeDec
-0001d470: 6f64 6545 7272 6f72 2e20 5468 6973 2022  odeError. This "
-0001d480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d490: 2022 6361 6e20 6861 7070 656e 2069 6620   "can happen if 
-0001d4a0: 796f 7520 7472 7920 746f 2070 6970 6520  you try to pipe 
-0001d4b0: 6269 6e61 7279 2064 6174 6120 666f 7220  binary data for 
-0001d4c0: 6120 7465 7874 2022 0a20 2020 2020 2020  a text ".       
-0001d4d0: 2020 2020 2020 2020 2022 6d65 7373 6167           "messag
-0001d4e0: 652e 2046 6f72 2061 2074 6578 7420 6d65  e. For a text me
-0001d4f0: 7373 6167 6520 6f6e 6c79 2070 6970 6520  ssage only pipe 
-0001d500: 7465 7874 2076 6961 2073 7464 696e 2c20  text via stdin, 
-0001d510: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001d520: 2020 226e 6f74 2062 696e 6172 7920 6461    "not binary da
-0001d530: 7461 2e20 4e6f 206d 6573 7361 6765 2077  ta. No message w
-0001d540: 696c 6c20 6265 2067 656e 6572 6174 6564  ill be generated
-0001d550: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-0001d560: 0a20 2020 2072 6574 7572 6e20 6d65 7373  .    return mess
-0001d570: 6167 6573 0a0a 0a64 6566 2067 6574 5f6d  ages...def get_m
-0001d580: 6573 7361 6765 735f 6672 6f6d 5f6b 6579  essages_from_key
-0001d590: 626f 6172 6428 2920 2d3e 206c 6973 743a  board() -> list:
-0001d5a0: 0a20 2020 2022 2222 5265 6164 2069 6e70  .    """Read inp
-0001d5b0: 7574 2066 726f 6d20 6b65 7962 6f61 7264  ut from keyboard
-0001d5c0: 2062 7574 206f 6e6c 7920 6966 206e 6f20   but only if no 
-0001d5d0: 6f74 6865 7220 6d65 7373 6167 6573 2061  other messages a
-0001d5e0: 7265 2061 7661 696c 6162 6c65 2e0a 0a20  re available... 
-0001d5f0: 2020 2049 6620 7468 6572 6520 6973 2061     If there is a
-0001d600: 206d 6573 7361 6765 2070 726f 7669 6465   message provide
-0001d610: 6420 7669 6120 2d2d 6d65 7373 6167 6520  d via --message 
-0001d620: 6172 6775 6d65 6e74 2c20 6e6f 206d 6573  argument, no mes
-0001d630: 7361 6765 0a20 2020 2077 696c 6c20 6265  sage.    will be
-0001d640: 2072 6561 6420 6672 6f6d 206b 6579 626f   read from keybo
-0001d650: 6172 642e 0a20 2020 2049 6620 7468 6572  ard..    If ther
-0001d660: 6520 6172 6520 6f74 6865 7220 7365 6e64  e are other send
-0001d670: 206f 7065 7261 7469 6f6e 7320 6c69 6b65   operations like
-0001d680: 202d 2d69 6d61 6765 2c20 2d2d 6669 6c65   --image, --file
-0001d690: 2c20 6574 632e 2061 7265 0a20 2020 2075  , etc. are.    u
-0001d6a0: 7365 642c 206e 6f20 6d65 7373 6167 6520  sed, no message 
-0001d6b0: 7769 6c6c 2062 6520 7265 6164 2066 726f  will be read fro
-0001d6c0: 6d20 6b65 7962 6f61 7264 2e0a 2020 2020  m keyboard..    
-0001d6d0: 4966 2074 6865 7265 2069 7320 6120 6d65  If there is a me
-0001d6e0: 7373 6167 6520 7072 6f76 6964 6564 2076  ssage provided v
-0001d6f0: 6961 2073 7464 696e 2069 6e70 7574 2070  ia stdin input p
-0001d700: 6970 652c 206e 6f20 6d65 7373 6167 650a  ipe, no message.
-0001d710: 2020 2020 7769 6c6c 2062 6520 7265 6164      will be read
-0001d720: 2066 726f 6d20 6b65 7962 6f61 7264 2e0a   from keyboard..
-0001d730: 2020 2020 496e 2073 686f 7274 2c20 7765      In short, we
-0001d740: 206f 6e6c 7920 7265 6164 2066 726f 6d20   only read from 
-0001d750: 6b65 7962 6f61 7264 2061 7320 6c61 7374  keyboard as last
-0001d760: 2072 6573 6f72 742c 2069 6620 6e6f 206d   resort, if no m
-0001d770: 6573 7361 6765 7320 6172 650a 2020 2020  essages are.    
-0001d780: 7370 6563 6966 6965 6420 6f72 2070 726f  specified or pro
-0001d790: 7669 6465 6420 616e 7977 6865 7265 2061  vided anywhere a
-0001d7a0: 6e64 206e 6f20 6f74 6865 7220 7365 6e64  nd no other send
-0001d7b0: 2d6f 7065 7261 7469 6f6e 7320 6c69 6b65  -operations like
-0001d7c0: 0a20 2020 202d 2d69 6d61 6765 2c20 2d2d  .    --image, --
-0001d7d0: 6576 656e 742c 2065 7463 2e20 6172 6520  event, etc. are 
-0001d7e0: 7065 7266 6f72 6d65 642e 0a0a 2020 2020  performed...    
-0001d7f0: 5265 7475 726e 205b 5d20 6966 206e 6f20  Return [] if no 
-0001d800: 696e 7075 7420 6176 6169 6c61 626c 6520  input available 
-0001d810: 6f6e 206b 6579 626f 6172 642e 0a20 2020  on keyboard..   
-0001d820: 2052 6574 7572 6e20 5b22 736f 6d65 2d6d   Return ["some-m
-0001d830: 7367 225d 2069 6620 696e 7075 7420 6973  sg"] if input is
-0001d840: 2061 7661 696c 626c 6520 6f6e 206b 6579   availble on key
-0001d850: 626f 6172 642e 0a20 2020 204d 6967 6874  board..    Might
-0001d860: 2061 6c73 6f20 7265 7475 726e 205b 2222   also return [""
-0001d870: 5d20 6f66 2063 6f75 7273 6520 6966 2022  ] of course if "
-0001d880: 2220 6b65 7962 6f61 7264 2065 6e74 7279  " keyboard entry
-0001d890: 2077 6173 2065 6d70 7479 2e0a 2020 2020   was empty..    
-0001d8a0: 4375 7272 656e 746c 7920 7468 6572 6520  Currently there 
-0001d8b0: 6973 2061 7420 6d6f 7374 2031 206d 7367  is at most 1 msg
-0001d8c0: 2069 6e20 7468 6520 7265 7475 726e 6564   in the returned
-0001d8d0: 206c 6973 742e 0a20 2020 2022 2222 0a20   list..    """. 
-0001d8e0: 2020 206d 6573 7361 6765 7320 3d20 5b5d     messages = []
-0001d8f0: 0a20 2020 2069 6620 6773 2e70 612e 6d65  .    if gs.pa.me
-0001d900: 7373 6167 653a 0a20 2020 2020 2020 2067  ssage:.        g
-0001d910: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0001d920: 2020 2020 2020 2020 2022 446f 6e27 7420           "Don't 
-0001d930: 7265 6164 2066 726f 6d20 6b65 7962 6f61  read from keyboa
-0001d940: 7264 2062 6563 6175 7365 2074 6865 7265  rd because there
-0001d950: 2061 7265 2022 0a20 2020 2020 2020 2020   are ".         
-0001d960: 2020 2022 6d65 7373 6167 6573 2070 726f     "messages pro
-0001d970: 7669 6465 6420 696e 2061 7267 756d 656e  vided in argumen
-0001d980: 7473 2077 6974 6820 2d6d 2e22 0a20 2020  ts with -m.".   
-0001d990: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0001d9a0: 6574 7572 6e20 6d65 7373 6167 6573 2020  eturn messages  
-0001d9b0: 2320 7265 7475 726e 2065 6d70 7479 206c  # return empty l
-0001d9c0: 6973 7420 6265 6361 7573 6520 6d65 7367  ist because mesg
-0001d9d0: 7320 696e 202d 6d0a 2020 2020 6966 2028  s in -m.    if (
-0001d9e0: 0a20 2020 2020 2020 2067 732e 7061 2e69  .        gs.pa.i
-0001d9f0: 6d61 6765 0a20 2020 2020 2020 206f 7220  mage.        or 
-0001da00: 6773 2e70 612e 6175 6469 6f0a 2020 2020  gs.pa.audio.    
-0001da10: 2020 2020 6f72 2067 732e 7061 2e66 696c      or gs.pa.fil
-0001da20: 650a 2020 2020 2020 2020 6f72 2067 732e  e.        or gs.
-0001da30: 7061 2e65 7665 6e74 0a20 2020 2020 2020  pa.event.       
-0001da40: 206f 7220 6773 2e70 612e 7665 7273 696f   or gs.pa.versio
-0001da50: 6e0a 2020 2020 293a 0a20 2020 2020 2020  n.    ):.       
-0001da60: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-0001da70: 2020 2020 2020 2020 2020 2022 446f 6e27             "Don'
-0001da80: 7420 7265 6164 2066 726f 6d20 6b65 7962  t read from keyb
-0001da90: 6f61 7264 2062 6563 6175 7365 2074 6865  oard because the
-0001daa0: 7265 2061 7265 2022 0a20 2020 2020 2020  re are ".       
-0001dab0: 2020 2020 2022 6f74 6865 7220 7365 6e64       "other send
-0001dac0: 206f 7065 7261 7469 6f6e 7320 6f72 202d   operations or -
-0001dad0: 2d76 6572 7369 6f6e 2070 726f 7669 6465  -version provide
-0001dae0: 6420 696e 2061 7267 756d 656e 7473 2e22  d in arguments."
-0001daf0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001db00: 2020 2072 6574 7572 6e20 6d65 7373 6167     return messag
-0001db10: 6573 2020 2320 7265 7475 726e 2065 6d70  es  # return emp
-0001db20: 7479 206c 6973 7420 6265 6361 7573 6520  ty list because 
-0001db30: 6d65 7367 7320 696e 202d 6d0a 2020 2020  mesgs in -m.    
-0001db40: 7374 6469 6e5f 7265 6164 7920 3d20 7365  stdin_ready = se
-0001db50: 6c65 6374 2e73 656c 6563 7428 5b73 7973  lect.select([sys
-0001db60: 2e73 7464 696e 2c5d 2c20 5b5d 2c20 5b5d  .stdin,], [], []
-0001db70: 2c20 302e 3029 5b20 2023 206e 6f71 610a  , 0.0)[  # noqa.
-0001db80: 2020 2020 2020 2020 300a 2020 2020 5d20          0.    ] 
-0001db90: 2023 206e 6f71 610a 2020 2020 6966 206e   # noqa.    if n
-0001dba0: 6f74 2073 7464 696e 5f72 6561 6479 3a0a  ot stdin_ready:.
-0001dbb0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0001dbc0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-0001dbd0: 2020 2273 7464 696e 2069 7320 6e6f 7420    "stdin is not 
-0001dbe0: 7265 6164 7920 666f 7220 6b65 7962 6f61  ready for keyboa
-0001dbf0: 7264 2069 6e74 6572 6163 7469 6f6e 2e20  rd interaction. 
-0001dc00: 220a 2020 2020 2020 2020 2020 2020 2241  ".            "A
-0001dc10: 2070 6970 6520 636f 756c 6420 6265 2075   pipe could be u
-0001dc20: 7365 642c 2062 7574 2070 6970 6520 636f  sed, but pipe co
-0001dc30: 756c 6420 6265 2065 6d70 7479 2c20 220a  uld be empty, ".
-0001dc40: 2020 2020 2020 2020 2020 2020 2273 7464              "std
-0001dc50: 696e 2063 6f75 6c64 2061 6c73 6f20 6265  in could also be
-0001dc60: 2061 206b 6579 626f 6172 642e 220a 2020   a keyboard.".  
-0001dc70: 2020 2020 2020 290a 2020 2020 656c 7365        ).    else
-0001dc80: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-0001dc90: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-0001dca0: 2020 2020 2273 7464 696e 2069 7320 7265      "stdin is re
-0001dcb0: 6164 792e 2053 6f6d 6574 6869 6e67 2022  ady. Something "
-0001dcc0: 0a20 2020 2020 2020 2020 2020 2022 6973  .            "is
-0001dcd0: 2064 6566 696e 6974 656c 7920 7069 7065   definitely pipe
-0001dce0: 6420 696e 746f 2070 726f 6772 616d 2066  d into program f
-0001dcf0: 726f 6d20 7374 6469 6e2e 2022 0a20 2020  rom stdin. ".   
-0001dd00: 2020 2020 2020 2020 2022 5265 6164 696e           "Readin
-0001dd10: 6720 6d65 7373 6167 6520 6672 6f6d 2073  g message from s
-0001dd20: 7464 696e 2070 6970 652e 220a 2020 2020  tdin pipe.".    
-0001dd30: 2020 2020 290a 2020 2020 6966 2028 6e6f      ).    if (no
-0001dd40: 7420 7374 6469 6e5f 7265 6164 7929 2061  t stdin_ready) a
-0001dd50: 6e64 2028 7379 732e 7374 6469 6e2e 6973  nd (sys.stdin.is
-0001dd60: 6174 7479 2829 293a 0a20 2020 2020 2020  atty()):.       
-0001dd70: 2023 2062 6563 6175 7365 2073 7973 2e73   # because sys.s
-0001dd80: 7464 696e 2e69 7361 7474 7928 2920 6973  tdin.isatty() is
-0001dd90: 2074 7275 650a 2020 2020 2020 2020 6773   true.        gs
-0001dda0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0001ddb0: 2020 2020 2020 2020 224e 6f20 7069 7065          "No pipe
-0001ddc0: 2077 6173 2075 7365 642c 2073 6f20 7265   was used, so re
-0001ddd0: 6164 2069 6e70 7574 2066 726f 6d20 6b65  ad input from ke
-0001dde0: 7962 6f61 7264 2e20 220a 2020 2020 2020  yboard. ".      
-0001ddf0: 2020 2020 2020 2252 6561 6469 6e67 206d        "Reading m
-0001de00: 6573 7361 6765 2066 726f 6d20 6b65 7962  essage from keyb
-0001de10: 6f61 7264 220a 2020 2020 2020 2020 290a  oard".        ).
-0001de20: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0001de30: 2020 2020 2020 2020 206d 6573 7361 6765           message
-0001de40: 203d 2069 6e70 7574 2822 456e 7465 7220   = input("Enter 
-0001de50: 6d65 7373 6167 6520 746f 2073 656e 643a  message to send:
-0001de60: 2022 290a 2020 2020 2020 2020 2020 2020   ").            
-0001de70: 6773 2e6c 6f67 2e64 6562 7567 2822 5573  gs.log.debug("Us
-0001de80: 696e 6720 6461 7461 2066 726f 6d20 7374  ing data from st
-0001de90: 6469 6e20 6b65 7962 6f61 7264 2061 7320  din keyboard as 
-0001dea0: 6d65 7373 6167 652e 2229 0a20 2020 2020  message.").     
-0001deb0: 2020 2020 2020 206d 6573 7361 6765 732e         messages.
-0001dec0: 6170 7065 6e64 286d 6573 7361 6765 290a  append(message).
-0001ded0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0001dee0: 4f46 4572 726f 723a 2020 2320 454f 4620  OFError:  # EOF 
-0001def0: 7768 656e 2072 6561 6469 6e67 2061 206c  when reading a l
-0001df00: 696e 650a 2020 2020 2020 2020 2020 2020  ine.            
-0001df10: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0001df20: 2020 2020 2020 2020 2020 2020 2020 2252                "R
-0001df30: 6561 6469 6e67 2066 726f 6d20 7374 6469  eading from stdi
-0001df40: 6e20 7265 7375 6c74 6564 2069 6e20 454f  n resulted in EO
-0001df50: 462e 2022 0a20 2020 2020 2020 2020 2020  F. ".           
-0001df60: 2020 2020 2022 5265 6164 696e 6720 6672       "Reading fr
-0001df70: 6f6d 206b 6579 626f 6172 6420 6661 696c  om keyboard fail
-0001df80: 6564 2e20 220a 2020 2020 2020 2020 2020  ed. ".          
-0001df90: 2020 2020 2020 224e 6f20 6d65 7373 6167        "No messag
-0001dfa0: 6520 7769 6c6c 2062 6520 6765 6e65 7261  e will be genera
-0001dfb0: 7465 642e 220a 2020 2020 2020 2020 2020  ted.".          
-0001dfc0: 2020 290a 2020 2020 7265 7475 726e 206d    ).    return m
-0001dfd0: 6573 7361 6765 730a 0a0a 6173 796e 6320  essages...async 
-0001dfe0: 6465 6620 7365 6e64 5f6d 6573 7361 6765  def send_message
-0001dff0: 735f 616e 645f 6669 6c65 7328 636c 6965  s_and_files(clie
-0001e000: 6e74 2c20 726f 6f6d 732c 206d 6573 7361  nt, rooms, messa
-0001e010: 6765 7329 3a0a 2020 2020 2222 2253 656e  ges):.    """Sen
-0001e020: 6420 7465 7874 206d 6573 7361 6765 7320  d text messages 
-0001e030: 616e 6420 6669 6c65 732e 0a0a 2020 2020  and files...    
-0001e040: 4669 7273 7420 696d 6167 6573 2c20 6175  First images, au
-0001e050: 6469 6f2c 2065 7463 2c20 7468 656e 2074  dio, etc, then t
-0001e060: 6578 7420 6d65 7373 6167 6564 2e0a 0a20  ext messaged... 
-0001e070: 2020 2041 7267 756d 656e 7473 3a0a 2020     Arguments:.  
-0001e080: 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020    ---------.    
-0001e090: 636c 6965 6e74 203a 2043 6c69 656e 740a  client : Client.
-0001e0a0: 2020 2020 726f 6f6d 7320 3a20 6c69 7374      rooms : list
-0001e0b0: 206f 6620 726f 6f6d 5f69 6473 0a20 2020   of room_ids.   
-0001e0c0: 206d 6573 7361 6765 7320 3a20 6c69 7374   messages : list
-0001e0d0: 206f 6620 6d65 7373 6167 6573 2074 6f20   of messages to 
-0001e0e0: 7365 6e64 0a0a 2020 2020 2222 220a 2020  send..    """.  
-0001e0f0: 2020 6966 2067 732e 7061 2e69 6d61 6765    if gs.pa.image
-0001e100: 3a0a 2020 2020 2020 2020 666f 7220 696d  :.        for im
-0001e110: 6167 6520 696e 2067 732e 7061 2e69 6d61  age in gs.pa.ima
-0001e120: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
-0001e130: 6177 6169 7420 7365 6e64 5f69 6d61 6765  await send_image
-0001e140: 2863 6c69 656e 742c 2072 6f6f 6d73 2c20  (client, rooms, 
-0001e150: 696d 6167 6529 0a0a 2020 2020 6966 2067  image)..    if g
-0001e160: 732e 7061 2e61 7564 696f 3a0a 2020 2020  s.pa.audio:.    
-0001e170: 2020 2020 666f 7220 6175 6469 6f20 696e      for audio in
-0001e180: 2067 732e 7061 2e61 7564 696f 3a0a 2020   gs.pa.audio:.  
-0001e190: 2020 2020 2020 2020 2020 2320 6175 6469            # audi
-0001e1a0: 6f20 6669 6c65 2063 616e 2062 6520 7365  o file can be se
-0001e1b0: 6e74 206c 696b 6520 6f74 6865 7220 6669  nt like other fi
-0001e1c0: 6c65 730a 2020 2020 2020 2020 2020 2020  les.            
-0001e1d0: 6177 6169 7420 7365 6e64 5f66 696c 6528  await send_file(
-0001e1e0: 636c 6965 6e74 2c20 726f 6f6d 732c 2061  client, rooms, a
-0001e1f0: 7564 696f 290a 0a20 2020 2069 6620 6773  udio)..    if gs
-0001e200: 2e70 612e 6669 6c65 3a0a 2020 2020 2020  .pa.file:.      
-0001e210: 2020 666f 7220 6669 6c65 2069 6e20 6773    for file in gs
-0001e220: 2e70 612e 6669 6c65 3a0a 2020 2020 2020  .pa.file:.      
-0001e230: 2020 2020 2020 6177 6169 7420 7365 6e64        await send
-0001e240: 5f66 696c 6528 636c 6965 6e74 2c20 726f  _file(client, ro
-0001e250: 6f6d 732c 2066 696c 6529 0a0a 2020 2020  oms, file)..    
-0001e260: 6966 2067 732e 7061 2e65 7665 6e74 3a0a  if gs.pa.event:.
-0001e270: 2020 2020 2020 2020 666f 7220 6576 656e          for even
-0001e280: 7420 696e 2067 732e 7061 2e65 7665 6e74  t in gs.pa.event
-0001e290: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-0001e2a0: 6169 7420 7365 6e64 5f65 7665 6e74 2863  ait send_event(c
-0001e2b0: 6c69 656e 742c 2072 6f6f 6d73 2c20 6576  lient, rooms, ev
-0001e2c0: 656e 7429 0a0a 2020 2020 666f 7220 6d65  ent)..    for me
-0001e2d0: 7373 6167 6520 696e 206d 6573 7361 6765  ssage in message
-0001e2e0: 733a 0a20 2020 2020 2020 2061 7761 6974  s:.        await
-0001e2f0: 2073 656e 645f 6d65 7373 6167 6528 636c   send_message(cl
-0001e300: 6965 6e74 2c20 726f 6f6d 732c 206d 6573  ient, rooms, mes
-0001e310: 7361 6765 290a 0a0a 6173 796e 6320 6465  sage)...async de
-0001e320: 6620 7072 6f63 6573 735f 6172 6775 6d65  f process_argume
-0001e330: 6e74 735f 616e 645f 696e 7075 7428 636c  nts_and_input(cl
-0001e340: 6965 6e74 2c20 726f 6f6d 7329 3a0a 2020  ient, rooms):.  
-0001e350: 2020 2222 2250 726f 6365 7373 2061 7267    """Process arg
-0001e360: 756d 656e 7473 2061 6e64 2061 6c6c 2069  uments and all i
-0001e370: 6e70 7574 2e0a 0a20 2020 2050 726f 6365  nput...    Proce
-0001e380: 7373 2061 6c6c 2069 6e70 7574 3a20 7465  ss all input: te
-0001e390: 7874 206d 6573 7361 6765 732c 2065 7463  xt messages, etc
-0001e3a0: 2e0a 2020 2020 5072 6570 6172 6520 6120  ..    Prepare a 
-0001e3b0: 6c69 7374 206f 6620 6d65 7373 6167 6573  list of messages
-0001e3c0: 2066 726f 6d20 616c 6c20 736f 7572 6365   from all source
-0001e3d0: 7320 616e 6420 7468 656e 2073 656e 6420  s and then send 
-0001e3e0: 7468 656d 2e0a 0a20 2020 2041 7267 756d  them...    Argum
-0001e3f0: 656e 7473 3a0a 2020 2020 2d2d 2d2d 2d2d  ents:.    ------
-0001e400: 2d2d 2d0a 2020 2020 636c 6965 6e74 203a  ---.    client :
-0001e410: 2043 6c69 656e 740a 2020 2020 726f 6f6d   Client.    room
-0001e420: 7320 3a20 6c69 7374 206f 6620 726f 6f6d  s : list of room
-0001e430: 5f69 6473 0a0a 2020 2020 2222 220a 2020  _ids..    """.  
-0001e440: 2020 7374 7265 616d 696e 6720 3d20 4661    streaming = Fa
-0001e450: 6c73 650a 2020 2020 6d65 7373 6167 6573  lse.    messages
-0001e460: 5f66 726f 6d5f 7069 7065 203d 205b 5d0a  _from_pipe = [].
-0001e470: 2020 2020 6966 2067 732e 7374 6469 6e5f      if gs.stdin_
-0001e480: 7573 6520 3d3d 2022 6e6f 6e65 223a 2020  use == "none":  
-0001e490: 2320 5354 4449 4e20 6973 2075 6e75 7365  # STDIN is unuse
-0001e4a0: 640a 2020 2020 2020 2020 6d65 7373 6167  d.        messag
-0001e4b0: 6573 5f66 726f 6d5f 7069 7065 203d 2067  es_from_pipe = g
-0001e4c0: 6574 5f6d 6573 7361 6765 735f 6672 6f6d  et_messages_from
-0001e4d0: 5f70 6970 6528 290a 2020 2020 6d65 7373  _pipe().    mess
-0001e4e0: 6167 6573 5f66 726f 6d5f 6b65 7962 6f61  ages_from_keyboa
-0001e4f0: 7264 203d 2067 6574 5f6d 6573 7361 6765  rd = get_message
-0001e500: 735f 6672 6f6d 5f6b 6579 626f 6172 6428  s_from_keyboard(
-0001e510: 290a 2020 2020 6966 206e 6f74 2067 732e  ).    if not gs.
-0001e520: 7061 2e6d 6573 7361 6765 3a0a 2020 2020  pa.message:.    
-0001e530: 2020 2020 6d65 7373 6167 6573 5f66 726f      messages_fro
-0001e540: 6d5f 636f 6d6d 616e 646c 696e 6520 3d20  m_commandline = 
-0001e550: 5b5d 0a20 2020 2065 6c73 653a 0a20 2020  [].    else:.   
-0001e560: 2020 2020 206d 6573 7361 6765 735f 6672       messages_fr
-0001e570: 6f6d 5f63 6f6d 6d61 6e64 6c69 6e65 203d  om_commandline =
-0001e580: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-0001e590: 6d20 696e 2067 732e 7061 2e6d 6573 7361  m in gs.pa.messa
-0001e5a0: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
-0001e5b0: 6966 206d 203d 3d20 225c 5c2d 223a 2020  if m == "\\-":  
-0001e5c0: 2320 6573 6361 7065 6420 2d0a 2020 2020  # escaped -.    
-0001e5d0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-0001e5e0: 6167 6573 5f66 726f 6d5f 636f 6d6d 616e  ages_from_comman
-0001e5f0: 646c 696e 6520 2b3d 205b 222d 225d 0a20  dline += ["-"]. 
-0001e600: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0001e610: 6d20 3d3d 2022 5c5c 5f22 3a20 2023 2065  m == "\\_":  # e
-0001e620: 7363 6170 6564 205f 0a20 2020 2020 2020  scaped _.       
-0001e630: 2020 2020 2020 2020 206d 6573 7361 6765           message
-0001e640: 735f 6672 6f6d 5f63 6f6d 6d61 6e64 6c69  s_from_commandli
-0001e650: 6e65 202b 3d20 5b22 5f22 5d0a 2020 2020  ne += ["_"].    
-0001e660: 2020 2020 2020 2020 656c 6966 206d 203d          elif m =
-0001e670: 3d20 222d 223a 0a20 2020 2020 2020 2020  = "-":.         
-0001e680: 2020 2020 2020 2023 2073 7464 696e 2070         # stdin p
-0001e690: 6970 652c 2072 6561 6420 616e 6420 7072  ipe, read and pr
-0001e6a0: 6f63 6573 7320 6576 6572 7974 6869 6e67  ocess everything
-0001e6b0: 2069 6e20 7069 7065 2061 7320 3120 6d73   in pipe as 1 ms
-0001e6c0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0001e6d0: 2020 6d65 7373 6167 6573 5f66 726f 6d5f    messages_from_
-0001e6e0: 636f 6d6d 616e 646c 696e 6520 2b3d 2067  commandline += g
-0001e6f0: 6574 5f6d 6573 7361 6765 735f 6672 6f6d  et_messages_from
-0001e700: 5f70 6970 6528 290a 2020 2020 2020 2020  _pipe().        
-0001e710: 2020 2020 656c 6966 206d 203d 3d20 225f      elif m == "_
-0001e720: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-0001e730: 2020 2023 2073 7472 6561 6d69 6e67 2076     # streaming v
-0001e740: 6961 2070 6970 6520 6f6e 2073 7464 696e  ia pipe on stdin
-0001e750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e760: 2023 2073 7464 696e 2070 6970 652c 2072   # stdin pipe, r
-0001e770: 6561 6420 616e 6420 7072 6f63 6573 7320  ead and process 
-0001e780: 6576 6572 7974 6869 6e67 2069 6e20 7069  everything in pi
-0001e790: 7065 206c 696e 6520 6279 206c 696e 650a  pe line by line.
-0001e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7b0: 7374 7265 616d 696e 6720 3d20 5472 7565  streaming = True
-0001e7c0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001e7d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001e7e0: 2020 206d 6573 7361 6765 735f 6672 6f6d     messages_from
-0001e7f0: 5f63 6f6d 6d61 6e64 6c69 6e65 202b 3d20  _commandline += 
-0001e800: 5b6d 5d0a 0a20 2020 2067 732e 6c6f 672e  [m]..    gs.log.
-0001e810: 6465 6275 6728 6622 4d65 7373 6167 6573  debug(f"Messages
-0001e820: 2066 726f 6d20 7069 7065 3a20 2020 2020   from pipe:     
-0001e830: 2020 2020 7b6d 6573 7361 6765 735f 6672      {messages_fr
-0001e840: 6f6d 5f70 6970 657d 2229 0a20 2020 2067  om_pipe}").    g
-0001e850: 732e 6c6f 672e 6465 6275 6728 6622 4d65  s.log.debug(f"Me
-0001e860: 7373 6167 6573 2066 726f 6d20 6b65 7962  ssages from keyb
-0001e870: 6f61 7264 3a20 2020 2020 7b6d 6573 7361  oard:     {messa
-0001e880: 6765 735f 6672 6f6d 5f6b 6579 626f 6172  ges_from_keyboar
-0001e890: 647d 2229 0a20 2020 2067 732e 6c6f 672e  d}").    gs.log.
-0001e8a0: 6465 6275 6728 6622 4d65 7373 6167 6573  debug(f"Messages
-0001e8b0: 2066 726f 6d20 636f 6d6d 616e 642d 6c69   from command-li
-0001e8c0: 6e65 3a20 7b6d 6573 7361 6765 735f 6672  ne: {messages_fr
-0001e8d0: 6f6d 5f63 6f6d 6d61 6e64 6c69 6e65 7d22  om_commandline}"
-0001e8e0: 290a 0a20 2020 206d 6573 7361 6765 735f  )..    messages_
-0001e8f0: 616c 6c20 3d20 280a 2020 2020 2020 2020  all = (.        
-0001e900: 6d65 7373 6167 6573 5f66 726f 6d5f 636f  messages_from_co
-0001e910: 6d6d 616e 646c 696e 6520 2b20 6d65 7373  mmandline + mess
-0001e920: 6167 6573 5f66 726f 6d5f 7069 7065 202b  ages_from_pipe +
-0001e930: 206d 6573 7361 6765 735f 6672 6f6d 5f6b   messages_from_k
-0001e940: 6579 626f 6172 640a 2020 2020 2920 2023  eyboard.    )  #
-0001e950: 206b 6579 626f 6172 6420 6174 2065 6e64   keyboard at end
-0001e960: 0a0a 2020 2020 2320 6c6f 6f70 2074 6872  ..    # loop thr
-0001e970: 7520 616c 6c20 6d73 6773 2061 6e64 2073  u all msgs and s
-0001e980: 706c 6974 2074 6865 6d0a 2020 2020 6966  plit them.    if
-0001e990: 2067 732e 7061 2e73 706c 6974 3a0a 2020   gs.pa.split:.  
-0001e9a0: 2020 2020 2020 2320 6773 2e70 612e 7370        # gs.pa.sp
-0001e9b0: 6c69 7420 6361 6e20 6861 7665 2065 7363  lit can have esc
-0001e9c0: 6170 6520 6368 6172 6163 7465 7273 2c20  ape characters, 
-0001e9d0: 6974 2068 6173 2074 6f20 6265 2064 652d  it has to be de-
-0001e9e0: 6573 6361 7065 640a 2020 2020 2020 2020  escaped.        
-0001e9f0: 6465 636f 6465 645f 7374 7269 6e67 203d  decoded_string =
-0001ea00: 2062 7974 6573 2867 732e 7061 2e73 706c   bytes(gs.pa.spl
-0001ea10: 6974 2c20 2275 7466 2d38 2229 2e64 6563  it, "utf-8").dec
-0001ea20: 6f64 6528 2275 6e69 636f 6465 5f65 7363  ode("unicode_esc
-0001ea30: 6170 6522 290a 2020 2020 2020 2020 6773  ape").        gs
-0001ea40: 2e6c 6f67 2e64 6562 7567 2866 2753 7472  .log.debug(f'Str
-0001ea50: 696e 6720 7573 6564 2066 6f72 2073 706c  ing used for spl
-0001ea60: 6974 7469 6e67 2069 733a 2022 7b64 6563  itting is: "{dec
-0001ea70: 6f64 6564 5f73 7472 696e 677d 2227 290a  oded_string}"').
-0001ea80: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-0001ea90: 5f61 6c6c 5f73 706c 6974 203d 205b 5d0a  _all_split = [].
-0001eaa0: 2020 2020 2020 2020 666f 7220 6d20 696e          for m in
-0001eab0: 206d 6573 7361 6765 735f 616c 6c3a 0a20   messages_all:. 
-0001eac0: 2020 2020 2020 2020 2020 206d 6573 7361             messa
-0001ead0: 6765 735f 616c 6c5f 7370 6c69 7420 2b3d  ges_all_split +=
-0001eae0: 206d 2e73 706c 6974 2864 6563 6f64 6564   m.split(decoded
-0001eaf0: 5f73 7472 696e 6729 0a20 2020 2065 6c73  _string).    els
-0001eb00: 653a 2020 2320 6e6f 7420 6773 2e70 612e  e:  # not gs.pa.
-0001eb10: 7370 6c69 740a 2020 2020 2020 2020 6d65  split.        me
-0001eb20: 7373 6167 6573 5f61 6c6c 5f73 706c 6974  ssages_all_split
-0001eb30: 203d 206d 6573 7361 6765 735f 616c 6c0a   = messages_all.
-0001eb40: 0a20 2020 2061 7761 6974 2073 656e 645f  .    await send_
-0001eb50: 6d65 7373 6167 6573 5f61 6e64 5f66 696c  messages_and_fil
-0001eb60: 6573 2863 6c69 656e 742c 2072 6f6f 6d73  es(client, rooms
-0001eb70: 2c20 6d65 7373 6167 6573 5f61 6c6c 5f73  , messages_all_s
-0001eb80: 706c 6974 290a 2020 2020 2320 6e6f 7720  plit).    # now 
-0001eb90: 7765 2061 7265 2064 6f6e 6520 7769 7468  we are done with
-0001eba0: 2061 6c6c 2074 6865 2075 7375 616c 2073   all the usual s
-0001ebb0: 656e 6473 2c20 6e6f 7720 7765 2073 7461  ends, now we sta
-0001ebc0: 7274 2073 7472 6561 6d69 6e67 0a20 2020  rt streaming.   
-0001ebd0: 2069 6620 7374 7265 616d 696e 673a 0a20   if streaming:. 
-0001ebe0: 2020 2020 2020 2061 7761 6974 2073 7472         await str
-0001ebf0: 6561 6d5f 6d65 7373 6167 6573 5f66 726f  eam_messages_fro
-0001ec00: 6d5f 7069 7065 2863 6c69 656e 742c 2072  m_pipe(client, r
-0001ec10: 6f6f 6d73 290a 0a0a 6173 796e 6320 6465  ooms)...async de
-0001ec20: 6620 6c6f 6769 6e5f 7573 696e 675f 6372  f login_using_cr
-0001ec30: 6564 656e 7469 616c 735f 6669 6c65 280a  edentials_file(.
-0001ec40: 2020 2020 6372 6564 656e 7469 616c 735f      credentials_
-0001ec50: 6669 6c65 3a20 4f70 7469 6f6e 616c 5b73  file: Optional[s
-0001ec60: 7472 5d20 3d20 4e6f 6e65 2c20 7374 6f72  tr] = None, stor
-0001ec70: 655f 6469 723a 204f 7074 696f 6e61 6c5b  e_dir: Optional[
-0001ec80: 7374 725d 203d 204e 6f6e 650a 2920 2d3e  str] = None.) ->
-0001ec90: 2028 4173 796e 6343 6c69 656e 742c 2064   (AsyncClient, d
-0001eca0: 6963 7429 3a0a 2020 2020 2222 224c 6f67  ict):.    """Log
-0001ecb0: 2069 6e20 6279 2075 7369 6e67 2061 7661   in by using ava
-0001ecc0: 696c 6162 6c65 2063 7265 6465 6e74 6961  ilable credentia
-0001ecd0: 6c73 2066 696c 652e 0a0a 2020 2020 4172  ls file...    Ar
-0001ece0: 6775 6d65 6e74 733a 0a20 2020 202d 2d2d  guments:.    ---
-0001ecf0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2063  ------.        c
-0001ed00: 7265 6465 6e74 6961 6c73 5f66 696c 653a  redentials_file:
-0001ed10: 2073 7472 203a 206c 6f63 6174 696f 6e20   str : location 
-0001ed20: 6f66 2063 7265 6465 6e74 6961 6c73 2066  of credentials f
-0001ed30: 696c 650a 2020 2020 2020 2020 2020 2020  ile.            
-0001ed40: 636f 6d70 7574 6520 6974 2069 6620 6e6f  compute it if no
-0001ed50: 7420 7072 6f76 6964 6564 0a20 2020 2020  t provided.     
-0001ed60: 2020 2073 746f 7265 5f64 6972 3a20 7374     store_dir: st
-0001ed70: 7220 3a20 6c6f 6361 7469 6f6e 206f 6620  r : location of 
-0001ed80: 7065 7273 6973 7465 6e74 2073 746f 7261  persistent stora
-0001ed90: 6765 2073 746f 7265 2064 6972 6563 746f  ge store directo
-0001eda0: 7279 0a20 2020 2020 2020 2020 2020 2063  ry.            c
-0001edb0: 6f6d 7075 7465 2069 7420 6966 206e 6f74  ompute it if not
-0001edc0: 2070 726f 7669 6465 640a 0a20 2020 2052   provided..    R
-0001edd0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-0001ede0: 2d2d 0a20 2020 2020 2020 2041 7379 6e63  --.        Async
-0001edf0: 436c 6965 6e74 203a 2074 6865 2063 7265  Client : the cre
-0001ee00: 6174 6564 204e 494f 2063 6c69 656e 740a  ated NIO client.
-0001ee10: 2020 2020 2020 2020 6469 6374 203a 2074          dict : t
-0001ee20: 6865 2063 7265 6465 6e74 6961 6c73 2064  he credentials d
-0001ee30: 6963 7469 6f6e 6172 7920 6672 6f6d 2074  ictionary from t
-0001ee40: 6865 2063 7265 6465 6e74 6961 6c73 2066  he credentials f
-0001ee50: 696c 650a 0a20 2020 2022 2222 0a0a 2020  ile..    """..  
-0001ee60: 2020 6966 206e 6f74 2063 7265 6465 6e74    if not credent
-0001ee70: 6961 6c73 5f66 696c 653a 0a20 2020 2020  ials_file:.     
-0001ee80: 2020 2063 7265 6465 6e74 6961 6c73 5f66     credentials_f
-0001ee90: 696c 6520 3d20 6465 7465 726d 696e 655f  ile = determine_
-0001eea0: 6372 6564 656e 7469 616c 735f 6669 6c65  credentials_file
-0001eeb0: 2829 0a20 2020 2069 6620 6e6f 7420 7374  ().    if not st
-0001eec0: 6f72 655f 6469 723a 0a20 2020 2020 2020  ore_dir:.       
-0001eed0: 2073 746f 7265 5f64 6972 203d 2064 6574   store_dir = det
-0001eee0: 6572 6d69 6e65 5f73 746f 7265 5f64 6972  ermine_store_dir
-0001eef0: 2829 0a0a 2020 2020 6966 206e 6f74 2063  ()..    if not c
-0001ef00: 7265 6465 6e74 6961 6c73 5f65 7869 7374  redentials_exist
-0001ef10: 2863 7265 6465 6e74 6961 6c73 5f66 696c  (credentials_fil
-0001ef20: 6529 3a0a 2020 2020 2020 2020 7261 6973  e):.        rais
-0001ef30: 6520 4d61 7472 6978 436f 6d6d 616e 6465  e MatrixCommande
-0001ef40: 7245 7272 6f72 280a 2020 2020 2020 2020  rError(.        
-0001ef50: 2020 2020 2245 3135 333a 2022 0a20 2020      "E153: ".   
-0001ef60: 2020 2020 2020 2020 2022 4372 6564 656e           "Creden
-0001ef70: 7469 616c 7320 6669 6c65 2077 6173 206e  tials file was n
-0001ef80: 6f74 2066 6f75 6e64 2e20 5072 6f76 6964  ot found. Provid
-0001ef90: 6520 6372 6564 656e 7469 616c 7320 6669  e credentials fi
-0001efa0: 6c65 206f 7220 220a 2020 2020 2020 2020  le or ".        
-0001efb0: 2020 2020 2275 7365 202d 2d6c 6f67 696e      "use --login
-0001efc0: 2074 6f20 6372 6561 7465 2061 2063 7265   to create a cre
-0001efd0: 6465 6e74 6961 6c73 2066 696c 652e 220a  dentials file.".
-0001efe0: 2020 2020 2020 2020 2920 6672 6f6d 204e          ) from N
-0001eff0: 6f6e 650a 2020 2020 6966 206e 6f74 2073  one.    if not s
-0001f000: 746f 7265 5f65 7869 7374 7328 7374 6f72  tore_exists(stor
-0001f010: 655f 6469 7229 3a0a 2020 2020 2020 2020  e_dir):.        
-0001f020: 7261 6973 6520 4d61 7472 6978 436f 6d6d  raise MatrixComm
-0001f030: 616e 6465 7245 7272 6f72 280a 2020 2020  anderError(.    
-0001f040: 2020 2020 2020 2020 2245 3135 343a 2022          "E154: "
-0001f050: 0a20 2020 2020 2020 2020 2020 2022 5374  .            "St
-0001f060: 6f72 6520 6469 7265 6374 6f72 7920 7761  ore directory wa
-0001f070: 7320 6e6f 7420 666f 756e 642e 2050 726f  s not found. Pro
-0001f080: 7669 6465 2073 746f 7265 2064 6972 6563  vide store direc
-0001f090: 746f 7279 206f 7220 220a 2020 2020 2020  tory or ".      
-0001f0a0: 2020 2020 2020 2275 7365 202d 2d6c 6f67        "use --log
-0001f0b0: 696e 2074 6f20 6372 6561 7465 2061 2073  in to create a s
-0001f0c0: 746f 7265 2064 6972 6563 746f 7279 2e22  tore directory."
-0001f0d0: 0a20 2020 2020 2020 2029 2066 726f 6d20  .        ) from 
-0001f0e0: 4e6f 6e65 0a0a 2020 2020 6372 6564 656e  None..    creden
-0001f0f0: 7469 616c 7320 3d20 7265 6164 5f63 7265  tials = read_cre
-0001f100: 6465 6e74 6961 6c73 5f66 726f 6d5f 6469  dentials_from_di
-0001f110: 736b 2863 7265 6465 6e74 6961 6c73 5f66  sk(credentials_f
-0001f120: 696c 6529 0a20 2020 2067 732e 6372 6564  ile).    gs.cred
-0001f130: 656e 7469 616c 7320 3d20 6372 6564 656e  entials = creden
-0001f140: 7469 616c 730a 0a20 2020 2067 732e 6c6f  tials..    gs.lo
-0001f150: 672e 6465 6275 6728 2241 626f 7574 2074  g.debug("About t
-0001f160: 6f20 636f 6e66 6967 7572 6520 4d61 7472  o configure Matr
-0001f170: 6978 2041 7379 6e63 2043 6c69 656e 742e  ix Async Client.
-0001f180: 2229 0a20 2020 2023 2043 6f6e 6669 6775  ").    # Configu
-0001f190: 7261 7469 6f6e 206f 7074 696f 6e73 2066  ration options f
-0001f1a0: 6f72 2074 6865 2041 7379 6e63 436c 6965  or the AsyncClie
-0001f1b0: 6e74 0a20 2020 2063 6c69 656e 745f 636f  nt.    client_co
-0001f1c0: 6e66 6967 203d 2041 7379 6e63 436c 6965  nfig = AsyncClie
-0001f1d0: 6e74 436f 6e66 6967 280a 2020 2020 2020  ntConfig(.      
-0001f1e0: 2020 6d61 785f 6c69 6d69 745f 6578 6365    max_limit_exce
-0001f1f0: 6564 6564 3d30 2c0a 2020 2020 2020 2020  eded=0,.        
-0001f200: 6d61 785f 7469 6d65 6f75 7473 3d30 2c0a  max_timeouts=0,.
-0001f210: 2020 2020 2020 2020 7374 6f72 655f 7379          store_sy
-0001f220: 6e63 5f74 6f6b 656e 733d 5472 7565 2c0a  nc_tokens=True,.
-0001f230: 2020 2020 2020 2020 656e 6372 7970 7469          encrypti
-0001f240: 6f6e 5f65 6e61 626c 6564 3d54 7275 652c  on_enabled=True,
-0001f250: 0a20 2020 2029 0a20 2020 2067 732e 6c6f  .    ).    gs.lo
-0001f260: 672e 6465 6275 6728 2241 626f 7574 2074  g.debug("About t
-0001f270: 6f20 696e 6974 6961 6c69 7a65 204d 6174  o initialize Mat
-0001f280: 7269 7820 4173 796e 6320 436c 6965 6e74  rix Async Client
-0001f290: 2e22 290a 2020 2020 2320 496e 6974 6961  .").    # Initia
-0001f2a0: 6c69 7a65 2074 6865 206d 6174 7269 7820  lize the matrix 
-0001f2b0: 636c 6965 6e74 2062 6173 6564 206f 6e20  client based on 
-0001f2c0: 6372 6564 656e 7469 616c 7320 6672 6f6d  credentials from
-0001f2d0: 2066 696c 650a 2020 2020 636c 6965 6e74   file.    client
-0001f2e0: 203d 2041 7379 6e63 436c 6965 6e74 280a   = AsyncClient(.
-0001f2f0: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
-0001f300: 616c 735b 2268 6f6d 6573 6572 7665 7222  als["homeserver"
-0001f310: 5d2c 0a20 2020 2020 2020 2063 7265 6465  ],.        crede
-0001f320: 6e74 6961 6c73 5b22 7573 6572 5f69 6422  ntials["user_id"
-0001f330: 5d2c 0a20 2020 2020 2020 2064 6576 6963  ],.        devic
-0001f340: 655f 6964 3d63 7265 6465 6e74 6961 6c73  e_id=credentials
-0001f350: 5b22 6465 7669 6365 5f69 6422 5d2c 0a20  ["device_id"],. 
-0001f360: 2020 2020 2020 2073 746f 7265 5f70 6174         store_pat
-0001f370: 683d 7374 6f72 655f 6469 722c 0a20 2020  h=store_dir,.   
-0001f380: 2020 2020 2063 6f6e 6669 673d 636c 6965       config=clie
-0001f390: 6e74 5f63 6f6e 6669 672c 0a20 2020 2020  nt_config,.     
-0001f3a0: 2020 2073 736c 3d67 732e 7373 6c2c 0a20     ssl=gs.ssl,. 
-0001f3b0: 2020 2020 2020 2070 726f 7879 3d67 732e         proxy=gs.
-0001f3c0: 7061 2e70 726f 7879 2c0a 2020 2020 290a  pa.proxy,.    ).
-0001f3d0: 2020 2020 6966 2067 732e 7061 2e70 726f      if gs.pa.pro
-0001f3e0: 7879 3a0a 2020 2020 2020 2020 6773 2e6c  xy:.        gs.l
-0001f3f0: 6f67 2e64 6562 7567 2866 2250 726f 7879  og.debug(f"Proxy
-0001f400: 207b 6773 2e70 612e 7072 6f78 797d 2077   {gs.pa.proxy} w
-0001f410: 696c 6c20 6265 2075 7365 6420 666f 7220  ill be used for 
-0001f420: 636f 6e6e 6563 7469 7669 7479 2e22 290a  connectivity.").
-0001f430: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-0001f440: 6728 2241 626f 7574 2074 6f20 7265 7374  g("About to rest
-0001f450: 6f72 6520 6c6f 6769 6e2e 2229 0a20 2020  ore login.").   
-0001f460: 2023 2072 6573 746f 7265 5f6c 6f67 696e   # restore_login
-0001f470: 2829 2061 6c77 6179 7320 7265 7475 726e  () always return
-0001f480: 7320 4e6f 6e65 2c20 6f6e 2073 7563 6365  s None, on succe
-0001f490: 7373 206f 7220 6661 696c 7572 650a 2020  ss or failure.  
-0001f4a0: 2020 2320 7265 7374 6f72 655f 6c6f 6769    # restore_logi
-0001f4b0: 6e28 2920 646f 6573 206e 6f74 2067 6f20  n() does not go 
-0001f4c0: 746f 2074 6865 2073 6572 7665 722c 2069  to the server, i
-0001f4d0: 7420 6a75 7374 2073 6574 7320 736f 6d65  t just sets some
-0001f4e0: 206c 6f63 616c 2076 616c 7565 730a 2020   local values.  
-0001f4f0: 2020 2320 544f 444f 3a20 7065 7266 6f72    # TODO: perfor
-0001f500: 6d61 6e63 650a 2020 2020 2320 7265 7374  mance.    # rest
-0001f510: 6f72 655f 6c6f 6769 6e28 2920 6973 2061  ore_login() is a
-0001f520: 2073 6c6f 7720 6f70 6572 6174 696f 6e2e   slow operation.
-0001f530: 2031 2e35 7320 746f 2032 732e 2057 6879   1.5s to 2s. Why
-0001f540: 3f0a 2020 2020 2320 4265 6361 7573 6520  ?.    # Because 
-0001f550: 6974 2069 7320 7265 6164 696e 6720 7468  it is reading th
-0001f560: 6520 7374 6f72 6520 6669 6c65 2064 6174  e store file dat
-0001f570: 6162 6173 652e 0a20 2020 2023 2053 6574  abase..    # Set
-0001f580: 7469 6e67 2073 746f 7265 5f73 796e 635f  ting store_sync_
-0001f590: 746f 6b65 6e73 3d46 616c 7365 2061 626f  tokens=False abo
-0001f5a0: 7665 2077 696c 6c20 6e6f 7420 6d61 6b65  ve will not make
-0001f5b0: 2069 7420 676f 2061 6e79 2066 6173 7465   it go any faste
-0001f5c0: 722e 0a20 2020 2063 6c69 656e 742e 7265  r..    client.re
-0001f5d0: 7374 6f72 655f 6c6f 6769 6e28 0a20 2020  store_login(.   
-0001f5e0: 2020 2020 2075 7365 725f 6964 3d63 7265       user_id=cre
-0001f5f0: 6465 6e74 6961 6c73 5b22 7573 6572 5f69  dentials["user_i
-0001f600: 6422 5d2c 0a20 2020 2020 2020 2064 6576  d"],.        dev
-0001f610: 6963 655f 6964 3d63 7265 6465 6e74 6961  ice_id=credentia
-0001f620: 6c73 5b22 6465 7669 6365 5f69 6422 5d2c  ls["device_id"],
-0001f630: 0a20 2020 2020 2020 2061 6363 6573 735f  .        access_
-0001f640: 746f 6b65 6e3d 6372 6564 656e 7469 616c  token=credential
-0001f650: 735b 2261 6363 6573 735f 746f 6b65 6e22  s["access_token"
-0001f660: 5d2c 0a20 2020 2029 0a20 2020 2067 732e  ],.    ).    gs.
-0001f670: 6c6f 672e 6465 6275 6728 2246 696e 6973  log.debug("Finis
-0001f680: 6865 6420 7265 7374 6f72 696e 6720 6c6f  hed restoring lo
-0001f690: 6769 6e2e 2229 0a20 2020 2067 732e 6c6f  gin.").    gs.lo
-0001f6a0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-0001f6b0: 2022 4c6f 6769 6e20 7769 6c6c 2062 6520   "Login will be 
-0001f6c0: 7573 696e 6720 7374 6f72 6564 2063 7265  using stored cre
-0001f6d0: 6465 6e74 6961 6c73 2066 726f 6d20 220a  dentials from ".
-0001f6e0: 2020 2020 2020 2020 6627 6372 6564 656e          f'creden
-0001f6f0: 7469 616c 7320 6669 6c65 2022 7b63 7265  tials file "{cre
-0001f700: 6465 6e74 6961 6c73 5f66 696c 657d 222e  dentials_file}".
-0001f710: 2027 0a20 2020 2020 2020 2066 2772 6f6f   '.        f'roo
-0001f720: 6d5f 6964 203d 207b 6372 6564 656e 7469  m_id = {credenti
-0001f730: 616c 735b 2272 6f6f 6d5f 6964 225d 7d2c  als["room_id"]},
-0001f740: 2027 0a20 2020 2020 2020 2066 2764 6576   '.        f'dev
-0001f750: 6963 655f 6964 203d 207b 6372 6564 656e  ice_id = {creden
-0001f760: 7469 616c 735b 2264 6576 6963 655f 6964  tials["device_id
-0001f770: 225d 7d2c 2027 0a20 2020 2020 2020 2066  "]}, '.        f
-0001f780: 2761 6363 6573 735f 746f 6b65 6e20 3d20  'access_token = 
-0001f790: 7b63 7265 6465 6e74 6961 6c73 5b22 6163  {credentials["ac
-0001f7a0: 6365 7373 5f74 6f6b 656e 225d 5b30 3a31  cess_token"][0:1
-0001f7b0: 5d7d 2a2a 2a27 0a20 2020 2020 2020 2066  ]}***'.        f
-0001f7c0: 277b 6372 6564 656e 7469 616c 735b 2261  '{credentials["a
-0001f7d0: 6363 6573 735f 746f 6b65 6e22 5d5b 2d31  ccess_token"][-1
-0001f7e0: 3a5d 7d2e 270a 2020 2020 290a 2020 2020  :]}.'.    ).    
-0001f7f0: 6966 2067 732e 7061 2e64 6562 7567 203e  if gs.pa.debug >
-0001f800: 2030 3a0a 2020 2020 2020 2020 6773 2e6c   0:.        gs.l
-0001f810: 6f67 2e64 6562 7567 2822 4162 6f75 7420  og.debug("About 
-0001f820: 746f 2063 6f6e 6e65 6374 2074 6f20 7365  to connect to se
-0001f830: 7276 6572 2074 6f20 7665 7269 6679 2063  rver to verify c
-0001f840: 6f6e 6e65 6374 696f 6e2e 2229 0a20 2020  onnection.").   
-0001f850: 2020 2020 2023 2067 732e 6c6f 672e 6465       # gs.log.de
-0001f860: 6275 6728 6622 4c6f 6767 6564 5f69 6e28  bug(f"Logged_in(
-0001f870: 293d 7b63 6c69 656e 742e 6c6f 6767 6564  )={client.logged
-0001f880: 5f69 6e7d 2229 2069 7320 616c 7761 7973  _in}") is always
-0001f890: 2054 7275 652e 0a20 2020 2020 2020 2023   True..        #
-0001f8a0: 204a 7573 7420 6265 6361 7573 6520 636c   Just because cl
-0001f8b0: 6965 6e74 2e6c 6f67 6765 645f 696e 2069  ient.logged_in i
-0001f8c0: 7320 5472 7565 2064 6f65 7320 6e6f 7420  s True does not 
-0001f8d0: 6d65 616e 2077 6520 6172 6520 6c6f 6767  mean we are logg
-0001f8e0: 6564 2069 6e2e 0a20 2020 2020 2020 2023  ed in..        #
-0001f8f0: 2054 6861 7420 6a75 7374 206d 6561 6e73   That just means
-0001f900: 2074 6865 2064 6174 6120 7374 7275 6374   the data struct
-0001f910: 7572 6520 6973 2066 696c 6c65 642e 0a20  ure is filled.. 
-0001f920: 2020 2020 2020 2023 2048 6f77 2074 6f20         # How to 
-0001f930: 6b6e 6f77 2069 6620 6c6f 6769 6e20 7761  know if login wa
-0001f940: 7320 7375 6363 6573 7366 756c 3f0a 2020  s successful?.  
-0001f950: 2020 2020 2020 2320 446f 2061 6e20 6163        # Do an ac
-0001f960: 7475 616c 2041 5049 2063 616c 6c20 6167  tual API call ag
-0001f970: 6169 6e73 7420 7468 6520 7365 7276 6572  ainst the server
-0001f980: 2e20 452e 672e 2077 686f 616d 692e 0a20  . E.g. whoami.. 
-0001f990: 2020 2020 2020 2023 2057 6520 646f 6e27         # We don'
-0001f9a0: 7420 7761 6e74 2074 6f20 646f 2074 6869  t want to do thi
-0001f9b0: 7320 616c 7761 7973 2066 6f72 2070 6572  s always for per
-0001f9c0: 666f 726d 616e 6365 2072 6561 736f 6e73  formance reasons
-0001f9d0: 2c20 736f 2077 6520 6f6e 6c79 0a20 2020  , so we only.   
-0001f9e0: 2020 2020 2023 2064 6f20 6974 2069 6e20       # do it in 
-0001f9f0: 6465 6275 6720 6d6f 6465 2e0a 2020 2020  debug mode..    
-0001fa00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001fa10: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
-0001fa20: 7420 636c 6965 6e74 2e77 686f 616d 6928  t client.whoami(
-0001fa30: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-0001fa40: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-0001fa50: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-0001fa60: 6974 2063 6c69 656e 742e 636c 6f73 6528  it client.close(
-0001fa70: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
-0001fa80: 6965 6e74 203d 204e 6f6e 650a 2020 2020  ient = None.    
-0001fa90: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
-0001faa0: 616c 7320 3d20 4e6f 6e65 0a20 2020 2020  als = None.     
-0001fab0: 2020 2020 2020 2072 6169 7365 2028 6529         raise (e)
-0001fac0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0001fad0: 7374 616e 6365 2872 6573 702c 2072 6573  stance(resp, res
-0001fae0: 706f 6e73 6573 2e57 686f 616d 6945 7272  ponses.WhoamiErr
-0001faf0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0001fb00: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-0001fb10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001fb20: 4531 3535 3a20 220a 2020 2020 2020 2020  E155: ".        
-0001fb30: 2020 2020 2020 2020 2272 6573 746f 7265          "restore
-0001fb40: 5f6c 6f67 696e 2066 6169 6c65 642e 2044  _login failed. D
-0001fb50: 6964 2079 6f75 2070 6572 666f 726d 202d  id you perform -
-0001fb60: 2d6c 6f67 6f75 7420 220a 2020 2020 2020  -logout ".      
-0001fb70: 2020 2020 2020 2020 2020 2262 6566 6f72            "befor
-0001fb80: 653f 204c 6f6f 6b73 206c 696b 6520 796f  e? Looks like yo
-0001fb90: 7572 2061 6363 6573 732d 746f 6b65 6e20  ur access-token 
-0001fba0: 6578 7069 7265 642e 204d 6179 6265 2022  expired. Maybe "
-0001fbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fbc0: 2022 6465 6c65 7465 2063 7265 6465 6e74   "delete credent
-0001fbd0: 6961 6c73 2066 696c 6520 616e 6420 7374  ials file and st
-0001fbe0: 6f72 6520 616e 6420 7065 7266 6f72 6d20  ore and perform 
-0001fbf0: 6120 220a 2020 2020 2020 2020 2020 2020  a ".            
-0001fc00: 2020 2020 6622 6e65 7720 2d2d 6c6f 6769      f"new --logi
-0001fc10: 6e2e 2052 6573 706f 6e73 6520 6973 3a20  n. Response is: 
-0001fc20: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0001fc30: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-0001fc40: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001fc50: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-0001fc60: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-0001fc70: 2020 2020 2061 7761 6974 2063 6c69 656e       await clien
-0001fc80: 742e 636c 6f73 6528 290a 2020 2020 2020  t.close().      
-0001fc90: 2020 2020 2020 636c 6965 6e74 203d 204e        client = N
-0001fca0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0001fcb0: 6372 6564 656e 7469 616c 7320 3d20 4e6f  credentials = No
-0001fcc0: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
-0001fcd0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-0001fce0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-0001fcf0: 2020 2020 2020 2020 2020 2022 7265 7374             "rest
-0001fd00: 6f72 655f 6c6f 6769 6e20 7375 6363 6573  ore_login succes
-0001fd10: 7366 756c 2e20 5375 6363 6573 7366 756c  sful. Successful
-0001fd20: 6c79 2022 0a20 2020 2020 2020 2020 2020  ly ".           
-0001fd30: 2020 2020 2066 226c 6f67 6765 6420 696e       f"logged in
-0001fd40: 2061 7320 7573 6572 207b 7265 7370 2e75   as user {resp.u
-0001fd50: 7365 725f 6964 7d20 7669 6120 7265 7374  ser_id} via rest
-0001fd60: 6f72 655f 6c6f 6769 6e2e 2022 0a20 2020  ore_login. ".   
-0001fd70: 2020 2020 2020 2020 2020 2020 2066 2252               f"R
-0001fd80: 6573 706f 6e73 6520 6973 3a20 7b70 7269  esponse is: {pri
-0001fd90: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-0001fda0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-0001fdb0: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
-0001fdc0: 0a20 2020 2020 2020 2070 6173 730a 2020  .        pass.  
-0001fdd0: 2020 2020 2020 2320 6c6f 6769 6e20 6d69        # login mi
-0001fde0: 6768 7420 6f72 206d 6967 6874 206e 6f74  ght or might not
-0001fdf0: 2066 6169 6c20 6c61 7465 722c 0a20 2020   fail later,.   
-0001fe00: 2020 2020 2023 2069 6620 6974 2066 6169       # if it fai
-0001fe10: 6c73 2073 6f6d 6520 6578 6365 7074 696f  ls some exceptio
-0001fe20: 6e20 7769 6c6c 2062 6520 7261 6973 6564  n will be raised
-0001fe30: 2c20 7468 6520 6578 6365 7074 696f 6e20  , the exception 
-0001fe40: 7465 7874 0a20 2020 2020 2020 2023 206d  text.        # m
-0001fe50: 6967 6874 206e 6f74 2065 7870 6c61 696e  ight not explain
-0001fe60: 2074 6865 2070 726f 626c 656d 2077 656c   the problem wel
-0001fe70: 6c2c 2062 7574 2074 6869 7320 7761 7920  l, but this way 
-0001fe80: 7765 2073 7065 6564 2075 700a 2020 2020  we speed up.    
-0001fe90: 2020 2020 2320 7065 7266 6f72 6d61 6e63      # performanc
-0001fea0: 6520 6279 2069 7373 7569 6e67 206f 6e65  e by issuing one
-0001feb0: 2041 5049 206c 6573 7320 6167 6169 6e73   API less agains
-0001fec0: 7420 7468 6520 7365 7276 6572 2e0a 2020  t the server..  
-0001fed0: 2020 7265 7475 726e 2028 636c 6965 6e74    return (client
-0001fee0: 2c20 6372 6564 656e 7469 616c 7329 0a0a  , credentials)..
-0001fef0: 0a61 7379 6e63 2064 6566 206c 6973 7465  .async def liste
-0001ff00: 6e5f 666f 7265 7665 7228 636c 6965 6e74  n_forever(client
-0001ff10: 3a20 4173 796e 6343 6c69 656e 7429 202d  : AsyncClient) -
-0001ff20: 3e20 4e6f 6e65 3a0a 2020 2020 2222 224c  > None:.    """L
-0001ff30: 6973 7465 6e20 666f 7265 7665 7220 6f72  isten forever or
-0001ff40: 2075 6e74 696c 2043 6f6e 7472 6f6c 2d43   until Control-C
-0001ff50: 2e22 2222 0a20 2020 2023 2053 6574 2075  .""".    # Set u
-0001ff60: 7020 6576 656e 7420 6361 6c6c 6261 636b  p event callback
-0001ff70: 730a 2020 2020 6361 6c6c 6261 636b 7320  s.    callbacks 
-0001ff80: 3d20 4361 6c6c 6261 636b 7328 636c 6965  = Callbacks(clie
-0001ff90: 6e74 290a 2020 2020 636c 6965 6e74 2e61  nt).    client.a
-0001ffa0: 6464 5f65 7665 6e74 5f63 616c 6c62 6163  dd_event_callbac
-0001ffb0: 6b28 0a20 2020 2020 2020 2063 616c 6c62  k(.        callb
-0001ffc0: 6163 6b73 2e6d 6573 7361 6765 5f63 616c  acks.message_cal
-0001ffd0: 6c62 6163 6b2c 0a20 2020 2020 2020 2028  lback,.        (
-0001ffe0: 0a20 2020 2020 2020 2020 2020 2052 6f6f  .            Roo
-0001fff0: 6d4d 6573 7361 6765 2c0a 2020 2020 2020  mMessage,.      
-00020000: 2020 2020 2020 5265 6461 6374 6564 4576        RedactedEv
-00020010: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-00020020: 2052 6564 6163 7469 6f6e 4576 656e 742c   RedactionEvent,
-00020030: 0a20 2020 2020 2020 2029 2c0a 2020 2020  .        ),.    
-00020040: 290a 2020 2020 636c 6965 6e74 2e61 6464  ).    client.add
-00020050: 5f65 7665 6e74 5f63 616c 6c62 6163 6b28  _event_callback(
-00020060: 6361 6c6c 6261 636b 732e 696e 7669 7465  callbacks.invite
-00020070: 5f63 616c 6c62 6163 6b2c 2028 496e 7669  _callback, (Invi
-00020080: 7465 4d65 6d62 6572 4576 656e 742c 2929  teMemberEvent,))
-00020090: 0a20 2020 2070 7269 6e74 280a 2020 2020  .    print(.    
-000200a0: 2020 2020 2254 6869 7320 7072 6f67 7261      "This progra
-000200b0: 6d20 6973 2072 6561 6479 2061 6e64 206c  m is ready and l
-000200c0: 6973 7465 6e69 6e67 2066 6f72 2069 7473  istening for its
-000200d0: 204d 6174 7269 7820 6d65 7373 6167 6573   Matrix messages
-000200e0: 2e20 220a 2020 2020 2020 2020 2254 6f20  . ".        "To 
-000200f0: 7374 6f70 2070 726f 6772 616d 2074 7970  stop program typ
-00020100: 6520 436f 6e74 726f 6c2d 4320 6f6e 206b  e Control-C on k
-00020110: 6579 626f 6172 6420 6f72 2073 656e 6420  eyboard or send 
-00020120: 7369 676e 616c 2022 0a20 2020 2020 2020  signal ".       
-00020130: 2066 2274 6f20 7072 6f63 6573 7320 7b6f   f"to process {o
-00020140: 732e 6765 7470 6964 2829 7d2e 2050 4944  s.getpid()}. PID
-00020150: 2063 616e 2061 6c73 6f20 6265 2066 6f75   can also be fou
-00020160: 6e64 2069 6e20 220a 2020 2020 2020 2020  nd in ".        
-00020170: 6627 6669 6c65 2022 7b50 4944 5f46 494c  f'file "{PID_FIL
-00020180: 455f 4445 4641 554c 547d 222e 272c 0a20  E_DEFAULT}".',. 
-00020190: 2020 2020 2020 2066 696c 653d 7379 732e         file=sys.
-000201a0: 7374 6465 7272 2c0a 2020 2020 2020 2020  stderr,.        
-000201b0: 666c 7573 683d 5472 7565 2c0a 2020 2020  flush=True,.    
-000201c0: 290a 2020 2020 2320 7468 6520 7379 6e63  ).    # the sync
-000201d0: 5f6c 6f6f 7020 7769 6c6c 2062 6520 7465  _loop will be te
-000201e0: 726d 696e 6174 6564 2062 7920 7573 6572  rminated by user
-000201f0: 2068 6974 7469 6e67 2043 6f6e 7472 6f6c   hitting Control
-00020200: 2d43 2074 6f20 7374 6f70 0a20 2020 2061  -C to stop.    a
-00020210: 7761 6974 2063 6c69 656e 742e 7379 6e63  wait client.sync
-00020220: 5f66 6f72 6576 6572 2874 696d 656f 7574  _forever(timeout
-00020230: 3d33 3030 3030 2c20 6675 6c6c 5f73 7461  =30000, full_sta
-00020240: 7465 3d54 7275 6529 0a0a 0a61 7379 6e63  te=True)...async
-00020250: 2064 6566 206c 6973 7465 6e5f 6f6e 6365   def listen_once
-00020260: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
-00020270: 6965 6e74 2920 2d3e 204e 6f6e 653a 0a20  ient) -> None:. 
-00020280: 2020 2022 2222 4c69 7374 656e 206f 6e63     """Listen onc
-00020290: 652c 2074 6865 6e20 7175 6974 2e0a 0a20  e, then quit... 
-000202a0: 2020 2047 6574 2061 6c6c 2074 6865 206d     Get all the m
-000202b0: 6573 7361 6765 7320 7468 6174 2061 7265  essages that are
-000202c0: 2063 7572 7265 6e74 6c79 2071 7565 7565   currently queue
-000202d0: 6420 7570 2061 6e64 2077 6169 7469 6e67  d up and waiting
-000202e0: 2e0a 2020 2020 5072 696e 7420 7468 656d  ..    Print them
-000202f0: 2e20 5468 656e 206c 6561 7665 2e0a 2020  . Then leave..  
-00020300: 2020 2222 220a 2020 2020 2320 5365 7420    """.    # Set 
-00020310: 7570 2065 7665 6e74 2063 616c 6c62 6163  up event callbac
-00020320: 6b73 0a20 2020 2063 616c 6c62 6163 6b73  ks.    callbacks
-00020330: 203d 2043 616c 6c62 6163 6b73 2863 6c69   = Callbacks(cli
-00020340: 656e 7429 0a20 2020 2063 6c69 656e 742e  ent).    client.
-00020350: 6164 645f 6576 656e 745f 6361 6c6c 6261  add_event_callba
-00020360: 636b 2863 616c 6c62 6163 6b73 2e6d 6573  ck(callbacks.mes
-00020370: 7361 6765 5f63 616c 6c62 6163 6b2c 2028  sage_callback, (
-00020380: 526f 6f6d 4d65 7373 6167 652c 2929 0a20  RoomMessage,)). 
-00020390: 2020 2063 6c69 656e 742e 6164 645f 6576     client.add_ev
-000203a0: 656e 745f 6361 6c6c 6261 636b 2863 616c  ent_callback(cal
-000203b0: 6c62 6163 6b73 2e69 6e76 6974 655f 6361  lbacks.invite_ca
-000203c0: 6c6c 6261 636b 2c20 2849 6e76 6974 654d  llback, (InviteM
-000203d0: 656d 6265 7245 7665 6e74 2c29 290a 2020  emberEvent,)).  
-000203e0: 2020 2320 5765 2077 616e 7420 746f 2067    # We want to g
-000203f0: 6574 206f 7574 2071 7569 636b 6c79 2c20  et out quickly, 
-00020400: 736f 2077 6520 7265 6475 6365 6420 7469  so we reduced ti
-00020410: 6d65 6f75 7420 746f 2031 3020 7365 632e  meout to 10 sec.
-00020420: 0a20 2020 2023 2057 6520 7761 6e74 2074  .    # We want t
-00020430: 6f20 6765 7420 6d65 7373 6167 6573 2061  o get messages a
-00020440: 6e64 2071 7569 742c 2073 6f20 7765 2063  nd quit, so we c
-00020450: 616c 6c20 7379 6e63 2829 2069 6e73 7465  all sync() inste
-00020460: 6164 206f 660a 2020 2020 2320 7379 6e63  ad of.    # sync
-00020470: 5f66 6f72 6576 6572 2829 2e0a 2020 2020  _forever()..    
-00020480: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
-00020490: 656e 742e 7379 6e63 2874 696d 656f 7574  ent.sync(timeout
-000204a0: 3d31 3030 3030 2c20 6675 6c6c 5f73 7461  =10000, full_sta
-000204b0: 7465 3d46 616c 7365 290a 2020 2020 6966  te=False).    if
-000204c0: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-000204d0: 2c20 5379 6e63 5265 7370 6f6e 7365 293a  , SyncResponse):
-000204e0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-000204f0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00020500: 2020 2066 2253 796e 6320 7375 6363 6573     f"Sync succes
-00020510: 7366 756c 2e20 5265 7370 6f6e 7365 2069  sful. Response i
-00020520: 733a 207b 7072 6976 6163 795f 6669 6c74  s: {privacy_filt
-00020530: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-00020540: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-00020550: 7365 3a0a 2020 2020 2020 2020 6773 2e6c  se:.        gs.l
-00020560: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-00020570: 2020 2020 2020 2245 3136 303a 2022 2066        "E160: " f
-00020580: 2253 796e 6320 6661 696c 6564 2e20 4572  "Sync failed. Er
-00020590: 726f 7220 6973 3a20 7b70 7269 7661 6379  ror is: {privacy
-000205a0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-000205b0: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
-000205c0: 2020 2023 2073 796e 6328 2920 666f 7263     # sync() forc
-000205d0: 6573 2074 6865 206d 6573 7361 6765 5f63  es the message_c
-000205e0: 616c 6c62 6163 6b28 2920 746f 2066 6972  allback() to fir
-000205f0: 650a 2020 2020 2320 666f 7220 6561 6368  e.    # for each
-00020600: 206e 6577 206d 6573 7361 6765 2070 7265   new message pre
-00020610: 7365 6e74 6564 2069 6e20 7468 6520 7379  sented in the sy
-00020620: 6e63 2829 2e0a 0a0a 6173 796e 6320 6465  nc()....async de
-00020630: 6620 6c69 7374 656e 5f6f 6e63 655f 616c  f listen_once_al
-00020640: 7465 726e 6174 6976 6528 636c 6965 6e74  ternative(client
-00020650: 3a20 4173 796e 6343 6c69 656e 7429 202d  : AsyncClient) -
-00020660: 3e20 4e6f 6e65 3a0a 2020 2020 2222 224c  > None:.    """L
-00020670: 6973 7465 6e20 6f6e 6365 2c20 7468 656e  isten once, then
-00020680: 2071 7569 742e 0a0a 2020 2020 4765 7420   quit...    Get 
-00020690: 616c 6c20 7468 6520 6d65 7373 6167 6573  all the messages
-000206a0: 2074 6861 7420 6172 6520 6375 7272 656e   that are curren
-000206b0: 746c 7920 7175 6575 6564 2075 7020 616e  tly queued up an
-000206c0: 6420 7761 6974 696e 672e 0a20 2020 2050  d waiting..    P
-000206d0: 7269 6e74 2074 6865 6d2e 2054 6865 6e20  rint them. Then 
-000206e0: 6c65 6176 652e 0a0a 2020 2020 416c 7465  leave...    Alte
-000206f0: 726e 6174 6976 6520 696d 706c 656d 656e  rnative implemen
-00020700: 7461 7469 6f6e 206f 6620 6c69 7374 656e  tation of listen
-00020710: 5f6f 6e63 6528 292e 0a20 2020 2057 6520  _once()..    We 
-00020720: 646f 6e27 7420 7573 6520 616e 7920 6361  don't use any ca
-00020730: 6c6c 6261 636b 7320 616e 6420 7765 206a  llbacks and we j
-00020740: 7573 7420 6361 6c6c 2073 796e 6328 2920  ust call sync() 
-00020750: 616e 6420 6765 7420 616c 6c0a 2020 2020  and get all.    
-00020760: 6f66 2074 6865 204d 6573 7361 6765 4576  of the MessageEv
-00020770: 656e 7473 2066 726f 6d20 7468 6520 7469  ents from the ti
-00020780: 6d65 6c69 6e65 206f 6620 7468 6520 7265  meline of the re
-00020790: 706c 7920 7072 6f76 6964 6564 2062 790a  ply provided by.
-000207a0: 2020 2020 7379 6e63 2829 2e20 5468 6973      sync(). This
-000207b0: 2069 7320 6d6f 7265 2077 6f72 6b20 7468   is more work th
-000207c0: 616e 206c 6973 7465 6e5f 6f6e 6365 2829  an listen_once()
-000207d0: 2062 7574 2069 7420 6973 2069 6e74 6572   but it is inter
-000207e0: 6573 7469 6e67 0a20 2020 2063 6173 6520  esting.    case 
-000207f0: 7374 7564 7920 746f 2075 6e64 6572 7374  study to underst
-00020800: 616e 6420 7379 6e63 2829 2e0a 0a20 2020  and sync()...   
-00020810: 2073 796e 6328 2920 7265 7370 6f6e 7365   sync() response
-00020820: 2069 6e63 6c75 6465 7320 7468 6520 6d65   includes the me
-00020830: 6d62 6572 2060 726f 6f6d 7360 2028 6f66  mber `rooms` (of
-00020840: 2063 6c61 7373 206e 696f 2e72 6573 706f   class nio.respo
-00020850: 6e73 6573 2e52 6f6f 6d73 292e 0a20 2020  nses.Rooms)..   
-00020860: 2052 6f6f 6d73 2068 6176 6520 3320 746f   Rooms have 3 to
-00020870: 7020 6469 6374 732e 0a20 2020 2052 6f6f  p dicts..    Roo
-00020880: 6d73 2869 6e76 6974 653d 7b7d 2c20 6a6f  ms(invite={}, jo
-00020890: 696e 3d7b 2e2e 2e7d 2c20 6c65 6176 653d  in={...}, leave=
-000208a0: 7b7d 290a 2020 2020 6a6f 696e 2068 6173  {}).    join has
-000208b0: 2061 2064 6963 7420 656e 7472 7920 6f66   a dict entry of
-000208c0: 2074 7970 6520 526f 6f6d 496e 666f 2066   type RoomInfo f
-000208d0: 6f72 0a20 2020 2065 6163 6820 726f 6f6d  or.    each room
-000208e0: 2e20 416e 6420 7468 6520 526f 6f6d 496e  . And the RoomIn
-000208f0: 666f 2068 6173 2061 2074 696d 656c 696e  fo has a timelin
-00020900: 6520 286f 6620 636c 6173 7320 5469 6d65  e (of class Time
-00020910: 4c69 6e65 2920 7769 7468 0a20 2020 2061  Line) with.    a
-00020920: 6c6c 2063 7572 7265 6e74 6c79 2071 7565  ll currently que
-00020930: 7565 6420 7570 2065 7665 6e74 732e 2053  ued up events. S
-00020940: 6f2c 2074 696d 656c 696e 6520 6861 7320  o, timeline has 
-00020950: 6120 6c69 7374 206f 6620 6576 656e 7473  a list of events
-00020960: 0a20 2020 2073 7563 6820 6173 2052 6f6f  .    such as Roo
-00020970: 6d4d 6573 7361 6765 5465 7874 2c20 526f  mMessageText, Ro
-00020980: 6f6d 4d65 7373 6167 654e 6f74 6963 652c  omMessageNotice,
-00020990: 2065 7463 2e20 4f6e 6520 6361 6e20 676f   etc. One can go
-000209a0: 2074 6872 6f75 6768 0a20 2020 2074 6865   through.    the
-000209b0: 7365 2074 696d 656c 696e 6520 6576 656e  se timeline even
-000209c0: 7420 6c69 7374 7320 616e 6420 7072 6f63  t lists and proc
-000209d0: 6573 7320 6561 6368 2071 7565 7565 6420  ess each queued 
-000209e0: 7570 206d 6573 7361 6765 2e0a 0a20 2020  up message...   
-000209f0: 2054 6869 7320 6973 2061 6e20 6578 616d   This is an exam
-00020a00: 706c 6520 526f 6f6d 7320 6f62 6a65 6374  ple Rooms object
-00020a10: 2074 6861 7420 6973 2070 6172 7420 6f66   that is part of
-00020a20: 2061 2073 796e 6328 2920 7265 7370 6f6e   a sync() respon
-00020a30: 7365 2e0a 2020 2020 5468 6973 2065 7861  se..    This exa
-00020a40: 6d70 6c65 2067 6976 6573 2074 6865 2064  mple gives the d
-00020a50: 6574 6169 6c73 206f 6e20 3220 6375 7272  etails on 2 curr
-00020a60: 656e 746c 7920 7175 6575 6564 2075 7020  ently queued up 
-00020a70: 6d65 7373 6167 6573 2e0a 0a20 2020 2052  messages...    R
-00020a80: 6f6f 6d73 280a 2020 2020 696e 7669 7465  ooms(.    invite
-00020a90: 3d7b 7d2c 0a20 2020 206a 6f69 6e3d 7b27  ={},.    join={'
-00020aa0: 2153 6f6d 6552 6f6f 6d49 643a 6578 616d  !SomeRoomId:exam
-00020ab0: 706c 652e 6f72 6727 3a0a 2020 2020 2020  ple.org':.      
-00020ac0: 2020 526f 6f6d 496e 666f 280a 2020 2020    RoomInfo(.    
-00020ad0: 2020 2020 7469 6d65 6c69 6e65 3d54 696d      timeline=Tim
-00020ae0: 656c 696e 6528 0a20 2020 2020 2020 2020  eline(.         
-00020af0: 2020 2065 7665 6e74 733d 5b0a 2020 2020     events=[.    
-00020b00: 2020 2020 2020 2020 2020 2020 526f 6f6d              Room
-00020b10: 4d65 7373 6167 6554 6578 7428 736f 7572  MessageText(sour
-00020b20: 6365 3d7b 0a20 2020 2020 2020 2020 2020  ce={.           
-00020b30: 2020 2020 2020 2020 2027 726f 6f6d 5f69           'room_i
-00020b40: 6427 3a20 2721 536f 6d65 526f 6f6d 4964  d': '!SomeRoomId
-00020b50: 3a65 7861 6d70 6c65 2e6f 7267 272c 0a20  :example.org',. 
-00020b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b70: 2020 2027 7479 7065 273a 2027 6d2e 726f     'type': 'm.ro
-00020b80: 6f6d 2e6d 6573 7361 6765 272c 0a20 2020  om.message',.   
-00020b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ba0: 2027 636f 6e74 656e 7427 3a20 7b27 6d73   'content': {'ms
-00020bb0: 6774 7970 6527 3a20 276d 2e74 6578 7427  gtype': 'm.text'
-00020bc0: 2c20 2762 6f64 7927 3a20 2748 6920 7468  , 'body': 'Hi th
-00020bd0: 6572 6527 7d2c 0a20 2020 2020 2020 2020  ere'},.         
-00020be0: 2020 2020 2020 2020 2020 2027 6576 656e             'even
-00020bf0: 745f 6964 273a 2027 536f 6d65 4576 656e  t_id': 'SomeEven
-00020c00: 7449 6431 272c 0a20 2020 2020 2020 2020  tId1',.         
-00020c10: 2020 2020 2020 2020 2020 2027 7365 6e64             'send
-00020c20: 6572 273a 2027 4075 7365 7231 3a65 7861  er': '@user1:exa
-00020c30: 6d70 6c65 2e6f 7267 272c 0a20 2020 2020  mple.org',.     
-00020c40: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00020c50: 6f72 6967 696e 5f73 6572 7665 725f 7473  origin_server_ts
-00020c60: 273a 2031 3539 3132 3334 3839 3637 3132  ': 1591234896712
-00020c70: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00020c80: 2020 2065 7665 6e74 5f69 643d 2753 6f6d     event_id='Som
-00020c90: 6545 7665 6e74 4964 3127 2c0a 2020 2020  eEventId1',.    
-00020ca0: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-00020cb0: 6572 3d27 4075 7365 7231 3a65 7861 6d70  er='@user1:examp
-00020cc0: 6c65 2e6f 7267 272c 0a20 2020 2020 2020  le.org',.       
-00020cd0: 2020 2020 2020 2020 2073 6572 7665 725f           server_
-00020ce0: 7469 6d65 7374 616d 703d 3135 3931 3233  timestamp=159123
-00020cf0: 3438 3936 3731 322c 0a20 2020 2020 2020  4896712,.       
-00020d00: 2020 2020 2020 2020 2064 6563 7279 7074           decrypt
-00020d10: 6564 3d54 7275 652c 2076 6572 6966 6965  ed=True, verifie
-00020d20: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-00020d30: 2020 2020 2020 2020 2073 656e 6465 725f           sender_
-00020d40: 6b65 793d 2753 6f6d 6553 656e 6465 724b  key='SomeSenderK
-00020d50: 6579 3127 2c0a 2020 2020 2020 2020 2020  ey1',.          
-00020d60: 2020 2020 2020 7365 7373 696f 6e5f 6964        session_id
-00020d70: 3d27 536f 6d65 5365 7373 696f 6e49 6431  ='SomeSessionId1
-00020d80: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00020d90: 2020 2074 7261 6e73 6163 7469 6f6e 5f69     transaction_i
-00020da0: 643d 4e6f 6e65 2c0a 2020 2020 2020 2020  d=None,.        
-00020db0: 2020 2020 2020 2020 626f 6479 3d27 4869          body='Hi
-00020dc0: 2074 6865 7265 272c 0a20 2020 2020 2020   there',.       
-00020dd0: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
-00020de0: 6564 5f62 6f64 793d 4e6f 6e65 2c0a 2020  ed_body=None,.  
-00020df0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00020e00: 726d 6174 3d4e 6f6e 6529 2c0a 0a20 2020  rmat=None),..   
-00020e10: 2020 2020 2020 2020 2020 2020 2052 6f6f               Roo
-00020e20: 6d4d 6573 7361 6765 4e6f 7469 6365 2873  mMessageNotice(s
-00020e30: 6f75 7263 653d 7b27 636f 6e74 656e 7427  ource={'content'
-00020e40: 3a20 7b27 6d73 6774 7970 6527 3a20 276d  : {'msgtype': 'm
-00020e50: 2e6e 6f74 6963 6527 2c0a 2020 2020 2020  .notice',.      
-00020e60: 2020 2020 2020 2020 2020 2020 2020 2762                'b
-00020e70: 6f64 7927 3a20 2748 656c 6c6f 272c 0a20  ody': 'Hello',. 
-00020e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e90: 2020 2027 666f 726d 6174 273a 2027 6f72     'format': 'or
-00020ea0: 672e 6d61 7472 6978 2e63 7573 746f 6d2e  g.matrix.custom.
-00020eb0: 6874 6d6c 272c 0a20 2020 2020 2020 2020  html',.         
-00020ec0: 2020 2020 2020 2020 2020 2027 666f 726d             'form
-00020ed0: 6174 7465 645f 626f 6479 273a 2027 3c70  atted_body': '<p
-00020ee0: 3e48 656c 6c6f 3c2f 703e 270a 2020 2020  >Hello</p>'.    
-00020ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f00: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00020f10: 2020 2020 2020 2027 7479 7065 273a 2027         'type': '
-00020f20: 6d2e 726f 6f6d 2e6d 6573 7361 6765 272c  m.room.message',
-00020f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020f40: 2020 2020 2027 726f 6f6d 5f69 6427 3a20       'room_id': 
-00020f50: 2721 536f 6d65 526f 6f6d 4964 3a65 7861  '!SomeRoomId:exa
-00020f60: 6d70 6c65 2e6f 7267 272c 0a20 2020 2020  mple.org',.     
-00020f70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00020f80: 6576 656e 745f 6964 273a 2027 536f 6d65  event_id': 'Some
-00020f90: 4576 656e 7449 6432 272c 0a20 2020 2020  EventId2',.     
-00020fa0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00020fb0: 7365 6e64 6572 273a 2027 4075 7365 7232  sender': '@user2
-00020fc0: 3a65 7861 6d70 6c65 2e6f 7267 272c 0a20  :example.org',. 
-00020fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020fe0: 2020 2027 6f72 6967 696e 5f73 6572 7665     'origin_serve
-00020ff0: 725f 7473 273a 2031 3539 3132 3334 3839  r_ts': 159123489
-00021000: 3730 3739 7d2c 0a20 2020 2020 2020 2020  7079},.         
-00021010: 2020 2020 2020 2065 7665 6e74 5f69 643d         event_id=
-00021020: 2753 6f6d 6545 7665 6e74 4964 3227 2c0a  'SomeEventId2',.
-00021030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021040: 7365 6e64 6572 3d27 4075 7365 7232 3a65  sender='@user2:e
-00021050: 7861 6d70 6c65 2e6f 7267 272c 0a20 2020  xample.org',.   
-00021060: 2020 2020 2020 2020 2020 2020 2073 6572               ser
-00021070: 7665 725f 7469 6d65 7374 616d 703d 3135  ver_timestamp=15
-00021080: 3931 3233 3438 3937 3037 392c 2064 6563  91234897079, dec
-00021090: 7279 7074 6564 3d54 7275 652c 2076 6572  rypted=True, ver
-000210a0: 6966 6965 643d 4661 6c73 652c 0a20 2020  ified=False,.   
-000210b0: 2020 2020 2020 2020 2020 2020 2073 656e               sen
-000210c0: 6465 725f 6b65 793d 2753 6f6d 6553 656e  der_key='SomeSen
-000210d0: 6465 724b 6579 3227 2c0a 2020 2020 2020  derKey2',.      
-000210e0: 2020 2020 2020 2020 2020 7365 7373 696f            sessio
-000210f0: 6e5f 6964 3d27 536f 6d65 5365 7373 696f  n_id='SomeSessio
-00021100: 6e49 6432 272c 0a20 2020 2020 2020 2020  nId2',.         
-00021110: 2020 2020 2020 2074 7261 6e73 6163 7469         transacti
-00021120: 6f6e 5f69 643d 4e6f 6e65 2c0a 2020 2020  on_id=None,.    
-00021130: 2020 2020 2020 2020 2020 2020 626f 6479              body
-00021140: 3d27 3c70 3e48 656c 6c6f 3c2f 703e 272c  ='<p>Hello</p>',
-00021150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021160: 2066 6f72 6d61 743d 276f 7267 2e6d 6174   format='org.mat
-00021170: 7269 782e 6375 7374 6f6d 2e68 746d 6c27  rix.custom.html'
-00021180: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
-00021190: 0a20 2020 2020 2020 2020 2020 206c 696d  .            lim
-000211a0: 6974 6564 3d46 616c 7365 2c0a 2020 2020  ited=False,.    
-000211b0: 2020 2020 2020 2020 7072 6576 5f62 6174          prev_bat
-000211c0: 6368 3d27 7331 3636 3530 5f32 3634 3734  ch='s16650_26474
-000211d0: 365f 3733 325f 3132 3334 5f38 3035 305f  6_732_1234_8050_
-000211e0: 325f 3832 3630 5f34 3339 5f31 2729 2c0a  2_8260_439_1'),.
-000211f0: 2020 2020 2020 2020 7374 6174 653d 5b5d          state=[]
-00021200: 2c0a 2020 2020 2020 2020 6570 6865 6d65  ,.        epheme
-00021210: 7261 6c3d 5b54 7970 696e 674e 6f74 6963  ral=[TypingNotic
-00021220: 6545 7665 6e74 2875 7365 7273 3d5b 5d29  eEvent(users=[])
-00021230: 2c20 5265 6365 6970 7445 7665 6e74 282e  , ReceiptEvent(.
-00021240: 2e2e 295d 2c0a 2020 2020 2020 2020 6163  ..)],.        ac
-00021250: 636f 756e 745f 6461 7461 3d5b 5d2c 0a20  count_data=[],. 
-00021260: 2020 2020 2020 2073 756d 6d61 7279 3d52         summary=R
-00021270: 6f6f 6d53 756d 6d61 7279 282e 2e2e 292c  oomSummary(...),
-00021280: 0a20 2020 2020 2020 2075 6e72 6561 645f  .        unread_
-00021290: 6e6f 7469 6669 6361 7469 6f6e 733d 556e  notifications=Un
-000212a0: 7265 6164 4e6f 7469 6669 6361 7469 6f6e  readNotification
-000212b0: 7328 2e2e 2e29 0a20 2020 2020 2020 2029  s(...).        )
-000212c0: 0a20 2020 207d 2c0a 2020 2020 6c65 6176  .    },.    leav
-000212d0: 653d 7b7d 290a 0a20 2020 2022 2222 0a20  e={})..    """. 
-000212e0: 2020 2072 6573 705f 7320 3d20 6177 6169     resp_s = awai
-000212f0: 7420 636c 6965 6e74 2e73 796e 6328 7469  t client.sync(ti
-00021300: 6d65 6f75 743d 3130 3030 302c 2066 756c  meout=10000, ful
-00021310: 6c5f 7374 6174 653d 4661 6c73 6529 0a20  l_state=False). 
-00021320: 2020 2023 2074 6869 7320 7072 696e 7473     # this prints
-00021330: 2061 2073 756d 6d61 7279 206f 6620 616c   a summary of al
-00021340: 6c20 6e65 7720 6d65 7373 6167 6573 2063  l new messages c
-00021350: 7572 7265 6e74 6c79 2077 6169 7469 6e67  urrently waiting
-00021360: 2069 6e20 7468 6520 7175 6575 650a 2020   in the queue.  
-00021370: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00021380: 2273 796e 6320 7265 7370 6f6e 7365 203d  "sync response =
-00021390: 207b 7479 7065 2872 6573 705f 7329 7d20   {type(resp_s)} 
-000213a0: 3a3a 207b 7265 7370 5f73 7d22 290a 2020  :: {resp_s}").  
-000213b0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-000213c0: 2273 796e 6320 6e65 7874 5f62 6174 6368  "sync next_batch
-000213d0: 203d 2028 7374 7229 207b 7265 7370 5f73   = (str) {resp_s
-000213e0: 2e6e 6578 745f 6261 7463 687d 2229 0a20  .next_batch}"). 
-000213f0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00021400: 6622 7379 6e63 2072 6f6f 6d73 203d 2028  f"sync rooms = (
-00021410: 6e69 6f2e 7265 7370 6f6e 7365 732e 526f  nio.responses.Ro
-00021420: 6f6d 7329 207b 7265 7370 5f73 2e72 6f6f  oms) {resp_s.roo
-00021430: 6d73 7d22 290a 2020 2020 2320 5365 7420  ms}").    # Set 
-00021440: 7570 2065 7665 6e74 2063 616c 6c62 6163  up event callbac
-00021450: 6b73 0a20 2020 2063 616c 6c62 6163 6b73  ks.    callbacks
-00021460: 203d 2043 616c 6c62 6163 6b73 2863 6c69   = Callbacks(cli
-00021470: 656e 7429 0a20 2020 2023 204e 6f74 653a  ent).    # Note:
-00021480: 2077 6520 6172 6520 4e4f 5420 7265 6769   we are NOT regi
-00021490: 7374 6572 696e 6720 6120 6361 6c6c 6261  stering a callba
-000214a0: 636b 2066 756e 7469 6f6e 210a 2020 2020  ck funtion!.    
-000214b0: 2320 4c6f 6f70 2074 6872 6f75 6768 2074  # Loop through t
-000214c0: 6865 206a 6f69 6e20 6469 6374 696f 6e61  he join dictiona
-000214d0: 7279 0a20 2020 2066 6f72 2072 6f6f 6d5f  ry.    for room_
-000214e0: 6964 2c20 726f 6f6d 5f69 6e66 6f20 696e  id, room_info in
-000214f0: 2072 6573 705f 732e 726f 6f6d 732e 6a6f   resp_s.rooms.jo
-00021500: 696e 2e69 7465 6d73 2829 3a0a 2020 2020  in.items():.    
-00021510: 2020 2020 6576 656e 745f 6c69 7374 203d      event_list =
-00021520: 2072 6f6f 6d5f 696e 666f 2e74 696d 656c   room_info.timel
-00021530: 696e 652e 6576 656e 7473 0a20 2020 2020  ine.events.     
-00021540: 2020 2066 6f72 2065 7665 6e74 2069 6e20     for event in 
-00021550: 6576 656e 745f 6c69 7374 3a0a 2020 2020  event_list:.    
-00021560: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00021570: 6562 7567 2866 2273 656e 6469 6e67 2065  ebug(f"sending e
-00021580: 7665 6e74 2074 6f20 6361 6c6c 6261 636b  vent to callback
-00021590: 203d 207b 6576 656e 747d 2e22 290a 2020   = {event}.").  
-000215a0: 2020 2020 2020 2020 2020 2320 6265 6361            # beca
-000215b0: 7573 6520 6f66 2066 756c 6c5f 7374 6174  use of full_stat
-000215c0: 653d 4661 6c73 6520 696e 2073 796e 6328  e=False in sync(
-000215d0: 2920 7468 650a 2020 2020 2020 2020 2020  ) the.          
-000215e0: 2020 2320 726f 6f6d 7320 6f62 6a65 6374    # rooms object
-000215f0: 2069 7320 6e6f 7420 6675 6c6c 7920 706f   is not fully po
-00021600: 7075 6c61 7465 6420 616e 6420 6d69 7373  pulated and miss
-00021610: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
-00021620: 2020 2020 2320 726f 6f6d 206e 616d 6573      # room names
-00021630: 2e0a 2020 2020 2020 2020 2020 2020 726f  ..            ro
-00021640: 6f6d 203d 2063 6c69 656e 742e 726f 6f6d  om = client.room
-00021650: 735b 726f 6f6d 5f69 645d 0a20 2020 2020  s[room_id].     
-00021660: 2020 2020 2020 2061 7761 6974 2063 616c         await cal
-00021670: 6c62 6163 6b73 2e6d 6573 7361 6765 5f63  lbacks.message_c
-00021680: 616c 6c62 6163 6b28 726f 6f6d 2c20 6576  allback(room, ev
-00021690: 656e 7429 0a20 2020 2020 2020 2069 6620  ent).        if 
-000216a0: 6576 656e 745f 6c69 7374 3a20 2023 206c  event_list:  # l
-000216b0: 6973 7420 6e6f 7420 656d 7074 790a 2020  ist not empty.  
-000216c0: 2020 2020 2020 2020 2020 6c61 7374 5f65            last_e
-000216d0: 7665 6e74 203d 2065 7665 6e74 5f6c 6973  vent = event_lis
-000216e0: 745b 2d31 5d0a 2020 2020 2020 2020 2020  t[-1].          
-000216f0: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00021700: 6c69 656e 742e 726f 6f6d 5f72 6561 645f  lient.room_read_
-00021710: 6d61 726b 6572 7328 0a20 2020 2020 2020  markers(.       
-00021720: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
-00021730: 3d72 6f6f 6d5f 6964 2c0a 2020 2020 2020  =room_id,.      
-00021740: 2020 2020 2020 2020 2020 6675 6c6c 795f            fully_
-00021750: 7265 6164 5f65 7665 6e74 3d6c 6173 745f  read_event=last_
-00021760: 6576 656e 742e 6576 656e 745f 6964 2c0a  event.event_id,.
-00021770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021780: 7265 6164 5f65 7665 6e74 3d6c 6173 745f  read_event=last_
-00021790: 6576 656e 742e 6576 656e 745f 6964 2c0a  event.event_id,.
-000217a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000217b0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-000217c0: 6e73 7461 6e63 6528 7265 7370 2c20 526f  nstance(resp, Ro
-000217d0: 6f6d 5265 6164 4d61 726b 6572 7345 7272  omReadMarkersErr
-000217e0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-000217f0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00021800: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00021810: 2020 2020 2020 2022 726f 6f6d 5f72 6561         "room_rea
-00021820: 645f 6d61 726b 6572 7320 6661 696c 6564  d_markers failed
-00021830: 2077 6974 6820 7265 7370 6f6e 7365 2022   with response "
-00021840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021850: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
-00021860: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00021870: 297d 2e22 0a20 2020 2020 2020 2020 2020  )}.".           
-00021880: 2020 2020 2029 0a0a 0a23 2061 6363 6f72       )...# accor
-00021890: 6469 6e67 2074 6f20 7079 6c61 6d61 3a20  ding to pylama: 
-000218a0: 6675 6e63 7469 6f6e 2074 6f6f 2063 6f6d  function too com
-000218b0: 706c 6578 3a20 4339 3031 2023 206e 6f71  plex: C901 # noq
-000218c0: 613a 2043 3930 310a 6173 796e 6320 6465  a: C901.async de
-000218d0: 6620 6c69 7374 656e 5f74 6169 6c28 2020  f listen_tail(  
-000218e0: 2320 6e6f 7161 3a20 4339 3031 0a20 2020  # noqa: C901.   
-000218f0: 2063 6c69 656e 743a 2041 7379 6e63 436c   client: AsyncCl
-00021900: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
-00021910: 733a 2064 6963 740a 2920 2d3e 204e 6f6e  s: dict.) -> Non
-00021920: 653a 2020 2320 6e6f 7161 3a20 4339 3031  e:  # noqa: C901
-00021930: 0a20 2020 2022 2222 4765 7420 7468 6520  .    """Get the 
-00021940: 6c61 7374 204e 206d 6573 7361 6765 732c  last N messages,
-00021950: 2074 6865 6e20 7175 6974 2e0a 0a20 2020   then quit...   
-00021960: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
-00021970: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
-00021980: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
-00021990: 6c69 656e 7420 3a20 7468 6520 6372 6561  lient : the crea
-000219a0: 7465 6420 4e49 4f20 636c 6965 6e74 0a20  ted NIO client. 
-000219b0: 2020 2020 2020 2063 7265 6465 6e74 6961         credentia
-000219c0: 6c73 3a20 6469 6374 203a 2063 7265 6465  ls: dict : crede
-000219d0: 6e74 6961 6c73 2064 6963 7469 6f6e 6172  ntials dictionar
-000219e0: 7920 6672 6f6d 2074 6865 2063 7265 6465  y from the crede
-000219f0: 6e74 6961 6c73 2066 696c 650a 0a20 2020  ntials file..   
-00021a00: 2047 6574 2074 6865 206c 6173 7420 4e20   Get the last N 
-00021a10: 6d65 7373 6167 6573 2e20 536f 6d65 206d  messages. Some m
-00021a20: 6967 6874 2062 6520 6f6c 642c 2069 2e65  ight be old, i.e
-00021a30: 2e20 616c 7265 6164 790a 2020 2020 7265  . already.    re
-00021a40: 6164 2062 6566 6f72 652c 2073 6f6d 6520  ad before, some 
-00021a50: 6d69 6768 7420 6265 206e 6577 2c20 692e  might be new, i.
-00021a60: 652e 206e 6576 6572 2072 6561 6420 6265  e. never read be
-00021a70: 666f 7265 2e0a 2020 2020 5072 696e 7420  fore..    Print 
-00021a80: 7468 656d 2e20 5468 656e 206c 6561 7665  them. Then leave
-00021a90: 2e0a 0a20 2020 2049 6620 7468 6572 6520  ...    If there 
-00021aa0: 6172 6520 6c65 7373 2074 6861 6e20 4e20  are less than N 
-00021ab0: 6d65 7373 6167 6573 2c20 6765 7420 7570  messages, get up
-00021ac0: 2074 6f20 4e2e 0a0a 2020 2020 5468 6520   to N...    The 
-00021ad0: 6675 6e63 7469 6f6e 2072 6f6f 6d5f 6d65  function room_me
-00021ae0: 7373 6167 6573 2829 2069 7320 7573 6564  ssages() is used
-00021af0: 2074 6f20 6765 740a 2020 2020 7468 6520   to get.    the 
-00021b00: 6c61 7374 204e 206d 6573 7361 6765 732e  last N messages.
-00021b10: 0a0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
-00021b20: 7765 2063 616c 6c20 7379 6e63 2829 2074  we call sync() t
-00021b30: 6f20 6765 7420 7468 6520 6e65 7874 5f62  o get the next_b
-00021b40: 6174 6368 206d 6172 6b65 720a 2020 2020  atch marker.    
-00021b50: 2320 7765 2073 6574 2066 756c 6c5f 7374  # we set full_st
-00021b60: 6174 653d 5472 7565 2074 6f20 6765 7420  ate=True to get 
-00021b70: 616c 6c20 726f 6f6d 5f69 6473 0a20 2020  all room_ids.   
-00021b80: 2072 6573 705f 7320 3d20 6177 6169 7420   resp_s = await 
-00021b90: 7379 6e63 6872 6f6e 697a 6528 636c 6965  synchronize(clie
-00021ba0: 6e74 2920 2023 2073 796e 6328 2920 746f  nt)  # sync() to
-00021bb0: 2067 6574 2072 6f6f 6d73 0a20 2020 2023   get rooms.    #
-00021bc0: 2074 6869 7320 7072 696e 7473 2061 2073   this prints a s
-00021bd0: 756d 6d61 7279 206f 6620 616c 6c20 6e65  ummary of all ne
-00021be0: 7720 6d65 7373 6167 6573 2063 7572 7265  w messages curre
-00021bf0: 6e74 6c79 2077 6169 7469 6e67 2069 6e20  ntly waiting in 
-00021c00: 7468 6520 7175 6575 650a 2020 2020 6773  the queue.    gs
-00021c10: 2e6c 6f67 2e64 6562 7567 2866 2273 796e  .log.debug(f"syn
-00021c20: 6320 7265 7370 6f6e 7365 203d 207b 7479  c response = {ty
-00021c30: 7065 2872 6573 705f 7329 7d20 3a3a 207b  pe(resp_s)} :: {
-00021c40: 7265 7370 5f73 7d22 290a 2020 2020 6773  resp_s}").    gs
-00021c50: 2e6c 6f67 2e64 6562 7567 2866 2263 6c69  .log.debug(f"cli
-00021c60: 656e 742e 6e65 7874 5f62 6174 6368 2061  ent.next_batch a
-00021c70: 6674 6572 203d 2028 7374 7229 207b 636c  fter = (str) {cl
-00021c80: 6965 6e74 2e6e 6578 745f 6261 7463 687d  ient.next_batch}
-00021c90: 2229 0a20 2020 2067 732e 6c6f 672e 6465  ").    gs.log.de
-00021ca0: 6275 6728 6622 7379 6e63 206e 6578 745f  bug(f"sync next_
-00021cb0: 6261 7463 6820 3d20 2873 7472 2920 7b72  batch = (str) {r
-00021cc0: 6573 705f 732e 6e65 7874 5f62 6174 6368  esp_s.next_batch
-00021cd0: 7d22 290a 2020 2020 6773 2e6c 6f67 2e64  }").    gs.log.d
-00021ce0: 6562 7567 2866 2273 796e 6320 726f 6f6d  ebug(f"sync room
-00021cf0: 7320 3d20 286e 696f 2e72 6573 706f 6e73  s = (nio.respons
-00021d00: 6573 2e52 6f6f 6d73 2920 7b72 6573 705f  es.Rooms) {resp_
-00021d10: 732e 726f 6f6d 737d 2229 0a20 2020 2067  s.rooms}").    g
-00021d20: 732e 6c6f 672e 6465 6275 6728 6622 636c  s.log.debug(f"cl
-00021d30: 6965 6e74 2e72 6f6f 6d73 203d 207b 636c  ient.rooms = {cl
-00021d40: 6965 6e74 2e72 6f6f 6d73 7d22 290a 2020  ient.rooms}").  
-00021d50: 2020 6966 206e 6f74 2072 6573 705f 732e    if not resp_s.
-00021d60: 726f 6f6d 732e 6a6f 696e 3a20 2023 206e  rooms.join:  # n
-00021d70: 6f20 526f 6f6d 7321 0a20 2020 2020 2020  o Rooms!.       
-00021d80: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-00021d90: 7379 6e63 2072 6574 7572 6e65 6420 6e6f  sync returned no
-00021da0: 2072 6f6f 6d73 203d 207b 7265 7370 5f73   rooms = {resp_s
-00021db0: 2e72 6f6f 6d73 2e6a 6f69 6e7d 2229 0a20  .rooms.join}"). 
-00021dc0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00021dd0: 2020 2023 2053 6574 2075 7020 6576 656e     # Set up even
-00021de0: 7420 6361 6c6c 6261 636b 730a 2020 2020  t callbacks.    
-00021df0: 6361 6c6c 6261 636b 7320 3d20 4361 6c6c  callbacks = Call
-00021e00: 6261 636b 7328 636c 6965 6e74 290a 2020  backs(client).  
-00021e10: 2020 2320 4e6f 7465 3a20 7765 2061 7265    # Note: we are
-00021e20: 204e 4f54 2072 6567 6973 7465 7269 6e67   NOT registering
-00021e30: 2061 2063 616c 6c62 6163 6b20 6675 6e74   a callback funt
-00021e40: 696f 6e21 0a0a 2020 2020 2320 726f 6f6d  ion!..    # room
-00021e50: 5f69 6420 3d20 6c69 7374 2872 6573 705f  _id = list(resp_
-00021e60: 732e 726f 6f6d 732e 6a6f 696e 2e6b 6579  s.rooms.join.key
-00021e70: 7328 2929 5b30 5d20 2023 2066 6972 7374  s())[0]  # first
-00021e80: 2072 6f6f 6d5f 6964 2066 726f 6d20 6469   room_id from di
-00021e90: 6374 0a20 2020 2023 2061 6c74 6572 6e61  ct.    # alterna
-00021ea0: 7469 7665 2077 6179 206f 6620 6765 7474  tive way of gett
-00021eb0: 696e 6720 726f 6f6d 5f69 642c 2063 6c69  ing room_id, cli
-00021ec0: 656e 742e 726f 6f6d 7320 6973 2061 6c73  ent.rooms is als
-00021ed0: 6f20 6120 6469 6374 0a20 2020 2023 2072  o a dict.    # r
-00021ee0: 6f6f 6d5f 6964 203d 206c 6973 7428 636c  oom_id = list(cl
-00021ef0: 6965 6e74 2e72 6f6f 6d73 2e6b 6579 7328  ient.rooms.keys(
-00021f00: 2929 5b30 5d20 2023 2066 6972 7374 2072  ))[0]  # first r
-00021f10: 6f6f 6d5f 6964 2066 726f 6d20 6469 6374  oom_id from dict
-00021f20: 0a0a 2020 2020 2320 6765 7420 726f 6f6d  ..    # get room
-00021f30: 7320 6173 2073 7065 6369 6669 6564 2062  s as specified b
-00021f40: 7920 7468 6520 7573 6572 2074 6872 7520  y the user thru 
-00021f50: 6172 6773 206f 7220 6372 6564 656e 7469  args or credenti
-00021f60: 616c 2066 696c 650a 2020 2020 726f 6f6d  al file.    room
-00021f70: 7320 3d20 6177 6169 7420 6465 7465 726d  s = await determ
-00021f80: 696e 655f 726f 6f6d 7328 6372 6564 656e  ine_rooms(creden
-00021f90: 7469 616c 735b 2272 6f6f 6d5f 6964 225d  tials["room_id"]
-00021fa0: 2c20 636c 6965 6e74 2c20 6372 6564 656e  , client, creden
-00021fb0: 7469 616c 7329 0a20 2020 206c 696d 6974  tials).    limit
-00021fc0: 203d 2067 732e 7061 2e74 6169 6c0a 2020   = gs.pa.tail.  
-00021fd0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00021fe0: 2252 6f6f 6d73 2061 7265 3a20 7b72 6f6f  "Rooms are: {roo
-00021ff0: 6d73 7d2c 206c 696d 6974 2069 7320 7b6c  ms}, limit is {l
-00022000: 696d 6974 7d22 290a 2020 2020 2320 546f  imit}").    # To
-00022010: 206c 6f6f 7020 6f76 6572 2061 6c6c 2072   loop over all r
-00022020: 6f6f 6d73 2c20 6f6e 6520 6361 6e20 6c6f  ooms, one can lo
-00022030: 6f70 2074 6872 6f75 6768 2074 6865 206a  op through the j
-00022040: 6f69 6e20 6469 6374 696f 6e61 7279 2e20  oin dictionary. 
-00022050: 692e 652e 0a20 2020 2023 2066 6f72 2072  i.e..    # for r
-00022060: 6f6f 6d5f 6964 2c20 726f 6f6d 5f69 6e66  oom_id, room_inf
-00022070: 6f20 696e 2072 6573 705f 732e 726f 6f6d  o in resp_s.room
-00022080: 732e 6a6f 696e 2e69 7465 6d73 2829 3a20  s.join.items(): 
-00022090: 2023 206c 6f6f 7020 616c 6c20 726f 6f6d   # loop all room
-000220a0: 730a 2020 2020 666f 7220 726f 6f6d 5f69  s.    for room_i
-000220b0: 6420 696e 2072 6f6f 6d73 3a20 2023 206c  d in rooms:  # l
-000220c0: 6f6f 7020 6f6e 6c79 206f 7665 7220 7573  oop only over us
-000220d0: 6572 2073 7065 6369 6669 6564 2072 6f6f  er specified roo
-000220e0: 6d73 0a20 2020 2020 2020 2072 6573 7020  ms.        resp 
-000220f0: 3d20 6177 6169 7420 636c 6965 6e74 2e72  = await client.r
-00022100: 6f6f 6d5f 6d65 7373 6167 6573 280a 2020  oom_messages(.  
-00022110: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
-00022120: 642c 2073 7461 7274 3d72 6573 705f 732e  d, start=resp_s.
-00022130: 6e65 7874 5f62 6174 6368 2c20 6c69 6d69  next_batch, limi
-00022140: 743d 6c69 6d69 740a 2020 2020 2020 2020  t=limit.        
-00022150: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
-00022160: 6e73 7461 6e63 6528 7265 7370 2c20 526f  nstance(resp, Ro
-00022170: 6f6d 4d65 7373 6167 6573 4572 726f 7229  omMessagesError)
-00022180: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-00022190: 2e6c 6f67 2e77 6172 6e69 6e67 280a 2020  .log.warning(.  
-000221a0: 2020 2020 2020 2020 2020 2020 2020 2257                "W
-000221b0: 3130 363a 2022 0a20 2020 2020 2020 2020  106: ".         
-000221c0: 2020 2020 2020 2066 2272 6f6f 6d5f 6d65         f"room_me
-000221d0: 7373 6167 6573 2066 6169 6c65 6420 7769  ssages failed wi
-000221e0: 7468 2072 6573 706f 6e73 6520 220a 2020  th response ".  
-000221f0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00022200: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-00022210: 7374 7228 7265 7370 2929 7d2e 2022 0a20  str(resp))}. ". 
-00022220: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00022230: 5072 6f63 6573 7369 6e67 2063 6f6e 7469  Processing conti
-00022240: 6e75 6573 2e22 0a20 2020 2020 2020 2020  nues.".         
-00022250: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00022260: 2067 732e 7761 726e 5f63 6f75 6e74 202b   gs.warn_count +
-00022270: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00022280: 636f 6e74 696e 7565 2020 2320 736b 6970  continue  # skip
-00022290: 2074 6869 7320 726f 6f6d 0a20 2020 2020   this room.     
-000222a0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-000222b0: 0a20 2020 2020 2020 2020 2020 2066 2272  .            f"r
-000222c0: 6f6f 6d5f 6d65 7373 6167 6573 2072 6573  oom_messages res
-000222d0: 706f 6e73 6520 3d20 7b74 7970 6528 7265  ponse = {type(re
-000222e0: 7370 297d 203a 3a20 220a 2020 2020 2020  sp)} :: ".      
-000222f0: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
-00022300: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-00022310: 2929 7d2e 220a 2020 2020 2020 2020 290a  ))}.".        ).
-00022320: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00022330: 6562 7567 2866 2272 6f6f 6d5f 6d65 7373  ebug(f"room_mess
-00022340: 6167 6573 2072 6f6f 6d5f 6964 203d 207b  ages room_id = {
-00022350: 7265 7370 2e72 6f6f 6d5f 6964 7d2e 2229  resp.room_id}.")
-00022360: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00022370: 6465 6275 6728 6622 726f 6f6d 5f6d 6573  debug(f"room_mes
-00022380: 7361 6765 7320 7374 6172 7420 3d20 2873  sages start = (s
-00022390: 7472 2920 7b72 6573 702e 7374 6172 747d  tr) {resp.start}
-000223a0: 2e22 290a 2020 2020 2020 2020 6773 2e6c  .").        gs.l
-000223b0: 6f67 2e64 6562 7567 2866 2272 6f6f 6d5f  og.debug(f"room_
-000223c0: 6d65 7373 6167 6573 2065 6e64 203d 2028  messages end = (
-000223d0: 7374 7229 203a 3a20 7b72 6573 702e 656e  str) :: {resp.en
-000223e0: 647d 2e22 290a 2020 2020 2020 2020 6773  d}.").        gs
-000223f0: 2e6c 6f67 2e64 6562 7567 2866 2272 6f6f  .log.debug(f"roo
-00022400: 6d5f 6d65 7373 6167 6573 2063 6875 6e6b  m_messages chunk
-00022410: 203d 2028 6c69 7374 2920 3a3a 207b 7265   = (list) :: {re
-00022420: 7370 2e63 6875 6e6b 7d2e 2229 0a20 2020  sp.chunk}.").   
-00022430: 2020 2020 2023 2063 6875 6e6b 2069 7320       # chunk is 
-00022440: 6a75 7374 2061 206c 6973 7420 6f66 2052  just a list of R
-00022450: 6f6f 6d4d 6573 7361 6765 2065 7665 6e74  oomMessage event
-00022460: 7320 6c69 6b65 2074 6869 7320 6578 616d  s like this exam
-00022470: 706c 653a 0a20 2020 2020 2020 2023 2063  ple:.        # c
-00022480: 6875 6e6b 3d5b 526f 6f6d 4d65 7373 6167  hunk=[RoomMessag
-00022490: 6554 6578 7428 2e2e 2e29 5d0a 0a20 2020  eText(...)]..   
-000224a0: 2020 2020 2066 6f72 2065 7665 6e74 2069       for event i
-000224b0: 6e20 7265 7370 2e63 6875 6e6b 3a0a 2020  n resp.chunk:.  
-000224c0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-000224d0: 2e64 6562 7567 2866 2273 656e 6469 6e67  .debug(f"sending
-000224e0: 2065 7665 6e74 2074 6f20 6361 6c6c 6261   event to callba
-000224f0: 636b 203d 207b 6576 656e 747d 2e22 290a  ck = {event}.").
-00022500: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00022510: 6c69 656e 742e 726f 6f6d 7320 616e 6420  lient.rooms and 
-00022520: 636c 6965 6e74 2e72 6f6f 6d73 5b72 6f6f  client.rooms[roo
-00022530: 6d5f 6964 5d3a 0a20 2020 2020 2020 2020  m_id]:.         
-00022540: 2020 2020 2020 2072 6f6f 6d20 3d20 636c         room = cl
-00022550: 6965 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f  ient.rooms[room_
-00022560: 6964 5d0a 2020 2020 2020 2020 2020 2020  id].            
-00022570: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00022580: 2020 2020 2020 726f 6f6d 203d 204d 6174        room = Mat
-00022590: 7269 7852 6f6f 6d28 726f 6f6d 5f69 642c  rixRoom(room_id,
-000225a0: 204e 6f6e 652c 2054 7275 6529 2020 2320   None, True)  # 
-000225b0: 6475 6d6d 795f 726f 6f6d 0a20 2020 2020  dummy_room.     
-000225c0: 2020 2020 2020 2061 7761 6974 2063 616c         await cal
-000225d0: 6c62 6163 6b73 2e6d 6573 7361 6765 5f63  lbacks.message_c
-000225e0: 616c 6c62 6163 6b28 726f 6f6d 2c20 6576  allback(room, ev
-000225f0: 656e 7429 0a20 2020 2020 2020 2069 6620  ent).        if 
-00022600: 7265 7370 2e63 6875 6e6b 3a20 2023 206c  resp.chunk:  # l
-00022610: 6973 7420 6e6f 7420 656d 7074 790a 2020  ist not empty.  
-00022620: 2020 2020 2020 2020 2020 2320 6f72 6465            # orde
-00022630: 7220 6973 2072 6576 6572 7365 642c 2066  r is reversed, f
-00022640: 6972 7374 2065 6c65 6d65 6e74 2069 7320  irst element is 
-00022650: 7469 6d65 7769 7365 2074 6865 206e 6577  timewise the new
-00022660: 6573 740a 2020 2020 2020 2020 2020 2020  est.            
-00022670: 6669 7273 745f 6576 656e 7420 3d20 7265  first_event = re
-00022680: 7370 2e63 6875 6e6b 5b30 5d0a 2020 2020  sp.chunk[0].    
-00022690: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-000226a0: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
-000226b0: 5f72 6561 645f 6d61 726b 6572 7328 0a20  _read_markers(. 
-000226c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000226d0: 6f6f 6d5f 6964 3d72 6f6f 6d5f 6964 2c0a  oom_id=room_id,.
-000226e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226f0: 6675 6c6c 795f 7265 6164 5f65 7665 6e74  fully_read_event
-00022700: 3d66 6972 7374 5f65 7665 6e74 2e65 7665  =first_event.eve
-00022710: 6e74 5f69 642c 0a20 2020 2020 2020 2020  nt_id,.         
-00022720: 2020 2020 2020 2072 6561 645f 6576 656e         read_even
-00022730: 743d 6669 7273 745f 6576 656e 742e 6576  t=first_event.ev
-00022740: 656e 745f 6964 2c0a 2020 2020 2020 2020  ent_id,.        
-00022750: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00022760: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00022770: 7265 7370 2c20 526f 6f6d 5265 6164 4d61  resp, RoomReadMa
-00022780: 726b 6572 7345 7272 6f72 293a 0a20 2020  rkersError):.   
-00022790: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-000227a0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-000227b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000227c0: 726f 6f6d 5f72 6561 645f 6d61 726b 6572  room_read_marker
-000227d0: 7320 6661 696c 6564 2077 6974 6820 7265  s failed with re
-000227e0: 7370 6f6e 7365 2022 0a20 2020 2020 2020  sponse ".       
-000227f0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-00022800: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
-00022810: 7472 2872 6573 7029 297d 2e22 0a20 2020  tr(resp))}.".   
-00022820: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00022830: 0a61 7379 6e63 2064 6566 2072 6561 645f  .async def read_
-00022840: 616c 6c5f 6576 656e 7473 5f69 6e5f 6469  all_events_in_di
-00022850: 7265 6374 696f 6e28 0a20 2020 2063 6c69  rection(.    cli
-00022860: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-00022870: 2c0a 2020 2020 726f 6f6d 5f69 643a 2073  ,.    room_id: s
-00022880: 7472 2c0a 2020 2020 7374 6172 745f 746f  tr,.    start_to
-00022890: 6b65 6e3a 2073 7472 2c0a 2020 2020 6469  ken: str,.    di
-000228a0: 7265 6374 696f 6e3a 204d 6573 7361 6765  rection: Message
-000228b0: 4469 7265 6374 696f 6e20 3d20 4d65 7373  Direction = Mess
-000228c0: 6167 6544 6972 6563 7469 6f6e 2e62 6163  ageDirection.bac
-000228d0: 6b2c 0a29 202d 3e20 6c69 7374 3a0a 2020  k,.) -> list:.  
-000228e0: 2020 2222 2252 6561 6420 616c 6c20 6576    """Read all ev
-000228f0: 656e 7473 2066 726f 6d20 6120 6769 7665  ents from a give
-00022900: 6e20 726f 6f6d 2069 6e20 6365 7274 6169  n room in certai
-00022910: 6e20 6469 7265 6374 696f 6e2e 0a0a 2020  n direction...  
-00022920: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
-00022930: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020   ---------.     
-00022940: 2020 2063 6c69 656e 743a 2041 7379 6e63     client: Async
-00022950: 436c 6965 6e74 203a 2054 6865 2063 7265  Client : The cre
-00022960: 6174 6564 204e 494f 2063 6c69 656e 740a  ated NIO client.
-00022970: 2020 2020 2020 2020 726f 6f6d 5f69 643a          room_id:
-00022980: 2073 7472 203a 2054 6865 2072 6f6f 6d20   str : The room 
-00022990: 6964 206f 6620 7468 6520 726f 6f6d 2066  id of the room f
-000229a0: 6f72 2077 6869 6368 2077 650a 2020 2020  or which we.    
-000229b0: 2020 2020 2020 2020 776f 756c 6420 6c69          would li
-000229c0: 6b65 2074 6f20 6665 7463 6820 7468 6520  ke to fetch the 
-000229d0: 6d65 7373 6167 6573 2e0a 2020 2020 2020  messages..      
-000229e0: 2020 7374 6172 745f 746f 6b65 6e3a 2073    start_token: s
-000229f0: 7472 203a 2020 5468 6520 746f 6b65 6e20  tr :  The token 
-00022a00: 746f 2073 7461 7274 2072 6574 7572 6e69  to start returni
-00022a10: 6e67 2065 7665 6e74 7320 6672 6f6d 2e0a  ng events from..
-00022a20: 2020 2020 2020 2020 2020 2020 5468 6973              This
-00022a30: 2074 6f6b 656e 2063 616e 2062 6520 6f62   token can be ob
-00022a40: 7461 696e 6564 2066 726f 6d20 6120 7072  tained from a pr
-00022a50: 6576 5f62 6174 6368 2074 6f6b 656e 2072  ev_batch token r
-00022a60: 6574 7572 6e65 6420 666f 720a 2020 2020  eturned for.    
-00022a70: 2020 2020 2020 2020 6561 6368 2072 6f6f          each roo
-00022a80: 6d20 6279 2074 6865 2073 796e 6328 2920  m by the sync() 
-00022a90: 4150 492c 206f 7220 6672 6f6d 2061 2073  API, or from a s
-00022aa0: 7461 7274 206f 7220 656e 6420 746f 6b65  tart or end toke
-00022ab0: 6e20 7265 7475 726e 6564 0a20 2020 2020  n returned.     
-00022ac0: 2020 2020 2020 2062 7920 6120 7072 6576         by a prev
-00022ad0: 696f 7573 2072 6571 7565 7374 2074 6f20  ious request to 
-00022ae0: 726f 6f6d 5f6d 6573 7361 6765 7328 292e  room_messages().
-00022af0: 0a20 2020 2020 2020 2064 6972 6563 7469  .        directi
-00022b00: 6f6e 3a20 4d65 7373 6167 6544 6972 6563  on: MessageDirec
-00022b10: 7469 6f6e 2028 6f70 7469 6f6e 616c 293a  tion (optional):
-00022b20: 2054 6865 2064 6972 6563 7469 6f6e 2074   The direction t
-00022b30: 6f20 7265 7475 726e 0a20 2020 2020 2020  o return.       
-00022b40: 2020 2020 2065 7665 6e74 7320 6672 6f6d       events from
-00022b50: 2e20 4465 6661 756c 7473 2074 6f20 4d65  . Defaults to Me
-00022b60: 7373 6167 6544 6972 6563 7469 6f6e 2e62  ssageDirection.b
-00022b70: 6163 6b2e 0a0a 2020 2020 5265 7475 726e  ack...    Return
-00022b80: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00022b90: 2020 2020 2020 6c69 7374 3a20 6c69 7374        list: list
-00022ba0: 206f 6620 526f 6f6d 4d65 7373 6167 6520   of RoomMessage 
-00022bb0: 6576 656e 7473 2c20 636f 756c 6420 6265  events, could be
-00022bc0: 2065 6d70 7479 0a0a 2020 2020 5265 6164   empty..    Read
-00022bd0: 2061 6c6c 206d 6573 7361 6765 7320 6f66   all messages of
-00022be0: 2061 2072 6f6f 6d20 6265 6769 6e6e 696e   a room beginnin
-00022bf0: 6720 6672 6f6d 2074 6865 2070 6173 745f  g from the past_
-00022c00: 746f 6b65 6e0a 2020 2020 746f 206f 6c64  token.    to old
-00022c10: 6573 7420 6f72 206e 6577 6573 7420 6d65  est or newest me
-00022c20: 7373 6167 6520 2864 6570 656e 6469 6e67  ssage (depending
-00022c30: 206f 6e20 7468 6520 6469 7265 6374 696f   on the directio
-00022c40: 6e29 2e0a 0a20 2020 2022 2222 0a20 2020  n)...    """.   
-00022c50: 2061 6c6c 5f65 7665 6e74 7320 3d20 5b5d   all_events = []
-00022c60: 0a20 2020 2063 7572 7265 6e74 5f73 7461  .    current_sta
-00022c70: 7274 5f74 6f6b 656e 203d 2073 7461 7274  rt_token = start
-00022c80: 5f74 6f6b 656e 0a20 2020 2023 2069 7320  _token.    # is 
-00022c90: 6361 7070 6564 2061 7420 3130 3030 2061  capped at 1000 a
-00022ca0: 7420 7365 7276 6572 2073 6964 650a 2020  t server side.  
-00022cb0: 2020 2320 3130 2073 6565 6d73 2074 6f6f    # 10 seems too
-00022cc0: 2073 6d61 6c6c 2c20 692e 652e 2074 6f6f   small, i.e. too
-00022cd0: 2073 6c6f 770a 2020 2020 2320 3130 3020   slow.    # 100 
-00022ce0: 746f 2035 3030 2073 6565 6d20 676f 6f64  to 500 seem good
-00022cf0: 2076 616c 7565 732c 2064 6570 656e 6473   values, depends
-00022d00: 206f 6e20 6e65 7477 6f72 6b20 7370 6565   on network spee
-00022d10: 642c 2073 6572 7665 7220 6c6f 6164 2c20  d, server load, 
-00022d20: 2e2e 2e0a 2020 2020 2320 6578 616d 706c  ....    # exampl
-00022d30: 6520 7275 6e3a 2032 3530 2d2d 3e37 6d69  e run: 250-->7mi
-00022d40: 6e33 3073 2c20 3530 302d 2d3e 346d 696e  n30s, 500-->4min
-00022d50: 3330 730a 2020 2020 6d61 785f 6d73 675f  30s.    max_msg_
-00022d60: 7065 725f 7075 6c6c 203d 2035 3030 0a20  per_pull = 500. 
-00022d70: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
-00022d80: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00022d90: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-00022da0: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
-00022db0: 5f6d 6573 7361 6765 7328 0a20 2020 2020  _messages(.     
-00022dc0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-00022dd0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00022de0: 2020 2020 6375 7272 656e 745f 7374 6172      current_star
-00022df0: 745f 746f 6b65 6e2c 0a20 2020 2020 2020  t_token,.       
-00022e00: 2020 2020 2020 2020 206c 696d 6974 3d6d           limit=m
-00022e10: 6178 5f6d 7367 5f70 6572 5f70 756c 6c2c  ax_msg_per_pull,
-00022e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022e30: 2064 6972 6563 7469 6f6e 3d64 6972 6563   direction=direc
-00022e40: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-00022e50: 2020 290a 2020 2020 2020 2020 6578 6365    ).        exce
-00022e60: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00022e70: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00022e80: 2064 7572 696e 6720 7465 7374 696e 6720   during testing 
-00022e90: 4920 6f62 7365 7276 6564 2074 6861 7420  I observed that 
-00022ea0: 736f 6d65 7469 6d65 7320 616e 2065 7863  sometimes an exc
-00022eb0: 6570 7469 6f6e 2069 7320 7261 6973 6564  eption is raised
-00022ec0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00022ed0: 6275 7420 6520 6973 2065 6d70 7479 2e20  but e is empty. 
-00022ee0: 5374 6163 6b74 7261 6365 2068 6164 2061  Stacktrace had a
-00022ef0: 7379 6e63 696f 2e65 7863 6570 7469 6f6e  syncio.exception
-00022f00: 732e 5469 6d65 6f75 7445 7272 6f72 2e0a  s.TimeoutError..
-00022f10: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00022f20: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-00022f30: 2020 2020 2020 2020 2020 2245 3136 313a            "E161:
-00022f40: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00022f50: 2020 2022 4572 726f 7220 6475 7269 6e67     "Error during
-00022f60: 2067 6574 7469 6e67 206d 6573 7361 6765   getting message
-00022f70: 732e 2022 0a20 2020 2020 2020 2020 2020  s. ".           
-00022f80: 2020 2020 2022 4275 7420 7072 6f67 7261       "But progra
-00022f90: 6d20 7769 6c6c 2063 6f6e 7469 6e75 6520  m will continue 
-00022fa0: 616e 7977 6179 2c20 6465 7370 6974 6520  anyway, despite 
-00022fb0: 7468 6520 6572 726f 722e 2022 0a20 2020  the error. ".   
-00022fc0: 2020 2020 2020 2020 2020 2020 2022 4e6f               "No
-00022fd0: 7420 616c 6c20 6d65 7373 6167 6573 206d  t all messages m
-00022fe0: 6967 6874 2068 6176 6520 6265 656e 2072  ight have been r
-00022ff0: 6574 7269 6576 6564 2066 726f 6d20 7365  etrieved from se
-00023000: 7276 6572 2e20 220a 2020 2020 2020 2020  rver. ".        
-00023010: 2020 2020 2020 2020 6622 4265 2077 6172          f"Be war
-00023020: 6e65 6421 2047 6f74 207b 6c65 6e28 616c  ned! Got {len(al
-00023030: 6c5f 6576 656e 7473 297d 206d 6573 7361  l_events)} messa
-00023040: 6765 7320 736f 2066 6172 2e22 0a20 2020  ges so far.".   
-00023050: 2020 2020 2020 2020 2020 2020 2066 2245               f"E
-00023060: 7863 6570 7469 6f6e 3a20 7b74 7970 6528  xception: {type(
-00023070: 6529 7d20 7b65 7d22 0a20 2020 2020 2020  e)} {e}".       
-00023080: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00023090: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-000230a0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-000230b0: 2067 732e 6c6f 672e 6465 6275 6728 2248   gs.log.debug("H
-000230c0: 6572 6520 6973 2074 6865 2074 7261 6365  ere is the trace
-000230d0: 6261 636b 2e5c 6e22 202b 2074 7261 6365  back.\n" + trace
-000230e0: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
-000230f0: 2929 0a20 2020 2020 2020 2020 2020 2062  )).            b
-00023100: 7265 616b 0a20 2020 2020 2020 2069 6620  reak.        if 
-00023110: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-00023120: 2052 6f6f 6d4d 6573 7361 6765 7345 7272   RoomMessagesErr
-00023130: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00023140: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-00023150: 2031 0a20 2020 2020 2020 2020 2020 2067   1.            g
-00023160: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00023170: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
-00023180: 3632 3a20 220a 2020 2020 2020 2020 2020  62: ".          
-00023190: 2020 2020 2020 6622 726f 6f6d 5f6d 6573        f"room_mes
-000231a0: 7361 6765 7320 6661 696c 6564 2077 6974  sages failed wit
-000231b0: 6820 7265 7370 203d 207b 7072 6976 6163  h resp = {privac
-000231c0: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-000231d0: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
-000231e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000231f0: 6272 6561 6b20 2023 2073 6b69 7020 746f  break  # skip to
-00023200: 2065 6e64 206f 6620 6675 6e63 7469 6f6e   end of function
-00023210: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00023220: 6465 6275 6728 6622 476f 7420 7b6c 656e  debug(f"Got {len
-00023230: 2861 6c6c 5f65 7665 6e74 7329 2b6c 656e  (all_events)+len
-00023240: 2872 6573 702e 6368 756e 6b29 7d20 6d65  (resp.chunk)} me
-00023250: 7373 6167 6573 2073 6f20 6661 722e 2229  ssages so far.")
-00023260: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00023270: 6465 6275 6728 6622 5265 6365 6976 6564  debug(f"Received
-00023280: 207b 6c65 6e28 7265 7370 2e63 6875 6e6b   {len(resp.chunk
-00023290: 297d 2065 7665 6e74 732e 2229 0a20 2020  )} events.").   
-000232a0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-000232b0: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
-000232c0: 2272 6f6f 6d5f 6d65 7373 6167 6573 2072  "room_messages r
-000232d0: 6573 706f 6e73 6520 3d20 7b74 7970 6528  esponse = {type(
-000232e0: 7265 7370 297d 203a 3a20 220a 2020 2020  resp)} :: ".    
-000232f0: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
-00023300: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-00023310: 7370 2929 7d2e 220a 2020 2020 2020 2020  sp))}.".        
-00023320: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
-00023330: 2e64 6562 7567 2866 2272 6f6f 6d5f 6d65  .debug(f"room_me
-00023340: 7373 6167 6573 2072 6f6f 6d5f 6964 203d  ssages room_id =
-00023350: 207b 7265 7370 2e72 6f6f 6d5f 6964 7d2e   {resp.room_id}.
-00023360: 2229 0a20 2020 2020 2020 2067 732e 6c6f  ").        gs.lo
-00023370: 672e 6465 6275 6728 6622 726f 6f6d 5f6d  g.debug(f"room_m
-00023380: 6573 7361 6765 7320 7374 6172 7420 3d20  essages start = 
-00023390: 2873 7472 2920 7b72 6573 702e 7374 6172  (str) {resp.star
-000233a0: 747d 2e22 290a 2020 2020 2020 2020 6773  t}.").        gs
-000233b0: 2e6c 6f67 2e64 6562 7567 2866 2272 6f6f  .log.debug(f"roo
-000233c0: 6d5f 6d65 7373 6167 6573 2065 6e64 203d  m_messages end =
-000233d0: 2028 7374 7229 203a 3a20 7b72 6573 702e   (str) :: {resp.
-000233e0: 656e 647d 2e22 290a 2020 2020 2020 2020  end}.").        
-000233f0: 6773 2e6c 6f67 2e64 6562 7567 2866 2272  gs.log.debug(f"r
-00023400: 6f6f 6d5f 6d65 7373 6167 6573 2063 6875  oom_messages chu
-00023410: 6e6b 203d 2028 6c69 7374 2920 3a3a 207b  nk = (list) :: {
-00023420: 7265 7370 2e63 6875 6e6b 7d2e 2229 0a20  resp.chunk}."). 
-00023430: 2020 2020 2020 2023 2072 6573 702e 6368         # resp.ch
-00023440: 756e 6b20 6973 206a 7573 7420 6120 6c69  unk is just a li
-00023450: 7374 206f 6620 526f 6f6d 4d65 7373 6167  st of RoomMessag
-00023460: 6520 6576 656e 7473 206c 696b 6520 7468  e events like th
-00023470: 6973 2065 7861 6d70 6c65 3a0a 2020 2020  is example:.    
-00023480: 2020 2020 2320 6368 756e 6b3d 5b52 6f6f      # chunk=[Roo
-00023490: 6d4d 6573 7361 6765 5465 7874 282e 2e2e  mMessageText(...
-000234a0: 295d 0a20 2020 2020 2020 2063 7572 7265  )].        curre
-000234b0: 6e74 5f73 7461 7274 5f74 6f6b 656e 203d  nt_start_token =
-000234c0: 2072 6573 702e 656e 640a 2020 2020 2020   resp.end.      
-000234d0: 2020 6966 206c 656e 2872 6573 702e 6368    if len(resp.ch
-000234e0: 756e 6b29 203d 3d20 303a 0a20 2020 2020  unk) == 0:.     
-000234f0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00023500: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00023510: 2020 2020 2022 416c 6c20 6d65 7373 6167       "All messag
-00023520: 6573 2068 6176 6520 6265 656e 2072 6574  es have been ret
-00023530: 7269 6576 6564 2066 726f 6d20 7365 7276  rieved from serv
-00023540: 6572 2073 7563 6365 7373 6675 6c6c 792e  er successfully.
-00023550: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00023560: 2020 2066 227b 6c65 6e28 616c 6c5f 6576     f"{len(all_ev
-00023570: 656e 7473 297d 206d 6573 7361 6765 7320  ents)} messages 
-00023580: 7765 7265 2070 756c 6c65 6420 6672 6f6d  were pulled from
-00023590: 2073 6572 7665 722e 220a 2020 2020 2020   server.".      
-000235a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000235b0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-000235c0: 2020 616c 6c5f 6576 656e 7473 203d 2061    all_events = a
-000235d0: 6c6c 5f65 7665 6e74 7320 2b20 7265 7370  ll_events + resp
-000235e0: 2e63 6875 6e6b 0a20 2020 2072 6574 7572  .chunk.    retur
-000235f0: 6e20 616c 6c5f 6576 656e 7473 0a0a 0a23  n all_events...#
-00023600: 2061 6363 6f72 6469 6e67 2074 6f20 7079   according to py
-00023610: 6c61 6d61 3a20 6675 6e63 7469 6f6e 2074  lama: function t
-00023620: 6f6f 2063 6f6d 706c 6578 3a20 4339 3031  oo complex: C901
-00023630: 2023 206e 6f71 613a 2043 3930 310a 6173   # noqa: C901.as
-00023640: 796e 6320 6465 6620 6c69 7374 656e 5f61  ync def listen_a
-00023650: 6c6c 2820 2023 206e 6f71 613a 2043 3930  ll(  # noqa: C90
-00023660: 310a 2020 2020 636c 6965 6e74 3a20 4173  1.    client: As
-00023670: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
-00023680: 6e74 6961 6c73 3a20 6469 6374 0a29 202d  ntials: dict.) -
-00023690: 3e20 4e6f 6e65 3a20 2023 206e 6f71 613a  > None:  # noqa:
-000236a0: 2043 3930 310a 2020 2020 2222 2247 6574   C901.    """Get
-000236b0: 2061 6c6c 206d 6573 7361 6765 732c 2074   all messages, t
-000236c0: 6865 6e20 7175 6974 2e0a 0a20 2020 2041  hen quit...    A
-000236d0: 7267 756d 656e 7473 3a0a 2020 2020 2d2d  rguments:.    --
-000236e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-000236f0: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-00023700: 656e 7420 3a20 7468 6520 6372 6561 7465  ent : the create
-00023710: 6420 4e49 4f20 636c 6965 6e74 0a20 2020  d NIO client.   
-00023720: 2020 2020 2063 7265 6465 6e74 6961 6c73       credentials
-00023730: 3a20 6469 6374 203a 2063 7265 6465 6e74  : dict : credent
-00023740: 6961 6c73 2064 6963 7469 6f6e 6172 7920  ials dictionary 
-00023750: 6672 6f6d 2074 6865 2063 7265 6465 6e74  from the credent
-00023760: 6961 6c73 2066 696c 650a 0a20 2020 2047  ials file..    G
-00023770: 6574 2061 6c6c 206d 6573 7361 6765 732e  et all messages.
-00023780: 2053 6f6d 6520 6d69 6768 7420 6265 206f   Some might be o
-00023790: 6c64 2c20 692e 652e 2061 6c72 6561 6479  ld, i.e. already
-000237a0: 0a20 2020 2072 6561 6420 6265 666f 7265  .    read before
-000237b0: 2c20 736f 6d65 206d 6967 6874 2062 6520  , some might be 
-000237c0: 6e65 772c 2069 2e65 2e20 6e65 7665 7220  new, i.e. never 
-000237d0: 7265 6164 2062 6566 6f72 652e 0a20 2020  read before..   
-000237e0: 2050 7269 6e74 2074 6865 6d2e 2054 6865   Print them. The
-000237f0: 6e20 6c65 6176 652e 0a0a 2020 2020 5468  n leave...    Th
-00023800: 6520 6675 6e63 7469 6f6e 2072 6f6f 6d5f  e function room_
-00023810: 6d65 7373 6167 6573 2829 2069 7320 7573  messages() is us
-00023820: 6564 2074 6f20 6765 7420 616c 6c20 6d65  ed to get all me
-00023830: 7373 6167 6573 2e0a 0a20 2020 2022 2222  ssages...    """
-00023840: 0a20 2020 2023 2077 6520 6361 6c6c 2073  .    # we call s
-00023850: 796e 6328 2920 746f 2067 6574 2074 6865  ync() to get the
-00023860: 206e 6578 745f 6261 7463 6820 6d61 726b   next_batch mark
-00023870: 6572 0a20 2020 2023 2077 6520 7365 7420  er.    # we set 
-00023880: 6675 6c6c 5f73 7461 7465 3d54 7275 6520  full_state=True 
-00023890: 746f 2067 6574 2061 6c6c 2072 6f6f 6d5f  to get all room_
-000238a0: 6964 730a 2020 2020 7265 7370 5f73 203d  ids.    resp_s =
-000238b0: 2061 7761 6974 2073 796e 6368 726f 6e69   await synchroni
-000238c0: 7a65 2863 6c69 656e 7429 2020 2320 7379  ze(client)  # sy
-000238d0: 6e63 2829 2074 6f20 6765 7420 726f 6f6d  nc() to get room
-000238e0: 730a 2020 2020 2320 7468 6973 2070 7269  s.    # this pri
-000238f0: 6e74 7320 6120 7375 6d6d 6172 7920 6f66  nts a summary of
-00023900: 2061 6c6c 206e 6577 206d 6573 7361 6765   all new message
-00023910: 7320 6375 7272 656e 746c 7920 7761 6974  s currently wait
-00023920: 696e 6720 696e 2074 6865 2071 7565 7565  ing in the queue
-00023930: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-00023940: 6728 6622 7379 6e63 2072 6573 706f 6e73  g(f"sync respons
-00023950: 6520 3d20 7b74 7970 6528 7265 7370 5f73  e = {type(resp_s
-00023960: 297d 203a 3a20 7b72 6573 705f 737d 2229  )} :: {resp_s}")
-00023970: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-00023980: 6728 6622 636c 6965 6e74 2e6e 6578 745f  g(f"client.next_
-00023990: 6261 7463 6820 6166 7465 7220 3d20 2873  batch after = (s
-000239a0: 7472 2920 7b63 6c69 656e 742e 6e65 7874  tr) {client.next
-000239b0: 5f62 6174 6368 7d22 290a 2020 2020 6773  _batch}").    gs
-000239c0: 2e6c 6f67 2e64 6562 7567 2866 2273 796e  .log.debug(f"syn
-000239d0: 6320 6e65 7874 5f62 6174 6368 203d 2028  c next_batch = (
-000239e0: 7374 7229 207b 7265 7370 5f73 2e6e 6578  str) {resp_s.nex
-000239f0: 745f 6261 7463 687d 2229 0a20 2020 2067  t_batch}").    g
-00023a00: 732e 6c6f 672e 6465 6275 6728 6622 7379  s.log.debug(f"sy
-00023a10: 6e63 2072 6f6f 6d73 203d 2028 6e69 6f2e  nc rooms = (nio.
-00023a20: 7265 7370 6f6e 7365 732e 526f 6f6d 7329  responses.Rooms)
-00023a30: 207b 7265 7370 5f73 2e72 6f6f 6d73 7d22   {resp_s.rooms}"
-00023a40: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
-00023a50: 7567 2866 2263 6c69 656e 742e 726f 6f6d  ug(f"client.room
-00023a60: 7320 3d20 7b63 6c69 656e 742e 726f 6f6d  s = {client.room
-00023a70: 737d 2229 0a20 2020 2069 6620 6e6f 7420  s}").    if not 
-00023a80: 7265 7370 5f73 2e72 6f6f 6d73 2e6a 6f69  resp_s.rooms.joi
-00023a90: 6e3a 2020 2320 6e6f 2052 6f6f 6d73 210a  n:  # no Rooms!.
-00023aa0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00023ab0: 6562 7567 2866 2273 796e 6320 7265 7475  ebug(f"sync retu
-00023ac0: 726e 6564 206e 6f20 726f 6f6d 7320 3d20  rned no rooms = 
-00023ad0: 7b72 6573 705f 732e 726f 6f6d 732e 6a6f  {resp_s.rooms.jo
-00023ae0: 696e 7d22 290a 2020 2020 2020 2020 7265  in}").        re
-00023af0: 7475 726e 0a0a 2020 2020 2320 5365 7420  turn..    # Set 
-00023b00: 7570 2065 7665 6e74 2063 616c 6c62 6163  up event callbac
-00023b10: 6b73 0a20 2020 2063 616c 6c62 6163 6b73  ks.    callbacks
-00023b20: 203d 2043 616c 6c62 6163 6b73 2863 6c69   = Callbacks(cli
-00023b30: 656e 7429 0a20 2020 2023 204e 6f74 653a  ent).    # Note:
-00023b40: 2077 6520 6172 6520 4e4f 5420 7265 6769   we are NOT regi
-00023b50: 7374 6572 696e 6720 6120 6361 6c6c 6261  stering a callba
-00023b60: 636b 2066 756e 7469 6f6e 210a 0a20 2020  ck funtion!..   
-00023b70: 2023 2072 6f6f 6d5f 6964 203d 206c 6973   # room_id = lis
-00023b80: 7428 7265 7370 5f73 2e72 6f6f 6d73 2e6a  t(resp_s.rooms.j
-00023b90: 6f69 6e2e 6b65 7973 2829 295b 305d 2020  oin.keys())[0]  
-00023ba0: 2320 6669 7273 7420 726f 6f6d 5f69 6420  # first room_id 
-00023bb0: 6672 6f6d 2064 6963 740a 2020 2020 2320  from dict.    # 
-00023bc0: 616c 7465 726e 6174 6976 6520 7761 7920  alternative way 
-00023bd0: 6f66 2067 6574 7469 6e67 2072 6f6f 6d5f  of getting room_
-00023be0: 6964 2c20 636c 6965 6e74 2e72 6f6f 6d73  id, client.rooms
-00023bf0: 2069 7320 616c 736f 2061 2064 6963 740a   is also a dict.
-00023c00: 2020 2020 2320 726f 6f6d 5f69 6420 3d20      # room_id = 
-00023c10: 6c69 7374 2863 6c69 656e 742e 726f 6f6d  list(client.room
-00023c20: 732e 6b65 7973 2829 295b 305d 2020 2320  s.keys())[0]  # 
-00023c30: 6669 7273 7420 726f 6f6d 5f69 6420 6672  first room_id fr
-00023c40: 6f6d 2064 6963 740a 0a20 2020 2023 2067  om dict..    # g
-00023c50: 6574 2072 6f6f 6d73 2061 7320 7370 6563  et rooms as spec
-00023c60: 6966 6965 6420 6279 2074 6865 2075 7365  ified by the use
-00023c70: 7220 7468 7275 2061 7267 7320 6f72 2063  r thru args or c
-00023c80: 7265 6465 6e74 6961 6c20 6669 6c65 0a20  redential file. 
-00023c90: 2020 2072 6f6f 6d73 203d 2061 7761 6974     rooms = await
-00023ca0: 2064 6574 6572 6d69 6e65 5f72 6f6f 6d73   determine_rooms
-00023cb0: 2863 7265 6465 6e74 6961 6c73 5b22 726f  (credentials["ro
-00023cc0: 6f6d 5f69 6422 5d2c 2063 6c69 656e 742c  om_id"], client,
-00023cd0: 2063 7265 6465 6e74 6961 6c73 290a 2020   credentials).  
-00023ce0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00023cf0: 2252 6f6f 6d73 2061 7265 3a20 7b72 6f6f  "Rooms are: {roo
-00023d00: 6d73 7d22 290a 0a20 2020 2023 2054 6f20  ms}")..    # To 
-00023d10: 6c6f 6f70 206f 7665 7220 616c 6c20 726f  loop over all ro
-00023d20: 6f6d 732c 206f 6e65 2063 616e 206c 6f6f  oms, one can loo
-00023d30: 7020 7468 726f 7567 6820 7468 6520 6a6f  p through the jo
-00023d40: 696e 2064 6963 7469 6f6e 6172 792e 2069  in dictionary. i
-00023d50: 2e65 2e0a 2020 2020 2320 666f 7220 726f  .e..    # for ro
-00023d60: 6f6d 5f69 642c 2072 6f6f 6d5f 696e 666f  om_id, room_info
-00023d70: 2069 6e20 7265 7370 5f73 2e72 6f6f 6d73   in resp_s.rooms
-00023d80: 2e6a 6f69 6e2e 6974 656d 7328 293a 2020  .join.items():  
-00023d90: 2320 6c6f 6f70 2061 6c6c 2072 6f6f 6d73  # loop all rooms
-00023da0: 0a20 2020 2066 6f72 2072 6f6f 6d5f 6964  .    for room_id
-00023db0: 2069 6e20 726f 6f6d 733a 2020 2320 6c6f   in rooms:  # lo
-00023dc0: 6f70 206f 6e6c 7920 6f76 6572 2075 7365  op only over use
-00023dd0: 7220 7370 6563 6966 6965 6420 726f 6f6d  r specified room
-00023de0: 730a 2020 2020 2020 2020 7072 6576 5f62  s.        prev_b
-00023df0: 6174 6368 203d 2072 6573 705f 732e 726f  atch = resp_s.ro
-00023e00: 6f6d 732e 6a6f 696e 5b72 6f6f 6d5f 6964  oms.join[room_id
-00023e10: 5d2e 7469 6d65 6c69 6e65 2e70 7265 765f  ].timeline.prev_
-00023e20: 6261 7463 680a 2020 2020 2020 2020 6261  batch.        ba
-00023e30: 636b 5f65 7665 6e74 7320 3d20 6177 6169  ck_events = awai
-00023e40: 7420 7265 6164 5f61 6c6c 5f65 7665 6e74  t read_all_event
-00023e50: 735f 696e 5f64 6972 6563 7469 6f6e 280a  s_in_direction(.
-00023e60: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-00023e70: 6e74 2c20 726f 6f6d 5f69 642c 2070 7265  nt, room_id, pre
-00023e80: 765f 6261 7463 682c 204d 6573 7361 6765  v_batch, Message
-00023e90: 4469 7265 6374 696f 6e2e 6261 636b 0a20  Direction.back. 
-00023ea0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00023eb0: 2066 726f 6e74 5f65 7665 6e74 7320 3d20   front_events = 
-00023ec0: 6177 6169 7420 7265 6164 5f61 6c6c 5f65  await read_all_e
-00023ed0: 7665 6e74 735f 696e 5f64 6972 6563 7469  vents_in_directi
-00023ee0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-00023ef0: 636c 6965 6e74 2c20 726f 6f6d 5f69 642c  client, room_id,
-00023f00: 2070 7265 765f 6261 7463 682c 204d 6573   prev_batch, Mes
-00023f10: 7361 6765 4469 7265 6374 696f 6e2e 6672  sageDirection.fr
-00023f20: 6f6e 740a 2020 2020 2020 2020 290a 0a20  ont.        ).. 
-00023f30: 2020 2020 2020 2023 2057 6520 6861 7665         # We have
-00023f40: 2074 6f20 7265 7665 7273 6520 7468 6520   to reverse the 
-00023f50: 6669 7273 7420 6c69 7374 2073 696e 6365  first list since
-00023f60: 2077 6520 6172 6520 676f 696e 6720 6261   we are going ba
-00023f70: 636b 7761 7264 7320 2862 7574 0a20 2020  ckwards (but.   
-00023f80: 2020 2020 2023 2077 6520 7761 6e74 2074       # we want t
-00023f90: 6f20 6861 7665 2061 2063 6872 6f6e 6f6c  o have a chronol
-00023fa0: 6f67 6963 616c 206f 7264 6572 290a 2020  ogical order).  
-00023fb0: 2020 2020 2020 616c 6c5f 6576 656e 7473        all_events
-00023fc0: 203d 2062 6163 6b5f 6576 656e 7473 5b3a   = back_events[:
-00023fd0: 3a2d 315d 202b 2066 726f 6e74 5f65 7665  :-1] + front_eve
-00023fe0: 6e74 730a 0a20 2020 2020 2020 2066 6f72  nts..        for
-00023ff0: 2065 7665 6e74 2069 6e20 616c 6c5f 6576   event in all_ev
-00024000: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-00024010: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00024020: 2273 656e 6469 6e67 2065 7665 6e74 2074  "sending event t
-00024030: 6f20 6361 6c6c 6261 636b 203d 207b 6576  o callback = {ev
-00024040: 656e 747d 2e22 290a 2020 2020 2020 2020  ent}.").        
-00024050: 2020 2020 6966 2063 6c69 656e 742e 726f      if client.ro
-00024060: 6f6d 7320 616e 6420 636c 6965 6e74 2e72  oms and client.r
-00024070: 6f6f 6d73 5b72 6f6f 6d5f 6964 5d3a 0a20  ooms[room_id]:. 
-00024080: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00024090: 6f6f 6d20 3d20 636c 6965 6e74 2e72 6f6f  oom = client.roo
-000240a0: 6d73 5b72 6f6f 6d5f 6964 5d0a 2020 2020  ms[room_id].    
-000240b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000240c0: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-000240d0: 6f6d 203d 204d 6174 7269 7852 6f6f 6d28  om = MatrixRoom(
-000240e0: 726f 6f6d 5f69 642c 204e 6f6e 652c 2054  room_id, None, T
-000240f0: 7275 6529 2020 2320 6475 6d6d 795f 726f  rue)  # dummy_ro
-00024100: 6f6d 0a20 2020 2020 2020 2020 2020 2061  om.            a
-00024110: 7761 6974 2063 616c 6c62 6163 6b73 2e6d  wait callbacks.m
-00024120: 6573 7361 6765 5f63 616c 6c62 6163 6b28  essage_callback(
-00024130: 726f 6f6d 2c20 6576 656e 7429 0a20 2020  room, event).   
-00024140: 2020 2020 2069 6620 616c 6c5f 6576 656e       if all_even
-00024150: 7473 3a20 2023 206c 6973 7420 6e6f 7420  ts:  # list not 
-00024160: 656d 7074 790a 2020 2020 2020 2020 2020  empty.          
-00024170: 2020 6c61 7374 5f65 7665 6e74 203d 2061    last_event = a
-00024180: 6c6c 5f65 7665 6e74 735b 2d31 5d0a 2020  ll_events[-1].  
-00024190: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
-000241a0: 2061 7761 6974 2063 6c69 656e 742e 726f   await client.ro
-000241b0: 6f6d 5f72 6561 645f 6d61 726b 6572 7328  om_read_markers(
-000241c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000241d0: 2072 6f6f 6d5f 6964 3d72 6f6f 6d5f 6964   room_id=room_id
-000241e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000241f0: 2020 6675 6c6c 795f 7265 6164 5f65 7665    fully_read_eve
-00024200: 6e74 3d6c 6173 745f 6576 656e 742e 6576  nt=last_event.ev
-00024210: 656e 745f 6964 2c0a 2020 2020 2020 2020  ent_id,.        
-00024220: 2020 2020 2020 2020 7265 6164 5f65 7665          read_eve
-00024230: 6e74 3d6c 6173 745f 6576 656e 742e 6576  nt=last_event.ev
-00024240: 656e 745f 6964 2c0a 2020 2020 2020 2020  ent_id,.        
-00024250: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00024260: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00024270: 7265 7370 2c20 526f 6f6d 5265 6164 4d61  resp, RoomReadMa
-00024280: 726b 6572 7345 7272 6f72 293a 0a20 2020  rkersError):.   
-00024290: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-000242a0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
-000242b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000242c0: 4531 3633 3a20 220a 2020 2020 2020 2020  E163: ".        
-000242d0: 2020 2020 2020 2020 2020 2020 2272 6f6f              "roo
-000242e0: 6d5f 7265 6164 5f6d 6172 6b65 7273 2066  m_read_markers f
-000242f0: 6169 6c65 6420 7769 7468 2072 6573 706f  ailed with respo
-00024300: 6e73 6520 220a 2020 2020 2020 2020 2020  nse ".          
-00024310: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
-00024320: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-00024330: 7265 7370 2929 7d2e 220a 2020 2020 2020  resp))}.".      
-00024340: 2020 2020 2020 2020 2020 290a 0a0a 6173            )...as
-00024350: 796e 6320 6465 6620 6163 7469 6f6e 5f6c  ync def action_l
-00024360: 6973 7465 6e28 2920 2d3e 204e 6f6e 653a  isten() -> None:
-00024370: 0a20 2020 2022 2222 4c69 7374 656e 2077  .    """Listen w
-00024380: 6869 6c65 2062 6569 6e67 206c 6f67 6765  hile being logge
-00024390: 6420 696e 2e22 2222 0a20 2020 2069 6620  d in.""".    if 
-000243a0: 6e6f 7420 6773 2e63 6c69 656e 7420 616e  not gs.client an
-000243b0: 6420 6e6f 7420 6773 2e63 7265 6465 6e74  d not gs.credent
-000243c0: 6961 6c73 3a0a 2020 2020 2020 2020 6773  ials:.        gs
-000243d0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-000243e0: 2020 2020 2020 2020 2245 3136 343a 2022          "E164: "
-000243f0: 2022 436c 6965 6e74 206f 7220 6372 6564   "Client or cred
-00024400: 656e 7469 616c 7320 6e6f 7420 7365 742e  entials not set.
-00024410: 2053 6b69 7070 696e 6720 6163 7469 6f6e   Skipping action
-00024420: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-00024430: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-00024440: 7420 2b3d 2031 0a20 2020 2020 2020 2072  t += 1.        r
-00024450: 6574 7572 6e0a 2020 2020 7472 793a 0a20  eturn.    try:. 
-00024460: 2020 2020 2020 2023 2053 796e 6320 656e         # Sync en
-00024470: 6372 7970 7469 6f6e 206b 6579 7320 7769  cryption keys wi
-00024480: 7468 2074 6865 2073 6572 7665 720a 2020  th the server.  
-00024490: 2020 2020 2020 2320 5265 7175 6972 6564        # Required
-000244a0: 2066 6f72 2070 6172 7469 6369 7061 7469   for participati
-000244b0: 6e67 2069 6e20 656e 6372 7970 7465 6420  ng in encrypted 
-000244c0: 726f 6f6d 730a 2020 2020 2020 2020 6966  rooms.        if
-000244d0: 2067 732e 636c 6965 6e74 2e73 686f 756c   gs.client.shoul
-000244e0: 645f 7570 6c6f 6164 5f6b 6579 733a 0a20  d_upload_keys:. 
-000244f0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00024500: 2067 732e 636c 6965 6e74 2e6b 6579 735f   gs.client.keys_
-00024510: 7570 6c6f 6164 2829 0a20 2020 2020 2020  upload().       
-00024520: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-00024530: 4c69 7374 656e 696e 6720 7479 7065 3a20  Listening type: 
-00024540: 7b67 732e 7061 2e6c 6973 7465 6e7d 2229  {gs.pa.listen}")
-00024550: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-00024560: 612e 6c69 7374 656e 203d 3d20 464f 5245  a.listen == FORE
-00024570: 5645 523a 0a20 2020 2020 2020 2020 2020  VER:.           
-00024580: 2061 7761 6974 206c 6973 7465 6e5f 666f   await listen_fo
-00024590: 7265 7665 7228 6773 2e63 6c69 656e 7429  rever(gs.client)
-000245a0: 0a20 2020 2020 2020 2065 6c69 6620 6773  .        elif gs
-000245b0: 2e70 612e 6c69 7374 656e 203d 3d20 4f4e  .pa.listen == ON
-000245c0: 4345 3a0a 2020 2020 2020 2020 2020 2020  CE:.            
-000245d0: 6177 6169 7420 6c69 7374 656e 5f6f 6e63  await listen_onc
-000245e0: 6528 6773 2e63 6c69 656e 7429 0a20 2020  e(gs.client).   
-000245f0: 2020 2020 2020 2020 2023 2063 6f75 6c64           # could
-00024600: 2075 7365 2027 6177 6169 7420 6c69 7374   use 'await list
-00024610: 656e 5f6f 6e63 655f 616c 7465 726e 6174  en_once_alternat
-00024620: 6976 6528 6773 2e63 6c69 656e 7429 270a  ive(gs.client)'.
-00024630: 2020 2020 2020 2020 2020 2020 2320 6173              # as
-00024640: 2061 6e20 616c 7465 726e 6174 6976 6520   an alternative 
-00024650: 696d 706c 656d 656e 7461 7469 6f6e 0a20  implementation. 
-00024660: 2020 2020 2020 2065 6c69 6620 6773 2e70         elif gs.p
-00024670: 612e 6c69 7374 656e 203d 3d20 5441 494c  a.listen == TAIL
-00024680: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00024690: 6169 7420 6c69 7374 656e 5f74 6169 6c28  ait listen_tail(
-000246a0: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
-000246b0: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
-000246c0: 2020 2065 6c69 6620 6773 2e70 612e 6c69     elif gs.pa.li
-000246d0: 7374 656e 203d 3d20 414c 4c3a 0a20 2020  sten == ALL:.   
-000246e0: 2020 2020 2020 2020 2061 7761 6974 206c           await l
-000246f0: 6973 7465 6e5f 616c 6c28 6773 2e63 6c69  isten_all(gs.cli
-00024700: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
-00024710: 616c 7329 0a20 2020 2020 2020 2065 6c73  als).        els
-00024720: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
-00024730: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00024740: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
-00024750: 3635 3a20 220a 2020 2020 2020 2020 2020  65: ".          
-00024760: 2020 2020 2020 6627 556e 7265 636f 676e        f'Unrecogn
-00024770: 697a 6564 206c 6973 7465 6e69 6e67 2074  ized listening t
-00024780: 7970 6520 227b 6773 2e70 612e 6c69 7374  ype "{gs.pa.list
-00024790: 656e 7d22 2e20 270a 2020 2020 2020 2020  en}". '.        
-000247a0: 2020 2020 2020 2020 2253 6b69 7070 696e          "Skippin
-000247b0: 6720 6c69 7374 656e 696e 672e 220a 2020  g listening.".  
-000247c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000247d0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-000247e0: 6f75 6e74 202b 3d20 310a 2020 2020 6578  ount += 1.    ex
-000247f0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00024800: 7320 653a 0a20 2020 2020 2020 2067 732e  s e:.        gs.
-00024810: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
-00024820: 2020 2020 2020 2022 4531 3636 3a20 220a         "E166: ".
-00024830: 2020 2020 2020 2020 2020 2020 2245 7272              "Err
-00024840: 6f72 2064 7572 696e 6720 6c69 7374 656e  or during listen
-00024850: 696e 672e 2043 6f6e 7469 6e75 696e 6720  ing. Continuing 
-00024860: 6465 7370 6974 6520 6572 726f 722e 2022  despite error. "
-00024870: 0a20 2020 2020 2020 2020 2020 2066 2245  .            f"E
-00024880: 7863 6570 7469 6f6e 3a20 7b65 7d22 0a20  xception: {e}". 
-00024890: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000248a0: 2067 732e 6c6f 672e 6465 6275 6728 2248   gs.log.debug("H
-000248b0: 6572 6520 6973 2074 6865 2074 7261 6365  ere is the trace
-000248c0: 6261 636b 2e5c 6e22 202b 2074 7261 6365  back.\n" + trace
-000248d0: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
-000248e0: 2929 0a20 2020 2020 2020 2067 732e 6572  )).        gs.er
-000248f0: 725f 636f 756e 7420 2b3d 2031 0a0a 0a61  r_count += 1...a
-00024900: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-00024910: 7365 745f 6465 7669 6365 5f6e 616d 6528  set_device_name(
-00024920: 0a20 2020 2063 6c69 656e 743a 2041 7379  .    client: Asy
-00024930: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
-00024940: 7469 616c 733a 2064 6963 740a 2920 2d3e  tials: dict.) ->
-00024950: 204e 6f6e 653a 0a20 2020 2022 2222 5365   None:.    """Se
-00024960: 742c 2072 656e 616d 6520 7468 6520 6465  t, rename the de
-00024970: 7669 6365 206e 616d 6520 6f66 2069 7473  vice name of its
-00024980: 656c 6620 7768 696c 6520 616c 7265 6164  elf while alread
-00024990: 7920 6265 696e 6720 6c6f 6767 6564 2069  y being logged i
-000249a0: 6e2e 2222 220a 2020 2020 636f 6e74 656e  n.""".    conten
-000249b0: 7420 3d20 7b22 6465 7669 6365 5f6e 616d  t = {"device_nam
-000249c0: 6522 3a20 6773 2e70 612e 7365 745f 6465  e": gs.pa.set_de
-000249d0: 7669 6365 5f6e 616d 657d 0a20 2020 2072  vice_name}.    r
-000249e0: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-000249f0: 6e74 2e75 7064 6174 655f 6465 7669 6365  nt.update_device
-00024a00: 2863 7265 6465 6e74 6961 6c73 5b22 6465  (credentials["de
-00024a10: 7669 6365 5f69 6422 5d2c 2063 6f6e 7465  vice_id"], conte
-00024a20: 6e74 290a 2020 2020 6966 2069 7369 6e73  nt).    if isins
-00024a30: 7461 6e63 6528 7265 7370 2c20 5570 6461  tance(resp, Upda
-00024a40: 7465 4465 7669 6365 4572 726f 7229 3a0a  teDeviceError):.
-00024a50: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00024a60: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00024a70: 2020 2245 3136 373a 2022 2066 2275 7064    "E167: " f"upd
-00024a80: 6174 655f 6465 7669 6365 2066 6169 6c65  ate_device faile
-00024a90: 6420 7769 7468 207b 7072 6976 6163 795f  d with {privacy_
-00024aa0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00024ab0: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
-00024ac0: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00024ad0: 6e74 202b 3d20 310a 2020 2020 656c 7365  nt += 1.    else
-00024ae0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00024af0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00024b00: 2020 2020 6622 7570 6461 7465 5f64 6576      f"update_dev
-00024b10: 6963 6520 7375 6363 6573 7366 756c 2077  ice successful w
-00024b20: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
-00024b30: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-00024b40: 0a20 2020 2020 2020 2029 0a0a 0a61 7379  .        )...asy
-00024b50: 6e63 2064 6566 2061 6374 696f 6e5f 7365  nc def action_se
-00024b60: 745f 6469 7370 6c61 795f 6e61 6d65 280a  t_display_name(.
-00024b70: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
-00024b80: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
-00024b90: 6961 6c73 3a20 6469 6374 0a29 202d 3e20  ials: dict.) -> 
-00024ba0: 4e6f 6e65 3a0a 2020 2020 2222 2253 6574  None:.    """Set
-00024bb0: 2c20 7265 6e61 6d65 2074 6865 206c 6f67  , rename the log
-00024bc0: 6765 6420 696e 2075 7365 7227 7320 6469  ged in user's di
-00024bd0: 7370 6c61 7920 6e61 6d65 2e20 4368 616e  splay name. Chan
-00024be0: 6765 206d 7920 6f77 6e0a 2020 2020 6469  ge my own.    di
-00024bf0: 7370 6c61 7920 6e61 6d65 2e0a 2020 2020  splay name..    
-00024c00: 5265 6e61 6d65 2074 6865 2075 7365 7220  Rename the user 
-00024c10: 6279 2063 6861 6e67 696e 6720 6469 7370  by changing disp
-00024c20: 6c61 7920 6e61 6d65 2e0a 2020 2020 4173  lay name..    As
-00024c30: 7375 6d65 7320 7468 6174 2075 7365 7220  sumes that user 
-00024c40: 6973 2061 6c72 6561 6479 206c 6f67 6765  is already logge
-00024c50: 6420 696e 2e0a 2020 2020 2222 220a 2020  d in..    """.  
-00024c60: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00024c70: 6c69 656e 742e 7365 745f 6469 7370 6c61  lient.set_displa
-00024c80: 796e 616d 6528 6773 2e70 612e 7365 745f  yname(gs.pa.set_
-00024c90: 6469 7370 6c61 795f 6e61 6d65 290a 2020  display_name).  
-00024ca0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00024cb0: 7265 7370 2c20 5072 6f66 696c 6553 6574  resp, ProfileSet
-00024cc0: 4469 7370 6c61 794e 616d 6545 7272 6f72  DisplayNameError
-00024cd0: 293a 0a20 2020 2020 2020 2067 732e 6c6f  ):.        gs.lo
-00024ce0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00024cf0: 2020 2020 2022 4531 3638 3a20 2220 6622       "E168: " f"
-00024d00: 7365 745f 6469 7370 6c61 796e 616d 6520  set_displayname 
-00024d10: 6661 696c 6564 2077 6974 6820 7b70 7269  failed with {pri
-00024d20: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-00024d30: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-00024d40: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
-00024d50: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-00024d60: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
-00024d70: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-00024d80: 2020 2020 2020 2020 2066 2273 6574 5f64           f"set_d
-00024d90: 6973 706c 6179 6e61 6d65 2073 7563 6365  isplayname succe
-00024da0: 7373 6675 6c20 7769 7468 207b 7072 6976  ssful with {priv
-00024db0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00024dc0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-00024dd0: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
-00024de0: 7469 6f6e 5f67 6574 5f64 6973 706c 6179  tion_get_display
-00024df0: 5f6e 616d 6528 0a20 2020 2063 6c69 656e  _name(.    clien
-00024e00: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-00024e10: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-00024e20: 740a 2920 2d3e 204e 6f6e 653a 0a20 2020  t.) -> None:.   
-00024e30: 2022 2222 4765 7420 6469 7370 6c61 7920   """Get display 
-00024e40: 6e61 6d65 2873 2920 7768 696c 6520 616c  name(s) while al
-00024e50: 7265 6164 7920 6c6f 6767 6564 2069 6e2e  ready logged in.
-00024e60: 2222 220a 2020 2020 6966 206e 6f74 2067  """.    if not g
-00024e70: 732e 7061 2e75 7365 723a 0a20 2020 2020  s.pa.user:.     
-00024e80: 2020 2023 2067 6574 2064 6973 706c 6179     # get display
-00024e90: 206e 616d 6520 6f66 206d 7973 656c 660a   name of myself.
-00024ea0: 2020 2020 2020 2020 7768 6f61 6d69 203d          whoami =
-00024eb0: 2063 7265 6465 6e74 6961 6c73 5b22 7573   credentials["us
-00024ec0: 6572 5f69 6422 5d0a 2020 2020 2020 2020  er_id"].        
-00024ed0: 7573 6572 7320 3d20 5b77 686f 616d 695d  users = [whoami]
-00024ee0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00024ef0: 2020 2075 7365 7273 203d 2067 732e 7061     users = gs.pa
-00024f00: 2e75 7365 720a 2020 2020 7573 6572 7320  .user.    users 
-00024f10: 3d20 6c69 7374 2864 6963 742e 6672 6f6d  = list(dict.from
-00024f20: 6b65 7973 2875 7365 7273 2929 2020 2320  keys(users))  # 
-00024f30: 7265 6d6f 7665 2064 7570 6c69 6361 7465  remove duplicate
-00024f40: 7320 696e 206c 6973 740a 2020 2020 666f  s in list.    fo
-00024f50: 7220 7573 6572 2069 6e20 7573 6572 733a  r user in users:
-00024f60: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
-00024f70: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-00024f80: 5f64 6973 706c 6179 6e61 6d65 2875 7365  _displayname(use
-00024f90: 7229 0a20 2020 2020 2020 2069 6620 6973  r).        if is
-00024fa0: 696e 7374 616e 6365 2872 6573 702c 2050  instance(resp, P
-00024fb0: 726f 6669 6c65 4765 7444 6973 706c 6179  rofileGetDisplay
-00024fc0: 4e61 6d65 4572 726f 7229 3a0a 2020 2020  NameError):.    
-00024fd0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00024fe0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00024ff0: 2020 2020 2020 2245 3136 393a 2022 0a20        "E169: ". 
-00025000: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00025010: 2267 6574 5f64 6973 706c 6179 6e61 6d65  "get_displayname
-00025020: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
-00025030: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00025040: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00025050: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00025060: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-00025070: 202b 3d20 310a 2020 2020 2020 2020 656c   += 1.        el
-00025080: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00025090: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-000250a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000250b0: 6765 745f 6469 7370 6c61 796e 616d 6520  get_displayname 
-000250c0: 7375 6363 6573 7366 756c 2077 6974 6820  successful with 
-000250d0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-000250e0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-000250f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00025100: 2020 2020 2020 2023 2072 6573 702e 6469         # resp.di
-00025110: 7370 6c61 796e 616d 6520 6973 2073 7472  splayname is str
-00025120: 206f 7220 4e6f 6e65 2028 6861 7320 6e6f   or None (has no
-00025130: 2064 6973 706c 6179 206e 616d 6529 0a20   display name). 
-00025140: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00025150: 7420 7265 7370 2e64 6973 706c 6179 6e61  t resp.displayna
-00025160: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
-00025170: 2020 2020 6469 7370 6c61 796e 616d 6520      displayname 
-00025180: 3d20 2222 2020 2320 6d65 616e 7320 6e6f  = ""  # means no
-00025190: 2064 6973 706c 6179 206e 616d 6520 6973   display name is
-000251a0: 2073 6574 0a20 2020 2020 2020 2020 2020   set.           
-000251b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000251c0: 2020 2020 2020 2064 6973 706c 6179 6e61         displayna
-000251d0: 6d65 203d 2072 6573 702e 6469 7370 6c61  me = resp.displa
-000251e0: 796e 616d 650a 2020 2020 2020 2020 2020  yname.          
-000251f0: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
-00025200: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
-00025210: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
-00025220: 2020 2020 2020 2020 2020 2074 6578 7420             text 
-00025230: 3d20 6622 7b75 7365 727d 7b53 4550 7d7b  = f"{user}{SEP}{
-00025240: 6469 7370 6c61 796e 616d 657d 220a 2020  displayname}".  
-00025250: 2020 2020 2020 2020 2020 2320 4f62 6a65            # Obje
-00025260: 6374 206f 6620 7479 7065 2052 6f6f 6d43  ct of type RoomC
-00025270: 7265 6174 6552 6573 706f 6e73 6520 6973  reateResponse is
-00025280: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
-00025290: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
-000252a0: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
-000252b0: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
-000252c0: 792e 0a20 2020 2020 2020 2020 2020 206a  y..            j
-000252d0: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
-000252e0: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
-000252f0: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
-00025300: 6174 6528 7b22 7573 6572 223a 2075 7365  ate({"user": use
-00025310: 727d 2920 2023 2061 6464 2064 6963 7420  r})  # add dict 
-00025320: 6974 656d 730a 2020 2020 2020 2020 2020  items.          
-00025330: 2020 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d    json_ = json_m
-00025340: 6178 2e63 6f70 7928 290a 2020 2020 2020  ax.copy().      
-00025350: 2020 2020 2020 6a73 6f6e 5f2e 706f 7028        json_.pop(
-00025360: 2274 7261 6e73 706f 7274 5f72 6573 706f  "transport_respo
-00025370: 6e73 6522 290a 2020 2020 2020 2020 2020  nse").          
-00025380: 2020 6a73 6f6e 5f73 7065 6320 3d20 4e6f    json_spec = No
-00025390: 6e65 0a20 2020 2020 2020 2020 2020 2070  ne.            p
-000253a0: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
-000253b0: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-000253c0: 7061 2e6f 7574 7075 742c 0a20 2020 2020  pa.output,.     
-000253d0: 2020 2020 2020 2020 2020 2074 6578 743d             text=
-000253e0: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
-000253f0: 2020 2020 2020 6a73 6f6e 5f3d 6a73 6f6e        json_=json
-00025400: 5f2c 0a20 2020 2020 2020 2020 2020 2020  _,.             
-00025410: 2020 206a 736f 6e5f 6d61 783d 6a73 6f6e     json_max=json
-00025420: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
-00025430: 2020 2020 2020 6a73 6f6e 5f73 7065 633d        json_spec=
-00025440: 6a73 6f6e 5f73 7065 632c 0a20 2020 2020  json_spec,.     
-00025450: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
-00025460: 2064 6566 2061 6374 696f 6e5f 7365 745f   def action_set_
-00025470: 7072 6573 656e 6365 2863 6c69 656e 743a  presence(client:
-00025480: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
-00025490: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
-000254a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
-000254b0: 2253 6574 2074 6865 206c 6f67 6765 6420  "Set the logged 
-000254c0: 696e 2075 7365 7227 7320 7072 6573 656e  in user's presen
-000254d0: 6365 2e20 4368 616e 6765 206d 7920 6f77  ce. Change my ow
-000254e0: 6e20 7072 6573 656e 6365 2e0a 2020 2020  n presence..    
-000254f0: 4173 7375 6d65 7320 7468 6174 2075 7365  Assumes that use
-00025500: 7220 6973 2061 6c72 6561 6479 206c 6f67  r is already log
-00025510: 6765 6420 696e 2e0a 2020 2020 2222 220a  ged in..    """.
-00025520: 2020 2020 7374 6174 6520 3d20 6773 2e70      state = gs.p
-00025530: 612e 7365 745f 7072 6573 656e 6365 2e73  a.set_presence.s
-00025540: 7472 6970 2829 2e6c 6f77 6572 2829 0a20  trip().lower(). 
-00025550: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00025560: 6622 5365 7474 696e 6720 7072 6573 656e  f"Setting presen
-00025570: 6365 2074 6f20 7b73 7461 7465 7d20 5b7b  ce to {state} [{
-00025580: 6773 2e70 612e 7365 745f 7072 6573 656e  gs.pa.set_presen
-00025590: 6365 7d5d 2e22 290a 2020 2020 7265 7370  ce}].").    resp
-000255a0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-000255b0: 7365 745f 7072 6573 656e 6365 2873 7461  set_presence(sta
-000255c0: 7465 290a 2020 2020 6966 2069 7369 6e73  te).    if isins
-000255d0: 7461 6e63 6528 7265 7370 2c20 5072 6573  tance(resp, Pres
-000255e0: 656e 6365 5365 7445 7272 6f72 293a 0a20  enceSetError):. 
-000255f0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-00025600: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00025610: 2022 4531 3730 3a20 2220 6622 7365 745f   "E170: " f"set_
-00025620: 7072 6573 656e 6365 2066 6169 6c65 6420  presence failed 
-00025630: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
-00025640: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-00025650: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00025660: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-00025670: 202b 3d20 310a 2020 2020 656c 7365 3a0a   += 1.    else:.
-00025680: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00025690: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-000256a0: 2020 6622 7365 745f 7072 6573 656e 6365    f"set_presence
-000256b0: 2073 7563 6365 7373 6675 6c20 7769 7468   successful with
-000256c0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
-000256d0: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
-000256e0: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
-000256f0: 6465 6620 6163 7469 6f6e 5f67 6574 5f70  def action_get_p
-00025700: 7265 7365 6e63 6528 636c 6965 6e74 3a20  resence(client: 
-00025710: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
-00025720: 6465 6e74 6961 6c73 3a20 6469 6374 2920  dentials: dict) 
-00025730: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
-00025740: 4765 7420 7072 6573 656e 6365 2873 2920  Get presence(s) 
-00025750: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
-00025760: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
-00025770: 6966 206e 6f74 2067 732e 7061 2e75 7365  if not gs.pa.use
-00025780: 723a 0a20 2020 2020 2020 2023 2067 6574  r:.        # get
-00025790: 2070 7265 7365 6e63 6520 6e61 6d65 206f   presence name o
-000257a0: 6620 6d79 7365 6c66 0a20 2020 2020 2020  f myself.       
-000257b0: 2077 686f 616d 6920 3d20 6372 6564 656e   whoami = creden
-000257c0: 7469 616c 735b 2275 7365 725f 6964 225d  tials["user_id"]
-000257d0: 0a20 2020 2020 2020 2075 7365 7273 203d  .        users =
-000257e0: 205b 7768 6f61 6d69 5d0a 2020 2020 656c   [whoami].    el
-000257f0: 7365 3a0a 2020 2020 2020 2020 7573 6572  se:.        user
-00025800: 7320 3d20 6773 2e70 612e 7573 6572 0a20  s = gs.pa.user. 
-00025810: 2020 2075 7365 7273 203d 206c 6973 7428     users = list(
-00025820: 6469 6374 2e66 726f 6d6b 6579 7328 7573  dict.fromkeys(us
-00025830: 6572 7329 2920 2023 2072 656d 6f76 6520  ers))  # remove 
-00025840: 6475 706c 6963 6174 6573 2069 6e20 6c69  duplicates in li
-00025850: 7374 0a20 2020 2066 6f72 2075 7365 7220  st.    for user 
-00025860: 696e 2075 7365 7273 3a0a 2020 2020 2020  in users:.      
-00025870: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00025880: 6c69 656e 742e 6765 745f 7072 6573 656e  lient.get_presen
-00025890: 6365 2875 7365 7229 0a20 2020 2020 2020  ce(user).       
-000258a0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-000258b0: 6573 702c 2050 7265 7365 6e63 6547 6574  esp, PresenceGet
-000258c0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-000258d0: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-000258e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000258f0: 2020 2245 3137 313a 2022 0a20 2020 2020    "E171: ".     
-00025900: 2020 2020 2020 2020 2020 2066 2267 6574             f"get
-00025910: 5f70 7265 7365 6e63 6520 6661 696c 6564  _presence failed
-00025920: 2077 6974 6820 7b70 7269 7661 6379 5f66   with {privacy_f
-00025930: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-00025940: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00025950: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00025960: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
-00025970: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00025980: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00025990: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-000259a0: 2020 2020 2020 2066 2267 6574 5f70 7265         f"get_pre
-000259b0: 7365 6e63 6520 7375 6363 6573 7366 756c  sence successful
-000259c0: 2077 6974 6820 7b70 7269 7661 6379 5f66   with {privacy_f
-000259d0: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-000259e0: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-000259f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00025a00: 6e6f 7420 7265 7370 2e6c 6173 745f 6163  not resp.last_ac
-00025a10: 7469 7665 5f61 676f 3a0a 2020 2020 2020  tive_ago:.      
-00025a20: 2020 2020 2020 2020 2020 6c61 7374 5f61            last_a
-00025a30: 6374 6976 655f 6167 6f20 3d20 3020 2023  ctive_ago = 0  #
-00025a40: 206d 6561 6e73 2063 7572 7265 6e74 6c79   means currently
-00025a50: 5f61 6374 6976 6520 6973 206e 6f74 2073  _active is not s
-00025a60: 6574 0a20 2020 2020 2020 2020 2020 2065  et.            e
-00025a70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00025a80: 2020 2020 206c 6173 745f 6163 7469 7665       last_active
-00025a90: 5f61 676f 203d 2072 6573 702e 6c61 7374  _ago = resp.last
-00025aa0: 5f61 6374 6976 655f 6167 6f0a 2020 2020  _active_ago.    
-00025ab0: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
-00025ac0: 6573 702e 6375 7272 656e 746c 795f 6163  esp.currently_ac
-00025ad0: 7469 7665 3a0a 2020 2020 2020 2020 2020  tive:.          
-00025ae0: 2020 2020 2020 6375 7272 656e 746c 795f        currently_
-00025af0: 6163 7469 7665 203d 2046 616c 7365 2020  active = False  
-00025b00: 2320 6d65 616e 7320 6375 7272 656e 746c  # means currentl
-00025b10: 795f 6163 7469 7665 2069 7320 6e6f 7420  y_active is not 
-00025b20: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
-00025b30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00025b40: 2020 2020 2020 6375 7272 656e 746c 795f        currently_
-00025b50: 6163 7469 7665 203d 2072 6573 702e 6375  active = resp.cu
-00025b60: 7272 656e 746c 795f 6163 7469 7665 0a20  rrently_active. 
-00025b70: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00025b80: 7420 7265 7370 2e73 7461 7475 735f 6d73  t resp.status_ms
-00025b90: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-00025ba0: 2020 2073 7461 7475 735f 6d73 6720 3d20     status_msg = 
-00025bb0: 2222 2020 2320 6d65 616e 7320 6e6f 2073  ""  # means no s
-00025bc0: 7461 7475 735f 6d73 6720 6973 2073 6574  tatus_msg is set
-00025bd0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00025be0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00025bf0: 2020 2073 7461 7475 735f 6d73 6720 3d20     status_msg = 
-00025c00: 7265 7370 2e73 7461 7475 735f 6d73 670a  resp.status_msg.
-00025c10: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
-00025c20: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
-00025c30: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
-00025c40: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
-00025c50: 2020 2020 2074 6578 7420 3d20 280a 2020       text = (.  
-00025c60: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00025c70: 7b72 6573 702e 7573 6572 5f69 647d 7b53  {resp.user_id}{S
-00025c80: 4550 7d7b 7265 7370 2e70 7265 7365 6e63  EP}{resp.presenc
-00025c90: 657d 7b53 4550 7d7b 6c61 7374 5f61 6374  e}{SEP}{last_act
-00025ca0: 6976 655f 6167 6f7d 220a 2020 2020 2020  ive_ago}".      
-00025cb0: 2020 2020 2020 2020 2020 6622 7b53 4550            f"{SEP
-00025cc0: 7d7b 6375 7272 656e 746c 795f 6163 7469  }{currently_acti
-00025cd0: 7665 7d7b 5345 507d 7b73 7461 7475 735f  ve}{SEP}{status_
-00025ce0: 6d73 677d 220a 2020 2020 2020 2020 2020  msg}".          
-00025cf0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00025d00: 2320 4f62 6a65 6374 206f 6620 7479 7065  # Object of type
-00025d10: 2078 7878 5265 7370 6f6e 7365 2069 7320   xxxResponse is 
-00025d20: 6e6f 7420 4a53 4f4e 0a20 2020 2020 2020  not JSON.       
-00025d30: 2020 2020 2023 2073 6572 6961 6c69 7a61       # serializa
-00025d40: 626c 652c 2068 656e 6365 2077 6520 7573  ble, hence we us
-00025d50: 6520 7468 6520 6469 6374 696f 6e61 7279  e the dictionary
-00025d60: 2e0a 2020 2020 2020 2020 2020 2020 6a73  ..            js
-00025d70: 6f6e 5f6d 6178 203d 2072 6573 702e 5f5f  on_max = resp.__
-00025d80: 6469 6374 5f5f 0a20 2020 2020 2020 2020  dict__.         
-00025d90: 2020 2023 206a 736f 6e5f 6d61 782e 7570     # json_max.up
-00025da0: 6461 7465 287b 226b 6579 223a 2076 616c  date({"key": val
-00025db0: 7565 7d29 2020 2320 6164 6420 6469 6374  ue})  # add dict
-00025dc0: 2069 7465 6d73 0a20 2020 2020 2020 2020   items.         
-00025dd0: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
-00025de0: 6d61 782e 636f 7079 2829 0a20 2020 2020  max.copy().     
-00025df0: 2020 2020 2020 206a 736f 6e5f 2e70 6f70         json_.pop
-00025e00: 2822 7472 616e 7370 6f72 745f 7265 7370  ("transport_resp
-00025e10: 6f6e 7365 2229 0a20 2020 2020 2020 2020  onse").         
-00025e20: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
-00025e30: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00025e40: 7072 696e 745f 6f75 7470 7574 280a 2020  print_output(.  
-00025e50: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-00025e60: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
-00025e70: 2020 2020 2020 2020 2020 2020 7465 7874              text
-00025e80: 3d74 6578 742c 0a20 2020 2020 2020 2020  =text,.         
-00025e90: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
-00025ea0: 6e5f 2c0a 2020 2020 2020 2020 2020 2020  n_,.            
-00025eb0: 2020 2020 6a73 6f6e 5f6d 6178 3d6a 736f      json_max=jso
-00025ec0: 6e5f 6d61 782c 0a20 2020 2020 2020 2020  n_max,.         
-00025ed0: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
-00025ee0: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
-00025ef0: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
-00025f00: 6320 6465 6620 6163 7469 6f6e 5f75 706c  c def action_upl
-00025f10: 6f61 6428 636c 6965 6e74 3a20 4173 796e  oad(client: Asyn
-00025f20: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
-00025f30: 6961 6c73 3a20 6469 6374 2920 2d3e 204e  ials: dict) -> N
-00025f40: 6f6e 653a 0a20 2020 2022 2222 5570 6c6f  one:.    """Uplo
-00025f50: 6164 206f 6e65 206f 7220 6d6f 7265 2066  ad one or more f
-00025f60: 696c 6573 2074 6f20 636f 6e74 656e 7420  iles to content 
-00025f70: 7265 706f 7369 746f 7279 206f 6620 4d61  repository of Ma
-00025f80: 7472 6978 2073 6572 7665 722e 0a20 2020  trix server..   
-00025f90: 2041 7373 756d 6573 2074 6861 7420 7573   Assumes that us
-00025fa0: 6572 2069 7320 616c 7265 6164 7920 6c6f  er is already lo
-00025fb0: 6767 6564 2069 6e2e 0a20 2020 2022 2222  gged in..    """
-00025fc0: 0a20 2020 2066 6f72 2066 696c 656e 616d  .    for filenam
-00025fd0: 6520 696e 2067 732e 7061 2e75 706c 6f61  e in gs.pa.uploa
-00025fe0: 643a 0a20 2020 2020 2020 2066 696c 656e  d:.        filen
-00025ff0: 616d 6520 3d20 6669 6c65 6e61 6d65 2e73  ame = filename.s
-00026000: 7472 6970 2829 0a20 2020 2020 2020 2065  trip().        e
-00026010: 6e63 7279 7074 203d 2046 616c 7365 2069  ncrypt = False i
-00026020: 6620 6773 2e70 612e 706c 6169 6e20 656c  f gs.pa.plain el
-00026030: 7365 2054 7275 650a 2020 2020 2020 2020  se True.        
-00026040: 6d69 6d65 5f74 7970 6520 3d20 6d61 6769  mime_type = magi
-00026050: 632e 6672 6f6d 5f66 696c 6528 6669 6c65  c.from_file(file
-00026060: 6e61 6d65 2c20 6d69 6d65 3d54 7275 6529  name, mime=True)
-00026070: 0a20 2020 2020 2020 2066 696c 655f 7374  .        file_st
-00026080: 6174 203d 2061 7761 6974 2061 696f 6669  at = await aiofi
-00026090: 6c65 732e 6f73 2e73 7461 7428 6669 6c65  les.os.stat(file
-000260a0: 6e61 6d65 290a 2020 2020 2020 2020 6173  name).        as
-000260b0: 796e 6320 7769 7468 2061 696f 6669 6c65  ync with aiofile
-000260c0: 732e 6f70 656e 2866 696c 656e 616d 652c  s.open(filename,
-000260d0: 2022 722b 6222 2920 6173 2066 3a0a 2020   "r+b") as f:.  
-000260e0: 2020 2020 2020 2020 2020 7265 7370 2c20            resp, 
-000260f0: 6465 6372 7970 7469 6f6e 5f64 6963 7420  decryption_dict 
-00026100: 3d20 6177 6169 7420 636c 6965 6e74 2e75  = await client.u
-00026110: 706c 6f61 6428 0a20 2020 2020 2020 2020  pload(.         
-00026120: 2020 2020 2020 2066 2c0a 2020 2020 2020         f,.      
-00026130: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
-00026140: 745f 7479 7065 3d6d 696d 655f 7479 7065  t_type=mime_type
-00026150: 2c20 2023 2065 2e67 2e20 6170 706c 6963  ,  # e.g. applic
-00026160: 6174 696f 6e2f 7064 660a 2020 2020 2020  ation/pdf.      
-00026170: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-00026180: 6d65 3d6f 732e 7061 7468 2e62 6173 656e  me=os.path.basen
-00026190: 616d 6528 6669 6c65 6e61 6d65 292c 0a20  ame(filename),. 
-000261a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000261b0: 6e63 7279 7074 3d65 6e63 7279 7074 2c0a  ncrypt=encrypt,.
-000261c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000261d0: 6669 6c65 7369 7a65 3d66 696c 655f 7374  filesize=file_st
-000261e0: 6174 2e73 745f 7369 7a65 2c0a 2020 2020  at.st_size,.    
-000261f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00026200: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00026210: 7265 7370 2c20 5570 6c6f 6164 4572 726f  resp, UploadErro
-00026220: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00026230: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-00026240: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00026250: 3137 323a 2022 0a20 2020 2020 2020 2020  172: ".         
-00026260: 2020 2020 2020 2022 4661 696c 6564 2074         "Failed t
-00026270: 6f20 7570 6c6f 6164 2e20 220a 2020 2020  o upload. ".    
-00026280: 2020 2020 2020 2020 2020 2020 6627 6669              f'fi
-00026290: 6c65 3d22 7b66 696c 656e 616d 657d 223b  le="{filename}";
-000262a0: 206d 696d 655f 7479 7065 3d22 7b6d 696d   mime_type="{mim
-000262b0: 655f 7479 7065 7d22 3b20 270a 2020 2020  e_type}"; '.    
-000262c0: 2020 2020 2020 2020 2020 2020 6622 6669              f"fi
-000262d0: 6c65 7373 697a 653d 7b66 696c 655f 7374  lessize={file_st
-000262e0: 6174 2e73 745f 7369 7a65 7d3b 2065 6e63  at.st_size}; enc
-000262f0: 7279 7074 3d7b 656e 6372 7970 747d 220a  rypt={encrypt}".
-00026300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026310: 6622 5365 7276 6572 2072 6573 706f 6e73  f"Server respons
-00026320: 653a 207b 7072 6976 6163 795f 6669 6c74  e: {privacy_filt
-00026330: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-00026340: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00026350: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
-00026360: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-00026370: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00026380: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00026390: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-000263a0: 2020 2020 6622 4669 6c65 207b 6669 6c65      f"File {file
-000263b0: 6e61 6d65 7d2c 206d 696d 653d 7b6d 696d  name}, mime={mim
-000263c0: 655f 7479 7065 7d2c 2022 0a20 2020 2020  e_type}, ".     
-000263d0: 2020 2020 2020 2020 2020 2066 227b 6669             f"{fi
-000263e0: 6c65 5f73 7461 742e 7374 5f73 697a 657d  le_stat.st_size}
-000263f0: 2062 7974 6573 2c20 656e 6372 7970 743d   bytes, encrypt=
-00026400: 7b65 6e63 7279 7074 7d20 220a 2020 2020  {encrypt} ".    
-00026410: 2020 2020 2020 2020 2020 2020 2277 6173              "was
-00026420: 2073 7563 6365 7373 6675 6c6c 7920 7570   successfully up
-00026430: 6c6f 6164 6564 2074 6f20 7365 7276 6572  loaded to server
-00026440: 2e20 5265 7370 6f6e 7365 2069 733a 2022  . Response is: "
-00026450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026460: 2066 227b 7072 6976 6163 795f 6669 6c74   f"{privacy_filt
-00026470: 6572 2873 7472 2872 6573 7029 297d 2e22  er(str(resp))}."
-00026480: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00026490: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-000264a0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-000264b0: 2020 2020 2020 2020 2066 2255 5249 206f           f"URI o
-000264c0: 6620 7570 6c6f 6164 6564 2066 696c 6520  f uploaded file 
-000264d0: 7b66 696c 656e 616d 657d 2069 733a 207b  {filename} is: {
-000264e0: 7265 7370 2e63 6f6e 7465 6e74 5f75 7269  resp.content_uri
-000264f0: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00026500: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00026510: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00026520: 2020 2020 2020 2020 2020 2066 2244 6563             f"Dec
-00026530: 7279 7074 696f 6e20 6b65 7920 2864 6963  ryption key (dic
-00026540: 7469 6f6e 6172 7929 206f 6620 7570 6c6f  tionary) of uplo
-00026550: 6164 6564 2066 696c 6520 7b66 696c 656e  aded file {filen
-00026560: 616d 657d 2069 733a 2022 0a20 2020 2020  ame} is: ".     
-00026570: 2020 2020 2020 2020 2020 2022 272a 2a2a             "'***
-00026580: 2068 6964 6465 6e20 746f 2070 7265 7665   hidden to preve
-00026590: 6e74 206c 6561 6b73 2722 2020 2320 6622  nt leaks'"  # f"
-000265a0: 7b64 6563 7279 7074 696f 6e5f 6469 6374  {decryption_dict
-000265b0: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-000265c0: 0a20 2020 2020 2020 2020 2020 2023 2064  .            # d
-000265d0: 6563 7279 7074 696f 6e5f 6469 6374 2077  ecryption_dict w
-000265e0: 696c 6c20 6265 204e 6f6e 6520 696e 2063  ill be None in c
-000265f0: 6173 6520 6f66 2070 6c61 696e 2d74 6578  ase of plain-tex
-00026600: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-00026610: 7468 6520 5552 4920 616e 6420 6b65 7973  the URI and keys
-00026620: 2077 696c 6c20 6265 206e 6565 6465 6420   will be needed 
-00026630: 6c61 7465 722e 2053 6f20 7468 6973 2070  later. So this p
-00026640: 7269 6e74 2069 7320 6120 6d75 7374 0a20  rint is a must. 
-00026650: 2020 2020 2020 2020 2020 2023 206f 7574             # out
-00026660: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-00026670: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-00026680: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-00026690: 2020 2020 7465 7874 203d 2066 227b 7265      text = f"{re
-000266a0: 7370 2e63 6f6e 7465 6e74 5f75 7269 7d7b  sp.content_uri}{
-000266b0: 5345 507d 7b64 6563 7279 7074 696f 6e5f  SEP}{decryption_
-000266c0: 6469 6374 7d22 0a20 2020 2020 2020 2020  dict}".         
-000266d0: 2020 2023 204f 626a 6563 7420 6f66 2074     # Object of t
-000266e0: 7970 6520 7878 7852 6573 706f 6e73 6520  ype xxxResponse 
-000266f0: 6973 206e 6f74 204a 534f 4e0a 2020 2020  is not JSON.    
-00026700: 2020 2020 2020 2020 2320 7365 7269 616c          # serial
-00026710: 697a 6162 6c65 2c20 6865 6e63 6520 7765  izable, hence we
-00026720: 2075 7365 2074 6865 2064 6963 7469 6f6e   use the diction
-00026730: 6172 792e 0a20 2020 2020 2020 2020 2020  ary..           
-00026740: 206a 736f 6e5f 6d61 7820 3d20 7265 7370   json_max = resp
-00026750: 2e5f 5f64 6963 745f 5f0a 2020 2020 2020  .__dict__.      
-00026760: 2020 2020 2020 6a73 6f6e 5f6d 6178 2e75        json_max.u
-00026770: 7064 6174 6528 0a20 2020 2020 2020 2020  pdate(.         
-00026780: 2020 2020 2020 207b 2264 6563 7279 7074         {"decrypt
-00026790: 696f 6e5f 6469 6374 223a 2064 6563 7279  ion_dict": decry
-000267a0: 7074 696f 6e5f 6469 6374 7d0a 2020 2020  ption_dict}.    
-000267b0: 2020 2020 2020 2020 2920 2023 2061 6464          )  # add
-000267c0: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
-000267d0: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
-000267e0: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
-000267f0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00026800: 5f2e 706f 7028 2274 7261 6e73 706f 7274  _.pop("transport
-00026810: 5f72 6573 706f 6e73 6522 290a 2020 2020  _response").    
-00026820: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00026830: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
-00026840: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
-00026850: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00026860: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
-00026870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026880: 2074 6578 743d 7465 7874 2c0a 2020 2020   text=text,.    
-00026890: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-000268a0: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
-000268b0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-000268c0: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
-000268d0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-000268e0: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
-000268f0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00026900: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
-00026910: 6e5f 6465 6c65 7465 5f6d 7863 2863 6c69  n_delete_mxc(cli
-00026920: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-00026930: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
-00026940: 6963 7429 202d 3e20 4e6f 6e65 3a0a 2020  ict) -> None:.  
-00026950: 2020 2222 2244 656c 6574 6520 6f6e 6520    """Delete one 
-00026960: 6f72 206d 6f72 6520 6669 6c65 7320 6672  or more files fr
-00026970: 6f6d 2063 6f6e 7465 6e74 2072 6570 6f73  om content repos
-00026980: 6974 6f72 7920 6f66 204d 6174 7269 7820  itory of Matrix 
-00026990: 7365 7276 6572 2e0a 2020 2020 4173 7375  server..    Assu
-000269a0: 6d65 7320 7468 6174 2075 7365 7220 6973  mes that user is
-000269b0: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
-000269c0: 696e 2e0a 2020 2020 2222 220a 2020 2020  in..    """.    
-000269d0: 2320 7365 653a 2068 7474 7073 3a2f 2f64  # see: https://d
-000269e0: 6f63 732e 6169 6f68 7474 702e 6f72 672f  ocs.aiohttp.org/
-000269f0: 656e 2f73 7461 626c 652f 636c 6965 6e74  en/stable/client
-00026a00: 5f71 7569 636b 7374 6172 742e 6874 6d6c  _quickstart.html
-00026a10: 0a20 2020 2023 2077 6520 6d75 7374 2065  .    # we must e
-00026a20: 6d75 6c61 7465 2061 2063 7572 6c20 6c69  mulate a curl li
-00026a30: 6b65 2074 6869 733a 0a20 2020 2023 2063  ke this:.    # c
-00026a40: 7572 6c20 2d58 4445 4c45 5445 2020 2268  url -XDELETE  "h
-00026a50: 7474 7073 3a2f 2f53 4552 5645 5248 4552  ttps://SERVERHER
-00026a60: 452f 5f73 796e 6170 7365 2f61 646d 696e  E/_synapse/admin
-00026a70: 2f76 312f 6d65 6469 612f 5345 5256 4552  /v1/media/SERVER
-00026a80: 4845 5245 2f0a 2020 2020 2320 2020 2020  HERE/.    #     
-00026a90: 204d 5843 4944 4845 5245 3f61 6363 6573   MXCIDHERE?acces
-00026aa0: 735f 746f 6b65 6e3d 4143 4345 5353 5f54  s_token=ACCESS_T
-00026ab0: 4f4b 454e 5f48 4552 4522 0a20 2020 2066  OKEN_HERE".    f
-00026ac0: 6f72 206d 7863 2069 6e20 6773 2e70 612e  or mxc in gs.pa.
-00026ad0: 6465 6c65 7465 5f6d 7863 3a0a 2020 2020  delete_mxc:.    
-00026ae0: 2020 2020 6d78 6320 3d20 6d78 632e 7374      mxc = mxc.st
-00026af0: 7269 7028 290a 2020 2020 2020 2020 6773  rip().        gs
-00026b00: 2e6c 6f67 2e64 6562 7567 2866 2250 7265  .log.debug(f"Pre
-00026b10: 7061 7269 6e67 2074 6f20 6465 6c65 7465  paring to delete
-00026b20: 204d 5843 207b 6d78 637d 2e22 290a 2020   MXC {mxc}.").  
-00026b30: 2020 2020 2020 2320 7765 2061 6c6c 6f77        # we allow
-00026b40: 206d 7863 2074 6f20 6265 2061 2920 6d78   mxc to be a) mx
-00026b50: 633a 2f2f 7365 7276 6572 2f6d 7863 2d69  c://server/mxc-i
-00026b60: 6420 6f72 206a 7573 7420 6d78 632d 6964  d or just mxc-id
-00026b70: 0a20 2020 2020 2020 2069 6620 7572 6c70  .        if urlp
-00026b80: 6172 7365 286d 7863 292e 7363 6865 6d65  arse(mxc).scheme
-00026b90: 203d 3d20 226d 7863 223a 0a20 2020 2020   == "mxc":.     
-00026ba0: 2020 2020 2020 206d 7863 203d 2075 726c         mxc = url
-00026bb0: 7061 7273 6528 6d78 6329 2e70 6174 682e  parse(mxc).path.
-00026bc0: 7265 706c 6163 6528 222f 222c 2022 2229  replace("/", "")
-00026bd0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00026be0: 6465 6275 6728 6622 5072 6570 6172 696e  debug(f"Preparin
-00026bf0: 6720 746f 2064 656c 6574 6520 4d58 4320  g to delete MXC 
-00026c00: 4944 207b 6d78 637d 2e22 290a 2020 2020  ID {mxc}.").    
-00026c10: 2020 2020 6966 2067 732e 7061 2e61 6363      if gs.pa.acc
-00026c20: 6573 735f 746f 6b65 6e3a 0a20 2020 2020  ess_token:.     
-00026c30: 2020 2020 2020 2061 7420 3d20 6773 2e70         at = gs.p
-00026c40: 612e 6163 6365 7373 5f74 6f6b 656e 0a20  a.access_token. 
-00026c50: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00026c60: 672e 6465 6275 6728 2255 7369 6e67 2061  g.debug("Using a
-00026c70: 6363 6573 7320 746f 6b65 6e20 6672 6f6d  ccess token from
-00026c80: 202d 2d61 6363 6573 732d 746f 6b65 6e20   --access-token 
-00026c90: 6172 6775 6d65 6e74 2e22 290a 2020 2020  argument.").    
-00026ca0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00026cb0: 2020 2020 2020 6174 203d 2063 7265 6465        at = crede
-00026cc0: 6e74 6961 6c73 5b22 6163 6365 7373 5f74  ntials["access_t
-00026cd0: 6f6b 656e 225d 0a20 2020 2020 2020 2020  oken"].         
-00026ce0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00026cf0: 2255 7369 6e67 2061 6363 6573 7320 746f  "Using access to
-00026d00: 6b65 6e20 6672 6f6d 2063 7265 6465 6e74  ken from credent
-00026d10: 6961 6c73 2066 696c 652e 2229 0a20 2020  ials file.").   
-00026d20: 2020 2020 2073 7276 5f66 756c 6c20 3d20       srv_full = 
-00026d30: 6372 6564 656e 7469 616c 735b 2268 6f6d  credentials["hom
-00026d40: 6573 6572 7665 7222 5d20 2023 2068 7474  eserver"]  # htt
-00026d50: 7073 3a2f 2f65 7861 6d70 6c65 2e6d 6174  ps://example.mat
-00026d60: 7269 782e 6f72 670a 2020 2020 2020 2020  rix.org.        
-00026d70: 7372 765f 686f 7374 203d 2075 726c 7061  srv_host = urlpa
-00026d80: 7273 6528 7372 765f 6675 6c6c 292e 686f  rse(srv_full).ho
-00026d90: 7374 6e61 6d65 2020 2320 6578 616d 706c  stname  # exampl
-00026da0: 652e 6d61 7472 6978 2e6f 7267 0a20 2020  e.matrix.org.   
-00026db0: 2020 2020 2072 6573 7420 3d20 280a 2020       rest = (.  
-00026dc0: 2020 2020 2020 2020 2020 7372 765f 6675            srv_fu
-00026dd0: 6c6c 0a20 2020 2020 2020 2020 2020 202b  ll.            +
-00026de0: 2022 2f5f 7379 6e61 7073 652f 6164 6d69   "/_synapse/admi
-00026df0: 6e2f 7631 2f6d 6564 6961 2f22 0a20 2020  n/v1/media/".   
-00026e00: 2020 2020 2020 2020 202b 2073 7276 5f68           + srv_h
-00026e10: 6f73 740a 2020 2020 2020 2020 2020 2020  ost.            
-00026e20: 2b20 222f 220a 2020 2020 2020 2020 2020  + "/".          
-00026e30: 2020 2b20 6d78 630a 2020 2020 2020 2020    + mxc.        
-00026e40: 2020 2020 2b20 223f 6163 6365 7373 5f74      + "?access_t
-00026e50: 6f6b 656e 3d22 0a20 2020 2020 2020 2020  oken=".         
-00026e60: 2020 202b 2061 740a 2020 2020 2020 2020     + at.        
-00026e70: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
-00026e80: 2e64 6562 7567 2866 2249 7373 7569 6e67  .debug(f"Issuing
-00026e90: 2052 4553 5420 4d61 7472 6978 2041 5049   REST Matrix API
-00026ea0: 2063 616c 6c3a 2044 454c 4554 4520 7b72   call: DELETE {r
-00026eb0: 6573 747d 2229 0a20 2020 2020 2020 2063  est}").        c
-00026ec0: 6f6e 6e65 6374 6f72 203d 2054 4350 436f  onnector = TCPCo
-00026ed0: 6e6e 6563 746f 7228 7373 6c3d 6773 2e73  nnector(ssl=gs.s
-00026ee0: 736c 2920 2023 2073 6574 7469 6e67 2073  sl)  # setting s
-00026ef0: 736c 636f 6e74 6578 740a 2020 2020 2020  slcontext.      
-00026f00: 2020 6173 796e 6320 7769 7468 2043 6c69    async with Cli
-00026f10: 656e 7453 6573 7369 6f6e 2863 6f6e 6e65  entSession(conne
-00026f20: 6374 6f72 3d63 6f6e 6e65 6374 6f72 2920  ctor=connector) 
-00026f30: 6173 2073 6573 7369 6f6e 3a20 2023 2061  as session:  # a
-00026f40: 696f 6874 7470 0a20 2020 2020 2020 2020  iohttp.         
-00026f50: 2020 2061 7379 6e63 2077 6974 6820 7365     async with se
-00026f60: 7373 696f 6e2e 6465 6c65 7465 2872 6573  ssion.delete(res
-00026f70: 7429 2061 7320 7265 7370 3a0a 2020 2020  t) as resp:.    
-00026f80: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-00026f90: 7573 203d 2072 6573 702e 7374 6174 7573  us = resp.status
-00026fa0: 2020 2320 696e 742c 2032 3030 2073 7563    # int, 200 suc
-00026fb0: 6365 7373 0a20 2020 2020 2020 2020 2020  cess.           
-00026fc0: 2020 2020 2074 7874 203d 2061 7761 6974       txt = await
-00026fd0: 2072 6573 702e 7465 7874 2829 2020 2320   resp.text()  # 
-00026fe0: 7374 7220 696e 2064 6963 7420 666f 726d  str in dict form
-00026ff0: 6174 0a20 2020 2020 2020 2069 6620 7374  at.        if st
-00027000: 6174 7573 2021 3d20 3230 303a 0a20 2020  atus != 200:.   
-00027010: 2020 2020 2020 2020 2023 2074 7874 2069           # txt i
-00027020: 7320 7374 7220 6c69 6b65 2074 6869 733a  s str like this:
-00027030: 0a20 2020 2020 2020 2020 2020 2023 207b  .            # {
-00027040: 2265 7272 636f 6465 223a 224d 5f46 4f52  "errcode":"M_FOR
-00027050: 4249 4444 454e 222c 2265 7272 6f72 223a  BIDDEN","error":
-00027060: 2259 6f75 2061 7265 206e 6f74 2061 2073  "You are not a s
-00027070: 6572 7665 7220 6164 6d69 6e22 7d0a 2020  erver admin"}.  
-00027080: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00027090: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-000270a0: 2020 2020 2020 2020 2245 3137 333a 2022          "E173: "
-000270b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000270c0: 2066 2246 6169 6c65 6420 746f 2064 656c   f"Failed to del
-000270d0: 6574 6520 6f62 6a65 6374 2028 6d78 6329  ete object (mxc)
-000270e0: 2027 7b6d 7863 7d27 2066 726f 6d20 7365   '{mxc}' from se
-000270f0: 7276 6572 2022 0a20 2020 2020 2020 2020  rver ".         
-00027100: 2020 2020 2020 2066 2227 7b73 7276 5f66         f"'{srv_f
-00027110: 756c 6c7d 272e 2046 6169 6c65 6420 7769  ull}'. Failed wi
-00027120: 7468 2065 7272 6f72 2063 6f64 6520 7b73  th error code {s
-00027130: 7461 7475 737d 2061 6e64 2022 0a20 2020  tatus} and ".   
-00027140: 2020 2020 2020 2020 2020 2020 2066 2265               f"e
-00027150: 7272 6f72 2074 6578 7420 7b74 7874 7d2e  rror text {txt}.
-00027160: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00027170: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-00027180: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-00027190: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000271a0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-000271b0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-000271c0: 2020 2020 2020 6622 4d58 4320 6f62 6a65        f"MXC obje
-000271d0: 6374 207b 6d78 637d 2077 6173 2073 7563  ct {mxc} was suc
-000271e0: 6365 7373 6675 6c6c 7920 6465 6c65 7465  cessfully delete
-000271f0: 6420 6672 6f6d 2073 6572 7665 7220 220a  d from server ".
-00027200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027210: 6622 7b73 7276 5f66 756c 6c7d 2e20 5265  f"{srv_full}. Re
-00027220: 7370 6f6e 7365 2069 733a 207b 7478 747d  sponse is: {txt}
-00027230: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-00027240: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
-00027250: 696f 6e5f 6465 6c65 7465 5f6d 7863 5f62  ion_delete_mxc_b
-00027260: 6566 6f72 6528 0a20 2020 2063 6c69 656e  efore(.    clien
-00027270: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-00027280: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-00027290: 740a 2920 2d3e 204e 6f6e 653a 0a20 2020  t.) -> None:.   
-000272a0: 2022 2222 4465 6c65 7465 2066 696c 6573   """Delete files
-000272b0: 206f 6c64 6572 2061 6e64 206c 6172 6765   older and large
-000272c0: 7220 6672 6f6d 2063 6f6e 7465 6e74 2072  r from content r
-000272d0: 6570 6f73 6974 6f72 7920 6f66 204d 6174  epository of Mat
-000272e0: 7269 7820 7365 7276 6572 2e0a 2020 2020  rix server..    
-000272f0: 4173 7375 6d65 7320 7468 6174 2075 7365  Assumes that use
-00027300: 7220 6973 2061 6c72 6561 6479 206c 6f67  r is already log
-00027310: 6765 6420 696e 2e0a 2020 2020 2222 220a  ged in..    """.
-00027320: 2020 2020 2320 6874 7470 733a 2f2f 6d61      # https://ma
-00027330: 7472 6978 2d6f 7267 2e67 6974 6875 622e  trix-org.github.
-00027340: 696f 2f73 796e 6170 7365 2f6c 6174 6573  io/synapse/lates
-00027350: 742f 6164 6d69 6e5f 6170 692f 0a20 2020  t/admin_api/.   
-00027360: 2023 2020 206d 6564 6961 5f61 646d 696e   #   media_admin
-00027370: 5f61 7069 2e68 746d 6c23 6465 6c65 7465  _api.html#delete
-00027380: 2d6c 6f63 616c 2d6d 6564 6961 2d62 792d  -local-media-by-
-00027390: 6461 7465 2d6f 722d 7369 7a65 0a20 2020  date-or-size.   
-000273a0: 2023 2050 4f53 5420 2f5f 7379 6e61 7073   # POST /_synaps
-000273b0: 652f 6164 6d69 6e2f 7631 2f6d 6564 6961  e/admin/v1/media
-000273c0: 2f3c 7365 7276 6572 5f6e 616d 653e 2f64  /<server_name>/d
-000273d0: 656c 6574 653f 6265 666f 7265 5f74 733d  elete?before_ts=
-000273e0: 3c62 6566 6f72 655f 7473 3e0a 2020 2020  <before_ts>.    
-000273f0: 2320 2673 697a 655f 6774 3d3c 7369 7a65  # &size_gt=<size
-00027400: 3e0a 2020 2020 6966 206c 656e 2867 732e  >.    if len(gs.
-00027410: 7061 2e64 656c 6574 655f 6d78 635f 6265  pa.delete_mxc_be
-00027420: 666f 7265 2920 3e20 323a 0a20 2020 2020  fore) > 2:.     
-00027430: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-00027440: 0a20 2020 2020 2020 2020 2020 2022 4531  .            "E1
-00027450: 3734 3a20 220a 2020 2020 2020 2020 2020  74: ".          
-00027460: 2020 2249 6e63 6f72 7265 6374 206e 756d    "Incorrect num
-00027470: 6265 7220 6f66 2061 7267 756d 656e 7473  ber of arguments
-00027480: 2066 6f72 202d 2d64 656c 6574 655f 6d78   for --delete_mx
-00027490: 635f 6265 666f 7265 2e20 220a 2020 2020  c_before. ".    
-000274a0: 2020 2020 2020 2020 2254 6865 7265 206d          "There m
-000274b0: 7573 7420 6265 2031 206f 7220 3220 6172  ust be 1 or 2 ar
-000274c0: 6775 6d65 6e74 7320 2c20 6275 7420 666f  guments , but fo
-000274d0: 756e 6420 220a 2020 2020 2020 2020 2020  und ".          
-000274e0: 2020 6622 7b6c 656e 2867 732e 7061 2e64    f"{len(gs.pa.d
-000274f0: 656c 6574 655f 6d78 635f 6265 666f 7265  elete_mxc_before
-00027500: 297d 2061 7267 756d 656e 7473 2e22 0a20  )} arguments.". 
-00027510: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00027520: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-00027530: 2031 0a20 2020 2020 2020 2072 6574 7572   1.        retur
-00027540: 6e0a 2020 2020 7369 7a65 203d 2030 0a20  n.    size = 0. 
-00027550: 2020 2069 6620 6c65 6e28 6773 2e70 612e     if len(gs.pa.
-00027560: 6465 6c65 7465 5f6d 7863 5f62 6566 6f72  delete_mxc_befor
-00027570: 6529 203d 3d20 323a 0a20 2020 2020 2020  e) == 2:.       
-00027580: 2073 697a 6520 3d20 6773 2e70 612e 6465   size = gs.pa.de
-00027590: 6c65 7465 5f6d 7863 5f62 6566 6f72 655b  lete_mxc_before[
-000275a0: 315d 0a20 2020 2062 6566 6f72 655f 7374  1].    before_st
-000275b0: 7220 3d20 6773 2e70 612e 6465 6c65 7465  r = gs.pa.delete
-000275c0: 5f6d 7863 5f62 6566 6f72 655b 305d 0a20  _mxc_before[0]. 
-000275d0: 2020 206d 696c 6c69 7365 6320 3d20 696e     millisec = in
-000275e0: 7428 0a20 2020 2020 2020 2064 6174 6574  t(.        datet
-000275f0: 696d 652e 6461 7465 7469 6d65 2e73 7472  ime.datetime.str
-00027600: 7074 696d 6528 6265 666f 7265 5f73 7472  ptime(before_str
-00027610: 2c20 2225 642e 256d 2e25 5920 2548 3a25  , "%d.%m.%Y %H:%
-00027620: 4d3a 2553 2229 2e74 696d 6573 7461 6d70  M:%S").timestamp
-00027630: 2829 0a20 2020 2020 2020 202a 2031 3030  ().        * 100
-00027640: 300a 2020 2020 290a 0a20 2020 2067 732e  0.    )..    gs.
-00027650: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00027660: 2020 2066 2250 7265 7061 7269 6e67 2074     f"Preparing t
-00027670: 6f20 6465 6c65 7465 206f 626a 6563 7473  o delete objects
-00027680: 206f 6c64 6572 2074 6861 6e20 7b62 6566   older than {bef
-00027690: 6f72 655f 7374 727d 2022 0a20 2020 2020  ore_str} ".     
-000276a0: 2020 2066 2228 556e 6978 2074 696d 6520     f"(Unix time 
-000276b0: 7b6d 696c 6c69 7365 637d 2920 616e 6420  {millisec}) and 
-000276c0: 6c61 7267 6572 2074 6861 6e20 7b73 697a  larger than {siz
-000276d0: 657d 2e22 0a20 2020 2029 0a20 2020 2069  e}.".    ).    i
-000276e0: 6620 6773 2e70 612e 6163 6365 7373 5f74  f gs.pa.access_t
-000276f0: 6f6b 656e 3a0a 2020 2020 2020 2020 6174  oken:.        at
-00027700: 203d 2067 732e 7061 2e61 6363 6573 735f   = gs.pa.access_
-00027710: 746f 6b65 6e0a 2020 2020 2020 2020 6773  token.        gs
-00027720: 2e6c 6f67 2e64 6562 7567 2822 5573 696e  .log.debug("Usin
-00027730: 6720 6163 6365 7373 2074 6f6b 656e 2066  g access token f
-00027740: 726f 6d20 2d2d 6163 6365 7373 2d74 6f6b  rom --access-tok
-00027750: 656e 2061 7267 756d 656e 742e 2229 0a20  en argument."). 
-00027760: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00027770: 2061 7420 3d20 6372 6564 656e 7469 616c   at = credential
-00027780: 735b 2261 6363 6573 735f 746f 6b65 6e22  s["access_token"
-00027790: 5d0a 2020 2020 2020 2020 6773 2e6c 6f67  ].        gs.log
-000277a0: 2e64 6562 7567 2822 5573 696e 6720 6163  .debug("Using ac
-000277b0: 6365 7373 2074 6f6b 656e 2066 726f 6d20  cess token from 
-000277c0: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
-000277d0: 2e22 290a 2020 2020 7372 765f 6675 6c6c  .").    srv_full
-000277e0: 203d 2063 7265 6465 6e74 6961 6c73 5b22   = credentials["
-000277f0: 686f 6d65 7365 7276 6572 225d 2020 2320  homeserver"]  # 
-00027800: 6874 7470 733a 2f2f 6578 616d 706c 652e  https://example.
-00027810: 6d61 7472 6978 2e6f 7267 0a20 2020 2073  matrix.org.    s
-00027820: 7276 5f68 6f73 7420 3d20 7572 6c70 6172  rv_host = urlpar
-00027830: 7365 2873 7276 5f66 756c 6c29 2e68 6f73  se(srv_full).hos
-00027840: 746e 616d 6520 2023 2065 7861 6d70 6c65  tname  # example
-00027850: 2e6d 6174 7269 782e 6f72 670a 2020 2020  .matrix.org.    
-00027860: 7265 7374 203d 2028 0a20 2020 2020 2020  rest = (.       
-00027870: 2073 7276 5f66 756c 6c0a 2020 2020 2020   srv_full.      
-00027880: 2020 2b20 222f 5f73 796e 6170 7365 2f61    + "/_synapse/a
-00027890: 646d 696e 2f76 312f 6d65 6469 612f 220a  dmin/v1/media/".
-000278a0: 2020 2020 2020 2020 2b20 7372 765f 686f          + srv_ho
-000278b0: 7374 0a20 2020 2020 2020 202b 2022 2f64  st.        + "/d
-000278c0: 656c 6574 653f 6265 666f 7265 5f74 733d  elete?before_ts=
-000278d0: 220a 2020 2020 2020 2020 2b20 7374 7228  ".        + str(
-000278e0: 6d69 6c6c 6973 6563 290a 2020 2020 2020  millisec).      
-000278f0: 2020 2b20 2226 7369 7a65 5f67 743d 220a    + "&size_gt=".
-00027900: 2020 2020 2020 2020 2b20 7374 7228 7369          + str(si
-00027910: 7a65 290a 2020 2020 2020 2020 2b20 2226  ze).        + "&
-00027920: 6163 6365 7373 5f74 6f6b 656e 3d22 0a20  access_token=". 
-00027930: 2020 2020 2020 202b 2061 740a 2020 2020         + at.    
-00027940: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
-00027950: 7567 2866 2249 7373 7569 6e67 2052 4553  ug(f"Issuing RES
-00027960: 5420 4d61 7472 6978 2041 5049 2063 616c  T Matrix API cal
-00027970: 6c3a 2050 4f53 5420 7b72 6573 747d 2229  l: POST {rest}")
-00027980: 0a20 2020 2063 6f6e 6e65 6374 6f72 203d  .    connector =
-00027990: 2054 4350 436f 6e6e 6563 746f 7228 7373   TCPConnector(ss
-000279a0: 6c3d 6773 2e73 736c 2920 2023 2073 6574  l=gs.ssl)  # set
-000279b0: 7469 6e67 2073 736c 636f 6e74 6578 740a  ting sslcontext.
-000279c0: 2020 2020 6173 796e 6320 7769 7468 2043      async with C
-000279d0: 6c69 656e 7453 6573 7369 6f6e 2863 6f6e  lientSession(con
-000279e0: 6e65 6374 6f72 3d63 6f6e 6e65 6374 6f72  nector=connector
-000279f0: 2920 6173 2073 6573 7369 6f6e 3a20 2023  ) as session:  #
-00027a00: 2061 696f 6874 7470 0a20 2020 2020 2020   aiohttp.       
-00027a10: 2061 7379 6e63 2077 6974 6820 7365 7373   async with sess
-00027a20: 696f 6e2e 706f 7374 2872 6573 7429 2061  ion.post(rest) a
-00027a30: 7320 7265 7370 3a0a 2020 2020 2020 2020  s resp:.        
-00027a40: 2020 2020 7374 6174 7573 203d 2072 6573      status = res
-00027a50: 702e 7374 6174 7573 2020 2320 696e 742c  p.status  # int,
-00027a60: 2032 3030 2073 7563 6365 7373 0a20 2020   200 success.   
-00027a70: 2020 2020 2020 2020 2074 7874 203d 2061           txt = a
-00027a80: 7761 6974 2072 6573 702e 7465 7874 2829  wait resp.text()
-00027a90: 2020 2320 7374 7220 696e 2064 6963 7420    # str in dict 
-00027aa0: 666f 726d 6174 0a20 2020 2069 6620 7374  format.    if st
-00027ab0: 6174 7573 2021 3d20 3230 303a 0a20 2020  atus != 200:.   
-00027ac0: 2020 2020 2023 2074 7874 2069 7320 7374       # txt is st
-00027ad0: 7220 6c69 6b65 2074 6869 733a 0a20 2020  r like this:.   
-00027ae0: 2020 2020 2023 207b 2265 7272 636f 6465       # {"errcode
-00027af0: 223a 224d 5f46 4f52 4249 4444 454e 222c  ":"M_FORBIDDEN",
-00027b00: 2265 7272 6f72 223a 2259 6f75 2061 7265  "error":"You are
-00027b10: 206e 6f74 2061 2073 6572 7665 7220 6164   not a server ad
-00027b20: 6d69 6e22 7d0a 2020 2020 2020 2020 6773  min"}.        gs
-00027b30: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-00027b40: 2020 2020 2020 2020 2245 3137 353a 2022          "E175: "
-00027b50: 0a20 2020 2020 2020 2020 2020 2066 2246  .            f"F
-00027b60: 6169 6c65 6420 746f 2064 656c 6574 6520  ailed to delete 
-00027b70: 6f62 6a65 6374 7320 6265 666f 7265 2027  objects before '
-00027b80: 7b62 6566 6f72 655f 7374 727d 2720 6672  {before_str}' fr
-00027b90: 6f6d 2073 6572 7665 7220 220a 2020 2020  om server ".    
-00027ba0: 2020 2020 2020 2020 6622 277b 7372 765f          f"'{srv_
-00027bb0: 6675 6c6c 7d27 2e20 4661 696c 6564 2077  full}'. Failed w
-00027bc0: 6974 6820 6572 726f 7220 636f 6465 207b  ith error code {
-00027bd0: 7374 6174 7573 7d20 616e 6420 220a 2020  status} and ".  
-00027be0: 2020 2020 2020 2020 2020 6622 6572 726f            f"erro
-00027bf0: 7220 7465 7874 207b 7478 747d 2e22 0a20  r text {txt}.". 
-00027c00: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00027c10: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-00027c20: 2031 0a20 2020 2065 6c73 653a 0a20 2020   1.    else:.   
-00027c30: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00027c40: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
-00027c50: 224f 626a 6563 7473 206f 6c64 6572 2074  "Objects older t
-00027c60: 6861 6e20 7b62 6566 6f72 655f 7374 727d  han {before_str}
-00027c70: 2061 6e64 206c 6172 6765 7220 7468 616e   and larger than
-00027c80: 207b 7369 7a65 7d20 220a 2020 2020 2020   {size} ".      
-00027c90: 2020 2020 2020 2277 6572 6520 7375 6363        "were succ
-00027ca0: 6573 7366 756c 6c79 2064 656c 6574 6564  essfully deleted
-00027cb0: 2066 726f 6d20 7365 7276 6572 2022 0a20   from server ". 
-00027cc0: 2020 2020 2020 2020 2020 2066 227b 7372             f"{sr
-00027cd0: 765f 6675 6c6c 7d2e 2052 6573 706f 6e73  v_full}. Respons
-00027ce0: 6520 6973 3a20 5c6e 7b74 7874 7d2e 220a  e is: \n{txt}.".
-00027cf0: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
-00027d00: 6320 6465 6620 6163 7469 6f6e 5f64 6f77  c def action_dow
-00027d10: 6e6c 6f61 6428 636c 6965 6e74 3a20 4173  nload(client: As
-00027d20: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
-00027d30: 6e74 6961 6c73 3a20 6469 6374 2920 2d3e  ntials: dict) ->
-00027d40: 204e 6f6e 653a 0a20 2020 2022 2222 446f   None:.    """Do
-00027d50: 776e 6c6f 6164 2061 2066 696c 6520 6672  wnload a file fr
-00027d60: 6f6d 2063 6f6e 7465 6e74 2072 6570 6f73  om content repos
-00027d70: 6974 6f72 7920 6f66 204d 6174 7269 7820  itory of Matrix 
-00027d80: 7365 7276 6572 2e0a 2020 2020 4173 7375  server..    Assu
-00027d90: 6d65 7320 7468 6174 2075 7365 7220 6973  mes that user is
-00027da0: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
-00027db0: 696e 2e0a 2020 2020 2222 220a 2020 2020  in..    """.    
-00027dc0: 6966 206e 6f74 2067 732e 7061 2e64 6f77  if not gs.pa.dow
-00027dd0: 6e6c 6f61 643a 0a20 2020 2020 2020 2067  nload:.        g
-00027de0: 732e 6c6f 672e 6465 6275 6728 2244 6f77  s.log.debug("Dow
-00027df0: 6e6c 6f61 6420 6c69 7374 2069 7320 656d  nload list is em
-00027e00: 7074 792e 204e 6f74 6869 6e67 2074 6f20  pty. Nothing to 
-00027e10: 646f 776e 6c6f 6164 2e20 536b 6970 7069  download. Skippi
-00027e20: 6e67 2e22 290a 2020 2020 2020 2020 7265  ng.").        re
-00027e30: 7475 726e 0a20 2020 2066 696c 656e 616d  turn.    filenam
-00027e40: 6573 203d 2067 732e 7061 2e66 696c 655f  es = gs.pa.file_
-00027e50: 6e61 6d65 0a20 2020 2069 6620 6669 6c65  name.    if file
-00027e60: 6e61 6d65 733a 0a20 2020 2020 2020 2077  names:.        w
-00027e70: 6869 6c65 206c 656e 2866 696c 656e 616d  hile len(filenam
-00027e80: 6573 2920 3c20 6c65 6e28 6773 2e70 612e  es) < len(gs.pa.
-00027e90: 646f 776e 6c6f 6164 293a 0a20 2020 2020  download):.     
-00027ea0: 2020 2020 2020 2066 696c 656e 616d 6573         filenames
-00027eb0: 2e61 7070 656e 6428 4e6f 6e65 290a 2020  .append(None).  
-00027ec0: 2020 6465 6372 7970 7469 6f6e 5f73 7472    decryption_str
-00027ed0: 696e 6773 203d 2067 732e 7061 2e6b 6579  ings = gs.pa.key
-00027ee0: 5f64 6963 740a 2020 2020 6966 2064 6563  _dict.    if dec
-00027ef0: 7279 7074 696f 6e5f 7374 7269 6e67 733a  ryption_strings:
-00027f00: 0a20 2020 2020 2020 2077 6869 6c65 206c  .        while l
-00027f10: 656e 2864 6563 7279 7074 696f 6e5f 7374  en(decryption_st
-00027f20: 7269 6e67 7329 203c 206c 656e 2867 732e  rings) < len(gs.
-00027f30: 7061 2e6b 6579 5f64 6963 7429 3a0a 2020  pa.key_dict):.  
-00027f40: 2020 2020 2020 2020 2020 6465 6372 7970            decryp
-00027f50: 7469 6f6e 5f73 7472 696e 6773 2e61 7070  tion_strings.app
-00027f60: 656e 6428 4e6f 6e65 290a 2020 2020 2320  end(None).    # 
-00027f70: 6669 6c65 6e61 6d65 7320 6973 206e 6f77  filenames is now
-00027f80: 204e 6f6e 6520 6f72 206c 6973 7420 6174   None or list at
-00027f90: 206c 6561 7374 2061 7320 6c6f 6e67 2061   least as long a
-00027fa0: 7320 646f 776e 6c6f 6164 730a 2020 2020  s downloads.    
-00027fb0: 2320 6465 6372 7970 7469 6f6e 5f73 7472  # decryption_str
-00027fc0: 696e 6773 2069 7320 6e6f 7720 4e6f 6e65  ings is now None
-00027fd0: 206f 7220 6c69 7374 2061 7420 6c65 6173   or list at leas
-00027fe0: 7420 6173 206c 6f6e 6720 6173 2064 6f77  t as long as dow
-00027ff0: 6e6c 6f61 6473 0a20 2020 2067 732e 6c6f  nloads.    gs.lo
-00028000: 672e 6465 6275 6728 6622 4669 6c65 206e  g.debug(f"File n
-00028010: 616d 6573 2070 726f 7669 6465 6420 696e  ames provided in
-00028020: 2061 7267 756d 656e 7473 3a20 7b66 696c   arguments: {fil
-00028030: 656e 616d 6573 7d22 290a 2020 2020 6773  enames}").    gs
-00028040: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-00028050: 2020 2020 2244 6563 7279 7074 696f 6e20      "Decryption 
-00028060: 7374 7269 6e67 7320 7072 6f76 6964 6564  strings provided
-00028070: 2069 6e20 6172 6775 6d65 6e74 733a 2022   in arguments: "
-00028080: 0a20 2020 2020 2020 2022 272a 2a2a 2068  .        "'*** h
-00028090: 6964 6465 6e20 746f 2070 7265 7665 6e74  idden to prevent
-000280a0: 206c 6561 6b73 2722 0a20 2020 2020 2020   leaks'".       
-000280b0: 2023 2066 227b 6465 6372 7970 7469 6f6e   # f"{decryption
-000280c0: 5f73 7472 696e 6773 7d22 0a20 2020 2029  _strings}".    )
-000280d0: 0a20 2020 2069 6920 3d20 300a 2020 2020  .    ii = 0.    
-000280e0: 666f 7220 646f 776e 6c6f 6164 2069 6e20  for download in 
-000280f0: 6773 2e70 612e 646f 776e 6c6f 6164 3a0a  gs.pa.download:.
-00028100: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-00028110: 2e66 696c 655f 6e61 6d65 3a0a 2020 2020  .file_name:.    
-00028120: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-00028130: 203d 2066 696c 656e 616d 6573 5b69 695d   = filenames[ii]
-00028140: 2020 2320 3173 7420 6368 6f69 6365 0a20    # 1st choice. 
-00028150: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00028160: 2020 2020 2020 2020 2023 2032 6e64 2063           # 2nd c
-00028170: 686f 6963 653b 2067 6574 2066 696c 656e  hoice; get filen
-00028180: 616d 6520 6672 6f6d 2073 6572 7665 720a  ame from server.
-00028190: 2020 2020 2020 2020 2020 2020 2320 692e              # i.
-000281a0: 652e 2075 7365 2074 6865 206f 7269 6769  e. use the origi
-000281b0: 6e61 6c20 6669 6c65 6e61 6d65 2066 726f  nal filename fro
-000281c0: 6d20 7570 6c6f 6164 0a20 2020 2020 2020  m upload.       
-000281d0: 2020 2020 2066 696c 656e 616d 6520 3d20       filename = 
-000281e0: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
-000281f0: 6773 2e70 612e 6b65 795f 6469 6374 3a0a  gs.pa.key_dict:.
-00028200: 2020 2020 2020 2020 2020 2020 6465 6372              decr
-00028210: 7970 7469 6f6e 5f73 7472 203d 2064 6563  yption_str = dec
-00028220: 7279 7074 696f 6e5f 7374 7269 6e67 735b  ryption_strings[
-00028230: 6969 5d0a 2020 2020 2020 2020 656c 7365  ii].        else
-00028240: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-00028250: 6372 7970 7469 6f6e 5f73 7472 203d 204e  cryption_str = N
-00028260: 6f6e 650a 2020 2020 2020 2020 656e 6372  one.        encr
-00028270: 7970 7465 6420 3d20 5472 7565 2069 6620  ypted = True if 
-00028280: 6465 6372 7970 7469 6f6e 5f73 7472 2065  decryption_str e
-00028290: 6c73 6520 4661 6c73 650a 2020 2020 2020  lse False.      
-000282a0: 2020 6966 206e 6f74 2065 6e63 7279 7074    if not encrypt
-000282b0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-000282c0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-000282d0: 2020 2020 2020 2020 2020 2020 2020 224e                "N
-000282e0: 6f20 6b65 7920 6469 6374 696f 6e61 7279  o key dictionary
-000282f0: 2073 7065 6369 6669 6564 2077 6974 6820   specified with 
-00028300: 2d2d 6b65 792d 6469 6374 2e20 536f 2c20  --key-dict. So, 
-00028310: 6974 2069 7320 220a 2020 2020 2020 2020  it is ".        
-00028320: 2020 2020 2020 2020 2261 7373 756d 6564          "assumed
-00028330: 2074 6861 7420 7468 6520 646f 776e 6c6f   that the downlo
-00028340: 6164 2069 7320 6e6f 7420 656e 6372 7970  ad is not encryp
-00028350: 7465 6420 220a 2020 2020 2020 2020 2020  ted ".          
-00028360: 2020 2020 2020 2228 692e 652e 2070 6c61        "(i.e. pla
-00028370: 696e 2d74 6578 7429 2e20 4e6f 2064 6563  in-text). No dec
-00028380: 7279 7074 696f 6e20 7769 6c6c 2062 6520  ryption will be 
-00028390: 6174 7465 6d70 7465 642e 220a 2020 2020  attempted.".    
+00015630: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+00015640: 310a 2020 2020 2020 2020 2020 2020 656c  1.            el
+00015650: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00015660: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
+00015670: 6627 4c65 6674 2072 6f6f 6d20 227b 726f  f'Left room "{ro
+00015680: 6f6d 5f69 647d 222e 2729 0a20 2020 2065  om_id}".').    e
+00015690: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+000156a0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+000156b0: 6572 726f 7228 2245 3133 323a 2022 2022  error("E132: " "
+000156c0: 526f 6f6d 206c 6561 7665 2066 6169 6c65  Room leave faile
+000156d0: 642e 2053 6f72 7279 2e22 290a 2020 2020  d. Sorry.").    
+000156e0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+000156f0: 202b 3d20 310a 2020 2020 2020 2020 6773   += 1.        gs
+00015700: 2e6c 6f67 2e64 6562 7567 2822 4865 7265  .log.debug("Here
+00015710: 2069 7320 7468 6520 7472 6163 6562 6163   is the tracebac
+00015720: 6b2e 5c6e 2220 2b20 7472 6163 6562 6163  k.\n" + tracebac
+00015730: 6b2e 666f 726d 6174 5f65 7863 2829 290a  k.format_exc()).
+00015740: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
+00015750: 6f6e 5f72 6f6f 6d5f 666f 7267 6574 2863  on_room_forget(c
+00015760: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
+00015770: 6c73 293a 0a20 2020 2022 2222 466f 7267  ls):.    """Forg
+00015780: 6574 206f 6e65 206f 7220 6d75 6c74 6970  et one or multip
+00015790: 6c65 2072 6f6f 6d73 2e22 2222 0a20 2020  le rooms.""".   
+000157a0: 2072 6f6f 6d73 203d 2067 732e 7061 2e72   rooms = gs.pa.r
+000157b0: 6f6f 6d5f 666f 7267 6574 0a20 2020 2074  oom_forget.    t
+000157c0: 7279 3a0a 2020 2020 2020 2020 666f 7220  ry:.        for 
+000157d0: 726f 6f6d 5f69 6420 696e 2072 6f6f 6d73  room_id in rooms
+000157e0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000157f0: 726f 6f6d 5f69 6420 6361 6e20 6265 2023  room_id can be #
+00015800: 726f 6f6d 416c 6961 7320 6f72 2021 726f  roomAlias or !ro
+00015810: 6f6d 4964 0a20 2020 2020 2020 2020 2020  omId.           
+00015820: 2067 732e 6c6f 672e 6465 6275 6728 6627   gs.log.debug(f'
+00015830: 5072 6570 6172 696e 6720 746f 2066 6f72  Preparing to for
+00015840: 6765 7420 726f 6f6d 2022 7b72 6f6f 6d5f  get room "{room_
+00015850: 6964 7d22 2e27 290a 2020 2020 2020 2020  id}".').        
+00015860: 2020 2020 726f 6f6d 5f69 6420 3d20 6177      room_id = aw
+00015870: 6169 7420 6d61 705f 726f 6f6d 696e 666f  ait map_roominfo
+00015880: 5f74 6f5f 726f 6f6d 6964 2863 6c69 656e  _to_roomid(clien
+00015890: 742c 2072 6f6f 6d5f 6964 290a 2020 2020  t, room_id).    
+000158a0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000158b0: 6562 7567 2866 2746 6f72 6765 7474 696e  ebug(f'Forgettin
+000158c0: 6720 726f 6f6d 2022 7b72 6f6f 6d5f 6964  g room "{room_id
+000158d0: 7d22 2e27 290a 2020 2020 2020 2020 2020  }".').          
+000158e0: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
+000158f0: 6c69 656e 742e 726f 6f6d 5f66 6f72 6765  lient.room_forge
+00015900: 7428 726f 6f6d 5f69 6429 0a20 2020 2020  t(room_id).     
+00015910: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00015920: 616e 6365 2872 6573 702c 2052 6f6f 6d46  ance(resp, RoomF
+00015930: 6f72 6765 7445 7272 6f72 293a 0a20 2020  orgetError):.   
+00015940: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+00015950: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00015960: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00015970: 4531 3333 3a20 2220 6622 466f 7267 6574  E133: " f"Forget
+00015980: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
+00015990: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+000159a0: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+000159b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000159c0: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
+000159d0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+000159e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000159f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a00: 6773 2e6c 6f67 2e69 6e66 6f28 6627 466f  gs.log.info(f'Fo
+00015a10: 7267 6f74 2072 6f6f 6d20 227b 726f 6f6d  rgot room "{room
+00015a20: 5f69 647d 222e 2729 0a20 2020 2065 7863  _id}".').    exc
+00015a30: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+00015a40: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+00015a50: 726f 7228 2245 3133 343a 2022 2022 526f  ror("E134: " "Ro
+00015a60: 6f6d 2066 6f72 6765 7420 6661 696c 6564  om forget failed
+00015a70: 2e20 536f 7272 792e 2229 0a20 2020 2020  . Sorry.").     
+00015a80: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00015a90: 2248 6572 6520 6973 2074 6865 2074 7261  "Here is the tra
+00015aa0: 6365 6261 636b 2e5c 6e22 202b 2074 7261  ceback.\n" + tra
+00015ab0: 6365 6261 636b 2e66 6f72 6d61 745f 6578  ceback.format_ex
+00015ac0: 6328 2929 0a0a 0a61 7379 6e63 2064 6566  c())...async def
+00015ad0: 2061 6374 696f 6e5f 726f 6f6d 5f69 6e76   action_room_inv
+00015ae0: 6974 6528 636c 6965 6e74 2c20 6372 6564  ite(client, cred
+00015af0: 656e 7469 616c 7329 3a0a 2020 2020 2222  entials):.    ""
+00015b00: 2249 6e76 6974 6520 6f6e 6520 6f72 206d  "Invite one or m
+00015b10: 756c 7469 706c 6520 7573 6572 7320 746f  ultiple users to
+00015b20: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
+00015b30: 2072 6f6f 6d73 2e22 2222 0a20 2020 2072   rooms.""".    r
+00015b40: 6f6f 6d73 203d 2067 732e 7061 2e72 6f6f  ooms = gs.pa.roo
+00015b50: 6d5f 696e 7669 7465 0a20 2020 2075 7365  m_invite.    use
+00015b60: 7273 203d 2067 732e 7061 2e75 7365 720a  rs = gs.pa.user.
+00015b70: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00015b80: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
+00015b90: 726f 6f6d 733a 0a20 2020 2020 2020 2020  rooms:.         
+00015ba0: 2020 2023 2072 6f6f 6d5f 6964 2063 616e     # room_id can
+00015bb0: 2062 6520 2372 6f6f 6d41 6c69 6173 206f   be #roomAlias o
+00015bc0: 7220 2172 6f6f 6d49 640a 2020 2020 2020  r !roomId.      
+00015bd0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00015be0: 7567 2866 2750 7265 7061 7269 6e67 2074  ug(f'Preparing t
+00015bf0: 6f20 696e 7669 7465 2074 6f20 726f 6f6d  o invite to room
+00015c00: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 290a   "{room_id}".').
+00015c10: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+00015c20: 5f69 6420 3d20 6177 6169 7420 6d61 705f  _id = await map_
+00015c30: 726f 6f6d 696e 666f 5f74 6f5f 726f 6f6d  roominfo_to_room
+00015c40: 6964 2863 6c69 656e 742c 2072 6f6f 6d5f  id(client, room_
+00015c50: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
+00015c60: 6773 2e6c 6f67 2e64 6562 7567 2866 2749  gs.log.debug(f'I
+00015c70: 6e76 6974 696e 6720 746f 2072 6f6f 6d20  nviting to room 
+00015c80: 227b 726f 6f6d 5f69 647d 222e 2729 0a20  "{room_id}".'). 
+00015c90: 2020 2020 2020 2020 2020 2066 6f72 2075             for u
+00015ca0: 7365 7220 696e 2075 7365 7273 3a0a 2020  ser in users:.  
+00015cb0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00015cc0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+00015cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ce0: 6627 496e 7669 7469 6e67 2075 7365 7220  f'Inviting user 
+00015cf0: 227b 7573 6572 7d22 2074 6f20 726f 6f6d  "{user}" to room
+00015d00: 2077 6974 6820 270a 2020 2020 2020 2020   with '.        
+00015d10: 2020 2020 2020 2020 2020 2020 6627 726f              f'ro
+00015d20: 6f6d 2061 6c69 6173 2022 7b72 6f6f 6d5f  om alias "{room_
+00015d30: 6964 7d22 2e27 0a20 2020 2020 2020 2020  id}".'.         
+00015d40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00015d50: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00015d60: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
+00015d70: 6d5f 696e 7669 7465 2872 6f6f 6d5f 6964  m_invite(room_id
+00015d80: 2c20 7573 6572 290a 2020 2020 2020 2020  , user).        
+00015d90: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00015da0: 7461 6e63 6528 7265 7370 2c20 526f 6f6d  tance(resp, Room
+00015db0: 496e 7669 7465 4572 726f 7229 3a0a 2020  InviteError):.  
+00015dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015dd0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015df0: 2020 2020 2020 2020 2245 3133 353a 2022          "E135: "
+00015e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015e10: 2020 2020 2020 2020 2066 2272 6f6f 6d5f           f"room_
+00015e20: 696e 7669 7465 2066 6169 6c65 6420 7769  invite failed wi
+00015e30: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
+00015e40: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00015e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00015e70: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00015e80: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00015e90: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00015ea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015eb0: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+00015ec0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+00015ed0: 2020 2020 2020 2020 2020 2066 2755 7365             f'Use
+00015ee0: 7220 227b 7573 6572 7d22 2077 6173 2073  r "{user}" was s
+00015ef0: 7563 6365 7373 6675 6c6c 7920 696e 7669  uccessfully invi
+00015f00: 7465 6420 270a 2020 2020 2020 2020 2020  ted '.          
+00015f10: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00015f20: 746f 2072 6f6f 6d20 227b 726f 6f6d 5f69  to room "{room_i
+00015f30: 647d 222e 270a 2020 2020 2020 2020 2020  d}".'.          
+00015f40: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00015f50: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00015f60: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+00015f70: 2e65 7272 6f72 2822 4531 3336 3a20 2220  .error("E136: " 
+00015f80: 2255 7365 7220 696e 7669 7465 2066 6169  "User invite fai
+00015f90: 6c65 642e 2053 6f72 7279 2e22 290a 2020  led. Sorry.").  
+00015fa0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00015fb0: 7567 2822 4865 7265 2069 7320 7468 6520  ug("Here is the 
+00015fc0: 7472 6163 6562 6163 6b2e 5c6e 2220 2b20  traceback.\n" + 
+00015fd0: 7472 6163 6562 6163 6b2e 666f 726d 6174  traceback.format
+00015fe0: 5f65 7863 2829 290a 0a0a 6173 796e 6320  _exc())...async 
+00015ff0: 6465 6620 6163 7469 6f6e 5f72 6f6f 6d5f  def action_room_
+00016000: 6261 6e28 636c 6965 6e74 2c20 6372 6564  ban(client, cred
+00016010: 656e 7469 616c 7329 3a0a 2020 2020 2222  entials):.    ""
+00016020: 2242 616e 206f 6e65 206f 7220 6d75 6c74  "Ban one or mult
+00016030: 6970 6c65 2075 7365 7273 2066 726f 6d20  iple users from 
+00016040: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+00016050: 726f 6f6d 732e 2222 220a 2020 2020 726f  rooms.""".    ro
+00016060: 6f6d 7320 3d20 6773 2e70 612e 726f 6f6d  oms = gs.pa.room
+00016070: 5f62 616e 0a20 2020 2075 7365 7273 203d  _ban.    users =
+00016080: 2067 732e 7061 2e75 7365 720a 2020 2020   gs.pa.user.    
+00016090: 7472 793a 0a20 2020 2020 2020 2066 6f72  try:.        for
+000160a0: 2072 6f6f 6d5f 6964 2069 6e20 726f 6f6d   room_id in room
+000160b0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+000160c0: 2072 6f6f 6d5f 6964 2063 616e 2062 6520   room_id can be 
+000160d0: 2372 6f6f 6d41 6c69 6173 206f 7220 2172  #roomAlias or !r
+000160e0: 6f6f 6d49 640a 2020 2020 2020 2020 2020  oomId.          
+000160f0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+00016100: 2750 7265 7061 7269 6e67 2074 6f20 6261  'Preparing to ba
+00016110: 6e20 696e 2072 6f6f 6d20 227b 726f 6f6d  n in room "{room
+00016120: 5f69 647d 222e 2729 0a20 2020 2020 2020  _id}".').       
+00016130: 2020 2020 2072 6f6f 6d5f 6964 203d 2061       room_id = a
+00016140: 7761 6974 206d 6170 5f72 6f6f 6d69 6e66  wait map_roominf
+00016150: 6f5f 746f 5f72 6f6f 6d69 6428 636c 6965  o_to_roomid(clie
+00016160: 6e74 2c20 726f 6f6d 5f69 6429 0a20 2020  nt, room_id).   
+00016170: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00016180: 6465 6275 6728 6627 4261 6e6e 696e 6720  debug(f'Banning 
+00016190: 746f 2072 6f6f 6d20 227b 726f 6f6d 5f69  to room "{room_i
+000161a0: 647d 222e 2729 0a20 2020 2020 2020 2020  d}".').         
+000161b0: 2020 2066 6f72 2075 7365 7220 696e 2075     for user in u
+000161c0: 7365 7273 3a0a 2020 2020 2020 2020 2020  sers:.          
+000161d0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+000161e0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+000161f0: 2020 2020 2020 2020 6627 4261 6e6e 696e          f'Bannin
+00016200: 6720 7573 6572 2022 7b75 7365 727d 2220  g user "{user}" 
+00016210: 6672 6f6d 2072 6f6f 6d20 7769 7468 2027  from room with '
+00016220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016230: 2020 2020 2066 2772 6f6f 6d20 616c 6961       f'room alia
+00016240: 7320 227b 726f 6f6d 5f69 647d 222e 270a  s "{room_id}".'.
+00016250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016260: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016270: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
+00016280: 6c69 656e 742e 726f 6f6d 5f62 616e 2872  lient.room_ban(r
+00016290: 6f6f 6d5f 6964 2c20 7573 6572 290a 2020  oom_id, user).  
+000162a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000162b0: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+000162c0: 2c20 526f 6f6d 4261 6e45 7272 6f72 293a  , RoomBanError):
+000162d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000162e0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+000162f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00016300: 2020 2020 2020 2020 2020 2022 4531 3337             "E137
+00016310: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00016320: 2020 2020 2020 2020 2020 2020 6622 726f              f"ro
+00016330: 6f6d 5f62 616e 2066 6169 6c65 6420 7769  om_ban failed wi
+00016340: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
+00016350: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00016360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016370: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00016380: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00016390: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+000163a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000163b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000163c0: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+000163d0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+000163e0: 2020 2020 2020 2020 2020 2066 2755 7365             f'Use
+000163f0: 7220 227b 7573 6572 7d22 2077 6173 2073  r "{user}" was s
+00016400: 7563 6365 7373 6675 6c6c 7920 6261 6e6e  uccessfully bann
+00016410: 6564 2027 0a20 2020 2020 2020 2020 2020  ed '.           
+00016420: 2020 2020 2020 2020 2020 2020 2066 2766               f'f
+00016430: 726f 6d20 726f 6f6d 2022 7b72 6f6f 6d5f  rom room "{room_
+00016440: 6964 7d22 2e27 0a20 2020 2020 2020 2020  id}".'.         
+00016450: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00016460: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00016470: 6e3a 0a20 2020 2020 2020 2067 732e 6c6f  n:.        gs.lo
+00016480: 672e 6572 726f 7228 2245 3133 383a 2022  g.error("E138: "
+00016490: 2022 5573 6572 2062 616e 2066 6169 6c65   "User ban faile
+000164a0: 642e 2053 6f72 7279 2e22 290a 2020 2020  d. Sorry.").    
+000164b0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000164c0: 2822 4865 7265 2069 7320 7468 6520 7472  ("Here is the tr
+000164d0: 6163 6562 6163 6b2e 5c6e 2220 2b20 7472  aceback.\n" + tr
+000164e0: 6163 6562 6163 6b2e 666f 726d 6174 5f65  aceback.format_e
+000164f0: 7863 2829 290a 0a0a 6173 796e 6320 6465  xc())...async de
+00016500: 6620 6163 7469 6f6e 5f72 6f6f 6d5f 756e  f action_room_un
+00016510: 6261 6e28 636c 6965 6e74 2c20 6372 6564  ban(client, cred
+00016520: 656e 7469 616c 7329 3a0a 2020 2020 2222  entials):.    ""
+00016530: 2255 6e62 616e 206f 6e65 206f 7220 6d75  "Unban one or mu
+00016540: 6c74 6970 6c65 2075 7365 7273 2066 726f  ltiple users fro
+00016550: 6d20 6f6e 6520 6f72 206d 756c 7469 706c  m one or multipl
+00016560: 6520 726f 6f6d 732e 2222 220a 2020 2020  e rooms.""".    
+00016570: 726f 6f6d 7320 3d20 6773 2e70 612e 726f  rooms = gs.pa.ro
+00016580: 6f6d 5f75 6e62 616e 0a20 2020 2075 7365  om_unban.    use
+00016590: 7273 203d 2067 732e 7061 2e75 7365 720a  rs = gs.pa.user.
+000165a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000165b0: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
+000165c0: 726f 6f6d 733a 0a20 2020 2020 2020 2020  rooms:.         
+000165d0: 2020 2023 2072 6f6f 6d5f 6964 2063 616e     # room_id can
+000165e0: 2062 6520 2372 6f6f 6d41 6c69 6173 206f   be #roomAlias o
+000165f0: 7220 2172 6f6f 6d49 640a 2020 2020 2020  r !roomId.      
+00016600: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00016610: 7567 2866 2750 7265 7061 7269 6e67 2074  ug(f'Preparing t
+00016620: 6f20 756e 6261 6e20 696e 2072 6f6f 6d20  o unban in room 
+00016630: 227b 726f 6f6d 5f69 647d 222e 2729 0a20  "{room_id}".'). 
+00016640: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
+00016650: 6964 203d 2061 7761 6974 206d 6170 5f72  id = await map_r
+00016660: 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f 6d69  oominfo_to_roomi
+00016670: 6428 636c 6965 6e74 2c20 726f 6f6d 5f69  d(client, room_i
+00016680: 6429 0a20 2020 2020 2020 2020 2020 2067  d).            g
+00016690: 732e 6c6f 672e 6465 6275 6728 6627 556e  s.log.debug(f'Un
+000166a0: 6261 6e6e 696e 6720 746f 2072 6f6f 6d20  banning to room 
+000166b0: 227b 726f 6f6d 5f69 647d 222e 2729 0a20  "{room_id}".'). 
+000166c0: 2020 2020 2020 2020 2020 2066 6f72 2075             for u
+000166d0: 7365 7220 696e 2075 7365 7273 3a0a 2020  ser in users:.  
+000166e0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+000166f0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+00016700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016710: 6627 556e 6261 6e6e 696e 6720 7573 6572  f'Unbanning user
+00016720: 2022 7b75 7365 727d 2220 6672 6f6d 2072   "{user}" from r
+00016730: 6f6f 6d20 7769 7468 2027 0a20 2020 2020  oom with '.     
+00016740: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00016750: 2772 6f6f 6d20 616c 6961 7320 227b 726f  'room alias "{ro
+00016760: 6f6d 5f69 647d 222e 270a 2020 2020 2020  om_id}".'.      
+00016770: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016780: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00016790: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+000167a0: 726f 6f6d 5f75 6e62 616e 2872 6f6f 6d5f  room_unban(room_
+000167b0: 6964 2c20 7573 6572 290a 2020 2020 2020  id, user).      
+000167c0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+000167d0: 6e73 7461 6e63 6528 7265 7370 2c20 526f  nstance(resp, Ro
+000167e0: 6f6d 556e 6261 6e45 7272 6f72 293a 0a20  omUnbanError):. 
+000167f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016800: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00016810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016820: 2020 2020 2020 2020 2022 4531 3339 3a20           "E139: 
+00016830: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00016840: 2020 2020 2020 2020 2020 6622 726f 6f6d            f"room
+00016850: 5f75 6e62 616e 2066 6169 6c65 6420 7769  _unban failed wi
+00016860: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
+00016870: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00016880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016890: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000168a0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+000168b0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+000168c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000168d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000168e0: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+000168f0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+00016900: 2020 2020 2020 2020 2020 2066 2755 7365             f'Use
+00016910: 7220 227b 7573 6572 7d22 2077 6173 2073  r "{user}" was s
+00016920: 7563 6365 7373 6675 6c6c 7920 756e 6261  uccessfully unba
+00016930: 6e6e 6564 2027 0a20 2020 2020 2020 2020  nned '.         
+00016940: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00016950: 2766 726f 6d20 726f 6f6d 2022 7b72 6f6f  'from room "{roo
+00016960: 6d5f 6964 7d22 2e27 0a20 2020 2020 2020  m_id}".'.       
+00016970: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00016980: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00016990: 696f 6e3a 0a20 2020 2020 2020 2067 732e  ion:.        gs.
+000169a0: 6c6f 672e 6572 726f 7228 2245 3134 303a  log.error("E140:
+000169b0: 2022 2022 5573 6572 2075 6e62 616e 2066   " "User unban f
+000169c0: 6169 6c65 642e 2053 6f72 7279 2e22 290a  ailed. Sorry.").
+000169d0: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+000169e0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+000169f0: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+00016a00: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+00016a10: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+00016a20: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00016a30: 2829 290a 0a0a 6173 796e 6320 6465 6620  ())...async def 
+00016a40: 6163 7469 6f6e 5f72 6f6f 6d5f 6b69 636b  action_room_kick
+00016a50: 2863 6c69 656e 742c 2063 7265 6465 6e74  (client, credent
+00016a60: 6961 6c73 293a 0a20 2020 2022 2222 4b69  ials):.    """Ki
+00016a70: 636b 206f 6e65 206f 7220 6d75 6c74 6970  ck one or multip
+00016a80: 6c65 2075 7365 7273 2066 726f 6d20 6f6e  le users from on
+00016a90: 6520 6f72 206d 756c 7469 706c 6520 726f  e or multiple ro
+00016aa0: 6f6d 732e 2222 220a 2020 2020 726f 6f6d  oms.""".    room
+00016ab0: 7320 3d20 6773 2e70 612e 726f 6f6d 5f6b  s = gs.pa.room_k
+00016ac0: 6963 6b0a 2020 2020 7573 6572 7320 3d20  ick.    users = 
+00016ad0: 6773 2e70 612e 7573 6572 0a20 2020 2074  gs.pa.user.    t
+00016ae0: 7279 3a0a 2020 2020 2020 2020 666f 7220  ry:.        for 
+00016af0: 726f 6f6d 5f69 6420 696e 2072 6f6f 6d73  room_id in rooms
+00016b00: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00016b10: 726f 6f6d 5f69 6420 6361 6e20 6265 2023  room_id can be #
+00016b20: 726f 6f6d 416c 6961 7320 6f72 2021 726f  roomAlias or !ro
+00016b30: 6f6d 4964 0a20 2020 2020 2020 2020 2020  omId.           
+00016b40: 2067 732e 6c6f 672e 6465 6275 6728 6627   gs.log.debug(f'
+00016b50: 5072 6570 6172 696e 6720 746f 206b 6963  Preparing to kic
+00016b60: 6b69 6e67 206f 6666 2072 6f6f 6d20 227b  king off room "{
+00016b70: 726f 6f6d 5f69 647d 222e 2729 0a20 2020  room_id}".').   
+00016b80: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
+00016b90: 203d 2061 7761 6974 206d 6170 5f72 6f6f   = await map_roo
+00016ba0: 6d69 6e66 6f5f 746f 5f72 6f6f 6d69 6428  minfo_to_roomid(
+00016bb0: 636c 6965 6e74 2c20 726f 6f6d 5f69 6429  client, room_id)
+00016bc0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00016bd0: 6c6f 672e 6465 6275 6728 6627 4b69 636b  log.debug(f'Kick
+00016be0: 696e 6720 6f66 6620 726f 6f6d 2022 7b72  ing off room "{r
+00016bf0: 6f6f 6d5f 6964 7d22 2e27 290a 2020 2020  oom_id}".').    
+00016c00: 2020 2020 2020 2020 666f 7220 7573 6572          for user
+00016c10: 2069 6e20 7573 6572 733a 0a20 2020 2020   in users:.     
+00016c20: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00016c30: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00016c40: 2020 2020 2020 2020 2020 2020 2066 274b               f'K
+00016c50: 6963 6b69 6e67 2075 7365 7220 227b 7573  icking user "{us
+00016c60: 6572 7d22 2066 726f 6d20 726f 6f6d 2077  er}" from room w
+00016c70: 6974 6820 270a 2020 2020 2020 2020 2020  ith '.          
+00016c80: 2020 2020 2020 2020 2020 6627 726f 6f6d            f'room
+00016c90: 2061 6c69 6173 2022 7b72 6f6f 6d5f 6964   alias "{room_id
+00016ca0: 7d22 2e27 0a20 2020 2020 2020 2020 2020  }".'.           
+00016cb0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00016cc0: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
+00016cd0: 6169 7420 636c 6965 6e74 2e72 6f6f 6d5f  ait client.room_
+00016ce0: 6b69 636b 2872 6f6f 6d5f 6964 2c20 7573  kick(room_id, us
+00016cf0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00016d00: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00016d10: 6528 7265 7370 2c20 526f 6f6d 4b69 636b  e(resp, RoomKick
+00016d20: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00016d30: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00016d40: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00016d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d60: 2020 2245 3134 313a 2022 0a20 2020 2020    "E141: ".     
+00016d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d80: 2020 2066 2272 6f6f 6d5f 6b69 636b 2066     f"room_kick f
+00016d90: 6169 6c65 6420 7769 7468 207b 7072 6976  ailed with {priv
+00016da0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+00016db0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+00016dc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00016dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016de0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00016df0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00016e00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00016e10: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00016e20: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
+00016e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e40: 2020 2066 2755 7365 7220 227b 7573 6572     f'User "{user
+00016e50: 7d22 2077 6173 2073 7563 6365 7373 6675  }" was successfu
+00016e60: 6c6c 7920 6b69 636b 6564 2027 0a20 2020  lly kicked '.   
+00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e80: 2020 2020 2066 2766 726f 6d20 726f 6f6d       f'from room
+00016e90: 2022 7b72 6f6f 6d5f 6964 7d22 2e27 0a20   "{room_id}".'. 
+00016ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016eb0: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
+00016ec0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+00016ed0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00016ee0: 2245 3134 323a 2022 2022 5573 6572 206b  "E142: " "User k
+00016ef0: 6963 6b20 6661 696c 6564 2e20 536f 7272  ick failed. Sorr
+00016f00: 792e 2229 0a20 2020 2020 2020 2067 732e  y.").        gs.
+00016f10: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+00016f20: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00016f30: 6275 6728 2248 6572 6520 6973 2074 6865  bug("Here is the
+00016f40: 2074 7261 6365 6261 636b 2e5c 6e22 202b   traceback.\n" +
+00016f50: 2074 7261 6365 6261 636b 2e66 6f72 6d61   traceback.forma
+00016f60: 745f 6578 6328 2929 0a0a 0a23 2061 6363  t_exc())...# acc
+00016f70: 6f72 6469 6e67 2074 6f20 6c69 6e74 6572  ording to linter
+00016f80: 3a20 6675 6e63 7469 6f6e 2069 7320 746f  : function is to
+00016f90: 6f20 636f 6d70 6c65 782c 2043 3930 310a  o complex, C901.
+00016fa0: 6173 796e 6320 6465 6620 7365 6e64 5f65  async def send_e
+00016fb0: 7665 6e74 2863 6c69 656e 742c 2072 6f6f  vent(client, roo
+00016fc0: 6d73 2c20 6576 656e 7429 3a20 2023 206e  ms, event):  # n
+00016fd0: 6f71 613a 2043 3930 310a 2020 2020 2222  oqa: C901.    ""
+00016fe0: 2250 726f 6365 7373 2065 7665 6e74 2e0a  "Process event..
+00016ff0: 0a20 2020 2041 7267 756d 656e 7473 3a0a  .    Arguments:.
+00017000: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020      ---------.  
+00017010: 2020 636c 6965 6e74 203a 2043 6c69 656e    client : Clien
+00017020: 740a 2020 2020 726f 6f6d 7320 3a20 6c69  t.    rooms : li
+00017030: 7374 0a20 2020 2020 2020 206c 6973 7420  st.        list 
+00017040: 6f66 2072 6f6f 6d5f 6964 2d73 0a20 2020  of room_id-s.   
+00017050: 2065 7665 6e74 203a 2073 7472 0a20 2020   event : str.   
+00017060: 2020 2020 2066 696c 6520 6e61 6d65 206f       file name o
+00017070: 6620 6576 656e 7420 6672 6f6d 202d 2d65  f event from --e
+00017080: 7665 6e74 2061 7267 756d 656e 740a 0a20  vent argument.. 
+00017090: 2020 2022 2222 0a20 2020 2069 6620 6e6f     """.    if no
+000170a0: 7420 726f 6f6d 733a 0a20 2020 2020 2020  t rooms:.       
+000170b0: 2067 732e 6c6f 672e 696e 666f 280a 2020   gs.log.info(.  
+000170c0: 2020 2020 2020 2020 2020 224e 6f20 726f            "No ro
+000170d0: 6f6d 7320 6172 6520 6769 7665 6e2e 2054  oms are given. T
+000170e0: 6869 7320 7368 6f75 6c64 206e 6f74 2068  his should not h
+000170f0: 6170 7065 6e2e 2022 0a20 2020 2020 2020  appen. ".       
+00017100: 2020 2020 2022 4d61 7962 6520 796f 7572       "Maybe your
+00017110: 2044 4d20 726f 6f6d 7320 7370 6563 6966   DM rooms specif
+00017120: 6965 6420 7669 6120 2d2d 7573 6572 2077  ied via --user w
+00017130: 6572 6520 6e6f 7420 666f 756e 642e 2022  ere not found. "
+00017140: 0a20 2020 2020 2020 2020 2020 2022 5468  .            "Th
+00017150: 6973 2066 696c 6520 6973 2062 6569 6e67  is file is being
+00017160: 2064 726f 7070 6564 2061 6e64 204e 4f54   dropped and NOT
+00017170: 2073 656e 742e 220a 2020 2020 2020 2020   sent.".        
+00017180: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00017190: 0a0a 2020 2020 6966 2065 7665 6e74 203d  ..    if event =
+000171a0: 3d20 222d 223a 2020 2320 2d20 6d65 616e  = "-":  # - mean
+000171b0: 7320 7265 6164 2061 7320 7069 7065 2066  s read as pipe f
+000171c0: 726f 6d20 7374 6469 6e0a 2020 2020 2020  rom stdin.      
+000171d0: 2020 6a73 6f6e 6461 7461 203d 2073 7973    jsondata = sys
+000171e0: 2e73 7464 696e 2e62 7566 6665 722e 7265  .stdin.buffer.re
+000171f0: 6164 2829 2e64 6563 6f64 6528 2920 2023  ad().decode()  #
+00017200: 2062 696e 6172 7920 7265 6164 0a20 2020   binary read.   
+00017210: 2065 6c73 653a 0a20 2020 2020 2020 2077   else:.        w
+00017220: 6974 6820 6f70 656e 2865 7665 6e74 2c20  ith open(event, 
+00017230: 2272 2229 2061 7320 6669 6c65 3a0a 2020  "r") as file:.  
+00017240: 2020 2020 2020 2020 2020 6a73 6f6e 6461            jsonda
+00017250: 7461 203d 2066 696c 652e 7265 6164 2829  ta = file.read()
+00017260: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
+00017270: 6728 0a20 2020 2020 2020 2066 227b 6c65  g(.        f"{le
+00017280: 6e28 6a73 6f6e 6461 7461 297d 2062 7974  n(jsondata)} byt
+00017290: 6573 206f 6620 6576 656e 7420 6461 7461  es of event data
+000172a0: 2072 6561 6420 6672 6f6d 2066 696c 6520   read from file 
+000172b0: 7b65 7665 6e74 7d2e 220a 2020 2020 290a  {event}.".    ).
+000172c0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000172d0: 2866 2245 7665 6e74 207b 6576 656e 747d  (f"Event {event}
+000172e0: 2063 6f6e 7461 696e 7320 7468 6973 204a   contains this J
+000172f0: 534f 4e20 6461 7461 3a20 7b6a 736f 6e64  SON data: {jsond
+00017300: 6174 617d 2229 0a0a 2020 2020 6966 206e  ata}")..    if n
+00017310: 6f74 206a 736f 6e64 6174 612e 7374 7269  ot jsondata.stri
+00017320: 7028 293a 0a20 2020 2020 2020 2067 732e  p():.        gs.
+00017330: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+00017340: 2020 2020 2020 2022 4576 656e 7420 6973         "Event is
+00017350: 2065 6d70 7479 2e20 5468 6973 2065 7665   empty. This eve
+00017360: 6e74 2069 7320 6265 696e 6720 6472 6f70  nt is being drop
+00017370: 7065 6420 616e 6420 4e4f 5420 7365 6e74  ped and NOT sent
+00017380: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+00017390: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+000173a0: 2074 7279 3a0a 2020 2020 2020 2020 636f   try:.        co
+000173b0: 6e74 656e 745f 6a73 6f6e 203d 206a 736f  ntent_json = jso
+000173c0: 6e2e 6c6f 6164 7328 6a73 6f6e 6461 7461  n.loads(jsondata
+000173d0: 290a 2020 2020 2020 2020 6d65 7373 6167  ).        messag
+000173e0: 655f 7479 7065 203d 2063 6f6e 7465 6e74  e_type = content
+000173f0: 5f6a 736f 6e5b 2274 7970 6522 5d0a 2020  _json["type"].  
+00017400: 2020 2020 2020 636f 6e74 656e 7420 3d20        content = 
+00017410: 636f 6e74 656e 745f 6a73 6f6e 5b22 636f  content_json["co
+00017420: 6e74 656e 7422 5d0a 2020 2020 6578 6365  ntent"].    exce
+00017430: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+00017440: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+00017450: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00017460: 2245 3134 333a 2022 0a20 2020 2020 2020  "E143: ".       
+00017470: 2020 2020 2022 4576 656e 7420 6973 206e       "Event is n
+00017480: 6f74 2061 2076 616c 6964 204a 534f 4e20  ot a valid JSON 
+00017490: 6f62 6a65 6374 206f 7220 6e6f 7420 6f66  object or not of
+000174a0: 204d 6174 7269 7820 4a53 4f4e 2066 6f72   Matrix JSON for
+000174b0: 6d61 742e 2022 0a20 2020 2020 2020 2020  mat. ".         
+000174c0: 2020 2022 5468 6973 2065 7665 6e74 2069     "This event i
+000174d0: 7320 6265 696e 6720 6472 6f70 7065 6420  s being dropped 
+000174e0: 616e 6420 4e4f 5420 7365 6e74 2e22 0a20  and NOT sent.". 
+000174f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00017500: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00017510: 2031 0a20 2020 2020 2020 2067 732e 6c6f   1.        gs.lo
+00017520: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
+00017530: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
+00017540: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
+00017550: 6f72 6d61 745f 6578 6328 2929 0a20 2020  ormat_exc()).   
+00017560: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00017570: 2074 7279 3a0a 2020 2020 2020 2020 666f   try:.        fo
+00017580: 7220 726f 6f6d 5f69 6420 696e 2072 6f6f  r room_id in roo
+00017590: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
+000175a0: 726f 6f6d 5f69 6420 3d20 6177 6169 7420  room_id = await 
+000175b0: 6d61 705f 726f 6f6d 696e 666f 5f74 6f5f  map_roominfo_to_
+000175c0: 726f 6f6d 6964 2863 6c69 656e 742c 2072  roomid(client, r
+000175d0: 6f6f 6d5f 6964 290a 2020 2020 2020 2020  oom_id).        
+000175e0: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
+000175f0: 2063 6c69 656e 742e 726f 6f6d 5f73 656e   client.room_sen
+00017600: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00017610: 2020 2072 6f6f 6d5f 6964 2c20 6d65 7373     room_id, mess
+00017620: 6167 655f 7479 7065 3d6d 6573 7361 6765  age_type=message
+00017630: 5f74 7970 652c 2063 6f6e 7465 6e74 3d63  _type, content=c
+00017640: 6f6e 7465 6e74 0a20 2020 2020 2020 2020  ontent.         
+00017650: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00017660: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00017670: 6573 702c 2052 6f6f 6d53 656e 6445 7272  esp, RoomSendErr
+00017680: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00017690: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+000176a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000176b0: 2020 2020 2020 2022 4531 3434 3a20 220a         "E144: ".
+000176c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176d0: 2020 2020 2272 6f6f 6d5f 7365 6e64 2066      "room_send f
+000176e0: 6169 6c65 6420 7769 7468 2065 7272 6f72  ailed with error
+000176f0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00017700: 2020 2020 2020 2066 2227 7b70 7269 7661         f"'{priva
+00017710: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00017720: 7370 2929 7d27 2e22 0a20 2020 2020 2020  sp))}'.".       
+00017730: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00017740: 2020 2020 2020 2020 2020 2023 2067 732e             # gs.
+00017750: 6572 725f 636f 756e 7420 2b3d 2031 2023  err_count += 1 #
+00017760: 206e 6f74 206e 6565 6465 642c 2077 696c   not needed, wil
+00017770: 6c20 7261 6973 6520 6578 6365 7074 696f  l raise exceptio
+00017780: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00017790: 2020 2320 696e 2066 6f6c 6c6f 7769 6e67    # in following
+000177a0: 206c 696e 6520 6f66 2063 6f64 650a 2020   line of code.  
+000177b0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+000177c0: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
+000177d0: 2020 2020 2020 2066 2754 6869 7320 6576         f'This ev
+000177e0: 656e 7420 7761 7320 7365 6e74 3a20 227b  ent was sent: "{
+000177f0: 6576 656e 747d 2220 746f 2072 6f6f 6d20  event}" to room 
+00017800: 227b 7265 7370 2e72 6f6f 6d5f 6964 7d22  "{resp.room_id}"
+00017810: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00017820: 2020 2066 2761 7320 6576 656e 7420 227b     f'as event "{
+00017830: 7265 7370 2e65 7665 6e74 5f69 647d 222e  resp.event_id}".
+00017840: 270a 2020 2020 2020 2020 2020 2020 290a  '.            ).
+00017850: 2020 2020 2020 2020 2020 2020 6966 2067              if g
+00017860: 732e 7061 2e70 7269 6e74 5f65 7665 6e74  s.pa.print_event
+00017870: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+00017880: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
+00017890: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
+000178a0: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
+000178b0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+000178c0: 2020 7465 7874 203d 2066 227b 7265 7370    text = f"{resp
+000178d0: 2e65 7665 6e74 5f69 647d 7b53 4550 7d7b  .event_id}{SEP}{
+000178e0: 7265 7370 2e72 6f6f 6d5f 6964 7d7b 5345  resp.room_id}{SE
+000178f0: 507d 7b65 7665 6e74 7d22 0a20 2020 2020  P}{event}".     
+00017900: 2020 2020 2020 2020 2020 2023 204f 626a             # Obj
+00017910: 6563 7420 6f66 2074 7970 6520 526f 6f6d  ect of type Room
+00017920: 4372 6561 7465 5265 7370 6f6e 7365 2069  CreateResponse i
+00017930: 7320 6e6f 7420 4a53 4f4e 0a20 2020 2020  s not JSON.     
+00017940: 2020 2020 2020 2020 2020 2023 2073 6572             # ser
+00017950: 6961 6c69 7a61 626c 652c 2068 656e 6365  ializable, hence
+00017960: 2077 6520 7573 6520 7468 6520 6469 6374   we use the dict
+00017970: 696f 6e61 7279 2e0a 2020 2020 2020 2020  ionary..        
+00017980: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+00017990: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
+000179a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000179b0: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
+000179c0: 287b 2265 7665 6e74 223a 2065 7665 6e74  ({"event": event
+000179d0: 7d29 2020 2320 6164 6420 6469 6374 2069  })  # add dict i
+000179e0: 7465 6d73 0a20 2020 2020 2020 2020 2020  tems.           
+000179f0: 2020 2020 206a 736f 6e5f 203d 206a 736f       json_ = jso
+00017a00: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
+00017a10: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00017a20: 6e5f 2e70 6f70 2822 7472 616e 7370 6f72  n_.pop("transpor
+00017a30: 745f 7265 7370 6f6e 7365 2229 0a20 2020  t_response").   
+00017a40: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00017a50: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
+00017a60: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00017a70: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
+00017a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a90: 6773 2e70 612e 6f75 7470 7574 2c0a 2020  gs.pa.output,.  
+00017aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ab0: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
+00017ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ad0: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+00017ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017af0: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
+00017b00: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
+00017b10: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+00017b20: 6563 3d6a 736f 6e5f 7370 6563 2c0a 2020  ec=json_spec,.  
+00017b30: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00017b40: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00017b50: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+00017b60: 2020 2020 2020 2020 2020 6627 5468 6973            f'This
+00017b70: 2065 7665 6e74 2077 6173 2073 656e 743a   event was sent:
+00017b80: 2022 7b65 7665 6e74 7d22 2028 7b63 6f6e   "{event}" ({con
+00017b90: 7465 6e74 7d29 2027 0a20 2020 2020 2020  tent}) '.       
+00017ba0: 2020 2020 2020 2020 2066 2774 6f20 726f           f'to ro
+00017bb0: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e20  om "{room_id}". 
+00017bc0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00017bd0: 2020 6622 5265 7370 6f6e 7365 3a20 6576    f"Response: ev
+00017be0: 656e 745f 6964 3d7b 7265 7370 2e65 7665  ent_id={resp.eve
+00017bf0: 6e74 5f69 647d 2c20 726f 6f6d 5f69 643d  nt_id}, room_id=
+00017c00: 7b72 6573 702e 726f 6f6d 5f69 647d 2c20  {resp.room_id}, 
+00017c10: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00017c20: 2020 6622 6675 6c6c 2072 6573 706f 6e73    f"full respons
+00017c30: 653a 207b 7072 6976 6163 795f 6669 6c74  e: {privacy_filt
+00017c40: 6572 2873 7472 2872 6573 7029 297d 2e20  er(str(resp))}. 
+00017c50: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00017c60: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00017c70: 7469 6f6e 3a0a 2020 2020 2020 2020 6773  tion:.        gs
+00017c80: 2e6c 6f67 2e65 7272 6f72 2822 4531 3435  .log.error("E145
+00017c90: 3a20 2220 6622 4576 656e 7420 7365 6e64  : " f"Event send
+00017ca0: 206f 6620 6669 6c65 207b 6576 656e 747d   of file {event}
+00017cb0: 2066 6169 6c65 642e 2053 6f72 7279 2e22   failed. Sorry."
+00017cc0: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
+00017cd0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00017ce0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00017cf0: 2822 4865 7265 2069 7320 7468 6520 7472  ("Here is the tr
+00017d00: 6163 6562 6163 6b2e 5c6e 2220 2b20 7472  aceback.\n" + tr
+00017d10: 6163 6562 6163 6b2e 666f 726d 6174 5f65  aceback.format_e
+00017d20: 7863 2829 290a 0a0a 2320 6163 636f 7264  xc())...# accord
+00017d30: 696e 6720 746f 206c 696e 7465 723a 2066  ing to linter: f
+00017d40: 756e 6374 696f 6e20 6973 2074 6f6f 2063  unction is too c
+00017d50: 6f6d 706c 6578 2c20 4339 3031 0a61 7379  omplex, C901.asy
+00017d60: 6e63 2064 6566 2073 656e 645f 6669 6c65  nc def send_file
+00017d70: 2863 6c69 656e 742c 2072 6f6f 6d73 2c20  (client, rooms, 
+00017d80: 6669 6c65 293a 2020 2320 6e6f 7161 3a20  file):  # noqa: 
+00017d90: 4339 3031 0a20 2020 2022 2222 5072 6f63  C901.    """Proc
+00017da0: 6573 7320 6669 6c65 2e0a 0a20 2020 2055  ess file...    U
+00017db0: 706c 6f61 6420 6669 6c65 2074 6f20 7365  pload file to se
+00017dc0: 7276 6572 2061 6e64 2074 6865 6e20 7365  rver and then se
+00017dd0: 6e64 206c 696e 6b20 746f 2072 6f6f 6d73  nd link to rooms
+00017de0: 2e0a 2020 2020 576f 726b 7320 616e 6420  ..    Works and 
+00017df0: 7465 7374 6564 2066 6f72 202e 7064 662c  tested for .pdf,
+00017e00: 202e 7478 742c 202e 6f67 672c 202e 7761   .txt, .ogg, .wa
+00017e10: 762e 0a20 2020 2041 6c6c 2074 6865 7365  v..    All these
+00017e20: 2066 696c 6520 7479 7065 7320 6172 6520   file types are 
+00017e30: 7472 6561 7465 6420 7468 6520 7361 6d65  treated the same
+00017e40: 2e0a 0a20 2020 2044 6f20 6e6f 7420 7573  ...    Do not us
+00017e50: 6520 7468 6973 2066 756e 6374 696f 6e20  e this function 
+00017e60: 666f 7220 696d 6167 6573 2e0a 2020 2020  for images..    
+00017e70: 5573 6520 7468 6520 7365 6e64 5f69 6d61  Use the send_ima
+00017e80: 6765 2829 2066 756e 6374 696f 6e20 666f  ge() function fo
+00017e90: 7220 696d 6167 6573 2e0a 0a20 2020 204d  r images...    M
+00017ea0: 6174 7269 7820 6861 7320 7479 7065 7320  atrix has types 
+00017eb0: 666f 7220 6175 6469 6f20 616e 6420 7669  for audio and vi
+00017ec0: 6465 6f20 2861 6e64 2069 6d61 6765 2061  deo (and image a
+00017ed0: 6e64 2066 696c 6529 2e0a 2020 2020 5365  nd file)..    Se
+00017ee0: 653a 2022 6d73 6774 7970 6522 203d 3d20  e: "msgtype" == 
+00017ef0: 226d 2e69 6d61 6765 222c 206d 2e61 7564  "m.image", m.aud
+00017f00: 696f 2c20 6d2e 7669 6465 6f2c 206d 2e66  io, m.video, m.f
+00017f10: 696c 650a 0a20 2020 2041 7267 756d 656e  ile..    Argumen
+00017f20: 7473 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  ts:.    --------
+00017f30: 2d0a 2020 2020 636c 6965 6e74 203a 2043  -.    client : C
+00017f40: 6c69 656e 740a 2020 2020 726f 6f6d 7320  lient.    rooms 
+00017f50: 3a20 6c69 7374 0a20 2020 2020 2020 206c  : list.        l
+00017f60: 6973 7420 6f66 2072 6f6f 6d5f 6964 2d73  ist of room_id-s
+00017f70: 0a20 2020 2066 696c 6520 3a20 7374 720a  .    file : str.
+00017f80: 2020 2020 2020 2020 6669 6c65 206e 616d          file nam
+00017f90: 6520 6f66 2066 696c 6520 6672 6f6d 202d  e of file from -
+00017fa0: 2d66 696c 6520 6172 6775 6d65 6e74 0a0a  -file argument..
+00017fb0: 2020 2020 5468 6973 2069 7320 6120 776f      This is a wo
+00017fc0: 726b 696e 6720 6578 616d 706c 6520 666f  rking example fo
+00017fd0: 7220 6120 5044 4620 6669 6c65 2e0a 2020  r a PDF file..  
+00017fe0: 2020 4974 2063 616e 2062 6520 7669 6577    It can be view
+00017ff0: 6564 206f 7220 646f 776e 6c6f 6164 6564  ed or downloaded
+00018000: 2066 726f 6d3a 0a20 2020 2068 7474 7073   from:.    https
+00018010: 3a2f 2f6d 6174 7269 782e 6578 616d 706c  ://matrix.exampl
+00018020: 652e 636f 6d2f 5f6d 6174 7269 782f 6d65  e.com/_matrix/me
+00018030: 6469 612f 7230 2f64 6f77 6e6c 6f61 642f  dia/r0/download/
+00018040: 0a20 2020 2020 2020 2065 7861 6d70 6c65  .        example
+00018050: 2e63 6f6d 2f53 6f6d 6553 7472 616e 6765  .com/SomeStrange
+00018060: 5572 694b 6579 0a20 2020 207b 0a20 2020  UriKey.    {.   
+00018070: 2020 2020 2022 7479 7065 223a 2022 6d2e       "type": "m.
+00018080: 726f 6f6d 2e6d 6573 7361 6765 222c 0a20  room.message",. 
+00018090: 2020 2020 2020 2022 7365 6e64 6572 223a         "sender":
+000180a0: 2022 4073 6f6d 6575 7365 723a 6578 616d   "@someuser:exam
+000180b0: 706c 652e 636f 6d22 2c0a 2020 2020 2020  ple.com",.      
+000180c0: 2020 2263 6f6e 7465 6e74 223a 207b 0a20    "content": {. 
+000180d0: 2020 2020 2020 2020 2020 2022 626f 6479             "body
+000180e0: 223a 2022 6578 616d 706c 652e 7064 6622  ": "example.pdf"
+000180f0: 2c0a 2020 2020 2020 2020 2020 2020 2269  ,.            "i
+00018100: 6e66 6f22 3a20 7b0a 2020 2020 2020 2020  nfo": {.        
+00018110: 2020 2020 2020 2020 2273 697a 6522 3a20          "size": 
+00018120: 3633 3031 3233 342c 0a20 2020 2020 2020  6301234,.       
+00018130: 2020 2020 2020 2020 2022 6d69 6d65 7479           "mimety
+00018140: 7065 223a 2022 6170 706c 6963 6174 696f  pe": "applicatio
+00018150: 6e2f 7064 6622 0a20 2020 2020 2020 2020  n/pdf".         
+00018160: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00018170: 2020 2020 2020 226d 7367 7479 7065 223a        "msgtype":
+00018180: 2022 6d2e 6669 6c65 222c 0a20 2020 2020   "m.file",.     
+00018190: 2020 2020 2020 2022 7572 6c22 3a20 226d         "url": "m
+000181a0: 7863 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  xc://example.com
+000181b0: 2f53 6f6d 6553 7472 616e 6765 5572 694b  /SomeStrangeUriK
+000181c0: 6579 220a 2020 2020 2020 2020 7d2c 0a20  ey".        },. 
+000181d0: 2020 2020 2020 2022 6f72 6967 696e 5f73         "origin_s
+000181e0: 6572 7665 725f 7473 223a 2031 3539 3531  erver_ts": 15951
+000181f0: 3030 3030 3030 3030 2c0a 2020 2020 2020  00000000,.      
+00018200: 2020 2275 6e73 6967 6e65 6422 3a20 7b0a    "unsigned": {.
+00018210: 2020 2020 2020 2020 2020 2020 2261 6765              "age
+00018220: 223a 2031 3030 302c 0a20 2020 2020 2020  ": 1000,.       
+00018230: 2020 2020 2022 7472 616e 7361 6374 696f       "transactio
+00018240: 6e5f 6964 223a 2022 536f 6d65 5478 4964  n_id": "SomeTxId
+00018250: 3031 3233 3435 3637 220a 2020 2020 2020  01234567".      
+00018260: 2020 7d2c 0a20 2020 2020 2020 2022 6576    },.        "ev
+00018270: 656e 745f 6964 223a 2022 2453 6f6d 6545  ent_id": "$SomeE
+00018280: 7665 6e74 4964 3031 3233 3435 3637 3738  ventId0123456778
+00018290: 3941 6263 6465 6630 3132 3334 3536 3738  9Abcdef012345678
+000182a0: 222c 0a20 2020 2020 2020 2022 726f 6f6d  ",.        "room
+000182b0: 5f69 6422 3a20 2221 536f 6d65 526f 6f6d  _id": "!SomeRoom
+000182c0: 4964 3a65 7861 6d70 6c65 2e63 6f6d 220a  Id:example.com".
+000182d0: 2020 2020 7d0a 0a20 2020 2022 2222 0a20      }..    """. 
+000182e0: 2020 2069 6620 6e6f 7420 726f 6f6d 733a     if not rooms:
+000182f0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00018300: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
+00018310: 2020 224e 6f20 726f 6f6d 7320 6172 6520    "No rooms are 
+00018320: 6769 7665 6e2e 2054 6869 7320 7368 6f75  given. This shou
+00018330: 6c64 206e 6f74 2068 6170 7065 6e2e 2022  ld not happen. "
+00018340: 0a20 2020 2020 2020 2020 2020 2022 4d61  .            "Ma
+00018350: 7962 6520 796f 7572 2044 4d20 726f 6f6d  ybe your DM room
+00018360: 7320 7370 6563 6966 6965 6420 7669 6120  s specified via 
+00018370: 2d2d 7573 6572 2077 6572 6520 6e6f 7420  --user were not 
+00018380: 666f 756e 642e 2022 0a20 2020 2020 2020  found. ".       
+00018390: 2020 2020 2022 5468 6973 2066 696c 6520       "This file 
+000183a0: 6973 2062 6569 6e67 2064 726f 7070 6564  is being dropped
+000183b0: 2061 6e64 204e 4f54 2073 656e 742e 220a   and NOT sent.".
+000183c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000183d0: 2020 7265 7475 726e 0a0a 2020 2020 2320    return..    # 
+000183e0: 666f 7220 6d6f 7265 2063 6f6d 6d65 6e74  for more comment
+000183f0: 7320 6f6e 2068 6f77 2074 6f20 7472 6561  s on how to trea
+00018400: 7420 7069 7065 206f 6e20 7374 6469 6e20  t pipe on stdin 
+00018410: 706c 6561 7365 2072 6561 6420 7468 650a  please read the.
+00018420: 2020 2020 2320 636f 6d6d 656e 7473 2069      # comments i
+00018430: 6e20 7365 6e64 5f69 6d61 6765 2829 0a0a  n send_image()..
+00018440: 2020 2020 6966 2066 696c 6520 3d3d 2022      if file == "
+00018450: 2d22 3a20 2023 202d 206d 6561 6e73 2072  -":  # - means r
+00018460: 6561 6420 6173 2070 6970 6520 6672 6f6d  ead as pipe from
+00018470: 2073 7464 696e 0a20 2020 2020 2020 2069   stdin.        i
+00018480: 7350 6970 6520 3d20 5472 7565 0a20 2020  sPipe = True.   
+00018490: 2020 2020 2066 696e 5f62 7566 203d 2073       fin_buf = s
+000184a0: 7973 2e73 7464 696e 2e62 7566 6665 722e  ys.stdin.buffer.
+000184b0: 7265 6164 2829 0a20 2020 2020 2020 206c  read().        l
+000184c0: 656e 5f66 696e 5f62 7566 203d 206c 656e  en_fin_buf = len
+000184d0: 2866 696e 5f62 7566 290a 2020 2020 2020  (fin_buf).      
+000184e0: 2020 6669 6c65 203d 2022 6d63 2d22 202b    file = "mc-" +
+000184f0: 2073 7472 2875 7569 642e 7575 6964 3428   str(uuid.uuid4(
+00018500: 2929 202b 2022 2e74 6d70 220a 2020 2020  )) + ".tmp".    
+00018510: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00018520: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00018530: 7b6c 656e 5f66 696e 5f62 7566 7d20 6279  {len_fin_buf} by
+00018540: 7465 7320 6f66 2066 696c 6520 6461 7461  tes of file data
+00018550: 2072 6561 6420 6672 6f6d 2073 7464 696e   read from stdin
+00018560: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+00018570: 6627 5465 6d70 6f72 6172 7920 6669 6c65  f'Temporary file
+00018580: 2022 7b66 696c 657d 2220 7761 7320 6372   "{file}" was cr
+00018590: 6561 7465 6420 666f 7220 6669 6c65 2e27  eated for file.'
+000185a0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000185b0: 2020 2066 6f75 7420 3d20 6f70 656e 2866     fout = open(f
+000185c0: 696c 652c 2022 7762 2229 0a20 2020 2020  ile, "wb").     
+000185d0: 2020 2066 6f75 742e 7772 6974 6528 6669     fout.write(fi
+000185e0: 6e5f 6275 6629 0a20 2020 2020 2020 2066  n_buf).        f
+000185f0: 6f75 742e 636c 6f73 6528 290a 2020 2020  out.close().    
+00018600: 656c 7365 3a0a 2020 2020 2020 2020 6973  else:.        is
+00018610: 5069 7065 203d 2046 616c 7365 0a0a 2020  Pipe = False..  
+00018620: 2020 6966 206e 6f74 206f 732e 7061 7468    if not os.path
+00018630: 2e69 7366 696c 6528 6669 6c65 293a 0a20  .isfile(file):. 
+00018640: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00018650: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+00018660: 2066 2246 696c 6520 7b66 696c 657d 2069   f"File {file} i
+00018670: 7320 6e6f 7420 6120 6669 6c65 2e20 446f  s not a file. Do
+00018680: 6573 6e27 7420 6578 6973 7420 6f72 2022  esn't exist or "
+00018690: 0a20 2020 2020 2020 2020 2020 2022 6973  .            "is
+000186a0: 2061 2064 6972 6563 746f 7279 2e20 220a   a directory. ".
+000186b0: 2020 2020 2020 2020 2020 2020 2254 6869              "Thi
+000186c0: 7320 6669 6c65 2069 7320 6265 696e 6720  s file is being 
+000186d0: 6472 6f70 7065 6420 616e 6420 4e4f 5420  dropped and NOT 
+000186e0: 7365 6e74 2e22 0a20 2020 2020 2020 2029  sent.".        )
+000186f0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+00018700: 0a20 2020 2023 2023 2072 6573 7472 6963  .    # # restric
+00018710: 7420 746f 2022 7478 7422 2c20 2270 6466  t to "txt", "pdf
+00018720: 222c 2022 6d70 3322 2c20 226f 6767 222c  ", "mp3", "ogg",
+00018730: 2022 7761 7622 2c20 2e2e 2e0a 2020 2020   "wav", ....    
+00018740: 2320 6966 206e 6f74 2072 652e 6d61 7463  # if not re.matc
+00018750: 6828 225e 2e70 6466 247c 5e2e 7478 7424  h("^.pdf$|^.txt$
+00018760: 7c5e 2e64 6f63 247c 5e2e 786c 7324 7c5e  |^.doc$|^.xls$|^
+00018770: 2e6d 6f62 6924 7c5e 2e6d 7033 2422 2c0a  .mobi$|^.mp3$",.
+00018780: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+00018790: 2020 2020 206f 732e 7061 7468 2e73 706c       os.path.spl
+000187a0: 6974 6578 7428 6669 6c65 295b 315d 2e6c  itext(file)[1].l
+000187b0: 6f77 6572 2829 293a 0a20 2020 2023 2020  ower()):.    #  
+000187c0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+000187d0: 2246 696c 6520 7b66 696c 657d 2069 7320  "File {file} is 
+000187e0: 6e6f 7420 6120 7065 726d 6974 7465 6420  not a permitted 
+000187f0: 6669 6c65 2074 7970 652e 2053 686f 756c  file type. Shoul
+00018800: 6420 6265 2022 0a20 2020 2023 2020 2020  d be ".    #    
+00018810: 2020 2020 2020 2020 2020 2020 2022 2e70               ".p
+00018820: 6466 2c20 2e74 7874 2c20 2e64 6f63 2c20  df, .txt, .doc, 
+00018830: 2e78 6c73 2c20 2e6d 6f62 6920 6f72 202e  .xls, .mobi or .
+00018840: 6d70 3320 2e2e 2e20 220a 2020 2020 2320  mp3 ... ".    # 
+00018850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018860: 6622 5b7b 6f73 2e70 6174 682e 7370 6c69  f"[{os.path.spli
+00018870: 7465 7874 2866 696c 6529 5b31 5d2e 6c6f  text(file)[1].lo
+00018880: 7765 7228 297d 5d22 0a20 2020 2023 2020  wer()}]".    #  
+00018890: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000188a0: 5468 6973 2066 696c 6520 6973 2062 6569  This file is bei
+000188b0: 6e67 2064 726f 7070 6564 2061 6e64 204e  ng dropped and N
+000188c0: 4f54 2073 656e 742e 2229 0a20 2020 2023  OT sent.").    #
+000188d0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+000188e0: 2320 2761 7070 6c69 6361 7469 6f6e 2f70  # 'application/p
+000188f0: 6466 2720 2270 6c61 696e 2f74 6578 7422  df' "plain/text"
+00018900: 2022 6175 6469 6f2f 6f67 6722 0a20 2020   "audio/ogg".   
+00018910: 206d 696d 655f 7479 7065 203d 206d 6167   mime_type = mag
+00018920: 6963 2e66 726f 6d5f 6669 6c65 2866 696c  ic.from_file(fil
+00018930: 652c 206d 696d 653d 5472 7565 290a 2020  e, mime=True).  
+00018940: 2020 2320 6966 2028 286e 6f74 206d 696d    # if ((not mim
+00018950: 655f 7479 7065 2e73 7461 7274 7377 6974  e_type.startswit
+00018960: 6828 2261 7070 6c69 6361 7469 6f6e 2f22  h("application/"
+00018970: 2929 2061 6e64 0a20 2020 2023 2020 2020  )) and.    #    
+00018980: 2020 2020 286e 6f74 206d 696d 655f 7479      (not mime_ty
+00018990: 7065 2e73 7461 7274 7377 6974 6828 2270  pe.startswith("p
+000189a0: 6c61 696e 2f22 2929 2061 6e64 0a20 2020  lain/")) and.   
+000189b0: 2023 2020 2020 2020 2020 286e 6f74 206d   #        (not m
+000189c0: 696d 655f 7479 7065 2e73 7461 7274 7377  ime_type.startsw
+000189d0: 6974 6828 2261 7564 696f 2f22 2929 293a  ith("audio/"))):
+000189e0: 0a20 2020 2023 2020 2020 6773 2e6c 6f67  .    #    gs.log
+000189f0: 2e64 6562 7567 2866 2246 696c 6520 7b66  .debug(f"File {f
+00018a00: 696c 657d 2064 6f65 7320 6e6f 7420 6861  ile} does not ha
+00018a10: 7665 2061 6e20 6163 6365 7074 6564 206d  ve an accepted m
+00018a20: 696d 6520 7479 7065 2e20 220a 2020 2020  ime type. ".    
+00018a30: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00018a40: 2020 2253 686f 756c 6420 6265 2073 6f6d    "Should be som
+00018a50: 6574 6869 6e67 206c 696b 6520 6170 706c  ething like appl
+00018a60: 6963 6174 696f 6e2f 7064 662e 2022 0a20  ication/pdf. ". 
+00018a70: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+00018a80: 2020 2020 2066 2246 6f75 6e64 206d 696d       f"Found mim
+00018a90: 6520 7479 7065 207b 6d69 6d65 5f74 7970  e type {mime_typ
+00018aa0: 657d 2e20 220a 2020 2020 2320 2020 2020  e}. ".    #     
+00018ab0: 2020 2020 2020 2020 2020 2020 2254 6869              "Thi
+00018ac0: 7320 6669 6c65 2069 7320 6265 696e 6720  s file is being 
+00018ad0: 6472 6f70 7065 6420 616e 6420 4e4f 5420  dropped and NOT 
+00018ae0: 7365 6e74 2e22 290a 2020 2020 2320 2020  sent.").    #   
+00018af0: 2072 6574 7572 6e0a 0a20 2020 2023 2066   return..    # f
+00018b00: 6972 7374 2064 6f20 616e 2075 706c 6f61  irst do an uploa
+00018b10: 6420 6f66 2066 696c 652c 2073 6565 2075  d of file, see u
+00018b20: 706c 6f61 6428 2920 646f 6375 6d65 6e74  pload() document
+00018b30: 6174 696f 6e0a 2020 2020 2320 6874 7470  ation.    # http
+00018b40: 3a2f 2f6d 6174 7269 782d 6e69 6f2e 7265  ://matrix-nio.re
+00018b50: 6164 7468 6564 6f63 732e 696f 2f65 6e2f  adthedocs.io/en/
+00018b60: 6c61 7465 7374 2f6e 696f 2e68 746d 6c23  latest/nio.html#
+00018b70: 6e69 6f2e 4173 796e 6343 6c69 656e 742e  nio.AsyncClient.
+00018b80: 7570 6c6f 6164 0a20 2020 2023 2074 6865  upload.    # the
+00018b90: 6e20 7365 6e64 2055 5249 206f 6620 7570  n send URI of up
+00018ba0: 6c6f 6164 2074 6f20 726f 6f6d 0a0a 2020  load to room..  
+00018bb0: 2020 6669 6c65 5f73 7461 7420 3d20 6177    file_stat = aw
+00018bc0: 6169 7420 6169 6f66 696c 6573 2e6f 732e  ait aiofiles.os.
+00018bd0: 7374 6174 2866 696c 6529 0a20 2020 2061  stat(file).    a
+00018be0: 7379 6e63 2077 6974 6820 6169 6f66 696c  sync with aiofil
+00018bf0: 6573 2e6f 7065 6e28 6669 6c65 2c20 2272  es.open(file, "r
+00018c00: 2b62 2229 2061 7320 663a 0a20 2020 2020  +b") as f:.     
+00018c10: 2020 2072 6573 702c 2064 6563 7279 7074     resp, decrypt
+00018c20: 696f 6e5f 6b65 7973 203d 2061 7761 6974  ion_keys = await
+00018c30: 2063 6c69 656e 742e 7570 6c6f 6164 280a   client.upload(.
+00018c40: 2020 2020 2020 2020 2020 2020 662c 0a20              f,. 
+00018c50: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+00018c60: 6e74 5f74 7970 653d 6d69 6d65 5f74 7970  nt_type=mime_typ
+00018c70: 652c 2020 2320 6170 706c 6963 6174 696f  e,  # applicatio
+00018c80: 6e2f 7064 660a 2020 2020 2020 2020 2020  n/pdf.          
+00018c90: 2020 6669 6c65 6e61 6d65 3d6f 732e 7061    filename=os.pa
+00018ca0: 7468 2e62 6173 656e 616d 6528 6669 6c65  th.basename(file
+00018cb0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00018cc0: 696c 6573 697a 653d 6669 6c65 5f73 7461  ilesize=file_sta
+00018cd0: 742e 7374 5f73 697a 652c 0a20 2020 2020  t.st_size,.     
+00018ce0: 2020 2020 2020 2065 6e63 7279 7074 3d54         encrypt=T
+00018cf0: 7275 652c 0a20 2020 2020 2020 2029 0a20  rue,.        ). 
+00018d00: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00018d10: 2872 6573 702c 2055 706c 6f61 6452 6573  (resp, UploadRes
+00018d20: 706f 6e73 6529 3a0a 2020 2020 2020 2020  ponse):.        
+00018d30: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+00018d40: 2020 2020 2020 2020 2020 2246 696c 6520            "File 
+00018d50: 7761 7320 7570 6c6f 6164 6564 2073 7563  was uploaded suc
+00018d60: 6365 7373 6675 6c6c 7920 746f 2073 6572  cessfully to ser
+00018d70: 7665 722e 2052 6573 706f 6e73 6520 6973  ver. Response is
+00018d80: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00018d90: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
+00018da0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00018db0: 2020 2020 2020 2029 0a20 2020 2065 6c73         ).    els
+00018dc0: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+00018dd0: 672e 696e 666f 280a 2020 2020 2020 2020  g.info(.        
+00018de0: 2020 2020 6622 5468 6520 7072 6f67 7261      f"The progra
+00018df0: 6d20 7b50 524f 475f 5749 5448 5f45 5854  m {PROG_WITH_EXT
+00018e00: 7d20 6661 696c 6564 2074 6f20 7570 6c6f  } failed to uplo
+00018e10: 6164 2e20 220a 2020 2020 2020 2020 2020  ad. ".          
+00018e20: 2020 2250 6c65 6173 6520 7265 7472 792e    "Please retry.
+00018e30: 2054 6869 7320 636f 756c 6420 6265 2074   This could be t
+00018e40: 656d 706f 7261 7279 2069 7373 7565 206f  emporary issue o
+00018e50: 6e20 220a 2020 2020 2020 2020 2020 2020  n ".            
+00018e60: 2279 6f75 7220 7365 7276 6572 2e20 220a  "your server. ".
+00018e70: 2020 2020 2020 2020 2020 2020 2253 6f72              "Sor
+00018e80: 7279 2e22 0a20 2020 2020 2020 2029 0a20  ry.".        ). 
+00018e90: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
+00018ea0: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+00018eb0: 6627 6669 6c65 3d22 7b66 696c 657d 223b  f'file="{file}";
+00018ec0: 206d 696d 655f 7479 7065 3d22 7b6d 696d   mime_type="{mim
+00018ed0: 655f 7479 7065 7d22 3b20 270a 2020 2020  e_type}"; '.    
+00018ee0: 2020 2020 2020 2020 6627 6669 6c65 7373          f'filess
+00018ef0: 697a 653d 227b 6669 6c65 5f73 7461 742e  ize="{file_stat.
+00018f00: 7374 5f73 697a 657d 2227 0a20 2020 2020  st_size}"'.     
+00018f10: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
+00018f20: 746f 2075 706c 6f61 643a 207b 7072 6976  to upload: {priv
+00018f30: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+00018f40: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+00018f50: 290a 0a20 2020 2023 2064 6574 6572 6d69  )..    # determi
+00018f60: 6e65 206d 7367 5f74 7970 653a 0a20 2020  ne msg_type:.   
+00018f70: 2069 6620 6d69 6d65 5f74 7970 652e 7374   if mime_type.st
+00018f80: 6172 7473 7769 7468 2822 6175 6469 6f2f  artswith("audio/
+00018f90: 2229 3a0a 2020 2020 2020 2020 6d73 675f  "):.        msg_
+00018fa0: 7479 7065 203d 2022 6d2e 6175 6469 6f22  type = "m.audio"
+00018fb0: 0a20 2020 2065 6c69 6620 6d69 6d65 5f74  .    elif mime_t
+00018fc0: 7970 652e 7374 6172 7473 7769 7468 2822  ype.startswith("
+00018fd0: 7669 6465 6f2f 2229 3a0a 2020 2020 2020  video/"):.      
+00018fe0: 2020 6d73 675f 7479 7065 203d 2022 6d2e    msg_type = "m.
+00018ff0: 7669 6465 6f22 0a20 2020 2065 6c73 653a  video".    else:
+00019000: 0a20 2020 2020 2020 206d 7367 5f74 7970  .        msg_typ
+00019010: 6520 3d20 226d 2e66 696c 6522 0a0a 2020  e = "m.file"..  
+00019020: 2020 636f 6e74 656e 7420 3d20 7b0a 2020    content = {.  
+00019030: 2020 2020 2020 2262 6f64 7922 3a20 6f73        "body": os
+00019040: 2e70 6174 682e 6261 7365 6e61 6d65 2866  .path.basename(f
+00019050: 696c 6529 2c20 2023 2064 6573 6372 6970  ile),  # descrip
+00019060: 7469 7665 2074 6974 6c65 0a20 2020 2020  tive title.     
+00019070: 2020 2022 696e 666f 223a 207b 2273 697a     "info": {"siz
+00019080: 6522 3a20 6669 6c65 5f73 7461 742e 7374  e": file_stat.st
+00019090: 5f73 697a 652c 2022 6d69 6d65 7479 7065  _size, "mimetype
+000190a0: 223a 206d 696d 655f 7479 7065 7d2c 0a20  ": mime_type},. 
+000190b0: 2020 2020 2020 2022 6d73 6774 7970 6522         "msgtype"
+000190c0: 3a20 6d73 675f 7479 7065 2c0a 2020 2020  : msg_type,.    
+000190d0: 2020 2020 2266 696c 6522 3a20 7b0a 2020      "file": {.  
+000190e0: 2020 2020 2020 2020 2020 2275 726c 223a            "url":
+000190f0: 2072 6573 702e 636f 6e74 656e 745f 7572   resp.content_ur
+00019100: 692c 0a20 2020 2020 2020 2020 2020 2022  i,.            "
+00019110: 6b65 7922 3a20 6465 6372 7970 7469 6f6e  key": decryption
+00019120: 5f6b 6579 735b 226b 6579 225d 2c0a 2020  _keys["key"],.  
+00019130: 2020 2020 2020 2020 2020 2269 7622 3a20            "iv": 
+00019140: 6465 6372 7970 7469 6f6e 5f6b 6579 735b  decryption_keys[
+00019150: 2269 7622 5d2c 0a20 2020 2020 2020 2020  "iv"],.         
+00019160: 2020 2022 6861 7368 6573 223a 2064 6563     "hashes": dec
+00019170: 7279 7074 696f 6e5f 6b65 7973 5b22 6861  ryption_keys["ha
+00019180: 7368 6573 225d 2c0a 2020 2020 2020 2020  shes"],.        
+00019190: 2020 2020 2276 223a 2064 6563 7279 7074      "v": decrypt
+000191a0: 696f 6e5f 6b65 7973 5b22 7622 5d2c 0a20  ion_keys["v"],. 
+000191b0: 2020 2020 2020 207d 2c0a 2020 2020 7d0a         },.    }.
+000191c0: 0a20 2020 2069 6620 6973 5069 7065 3a0a  .    if isPipe:.
+000191d0: 2020 2020 2020 2020 2320 726d 2074 656d          # rm tem
+000191e0: 7020 6669 6c65 0a20 2020 2020 2020 206f  p file.        o
+000191f0: 732e 7265 6d6f 7665 2866 696c 6529 0a0a  s.remove(file)..
+00019200: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00019210: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
+00019220: 726f 6f6d 733a 0a20 2020 2020 2020 2020  rooms:.         
+00019230: 2020 2072 6f6f 6d5f 6964 203d 2061 7761     room_id = awa
+00019240: 6974 206d 6170 5f72 6f6f 6d69 6e66 6f5f  it map_roominfo_
+00019250: 746f 5f72 6f6f 6d69 6428 636c 6965 6e74  to_roomid(client
+00019260: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
+00019270: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
+00019280: 6169 7420 636c 6965 6e74 2e72 6f6f 6d5f  ait client.room_
+00019290: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
+000192a0: 2020 2020 2020 726f 6f6d 5f69 642c 206d        room_id, m
+000192b0: 6573 7361 6765 5f74 7970 653d 226d 2e72  essage_type="m.r
+000192c0: 6f6f 6d2e 6d65 7373 6167 6522 2c20 636f  oom.message", co
+000192d0: 6e74 656e 743d 636f 6e74 656e 740a 2020  ntent=content.  
+000192e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000192f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00019300: 7461 6e63 6528 7265 7370 2c20 526f 6f6d  tance(resp, Room
+00019310: 5365 6e64 4572 726f 7229 3a0a 2020 2020  SendError):.    
+00019320: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00019330: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00019340: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00019350: 3134 363a 2022 0a20 2020 2020 2020 2020  146: ".         
+00019360: 2020 2020 2020 2020 2020 2022 726f 6f6d             "room
+00019370: 5f73 656e 6420 6661 696c 6564 2077 6974  _send failed wit
+00019380: 6820 6572 726f 7220 220a 2020 2020 2020  h error ".      
+00019390: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000193a0: 277b 7072 6976 6163 795f 6669 6c74 6572  '{privacy_filter
+000193b0: 2873 7472 2872 6573 7029 297d 272e 220a  (str(resp))}'.".
+000193c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000193e0: 2020 2320 6773 2e65 7272 5f63 6f75 6e74    # gs.err_count
+000193f0: 202b 3d20 3120 2320 6e6f 7420 6e65 6564   += 1 # not need
+00019400: 6564 2c20 7769 6c6c 2072 6169 7365 2065  ed, will raise e
+00019410: 7863 6570 7469 6f6e 0a20 2020 2020 2020  xception.       
+00019420: 2020 2020 2020 2020 2023 2069 6e20 666f           # in fo
+00019430: 6c6c 6f77 696e 6720 6c69 6e65 206f 6620  llowing line of 
+00019440: 636f 6465 0a20 2020 2020 2020 2020 2020  code.           
+00019450: 2067 732e 6c6f 672e 696e 666f 280a 2020   gs.log.info(.  
+00019460: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00019470: 5468 6973 2066 696c 6520 7761 7320 7365  This file was se
+00019480: 6e74 3a20 227b 6669 6c65 7d22 2074 6f20  nt: "{file}" to 
+00019490: 726f 6f6d 2022 7b72 6573 702e 726f 6f6d  room "{resp.room
+000194a0: 5f69 647d 2220 270a 2020 2020 2020 2020  _id}" '.        
+000194b0: 2020 2020 2020 2020 6627 6173 2065 7665          f'as eve
+000194c0: 6e74 2022 7b72 6573 702e 6576 656e 745f  nt "{resp.event_
+000194d0: 6964 7d22 2e27 0a20 2020 2020 2020 2020  id}".'.         
+000194e0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000194f0: 2069 6620 6773 2e70 612e 7072 696e 745f   if gs.pa.print_
+00019500: 6576 656e 745f 6964 3a0a 2020 2020 2020  event_id:.      
+00019510: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
+00019520: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
+00019530: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
+00019540: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
+00019550: 2020 2020 2020 2074 6578 7420 3d20 6622         text = f"
+00019560: 7b72 6573 702e 6576 656e 745f 6964 7d7b  {resp.event_id}{
+00019570: 5345 507d 7b72 6573 702e 726f 6f6d 5f69  SEP}{resp.room_i
+00019580: 647d 7b53 4550 7d7b 6669 6c65 7d22 0a20  d}{SEP}{file}". 
+00019590: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000195a0: 204f 626a 6563 7420 6f66 2074 7970 6520   Object of type 
+000195b0: 526f 6f6d 4372 6561 7465 5265 7370 6f6e  RoomCreateRespon
+000195c0: 7365 2069 7320 6e6f 7420 4a53 4f4e 0a20  se is not JSON. 
+000195d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000195e0: 2073 6572 6961 6c69 7a61 626c 652c 2068   serializable, h
+000195f0: 656e 6365 2077 6520 7573 6520 7468 6520  ence we use the 
+00019600: 6469 6374 696f 6e61 7279 2e0a 2020 2020  dictionary..    
+00019610: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00019620: 5f6d 6178 203d 2072 6573 702e 5f5f 6469  _max = resp.__di
+00019630: 6374 5f5f 0a20 2020 2020 2020 2020 2020  ct__.           
+00019640: 2020 2020 206a 736f 6e5f 6d61 782e 7570       json_max.up
+00019650: 6461 7465 287b 2266 696c 6522 3a20 6669  date({"file": fi
+00019660: 6c65 7d29 2020 2320 6164 6420 6469 6374  le})  # add dict
+00019670: 2069 7465 6d73 0a20 2020 2020 2020 2020   items.         
+00019680: 2020 2020 2020 206a 736f 6e5f 203d 206a         json_ = j
+00019690: 736f 6e5f 6d61 782e 636f 7079 2829 0a20  son_max.copy(). 
+000196a0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+000196b0: 736f 6e5f 2e70 6f70 2822 7472 616e 7370  son_.pop("transp
+000196c0: 6f72 745f 7265 7370 6f6e 7365 2229 0a20  ort_response"). 
+000196d0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+000196e0: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
+000196f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019700: 7072 696e 745f 6f75 7470 7574 280a 2020  print_output(.  
+00019710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019720: 2020 6773 2e70 612e 6f75 7470 7574 2c0a    gs.pa.output,.
+00019730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019740: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
+00019750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019760: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
+00019770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019780: 2020 2020 6a73 6f6e 5f6d 6178 3d6a 736f      json_max=jso
+00019790: 6e5f 6d61 782c 0a20 2020 2020 2020 2020  n_max,.         
+000197a0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+000197b0: 7370 6563 3d6a 736f 6e5f 7370 6563 2c0a  spec=json_spec,.
+000197c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000197d0: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+000197e0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+000197f0: 2020 2020 2020 2020 2020 2020 6627 5468              f'Th
+00019800: 6973 2066 696c 6520 7761 7320 7365 6e74  is file was sent
+00019810: 3a20 227b 6669 6c65 7d22 2074 6f20 726f  : "{file}" to ro
+00019820: 6f6d 2022 7b72 6f6f 6d5f 6964 7d22 2e20  om "{room_id}". 
+00019830: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00019840: 2020 6622 5265 7370 6f6e 7365 3a20 6576    f"Response: ev
+00019850: 656e 745f 6964 3d7b 7265 7370 2e65 7665  ent_id={resp.eve
+00019860: 6e74 5f69 647d 2c20 726f 6f6d 5f69 643d  nt_id}, room_id=
+00019870: 7b72 6573 702e 726f 6f6d 5f69 647d 2c20  {resp.room_id}, 
+00019880: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00019890: 2020 6622 6675 6c6c 2072 6573 706f 6e73    f"full respons
+000198a0: 653a 207b 7072 6976 6163 795f 6669 6c74  e: {privacy_filt
+000198b0: 6572 2873 7472 2872 6573 7029 297d 2e20  er(str(resp))}. 
+000198c0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+000198d0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000198e0: 7469 6f6e 3a0a 2020 2020 2020 2020 6773  tion:.        gs
+000198f0: 2e6c 6f67 2e65 7272 6f72 2822 4531 3437  .log.error("E147
+00019900: 3a20 2220 6622 4669 6c65 2073 656e 6420  : " f"File send 
+00019910: 6f66 2066 696c 6520 7b66 696c 657d 2066  of file {file} f
+00019920: 6169 6c65 642e 2053 6f72 7279 2e22 290a  ailed. Sorry.").
+00019930: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+00019940: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+00019950: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+00019960: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+00019970: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+00019980: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00019990: 2829 290a 0a0a 2320 6163 636f 7264 696e  ())...# accordin
+000199a0: 6720 746f 206c 696e 7465 723a 2066 756e  g to linter: fun
+000199b0: 6374 696f 6e20 6973 2074 6f6f 2063 6f6d  ction is too com
+000199c0: 706c 6578 2c20 4339 3031 0a61 7379 6e63  plex, C901.async
+000199d0: 2064 6566 2073 656e 645f 696d 6167 6528   def send_image(
+000199e0: 636c 6965 6e74 2c20 726f 6f6d 732c 2069  client, rooms, i
+000199f0: 6d61 6765 293a 2020 2320 6e6f 7161 3a20  mage):  # noqa: 
+00019a00: 4339 3031 0a20 2020 2022 2222 5072 6f63  C901.    """Proc
+00019a10: 6573 7320 696d 6167 652e 0a0a 2020 2020  ess image...    
+00019a20: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
+00019a30: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6c69  --------.    cli
+00019a40: 656e 7420 3a20 436c 6965 6e74 0a20 2020  ent : Client.   
+00019a50: 2072 6f6f 6d73 203a 206c 6973 740a 2020   rooms : list.  
+00019a60: 2020 2020 2020 6c69 7374 206f 6620 726f        list of ro
+00019a70: 6f6d 5f69 642d 730a 2020 2020 696d 6167  om_id-s.    imag
+00019a80: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+00019a90: 6669 6c65 206e 616d 6520 6f66 2069 6d61  file name of ima
+00019aa0: 6765 2066 726f 6d20 2d2d 696d 6167 6520  ge from --image 
+00019ab0: 6172 6775 6d65 6e74 0a0a 2020 2020 5468  argument..    Th
+00019ac0: 6973 2069 7320 6120 776f 726b 696e 6720  is is a working 
+00019ad0: 6578 616d 706c 6520 666f 7220 6120 4a50  example for a JP
+00019ae0: 4720 696d 6167 652e 0a20 2020 2049 7420  G image..    It 
+00019af0: 6361 6e20 6265 2076 6965 7765 6420 6f72  can be viewed or
+00019b00: 2064 6f77 6e6c 6f61 6465 6420 6672 6f6d   downloaded from
+00019b10: 3a0a 2020 2020 6874 7470 733a 2f2f 6d61  :.    https://ma
+00019b20: 7472 6978 2e65 7861 6d70 6c65 2e63 6f6d  trix.example.com
+00019b30: 2f5f 6d61 7472 6978 2f6d 6564 6961 2f72  /_matrix/media/r
+00019b40: 302f 646f 776e 6c6f 6164 2f0a 2020 2020  0/download/.    
+00019b50: 2020 2020 6578 616d 706c 652e 636f 6d2f      example.com/
+00019b60: 536f 6d65 5374 7261 6e67 6555 7269 4b65  SomeStrangeUriKe
+00019b70: 790a 2020 2020 7b0a 2020 2020 2020 2020  y.    {.        
+00019b80: 2274 7970 6522 3a20 226d 2e72 6f6f 6d2e  "type": "m.room.
+00019b90: 6d65 7373 6167 6522 2c0a 2020 2020 2020  message",.      
+00019ba0: 2020 2273 656e 6465 7222 3a20 2240 736f    "sender": "@so
+00019bb0: 6d65 7573 6572 3a65 7861 6d70 6c65 2e63  meuser:example.c
+00019bc0: 6f6d 222c 0a20 2020 2020 2020 2022 636f  om",.        "co
+00019bd0: 6e74 656e 7422 3a20 7b0a 2020 2020 2020  ntent": {.      
+00019be0: 2020 2020 2020 2262 6f64 7922 3a20 2273        "body": "s
+00019bf0: 6f6d 6569 6d61 6765 2e6a 7067 222c 0a20  omeimage.jpg",. 
+00019c00: 2020 2020 2020 2020 2020 2022 696e 666f             "info
+00019c10: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+00019c20: 2020 2020 2022 7369 7a65 223a 2035 3432       "size": 542
+00019c30: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00019c40: 2020 2022 6d69 6d65 7479 7065 223a 2022     "mimetype": "
+00019c50: 696d 6167 652f 6a70 6567 222c 0a20 2020  image/jpeg",.   
+00019c60: 2020 2020 2020 2020 2020 2020 2022 7468               "th
+00019c70: 756d 626e 6169 6c5f 696e 666f 223a 207b  umbnail_info": {
+00019c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019c90: 2020 2020 2022 7722 3a20 3130 302c 0a20       "w": 100,. 
+00019ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cb0: 2020 2022 6822 3a20 3130 302c 0a20 2020     "h": 100,.   
+00019cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cd0: 2022 6d69 6d65 7479 7065 223a 2022 696d   "mimetype": "im
+00019ce0: 6167 652f 6a70 6567 222c 0a20 2020 2020  age/jpeg",.     
+00019cf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00019d00: 7369 7a65 223a 2032 3130 360a 2020 2020  size": 2106.    
+00019d10: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00019d20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00019d30: 7722 3a20 3130 302c 0a20 2020 2020 2020  w": 100,.       
+00019d40: 2020 2020 2020 2020 2022 6822 3a20 3130           "h": 10
+00019d50: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00019d60: 2020 2022 7468 756d 626e 6169 6c5f 7572     "thumbnail_ur
+00019d70: 6c22 3a20 226d 7863 3a2f 2f65 7861 6d70  l": "mxc://examp
+00019d80: 6c65 2e63 6f6d 2f53 6f6d 6553 7472 616e  le.com/SomeStran
+00019d90: 6765 5468 756d 626e 6169 6c55 7269 4b65  geThumbnailUriKe
+00019da0: 7922 0a20 2020 2020 2020 2020 2020 207d  y".            }
+00019db0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00019dc0: 7367 7479 7065 223a 2022 6d2e 696d 6167  sgtype": "m.imag
+00019dd0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00019de0: 2275 726c 223a 2022 6d78 633a 2f2f 6578  "url": "mxc://ex
+00019df0: 616d 706c 652e 636f 6d2f 536f 6d65 5374  ample.com/SomeSt
+00019e00: 7261 6e67 6555 7269 4b65 7922 0a20 2020  rangeUriKey".   
+00019e10: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00019e20: 226f 7269 6769 6e5f 7365 7276 6572 5f74  "origin_server_t
+00019e30: 7322 3a20 3132 3334 3536 3738 3930 3132  s": 123456789012
+00019e40: 3334 3537 362c 0a20 2020 2020 2020 2022  34576,.        "
+00019e50: 756e 7369 676e 6564 223a 207b 0a20 2020  unsigned": {.   
+00019e60: 2020 2020 2020 2020 2022 6167 6522 3a20           "age": 
+00019e70: 3236 380a 2020 2020 2020 2020 7d2c 0a20  268.        },. 
+00019e80: 2020 2020 2020 2022 6576 656e 745f 6964         "event_id
+00019e90: 223a 2022 2473 6b64 6847 4a4b 6867 7972  ": "$skdhGJKhgyr
+00019ea0: 3534 3836 3534 5954 7237 3635 5969 7935  548654YTr765Yiy5
+00019eb0: 3854 5952 222c 0a20 2020 2020 2020 2022  8TYR",.        "
+00019ec0: 726f 6f6d 5f69 6422 3a20 2221 4a4b 4867  room_id": "!JKHg
+00019ed0: 7948 4766 7974 4847 466a 6867 6659 3a65  yHGfytHGFjhgfY:e
+00019ee0: 7861 6d70 6c65 2e63 6f6d 220a 2020 2020  xample.com".    
+00019ef0: 7d0a 0a20 2020 2022 2222 0a20 2020 2069  }..    """.    i
+00019f00: 6620 6e6f 7420 726f 6f6d 733a 0a20 2020  f not rooms:.   
+00019f10: 2020 2020 2067 732e 6c6f 672e 7761 726e       gs.log.warn
+00019f20: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00019f30: 2022 5731 3031 3a20 220a 2020 2020 2020   "W101: ".      
+00019f40: 2020 2020 2020 224e 6f20 726f 6f6d 7320        "No rooms 
+00019f50: 6172 6520 6769 7665 6e2e 2054 6869 7320  are given. This 
+00019f60: 7368 6f75 6c64 206e 6f74 2068 6170 7065  should not happe
+00019f70: 6e2e 2022 0a20 2020 2020 2020 2020 2020  n. ".           
+00019f80: 2022 4d61 7962 6520 796f 7572 2044 4d20   "Maybe your DM 
+00019f90: 726f 6f6d 7320 7370 6563 6966 6965 6420  rooms specified 
+00019fa0: 7669 6120 2d2d 7573 6572 2077 6572 6520  via --user were 
+00019fb0: 6e6f 7420 666f 756e 642e 2022 0a20 2020  not found. ".   
+00019fc0: 2020 2020 2020 2020 2022 5468 6973 2069           "This i
+00019fd0: 6d61 6765 2069 7320 6265 696e 6720 6472  mage is being dr
+00019fe0: 6f70 7065 6420 616e 6420 4e4f 5420 7365  opped and NOT se
+00019ff0: 6e74 2e22 0a20 2020 2020 2020 2029 0a20  nt.".        ). 
+0001a000: 2020 2020 2020 2067 732e 7761 726e 5f63         gs.warn_c
+0001a010: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+0001a020: 2020 7265 7475 726e 0a0a 2020 2020 2320    return..    # 
+0001a030: 686f 7720 746f 2074 7265 6174 2070 6970  how to treat pip
+0001a040: 6520 6f6e 2073 7464 696e 3f0a 2020 2020  e on stdin?.    
+0001a050: 2320 6169 6f66 696c 6573 2e6f 7065 6e28  # aiofiles.open(
+0001a060: 7379 732e 7374 6469 6e2c 2022 722b 6222  sys.stdin, "r+b"
+0001a070: 2920 646f 6573 206e 6f74 2077 6f72 6b2c  ) does not work,
+0001a080: 2077 726f 6e67 2074 7970 652e 0a20 2020   wrong type..   
+0001a090: 2023 2061 696f 6669 6c65 732e 6f70 656e   # aiofiles.open
+0001a0a0: 2873 7973 2e73 7464 696e 2e62 7566 6665  (sys.stdin.buffe
+0001a0b0: 722c 2022 722b 6222 2920 646f 6573 206e  r, "r+b") does n
+0001a0c0: 6f74 2077 6f72 6b2c 2077 726f 6e67 2074  ot work, wrong t
+0001a0d0: 7970 652e 0a20 2020 2023 2061 696f 6669  ype..    # aiofi
+0001a0e0: 6c65 732e 6f70 656e 2827 2f64 6576 2f73  les.open('/dev/s
+0001a0f0: 7464 696e 272c 206d 6f64 653d 2772 6227  tdin', mode='rb'
+0001a100: 2920 6661 696c 7320 7769 7468 2065 7272  ) fails with err
+0001a110: 6f72 3a0a 2020 2020 2320 2020 2069 6f2e  or:.    #    io.
+0001a120: 556e 7375 7070 6f72 7465 644f 7065 7261  UnsupportedOpera
+0001a130: 7469 6f6e 3a20 4669 6c65 206f 7220 7374  tion: File or st
+0001a140: 7265 616d 2069 7320 6e6f 7420 7365 656b  ream is not seek
+0001a150: 6162 6c65 0a20 2020 2023 2073 7464 696e  able.    # stdin
+0001a160: 2c20 5f20 3d20 6177 6169 7420 6169 6f63  , _ = await aioc
+0001a170: 6f6e 736f 6c65 2e67 6574 5f73 7461 6e64  onsole.get_stand
+0001a180: 6172 645f 7374 7265 616d 7328 2920 616c  ard_streams() al
+0001a190: 736f 2066 6169 6c65 730a 2020 2020 2320  so failes.    # 
+0001a1a0: 4865 6e63 6520 4920 7365 6520 6e6f 2077  Hence I see no w
+0001a1b0: 6179 2074 6f20 6469 7265 6374 6c79 2068  ay to directly h
+0001a1c0: 616e 6420 7374 6469 6e20 746f 2061 696f  and stdin to aio
+0001a1d0: 6669 6c65 732e 0a20 2020 2023 2050 726f  files..    # Pro
+0001a1e0: 626c 656d 3a20 4920 6361 6e6e 6f74 2063  blem: I cannot c
+0001a1f0: 6f6d 6269 6e65 2074 6865 2033 2074 6869  ombine the 3 thi
+0001a200: 6e67 733a 0a20 2020 2023 2020 2020 7374  ngs:.    #    st
+0001a210: 6469 6e20 2b20 6169 6f66 696c 6573 202b  din + aiofiles +
+0001a220: 206e 696f 2e41 7379 6e63 436c 6965 6e74   nio.AsyncClient
+0001a230: 2e75 706c 6f61 6428 290a 2020 2020 2320  .upload().    # 
+0001a240: 5369 6e63 6520 4920 636f 756c 6420 6e6f  Since I could no
+0001a250: 7420 6f76 6572 636f 6d65 2074 6869 7320  t overcome this 
+0001a260: 7072 6f62 6c65 6d20 4920 6765 6e65 7261  problem I genera
+0001a270: 7465 2061 2074 656d 706f 7261 7279 2066  te a temporary f
+0001a280: 696c 650a 0a20 2020 2069 6620 696d 6167  ile..    if imag
+0001a290: 6520 3d3d 2022 2d22 3a20 2023 202d 206d  e == "-":  # - m
+0001a2a0: 6561 6e73 2072 6561 6420 6173 2070 6970  eans read as pip
+0001a2b0: 6520 6672 6f6d 2073 7464 696e 0a20 2020  e from stdin.   
+0001a2c0: 2020 2020 2069 7350 6970 6520 3d20 5472       isPipe = Tr
+0001a2d0: 7565 0a20 2020 2020 2020 2066 696e 5f62  ue.        fin_b
+0001a2e0: 7566 203d 2073 7973 2e73 7464 696e 2e62  uf = sys.stdin.b
+0001a2f0: 7566 6665 722e 7265 6164 2829 0a20 2020  uffer.read().   
+0001a300: 2020 2020 206c 656e 5f66 696e 5f62 7566       len_fin_buf
+0001a310: 203d 206c 656e 2866 696e 5f62 7566 290a   = len(fin_buf).
+0001a320: 2020 2020 2020 2020 696d 6167 6520 3d20          image = 
+0001a330: 226d 632d 2220 2b20 7374 7228 7575 6964  "mc-" + str(uuid
+0001a340: 2e75 7569 6434 2829 2920 2b20 222e 746d  .uuid4()) + ".tm
+0001a350: 7022 0a20 2020 2020 2020 2067 732e 6c6f  p".        gs.lo
+0001a360: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0001a370: 2020 2020 2066 227b 6c65 6e5f 6669 6e5f       f"{len_fin_
+0001a380: 6275 667d 2062 7974 6573 206f 6620 696d  buf} bytes of im
+0001a390: 6167 6520 6461 7461 2072 6561 6420 6672  age data read fr
+0001a3a0: 6f6d 2073 7464 696e 2e20 220a 2020 2020  om stdin. ".    
+0001a3b0: 2020 2020 2020 2020 6627 5465 6d70 6f72          f'Tempor
+0001a3c0: 6172 7920 6669 6c65 2022 7b69 6d61 6765  ary file "{image
+0001a3d0: 7d22 2077 6173 2063 7265 6174 6564 2066  }" was created f
+0001a3e0: 6f72 2069 6d61 6765 2e27 0a20 2020 2020  or image.'.     
+0001a3f0: 2020 2029 0a20 2020 2020 2020 2066 6f75     ).        fou
+0001a400: 7420 3d20 6f70 656e 2869 6d61 6765 2c20  t = open(image, 
+0001a410: 2277 6222 290a 2020 2020 2020 2020 666f  "wb").        fo
+0001a420: 7574 2e77 7269 7465 2866 696e 5f62 7566  ut.write(fin_buf
+0001a430: 290a 2020 2020 2020 2020 666f 7574 2e63  ).        fout.c
+0001a440: 6c6f 7365 2829 0a20 2020 2065 6c73 653a  lose().    else:
+0001a450: 0a20 2020 2020 2020 2069 7350 6970 6520  .        isPipe 
+0001a460: 3d20 4661 6c73 650a 0a20 2020 2069 6620  = False..    if 
+0001a470: 6e6f 7420 6f73 2e70 6174 682e 6973 6669  not os.path.isfi
+0001a480: 6c65 2869 6d61 6765 293a 0a20 2020 2020  le(image):.     
+0001a490: 2020 2067 732e 6c6f 672e 7761 726e 696e     gs.log.warnin
+0001a4a0: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
+0001a4b0: 5731 3032 3a20 220a 2020 2020 2020 2020  W102: ".        
+0001a4c0: 2020 2020 6622 496d 6167 6520 6669 6c65      f"Image file
+0001a4d0: 207b 696d 6167 657d 2069 7320 6e6f 7420   {image} is not 
+0001a4e0: 6120 6669 6c65 2e20 446f 6573 6e27 7420  a file. Doesn't 
+0001a4f0: 6578 6973 7420 6f72 2022 0a20 2020 2020  exist or ".     
+0001a500: 2020 2020 2020 2022 6973 2061 2064 6972         "is a dir
+0001a510: 6563 746f 7279 2e20 220a 2020 2020 2020  ectory. ".      
+0001a520: 2020 2020 2020 2254 6869 7320 696d 6167        "This imag
+0001a530: 6520 6973 2062 6569 6e67 2064 726f 7070  e is being dropp
+0001a540: 6564 2061 6e64 204e 4f54 2073 656e 742e  ed and NOT sent.
+0001a550: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0001a560: 2020 2020 6773 2e77 6172 6e5f 636f 756e      gs.warn_coun
+0001a570: 7420 2b3d 2031 0a20 2020 2020 2020 2072  t += 1.        r
+0001a580: 6574 7572 6e0a 0a20 2020 2023 2022 626d  eturn..    # "bm
+0001a590: 7022 2c20 2267 6966 222c 2022 6a70 6722  p", "gif", "jpg"
+0001a5a0: 2c20 226a 7065 6722 2c20 2270 6e67 222c  , "jpeg", "png",
+0001a5b0: 2022 7062 6d22 2c20 2270 676d 222c 2022   "pbm", "pgm", "
+0001a5c0: 7070 6d22 2c20 2278 626d 222c 2022 7870  ppm", "xbm", "xp
+0001a5d0: 6d22 2c0a 2020 2020 2320 2274 6966 6622  m",.    # "tiff"
+0001a5e0: 2c20 2277 6562 7022 2c20 2273 7667 222c  , "webp", "svg",
+0001a5f0: 0a0a 2020 2020 2320 7376 6720 6669 6c65  ..    # svg file
+0001a600: 7320 6172 6520 6e6f 7420 7368 6f77 6e20  s are not shown 
+0001a610: 696e 2045 6c65 6d65 6e74 2c20 6865 6e63  in Element, henc
+0001a620: 6520 7365 6e64 2053 5647 2066 696c 6573  e send SVG files
+0001a630: 2061 7320 6669 6c65 7320 7769 7468 202d   as files with -
+0001a640: 660a 2020 2020 6966 206e 6f74 2069 7350  f.    if not isP
+0001a650: 6970 6520 616e 6420 6e6f 7420 7265 2e6d  ipe and not re.m
+0001a660: 6174 6368 280a 2020 2020 2020 2020 225e  atch(.        "^
+0001a670: 2e6a 7067 247c 5e2e 6a70 6567 247c 5e2e  .jpg$|^.jpeg$|^.
+0001a680: 6769 6624 7c5e 2e70 6e67 247c 5e2e 7376  gif$|^.png$|^.sv
+0001a690: 6724 222c 0a20 2020 2020 2020 206f 732e  g$",.        os.
+0001a6a0: 7061 7468 2e73 706c 6974 6578 7428 696d  path.splitext(im
+0001a6b0: 6167 6529 5b31 5d2e 6c6f 7765 7228 292c  age)[1].lower(),
+0001a6c0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0001a6d0: 6773 2e6c 6f67 2e77 6172 6e69 6e67 280a  gs.log.warning(.
+0001a6e0: 2020 2020 2020 2020 2020 2020 2257 3130              "W10
+0001a6f0: 333a 2022 0a20 2020 2020 2020 2020 2020  3: ".           
+0001a700: 2066 2249 6d61 6765 2066 696c 6520 7b69   f"Image file {i
+0001a710: 6d61 6765 7d20 6973 206e 6f74 2061 6e20  mage} is not an 
+0001a720: 696d 6167 6520 6669 6c65 2e20 5368 6f75  image file. Shou
+0001a730: 6c64 2062 6520 220a 2020 2020 2020 2020  ld be ".        
+0001a740: 2020 2020 222e 6a70 672c 202e 6a70 6567      ".jpg, .jpeg
+0001a750: 2c20 2e67 6966 2c20 6f72 202e 706e 672e  , .gif, or .png.
+0001a760: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+0001a770: 2246 6f75 6e64 205b 7b6f 732e 7061 7468  "Found [{os.path
+0001a780: 2e73 706c 6974 6578 7428 696d 6167 6529  .splitext(image)
+0001a790: 5b31 5d2e 6c6f 7765 7228 297d 5d2e 2022  [1].lower()}]. "
+0001a7a0: 0a20 2020 2020 2020 2020 2020 2022 5468  .            "Th
+0001a7b0: 6973 2069 6d61 6765 2069 7320 6265 696e  is image is bein
+0001a7c0: 6720 6472 6f70 7065 6420 616e 6420 4e4f  g dropped and NO
+0001a7d0: 5420 7365 6e74 2e22 0a20 2020 2020 2020  T sent.".       
+0001a7e0: 2029 0a20 2020 2020 2020 2067 732e 7761   ).        gs.wa
+0001a7f0: 726e 5f63 6f75 6e74 202b 3d20 310a 2020  rn_count += 1.  
+0001a800: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0001a810: 2020 2320 2761 7070 6c69 6361 7469 6f6e    # 'application
+0001a820: 2f70 6466 2720 2269 6d61 6765 2f6a 7065  /pdf' "image/jpe
+0001a830: 6722 0a20 2020 2023 2073 7667 206d 696d  g".    # svg mim
+0001a840: 652d 7479 7065 2069 7320 2269 6d61 6765  e-type is "image
+0001a850: 2f73 7667 2b78 6d6c 220a 2020 2020 6d69  /svg+xml".    mi
+0001a860: 6d65 5f74 7970 6520 3d20 6d61 6769 632e  me_type = magic.
+0001a870: 6672 6f6d 5f66 696c 6528 696d 6167 652c  from_file(image,
+0001a880: 206d 696d 653d 5472 7565 290a 2020 2020   mime=True).    
+0001a890: 6773 2e6c 6f67 2e64 6562 7567 2866 2249  gs.log.debug(f"I
+0001a8a0: 6d61 6765 2066 696c 6520 6d69 6d65 2d74  mage file mime-t
+0001a8b0: 7970 6520 6973 207b 6d69 6d65 5f74 7970  ype is {mime_typ
+0001a8c0: 657d 2229 0a20 2020 2069 6620 6e6f 7420  e}").    if not 
+0001a8d0: 6d69 6d65 5f74 7970 652e 7374 6172 7473  mime_type.starts
+0001a8e0: 7769 7468 2822 696d 6167 652f 2229 3a0a  with("image/"):.
+0001a8f0: 2020 2020 2020 2020 6773 2e6c 6f67 2e77          gs.log.w
+0001a900: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+0001a910: 2020 2020 2257 3130 343a 2022 0a20 2020      "W104: ".   
+0001a920: 2020 2020 2020 2020 2066 2249 6d61 6765           f"Image
+0001a930: 2066 696c 6520 7b69 6d61 6765 7d20 646f   file {image} do
+0001a940: 6573 206e 6f74 2068 6176 6520 616e 2069  es not have an i
+0001a950: 6d61 6765 206d 696d 6520 7479 7065 2e20  mage mime type. 
+0001a960: 220a 2020 2020 2020 2020 2020 2020 2253  ".            "S
+0001a970: 686f 756c 6420 6265 2073 6f6d 6574 6869  hould be somethi
+0001a980: 6e67 206c 696b 6520 696d 6167 652f 6a70  ng like image/jp
+0001a990: 6567 2e20 220a 2020 2020 2020 2020 2020  eg. ".          
+0001a9a0: 2020 6622 466f 756e 6420 6d69 6d65 2074    f"Found mime t
+0001a9b0: 7970 6520 7b6d 696d 655f 7479 7065 7d2e  ype {mime_type}.
+0001a9c0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0001a9d0: 5468 6973 2069 6d61 6765 2069 7320 6265  This image is be
+0001a9e0: 696e 6720 6472 6f70 7065 6420 616e 6420  ing dropped and 
+0001a9f0: 4e4f 5420 7365 6e74 2e22 0a20 2020 2020  NOT sent.".     
+0001aa00: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
+0001aa10: 7761 726e 5f63 6f75 6e74 202b 3d20 310a  warn_count += 1.
+0001aa20: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+0001aa30: 2020 2020 6966 206d 696d 655f 7479 7065      if mime_type
+0001aa40: 2e73 7461 7274 7377 6974 6828 2269 6d61  .startswith("ima
+0001aa50: 6765 2f73 7667 2229 3a0a 2020 2020 2020  ge/svg"):.      
+0001aa60: 2020 6773 2e6c 6f67 2e77 6172 6e69 6e67    gs.log.warning
+0001aa70: 280a 2020 2020 2020 2020 2020 2020 2257  (.            "W
+0001aa80: 3130 353a 2022 0a20 2020 2020 2020 2020  105: ".         
+0001aa90: 2020 2022 5468 6572 6520 6973 2061 2062     "There is a b
+0001aaa0: 7567 2069 6e20 456c 656d 656e 7420 7072  ug in Element pr
+0001aab0: 6576 656e 7469 6e67 2070 7265 7669 6577  eventing preview
+0001aac0: 7320 6f66 2053 5647 2069 6d61 6765 732e  s of SVG images.
+0001aad0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0001aae0: 416c 7465 726e 6174 6976 656c 7920 796f  Alternatively yo
+0001aaf0: 7520 6d61 7920 7365 6e64 2053 5647 2066  u may send SVG f
+0001ab00: 696c 6573 2061 7320 6669 6c65 7320 7669  iles as files vi
+0001ab10: 6120 2d66 2e22 0a20 2020 2020 2020 2029  a -f.".        )
+0001ab20: 0a20 2020 2020 2020 2077 6964 7468 203d  .        width =
+0001ab30: 2031 3030 2020 2320 696e 2070 6978 656c   100  # in pixel
+0001ab40: 0a20 2020 2020 2020 2068 6569 6768 7420  .        height 
+0001ab50: 3d20 3130 300a 2020 2020 2020 2020 2320  = 100.        # 
+0001ab60: 5079 7468 6f6e 2062 6c75 7268 6173 6820  Python blurhash 
+0001ab70: 7061 636b 6167 6520 646f 6573 206e 6f74  package does not
+0001ab80: 2077 6f72 6b20 6f6e 2053 5647 0a20 2020   work on SVG.   
+0001ab90: 2020 2020 2023 2062 6c75 7268 6173 683a       # blurhash:
+0001aba0: 2073 6f6d 6520 7261 6e64 6f6d 2063 6f6c   some random col
+0001abb0: 6f72 6675 6c20 696d 6167 650a 2020 2020  orful image.    
+0001abc0: 2020 2020 626c 7572 6861 7368 203d 2022      blurhash = "
+0001abd0: 554c 485f 433a 3048 4746 7d42 2e24 6b3a  ULH_C:0HGF}B.$k:
+0001abe0: 504c 5647 387a 7d24 343b 6f3f 7e49 513a  PLVG8z}$4;o?~IQ:
+0001abf0: 3924 7942 220a 2020 2020 2020 2020 626c  9$yB".        bl
+0001ac00: 7572 6861 7368 203d 204e 6f6e 6520 2023  urhash = None  #
+0001ac10: 2073 686f 7773 2074 7572 6e69 6e67 2063   shows turning c
+0001ac20: 6972 636c 6520 666f 7265 7665 7220 696e  ircle forever in
+0001ac30: 2045 6c65 6d65 6e74 2064 7565 2074 6f20   Element due to 
+0001ac40: 6275 670a 2020 2020 656c 7365 3a0a 2020  bug.    else:.  
+0001ac50: 2020 2020 2020 696d 203d 2049 6d61 6765        im = Image
+0001ac60: 2e6f 7065 6e28 696d 6167 6529 2020 2320  .open(image)  # 
+0001ac70: 7468 6973 2077 696c 6c20 6661 696c 2066  this will fail f
+0001ac80: 6f72 2053 5647 2066 696c 6573 0a20 2020  or SVG files.   
+0001ac90: 2020 2020 2028 7769 6474 682c 2068 6569       (width, hei
+0001aca0: 6768 7429 203d 2069 6d2e 7369 7a65 2020  ght) = im.size  
+0001acb0: 2320 696d 2e73 697a 6520 7265 7475 726e  # im.size return
+0001acc0: 7320 2877 6964 7468 2c68 6569 6768 7429  s (width,height)
+0001acd0: 2074 7570 6c65 0a20 2020 2020 2020 2062   tuple.        b
+0001ace0: 6c75 7268 6173 6820 3d20 4e6f 6e65 0a0a  lurhash = None..
+0001acf0: 2020 2020 2320 6669 7273 7420 646f 2061      # first do a
+0001ad00: 6e20 7570 6c6f 6164 206f 6620 696d 6167  n upload of imag
+0001ad10: 652c 2073 6565 2075 706c 6f61 6428 2920  e, see upload() 
+0001ad20: 646f 6375 6d65 6e74 6174 696f 6e0a 2020  documentation.  
+0001ad30: 2020 2320 6874 7470 3a2f 2f6d 6174 7269    # http://matri
+0001ad40: 782d 6e69 6f2e 7265 6164 7468 6564 6f63  x-nio.readthedoc
+0001ad50: 732e 696f 2f65 6e2f 6c61 7465 7374 2f6e  s.io/en/latest/n
+0001ad60: 696f 2e68 746d 6c23 6e69 6f2e 4173 796e  io.html#nio.Asyn
+0001ad70: 6343 6c69 656e 742e 7570 6c6f 6164 0a20  cClient.upload. 
+0001ad80: 2020 2023 2074 6865 6e20 7365 6e64 2055     # then send U
+0001ad90: 5249 206f 6620 7570 6c6f 6164 2074 6f20  RI of upload to 
+0001ada0: 726f 6f6d 0a20 2020 2023 204e 6f74 6520  room.    # Note 
+0001adb0: 7468 6174 2065 6e63 7279 7074 6564 2075  that encrypted u
+0001adc0: 706c 6f61 6420 776f 726b 7320 6576 656e  pload works even
+0001add0: 2077 6974 6820 756e 656e 6372 7970 7465   with unencrypte
+0001ade0: 642f 706c 6169 6e20 726f 6f6d 733b 2074  d/plain rooms; t
+0001adf0: 6865 0a20 2020 2023 2064 6563 7279 7074  he.    # decrypt
+0001ae00: 696f 6e20 6b65 7973 2077 696c 6c20 6e6f  ion keys will no
+0001ae10: 7420 6265 2070 726f 7465 6374 6564 2c20  t be protected, 
+0001ae20: 6f62 7669 6f75 736c 792c 2062 7574 206e  obviously, but n
+0001ae30: 6f20 7370 6563 6961 6c0a 2020 2020 2320  o special.    # 
+0001ae40: 7472 6561 746d 656e 7420 6973 2072 6571  treatment is req
+0001ae50: 7569 7265 642e 0a0a 2020 2020 6669 6c65  uired...    file
+0001ae60: 5f73 7461 7420 3d20 6177 6169 7420 6169  _stat = await ai
+0001ae70: 6f66 696c 6573 2e6f 732e 7374 6174 2869  ofiles.os.stat(i
+0001ae80: 6d61 6765 290a 2020 2020 6173 796e 6320  mage).    async 
+0001ae90: 7769 7468 2061 696f 6669 6c65 732e 6f70  with aiofiles.op
+0001aea0: 656e 2869 6d61 6765 2c20 2272 2b62 2229  en(image, "r+b")
+0001aeb0: 2061 7320 663a 0a20 2020 2020 2020 2072   as f:.        r
+0001aec0: 6573 702c 2064 6563 7279 7074 696f 6e5f  esp, decryption_
+0001aed0: 6b65 7973 203d 2061 7761 6974 2063 6c69  keys = await cli
+0001aee0: 656e 742e 7570 6c6f 6164 280a 2020 2020  ent.upload(.    
+0001aef0: 2020 2020 2020 2020 662c 0a20 2020 2020          f,.     
+0001af00: 2020 2020 2020 2063 6f6e 7465 6e74 5f74         content_t
+0001af10: 7970 653d 6d69 6d65 5f74 7970 652c 2020  ype=mime_type,  
+0001af20: 2320 696d 6167 652f 6a70 6567 0a20 2020  # image/jpeg.   
+0001af30: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
+0001af40: 653d 6f73 2e70 6174 682e 6261 7365 6e61  e=os.path.basena
+0001af50: 6d65 2869 6d61 6765 292c 0a20 2020 2020  me(image),.     
+0001af60: 2020 2020 2020 2066 696c 6573 697a 653d         filesize=
+0001af70: 6669 6c65 5f73 7461 742e 7374 5f73 697a  file_stat.st_siz
+0001af80: 652c 0a20 2020 2020 2020 2020 2020 2065  e,.            e
+0001af90: 6e63 7279 7074 3d54 7275 652c 0a20 2020  ncrypt=True,.   
+0001afa0: 2020 2020 2029 0a20 2020 2069 6620 6973       ).    if is
+0001afb0: 696e 7374 616e 6365 2872 6573 702c 2055  instance(resp, U
+0001afc0: 706c 6f61 6452 6573 706f 6e73 6529 3a0a  ploadResponse):.
+0001afd0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0001afe0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0001aff0: 2020 2249 6d61 6765 2077 6173 2075 706c    "Image was upl
+0001b000: 6f61 6465 6420 7375 6363 6573 7366 756c  oaded successful
+0001b010: 6c79 2074 6f20 7365 7276 6572 2e20 220a  ly to server. ".
+0001b020: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
+0001b030: 7370 6f6e 7365 2069 733a 207b 7072 6976  sponse is: {priv
+0001b040: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+0001b050: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+0001b060: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+0001b070: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
+0001b080: 0a20 2020 2020 2020 2020 2020 2066 2254  .            f"T
+0001b090: 6865 2070 726f 6772 616d 207b 5052 4f47  he program {PROG
+0001b0a0: 5f57 4954 485f 4558 547d 2066 6169 6c65  _WITH_EXT} faile
+0001b0b0: 6420 746f 2075 706c 6f61 642e 2022 0a20  d to upload. ". 
+0001b0c0: 2020 2020 2020 2020 2020 2022 506c 6561             "Plea
+0001b0d0: 7365 2072 6574 7279 2e20 5468 6973 2063  se retry. This c
+0001b0e0: 6f75 6c64 2062 6520 7465 6d70 6f72 6172  ould be temporar
+0001b0f0: 7920 6973 7375 6520 6f6e 2022 0a20 2020  y issue on ".   
+0001b100: 2020 2020 2020 2020 2022 796f 7572 2073           "your s
+0001b110: 6572 7665 722e 2022 0a20 2020 2020 2020  erver. ".       
+0001b120: 2020 2020 2022 536f 7272 792e 220a 2020       "Sorry.".  
+0001b130: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001b140: 6773 2e6c 6f67 2e69 6e66 6f28 0a20 2020  gs.log.info(.   
+0001b150: 2020 2020 2020 2020 2066 2766 696c 653d           f'file=
+0001b160: 227b 696d 6167 657d 223b 206d 696d 655f  "{image}"; mime_
+0001b170: 7479 7065 3d22 7b6d 696d 655f 7479 7065  type="{mime_type
+0001b180: 7d22 3b20 270a 2020 2020 2020 2020 2020  }"; '.          
+0001b190: 2020 6627 6669 6c65 7373 697a 653d 227b    f'filessize="{
+0001b1a0: 6669 6c65 5f73 7461 742e 7374 5f73 697a  file_stat.st_siz
+0001b1b0: 657d 2227 0a20 2020 2020 2020 2020 2020  e}"'.           
+0001b1c0: 2066 2246 6169 6c65 6420 746f 2075 706c   f"Failed to upl
+0001b1d0: 6f61 643a 207b 7072 6976 6163 795f 6669  oad: {privacy_fi
+0001b1e0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+0001b1f0: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
+0001b200: 2023 2054 4f44 4f20 636f 6d70 7574 6520   # TODO compute 
+0001b210: 7468 756d 626e 6169 6c2c 2075 706c 6f61  thumbnail, uploa
+0001b220: 6420 7468 756d 626e 6169 6c20 746f 2053  d thumbnail to S
+0001b230: 6572 7665 720a 2020 2020 2320 544f 444f  erver.    # TODO
+0001b240: 2061 6464 2074 6875 6d62 6e61 696c 2069   add thumbnail i
+0001b250: 6e66 6f20 746f 2060 636f 6e74 656e 7460  nfo to `content`
+0001b260: 0a0a 2020 2020 636f 6e74 656e 7420 3d20  ..    content = 
+0001b270: 7b0a 2020 2020 2020 2020 2262 6f64 7922  {.        "body"
+0001b280: 3a20 6f73 2e70 6174 682e 6261 7365 6e61  : os.path.basena
+0001b290: 6d65 2869 6d61 6765 292c 2020 2320 6465  me(image),  # de
+0001b2a0: 7363 7269 7074 6976 6520 7469 746c 650a  scriptive title.
+0001b2b0: 2020 2020 2020 2020 2269 6e66 6f22 3a20          "info": 
+0001b2c0: 7b0a 2020 2020 2020 2020 2020 2020 2273  {.            "s
+0001b2d0: 697a 6522 3a20 6669 6c65 5f73 7461 742e  ize": file_stat.
+0001b2e0: 7374 5f73 697a 652c 0a20 2020 2020 2020  st_size,.       
+0001b2f0: 2020 2020 2022 6d69 6d65 7479 7065 223a       "mimetype":
+0001b300: 206d 696d 655f 7479 7065 2c0a 2020 2020   mime_type,.    
+0001b310: 2020 2020 2020 2020 2320 2274 6875 6d62          # "thumb
+0001b320: 6e61 696c 5f69 6e66 6f22 3a20 4e6f 6e65  nail_info": None
+0001b330: 2c20 2023 2054 4f44 4f0a 2020 2020 2020  ,  # TODO.      
+0001b340: 2020 2020 2020 2277 223a 2077 6964 7468        "w": width
+0001b350: 2c20 2023 2077 6964 7468 2069 6e20 7069  ,  # width in pi
+0001b360: 7865 6c0a 2020 2020 2020 2020 2020 2020  xel.            
+0001b370: 2268 223a 2068 6569 6768 742c 2020 2320  "h": height,  # 
+0001b380: 6865 6967 6874 2069 6e20 7069 7865 6c0a  height in pixel.
+0001b390: 2020 2020 2020 2020 2020 2020 2320 2274              # "t
+0001b3a0: 6875 6d62 6e61 696c 5f75 726c 223a 204e  humbnail_url": N
+0001b3b0: 6f6e 652c 2020 2320 544f 444f 0a20 2020  one,  # TODO.   
+0001b3c0: 2020 2020 2020 2020 2022 7879 7a2e 616d           "xyz.am
+0001b3d0: 6f72 6761 6e2e 626c 7572 6861 7368 223a  organ.blurhash":
+0001b3e0: 2062 6c75 7268 6173 680a 2020 2020 2020   blurhash.      
+0001b3f0: 2020 2020 2020 2320 2274 6875 6d62 6e61        # "thumbna
+0001b400: 696c 5f66 696c 6522 3a20 4e6f 6e65 2c0a  il_file": None,.
+0001b410: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0001b420: 2020 2022 6d73 6774 7970 6522 3a20 226d     "msgtype": "m
+0001b430: 2e69 6d61 6765 222c 0a20 2020 2020 2020  .image",.       
+0001b440: 2022 6669 6c65 223a 207b 0a20 2020 2020   "file": {.     
+0001b450: 2020 2020 2020 2022 7572 6c22 3a20 7265         "url": re
+0001b460: 7370 2e63 6f6e 7465 6e74 5f75 7269 2c0a  sp.content_uri,.
+0001b470: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+0001b480: 223a 2064 6563 7279 7074 696f 6e5f 6b65  ": decryption_ke
+0001b490: 7973 5b22 6b65 7922 5d2c 0a20 2020 2020  ys["key"],.     
+0001b4a0: 2020 2020 2020 2022 6976 223a 2064 6563         "iv": dec
+0001b4b0: 7279 7074 696f 6e5f 6b65 7973 5b22 6976  ryption_keys["iv
+0001b4c0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0001b4d0: 2268 6173 6865 7322 3a20 6465 6372 7970  "hashes": decryp
+0001b4e0: 7469 6f6e 5f6b 6579 735b 2268 6173 6865  tion_keys["hashe
+0001b4f0: 7322 5d2c 0a20 2020 2020 2020 2020 2020  s"],.           
+0001b500: 2022 7622 3a20 6465 6372 7970 7469 6f6e   "v": decryption
+0001b510: 5f6b 6579 735b 2276 225d 2c0a 2020 2020  _keys["v"],.    
+0001b520: 2020 2020 7d2c 0a20 2020 207d 0a0a 2020      },.    }..  
+0001b530: 2020 6966 2069 7350 6970 653a 0a20 2020    if isPipe:.   
+0001b540: 2020 2020 2023 2072 6d20 7465 6d70 2066       # rm temp f
+0001b550: 696c 650a 2020 2020 2020 2020 6f73 2e72  ile.        os.r
+0001b560: 656d 6f76 6528 696d 6167 6529 0a0a 2020  emove(image)..  
+0001b570: 2020 7472 793a 0a20 2020 2020 2020 2066    try:.        f
+0001b580: 6f72 2072 6f6f 6d5f 6964 2069 6e20 726f  or room_id in ro
+0001b590: 6f6d 733a 0a20 2020 2020 2020 2020 2020  oms:.           
+0001b5a0: 2072 6f6f 6d5f 6964 203d 2061 7761 6974   room_id = await
+0001b5b0: 206d 6170 5f72 6f6f 6d69 6e66 6f5f 746f   map_roominfo_to
+0001b5c0: 5f72 6f6f 6d69 6428 636c 6965 6e74 2c20  _roomid(client, 
+0001b5d0: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
+0001b5e0: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
+0001b5f0: 7420 636c 6965 6e74 2e72 6f6f 6d5f 7365  t client.room_se
+0001b600: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+0001b610: 2020 2020 726f 6f6d 5f69 642c 206d 6573      room_id, mes
+0001b620: 7361 6765 5f74 7970 653d 226d 2e72 6f6f  sage_type="m.roo
+0001b630: 6d2e 6d65 7373 6167 6522 2c20 636f 6e74  m.message", cont
+0001b640: 656e 743d 636f 6e74 656e 740a 2020 2020  ent=content.    
+0001b650: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001b660: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0001b670: 6e63 6528 7265 7370 2c20 526f 6f6d 5365  nce(resp, RoomSe
+0001b680: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
+0001b690: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+0001b6a0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+0001b6b0: 2020 2020 2020 2020 2020 2020 2245 3134              "E14
+0001b6c0: 383a 2022 0a20 2020 2020 2020 2020 2020  8: ".           
+0001b6d0: 2020 2020 2020 2020 2022 726f 6f6d 5f73           "room_s
+0001b6e0: 656e 6420 6661 696c 6564 2077 6974 6820  end failed with 
+0001b6f0: 6572 726f 7220 220a 2020 2020 2020 2020  error ".        
+0001b700: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
+0001b710: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+0001b720: 7472 2872 6573 7029 297d 272e 220a 2020  tr(resp))}'.".  
+0001b730: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b750: 2320 6773 2e65 7272 5f63 6f75 6e74 202b  # gs.err_count +
+0001b760: 3d20 3120 2320 6e6f 7420 6e65 6564 6564  = 1 # not needed
+0001b770: 2c20 7769 6c6c 2072 6169 7365 2065 7863  , will raise exc
+0001b780: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
+0001b790: 2020 2020 2020 2023 2069 6e20 666f 6c6c         # in foll
+0001b7a0: 6f77 696e 6720 6c69 6e65 206f 6620 636f  owing line of co
+0001b7b0: 6465 0a20 2020 2020 2020 2020 2020 2067  de.            g
+0001b7c0: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
+0001b7d0: 2020 2020 2020 2020 2020 2020 6627 5468              f'Th
+0001b7e0: 6973 2069 6d61 6765 2066 696c 6520 7761  is image file wa
+0001b7f0: 7320 7365 6e74 3a20 227b 696d 6167 657d  s sent: "{image}
+0001b800: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+0001b810: 2020 2020 6627 746f 2072 6f6f 6d20 227b      f'to room "{
+0001b820: 7265 7370 2e72 6f6f 6d5f 6964 7d22 2027  resp.room_id}" '
+0001b830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b840: 2066 2761 7320 6576 656e 7420 227b 7265   f'as event "{re
+0001b850: 7370 2e65 7665 6e74 5f69 647d 222e 270a  sp.event_id}".'.
+0001b860: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001b870: 2020 2020 2020 2020 2020 6966 2067 732e            if gs.
+0001b880: 7061 2e70 7269 6e74 5f65 7665 6e74 5f69  pa.print_event_i
+0001b890: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+0001b8a0: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
+0001b8b0: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
+0001b8c0: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
+0001b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8e0: 7465 7874 203d 2066 227b 7265 7370 2e65  text = f"{resp.e
+0001b8f0: 7665 6e74 5f69 647d 7b53 4550 7d7b 7265  vent_id}{SEP}{re
+0001b900: 7370 2e72 6f6f 6d5f 6964 7d7b 5345 507d  sp.room_id}{SEP}
+0001b910: 7b69 6d61 6765 7d22 0a20 2020 2020 2020  {image}".       
+0001b920: 2020 2020 2020 2020 2023 204f 626a 6563           # Objec
+0001b930: 7420 6f66 2074 7970 6520 526f 6f6d 4372  t of type RoomCr
+0001b940: 6561 7465 5265 7370 6f6e 7365 2069 7320  eateResponse is 
+0001b950: 6e6f 7420 4a53 4f4e 0a20 2020 2020 2020  not JSON.       
+0001b960: 2020 2020 2020 2020 2023 2073 6572 6961           # seria
+0001b970: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
+0001b980: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
+0001b990: 6e61 7279 2e0a 2020 2020 2020 2020 2020  nary..          
+0001b9a0: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
+0001b9b0: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
+0001b9c0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0001b9d0: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
+0001b9e0: 2269 6d61 6765 223a 2069 6d61 6765 7d29  "image": image})
+0001b9f0: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
+0001ba00: 6d73 0a20 2020 2020 2020 2020 2020 2020  ms.             
+0001ba10: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
+0001ba20: 6d61 782e 636f 7079 2829 0a20 2020 2020  max.copy().     
+0001ba30: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0001ba40: 2e70 6f70 2822 7472 616e 7370 6f72 745f  .pop("transport_
+0001ba50: 7265 7370 6f6e 7365 2229 0a20 2020 2020  response").     
+0001ba60: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0001ba70: 7370 6563 203d 204e 6f6e 650a 2020 2020  spec = None.    
+0001ba80: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001ba90: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
+0001baa0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+0001bab0: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
+0001bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bad0: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
+0001bae0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0001baf0: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
+0001bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb10: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
+0001bb20: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0001bb30: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
+0001bb40: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
+0001bb50: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001bb60: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+0001bb70: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0001bb80: 2020 2020 2020 2020 6627 5468 6973 2069          f'This i
+0001bb90: 6d61 6765 2066 696c 6520 7761 7320 7365  mage file was se
+0001bba0: 6e74 3a20 227b 696d 6167 657d 2220 270a  nt: "{image}" '.
+0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbc0: 6627 746f 2072 6f6f 6d20 227b 726f 6f6d  f'to room "{room
+0001bbd0: 5f69 647d 222e 2027 0a20 2020 2020 2020  _id}". '.       
+0001bbe0: 2020 2020 2020 2020 2066 2252 6573 706f           f"Respo
+0001bbf0: 6e73 653a 2065 7665 6e74 5f69 643d 7b72  nse: event_id={r
+0001bc00: 6573 702e 6576 656e 745f 6964 7d2c 2072  esp.event_id}, r
+0001bc10: 6f6f 6d5f 6964 3d7b 7265 7370 2e72 6f6f  oom_id={resp.roo
+0001bc20: 6d5f 6964 7d2c 2022 0a20 2020 2020 2020  m_id}, ".       
+0001bc30: 2020 2020 2020 2020 2066 2266 756c 6c20           f"full 
+0001bc40: 7265 7370 6f6e 7365 3a20 7b70 7269 7661  response: {priva
+0001bc50: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+0001bc60: 7370 2929 7d2e 2022 0a20 2020 2020 2020  sp))}. ".       
+0001bc70: 2020 2020 2029 0a20 2020 2065 7863 6570       ).    excep
+0001bc80: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+0001bc90: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+0001bca0: 7228 2245 3134 393a 2022 2066 2249 6d61  r("E149: " f"Ima
+0001bcb0: 6765 2073 656e 6420 6f66 2066 696c 6520  ge send of file 
+0001bcc0: 7b69 6d61 6765 7d20 6661 696c 6564 2e20  {image} failed. 
+0001bcd0: 536f 7272 792e 2229 0a20 2020 2020 2020  Sorry.").       
+0001bce0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+0001bcf0: 2031 0a20 2020 2020 2020 2067 732e 6c6f   1.        gs.lo
+0001bd00: 672e 6465 6275 6728 2248 6572 6520 6973  g.debug("Here is
+0001bd10: 2074 6865 2074 7261 6365 6261 636b 2e5c   the traceback.\
+0001bd20: 6e22 202b 2074 7261 6365 6261 636b 2e66  n" + traceback.f
+0001bd30: 6f72 6d61 745f 6578 6328 2929 0a0a 0a23  ormat_exc())...#
+0001bd40: 2061 6363 6f72 6469 6e67 2074 6f20 6c69   according to li
+0001bd50: 6e74 6572 3a20 6675 6e63 7469 6f6e 2069  nter: function i
+0001bd60: 7320 746f 6f20 636f 6d70 6c65 782c 2043  s too complex, C
+0001bd70: 3930 310a 6173 796e 6320 6465 6620 7365  901.async def se
+0001bd80: 6e64 5f6d 6573 7361 6765 2863 6c69 656e  nd_message(clien
+0001bd90: 742c 2072 6f6f 6d73 2c20 6d65 7373 6167  t, rooms, messag
+0001bda0: 6529 3a20 2023 206e 6f71 613a 2043 3930  e):  # noqa: C90
+0001bdb0: 310a 2020 2020 2222 2250 726f 6365 7373  1.    """Process
+0001bdc0: 206d 6573 7361 6765 2e0a 0a20 2020 2046   message...    F
+0001bdd0: 6f72 6d61 7420 6d65 7373 6167 6520 6163  ormat message ac
+0001bde0: 636f 7264 696e 6720 746f 2069 6e73 7472  cording to instr
+0001bdf0: 7563 7469 6f6e 7320 6672 6f6d 2063 6f6d  uctions from com
+0001be00: 6d61 6e64 206c 696e 6520 6172 6775 6d65  mand line argume
+0001be10: 6e74 732e 0a20 2020 2054 6865 6e20 7365  nts..    Then se
+0001be20: 6e64 2074 6865 206f 6e65 206d 6573 7361  nd the one messa
+0001be30: 6765 2074 6f20 616c 6c20 726f 6f6d 732e  ge to all rooms.
+0001be40: 0a0a 2020 2020 4172 6775 6d65 6e74 733a  ..    Arguments:
+0001be50: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 0a20  .    ---------. 
+0001be60: 2020 2063 6c69 656e 7420 3a20 436c 6965     client : Clie
+0001be70: 6e74 0a20 2020 2072 6f6f 6d73 203a 206c  nt.    rooms : l
+0001be80: 6973 740a 2020 2020 2020 2020 6c69 7374  ist.        list
+0001be90: 206f 6620 726f 6f6d 5f69 642d 730a 2020   of room_id-s.  
+0001bea0: 2020 6d65 7373 6167 6520 3a20 7374 720a    message : str.
+0001beb0: 2020 2020 2020 2020 6d65 7373 6167 6520          message 
+0001bec0: 746f 2073 656e 6420 6173 2072 6561 6420  to send as read 
+0001bed0: 6672 6f6d 202d 6d2c 2070 6970 6520 6f72  from -m, pipe or
+0001bee0: 206b 6579 626f 6172 640a 2020 2020 2020   keyboard.      
+0001bef0: 2020 6d65 7373 6167 6520 6973 2077 6974    message is wit
+0001bf00: 686f 7574 206d 696d 6520 666f 726d 6174  hout mime format
+0001bf10: 7469 6e67 0a0a 2020 2020 2222 220a 2020  ting..    """.  
+0001bf20: 2020 6966 206e 6f74 2072 6f6f 6d73 3a0a    if not rooms:.
+0001bf30: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
+0001bf40: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+0001bf50: 2022 4e6f 2072 6f6f 6d73 2061 7265 2067   "No rooms are g
+0001bf60: 6976 656e 2e20 5468 6973 2073 686f 756c  iven. This shoul
+0001bf70: 6420 6e6f 7420 6861 7070 656e 2e20 220a  d not happen. ".
+0001bf80: 2020 2020 2020 2020 2020 2020 224d 6179              "May
+0001bf90: 6265 2079 6f75 7220 444d 2072 6f6f 6d73  be your DM rooms
+0001bfa0: 2073 7065 6369 6669 6564 2076 6961 202d   specified via -
+0001bfb0: 2d75 7365 7220 7765 7265 206e 6f74 2066  -user were not f
+0001bfc0: 6f75 6e64 2e20 220a 2020 2020 2020 2020  ound. ".        
+0001bfd0: 2020 2020 2254 6869 7320 7465 7874 206d      "This text m
+0001bfe0: 6573 7361 6765 2069 7320 6265 696e 6720  essage is being 
+0001bff0: 6472 6f70 7065 6420 616e 6420 4e4f 5420  dropped and NOT 
+0001c000: 7365 6e74 2e22 0a20 2020 2020 2020 2029  sent.".        )
+0001c010: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+0001c020: 2020 2020 2320 7265 6d6f 7665 206c 6561      # remove lea
+0001c030: 6469 6e67 2041 4e44 2074 7261 696c 696e  ding AND trailin
+0001c040: 6720 6e65 776c 696e 6573 2074 6f20 6265  g newlines to be
+0001c050: 6175 7469 6679 0a20 2020 206d 6573 7361  autify.    messa
+0001c060: 6765 203d 206d 6573 7361 6765 2e73 7472  ge = message.str
+0001c070: 6970 2822 5c6e 2229 0a0a 2020 2020 6966  ip("\n")..    if
+0001c080: 206d 6573 7361 6765 2e73 7472 6970 2829   message.strip()
+0001c090: 203d 3d20 2222 3a0a 2020 2020 2020 2020   == "":.        
+0001c0a0: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+0001c0b0: 2020 2020 2020 2020 2020 2254 6865 206d            "The m
+0001c0c0: 6573 7361 6765 2069 7320 656d 7074 792e  essage is empty.
+0001c0d0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0001c0e0: 5468 6973 206d 6573 7361 6765 2069 7320  This message is 
+0001c0f0: 6265 696e 6720 6472 6f70 7065 6420 616e  being dropped an
+0001c100: 6420 4e4f 5420 7365 6e74 2e22 0a20 2020  d NOT sent.".   
+0001c110: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0001c120: 6574 7572 6e0a 0a20 2020 2069 6620 6773  eturn..    if gs
+0001c130: 2e70 612e 6e6f 7469 6365 3a0a 2020 2020  .pa.notice:.    
+0001c140: 2020 2020 636f 6e74 656e 7420 3d20 7b22      content = {"
+0001c150: 6d73 6774 7970 6522 3a20 226d 2e6e 6f74  msgtype": "m.not
+0001c160: 6963 6522 7d0a 2020 2020 656c 7365 3a0a  ice"}.    else:.
+0001c170: 2020 2020 2020 2020 636f 6e74 656e 7420          content 
+0001c180: 3d20 7b22 6d73 6774 7970 6522 3a20 226d  = {"msgtype": "m
+0001c190: 2e74 6578 7422 7d0a 0a20 2020 2069 6620  .text"}..    if 
+0001c1a0: 6773 2e70 612e 636f 6465 3a0a 2020 2020  gs.pa.code:.    
+0001c1b0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0001c1c0: 2827 5365 6e64 696e 6720 6d65 7373 6167  ('Sending messag
+0001c1d0: 6520 696e 2066 6f72 6d61 7420 2263 6f64  e in format "cod
+0001c1e0: 6522 2e27 290a 2020 2020 2020 2020 666f  e".').        fo
+0001c1f0: 726d 6174 7465 645f 6d65 7373 6167 6520  rmatted_message 
+0001c200: 3d20 223c 7072 653e 3c63 6f64 653e 2220  = "<pre><code>" 
+0001c210: 2b20 6d65 7373 6167 6520 2b20 225c 6e3c  + message + "\n<
+0001c220: 2f63 6f64 653e 3c2f 7072 653e 5c6e 220a  /code></pre>\n".
+0001c230: 2020 2020 2020 2020 636f 6e74 656e 745b          content[
+0001c240: 2266 6f72 6d61 7422 5d20 3d20 226f 7267  "format"] = "org
+0001c250: 2e6d 6174 7269 782e 6375 7374 6f6d 2e68  .matrix.custom.h
+0001c260: 746d 6c22 2020 2320 6164 6420 746f 2064  tml"  # add to d
+0001c270: 6963 740a 2020 2020 2020 2020 636f 6e74  ict.        cont
+0001c280: 656e 745b 2266 6f72 6d61 7474 6564 5f62  ent["formatted_b
+0001c290: 6f64 7922 5d20 3d20 666f 726d 6174 7465  ody"] = formatte
+0001c2a0: 645f 6d65 7373 6167 650a 2020 2020 2020  d_message.      
+0001c2b0: 2020 2320 6e65 7874 206c 696e 653a 2077    # next line: w
+0001c2c0: 6f72 6b2d 6172 6f75 6e64 2066 6f72 2045  ork-around for E
+0001c2d0: 6c65 6d65 6e74 2041 6e64 726f 6964 0a20  lement Android. 
+0001c2e0: 2020 2020 2020 206d 6573 7361 6765 203d         message =
+0001c2f0: 2022 6060 605c 6e22 202b 206d 6573 7361   "```\n" + messa
+0001c300: 6765 202b 2022 5c6e 6060 6022 2020 2320  ge + "\n```"  # 
+0001c310: 746f 2066 6f72 6d61 7420 6974 2061 7320  to format it as 
+0001c320: 636f 6465 0a20 2020 2065 6c69 6620 6773  code.    elif gs
+0001c330: 2e70 612e 6d61 726b 646f 776e 3a0a 2020  .pa.markdown:.  
+0001c340: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0001c350: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0001c360: 2243 6f6e 7665 7274 696e 6720 6d65 7373  "Converting mess
+0001c370: 6167 6520 6672 6f6d 204d 6172 6b44 6f77  age from MarkDow
+0001c380: 6e20 696e 746f 2048 544d 4c2e 2022 0a20  n into HTML. ". 
+0001c390: 2020 2020 2020 2020 2020 2027 5365 6e64             'Send
+0001c3a0: 696e 6720 6d65 7373 6167 6520 696e 2066  ing message in f
+0001c3b0: 6f72 6d61 7420 226d 6172 6b64 6f77 6e22  ormat "markdown"
+0001c3c0: 2e27 0a20 2020 2020 2020 2029 0a20 2020  .'.        ).   
+0001c3d0: 2020 2020 2023 2065 2e67 2e20 636f 6e76       # e.g. conv
+0001c3e0: 6572 7473 2066 726f 6d20 222d 6162 6322  erts from "-abc"
+0001c3f0: 2074 6f20 223c 756c 3e3c 6c69 3e61 6263   to "<ul><li>abc
+0001c400: 3c2f 6c69 3e3c 2f75 6c3e 220a 2020 2020  </li></ul>".    
+0001c410: 2020 2020 666f 726d 6174 7465 645f 6d65      formatted_me
+0001c420: 7373 6167 6520 3d20 6d61 726b 646f 776e  ssage = markdown
+0001c430: 286d 6573 7361 6765 290a 2020 2020 2020  (message).      
+0001c440: 2020 636f 6e74 656e 745b 2266 6f72 6d61    content["forma
+0001c450: 7422 5d20 3d20 226f 7267 2e6d 6174 7269  t"] = "org.matri
+0001c460: 782e 6375 7374 6f6d 2e68 746d 6c22 2020  x.custom.html"  
+0001c470: 2320 6164 6420 746f 2064 6963 740a 2020  # add to dict.  
+0001c480: 2020 2020 2020 636f 6e74 656e 745b 2266        content["f
+0001c490: 6f72 6d61 7474 6564 5f62 6f64 7922 5d20  ormatted_body"] 
+0001c4a0: 3d20 666f 726d 6174 7465 645f 6d65 7373  = formatted_mess
+0001c4b0: 6167 650a 2020 2020 656c 6966 2067 732e  age.    elif gs.
+0001c4c0: 7061 2e68 746d 6c3a 0a20 2020 2020 2020  pa.html:.       
+0001c4d0: 2067 732e 6c6f 672e 6465 6275 6728 2753   gs.log.debug('S
+0001c4e0: 656e 6469 6e67 206d 6573 7361 6765 2069  ending message i
+0001c4f0: 6e20 666f 726d 6174 2022 6874 6d6c 222e  n format "html".
+0001c500: 2729 0a20 2020 2020 2020 2066 6f72 6d61  ').        forma
+0001c510: 7474 6564 5f6d 6573 7361 6765 203d 206d  tted_message = m
+0001c520: 6573 7361 6765 2020 2320 7468 6520 7361  essage  # the sa
+0001c530: 6d65 2066 6f72 2074 6865 2074 696d 6520  me for the time 
+0001c540: 6265 696e 670a 2020 2020 2020 2020 636f  being.        co
+0001c550: 6e74 656e 745b 2266 6f72 6d61 7422 5d20  ntent["format"] 
+0001c560: 3d20 226f 7267 2e6d 6174 7269 782e 6375  = "org.matrix.cu
+0001c570: 7374 6f6d 2e68 746d 6c22 2020 2320 6164  stom.html"  # ad
+0001c580: 6420 746f 2064 6963 740a 2020 2020 2020  d to dict.      
+0001c590: 2020 636f 6e74 656e 745b 2266 6f72 6d61    content["forma
+0001c5a0: 7474 6564 5f62 6f64 7922 5d20 3d20 666f  tted_body"] = fo
+0001c5b0: 726d 6174 7465 645f 6d65 7373 6167 650a  rmatted_message.
+0001c5c0: 2020 2020 656c 6966 2067 732e 7061 2e65      elif gs.pa.e
+0001c5d0: 6d6f 6a69 7a65 3a0a 2020 2020 2020 2020  mojize:.        
+0001c5e0: 6773 2e6c 6f67 2e64 6562 7567 2827 5365  gs.log.debug('Se
+0001c5f0: 6e64 696e 6720 6d65 7373 6167 6520 696e  nding message in
+0001c600: 2066 6f72 6d61 7420 2265 6d6f 6a69 7a65   format "emojize
+0001c610: 6422 2e27 290a 2020 2020 2020 2020 666f  d".').        fo
+0001c620: 726d 6174 7465 645f 6d65 7373 6167 6520  rmatted_message 
+0001c630: 3d20 656d 6f6a 692e 656d 6f6a 697a 6528  = emoji.emojize(
+0001c640: 0a20 2020 2020 2020 2020 2020 206d 6573  .            mes
+0001c650: 7361 6765 0a20 2020 2020 2020 2029 2020  sage.        )  
+0001c660: 2320 636f 6e76 6572 7420 656d 6f6a 6920  # convert emoji 
+0001c670: 7368 6f72 7463 6f64 6573 2069 6620 7072  shortcodes if pr
+0001c680: 6573 656e 740a 2020 2020 2020 2020 636f  esent.        co
+0001c690: 6e74 656e 745b 2266 6f72 6d61 7422 5d20  ntent["format"] 
+0001c6a0: 3d20 226f 7267 2e6d 6174 7269 782e 6375  = "org.matrix.cu
+0001c6b0: 7374 6f6d 2e68 746d 6c22 2020 2320 6164  stom.html"  # ad
+0001c6c0: 6420 746f 2064 6963 740a 2020 2020 2020  d to dict.      
+0001c6d0: 2020 636f 6e74 656e 745b 2266 6f72 6d61    content["forma
+0001c6e0: 7474 6564 5f62 6f64 7922 5d20 3d20 666f  tted_body"] = fo
+0001c6f0: 726d 6174 7465 645f 6d65 7373 6167 650a  rmatted_message.
+0001c700: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001c710: 2020 6773 2e6c 6f67 2e64 6562 7567 2827    gs.log.debug('
+0001c720: 5365 6e64 696e 6720 6d65 7373 6167 6520  Sending message 
+0001c730: 696e 2066 6f72 6d61 7420 2274 6578 7422  in format "text"
+0001c740: 2e27 290a 2020 2020 636f 6e74 656e 745b  .').    content[
+0001c750: 2262 6f64 7922 5d20 3d20 6d65 7373 6167  "body"] = messag
+0001c760: 650a 0a20 2020 2074 7279 3a0a 2020 2020  e..    try:.    
+0001c770: 2020 2020 666f 7220 726f 6f6d 5f69 6420      for room_id 
+0001c780: 696e 2072 6f6f 6d73 3a0a 2020 2020 2020  in rooms:.      
+0001c790: 2020 2020 2020 726f 6f6d 5f69 6420 3d20        room_id = 
+0001c7a0: 6177 6169 7420 6d61 705f 726f 6f6d 696e  await map_roomin
+0001c7b0: 666f 5f74 6f5f 726f 6f6d 6964 2863 6c69  fo_to_roomid(cli
+0001c7c0: 656e 742c 2072 6f6f 6d5f 6964 290a 2020  ent, room_id).  
+0001c7d0: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
+0001c7e0: 2061 7761 6974 2063 6c69 656e 742e 726f   await client.ro
+0001c7f0: 6f6d 5f73 656e 6428 0a20 2020 2020 2020  om_send(.       
+0001c800: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
+0001c810: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c820: 2020 6d65 7373 6167 655f 7479 7065 3d22    message_type="
+0001c830: 6d2e 726f 6f6d 2e6d 6573 7361 6765 222c  m.room.message",
+0001c840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c850: 2063 6f6e 7465 6e74 3d63 6f6e 7465 6e74   content=content
+0001c860: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c870: 2020 6967 6e6f 7265 5f75 6e76 6572 6966    ignore_unverif
+0001c880: 6965 645f 6465 7669 6365 733d 5472 7565  ied_devices=True
+0001c890: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0001c8a0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0001c8b0: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
+0001c8c0: 526f 6f6d 5365 6e64 4572 726f 7229 3a0a  RoomSendError):.
+0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8e0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+0001c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c900: 2020 2245 3135 303a 2022 0a20 2020 2020    "E150: ".     
+0001c910: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001c920: 726f 6f6d 5f73 656e 6420 6661 696c 6564  room_send failed
+0001c930: 2077 6974 6820 6572 726f 7220 220a 2020   with error ".  
+0001c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c950: 2020 6622 277b 7072 6976 6163 795f 6669    f"'{privacy_fi
+0001c960: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+0001c970: 272e 220a 2020 2020 2020 2020 2020 2020  '.".            
+0001c980: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001c990: 2020 2020 2020 2320 6773 2e65 7272 5f63        # gs.err_c
+0001c9a0: 6f75 6e74 202b 3d20 3120 2320 6e6f 7420  ount += 1 # not 
+0001c9b0: 6e65 6564 6564 2c20 7769 6c6c 2072 6169  needed, will rai
+0001c9c0: 7365 2065 7863 6570 7469 6f6e 0a20 2020  se exception.   
+0001c9d0: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+0001c9e0: 6e20 666f 6c6c 6f77 696e 6720 6c69 6e65  n following line
+0001c9f0: 206f 6620 636f 6465 0a20 2020 2020 2020   of code.       
+0001ca00: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+0001ca10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001ca20: 2020 6627 5468 6973 206d 6573 7361 6765    f'This message
+0001ca30: 2077 6173 2073 656e 743a 2022 7b6d 6573   was sent: "{mes
+0001ca40: 7361 6765 7d22 2074 6f20 726f 6f6d 2022  sage}" to room "
+0001ca50: 7b72 6573 702e 726f 6f6d 5f69 647d 2220  {resp.room_id}" 
+0001ca60: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001ca70: 2020 6627 6173 2065 7665 6e74 2022 7b72    f'as event "{r
+0001ca80: 6573 702e 6576 656e 745f 6964 7d22 2e27  esp.event_id}".'
+0001ca90: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001caa0: 2020 2020 2020 2020 2020 2069 6620 6773             if gs
+0001cab0: 2e70 612e 7072 696e 745f 6576 656e 745f  .pa.print_event_
+0001cac0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
+0001cad0: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
+0001cae0: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
+0001caf0: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
+0001cb00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cb10: 2074 6578 7420 3d20 6622 7b72 6573 702e   text = f"{resp.
+0001cb20: 6576 656e 745f 6964 7d7b 5345 507d 7b72  event_id}{SEP}{r
+0001cb30: 6573 702e 726f 6f6d 5f69 647d 7b53 4550  esp.room_id}{SEP
+0001cb40: 7d7b 6d65 7373 6167 657d 220a 2020 2020  }{message}".    
+0001cb50: 2020 2020 2020 2020 2020 2020 2320 4f62              # Ob
+0001cb60: 6a65 6374 206f 6620 7479 7065 2052 6f6f  ject of type Roo
+0001cb70: 6d43 7265 6174 6552 6573 706f 6e73 6520  mCreateResponse 
+0001cb80: 6973 206e 6f74 204a 534f 4e0a 2020 2020  is not JSON.    
+0001cb90: 2020 2020 2020 2020 2020 2020 2320 7365              # se
+0001cba0: 7269 616c 697a 6162 6c65 2c20 6865 6e63  rializable, henc
+0001cbb0: 6520 7765 2075 7365 2074 6865 2064 6963  e we use the dic
+0001cbc0: 7469 6f6e 6172 792e 0a20 2020 2020 2020  tionary..       
+0001cbd0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+0001cbe0: 7820 3d20 7265 7370 2e5f 5f64 6963 745f  x = resp.__dict_
+0001cbf0: 5f0a 2020 2020 2020 2020 2020 2020 2020  _.              
+0001cc00: 2020 6a73 6f6e 5f6d 6178 2e75 7064 6174    json_max.updat
+0001cc10: 6528 7b22 6d65 7373 6167 6522 3a20 6d65  e({"message": me
+0001cc20: 7373 6167 657d 2920 2023 2061 6464 2064  ssage})  # add d
+0001cc30: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
+0001cc40: 2020 2020 2020 2020 2020 6a73 6f6e 5f20            json_ 
+0001cc50: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
+0001cc60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001cc70: 2020 6a73 6f6e 5f2e 706f 7028 2274 7261    json_.pop("tra
+0001cc80: 6e73 706f 7274 5f72 6573 706f 6e73 6522  nsport_response"
+0001cc90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001cca0: 2020 6a73 6f6e 5f73 7065 6320 3d20 4e6f    json_spec = No
+0001ccb0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+0001ccc0: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
+0001ccd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cce0: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
+0001ccf0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0001cd00: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
+0001cd10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001cd20: 2020 2020 2020 6a73 6f6e 5f3d 6a73 6f6e        json_=json
+0001cd30: 5f2c 0a20 2020 2020 2020 2020 2020 2020  _,.             
+0001cd40: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
+0001cd50: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
+0001cd60: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0001cd70: 6f6e 5f73 7065 633d 6a73 6f6e 5f73 7065  on_spec=json_spe
+0001cd80: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+0001cd90: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001cda0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0001cdb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001cdc0: 2754 6869 7320 6d65 7373 6167 6520 7761  'This message wa
+0001cdd0: 7320 7365 6e74 3a20 227b 6d65 7373 6167  s sent: "{messag
+0001cde0: 657d 2220 746f 2072 6f6f 6d20 227b 726f  e}" to room "{ro
+0001cdf0: 6f6d 5f69 647d 222e 2027 0a20 2020 2020  om_id}". '.     
+0001ce00: 2020 2020 2020 2020 2020 2066 2252 6573             f"Res
+0001ce10: 706f 6e73 653a 2065 7665 6e74 5f69 643d  ponse: event_id=
+0001ce20: 7b72 6573 702e 6576 656e 745f 6964 7d2c  {resp.event_id},
+0001ce30: 2072 6f6f 6d5f 6964 3d7b 7265 7370 2e72   room_id={resp.r
+0001ce40: 6f6f 6d5f 6964 7d2c 2022 0a20 2020 2020  oom_id}, ".     
+0001ce50: 2020 2020 2020 2020 2020 2066 2266 756c             f"ful
+0001ce60: 6c20 7265 7370 6f6e 7365 3a20 7b70 7269  l response: {pri
+0001ce70: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+0001ce80: 7265 7370 2929 7d2e 2022 0a20 2020 2020  resp))}. ".     
+0001ce90: 2020 2020 2020 2029 0a20 2020 2065 7863         ).    exc
+0001cea0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+0001ceb0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+0001cec0: 726f 7228 2245 3135 313a 2022 2022 4d65  ror("E151: " "Me
+0001ced0: 7373 6167 6520 7365 6e64 2066 6169 6c65  ssage send faile
+0001cee0: 642e 2053 6f72 7279 2e22 290a 2020 2020  d. Sorry.").    
+0001cef0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+0001cf00: 202b 3d20 310a 2020 2020 2020 2020 6773   += 1.        gs
+0001cf10: 2e6c 6f67 2e64 6562 7567 2822 4865 7265  .log.debug("Here
+0001cf20: 2069 7320 7468 6520 7472 6163 6562 6163   is the tracebac
+0001cf30: 6b2e 5c6e 2220 2b20 7472 6163 6562 6163  k.\n" + tracebac
+0001cf40: 6b2e 666f 726d 6174 5f65 7863 2829 290a  k.format_exc()).
+0001cf50: 0a0a 6173 796e 6320 6465 6620 7374 7265  ..async def stre
+0001cf60: 616d 5f6d 6573 7361 6765 735f 6672 6f6d  am_messages_from
+0001cf70: 5f70 6970 6528 636c 6965 6e74 2c20 726f  _pipe(client, ro
+0001cf80: 6f6d 7329 3a0a 2020 2020 2222 2252 6561  oms):.    """Rea
+0001cf90: 6420 696e 7075 7420 6672 6f6d 2070 6970  d input from pip
+0001cfa0: 6520 6966 2061 7661 696c 6162 6c65 2e0a  e if available..
+0001cfb0: 0a20 2020 2052 6561 6420 7069 7065 206c  .    Read pipe l
+0001cfc0: 696e 6520 6279 206c 696e 652e 2046 6f72  ine by line. For
+0001cfd0: 2065 6163 6820 6c69 6e65 2072 6563 6569   each line recei
+0001cfe0: 7665 642c 2069 6d6d 6564 6961 7465 6c79  ved, immediately
+0001cff0: 0a20 2020 2073 656e 6420 6974 2e0a 0a20  .    send it... 
+0001d000: 2020 2041 7267 756d 656e 7473 3a0a 2020     Arguments:.  
+0001d010: 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020    ---------.    
+0001d020: 636c 6965 6e74 203a 2043 6c69 656e 740a  client : Client.
+0001d030: 2020 2020 726f 6f6d 7320 3a20 6c69 7374      rooms : list
+0001d040: 206f 6620 726f 6f6d 5f69 6473 0a0a 2020   of room_ids..  
+0001d050: 2020 2222 220a 2020 2020 7374 6469 6e5f    """.    stdin_
+0001d060: 7265 6164 7920 3d20 7365 6c65 6374 2e73  ready = select.s
+0001d070: 656c 6563 7428 5b73 7973 2e73 7464 696e  elect([sys.stdin
+0001d080: 2c5d 2c20 5b5d 2c20 5b5d 2c20 302e 3029  ,], [], [], 0.0)
+0001d090: 5b20 2023 206e 6f71 610a 2020 2020 2020  [  # noqa.      
+0001d0a0: 2020 300a 2020 2020 5d20 2023 206e 6f71    0.    ]  # noq
+0001d0b0: 610a 2020 2020 6966 206e 6f74 2073 7464  a.    if not std
+0001d0c0: 696e 5f72 6561 6479 3a0a 2020 2020 2020  in_ready:.      
+0001d0d0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+0001d0e0: 2020 2020 2020 2020 2020 2020 2273 7464              "std
+0001d0f0: 696e 2069 7320 6e6f 7420 7265 6164 7920  in is not ready 
+0001d100: 666f 7220 7374 7265 616d 696e 672e 2022  for streaming. "
+0001d110: 0a20 2020 2020 2020 2020 2020 2022 4120  .            "A 
+0001d120: 7069 7065 2063 6f75 6c64 2062 6520 7573  pipe could be us
+0001d130: 6564 2c20 6275 7420 7069 7065 2063 6f75  ed, but pipe cou
+0001d140: 6c64 2062 6520 656d 7074 792c 2022 0a20  ld be empty, ". 
+0001d150: 2020 2020 2020 2020 2020 2022 7374 6469             "stdi
+0001d160: 6e20 636f 756c 6420 616c 736f 2062 6520  n could also be 
+0001d170: 6120 6b65 7962 6f61 7264 2e22 0a20 2020  a keyboard.".   
+0001d180: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
+0001d190: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+0001d1a0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0001d1b0: 2020 2022 7374 6469 6e20 6973 2072 6561     "stdin is rea
+0001d1c0: 6479 2e20 536f 6d65 7468 696e 6720 220a  dy. Something ".
+0001d1d0: 2020 2020 2020 2020 2020 2020 2269 7320              "is 
+0001d1e0: 6465 6669 6e69 7465 6c79 2070 6970 6564  definitely piped
+0001d1f0: 2069 6e74 6f20 7072 6f67 7261 6d20 6672   into program fr
+0001d200: 6f6d 2073 7464 696e 2e20 220a 2020 2020  om stdin. ".    
+0001d210: 2020 2020 2020 2020 2252 6561 6469 6e67          "Reading
+0001d220: 206d 6573 7361 6765 2066 726f 6d20 7374   message from st
+0001d230: 6469 6e20 7069 7065 2e22 0a20 2020 2020  din pipe.".     
+0001d240: 2020 2029 0a20 2020 2069 6620 2828 6e6f     ).    if ((no
+0001d250: 7420 7374 6469 6e5f 7265 6164 7929 2061  t stdin_ready) a
+0001d260: 6e64 2028 6e6f 7420 7379 732e 7374 6469  nd (not sys.stdi
+0001d270: 6e2e 6973 6174 7479 2829 2929 206f 7220  n.isatty())) or 
+0001d280: 7374 6469 6e5f 7265 6164 793a 0a20 2020  stdin_ready:.   
+0001d290: 2020 2020 2069 6620 6e6f 7420 7379 732e       if not sys.
+0001d2a0: 7374 6469 6e2e 6973 6174 7479 2829 3a0a  stdin.isatty():.
+0001d2b0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0001d2c0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0001d2d0: 2020 2020 2020 2020 2020 2250 6970 6520            "Pipe 
+0001d2e0: 7761 7320 6465 6669 6e69 7465 6c79 2075  was definitely u
+0001d2f0: 7365 642c 2062 7574 2070 6970 6520 6d69  sed, but pipe mi
+0001d300: 6768 7420 6265 2065 6d70 7479 2e20 220a  ght be empty. ".
+0001d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d320: 2254 7279 696e 6720 746f 2072 6561 6420  "Trying to read 
+0001d330: 6672 6f6d 2070 6970 6520 696e 2061 6e79  from pipe in any
+0001d340: 2063 6173 652e 220a 2020 2020 2020 2020   case.".        
+0001d350: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
+0001d360: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
+0001d370: 6f72 206c 696e 6520 696e 2073 7973 2e73  or line in sys.s
+0001d380: 7464 696e 3a0a 2020 2020 2020 2020 2020  tdin:.          
+0001d390: 2020 2020 2020 6177 6169 7420 7365 6e64        await send
+0001d3a0: 5f6d 6573 7361 6765 2863 6c69 656e 742c  _message(client,
+0001d3b0: 2072 6f6f 6d73 2c20 6c69 6e65 290a 2020   rooms, line).  
+0001d3c0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+0001d3d0: 2e6c 6f67 2e64 6562 7567 2822 5573 696e  .log.debug("Usin
+0001d3e0: 6720 6461 7461 2066 726f 6d20 7374 6469  g data from stdi
+0001d3f0: 6e20 7069 7065 2073 7472 6561 6d20 6173  n pipe stream as
+0001d400: 206d 6573 7361 6765 2e22 290a 2020 2020   message.").    
+0001d410: 2020 2020 6578 6365 7074 2045 4f46 4572      except EOFEr
+0001d420: 726f 723a 2020 2320 454f 4620 7768 656e  ror:  # EOF when
+0001d430: 2072 6561 6469 6e67 2061 206c 696e 650a   reading a line.
+0001d440: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0001d450: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0001d460: 2020 2020 2020 2020 2020 2252 6561 6469            "Readi
+0001d470: 6e67 2066 726f 6d20 7374 6469 6e20 7265  ng from stdin re
+0001d480: 7375 6c74 6564 2069 6e20 454f 462e 2054  sulted in EOF. T
+0001d490: 6869 7320 6361 6e20 6861 7070 656e 2022  his can happen "
+0001d4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d4b0: 2022 7768 656e 2061 2070 6970 6520 7761   "when a pipe wa
+0001d4c0: 7320 7573 6564 2c20 6275 7420 7468 6520  s used, but the 
+0001d4d0: 7069 7065 2069 7320 656d 7074 792e 2022  pipe is empty. "
+0001d4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d4f0: 2022 4e6f 206d 6573 7361 6765 2077 696c   "No message wil
+0001d500: 6c20 6265 2067 656e 6572 6174 6564 2e22  l be generated."
+0001d510: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001d520: 2020 2020 2020 2065 7863 6570 7420 556e         except Un
+0001d530: 6963 6f64 6544 6563 6f64 6545 7272 6f72  icodeDecodeError
+0001d540: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+0001d550: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
+0001d560: 2020 2020 2020 2020 2020 2022 5265 6164             "Read
+0001d570: 696e 6720 6672 6f6d 2073 7464 696e 2072  ing from stdin r
+0001d580: 6573 756c 7465 6420 696e 2055 6e69 636f  esulted in Unico
+0001d590: 6465 4465 636f 6465 4572 726f 722e 2054  deDecodeError. T
+0001d5a0: 6869 7320 220a 2020 2020 2020 2020 2020  his ".          
+0001d5b0: 2020 2020 2020 2263 616e 2068 6170 7065        "can happe
+0001d5c0: 6e20 6966 2079 6f75 2074 7279 2074 6f20  n if you try to 
+0001d5d0: 7069 7065 2062 696e 6172 7920 6461 7461  pipe binary data
+0001d5e0: 2066 6f72 2061 2074 6578 7420 220a 2020   for a text ".  
+0001d5f0: 2020 2020 2020 2020 2020 2020 2020 226d                "m
+0001d600: 6573 7361 6765 2e20 466f 7220 6120 7465  essage. For a te
+0001d610: 7874 206d 6573 7361 6765 206f 6e6c 7920  xt message only 
+0001d620: 7069 7065 2074 6578 7420 7669 6120 7374  pipe text via st
+0001d630: 6469 6e2c 2022 0a20 2020 2020 2020 2020  din, ".         
+0001d640: 2020 2020 2020 2022 6e6f 7420 6269 6e61         "not bina
+0001d650: 7279 2064 6174 612e 204e 6f20 6d65 7373  ry data. No mess
+0001d660: 6167 6520 7769 6c6c 2062 6520 6765 6e65  age will be gene
+0001d670: 7261 7465 642e 220a 2020 2020 2020 2020  rated.".        
+0001d680: 2020 2020 290a 0a0a 6465 6620 6765 745f      )...def get_
+0001d690: 6d65 7373 6167 6573 5f66 726f 6d5f 7069  messages_from_pi
+0001d6a0: 7065 2829 202d 3e20 6c69 7374 3a0a 2020  pe() -> list:.  
+0001d6b0: 2020 2222 2252 6561 6420 696e 7075 7420    """Read input 
+0001d6c0: 6672 6f6d 2070 6970 6520 6966 2061 7661  from pipe if ava
+0001d6d0: 696c 6162 6c65 2e0a 0a20 2020 2052 6574  ilable...    Ret
+0001d6e0: 7572 6e20 5b5d 2069 6620 6e6f 2069 6e70  urn [] if no inp
+0001d6f0: 7574 2061 7661 696c 6162 6c65 206f 6e20  ut available on 
+0001d700: 7069 7065 2073 7464 696e 2e0a 2020 2020  pipe stdin..    
+0001d710: 5265 7475 726e 205b 2273 6f6d 652d 6d73  Return ["some-ms
+0001d720: 6722 5d20 6966 2069 6e70 7574 2069 7320  g"] if input is 
+0001d730: 6176 6169 6c62 6c65 2e0a 2020 2020 4d69  availble..    Mi
+0001d740: 6768 7420 616c 736f 2072 6574 7572 6e20  ght also return 
+0001d750: 5b22 225d 206f 6620 636f 7572 7365 2069  [""] of course i
+0001d760: 6620 2222 2077 6173 2069 6e20 7069 7065  f "" was in pipe
+0001d770: 2e0a 2020 2020 4375 7272 656e 746c 7920  ..    Currently 
+0001d780: 7468 6572 6520 6973 2061 7420 6d6f 7374  there is at most
+0001d790: 2031 206d 7367 2069 6e20 7468 6520 7265   1 msg in the re
+0001d7a0: 7475 726e 6564 206c 6973 742e 0a20 2020  turned list..   
+0001d7b0: 2022 2222 0a20 2020 206d 6573 7361 6765   """.    message
+0001d7c0: 7320 3d20 5b5d 0a20 2020 2073 7464 696e  s = [].    stdin
+0001d7d0: 5f72 6561 6479 203d 2073 656c 6563 742e  _ready = select.
+0001d7e0: 7365 6c65 6374 285b 7379 732e 7374 6469  select([sys.stdi
+0001d7f0: 6e2c 5d2c 205b 5d2c 205b 5d2c 2030 2e30  n,], [], [], 0.0
+0001d800: 295b 2020 2320 6e6f 7161 0a20 2020 2020  )[  # noqa.     
+0001d810: 2020 2030 0a20 2020 205d 2020 2320 6e6f     0.    ]  # no
+0001d820: 7161 0a20 2020 2069 6620 6e6f 7420 7374  qa.    if not st
+0001d830: 6469 6e5f 7265 6164 793a 0a20 2020 2020  din_ready:.     
+0001d840: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0001d850: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0001d860: 6469 6e20 6973 206e 6f74 2072 6561 6479  din is not ready
+0001d870: 2066 6f72 2072 6561 6469 6e67 2e20 220a   for reading. ".
+0001d880: 2020 2020 2020 2020 2020 2020 2241 2070              "A p
+0001d890: 6970 6520 636f 756c 6420 6265 2075 7365  ipe could be use
+0001d8a0: 642c 2062 7574 2070 6970 6520 636f 756c  d, but pipe coul
+0001d8b0: 6420 6265 2065 6d70 7479 2c20 220a 2020  d be empty, ".  
+0001d8c0: 2020 2020 2020 2020 2020 2273 7464 696e            "stdin
+0001d8d0: 2063 6f75 6c64 2061 6c73 6f20 6265 2061   could also be a
+0001d8e0: 206b 6579 626f 6172 642e 220a 2020 2020   keyboard.".    
+0001d8f0: 2020 2020 290a 2020 2020 656c 7365 3a0a      ).    else:.
+0001d900: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0001d910: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0001d920: 2020 2273 7464 696e 2069 7320 7265 6164    "stdin is read
+0001d930: 792e 2053 6f6d 6574 6869 6e67 2022 0a20  y. Something ". 
+0001d940: 2020 2020 2020 2020 2020 2022 6973 2064             "is d
+0001d950: 6566 696e 6974 656c 7920 7069 7065 6420  efinitely piped 
+0001d960: 696e 746f 2070 726f 6772 616d 2066 726f  into program fro
+0001d970: 6d20 7374 6469 6e2e 2022 0a20 2020 2020  m stdin. ".     
+0001d980: 2020 2020 2020 2022 5265 6164 696e 6720         "Reading 
+0001d990: 6d65 7373 6167 6520 6672 6f6d 2073 7464  message from std
+0001d9a0: 696e 2070 6970 652e 220a 2020 2020 2020  in pipe.".      
+0001d9b0: 2020 290a 2020 2020 6966 2028 286e 6f74    ).    if ((not
+0001d9c0: 2073 7464 696e 5f72 6561 6479 2920 616e   stdin_ready) an
+0001d9d0: 6420 286e 6f74 2073 7973 2e73 7464 696e  d (not sys.stdin
+0001d9e0: 2e69 7361 7474 7928 2929 2920 6f72 2073  .isatty())) or s
+0001d9f0: 7464 696e 5f72 6561 6479 3a0a 2020 2020  tdin_ready:.    
+0001da00: 2020 2020 6966 206e 6f74 2073 7973 2e73      if not sys.s
+0001da10: 7464 696e 2e69 7361 7474 7928 293a 0a20  tdin.isatty():. 
+0001da20: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0001da30: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0001da40: 2020 2020 2020 2020 2022 5069 7065 2077           "Pipe w
+0001da50: 6173 2064 6566 696e 6974 656c 7920 7573  as definitely us
+0001da60: 6564 2c20 6275 7420 7069 7065 206d 6967  ed, but pipe mig
+0001da70: 6874 2062 6520 656d 7074 792e 2022 0a20  ht be empty. ". 
+0001da80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001da90: 5472 7969 6e67 2074 6f20 7265 6164 2066  Trying to read f
+0001daa0: 726f 6d20 7069 7065 2069 6e20 616e 7920  rom pipe in any 
+0001dab0: 6361 7365 2e22 0a20 2020 2020 2020 2020  case.".         
+0001dac0: 2020 2029 0a20 2020 2020 2020 206d 6573     ).        mes
+0001dad0: 7361 6765 203d 2022 220a 2020 2020 2020  sage = "".      
+0001dae0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001daf0: 2020 2066 6f72 206c 696e 6520 696e 2073     for line in s
+0001db00: 7973 2e73 7464 696e 3a0a 2020 2020 2020  ys.stdin:.      
+0001db10: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
+0001db20: 6520 2b3d 206c 696e 650a 2020 2020 2020  e += line.      
+0001db30: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0001db40: 7567 2822 5573 696e 6720 6461 7461 2066  ug("Using data f
+0001db50: 726f 6d20 7374 6469 6e20 7069 7065 2061  rom stdin pipe a
+0001db60: 7320 6d65 7373 6167 652e 2229 0a20 2020  s message.").   
+0001db70: 2020 2020 2020 2020 206d 6573 7361 6765           message
+0001db80: 732e 6170 7065 6e64 286d 6573 7361 6765  s.append(message
+0001db90: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+0001dba0: 2045 4f46 4572 726f 723a 2020 2320 454f   EOFError:  # EO
+0001dbb0: 4620 7768 656e 2072 6561 6469 6e67 2061  F when reading a
+0001dbc0: 206c 696e 650a 2020 2020 2020 2020 2020   line.          
+0001dbd0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+0001dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbf0: 2252 6561 6469 6e67 2066 726f 6d20 7374  "Reading from st
+0001dc00: 6469 6e20 7265 7375 6c74 6564 2069 6e20  din resulted in 
+0001dc10: 454f 462e 2054 6869 7320 6361 6e20 6861  EOF. This can ha
+0001dc20: 7070 656e 2022 0a20 2020 2020 2020 2020  ppen ".         
+0001dc30: 2020 2020 2020 2022 7768 656e 2061 2070         "when a p
+0001dc40: 6970 6520 7761 7320 7573 6564 2c20 6275  ipe was used, bu
+0001dc50: 7420 7468 6520 7069 7065 2069 7320 656d  t the pipe is em
+0001dc60: 7074 792e 2022 0a20 2020 2020 2020 2020  pty. ".         
+0001dc70: 2020 2020 2020 2022 4e6f 206d 6573 7361         "No messa
+0001dc80: 6765 2077 696c 6c20 6265 2067 656e 6572  ge will be gener
+0001dc90: 6174 6564 2e22 0a20 2020 2020 2020 2020  ated.".         
+0001dca0: 2020 2029 0a20 2020 2020 2020 2065 7863     ).        exc
+0001dcb0: 6570 7420 556e 6963 6f64 6544 6563 6f64  ept UnicodeDecod
+0001dcc0: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+0001dcd0: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
+0001dce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dcf0: 2022 5265 6164 696e 6720 6672 6f6d 2073   "Reading from s
+0001dd00: 7464 696e 2072 6573 756c 7465 6420 696e  tdin resulted in
+0001dd10: 2055 6e69 636f 6465 4465 636f 6465 4572   UnicodeDecodeEr
+0001dd20: 726f 722e 2054 6869 7320 220a 2020 2020  ror. This ".    
+0001dd30: 2020 2020 2020 2020 2020 2020 2263 616e              "can
+0001dd40: 2068 6170 7065 6e20 6966 2079 6f75 2074   happen if you t
+0001dd50: 7279 2074 6f20 7069 7065 2062 696e 6172  ry to pipe binar
+0001dd60: 7920 6461 7461 2066 6f72 2061 2074 6578  y data for a tex
+0001dd70: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
+0001dd80: 2020 2020 226d 6573 7361 6765 2e20 466f      "message. Fo
+0001dd90: 7220 6120 7465 7874 206d 6573 7361 6765  r a text message
+0001dda0: 206f 6e6c 7920 7069 7065 2074 6578 7420   only pipe text 
+0001ddb0: 7669 6120 7374 6469 6e2c 2022 0a20 2020  via stdin, ".   
+0001ddc0: 2020 2020 2020 2020 2020 2020 2022 6e6f               "no
+0001ddd0: 7420 6269 6e61 7279 2064 6174 612e 204e  t binary data. N
+0001dde0: 6f20 6d65 7373 6167 6520 7769 6c6c 2062  o message will b
+0001ddf0: 6520 6765 6e65 7261 7465 642e 220a 2020  e generated.".  
+0001de00: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001de10: 7265 7475 726e 206d 6573 7361 6765 730a  return messages.
+0001de20: 0a0a 6465 6620 6765 745f 6d65 7373 6167  ..def get_messag
+0001de30: 6573 5f66 726f 6d5f 6b65 7962 6f61 7264  es_from_keyboard
+0001de40: 2829 202d 3e20 6c69 7374 3a0a 2020 2020  () -> list:.    
+0001de50: 2222 2252 6561 6420 696e 7075 7420 6672  """Read input fr
+0001de60: 6f6d 206b 6579 626f 6172 6420 6275 7420  om keyboard but 
+0001de70: 6f6e 6c79 2069 6620 6e6f 206f 7468 6572  only if no other
+0001de80: 206d 6573 7361 6765 7320 6172 6520 6176   messages are av
+0001de90: 6169 6c61 626c 652e 0a0a 2020 2020 4966  ailable...    If
+0001dea0: 2074 6865 7265 2069 7320 6120 6d65 7373   there is a mess
+0001deb0: 6167 6520 7072 6f76 6964 6564 2076 6961  age provided via
+0001dec0: 202d 2d6d 6573 7361 6765 2061 7267 756d   --message argum
+0001ded0: 656e 742c 206e 6f20 6d65 7373 6167 650a  ent, no message.
+0001dee0: 2020 2020 7769 6c6c 2062 6520 7265 6164      will be read
+0001def0: 2066 726f 6d20 6b65 7962 6f61 7264 2e0a   from keyboard..
+0001df00: 2020 2020 4966 2074 6865 7265 2061 7265      If there are
+0001df10: 206f 7468 6572 2073 656e 6420 6f70 6572   other send oper
+0001df20: 6174 696f 6e73 206c 696b 6520 2d2d 696d  ations like --im
+0001df30: 6167 652c 202d 2d66 696c 652c 2065 7463  age, --file, etc
+0001df40: 2e20 6172 650a 2020 2020 7573 6564 2c20  . are.    used, 
+0001df50: 6e6f 206d 6573 7361 6765 2077 696c 6c20  no message will 
+0001df60: 6265 2072 6561 6420 6672 6f6d 206b 6579  be read from key
+0001df70: 626f 6172 642e 0a20 2020 2049 6620 7468  board..    If th
+0001df80: 6572 6520 6973 2061 206d 6573 7361 6765  ere is a message
+0001df90: 2070 726f 7669 6465 6420 7669 6120 7374   provided via st
+0001dfa0: 6469 6e20 696e 7075 7420 7069 7065 2c20  din input pipe, 
+0001dfb0: 6e6f 206d 6573 7361 6765 0a20 2020 2077  no message.    w
+0001dfc0: 696c 6c20 6265 2072 6561 6420 6672 6f6d  ill be read from
+0001dfd0: 206b 6579 626f 6172 642e 0a20 2020 2049   keyboard..    I
+0001dfe0: 6e20 7368 6f72 742c 2077 6520 6f6e 6c79  n short, we only
+0001dff0: 2072 6561 6420 6672 6f6d 206b 6579 626f   read from keybo
+0001e000: 6172 6420 6173 206c 6173 7420 7265 736f  ard as last reso
+0001e010: 7274 2c20 6966 206e 6f20 6d65 7373 6167  rt, if no messag
+0001e020: 6573 2061 7265 0a20 2020 2073 7065 6369  es are.    speci
+0001e030: 6669 6564 206f 7220 7072 6f76 6964 6564  fied or provided
+0001e040: 2061 6e79 7768 6572 6520 616e 6420 6e6f   anywhere and no
+0001e050: 206f 7468 6572 2073 656e 642d 6f70 6572   other send-oper
+0001e060: 6174 696f 6e73 206c 696b 650a 2020 2020  ations like.    
+0001e070: 2d2d 696d 6167 652c 202d 2d65 7665 6e74  --image, --event
+0001e080: 2c20 6574 632e 2061 7265 2070 6572 666f  , etc. are perfo
+0001e090: 726d 6564 2e0a 0a20 2020 2052 6574 7572  rmed...    Retur
+0001e0a0: 6e20 5b5d 2069 6620 6e6f 2069 6e70 7574  n [] if no input
+0001e0b0: 2061 7661 696c 6162 6c65 206f 6e20 6b65   available on ke
+0001e0c0: 7962 6f61 7264 2e0a 2020 2020 5265 7475  yboard..    Retu
+0001e0d0: 726e 205b 2273 6f6d 652d 6d73 6722 5d20  rn ["some-msg"] 
+0001e0e0: 6966 2069 6e70 7574 2069 7320 6176 6169  if input is avai
+0001e0f0: 6c62 6c65 206f 6e20 6b65 7962 6f61 7264  lble on keyboard
+0001e100: 2e0a 2020 2020 4d69 6768 7420 616c 736f  ..    Might also
+0001e110: 2072 6574 7572 6e20 5b22 225d 206f 6620   return [""] of 
+0001e120: 636f 7572 7365 2069 6620 2222 206b 6579  course if "" key
+0001e130: 626f 6172 6420 656e 7472 7920 7761 7320  board entry was 
+0001e140: 656d 7074 792e 0a20 2020 2043 7572 7265  empty..    Curre
+0001e150: 6e74 6c79 2074 6865 7265 2069 7320 6174  ntly there is at
+0001e160: 206d 6f73 7420 3120 6d73 6720 696e 2074   most 1 msg in t
+0001e170: 6865 2072 6574 7572 6e65 6420 6c69 7374  he returned list
+0001e180: 2e0a 2020 2020 2222 220a 2020 2020 6d65  ..    """.    me
+0001e190: 7373 6167 6573 203d 205b 5d0a 2020 2020  ssages = [].    
+0001e1a0: 6966 2067 732e 7061 2e6d 6573 7361 6765  if gs.pa.message
+0001e1b0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+0001e1c0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0001e1d0: 2020 2020 2244 6f6e 2774 2072 6561 6420      "Don't read 
+0001e1e0: 6672 6f6d 206b 6579 626f 6172 6420 6265  from keyboard be
+0001e1f0: 6361 7573 6520 7468 6572 6520 6172 6520  cause there are 
+0001e200: 220a 2020 2020 2020 2020 2020 2020 226d  ".            "m
+0001e210: 6573 7361 6765 7320 7072 6f76 6964 6564  essages provided
+0001e220: 2069 6e20 6172 6775 6d65 6e74 7320 7769   in arguments wi
+0001e230: 7468 202d 6d2e 220a 2020 2020 2020 2020  th -m.".        
+0001e240: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001e250: 206d 6573 7361 6765 7320 2023 2072 6574   messages  # ret
+0001e260: 7572 6e20 656d 7074 7920 6c69 7374 2062  urn empty list b
+0001e270: 6563 6175 7365 206d 6573 6773 2069 6e20  ecause mesgs in 
+0001e280: 2d6d 0a20 2020 2069 6620 280a 2020 2020  -m.    if (.    
+0001e290: 2020 2020 6773 2e70 612e 696d 6167 650a      gs.pa.image.
+0001e2a0: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
+0001e2b0: 2e61 7564 696f 0a20 2020 2020 2020 206f  .audio.        o
+0001e2c0: 7220 6773 2e70 612e 6669 6c65 0a20 2020  r gs.pa.file.   
+0001e2d0: 2020 2020 206f 7220 6773 2e70 612e 6576       or gs.pa.ev
+0001e2e0: 656e 740a 2020 2020 2020 2020 6f72 2067  ent.        or g
+0001e2f0: 732e 7061 2e76 6572 7369 6f6e 0a20 2020  s.pa.version.   
+0001e300: 2029 3a0a 2020 2020 2020 2020 6773 2e6c   ):.        gs.l
+0001e310: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0001e320: 2020 2020 2020 2244 6f6e 2774 2072 6561        "Don't rea
+0001e330: 6420 6672 6f6d 206b 6579 626f 6172 6420  d from keyboard 
+0001e340: 6265 6361 7573 6520 7468 6572 6520 6172  because there ar
+0001e350: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+0001e360: 226f 7468 6572 2073 656e 6420 6f70 6572  "other send oper
+0001e370: 6174 696f 6e73 206f 7220 2d2d 7665 7273  ations or --vers
+0001e380: 696f 6e20 7072 6f76 6964 6564 2069 6e20  ion provided in 
+0001e390: 6172 6775 6d65 6e74 732e 220a 2020 2020  arguments.".    
+0001e3a0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0001e3b0: 7475 726e 206d 6573 7361 6765 7320 2023  turn messages  #
+0001e3c0: 2072 6574 7572 6e20 656d 7074 7920 6c69   return empty li
+0001e3d0: 7374 2062 6563 6175 7365 206d 6573 6773  st because mesgs
+0001e3e0: 2069 6e20 2d6d 0a20 2020 2073 7464 696e   in -m.    stdin
+0001e3f0: 5f72 6561 6479 203d 2073 656c 6563 742e  _ready = select.
+0001e400: 7365 6c65 6374 285b 7379 732e 7374 6469  select([sys.stdi
+0001e410: 6e2c 5d2c 205b 5d2c 205b 5d2c 2030 2e30  n,], [], [], 0.0
+0001e420: 295b 2020 2320 6e6f 7161 0a20 2020 2020  )[  # noqa.     
+0001e430: 2020 2030 0a20 2020 205d 2020 2320 6e6f     0.    ]  # no
+0001e440: 7161 0a20 2020 2069 6620 6e6f 7420 7374  qa.    if not st
+0001e450: 6469 6e5f 7265 6164 793a 0a20 2020 2020  din_ready:.     
+0001e460: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0001e470: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+0001e480: 6469 6e20 6973 206e 6f74 2072 6561 6479  din is not ready
+0001e490: 2066 6f72 206b 6579 626f 6172 6420 696e   for keyboard in
+0001e4a0: 7465 7261 6374 696f 6e2e 2022 0a20 2020  teraction. ".   
+0001e4b0: 2020 2020 2020 2020 2022 4120 7069 7065           "A pipe
+0001e4c0: 2063 6f75 6c64 2062 6520 7573 6564 2c20   could be used, 
+0001e4d0: 6275 7420 7069 7065 2063 6f75 6c64 2062  but pipe could b
+0001e4e0: 6520 656d 7074 792c 2022 0a20 2020 2020  e empty, ".     
+0001e4f0: 2020 2020 2020 2022 7374 6469 6e20 636f         "stdin co
+0001e500: 756c 6420 616c 736f 2062 6520 6120 6b65  uld also be a ke
+0001e510: 7962 6f61 7264 2e22 0a20 2020 2020 2020  yboard.".       
+0001e520: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
+0001e530: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+0001e540: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
+0001e550: 7374 6469 6e20 6973 2072 6561 6479 2e20  stdin is ready. 
+0001e560: 536f 6d65 7468 696e 6720 220a 2020 2020  Something ".    
+0001e570: 2020 2020 2020 2020 2269 7320 6465 6669          "is defi
+0001e580: 6e69 7465 6c79 2070 6970 6564 2069 6e74  nitely piped int
+0001e590: 6f20 7072 6f67 7261 6d20 6672 6f6d 2073  o program from s
+0001e5a0: 7464 696e 2e20 220a 2020 2020 2020 2020  tdin. ".        
+0001e5b0: 2020 2020 2252 6561 6469 6e67 206d 6573      "Reading mes
+0001e5c0: 7361 6765 2066 726f 6d20 7374 6469 6e20  sage from stdin 
+0001e5d0: 7069 7065 2e22 0a20 2020 2020 2020 2029  pipe.".        )
+0001e5e0: 0a20 2020 2069 6620 286e 6f74 2073 7464  .    if (not std
+0001e5f0: 696e 5f72 6561 6479 2920 616e 6420 2873  in_ready) and (s
+0001e600: 7973 2e73 7464 696e 2e69 7361 7474 7928  ys.stdin.isatty(
+0001e610: 2929 3a0a 2020 2020 2020 2020 2320 6265  )):.        # be
+0001e620: 6361 7573 6520 7379 732e 7374 6469 6e2e  cause sys.stdin.
+0001e630: 6973 6174 7479 2829 2069 7320 7472 7565  isatty() is true
+0001e640: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+0001e650: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0001e660: 2020 2022 4e6f 2070 6970 6520 7761 7320     "No pipe was 
+0001e670: 7573 6564 2c20 736f 2072 6561 6420 696e  used, so read in
+0001e680: 7075 7420 6672 6f6d 206b 6579 626f 6172  put from keyboar
+0001e690: 642e 2022 0a20 2020 2020 2020 2020 2020  d. ".           
+0001e6a0: 2022 5265 6164 696e 6720 6d65 7373 6167   "Reading messag
+0001e6b0: 6520 6672 6f6d 206b 6579 626f 6172 6422  e from keyboard"
+0001e6c0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001e6d0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001e6e0: 2020 2020 6d65 7373 6167 6520 3d20 696e      message = in
+0001e6f0: 7075 7428 2245 6e74 6572 206d 6573 7361  put("Enter messa
+0001e700: 6765 2074 6f20 7365 6e64 3a20 2229 0a20  ge to send: "). 
+0001e710: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0001e720: 672e 6465 6275 6728 2255 7369 6e67 2064  g.debug("Using d
+0001e730: 6174 6120 6672 6f6d 2073 7464 696e 206b  ata from stdin k
+0001e740: 6579 626f 6172 6420 6173 206d 6573 7361  eyboard as messa
+0001e750: 6765 2e22 290a 2020 2020 2020 2020 2020  ge.").          
+0001e760: 2020 6d65 7373 6167 6573 2e61 7070 656e    messages.appen
+0001e770: 6428 6d65 7373 6167 6529 0a20 2020 2020  d(message).     
+0001e780: 2020 2065 7863 6570 7420 454f 4645 7272     except EOFErr
+0001e790: 6f72 3a20 2023 2045 4f46 2077 6865 6e20  or:  # EOF when 
+0001e7a0: 7265 6164 696e 6720 6120 6c69 6e65 0a20  reading a line. 
+0001e7b0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0001e7c0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0001e7d0: 2020 2020 2020 2020 2022 5265 6164 696e           "Readin
+0001e7e0: 6720 6672 6f6d 2073 7464 696e 2072 6573  g from stdin res
+0001e7f0: 756c 7465 6420 696e 2045 4f46 2e20 220a  ulted in EOF. ".
+0001e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e810: 2252 6561 6469 6e67 2066 726f 6d20 6b65  "Reading from ke
+0001e820: 7962 6f61 7264 2066 6169 6c65 642e 2022  yboard failed. "
+0001e830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e840: 2022 4e6f 206d 6573 7361 6765 2077 696c   "No message wil
+0001e850: 6c20 6265 2067 656e 6572 6174 6564 2e22  l be generated."
+0001e860: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001e870: 2020 2072 6574 7572 6e20 6d65 7373 6167     return messag
+0001e880: 6573 0a0a 0a61 7379 6e63 2064 6566 2073  es...async def s
+0001e890: 656e 645f 6d65 7373 6167 6573 5f61 6e64  end_messages_and
+0001e8a0: 5f66 696c 6573 2863 6c69 656e 742c 2072  _files(client, r
+0001e8b0: 6f6f 6d73 2c20 6d65 7373 6167 6573 293a  ooms, messages):
+0001e8c0: 0a20 2020 2022 2222 5365 6e64 2074 6578  .    """Send tex
+0001e8d0: 7420 6d65 7373 6167 6573 2061 6e64 2066  t messages and f
+0001e8e0: 696c 6573 2e0a 0a20 2020 2046 6972 7374  iles...    First
+0001e8f0: 2069 6d61 6765 732c 2061 7564 696f 2c20   images, audio, 
+0001e900: 6574 632c 2074 6865 6e20 7465 7874 206d  etc, then text m
+0001e910: 6573 7361 6765 642e 0a0a 2020 2020 4172  essaged...    Ar
+0001e920: 6775 6d65 6e74 733a 0a20 2020 202d 2d2d  guments:.    ---
+0001e930: 2d2d 2d2d 2d2d 0a20 2020 2063 6c69 656e  ------.    clien
+0001e940: 7420 3a20 436c 6965 6e74 0a20 2020 2072  t : Client.    r
+0001e950: 6f6f 6d73 203a 206c 6973 7420 6f66 2072  ooms : list of r
+0001e960: 6f6f 6d5f 6964 730a 2020 2020 6d65 7373  oom_ids.    mess
+0001e970: 6167 6573 203a 206c 6973 7420 6f66 206d  ages : list of m
+0001e980: 6573 7361 6765 7320 746f 2073 656e 640a  essages to send.
+0001e990: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+0001e9a0: 6773 2e70 612e 696d 6167 653a 0a20 2020  gs.pa.image:.   
+0001e9b0: 2020 2020 2066 6f72 2069 6d61 6765 2069       for image i
+0001e9c0: 6e20 6773 2e70 612e 696d 6167 653a 0a20  n gs.pa.image:. 
+0001e9d0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0001e9e0: 2073 656e 645f 696d 6167 6528 636c 6965   send_image(clie
+0001e9f0: 6e74 2c20 726f 6f6d 732c 2069 6d61 6765  nt, rooms, image
+0001ea00: 290a 0a20 2020 2069 6620 6773 2e70 612e  )..    if gs.pa.
+0001ea10: 6175 6469 6f3a 0a20 2020 2020 2020 2066  audio:.        f
+0001ea20: 6f72 2061 7564 696f 2069 6e20 6773 2e70  or audio in gs.p
+0001ea30: 612e 6175 6469 6f3a 0a20 2020 2020 2020  a.audio:.       
+0001ea40: 2020 2020 2023 2061 7564 696f 2066 696c       # audio fil
+0001ea50: 6520 6361 6e20 6265 2073 656e 7420 6c69  e can be sent li
+0001ea60: 6b65 206f 7468 6572 2066 696c 6573 0a20  ke other files. 
+0001ea70: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0001ea80: 2073 656e 645f 6669 6c65 2863 6c69 656e   send_file(clien
+0001ea90: 742c 2072 6f6f 6d73 2c20 6175 6469 6f29  t, rooms, audio)
+0001eaa0: 0a0a 2020 2020 6966 2067 732e 7061 2e66  ..    if gs.pa.f
+0001eab0: 696c 653a 0a20 2020 2020 2020 2066 6f72  ile:.        for
+0001eac0: 2066 696c 6520 696e 2067 732e 7061 2e66   file in gs.pa.f
+0001ead0: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
+0001eae0: 2061 7761 6974 2073 656e 645f 6669 6c65   await send_file
+0001eaf0: 2863 6c69 656e 742c 2072 6f6f 6d73 2c20  (client, rooms, 
+0001eb00: 6669 6c65 290a 0a20 2020 2069 6620 6773  file)..    if gs
+0001eb10: 2e70 612e 6576 656e 743a 0a20 2020 2020  .pa.event:.     
+0001eb20: 2020 2066 6f72 2065 7665 6e74 2069 6e20     for event in 
+0001eb30: 6773 2e70 612e 6576 656e 743a 0a20 2020  gs.pa.event:.   
+0001eb40: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+0001eb50: 656e 645f 6576 656e 7428 636c 6965 6e74  end_event(client
+0001eb60: 2c20 726f 6f6d 732c 2065 7665 6e74 290a  , rooms, event).
+0001eb70: 0a20 2020 2066 6f72 206d 6573 7361 6765  .    for message
+0001eb80: 2069 6e20 6d65 7373 6167 6573 3a0a 2020   in messages:.  
+0001eb90: 2020 2020 2020 6177 6169 7420 7365 6e64        await send
+0001eba0: 5f6d 6573 7361 6765 2863 6c69 656e 742c  _message(client,
+0001ebb0: 2072 6f6f 6d73 2c20 6d65 7373 6167 6529   rooms, message)
+0001ebc0: 0a0a 0a61 7379 6e63 2064 6566 2070 726f  ...async def pro
+0001ebd0: 6365 7373 5f61 7267 756d 656e 7473 5f61  cess_arguments_a
+0001ebe0: 6e64 5f69 6e70 7574 2863 6c69 656e 742c  nd_input(client,
+0001ebf0: 2072 6f6f 6d73 293a 0a20 2020 2022 2222   rooms):.    """
+0001ec00: 5072 6f63 6573 7320 6172 6775 6d65 6e74  Process argument
+0001ec10: 7320 616e 6420 616c 6c20 696e 7075 742e  s and all input.
+0001ec20: 0a0a 2020 2020 5072 6f63 6573 7320 616c  ..    Process al
+0001ec30: 6c20 696e 7075 743a 2074 6578 7420 6d65  l input: text me
+0001ec40: 7373 6167 6573 2c20 6574 632e 0a20 2020  ssages, etc..   
+0001ec50: 2050 7265 7061 7265 2061 206c 6973 7420   Prepare a list 
+0001ec60: 6f66 206d 6573 7361 6765 7320 6672 6f6d  of messages from
+0001ec70: 2061 6c6c 2073 6f75 7263 6573 2061 6e64   all sources and
+0001ec80: 2074 6865 6e20 7365 6e64 2074 6865 6d2e   then send them.
+0001ec90: 0a0a 2020 2020 4172 6775 6d65 6e74 733a  ..    Arguments:
+0001eca0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 0a20  .    ---------. 
+0001ecb0: 2020 2063 6c69 656e 7420 3a20 436c 6965     client : Clie
+0001ecc0: 6e74 0a20 2020 2072 6f6f 6d73 203a 206c  nt.    rooms : l
+0001ecd0: 6973 7420 6f66 2072 6f6f 6d5f 6964 730a  ist of room_ids.
+0001ece0: 0a20 2020 2022 2222 0a20 2020 2073 7472  .    """.    str
+0001ecf0: 6561 6d69 6e67 203d 2046 616c 7365 0a20  eaming = False. 
+0001ed00: 2020 206d 6573 7361 6765 735f 6672 6f6d     messages_from
+0001ed10: 5f70 6970 6520 3d20 5b5d 0a20 2020 2069  _pipe = [].    i
+0001ed20: 6620 6773 2e73 7464 696e 5f75 7365 203d  f gs.stdin_use =
+0001ed30: 3d20 226e 6f6e 6522 3a20 2023 2053 5444  = "none":  # STD
+0001ed40: 494e 2069 7320 756e 7573 6564 0a20 2020  IN is unused.   
+0001ed50: 2020 2020 206d 6573 7361 6765 735f 6672       messages_fr
+0001ed60: 6f6d 5f70 6970 6520 3d20 6765 745f 6d65  om_pipe = get_me
+0001ed70: 7373 6167 6573 5f66 726f 6d5f 7069 7065  ssages_from_pipe
+0001ed80: 2829 0a20 2020 206d 6573 7361 6765 735f  ().    messages_
+0001ed90: 6672 6f6d 5f6b 6579 626f 6172 6420 3d20  from_keyboard = 
+0001eda0: 6765 745f 6d65 7373 6167 6573 5f66 726f  get_messages_fro
+0001edb0: 6d5f 6b65 7962 6f61 7264 2829 0a20 2020  m_keyboard().   
+0001edc0: 2069 6620 6e6f 7420 6773 2e70 612e 6d65   if not gs.pa.me
+0001edd0: 7373 6167 653a 0a20 2020 2020 2020 206d  ssage:.        m
+0001ede0: 6573 7361 6765 735f 6672 6f6d 5f63 6f6d  essages_from_com
+0001edf0: 6d61 6e64 6c69 6e65 203d 205b 5d0a 2020  mandline = [].  
+0001ee00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ee10: 6d65 7373 6167 6573 5f66 726f 6d5f 636f  messages_from_co
+0001ee20: 6d6d 616e 646c 696e 6520 3d20 5b5d 0a20  mmandline = []. 
+0001ee30: 2020 2020 2020 2066 6f72 206d 2069 6e20         for m in 
+0001ee40: 6773 2e70 612e 6d65 7373 6167 653a 0a20  gs.pa.message:. 
+0001ee50: 2020 2020 2020 2020 2020 2069 6620 6d20             if m 
+0001ee60: 3d3d 2022 5c5c 2d22 3a20 2023 2065 7363  == "\\-":  # esc
+0001ee70: 6170 6564 202d 0a20 2020 2020 2020 2020  aped -.         
+0001ee80: 2020 2020 2020 206d 6573 7361 6765 735f         messages_
+0001ee90: 6672 6f6d 5f63 6f6d 6d61 6e64 6c69 6e65  from_commandline
+0001eea0: 202b 3d20 5b22 2d22 5d0a 2020 2020 2020   += ["-"].      
+0001eeb0: 2020 2020 2020 656c 6966 206d 203d 3d20        elif m == 
+0001eec0: 225c 5c5f 223a 2020 2320 6573 6361 7065  "\\_":  # escape
+0001eed0: 6420 5f0a 2020 2020 2020 2020 2020 2020  d _.            
+0001eee0: 2020 2020 6d65 7373 6167 6573 5f66 726f      messages_fro
+0001eef0: 6d5f 636f 6d6d 616e 646c 696e 6520 2b3d  m_commandline +=
+0001ef00: 205b 225f 225d 0a20 2020 2020 2020 2020   ["_"].         
+0001ef10: 2020 2065 6c69 6620 6d20 3d3d 2022 2d22     elif m == "-"
+0001ef20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ef30: 2020 2320 7374 6469 6e20 7069 7065 2c20    # stdin pipe, 
+0001ef40: 7265 6164 2061 6e64 2070 726f 6365 7373  read and process
+0001ef50: 2065 7665 7279 7468 696e 6720 696e 2070   everything in p
+0001ef60: 6970 6520 6173 2031 206d 7367 0a20 2020  ipe as 1 msg.   
+0001ef70: 2020 2020 2020 2020 2020 2020 206d 6573               mes
+0001ef80: 7361 6765 735f 6672 6f6d 5f63 6f6d 6d61  sages_from_comma
+0001ef90: 6e64 6c69 6e65 202b 3d20 6765 745f 6d65  ndline += get_me
+0001efa0: 7373 6167 6573 5f66 726f 6d5f 7069 7065  ssages_from_pipe
+0001efb0: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+0001efc0: 6c69 6620 6d20 3d3d 2022 5f22 3a0a 2020  lif m == "_":.  
+0001efd0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001efe0: 7374 7265 616d 696e 6720 7669 6120 7069  streaming via pi
+0001eff0: 7065 206f 6e20 7374 6469 6e0a 2020 2020  pe on stdin.    
+0001f000: 2020 2020 2020 2020 2020 2020 2320 7374              # st
+0001f010: 6469 6e20 7069 7065 2c20 7265 6164 2061  din pipe, read a
+0001f020: 6e64 2070 726f 6365 7373 2065 7665 7279  nd process every
+0001f030: 7468 696e 6720 696e 2070 6970 6520 6c69  thing in pipe li
+0001f040: 6e65 2062 7920 6c69 6e65 0a20 2020 2020  ne by line.     
+0001f050: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+0001f060: 6d69 6e67 203d 2054 7275 650a 2020 2020  ming = True.    
+0001f070: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f080: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+0001f090: 7373 6167 6573 5f66 726f 6d5f 636f 6d6d  ssages_from_comm
+0001f0a0: 616e 646c 696e 6520 2b3d 205b 6d5d 0a0a  andline += [m]..
+0001f0b0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0001f0c0: 2866 224d 6573 7361 6765 7320 6672 6f6d  (f"Messages from
+0001f0d0: 2070 6970 653a 2020 2020 2020 2020 207b   pipe:         {
+0001f0e0: 6d65 7373 6167 6573 5f66 726f 6d5f 7069  messages_from_pi
+0001f0f0: 7065 7d22 290a 2020 2020 6773 2e6c 6f67  pe}").    gs.log
+0001f100: 2e64 6562 7567 2866 224d 6573 7361 6765  .debug(f"Message
+0001f110: 7320 6672 6f6d 206b 6579 626f 6172 643a  s from keyboard:
+0001f120: 2020 2020 207b 6d65 7373 6167 6573 5f66       {messages_f
+0001f130: 726f 6d5f 6b65 7962 6f61 7264 7d22 290a  rom_keyboard}").
+0001f140: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0001f150: 2866 224d 6573 7361 6765 7320 6672 6f6d  (f"Messages from
+0001f160: 2063 6f6d 6d61 6e64 2d6c 696e 653a 207b   command-line: {
+0001f170: 6d65 7373 6167 6573 5f66 726f 6d5f 636f  messages_from_co
+0001f180: 6d6d 616e 646c 696e 657d 2229 0a0a 2020  mmandline}")..  
+0001f190: 2020 6d65 7373 6167 6573 5f61 6c6c 203d    messages_all =
+0001f1a0: 2028 0a20 2020 2020 2020 206d 6573 7361   (.        messa
+0001f1b0: 6765 735f 6672 6f6d 5f63 6f6d 6d61 6e64  ges_from_command
+0001f1c0: 6c69 6e65 202b 206d 6573 7361 6765 735f  line + messages_
+0001f1d0: 6672 6f6d 5f70 6970 6520 2b20 6d65 7373  from_pipe + mess
+0001f1e0: 6167 6573 5f66 726f 6d5f 6b65 7962 6f61  ages_from_keyboa
+0001f1f0: 7264 0a20 2020 2029 2020 2320 6b65 7962  rd.    )  # keyb
+0001f200: 6f61 7264 2061 7420 656e 640a 0a20 2020  oard at end..   
+0001f210: 2023 206c 6f6f 7020 7468 7275 2061 6c6c   # loop thru all
+0001f220: 206d 7367 7320 616e 6420 7370 6c69 7420   msgs and split 
+0001f230: 7468 656d 0a20 2020 2069 6620 6773 2e70  them.    if gs.p
+0001f240: 612e 7370 6c69 743a 0a20 2020 2020 2020  a.split:.       
+0001f250: 2023 2067 732e 7061 2e73 706c 6974 2063   # gs.pa.split c
+0001f260: 616e 2068 6176 6520 6573 6361 7065 2063  an have escape c
+0001f270: 6861 7261 6374 6572 732c 2069 7420 6861  haracters, it ha
+0001f280: 7320 746f 2062 6520 6465 2d65 7363 6170  s to be de-escap
+0001f290: 6564 0a20 2020 2020 2020 2064 6563 6f64  ed.        decod
+0001f2a0: 6564 5f73 7472 696e 6720 3d20 6279 7465  ed_string = byte
+0001f2b0: 7328 6773 2e70 612e 7370 6c69 742c 2022  s(gs.pa.split, "
+0001f2c0: 7574 662d 3822 292e 6465 636f 6465 2822  utf-8").decode("
+0001f2d0: 756e 6963 6f64 655f 6573 6361 7065 2229  unicode_escape")
+0001f2e0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+0001f2f0: 6465 6275 6728 6627 5374 7269 6e67 2075  debug(f'String u
+0001f300: 7365 6420 666f 7220 7370 6c69 7474 696e  sed for splittin
+0001f310: 6720 6973 3a20 227b 6465 636f 6465 645f  g is: "{decoded_
+0001f320: 7374 7269 6e67 7d22 2729 0a20 2020 2020  string}"').     
+0001f330: 2020 206d 6573 7361 6765 735f 616c 6c5f     messages_all_
+0001f340: 7370 6c69 7420 3d20 5b5d 0a20 2020 2020  split = [].     
+0001f350: 2020 2066 6f72 206d 2069 6e20 6d65 7373     for m in mess
+0001f360: 6167 6573 5f61 6c6c 3a0a 2020 2020 2020  ages_all:.      
+0001f370: 2020 2020 2020 6d65 7373 6167 6573 5f61        messages_a
+0001f380: 6c6c 5f73 706c 6974 202b 3d20 6d2e 7370  ll_split += m.sp
+0001f390: 6c69 7428 6465 636f 6465 645f 7374 7269  lit(decoded_stri
+0001f3a0: 6e67 290a 2020 2020 656c 7365 3a20 2023  ng).    else:  #
+0001f3b0: 206e 6f74 2067 732e 7061 2e73 706c 6974   not gs.pa.split
+0001f3c0: 0a20 2020 2020 2020 206d 6573 7361 6765  .        message
+0001f3d0: 735f 616c 6c5f 7370 6c69 7420 3d20 6d65  s_all_split = me
+0001f3e0: 7373 6167 6573 5f61 6c6c 0a0a 2020 2020  ssages_all..    
+0001f3f0: 6177 6169 7420 7365 6e64 5f6d 6573 7361  await send_messa
+0001f400: 6765 735f 616e 645f 6669 6c65 7328 636c  ges_and_files(cl
+0001f410: 6965 6e74 2c20 726f 6f6d 732c 206d 6573  ient, rooms, mes
+0001f420: 7361 6765 735f 616c 6c5f 7370 6c69 7429  sages_all_split)
+0001f430: 0a20 2020 2023 206e 6f77 2077 6520 6172  .    # now we ar
+0001f440: 6520 646f 6e65 2077 6974 6820 616c 6c20  e done with all 
+0001f450: 7468 6520 7573 7561 6c20 7365 6e64 732c  the usual sends,
+0001f460: 206e 6f77 2077 6520 7374 6172 7420 7374   now we start st
+0001f470: 7265 616d 696e 670a 2020 2020 6966 2073  reaming.    if s
+0001f480: 7472 6561 6d69 6e67 3a0a 2020 2020 2020  treaming:.      
+0001f490: 2020 6177 6169 7420 7374 7265 616d 5f6d    await stream_m
+0001f4a0: 6573 7361 6765 735f 6672 6f6d 5f70 6970  essages_from_pip
+0001f4b0: 6528 636c 6965 6e74 2c20 726f 6f6d 7329  e(client, rooms)
+0001f4c0: 0a0a 0a61 7379 6e63 2064 6566 206c 6f67  ...async def log
+0001f4d0: 696e 5f75 7369 6e67 5f63 7265 6465 6e74  in_using_credent
+0001f4e0: 6961 6c73 5f66 696c 6528 0a20 2020 2063  ials_file(.    c
+0001f4f0: 7265 6465 6e74 6961 6c73 5f66 696c 653a  redentials_file:
+0001f500: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+0001f510: 204e 6f6e 652c 2073 746f 7265 5f64 6972   None, store_dir
+0001f520: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0001f530: 3d20 4e6f 6e65 0a29 202d 3e20 2841 7379  = None.) -> (Asy
+0001f540: 6e63 436c 6965 6e74 2c20 6469 6374 293a  ncClient, dict):
+0001f550: 0a20 2020 2022 2222 4c6f 6720 696e 2062  .    """Log in b
+0001f560: 7920 7573 696e 6720 6176 6169 6c61 626c  y using availabl
+0001f570: 6520 6372 6564 656e 7469 616c 7320 6669  e credentials fi
+0001f580: 6c65 2e0a 0a20 2020 2041 7267 756d 656e  le...    Argumen
+0001f590: 7473 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  ts:.    --------
+0001f5a0: 2d0a 2020 2020 2020 2020 6372 6564 656e  -.        creden
+0001f5b0: 7469 616c 735f 6669 6c65 3a20 7374 7220  tials_file: str 
+0001f5c0: 3a20 6c6f 6361 7469 6f6e 206f 6620 6372  : location of cr
+0001f5d0: 6564 656e 7469 616c 7320 6669 6c65 0a20  edentials file. 
+0001f5e0: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
+0001f5f0: 7465 2069 7420 6966 206e 6f74 2070 726f  te it if not pro
+0001f600: 7669 6465 640a 2020 2020 2020 2020 7374  vided.        st
+0001f610: 6f72 655f 6469 723a 2073 7472 203a 206c  ore_dir: str : l
+0001f620: 6f63 6174 696f 6e20 6f66 2070 6572 7369  ocation of persi
+0001f630: 7374 656e 7420 7374 6f72 6167 6520 7374  stent storage st
+0001f640: 6f72 6520 6469 7265 6374 6f72 790a 2020  ore directory.  
+0001f650: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
+0001f660: 6520 6974 2069 6620 6e6f 7420 7072 6f76  e it if not prov
+0001f670: 6964 6564 0a0a 2020 2020 5265 7475 726e  ided..    Return
+0001f680: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+0001f690: 2020 2020 2020 4173 796e 6343 6c69 656e        AsyncClien
+0001f6a0: 7420 3a20 7468 6520 6372 6561 7465 6420  t : the created 
+0001f6b0: 4e49 4f20 636c 6965 6e74 0a20 2020 2020  NIO client.     
+0001f6c0: 2020 2064 6963 7420 3a20 7468 6520 6372     dict : the cr
+0001f6d0: 6564 656e 7469 616c 7320 6469 6374 696f  edentials dictio
+0001f6e0: 6e61 7279 2066 726f 6d20 7468 6520 6372  nary from the cr
+0001f6f0: 6564 656e 7469 616c 7320 6669 6c65 0a0a  edentials file..
+0001f700: 2020 2020 2222 220a 0a20 2020 2069 6620      """..    if 
+0001f710: 6e6f 7420 6372 6564 656e 7469 616c 735f  not credentials_
+0001f720: 6669 6c65 3a0a 2020 2020 2020 2020 6372  file:.        cr
+0001f730: 6564 656e 7469 616c 735f 6669 6c65 203d  edentials_file =
+0001f740: 2064 6574 6572 6d69 6e65 5f63 7265 6465   determine_crede
+0001f750: 6e74 6961 6c73 5f66 696c 6528 290a 2020  ntials_file().  
+0001f760: 2020 6966 206e 6f74 2073 746f 7265 5f64    if not store_d
+0001f770: 6972 3a0a 2020 2020 2020 2020 7374 6f72  ir:.        stor
+0001f780: 655f 6469 7220 3d20 6465 7465 726d 696e  e_dir = determin
+0001f790: 655f 7374 6f72 655f 6469 7228 290a 0a20  e_store_dir().. 
+0001f7a0: 2020 2069 6620 6e6f 7420 6372 6564 656e     if not creden
+0001f7b0: 7469 616c 735f 6578 6973 7428 6372 6564  tials_exist(cred
+0001f7c0: 656e 7469 616c 735f 6669 6c65 293a 0a20  entials_file):. 
+0001f7d0: 2020 2020 2020 2072 6169 7365 204d 6174         raise Mat
+0001f7e0: 7269 7843 6f6d 6d61 6e64 6572 4572 726f  rixCommanderErro
+0001f7f0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+0001f800: 4531 3533 3a20 220a 2020 2020 2020 2020  E153: ".        
+0001f810: 2020 2020 2243 7265 6465 6e74 6961 6c73      "Credentials
+0001f820: 2066 696c 6520 7761 7320 6e6f 7420 666f   file was not fo
+0001f830: 756e 642e 2050 726f 7669 6465 2063 7265  und. Provide cre
+0001f840: 6465 6e74 6961 6c73 2066 696c 6520 6f72  dentials file or
+0001f850: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0001f860: 7573 6520 2d2d 6c6f 6769 6e20 746f 2063  use --login to c
+0001f870: 7265 6174 6520 6120 6372 6564 656e 7469  reate a credenti
+0001f880: 616c 7320 6669 6c65 2e22 0a20 2020 2020  als file.".     
+0001f890: 2020 2029 2066 726f 6d20 4e6f 6e65 0a20     ) from None. 
+0001f8a0: 2020 2069 6620 6e6f 7420 7374 6f72 655f     if not store_
+0001f8b0: 6578 6973 7473 2873 746f 7265 5f64 6972  exists(store_dir
+0001f8c0: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
+0001f8d0: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+0001f8e0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001f8f0: 2020 2022 4531 3534 3a20 220a 2020 2020     "E154: ".    
+0001f900: 2020 2020 2020 2020 2253 746f 7265 2064          "Store d
+0001f910: 6972 6563 746f 7279 2077 6173 206e 6f74  irectory was not
+0001f920: 2066 6f75 6e64 2e20 5072 6f76 6964 6520   found. Provide 
+0001f930: 7374 6f72 6520 6469 7265 6374 6f72 7920  store directory 
+0001f940: 6f72 2022 0a20 2020 2020 2020 2020 2020  or ".           
+0001f950: 2022 7573 6520 2d2d 6c6f 6769 6e20 746f   "use --login to
+0001f960: 2063 7265 6174 6520 6120 7374 6f72 6520   create a store 
+0001f970: 6469 7265 6374 6f72 792e 220a 2020 2020  directory.".    
+0001f980: 2020 2020 2920 6672 6f6d 204e 6f6e 650a      ) from None.
+0001f990: 0a20 2020 2063 7265 6465 6e74 6961 6c73  .    credentials
+0001f9a0: 203d 2072 6561 645f 6372 6564 656e 7469   = read_credenti
+0001f9b0: 616c 735f 6672 6f6d 5f64 6973 6b28 6372  als_from_disk(cr
+0001f9c0: 6564 656e 7469 616c 735f 6669 6c65 290a  edentials_file).
+0001f9d0: 2020 2020 6773 2e63 7265 6465 6e74 6961      gs.credentia
+0001f9e0: 6c73 203d 2063 7265 6465 6e74 6961 6c73  ls = credentials
+0001f9f0: 0a0a 2020 2020 6773 2e6c 6f67 2e64 6562  ..    gs.log.deb
+0001fa00: 7567 2822 4162 6f75 7420 746f 2063 6f6e  ug("About to con
+0001fa10: 6669 6775 7265 204d 6174 7269 7820 4173  figure Matrix As
+0001fa20: 796e 6320 436c 6965 6e74 2e22 290a 2020  ync Client.").  
+0001fa30: 2020 2320 436f 6e66 6967 7572 6174 696f    # Configuratio
+0001fa40: 6e20 6f70 7469 6f6e 7320 666f 7220 7468  n options for th
+0001fa50: 6520 4173 796e 6343 6c69 656e 740a 2020  e AsyncClient.  
+0001fa60: 2020 636c 6965 6e74 5f63 6f6e 6669 6720    client_config 
+0001fa70: 3d20 4173 796e 6343 6c69 656e 7443 6f6e  = AsyncClientCon
+0001fa80: 6669 6728 0a20 2020 2020 2020 206d 6178  fig(.        max
+0001fa90: 5f6c 696d 6974 5f65 7863 6565 6465 643d  _limit_exceeded=
+0001faa0: 302c 0a20 2020 2020 2020 206d 6178 5f74  0,.        max_t
+0001fab0: 696d 656f 7574 733d 302c 0a20 2020 2020  imeouts=0,.     
+0001fac0: 2020 2073 746f 7265 5f73 796e 635f 746f     store_sync_to
+0001fad0: 6b65 6e73 3d54 7275 652c 0a20 2020 2020  kens=True,.     
+0001fae0: 2020 2065 6e63 7279 7074 696f 6e5f 656e     encryption_en
+0001faf0: 6162 6c65 643d 5472 7565 2c0a 2020 2020  abled=True,.    
+0001fb00: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
+0001fb10: 7567 2822 4162 6f75 7420 746f 2069 6e69  ug("About to ini
+0001fb20: 7469 616c 697a 6520 4d61 7472 6978 2041  tialize Matrix A
+0001fb30: 7379 6e63 2043 6c69 656e 742e 2229 0a20  sync Client."). 
+0001fb40: 2020 2023 2049 6e69 7469 616c 697a 6520     # Initialize 
+0001fb50: 7468 6520 6d61 7472 6978 2063 6c69 656e  the matrix clien
+0001fb60: 7420 6261 7365 6420 6f6e 2063 7265 6465  t based on crede
+0001fb70: 6e74 6961 6c73 2066 726f 6d20 6669 6c65  ntials from file
+0001fb80: 0a20 2020 2063 6c69 656e 7420 3d20 4173  .    client = As
+0001fb90: 796e 6343 6c69 656e 7428 0a20 2020 2020  yncClient(.     
+0001fba0: 2020 2063 7265 6465 6e74 6961 6c73 5b22     credentials["
+0001fbb0: 686f 6d65 7365 7276 6572 225d 2c0a 2020  homeserver"],.  
+0001fbc0: 2020 2020 2020 6372 6564 656e 7469 616c        credential
+0001fbd0: 735b 2275 7365 725f 6964 225d 2c0a 2020  s["user_id"],.  
+0001fbe0: 2020 2020 2020 6465 7669 6365 5f69 643d        device_id=
+0001fbf0: 6372 6564 656e 7469 616c 735b 2264 6576  credentials["dev
+0001fc00: 6963 655f 6964 225d 2c0a 2020 2020 2020  ice_id"],.      
+0001fc10: 2020 7374 6f72 655f 7061 7468 3d73 746f    store_path=sto
+0001fc20: 7265 5f64 6972 2c0a 2020 2020 2020 2020  re_dir,.        
+0001fc30: 636f 6e66 6967 3d63 6c69 656e 745f 636f  config=client_co
+0001fc40: 6e66 6967 2c0a 2020 2020 2020 2020 7373  nfig,.        ss
+0001fc50: 6c3d 6773 2e73 736c 2c0a 2020 2020 2020  l=gs.ssl,.      
+0001fc60: 2020 7072 6f78 793d 6773 2e70 612e 7072    proxy=gs.pa.pr
+0001fc70: 6f78 792c 0a20 2020 2029 0a20 2020 2069  oxy,.    ).    i
+0001fc80: 6620 6773 2e70 612e 7072 6f78 793a 0a20  f gs.pa.proxy:. 
+0001fc90: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+0001fca0: 6275 6728 6622 5072 6f78 7920 7b67 732e  bug(f"Proxy {gs.
+0001fcb0: 7061 2e70 726f 7879 7d20 7769 6c6c 2062  pa.proxy} will b
+0001fcc0: 6520 7573 6564 2066 6f72 2063 6f6e 6e65  e used for conne
+0001fcd0: 6374 6976 6974 792e 2229 0a0a 2020 2020  ctivity.")..    
+0001fce0: 6773 2e6c 6f67 2e64 6562 7567 2822 4162  gs.log.debug("Ab
+0001fcf0: 6f75 7420 746f 2072 6573 746f 7265 206c  out to restore l
+0001fd00: 6f67 696e 2e22 290a 2020 2020 2320 7265  ogin.").    # re
+0001fd10: 7374 6f72 655f 6c6f 6769 6e28 2920 616c  store_login() al
+0001fd20: 7761 7973 2072 6574 7572 6e73 204e 6f6e  ways returns Non
+0001fd30: 652c 206f 6e20 7375 6363 6573 7320 6f72  e, on success or
+0001fd40: 2066 6169 6c75 7265 0a20 2020 2023 2072   failure.    # r
+0001fd50: 6573 746f 7265 5f6c 6f67 696e 2829 2064  estore_login() d
+0001fd60: 6f65 7320 6e6f 7420 676f 2074 6f20 7468  oes not go to th
+0001fd70: 6520 7365 7276 6572 2c20 6974 206a 7573  e server, it jus
+0001fd80: 7420 7365 7473 2073 6f6d 6520 6c6f 6361  t sets some loca
+0001fd90: 6c20 7661 6c75 6573 0a20 2020 2023 2054  l values.    # T
+0001fda0: 4f44 4f3a 2070 6572 666f 726d 616e 6365  ODO: performance
+0001fdb0: 0a20 2020 2023 2072 6573 746f 7265 5f6c  .    # restore_l
+0001fdc0: 6f67 696e 2829 2069 7320 6120 736c 6f77  ogin() is a slow
+0001fdd0: 206f 7065 7261 7469 6f6e 2e20 312e 3573   operation. 1.5s
+0001fde0: 2074 6f20 3273 2e20 5768 793f 0a20 2020   to 2s. Why?.   
+0001fdf0: 2023 2042 6563 6175 7365 2069 7420 6973   # Because it is
+0001fe00: 2072 6561 6469 6e67 2074 6865 2073 746f   reading the sto
+0001fe10: 7265 2066 696c 6520 6461 7461 6261 7365  re file database
+0001fe20: 2e0a 2020 2020 2320 5365 7474 696e 6720  ..    # Setting 
+0001fe30: 7374 6f72 655f 7379 6e63 5f74 6f6b 656e  store_sync_token
+0001fe40: 733d 4661 6c73 6520 6162 6f76 6520 7769  s=False above wi
+0001fe50: 6c6c 206e 6f74 206d 616b 6520 6974 2067  ll not make it g
+0001fe60: 6f20 616e 7920 6661 7374 6572 2e0a 2020  o any faster..  
+0001fe70: 2020 636c 6965 6e74 2e72 6573 746f 7265    client.restore
+0001fe80: 5f6c 6f67 696e 280a 2020 2020 2020 2020  _login(.        
+0001fe90: 7573 6572 5f69 643d 6372 6564 656e 7469  user_id=credenti
+0001fea0: 616c 735b 2275 7365 725f 6964 225d 2c0a  als["user_id"],.
+0001feb0: 2020 2020 2020 2020 6465 7669 6365 5f69          device_i
+0001fec0: 643d 6372 6564 656e 7469 616c 735b 2264  d=credentials["d
+0001fed0: 6576 6963 655f 6964 225d 2c0a 2020 2020  evice_id"],.    
+0001fee0: 2020 2020 6163 6365 7373 5f74 6f6b 656e      access_token
+0001fef0: 3d63 7265 6465 6e74 6961 6c73 5b22 6163  =credentials["ac
+0001ff00: 6365 7373 5f74 6f6b 656e 225d 2c0a 2020  cess_token"],.  
+0001ff10: 2020 290a 2020 2020 6773 2e6c 6f67 2e64    ).    gs.log.d
+0001ff20: 6562 7567 2822 4669 6e69 7368 6564 2072  ebug("Finished r
+0001ff30: 6573 746f 7269 6e67 206c 6f67 696e 2e22  estoring login."
+0001ff40: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
+0001ff50: 7567 280a 2020 2020 2020 2020 224c 6f67  ug(.        "Log
+0001ff60: 696e 2077 696c 6c20 6265 2075 7369 6e67  in will be using
+0001ff70: 2073 746f 7265 6420 6372 6564 656e 7469   stored credenti
+0001ff80: 616c 7320 6672 6f6d 2022 0a20 2020 2020  als from ".     
+0001ff90: 2020 2066 2763 7265 6465 6e74 6961 6c73     f'credentials
+0001ffa0: 2066 696c 6520 227b 6372 6564 656e 7469   file "{credenti
+0001ffb0: 616c 735f 6669 6c65 7d22 2e20 270a 2020  als_file}". '.  
+0001ffc0: 2020 2020 2020 6627 726f 6f6d 5f69 6420        f'room_id 
+0001ffd0: 3d20 7b63 7265 6465 6e74 6961 6c73 5b22  = {credentials["
+0001ffe0: 726f 6f6d 5f69 6422 5d7d 2c20 270a 2020  room_id"]}, '.  
+0001fff0: 2020 2020 2020 6627 6465 7669 6365 5f69        f'device_i
+00020000: 6420 3d20 7b63 7265 6465 6e74 6961 6c73  d = {credentials
+00020010: 5b22 6465 7669 6365 5f69 6422 5d7d 2c20  ["device_id"]}, 
+00020020: 270a 2020 2020 2020 2020 6627 6163 6365  '.        f'acce
+00020030: 7373 5f74 6f6b 656e 203d 207b 6372 6564  ss_token = {cred
+00020040: 656e 7469 616c 735b 2261 6363 6573 735f  entials["access_
+00020050: 746f 6b65 6e22 5d5b 303a 315d 7d2a 2a2a  token"][0:1]}***
+00020060: 270a 2020 2020 2020 2020 6627 7b63 7265  '.        f'{cre
+00020070: 6465 6e74 6961 6c73 5b22 6163 6365 7373  dentials["access
+00020080: 5f74 6f6b 656e 225d 5b2d 313a 5d7d 2e27  _token"][-1:]}.'
+00020090: 0a20 2020 2029 0a20 2020 2069 6620 6773  .    ).    if gs
+000200a0: 2e70 612e 6465 6275 6720 3e20 303a 0a20  .pa.debug > 0:. 
+000200b0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+000200c0: 6275 6728 2241 626f 7574 2074 6f20 636f  bug("About to co
+000200d0: 6e6e 6563 7420 746f 2073 6572 7665 7220  nnect to server 
+000200e0: 746f 2076 6572 6966 7920 636f 6e6e 6563  to verify connec
+000200f0: 7469 6f6e 2e22 290a 2020 2020 2020 2020  tion.").        
+00020100: 2320 6773 2e6c 6f67 2e64 6562 7567 2866  # gs.log.debug(f
+00020110: 224c 6f67 6765 645f 696e 2829 3d7b 636c  "Logged_in()={cl
+00020120: 6965 6e74 2e6c 6f67 6765 645f 696e 7d22  ient.logged_in}"
+00020130: 2920 6973 2061 6c77 6179 7320 5472 7565  ) is always True
+00020140: 2e0a 2020 2020 2020 2020 2320 4a75 7374  ..        # Just
+00020150: 2062 6563 6175 7365 2063 6c69 656e 742e   because client.
+00020160: 6c6f 6767 6564 5f69 6e20 6973 2054 7275  logged_in is Tru
+00020170: 6520 646f 6573 206e 6f74 206d 6561 6e20  e does not mean 
+00020180: 7765 2061 7265 206c 6f67 6765 6420 696e  we are logged in
+00020190: 2e0a 2020 2020 2020 2020 2320 5468 6174  ..        # That
+000201a0: 206a 7573 7420 6d65 616e 7320 7468 6520   just means the 
+000201b0: 6461 7461 2073 7472 7563 7475 7265 2069  data structure i
+000201c0: 7320 6669 6c6c 6564 2e0a 2020 2020 2020  s filled..      
+000201d0: 2020 2320 486f 7720 746f 206b 6e6f 7720    # How to know 
+000201e0: 6966 206c 6f67 696e 2077 6173 2073 7563  if login was suc
+000201f0: 6365 7373 6675 6c3f 0a20 2020 2020 2020  cessful?.       
+00020200: 2023 2044 6f20 616e 2061 6374 7561 6c20   # Do an actual 
+00020210: 4150 4920 6361 6c6c 2061 6761 696e 7374  API call against
+00020220: 2074 6865 2073 6572 7665 722e 2045 2e67   the server. E.g
+00020230: 2e20 7768 6f61 6d69 2e0a 2020 2020 2020  . whoami..      
+00020240: 2020 2320 5765 2064 6f6e 2774 2077 616e    # We don't wan
+00020250: 7420 746f 2064 6f20 7468 6973 2061 6c77  t to do this alw
+00020260: 6179 7320 666f 7220 7065 7266 6f72 6d61  ays for performa
+00020270: 6e63 6520 7265 6173 6f6e 732c 2073 6f20  nce reasons, so 
+00020280: 7765 206f 6e6c 790a 2020 2020 2020 2020  we only.        
+00020290: 2320 646f 2069 7420 696e 2064 6562 7567  # do it in debug
+000202a0: 206d 6f64 652e 0a20 2020 2020 2020 2074   mode..        t
+000202b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000202c0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+000202d0: 656e 742e 7768 6f61 6d69 2829 0a20 2020  ent.whoami().   
+000202e0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+000202f0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00020300: 2020 2020 2020 2020 6177 6169 7420 636c          await cl
+00020310: 6965 6e74 2e63 6c6f 7365 2829 0a20 2020  ient.close().   
+00020320: 2020 2020 2020 2020 2063 6c69 656e 7420           client 
+00020330: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00020340: 2020 2063 7265 6465 6e74 6961 6c73 203d     credentials =
+00020350: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00020360: 2020 7261 6973 6520 2865 290a 2020 2020    raise (e).    
+00020370: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00020380: 6528 7265 7370 2c20 7265 7370 6f6e 7365  e(resp, response
+00020390: 732e 5768 6f61 6d69 4572 726f 7229 3a0a  s.WhoamiError):.
+000203a0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+000203b0: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+000203c0: 2020 2020 2020 2020 2020 2245 3135 353a            "E155:
+000203d0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+000203e0: 2020 2022 7265 7374 6f72 655f 6c6f 6769     "restore_logi
+000203f0: 6e20 6661 696c 6564 2e20 4469 6420 796f  n failed. Did yo
+00020400: 7520 7065 7266 6f72 6d20 2d2d 6c6f 676f  u perform --logo
+00020410: 7574 2022 0a20 2020 2020 2020 2020 2020  ut ".           
+00020420: 2020 2020 2022 6265 666f 7265 3f20 4c6f       "before? Lo
+00020430: 6f6b 7320 6c69 6b65 2079 6f75 7220 6163  oks like your ac
+00020440: 6365 7373 2d74 6f6b 656e 2065 7870 6972  cess-token expir
+00020450: 6564 2e20 4d61 7962 6520 220a 2020 2020  ed. Maybe ".    
+00020460: 2020 2020 2020 2020 2020 2020 2264 656c              "del
+00020470: 6574 6520 6372 6564 656e 7469 616c 7320  ete credentials 
+00020480: 6669 6c65 2061 6e64 2073 746f 7265 2061  file and store a
+00020490: 6e64 2070 6572 666f 726d 2061 2022 0a20  nd perform a ". 
+000204a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000204b0: 226e 6577 202d 2d6c 6f67 696e 2e20 5265  "new --login. Re
+000204c0: 7370 6f6e 7365 2069 733a 207b 7072 6976  sponse is: {priv
+000204d0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+000204e0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+000204f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00020500: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00020510: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00020520: 6177 6169 7420 636c 6965 6e74 2e63 6c6f  await client.clo
+00020530: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
+00020540: 2063 6c69 656e 7420 3d20 4e6f 6e65 0a20   client = None. 
+00020550: 2020 2020 2020 2020 2020 2063 7265 6465             crede
+00020560: 6e74 6961 6c73 203d 204e 6f6e 650a 2020  ntials = None.  
+00020570: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00020580: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00020590: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+000205a0: 2020 2020 2020 2272 6573 746f 7265 5f6c        "restore_l
+000205b0: 6f67 696e 2073 7563 6365 7373 6675 6c2e  ogin successful.
+000205c0: 2053 7563 6365 7373 6675 6c6c 7920 220a   Successfully ".
+000205d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000205e0: 6622 6c6f 6767 6564 2069 6e20 6173 2075  f"logged in as u
+000205f0: 7365 7220 7b72 6573 702e 7573 6572 5f69  ser {resp.user_i
+00020600: 647d 2076 6961 2072 6573 746f 7265 5f6c  d} via restore_l
+00020610: 6f67 696e 2e20 220a 2020 2020 2020 2020  ogin. ".        
+00020620: 2020 2020 2020 2020 6622 5265 7370 6f6e          f"Respon
+00020630: 7365 2069 733a 207b 7072 6976 6163 795f  se is: {privacy_
+00020640: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+00020650: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+00020660: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00020670: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00020680: 2023 206c 6f67 696e 206d 6967 6874 206f   # login might o
+00020690: 7220 6d69 6768 7420 6e6f 7420 6661 696c  r might not fail
+000206a0: 206c 6174 6572 2c0a 2020 2020 2020 2020   later,.        
+000206b0: 2320 6966 2069 7420 6661 696c 7320 736f  # if it fails so
+000206c0: 6d65 2065 7863 6570 7469 6f6e 2077 696c  me exception wil
+000206d0: 6c20 6265 2072 6169 7365 642c 2074 6865  l be raised, the
+000206e0: 2065 7863 6570 7469 6f6e 2074 6578 740a   exception text.
+000206f0: 2020 2020 2020 2020 2320 6d69 6768 7420          # might 
+00020700: 6e6f 7420 6578 706c 6169 6e20 7468 6520  not explain the 
+00020710: 7072 6f62 6c65 6d20 7765 6c6c 2c20 6275  problem well, bu
+00020720: 7420 7468 6973 2077 6179 2077 6520 7370  t this way we sp
+00020730: 6565 6420 7570 0a20 2020 2020 2020 2023  eed up.        #
+00020740: 2070 6572 666f 726d 616e 6365 2062 7920   performance by 
+00020750: 6973 7375 696e 6720 6f6e 6520 4150 4920  issuing one API 
+00020760: 6c65 7373 2061 6761 696e 7374 2074 6865  less against the
+00020770: 2073 6572 7665 722e 0a20 2020 2072 6574   server..    ret
+00020780: 7572 6e20 2863 6c69 656e 742c 2063 7265  urn (client, cre
+00020790: 6465 6e74 6961 6c73 290a 0a0a 6173 796e  dentials)...asyn
+000207a0: 6320 6465 6620 6c69 7374 656e 5f66 6f72  c def listen_for
+000207b0: 6576 6572 2863 6c69 656e 743a 2041 7379  ever(client: Asy
+000207c0: 6e63 436c 6965 6e74 2920 2d3e 204e 6f6e  ncClient) -> Non
+000207d0: 653a 0a20 2020 2022 2222 4c69 7374 656e  e:.    """Listen
+000207e0: 2066 6f72 6576 6572 206f 7220 756e 7469   forever or unti
+000207f0: 6c20 436f 6e74 726f 6c2d 432e 2222 220a  l Control-C.""".
+00020800: 2020 2020 2320 5365 7420 7570 2065 7665      # Set up eve
+00020810: 6e74 2063 616c 6c62 6163 6b73 0a20 2020  nt callbacks.   
+00020820: 2063 616c 6c62 6163 6b73 203d 2043 616c   callbacks = Cal
+00020830: 6c62 6163 6b73 2863 6c69 656e 7429 0a20  lbacks(client). 
+00020840: 2020 2063 6c69 656e 742e 6164 645f 6576     client.add_ev
+00020850: 656e 745f 6361 6c6c 6261 636b 280a 2020  ent_callback(.  
+00020860: 2020 2020 2020 6361 6c6c 6261 636b 732e        callbacks.
+00020870: 6d65 7373 6167 655f 6361 6c6c 6261 636b  message_callback
+00020880: 2c0a 2020 2020 2020 2020 280a 2020 2020  ,.        (.    
+00020890: 2020 2020 2020 2020 526f 6f6d 4d65 7373          RoomMess
+000208a0: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
+000208b0: 2052 6564 6163 7465 6445 7665 6e74 2c0a   RedactedEvent,.
+000208c0: 2020 2020 2020 2020 2020 2020 5265 6461              Reda
+000208d0: 6374 696f 6e45 7665 6e74 2c0a 2020 2020  ctionEvent,.    
+000208e0: 2020 2020 292c 0a20 2020 2029 0a20 2020      ),.    ).   
+000208f0: 2069 6620 6773 2e70 612e 726f 6f6d 5f69   if gs.pa.room_i
+00020900: 6e76 6974 6573 3a0a 2020 2020 2020 2020  nvites:.        
+00020910: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+00020920: 2020 2020 2020 2020 2020 2252 6567 6973            "Regis
+00020930: 7465 7269 6e67 2074 6f20 6c69 7374 656e  tering to listen
+00020940: 2074 6f20 6576 656e 7473 206f 6620 7479   to events of ty
+00020950: 7065 2022 0a20 2020 2020 2020 2020 2020  pe ".           
+00020960: 2022 496e 7669 7465 4d65 6d62 6572 4576   "InviteMemberEv
+00020970: 656e 742e 204c 6973 7465 6e69 6e67 2074  ent. Listening t
+00020980: 6f20 726f 6f6d 2069 6e76 6974 6573 2e22  o room invites."
+00020990: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000209a0: 2020 2063 6c69 656e 742e 6164 645f 6576     client.add_ev
+000209b0: 656e 745f 6361 6c6c 6261 636b 280a 2020  ent_callback(.  
+000209c0: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
+000209d0: 636b 732e 696e 7669 7465 5f63 616c 6c62  cks.invite_callb
+000209e0: 6163 6b2c 2028 496e 7669 7465 4d65 6d62  ack, (InviteMemb
+000209f0: 6572 4576 656e 742c 290a 2020 2020 2020  erEvent,).      
+00020a00: 2020 290a 2020 2020 7072 696e 7428 0a20    ).    print(. 
+00020a10: 2020 2020 2020 2022 5468 6973 2070 726f         "This pro
+00020a20: 6772 616d 2069 7320 7265 6164 7920 616e  gram is ready an
+00020a30: 6420 6c69 7374 656e 696e 6720 666f 7220  d listening for 
+00020a40: 6974 7320 4d61 7472 6978 206d 6573 7361  its Matrix messa
+00020a50: 6765 732e 2022 0a20 2020 2020 2020 2022  ges. ".        "
+00020a60: 546f 2073 746f 7020 7072 6f67 7261 6d20  To stop program 
+00020a70: 7479 7065 2043 6f6e 7472 6f6c 2d43 206f  type Control-C o
+00020a80: 6e20 6b65 7962 6f61 7264 206f 7220 7365  n keyboard or se
+00020a90: 6e64 2073 6967 6e61 6c20 220a 2020 2020  nd signal ".    
+00020aa0: 2020 2020 6622 746f 2070 726f 6365 7373      f"to process
+00020ab0: 207b 6f73 2e67 6574 7069 6428 297d 2e20   {os.getpid()}. 
+00020ac0: 5049 4420 6361 6e20 616c 736f 2062 6520  PID can also be 
+00020ad0: 666f 756e 6420 696e 2022 0a20 2020 2020  found in ".     
+00020ae0: 2020 2066 2766 696c 6520 227b 5049 445f     f'file "{PID_
+00020af0: 4649 4c45 5f44 4546 4155 4c54 7d22 2e27  FILE_DEFAULT}".'
+00020b00: 2c0a 2020 2020 2020 2020 6669 6c65 3d73  ,.        file=s
+00020b10: 7973 2e73 7464 6572 722c 0a20 2020 2020  ys.stderr,.     
+00020b20: 2020 2066 6c75 7368 3d54 7275 652c 0a20     flush=True,. 
+00020b30: 2020 2029 0a20 2020 2023 2074 6865 2073     ).    # the s
+00020b40: 796e 635f 6c6f 6f70 2077 696c 6c20 6265  ync_loop will be
+00020b50: 2074 6572 6d69 6e61 7465 6420 6279 2075   terminated by u
+00020b60: 7365 7220 6869 7474 696e 6720 436f 6e74  ser hitting Cont
+00020b70: 726f 6c2d 4320 746f 2073 746f 700a 2020  rol-C to stop.  
+00020b80: 2020 6177 6169 7420 636c 6965 6e74 2e73    await client.s
+00020b90: 796e 635f 666f 7265 7665 7228 7469 6d65  ync_forever(time
+00020ba0: 6f75 743d 3330 3030 302c 2066 756c 6c5f  out=30000, full_
+00020bb0: 7374 6174 653d 5472 7565 290a 0a0a 6173  state=True)...as
+00020bc0: 796e 6320 6465 6620 6c69 7374 656e 5f69  ync def listen_i
+00020bd0: 6e76 6974 6573 5f6f 6e63 6528 636c 6965  nvites_once(clie
+00020be0: 6e74 3a20 4173 796e 6343 6c69 656e 7429  nt: AsyncClient)
+00020bf0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00020c00: 224c 6973 7465 6e20 6f6e 6365 2065 7863  "Listen once exc
+00020c10: 6c75 7369 7665 6c79 2066 6f72 2072 6f6f  lusively for roo
+00020c20: 6d20 696e 7669 7465 732c 2074 6865 6e20  m invites, then 
+00020c30: 7175 6974 2e0a 0a20 2020 2047 6574 2061  quit...    Get a
+00020c40: 6c6c 2074 6865 2072 6f6f 6d20 696e 7669  ll the room invi
+00020c50: 7461 7469 6f6e 7320 7468 6174 2061 7265  tations that are
+00020c60: 2063 7572 7265 6e74 6c79 2071 7565 7565   currently queue
+00020c70: 6420 7570 2061 6e64 2077 6169 7469 6e67  d up and waiting
+00020c80: 2e0a 2020 2020 4c69 7374 2074 6865 6d20  ..    List them 
+00020c90: 6f72 206a 6f69 6e20 7468 6573 6520 726f  or join these ro
+00020ca0: 6f6d 732e 2054 6865 6e20 6c65 6176 652e  oms. Then leave.
+00020cb0: 0a20 2020 2022 2222 0a20 2020 2023 2053  .    """.    # S
+00020cc0: 6574 2075 7020 6576 656e 7420 6361 6c6c  et up event call
+00020cd0: 6261 636b 730a 2020 2020 6361 6c6c 6261  backs.    callba
+00020ce0: 636b 7320 3d20 4361 6c6c 6261 636b 7328  cks = Callbacks(
+00020cf0: 636c 6965 6e74 290a 2020 2020 6773 2e6c  client).    gs.l
+00020d00: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+00020d10: 2020 2252 6567 6973 7465 7269 6e67 2074    "Registering t
+00020d20: 6f20 6c69 7374 656e 2074 6f20 6576 656e  o listen to even
+00020d30: 7473 206f 6620 7479 7065 2022 0a20 2020  ts of type ".   
+00020d40: 2020 2020 2022 496e 7669 7465 4d65 6d62       "InviteMemb
+00020d50: 6572 4576 656e 742e 204c 6973 7465 6e69  erEvent. Listeni
+00020d60: 6e67 2074 6f20 726f 6f6d 2069 6e76 6974  ng to room invit
+00020d70: 6573 2e22 0a20 2020 2029 0a20 2020 2063  es.".    ).    c
+00020d80: 6c69 656e 742e 6164 645f 6576 656e 745f  lient.add_event_
+00020d90: 6361 6c6c 6261 636b 2863 616c 6c62 6163  callback(callbac
+00020da0: 6b73 2e69 6e76 6974 655f 6361 6c6c 6261  ks.invite_callba
+00020db0: 636b 2c20 2849 6e76 6974 654d 656d 6265  ck, (InviteMembe
+00020dc0: 7245 7665 6e74 2c29 290a 2020 2020 2320  rEvent,)).    # 
+00020dd0: 5765 2077 616e 7420 746f 2067 6574 206f  We want to get o
+00020de0: 7574 2071 7569 636b 6c79 2c20 736f 2077  ut quickly, so w
+00020df0: 6520 7265 6475 6365 6420 7469 6d65 6f75  e reduced timeou
+00020e00: 7420 746f 2031 3020 7365 632e 0a20 2020  t to 10 sec..   
+00020e10: 2023 2057 6520 7761 6e74 2074 6f20 6765   # We want to ge
+00020e20: 7420 6d65 7373 6167 6573 2061 6e64 2071  t messages and q
+00020e30: 7569 742c 2073 6f20 7765 2063 616c 6c20  uit, so we call 
+00020e40: 7379 6e63 2829 2069 6e73 7465 6164 206f  sync() instead o
+00020e50: 660a 2020 2020 2320 7379 6e63 5f66 6f72  f.    # sync_for
+00020e60: 6576 6572 2829 2e0a 2020 2020 7265 7370  ever()..    resp
+00020e70: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00020e80: 7379 6e63 2874 696d 656f 7574 3d31 3030  sync(timeout=100
+00020e90: 3030 2c20 6675 6c6c 5f73 7461 7465 3d46  00, full_state=F
+00020ea0: 616c 7365 290a 2020 2020 6966 2069 7369  alse).    if isi
+00020eb0: 6e73 7461 6e63 6528 7265 7370 2c20 5379  nstance(resp, Sy
+00020ec0: 6e63 5265 7370 6f6e 7365 293a 0a20 2020  ncResponse):.   
+00020ed0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00020ee0: 6728 0a20 2020 2020 2020 2020 2020 2066  g(.            f
+00020ef0: 2253 796e 6320 7375 6363 6573 7366 756c  "Sync successful
+00020f00: 2e20 5265 7370 6f6e 7365 2069 733a 207b  . Response is: {
+00020f10: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+00020f20: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+00020f30: 2020 2020 290a 2020 2020 656c 7365 3a0a      ).    else:.
+00020f40: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00020f50: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00020f60: 2020 2245 3136 303a 2022 2066 2253 796e    "E160: " f"Syn
+00020f70: 6320 6661 696c 6564 2e20 4572 726f 7220  c failed. Error 
+00020f80: 6973 3a20 7b70 7269 7661 6379 5f66 696c  is: {privacy_fil
+00020f90: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00020fa0: 0a20 2020 2020 2020 2029 0a20 2020 2023  .        ).    #
+00020fb0: 2073 796e 6328 2920 666f 7263 6573 2074   sync() forces t
+00020fc0: 6865 206d 6573 7361 6765 5f63 616c 6c62  he message_callb
+00020fd0: 6163 6b28 2920 746f 2066 6972 650a 2020  ack() to fire.  
+00020fe0: 2020 2320 666f 7220 6561 6368 206e 6577    # for each new
+00020ff0: 206d 6573 7361 6765 2070 7265 7365 6e74   message present
+00021000: 6564 2069 6e20 7468 6520 7379 6e63 2829  ed in the sync()
+00021010: 2e0a 0a0a 6173 796e 6320 6465 6620 6c69  ....async def li
+00021020: 7374 656e 5f6f 6e63 6528 636c 6965 6e74  sten_once(client
+00021030: 3a20 4173 796e 6343 6c69 656e 7429 202d  : AsyncClient) -
+00021040: 3e20 4e6f 6e65 3a0a 2020 2020 2222 224c  > None:.    """L
+00021050: 6973 7465 6e20 6f6e 6365 2c20 7468 656e  isten once, then
+00021060: 2071 7569 742e 0a0a 2020 2020 4765 7420   quit...    Get 
+00021070: 616c 6c20 7468 6520 6d65 7373 6167 6573  all the messages
+00021080: 2074 6861 7420 6172 6520 6375 7272 656e   that are curren
+00021090: 746c 7920 7175 6575 6564 2075 7020 616e  tly queued up an
+000210a0: 6420 7761 6974 696e 672e 0a20 2020 2050  d waiting..    P
+000210b0: 7269 6e74 2074 6865 6d2e 2054 6865 6e20  rint them. Then 
+000210c0: 6c65 6176 652e 0a20 2020 2022 2222 0a20  leave..    """. 
+000210d0: 2020 2023 2053 6574 2075 7020 6576 656e     # Set up even
+000210e0: 7420 6361 6c6c 6261 636b 730a 2020 2020  t callbacks.    
+000210f0: 6361 6c6c 6261 636b 7320 3d20 4361 6c6c  callbacks = Call
+00021100: 6261 636b 7328 636c 6965 6e74 290a 2020  backs(client).  
+00021110: 2020 636c 6965 6e74 2e61 6464 5f65 7665    client.add_eve
+00021120: 6e74 5f63 616c 6c62 6163 6b28 6361 6c6c  nt_callback(call
+00021130: 6261 636b 732e 6d65 7373 6167 655f 6361  backs.message_ca
+00021140: 6c6c 6261 636b 2c20 2852 6f6f 6d4d 6573  llback, (RoomMes
+00021150: 7361 6765 2c29 290a 2020 2020 6966 2067  sage,)).    if g
+00021160: 732e 7061 2e72 6f6f 6d5f 696e 7669 7465  s.pa.room_invite
+00021170: 733a 0a20 2020 2020 2020 2067 732e 6c6f  s:.        gs.lo
+00021180: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00021190: 2020 2020 2022 5265 6769 7374 6572 696e       "Registerin
+000211a0: 6720 746f 206c 6973 7465 6e20 746f 2065  g to listen to e
+000211b0: 7665 6e74 7320 6f66 2074 7970 6520 220a  vents of type ".
+000211c0: 2020 2020 2020 2020 2020 2020 2249 6e76              "Inv
+000211d0: 6974 654d 656d 6265 7245 7665 6e74 2e20  iteMemberEvent. 
+000211e0: 4c69 7374 656e 696e 6720 746f 2072 6f6f  Listening to roo
+000211f0: 6d20 696e 7669 7465 732e 220a 2020 2020  m invites.".    
+00021200: 2020 2020 290a 2020 2020 2020 2020 636c      ).        cl
+00021210: 6965 6e74 2e61 6464 5f65 7665 6e74 5f63  ient.add_event_c
+00021220: 616c 6c62 6163 6b28 0a20 2020 2020 2020  allback(.       
+00021230: 2020 2020 2063 616c 6c62 6163 6b73 2e69       callbacks.i
+00021240: 6e76 6974 655f 6361 6c6c 6261 636b 2c20  nvite_callback, 
+00021250: 2849 6e76 6974 654d 656d 6265 7245 7665  (InviteMemberEve
+00021260: 6e74 2c29 0a20 2020 2020 2020 2029 0a20  nt,).        ). 
+00021270: 2020 2023 2057 6520 7761 6e74 2074 6f20     # We want to 
+00021280: 6765 7420 6f75 7420 7175 6963 6b6c 792c  get out quickly,
+00021290: 2073 6f20 7765 2072 6564 7563 6564 2074   so we reduced t
+000212a0: 696d 656f 7574 2074 6f20 3130 2073 6563  imeout to 10 sec
+000212b0: 2e0a 2020 2020 2320 5765 2077 616e 7420  ..    # We want 
+000212c0: 746f 2067 6574 206d 6573 7361 6765 7320  to get messages 
+000212d0: 616e 6420 7175 6974 2c20 736f 2077 6520  and quit, so we 
+000212e0: 6361 6c6c 2073 796e 6328 2920 696e 7374  call sync() inst
+000212f0: 6561 6420 6f66 0a20 2020 2023 2073 796e  ead of.    # syn
+00021300: 635f 666f 7265 7665 7228 292e 0a20 2020  c_forever()..   
+00021310: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
+00021320: 6965 6e74 2e73 796e 6328 7469 6d65 6f75  ient.sync(timeou
+00021330: 743d 3130 3030 302c 2066 756c 6c5f 7374  t=10000, full_st
+00021340: 6174 653d 4661 6c73 6529 0a20 2020 2069  ate=False).    i
+00021350: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+00021360: 702c 2053 796e 6352 6573 706f 6e73 6529  p, SyncResponse)
+00021370: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+00021380: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00021390: 2020 2020 6622 5379 6e63 2073 7563 6365      f"Sync succe
+000213a0: 7373 6675 6c2e 2052 6573 706f 6e73 6520  ssful. Response 
+000213b0: 6973 3a20 7b70 7269 7661 6379 5f66 696c  is: {privacy_fil
+000213c0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+000213d0: 0a20 2020 2020 2020 2029 0a20 2020 2065  .        ).    e
+000213e0: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
+000213f0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00021400: 2020 2020 2020 2022 4531 3630 3a20 2220         "E160: " 
+00021410: 6622 5379 6e63 2066 6169 6c65 642e 2045  f"Sync failed. E
+00021420: 7272 6f72 2069 733a 207b 7072 6976 6163  rror is: {privac
+00021430: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+00021440: 7029 297d 220a 2020 2020 2020 2020 290a  p))}".        ).
+00021450: 2020 2020 2320 7379 6e63 2829 2066 6f72      # sync() for
+00021460: 6365 7320 7468 6520 6d65 7373 6167 655f  ces the message_
+00021470: 6361 6c6c 6261 636b 2829 2074 6f20 6669  callback() to fi
+00021480: 7265 0a20 2020 2023 2066 6f72 2065 6163  re.    # for eac
+00021490: 6820 6e65 7720 6d65 7373 6167 6520 7072  h new message pr
+000214a0: 6573 656e 7465 6420 696e 2074 6865 2073  esented in the s
+000214b0: 796e 6328 292e 0a0a 0a61 7379 6e63 2064  ync()....async d
+000214c0: 6566 206c 6973 7465 6e5f 6f6e 6365 5f61  ef listen_once_a
+000214d0: 6c74 6572 6e61 7469 7665 2863 6c69 656e  lternative(clien
+000214e0: 743a 2041 7379 6e63 436c 6965 6e74 2920  t: AsyncClient) 
+000214f0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+00021500: 4c69 7374 656e 206f 6e63 652c 2074 6865  Listen once, the
+00021510: 6e20 7175 6974 2e0a 0a20 2020 2047 6574  n quit...    Get
+00021520: 2061 6c6c 2074 6865 206d 6573 7361 6765   all the message
+00021530: 7320 7468 6174 2061 7265 2063 7572 7265  s that are curre
+00021540: 6e74 6c79 2071 7565 7565 6420 7570 2061  ntly queued up a
+00021550: 6e64 2077 6169 7469 6e67 2e0a 2020 2020  nd waiting..    
+00021560: 5072 696e 7420 7468 656d 2e20 5468 656e  Print them. Then
+00021570: 206c 6561 7665 2e0a 0a20 2020 2041 6c74   leave...    Alt
+00021580: 6572 6e61 7469 7665 2069 6d70 6c65 6d65  ernative impleme
+00021590: 6e74 6174 696f 6e20 6f66 206c 6973 7465  ntation of liste
+000215a0: 6e5f 6f6e 6365 2829 2e0a 2020 2020 5765  n_once()..    We
+000215b0: 2064 6f6e 2774 2075 7365 2061 6e79 2063   don't use any c
+000215c0: 616c 6c62 6163 6b73 2061 6e64 2077 6520  allbacks and we 
+000215d0: 6a75 7374 2063 616c 6c20 7379 6e63 2829  just call sync()
+000215e0: 2061 6e64 2067 6574 2061 6c6c 0a20 2020   and get all.   
+000215f0: 206f 6620 7468 6520 4d65 7373 6167 6545   of the MessageE
+00021600: 7665 6e74 7320 6672 6f6d 2074 6865 2074  vents from the t
+00021610: 696d 656c 696e 6520 6f66 2074 6865 2072  imeline of the r
+00021620: 6570 6c79 2070 726f 7669 6465 6420 6279  eply provided by
+00021630: 0a20 2020 2073 796e 6328 292e 2054 6869  .    sync(). Thi
+00021640: 7320 6973 206d 6f72 6520 776f 726b 2074  s is more work t
+00021650: 6861 6e20 6c69 7374 656e 5f6f 6e63 6528  han listen_once(
+00021660: 2920 6275 7420 6974 2069 7320 696e 7465  ) but it is inte
+00021670: 7265 7374 696e 670a 2020 2020 6361 7365  resting.    case
+00021680: 2073 7475 6479 2074 6f20 756e 6465 7273   study to unders
+00021690: 7461 6e64 2073 796e 6328 292e 0a0a 2020  tand sync()...  
+000216a0: 2020 7379 6e63 2829 2072 6573 706f 6e73    sync() respons
+000216b0: 6520 696e 636c 7564 6573 2074 6865 206d  e includes the m
+000216c0: 656d 6265 7220 6072 6f6f 6d73 6020 286f  ember `rooms` (o
+000216d0: 6620 636c 6173 7320 6e69 6f2e 7265 7370  f class nio.resp
+000216e0: 6f6e 7365 732e 526f 6f6d 7329 2e0a 2020  onses.Rooms)..  
+000216f0: 2020 526f 6f6d 7320 6861 7665 2033 2074    Rooms have 3 t
+00021700: 6f70 2064 6963 7473 2e0a 2020 2020 526f  op dicts..    Ro
+00021710: 6f6d 7328 696e 7669 7465 3d7b 7d2c 206a  oms(invite={}, j
+00021720: 6f69 6e3d 7b2e 2e2e 7d2c 206c 6561 7665  oin={...}, leave
+00021730: 3d7b 7d29 0a20 2020 206a 6f69 6e20 6861  ={}).    join ha
+00021740: 7320 6120 6469 6374 2065 6e74 7279 206f  s a dict entry o
+00021750: 6620 7479 7065 2052 6f6f 6d49 6e66 6f20  f type RoomInfo 
+00021760: 666f 720a 2020 2020 6561 6368 2072 6f6f  for.    each roo
+00021770: 6d2e 2041 6e64 2074 6865 2052 6f6f 6d49  m. And the RoomI
+00021780: 6e66 6f20 6861 7320 6120 7469 6d65 6c69  nfo has a timeli
+00021790: 6e65 2028 6f66 2063 6c61 7373 2054 696d  ne (of class Tim
+000217a0: 654c 696e 6529 2077 6974 680a 2020 2020  eLine) with.    
+000217b0: 616c 6c20 6375 7272 656e 746c 7920 7175  all currently qu
+000217c0: 6575 6564 2075 7020 6576 656e 7473 2e20  eued up events. 
+000217d0: 536f 2c20 7469 6d65 6c69 6e65 2068 6173  So, timeline has
+000217e0: 2061 206c 6973 7420 6f66 2065 7665 6e74   a list of event
+000217f0: 730a 2020 2020 7375 6368 2061 7320 526f  s.    such as Ro
+00021800: 6f6d 4d65 7373 6167 6554 6578 742c 2052  omMessageText, R
+00021810: 6f6f 6d4d 6573 7361 6765 4e6f 7469 6365  oomMessageNotice
+00021820: 2c20 6574 632e 204f 6e65 2063 616e 2067  , etc. One can g
+00021830: 6f20 7468 726f 7567 680a 2020 2020 7468  o through.    th
+00021840: 6573 6520 7469 6d65 6c69 6e65 2065 7665  ese timeline eve
+00021850: 6e74 206c 6973 7473 2061 6e64 2070 726f  nt lists and pro
+00021860: 6365 7373 2065 6163 6820 7175 6575 6564  cess each queued
+00021870: 2075 7020 6d65 7373 6167 652e 0a0a 2020   up message...  
+00021880: 2020 5468 6973 2069 7320 616e 2065 7861    This is an exa
+00021890: 6d70 6c65 2052 6f6f 6d73 206f 626a 6563  mple Rooms objec
+000218a0: 7420 7468 6174 2069 7320 7061 7274 206f  t that is part o
+000218b0: 6620 6120 7379 6e63 2829 2072 6573 706f  f a sync() respo
+000218c0: 6e73 652e 0a20 2020 2054 6869 7320 6578  nse..    This ex
+000218d0: 616d 706c 6520 6769 7665 7320 7468 6520  ample gives the 
+000218e0: 6465 7461 696c 7320 6f6e 2032 2063 7572  details on 2 cur
+000218f0: 7265 6e74 6c79 2071 7565 7565 6420 7570  rently queued up
+00021900: 206d 6573 7361 6765 732e 0a0a 2020 2020   messages...    
+00021910: 526f 6f6d 7328 0a20 2020 2069 6e76 6974  Rooms(.    invit
+00021920: 653d 7b7d 2c0a 2020 2020 6a6f 696e 3d7b  e={},.    join={
+00021930: 2721 536f 6d65 526f 6f6d 4964 3a65 7861  '!SomeRoomId:exa
+00021940: 6d70 6c65 2e6f 7267 273a 0a20 2020 2020  mple.org':.     
+00021950: 2020 2052 6f6f 6d49 6e66 6f28 0a20 2020     RoomInfo(.   
+00021960: 2020 2020 2074 696d 656c 696e 653d 5469       timeline=Ti
+00021970: 6d65 6c69 6e65 280a 2020 2020 2020 2020  meline(.        
+00021980: 2020 2020 6576 656e 7473 3d5b 0a20 2020      events=[.   
+00021990: 2020 2020 2020 2020 2020 2020 2052 6f6f               Roo
+000219a0: 6d4d 6573 7361 6765 5465 7874 2873 6f75  mMessageText(sou
+000219b0: 7263 653d 7b0a 2020 2020 2020 2020 2020  rce={.          
+000219c0: 2020 2020 2020 2020 2020 2772 6f6f 6d5f            'room_
+000219d0: 6964 273a 2027 2153 6f6d 6552 6f6f 6d49  id': '!SomeRoomI
+000219e0: 643a 6578 616d 706c 652e 6f72 6727 2c0a  d:example.org',.
+000219f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021a00: 2020 2020 2774 7970 6527 3a20 276d 2e72      'type': 'm.r
+00021a10: 6f6f 6d2e 6d65 7373 6167 6527 2c0a 2020  oom.message',.  
+00021a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021a30: 2020 2763 6f6e 7465 6e74 273a 207b 276d    'content': {'m
+00021a40: 7367 7479 7065 273a 2027 6d2e 7465 7874  sgtype': 'm.text
+00021a50: 272c 2027 626f 6479 273a 2027 4869 2074  ', 'body': 'Hi t
+00021a60: 6865 7265 277d 2c0a 2020 2020 2020 2020  here'},.        
+00021a70: 2020 2020 2020 2020 2020 2020 2765 7665              'eve
+00021a80: 6e74 5f69 6427 3a20 2753 6f6d 6545 7665  nt_id': 'SomeEve
+00021a90: 6e74 4964 3127 2c0a 2020 2020 2020 2020  ntId1',.        
+00021aa0: 2020 2020 2020 2020 2020 2020 2773 656e              'sen
+00021ab0: 6465 7227 3a20 2740 7573 6572 313a 6578  der': '@user1:ex
+00021ac0: 616d 706c 652e 6f72 6727 2c0a 2020 2020  ample.org',.    
+00021ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ae0: 276f 7269 6769 6e5f 7365 7276 6572 5f74  'origin_server_t
+00021af0: 7327 3a20 3135 3931 3233 3438 3936 3731  s': 159123489671
+00021b00: 327d 2c0a 2020 2020 2020 2020 2020 2020  2},.            
+00021b10: 2020 2020 6576 656e 745f 6964 3d27 536f      event_id='So
+00021b20: 6d65 4576 656e 7449 6431 272c 0a20 2020  meEventId1',.   
+00021b30: 2020 2020 2020 2020 2020 2020 2073 656e               sen
+00021b40: 6465 723d 2740 7573 6572 313a 6578 616d  der='@user1:exam
+00021b50: 706c 652e 6f72 6727 2c0a 2020 2020 2020  ple.org',.      
+00021b60: 2020 2020 2020 2020 2020 7365 7276 6572            server
+00021b70: 5f74 696d 6573 7461 6d70 3d31 3539 3132  _timestamp=15912
+00021b80: 3334 3839 3637 3132 2c0a 2020 2020 2020  34896712,.      
+00021b90: 2020 2020 2020 2020 2020 6465 6372 7970            decryp
+00021ba0: 7465 643d 5472 7565 2c20 7665 7269 6669  ted=True, verifi
+00021bb0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00021bc0: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
+00021bd0: 5f6b 6579 3d27 536f 6d65 5365 6e64 6572  _key='SomeSender
+00021be0: 4b65 7931 272c 0a20 2020 2020 2020 2020  Key1',.         
+00021bf0: 2020 2020 2020 2073 6573 7369 6f6e 5f69         session_i
+00021c00: 643d 2753 6f6d 6553 6573 7369 6f6e 4964  d='SomeSessionId
+00021c10: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+00021c20: 2020 2020 7472 616e 7361 6374 696f 6e5f      transaction_
+00021c30: 6964 3d4e 6f6e 652c 0a20 2020 2020 2020  id=None,.       
+00021c40: 2020 2020 2020 2020 2062 6f64 793d 2748           body='H
+00021c50: 6920 7468 6572 6527 2c0a 2020 2020 2020  i there',.      
+00021c60: 2020 2020 2020 2020 2020 666f 726d 6174            format
+00021c70: 7465 645f 626f 6479 3d4e 6f6e 652c 0a20  ted_body=None,. 
+00021c80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00021c90: 6f72 6d61 743d 4e6f 6e65 292c 0a0a 2020  ormat=None),..  
+00021ca0: 2020 2020 2020 2020 2020 2020 2020 526f                Ro
+00021cb0: 6f6d 4d65 7373 6167 654e 6f74 6963 6528  omMessageNotice(
+00021cc0: 736f 7572 6365 3d7b 2763 6f6e 7465 6e74  source={'content
+00021cd0: 273a 207b 276d 7367 7479 7065 273a 2027  ': {'msgtype': '
+00021ce0: 6d2e 6e6f 7469 6365 272c 0a20 2020 2020  m.notice',.     
+00021cf0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00021d00: 626f 6479 273a 2027 4865 6c6c 6f27 2c0a  body': 'Hello',.
+00021d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d20: 2020 2020 2766 6f72 6d61 7427 3a20 276f      'format': 'o
+00021d30: 7267 2e6d 6174 7269 782e 6375 7374 6f6d  rg.matrix.custom
+00021d40: 2e68 746d 6c27 2c0a 2020 2020 2020 2020  .html',.        
+00021d50: 2020 2020 2020 2020 2020 2020 2766 6f72              'for
+00021d60: 6d61 7474 6564 5f62 6f64 7927 3a20 273c  matted_body': '<
+00021d70: 703e 4865 6c6c 6f3c 2f70 3e27 0a20 2020  p>Hello</p>'.   
+00021d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d90: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+00021da0: 2020 2020 2020 2020 2774 7970 6527 3a20          'type': 
+00021db0: 276d 2e72 6f6f 6d2e 6d65 7373 6167 6527  'm.room.message'
+00021dc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021dd0: 2020 2020 2020 2772 6f6f 6d5f 6964 273a        'room_id':
+00021de0: 2027 2153 6f6d 6552 6f6f 6d49 643a 6578   '!SomeRoomId:ex
+00021df0: 616d 706c 652e 6f72 6727 2c0a 2020 2020  ample.org',.    
+00021e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e10: 2765 7665 6e74 5f69 6427 3a20 2753 6f6d  'event_id': 'Som
+00021e20: 6545 7665 6e74 4964 3227 2c0a 2020 2020  eEventId2',.    
+00021e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e40: 2773 656e 6465 7227 3a20 2740 7573 6572  'sender': '@user
+00021e50: 323a 6578 616d 706c 652e 6f72 6727 2c0a  2:example.org',.
+00021e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e70: 2020 2020 276f 7269 6769 6e5f 7365 7276      'origin_serv
+00021e80: 6572 5f74 7327 3a20 3135 3931 3233 3438  er_ts': 15912348
+00021e90: 3937 3037 397d 2c0a 2020 2020 2020 2020  97079},.        
+00021ea0: 2020 2020 2020 2020 6576 656e 745f 6964          event_id
+00021eb0: 3d27 536f 6d65 4576 656e 7449 6432 272c  ='SomeEventId2',
+00021ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021ed0: 2073 656e 6465 723d 2740 7573 6572 323a   sender='@user2:
+00021ee0: 6578 616d 706c 652e 6f72 6727 2c0a 2020  example.org',.  
+00021ef0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00021f00: 7276 6572 5f74 696d 6573 7461 6d70 3d31  rver_timestamp=1
+00021f10: 3539 3132 3334 3839 3730 3739 2c20 6465  591234897079, de
+00021f20: 6372 7970 7465 643d 5472 7565 2c20 7665  crypted=True, ve
+00021f30: 7269 6669 6564 3d46 616c 7365 2c0a 2020  rified=False,.  
+00021f40: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00021f50: 6e64 6572 5f6b 6579 3d27 536f 6d65 5365  nder_key='SomeSe
+00021f60: 6e64 6572 4b65 7932 272c 0a20 2020 2020  nderKey2',.     
+00021f70: 2020 2020 2020 2020 2020 2073 6573 7369             sessi
+00021f80: 6f6e 5f69 643d 2753 6f6d 6553 6573 7369  on_id='SomeSessi
+00021f90: 6f6e 4964 3227 2c0a 2020 2020 2020 2020  onId2',.        
+00021fa0: 2020 2020 2020 2020 7472 616e 7361 6374          transact
+00021fb0: 696f 6e5f 6964 3d4e 6f6e 652c 0a20 2020  ion_id=None,.   
+00021fc0: 2020 2020 2020 2020 2020 2020 2062 6f64               bod
+00021fd0: 793d 273c 703e 4865 6c6c 6f3c 2f70 3e27  y='<p>Hello</p>'
+00021fe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021ff0: 2020 666f 726d 6174 3d27 6f72 672e 6d61    format='org.ma
+00022000: 7472 6978 2e63 7573 746f 6d2e 6874 6d6c  trix.custom.html
+00022010: 2729 0a20 2020 2020 2020 2020 2020 205d  ').            ]
+00022020: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
+00022030: 6d69 7465 643d 4661 6c73 652c 0a20 2020  mited=False,.   
+00022040: 2020 2020 2020 2020 2070 7265 765f 6261           prev_ba
+00022050: 7463 683d 2773 3136 3635 305f 3236 3437  tch='s16650_2647
+00022060: 3436 5f37 3332 5f31 3233 345f 3830 3530  46_732_1234_8050
+00022070: 5f32 5f38 3236 305f 3433 395f 3127 292c  _2_8260_439_1'),
+00022080: 0a20 2020 2020 2020 2073 7461 7465 3d5b  .        state=[
+00022090: 5d2c 0a20 2020 2020 2020 2065 7068 656d  ],.        ephem
+000220a0: 6572 616c 3d5b 5479 7069 6e67 4e6f 7469  eral=[TypingNoti
+000220b0: 6365 4576 656e 7428 7573 6572 733d 5b5d  ceEvent(users=[]
+000220c0: 292c 2052 6563 6569 7074 4576 656e 7428  ), ReceiptEvent(
+000220d0: 2e2e 2e29 5d2c 0a20 2020 2020 2020 2061  ...)],.        a
+000220e0: 6363 6f75 6e74 5f64 6174 613d 5b5d 2c0a  ccount_data=[],.
+000220f0: 2020 2020 2020 2020 7375 6d6d 6172 793d          summary=
+00022100: 526f 6f6d 5375 6d6d 6172 7928 2e2e 2e29  RoomSummary(...)
+00022110: 2c0a 2020 2020 2020 2020 756e 7265 6164  ,.        unread
+00022120: 5f6e 6f74 6966 6963 6174 696f 6e73 3d55  _notifications=U
+00022130: 6e72 6561 644e 6f74 6966 6963 6174 696f  nreadNotificatio
+00022140: 6e73 282e 2e2e 290a 2020 2020 2020 2020  ns(...).        
+00022150: 290a 2020 2020 7d2c 0a20 2020 206c 6561  ).    },.    lea
+00022160: 7665 3d7b 7d29 0a0a 2020 2020 2222 220a  ve={})..    """.
+00022170: 2020 2020 7265 7370 5f73 203d 2061 7761      resp_s = awa
+00022180: 6974 2063 6c69 656e 742e 7379 6e63 2874  it client.sync(t
+00022190: 696d 656f 7574 3d31 3030 3030 2c20 6675  imeout=10000, fu
+000221a0: 6c6c 5f73 7461 7465 3d46 616c 7365 290a  ll_state=False).
+000221b0: 2020 2020 2320 7468 6973 2070 7269 6e74      # this print
+000221c0: 7320 6120 7375 6d6d 6172 7920 6f66 2061  s a summary of a
+000221d0: 6c6c 206e 6577 206d 6573 7361 6765 7320  ll new messages 
+000221e0: 6375 7272 656e 746c 7920 7761 6974 696e  currently waitin
+000221f0: 6720 696e 2074 6865 2071 7565 7565 0a20  g in the queue. 
+00022200: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00022210: 6622 7379 6e63 2072 6573 706f 6e73 6520  f"sync response 
+00022220: 3d20 7b74 7970 6528 7265 7370 5f73 297d  = {type(resp_s)}
+00022230: 203a 3a20 7b72 6573 705f 737d 2229 0a20   :: {resp_s}"). 
+00022240: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00022250: 6622 7379 6e63 206e 6578 745f 6261 7463  f"sync next_batc
+00022260: 6820 3d20 2873 7472 2920 7b72 6573 705f  h = (str) {resp_
+00022270: 732e 6e65 7874 5f62 6174 6368 7d22 290a  s.next_batch}").
+00022280: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00022290: 2866 2273 796e 6320 726f 6f6d 7320 3d20  (f"sync rooms = 
+000222a0: 286e 696f 2e72 6573 706f 6e73 6573 2e52  (nio.responses.R
+000222b0: 6f6f 6d73 2920 7b72 6573 705f 732e 726f  ooms) {resp_s.ro
+000222c0: 6f6d 737d 2229 0a20 2020 2023 2053 6574  oms}").    # Set
+000222d0: 2075 7020 6576 656e 7420 6361 6c6c 6261   up event callba
+000222e0: 636b 730a 2020 2020 6361 6c6c 6261 636b  cks.    callback
+000222f0: 7320 3d20 4361 6c6c 6261 636b 7328 636c  s = Callbacks(cl
+00022300: 6965 6e74 290a 2020 2020 2320 4e6f 7465  ient).    # Note
+00022310: 3a20 7765 2061 7265 204e 4f54 2072 6567  : we are NOT reg
+00022320: 6973 7465 7269 6e67 2061 2063 616c 6c62  istering a callb
+00022330: 6163 6b20 6675 6e74 696f 6e21 0a20 2020  ack funtion!.   
+00022340: 2023 204c 6f6f 7020 7468 726f 7567 6820   # Loop through 
+00022350: 7468 6520 6a6f 696e 2064 6963 7469 6f6e  the join diction
+00022360: 6172 790a 2020 2020 666f 7220 726f 6f6d  ary.    for room
+00022370: 5f69 642c 2072 6f6f 6d5f 696e 666f 2069  _id, room_info i
+00022380: 6e20 7265 7370 5f73 2e72 6f6f 6d73 2e6a  n resp_s.rooms.j
+00022390: 6f69 6e2e 6974 656d 7328 293a 0a20 2020  oin.items():.   
+000223a0: 2020 2020 2065 7665 6e74 5f6c 6973 7420       event_list 
+000223b0: 3d20 726f 6f6d 5f69 6e66 6f2e 7469 6d65  = room_info.time
+000223c0: 6c69 6e65 2e65 7665 6e74 730a 2020 2020  line.events.    
+000223d0: 2020 2020 666f 7220 6576 656e 7420 696e      for event in
+000223e0: 2065 7665 6e74 5f6c 6973 743a 0a20 2020   event_list:.   
+000223f0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00022400: 6465 6275 6728 6622 7365 6e64 696e 6720  debug(f"sending 
+00022410: 6576 656e 7420 746f 2063 616c 6c62 6163  event to callbac
+00022420: 6b20 3d20 7b65 7665 6e74 7d2e 2229 0a20  k = {event}."). 
+00022430: 2020 2020 2020 2020 2020 2023 2062 6563             # bec
+00022440: 6175 7365 206f 6620 6675 6c6c 5f73 7461  ause of full_sta
+00022450: 7465 3d46 616c 7365 2069 6e20 7379 6e63  te=False in sync
+00022460: 2829 2074 6865 0a20 2020 2020 2020 2020  () the.         
+00022470: 2020 2023 2072 6f6f 6d73 206f 626a 6563     # rooms objec
+00022480: 7420 6973 206e 6f74 2066 756c 6c79 2070  t is not fully p
+00022490: 6f70 756c 6174 6564 2061 6e64 206d 6973  opulated and mis
+000224a0: 7369 6e67 2074 6865 0a20 2020 2020 2020  sing the.       
+000224b0: 2020 2020 2023 2072 6f6f 6d20 6e61 6d65       # room name
+000224c0: 732e 0a20 2020 2020 2020 2020 2020 2072  s..            r
+000224d0: 6f6f 6d20 3d20 636c 6965 6e74 2e72 6f6f  oom = client.roo
+000224e0: 6d73 5b72 6f6f 6d5f 6964 5d0a 2020 2020  ms[room_id].    
+000224f0: 2020 2020 2020 2020 6177 6169 7420 6361          await ca
+00022500: 6c6c 6261 636b 732e 6d65 7373 6167 655f  llbacks.message_
+00022510: 6361 6c6c 6261 636b 2872 6f6f 6d2c 2065  callback(room, e
+00022520: 7665 6e74 290a 2020 2020 2020 2020 6966  vent).        if
+00022530: 2065 7665 6e74 5f6c 6973 743a 2020 2320   event_list:  # 
+00022540: 6c69 7374 206e 6f74 2065 6d70 7479 0a20  list not empty. 
+00022550: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+00022560: 6576 656e 7420 3d20 6576 656e 745f 6c69  event = event_li
+00022570: 7374 5b2d 315d 0a20 2020 2020 2020 2020  st[-1].         
+00022580: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+00022590: 636c 6965 6e74 2e72 6f6f 6d5f 7265 6164  client.room_read
+000225a0: 5f6d 6172 6b65 7273 280a 2020 2020 2020  _markers(.      
+000225b0: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
+000225c0: 643d 726f 6f6d 5f69 642c 0a20 2020 2020  d=room_id,.     
+000225d0: 2020 2020 2020 2020 2020 2066 756c 6c79             fully
+000225e0: 5f72 6561 645f 6576 656e 743d 6c61 7374  _read_event=last
+000225f0: 5f65 7665 6e74 2e65 7665 6e74 5f69 642c  _event.event_id,
+00022600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022610: 2072 6561 645f 6576 656e 743d 6c61 7374   read_event=last
+00022620: 5f65 7665 6e74 2e65 7665 6e74 5f69 642c  _event.event_id,
+00022630: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00022640: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00022650: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
+00022660: 6f6f 6d52 6561 644d 6172 6b65 7273 4572  oomReadMarkersEr
+00022670: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00022680: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00022690: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+000226a0: 2020 2020 2020 2020 2272 6f6f 6d5f 7265          "room_re
+000226b0: 6164 5f6d 6172 6b65 7273 2066 6169 6c65  ad_markers faile
+000226c0: 6420 7769 7468 2072 6573 706f 6e73 6520  d with response 
+000226d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000226e0: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+000226f0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+00022700: 2929 7d2e 220a 2020 2020 2020 2020 2020  ))}.".          
+00022710: 2020 2020 2020 290a 0a0a 2320 6163 636f        )...# acco
+00022720: 7264 696e 6720 746f 2070 796c 616d 613a  rding to pylama:
+00022730: 2066 756e 6374 696f 6e20 746f 6f20 636f   function too co
+00022740: 6d70 6c65 783a 2043 3930 3120 2320 6e6f  mplex: C901 # no
+00022750: 7161 3a20 4339 3031 0a61 7379 6e63 2064  qa: C901.async d
+00022760: 6566 206c 6973 7465 6e5f 7461 696c 2820  ef listen_tail( 
+00022770: 2023 206e 6f71 613a 2043 3930 310a 2020   # noqa: C901.  
+00022780: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
+00022790: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
+000227a0: 6c73 3a20 6469 6374 0a29 202d 3e20 4e6f  ls: dict.) -> No
+000227b0: 6e65 3a20 2023 206e 6f71 613a 2043 3930  ne:  # noqa: C90
+000227c0: 310a 2020 2020 2222 2247 6574 2074 6865  1.    """Get the
+000227d0: 206c 6173 7420 4e20 6d65 7373 6167 6573   last N messages
+000227e0: 2c20 7468 656e 2071 7569 742e 0a0a 2020  , then quit...  
+000227f0: 2020 4172 6775 6d65 6e74 733a 0a20 2020    Arguments:.   
+00022800: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020   ---------.     
+00022810: 2020 2063 6c69 656e 743a 2041 7379 6e63     client: Async
+00022820: 436c 6965 6e74 203a 2074 6865 2063 7265  Client : the cre
+00022830: 6174 6564 204e 494f 2063 6c69 656e 740a  ated NIO client.
+00022840: 2020 2020 2020 2020 6372 6564 656e 7469          credenti
+00022850: 616c 733a 2064 6963 7420 3a20 6372 6564  als: dict : cred
+00022860: 656e 7469 616c 7320 6469 6374 696f 6e61  entials dictiona
+00022870: 7279 2066 726f 6d20 7468 6520 6372 6564  ry from the cred
+00022880: 656e 7469 616c 7320 6669 6c65 0a0a 2020  entials file..  
+00022890: 2020 4765 7420 7468 6520 6c61 7374 204e    Get the last N
+000228a0: 206d 6573 7361 6765 732e 2053 6f6d 6520   messages. Some 
+000228b0: 6d69 6768 7420 6265 206f 6c64 2c20 692e  might be old, i.
+000228c0: 652e 2061 6c72 6561 6479 0a20 2020 2072  e. already.    r
+000228d0: 6561 6420 6265 666f 7265 2c20 736f 6d65  ead before, some
+000228e0: 206d 6967 6874 2062 6520 6e65 772c 2069   might be new, i
+000228f0: 2e65 2e20 6e65 7665 7220 7265 6164 2062  .e. never read b
+00022900: 6566 6f72 652e 0a20 2020 2050 7269 6e74  efore..    Print
+00022910: 2074 6865 6d2e 2054 6865 6e20 6c65 6176   them. Then leav
+00022920: 652e 0a0a 2020 2020 4966 2074 6865 7265  e...    If there
+00022930: 2061 7265 206c 6573 7320 7468 616e 204e   are less than N
+00022940: 206d 6573 7361 6765 732c 2067 6574 2075   messages, get u
+00022950: 7020 746f 204e 2e0a 0a20 2020 2054 6865  p to N...    The
+00022960: 2066 756e 6374 696f 6e20 726f 6f6d 5f6d   function room_m
+00022970: 6573 7361 6765 7328 2920 6973 2075 7365  essages() is use
+00022980: 6420 746f 2067 6574 0a20 2020 2074 6865  d to get.    the
+00022990: 206c 6173 7420 4e20 6d65 7373 6167 6573   last N messages
+000229a0: 2e0a 0a20 2020 2022 2222 0a20 2020 2023  ...    """.    #
+000229b0: 2077 6520 6361 6c6c 2073 796e 6328 2920   we call sync() 
+000229c0: 746f 2067 6574 2074 6865 206e 6578 745f  to get the next_
+000229d0: 6261 7463 6820 6d61 726b 6572 0a20 2020  batch marker.   
+000229e0: 2023 2077 6520 7365 7420 6675 6c6c 5f73   # we set full_s
+000229f0: 7461 7465 3d54 7275 6520 746f 2067 6574  tate=True to get
+00022a00: 2061 6c6c 2072 6f6f 6d5f 6964 730a 2020   all room_ids.  
+00022a10: 2020 7265 7370 5f73 203d 2061 7761 6974    resp_s = await
+00022a20: 2073 796e 6368 726f 6e69 7a65 2863 6c69   synchronize(cli
+00022a30: 656e 7429 2020 2320 7379 6e63 2829 2074  ent)  # sync() t
+00022a40: 6f20 6765 7420 726f 6f6d 730a 2020 2020  o get rooms.    
+00022a50: 2320 7468 6973 2070 7269 6e74 7320 6120  # this prints a 
+00022a60: 7375 6d6d 6172 7920 6f66 2061 6c6c 206e  summary of all n
+00022a70: 6577 206d 6573 7361 6765 7320 6375 7272  ew messages curr
+00022a80: 656e 746c 7920 7761 6974 696e 6720 696e  ently waiting in
+00022a90: 2074 6865 2071 7565 7565 0a20 2020 2067   the queue.    g
+00022aa0: 732e 6c6f 672e 6465 6275 6728 6622 7379  s.log.debug(f"sy
+00022ab0: 6e63 2072 6573 706f 6e73 6520 3d20 7b74  nc response = {t
+00022ac0: 7970 6528 7265 7370 5f73 297d 203a 3a20  ype(resp_s)} :: 
+00022ad0: 7b72 6573 705f 737d 2229 0a20 2020 2067  {resp_s}").    g
+00022ae0: 732e 6c6f 672e 6465 6275 6728 6622 636c  s.log.debug(f"cl
+00022af0: 6965 6e74 2e6e 6578 745f 6261 7463 6820  ient.next_batch 
+00022b00: 6166 7465 7220 3d20 2873 7472 2920 7b63  after = (str) {c
+00022b10: 6c69 656e 742e 6e65 7874 5f62 6174 6368  lient.next_batch
+00022b20: 7d22 290a 2020 2020 6773 2e6c 6f67 2e64  }").    gs.log.d
+00022b30: 6562 7567 2866 2273 796e 6320 6e65 7874  ebug(f"sync next
+00022b40: 5f62 6174 6368 203d 2028 7374 7229 207b  _batch = (str) {
+00022b50: 7265 7370 5f73 2e6e 6578 745f 6261 7463  resp_s.next_batc
+00022b60: 687d 2229 0a20 2020 2067 732e 6c6f 672e  h}").    gs.log.
+00022b70: 6465 6275 6728 6622 7379 6e63 2072 6f6f  debug(f"sync roo
+00022b80: 6d73 203d 2028 6e69 6f2e 7265 7370 6f6e  ms = (nio.respon
+00022b90: 7365 732e 526f 6f6d 7329 207b 7265 7370  ses.Rooms) {resp
+00022ba0: 5f73 2e72 6f6f 6d73 7d22 290a 2020 2020  _s.rooms}").    
+00022bb0: 6773 2e6c 6f67 2e64 6562 7567 2866 2263  gs.log.debug(f"c
+00022bc0: 6c69 656e 742e 726f 6f6d 7320 3d20 7b63  lient.rooms = {c
+00022bd0: 6c69 656e 742e 726f 6f6d 737d 2229 0a20  lient.rooms}"). 
+00022be0: 2020 2069 6620 6e6f 7420 7265 7370 5f73     if not resp_s
+00022bf0: 2e72 6f6f 6d73 2e6a 6f69 6e3a 2020 2320  .rooms.join:  # 
+00022c00: 6e6f 2052 6f6f 6d73 210a 2020 2020 2020  no Rooms!.      
+00022c10: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+00022c20: 2273 796e 6320 7265 7475 726e 6564 206e  "sync returned n
+00022c30: 6f20 726f 6f6d 7320 3d20 7b72 6573 705f  o rooms = {resp_
+00022c40: 732e 726f 6f6d 732e 6a6f 696e 7d22 290a  s.rooms.join}").
+00022c50: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00022c60: 2020 2020 2320 5365 7420 7570 2065 7665      # Set up eve
+00022c70: 6e74 2063 616c 6c62 6163 6b73 0a20 2020  nt callbacks.   
+00022c80: 2063 616c 6c62 6163 6b73 203d 2043 616c   callbacks = Cal
+00022c90: 6c62 6163 6b73 2863 6c69 656e 7429 0a20  lbacks(client). 
+00022ca0: 2020 2023 204e 6f74 653a 2077 6520 6172     # Note: we ar
+00022cb0: 6520 4e4f 5420 7265 6769 7374 6572 696e  e NOT registerin
+00022cc0: 6720 6120 6361 6c6c 6261 636b 2066 756e  g a callback fun
+00022cd0: 7469 6f6e 210a 0a20 2020 2023 2072 6f6f  tion!..    # roo
+00022ce0: 6d5f 6964 203d 206c 6973 7428 7265 7370  m_id = list(resp
+00022cf0: 5f73 2e72 6f6f 6d73 2e6a 6f69 6e2e 6b65  _s.rooms.join.ke
+00022d00: 7973 2829 295b 305d 2020 2320 6669 7273  ys())[0]  # firs
+00022d10: 7420 726f 6f6d 5f69 6420 6672 6f6d 2064  t room_id from d
+00022d20: 6963 740a 2020 2020 2320 616c 7465 726e  ict.    # altern
+00022d30: 6174 6976 6520 7761 7920 6f66 2067 6574  ative way of get
+00022d40: 7469 6e67 2072 6f6f 6d5f 6964 2c20 636c  ting room_id, cl
+00022d50: 6965 6e74 2e72 6f6f 6d73 2069 7320 616c  ient.rooms is al
+00022d60: 736f 2061 2064 6963 740a 2020 2020 2320  so a dict.    # 
+00022d70: 726f 6f6d 5f69 6420 3d20 6c69 7374 2863  room_id = list(c
+00022d80: 6c69 656e 742e 726f 6f6d 732e 6b65 7973  lient.rooms.keys
+00022d90: 2829 295b 305d 2020 2320 6669 7273 7420  ())[0]  # first 
+00022da0: 726f 6f6d 5f69 6420 6672 6f6d 2064 6963  room_id from dic
+00022db0: 740a 0a20 2020 2023 2067 6574 2072 6f6f  t..    # get roo
+00022dc0: 6d73 2061 7320 7370 6563 6966 6965 6420  ms as specified 
+00022dd0: 6279 2074 6865 2075 7365 7220 7468 7275  by the user thru
+00022de0: 2061 7267 7320 6f72 2063 7265 6465 6e74   args or credent
+00022df0: 6961 6c20 6669 6c65 0a20 2020 2072 6f6f  ial file.    roo
+00022e00: 6d73 203d 2061 7761 6974 2064 6574 6572  ms = await deter
+00022e10: 6d69 6e65 5f72 6f6f 6d73 2863 7265 6465  mine_rooms(crede
+00022e20: 6e74 6961 6c73 5b22 726f 6f6d 5f69 6422  ntials["room_id"
+00022e30: 5d2c 2063 6c69 656e 742c 2063 7265 6465  ], client, crede
+00022e40: 6e74 6961 6c73 290a 2020 2020 6c69 6d69  ntials).    limi
+00022e50: 7420 3d20 6773 2e70 612e 7461 696c 0a20  t = gs.pa.tail. 
+00022e60: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00022e70: 6622 526f 6f6d 7320 6172 653a 207b 726f  f"Rooms are: {ro
+00022e80: 6f6d 737d 2c20 6c69 6d69 7420 6973 207b  oms}, limit is {
+00022e90: 6c69 6d69 747d 2229 0a20 2020 2023 2054  limit}").    # T
+00022ea0: 6f20 6c6f 6f70 206f 7665 7220 616c 6c20  o loop over all 
+00022eb0: 726f 6f6d 732c 206f 6e65 2063 616e 206c  rooms, one can l
+00022ec0: 6f6f 7020 7468 726f 7567 6820 7468 6520  oop through the 
+00022ed0: 6a6f 696e 2064 6963 7469 6f6e 6172 792e  join dictionary.
+00022ee0: 2069 2e65 2e0a 2020 2020 2320 666f 7220   i.e..    # for 
+00022ef0: 726f 6f6d 5f69 642c 2072 6f6f 6d5f 696e  room_id, room_in
+00022f00: 666f 2069 6e20 7265 7370 5f73 2e72 6f6f  fo in resp_s.roo
+00022f10: 6d73 2e6a 6f69 6e2e 6974 656d 7328 293a  ms.join.items():
+00022f20: 2020 2320 6c6f 6f70 2061 6c6c 2072 6f6f    # loop all roo
+00022f30: 6d73 0a20 2020 2066 6f72 2072 6f6f 6d5f  ms.    for room_
+00022f40: 6964 2069 6e20 726f 6f6d 733a 2020 2320  id in rooms:  # 
+00022f50: 6c6f 6f70 206f 6e6c 7920 6f76 6572 2075  loop only over u
+00022f60: 7365 7220 7370 6563 6966 6965 6420 726f  ser specified ro
+00022f70: 6f6d 730a 2020 2020 2020 2020 7265 7370  oms.        resp
+00022f80: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00022f90: 726f 6f6d 5f6d 6573 7361 6765 7328 0a20  room_messages(. 
+00022fa0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
+00022fb0: 6964 2c20 7374 6172 743d 7265 7370 5f73  id, start=resp_s
+00022fc0: 2e6e 6578 745f 6261 7463 682c 206c 696d  .next_batch, lim
+00022fd0: 6974 3d6c 696d 6974 0a20 2020 2020 2020  it=limit.       
+00022fe0: 2029 0a20 2020 2020 2020 2069 6620 6973   ).        if is
+00022ff0: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
+00023000: 6f6f 6d4d 6573 7361 6765 7345 7272 6f72  oomMessagesError
+00023010: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
+00023020: 732e 6c6f 672e 7761 726e 696e 6728 0a20  s.log.warning(. 
+00023030: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00023040: 5731 3036 3a20 220a 2020 2020 2020 2020  W106: ".        
+00023050: 2020 2020 2020 2020 6622 726f 6f6d 5f6d          f"room_m
+00023060: 6573 7361 6765 7320 6661 696c 6564 2077  essages failed w
+00023070: 6974 6820 7265 7370 6f6e 7365 2022 0a20  ith response ". 
+00023080: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00023090: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
+000230a0: 2873 7472 2872 6573 7029 297d 2e20 220a  (str(resp))}. ".
+000230b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230c0: 2250 726f 6365 7373 696e 6720 636f 6e74  "Processing cont
+000230d0: 696e 7565 732e 220a 2020 2020 2020 2020  inues.".        
+000230e0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000230f0: 2020 6773 2e77 6172 6e5f 636f 756e 7420    gs.warn_count 
+00023100: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00023110: 2063 6f6e 7469 6e75 6520 2023 2073 6b69   continue  # ski
+00023120: 7020 7468 6973 2072 6f6f 6d0a 2020 2020  p this room.    
+00023130: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00023140: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+00023150: 726f 6f6d 5f6d 6573 7361 6765 7320 7265  room_messages re
+00023160: 7370 6f6e 7365 203d 207b 7479 7065 2872  sponse = {type(r
+00023170: 6573 7029 7d20 3a3a 2022 0a20 2020 2020  esp)} :: ".     
+00023180: 2020 2020 2020 2066 227b 7072 6976 6163         f"{privac
+00023190: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+000231a0: 7029 297d 2e22 0a20 2020 2020 2020 2029  p))}.".        )
+000231b0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+000231c0: 6465 6275 6728 6622 726f 6f6d 5f6d 6573  debug(f"room_mes
+000231d0: 7361 6765 7320 726f 6f6d 5f69 6420 3d20  sages room_id = 
+000231e0: 7b72 6573 702e 726f 6f6d 5f69 647d 2e22  {resp.room_id}."
+000231f0: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
+00023200: 2e64 6562 7567 2866 2272 6f6f 6d5f 6d65  .debug(f"room_me
+00023210: 7373 6167 6573 2073 7461 7274 203d 2028  ssages start = (
+00023220: 7374 7229 207b 7265 7370 2e73 7461 7274  str) {resp.start
+00023230: 7d2e 2229 0a20 2020 2020 2020 2067 732e  }.").        gs.
+00023240: 6c6f 672e 6465 6275 6728 6622 726f 6f6d  log.debug(f"room
+00023250: 5f6d 6573 7361 6765 7320 656e 6420 3d20  _messages end = 
+00023260: 2873 7472 2920 3a3a 207b 7265 7370 2e65  (str) :: {resp.e
+00023270: 6e64 7d2e 2229 0a20 2020 2020 2020 2067  nd}.").        g
+00023280: 732e 6c6f 672e 6465 6275 6728 6622 726f  s.log.debug(f"ro
+00023290: 6f6d 5f6d 6573 7361 6765 7320 6368 756e  om_messages chun
+000232a0: 6b20 3d20 286c 6973 7429 203a 3a20 7b72  k = (list) :: {r
+000232b0: 6573 702e 6368 756e 6b7d 2e22 290a 2020  esp.chunk}.").  
+000232c0: 2020 2020 2020 2320 6368 756e 6b20 6973        # chunk is
+000232d0: 206a 7573 7420 6120 6c69 7374 206f 6620   just a list of 
+000232e0: 526f 6f6d 4d65 7373 6167 6520 6576 656e  RoomMessage even
+000232f0: 7473 206c 696b 6520 7468 6973 2065 7861  ts like this exa
+00023300: 6d70 6c65 3a0a 2020 2020 2020 2020 2320  mple:.        # 
+00023310: 6368 756e 6b3d 5b52 6f6f 6d4d 6573 7361  chunk=[RoomMessa
+00023320: 6765 5465 7874 282e 2e2e 295d 0a0a 2020  geText(...)]..  
+00023330: 2020 2020 2020 666f 7220 6576 656e 7420        for event 
+00023340: 696e 2072 6573 702e 6368 756e 6b3a 0a20  in resp.chunk:. 
+00023350: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00023360: 672e 6465 6275 6728 6622 7365 6e64 696e  g.debug(f"sendin
+00023370: 6720 6576 656e 7420 746f 2063 616c 6c62  g event to callb
+00023380: 6163 6b20 3d20 7b65 7665 6e74 7d2e 2229  ack = {event}.")
+00023390: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000233a0: 636c 6965 6e74 2e72 6f6f 6d73 2061 6e64  client.rooms and
+000233b0: 2063 6c69 656e 742e 726f 6f6d 735b 726f   client.rooms[ro
+000233c0: 6f6d 5f69 645d 3a0a 2020 2020 2020 2020  om_id]:.        
+000233d0: 2020 2020 2020 2020 726f 6f6d 203d 2063          room = c
+000233e0: 6c69 656e 742e 726f 6f6d 735b 726f 6f6d  lient.rooms[room
+000233f0: 5f69 645d 0a20 2020 2020 2020 2020 2020  _id].           
+00023400: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00023410: 2020 2020 2020 2072 6f6f 6d20 3d20 4d61         room = Ma
+00023420: 7472 6978 526f 6f6d 2872 6f6f 6d5f 6964  trixRoom(room_id
+00023430: 2c20 4e6f 6e65 2c20 5472 7565 2920 2023  , None, True)  #
+00023440: 2064 756d 6d79 5f72 6f6f 6d0a 2020 2020   dummy_room.    
+00023450: 2020 2020 2020 2020 6177 6169 7420 6361          await ca
+00023460: 6c6c 6261 636b 732e 6d65 7373 6167 655f  llbacks.message_
+00023470: 6361 6c6c 6261 636b 2872 6f6f 6d2c 2065  callback(room, e
+00023480: 7665 6e74 290a 2020 2020 2020 2020 6966  vent).        if
+00023490: 2072 6573 702e 6368 756e 6b3a 2020 2320   resp.chunk:  # 
+000234a0: 6c69 7374 206e 6f74 2065 6d70 7479 0a20  list not empty. 
+000234b0: 2020 2020 2020 2020 2020 2023 206f 7264             # ord
+000234c0: 6572 2069 7320 7265 7665 7273 6564 2c20  er is reversed, 
+000234d0: 6669 7273 7420 656c 656d 656e 7420 6973  first element is
+000234e0: 2074 696d 6577 6973 6520 7468 6520 6e65   timewise the ne
+000234f0: 7765 7374 0a20 2020 2020 2020 2020 2020  west.           
+00023500: 2066 6972 7374 5f65 7665 6e74 203d 2072   first_event = r
+00023510: 6573 702e 6368 756e 6b5b 305d 0a20 2020  esp.chunk[0].   
+00023520: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00023530: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
+00023540: 6d5f 7265 6164 5f6d 6172 6b65 7273 280a  m_read_markers(.
+00023550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023560: 726f 6f6d 5f69 643d 726f 6f6d 5f69 642c  room_id=room_id,
+00023570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023580: 2066 756c 6c79 5f72 6561 645f 6576 656e   fully_read_even
+00023590: 743d 6669 7273 745f 6576 656e 742e 6576  t=first_event.ev
+000235a0: 656e 745f 6964 2c0a 2020 2020 2020 2020  ent_id,.        
+000235b0: 2020 2020 2020 2020 7265 6164 5f65 7665          read_eve
+000235c0: 6e74 3d66 6972 7374 5f65 7665 6e74 2e65  nt=first_event.e
+000235d0: 7665 6e74 5f69 642c 0a20 2020 2020 2020  vent_id,.       
+000235e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000235f0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00023600: 2872 6573 702c 2052 6f6f 6d52 6561 644d  (resp, RoomReadM
+00023610: 6172 6b65 7273 4572 726f 7229 3a0a 2020  arkersError):.  
+00023620: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00023630: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+00023640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023650: 2272 6f6f 6d5f 7265 6164 5f6d 6172 6b65  "room_read_marke
+00023660: 7273 2066 6169 6c65 6420 7769 7468 2072  rs failed with r
+00023670: 6573 706f 6e73 6520 220a 2020 2020 2020  esponse ".      
+00023680: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00023690: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
+000236a0: 7374 7228 7265 7370 2929 7d2e 220a 2020  str(resp))}.".  
+000236b0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000236c0: 0a0a 6173 796e 6320 6465 6620 7265 6164  ..async def read
+000236d0: 5f61 6c6c 5f65 7665 6e74 735f 696e 5f64  _all_events_in_d
+000236e0: 6972 6563 7469 6f6e 280a 2020 2020 636c  irection(.    cl
+000236f0: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+00023700: 742c 0a20 2020 2072 6f6f 6d5f 6964 3a20  t,.    room_id: 
+00023710: 7374 722c 0a20 2020 2073 7461 7274 5f74  str,.    start_t
+00023720: 6f6b 656e 3a20 7374 722c 0a20 2020 2064  oken: str,.    d
+00023730: 6972 6563 7469 6f6e 3a20 4d65 7373 6167  irection: Messag
+00023740: 6544 6972 6563 7469 6f6e 203d 204d 6573  eDirection = Mes
+00023750: 7361 6765 4469 7265 6374 696f 6e2e 6261  sageDirection.ba
+00023760: 636b 2c0a 2920 2d3e 206c 6973 743a 0a20  ck,.) -> list:. 
+00023770: 2020 2022 2222 5265 6164 2061 6c6c 2065     """Read all e
+00023780: 7665 6e74 7320 6672 6f6d 2061 2067 6976  vents from a giv
+00023790: 656e 2072 6f6f 6d20 696e 2063 6572 7461  en room in certa
+000237a0: 696e 2064 6972 6563 7469 6f6e 2e0a 0a20  in direction... 
+000237b0: 2020 2041 7267 756d 656e 7473 3a0a 2020     Arguments:.  
+000237c0: 2020 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020    ---------.    
+000237d0: 2020 2020 636c 6965 6e74 3a20 4173 796e      client: Asyn
+000237e0: 6343 6c69 656e 7420 3a20 5468 6520 6372  cClient : The cr
+000237f0: 6561 7465 6420 4e49 4f20 636c 6965 6e74  eated NIO client
+00023800: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
+00023810: 3a20 7374 7220 3a20 5468 6520 726f 6f6d  : str : The room
+00023820: 2069 6420 6f66 2074 6865 2072 6f6f 6d20   id of the room 
+00023830: 666f 7220 7768 6963 6820 7765 0a20 2020  for which we.   
+00023840: 2020 2020 2020 2020 2077 6f75 6c64 206c           would l
+00023850: 696b 6520 746f 2066 6574 6368 2074 6865  ike to fetch the
+00023860: 206d 6573 7361 6765 732e 0a20 2020 2020   messages..     
+00023870: 2020 2073 7461 7274 5f74 6f6b 656e 3a20     start_token: 
+00023880: 7374 7220 3a20 2054 6865 2074 6f6b 656e  str :  The token
+00023890: 2074 6f20 7374 6172 7420 7265 7475 726e   to start return
+000238a0: 696e 6720 6576 656e 7473 2066 726f 6d2e  ing events from.
+000238b0: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
+000238c0: 7320 746f 6b65 6e20 6361 6e20 6265 206f  s token can be o
+000238d0: 6274 6169 6e65 6420 6672 6f6d 2061 2070  btained from a p
+000238e0: 7265 765f 6261 7463 6820 746f 6b65 6e20  rev_batch token 
+000238f0: 7265 7475 726e 6564 2066 6f72 0a20 2020  returned for.   
+00023900: 2020 2020 2020 2020 2065 6163 6820 726f           each ro
+00023910: 6f6d 2062 7920 7468 6520 7379 6e63 2829  om by the sync()
+00023920: 2041 5049 2c20 6f72 2066 726f 6d20 6120   API, or from a 
+00023930: 7374 6172 7420 6f72 2065 6e64 2074 6f6b  start or end tok
+00023940: 656e 2072 6574 7572 6e65 640a 2020 2020  en returned.    
+00023950: 2020 2020 2020 2020 6279 2061 2070 7265          by a pre
+00023960: 7669 6f75 7320 7265 7175 6573 7420 746f  vious request to
+00023970: 2072 6f6f 6d5f 6d65 7373 6167 6573 2829   room_messages()
+00023980: 2e0a 2020 2020 2020 2020 6469 7265 6374  ..        direct
+00023990: 696f 6e3a 204d 6573 7361 6765 4469 7265  ion: MessageDire
+000239a0: 6374 696f 6e20 286f 7074 696f 6e61 6c29  ction (optional)
+000239b0: 3a20 5468 6520 6469 7265 6374 696f 6e20  : The direction 
+000239c0: 746f 2072 6574 7572 6e0a 2020 2020 2020  to return.      
+000239d0: 2020 2020 2020 6576 656e 7473 2066 726f        events fro
+000239e0: 6d2e 2044 6566 6175 6c74 7320 746f 204d  m. Defaults to M
+000239f0: 6573 7361 6765 4469 7265 6374 696f 6e2e  essageDirection.
+00023a00: 6261 636b 2e0a 0a20 2020 2052 6574 7572  back...    Retur
+00023a10: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00023a20: 2020 2020 2020 206c 6973 743a 206c 6973         list: lis
+00023a30: 7420 6f66 2052 6f6f 6d4d 6573 7361 6765  t of RoomMessage
+00023a40: 2065 7665 6e74 732c 2063 6f75 6c64 2062   events, could b
+00023a50: 6520 656d 7074 790a 0a20 2020 2052 6561  e empty..    Rea
+00023a60: 6420 616c 6c20 6d65 7373 6167 6573 206f  d all messages o
+00023a70: 6620 6120 726f 6f6d 2062 6567 696e 6e69  f a room beginni
+00023a80: 6e67 2066 726f 6d20 7468 6520 7061 7374  ng from the past
+00023a90: 5f74 6f6b 656e 0a20 2020 2074 6f20 6f6c  _token.    to ol
+00023aa0: 6465 7374 206f 7220 6e65 7765 7374 206d  dest or newest m
+00023ab0: 6573 7361 6765 2028 6465 7065 6e64 696e  essage (dependin
+00023ac0: 6720 6f6e 2074 6865 2064 6972 6563 7469  g on the directi
+00023ad0: 6f6e 292e 0a0a 2020 2020 2222 220a 2020  on)...    """.  
+00023ae0: 2020 616c 6c5f 6576 656e 7473 203d 205b    all_events = [
+00023af0: 5d0a 2020 2020 6375 7272 656e 745f 7374  ].    current_st
+00023b00: 6172 745f 746f 6b65 6e20 3d20 7374 6172  art_token = star
+00023b10: 745f 746f 6b65 6e0a 2020 2020 2320 6973  t_token.    # is
+00023b20: 2063 6170 7065 6420 6174 2031 3030 3020   capped at 1000 
+00023b30: 6174 2073 6572 7665 7220 7369 6465 0a20  at server side. 
+00023b40: 2020 2023 2031 3020 7365 656d 7320 746f     # 10 seems to
+00023b50: 6f20 736d 616c 6c2c 2069 2e65 2e20 746f  o small, i.e. to
+00023b60: 6f20 736c 6f77 0a20 2020 2023 2031 3030  o slow.    # 100
+00023b70: 2074 6f20 3530 3020 7365 656d 2067 6f6f   to 500 seem goo
+00023b80: 6420 7661 6c75 6573 2c20 6465 7065 6e64  d values, depend
+00023b90: 7320 6f6e 206e 6574 776f 726b 2073 7065  s on network spe
+00023ba0: 6564 2c20 7365 7276 6572 206c 6f61 642c  ed, server load,
+00023bb0: 202e 2e2e 0a20 2020 2023 2065 7861 6d70   ....    # examp
+00023bc0: 6c65 2072 756e 3a20 3235 302d 2d3e 376d  le run: 250-->7m
+00023bd0: 696e 3330 732c 2035 3030 2d2d 3e34 6d69  in30s, 500-->4mi
+00023be0: 6e33 3073 0a20 2020 206d 6178 5f6d 7367  n30s.    max_msg
+00023bf0: 5f70 6572 5f70 756c 6c20 3d20 3530 300a  _per_pull = 500.
+00023c00: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
+00023c10: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00023c20: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00023c30: 6177 6169 7420 636c 6965 6e74 2e72 6f6f  await client.roo
+00023c40: 6d5f 6d65 7373 6167 6573 280a 2020 2020  m_messages(.    
+00023c50: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+00023c60: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00023c70: 2020 2020 2063 7572 7265 6e74 5f73 7461       current_sta
+00023c80: 7274 5f74 6f6b 656e 2c0a 2020 2020 2020  rt_token,.      
+00023c90: 2020 2020 2020 2020 2020 6c69 6d69 743d            limit=
+00023ca0: 6d61 785f 6d73 675f 7065 725f 7075 6c6c  max_msg_per_pull
+00023cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023cc0: 2020 6469 7265 6374 696f 6e3d 6469 7265    direction=dire
+00023cd0: 6374 696f 6e2c 0a20 2020 2020 2020 2020  ction,.         
+00023ce0: 2020 2029 0a20 2020 2020 2020 2065 7863     ).        exc
+00023cf0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+00023d00: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+00023d10: 2320 6475 7269 6e67 2074 6573 7469 6e67  # during testing
+00023d20: 2049 206f 6273 6572 7665 6420 7468 6174   I observed that
+00023d30: 2073 6f6d 6574 696d 6573 2061 6e20 6578   sometimes an ex
+00023d40: 6365 7074 696f 6e20 6973 2072 6169 7365  ception is raise
+00023d50: 642c 0a20 2020 2020 2020 2020 2020 2023  d,.            #
+00023d60: 2062 7574 2065 2069 7320 656d 7074 792e   but e is empty.
+00023d70: 2053 7461 636b 7472 6163 6520 6861 6420   Stacktrace had 
+00023d80: 6173 796e 6369 6f2e 6578 6365 7074 696f  asyncio.exceptio
+00023d90: 6e73 2e54 696d 656f 7574 4572 726f 722e  ns.TimeoutError.
+00023da0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00023db0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+00023dc0: 2020 2020 2020 2020 2020 2022 4531 3631             "E161
+00023dd0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00023de0: 2020 2020 2245 7272 6f72 2064 7572 696e      "Error durin
+00023df0: 6720 6765 7474 696e 6720 6d65 7373 6167  g getting messag
+00023e00: 6573 2e20 220a 2020 2020 2020 2020 2020  es. ".          
+00023e10: 2020 2020 2020 2242 7574 2070 726f 6772        "But progr
+00023e20: 616d 2077 696c 6c20 636f 6e74 696e 7565  am will continue
+00023e30: 2061 6e79 7761 792c 2064 6573 7069 7465   anyway, despite
+00023e40: 2074 6865 2065 7272 6f72 2e20 220a 2020   the error. ".  
+00023e50: 2020 2020 2020 2020 2020 2020 2020 224e                "N
+00023e60: 6f74 2061 6c6c 206d 6573 7361 6765 7320  ot all messages 
+00023e70: 6d69 6768 7420 6861 7665 2062 6565 6e20  might have been 
+00023e80: 7265 7472 6965 7665 6420 6672 6f6d 2073  retrieved from s
+00023e90: 6572 7665 722e 2022 0a20 2020 2020 2020  erver. ".       
+00023ea0: 2020 2020 2020 2020 2066 2242 6520 7761           f"Be wa
+00023eb0: 726e 6564 2120 476f 7420 7b6c 656e 2861  rned! Got {len(a
+00023ec0: 6c6c 5f65 7665 6e74 7329 7d20 6d65 7373  ll_events)} mess
+00023ed0: 6167 6573 2073 6f20 6661 722e 220a 2020  ages so far.".  
+00023ee0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00023ef0: 4578 6365 7074 696f 6e3a 207b 7479 7065  Exception: {type
+00023f00: 2865 297d 207b 657d 220a 2020 2020 2020  (e)} {e}".      
+00023f10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00023f20: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+00023f30: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00023f40: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+00023f50: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+00023f60: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+00023f70: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00023f80: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00023f90: 6272 6561 6b0a 2020 2020 2020 2020 6966  break.        if
+00023fa0: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+00023fb0: 2c20 526f 6f6d 4d65 7373 6167 6573 4572  , RoomMessagesEr
+00023fc0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00023fd0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00023fe0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00023ff0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+00024000: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+00024010: 3136 323a 2022 0a20 2020 2020 2020 2020  162: ".         
+00024020: 2020 2020 2020 2066 2272 6f6f 6d5f 6d65         f"room_me
+00024030: 7373 6167 6573 2066 6169 6c65 6420 7769  ssages failed wi
+00024040: 7468 2072 6573 7020 3d20 7b70 7269 7661  th resp = {priva
+00024050: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+00024060: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+00024070: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00024080: 2062 7265 616b 2020 2320 736b 6970 2074   break  # skip t
+00024090: 6f20 656e 6420 6f66 2066 756e 6374 696f  o end of functio
+000240a0: 6e0a 2020 2020 2020 2020 6773 2e6c 6f67  n.        gs.log
+000240b0: 2e64 6562 7567 2866 2247 6f74 207b 6c65  .debug(f"Got {le
+000240c0: 6e28 616c 6c5f 6576 656e 7473 292b 6c65  n(all_events)+le
+000240d0: 6e28 7265 7370 2e63 6875 6e6b 297d 206d  n(resp.chunk)} m
+000240e0: 6573 7361 6765 7320 736f 2066 6172 2e22  essages so far."
+000240f0: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
+00024100: 2e64 6562 7567 2866 2252 6563 6569 7665  .debug(f"Receive
+00024110: 6420 7b6c 656e 2872 6573 702e 6368 756e  d {len(resp.chun
+00024120: 6b29 7d20 6576 656e 7473 2e22 290a 2020  k)} events.").  
+00024130: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00024140: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00024150: 6622 726f 6f6d 5f6d 6573 7361 6765 7320  f"room_messages 
+00024160: 7265 7370 6f6e 7365 203d 207b 7479 7065  response = {type
+00024170: 2872 6573 7029 7d20 3a3a 2022 0a20 2020  (resp)} :: ".   
+00024180: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
+00024190: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+000241a0: 6573 7029 297d 2e22 0a20 2020 2020 2020  esp))}.".       
+000241b0: 2029 0a20 2020 2020 2020 2067 732e 6c6f   ).        gs.lo
+000241c0: 672e 6465 6275 6728 6622 726f 6f6d 5f6d  g.debug(f"room_m
+000241d0: 6573 7361 6765 7320 726f 6f6d 5f69 6420  essages room_id 
+000241e0: 3d20 7b72 6573 702e 726f 6f6d 5f69 647d  = {resp.room_id}
+000241f0: 2e22 290a 2020 2020 2020 2020 6773 2e6c  .").        gs.l
+00024200: 6f67 2e64 6562 7567 2866 2272 6f6f 6d5f  og.debug(f"room_
+00024210: 6d65 7373 6167 6573 2073 7461 7274 203d  messages start =
+00024220: 2028 7374 7229 207b 7265 7370 2e73 7461   (str) {resp.sta
+00024230: 7274 7d2e 2229 0a20 2020 2020 2020 2067  rt}.").        g
+00024240: 732e 6c6f 672e 6465 6275 6728 6622 726f  s.log.debug(f"ro
+00024250: 6f6d 5f6d 6573 7361 6765 7320 656e 6420  om_messages end 
+00024260: 3d20 2873 7472 2920 3a3a 207b 7265 7370  = (str) :: {resp
+00024270: 2e65 6e64 7d2e 2229 0a20 2020 2020 2020  .end}.").       
+00024280: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
+00024290: 726f 6f6d 5f6d 6573 7361 6765 7320 6368  room_messages ch
+000242a0: 756e 6b20 3d20 286c 6973 7429 203a 3a20  unk = (list) :: 
+000242b0: 7b72 6573 702e 6368 756e 6b7d 2e22 290a  {resp.chunk}.").
+000242c0: 2020 2020 2020 2020 2320 7265 7370 2e63          # resp.c
+000242d0: 6875 6e6b 2069 7320 6a75 7374 2061 206c  hunk is just a l
+000242e0: 6973 7420 6f66 2052 6f6f 6d4d 6573 7361  ist of RoomMessa
+000242f0: 6765 2065 7665 6e74 7320 6c69 6b65 2074  ge events like t
+00024300: 6869 7320 6578 616d 706c 653a 0a20 2020  his example:.   
+00024310: 2020 2020 2023 2063 6875 6e6b 3d5b 526f       # chunk=[Ro
+00024320: 6f6d 4d65 7373 6167 6554 6578 7428 2e2e  omMessageText(..
+00024330: 2e29 5d0a 2020 2020 2020 2020 6375 7272  .)].        curr
+00024340: 656e 745f 7374 6172 745f 746f 6b65 6e20  ent_start_token 
+00024350: 3d20 7265 7370 2e65 6e64 0a20 2020 2020  = resp.end.     
+00024360: 2020 2069 6620 6c65 6e28 7265 7370 2e63     if len(resp.c
+00024370: 6875 6e6b 2920 3d3d 2030 3a0a 2020 2020  hunk) == 0:.    
+00024380: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00024390: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+000243a0: 2020 2020 2020 2241 6c6c 206d 6573 7361        "All messa
+000243b0: 6765 7320 6861 7665 2062 6565 6e20 7265  ges have been re
+000243c0: 7472 6965 7665 6420 6672 6f6d 2073 6572  trieved from ser
+000243d0: 7665 7220 7375 6363 6573 7366 756c 6c79  ver successfully
+000243e0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+000243f0: 2020 2020 6622 7b6c 656e 2861 6c6c 5f65      f"{len(all_e
+00024400: 7665 6e74 7329 7d20 6d65 7373 6167 6573  vents)} messages
+00024410: 2077 6572 6520 7075 6c6c 6564 2066 726f   were pulled fro
+00024420: 6d20 7365 7276 6572 2e22 0a20 2020 2020  m server.".     
+00024430: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00024440: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
+00024450: 2020 2061 6c6c 5f65 7665 6e74 7320 3d20     all_events = 
+00024460: 616c 6c5f 6576 656e 7473 202b 2072 6573  all_events + res
+00024470: 702e 6368 756e 6b0a 2020 2020 7265 7475  p.chunk.    retu
+00024480: 726e 2061 6c6c 5f65 7665 6e74 730a 0a0a  rn all_events...
+00024490: 2320 6163 636f 7264 696e 6720 746f 2070  # according to p
+000244a0: 796c 616d 613a 2066 756e 6374 696f 6e20  ylama: function 
+000244b0: 746f 6f20 636f 6d70 6c65 783a 2043 3930  too complex: C90
+000244c0: 3120 2320 6e6f 7161 3a20 4339 3031 0a61  1 # noqa: C901.a
+000244d0: 7379 6e63 2064 6566 206c 6973 7465 6e5f  sync def listen_
+000244e0: 616c 6c28 2020 2320 6e6f 7161 3a20 4339  all(  # noqa: C9
+000244f0: 3031 0a20 2020 2063 6c69 656e 743a 2041  01.    client: A
+00024500: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+00024510: 656e 7469 616c 733a 2064 6963 740a 2920  entials: dict.) 
+00024520: 2d3e 204e 6f6e 653a 2020 2320 6e6f 7161  -> None:  # noqa
+00024530: 3a20 4339 3031 0a20 2020 2022 2222 4765  : C901.    """Ge
+00024540: 7420 616c 6c20 6d65 7373 6167 6573 2c20  t all messages, 
+00024550: 7468 656e 2071 7569 742e 0a0a 2020 2020  then quit...    
+00024560: 4172 6775 6d65 6e74 733a 0a20 2020 202d  Arguments:.    -
+00024570: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00024580: 2063 6c69 656e 743a 2041 7379 6e63 436c   client: AsyncCl
+00024590: 6965 6e74 203a 2074 6865 2063 7265 6174  ient : the creat
+000245a0: 6564 204e 494f 2063 6c69 656e 740a 2020  ed NIO client.  
+000245b0: 2020 2020 2020 6372 6564 656e 7469 616c        credential
+000245c0: 733a 2064 6963 7420 3a20 6372 6564 656e  s: dict : creden
+000245d0: 7469 616c 7320 6469 6374 696f 6e61 7279  tials dictionary
+000245e0: 2066 726f 6d20 7468 6520 6372 6564 656e   from the creden
+000245f0: 7469 616c 7320 6669 6c65 0a0a 2020 2020  tials file..    
+00024600: 4765 7420 616c 6c20 6d65 7373 6167 6573  Get all messages
+00024610: 2e20 536f 6d65 206d 6967 6874 2062 6520  . Some might be 
+00024620: 6f6c 642c 2069 2e65 2e20 616c 7265 6164  old, i.e. alread
+00024630: 790a 2020 2020 7265 6164 2062 6566 6f72  y.    read befor
+00024640: 652c 2073 6f6d 6520 6d69 6768 7420 6265  e, some might be
+00024650: 206e 6577 2c20 692e 652e 206e 6576 6572   new, i.e. never
+00024660: 2072 6561 6420 6265 666f 7265 2e0a 2020   read before..  
+00024670: 2020 5072 696e 7420 7468 656d 2e20 5468    Print them. Th
+00024680: 656e 206c 6561 7665 2e0a 0a20 2020 2054  en leave...    T
+00024690: 6865 2066 756e 6374 696f 6e20 726f 6f6d  he function room
+000246a0: 5f6d 6573 7361 6765 7328 2920 6973 2075  _messages() is u
+000246b0: 7365 6420 746f 2067 6574 2061 6c6c 206d  sed to get all m
+000246c0: 6573 7361 6765 732e 0a0a 2020 2020 2222  essages...    ""
+000246d0: 220a 2020 2020 2320 7765 2063 616c 6c20  ".    # we call 
+000246e0: 7379 6e63 2829 2074 6f20 6765 7420 7468  sync() to get th
+000246f0: 6520 6e65 7874 5f62 6174 6368 206d 6172  e next_batch mar
+00024700: 6b65 720a 2020 2020 2320 7765 2073 6574  ker.    # we set
+00024710: 2066 756c 6c5f 7374 6174 653d 5472 7565   full_state=True
+00024720: 2074 6f20 6765 7420 616c 6c20 726f 6f6d   to get all room
+00024730: 5f69 6473 0a20 2020 2072 6573 705f 7320  _ids.    resp_s 
+00024740: 3d20 6177 6169 7420 7379 6e63 6872 6f6e  = await synchron
+00024750: 697a 6528 636c 6965 6e74 2920 2023 2073  ize(client)  # s
+00024760: 796e 6328 2920 746f 2067 6574 2072 6f6f  ync() to get roo
+00024770: 6d73 0a20 2020 2023 2074 6869 7320 7072  ms.    # this pr
+00024780: 696e 7473 2061 2073 756d 6d61 7279 206f  ints a summary o
+00024790: 6620 616c 6c20 6e65 7720 6d65 7373 6167  f all new messag
+000247a0: 6573 2063 7572 7265 6e74 6c79 2077 6169  es currently wai
+000247b0: 7469 6e67 2069 6e20 7468 6520 7175 6575  ting in the queu
+000247c0: 650a 2020 2020 6773 2e6c 6f67 2e64 6562  e.    gs.log.deb
+000247d0: 7567 2866 2273 796e 6320 7265 7370 6f6e  ug(f"sync respon
+000247e0: 7365 203d 207b 7479 7065 2872 6573 705f  se = {type(resp_
+000247f0: 7329 7d20 3a3a 207b 7265 7370 5f73 7d22  s)} :: {resp_s}"
+00024800: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
+00024810: 7567 2866 2263 6c69 656e 742e 6e65 7874  ug(f"client.next
+00024820: 5f62 6174 6368 2061 6674 6572 203d 2028  _batch after = (
+00024830: 7374 7229 207b 636c 6965 6e74 2e6e 6578  str) {client.nex
+00024840: 745f 6261 7463 687d 2229 0a20 2020 2067  t_batch}").    g
+00024850: 732e 6c6f 672e 6465 6275 6728 6622 7379  s.log.debug(f"sy
+00024860: 6e63 206e 6578 745f 6261 7463 6820 3d20  nc next_batch = 
+00024870: 2873 7472 2920 7b72 6573 705f 732e 6e65  (str) {resp_s.ne
+00024880: 7874 5f62 6174 6368 7d22 290a 2020 2020  xt_batch}").    
+00024890: 6773 2e6c 6f67 2e64 6562 7567 2866 2273  gs.log.debug(f"s
+000248a0: 796e 6320 726f 6f6d 7320 3d20 286e 696f  ync rooms = (nio
+000248b0: 2e72 6573 706f 6e73 6573 2e52 6f6f 6d73  .responses.Rooms
+000248c0: 2920 7b72 6573 705f 732e 726f 6f6d 737d  ) {resp_s.rooms}
+000248d0: 2229 0a20 2020 2067 732e 6c6f 672e 6465  ").    gs.log.de
+000248e0: 6275 6728 6622 636c 6965 6e74 2e72 6f6f  bug(f"client.roo
+000248f0: 6d73 203d 207b 636c 6965 6e74 2e72 6f6f  ms = {client.roo
+00024900: 6d73 7d22 290a 2020 2020 6966 206e 6f74  ms}").    if not
+00024910: 2072 6573 705f 732e 726f 6f6d 732e 6a6f   resp_s.rooms.jo
+00024920: 696e 3a20 2023 206e 6f20 526f 6f6d 7321  in:  # no Rooms!
+00024930: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00024940: 6465 6275 6728 6622 7379 6e63 2072 6574  debug(f"sync ret
+00024950: 7572 6e65 6420 6e6f 2072 6f6f 6d73 203d  urned no rooms =
+00024960: 207b 7265 7370 5f73 2e72 6f6f 6d73 2e6a   {resp_s.rooms.j
+00024970: 6f69 6e7d 2229 0a20 2020 2020 2020 2072  oin}").        r
+00024980: 6574 7572 6e0a 0a20 2020 2023 2053 6574  eturn..    # Set
+00024990: 2075 7020 6576 656e 7420 6361 6c6c 6261   up event callba
+000249a0: 636b 730a 2020 2020 6361 6c6c 6261 636b  cks.    callback
+000249b0: 7320 3d20 4361 6c6c 6261 636b 7328 636c  s = Callbacks(cl
+000249c0: 6965 6e74 290a 2020 2020 2320 4e6f 7465  ient).    # Note
+000249d0: 3a20 7765 2061 7265 204e 4f54 2072 6567  : we are NOT reg
+000249e0: 6973 7465 7269 6e67 2061 2063 616c 6c62  istering a callb
+000249f0: 6163 6b20 6675 6e74 696f 6e21 0a0a 2020  ack funtion!..  
+00024a00: 2020 2320 726f 6f6d 5f69 6420 3d20 6c69    # room_id = li
+00024a10: 7374 2872 6573 705f 732e 726f 6f6d 732e  st(resp_s.rooms.
+00024a20: 6a6f 696e 2e6b 6579 7328 2929 5b30 5d20  join.keys())[0] 
+00024a30: 2023 2066 6972 7374 2072 6f6f 6d5f 6964   # first room_id
+00024a40: 2066 726f 6d20 6469 6374 0a20 2020 2023   from dict.    #
+00024a50: 2061 6c74 6572 6e61 7469 7665 2077 6179   alternative way
+00024a60: 206f 6620 6765 7474 696e 6720 726f 6f6d   of getting room
+00024a70: 5f69 642c 2063 6c69 656e 742e 726f 6f6d  _id, client.room
+00024a80: 7320 6973 2061 6c73 6f20 6120 6469 6374  s is also a dict
+00024a90: 0a20 2020 2023 2072 6f6f 6d5f 6964 203d  .    # room_id =
+00024aa0: 206c 6973 7428 636c 6965 6e74 2e72 6f6f   list(client.roo
+00024ab0: 6d73 2e6b 6579 7328 2929 5b30 5d20 2023  ms.keys())[0]  #
+00024ac0: 2066 6972 7374 2072 6f6f 6d5f 6964 2066   first room_id f
+00024ad0: 726f 6d20 6469 6374 0a0a 2020 2020 2320  rom dict..    # 
+00024ae0: 6765 7420 726f 6f6d 7320 6173 2073 7065  get rooms as spe
+00024af0: 6369 6669 6564 2062 7920 7468 6520 7573  cified by the us
+00024b00: 6572 2074 6872 7520 6172 6773 206f 7220  er thru args or 
+00024b10: 6372 6564 656e 7469 616c 2066 696c 650a  credential file.
+00024b20: 2020 2020 726f 6f6d 7320 3d20 6177 6169      rooms = awai
+00024b30: 7420 6465 7465 726d 696e 655f 726f 6f6d  t determine_room
+00024b40: 7328 6372 6564 656e 7469 616c 735b 2272  s(credentials["r
+00024b50: 6f6f 6d5f 6964 225d 2c20 636c 6965 6e74  oom_id"], client
+00024b60: 2c20 6372 6564 656e 7469 616c 7329 0a20  , credentials). 
+00024b70: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00024b80: 6622 526f 6f6d 7320 6172 653a 207b 726f  f"Rooms are: {ro
+00024b90: 6f6d 737d 2229 0a0a 2020 2020 2320 546f  oms}")..    # To
+00024ba0: 206c 6f6f 7020 6f76 6572 2061 6c6c 2072   loop over all r
+00024bb0: 6f6f 6d73 2c20 6f6e 6520 6361 6e20 6c6f  ooms, one can lo
+00024bc0: 6f70 2074 6872 6f75 6768 2074 6865 206a  op through the j
+00024bd0: 6f69 6e20 6469 6374 696f 6e61 7279 2e20  oin dictionary. 
+00024be0: 692e 652e 0a20 2020 2023 2066 6f72 2072  i.e..    # for r
+00024bf0: 6f6f 6d5f 6964 2c20 726f 6f6d 5f69 6e66  oom_id, room_inf
+00024c00: 6f20 696e 2072 6573 705f 732e 726f 6f6d  o in resp_s.room
+00024c10: 732e 6a6f 696e 2e69 7465 6d73 2829 3a20  s.join.items(): 
+00024c20: 2023 206c 6f6f 7020 616c 6c20 726f 6f6d   # loop all room
+00024c30: 730a 2020 2020 666f 7220 726f 6f6d 5f69  s.    for room_i
+00024c40: 6420 696e 2072 6f6f 6d73 3a20 2023 206c  d in rooms:  # l
+00024c50: 6f6f 7020 6f6e 6c79 206f 7665 7220 7573  oop only over us
+00024c60: 6572 2073 7065 6369 6669 6564 2072 6f6f  er specified roo
+00024c70: 6d73 0a20 2020 2020 2020 2070 7265 765f  ms.        prev_
+00024c80: 6261 7463 6820 3d20 7265 7370 5f73 2e72  batch = resp_s.r
+00024c90: 6f6f 6d73 2e6a 6f69 6e5b 726f 6f6d 5f69  ooms.join[room_i
+00024ca0: 645d 2e74 696d 656c 696e 652e 7072 6576  d].timeline.prev
+00024cb0: 5f62 6174 6368 0a20 2020 2020 2020 2062  _batch.        b
+00024cc0: 6163 6b5f 6576 656e 7473 203d 2061 7761  ack_events = awa
+00024cd0: 6974 2072 6561 645f 616c 6c5f 6576 656e  it read_all_even
+00024ce0: 7473 5f69 6e5f 6469 7265 6374 696f 6e28  ts_in_direction(
+00024cf0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00024d00: 656e 742c 2072 6f6f 6d5f 6964 2c20 7072  ent, room_id, pr
+00024d10: 6576 5f62 6174 6368 2c20 4d65 7373 6167  ev_batch, Messag
+00024d20: 6544 6972 6563 7469 6f6e 2e62 6163 6b0a  eDirection.back.
+00024d30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00024d40: 2020 6672 6f6e 745f 6576 656e 7473 203d    front_events =
+00024d50: 2061 7761 6974 2072 6561 645f 616c 6c5f   await read_all_
+00024d60: 6576 656e 7473 5f69 6e5f 6469 7265 6374  events_in_direct
+00024d70: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00024d80: 2063 6c69 656e 742c 2072 6f6f 6d5f 6964   client, room_id
+00024d90: 2c20 7072 6576 5f62 6174 6368 2c20 4d65  , prev_batch, Me
+00024da0: 7373 6167 6544 6972 6563 7469 6f6e 2e66  ssageDirection.f
+00024db0: 726f 6e74 0a20 2020 2020 2020 2029 0a0a  ront.        )..
+00024dc0: 2020 2020 2020 2020 2320 5765 2068 6176          # We hav
+00024dd0: 6520 746f 2072 6576 6572 7365 2074 6865  e to reverse the
+00024de0: 2066 6972 7374 206c 6973 7420 7369 6e63   first list sinc
+00024df0: 6520 7765 2061 7265 2067 6f69 6e67 2062  e we are going b
+00024e00: 6163 6b77 6172 6473 2028 6275 740a 2020  ackwards (but.  
+00024e10: 2020 2020 2020 2320 7765 2077 616e 7420        # we want 
+00024e20: 746f 2068 6176 6520 6120 6368 726f 6e6f  to have a chrono
+00024e30: 6c6f 6769 6361 6c20 6f72 6465 7229 0a20  logical order). 
+00024e40: 2020 2020 2020 2061 6c6c 5f65 7665 6e74         all_event
+00024e50: 7320 3d20 6261 636b 5f65 7665 6e74 735b  s = back_events[
+00024e60: 3a3a 2d31 5d20 2b20 6672 6f6e 745f 6576  ::-1] + front_ev
+00024e70: 656e 7473 0a0a 2020 2020 2020 2020 666f  ents..        fo
+00024e80: 7220 6576 656e 7420 696e 2061 6c6c 5f65  r event in all_e
+00024e90: 7665 6e74 733a 0a20 2020 2020 2020 2020  vents:.         
+00024ea0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00024eb0: 6622 7365 6e64 696e 6720 6576 656e 7420  f"sending event 
+00024ec0: 746f 2063 616c 6c62 6163 6b20 3d20 7b65  to callback = {e
+00024ed0: 7665 6e74 7d2e 2229 0a20 2020 2020 2020  vent}.").       
+00024ee0: 2020 2020 2069 6620 636c 6965 6e74 2e72       if client.r
+00024ef0: 6f6f 6d73 2061 6e64 2063 6c69 656e 742e  ooms and client.
+00024f00: 726f 6f6d 735b 726f 6f6d 5f69 645d 3a0a  rooms[room_id]:.
+00024f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024f20: 726f 6f6d 203d 2063 6c69 656e 742e 726f  room = client.ro
+00024f30: 6f6d 735b 726f 6f6d 5f69 645d 0a20 2020  oms[room_id].   
+00024f40: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00024f50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00024f60: 6f6f 6d20 3d20 4d61 7472 6978 526f 6f6d  oom = MatrixRoom
+00024f70: 2872 6f6f 6d5f 6964 2c20 4e6f 6e65 2c20  (room_id, None, 
+00024f80: 5472 7565 2920 2023 2064 756d 6d79 5f72  True)  # dummy_r
+00024f90: 6f6f 6d0a 2020 2020 2020 2020 2020 2020  oom.            
+00024fa0: 6177 6169 7420 6361 6c6c 6261 636b 732e  await callbacks.
+00024fb0: 6d65 7373 6167 655f 6361 6c6c 6261 636b  message_callback
+00024fc0: 2872 6f6f 6d2c 2065 7665 6e74 290a 2020  (room, event).  
+00024fd0: 2020 2020 2020 6966 2061 6c6c 5f65 7665        if all_eve
+00024fe0: 6e74 733a 2020 2320 6c69 7374 206e 6f74  nts:  # list not
+00024ff0: 2065 6d70 7479 0a20 2020 2020 2020 2020   empty.         
+00025000: 2020 206c 6173 745f 6576 656e 7420 3d20     last_event = 
+00025010: 616c 6c5f 6576 656e 7473 5b2d 315d 0a20  all_events[-1]. 
+00025020: 2020 2020 2020 2020 2020 2072 6573 7020             resp 
+00025030: 3d20 6177 6169 7420 636c 6965 6e74 2e72  = await client.r
+00025040: 6f6f 6d5f 7265 6164 5f6d 6172 6b65 7273  oom_read_markers
+00025050: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00025060: 2020 726f 6f6d 5f69 643d 726f 6f6d 5f69    room_id=room_i
+00025070: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00025080: 2020 2066 756c 6c79 5f72 6561 645f 6576     fully_read_ev
+00025090: 656e 743d 6c61 7374 5f65 7665 6e74 2e65  ent=last_event.e
+000250a0: 7665 6e74 5f69 642c 0a20 2020 2020 2020  vent_id,.       
+000250b0: 2020 2020 2020 2020 2072 6561 645f 6576           read_ev
+000250c0: 656e 743d 6c61 7374 5f65 7665 6e74 2e65  ent=last_event.e
+000250d0: 7665 6e74 5f69 642c 0a20 2020 2020 2020  vent_id,.       
+000250e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000250f0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00025100: 2872 6573 702c 2052 6f6f 6d52 6561 644d  (resp, RoomReadM
+00025110: 6172 6b65 7273 4572 726f 7229 3a0a 2020  arkersError):.  
+00025120: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00025130: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+00025140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025150: 2245 3136 333a 2022 0a20 2020 2020 2020  "E163: ".       
+00025160: 2020 2020 2020 2020 2020 2020 2022 726f               "ro
+00025170: 6f6d 5f72 6561 645f 6d61 726b 6572 7320  om_read_markers 
+00025180: 6661 696c 6564 2077 6974 6820 7265 7370  failed with resp
+00025190: 6f6e 7365 2022 0a20 2020 2020 2020 2020  onse ".         
+000251a0: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
+000251b0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+000251c0: 2872 6573 7029 297d 2e22 0a20 2020 2020  (resp))}.".     
+000251d0: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
+000251e0: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
+000251f0: 6c69 7374 656e 2829 202d 3e20 4e6f 6e65  listen() -> None
+00025200: 3a0a 2020 2020 2222 224c 6973 7465 6e20  :.    """Listen 
+00025210: 7768 696c 6520 6265 696e 6720 6c6f 6767  while being logg
+00025220: 6564 2069 6e2e 2222 220a 2020 2020 6966  ed in.""".    if
+00025230: 206e 6f74 2067 732e 636c 6965 6e74 2061   not gs.client a
+00025240: 6e64 206e 6f74 2067 732e 6372 6564 656e  nd not gs.creden
+00025250: 7469 616c 733a 0a20 2020 2020 2020 2067  tials:.        g
+00025260: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+00025270: 2020 2020 2020 2020 2022 4531 3634 3a20           "E164: 
+00025280: 2220 2243 6c69 656e 7420 6f72 2063 7265  " "Client or cre
+00025290: 6465 6e74 6961 6c73 206e 6f74 2073 6574  dentials not set
+000252a0: 2e20 536b 6970 7069 6e67 2061 6374 696f  . Skipping actio
+000252b0: 6e2e 220a 2020 2020 2020 2020 290a 2020  n.".        ).  
+000252c0: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
+000252d0: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+000252e0: 7265 7475 726e 0a20 2020 2074 7279 3a0a  return.    try:.
+000252f0: 2020 2020 2020 2020 2320 5379 6e63 2065          # Sync e
+00025300: 6e63 7279 7074 696f 6e20 6b65 7973 2077  ncryption keys w
+00025310: 6974 6820 7468 6520 7365 7276 6572 0a20  ith the server. 
+00025320: 2020 2020 2020 2023 2052 6571 7569 7265         # Require
+00025330: 6420 666f 7220 7061 7274 6963 6970 6174  d for participat
+00025340: 696e 6720 696e 2065 6e63 7279 7074 6564  ing in encrypted
+00025350: 2072 6f6f 6d73 0a20 2020 2020 2020 2069   rooms.        i
+00025360: 6620 6773 2e63 6c69 656e 742e 7368 6f75  f gs.client.shou
+00025370: 6c64 5f75 706c 6f61 645f 6b65 7973 3a0a  ld_upload_keys:.
+00025380: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00025390: 7420 6773 2e63 6c69 656e 742e 6b65 7973  t gs.client.keys
+000253a0: 5f75 706c 6f61 6428 290a 2020 2020 2020  _upload().      
+000253b0: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+000253c0: 224c 6973 7465 6e69 6e67 2074 7970 653a  "Listening type:
+000253d0: 207b 6773 2e70 612e 6c69 7374 656e 7d22   {gs.pa.listen}"
+000253e0: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
+000253f0: 7061 2e6c 6973 7465 6e20 3d3d 2046 4f52  pa.listen == FOR
+00025400: 4556 4552 3a0a 2020 2020 2020 2020 2020  EVER:.          
+00025410: 2020 6177 6169 7420 6c69 7374 656e 5f66    await listen_f
+00025420: 6f72 6576 6572 2867 732e 636c 6965 6e74  orever(gs.client
+00025430: 290a 2020 2020 2020 2020 656c 6966 2067  ).        elif g
+00025440: 732e 7061 2e6c 6973 7465 6e20 3d3d 204f  s.pa.listen == O
+00025450: 4e43 453a 0a20 2020 2020 2020 2020 2020  NCE:.           
+00025460: 2061 7761 6974 206c 6973 7465 6e5f 6f6e   await listen_on
+00025470: 6365 2867 732e 636c 6965 6e74 290a 2020  ce(gs.client).  
+00025480: 2020 2020 2020 2020 2020 2320 636f 756c            # coul
+00025490: 6420 7573 6520 2761 7761 6974 206c 6973  d use 'await lis
+000254a0: 7465 6e5f 6f6e 6365 5f61 6c74 6572 6e61  ten_once_alterna
+000254b0: 7469 7665 2867 732e 636c 6965 6e74 2927  tive(gs.client)'
+000254c0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+000254d0: 7320 616e 2061 6c74 6572 6e61 7469 7665  s an alternative
+000254e0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e0a   implementation.
+000254f0: 2020 2020 2020 2020 656c 6966 2067 732e          elif gs.
+00025500: 7061 2e6c 6973 7465 6e20 3d3d 2054 4149  pa.listen == TAI
+00025510: 4c3a 0a20 2020 2020 2020 2020 2020 2061  L:.            a
+00025520: 7761 6974 206c 6973 7465 6e5f 7461 696c  wait listen_tail
+00025530: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
+00025540: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+00025550: 2020 2020 656c 6966 2067 732e 7061 2e6c      elif gs.pa.l
+00025560: 6973 7465 6e20 3d3d 2041 4c4c 3a0a 2020  isten == ALL:.  
+00025570: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00025580: 6c69 7374 656e 5f61 6c6c 2867 732e 636c  listen_all(gs.cl
+00025590: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
+000255a0: 6961 6c73 290a 2020 2020 2020 2020 656c  ials).        el
+000255b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000255c0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+000255d0: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+000255e0: 3136 353a 2022 0a20 2020 2020 2020 2020  165: ".         
+000255f0: 2020 2020 2020 2066 2755 6e72 6563 6f67         f'Unrecog
+00025600: 6e69 7a65 6420 6c69 7374 656e 696e 6720  nized listening 
+00025610: 7479 7065 2022 7b67 732e 7061 2e6c 6973  type "{gs.pa.lis
+00025620: 7465 6e7d 222e 2027 0a20 2020 2020 2020  ten}". '.       
+00025630: 2020 2020 2020 2020 2022 536b 6970 7069           "Skippi
+00025640: 6e67 206c 6973 7465 6e69 6e67 2e22 0a20  ng listening.". 
+00025650: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00025660: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
+00025670: 636f 756e 7420 2b3d 2031 0a20 2020 2065  count += 1.    e
+00025680: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00025690: 6173 2065 3a0a 2020 2020 2020 2020 6773  as e:.        gs
+000256a0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
+000256b0: 2020 2020 2020 2020 2245 3136 363a 2022          "E166: "
+000256c0: 0a20 2020 2020 2020 2020 2020 2022 4572  .            "Er
+000256d0: 726f 7220 6475 7269 6e67 206c 6973 7465  ror during liste
+000256e0: 6e69 6e67 2e20 436f 6e74 696e 7569 6e67  ning. Continuing
+000256f0: 2064 6573 7069 7465 2065 7272 6f72 2e20   despite error. 
+00025700: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00025710: 4578 6365 7074 696f 6e3a 207b 657d 220a  Exception: {e}".
+00025720: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00025730: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
+00025740: 4865 7265 2069 7320 7468 6520 7472 6163  Here is the trac
+00025750: 6562 6163 6b2e 5c6e 2220 2b20 7472 6163  eback.\n" + trac
+00025760: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00025770: 2829 290a 2020 2020 2020 2020 6773 2e65  ()).        gs.e
+00025780: 7272 5f63 6f75 6e74 202b 3d20 310a 0a0a  rr_count += 1...
+00025790: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
+000257a0: 5f73 6574 5f64 6576 6963 655f 6e61 6d65  _set_device_name
+000257b0: 280a 2020 2020 636c 6965 6e74 3a20 4173  (.    client: As
+000257c0: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
+000257d0: 6e74 6961 6c73 3a20 6469 6374 0a29 202d  ntials: dict.) -
+000257e0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2253  > None:.    """S
+000257f0: 6574 2c20 7265 6e61 6d65 2074 6865 2064  et, rename the d
+00025800: 6576 6963 6520 6e61 6d65 206f 6620 6974  evice name of it
+00025810: 7365 6c66 2077 6869 6c65 2061 6c72 6561  self while alrea
+00025820: 6479 2062 6569 6e67 206c 6f67 6765 6420  dy being logged 
+00025830: 696e 2e22 2222 0a20 2020 2063 6f6e 7465  in.""".    conte
+00025840: 6e74 203d 207b 2264 6576 6963 655f 6e61  nt = {"device_na
+00025850: 6d65 223a 2067 732e 7061 2e73 6574 5f64  me": gs.pa.set_d
+00025860: 6576 6963 655f 6e61 6d65 7d0a 2020 2020  evice_name}.    
+00025870: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00025880: 656e 742e 7570 6461 7465 5f64 6576 6963  ent.update_devic
+00025890: 6528 6372 6564 656e 7469 616c 735b 2264  e(credentials["d
+000258a0: 6576 6963 655f 6964 225d 2c20 636f 6e74  evice_id"], cont
+000258b0: 656e 7429 0a20 2020 2069 6620 6973 696e  ent).    if isin
+000258c0: 7374 616e 6365 2872 6573 702c 2055 7064  stance(resp, Upd
+000258d0: 6174 6544 6576 6963 6545 7272 6f72 293a  ateDeviceError):
+000258e0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+000258f0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+00025900: 2020 2022 4531 3637 3a20 2220 6622 7570     "E167: " f"up
+00025910: 6461 7465 5f64 6576 6963 6520 6661 696c  date_device fail
+00025920: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
+00025930: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+00025940: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
+00025950: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+00025960: 756e 7420 2b3d 2031 0a20 2020 2065 6c73  unt += 1.    els
+00025970: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+00025980: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00025990: 2020 2020 2066 2275 7064 6174 655f 6465       f"update_de
+000259a0: 7669 6365 2073 7563 6365 7373 6675 6c20  vice successful 
+000259b0: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
+000259c0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+000259d0: 220a 2020 2020 2020 2020 290a 0a0a 6173  ".        )...as
+000259e0: 796e 6320 6465 6620 6163 7469 6f6e 5f73  ync def action_s
+000259f0: 6574 5f64 6973 706c 6179 5f6e 616d 6528  et_display_name(
+00025a00: 0a20 2020 2063 6c69 656e 743a 2041 7379  .    client: Asy
+00025a10: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
+00025a20: 7469 616c 733a 2064 6963 740a 2920 2d3e  tials: dict.) ->
+00025a30: 204e 6f6e 653a 0a20 2020 2022 2222 5365   None:.    """Se
+00025a40: 742c 2072 656e 616d 6520 7468 6520 6c6f  t, rename the lo
+00025a50: 6767 6564 2069 6e20 7573 6572 2773 2064  gged in user's d
+00025a60: 6973 706c 6179 206e 616d 652e 2043 6861  isplay name. Cha
+00025a70: 6e67 6520 6d79 206f 776e 0a20 2020 2064  nge my own.    d
+00025a80: 6973 706c 6179 206e 616d 652e 0a20 2020  isplay name..   
+00025a90: 2052 656e 616d 6520 7468 6520 7573 6572   Rename the user
+00025aa0: 2062 7920 6368 616e 6769 6e67 2064 6973   by changing dis
+00025ab0: 706c 6179 206e 616d 652e 0a20 2020 2041  play name..    A
+00025ac0: 7373 756d 6573 2074 6861 7420 7573 6572  ssumes that user
+00025ad0: 2069 7320 616c 7265 6164 7920 6c6f 6767   is already logg
+00025ae0: 6564 2069 6e2e 0a20 2020 2022 2222 0a20  ed in..    """. 
+00025af0: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+00025b00: 636c 6965 6e74 2e73 6574 5f64 6973 706c  client.set_displ
+00025b10: 6179 6e61 6d65 2867 732e 7061 2e73 6574  ayname(gs.pa.set
+00025b20: 5f64 6973 706c 6179 5f6e 616d 6529 0a20  _display_name). 
+00025b30: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00025b40: 2872 6573 702c 2050 726f 6669 6c65 5365  (resp, ProfileSe
+00025b50: 7444 6973 706c 6179 4e61 6d65 4572 726f  tDisplayNameErro
+00025b60: 7229 3a0a 2020 2020 2020 2020 6773 2e6c  r):.        gs.l
+00025b70: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00025b80: 2020 2020 2020 2245 3136 383a 2022 2066        "E168: " f
+00025b90: 2273 6574 5f64 6973 706c 6179 6e61 6d65  "set_displayname
+00025ba0: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
+00025bb0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+00025bc0: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+00025bd0: 2020 290a 2020 2020 2020 2020 6773 2e65    ).        gs.e
+00025be0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+00025bf0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00025c00: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+00025c10: 2020 2020 2020 2020 2020 6622 7365 745f            f"set_
+00025c20: 6469 7370 6c61 796e 616d 6520 7375 6363  displayname succ
+00025c30: 6573 7366 756c 2077 6974 6820 7b70 7269  essful with {pri
+00025c40: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+00025c50: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+00025c60: 2029 0a0a 0a61 7379 6e63 2064 6566 2061   )...async def a
+00025c70: 6374 696f 6e5f 6765 745f 6469 7370 6c61  ction_get_displa
+00025c80: 795f 6e61 6d65 280a 2020 2020 636c 6965  y_name(.    clie
+00025c90: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
+00025ca0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
+00025cb0: 6374 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ct.) -> None:.  
+00025cc0: 2020 2222 2247 6574 2064 6973 706c 6179    """Get display
+00025cd0: 206e 616d 6528 7329 2077 6869 6c65 2061   name(s) while a
+00025ce0: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+00025cf0: 2e22 2222 0a20 2020 2069 6620 6e6f 7420  .""".    if not 
+00025d00: 6773 2e70 612e 7573 6572 3a0a 2020 2020  gs.pa.user:.    
+00025d10: 2020 2020 2320 6765 7420 6469 7370 6c61      # get displa
+00025d20: 7920 6e61 6d65 206f 6620 6d79 7365 6c66  y name of myself
+00025d30: 0a20 2020 2020 2020 2077 686f 616d 6920  .        whoami 
+00025d40: 3d20 6372 6564 656e 7469 616c 735b 2275  = credentials["u
+00025d50: 7365 725f 6964 225d 0a20 2020 2020 2020  ser_id"].       
+00025d60: 2075 7365 7273 203d 205b 7768 6f61 6d69   users = [whoami
+00025d70: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
+00025d80: 2020 2020 7573 6572 7320 3d20 6773 2e70      users = gs.p
+00025d90: 612e 7573 6572 0a20 2020 2075 7365 7273  a.user.    users
+00025da0: 203d 206c 6973 7428 6469 6374 2e66 726f   = list(dict.fro
+00025db0: 6d6b 6579 7328 7573 6572 7329 2920 2023  mkeys(users))  #
+00025dc0: 2072 656d 6f76 6520 6475 706c 6963 6174   remove duplicat
+00025dd0: 6573 2069 6e20 6c69 7374 0a20 2020 2066  es in list.    f
+00025de0: 6f72 2075 7365 7220 696e 2075 7365 7273  or user in users
+00025df0: 3a0a 2020 2020 2020 2020 7265 7370 203d  :.        resp =
+00025e00: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
+00025e10: 745f 6469 7370 6c61 796e 616d 6528 7573  t_displayname(us
+00025e20: 6572 290a 2020 2020 2020 2020 6966 2069  er).        if i
+00025e30: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
+00025e40: 5072 6f66 696c 6547 6574 4469 7370 6c61  ProfileGetDispla
+00025e50: 794e 616d 6545 7272 6f72 293a 0a20 2020  yNameError):.   
+00025e60: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00025e70: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+00025e80: 2020 2020 2020 2022 4531 3639 3a20 220a         "E169: ".
+00025e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ea0: 6622 6765 745f 6469 7370 6c61 796e 616d  f"get_displaynam
+00025eb0: 6520 6661 696c 6564 2077 6974 6820 7b70  e failed with {p
+00025ec0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+00025ed0: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
+00025ee0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00025ef0: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+00025f00: 7420 2b3d 2031 0a20 2020 2020 2020 2065  t += 1.        e
+00025f10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00025f20: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+00025f30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00025f40: 2267 6574 5f64 6973 706c 6179 6e61 6d65  "get_displayname
+00025f50: 2073 7563 6365 7373 6675 6c20 7769 7468   successful with
+00025f60: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+00025f70: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+00025f80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00025f90: 2020 2020 2020 2020 2320 7265 7370 2e64          # resp.d
+00025fa0: 6973 706c 6179 6e61 6d65 2069 7320 7374  isplayname is st
+00025fb0: 7220 6f72 204e 6f6e 6520 2868 6173 206e  r or None (has n
+00025fc0: 6f20 6469 7370 6c61 7920 6e61 6d65 290a  o display name).
+00025fd0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00025fe0: 6f74 2072 6573 702e 6469 7370 6c61 796e  ot resp.displayn
+00025ff0: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
+00026000: 2020 2020 2064 6973 706c 6179 6e61 6d65       displayname
+00026010: 203d 2022 2220 2023 206d 6561 6e73 206e   = ""  # means n
+00026020: 6f20 6469 7370 6c61 7920 6e61 6d65 2069  o display name i
+00026030: 7320 7365 740a 2020 2020 2020 2020 2020  s set.          
+00026040: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00026050: 2020 2020 2020 2020 6469 7370 6c61 796e          displayn
+00026060: 616d 6520 3d20 7265 7370 2e64 6973 706c  ame = resp.displ
+00026070: 6179 6e61 6d65 0a20 2020 2020 2020 2020  ayname.         
+00026080: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
+00026090: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
+000260a0: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
+000260b0: 2020 2020 2020 2020 2020 2020 7465 7874              text
+000260c0: 203d 2066 227b 7573 6572 7d7b 5345 507d   = f"{user}{SEP}
+000260d0: 7b64 6973 706c 6179 6e61 6d65 7d22 0a20  {displayname}". 
+000260e0: 2020 2020 2020 2020 2020 2023 204f 626a             # Obj
+000260f0: 6563 7420 6f66 2074 7970 6520 526f 6f6d  ect of type Room
+00026100: 4372 6561 7465 5265 7370 6f6e 7365 2069  CreateResponse i
+00026110: 7320 6e6f 7420 4a53 4f4e 0a20 2020 2020  s not JSON.     
+00026120: 2020 2020 2020 2023 2073 6572 6961 6c69         # seriali
+00026130: 7a61 626c 652c 2068 656e 6365 2077 6520  zable, hence we 
+00026140: 7573 6520 7468 6520 6469 6374 696f 6e61  use the dictiona
+00026150: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+00026160: 6a73 6f6e 5f6d 6178 203d 2072 6573 702e  json_max = resp.
+00026170: 5f5f 6469 6374 5f5f 0a20 2020 2020 2020  __dict__.       
+00026180: 2020 2020 206a 736f 6e5f 6d61 782e 7570       json_max.up
+00026190: 6461 7465 287b 2275 7365 7222 3a20 7573  date({"user": us
+000261a0: 6572 7d29 2020 2320 6164 6420 6469 6374  er})  # add dict
+000261b0: 2069 7465 6d73 0a20 2020 2020 2020 2020   items.         
+000261c0: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
+000261d0: 6d61 782e 636f 7079 2829 0a20 2020 2020  max.copy().     
+000261e0: 2020 2020 2020 206a 736f 6e5f 2e70 6f70         json_.pop
+000261f0: 2822 7472 616e 7370 6f72 745f 7265 7370  ("transport_resp
+00026200: 6f6e 7365 2229 0a20 2020 2020 2020 2020  onse").         
+00026210: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
+00026220: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00026230: 7072 696e 745f 6f75 7470 7574 280a 2020  print_output(.  
+00026240: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00026250: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
+00026260: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00026270: 3d74 6578 742c 0a20 2020 2020 2020 2020  =text,.         
+00026280: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
+00026290: 6e5f 2c0a 2020 2020 2020 2020 2020 2020  n_,.            
+000262a0: 2020 2020 6a73 6f6e 5f6d 6178 3d6a 736f      json_max=jso
+000262b0: 6e5f 6d61 782c 0a20 2020 2020 2020 2020  n_max,.         
+000262c0: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
+000262d0: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
+000262e0: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
+000262f0: 6320 6465 6620 6163 7469 6f6e 5f73 6574  c def action_set
+00026300: 5f70 7265 7365 6e63 6528 636c 6965 6e74  _presence(client
+00026310: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
+00026320: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
+00026330: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+00026340: 2222 5365 7420 7468 6520 6c6f 6767 6564  ""Set the logged
+00026350: 2069 6e20 7573 6572 2773 2070 7265 7365   in user's prese
+00026360: 6e63 652e 2043 6861 6e67 6520 6d79 206f  nce. Change my o
+00026370: 776e 2070 7265 7365 6e63 652e 0a20 2020  wn presence..   
+00026380: 2041 7373 756d 6573 2074 6861 7420 7573   Assumes that us
+00026390: 6572 2069 7320 616c 7265 6164 7920 6c6f  er is already lo
+000263a0: 6767 6564 2069 6e2e 0a20 2020 2022 2222  gged in..    """
+000263b0: 0a20 2020 2073 7461 7465 203d 2067 732e  .    state = gs.
+000263c0: 7061 2e73 6574 5f70 7265 7365 6e63 652e  pa.set_presence.
+000263d0: 7374 7269 7028 292e 6c6f 7765 7228 290a  strip().lower().
+000263e0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000263f0: 2866 2253 6574 7469 6e67 2070 7265 7365  (f"Setting prese
+00026400: 6e63 6520 746f 207b 7374 6174 657d 205b  nce to {state} [
+00026410: 7b67 732e 7061 2e73 6574 5f70 7265 7365  {gs.pa.set_prese
+00026420: 6e63 657d 5d2e 2229 0a20 2020 2072 6573  nce}].").    res
+00026430: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
+00026440: 2e73 6574 5f70 7265 7365 6e63 6528 7374  .set_presence(st
+00026450: 6174 6529 0a20 2020 2069 6620 6973 696e  ate).    if isin
+00026460: 7374 616e 6365 2872 6573 702c 2050 7265  stance(resp, Pre
+00026470: 7365 6e63 6553 6574 4572 726f 7229 3a0a  senceSetError):.
+00026480: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00026490: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000264a0: 2020 2245 3137 303a 2022 2066 2273 6574    "E170: " f"set
+000264b0: 5f70 7265 7365 6e63 6520 6661 696c 6564  _presence failed
+000264c0: 2077 6974 6820 7b70 7269 7661 6379 5f66   with {privacy_f
+000264d0: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+000264e0: 7d22 0a20 2020 2020 2020 2029 0a20 2020  }".        ).   
+000264f0: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+00026500: 7420 2b3d 2031 0a20 2020 2065 6c73 653a  t += 1.    else:
+00026510: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00026520: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00026530: 2020 2066 2273 6574 5f70 7265 7365 6e63     f"set_presenc
+00026540: 6520 7375 6363 6573 7366 756c 2077 6974  e successful wit
+00026550: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
+00026560: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+00026570: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
+00026580: 2064 6566 2061 6374 696f 6e5f 6765 745f   def action_get_
+00026590: 7072 6573 656e 6365 2863 6c69 656e 743a  presence(client:
+000265a0: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
+000265b0: 6564 656e 7469 616c 733a 2064 6963 7429  edentials: dict)
+000265c0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+000265d0: 2247 6574 2070 7265 7365 6e63 6528 7329  "Get presence(s)
+000265e0: 2077 6869 6c65 2061 6c72 6561 6479 206c   while already l
+000265f0: 6f67 6765 6420 696e 2e22 2222 0a20 2020  ogged in.""".   
+00026600: 2069 6620 6e6f 7420 6773 2e70 612e 7573   if not gs.pa.us
+00026610: 6572 3a0a 2020 2020 2020 2020 2320 6765  er:.        # ge
+00026620: 7420 7072 6573 656e 6365 206e 616d 6520  t presence name 
+00026630: 6f66 206d 7973 656c 660a 2020 2020 2020  of myself.      
+00026640: 2020 7768 6f61 6d69 203d 2063 7265 6465    whoami = crede
+00026650: 6e74 6961 6c73 5b22 7573 6572 5f69 6422  ntials["user_id"
+00026660: 5d0a 2020 2020 2020 2020 7573 6572 7320  ].        users 
+00026670: 3d20 5b77 686f 616d 695d 0a20 2020 2065  = [whoami].    e
+00026680: 6c73 653a 0a20 2020 2020 2020 2075 7365  lse:.        use
+00026690: 7273 203d 2067 732e 7061 2e75 7365 720a  rs = gs.pa.user.
+000266a0: 2020 2020 7573 6572 7320 3d20 6c69 7374      users = list
+000266b0: 2864 6963 742e 6672 6f6d 6b65 7973 2875  (dict.fromkeys(u
+000266c0: 7365 7273 2929 2020 2320 7265 6d6f 7665  sers))  # remove
+000266d0: 2064 7570 6c69 6361 7465 7320 696e 206c   duplicates in l
+000266e0: 6973 740a 2020 2020 666f 7220 7573 6572  ist.    for user
+000266f0: 2069 6e20 7573 6572 733a 0a20 2020 2020   in users:.     
+00026700: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+00026710: 636c 6965 6e74 2e67 6574 5f70 7265 7365  client.get_prese
+00026720: 6e63 6528 7573 6572 290a 2020 2020 2020  nce(user).      
+00026730: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00026740: 7265 7370 2c20 5072 6573 656e 6365 4765  resp, PresenceGe
+00026750: 7445 7272 6f72 293a 0a20 2020 2020 2020  tError):.       
+00026760: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00026770: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00026780: 2020 2022 4531 3731 3a20 220a 2020 2020     "E171: ".    
+00026790: 2020 2020 2020 2020 2020 2020 6622 6765              f"ge
+000267a0: 745f 7072 6573 656e 6365 2066 6169 6c65  t_presence faile
+000267b0: 6420 7769 7468 207b 7072 6976 6163 795f  d with {privacy_
+000267c0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+000267d0: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+000267e0: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+000267f0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+00026800: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00026810: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00026820: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00026830: 2020 2020 2020 2020 6622 6765 745f 7072          f"get_pr
+00026840: 6573 656e 6365 2073 7563 6365 7373 6675  esence successfu
+00026850: 6c20 7769 7468 207b 7072 6976 6163 795f  l with {privacy_
+00026860: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+00026870: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+00026880: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00026890: 206e 6f74 2072 6573 702e 6c61 7374 5f61   not resp.last_a
+000268a0: 6374 6976 655f 6167 6f3a 0a20 2020 2020  ctive_ago:.     
+000268b0: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+000268c0: 6163 7469 7665 5f61 676f 203d 2030 2020  active_ago = 0  
+000268d0: 2320 6d65 616e 7320 6375 7272 656e 746c  # means currentl
+000268e0: 795f 6163 7469 7665 2069 7320 6e6f 7420  y_active is not 
+000268f0: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
+00026900: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00026910: 2020 2020 2020 6c61 7374 5f61 6374 6976        last_activ
+00026920: 655f 6167 6f20 3d20 7265 7370 2e6c 6173  e_ago = resp.las
+00026930: 745f 6163 7469 7665 5f61 676f 0a20 2020  t_active_ago.   
+00026940: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00026950: 7265 7370 2e63 7572 7265 6e74 6c79 5f61  resp.currently_a
+00026960: 6374 6976 653a 0a20 2020 2020 2020 2020  ctive:.         
+00026970: 2020 2020 2020 2063 7572 7265 6e74 6c79         currently
+00026980: 5f61 6374 6976 6520 3d20 4661 6c73 6520  _active = False 
+00026990: 2023 206d 6561 6e73 2063 7572 7265 6e74   # means current
+000269a0: 6c79 5f61 6374 6976 6520 6973 206e 6f74  ly_active is not
+000269b0: 2073 6574 0a20 2020 2020 2020 2020 2020   set.           
+000269c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000269d0: 2020 2020 2020 2063 7572 7265 6e74 6c79         currently
+000269e0: 5f61 6374 6976 6520 3d20 7265 7370 2e63  _active = resp.c
+000269f0: 7572 7265 6e74 6c79 5f61 6374 6976 650a  urrently_active.
+00026a00: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00026a10: 6f74 2072 6573 702e 7374 6174 7573 5f6d  ot resp.status_m
+00026a20: 7367 3a0a 2020 2020 2020 2020 2020 2020  sg:.            
+00026a30: 2020 2020 7374 6174 7573 5f6d 7367 203d      status_msg =
+00026a40: 2022 2220 2023 206d 6561 6e73 206e 6f20   ""  # means no 
+00026a50: 7374 6174 7573 5f6d 7367 2069 7320 7365  status_msg is se
+00026a60: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00026a70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00026a80: 2020 2020 7374 6174 7573 5f6d 7367 203d      status_msg =
+00026a90: 2072 6573 702e 7374 6174 7573 5f6d 7367   resp.status_msg
+00026aa0: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+00026ab0: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
+00026ac0: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
+00026ad0: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
+00026ae0: 2020 2020 2020 7465 7874 203d 2028 0a20        text = (. 
+00026af0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00026b00: 227b 7265 7370 2e75 7365 725f 6964 7d7b  "{resp.user_id}{
+00026b10: 5345 507d 7b72 6573 702e 7072 6573 656e  SEP}{resp.presen
+00026b20: 6365 7d7b 5345 507d 7b6c 6173 745f 6163  ce}{SEP}{last_ac
+00026b30: 7469 7665 5f61 676f 7d22 0a20 2020 2020  tive_ago}".     
+00026b40: 2020 2020 2020 2020 2020 2066 227b 5345             f"{SE
+00026b50: 507d 7b63 7572 7265 6e74 6c79 5f61 6374  P}{currently_act
+00026b60: 6976 657d 7b53 4550 7d7b 7374 6174 7573  ive}{SEP}{status
+00026b70: 5f6d 7367 7d22 0a20 2020 2020 2020 2020  _msg}".         
+00026b80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00026b90: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
+00026ba0: 6520 7878 7852 6573 706f 6e73 6520 6973  e xxxResponse is
+00026bb0: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
+00026bc0: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
+00026bd0: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
+00026be0: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
+00026bf0: 792e 0a20 2020 2020 2020 2020 2020 206a  y..            j
+00026c00: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
+00026c10: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
+00026c20: 2020 2020 2320 6a73 6f6e 5f6d 6178 2e75      # json_max.u
+00026c30: 7064 6174 6528 7b22 6b65 7922 3a20 7661  pdate({"key": va
+00026c40: 6c75 657d 2920 2023 2061 6464 2064 6963  lue})  # add dic
+00026c50: 7420 6974 656d 730a 2020 2020 2020 2020  t items.        
+00026c60: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
+00026c70: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
+00026c80: 2020 2020 2020 2020 6a73 6f6e 5f2e 706f          json_.po
+00026c90: 7028 2274 7261 6e73 706f 7274 5f72 6573  p("transport_res
+00026ca0: 706f 6e73 6522 290a 2020 2020 2020 2020  ponse").        
+00026cb0: 2020 2020 6a73 6f6e 5f73 7065 6320 3d20      json_spec = 
+00026cc0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00026cd0: 2070 7269 6e74 5f6f 7574 7075 7428 0a20   print_output(. 
+00026ce0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00026cf0: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
+00026d00: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+00026d10: 743d 7465 7874 2c0a 2020 2020 2020 2020  t=text,.        
+00026d20: 2020 2020 2020 2020 6a73 6f6e 5f3d 6a73          json_=js
+00026d30: 6f6e 5f2c 0a20 2020 2020 2020 2020 2020  on_,.           
+00026d40: 2020 2020 206a 736f 6e5f 6d61 783d 6a73       json_max=js
+00026d50: 6f6e 5f6d 6178 2c0a 2020 2020 2020 2020  on_max,.        
+00026d60: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
+00026d70: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
+00026d80: 2020 2020 2020 2020 2029 0a0a 0a61 7379           )...asy
+00026d90: 6e63 2064 6566 2061 6374 696f 6e5f 7570  nc def action_up
+00026da0: 6c6f 6164 2863 6c69 656e 743a 2041 7379  load(client: Asy
+00026db0: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
+00026dc0: 7469 616c 733a 2064 6963 7429 202d 3e20  tials: dict) -> 
+00026dd0: 4e6f 6e65 3a0a 2020 2020 2222 2255 706c  None:.    """Upl
+00026de0: 6f61 6420 6f6e 6520 6f72 206d 6f72 6520  oad one or more 
+00026df0: 6669 6c65 7320 746f 2063 6f6e 7465 6e74  files to content
+00026e00: 2072 6570 6f73 6974 6f72 7920 6f66 204d   repository of M
+00026e10: 6174 7269 7820 7365 7276 6572 2e0a 2020  atrix server..  
+00026e20: 2020 4173 7375 6d65 7320 7468 6174 2075    Assumes that u
+00026e30: 7365 7220 6973 2061 6c72 6561 6479 206c  ser is already l
+00026e40: 6f67 6765 6420 696e 2e0a 2020 2020 2222  ogged in..    ""
+00026e50: 220a 2020 2020 666f 7220 6669 6c65 6e61  ".    for filena
+00026e60: 6d65 2069 6e20 6773 2e70 612e 7570 6c6f  me in gs.pa.uplo
+00026e70: 6164 3a0a 2020 2020 2020 2020 6669 6c65  ad:.        file
+00026e80: 6e61 6d65 203d 2066 696c 656e 616d 652e  name = filename.
+00026e90: 7374 7269 7028 290a 2020 2020 2020 2020  strip().        
+00026ea0: 656e 6372 7970 7420 3d20 4661 6c73 6520  encrypt = False 
+00026eb0: 6966 2067 732e 7061 2e70 6c61 696e 2065  if gs.pa.plain e
+00026ec0: 6c73 6520 5472 7565 0a20 2020 2020 2020  lse True.       
+00026ed0: 206d 696d 655f 7479 7065 203d 206d 6167   mime_type = mag
+00026ee0: 6963 2e66 726f 6d5f 6669 6c65 2866 696c  ic.from_file(fil
+00026ef0: 656e 616d 652c 206d 696d 653d 5472 7565  ename, mime=True
+00026f00: 290a 2020 2020 2020 2020 6669 6c65 5f73  ).        file_s
+00026f10: 7461 7420 3d20 6177 6169 7420 6169 6f66  tat = await aiof
+00026f20: 696c 6573 2e6f 732e 7374 6174 2866 696c  iles.os.stat(fil
+00026f30: 656e 616d 6529 0a20 2020 2020 2020 2061  ename).        a
+00026f40: 7379 6e63 2077 6974 6820 6169 6f66 696c  sync with aiofil
+00026f50: 6573 2e6f 7065 6e28 6669 6c65 6e61 6d65  es.open(filename
+00026f60: 2c20 2272 2b62 2229 2061 7320 663a 0a20  , "r+b") as f:. 
+00026f70: 2020 2020 2020 2020 2020 2072 6573 702c             resp,
+00026f80: 2064 6563 7279 7074 696f 6e5f 6469 6374   decryption_dict
+00026f90: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+00026fa0: 7570 6c6f 6164 280a 2020 2020 2020 2020  upload(.        
+00026fb0: 2020 2020 2020 2020 662c 0a20 2020 2020          f,.     
+00026fc0: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+00026fd0: 6e74 5f74 7970 653d 6d69 6d65 5f74 7970  nt_type=mime_typ
+00026fe0: 652c 2020 2320 652e 672e 2061 7070 6c69  e,  # e.g. appli
+00026ff0: 6361 7469 6f6e 2f70 6466 0a20 2020 2020  cation/pdf.     
+00027000: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+00027010: 616d 653d 6f73 2e70 6174 682e 6261 7365  ame=os.path.base
+00027020: 6e61 6d65 2866 696c 656e 616d 6529 2c0a  name(filename),.
+00027030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027040: 656e 6372 7970 743d 656e 6372 7970 742c  encrypt=encrypt,
+00027050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027060: 2066 696c 6573 697a 653d 6669 6c65 5f73   filesize=file_s
+00027070: 7461 742e 7374 5f73 697a 652c 0a20 2020  tat.st_size,.   
+00027080: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00027090: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000270a0: 2872 6573 702c 2055 706c 6f61 6445 7272  (resp, UploadErr
+000270b0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+000270c0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+000270d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000270e0: 4531 3732 3a20 220a 2020 2020 2020 2020  E172: ".        
+000270f0: 2020 2020 2020 2020 2246 6169 6c65 6420          "Failed 
+00027100: 746f 2075 706c 6f61 642e 2022 0a20 2020  to upload. ".   
+00027110: 2020 2020 2020 2020 2020 2020 2066 2766               f'f
+00027120: 696c 653d 227b 6669 6c65 6e61 6d65 7d22  ile="{filename}"
+00027130: 3b20 6d69 6d65 5f74 7970 653d 227b 6d69  ; mime_type="{mi
+00027140: 6d65 5f74 7970 657d 223b 2027 0a20 2020  me_type}"; '.   
+00027150: 2020 2020 2020 2020 2020 2020 2066 2266               f"f
+00027160: 696c 6573 7369 7a65 3d7b 6669 6c65 5f73  ilessize={file_s
+00027170: 7461 742e 7374 5f73 697a 657d 3b20 656e  tat.st_size}; en
+00027180: 6372 7970 743d 7b65 6e63 7279 7074 7d22  crypt={encrypt}"
+00027190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000271a0: 2066 2253 6572 7665 7220 7265 7370 6f6e   f"Server respon
+000271b0: 7365 3a20 7b70 7269 7661 6379 5f66 696c  se: {privacy_fil
+000271c0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+000271d0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000271e0: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
+000271f0: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
+00027200: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00027210: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00027220: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+00027230: 2020 2020 2066 2246 696c 6520 7b66 696c       f"File {fil
+00027240: 656e 616d 657d 2c20 6d69 6d65 3d7b 6d69  ename}, mime={mi
+00027250: 6d65 5f74 7970 657d 2c20 220a 2020 2020  me_type}, ".    
+00027260: 2020 2020 2020 2020 2020 2020 6622 7b66              f"{f
+00027270: 696c 655f 7374 6174 2e73 745f 7369 7a65  ile_stat.st_size
+00027280: 7d20 6279 7465 732c 2065 6e63 7279 7074  } bytes, encrypt
+00027290: 3d7b 656e 6372 7970 747d 2022 0a20 2020  ={encrypt} ".   
+000272a0: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
+000272b0: 7320 7375 6363 6573 7366 756c 6c79 2075  s successfully u
+000272c0: 706c 6f61 6465 6420 746f 2073 6572 7665  ploaded to serve
+000272d0: 722e 2052 6573 706f 6e73 6520 6973 3a20  r. Response is: 
+000272e0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000272f0: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
+00027300: 7465 7228 7374 7228 7265 7370 2929 7d2e  ter(str(resp))}.
+00027310: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00027320: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00027330: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+00027340: 2020 2020 2020 2020 2020 6622 5552 4920            f"URI 
+00027350: 6f66 2075 706c 6f61 6465 6420 6669 6c65  of uploaded file
+00027360: 207b 6669 6c65 6e61 6d65 7d20 6973 3a20   {filename} is: 
+00027370: 7b72 6573 702e 636f 6e74 656e 745f 7572  {resp.content_ur
+00027380: 697d 220a 2020 2020 2020 2020 2020 2020  i}".            
+00027390: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+000273a0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+000273b0: 2020 2020 2020 2020 2020 2020 6622 4465              f"De
+000273c0: 6372 7970 7469 6f6e 206b 6579 2028 6469  cryption key (di
+000273d0: 6374 696f 6e61 7279 2920 6f66 2075 706c  ctionary) of upl
+000273e0: 6f61 6465 6420 6669 6c65 207b 6669 6c65  oaded file {file
+000273f0: 6e61 6d65 7d20 6973 3a20 220a 2020 2020  name} is: ".    
+00027400: 2020 2020 2020 2020 2020 2020 2227 2a2a              "'**
+00027410: 2a20 6869 6464 656e 2074 6f20 7072 6576  * hidden to prev
+00027420: 656e 7420 6c65 616b 7327 2220 2023 2066  ent leaks'"  # f
+00027430: 227b 6465 6372 7970 7469 6f6e 5f64 6963  "{decryption_dic
+00027440: 747d 220a 2020 2020 2020 2020 2020 2020  t}".            
+00027450: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00027460: 6465 6372 7970 7469 6f6e 5f64 6963 7420  decryption_dict 
+00027470: 7769 6c6c 2062 6520 4e6f 6e65 2069 6e20  will be None in 
+00027480: 6361 7365 206f 6620 706c 6169 6e2d 7465  case of plain-te
+00027490: 7874 0a20 2020 2020 2020 2020 2020 2023  xt.            #
+000274a0: 2074 6865 2055 5249 2061 6e64 206b 6579   the URI and key
+000274b0: 7320 7769 6c6c 2062 6520 6e65 6564 6564  s will be needed
+000274c0: 206c 6174 6572 2e20 536f 2074 6869 7320   later. So this 
+000274d0: 7072 696e 7420 6973 2061 206d 7573 740a  print is a must.
+000274e0: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
+000274f0: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
+00027500: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
+00027510: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
+00027520: 2020 2020 2074 6578 7420 3d20 6622 7b72       text = f"{r
+00027530: 6573 702e 636f 6e74 656e 745f 7572 697d  esp.content_uri}
+00027540: 7b53 4550 7d7b 6465 6372 7970 7469 6f6e  {SEP}{decryption
+00027550: 5f64 6963 747d 220a 2020 2020 2020 2020  _dict}".        
+00027560: 2020 2020 2320 4f62 6a65 6374 206f 6620      # Object of 
+00027570: 7479 7065 2078 7878 5265 7370 6f6e 7365  type xxxResponse
+00027580: 2069 7320 6e6f 7420 4a53 4f4e 0a20 2020   is not JSON.   
+00027590: 2020 2020 2020 2020 2023 2073 6572 6961           # seria
+000275a0: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
+000275b0: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
+000275c0: 6e61 7279 2e0a 2020 2020 2020 2020 2020  nary..          
+000275d0: 2020 6a73 6f6e 5f6d 6178 203d 2072 6573    json_max = res
+000275e0: 702e 5f5f 6469 6374 5f5f 0a20 2020 2020  p.__dict__.     
+000275f0: 2020 2020 2020 206a 736f 6e5f 6d61 782e         json_max.
+00027600: 7570 6461 7465 280a 2020 2020 2020 2020  update(.        
+00027610: 2020 2020 2020 2020 7b22 6465 6372 7970          {"decryp
+00027620: 7469 6f6e 5f64 6963 7422 3a20 6465 6372  tion_dict": decr
+00027630: 7970 7469 6f6e 5f64 6963 747d 0a20 2020  yption_dict}.   
+00027640: 2020 2020 2020 2020 2029 2020 2320 6164           )  # ad
+00027650: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
+00027660: 2020 2020 2020 2020 206a 736f 6e5f 203d           json_ =
+00027670: 206a 736f 6e5f 6d61 782e 636f 7079 2829   json_max.copy()
+00027680: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00027690: 6e5f 2e70 6f70 2822 7472 616e 7370 6f72  n_.pop("transpor
+000276a0: 745f 7265 7370 6f6e 7365 2229 0a20 2020  t_response").   
+000276b0: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+000276c0: 6563 203d 204e 6f6e 650a 2020 2020 2020  ec = None.      
+000276d0: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
+000276e0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+000276f0: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
+00027700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00027710: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
+00027720: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00027730: 6e5f 3d6a 736f 6e5f 2c0a 2020 2020 2020  n_=json_,.      
+00027740: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+00027750: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
+00027760: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00027770: 6e5f 7370 6563 3d6a 736f 6e5f 7370 6563  n_spec=json_spec
+00027780: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00027790: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
+000277a0: 6f6e 5f64 656c 6574 655f 6d78 6328 636c  on_delete_mxc(cl
+000277b0: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+000277c0: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
+000277d0: 6469 6374 2920 2d3e 204e 6f6e 653a 0a20  dict) -> None:. 
+000277e0: 2020 2022 2222 4465 6c65 7465 206f 6e65     """Delete one
+000277f0: 206f 7220 6d6f 7265 2066 696c 6573 2066   or more files f
+00027800: 726f 6d20 636f 6e74 656e 7420 7265 706f  rom content repo
+00027810: 7369 746f 7279 206f 6620 4d61 7472 6978  sitory of Matrix
+00027820: 2073 6572 7665 722e 0a20 2020 2041 7373   server..    Ass
+00027830: 756d 6573 2074 6861 7420 7573 6572 2069  umes that user i
+00027840: 7320 616c 7265 6164 7920 6c6f 6767 6564  s already logged
+00027850: 2069 6e2e 0a20 2020 2022 2222 0a20 2020   in..    """.   
+00027860: 2023 2073 6565 3a20 6874 7470 733a 2f2f   # see: https://
+00027870: 646f 6373 2e61 696f 6874 7470 2e6f 7267  docs.aiohttp.org
+00027880: 2f65 6e2f 7374 6162 6c65 2f63 6c69 656e  /en/stable/clien
+00027890: 745f 7175 6963 6b73 7461 7274 2e68 746d  t_quickstart.htm
+000278a0: 6c0a 2020 2020 2320 7765 206d 7573 7420  l.    # we must 
+000278b0: 656d 756c 6174 6520 6120 6375 726c 206c  emulate a curl l
+000278c0: 696b 6520 7468 6973 3a0a 2020 2020 2320  ike this:.    # 
+000278d0: 6375 726c 202d 5844 454c 4554 4520 2022  curl -XDELETE  "
+000278e0: 6874 7470 733a 2f2f 5345 5256 4552 4845  https://SERVERHE
+000278f0: 5245 2f5f 7379 6e61 7073 652f 6164 6d69  RE/_synapse/admi
+00027900: 6e2f 7631 2f6d 6564 6961 2f53 4552 5645  n/v1/media/SERVE
+00027910: 5248 4552 452f 0a20 2020 2023 2020 2020  RHERE/.    #    
+00027920: 2020 4d58 4349 4448 4552 453f 6163 6365    MXCIDHERE?acce
+00027930: 7373 5f74 6f6b 656e 3d41 4343 4553 535f  ss_token=ACCESS_
+00027940: 544f 4b45 4e5f 4845 5245 220a 2020 2020  TOKEN_HERE".    
+00027950: 666f 7220 6d78 6320 696e 2067 732e 7061  for mxc in gs.pa
+00027960: 2e64 656c 6574 655f 6d78 633a 0a20 2020  .delete_mxc:.   
+00027970: 2020 2020 206d 7863 203d 206d 7863 2e73       mxc = mxc.s
+00027980: 7472 6970 2829 0a20 2020 2020 2020 2067  trip().        g
+00027990: 732e 6c6f 672e 6465 6275 6728 6622 5072  s.log.debug(f"Pr
+000279a0: 6570 6172 696e 6720 746f 2064 656c 6574  eparing to delet
+000279b0: 6520 4d58 4320 7b6d 7863 7d2e 2229 0a20  e MXC {mxc}."). 
+000279c0: 2020 2020 2020 2023 2077 6520 616c 6c6f         # we allo
+000279d0: 7720 6d78 6320 746f 2062 6520 6129 206d  w mxc to be a) m
+000279e0: 7863 3a2f 2f73 6572 7665 722f 6d78 632d  xc://server/mxc-
+000279f0: 6964 206f 7220 6a75 7374 206d 7863 2d69  id or just mxc-i
+00027a00: 640a 2020 2020 2020 2020 6966 2075 726c  d.        if url
+00027a10: 7061 7273 6528 6d78 6329 2e73 6368 656d  parse(mxc).schem
+00027a20: 6520 3d3d 2022 6d78 6322 3a0a 2020 2020  e == "mxc":.    
+00027a30: 2020 2020 2020 2020 6d78 6320 3d20 7572          mxc = ur
+00027a40: 6c70 6172 7365 286d 7863 292e 7061 7468  lparse(mxc).path
+00027a50: 2e72 6570 6c61 6365 2822 2f22 2c20 2222  .replace("/", ""
+00027a60: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
+00027a70: 2e64 6562 7567 2866 2250 7265 7061 7269  .debug(f"Prepari
+00027a80: 6e67 2074 6f20 6465 6c65 7465 204d 5843  ng to delete MXC
+00027a90: 2049 4420 7b6d 7863 7d2e 2229 0a20 2020   ID {mxc}.").   
+00027aa0: 2020 2020 2069 6620 6773 2e70 612e 6163       if gs.pa.ac
+00027ab0: 6365 7373 5f74 6f6b 656e 3a0a 2020 2020  cess_token:.    
+00027ac0: 2020 2020 2020 2020 6174 203d 2067 732e          at = gs.
+00027ad0: 7061 2e61 6363 6573 735f 746f 6b65 6e0a  pa.access_token.
+00027ae0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00027af0: 6f67 2e64 6562 7567 2822 5573 696e 6720  og.debug("Using 
+00027b00: 6163 6365 7373 2074 6f6b 656e 2066 726f  access token fro
+00027b10: 6d20 2d2d 6163 6365 7373 2d74 6f6b 656e  m --access-token
+00027b20: 2061 7267 756d 656e 742e 2229 0a20 2020   argument.").   
+00027b30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00027b40: 2020 2020 2020 2061 7420 3d20 6372 6564         at = cred
+00027b50: 656e 7469 616c 735b 2261 6363 6573 735f  entials["access_
+00027b60: 746f 6b65 6e22 5d0a 2020 2020 2020 2020  token"].        
+00027b70: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00027b80: 2822 5573 696e 6720 6163 6365 7373 2074  ("Using access t
+00027b90: 6f6b 656e 2066 726f 6d20 6372 6564 656e  oken from creden
+00027ba0: 7469 616c 7320 6669 6c65 2e22 290a 2020  tials file.").  
+00027bb0: 2020 2020 2020 7372 765f 6675 6c6c 203d        srv_full =
+00027bc0: 2063 7265 6465 6e74 6961 6c73 5b22 686f   credentials["ho
+00027bd0: 6d65 7365 7276 6572 225d 2020 2320 6874  meserver"]  # ht
+00027be0: 7470 733a 2f2f 6578 616d 706c 652e 6d61  tps://example.ma
+00027bf0: 7472 6978 2e6f 7267 0a20 2020 2020 2020  trix.org.       
+00027c00: 2073 7276 5f68 6f73 7420 3d20 7572 6c70   srv_host = urlp
+00027c10: 6172 7365 2873 7276 5f66 756c 6c29 2e68  arse(srv_full).h
+00027c20: 6f73 746e 616d 6520 2023 2065 7861 6d70  ostname  # examp
+00027c30: 6c65 2e6d 6174 7269 782e 6f72 670a 2020  le.matrix.org.  
+00027c40: 2020 2020 2020 7265 7374 203d 2028 0a20        rest = (. 
+00027c50: 2020 2020 2020 2020 2020 2073 7276 5f66             srv_f
+00027c60: 756c 6c0a 2020 2020 2020 2020 2020 2020  ull.            
+00027c70: 2b20 222f 5f73 796e 6170 7365 2f61 646d  + "/_synapse/adm
+00027c80: 696e 2f76 312f 6d65 6469 612f 220a 2020  in/v1/media/".  
+00027c90: 2020 2020 2020 2020 2020 2b20 7372 765f            + srv_
+00027ca0: 686f 7374 0a20 2020 2020 2020 2020 2020  host.           
+00027cb0: 202b 2022 2f22 0a20 2020 2020 2020 2020   + "/".         
+00027cc0: 2020 202b 206d 7863 0a20 2020 2020 2020     + mxc.       
+00027cd0: 2020 2020 202b 2022 3f61 6363 6573 735f       + "?access_
+00027ce0: 746f 6b65 6e3d 220a 2020 2020 2020 2020  token=".        
+00027cf0: 2020 2020 2b20 6174 0a20 2020 2020 2020      + at.       
+00027d00: 2029 0a20 2020 2020 2020 2067 732e 6c6f   ).        gs.lo
+00027d10: 672e 6465 6275 6728 6622 4973 7375 696e  g.debug(f"Issuin
+00027d20: 6720 5245 5354 204d 6174 7269 7820 4150  g REST Matrix AP
+00027d30: 4920 6361 6c6c 3a20 4445 4c45 5445 207b  I call: DELETE {
+00027d40: 7265 7374 7d22 290a 2020 2020 2020 2020  rest}").        
+00027d50: 636f 6e6e 6563 746f 7220 3d20 5443 5043  connector = TCPC
+00027d60: 6f6e 6e65 6374 6f72 2873 736c 3d67 732e  onnector(ssl=gs.
+00027d70: 7373 6c29 2020 2320 7365 7474 696e 6720  ssl)  # setting 
+00027d80: 7373 6c63 6f6e 7465 7874 0a20 2020 2020  sslcontext.     
+00027d90: 2020 2061 7379 6e63 2077 6974 6820 436c     async with Cl
+00027da0: 6965 6e74 5365 7373 696f 6e28 636f 6e6e  ientSession(conn
+00027db0: 6563 746f 723d 636f 6e6e 6563 746f 7229  ector=connector)
+00027dc0: 2061 7320 7365 7373 696f 6e3a 2020 2320   as session:  # 
+00027dd0: 6169 6f68 7474 700a 2020 2020 2020 2020  aiohttp.        
+00027de0: 2020 2020 6173 796e 6320 7769 7468 2073      async with s
+00027df0: 6573 7369 6f6e 2e64 656c 6574 6528 7265  ession.delete(re
+00027e00: 7374 2920 6173 2072 6573 703a 0a20 2020  st) as resp:.   
+00027e10: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00027e20: 7475 7320 3d20 7265 7370 2e73 7461 7475  tus = resp.statu
+00027e30: 7320 2023 2069 6e74 2c20 3230 3020 7375  s  # int, 200 su
+00027e40: 6363 6573 730a 2020 2020 2020 2020 2020  ccess.          
+00027e50: 2020 2020 2020 7478 7420 3d20 6177 6169        txt = awai
+00027e60: 7420 7265 7370 2e74 6578 7428 2920 2023  t resp.text()  #
+00027e70: 2073 7472 2069 6e20 6469 6374 2066 6f72   str in dict for
+00027e80: 6d61 740a 2020 2020 2020 2020 6966 2073  mat.        if s
+00027e90: 7461 7475 7320 213d 2032 3030 3a0a 2020  tatus != 200:.  
+00027ea0: 2020 2020 2020 2020 2020 2320 7478 7420            # txt 
+00027eb0: 6973 2073 7472 206c 696b 6520 7468 6973  is str like this
+00027ec0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00027ed0: 7b22 6572 7263 6f64 6522 3a22 4d5f 464f  {"errcode":"M_FO
+00027ee0: 5242 4944 4445 4e22 2c22 6572 726f 7222  RBIDDEN","error"
+00027ef0: 3a22 596f 7520 6172 6520 6e6f 7420 6120  :"You are not a 
+00027f00: 7365 7276 6572 2061 646d 696e 227d 0a20  server admin"}. 
+00027f10: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00027f20: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
+00027f30: 2020 2020 2020 2020 2022 4531 3733 3a20           "E173: 
+00027f40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00027f50: 2020 6622 4661 696c 6564 2074 6f20 6465    f"Failed to de
+00027f60: 6c65 7465 206f 626a 6563 7420 286d 7863  lete object (mxc
+00027f70: 2920 277b 6d78 637d 2720 6672 6f6d 2073  ) '{mxc}' from s
+00027f80: 6572 7665 7220 220a 2020 2020 2020 2020  erver ".        
+00027f90: 2020 2020 2020 2020 6622 277b 7372 765f          f"'{srv_
+00027fa0: 6675 6c6c 7d27 2e20 4661 696c 6564 2077  full}'. Failed w
+00027fb0: 6974 6820 6572 726f 7220 636f 6465 207b  ith error code {
+00027fc0: 7374 6174 7573 7d20 616e 6420 220a 2020  status} and ".  
+00027fd0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00027fe0: 6572 726f 7220 7465 7874 207b 7478 747d  error text {txt}
+00027ff0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00028000: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00028010: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+00028020: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00028030: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00028040: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00028050: 2020 2020 2020 2066 224d 5843 206f 626a         f"MXC obj
+00028060: 6563 7420 7b6d 7863 7d20 7761 7320 7375  ect {mxc} was su
+00028070: 6363 6573 7366 756c 6c79 2064 656c 6574  ccessfully delet
+00028080: 6564 2066 726f 6d20 7365 7276 6572 2022  ed from server "
+00028090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000280a0: 2066 227b 7372 765f 6675 6c6c 7d2e 2052   f"{srv_full}. R
+000280b0: 6573 706f 6e73 6520 6973 3a20 7b74 7874  esponse is: {txt
+000280c0: 7d2e 220a 2020 2020 2020 2020 2020 2020  }.".            
+000280d0: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
+000280e0: 7469 6f6e 5f64 656c 6574 655f 6d78 635f  tion_delete_mxc_
+000280f0: 6265 666f 7265 280a 2020 2020 636c 6965  before(.    clie
+00028100: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
+00028110: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
+00028120: 6374 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ct.) -> None:.  
+00028130: 2020 2222 2244 656c 6574 6520 6669 6c65    """Delete file
+00028140: 7320 6f6c 6465 7220 616e 6420 6c61 7267  s older and larg
+00028150: 6572 2066 726f 6d20 636f 6e74 656e 7420  er from content 
+00028160: 7265 706f 7369 746f 7279 206f 6620 4d61  repository of Ma
+00028170: 7472 6978 2073 6572 7665 722e 0a20 2020  trix server..   
+00028180: 2041 7373 756d 6573 2074 6861 7420 7573   Assumes that us
+00028190: 6572 2069 7320 616c 7265 6164 7920 6c6f  er is already lo
+000281a0: 6767 6564 2069 6e2e 0a20 2020 2022 2222  gged in..    """
+000281b0: 0a20 2020 2023 2068 7474 7073 3a2f 2f6d  .    # https://m
+000281c0: 6174 7269 782d 6f72 672e 6769 7468 7562  atrix-org.github
+000281d0: 2e69 6f2f 7379 6e61 7073 652f 6c61 7465  .io/synapse/late
+000281e0: 7374 2f61 646d 696e 5f61 7069 2f0a 2020  st/admin_api/.  
+000281f0: 2020 2320 2020 6d65 6469 615f 6164 6d69    #   media_admi
+00028200: 6e5f 6170 692e 6874 6d6c 2364 656c 6574  n_api.html#delet
+00028210: 652d 6c6f 6361 6c2d 6d65 6469 612d 6279  e-local-media-by
+00028220: 2d64 6174 652d 6f72 2d73 697a 650a 2020  -date-or-size.  
+00028230: 2020 2320 504f 5354 202f 5f73 796e 6170    # POST /_synap
+00028240: 7365 2f61 646d 696e 2f76 312f 6d65 6469  se/admin/v1/medi
+00028250: 612f 3c73 6572 7665 725f 6e61 6d65 3e2f  a/<server_name>/
+00028260: 6465 6c65 7465 3f62 6566 6f72 655f 7473  delete?before_ts
+00028270: 3d3c 6265 666f 7265 5f74 733e 0a20 2020  =<before_ts>.   
+00028280: 2023 2026 7369 7a65 5f67 743d 3c73 697a   # &size_gt=<siz
+00028290: 653e 0a20 2020 2069 6620 6c65 6e28 6773  e>.    if len(gs
+000282a0: 2e70 612e 6465 6c65 7465 5f6d 7863 5f62  .pa.delete_mxc_b
+000282b0: 6566 6f72 6529 203e 2032 3a0a 2020 2020  efore) > 2:.    
+000282c0: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+000282d0: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
+000282e0: 3137 343a 2022 0a20 2020 2020 2020 2020  174: ".         
+000282f0: 2020 2022 496e 636f 7272 6563 7420 6e75     "Incorrect nu
+00028300: 6d62 6572 206f 6620 6172 6775 6d65 6e74  mber of argument
+00028310: 7320 666f 7220 2d2d 6465 6c65 7465 5f6d  s for --delete_m
+00028320: 7863 5f62 6566 6f72 652e 2022 0a20 2020  xc_before. ".   
+00028330: 2020 2020 2020 2020 2022 5468 6572 6520           "There 
+00028340: 6d75 7374 2062 6520 3120 6f72 2032 2061  must be 1 or 2 a
+00028350: 7267 756d 656e 7473 202c 2062 7574 2066  rguments , but f
+00028360: 6f75 6e64 2022 0a20 2020 2020 2020 2020  ound ".         
+00028370: 2020 2066 227b 6c65 6e28 6773 2e70 612e     f"{len(gs.pa.
+00028380: 6465 6c65 7465 5f6d 7863 5f62 6566 6f72  delete_mxc_befor
+00028390: 6529 7d20 6172 6775 6d65 6e74 732e 220a  e)} arguments.".
 000283a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000283b0: 2020 6d78 6320 3d20 646f 776e 6c6f 6164    mxc = download
-000283c0: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
-000283d0: 6177 6169 7420 646f 776e 6c6f 6164 5f6d  await download_m
-000283e0: 7863 2863 6c69 656e 742c 206d 7863 3d6d  xc(client, mxc=m
-000283f0: 7863 2c20 6669 6c65 6e61 6d65 3d66 696c  xc, filename=fil
-00028400: 656e 616d 6529 0a20 2020 2020 2020 2069  ename).        i
-00028410: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-00028420: 702c 2044 6f77 6e6c 6f61 6445 7272 6f72  p, DownloadError
-00028430: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
-00028440: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-00028450: 2020 2020 2020 2020 2020 2020 2022 4531               "E1
-00028460: 3736 3a20 220a 2020 2020 2020 2020 2020  76: ".          
-00028470: 2020 2020 2020 6622 646f 776e 6c6f 6164        f"download
-00028480: 206f 6620 5552 4920 277b 6d78 637d 2720   of URI '{mxc}' 
-00028490: 746f 206c 6f63 616c 2066 696c 6520 277b  to local file '{
-000284a0: 6669 6c65 6e61 6d65 7d27 2022 0a20 2020  filename}' ".   
-000284b0: 2020 2020 2020 2020 2020 2020 2066 2266               f"f
-000284c0: 6169 6c65 6420 7769 7468 2072 6573 706f  ailed with respo
-000284d0: 6e73 6520 7b70 7269 7661 6379 5f66 696c  nse {privacy_fil
-000284e0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-000284f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00028500: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
-00028510: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-00028520: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00028530: 2020 2020 2020 2075 726c 203d 2075 726c         url = url
-00028540: 7061 7273 6528 6d78 6329 0a20 2020 2020  parse(mxc).     
-00028550: 2020 2020 2020 206d 6564 6961 5f69 6420         media_id 
-00028560: 3d20 7572 6c2e 7061 7468 2e73 7472 6970  = url.path.strip
-00028570: 2822 2f22 290a 2020 2020 2020 2020 2020  ("/").          
-00028580: 2020 6966 2066 696c 656e 616d 6520 3d3d    if filename ==
-00028590: 2022 223a 0a20 2020 2020 2020 2020 2020   "":.           
-000285a0: 2020 2020 2066 696c 656e 616d 6520 3d20       filename = 
-000285b0: 226d 7863 2d22 202b 204d 5843 5f49 445f  "mxc-" + MXC_ID_
-000285c0: 504c 4143 4548 4f4c 4445 520a 2020 2020  PLACEHOLDER.    
-000285d0: 2020 2020 2020 2020 6966 206e 6f74 2066          if not f
-000285e0: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
-000285f0: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
-00028600: 6520 3d20 7265 7370 2e66 696c 656e 616d  e = resp.filenam
-00028610: 6520 2023 2032 6e64 2063 686f 6963 652c  e  # 2nd choice,
-00028620: 2066 726f 6d20 7365 7276 6572 0a20 2020   from server.   
-00028630: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-00028640: 6c6f 672e 6465 6275 6728 6622 4669 6c65  log.debug(f"File
-00028650: 206e 616d 6520 6f6e 2073 6572 7665 723a   name on server:
-00028660: 207b 6669 6c65 6e61 6d65 737d 2229 0a20   {filenames}"). 
-00028670: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00028680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028690: 2066 696c 656e 616d 6520 3d20 6669 6c65   filename = file
-000286a0: 6e61 6d65 2e72 6570 6c61 6365 284d 5843  name.replace(MXC
-000286b0: 5f49 445f 504c 4143 4548 4f4c 4445 522c  _ID_PLACEHOLDER,
-000286c0: 206d 6564 6961 5f69 6429 0a20 2020 2020   media_id).     
-000286d0: 2020 2020 2020 2069 6620 6e6f 7420 6669         if not fi
-000286e0: 6c65 6e61 6d65 3a0a 2020 2020 2020 2020  lename:.        
-000286f0: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-00028700: 203d 2022 6d78 632d 2220 2b20 6d65 6469   = "mxc-" + medi
-00028710: 615f 6964 2020 2320 3372 6420 6368 6f69  a_id  # 3rd choi
-00028720: 6365 2c20 6d78 635f 6964 0a20 2020 2020  ce, mxc_id.     
-00028730: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00028740: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00028750: 2020 2020 2066 2244 6f77 6e6c 6f61 6420       f"Download 
-00028760: 6f66 2055 5249 2027 7b6d 7863 7d27 2074  of URI '{mxc}' t
-00028770: 6f20 6c6f 6361 6c20 6669 6c65 2027 7b66  o local file '{f
-00028780: 696c 656e 616d 657d 2720 220a 2020 2020  ilename}' ".    
-00028790: 2020 2020 2020 2020 2020 2020 6622 7375              f"su
-000287a0: 6363 6573 7366 756c 2077 6974 6820 7b6c  ccessful with {l
-000287b0: 656e 2872 6573 702e 626f 6479 297d 2062  en(resp.body)} b
-000287c0: 7974 6573 206f 6620 6461 7461 2064 6f77  ytes of data dow
-000287d0: 6e6c 6f61 6465 642c 2022 0a20 2020 2020  nloaded, ".     
-000287e0: 2020 2020 2020 2020 2020 2066 2263 6f6e             f"con
-000287f0: 7465 6e74 5f74 7970 6520 7b72 6573 702e  tent_type {resp.
-00028800: 636f 6e74 656e 745f 7479 7065 7d3b 2022  content_type}; "
-00028810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028820: 2066 2272 656d 6f74 6520 6669 6c65 6e61   f"remote filena
-00028830: 6d65 207b 7265 7370 2e66 696c 656e 616d  me {resp.filenam
-00028840: 657d 3b20 220a 2020 2020 2020 2020 2020  e}; ".          
-00028850: 2020 2020 2020 6622 656e 6372 7970 7465        f"encrypte
-00028860: 6420 7b65 6e63 7279 7074 6564 7d3b 2022  d {encrypted}; "
-00028870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028880: 2022 6b65 7920 6469 6374 696f 6e61 7279   "key dictionary
-00028890: 2027 2a2a 2a20 6869 6464 656e 2074 6f20   '*** hidden to 
-000288a0: 7072 6576 656e 7420 6c65 616b 7327 2e20  prevent leaks'. 
-000288b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000288c0: 2020 2320 6622 6b65 7920 6469 6374 696f    # f"key dictio
-000288d0: 6e61 7279 207b 6465 6372 7970 7469 6f6e  nary {decryption
-000288e0: 5f73 7472 7d2e 2022 0a20 2020 2020 2020  _str}. ".       
-000288f0: 2020 2020 2020 2020 2022 5472 7969 6e67           "Trying
-00028900: 2074 6f20 7361 7665 2064 6174 6120 6e6f   to save data no
-00028910: 772e 220a 2020 2020 2020 2020 2020 2020  w.".            
-00028920: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00028930: 2065 6e63 7279 7074 6564 3a0a 2020 2020   encrypted:.    
-00028940: 2020 2020 2020 2020 2020 2020 6465 6372              decr
-00028950: 7970 7469 6f6e 5f64 6963 7420 3d20 6173  yption_dict = as
-00028960: 742e 6c69 7465 7261 6c5f 6576 616c 2864  t.literal_eval(d
-00028970: 6563 7279 7074 696f 6e5f 7374 7229 0a20  ecryption_str). 
-00028980: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00028990: 6974 6820 6f70 656e 2866 696c 656e 616d  ith open(filenam
-000289a0: 652c 2022 7762 2229 2061 7320 6669 6c65  e, "wb") as file
-000289b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000289c0: 2020 2020 2020 6669 6c65 2e77 7269 7465        file.write
-000289d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000289e0: 2020 2020 2020 2020 2020 6372 7970 746f            crypto
-000289f0: 2e61 7474 6163 686d 656e 7473 2e64 6563  .attachments.dec
-00028a00: 7279 7074 5f61 7474 6163 686d 656e 7428  rypt_attachment(
-00028a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028a20: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00028a30: 702e 626f 6479 2c0a 2020 2020 2020 2020  p.body,.        
-00028a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a50: 2020 2020 6465 6372 7970 7469 6f6e 5f64      decryption_d
-00028a60: 6963 745b 226b 6579 225d 5b22 6b22 5d2c  ict["key"]["k"],
-00028a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028a80: 2020 2020 2020 2020 2020 2020 2064 6563               dec
-00028a90: 7279 7074 696f 6e5f 6469 6374 5b22 6861  ryption_dict["ha
-00028aa0: 7368 6573 225d 5b22 7368 6132 3536 225d  shes"]["sha256"]
-00028ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028ac0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00028ad0: 6372 7970 7469 6f6e 5f64 6963 745b 2269  cryption_dict["i
-00028ae0: 7622 5d2c 0a20 2020 2020 2020 2020 2020  v"],.           
-00028af0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00028b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00028b20: 2065 6c73 653a 2020 2320 706c 6169 6e2c   else:  # plain,
-00028b30: 2075 6e65 6e63 7279 7074 6564 0a20 2020   unencrypted.   
-00028b40: 2020 2020 2020 2020 2020 2020 2077 6974               wit
-00028b50: 6820 6f70 656e 2866 696c 656e 616d 652c  h open(filename,
-00028b60: 2022 7762 2229 2061 7320 6669 6c65 3a0a   "wb") as file:.
-00028b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b80: 2020 2020 6669 6c65 2e77 7269 7465 2872      file.write(r
-00028b90: 6573 702e 626f 6479 290a 2020 2020 2020  esp.body).      
-00028ba0: 2020 6969 202b 3d20 310a 0a0a 6173 796e    ii += 1...asyn
-00028bb0: 6320 6465 6620 6163 7469 6f6e 5f6a 6f69  c def action_joi
-00028bc0: 6e65 645f 726f 6f6d 7328 636c 6965 6e74  ned_rooms(client
-00028bd0: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
-00028be0: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
-00028bf0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-00028c00: 2222 4765 7420 6a6f 696e 6564 2072 6f6f  ""Get joined roo
-00028c10: 6d73 2077 6869 6c65 2061 6c72 6561 6479  ms while already
-00028c20: 206c 6f67 6765 6420 696e 2e22 2222 0a20   logged in.""". 
-00028c30: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
-00028c40: 636c 6965 6e74 2e6a 6f69 6e65 645f 726f  client.joined_ro
-00028c50: 6f6d 7328 290a 2020 2020 6966 2069 7369  oms().    if isi
-00028c60: 6e73 7461 6e63 6528 7265 7370 2c20 4a6f  nstance(resp, Jo
-00028c70: 696e 6564 526f 6f6d 7345 7272 6f72 293a  inedRoomsError):
-00028c80: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00028c90: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-00028ca0: 2020 2022 4531 3737 3a20 2220 6622 6a6f     "E177: " f"jo
-00028cb0: 696e 6564 5f72 6f6f 6d73 2066 6169 6c65  ined_rooms faile
-00028cc0: 6420 7769 7468 207b 7072 6976 6163 795f  d with {privacy_
-00028cd0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00028ce0: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
-00028cf0: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00028d00: 6e74 202b 3d20 310a 2020 2020 656c 7365  nt += 1.    else
-00028d10: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00028d20: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00028d30: 2020 2020 6622 6a6f 696e 6564 5f72 6f6f      f"joined_roo
-00028d40: 6d73 2073 7563 6365 7373 6675 6c20 7769  ms successful wi
-00028d50: 7468 207b 7072 6976 6163 795f 6669 6c74  th {privacy_filt
-00028d60: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-00028d70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00028d80: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
-00028d90: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
-00028da0: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
-00028db0: 2020 2020 2020 2074 6578 7420 3d20 2222         text = ""
-00028dc0: 0a20 2020 2020 2020 2066 6f72 2072 7220  .        for rr 
-00028dd0: 696e 2072 6573 702e 726f 6f6d 733a 0a20  in resp.rooms:. 
-00028de0: 2020 2020 2020 2020 2020 2074 6578 7420             text 
-00028df0: 2b3d 2072 7220 2b20 225c 6e22 0a20 2020  += rr + "\n".   
-00028e00: 2020 2020 2074 6578 7420 3d20 7465 7874       text = text
-00028e10: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
-00028e20: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
-00028e30: 6520 7878 7852 6573 706f 6e73 6520 6973  e xxxResponse is
-00028e40: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
-00028e50: 2020 2320 7365 7269 616c 697a 6162 6c65    # serializable
-00028e60: 2c20 6865 6e63 6520 7765 2075 7365 2074  , hence we use t
-00028e70: 6865 2064 6963 7469 6f6e 6172 792e 0a20  he dictionary.. 
-00028e80: 2020 2020 2020 206a 736f 6e5f 6d61 7820         json_max 
-00028e90: 3d20 7265 7370 2e5f 5f64 6963 745f 5f0a  = resp.__dict__.
-00028ea0: 2020 2020 2020 2020 2320 6a73 6f6e 5f6d          # json_m
-00028eb0: 6178 2e75 7064 6174 6528 7b22 6b65 7922  ax.update({"key"
-00028ec0: 3a20 7661 6c75 657d 2920 2023 2061 6464  : value})  # add
-00028ed0: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
-00028ee0: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
-00028ef0: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
-00028f00: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
-00028f10: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
-00028f20: 6522 290a 2020 2020 2020 2020 6a73 6f6e  e").        json
-00028f30: 5f73 7065 6320 3d20 4e6f 6e65 0a20 2020  _spec = None.   
-00028f40: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
-00028f50: 7428 0a20 2020 2020 2020 2020 2020 2067  t(.            g
-00028f60: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
-00028f70: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
-00028f80: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
-00028f90: 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020  json_=json_,.   
-00028fa0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00028fb0: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
-00028fc0: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00028fd0: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
-00028fe0: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
-00028ff0: 6566 2061 6374 696f 6e5f 6a6f 696e 6564  ef action_joined
-00029000: 5f6d 656d 6265 7273 280a 2020 2020 636c  _members(.    cl
-00029010: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
-00029020: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
-00029030: 6469 6374 0a29 202d 3e20 4e6f 6e65 3a0a  dict.) -> None:.
-00029040: 2020 2020 2222 2247 6574 206d 656d 6265      """Get membe
-00029050: 7273 206f 6620 6769 7665 6e20 726f 6f6d  rs of given room
-00029060: 7320 7768 696c 6520 616c 7265 6164 7920  s while already 
-00029070: 6265 696e 6720 6c6f 6767 6564 2069 6e2e  being logged in.
-00029080: 2222 220a 2020 2020 726f 6f6d 7320 3d20  """.    rooms = 
-00029090: 6773 2e70 612e 6a6f 696e 6564 5f6d 656d  gs.pa.joined_mem
-000290a0: 6265 7273 0a20 2020 2069 6620 6e6f 7420  bers.    if not 
-000290b0: 726f 6f6d 733a 0a20 2020 2020 2020 2067  rooms:.        g
-000290c0: 732e 6c6f 672e 7761 726e 696e 6728 0a20  s.log.warning(. 
-000290d0: 2020 2020 2020 2020 2020 2022 5731 3037             "W107
-000290e0: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-000290f0: 224e 6f20 6d65 6d62 6572 7368 6970 2061  "No membership a
-00029100: 6374 696f 6e28 7329 2077 6572 6520 7065  ction(s) were pe
-00029110: 7266 6f72 6d65 6420 6265 6361 7573 6520  rformed because 
-00029120: 6e6f 2072 6f6f 6d73 2022 0a20 2020 2020  no rooms ".     
-00029130: 2020 2020 2020 2022 7765 7265 2073 7065         "were spe
-00029140: 6369 6669 6564 2e20 5573 6520 2d2d 6a6f  cified. Use --jo
-00029150: 696e 6564 2d6d 656d 6265 7273 206f 7074  ined-members opt
-00029160: 696f 6e20 616e 6420 7370 6563 6966 7920  ion and specify 
-00029170: 726f 6f6d 732e 220a 2020 2020 2020 2020  rooms.".        
-00029180: 290a 2020 2020 2020 2020 6773 2e77 6172  ).        gs.war
-00029190: 6e5f 636f 756e 7420 2b3d 2031 0a20 2020  n_count += 1.   
-000291a0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-000291b0: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
-000291c0: 5472 7969 6e67 2074 6f20 6765 7420 6d65  Trying to get me
-000291d0: 6d62 6572 7320 666f 7220 7468 6573 6520  mbers for these 
-000291e0: 726f 6f6d 733a 207b 726f 6f6d 737d 2229  rooms: {rooms}")
-000291f0: 0a20 2020 2069 6620 222a 2220 696e 2072  .    if "*" in r
-00029200: 6f6f 6d73 3a0a 2020 2020 2020 2020 7265  ooms:.        re
-00029210: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-00029220: 742e 6a6f 696e 6564 5f72 6f6f 6d73 2829  t.joined_rooms()
-00029230: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00029240: 7374 616e 6365 2872 6573 702c 204a 6f69  stance(resp, Joi
-00029250: 6e65 6452 6f6f 6d73 4572 726f 7229 3a0a  nedRoomsError):.
-00029260: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00029270: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-00029280: 2020 2020 2020 2020 2020 2245 3137 383a            "E178:
-00029290: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000292a0: 2020 2022 6a6f 696e 6564 5f72 6f6f 6d73     "joined_rooms
-000292b0: 2066 6169 6c65 6420 7769 7468 2022 0a20   failed with ". 
-000292c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000292d0: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
-000292e0: 2873 7472 2872 6573 7029 297d 2e20 4e6f  (str(resp))}. No
-000292f0: 7420 6162 6c65 2074 6f20 220a 2020 2020  t able to ".    
-00029300: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-00029310: 2061 6c6c 2072 6f6f 6d73 2061 7320 7370   all rooms as sp
-00029320: 6563 6966 6965 6420 6279 2027 2a27 2e20  ecified by '*'. 
-00029330: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00029340: 2020 2254 6865 206d 656d 6265 7220 6c69    "The member li
-00029350: 7374 696e 6720 7769 6c6c 2062 6520 696e  sting will be in
-00029360: 636f 6d70 6c65 7465 206f 7220 6d69 7373  complete or miss
-00029370: 696e 672e 220a 2020 2020 2020 2020 2020  ing.".          
-00029380: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00029390: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-000293a0: 310a 2020 2020 2020 2020 2020 2020 2320  1.            # 
-000293b0: 7369 6e63 6520 7765 2063 616e 2774 2067  since we can't g
-000293c0: 6574 2061 6c6c 2072 6f6f 6d73 206c 6561  et all rooms lea
-000293d0: 7665 2072 6f6f 6d20 6c69 7374 2061 7320  ve room list as 
-000293e0: 6973 0a20 2020 2020 2020 2020 2020 2072  is.            r
-000293f0: 6f6f 6d73 203d 2066 696c 7465 7228 6c61  ooms = filter(la
-00029400: 6d62 6461 2076 616c 3a20 7661 6c20 213d  mbda val: val !=
-00029410: 2022 2a22 2c20 726f 6f6d 7329 2020 2320   "*", rooms)  # 
-00029420: 7265 6d6f 7665 2061 6c6c 202a 0a20 2020  remove all *.   
-00029430: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00029440: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-00029450: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00029460: 2020 2020 2066 226a 6f69 6e65 645f 726f       f"joined_ro
-00029470: 6f6d 7320 7375 6363 6573 7366 756c 2077  oms successful w
-00029480: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
-00029490: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-000294a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000294b0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-000294c0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
-000294d0: 2020 2020 2020 2020 2022 526f 6f6d 206c           "Room l
-000294e0: 6973 7420 6861 7320 6265 656e 2073 7563  ist has been suc
-000294f0: 6365 7373 6675 6c6c 7920 6f76 6572 7772  cessfully overwr
-00029500: 6974 7465 6e20 7769 7468 2027 2a27 220a  itten with '*'".
-00029510: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00029520: 2020 2020 2020 2020 2020 726f 6f6d 7320            rooms 
-00029530: 3d20 7265 7370 2e72 6f6f 6d73 2020 2320  = resp.rooms  # 
-00029540: 6f76 6572 7772 6974 6520 6172 6773 2077  overwrite args w
-00029550: 6974 6820 6675 6c6c 206c 6973 740a 2020  ith full list.  
-00029560: 2020 666f 7220 726f 6f6d 2069 6e20 726f    for room in ro
-00029570: 6f6d 733a 0a20 2020 2020 2020 2072 6f6f  oms:.        roo
-00029580: 6d20 3d20 726f 6f6d 2e72 6570 6c61 6365  m = room.replace
-00029590: 2872 225c 2122 2c20 2221 2229 2020 2320  (r"\!", "!")  # 
-000295a0: 7265 6d6f 7665 2070 6f73 7369 626c 6520  remove possible 
-000295b0: 6573 6361 7065 0a20 2020 2020 2020 2072  escape.        r
-000295c0: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-000295d0: 6e74 2e6a 6f69 6e65 645f 6d65 6d62 6572  nt.joined_member
-000295e0: 7328 726f 6f6d 290a 2020 2020 2020 2020  s(room).        
-000295f0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-00029600: 7370 2c20 4a6f 696e 6564 4d65 6d62 6572  sp, JoinedMember
-00029610: 7345 7272 6f72 293a 0a20 2020 2020 2020  sError):.       
-00029620: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-00029630: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00029640: 2020 2022 4531 3739 3a20 220a 2020 2020     "E179: ".    
-00029650: 2020 2020 2020 2020 2020 2020 6622 6a6f              f"jo
-00029660: 696e 6564 5f6d 656d 6265 7273 2066 6169  ined_members fai
-00029670: 6c65 6420 7769 7468 207b 7072 6976 6163  led with {privac
-00029680: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-00029690: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
-000296a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000296b0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-000296c0: 310a 2020 2020 2020 2020 656c 7365 3a0a  1.        else:.
-000296d0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-000296e0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-000296f0: 2020 2020 2020 2020 2020 6622 6a6f 696e            f"join
-00029700: 6564 5f6d 656d 6265 7273 2073 7563 6365  ed_members succe
-00029710: 7373 6675 6c20 7769 7468 207b 7072 6976  ssful with {priv
-00029720: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00029730: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-00029740: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00029750: 2020 2320 6d65 6d62 6572 7320 3d20 4c69    # members = Li
-00029760: 7374 5b52 6f6f 6d4d 656d 6265 725d 203b  st[RoomMember] ;
-00029770: 2052 6f6f 6d4d 656d 6265 720a 2020 2020   RoomMember.    
-00029780: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-00029790: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
-000297a0: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
-000297b0: 666c 6167 0a20 2020 2020 2020 2020 2020  flag.           
-000297c0: 2074 6578 7420 3d20 7265 7370 2e72 6f6f   text = resp.roo
-000297d0: 6d5f 6964 202b 2022 5c6e 220a 2020 2020  m_id + "\n".    
-000297e0: 2020 2020 2020 2020 666f 7220 6d65 6d62          for memb
-000297f0: 6572 2069 6e20 7265 7370 2e6d 656d 6265  er in resp.membe
-00029800: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00029810: 2020 2020 2320 636f 6e76 6572 7420 4e6f      # convert No
-00029820: 6e65 2074 6f20 2727 0a20 2020 2020 2020  ne to ''.       
-00029830: 2020 2020 2020 2020 2074 6578 7420 2b3d           text +=
-00029840: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00029850: 2020 2020 2020 2053 4550 0a20 2020 2020         SEP.     
-00029860: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00029870: 206d 656d 6265 722e 7573 6572 5f69 640a   member.user_id.
-00029880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029890: 2020 2020 2b20 5345 500a 2020 2020 2020      + SEP.      
-000298a0: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-000298b0: 7a6e 286d 656d 6265 722e 6469 7370 6c61  zn(member.displa
-000298c0: 795f 6e61 6d65 290a 2020 2020 2020 2020  y_name).        
-000298d0: 2020 2020 2020 2020 2020 2020 2b20 5345              + SE
-000298e0: 500a 2020 2020 2020 2020 2020 2020 2020  P.              
-000298f0: 2020 2020 2020 2b20 7a6e 286d 656d 6265        + zn(membe
-00029900: 722e 6176 6174 6172 5f75 726c 290a 2020  r.avatar_url).  
-00029910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029920: 2020 2b20 225c 6e22 0a20 2020 2020 2020    + "\n".       
-00029930: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00029940: 2020 2020 2020 2074 6578 7420 3d20 7465         text = te
-00029950: 7874 2e73 7472 6970 2829 0a20 2020 2020  xt.strip().     
-00029960: 2020 2020 2020 2023 204f 626a 6563 7420         # Object 
-00029970: 6f66 2074 7970 6520 7878 7852 6573 706f  of type xxxRespo
-00029980: 6e73 6520 6973 206e 6f74 204a 534f 4e0a  nse is not JSON.
-00029990: 2020 2020 2020 2020 2020 2020 2320 7365              # se
-000299a0: 7269 616c 697a 6162 6c65 2c20 6865 6e63  rializable, henc
-000299b0: 6520 7765 2075 7365 2074 6865 2064 6963  e we use the dic
-000299c0: 7469 6f6e 6172 792e 0a20 2020 2020 2020  tionary..       
-000299d0: 2020 2020 206a 736f 6e5f 6d61 7820 3d20       json_max = 
-000299e0: 7265 7370 2e5f 5f64 6963 745f 5f0a 2020  resp.__dict__.  
-000299f0: 2020 2020 2020 2020 2020 2320 6a73 6f6e            # json
-00029a00: 5f6d 6178 2e75 7064 6174 6528 7b22 6b65  _max.update({"ke
-00029a10: 7922 3a20 7661 6c75 657d 2920 2023 2061  y": value})  # a
-00029a20: 6464 2064 6963 7420 6974 656d 730a 2020  dd dict items.  
-00029a30: 2020 2020 2020 2020 2020 6a73 6f6e 5f20            json_ 
-00029a40: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
-00029a50: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
-00029a60: 6f6e 5f2e 706f 7028 2274 7261 6e73 706f  on_.pop("transpo
-00029a70: 7274 5f72 6573 706f 6e73 6522 290a 2020  rt_response").  
-00029a80: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
-00029a90: 7065 6320 3d20 4e6f 6e65 0a20 2020 2020  pec = None.     
-00029aa0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
-00029ab0: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
-00029ac0: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
-00029ad0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00029ae0: 2020 2074 6578 743d 7465 7874 2c0a 2020     text=text,.  
-00029af0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00029b00: 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020 2020  on_=json_,.     
-00029b10: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-00029b20: 6d61 783d 6a73 6f6e 5f6d 6178 2c0a 2020  max=json_max,.  
-00029b30: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00029b40: 6f6e 5f73 7065 633d 6a73 6f6e 5f73 7065  on_spec=json_spe
-00029b50: 632c 0a20 2020 2020 2020 2020 2020 2029  c,.            )
-00029b60: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
-00029b70: 696f 6e5f 6d78 635f 746f 5f68 7474 7028  ion_mxc_to_http(
-00029b80: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-00029b90: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-00029ba0: 3a20 6469 6374 2920 2d3e 204e 6f6e 653a  : dict) -> None:
-00029bb0: 0a20 2020 2022 2222 436f 6e76 6572 7420  .    """Convert 
-00029bc0: 4d58 4320 5552 4920 746f 2048 5454 5020  MXC URI to HTTP 
-00029bd0: 5552 4c20 7768 696c 6520 616c 7265 6164  URL while alread
-00029be0: 7920 6c6f 6767 6564 2069 6e2e 2222 220a  y logged in.""".
-00029bf0: 2020 2020 666f 7220 6d78 6320 696e 2067      for mxc in g
-00029c00: 732e 7061 2e6d 7863 5f74 6f5f 6874 7470  s.pa.mxc_to_http
-00029c10: 3a0a 2020 2020 2020 2020 6d78 6320 3d20  :.        mxc = 
-00029c20: 6d78 632e 7374 7269 7028 290a 2020 2020  mxc.strip().    
-00029c30: 2020 2020 6874 7470 203d 2061 7761 6974      http = await
-00029c40: 2063 6c69 656e 742e 6d78 635f 746f 5f68   client.mxc_to_h
-00029c50: 7474 7028 6d78 6329 2020 2320 7265 7475  ttp(mxc)  # retu
-00029c60: 726e 7320 4e6f 6e65 206f 7220 7374 720a  rns None or str.
-00029c70: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-00029c80: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
-00029c90: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
-00029ca0: 666c 6167 0a20 2020 2020 2020 2074 6578  flag.        tex
-00029cb0: 7420 3d20 6622 7b6d 7863 7d7b 5345 507d  t = f"{mxc}{SEP}
-00029cc0: 7b68 7474 707d 220a 2020 2020 2020 2020  {http}".        
-00029cd0: 6a73 6f6e 5f6d 6178 203d 207b 226d 7863  json_max = {"mxc
-00029ce0: 223a 206d 7863 2c20 2268 7474 7022 3a20  ": mxc, "http": 
-00029cf0: 6874 7470 7d0a 2020 2020 2020 2020 2320  http}.        # 
-00029d00: 6a73 6f6e 5f6d 6178 2e75 7064 6174 6528  json_max.update(
-00029d10: 7b22 6b65 7922 3a20 7661 6c75 657d 2920  {"key": value}) 
-00029d20: 2023 2061 6464 2064 6963 7420 6974 656d   # add dict item
-00029d30: 730a 2020 2020 2020 2020 6a73 6f6e 5f20  s.        json_ 
-00029d40: 3d20 6a73 6f6e 5f6d 6178 2e63 6f70 7928  = json_max.copy(
-00029d50: 290a 2020 2020 2020 2020 2320 6a73 6f6e  ).        # json
-00029d60: 5f2e 706f 7028 226b 6579 2229 0a20 2020  _.pop("key").   
-00029d70: 2020 2020 206a 736f 6e5f 7370 6563 203d       json_spec =
-00029d80: 204e 6f6e 650a 2020 2020 2020 2020 7072   None.        pr
-00029d90: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
-00029da0: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
-00029db0: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
-00029dc0: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
-00029dd0: 2020 2020 2020 2020 206a 736f 6e5f 3d6a           json_=j
-00029de0: 736f 6e5f 2c0a 2020 2020 2020 2020 2020  son_,.          
-00029df0: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
-00029e00: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
-00029e10: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
-00029e20: 7370 6563 2c0a 2020 2020 2020 2020 290a  spec,.        ).
-00029e30: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
-00029e40: 6f6e 5f64 6576 6963 6573 2863 6c69 656e  on_devices(clien
-00029e50: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-00029e60: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-00029e70: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-00029e80: 2222 224c 6973 7420 6465 7669 6365 7320  """List devices 
-00029e90: 6f66 2061 6363 6f75 6e74 2077 6869 6c65  of account while
-00029ea0: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
-00029eb0: 696e 2e22 2222 0a20 2020 2072 6573 7020  in.""".    resp 
-00029ec0: 3d20 6177 6169 7420 636c 6965 6e74 2e64  = await client.d
-00029ed0: 6576 6963 6573 2829 0a20 2020 2069 6620  evices().    if 
-00029ee0: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-00029ef0: 2044 6576 6963 6573 4572 726f 7229 3a0a   DevicesError):.
-00029f00: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00029f10: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00029f20: 2020 2245 3138 303a 2022 2066 2264 6576    "E180: " f"dev
-00029f30: 6963 6573 2066 6169 6c65 6420 7769 7468  ices failed with
-00029f40: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
-00029f50: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
-00029f60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00029f70: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-00029f80: 310a 2020 2020 656c 7365 3a0a 2020 2020  1.    else:.    
-00029f90: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00029fa0: 2866 2264 6576 6963 6573 2073 7563 6365  (f"devices succe
-00029fb0: 7373 6675 6c20 7769 7468 207b 7072 6976  ssful with {priv
-00029fc0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00029fd0: 6573 7029 297d 2229 0a20 2020 2020 2020  esp))}").       
-00029fe0: 2023 206f 7574 7075 7420 666f 726d 6174   # output format
-00029ff0: 2063 6f6e 7472 6f6c 6c65 6420 7669 6120   controlled via 
-0002a000: 2d2d 6f75 7470 7574 2066 6c61 670a 2020  --output flag.  
-0002a010: 2020 2020 2020 7465 7874 203d 2022 220a        text = "".
-0002a020: 2020 2020 2020 2020 666f 7220 7272 2069          for rr i
-0002a030: 6e20 7265 7370 2e64 6576 6963 6573 3a0a  n resp.devices:.
-0002a040: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0002a050: 202b 3d20 280a 2020 2020 2020 2020 2020   += (.          
-0002a060: 2020 2020 2020 7272 2e69 640a 2020 2020        rr.id.    
-0002a070: 2020 2020 2020 2020 2020 2020 2b20 5345              + SE
-0002a080: 500a 2020 2020 2020 2020 2020 2020 2020  P.              
-0002a090: 2020 2b20 7272 2e64 6973 706c 6179 5f6e    + rr.display_n
-0002a0a0: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
-0002a0b0: 2020 2020 2b20 5345 500a 2020 2020 2020      + SEP.      
-0002a0c0: 2020 2020 2020 2020 2020 2b20 7272 2e6c            + rr.l
-0002a0d0: 6173 745f 7365 656e 5f69 700a 2020 2020  ast_seen_ip.    
-0002a0e0: 2020 2020 2020 2020 2020 2020 2b20 5345              + SE
-0002a0f0: 500a 2020 2020 2020 2020 2020 2020 2020  P.              
-0002a100: 2020 2b20 7374 7228 7272 2e6c 6173 745f    + str(rr.last_
-0002a110: 7365 656e 5f64 6174 6529 0a20 2020 2020  seen_date).     
-0002a120: 2020 2020 2020 2020 2020 202b 2022 5c6e             + "\n
-0002a130: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0002a140: 2020 2020 2020 2020 7465 7874 203d 2074          text = t
-0002a150: 6578 742e 7374 7269 7028 290a 2020 2020  ext.strip().    
-0002a160: 2020 2020 2320 4f62 6a65 6374 206f 6620      # Object of 
-0002a170: 7479 7065 2078 7878 5265 7370 6f6e 7365  type xxxResponse
-0002a180: 2069 7320 6e6f 7420 4a53 4f4e 0a20 2020   is not JSON.   
-0002a190: 2020 2020 2023 2073 6572 6961 6c69 7a61       # serializa
-0002a1a0: 626c 652c 2068 656e 6365 2077 6520 7573  ble, hence we us
-0002a1b0: 6520 7468 6520 6469 6374 696f 6e61 7279  e the dictionary
-0002a1c0: 2e0a 2020 2020 2020 2020 6a73 6f6e 5f6d  ..        json_m
-0002a1d0: 6178 203d 2072 6573 702e 5f5f 6469 6374  ax = resp.__dict
-0002a1e0: 5f5f 0a20 2020 2020 2020 2023 206a 736f  __.        # jso
-0002a1f0: 6e5f 6d61 782e 7570 6461 7465 287b 226b  n_max.update({"k
-0002a200: 6579 223a 2076 616c 7565 7d29 2020 2320  ey": value})  # 
-0002a210: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
-0002a220: 2020 2020 2020 206a 736f 6e5f 203d 206a         json_ = j
-0002a230: 736f 6e5f 6d61 782e 636f 7079 2829 0a20  son_max.copy(). 
-0002a240: 2020 2020 2020 206a 736f 6e5f 2e70 6f70         json_.pop
-0002a250: 2822 7472 616e 7370 6f72 745f 7265 7370  ("transport_resp
-0002a260: 6f6e 7365 2229 0a20 2020 2020 2020 206a  onse").        j
-0002a270: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-0002a280: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
-0002a290: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-0002a2a0: 2020 6773 2e70 612e 6f75 7470 7574 2c0a    gs.pa.output,.
-0002a2b0: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0002a2c0: 3d74 6578 742c 0a20 2020 2020 2020 2020  =text,.         
-0002a2d0: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-0002a2e0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0002a2f0: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
-0002a300: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0002a310: 7370 6563 3d6a 736f 6e5f 7370 6563 2c0a  spec=json_spec,.
-0002a320: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
-0002a330: 6320 6465 6620 6163 7469 6f6e 5f64 6973  c def action_dis
-0002a340: 636f 7665 7279 5f69 6e66 6f28 0a20 2020  covery_info(.   
-0002a350: 2063 6c69 656e 743a 2041 7379 6e63 436c   client: AsyncCl
-0002a360: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
-0002a370: 733a 2064 6963 740a 2920 2d3e 204e 6f6e  s: dict.) -> Non
-0002a380: 653a 0a20 2020 2022 2222 4c69 7374 2064  e:.    """List d
-0002a390: 6973 636f 7665 7279 5f69 6e66 6f20 6f66  iscovery_info of
-0002a3a0: 2068 6f6d 6520 7365 7276 6572 2077 6869   home server whi
-0002a3b0: 6c65 2061 6c72 6561 6479 206c 6f67 6765  le already logge
-0002a3c0: 6420 696e 2e22 2222 0a20 2020 2072 6573  d in.""".    res
-0002a3d0: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-0002a3e0: 2e64 6973 636f 7665 7279 5f69 6e66 6f28  .discovery_info(
-0002a3f0: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
-0002a400: 6e63 6528 7265 7370 2c20 4469 7363 6f76  nce(resp, Discov
-0002a410: 6572 7949 6e66 6f45 7272 6f72 293a 0a20  eryInfoError):. 
-0002a420: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-0002a430: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0002a440: 2022 4531 3831 3a20 2220 6622 6469 7363   "E181: " f"disc
-0002a450: 6f76 6572 795f 696e 666f 2066 6169 6c65  overy_info faile
-0002a460: 6420 7769 7468 207b 7072 6976 6163 795f  d with {privacy_
-0002a470: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-0002a480: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
-0002a490: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-0002a4a0: 6e74 202b 3d20 310a 2020 2020 656c 7365  nt += 1.    else
-0002a4b0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-0002a4c0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-0002a4d0: 2020 2020 6622 6469 7363 6f76 6572 795f      f"discovery_
-0002a4e0: 696e 666f 2073 7563 6365 7373 6675 6c20  info successful 
-0002a4f0: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
-0002a500: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-0002a510: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0002a520: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
-0002a530: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
-0002a540: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
-0002a550: 0a20 2020 2020 2020 2074 6578 7420 3d20  .        text = 
-0002a560: 6622 7b72 6573 702e 686f 6d65 7365 7276  f"{resp.homeserv
-0002a570: 6572 5f75 726c 7d7b 5345 507d 7b72 6573  er_url}{SEP}{res
-0002a580: 702e 6964 656e 7469 7479 5f73 6572 7665  p.identity_serve
-0002a590: 725f 7572 6c7d 220a 2020 2020 2020 2020  r_url}".        
-0002a5a0: 2320 4f62 6a65 6374 206f 6620 7479 7065  # Object of type
-0002a5b0: 2078 7878 5265 7370 6f6e 7365 2069 7320   xxxResponse is 
-0002a5c0: 6e6f 7420 4a53 4f4e 0a20 2020 2020 2020  not JSON.       
-0002a5d0: 2023 2073 6572 6961 6c69 7a61 626c 652c   # serializable,
-0002a5e0: 2068 656e 6365 2077 6520 7573 6520 7468   hence we use th
-0002a5f0: 6520 6469 6374 696f 6e61 7279 2e0a 2020  e dictionary..  
-0002a600: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
-0002a610: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
-0002a620: 2020 2020 2020 2023 206a 736f 6e5f 6d61         # json_ma
-0002a630: 782e 7570 6461 7465 287b 226b 6579 223a  x.update({"key":
-0002a640: 2076 616c 7565 7d29 2020 2320 6164 6420   value})  # add 
-0002a650: 6469 6374 2069 7465 6d73 0a20 2020 2020  dict items.     
-0002a660: 2020 206a 736f 6e5f 203d 206a 736f 6e5f     json_ = json_
-0002a670: 6d61 782e 636f 7079 2829 0a20 2020 2020  max.copy().     
-0002a680: 2020 206a 736f 6e5f 2e70 6f70 2822 7472     json_.pop("tr
-0002a690: 616e 7370 6f72 745f 7265 7370 6f6e 7365  ansport_response
-0002a6a0: 2229 0a20 2020 2020 2020 206a 736f 6e5f  ").        json_
-0002a6b0: 7370 6563 203d 204e 6f6e 650a 2020 2020  spec = None.    
-0002a6c0: 2020 2020 7072 696e 745f 6f75 7470 7574      print_output
-0002a6d0: 280a 2020 2020 2020 2020 2020 2020 6773  (.            gs
-0002a6e0: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
-0002a6f0: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
-0002a700: 742c 0a20 2020 2020 2020 2020 2020 206a  t,.            j
-0002a710: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
-0002a720: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-0002a730: 3d6a 736f 6e5f 6d61 782c 0a20 2020 2020  =json_max,.     
-0002a740: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
-0002a750: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
-0002a760: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-0002a770: 6620 6163 7469 6f6e 5f6c 6f67 696e 5f69  f action_login_i
-0002a780: 6e66 6f28 636c 6965 6e74 3a20 4173 796e  nfo(client: Asyn
-0002a790: 6343 6c69 656e 742c 2063 7265 6465 6e74  cClient, credent
-0002a7a0: 6961 6c73 3a20 6469 6374 2920 2d3e 204e  ials: dict) -> N
-0002a7b0: 6f6e 653a 0a20 2020 2022 2222 4c69 7374  one:.    """List
-0002a7c0: 206c 6f67 696e 206d 6574 686f 6473 206f   login methods o
-0002a7d0: 6620 686f 6d65 2073 6572 7665 7220 7768  f home server wh
-0002a7e0: 696c 6520 616c 7265 6164 7920 6c6f 6767  ile already logg
-0002a7f0: 6564 2069 6e2e 2222 220a 2020 2020 7265  ed in.""".    re
-0002a800: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-0002a810: 742e 6c6f 6769 6e5f 696e 666f 2829 0a20  t.login_info(). 
-0002a820: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0002a830: 2872 6573 702c 204c 6f67 696e 496e 666f  (resp, LoginInfo
-0002a840: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002a850: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-0002a860: 2020 2020 2020 2020 2020 2245 3138 323a            "E182:
-0002a870: 2022 2066 226c 6f67 696e 5f69 6e66 6f20   " f"login_info 
-0002a880: 6661 696c 6564 2077 6974 6820 7b70 7269  failed with {pri
-0002a890: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-0002a8a0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-0002a8b0: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
-0002a8c0: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-0002a8d0: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
-0002a8e0: 732e 6c6f 672e 6465 6275 6728 6622 6c6f  s.log.debug(f"lo
-0002a8f0: 6769 6e5f 696e 666f 2073 7563 6365 7373  gin_info success
-0002a900: 6675 6c20 7769 7468 207b 7072 6976 6163  ful with {privac
-0002a910: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-0002a920: 7029 297d 2229 0a20 2020 2020 2020 2023  p))}").        #
-0002a930: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
-0002a940: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
-0002a950: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
-0002a960: 2020 2020 7465 7874 203d 2022 220a 2020      text = "".  
-0002a970: 2020 2020 2020 666f 7220 7272 2069 6e20        for rr in 
-0002a980: 7265 7370 2e66 6c6f 7773 3a0a 2020 2020  resp.flows:.    
-0002a990: 2020 2020 2020 2020 7465 7874 202b 3d20          text += 
-0002a9a0: 7374 7228 7272 2920 2b20 225c 6e22 0a20  str(rr) + "\n". 
-0002a9b0: 2020 2020 2020 2074 6578 7420 3d20 7465         text = te
-0002a9c0: 7874 2e73 7472 6970 2829 0a20 2020 2020  xt.strip().     
-0002a9d0: 2020 2023 204f 626a 6563 7420 6f66 2074     # Object of t
-0002a9e0: 7970 6520 7878 7852 6573 706f 6e73 6520  ype xxxResponse 
-0002a9f0: 6973 206e 6f74 204a 534f 4e0a 2020 2020  is not JSON.    
-0002aa00: 2020 2020 2320 7365 7269 616c 697a 6162      # serializab
-0002aa10: 6c65 2c20 6865 6e63 6520 7765 2075 7365  le, hence we use
-0002aa20: 2074 6865 2064 6963 7469 6f6e 6172 792e   the dictionary.
-0002aa30: 0a20 2020 2020 2020 206a 736f 6e5f 6d61  .        json_ma
-0002aa40: 7820 3d20 7265 7370 2e5f 5f64 6963 745f  x = resp.__dict_
-0002aa50: 5f0a 2020 2020 2020 2020 2320 6a73 6f6e  _.        # json
-0002aa60: 5f6d 6178 2e75 7064 6174 6528 7b22 6b65  _max.update({"ke
-0002aa70: 7922 3a20 7661 6c75 657d 2920 2023 2061  y": value})  # a
-0002aa80: 6464 2064 6963 7420 6974 656d 730a 2020  dd dict items.  
-0002aa90: 2020 2020 2020 6a73 6f6e 5f20 3d20 6a73        json_ = js
-0002aaa0: 6f6e 5f6d 6178 2e63 6f70 7928 290a 2020  on_max.copy().  
-0002aab0: 2020 2020 2020 6a73 6f6e 5f2e 706f 7028        json_.pop(
-0002aac0: 2274 7261 6e73 706f 7274 5f72 6573 706f  "transport_respo
-0002aad0: 6e73 6522 290a 2020 2020 2020 2020 6a73  nse").        js
-0002aae0: 6f6e 5f73 7065 6320 3d20 4e6f 6e65 0a20  on_spec = None. 
-0002aaf0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
-0002ab00: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
-0002ab10: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
-0002ab20: 2020 2020 2020 2020 2020 2074 6578 743d             text=
-0002ab30: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
-0002ab40: 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20    json_=json_,. 
-0002ab50: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0002ab60: 6d61 783d 6a73 6f6e 5f6d 6178 2c0a 2020  max=json_max,.  
-0002ab70: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
-0002ab80: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
-0002ab90: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
-0002aba0: 2064 6566 2061 6374 696f 6e5f 636f 6e74   def action_cont
-0002abb0: 656e 745f 7265 706f 7369 746f 7279 5f63  ent_repository_c
-0002abc0: 6f6e 6669 6728 0a20 2020 2063 6c69 656e  onfig(.    clien
-0002abd0: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-0002abe0: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-0002abf0: 740a 2920 2d3e 204e 6f6e 653a 0a20 2020  t.) -> None:.   
-0002ac00: 2022 2222 4c69 7374 2063 6f6e 6669 6720   """List config 
-0002ac10: 6f66 2063 6f6e 7465 6e74 2072 6570 6f20  of content repo 
-0002ac20: 6f66 2068 6f6d 6520 7365 7276 6572 2077  of home server w
-0002ac30: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
-0002ac40: 6765 6420 696e 2e22 2222 0a20 2020 2072  ged in.""".    r
-0002ac50: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-0002ac60: 6e74 2e63 6f6e 7465 6e74 5f72 6570 6f73  nt.content_repos
-0002ac70: 6974 6f72 795f 636f 6e66 6967 2829 0a20  itory_config(). 
-0002ac80: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0002ac90: 2872 6573 702c 2043 6f6e 7465 6e74 5265  (resp, ContentRe
-0002aca0: 706f 7369 746f 7279 436f 6e66 6967 4572  positoryConfigEr
-0002acb0: 726f 7229 3a0a 2020 2020 2020 2020 6773  ror):.        gs
-0002acc0: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-0002acd0: 2020 2020 2020 2020 2245 3138 333a 2022          "E183: "
-0002ace0: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
-0002acf0: 6e74 656e 745f 7265 706f 7369 746f 7279  ntent_repository
-0002ad00: 5f63 6f6e 6669 6720 6661 696c 6564 2077  _config failed w
-0002ad10: 6974 6820 220a 2020 2020 2020 2020 2020  ith ".          
-0002ad20: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
-0002ad30: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-0002ad40: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0002ad50: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-0002ad60: 2b3d 2031 0a20 2020 2065 6c73 653a 0a20  += 1.    else:. 
-0002ad70: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0002ad80: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0002ad90: 2022 636f 6e74 656e 745f 7265 706f 7369   "content_reposi
-0002ada0: 746f 7279 5f63 6f6e 6669 6720 7375 6363  tory_config succ
-0002adb0: 6573 7366 756c 2077 6974 6820 220a 2020  essful with ".  
-0002adc0: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
-0002add0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-0002ade0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-0002adf0: 2029 0a20 2020 2020 2020 2023 206f 7574   ).        # out
-0002ae00: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-0002ae10: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-0002ae20: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-0002ae30: 7465 7874 203d 2072 6573 702e 7570 6c6f  text = resp.uplo
-0002ae40: 6164 5f73 697a 6520 2023 2072 6574 7572  ad_size  # retur
-0002ae50: 6e73 206f 6e6c 7920 3120 7661 6c75 650a  ns only 1 value.
-0002ae60: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
-0002ae70: 206f 6620 7479 7065 2078 7878 5265 7370   of type xxxResp
-0002ae80: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
-0002ae90: 0a20 2020 2020 2020 2023 2073 6572 6961  .        # seria
-0002aea0: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
-0002aeb0: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
-0002aec0: 6e61 7279 2e0a 2020 2020 2020 2020 6a73  nary..        js
-0002aed0: 6f6e 5f6d 6178 203d 2072 6573 702e 5f5f  on_max = resp.__
-0002aee0: 6469 6374 5f5f 0a20 2020 2020 2020 2023  dict__.        #
-0002aef0: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
-0002af00: 287b 226b 6579 223a 2076 616c 7565 7d29  ({"key": value})
-0002af10: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
-0002af20: 6d73 0a20 2020 2020 2020 206a 736f 6e5f  ms.        json_
-0002af30: 203d 206a 736f 6e5f 6d61 782e 636f 7079   = json_max.copy
-0002af40: 2829 0a20 2020 2020 2020 206a 736f 6e5f  ().        json_
-0002af50: 2e70 6f70 2822 7472 616e 7370 6f72 745f  .pop("transport_
-0002af60: 7265 7370 6f6e 7365 2229 0a20 2020 2020  response").     
-0002af70: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
-0002af80: 6f6e 650a 2020 2020 2020 2020 7072 696e  one.        prin
-0002af90: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-0002afa0: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
-0002afb0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-0002afc0: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
-0002afd0: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
-0002afe0: 6e5f 2c0a 2020 2020 2020 2020 2020 2020  n_,.            
-0002aff0: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-0002b000: 782c 0a20 2020 2020 2020 2020 2020 206a  x,.            j
-0002b010: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
-0002b020: 6563 2c0a 2020 2020 2020 2020 290a 0a0a  ec,.        )...
-0002b030: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
-0002b040: 5f72 6573 7428 636c 6965 6e74 3a20 4173  _rest(client: As
-0002b050: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
-0002b060: 6e74 6961 6c73 3a20 6469 6374 2920 2d3e  ntials: dict) ->
-0002b070: 204e 6f6e 653a 0a20 2020 2022 2222 496e   None:.    """In
-0002b080: 766f 6b65 2052 4553 5420 4150 4920 6f6e  voke REST API on
-0002b090: 204d 6174 7269 7820 7365 7276 6572 2e0a   Matrix server..
-0002b0a0: 2020 2020 4173 7375 6d65 7320 7468 6174      Assumes that
-0002b0b0: 2075 7365 7220 6973 2061 6c72 6561 6479   user is already
-0002b0c0: 206c 6f67 6765 6420 696e 2e0a 2020 2020   logged in..    
-0002b0d0: 2222 220a 2020 2020 2320 7365 653a 2068  """.    # see: h
-0002b0e0: 7474 7073 3a2f 2f64 6f63 732e 6169 6f68  ttps://docs.aioh
-0002b0f0: 7474 702e 6f72 672f 656e 2f73 7461 626c  ttp.org/en/stabl
-0002b100: 652f 636c 6965 6e74 5f71 7569 636b 7374  e/client_quickst
-0002b110: 6172 742e 6874 6d6c 0a20 2020 2023 2077  art.html.    # w
-0002b120: 6520 6d75 7374 2065 6d75 6c61 7465 2061  e must emulate a
-0002b130: 2063 7572 6c20 6c69 6b65 2074 6869 733a   curl like this:
-0002b140: 0a20 2020 2023 2063 7572 6c20 2d58 4445  .    # curl -XDE
-0002b150: 4c45 5445 2020 2268 7474 7073 3a2f 2f53  LETE  "https://S
-0002b160: 4552 5645 5248 4552 452f 5f73 796e 6170  ERVERHERE/_synap
-0002b170: 7365 2f61 646d 696e 2f76 312f 6d65 6469  se/admin/v1/medi
-0002b180: 612f 5345 5256 4552 4845 5245 2f0a 2020  a/SERVERHERE/.  
-0002b190: 2020 2320 2020 2020 204d 5843 4944 4845    #      MXCIDHE
-0002b1a0: 5245 3f61 6363 6573 735f 746f 6b65 6e3d  RE?access_token=
-0002b1b0: 4143 4345 5353 5f54 4f4b 454e 5f48 4552  ACCESS_TOKEN_HER
-0002b1c0: 4522 0a20 2020 2023 2063 7572 6c20 2d58  E".    # curl -X
-0002b1d0: 504f 5354 202d 6420 277b 226d 7367 7479  POST -d '{"msgty
-0002b1e0: 7065 223a 226d 2e74 6578 7422 2c20 2262  pe":"m.text", "b
-0002b1f0: 6f64 7922 3a22 6865 6c6c 6f22 7d27 205c  ody":"hello"}' \
-0002b200: 0a20 2020 2023 2020 2022 5f5f 686f 6d65  .    #   "__home
-0002b210: 7365 7276 6572 5f5f 2f5f 6d61 7472 6978  server__/_matrix
-0002b220: 2f63 6c69 656e 742f 7230 2f72 6f6f 6d73  /client/r0/rooms
-0002b230: 2f5f 5f65 6e63 6f64 6564 5f66 756c 6c5f  /__encoded_full_
-0002b240: 726f 6f6d 5f69 645f 5f2f 5c0a 2020 2020  room_id__/\.    
-0002b250: 2320 2020 7365 6e64 2f6d 2e72 6f6f 6d2e  #   send/m.room.
-0002b260: 6d65 7373 6167 653f 6163 6365 7373 5f74  message?access_t
-0002b270: 6f6b 656e 3d59 4f55 5254 4f4b 454e 4845  oken=YOURTOKENHE
-0002b280: 5245 220a 2020 2020 2320 6375 726c 202d  RE".    # curl -
-0002b290: 5847 4554 202d 6420 2222 2027 5f5f 686f  XGET -d "" '__ho
-0002b2a0: 6d65 7365 7276 6572 5f5f 2f5f 6d61 7472  meserver__/_matr
-0002b2b0: 6978 2f63 6c69 656e 742f 7665 7273 696f  ix/client/versio
-0002b2c0: 6e73 270a 2020 2020 6966 206e 6f74 206c  ns'.    if not l
-0002b2d0: 656e 2867 732e 7061 2e72 6573 7429 2025  en(gs.pa.rest) %
-0002b2e0: 2033 203d 3d20 303a 0a20 2020 2020 2020   3 == 0:.       
-0002b2f0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-0002b300: 2020 2020 2020 2020 2020 2022 4531 3834             "E184
-0002b310: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-0002b320: 2249 6e63 6f72 7265 6374 206e 756d 6265  "Incorrect numbe
-0002b330: 7220 6f66 2061 7267 756d 656e 7473 2066  r of arguments f
-0002b340: 6f72 202d 2d72 6573 742e 2041 7267 756d  or --rest. Argum
-0002b350: 656e 7473 206d 7573 7420 6265 2022 0a20  ents must be ". 
-0002b360: 2020 2020 2020 2020 2020 2066 2274 7269             f"tri
-0002b370: 706c 6573 2c20 692e 652e 206d 756c 7469  ples, i.e. multi
-0002b380: 706c 6573 206f 6620 332c 2062 7574 2066  ples of 3, but f
-0002b390: 6f75 6e64 207b 6c65 6e28 6773 2e70 612e  ound {len(gs.pa.
-0002b3a0: 7265 7374 297d 2022 0a20 2020 2020 2020  rest)} ".       
-0002b3b0: 2020 2020 2022 6172 6775 6d65 6e74 732e       "arguments.
-0002b3c0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0002b3d0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
-0002b3e0: 202b 3d20 310a 2020 2020 2020 2020 7265   += 1.        re
-0002b3f0: 7475 726e 0a20 2020 2066 6f72 2069 6920  turn.    for ii 
-0002b400: 696e 2072 616e 6765 286c 656e 2867 732e  in range(len(gs.
-0002b410: 7061 2e72 6573 7429 202f 2f20 3329 3a0a  pa.rest) // 3):.
-0002b420: 2020 2020 2020 2020 6d65 7468 6f64 203d          method =
-0002b430: 2067 732e 7061 2e72 6573 745b 6969 202a   gs.pa.rest[ii *
-0002b440: 2033 202b 2030 5d0a 2020 2020 2020 2020   3 + 0].        
-0002b450: 6461 7461 203d 2067 732e 7061 2e72 6573  data = gs.pa.res
-0002b460: 745b 6969 202a 2033 202b 2031 5d0a 2020  t[ii * 3 + 1].  
-0002b470: 2020 2020 2020 7572 6c20 3d20 6773 2e70        url = gs.p
-0002b480: 612e 7265 7374 5b69 6920 2a20 3320 2b20  a.rest[ii * 3 + 
-0002b490: 325d 0a20 2020 2020 2020 2069 6620 6e6f  2].        if no
-0002b4a0: 7420 6d65 7468 6f64 206f 7220 6d65 7468  t method or meth
-0002b4b0: 6f64 2e75 7070 6572 2829 2e73 7472 6970  od.upper().strip
-0002b4c0: 2829 206e 6f74 2069 6e20 5b0a 2020 2020  () not in [.    
-0002b4d0: 2020 2020 2020 2020 2247 4554 222c 0a20          "GET",. 
-0002b4e0: 2020 2020 2020 2020 2020 2022 504f 5354             "POST
-0002b4f0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0002b500: 5055 5422 2c0a 2020 2020 2020 2020 2020  PUT",.          
-0002b510: 2020 2244 454c 4554 4522 2c0a 2020 2020    "DELETE",.    
-0002b520: 2020 2020 2020 2020 224f 5054 494f 4e53          "OPTIONS
-0002b530: 222c 0a20 2020 2020 2020 205d 3a0a 2020  ",.        ]:.  
-0002b540: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0002b550: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-0002b560: 2020 2020 2020 2020 2245 3138 353a 2022          "E185: "
-0002b570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b580: 2066 2249 6e63 6f72 7265 6374 2052 4553   f"Incorrect RES
-0002b590: 5420 6d65 7468 6f64 207b 6d65 7468 6f64  T method {method
-0002b5a0: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
-0002b5b0: 2020 2020 2027 4d75 7374 2062 6520 6f6e       'Must be on
-0002b5c0: 6520 6f66 3a20 2247 4554 222c 2022 504f  e of: "GET", "PO
-0002b5d0: 5354 222c 2022 5055 5422 2c20 2244 454c  ST", "PUT", "DEL
-0002b5e0: 4554 4522 2c20 224f 5054 494f 4e53 222e  ETE", "OPTIONS".
-0002b5f0: 270a 2020 2020 2020 2020 2020 2020 290a  '.            ).
-0002b600: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-0002b610: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-0002b620: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0002b630: 7565 0a20 2020 2020 2020 206d 6574 686f  ue.        metho
-0002b640: 6420 3d20 6d65 7468 6f64 2e75 7070 6572  d = method.upper
-0002b650: 2829 2e73 7472 6970 2829 0a20 2020 2020  ().strip().     
-0002b660: 2020 2069 6620 6e6f 7420 6461 7461 3a0a     if not data:.
-0002b670: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0002b680: 203d 2022 220a 2020 2020 2020 2020 6966   = "".        if
-0002b690: 206e 6f74 2075 726c 206f 7220 7572 6c2e   not url or url.
-0002b6a0: 7374 7269 7028 2920 3d3d 2022 223a 0a20  strip() == "":. 
-0002b6b0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-0002b6c0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-0002b6d0: 2020 2020 2020 2020 2022 4531 3836 3a20           "E186: 
-0002b6e0: 2220 6622 496e 636f 7272 6563 7420 5245  " f"Incorrect RE
-0002b6f0: 5354 2055 524c 207b 7572 6c7d 2e20 4d75  ST URL {url}. Mu
-0002b700: 7374 206e 6f74 2062 6520 656d 7074 792e  st not be empty.
-0002b710: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0002b720: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-0002b730: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-0002b740: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0002b750: 7565 0a20 2020 2020 2020 2069 6620 6773  ue.        if gs
-0002b760: 2e70 612e 6163 6365 7373 5f74 6f6b 656e  .pa.access_token
-0002b770: 3a0a 2020 2020 2020 2020 2020 2020 6174  :.            at
-0002b780: 203d 2067 732e 7061 2e61 6363 6573 735f   = gs.pa.access_
-0002b790: 746f 6b65 6e0a 2020 2020 2020 2020 2020  token.          
-0002b7a0: 2020 6773 2e6c 6f67 2e64 6562 7567 2822    gs.log.debug("
-0002b7b0: 5573 696e 6720 6163 6365 7373 2074 6f6b  Using access tok
-0002b7c0: 656e 2066 726f 6d20 2d2d 6163 6365 7373  en from --access
-0002b7d0: 2d74 6f6b 656e 2061 7267 756d 656e 742e  -token argument.
-0002b7e0: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
-0002b7f0: 0a20 2020 2020 2020 2020 2020 2061 7420  .            at 
-0002b800: 3d20 6372 6564 656e 7469 616c 735b 2261  = credentials["a
-0002b810: 6363 6573 735f 746f 6b65 6e22 5d0a 2020  ccess_token"].  
-0002b820: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-0002b830: 2e64 6562 7567 2822 5573 696e 6720 6163  .debug("Using ac
-0002b840: 6365 7373 2074 6f6b 656e 2066 726f 6d20  cess token from 
-0002b850: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
-0002b860: 2e22 290a 2020 2020 2020 2020 666f 7220  .").        for 
-0002b870: 7068 2069 6e20 5b0a 2020 2020 2020 2020  ph in [.        
-0002b880: 2020 2020 484f 4d45 5345 5256 4552 5f50      HOMESERVER_P
-0002b890: 4c41 4345 484f 4c44 4552 2c0a 2020 2020  LACEHOLDER,.    
-0002b8a0: 2020 2020 2020 2020 484f 5354 4e41 4d45          HOSTNAME
-0002b8b0: 5f50 4c41 4345 484f 4c44 4552 2c0a 2020  _PLACEHOLDER,.  
-0002b8c0: 2020 2020 2020 2020 2020 4143 4345 5353            ACCESS
-0002b8d0: 5f54 4f4b 454e 5f50 4c41 4345 484f 4c44  _TOKEN_PLACEHOLD
-0002b8e0: 4552 2c0a 2020 2020 2020 2020 2020 2020  ER,.            
-0002b8f0: 5553 4552 5f49 445f 504c 4143 4548 4f4c  USER_ID_PLACEHOL
-0002b900: 4445 522c 0a20 2020 2020 2020 2020 2020  DER,.           
-0002b910: 2044 4556 4943 455f 4944 5f50 4c41 4345   DEVICE_ID_PLACE
-0002b920: 484f 4c44 4552 2c0a 2020 2020 2020 2020  HOLDER,.        
-0002b930: 2020 2020 524f 4f4d 5f49 445f 504c 4143      ROOM_ID_PLAC
-0002b940: 4548 4f4c 4445 522c 0a20 2020 2020 2020  EHOLDER,.       
-0002b950: 205d 3a0a 2020 2020 2020 2020 2020 2020   ]:.            
-0002b960: 6966 2070 6820 3d3d 2048 4f4d 4553 4552  if ph == HOMESER
-0002b970: 5645 525f 504c 4143 4548 4f4c 4445 523a  VER_PLACEHOLDER:
-0002b980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b990: 2064 6174 6120 3d20 6461 7461 2e72 6570   data = data.rep
-0002b9a0: 6c61 6365 2870 682c 2063 7265 6465 6e74  lace(ph, credent
-0002b9b0: 6961 6c73 5b22 686f 6d65 7365 7276 6572  ials["homeserver
-0002b9c0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-0002b9d0: 2020 2020 7572 6c20 3d20 7572 6c2e 7265      url = url.re
-0002b9e0: 706c 6163 6528 7068 2c20 6372 6564 656e  place(ph, creden
-0002b9f0: 7469 616c 735b 2268 6f6d 6573 6572 7665  tials["homeserve
-0002ba00: 7222 5d29 0a20 2020 2020 2020 2020 2020  r"]).           
-0002ba10: 2065 6c69 6620 7068 203d 3d20 484f 5354   elif ph == HOST
-0002ba20: 4e41 4d45 5f50 4c41 4345 484f 4c44 4552  NAME_PLACEHOLDER
-0002ba30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002ba40: 2020 686f 7374 6e61 6d65 203d 2075 726c    hostname = url
-0002ba50: 7061 7273 6528 6372 6564 656e 7469 616c  parse(credential
-0002ba60: 735b 2268 6f6d 6573 6572 7665 7222 5d29  s["homeserver"])
-0002ba70: 2e68 6f73 746e 616d 650a 2020 2020 2020  .hostname.      
-0002ba80: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-0002ba90: 2064 6174 612e 7265 706c 6163 6528 7068   data.replace(ph
-0002baa0: 2c20 686f 7374 6e61 6d65 290a 2020 2020  , hostname).    
-0002bab0: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
-0002bac0: 3d20 7572 6c2e 7265 706c 6163 6528 7068  = url.replace(ph
-0002bad0: 2c20 686f 7374 6e61 6d65 290a 2020 2020  , hostname).    
-0002bae0: 2020 2020 2020 2020 656c 6966 2070 6820          elif ph 
-0002baf0: 3d3d 2041 4343 4553 535f 544f 4b45 4e5f  == ACCESS_TOKEN_
-0002bb00: 504c 4143 4548 4f4c 4445 523a 0a20 2020  PLACEHOLDER:.   
-0002bb10: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-0002bb20: 6120 3d20 6461 7461 2e72 6570 6c61 6365  a = data.replace
-0002bb30: 2870 682c 2061 7429 0a20 2020 2020 2020  (ph, at).       
-0002bb40: 2020 2020 2020 2020 2075 726c 203d 2075           url = u
-0002bb50: 726c 2e72 6570 6c61 6365 2870 682c 2061  rl.replace(ph, a
-0002bb60: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
-0002bb70: 6c69 6620 7068 203d 3d20 5553 4552 5f49  lif ph == USER_I
-0002bb80: 445f 504c 4143 4548 4f4c 4445 523a 0a20  D_PLACEHOLDER:. 
-0002bb90: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002bba0: 6174 6120 3d20 6461 7461 2e72 6570 6c61  ata = data.repla
-0002bbb0: 6365 2870 682c 2063 7265 6465 6e74 6961  ce(ph, credentia
-0002bbc0: 6c73 5b22 7573 6572 5f69 6422 5d29 0a20  ls["user_id"]). 
-0002bbd0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0002bbe0: 726c 203d 2075 726c 2e72 6570 6c61 6365  rl = url.replace
-0002bbf0: 2870 682c 2063 7265 6465 6e74 6961 6c73  (ph, credentials
-0002bc00: 5b22 7573 6572 5f69 6422 5d29 0a20 2020  ["user_id"]).   
-0002bc10: 2020 2020 2020 2020 2065 6c69 6620 7068           elif ph
-0002bc20: 203d 3d20 4445 5649 4345 5f49 445f 504c   == DEVICE_ID_PL
-0002bc30: 4143 4548 4f4c 4445 523a 0a20 2020 2020  ACEHOLDER:.     
-0002bc40: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-0002bc50: 3d20 6461 7461 2e72 6570 6c61 6365 2870  = data.replace(p
-0002bc60: 682c 2063 7265 6465 6e74 6961 6c73 5b22  h, credentials["
-0002bc70: 6465 7669 6365 5f69 6422 5d29 0a20 2020  device_id"]).   
-0002bc80: 2020 2020 2020 2020 2020 2020 2075 726c               url
-0002bc90: 203d 2075 726c 2e72 6570 6c61 6365 2870   = url.replace(p
-0002bca0: 682c 2063 7265 6465 6e74 6961 6c73 5b22  h, credentials["
-0002bcb0: 6465 7669 6365 5f69 6422 5d29 0a20 2020  device_id"]).   
-0002bcc0: 2020 2020 2020 2020 2065 6c69 6620 7068           elif ph
-0002bcd0: 203d 3d20 524f 4f4d 5f49 445f 504c 4143   == ROOM_ID_PLAC
-0002bce0: 4548 4f4c 4445 523a 0a20 2020 2020 2020  EHOLDER:.       
-0002bcf0: 2020 2020 2020 2020 2072 6f6f 6d5f 6964           room_id
-0002bd00: 203d 2063 7265 6465 6e74 6961 6c73 5b22   = credentials["
-0002bd10: 726f 6f6d 5f69 6422 5d0a 2020 2020 2020  room_id"].      
-0002bd20: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
-0002bd30: 6420 3d20 6177 6169 7420 6d61 705f 726f  d = await map_ro
-0002bd40: 6f6d 696e 666f 5f74 6f5f 726f 6f6d 6964  ominfo_to_roomid
-0002bd50: 2863 6c69 656e 742c 2072 6f6f 6d5f 6964  (client, room_id
-0002bd60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002bd70: 2020 726f 6f6d 5f69 6420 3d20 7175 6f74    room_id = quot
-0002bd80: 6528 726f 6f6d 5f69 6429 0a20 2020 2020  e(room_id).     
-0002bd90: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-0002bda0: 3d20 6461 7461 2e72 6570 6c61 6365 2870  = data.replace(p
-0002bdb0: 682c 2072 6f6f 6d5f 6964 290a 2020 2020  h, room_id).    
-0002bdc0: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
-0002bdd0: 3d20 7572 6c2e 7265 706c 6163 6528 7068  = url.replace(ph
-0002bde0: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
-0002bdf0: 2020 2075 726c 203d 2075 726c 2e73 7472     url = url.str
-0002be00: 6970 2829 0a20 2020 2020 2020 2069 6620  ip().        if 
-0002be10: 6461 7461 2021 3d20 2222 2061 6e64 2028  data != "" and (
-0002be20: 6d65 7468 6f64 2069 6e20 2822 4745 5422  method in ("GET"
-0002be30: 2c20 2244 454c 4554 4522 2c20 224f 5054  , "DELETE", "OPT
-0002be40: 494f 4e53 2229 293a 0a20 2020 2020 2020  IONS")):.       
-0002be50: 2020 2020 2067 732e 6c6f 672e 7761 726e       gs.log.warn
-0002be60: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-0002be70: 2020 2020 2022 5731 3038 3a20 220a 2020       "W108: ".  
-0002be80: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0002be90: 466f 756e 6420 5245 5354 2064 6174 6120  Found REST data 
-0002bea0: 227b 6461 7461 7d22 2066 6f72 206d 6574  "{data}" for met
-0002beb0: 686f 6420 7b6d 6574 686f 647d 2e20 270a  hod {method}. '.
-0002bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bed0: 2754 6865 7265 2069 7320 7573 7561 6c6c  'There is usuall
-0002bee0: 7920 6e6f 2064 6174 6120 666f 723a 2022  y no data for: "
-0002bef0: 4745 5422 2c20 2244 454c 4554 4522 2c20  GET", "DELETE", 
-0002bf00: 224f 5054 494f 4e53 222e 2027 0a20 2020  "OPTIONS". '.   
-0002bf10: 2020 2020 2020 2020 2020 2020 2022 4d6f               "Mo
-0002bf20: 7374 206c 696b 656c 7920 7468 6973 2069  st likely this i
-0002bf30: 7320 6e6f 7420 7768 6174 2079 6f75 2077  s not what you w
-0002bf40: 616e 742e 2022 0a20 2020 2020 2020 2020  ant. ".         
-0002bf50: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002bf60: 2067 732e 7761 726e 5f63 6f75 6e74 202b   gs.warn_count +
-0002bf70: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-0002bf80: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-0002bf90: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-0002bfa0: 2020 2020 2020 2020 2020 2066 2250 7265             f"Pre
-0002bfb0: 7061 7269 6e67 2074 6f20 696e 766f 6b65  paring to invoke
-0002bfc0: 2052 4553 5420 4150 4920 6361 6c6c 3a20   REST API call: 
-0002bfd0: 6d65 7468 6f64 3d7b 6d65 7468 6f64 7d20  method={method} 
-0002bfe0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-0002bff0: 6461 7461 3d7b 6461 7461 7d2c 2075 726c  data={data}, url
-0002c000: 3d7b 7072 6976 6163 795f 6669 6c74 6572  ={privacy_filter
-0002c010: 2873 7472 2875 726c 2929 7d2e 220a 2020  (str(url))}.".  
-0002c020: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002c030: 636f 6e6e 6563 746f 7220 3d20 5443 5043  connector = TCPC
-0002c040: 6f6e 6e65 6374 6f72 2873 736c 3d67 732e  onnector(ssl=gs.
-0002c050: 7373 6c29 2020 2320 7365 7474 696e 6720  ssl)  # setting 
-0002c060: 7373 6c63 6f6e 7465 7874 0a20 2020 2020  sslcontext.     
-0002c070: 2020 2061 7379 6e63 2077 6974 6820 436c     async with Cl
-0002c080: 6965 6e74 5365 7373 696f 6e28 636f 6e6e  ientSession(conn
-0002c090: 6563 746f 723d 636f 6e6e 6563 746f 7229  ector=connector)
-0002c0a0: 2061 7320 7365 7373 696f 6e3a 2020 2320   as session:  # 
-0002c0b0: 6169 6f68 7474 700a 2020 2020 2020 2020  aiohttp.        
-0002c0c0: 2020 2020 6966 206d 6574 686f 6420 3d3d      if method ==
-0002c0d0: 2022 4745 5422 3a0a 2020 2020 2020 2020   "GET":.        
-0002c0e0: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
-0002c0f0: 7468 2073 6573 7369 6f6e 2e67 6574 2875  th session.get(u
-0002c100: 726c 2c20 6461 7461 3d64 6174 6129 2061  rl, data=data) a
-0002c110: 7320 7265 7370 3a0a 2020 2020 2020 2020  s resp:.        
-0002c120: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-0002c130: 7573 203d 2072 6573 702e 7374 6174 7573  us = resp.status
-0002c140: 2020 2320 696e 742c 2032 3030 2073 7563    # int, 200 suc
-0002c150: 6365 7373 0a20 2020 2020 2020 2020 2020  cess.           
-0002c160: 2020 2020 2020 2020 2074 7874 203d 2061           txt = a
-0002c170: 7761 6974 2072 6573 702e 7465 7874 2829  wait resp.text()
-0002c180: 2020 2320 7374 7220 696e 2064 6963 7420    # str in dict 
-0002c190: 666f 726d 6174 0a20 2020 2020 2020 2020  format.         
-0002c1a0: 2020 2065 6c69 6620 6d65 7468 6f64 203d     elif method =
-0002c1b0: 3d20 2250 4f53 5422 3a0a 2020 2020 2020  = "POST":.      
-0002c1c0: 2020 2020 2020 2020 2020 6173 796e 6320            async 
-0002c1d0: 7769 7468 2073 6573 7369 6f6e 2e70 6f73  with session.pos
-0002c1e0: 7428 7572 6c2c 2064 6174 613d 6461 7461  t(url, data=data
-0002c1f0: 2920 6173 2072 6573 703a 0a20 2020 2020  ) as resp:.     
-0002c200: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002c210: 7461 7475 7320 3d20 7265 7370 2e73 7461  tatus = resp.sta
-0002c220: 7475 7320 2023 2069 6e74 2c20 3230 3020  tus  # int, 200 
-0002c230: 7375 6363 6573 730a 2020 2020 2020 2020  success.        
-0002c240: 2020 2020 2020 2020 2020 2020 7478 7420              txt 
-0002c250: 3d20 6177 6169 7420 7265 7370 2e74 6578  = await resp.tex
-0002c260: 7428 2920 2023 2073 7472 2069 6e20 6469  t()  # str in di
-0002c270: 6374 2066 6f72 6d61 740a 2020 2020 2020  ct format.      
-0002c280: 2020 2020 2020 656c 6966 206d 6574 686f        elif metho
-0002c290: 6420 3d3d 2022 5055 5422 3a0a 2020 2020  d == "PUT":.    
-0002c2a0: 2020 2020 2020 2020 2020 2020 6173 796e              asyn
-0002c2b0: 6320 7769 7468 2073 6573 7369 6f6e 2e70  c with session.p
-0002c2c0: 7574 2875 726c 2c20 6461 7461 3d64 6174  ut(url, data=dat
-0002c2d0: 6129 2061 7320 7265 7370 3a0a 2020 2020  a) as resp:.    
-0002c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2f0: 7374 6174 7573 203d 2072 6573 702e 7374  status = resp.st
-0002c300: 6174 7573 2020 2320 696e 742c 2032 3030  atus  # int, 200
-0002c310: 2073 7563 6365 7373 0a20 2020 2020 2020   success.       
-0002c320: 2020 2020 2020 2020 2020 2020 2074 7874               txt
-0002c330: 203d 2061 7761 6974 2072 6573 702e 7465   = await resp.te
-0002c340: 7874 2829 2020 2320 7374 7220 696e 2064  xt()  # str in d
-0002c350: 6963 7420 666f 726d 6174 0a20 2020 2020  ict format.     
-0002c360: 2020 2020 2020 2065 6c69 6620 6d65 7468         elif meth
-0002c370: 6f64 203d 3d20 2244 454c 4554 4522 3a0a  od == "DELETE":.
-0002c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c390: 6173 796e 6320 7769 7468 2073 6573 7369  async with sessi
-0002c3a0: 6f6e 2e64 656c 6574 6528 7572 6c2c 2064  on.delete(url, d
-0002c3b0: 6174 613d 6461 7461 2920 6173 2072 6573  ata=data) as res
-0002c3c0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-0002c3d0: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-0002c3e0: 7265 7370 2e73 7461 7475 7320 2023 2069  resp.status  # i
-0002c3f0: 6e74 2c20 3230 3020 7375 6363 6573 730a  nt, 200 success.
-0002c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c410: 2020 2020 7478 7420 3d20 6177 6169 7420      txt = await 
-0002c420: 7265 7370 2e74 6578 7428 2920 2023 2073  resp.text()  # s
-0002c430: 7472 2069 6e20 6469 6374 2066 6f72 6d61  tr in dict forma
-0002c440: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
-0002c450: 6966 206d 6574 686f 6420 3d3d 2022 4f50  if method == "OP
-0002c460: 5449 4f4e 5322 3a0a 2020 2020 2020 2020  TIONS":.        
-0002c470: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
-0002c480: 7468 2073 6573 7369 6f6e 2e6f 7074 696f  th session.optio
-0002c490: 6e73 2875 726c 2c20 6461 7461 3d64 6174  ns(url, data=dat
-0002c4a0: 6129 2061 7320 7265 7370 3a0a 2020 2020  a) as resp:.    
-0002c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c4c0: 7374 6174 7573 203d 2072 6573 702e 7374  status = resp.st
-0002c4d0: 6174 7573 2020 2320 696e 742c 2032 3030  atus  # int, 200
-0002c4e0: 2073 7563 6365 7373 0a20 2020 2020 2020   success.       
-0002c4f0: 2020 2020 2020 2020 2020 2020 2074 7874               txt
-0002c500: 203d 2061 7761 6974 2072 6573 702e 7465   = await resp.te
-0002c510: 7874 2829 2020 2320 7374 7220 696e 2064  xt()  # str in d
-0002c520: 6963 7420 666f 726d 6174 0a20 2020 2020  ict format.     
-0002c530: 2020 2069 6620 7374 6174 7573 2021 3d20     if status != 
-0002c540: 3230 303a 0a20 2020 2020 2020 2020 2020  200:.           
-0002c550: 2023 2074 7874 2069 7320 7374 7220 6c69   # txt is str li
-0002c560: 6b65 2074 6869 733a 0a20 2020 2020 2020  ke this:.       
-0002c570: 2020 2020 2023 207b 2265 7272 636f 6465       # {"errcode
-0002c580: 223a 224d 5f46 4f52 4249 4444 454e 222c  ":"M_FORBIDDEN",
-0002c590: 2265 7272 6f72 223a 2259 6f75 2061 7265  "error":"You are
-0002c5a0: 206e 6f74 2061 2073 6572 7665 7220 6164   not a server ad
-0002c5b0: 6d69 6e22 7d0a 2020 2020 2020 2020 2020  min"}.          
-0002c5c0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-0002c5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c5e0: 2245 3138 373a 2022 0a20 2020 2020 2020  "E187: ".       
-0002c5f0: 2020 2020 2020 2020 2066 2252 4553 5420           f"REST 
-0002c600: 4150 4920 6361 6c6c 2066 6169 6c65 642e  API call failed.
-0002c610: 2046 6169 6c65 6420 7769 7468 2065 7272   Failed with err
-0002c620: 6f72 2063 6f64 6520 7b73 7461 7475 737d  or code {status}
-0002c630: 2061 6e64 2022 0a20 2020 2020 2020 2020   and ".         
-0002c640: 2020 2020 2020 2066 2265 7272 6f72 2074         f"error t
-0002c650: 6578 7420 7b74 7874 7d2e 2049 6e70 7574  ext {txt}. Input
-0002c660: 2077 6173 3a20 6d65 7468 6f64 3d7b 6d65   was: method={me
-0002c670: 7468 6f64 7d20 220a 2020 2020 2020 2020  thod} ".        
-0002c680: 2020 2020 2020 2020 6622 6461 7461 3d7b          f"data={
-0002c690: 6461 7461 7d2c 2075 726c 3d7b 7072 6976  data}, url={priv
-0002c6a0: 6163 795f 6669 6c74 6572 2873 7472 2875  acy_filter(str(u
-0002c6b0: 726c 2929 7d2e 220a 2020 2020 2020 2020  rl))}.".        
-0002c6c0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0002c6d0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-0002c6e0: 3d20 310a 2020 2020 2020 2020 656c 7365  = 1.        else
-0002c6f0: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-0002c700: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0002c710: 2020 2020 2020 2020 2020 2020 6622 5245              f"RE
-0002c720: 5354 2041 5049 2063 616c 6c20 7761 7320  ST API call was 
-0002c730: 7375 6363 6573 7366 756c 2e20 220a 2020  successful. ".  
-0002c740: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002c750: 5265 7370 6f6e 7365 2069 733a 207b 7478  Response is: {tx
-0002c760: 747d 2e20 496e 7075 7420 7761 733a 206d  t}. Input was: m
-0002c770: 6574 686f 643d 7b6d 6574 686f 647d 2022  ethod={method} "
-0002c780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c790: 2066 2264 6174 613d 7b64 6174 617d 2c20   f"data={data}, 
-0002c7a0: 7572 6c3d 7b70 7269 7661 6379 5f66 696c  url={privacy_fil
-0002c7b0: 7465 7228 7374 7228 7572 6c29 297d 2e22  ter(str(url))}."
-0002c7c0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002c7d0: 2020 2020 2020 2020 2020 2023 206f 7574             # out
-0002c7e0: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
-0002c7f0: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
-0002c800: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
-0002c810: 2020 2020 7465 7874 203d 2066 227b 7478      text = f"{tx
-0002c820: 747d 2220 2023 2072 6574 7572 6e73 206f  t}"  # returns o
-0002c830: 6e6c 7920 3120 7661 6c75 650a 2020 2020  nly 1 value.    
-0002c840: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-0002c850: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
-0002c860: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-0002c870: 6e5f 6d61 782e 7570 6461 7465 287b 2272  n_max.update({"r
-0002c880: 6573 706f 6e73 6522 3a20 7478 747d 2920  esponse": txt}) 
-0002c890: 2023 2061 6464 2064 6963 7420 6974 656d   # add dict item
-0002c8a0: 730a 2020 2020 2020 2020 2020 2020 6a73  s.            js
-0002c8b0: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
-0002c8c0: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-0002c8d0: 2020 2320 6a73 6f6e 5f2e 706f 7028 226b    # json_.pop("k
-0002c8e0: 6579 2229 0a20 2020 2020 2020 2020 2020  ey").           
-0002c8f0: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
-0002c900: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
-0002c910: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
-0002c920: 2020 2020 2020 2020 2020 2020 6773 2e70              gs.p
-0002c930: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
-0002c940: 2020 2020 2020 2020 2020 7465 7874 3d74            text=t
-0002c950: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
-0002c960: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
-0002c970: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002c980: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
-0002c990: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
-0002c9a0: 2020 2020 206a 736f 6e5f 7370 6563 3d6a       json_spec=j
-0002c9b0: 736f 6e5f 7370 6563 2c0a 2020 2020 2020  son_spec,.      
-0002c9c0: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
-0002c9d0: 6465 6620 6163 7469 6f6e 5f67 6574 5f61  def action_get_a
-0002c9e0: 7661 7461 7228 636c 6965 6e74 3a20 4173  vatar(client: As
-0002c9f0: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
-0002ca00: 6e74 6961 6c73 3a20 6469 6374 2920 2d3e  ntials: dict) ->
-0002ca10: 204e 6f6e 653a 0a20 2020 2022 2222 4765   None:.    """Ge
-0002ca20: 7420 6176 6174 6172 2873 2920 6f66 2069  t avatar(s) of i
-0002ca30: 7473 656c 6620 6f72 2075 7365 7273 2077  tself or users w
-0002ca40: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
-0002ca50: 6765 6420 696e 2e22 2222 0a20 2020 2069  ged in.""".    i
-0002ca60: 6620 6773 2e70 612e 6765 745f 6176 6174  f gs.pa.get_avat
-0002ca70: 6172 203d 3d20 5b5d 3a0a 2020 2020 2020  ar == []:.      
-0002ca80: 2020 6773 2e70 612e 6765 745f 6176 6174    gs.pa.get_avat
-0002ca90: 6172 2e61 7070 656e 6428 6372 6564 656e  ar.append(creden
-0002caa0: 7469 616c 735b 2275 7365 725f 6964 225d  tials["user_id"]
-0002cab0: 2920 2023 2077 686f 616d 690a 2020 2020  )  # whoami.    
-0002cac0: 6773 2e6c 6f67 2e64 6562 7567 2866 2247  gs.log.debug(f"G
-0002cad0: 6574 7469 6e67 2061 7661 7461 7273 2066  etting avatars f
-0002cae0: 6f72 2074 6865 7365 2075 7365 7273 3a20  or these users: 
-0002caf0: 7b67 732e 7061 2e67 6574 5f61 7661 7461  {gs.pa.get_avata
-0002cb00: 727d 2229 0a20 2020 2066 6f72 2075 7365  r}").    for use
-0002cb10: 725f 6964 2069 6e20 6773 2e70 612e 6765  r_id in gs.pa.ge
-0002cb20: 745f 6176 6174 6172 3a0a 2020 2020 2020  t_avatar:.      
-0002cb30: 2020 7573 6572 5f69 6420 3d20 7573 6572    user_id = user
-0002cb40: 5f69 642e 7374 7269 7028 290a 2020 2020  _id.strip().    
-0002cb50: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
-0002cb60: 2063 6c69 656e 742e 6765 745f 6176 6174   client.get_avat
-0002cb70: 6172 2875 7365 725f 6964 290a 2020 2020  ar(user_id).    
-0002cb80: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0002cb90: 6528 7265 7370 2c20 5072 6f66 696c 6547  e(resp, ProfileG
-0002cba0: 6574 4176 6174 6172 5265 7370 6f6e 7365  etAvatarResponse
-0002cbb0: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
-0002cbc0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
-0002cbd0: 2020 2020 2020 2020 2020 2020 2022 5072               "Pr
-0002cbe0: 6f66 696c 6547 6574 4176 6174 6172 5265  ofileGetAvatarRe
-0002cbf0: 7370 6f6e 7365 2e20 5265 7370 6f6e 7365  sponse. Response
-0002cc00: 2069 733a 2022 0a20 2020 2020 2020 2020   is: ".         
-0002cc10: 2020 2020 2020 2066 227b 7072 6976 6163         f"{privac
-0002cc20: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
-0002cc30: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
-0002cc40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0002cc50: 6176 6174 6172 5f6d 7863 203d 2072 6573  avatar_mxc = res
-0002cc60: 702e 6176 6174 6172 5f75 726c 0a20 2020  p.avatar_url.   
-0002cc70: 2020 2020 2020 2020 2061 7661 7461 725f           avatar_
-0002cc80: 7572 6c20 3d20 4e6f 6e65 0a20 2020 2020  url = None.     
-0002cc90: 2020 2020 2020 2069 6620 6176 6174 6172         if avatar
-0002cca0: 5f6d 7863 3a20 2023 2063 6f75 6c64 2062  _mxc:  # could b
-0002ccb0: 6520 4e6f 6e65 2069 6620 6e6f 2061 7661  e None if no ava
-0002ccc0: 7461 720a 2020 2020 2020 2020 2020 2020  tar.            
-0002ccd0: 2020 2020 6176 6174 6172 5f75 726c 203d      avatar_url =
-0002cce0: 2061 7761 6974 2063 6c69 656e 742e 6d78   await client.mx
-0002ccf0: 635f 746f 5f68 7474 7028 6176 6174 6172  c_to_http(avatar
-0002cd00: 5f6d 7863 290a 2020 2020 2020 2020 2020  _mxc).          
-0002cd10: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-0002cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cd30: 6622 6176 6174 6172 5f6d 7863 2069 7320  f"avatar_mxc is 
-0002cd40: 7b61 7661 7461 725f 6d78 637d 2e20 6176  {avatar_mxc}. av
-0002cd50: 6174 6172 5f75 726c 2069 7320 7b61 7661  atar_url is {ava
-0002cd60: 7461 725f 7572 6c7d 220a 2020 2020 2020  tar_url}".      
-0002cd70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002cd80: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
-0002cd90: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
-0002cda0: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
-0002cdb0: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
-0002cdc0: 7420 3d20 6622 7b61 7661 7461 725f 6d78  t = f"{avatar_mx
-0002cdd0: 637d 7b53 4550 7d7b 6176 6174 6172 5f75  c}{SEP}{avatar_u
-0002cde0: 726c 7d22 0a20 2020 2020 2020 2020 2020  rl}".           
-0002cdf0: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
-0002ce00: 6520 7878 7852 6573 706f 6e73 6520 6973  e xxxResponse is
-0002ce10: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
-0002ce20: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
-0002ce30: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
-0002ce40: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
-0002ce50: 792e 0a20 2020 2020 2020 2020 2020 206a  y..            j
-0002ce60: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
-0002ce70: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
-0002ce80: 2020 2020 6a73 6f6e 5f6d 6178 2e75 7064      json_max.upd
-0002ce90: 6174 6528 7b22 6176 6174 6172 5f68 7474  ate({"avatar_htt
-0002cea0: 7022 3a20 6176 6174 6172 5f75 726c 7d29  p": avatar_url})
-0002ceb0: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
-0002cec0: 6d73 0a20 2020 2020 2020 2020 2020 206a  ms.            j
-0002ced0: 736f 6e5f 203d 206a 736f 6e5f 6d61 782e  son_ = json_max.
-0002cee0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-0002cef0: 2020 206a 736f 6e5f 2e70 6f70 2822 7472     json_.pop("tr
-0002cf00: 616e 7370 6f72 745f 7265 7370 6f6e 7365  ansport_response
-0002cf10: 2229 0a20 2020 2020 2020 2020 2020 206a  ").            j
-0002cf20: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-0002cf30: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0002cf40: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-0002cf50: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
-0002cf60: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-0002cf70: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
-0002cf80: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0002cf90: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-0002cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cfb0: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-0002cfc0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0002cfd0: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-0002cfe0: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
-0002cff0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-0002d000: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002d010: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-0002d020: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-0002d030: 3138 383a 2022 0a20 2020 2020 2020 2020  188: ".         
-0002d040: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-0002d050: 6765 7474 696e 6720 6176 6174 6172 2066  getting avatar f
-0002d060: 6f72 2075 7365 7220 7b75 7365 725f 6964  or user {user_id
-0002d070: 7d20 220a 2020 2020 2020 2020 2020 2020  } ".            
-0002d080: 2020 2020 6622 6672 6f6d 2073 6572 7665      f"from serve
-0002d090: 722e 207b 7072 6976 6163 795f 6669 6c74  r. {privacy_filt
-0002d0a0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-0002d0b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002d0c0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
-0002d0d0: 5f63 6f75 6e74 202b 3d20 310a 0a0a 6173  _count += 1...as
-0002d0e0: 796e 6320 6465 6620 6163 7469 6f6e 5f67  ync def action_g
-0002d0f0: 6574 5f70 726f 6669 6c65 2863 6c69 656e  et_profile(clien
-0002d100: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
-0002d110: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
-0002d120: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-0002d130: 2222 2247 6574 2075 7365 7220 7072 6f66  """Get user prof
-0002d140: 696c 6528 7329 206f 6620 6974 7365 6c66  ile(s) of itself
-0002d150: 206f 7220 7573 6572 7320 7768 696c 6520   or users while 
-0002d160: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
-0002d170: 6e2e 2222 220a 2020 2020 6966 2067 732e  n.""".    if gs.
-0002d180: 7061 2e67 6574 5f70 726f 6669 6c65 203d  pa.get_profile =
-0002d190: 3d20 5b5d 3a0a 2020 2020 2020 2020 6773  = []:.        gs
-0002d1a0: 2e70 612e 6765 745f 7072 6f66 696c 652e  .pa.get_profile.
-0002d1b0: 6170 7065 6e64 2863 7265 6465 6e74 6961  append(credentia
-0002d1c0: 6c73 5b22 7573 6572 5f69 6422 5d29 2020  ls["user_id"])  
-0002d1d0: 2320 7768 6f61 6d69 0a20 2020 2067 732e  # whoami.    gs.
-0002d1e0: 6c6f 672e 6465 6275 6728 6622 4765 7474  log.debug(f"Gett
-0002d1f0: 696e 6720 7573 6572 2070 726f 6669 6c65  ing user profile
-0002d200: 7320 666f 7220 7468 6573 6520 7573 6572  s for these user
-0002d210: 733a 207b 6773 2e70 612e 6765 745f 7072  s: {gs.pa.get_pr
-0002d220: 6f66 696c 657d 2229 0a20 2020 2066 6f72  ofile}").    for
-0002d230: 2075 7365 725f 6964 2069 6e20 6773 2e70   user_id in gs.p
-0002d240: 612e 6765 745f 7072 6f66 696c 653a 0a20  a.get_profile:. 
-0002d250: 2020 2020 2020 2075 7365 725f 6964 203d         user_id =
-0002d260: 2075 7365 725f 6964 2e73 7472 6970 2829   user_id.strip()
-0002d270: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
-0002d280: 6177 6169 7420 636c 6965 6e74 2e67 6574  await client.get
-0002d290: 5f70 726f 6669 6c65 2875 7365 725f 6964  _profile(user_id
-0002d2a0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
-0002d2b0: 6e73 7461 6e63 6528 7265 7370 2c20 5072  nstance(resp, Pr
-0002d2c0: 6f66 696c 6547 6574 4572 726f 7229 3a0a  ofileGetError):.
-0002d2d0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-0002d2e0: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-0002d2f0: 2020 2020 2020 2020 2020 2245 3138 393a            "E189:
-0002d300: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002d310: 2020 2066 2246 6169 6c65 6420 6765 7474     f"Failed gett
-0002d320: 696e 6720 7072 6f66 696c 6520 666f 7220  ing profile for 
-0002d330: 7573 6572 207b 7573 6572 5f69 647d 2022  user {user_id} "
-0002d340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d350: 2066 2266 726f 6d20 7365 7276 6572 2e20   f"from server. 
-0002d360: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0002d370: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-0002d380: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002d390: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-0002d3a0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-0002d3b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002d3c0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0002d3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d3e0: 2066 2250 726f 6669 6c65 4765 7452 6573   f"ProfileGetRes
-0002d3f0: 706f 6e73 652e 2052 6573 706f 6e73 6520  ponse. Response 
-0002d400: 6973 3a20 7b70 7269 7661 6379 5f66 696c  is: {privacy_fil
-0002d410: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-0002d420: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002d430: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-0002d440: 6179 6e61 6d65 203d 2072 6573 702e 6469  ayname = resp.di
-0002d450: 7370 6c61 796e 616d 650a 2020 2020 2020  splayname.      
-0002d460: 2020 2020 2020 6176 6174 6172 5f6d 7863        avatar_mxc
-0002d470: 203d 2072 6573 702e 6176 6174 6172 5f75   = resp.avatar_u
-0002d480: 726c 0a20 2020 2020 2020 2020 2020 2061  rl.            a
-0002d490: 7661 7461 725f 7572 6c20 3d20 4e6f 6e65  vatar_url = None
-0002d4a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002d4b0: 6176 6174 6172 5f6d 7863 3a20 2023 2063  avatar_mxc:  # c
-0002d4c0: 6f75 6c64 2062 6520 4e6f 6e65 2069 6620  ould be None if 
-0002d4d0: 6e6f 2061 7661 7461 720a 2020 2020 2020  no avatar.      
-0002d4e0: 2020 2020 2020 2020 2020 6176 6174 6172            avatar
-0002d4f0: 5f75 726c 203d 2061 7761 6974 2063 6c69  _url = await cli
-0002d500: 656e 742e 6d78 635f 746f 5f68 7474 7028  ent.mxc_to_http(
-0002d510: 6176 6174 6172 5f6d 7863 290a 2020 2020  avatar_mxc).    
-0002d520: 2020 2020 2020 2020 6f74 6865 725f 696e          other_in
-0002d530: 666f 203d 2072 6573 702e 6f74 6865 725f  fo = resp.other_
-0002d540: 696e 666f 0a20 2020 2020 2020 2020 2020  info.           
-0002d550: 2069 6620 6e6f 7420 6f74 6865 725f 696e   if not other_in
-0002d560: 666f 3a20 2023 2065 6d70 7479 2064 6963  fo:  # empty dic
-0002d570: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0002d580: 2020 6f74 6865 725f 696e 666f 203d 2022    other_info = "
-0002d590: 220a 2020 2020 2020 2020 2020 2020 6773  ".            gs
-0002d5a0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0002d5b0: 2020 2020 2020 2020 2020 2020 6622 6469              f"di
-0002d5c0: 7370 6c61 796e 616d 6520 6973 207b 6469  splayname is {di
-0002d5d0: 7370 6c61 796e 616d 657d 2e20 6176 6174  splayname}. avat
-0002d5e0: 6172 5f6d 7863 2069 7320 7b61 7661 7461  ar_mxc is {avata
-0002d5f0: 725f 6d78 637d 2e20 220a 2020 2020 2020  r_mxc}. ".      
-0002d600: 2020 2020 2020 2020 2020 6622 6176 6174            f"avat
-0002d610: 6172 5f75 726c 2069 7320 7b61 7661 7461  ar_url is {avata
-0002d620: 725f 7572 6c7d 2e20 6f74 6865 725f 696e  r_url}. other_in
-0002d630: 666f 2069 7320 7b72 6573 702e 6f74 6865  fo is {resp.othe
-0002d640: 725f 696e 666f 7d2e 220a 2020 2020 2020  r_info}.".      
-0002d650: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002d660: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
-0002d670: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
-0002d680: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
-0002d690: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
-0002d6a0: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
-0002d6b0: 2020 2020 2020 6622 7b64 6973 706c 6179        f"{display
-0002d6c0: 6e61 6d65 7d7b 5345 507d 7b61 7661 7461  name}{SEP}{avata
-0002d6d0: 725f 6d78 637d 7b53 4550 7d7b 6176 6174  r_mxc}{SEP}{avat
-0002d6e0: 6172 5f75 726c 7d22 0a20 2020 2020 2020  ar_url}".       
-0002d6f0: 2020 2020 2020 2020 2066 227b 5345 507d           f"{SEP}
-0002d700: 7b6f 7468 6572 5f69 6e66 6f7d 220a 2020  {other_info}".  
-0002d710: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002d720: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
-0002d730: 206f 6620 7479 7065 2078 7878 5265 7370   of type xxxResp
-0002d740: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
-0002d750: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-0002d760: 6572 6961 6c69 7a61 626c 652c 2068 656e  erializable, hen
-0002d770: 6365 2077 6520 7573 6520 7468 6520 6469  ce we use the di
-0002d780: 6374 696f 6e61 7279 2e0a 2020 2020 2020  ctionary..      
-0002d790: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
-0002d7a0: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
-0002d7b0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0002d7c0: 6d61 782e 7570 6461 7465 287b 2261 7661  max.update({"ava
-0002d7d0: 7461 725f 6874 7470 223a 2061 7661 7461  tar_http": avata
-0002d7e0: 725f 7572 6c7d 2920 2023 2061 6464 2064  r_url})  # add d
-0002d7f0: 6963 7420 6974 656d 730a 2020 2020 2020  ict items.      
-0002d800: 2020 2020 2020 6a73 6f6e 5f20 3d20 6a73        json_ = js
-0002d810: 6f6e 5f6d 6178 2e63 6f70 7928 290a 2020  on_max.copy().  
-0002d820: 2020 2020 2020 2020 2020 6a73 6f6e 5f2e            json_.
-0002d830: 706f 7028 2274 7261 6e73 706f 7274 5f72  pop("transport_r
-0002d840: 6573 706f 6e73 6522 290a 2020 2020 2020  esponse").      
-0002d850: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
-0002d860: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-0002d870: 2020 2070 7269 6e74 5f6f 7574 7075 7428     print_output(
-0002d880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d890: 2067 732e 7061 2e6f 7574 7075 742c 0a20   gs.pa.output,. 
-0002d8a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002d8b0: 6578 743d 7465 7874 2c0a 2020 2020 2020  ext=text,.      
-0002d8c0: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
-0002d8d0: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
-0002d8e0: 2020 2020 2020 206a 736f 6e5f 6d61 783d         json_max=
-0002d8f0: 6a73 6f6e 5f6d 6178 2c0a 2020 2020 2020  json_max,.      
-0002d900: 2020 2020 2020 2020 2020 6a73 6f6e 5f73            json_s
-0002d910: 7065 633d 6a73 6f6e 5f73 7065 632c 0a20  pec=json_spec,. 
-0002d920: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
-0002d930: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
-0002d940: 6765 745f 636c 6965 6e74 5f69 6e66 6f28  get_client_info(
-0002d950: 0a20 2020 2063 6c69 656e 743a 2041 7379  .    client: Asy
-0002d960: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
-0002d970: 7469 616c 733a 2064 6963 740a 2920 2d3e  tials: dict.) ->
-0002d980: 204e 6f6e 653a 0a20 2020 2022 2222 4765   None:.    """Ge
-0002d990: 7420 636c 6965 6e74 2069 6e66 6f20 7768  t client info wh
-0002d9a0: 696c 6520 616c 7265 6164 7920 6c6f 6767  ile already logg
-0002d9b0: 6564 2069 6e2e 2222 220a 2020 2020 6773  ed in.""".    gs
-0002d9c0: 2e6c 6f67 2e64 6562 7567 2822 4765 7474  .log.debug("Gett
-0002d9d0: 696e 6720 636c 6965 6e74 2069 6e66 6f2e  ing client info.
-0002d9e0: 2229 0a20 2020 2061 7761 6974 2073 796e  ").    await syn
-0002d9f0: 6368 726f 6e69 7a65 2863 6c69 656e 7429  chronize(client)
-0002da00: 2020 2320 7379 6e63 2829 2074 6f20 6765    # sync() to ge
-0002da10: 7420 726f 6f6d 730a 2020 2020 7072 696e  t rooms.    prin
-0002da20: 7428 6a73 6f6e 2e64 756d 7073 2863 6c69  t(json.dumps(cli
-0002da30: 656e 742e 5f5f 6469 6374 5f5f 2c20 6465  ent.__dict__, de
-0002da40: 6661 756c 743d 6f62 6a5f 746f 5f64 6963  fault=obj_to_dic
-0002da50: 7429 290a 0a0a 6173 796e 6320 6465 6620  t))...async def 
-0002da60: 6163 7469 6f6e 5f67 6574 5f72 6f6f 6d5f  action_get_room_
-0002da70: 696e 666f 2863 6c69 656e 743a 2041 7379  info(client: Asy
-0002da80: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
-0002da90: 7469 616c 733a 2064 6963 7429 202d 3e20  tials: dict) -> 
-0002daa0: 4e6f 6e65 3a0a 2020 2020 2222 2247 6574  None:.    """Get
-0002dab0: 2072 6f6f 6d20 6469 7370 6c61 7920 6e61   room display na
-0002dac0: 6d65 2873 2920 6f66 2069 7473 656c 6620  me(s) of itself 
-0002dad0: 6f72 2072 6f6f 6d73 2077 6869 6c65 2061  or rooms while a
-0002dae0: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
-0002daf0: 2e22 2222 0a20 2020 2069 6620 6773 2e70  .""".    if gs.p
-0002db00: 612e 6765 745f 726f 6f6d 5f69 6e66 6f20  a.get_room_info 
-0002db10: 3d3d 205b 5d3a 0a20 2020 2020 2020 2067  == []:.        g
-0002db20: 732e 7061 2e67 6574 5f72 6f6f 6d5f 696e  s.pa.get_room_in
-0002db30: 666f 2e61 7070 656e 6428 6372 6564 656e  fo.append(creden
-0002db40: 7469 616c 735b 2272 6f6f 6d5f 6964 225d  tials["room_id"]
-0002db50: 290a 2020 2020 6773 2e6c 6f67 2e64 6562  ).    gs.log.deb
-0002db60: 7567 280a 2020 2020 2020 2020 2247 6574  ug(.        "Get
-0002db70: 7469 6e67 2072 6f6f 6d20 6469 7370 6c61  ting room displa
-0002db80: 7920 6e61 6d65 7320 666f 7220 7468 6573  y names for thes
-0002db90: 6520 726f 6f6d 733a 2022 2066 227b 6773  e rooms: " f"{gs
-0002dba0: 2e70 612e 6765 745f 726f 6f6d 5f69 6e66  .pa.get_room_inf
-0002dbb0: 6f7d 220a 2020 2020 290a 2020 2020 6177  o}".    ).    aw
-0002dbc0: 6169 7420 7379 6e63 6872 6f6e 697a 6528  ait synchronize(
-0002dbd0: 636c 6965 6e74 2920 2023 2073 796e 6328  client)  # sync(
-0002dbe0: 2920 746f 2067 6574 2072 6f6f 6d73 0a20  ) to get rooms. 
-0002dbf0: 2020 2023 2075 7365 725f 6964 203d 2063     # user_id = c
-0002dc00: 7265 6465 6e74 6961 6c73 5b22 7573 6572  redentials["user
-0002dc10: 5f69 6422 5d0a 2020 2020 666f 7220 726f  _id"].    for ro
-0002dc20: 6f6d 5f69 6420 696e 2067 732e 7061 2e67  om_id in gs.pa.g
-0002dc30: 6574 5f72 6f6f 6d5f 696e 666f 3a0a 2020  et_room_info:.  
-0002dc40: 2020 2020 2020 726f 6f6d 5f69 6420 3d20        room_id = 
-0002dc50: 6177 6169 7420 6d61 705f 726f 6f6d 696e  await map_roomin
-0002dc60: 666f 5f74 6f5f 726f 6f6d 6964 2863 6c69  fo_to_roomid(cli
-0002dc70: 656e 742c 2072 6f6f 6d5f 6964 290a 2020  ent, room_id).  
-0002dc80: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002dc90: 2020 2020 2020 2072 6f6f 6d20 3d20 636c         room = cl
-0002dca0: 6965 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f  ient.rooms[room_
-0002dcb0: 6964 5d0a 2020 2020 2020 2020 2020 2020  id].            
-0002dcc0: 726f 6f6d 5f64 6973 706c 6179 6e61 6d65  room_displayname
-0002dcd0: 203d 2072 6f6f 6d2e 6469 7370 6c61 795f   = room.display_
-0002dce0: 6e61 6d65 0a20 2020 2020 2020 2065 7863  name.        exc
-0002dcf0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-0002dd00: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0002dd10: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-0002dd20: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-0002dd30: 3139 303a 2022 0a20 2020 2020 2020 2020  190: ".         
-0002dd40: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-0002dd50: 6765 7474 696e 6720 726f 6f6d 2064 6973  getting room dis
-0002dd60: 706c 6179 206e 616d 6520 666f 7220 726f  play name for ro
-0002dd70: 6f6d 207b 726f 6f6d 5f69 647d 2022 0a20  om {room_id} ". 
-0002dd80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002dd90: 2266 726f 6d20 7365 7276 6572 2e20 220a  "from server. ".
-0002dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ddb0: 6622 4578 6365 7074 696f 6e20 6973 207b  f"Exception is {
-0002ddc0: 657d 2e20 220a 2020 2020 2020 2020 2020  e}. ".          
-0002ddd0: 2020 2020 2020 6622 526f 6f6d 2069 7320        f"Room is 
-0002dde0: 7b72 6f6f 6d7d 2e20 526f 6f6d 2064 6963  {room}. Room dic
-0002ddf0: 7420 6973 207b 726f 6f6d 2e5f 5f64 6963  t is {room.__dic
-0002de00: 745f 5f7d 2e20 220a 2020 2020 2020 2020  t__}. ".        
-0002de10: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0002de20: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-0002de30: 3d20 310a 2020 2020 2020 2020 656c 7365  = 1.        else
-0002de40: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-0002de50: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0002de60: 2020 2020 2020 2020 2020 2020 6622 726f              f"ro
-0002de70: 6f6d 2069 6420 6973 207b 726f 6f6d 5f69  om id is {room_i
-0002de80: 647d 2c20 220a 2020 2020 2020 2020 2020  d}, ".          
-0002de90: 2020 2020 2020 6622 726f 6f6d 2064 6973        f"room dis
-0002dea0: 706c 6179 206e 616d 6520 6973 207b 726f  play name is {ro
-0002deb0: 6f6d 5f64 6973 706c 6179 6e61 6d65 7d2c  om_displayname},
-0002dec0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002ded0: 2020 2066 2272 6f6f 6d20 6973 207b 726f     f"room is {ro
-0002dee0: 6f6d 7d2e 2022 0a20 2020 2020 2020 2020  om}. ".         
-0002def0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002df00: 2072 6573 7020 3d20 726f 6f6d 0a20 2020   resp = room.   
-0002df10: 2020 2020 2020 2020 2023 206f 7574 7075           # outpu
-0002df20: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
-0002df30: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
-0002df40: 2066 6c61 670a 2020 2020 2020 2020 2020   flag.          
-0002df50: 2020 7465 7874 203d 2028 0a20 2020 2020    text = (.     
-0002df60: 2020 2020 2020 2020 2020 2066 227b 726f             f"{ro
-0002df70: 6f6d 5f69 647d 7b53 4550 7d7b 726f 6f6d  om_id}{SEP}{room
-0002df80: 5f64 6973 706c 6179 6e61 6d65 7d7b 5345  _displayname}{SE
-0002df90: 507d 220a 2020 2020 2020 2020 2020 2020  P}".            
-0002dfa0: 2020 2020 6622 7b72 6f6f 6d2e 6361 6e6f      f"{room.cano
-0002dfb0: 6e69 6361 6c5f 616c 6961 737d 7b53 4550  nical_alias}{SEP
-0002dfc0: 7d7b 726f 6f6d 2e74 6f70 6963 7d7b 5345  }{room.topic}{SE
-0002dfd0: 507d 220a 2020 2020 2020 2020 2020 2020  P}".            
-0002dfe0: 2020 2020 6622 7b72 6f6f 6d2e 6372 6561      f"{room.crea
-0002dff0: 746f 727d 7b53 4550 7d7b 726f 6f6d 2e65  tor}{SEP}{room.e
-0002e000: 6e63 7279 7074 6564 7d22 0a20 2020 2020  ncrypted}".     
-0002e010: 2020 2020 2020 2020 2020 2023 2066 227b             # f"{
-0002e020: 5345 507d 7b75 7365 725f 6964 7d22 0a20  SEP}{user_id}". 
-0002e030: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002e040: 2020 2020 2020 2020 2023 204f 626a 6563           # Objec
-0002e050: 7420 6f66 2074 7970 6520 7878 7852 6573  t of type xxxRes
-0002e060: 706f 6e73 6520 6973 206e 6f74 204a 534f  ponse is not JSO
-0002e070: 4e0a 2020 2020 2020 2020 2020 2020 2320  N.            # 
-0002e080: 7365 7269 616c 697a 6162 6c65 2c20 6865  serializable, he
-0002e090: 6e63 6520 7765 2075 7365 2074 6865 2064  nce we use the d
-0002e0a0: 6963 7469 6f6e 6172 792e 0a20 2020 2020  ictionary..     
-0002e0b0: 2020 2020 2020 206a 736f 6e5f 6d61 7820         json_max 
-0002e0c0: 3d20 7265 7370 2e5f 5f64 6963 745f 5f0a  = resp.__dict__.
-0002e0d0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0002e0e0: 5f6d 6178 2e75 7064 6174 6528 0a20 2020  _max.update(.   
-0002e0f0: 2020 2020 2020 2020 2020 2020 207b 2264               {"d
-0002e100: 6973 706c 6179 5f6e 616d 6522 3a20 726f  isplay_name": ro
-0002e110: 6f6d 5f64 6973 706c 6179 6e61 6d65 7d0a  om_displayname}.
-0002e120: 2020 2020 2020 2020 2020 2020 2920 2023              )  #
-0002e130: 2061 6464 2064 6963 7420 6974 656d 730a   add dict items.
-0002e140: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0002e150: 5f20 3d20 6a73 6f6e 5f6d 6178 2e63 6f70  _ = json_max.cop
-0002e160: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-0002e170: 2320 6a73 6f6e 5f2e 706f 7028 226b 6579  # json_.pop("key
-0002e180: 2229 0a20 2020 2020 2020 2020 2020 206a  ").            j
-0002e190: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-0002e1a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0002e1b0: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-0002e1c0: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
-0002e1d0: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-0002e1e0: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
-0002e1f0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0002e200: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-0002e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e220: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-0002e230: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0002e240: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-0002e250: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
-0002e260: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-0002e270: 6620 6163 7469 6f6e 5f68 6173 5f70 6572  f action_has_per
-0002e280: 6d69 7373 696f 6e28 0a20 2020 2063 6c69  mission(.    cli
-0002e290: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-0002e2a0: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
-0002e2b0: 6963 740a 2920 2d3e 204e 6f6e 653a 0a20  ict.) -> None:. 
-0002e2c0: 2020 2022 2222 496e 7175 6972 6520 6162     """Inquire ab
-0002e2d0: 6f75 7420 7065 726d 6973 7369 6f6e 7320  out permissions 
-0002e2e0: 696e 2072 6f6f 6d73 2077 6869 6c65 2061  in rooms while a
-0002e2f0: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
-0002e300: 2e22 2222 0a20 2020 2069 6620 6e6f 7420  .""".    if not 
-0002e310: 6c65 6e28 6773 2e70 612e 6861 735f 7065  len(gs.pa.has_pe
-0002e320: 726d 6973 7369 6f6e 2920 2520 3220 3d3d  rmission) % 2 ==
-0002e330: 2030 3a0a 2020 2020 2020 2020 6773 2e6c   0:.        gs.l
-0002e340: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
-0002e350: 2020 2020 2020 2245 3139 313a 2022 0a20        "E191: ". 
-0002e360: 2020 2020 2020 2020 2020 2022 496e 636f             "Inco
-0002e370: 7272 6563 7420 6e75 6d62 6572 206f 6620  rrect number of 
-0002e380: 6172 6775 6d65 6e74 7320 666f 7220 2d2d  arguments for --
-0002e390: 6861 732d 7065 726d 6973 7369 6f6e 2e20  has-permission. 
-0002e3a0: 4172 6775 6d65 6e74 7320 220a 2020 2020  Arguments ".    
-0002e3b0: 2020 2020 2020 2020 226d 7573 7420 6265          "must be
-0002e3c0: 2070 6169 7273 2c20 692e 652e 206d 756c   pairs, i.e. mul
-0002e3d0: 7469 706c 6573 206f 6620 322c 2062 7574  tiples of 2, but
-0002e3e0: 2066 6f75 6e64 2022 0a20 2020 2020 2020   found ".       
-0002e3f0: 2020 2020 2066 227b 6c65 6e28 6773 2e70       f"{len(gs.p
-0002e400: 612e 6861 735f 7065 726d 6973 7369 6f6e  a.has_permission
-0002e410: 297d 2061 7267 756d 656e 7473 2e22 0a20  )} arguments.". 
-0002e420: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002e430: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-0002e440: 2031 0a20 2020 2020 2020 2072 6574 7572   1.        retur
-0002e450: 6e0a 2020 2020 7573 6572 5f69 6420 3d20  n.    user_id = 
-0002e460: 6372 6564 656e 7469 616c 735b 2275 7365  credentials["use
-0002e470: 725f 6964 225d 2020 2320 7768 6f61 6d69  r_id"]  # whoami
-0002e480: 0a20 2020 2066 6f72 2069 6920 696e 2072  .    for ii in r
-0002e490: 616e 6765 286c 656e 2867 732e 7061 2e68  ange(len(gs.pa.h
-0002e4a0: 6173 5f70 6572 6d69 7373 696f 6e29 202f  as_permission) /
-0002e4b0: 2f20 3229 3a0a 2020 2020 2020 2020 726f  / 2):.        ro
-0002e4c0: 6f6d 5f69 6420 3d20 6773 2e70 612e 6861  om_id = gs.pa.ha
-0002e4d0: 735f 7065 726d 6973 7369 6f6e 5b69 6920  s_permission[ii 
-0002e4e0: 2a20 3220 2b20 305d 0a20 2020 2020 2020  * 2 + 0].       
-0002e4f0: 2072 6f6f 6d5f 6964 203d 2072 6f6f 6d5f   room_id = room_
-0002e500: 6964 2e72 6570 6c61 6365 2872 225c 2122  id.replace(r"\!"
-0002e510: 2c20 2221 2229 2020 2320 7265 6d6f 7665  , "!")  # remove
-0002e520: 2070 6f73 7369 626c 6520 6573 6361 7065   possible escape
-0002e530: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
-0002e540: 203d 2061 7761 6974 206d 6170 5f72 6f6f   = await map_roo
-0002e550: 6d69 6e66 6f5f 746f 5f72 6f6f 6d69 6428  minfo_to_roomid(
-0002e560: 636c 6965 6e74 2c20 726f 6f6d 5f69 6429  client, room_id)
-0002e570: 0a20 2020 2020 2020 2070 6572 6d69 7373  .        permiss
-0002e580: 696f 6e5f 7479 7065 203d 2067 732e 7061  ion_type = gs.pa
-0002e590: 2e68 6173 5f70 6572 6d69 7373 696f 6e5b  .has_permission[
-0002e5a0: 6969 202a 2032 202b 2031 5d2e 7374 7269  ii * 2 + 1].stri
-0002e5b0: 7028 290a 2020 2020 2020 2020 6773 2e6c  p().        gs.l
-0002e5c0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-0002e5d0: 2020 2020 2020 2250 7265 7061 7269 6e67        "Preparing
-0002e5e0: 2074 6f20 6173 6b20 6162 6f75 7420 7065   to ask about pe
-0002e5f0: 726d 6973 7369 6f6e 2066 6f72 2070 6572  rmission for per
-0002e600: 6d69 7373 696f 6e20 7479 7065 2022 0a20  mission type ". 
-0002e610: 2020 2020 2020 2020 2020 2066 2227 7b70             f"'{p
-0002e620: 6572 6d69 7373 696f 6e5f 7479 7065 7d27  ermission_type}'
-0002e630: 2069 6e20 726f 6f6d 207b 726f 6f6d 5f69   in room {room_i
-0002e640: 647d 2e22 0a20 2020 2020 2020 2029 0a20  d}.".        ). 
-0002e650: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0002e660: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-0002e670: 7761 6974 2063 6c69 656e 742e 6861 735f  wait client.has_
-0002e680: 7065 726d 6973 7369 6f6e 2872 6f6f 6d5f  permission(room_
-0002e690: 6964 2c20 7065 726d 6973 7369 6f6e 5f74  id, permission_t
-0002e6a0: 7970 6529 0a20 2020 2020 2020 2065 7863  ype).        exc
-0002e6b0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-0002e6c0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0002e6d0: 7265 7370 203d 2045 7272 6f72 5265 7370  resp = ErrorResp
-0002e6e0: 6f6e 7365 280a 2020 2020 2020 2020 2020  onse(.          
-0002e6f0: 2020 2020 2020 2245 3139 323a 2022 0a20        "E192: ". 
-0002e700: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002e710: 2268 6173 5f70 6572 6d69 7373 696f 6e28  "has_permission(
-0002e720: 2920 6661 696c 6564 2077 6974 6820 277b  ) failed with '{
-0002e730: 657d 272e 2022 0a20 2020 2020 2020 2020  e}'. ".         
-0002e740: 2020 2020 2020 2066 2249 7320 7468 6520         f"Is the 
-0002e750: 726f 6f6d 2069 6420 7b72 6f6f 6d5f 6964  room id {room_id
-0002e760: 7d20 636f 7272 6563 743f 220a 2020 2020  } correct?".    
-0002e770: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002e780: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0002e790: 7265 7370 2c20 4572 726f 7252 6573 706f  resp, ErrorRespo
-0002e7a0: 6e73 6529 3a0a 2020 2020 2020 2020 2020  nse):.          
-0002e7b0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-0002e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e7d0: 2245 3139 333a 2022 0a20 2020 2020 2020  "E193: ".       
-0002e7e0: 2020 2020 2020 2020 2022 4661 696c 6564           "Failed
-0002e7f0: 2074 6f20 6173 6b20 6162 6f75 7420 7065   to ask about pe
-0002e800: 726d 6973 7369 6f6e 2066 6f72 2070 6572  rmission for per
-0002e810: 6d69 7373 696f 6e20 7479 7065 2022 0a20  mission type ". 
-0002e820: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002e830: 2227 7b70 6572 6d69 7373 696f 6e5f 7479  "'{permission_ty
-0002e840: 7065 7d27 2069 6e20 726f 6f6d 207b 726f  pe}' in room {ro
-0002e850: 6f6d 5f69 647d 2e20 220a 2020 2020 2020  om_id}. ".      
-0002e860: 2020 2020 2020 2020 2020 6622 5265 7370            f"Resp
-0002e870: 6f6e 7365 2069 7320 7b70 7269 7661 6379  onse is {privacy
-0002e880: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
-0002e890: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
-0002e8a0: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
-0002e8b0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-0002e8c0: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
-0002e8d0: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
-0002e8e0: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
-0002e8f0: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
-0002e900: 2020 2020 2020 2320 666f 7220 4a53 4f4e        # for JSON
-0002e910: 2074 6865 2075 7365 7220 6361 6e20 6465   the user can de
-0002e920: 7465 726d 696e 6520 7768 6963 6820 6f6e  termine which on
-0002e930: 6520 6672 6f6d 2074 6865 206c 6973 740a  e from the list.
-0002e940: 2020 2020 2020 2020 2020 2020 2320 7761              # wa
-0002e950: 7320 7375 6363 6573 7366 756c 2061 6e64  s successful and
-0002e960: 2077 6869 6368 206f 6e65 2066 6169 6c65   which one faile
-0002e970: 642e 2046 6f72 2034 2069 6e70 7574 7320  d. For 4 inputs 
-0002e980: 7468 6572 650a 2020 2020 2020 2020 2020  there.          
-0002e990: 2020 2320 6d69 6768 7420 6f6e 6c79 2062    # might only b
-0002e9a0: 6520 3320 6f75 7470 7574 204a 534f 4e20  e 3 output JSON 
-0002e9b0: 6f62 6a65 6374 7320 6966 2074 6865 7265  objects if there
-0002e9c0: 2077 6173 2031 2065 7272 6f72 2e0a 2020   was 1 error..  
-0002e9d0: 2020 2020 2020 2020 2020 2320 496e 2074            # In t
-0002e9e0: 6578 7420 6d6f 6465 2077 6520 7072 696e  ext mode we prin
-0002e9f0: 7420 7468 6973 2065 7272 6f72 206c 696e  t this error lin
-0002ea00: 652c 2073 6f20 7468 6174 2066 6f72 2034  e, so that for 4
-0002ea10: 2069 6e70 7574 730a 2020 2020 2020 2020   inputs.        
-0002ea20: 2020 2020 2320 7468 6572 6520 7769 6c6c      # there will
-0002ea30: 2062 6520 3420 6f75 7470 7574 206c 696e   be 4 output lin
-0002ea40: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
-0002ea50: 7072 696e 745f 6f75 7470 7574 280a 2020  print_output(.  
-0002ea60: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-0002ea70: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
-0002ea80: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0002ea90: 3d28 0a20 2020 2020 2020 2020 2020 2020  =(.             
-0002eaa0: 2020 2020 2020 2066 2245 7272 6f72 7b53         f"Error{S
-0002eab0: 4550 7d7b 7573 6572 5f69 647d 7b53 4550  EP}{user_id}{SEP
-0002eac0: 7d7b 726f 6f6d 5f69 647d 220a 2020 2020  }{room_id}".    
-0002ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eae0: 6622 7b53 4550 7d7b 7065 726d 6973 7369  f"{SEP}{permissi
-0002eaf0: 6f6e 5f74 7970 657d 220a 2020 2020 2020  on_type}".      
-0002eb00: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-0002eb10: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-0002eb20: 6e5f 3d4e 6f6e 652c 0a20 2020 2020 2020  n_=None,.       
-0002eb30: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-0002eb40: 783d 4e6f 6e65 2c0a 2020 2020 2020 2020  x=None,.        
-0002eb50: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-0002eb60: 633d 4e6f 6e65 2c0a 2020 2020 2020 2020  c=None,.        
-0002eb70: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-0002eb80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002eb90: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0002eba0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002ebb0: 6861 735f 7065 726d 6973 7369 6f6e 207b  has_permission {
-0002ebc0: 7573 6572 5f69 647d 2066 6f72 2070 6572  user_id} for per
-0002ebd0: 6d69 7373 696f 6e20 7479 7065 2022 0a20  mission type ". 
-0002ebe0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002ebf0: 2227 7b70 6572 6d69 7373 696f 6e5f 7479  "'{permission_ty
-0002ec00: 7065 7d27 2069 6e20 726f 6f6d 207b 726f  pe}' in room {ro
-0002ec10: 6f6d 5f69 647d 3a20 220a 2020 2020 2020  om_id}: ".      
-0002ec20: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
-0002ec30: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
-0002ec40: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
-0002ec50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002ec60: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
-0002ec70: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
-0002ec80: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
-0002ec90: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0002eca0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-0002ecb0: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
-0002ecc0: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-0002ecd0: 297d 7b53 4550 7d7b 7573 6572 5f69 647d  )}{SEP}{user_id}
-0002ece0: 7b53 4550 7d7b 726f 6f6d 5f69 647d 7b53  {SEP}{room_id}{S
-0002ecf0: 4550 7d22 0a20 2020 2020 2020 2020 2020  EP}".           
-0002ed00: 2020 2020 2066 227b 7065 726d 6973 7369       f"{permissi
-0002ed10: 6f6e 5f74 7970 657d 220a 2020 2020 2020  on_type}".      
-0002ed20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002ed30: 2020 2020 2320 4f62 6a65 6374 206f 6620      # Object of 
-0002ed40: 7479 7065 2078 7878 5265 7370 6f6e 7365  type xxxResponse
-0002ed50: 2069 7320 6e6f 7420 4a53 4f4e 0a20 2020   is not JSON.   
-0002ed60: 2020 2020 2020 2020 2023 2073 6572 6961           # seria
-0002ed70: 6c69 7a61 626c 652c 2068 656e 6365 2077  lizable, hence w
-0002ed80: 6520 7573 6520 7468 6520 6469 6374 696f  e use the dictio
-0002ed90: 6e61 7279 2e0a 2020 2020 2020 2020 2020  nary..          
-0002eda0: 2020 6a73 6f6e 5f6d 6178 203d 2072 6573    json_max = res
-0002edb0: 702e 5f5f 6469 6374 5f5f 0a20 2020 2020  p.__dict__.     
-0002edc0: 2020 2020 2020 2023 206a 736f 6e5f 6d61         # json_ma
-0002edd0: 782e 7570 6461 7465 287b 226b 6579 223a  x.update({"key":
-0002ede0: 2076 616c 7565 7d29 2020 2320 6164 6420   value})  # add 
-0002edf0: 6469 6374 2069 7465 6d73 0a20 2020 2020  dict items.     
-0002ee00: 2020 2020 2020 206a 736f 6e5f 203d 206a         json_ = j
-0002ee10: 736f 6e5f 6d61 782e 636f 7079 2829 0a20  son_max.copy(). 
-0002ee20: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0002ee30: 2e70 6f70 2822 7472 616e 7370 6f72 745f  .pop("transport_
-0002ee40: 7265 7370 6f6e 7365 2229 0a20 2020 2020  response").     
-0002ee50: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
-0002ee60: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0002ee70: 2020 2020 7072 696e 745f 6f75 7470 7574      print_output
-0002ee80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002ee90: 2020 6773 2e70 612e 6f75 7470 7574 2c0a    gs.pa.output,.
-0002eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eeb0: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
-0002eec0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0002eed0: 3d6a 736f 6e5f 2c0a 2020 2020 2020 2020  =json_,.        
-0002eee0: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-0002eef0: 3d6a 736f 6e5f 6d61 782c 0a20 2020 2020  =json_max,.     
-0002ef00: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-0002ef10: 7370 6563 3d6a 736f 6e5f 7370 6563 2c0a  spec=json_spec,.
-0002ef20: 2020 2020 2020 2020 2020 2020 290a 0a0a              )...
-0002ef30: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
-0002ef40: 5f73 6574 5f61 7661 7461 7228 636c 6965  _set_avatar(clie
-0002ef50: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
-0002ef60: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
-0002ef70: 6374 2920 2d3e 204e 6f6e 653a 0a20 2020  ct) -> None:.   
-0002ef80: 2022 2222 5365 7420 6176 6174 6172 206f   """Set avatar o
-0002ef90: 6620 6974 7365 6c66 2077 6869 6c65 2061  f itself while a
-0002efa0: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
-0002efb0: 2e22 2222 0a20 2020 2075 7365 725f 6964  .""".    user_id
-0002efc0: 203d 2063 7265 6465 6e74 6961 6c73 5b22   = credentials["
-0002efd0: 7573 6572 5f69 6422 5d20 2023 2077 686f  user_id"]  # who
-0002efe0: 616d 690a 2020 2020 6176 6174 6172 5f6d  ami.    avatar_m
-0002eff0: 7863 203d 2067 732e 7061 2e73 6574 5f61  xc = gs.pa.set_a
-0002f000: 7661 7461 720a 2020 2020 6773 2e6c 6f67  vatar.    gs.log
-0002f010: 2e64 6562 7567 2866 2253 6574 7469 6e67  .debug(f"Setting
-0002f020: 2061 7661 7461 7220 666f 7220 7573 6572   avatar for user
-0002f030: 207b 7573 6572 5f69 647d 2074 6f20 5552   {user_id} to UR
-0002f040: 4920 7b61 7661 7461 725f 6d78 637d 2e22  I {avatar_mxc}."
-0002f050: 290a 2020 2020 7265 7370 203d 2061 7761  ).    resp = awa
-0002f060: 6974 2063 6c69 656e 742e 7365 745f 6176  it client.set_av
-0002f070: 6174 6172 2861 7661 7461 725f 6d78 6329  atar(avatar_mxc)
-0002f080: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-0002f090: 6365 2872 6573 702c 2050 726f 6669 6c65  ce(resp, Profile
-0002f0a0: 5365 7441 7661 7461 7252 6573 706f 6e73  SetAvatarRespons
-0002f0b0: 6529 3a0a 2020 2020 2020 2020 6773 2e6c  e):.        gs.l
-0002f0c0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-0002f0d0: 2020 2020 2020 2250 726f 6669 6c65 5365        "ProfileSe
-0002f0e0: 7441 7661 7461 7252 6573 706f 6e73 652e  tAvatarResponse.
-0002f0f0: 2052 6573 706f 6e73 6520 6973 3a20 220a   Response is: ".
-0002f100: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-0002f110: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-0002f120: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-0002f130: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
-0002f140: 6c6f 672e 696e 666f 280a 2020 2020 2020  log.info(.      
-0002f150: 2020 2020 2020 6622 5375 6363 6573 7366        f"Successf
-0002f160: 756c 6c79 2073 6574 2061 7661 7461 7220  ully set avatar 
-0002f170: 666f 7220 7573 6572 207b 7573 6572 5f69  for user {user_i
-0002f180: 647d 2022 0a20 2020 2020 2020 2020 2020  d} ".           
-0002f190: 2066 2274 6f20 5552 4920 7b61 7661 7461   f"to URI {avata
-0002f1a0: 725f 6d78 637d 2e22 0a20 2020 2020 2020  r_mxc}.".       
-0002f1b0: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
-0002f1c0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-0002f1d0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-0002f1e0: 4531 3935 3a20 220a 2020 2020 2020 2020  E195: ".        
-0002f1f0: 2020 2020 6622 4661 696c 6564 2073 6574      f"Failed set
-0002f200: 7469 6e67 2061 7661 7461 7220 666f 7220  ting avatar for 
-0002f210: 7573 6572 207b 7573 6572 5f69 647d 206f  user {user_id} o
-0002f220: 6e20 7365 7276 6572 2e20 220a 2020 2020  n server. ".    
-0002f230: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
-0002f240: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-0002f250: 7370 2929 7d22 0a20 2020 2020 2020 2029  sp))}".        )
-0002f260: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
-0002f270: 636f 756e 7420 2b3d 2031 0a0a 0a61 7379  count += 1...asy
-0002f280: 6e63 2064 6566 2061 6374 696f 6e5f 696d  nc def action_im
-0002f290: 706f 7274 5f6b 6579 7328 636c 6965 6e74  port_keys(client
-0002f2a0: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
-0002f2b0: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
-0002f2c0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-0002f2d0: 2222 496d 706f 7274 204d 6567 6f6c 6d20  ""Import Megolm 
-0002f2e0: 6b65 7973 2066 726f 6d20 6669 6c65 2077  keys from file w
-0002f2f0: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
-0002f300: 6765 6420 696e 2e22 2222 0a20 2020 2066  ged in.""".    f
-0002f310: 696c 6520 3d20 6773 2e70 612e 696d 706f  ile = gs.pa.impo
-0002f320: 7274 5f6b 6579 735b 305d 0a20 2020 2070  rt_keys[0].    p
-0002f330: 6173 7370 6872 6173 6520 3d20 6773 2e70  assphrase = gs.p
-0002f340: 612e 696d 706f 7274 5f6b 6579 735b 315d  a.import_keys[1]
-0002f350: 0a20 2020 2067 732e 6c6f 672e 6465 6275  .    gs.log.debu
-0002f360: 6728 6622 496d 706f 7274 696e 6720 6b65  g(f"Importing ke
-0002f370: 7973 2066 726f 6d20 6669 6c65 207b 6669  ys from file {fi
-0002f380: 6c65 7d20 7573 696e 6720 6120 7061 7373  le} using a pass
-0002f390: 7068 7261 7365 2e22 290a 2020 2020 7265  phrase.").    re
-0002f3a0: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
-0002f3b0: 742e 696d 706f 7274 5f6b 6579 7328 6669  t.import_keys(fi
-0002f3c0: 6c65 2c20 7061 7373 7068 7261 7365 290a  le, passphrase).
-0002f3d0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0002f3e0: 6528 7265 7370 2c20 456e 6372 7970 7469  e(resp, Encrypti
-0002f3f0: 6f6e 4572 726f 7229 3a0a 2020 2020 2020  onError):.      
-0002f400: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-0002f410: 2020 2020 2020 2020 2020 2020 2245 3139              "E19
-0002f420: 363a 2022 0a20 2020 2020 2020 2020 2020  6: ".           
-0002f430: 2066 2246 6169 6c65 6420 746f 2064 6563   f"Failed to dec
-0002f440: 7279 7074 206b 6579 7320 6669 6c65 2e20  rypt keys file. 
-0002f450: 4669 6c65 207b 6669 6c65 7d20 6973 2069  File {file} is i
-0002f460: 6e76 616c 6964 206f 7220 220a 2020 2020  nvalid or ".    
-0002f470: 2020 2020 2020 2020 6622 636f 756c 646e          f"couldn
-0002f480: e280 9974 2062 6520 6465 6372 7970 7465  ...t be decrypte
-0002f490: 642e 207b 7072 6976 6163 795f 6669 6c74  d. {privacy_filt
-0002f4a0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
-0002f4b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002f4c0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-0002f4d0: 3d20 310a 2020 2020 656c 7365 3a0a 2020  = 1.    else:.  
-0002f4e0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-0002f4f0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0002f500: 6622 696d 706f 7274 5f6b 6579 7320 7375  f"import_keys su
-0002f510: 6363 6573 7366 756c 2e20 5265 7370 6f6e  ccessful. Respon
-0002f520: 7365 2069 733a 207b 7072 6976 6163 795f  se is: {privacy_
-0002f530: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-0002f540: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
-0002f550: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
-0002f560: 6f28 6622 5375 6363 6573 7366 756c 6c79  o(f"Successfully
-0002f570: 2069 6d70 6f72 7465 6420 6b65 7973 2066   imported keys f
-0002f580: 726f 6d20 6669 6c65 207b 6669 6c65 7d2e  rom file {file}.
-0002f590: 2229 0a0a 0a61 7379 6e63 2064 6566 2061  ")...async def a
-0002f5a0: 6374 696f 6e5f 6578 706f 7274 5f6b 6579  ction_export_key
-0002f5b0: 7328 636c 6965 6e74 3a20 4173 796e 6343  s(client: AsyncC
-0002f5c0: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
-0002f5d0: 6c73 3a20 6469 6374 2920 2d3e 204e 6f6e  ls: dict) -> Non
-0002f5e0: 653a 0a20 2020 2022 2222 4578 706f 7274  e:.    """Export
-0002f5f0: 204d 6567 6f6c 6d20 6b65 7973 2066 726f   Megolm keys fro
-0002f600: 6d20 6669 6c65 2077 6869 6c65 2061 6c72  m file while alr
-0002f610: 6561 6479 206c 6f67 6765 6420 696e 2e22  eady logged in."
-0002f620: 2222 0a20 2020 2066 696c 6520 3d20 6773  "".    file = gs
-0002f630: 2e70 612e 6578 706f 7274 5f6b 6579 735b  .pa.export_keys[
-0002f640: 305d 0a20 2020 2070 6173 7370 6872 6173  0].    passphras
-0002f650: 6520 3d20 6773 2e70 612e 6578 706f 7274  e = gs.pa.export
-0002f660: 5f6b 6579 735b 315d 0a20 2020 2067 732e  _keys[1].    gs.
-0002f670: 6c6f 672e 6465 6275 6728 6622 4578 706f  log.debug(f"Expo
-0002f680: 7274 696e 6720 6b65 7973 2074 6f20 6669  rting keys to fi
-0002f690: 6c65 207b 6669 6c65 7d20 7573 696e 6720  le {file} using 
-0002f6a0: 6120 7061 7373 7068 7261 7365 2e22 290a  a passphrase.").
-0002f6b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0002f6c0: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
-0002f6d0: 6965 6e74 2e65 7870 6f72 745f 6b65 7973  ient.export_keys
-0002f6e0: 2866 696c 652c 2070 6173 7370 6872 6173  (file, passphras
-0002f6f0: 6529 0a20 2020 2065 7863 6570 7420 4578  e).    except Ex
-0002f700: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-0002f710: 2067 732e 6c6f 672e 6572 726f 7228 2245   gs.log.error("E
-0002f720: 3139 373a 2022 2066 2246 6169 6c65 6420  197: " f"Failed 
-0002f730: 746f 2065 7870 6f72 7420 6b65 7973 2074  to export keys t
-0002f740: 6f20 6669 6c65 207b 6669 6c65 7d2e 2229  o file {file}.")
-0002f750: 0a20 2020 2020 2020 2072 6169 7365 0a20  .        raise. 
-0002f760: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0002f770: 0a20 2020 2020 2020 2066 2265 7870 6f72  .        f"expor
-0002f780: 745f 6b65 7973 2073 7563 6365 7373 6675  t_keys successfu
-0002f790: 6c2e 2052 6573 706f 6e73 6520 6973 3a20  l. Response is: 
-0002f7a0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-0002f7b0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-0002f7c0: 2029 0a20 2020 2067 732e 6c6f 672e 696e   ).    gs.log.in
-0002f7d0: 666f 2866 2253 7563 6365 7373 6675 6c6c  fo(f"Successfull
-0002f7e0: 7920 6578 706f 7274 6564 206b 6579 7320  y exported keys 
-0002f7f0: 746f 2066 696c 6520 7b66 696c 657d 2e22  to file {file}."
-0002f800: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
-0002f810: 7469 6f6e 5f72 6f6f 6d5f 7365 745f 616c  tion_room_set_al
-0002f820: 6961 7328 0a20 2020 2063 6c69 656e 743a  ias(.    client:
-0002f830: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
-0002f840: 6564 656e 7469 616c 733a 2064 6963 740a  edentials: dict.
-0002f850: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-0002f860: 2222 4164 6420 616c 6961 7328 6573 2920  ""Add alias(es) 
-0002f870: 746f 2072 6f6f 6d28 7329 2077 6869 6c65  to room(s) while
-0002f880: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
-0002f890: 696e 2e22 2222 0a20 2020 2069 6620 6c65  in.""".    if le
-0002f8a0: 6e28 6773 2e70 612e 726f 6f6d 5f73 6574  n(gs.pa.room_set
-0002f8b0: 5f61 6c69 6173 2920 3d3d 2031 3a20 2023  _alias) == 1:  #
-0002f8c0: 2073 7065 6369 616c 2063 6173 650a 2020   special case.  
-0002f8d0: 2020 2020 2020 6773 2e70 612e 726f 6f6d        gs.pa.room
-0002f8e0: 5f73 6574 5f61 6c69 6173 2e61 7070 656e  _set_alias.appen
-0002f8f0: 6428 6372 6564 656e 7469 616c 735b 2272  d(credentials["r
-0002f900: 6f6f 6d5f 6964 225d 290a 2020 2020 6966  oom_id"]).    if
-0002f910: 206e 6f74 206c 656e 2867 732e 7061 2e72   not len(gs.pa.r
-0002f920: 6f6f 6d5f 7365 745f 616c 6961 7329 2025  oom_set_alias) %
-0002f930: 2032 203d 3d20 303a 0a20 2020 2020 2020   2 == 0:.       
-0002f940: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-0002f950: 2020 2020 2020 2020 2020 2022 4531 3938             "E198
-0002f960: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-0002f970: 2249 6e63 6f72 7265 6374 206e 756d 6265  "Incorrect numbe
-0002f980: 7220 6f66 2061 7267 756d 656e 7473 2066  r of arguments f
-0002f990: 6f72 202d 2d72 6f6f 6d2d 7365 742d 616c  or --room-set-al
-0002f9a0: 6961 732e 2041 7267 756d 656e 7473 2022  ias. Arguments "
-0002f9b0: 0a20 2020 2020 2020 2020 2020 2022 6d75  .            "mu
-0002f9c0: 7374 2062 6520 7061 6972 732c 2069 2e65  st be pairs, i.e
-0002f9d0: 2e20 6d75 6c74 6970 6c65 7320 6f66 2032  . multiples of 2
-0002f9e0: 2c20 6275 7420 666f 756e 6420 220a 2020  , but found ".  
-0002f9f0: 2020 2020 2020 2020 2020 6622 7b6c 656e            f"{len
-0002fa00: 2867 732e 7061 2e72 6f6f 6d5f 7365 745f  (gs.pa.room_set_
-0002fa10: 616c 6961 7329 7d20 6172 6775 6d65 6e74  alias)} argument
-0002fa20: 732e 2031 2069 7320 616c 6c6f 7765 6420  s. 1 is allowed 
-0002fa30: 746f 6f2e 220a 2020 2020 2020 2020 290a  too.".        ).
-0002fa40: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
-0002fa50: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-0002fa60: 2020 7265 7475 726e 0a20 2020 2066 6f72    return.    for
-0002fa70: 2069 6920 696e 2072 616e 6765 286c 656e   ii in range(len
-0002fa80: 2867 732e 7061 2e72 6f6f 6d5f 7365 745f  (gs.pa.room_set_
-0002fa90: 616c 6961 7329 202f 2f20 3229 3a0a 2020  alias) // 2):.  
-0002faa0: 2020 2020 2020 616c 6961 7320 3d20 6773        alias = gs
-0002fab0: 2e70 612e 726f 6f6d 5f73 6574 5f61 6c69  .pa.room_set_ali
-0002fac0: 6173 5b69 6920 2a20 3220 2b20 305d 2e73  as[ii * 2 + 0].s
-0002fad0: 7472 6970 2829 0a20 2020 2020 2020 2072  trip().        r
-0002fae0: 6f6f 6d5f 6964 203d 2067 732e 7061 2e72  oom_id = gs.pa.r
-0002faf0: 6f6f 6d5f 7365 745f 616c 6961 735b 6969  oom_set_alias[ii
-0002fb00: 202a 2032 202b 2031 5d0a 2020 2020 2020   * 2 + 1].      
-0002fb10: 2020 726f 6f6d 5f69 6420 3d20 6177 6169    room_id = awai
-0002fb20: 7420 6d61 705f 726f 6f6d 696e 666f 5f74  t map_roominfo_t
-0002fb30: 6f5f 726f 6f6d 6964 2863 6c69 656e 742c  o_roomid(client,
-0002fb40: 2072 6f6f 6d5f 6964 290a 2020 2020 2020   room_id).      
-0002fb50: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-0002fb60: 2241 6464 696e 6720 616c 6961 7320 277b  "Adding alias '{
-0002fb70: 616c 6961 737d 2720 746f 2072 6f6f 6d20  alias}' to room 
-0002fb80: 277b 726f 6f6d 5f69 647d 272e 2229 0a20  '{room_id}'."). 
-0002fb90: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0002fba0: 5f72 6f6f 6d5f 616c 6961 7328 616c 6961  _room_alias(alia
-0002fbb0: 7329 2061 6e64 206e 6f74 2069 735f 7368  s) and not is_sh
-0002fbc0: 6f72 745f 726f 6f6d 5f61 6c69 6173 2861  ort_room_alias(a
-0002fbd0: 6c69 6173 293a 0a20 2020 2020 2020 2020  lias):.         
-0002fbe0: 2020 2023 206e 6f74 2061 6e20 6578 6861     # not an exha
-0002fbf0: 7573 7469 7665 2063 6865 636b 0a20 2020  ustive check.   
-0002fc00: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-0002fc10: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-0002fc20: 2020 2020 2020 2022 4531 3939 3a20 220a         "E199: ".
-0002fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc40: 6622 496e 7661 6c69 6420 616c 6961 7320  f"Invalid alias 
-0002fc50: 277b 616c 6961 737d 272e 2054 6869 7320  '{alias}'. This 
-0002fc60: 6973 206e 6569 7468 6572 2061 2066 756c  is neither a ful
-0002fc70: 6c20 726f 6f6d 2061 6c69 6173 2022 0a20  l room alias ". 
-0002fc80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002fc90: 6e6f 7220 6120 7368 6f72 7420 726f 6f6d  nor a short room
-0002fca0: 2061 6c69 6173 2e20 4974 2073 686f 756c   alias. It shoul
-0002fcb0: 6420 6569 7468 6572 2062 6520 220a 2020  d either be ".  
-0002fcc0: 2020 2020 2020 2020 2020 2020 2020 2227                "'
-0002fcd0: 2353 6f6d 6552 6f6f 6d41 6c69 6173 3a6d  #SomeRoomAlias:m
-0002fce0: 6174 7269 782e 6578 616d 706c 652e 636f  atrix.example.co
-0002fcf0: 6d27 206f 7220 220a 2020 2020 2020 2020  m' or ".        
-0002fd00: 2020 2020 2020 2020 2227 2353 6f6d 6552          "'#SomeR
-0002fd10: 6f6f 6d41 6c69 6173 2720 6f72 2027 536f  oomAlias' or 'So
-0002fd20: 6d65 526f 6f6d 416c 6961 7327 2e22 0a20  meRoomAlias'.". 
-0002fd30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002fd40: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-0002fd50: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0002fd60: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0002fd70: 2020 2020 2020 2020 6966 2022 3a22 206e          if ":" n
-0002fd80: 6f74 2069 6e20 616c 6961 733a 0a20 2020  ot in alias:.   
-0002fd90: 2020 2020 2020 2020 2023 2044 6f20 4e4f           # Do NO
-0002fda0: 5420 7573 6520 7368 6f72 745f 726f 6f6d  T use short_room
-0002fdb0: 5f61 6c69 6173 5f74 6f5f 726f 6f6d 5f61  _alias_to_room_a
-0002fdc0: 6c69 6173 2829 2e0a 2020 2020 2020 2020  lias()..        
-0002fdd0: 2020 2020 2320 5765 2077 616e 7420 7468      # We want th
-0002fde0: 6973 2074 6f20 6265 2062 6173 6564 206f  is to be based o
-0002fdf0: 6e20 7072 6f76 6964 6564 2072 6f6f 6d5f  n provided room_
-0002fe00: 6964 206e 6f74 2074 6865 2064 6566 6175  id not the defau
-0002fe10: 6c74 0a20 2020 2020 2020 2020 2020 2023  lt.            #
-0002fe20: 2068 6f6d 6573 6572 7665 7221 0a20 2020   homeserver!.   
-0002fe30: 2020 2020 2020 2020 2069 6620 616c 6961           if alia
-0002fe40: 735b 305d 2021 3d20 2223 223a 0a20 2020  s[0] != "#":.   
-0002fe50: 2020 2020 2020 2020 2020 2020 2061 6c69               ali
-0002fe60: 6173 203d 2022 2322 202b 2061 6c69 6173  as = "#" + alias
-0002fe70: 0a20 2020 2020 2020 2020 2020 2061 6c69  .            ali
-0002fe80: 6173 203d 2061 6c69 6173 202b 2022 3a22  as = alias + ":"
-0002fe90: 202b 2072 6f6f 6d5f 6964 2e73 706c 6974   + room_id.split
-0002fea0: 2822 3a22 295b 315d 0a20 2020 2020 2020  (":")[1].       
-0002feb0: 2072 6573 7020 3d20 6177 6169 7420 636c   resp = await cl
-0002fec0: 6965 6e74 2e72 6f6f 6d5f 7075 745f 616c  ient.room_put_al
-0002fed0: 6961 7328 616c 6961 732c 2072 6f6f 6d5f  ias(alias, room_
-0002fee0: 6964 290a 2020 2020 2020 2020 6966 2069  id).        if i
-0002fef0: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
-0002ff00: 526f 6f6d 5075 7441 6c69 6173 5265 7370  RoomPutAliasResp
-0002ff10: 6f6e 7365 293a 0a20 2020 2020 2020 2020  onse):.         
-0002ff20: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-0002ff30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ff40: 2022 726f 6f6d 5f70 7574 5f61 6c69 6173   "room_put_alias
-0002ff50: 2073 7563 6365 7373 6675 6c2e 2052 6573   successful. Res
-0002ff60: 706f 6e73 6520 6973 3a20 220a 2020 2020  ponse is: ".    
-0002ff70: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-0002ff80: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-0002ff90: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-0002ffa0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002ffb0: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-0002ffc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002ffd0: 2020 6622 5375 6363 6573 7366 756c 6c79    f"Successfully
-0002ffe0: 2061 6464 6564 2061 6c69 6173 2027 7b61   added alias '{a
-0002fff0: 6c69 6173 7d27 2074 6f20 726f 6f6d 2027  lias}' to room '
-00030000: 7b72 6f6f 6d5f 6964 7d27 2e22 0a20 2020  {room_id}'.".   
-00030010: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00030020: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00030030: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-00030040: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00030050: 2020 2022 4532 3030 3a20 220a 2020 2020     "E200: ".    
-00030060: 2020 2020 2020 2020 2020 2020 6622 4661              f"Fa
-00030070: 696c 6564 2074 6f20 6164 6420 616c 6961  iled to add alia
-00030080: 7320 277b 616c 6961 737d 2720 746f 2072  s '{alias}' to r
-00030090: 6f6f 6d20 277b 726f 6f6d 5f69 647d 273a  oom '{room_id}':
-000300a0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000300b0: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
-000300c0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-000300d0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-000300e0: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-000300f0: 7272 5f63 6f75 6e74 202b 3d20 310a 0a0a  rr_count += 1...
-00030100: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
-00030110: 5f72 6f6f 6d5f 7265 736f 6c76 655f 616c  _room_resolve_al
-00030120: 6961 7328 0a20 2020 2063 6c69 656e 743a  ias(.    client:
-00030130: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
-00030140: 6564 656e 7469 616c 733a 2064 6963 740a  edentials: dict.
-00030150: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-00030160: 2222 5265 736f 6c76 6520 726f 6f6d 2061  ""Resolve room a
-00030170: 6c69 6173 2865 7329 2077 6869 6c65 2061  lias(es) while a
-00030180: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
-00030190: 2e22 2222 0a20 2020 2066 6f72 2061 6c69  .""".    for ali
-000301a0: 6173 2069 6e20 6773 2e70 612e 726f 6f6d  as in gs.pa.room
-000301b0: 5f72 6573 6f6c 7665 5f61 6c69 6173 3a0a  _resolve_alias:.
-000301c0: 2020 2020 2020 2020 616c 6961 7320 3d20          alias = 
-000301d0: 616c 6961 732e 7374 7269 7028 290a 2020  alias.strip().  
-000301e0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-000301f0: 7567 2866 2252 6573 6f6c 7669 6e67 2072  ug(f"Resolving r
-00030200: 6f6f 6d20 616c 6961 7320 277b 616c 6961  oom alias '{alia
-00030210: 737d 272e 2229 0a20 2020 2020 2020 2069  s}'.").        i
-00030220: 6620 6e6f 7420 6973 5f72 6f6f 6d5f 616c  f not is_room_al
-00030230: 6961 7328 616c 6961 7329 2061 6e64 206e  ias(alias) and n
-00030240: 6f74 2069 735f 7368 6f72 745f 726f 6f6d  ot is_short_room
-00030250: 5f61 6c69 6173 2861 6c69 6173 293a 0a20  _alias(alias):. 
-00030260: 2020 2020 2020 2020 2020 2023 206e 6f74             # not
-00030270: 2061 6e20 6578 6861 7573 7469 7665 2063   an exhaustive c
-00030280: 6865 636b 0a20 2020 2020 2020 2020 2020  heck.           
-00030290: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-000302a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000302b0: 4532 3031 3a20 220a 2020 2020 2020 2020  E201: ".        
-000302c0: 2020 2020 2020 2020 6622 496e 7661 6c69          f"Invali
-000302d0: 6420 616c 6961 7320 277b 616c 6961 737d  d alias '{alias}
-000302e0: 272e 2054 6869 7320 6973 206e 6569 7468  '. This is neith
-000302f0: 6572 2061 2066 756c 6c20 726f 6f6d 2061  er a full room a
-00030300: 6c69 6173 2022 0a20 2020 2020 2020 2020  lias ".         
-00030310: 2020 2020 2020 2022 6e6f 7220 6120 7368         "nor a sh
-00030320: 6f72 7420 726f 6f6d 2061 6c69 6173 2e20  ort room alias. 
-00030330: 4974 2073 686f 756c 6420 6569 7468 6572  It should either
-00030340: 2062 6520 220a 2020 2020 2020 2020 2020   be ".          
-00030350: 2020 2020 2020 2227 2353 6f6d 6552 6f6f        "'#SomeRoo
-00030360: 6d41 6c69 6173 3a6d 6174 7269 782e 6578  mAlias:matrix.ex
-00030370: 616d 706c 652e 636f 6d27 206f 7220 220a  ample.com' or ".
-00030380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030390: 2227 2353 6f6d 6552 6f6f 6d41 6c69 6173  "'#SomeRoomAlias
-000303a0: 2720 6f72 2027 536f 6d65 526f 6f6d 416c  ' or 'SomeRoomAl
-000303b0: 6961 7327 2e22 0a20 2020 2020 2020 2020  ias'.".         
-000303c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000303d0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-000303e0: 2031 0a20 2020 2020 2020 2020 2020 2063   1.            c
-000303f0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00030400: 6966 2022 3a22 206e 6f74 2069 6e20 616c  if ":" not in al
-00030410: 6961 733a 2020 2320 7368 6f72 7420 616c  ias:  # short al
-00030420: 6961 732c 2077 6974 686f 7574 2068 6f6d  ias, without hom
-00030430: 6573 6572 7665 720a 2020 2020 2020 2020  eserver.        
-00030440: 2020 2020 616c 6961 7320 3d20 7368 6f72      alias = shor
-00030450: 745f 726f 6f6d 5f61 6c69 6173 5f74 6f5f  t_room_alias_to_
-00030460: 726f 6f6d 5f61 6c69 6173 2861 6c69 6173  room_alias(alias
-00030470: 2c20 6372 6564 656e 7469 616c 7329 0a20  , credentials). 
-00030480: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-00030490: 6169 7420 636c 6965 6e74 2e72 6f6f 6d5f  ait client.room_
-000304a0: 7265 736f 6c76 655f 616c 6961 7328 616c  resolve_alias(al
-000304b0: 6961 7329 0a20 2020 2020 2020 2069 6620  ias).        if 
-000304c0: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-000304d0: 2052 6f6f 6d52 6573 6f6c 7665 416c 6961   RoomResolveAlia
-000304e0: 7352 6573 706f 6e73 6529 3a0a 2020 2020  sResponse):.    
-000304f0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00030500: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00030510: 2020 2020 2020 2272 6f6f 6d5f 7265 736f        "room_reso
-00030520: 6c76 655f 616c 6961 7320 7375 6363 6573  lve_alias succes
-00030530: 7366 756c 2e20 5265 7370 6f6e 7365 2069  sful. Response i
-00030540: 733a 2022 0a20 2020 2020 2020 2020 2020  s: ".           
-00030550: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
-00030560: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
-00030570: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-00030580: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-00030590: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
-000305a0: 2020 2020 2020 2020 2020 2066 2253 7563             f"Suc
-000305b0: 6365 7373 6675 6c6c 7920 7265 736f 6c76  cessfully resolv
-000305c0: 6564 2072 6f6f 6d20 616c 6961 7320 277b  ed room alias '{
-000305d0: 616c 6961 737d 2720 746f 2022 0a20 2020  alias}' to ".   
-000305e0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-000305f0: 7265 7370 2e72 6f6f 6d5f 6964 7d2e 220a  resp.room_id}.".
-00030600: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00030610: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
-00030620: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
-00030630: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
-00030640: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
-00030650: 2020 2074 6578 7420 3d20 280a 2020 2020     text = (.    
-00030660: 2020 2020 2020 2020 2020 2020 6622 7b72              f"{r
-00030670: 6573 702e 726f 6f6d 5f61 6c69 6173 7d7b  esp.room_alias}{
-00030680: 5345 507d 7b72 6573 702e 726f 6f6d 5f69  SEP}{resp.room_i
-00030690: 647d 7b53 4550 7d22 2066 227b 7265 7370  d}{SEP}" f"{resp
-000306a0: 2e73 6572 7665 7273 7d22 0a20 2020 2020  .servers}".     
-000306b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000306c0: 2020 2020 2023 204f 626a 6563 7420 6f66       # Object of
-000306d0: 2074 7970 6520 7878 7852 6573 706f 6e73   type xxxRespons
-000306e0: 6520 6973 206e 6f74 204a 534f 4e0a 2020  e is not JSON.  
-000306f0: 2020 2020 2020 2020 2020 2320 7365 7269            # seri
-00030700: 616c 697a 6162 6c65 2c20 6865 6e63 6520  alizable, hence 
-00030710: 7765 2075 7365 2074 6865 2064 6963 7469  we use the dicti
-00030720: 6f6e 6172 792e 0a20 2020 2020 2020 2020  onary..         
-00030730: 2020 206a 736f 6e5f 6d61 7820 3d20 7265     json_max = re
-00030740: 7370 2e5f 5f64 6963 745f 5f0a 2020 2020  sp.__dict__.    
-00030750: 2020 2020 2020 2020 2320 6a73 6f6e 5f6d          # json_m
-00030760: 6178 2e75 7064 6174 6528 7b22 6b65 7922  ax.update({"key"
-00030770: 3a20 7661 6c75 657d 2920 2023 2061 6464  : value})  # add
-00030780: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
-00030790: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
-000307a0: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
-000307b0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-000307c0: 5f2e 706f 7028 2274 7261 6e73 706f 7274  _.pop("transport
-000307d0: 5f72 6573 706f 6e73 6522 290a 2020 2020  _response").    
-000307e0: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-000307f0: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
-00030800: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
-00030810: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00030820: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
-00030830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030840: 2074 6578 743d 7465 7874 2c0a 2020 2020   text=text,.    
-00030850: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00030860: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
-00030870: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00030880: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
-00030890: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-000308a0: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
-000308b0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000308c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000308d0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-000308e0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-000308f0: 2020 2020 2020 2022 4532 3032 3a20 220a         "E202: ".
-00030900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030910: 6622 4661 696c 6564 2074 6f20 7265 736f  f"Failed to reso
-00030920: 6c76 6520 726f 6f6d 2061 6c69 6173 2027  lve room alias '
-00030930: 7b61 6c69 6173 7d27 3a20 220a 2020 2020  {alias}': ".    
-00030940: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-00030950: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-00030960: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-00030970: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00030980: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-00030990: 7420 2b3d 2031 0a20 2020 2020 2020 2020  t += 1.         
-000309a0: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
-000309b0: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
-000309c0: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
-000309d0: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
-000309e0: 7220 4a53 4f4e 2074 6865 2075 7365 7220  r JSON the user 
-000309f0: 6361 6e20 6465 7465 726d 696e 6520 7768  can determine wh
-00030a00: 6963 6820 6f6e 6520 6672 6f6d 2074 6865  ich one from the
-00030a10: 206c 6973 740a 2020 2020 2020 2020 2020   list.          
-00030a20: 2020 2320 7761 7320 7375 6363 6573 7366    # was successf
-00030a30: 756c 2061 6e64 2077 6869 6368 206f 6e65  ul and which one
-00030a40: 2066 6169 6c65 642e 2046 6f72 2034 2069   failed. For 4 i
-00030a50: 6e70 7574 7320 7468 6572 650a 2020 2020  nputs there.    
-00030a60: 2020 2020 2020 2020 2320 6d69 6768 7420          # might 
-00030a70: 6f6e 6c79 2062 6520 3320 6f75 7470 7574  only be 3 output
-00030a80: 204a 534f 4e20 6f62 6a65 6374 7320 6966   JSON objects if
-00030a90: 2074 6865 7265 2077 6173 2031 2065 7272   there was 1 err
-00030aa0: 6f72 2e0a 2020 2020 2020 2020 2020 2020  or..            
-00030ab0: 2320 496e 2074 6578 7420 6d6f 6465 2077  # In text mode w
-00030ac0: 6520 7072 696e 7420 7468 6973 2065 7272  e print this err
-00030ad0: 6f72 206c 696e 652c 2073 6f20 7468 6174  or line, so that
-00030ae0: 2066 6f72 2034 2069 6e70 7574 730a 2020   for 4 inputs.  
-00030af0: 2020 2020 2020 2020 2020 2320 7468 6572            # ther
-00030b00: 6520 7769 6c6c 2062 6520 3420 6f75 7470  e will be 4 outp
-00030b10: 7574 206c 696e 6573 2e0a 2020 2020 2020  ut lines..      
-00030b20: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
-00030b30: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
-00030b40: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
-00030b50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00030b60: 2020 7465 7874 3d28 6622 7b61 6c69 6173    text=(f"{alias
-00030b70: 7d7b 5345 507d 4572 726f 727b 5345 507d  }{SEP}Error{SEP}
-00030b80: 5b5d 2229 2c0a 2020 2020 2020 2020 2020  []"),.          
-00030b90: 2020 2020 2020 6a73 6f6e 5f3d 4e6f 6e65        json_=None
-00030ba0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00030bb0: 2020 6a73 6f6e 5f6d 6178 3d4e 6f6e 652c    json_max=None,
-00030bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030bd0: 206a 736f 6e5f 7370 6563 3d4e 6f6e 652c   json_spec=None,
-00030be0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00030bf0: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
-00030c00: 6e5f 726f 6f6d 5f64 656c 6574 655f 616c  n_room_delete_al
-00030c10: 6961 7328 0a20 2020 2063 6c69 656e 743a  ias(.    client:
-00030c20: 2041 7379 6e63 436c 6965 6e74 2c20 6372   AsyncClient, cr
-00030c30: 6564 656e 7469 616c 733a 2064 6963 740a  edentials: dict.
-00030c40: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-00030c50: 2222 4465 6c65 7465 2072 6f6f 6d20 616c  ""Delete room al
-00030c60: 6961 7328 6573 2920 7768 696c 6520 616c  ias(es) while al
-00030c70: 7265 6164 7920 6c6f 6767 6564 2069 6e2e  ready logged in.
-00030c80: 2222 220a 2020 2020 666f 7220 616c 6961  """.    for alia
-00030c90: 7320 696e 2067 732e 7061 2e72 6f6f 6d5f  s in gs.pa.room_
-00030ca0: 6465 6c65 7465 5f61 6c69 6173 3a0a 2020  delete_alias:.  
-00030cb0: 2020 2020 2020 616c 6961 7320 3d20 616c        alias = al
-00030cc0: 6961 732e 7374 7269 7028 290a 2020 2020  ias.strip().    
-00030cd0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00030ce0: 2866 2244 656c 6574 696e 6720 726f 6f6d  (f"Deleting room
-00030cf0: 2061 6c69 6173 2027 7b61 6c69 6173 7d27   alias '{alias}'
-00030d00: 2e22 290a 2020 2020 2020 2020 6966 206e  .").        if n
-00030d10: 6f74 2069 735f 726f 6f6d 5f61 6c69 6173  ot is_room_alias
-00030d20: 2861 6c69 6173 2920 616e 6420 6e6f 7420  (alias) and not 
-00030d30: 6973 5f73 686f 7274 5f72 6f6f 6d5f 616c  is_short_room_al
-00030d40: 6961 7328 616c 6961 7329 3a0a 2020 2020  ias(alias):.    
-00030d50: 2020 2020 2020 2020 2320 6e6f 7420 616e          # not an
-00030d60: 2065 7868 6175 7374 6976 6520 6368 6563   exhaustive chec
-00030d70: 6b0a 2020 2020 2020 2020 2020 2020 6773  k.            gs
-00030d80: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-00030d90: 2020 2020 2020 2020 2020 2020 2245 3230              "E20
-00030da0: 333a 2022 0a20 2020 2020 2020 2020 2020  3: ".           
-00030db0: 2020 2020 2066 2249 6e76 616c 6964 2061       f"Invalid a
-00030dc0: 6c69 6173 2027 7b61 6c69 6173 7d27 2e20  lias '{alias}'. 
-00030dd0: 5468 6973 2069 7320 6e65 6974 6865 7220  This is neither 
-00030de0: 6120 6675 6c6c 2072 6f6f 6d20 616c 6961  a full room alia
-00030df0: 7320 220a 2020 2020 2020 2020 2020 2020  s ".            
-00030e00: 2020 2020 226e 6f72 2061 2073 686f 7274      "nor a short
-00030e10: 2072 6f6f 6d20 616c 6961 732e 2049 7420   room alias. It 
-00030e20: 7368 6f75 6c64 2065 6974 6865 7220 6265  should either be
-00030e30: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00030e40: 2020 2022 2723 536f 6d65 526f 6f6d 416c     "'#SomeRoomAl
-00030e50: 6961 733a 6d61 7472 6978 2e65 7861 6d70  ias:matrix.examp
-00030e60: 6c65 2e63 6f6d 2720 6f72 2027 536f 6d65  le.com' or 'Some
-00030e70: 526f 6f6d 416c 6961 7327 2e22 0a20 2020  RoomAlias'.".   
-00030e80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00030e90: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
-00030ea0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00030eb0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-00030ec0: 2020 2020 2020 6966 2022 3a22 206e 6f74        if ":" not
-00030ed0: 2069 6e20 616c 6961 733a 2020 2320 7368   in alias:  # sh
-00030ee0: 6f72 7420 616c 6961 732c 2077 6974 686f  ort alias, witho
-00030ef0: 7574 2068 6f6d 6573 6572 7665 720a 2020  ut homeserver.  
-00030f00: 2020 2020 2020 2020 2020 616c 6961 7320            alias 
-00030f10: 3d20 7368 6f72 745f 726f 6f6d 5f61 6c69  = short_room_ali
-00030f20: 6173 5f74 6f5f 726f 6f6d 5f61 6c69 6173  as_to_room_alias
-00030f30: 2861 6c69 6173 2c20 6372 6564 656e 7469  (alias, credenti
-00030f40: 616c 7329 0a20 2020 2020 2020 2072 6573  als).        res
-00030f50: 7020 3d20 6177 6169 7420 636c 6965 6e74  p = await client
-00030f60: 2e72 6f6f 6d5f 6465 6c65 7465 5f61 6c69  .room_delete_ali
-00030f70: 6173 2861 6c69 6173 290a 2020 2020 2020  as(alias).      
-00030f80: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00030f90: 7265 7370 2c20 526f 6f6d 4465 6c65 7465  resp, RoomDelete
-00030fa0: 416c 6961 7352 6573 706f 6e73 6529 3a0a  AliasResponse):.
-00030fb0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00030fc0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00030fd0: 2020 2020 2020 2020 2020 2272 6f6f 6d5f            "room_
-00030fe0: 6465 6c65 7465 5f61 6c69 6173 2073 7563  delete_alias suc
-00030ff0: 6365 7373 6675 6c2e 2052 6573 706f 6e73  cessful. Respons
-00031000: 6520 6973 3a20 220a 2020 2020 2020 2020  e is: ".        
-00031010: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
-00031020: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-00031030: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
-00031040: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00031050: 2067 732e 6c6f 672e 696e 666f 2866 2253   gs.log.info(f"S
-00031060: 7563 6365 7373 6675 6c6c 7920 6465 6c65  uccessfully dele
-00031070: 7465 6420 726f 6f6d 2061 6c69 6173 2027  ted room alias '
-00031080: 7b61 6c69 6173 7d27 2e22 290a 2020 2020  {alias}'.").    
-00031090: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000310a0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
-000310b0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000310c0: 2020 2020 2245 3230 343a 2022 0a20 2020      "E204: ".   
-000310d0: 2020 2020 2020 2020 2020 2020 2066 2246               f"F
-000310e0: 6169 6c65 6420 746f 2064 656c 6574 6520  ailed to delete 
-000310f0: 726f 6f6d 2061 6c69 6173 2027 7b61 6c69  room alias '{ali
-00031100: 6173 7d27 3a20 220a 2020 2020 2020 2020  as}': ".        
-00031110: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
-00031120: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
-00031130: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
-00031140: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00031150: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-00031160: 2031 0a0a 0a61 7379 6e63 2064 6566 2061   1...async def a
-00031170: 6374 696f 6e5f 6765 745f 6f70 656e 6964  ction_get_openid
-00031180: 5f74 6f6b 656e 280a 2020 2020 636c 6965  _token(.    clie
-00031190: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
-000311a0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
-000311b0: 6374 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ct.) -> None:.  
-000311c0: 2020 2222 2247 6574 204f 7065 6e49 6420    """Get OpenId 
-000311d0: 746f 6b65 6e28 7329 2066 6f72 2069 7473  token(s) for its
-000311e0: 656c 6620 6f72 2075 7365 7273 2077 6869  elf or users whi
-000311f0: 6c65 2061 6c72 6561 6479 206c 6f67 6765  le already logge
-00031200: 6420 696e 2e22 2222 0a20 2020 2069 6620  d in.""".    if 
-00031210: 6e6f 7420 4841 5645 5f4f 5045 4e49 443a  not HAVE_OPENID:
-00031220: 0a20 2020 2020 2020 206e 696f 5f76 6572  .        nio_ver
-00031230: 7369 6f6e 203d 2070 6b67 5f72 6573 6f75  sion = pkg_resou
-00031240: 7263 6573 2e67 6574 5f64 6973 7472 6962  rces.get_distrib
-00031250: 7574 696f 6e28 226d 6174 7269 782d 6e69  ution("matrix-ni
-00031260: 6f22 292e 7665 7273 696f 6e0a 2020 2020  o").version.    
-00031270: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00031280: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
-00031290: 3230 353a 2022 0a20 2020 2020 2020 2020  205: ".         
-000312a0: 2020 2066 2259 6f75 2061 7265 2072 756e     f"You are run
-000312b0: 6e69 6e67 206d 6174 7269 782d 6e69 6f20  ning matrix-nio 
-000312c0: 7665 7273 696f 6e20 7b6e 696f 5f76 6572  version {nio_ver
-000312d0: 7369 6f6e 7d2e 2022 0a20 2020 2020 2020  sion}. ".       
-000312e0: 2020 2020 2066 2254 6869 7320 6665 6174       f"This feat
-000312f0: 7572 6520 6973 206f 6e6c 7920 6176 6169  ure is only avai
-00031300: 6c61 626c 6520 6f6e 2076 6572 7369 6f6e  lable on version
-00031310: 7320 6c61 7267 6572 2074 6861 6e20 302e  s larger than 0.
-00031320: 3139 2e30 2e20 220a 2020 2020 2020 2020  19.0. ".        
-00031330: 2020 2020 2255 7064 6174 6520 6966 206e      "Update if n
-00031340: 6563 6573 7361 7279 2e20 220a 2020 2020  ecessary. ".    
-00031350: 2020 2020 2020 2020 2257 6169 7420 666f          "Wait fo
-00031360: 7220 7665 7273 696f 6e20 302e 3139 2e31  r version 0.19.1
-00031370: 206f 7220 302e 3230 2074 6f20 6265 2072   or 0.20 to be r
-00031380: 656c 6561 7365 642e 2022 0a20 2020 2020  eleased. ".     
-00031390: 2020 2020 2020 2022 4f72 2075 7365 2075         "Or use u
-000313a0: 6e72 656c 6561 7365 6420 636f 6465 2066  nreleased code f
-000313b0: 726f 6d20 6d61 7374 6572 2062 7261 6e63  rom master branc
-000313c0: 6820 6f6e 2047 6974 6875 622e 220a 2020  h on Github.".  
-000313d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000313e0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-000313f0: 310a 2020 2020 2020 2020 7265 7475 726e  1.        return
-00031400: 0a20 2020 2069 6620 6773 2e70 612e 6765  .    if gs.pa.ge
-00031410: 745f 6f70 656e 6964 5f74 6f6b 656e 203d  t_openid_token =
-00031420: 3d20 5b5d 3a0a 2020 2020 2020 2020 6773  = []:.        gs
-00031430: 2e70 612e 6765 745f 6f70 656e 6964 5f74  .pa.get_openid_t
-00031440: 6f6b 656e 2e61 7070 656e 6428 6372 6564  oken.append(cred
-00031450: 656e 7469 616c 735b 2275 7365 725f 6964  entials["user_id
-00031460: 225d 2920 2023 2077 686f 616d 690a 2020  "])  # whoami.  
-00031470: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00031480: 2247 6574 7469 6e67 204f 7065 6e49 4473  "Getting OpenIDs
-00031490: 2066 6f72 2074 6865 7365 2075 7365 7273   for these users
-000314a0: 3a20 7b67 732e 7061 2e67 6574 5f6f 7065  : {gs.pa.get_ope
-000314b0: 6e69 645f 746f 6b65 6e7d 2229 0a20 2020  nid_token}").   
-000314c0: 2066 6f72 2075 7365 725f 6964 2069 6e20   for user_id in 
-000314d0: 6773 2e70 612e 6765 745f 6f70 656e 6964  gs.pa.get_openid
-000314e0: 5f74 6f6b 656e 3a0a 2020 2020 2020 2020  _token:.        
-000314f0: 7573 6572 5f69 6420 3d20 7573 6572 5f69  user_id = user_i
-00031500: 642e 7374 7269 7028 290a 2020 2020 2020  d.strip().      
-00031510: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00031520: 6c69 656e 742e 6765 745f 6f70 656e 6964  lient.get_openid
-00031530: 5f74 6f6b 656e 2875 7365 725f 6964 290a  _token(user_id).
-00031540: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00031550: 7461 6e63 6528 7265 7370 2c20 4765 744f  tance(resp, GetO
-00031560: 7065 6e49 4454 6f6b 656e 4572 726f 7229  penIDTokenError)
-00031570: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-00031580: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-00031590: 2020 2020 2020 2020 2020 2020 2245 3230              "E20
-000315a0: 363a 2022 0a20 2020 2020 2020 2020 2020  6: ".           
-000315b0: 2020 2020 2066 2246 6169 6c65 6420 746f       f"Failed to
-000315c0: 2067 6574 204f 7065 6e49 6420 666f 7220   get OpenId for 
-000315d0: 7573 6572 207b 7573 6572 5f69 647d 2e20  user {user_id}. 
-000315e0: 5265 7370 6f6e 7365 3a20 220a 2020 2020  Response: ".    
-000315f0: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-00031600: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-00031610: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-00031620: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00031630: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
-00031640: 7420 2b3d 2031 0a20 2020 2020 2020 2065  t += 1.        e
-00031650: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00031660: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-00031670: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00031680: 6765 745f 6f70 656e 6964 5f74 6f6b 656e  get_openid_token
-00031690: 2073 7563 6365 7373 6675 6c2e 2052 6573   successful. Res
-000316a0: 706f 6e73 6520 6973 3a20 220a 2020 2020  ponse is: ".    
-000316b0: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
-000316c0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
-000316d0: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
-000316e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000316f0: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-00031700: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00031710: 2020 6622 5375 6363 6573 7366 756c 6c79    f"Successfully
-00031720: 206f 6274 6169 6e65 6420 4f70 656e 4964   obtained OpenId
-00031730: 2074 6f6b 656e 2022 0a20 2020 2020 2020   token ".       
-00031740: 2020 2020 2020 2020 2066 227b 7265 7370           f"{resp
-00031750: 2e61 6363 6573 735f 746f 6b65 6e7d 2066  .access_token} f
-00031760: 6f72 2075 7365 7220 7b75 7365 725f 6964  or user {user_id
-00031770: 7d2e 220a 2020 2020 2020 2020 2020 2020  }.".            
-00031780: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00031790: 6f75 7470 7574 2066 6f72 6d61 7420 636f  output format co
-000317a0: 6e74 726f 6c6c 6564 2076 6961 202d 2d6f  ntrolled via --o
-000317b0: 7574 7075 7420 666c 6167 0a20 2020 2020  utput flag.     
-000317c0: 2020 2020 2020 2074 6578 7420 3d20 280a         text = (.
-000317d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000317e0: 6622 7b75 7365 725f 6964 7d7b 5345 507d  f"{user_id}{SEP}
-000317f0: 7b72 6573 702e 6163 6365 7373 5f74 6f6b  {resp.access_tok
-00031800: 656e 7d7b 5345 507d 7b72 6573 702e 6578  en}{SEP}{resp.ex
-00031810: 7069 7265 735f 696e 7d22 0a20 2020 2020  pires_in}".     
-00031820: 2020 2020 2020 2020 2020 2066 227b 5345             f"{SE
-00031830: 507d 7b72 6573 702e 6d61 7472 6978 5f73  P}{resp.matrix_s
-00031840: 6572 7665 725f 6e61 6d65 7d7b 5345 507d  erver_name}{SEP}
-00031850: 7b72 6573 702e 746f 6b65 6e5f 7479 7065  {resp.token_type
-00031860: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00031870: 0a20 2020 2020 2020 2020 2020 2023 204f  .            # O
-00031880: 626a 6563 7420 6f66 2074 7970 6520 7878  bject of type xx
-00031890: 7852 6573 706f 6e73 6520 6973 206e 6f74  xResponse is not
-000318a0: 204a 534f 4e0a 2020 2020 2020 2020 2020   JSON.          
-000318b0: 2020 2320 7365 7269 616c 697a 6162 6c65    # serializable
-000318c0: 2c20 6865 6e63 6520 7765 2075 7365 2074  , hence we use t
-000318d0: 6865 2064 6963 7469 6f6e 6172 792e 0a20  he dictionary.. 
-000318e0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
-000318f0: 6d61 7820 3d20 7265 7370 2e5f 5f64 6963  max = resp.__dic
-00031900: 745f 5f0a 2020 2020 2020 2020 2020 2020  t__.            
-00031910: 6a73 6f6e 5f6d 6178 2e75 7064 6174 6528  json_max.update(
-00031920: 7b22 7573 6572 5f69 6422 3a20 7573 6572  {"user_id": user
-00031930: 5f69 647d 2920 2023 2061 6464 2064 6963  _id})  # add dic
-00031940: 7420 6974 656d 730a 2020 2020 2020 2020  t items.        
-00031950: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
-00031960: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
-00031970: 2020 2020 2020 2020 6a73 6f6e 5f2e 706f          json_.po
-00031980: 7028 2274 7261 6e73 706f 7274 5f72 6573  p("transport_res
-00031990: 706f 6e73 6522 290a 2020 2020 2020 2020  ponse").        
-000319a0: 2020 2020 6a73 6f6e 5f73 7065 6320 3d20      json_spec = 
-000319b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000319c0: 2070 7269 6e74 5f6f 7574 7075 7428 0a20   print_output(. 
-000319d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000319e0: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
-000319f0: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-00031a00: 743d 7465 7874 2c0a 2020 2020 2020 2020  t=text,.        
-00031a10: 2020 2020 2020 2020 6a73 6f6e 5f3d 6a73          json_=js
-00031a20: 6f6e 5f2c 0a20 2020 2020 2020 2020 2020  on_,.           
-00031a30: 2020 2020 206a 736f 6e5f 6d61 783d 6a73       json_max=js
-00031a40: 6f6e 5f6d 6178 2c0a 2020 2020 2020 2020  on_max,.        
-00031a50: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00031a60: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
-00031a70: 2020 2020 2020 2020 2029 0a0a 0a61 7379           )...asy
-00031a80: 6e63 2064 6566 2061 6374 696f 6e5f 726f  nc def action_ro
-00031a90: 6f6d 5f67 6574 5f76 6973 6962 696c 6974  om_get_visibilit
-00031aa0: 7928 0a20 2020 2063 6c69 656e 743a 2041  y(.    client: A
-00031ab0: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
-00031ac0: 656e 7469 616c 733a 2064 6963 740a 2920  entials: dict.) 
-00031ad0: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
-00031ae0: 4765 7420 7669 7369 6269 6c69 7479 206f  Get visibility o
-00031af0: 6620 726f 6f6d 2873 2920 7768 696c 6520  f room(s) while 
-00031b00: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
-00031b10: 6e2e 2222 220a 2020 2020 6966 2067 732e  n.""".    if gs.
-00031b20: 7061 2e72 6f6f 6d5f 6765 745f 7669 7369  pa.room_get_visi
-00031b30: 6269 6c69 7479 203d 3d20 5b5d 3a0a 2020  bility == []:.  
-00031b40: 2020 2020 2020 6773 2e70 612e 726f 6f6d        gs.pa.room
-00031b50: 5f67 6574 5f76 6973 6962 696c 6974 792e  _get_visibility.
-00031b60: 6170 7065 6e64 2863 7265 6465 6e74 6961  append(credentia
-00031b70: 6c73 5b22 726f 6f6d 5f69 6422 5d29 2020  ls["room_id"])  
-00031b80: 2320 6465 662e 2072 6f6f 6d0a 2020 2020  # def. room.    
-00031b90: 666f 7220 726f 6f6d 5f69 6420 696e 2067  for room_id in g
-00031ba0: 732e 7061 2e72 6f6f 6d5f 6765 745f 7669  s.pa.room_get_vi
-00031bb0: 7369 6269 6c69 7479 3a0a 2020 2020 2020  sibility:.      
-00031bc0: 2020 726f 6f6d 5f69 6420 3d20 6177 6169    room_id = awai
-00031bd0: 7420 6d61 705f 726f 6f6d 696e 666f 5f74  t map_roominfo_t
-00031be0: 6f5f 726f 6f6d 6964 2863 6c69 656e 742c  o_roomid(client,
-00031bf0: 2072 6f6f 6d5f 6964 290a 2020 2020 2020   room_id).      
-00031c00: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00031c10: 2247 6574 7469 6e67 2076 6973 6962 696c  "Getting visibil
-00031c20: 6974 7920 666f 7220 726f 6f6d 207b 726f  ity for room {ro
-00031c30: 6f6d 5f69 647d 2e22 290a 2020 2020 2020  om_id}.").      
-00031c40: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
-00031c50: 6c69 656e 742e 726f 6f6d 5f67 6574 5f76  lient.room_get_v
-00031c60: 6973 6962 696c 6974 7928 726f 6f6d 5f69  isibility(room_i
-00031c70: 6429 0a20 2020 2020 2020 2069 6620 6973  d).        if is
-00031c80: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
-00031c90: 6f6f 6d47 6574 5669 7369 6269 6c69 7479  oomGetVisibility
-00031ca0: 5265 7370 6f6e 7365 293a 0a20 2020 2020  Response):.     
-00031cb0: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
-00031cc0: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-00031cd0: 2020 2020 6622 5375 6363 6573 7366 756c      f"Successful
-00031ce0: 6c79 2067 6f74 2076 6973 6962 696c 6974  ly got visibilit
-00031cf0: 7920 666f 7220 726f 6f6d 207b 7265 7370  y for room {resp
-00031d00: 2e72 6f6f 6d5f 6964 7d3a 2022 0a20 2020  .room_id}: ".   
-00031d10: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-00031d20: 7265 7370 2e76 6973 6962 696c 6974 797d  resp.visibility}
-00031d30: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-00031d40: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
-00031d50: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
-00031d60: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
-00031d70: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
-00031d80: 2020 2020 2020 7465 7874 203d 2066 227b        text = f"{
-00031d90: 7265 7370 2e76 6973 6962 696c 6974 797d  resp.visibility}
-00031da0: 7b53 4550 7d7b 726f 6f6d 5f69 647d 220a  {SEP}{room_id}".
-00031db0: 2020 2020 2020 2020 2020 2020 2320 4f62              # Ob
-00031dc0: 6a65 6374 206f 6620 7479 7065 2078 7878  ject of type xxx
-00031dd0: 5265 7370 6f6e 7365 2069 7320 6e6f 7420  Response is not 
-00031de0: 4a53 4f4e 0a20 2020 2020 2020 2020 2020  JSON.           
-00031df0: 2023 2073 6572 6961 6c69 7a61 626c 652c   # serializable,
-00031e00: 2068 656e 6365 2077 6520 7573 6520 7468   hence we use th
-00031e10: 6520 6469 6374 696f 6e61 7279 2e0a 2020  e dictionary..  
-00031e20: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
-00031e30: 6178 203d 2072 6573 702e 5f5f 6469 6374  ax = resp.__dict
-00031e40: 5f5f 0a20 2020 2020 2020 2020 2020 2023  __.            #
-00031e50: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
-00031e60: 287b 226b 6579 223a 2076 616c 7565 7d29  ({"key": value})
-00031e70: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
-00031e80: 6d73 0a20 2020 2020 2020 2020 2020 206a  ms.            j
-00031e90: 736f 6e5f 203d 206a 736f 6e5f 6d61 782e  son_ = json_max.
-00031ea0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-00031eb0: 2020 206a 736f 6e5f 2e70 6f70 2822 7472     json_.pop("tr
-00031ec0: 616e 7370 6f72 745f 7265 7370 6f6e 7365  ansport_response
-00031ed0: 2229 0a20 2020 2020 2020 2020 2020 206a  ").            j
-00031ee0: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
-00031ef0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00031f00: 745f 6f75 7470 7574 280a 2020 2020 2020  t_output(.      
-00031f10: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
-00031f20: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
-00031f30: 2020 2020 2020 2020 7465 7874 3d74 6578          text=tex
-00031f40: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00031f50: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
-00031f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031f70: 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61  json_max=json_ma
-00031f80: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00031f90: 2020 206a 736f 6e5f 7370 6563 3d6a 736f     json_spec=jso
-00031fa0: 6e5f 7370 6563 2c0a 2020 2020 2020 2020  n_spec,.        
-00031fb0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00031fc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00031fd0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-00031fe0: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00031ff0: 3230 373a 2022 0a20 2020 2020 2020 2020  207: ".         
-00032000: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-00032010: 6765 7474 696e 6720 7669 7369 6269 6c69  getting visibili
-00032020: 7479 2066 6f72 2072 6f6f 6d20 7b72 6f6f  ty for room {roo
-00032030: 6d5f 6964 7d2e 2022 0a20 2020 2020 2020  m_id}. ".       
-00032040: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
-00032050: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
-00032060: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
-00032070: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00032080: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00032090: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-000320a0: 6572 726d 7367 203d 2022 4572 726f 723a  errmsg = "Error:
-000320b0: 2022 202b 2073 7472 2872 6573 702e 7374   " + str(resp.st
-000320c0: 6174 7573 5f63 6f64 6529 202b 2022 2022  atus_code) + " "
-000320d0: 202b 2072 6573 702e 6d65 7373 6167 650a   + resp.message.
-000320e0: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
-000320f0: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
-00032100: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
-00032110: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
-00032120: 2020 2020 2023 2066 6f72 204a 534f 4e20       # for JSON 
-00032130: 7468 6520 7573 6572 2063 616e 2064 6574  the user can det
-00032140: 6572 6d69 6e65 2077 6869 6368 206f 6e65  ermine which one
-00032150: 2066 726f 6d20 7468 6520 6c69 7374 0a20   from the list. 
-00032160: 2020 2020 2020 2020 2020 2023 2077 6173             # was
-00032170: 2073 7563 6365 7373 6675 6c20 616e 6420   successful and 
-00032180: 7768 6963 6820 6f6e 6520 6661 696c 6564  which one failed
-00032190: 2e20 466f 7220 3420 696e 7075 7473 2074  . For 4 inputs t
-000321a0: 6865 7265 0a20 2020 2020 2020 2020 2020  here.           
-000321b0: 2023 206d 6967 6874 206f 6e6c 7920 6265   # might only be
-000321c0: 2033 206f 7574 7075 7420 4a53 4f4e 206f   3 output JSON o
-000321d0: 626a 6563 7473 2069 6620 7468 6572 6520  bjects if there 
-000321e0: 7761 7320 3120 6572 726f 722e 0a20 2020  was 1 error..   
-000321f0: 2020 2020 2020 2020 2023 2049 6e20 7465           # In te
-00032200: 7874 206d 6f64 6520 7765 2070 7269 6e74  xt mode we print
-00032210: 2074 6869 7320 6572 726f 7220 6c69 6e65   this error line
-00032220: 2c20 736f 2074 6861 7420 666f 7220 3420  , so that for 4 
-00032230: 696e 7075 7473 0a20 2020 2020 2020 2020  inputs.         
-00032240: 2020 2023 2074 6865 7265 2077 696c 6c20     # there will 
-00032250: 6265 2034 206f 7574 7075 7420 6c69 6e65  be 4 output line
-00032260: 732e 0a20 2020 2020 2020 2020 2020 2070  s..            p
-00032270: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
-00032280: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
-00032290: 7061 2e6f 7574 7075 742c 0a20 2020 2020  pa.output,.     
-000322a0: 2020 2020 2020 2020 2020 2074 6578 743d             text=
-000322b0: 2866 227b 6572 726d 7367 7d7b 5345 507d  (f"{errmsg}{SEP}
-000322c0: 7b72 6f6f 6d5f 6964 7d22 292c 0a20 2020  {room_id}"),.   
-000322d0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-000322e0: 6e5f 3d4e 6f6e 652c 0a20 2020 2020 2020  n_=None,.       
-000322f0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
-00032300: 783d 4e6f 6e65 2c0a 2020 2020 2020 2020  x=None,.        
-00032310: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
-00032320: 633d 4e6f 6e65 2c0a 2020 2020 2020 2020  c=None,.        
-00032330: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-00032340: 6620 6163 7469 6f6e 5f72 6f6f 6d5f 6765  f action_room_ge
-00032350: 745f 7374 6174 6528 0a20 2020 2063 6c69  t_state(.    cli
-00032360: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
-00032370: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
-00032380: 6963 740a 2920 2d3e 204e 6f6e 653a 0a20  ict.) -> None:. 
-00032390: 2020 2022 2222 4765 7420 7374 6174 6520     """Get state 
-000323a0: 6f66 2072 6f6f 6d28 7329 2077 6869 6c65  of room(s) while
-000323b0: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
-000323c0: 696e 2e22 2222 0a20 2020 2069 6620 6773  in.""".    if gs
-000323d0: 2e70 612e 726f 6f6d 5f67 6574 5f73 7461  .pa.room_get_sta
-000323e0: 7465 203d 3d20 5b5d 3a0a 2020 2020 2020  te == []:.      
-000323f0: 2020 6773 2e70 612e 726f 6f6d 5f67 6574    gs.pa.room_get
-00032400: 5f73 7461 7465 2e61 7070 656e 6428 6372  _state.append(cr
-00032410: 6564 656e 7469 616c 735b 2272 6f6f 6d5f  edentials["room_
-00032420: 6964 225d 2920 2023 2064 6566 6175 6c74  id"])  # default
-00032430: 2072 6f6f 6d0a 2020 2020 666f 7220 726f   room.    for ro
-00032440: 6f6d 5f69 6420 696e 2067 732e 7061 2e72  om_id in gs.pa.r
-00032450: 6f6f 6d5f 6765 745f 7374 6174 653a 0a20  oom_get_state:. 
-00032460: 2020 2020 2020 2072 6f6f 6d5f 6964 203d         room_id =
-00032470: 2061 7761 6974 206d 6170 5f72 6f6f 6d69   await map_roomi
-00032480: 6e66 6f5f 746f 5f72 6f6f 6d69 6428 636c  nfo_to_roomid(cl
-00032490: 6965 6e74 2c20 726f 6f6d 5f69 6429 0a20  ient, room_id). 
-000324a0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-000324b0: 6275 6728 6622 4765 7474 696e 6720 7669  bug(f"Getting vi
-000324c0: 7369 6269 6c69 7479 2066 6f72 2072 6f6f  sibility for roo
-000324d0: 6d20 7b72 6f6f 6d5f 6964 7d2e 2229 0a20  m {room_id}."). 
-000324e0: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-000324f0: 6169 7420 636c 6965 6e74 2e72 6f6f 6d5f  ait client.room_
-00032500: 6765 745f 7374 6174 6528 726f 6f6d 5f69  get_state(room_i
-00032510: 6429 0a20 2020 2020 2020 2069 6620 6973  d).        if is
-00032520: 696e 7374 616e 6365 2872 6573 702c 2052  instance(resp, R
-00032530: 6f6f 6d47 6574 5374 6174 6552 6573 706f  oomGetStateRespo
-00032540: 6e73 6529 3a0a 2020 2020 2020 2020 2020  nse):.          
-00032550: 2020 6773 2e6c 6f67 2e69 6e66 6f28 0a20    gs.log.info(. 
-00032560: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00032570: 2253 7563 6365 7373 6675 6c6c 7920 676f  "Successfully go
-00032580: 7420 7374 6174 6520 666f 7220 726f 6f6d  t state for room
-00032590: 207b 7265 7370 2e72 6f6f 6d5f 6964 7d3a   {resp.room_id}:
-000325a0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000325b0: 2020 2066 227b 7265 7370 2e65 7665 6e74     f"{resp.event
-000325c0: 737d 2e22 0a20 2020 2020 2020 2020 2020  s}.".           
-000325d0: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
-000325e0: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
-000325f0: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
-00032600: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
-00032610: 2020 2020 2020 2020 7465 7874 203d 2066          text = f
-00032620: 227b 7265 7370 2e65 7665 6e74 737d 7b53  "{resp.events}{S
-00032630: 4550 7d7b 726f 6f6d 5f69 647d 220a 2020  EP}{room_id}".  
-00032640: 2020 2020 2020 2020 2020 2320 4f62 6a65            # Obje
-00032650: 6374 206f 6620 7479 7065 2078 7878 5265  ct of type xxxRe
-00032660: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
-00032670: 4f4e 0a20 2020 2020 2020 2020 2020 2023  ON.            #
-00032680: 2073 6572 6961 6c69 7a61 626c 652c 2068   serializable, h
-00032690: 656e 6365 2077 6520 7573 6520 7468 6520  ence we use the 
-000326a0: 6469 6374 696f 6e61 7279 2e0a 2020 2020  dictionary..    
-000326b0: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
-000326c0: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
-000326d0: 0a20 2020 2020 2020 2020 2020 2023 206a  .            # j
-000326e0: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
-000326f0: 226b 6579 223a 2076 616c 7565 7d29 2020  "key": value})  
-00032700: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
-00032710: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-00032720: 6e5f 203d 206a 736f 6e5f 6d61 782e 636f  n_ = json_max.co
-00032730: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-00032740: 206a 736f 6e5f 2e70 6f70 2822 7472 616e   json_.pop("tran
-00032750: 7370 6f72 745f 7265 7370 6f6e 7365 2229  sport_response")
-00032760: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
-00032770: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
-00032780: 2020 2020 2020 2020 2020 7072 696e 745f            print_
-00032790: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
-000327a0: 2020 2020 2020 2020 6773 2e70 612e 6f75          gs.pa.ou
-000327b0: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
-000327c0: 2020 2020 2020 7465 7874 3d74 6578 742c        text=text,
-000327d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000327e0: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
-000327f0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00032800: 6f6e 5f6d 6178 3d6a 736f 6e5f 6d61 782c  on_max=json_max,
-00032810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032820: 206a 736f 6e5f 7370 6563 3d6a 736f 6e5f   json_spec=json_
-00032830: 7370 6563 2c0a 2020 2020 2020 2020 2020  spec,.          
-00032840: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
-00032850: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-00032860: 2e6c 6f67 2e65 7272 6f72 280a 2020 2020  .log.error(.    
-00032870: 2020 2020 2020 2020 2020 2020 2245 3230              "E20
-00032880: 383a 2022 0a20 2020 2020 2020 2020 2020  8: ".           
-00032890: 2020 2020 2066 2246 6169 6c65 6420 6765       f"Failed ge
-000328a0: 7474 696e 6720 7374 6174 6520 666f 7220  tting state for 
-000328b0: 726f 6f6d 207b 726f 6f6d 5f69 647d 2e20  room {room_id}. 
-000328c0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000328d0: 2020 6622 7b70 7269 7661 6379 5f66 696c    f"{privacy_fil
-000328e0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
-000328f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00032900: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
-00032910: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-00032920: 2020 2020 2020 2020 2065 7272 6d73 6720           errmsg 
-00032930: 3d20 2245 7272 6f72 3a20 2220 2b20 7374  = "Error: " + st
-00032940: 7228 7265 7370 2e73 7461 7475 735f 636f  r(resp.status_co
-00032950: 6465 2920 2b20 2220 2220 2b20 7265 7370  de) + " " + resp
-00032960: 2e6d 6573 7361 6765 0a20 2020 2020 2020  .message.       
-00032970: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
-00032980: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
-00032990: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
-000329a0: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
-000329b0: 666f 7220 4a53 4f4e 2074 6865 2075 7365  for JSON the use
-000329c0: 7220 6361 6e20 6465 7465 726d 696e 6520  r can determine 
-000329d0: 7768 6963 6820 6f6e 6520 6672 6f6d 2074  which one from t
-000329e0: 6865 206c 6973 740a 2020 2020 2020 2020  he list.        
-000329f0: 2020 2020 2320 7761 7320 7375 6363 6573      # was succes
-00032a00: 7366 756c 2061 6e64 2077 6869 6368 206f  sful and which o
-00032a10: 6e65 2066 6169 6c65 642e 2046 6f72 2034  ne failed. For 4
-00032a20: 2069 6e70 7574 7320 7468 6572 650a 2020   inputs there.  
-00032a30: 2020 2020 2020 2020 2020 2320 6d69 6768            # migh
-00032a40: 7420 6f6e 6c79 2062 6520 3320 6f75 7470  t only be 3 outp
-00032a50: 7574 204a 534f 4e20 6f62 6a65 6374 7320  ut JSON objects 
-00032a60: 6966 2074 6865 7265 2077 6173 2031 2065  if there was 1 e
-00032a70: 7272 6f72 2e0a 2020 2020 2020 2020 2020  rror..          
-00032a80: 2020 2320 496e 2074 6578 7420 6d6f 6465    # In text mode
-00032a90: 2077 6520 7072 696e 7420 7468 6973 2065   we print this e
-00032aa0: 7272 6f72 206c 696e 652c 2073 6f20 7468  rror line, so th
-00032ab0: 6174 2066 6f72 2034 2069 6e70 7574 730a  at for 4 inputs.
-00032ac0: 2020 2020 2020 2020 2020 2020 2320 7468              # th
-00032ad0: 6572 6520 7769 6c6c 2062 6520 3420 6f75  ere will be 4 ou
-00032ae0: 7470 7574 206c 696e 6573 2e0a 2020 2020  tput lines..    
-00032af0: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
-00032b00: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-00032b10: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
-00032b20: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-00032b30: 2020 2020 7465 7874 3d28 6622 7b65 7272      text=(f"{err
-00032b40: 6d73 677d 7b53 4550 7d7b 726f 6f6d 5f69  msg}{SEP}{room_i
-00032b50: 647d 2229 2c0a 2020 2020 2020 2020 2020  d}"),.          
-00032b60: 2020 2020 2020 6a73 6f6e 5f3d 4e6f 6e65        json_=None
-00032b70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032b80: 2020 6a73 6f6e 5f6d 6178 3d4e 6f6e 652c    json_max=None,
-00032b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032ba0: 206a 736f 6e5f 7370 6563 3d4e 6f6e 652c   json_spec=None,
-00032bb0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00032bc0: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
-00032bd0: 6e5f 6465 6c65 7465 5f64 6576 6963 6528  n_delete_device(
-00032be0: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-00032bf0: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-00032c00: 3a20 6469 6374 2920 2d3e 204e 6f6e 653a  : dict) -> None:
-00032c10: 0a20 2020 2022 2222 4465 6c65 7465 2064  .    """Delete d
-00032c20: 6576 6963 6528 7329 2066 6f72 2069 7473  evice(s) for its
-00032c30: 656c 6620 6f72 206f 7468 6572 2075 7365  elf or other use
-00032c40: 7220 7768 696c 6520 616c 7265 6164 7920  r while already 
-00032c50: 6c6f 6767 6564 2069 6e2e 0a0a 2020 2020  logged in...    
-00032c60: 466f 7220 646f 6375 6d65 6e74 6174 696f  For documentatio
-00032c70: 6e20 7265 6164 3a0a 2020 2020 6874 7470  n read:.    http
-00032c80: 733a 2f2f 6d61 7472 6978 2d6e 696f 2e72  s://matrix-nio.r
-00032c90: 6561 6474 6865 646f 6373 2e69 6f2f 656e  eadthedocs.io/en
-00032ca0: 2f6c 6174 6573 742f 6e69 6f2e 6874 6d6c  /latest/nio.html
-00032cb0: 2361 7379 6e63 636c 6965 6e74 0a20 2020  #asyncclient.   
-00032cc0: 2068 7474 7073 3a2f 2f6d 6174 7269 782e   https://matrix.
-00032cd0: 6f72 672f 646f 6373 2f73 7065 632f 636c  org/docs/spec/cl
-00032ce0: 6965 6e74 5f73 6572 7665 722f 7230 2e36  ient_server/r0.6
-00032cf0: 2e30 2361 7574 6865 6e74 6963 6174 696f  .0#authenticatio
-00032d00: 6e2d 7479 7065 730a 0a20 2020 2054 6865  n-types..    The
-00032d10: 7265 2061 7265 2073 6576 6572 616c 2077  re are several w
-00032d20: 6179 7320 746f 2061 7574 6865 6e74 6963  ays to authentic
-00032d30: 6174 652c 2073 6f6d 6520 6f66 2074 6865  ate, some of the
-00032d40: 7365 2077 6179 7320 6d61 7920 6f72 206d  se ways may or m
-00032d50: 6179 206e 6f74 0a20 2020 2062 6520 7375  ay not.    be su
-00032d60: 7070 6f72 7465 6420 6279 2074 6865 2073  pported by the s
-00032d70: 6572 7665 722e 2053 6f2c 2074 6869 7320  erver. So, this 
-00032d80: 6973 2073 6572 7665 7220 7370 6563 6966  is server specif
-00032d90: 6963 2e0a 2020 2020 5468 6520 226d 2e6c  ic..    The "m.l
-00032da0: 6f67 696e 2e74 6f6b 656e 2220 6f70 7469  ogin.token" opti
-00032db0: 6f6e 2073 6565 6d73 2075 7365 6675 6c20  on seems useful 
-00032dc0: 6174 2066 6972 7374 2067 6c61 6e63 652c  at first glance,
-00032dd0: 2062 7574 206e 6f74 6520 7468 6174 0a20   but note that. 
-00032de0: 2020 2074 6869 7320 6973 204e 4f54 2061     this is NOT a
-00032df0: 6e20 6163 6365 7373 2074 6f6b 656e 2c20  n access token, 
-00032e00: 6275 7420 6120 6c6f 6769 6e20 746f 6b65  but a login toke
-00032e10: 6e20 7265 6365 6976 6564 2066 726f 6d20  n received from 
-00032e20: 736f 6d65 7768 6572 650a 2020 2020 656c  somewhere.    el
-00032e30: 7365 2e20 536f 2c20 696e 2072 6561 6c69  se. So, in reali
-00032e40: 7479 2074 6865 2022 6d2e 6c6f 6769 6e2e  ty the "m.login.
-00032e50: 746f 6b65 6e22 206f 7074 696f 6e20 6973  token" option is
-00032e60: 206e 6f74 2075 7365 6675 6c2e 0a20 2020   not useful..   
-00032e70: 207b 0a20 2020 2020 2022 7479 7065 223a   {.      "type":
-00032e80: 2022 6d2e 6c6f 6769 6e2e 746f 6b65 6e22   "m.login.token"
-00032e90: 2c0a 2020 2020 2020 2274 6f6b 656e 223a  ,.      "token":
-00032ea0: 2022 3c74 6f6b 656e 3e22 2c20 203c 3d3d   "<token>",  <==
-00032eb0: 2074 6869 7320 6973 2061 206c 6f67 696e   this is a login
-00032ec0: 2074 6f6b 656e 2c20 4e4f 5420 616e 2061   token, NOT an a
-00032ed0: 6363 6573 7320 746f 6b65 6e21 0a20 2020  ccess token!.   
-00032ee0: 2020 2022 7478 6e5f 6964 223a 2022 3c63     "txn_id": "<c
-00032ef0: 6c69 656e 7420 6765 6e65 7261 7465 6420  lient generated 
-00032f00: 6e6f 6e63 653e 222c 0a20 2020 2020 2022  nonce>",.      "
-00032f10: 7365 7373 696f 6e22 3a20 223c 7365 7373  session": "<sess
-00032f20: 696f 6e20 4944 3e22 0a20 2020 207d 0a0a  ion ID>".    }..
-00032f30: 2020 2020 5468 6520 226d 2e6c 6f67 696e      The "m.login
-00032f40: 2e73 736f 2220 6f70 7469 6f6e 2077 6f75  .sso" option wou
-00032f50: 6c64 2062 6520 7573 6566 756c 2c20 6275  ld be useful, bu
-00032f60: 7420 4920 6861 7665 6e27 7420 696d 706c  t I haven't impl
-00032f70: 656d 656e 7465 6420 6974 0a20 2020 2079  emented it.    y
-00032f80: 6574 2e20 4974 2077 6f75 6c64 2062 6520  et. It would be 
-00032f90: 6120 6269 7420 7369 6d69 6c61 7220 6173  a bit similar as
-00032fa0: 2074 6f20 7468 6520 636f 6465 2069 6e20   to the code in 
-00032fb0: 6163 7469 6f6e 5f6c 6f67 696e 2829 2e0a  action_login()..
-00032fc0: 0a20 2020 2054 6865 206d 6f73 7420 636f  .    The most co
-00032fd0: 6d6d 6f6e 206f 7074 696f 6e20 6973 2022  mmon option is "
-00032fe0: 6d2e 6c6f 6769 6e2e 7061 7373 776f 7264  m.login.password
-00032ff0: 222e 2054 6869 7320 6f70 7469 6f6e 2069  ". This option i
-00033000: 7320 696d 706c 656d 656e 7465 642e 0a20  s implemented.. 
-00033010: 2020 2022 2222 0a20 2020 2069 6620 6e6f     """.    if no
-00033020: 7420 6773 2e70 612e 7061 7373 776f 7264  t gs.pa.password
-00033030: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
-00033040: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
-00033050: 2020 2020 2245 3230 393a 2022 0a20 2020      "E209: ".   
-00033060: 2020 2020 2020 2020 2066 2246 6169 6c65           f"Faile
-00033070: 6420 746f 2064 656c 6574 6520 6465 7669  d to delete devi
-00033080: 6365 7320 6265 6361 7573 6520 2d2d 7061  ces because --pa
-00033090: 7373 776f 7264 2077 6173 206e 6f74 2073  ssword was not s
-000330a0: 6574 2e20 220a 2020 2020 2020 2020 2020  et. ".          
-000330b0: 2020 6622 287b 6773 2e70 612e 7061 7373    f"({gs.pa.pass
-000330c0: 776f 7264 7d29 220a 2020 2020 2020 2020  word})".        
-000330d0: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
-000330e0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-000330f0: 2020 2020 7265 7475 726e 0a20 2020 2065      return.    e
-00033100: 6c73 653a 0a20 2020 2020 2020 2070 6173  lse:.        pas
-00033110: 7377 6f72 6420 3d20 6773 2e70 612e 7061  sword = gs.pa.pa
-00033120: 7373 776f 7264 0a20 2020 2069 6620 6e6f  ssword.    if no
-00033130: 7420 6773 2e70 612e 7573 6572 3a0a 2020  t gs.pa.user:.  
-00033140: 2020 2020 2020 2320 6765 7420 7072 6573        # get pres
-00033150: 656e 6365 206e 616d 6520 6f66 206d 7973  ence name of mys
-00033160: 656c 660a 2020 2020 2020 2020 7573 6572  elf.        user
-00033170: 5f69 6420 3d20 6372 6564 656e 7469 616c  _id = credential
-00033180: 735b 2275 7365 725f 6964 225d 0a20 2020  s["user_id"].   
-00033190: 2065 6c73 653a 0a20 2020 2020 2020 2075   else:.        u
-000331a0: 7365 725f 6964 203d 2067 732e 7061 2e75  ser_id = gs.pa.u
-000331b0: 7365 725b 305d 0a20 2020 2020 2020 2069  ser[0].        i
-000331c0: 6620 6c65 6e28 6773 2e70 612e 7573 6572  f len(gs.pa.user
-000331d0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
-000331e0: 2020 2067 732e 6c6f 672e 7761 726e 696e     gs.log.warnin
-000331f0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00033200: 2020 2022 5731 3039 3a20 220a 2020 2020     "W109: ".    
-00033210: 2020 2020 2020 2020 2020 2020 2257 6172              "War
-00033220: 6e69 6e67 2e20 220a 2020 2020 2020 2020  ning. ".        
-00033230: 2020 2020 2020 2020 222d 2d75 7365 7220          "--user 
-00033240: 7370 6563 6966 6965 7320 6d6f 7265 2074  specifies more t
-00033250: 6865 6e20 6f6e 6520 7573 6572 2e20 4966  hen one user. If
-00033260: 202d 2d75 7365 7220 6973 2075 7365 6420   --user is used 
-00033270: 6174 2022 0a20 2020 2020 2020 2020 2020  at ".           
-00033280: 2020 2020 2022 616c 6c2c 2074 6865 6e20       "all, then 
-00033290: 6578 6163 746c 7920 6f6e 6520 7573 6572  exactly one user
-000332a0: 2073 686f 756c 6420 6265 2067 6976 656e   should be given
-000332b0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-000332c0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-000332d0: 7761 726e 5f63 6f75 6e74 202b 3d20 310a  warn_count += 1.
-000332e0: 2020 2020 6465 7669 6365 7320 3d20 6773      devices = gs
-000332f0: 2e70 612e 6465 6c65 7465 5f64 6576 6963  .pa.delete_devic
-00033300: 650a 2020 2020 2320 7468 6973 2061 7574  e.    # this aut
-00033310: 6f6d 6174 6963 616c 6c79 2065 7363 6170  omatically escap
-00033320: 6573 2074 6865 2022 206c 6574 7465 7273  es the " letters
-00033330: 2069 6e20 7468 6520 7061 7373 776f 7264   in the password
-00033340: 2c0a 2020 2020 2320 616e 6420 7461 6b65  ,.    # and take
-00033350: 7320 6361 7265 206f 6620 7370 6163 6573  s care of spaces
-00033360: 2c20 6574 632e 0a20 2020 2061 7574 6820  , etc..    auth 
-00033370: 3d20 7b0a 2020 2020 2020 2020 2274 7970  = {.        "typ
-00033380: 6522 3a20 226d 2e6c 6f67 696e 2e70 6173  e": "m.login.pas
-00033390: 7377 6f72 6422 2c0a 2020 2020 2020 2020  sword",.        
-000333a0: 2269 6465 6e74 6966 6965 7222 3a20 7b22  "identifier": {"
-000333b0: 7479 7065 223a 2022 6d2e 6964 2e75 7365  type": "m.id.use
-000333c0: 7222 2c20 2275 7365 7222 3a20 7573 6572  r", "user": user
-000333d0: 5f69 647d 2c0a 2020 2020 2020 2020 2270  _id},.        "p
-000333e0: 6173 7377 6f72 6422 3a20 7061 7373 776f  assword": passwo
-000333f0: 7264 2c0a 2020 2020 7d0a 2020 2020 7061  rd,.    }.    pa
-00033400: 7373 776f 7264 6661 6b65 203d 2022 2a2a  sswordfake = "**
-00033410: 2a22 0a20 2020 2061 7574 6866 616b 6520  *".    authfake 
-00033420: 3d20 7b0a 2020 2020 2020 2020 2274 7970  = {.        "typ
-00033430: 6522 3a20 226d 2e6c 6f67 696e 2e70 6173  e": "m.login.pas
-00033440: 7377 6f72 6422 2c0a 2020 2020 2020 2020  sword",.        
-00033450: 2269 6465 6e74 6966 6965 7222 3a20 7b22  "identifier": {"
-00033460: 7479 7065 223a 2022 6d2e 6964 2e75 7365  type": "m.id.use
-00033470: 7222 2c20 2275 7365 7222 3a20 7573 6572  r", "user": user
-00033480: 5f69 647d 2c0a 2020 2020 2020 2020 2270  _id},.        "p
-00033490: 6173 7377 6f72 6422 3a20 7061 7373 776f  assword": passwo
-000334a0: 7264 6661 6b65 2c0a 2020 2020 7d0a 2020  rdfake,.    }.  
-000334b0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
-000334c0: 2020 2020 2020 2020 6622 4162 6f75 7420          f"About 
-000334d0: 746f 2064 656c 6574 6520 6465 7669 6365  to delete device
-000334e0: 7320 7b64 6576 6963 6573 7d20 666f 7220  s {devices} for 
-000334f0: 7573 6572 207b 7573 6572 5f69 647d 2022  user {user_id} "
-00033500: 0a20 2020 2020 2020 2066 2277 6974 6820  .        f"with 
-00033510: 7061 7373 776f 7264 207b 7061 7373 776f  password {passwo
-00033520: 7264 6661 6b65 7d20 616e 6420 6175 7468  rdfake} and auth
-00033530: 207b 6175 7468 6661 6b65 7d2e 220a 2020   {authfake}.".  
-00033540: 2020 290a 2020 2020 7265 7370 203d 2061    ).    resp = a
-00033550: 7761 6974 2063 6c69 656e 742e 6465 6c65  wait client.dele
-00033560: 7465 5f64 6576 6963 6573 2864 6576 6963  te_devices(devic
-00033570: 6573 2c20 6175 7468 290a 2020 2020 6966  es, auth).    if
-00033580: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
-00033590: 2c20 4465 6c65 7465 4465 7669 6365 7345  , DeleteDevicesE
-000335a0: 7272 6f72 293a 0a20 2020 2020 2020 2067  rror):.        g
-000335b0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
-000335c0: 2020 2020 2020 2020 2022 4532 3130 3a20           "E210: 
-000335d0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-000335e0: 4661 696c 6564 2074 6f20 6465 6c65 7465  Failed to delete
-000335f0: 2064 6576 6963 6573 207b 6465 7669 6365   devices {device
-00033600: 737d 2066 6f72 2075 7365 7220 7b75 7365  s} for user {use
-00033610: 725f 6964 7d20 220a 2020 2020 2020 2020  r_id} ".        
-00033620: 2020 2020 6622 7769 7468 2070 6173 7377      f"with passw
-00033630: 6f72 6420 7b70 6173 7377 6f72 6466 616b  ord {passwordfak
-00033640: 657d 2061 6e64 2061 7574 6820 7b61 7574  e} and auth {aut
-00033650: 6866 616b 657d 2e20 220a 2020 2020 2020  hfake}. ".      
-00033660: 2020 2020 2020 6622 5265 7370 6f6e 7365        f"Response
-00033670: 3a20 7b70 7269 7661 6379 5f66 696c 7465  : {privacy_filte
-00033680: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-00033690: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000336a0: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
-000336b0: 2031 0a20 2020 2065 6c69 6620 6973 696e   1.    elif isin
-000336c0: 7374 616e 6365 2872 6573 702c 2044 656c  stance(resp, Del
-000336d0: 6574 6544 6576 6963 6573 4175 7468 5265  eteDevicesAuthRe
-000336e0: 7370 6f6e 7365 293a 0a20 2020 2020 2020  sponse):.       
-000336f0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-00033700: 2020 2020 2020 2020 2020 2022 4532 3131             "E211
-00033710: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-00033720: 6622 4661 696c 6564 2074 6f20 6465 6c65  f"Failed to dele
-00033730: 7465 2064 6576 6963 6573 207b 6465 7669  te devices {devi
-00033740: 6365 737d 2066 6f72 2075 7365 7220 7b75  ces} for user {u
-00033750: 7365 725f 6964 7d20 6475 6520 746f 2022  ser_id} due to "
-00033760: 0a20 2020 2020 2020 2020 2020 2022 6175  .            "au
-00033770: 7468 656e 7469 6361 7469 6f6e 2066 6169  thentication fai
-00033780: 6c75 7265 2e20 4172 6520 796f 7520 6175  lure. Are you au
-00033790: 7468 6f72 697a 6564 3f20 220a 2020 2020  thorized? ".    
-000337a0: 2020 2020 2020 2020 6622 4175 7468 656e          f"Authen
-000337b0: 7469 6361 7469 6f6e 3a20 7b61 7574 6866  tication: {authf
-000337c0: 616b 657d 2c20 5265 7370 6f6e 7365 3a20  ake}, Response: 
-000337d0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-000337e0: 7b70 7269 7661 6379 5f66 696c 7465 7228  {privacy_filter(
-000337f0: 7374 7228 7265 7370 2929 7d22 0a20 2020  str(resp))}".   
-00033800: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
-00033810: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00033820: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00033830: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00033840: 0a20 2020 2020 2020 2020 2020 2022 6465  .            "de
-00033850: 6c65 7465 5f64 6576 6963 6573 2073 7563  lete_devices suc
-00033860: 6365 7373 6675 6c2e 2052 6573 706f 6e73  cessful. Respons
-00033870: 6520 6973 3a20 220a 2020 2020 2020 2020  e is: ".        
-00033880: 2020 2020 6622 7b70 7269 7661 6379 5f66      f"{privacy_f
-00033890: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
-000338a0: 7d22 0a20 2020 2020 2020 2029 0a20 2020  }".        ).   
-000338b0: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
-000338c0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-000338d0: 5375 6363 6573 7366 756c 6c79 2064 656c  Successfully del
-000338e0: 6574 6564 2064 6576 6963 6573 207b 6465  eted devices {de
-000338f0: 7669 6365 737d 2066 6f72 2075 7365 7220  vices} for user 
-00033900: 7b75 7365 725f 6964 7d2e 220a 2020 2020  {user_id}.".    
-00033910: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-00033920: 6620 6163 7469 6f6e 5f72 6f6f 6d5f 7265  f action_room_re
-00033930: 6461 6374 2863 6c69 656e 743a 2041 7379  dact(client: Asy
-00033940: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
-00033950: 7469 616c 733a 2064 6963 7429 202d 3e20  tials: dict) -> 
-00033960: 4e6f 6e65 3a0a 2020 2020 2222 2252 6564  None:.    """Red
-00033970: 6163 7420 6576 656e 7428 7329 206f 6620  act event(s) of 
-00033980: 726f 6f6d 2873 2920 7768 696c 6520 616c  room(s) while al
-00033990: 7265 6164 7920 6c6f 6767 6564 2069 6e2e  ready logged in.
-000339a0: 2222 220a 2020 2020 6966 206c 656e 2867  """.    if len(g
-000339b0: 732e 7061 2e72 6f6f 6d5f 7265 6461 6374  s.pa.room_redact
-000339c0: 2920 3d3d 2032 3a0a 2020 2020 2020 2020  ) == 2:.        
-000339d0: 6773 2e70 612e 726f 6f6d 5f72 6564 6163  gs.pa.room_redac
-000339e0: 742e 6170 7065 6e64 2822 2229 0a20 2020  t.append("").   
-000339f0: 2069 6620 6e6f 7420 6c65 6e28 6773 2e70   if not len(gs.p
-00033a00: 612e 726f 6f6d 5f72 6564 6163 7429 2025  a.room_redact) %
-00033a10: 2033 203d 3d20 303a 0a20 2020 2020 2020   3 == 0:.       
-00033a20: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
-00033a30: 2020 2020 2020 2020 2020 2022 4532 3132             "E212
-00033a40: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-00033a50: 2249 6e63 6f72 7265 6374 206e 756d 6265  "Incorrect numbe
-00033a60: 7220 6f66 2061 7267 756d 656e 7473 2066  r of arguments f
-00033a70: 6f72 202d 2d72 6f6f 6d2d 7265 6461 6374  or --room-redact
-00033a80: 2e20 4172 6775 6d65 6e74 7320 6d75 7374  . Arguments must
-00033a90: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00033aa0: 2262 6520 7472 6970 6c65 732c 2069 2e65  "be triples, i.e
-00033ab0: 2e20 6d75 6c74 6970 6c65 7320 6f66 2033  . multiples of 3
-00033ac0: 2c20 6275 7420 666f 756e 6420 220a 2020  , but found ".  
-00033ad0: 2020 2020 2020 2020 2020 6622 7b6c 656e            f"{len
-00033ae0: 2867 732e 7061 2e72 6f6f 6d5f 7265 6461  (gs.pa.room_reda
-00033af0: 6374 297d 2061 7267 756d 656e 7473 2e20  ct)} arguments. 
-00033b00: 3220 6973 2061 6c73 6f20 616c 6c6f 7765  2 is also allowe
-00033b10: 642e 220a 2020 2020 2020 2020 290a 2020  d.".        ).  
-00033b20: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00033b30: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-00033b40: 7265 7475 726e 0a20 2020 2066 6f72 2069  return.    for i
-00033b50: 6920 696e 2072 616e 6765 286c 656e 2867  i in range(len(g
-00033b60: 732e 7061 2e72 6f6f 6d5f 7265 6461 6374  s.pa.room_redact
-00033b70: 2920 2f2f 2033 293a 0a20 2020 2020 2020  ) // 3):.       
-00033b80: 2072 6f6f 6d5f 6964 203d 2067 732e 7061   room_id = gs.pa
-00033b90: 2e72 6f6f 6d5f 7265 6461 6374 5b69 6920  .room_redact[ii 
-00033ba0: 2a20 3320 2b20 305d 0a20 2020 2020 2020  * 3 + 0].       
-00033bb0: 2072 6f6f 6d5f 6964 203d 2061 7761 6974   room_id = await
-00033bc0: 206d 6170 5f72 6f6f 6d69 6e66 6f5f 746f   map_roominfo_to
-00033bd0: 5f72 6f6f 6d69 6428 636c 6965 6e74 2c20  _roomid(client, 
-00033be0: 726f 6f6d 5f69 6429 0a20 2020 2020 2020  room_id).       
-00033bf0: 2065 7665 6e74 5f69 6420 3d20 6773 2e70   event_id = gs.p
-00033c00: 612e 726f 6f6d 5f72 6564 6163 745b 6969  a.room_redact[ii
-00033c10: 202a 2033 202b 2031 5d0a 2020 2020 2020   * 3 + 1].      
-00033c20: 2020 7265 6173 6f6e 203d 2067 732e 7061    reason = gs.pa
-00033c30: 2e72 6f6f 6d5f 7265 6461 6374 5b69 6920  .room_redact[ii 
-00033c40: 2a20 3320 2b20 325d 2e73 7472 6970 2829  * 3 + 2].strip()
-00033c50: 0a20 2020 2020 2020 2069 6620 7265 6173  .        if reas
-00033c60: 6f6e 203d 3d20 2222 3a0a 2020 2020 2020  on == "":.      
-00033c70: 2020 2020 2020 7265 6173 6f6e 203d 204e        reason = N
-00033c80: 6f6e 650a 2020 2020 2020 2020 6773 2e6c  one.        gs.l
-00033c90: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
-00033ca0: 2020 2020 2020 6622 5072 6570 6172 696e        f"Preparin
-00033cb0: 6720 746f 2072 6564 6163 7420 6576 656e  g to redact even
-00033cc0: 7420 7b65 7665 6e74 5f69 647d 2069 6e20  t {event_id} in 
-00033cd0: 726f 6f6d 207b 726f 6f6d 5f69 647d 2022  room {room_id} "
-00033ce0: 0a20 2020 2020 2020 2020 2020 2066 2270  .            f"p
-00033cf0: 726f 7669 6469 6e67 2072 6561 736f 6e20  roviding reason 
-00033d00: 277b 7265 6173 6f6e 7d27 2e22 0a20 2020  '{reason}'.".   
-00033d10: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00033d20: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
-00033d30: 6e74 2e72 6f6f 6d5f 7265 6461 6374 2872  nt.room_redact(r
-00033d40: 6f6f 6d5f 6964 2c20 6576 656e 745f 6964  oom_id, event_id
-00033d50: 2c20 7265 6173 6f6e 3d72 6561 736f 6e29  , reason=reason)
-00033d60: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00033d70: 7374 616e 6365 2872 6573 702c 2052 6f6f  stance(resp, Roo
-00033d80: 6d52 6564 6163 7445 7272 6f72 293a 0a20  mRedactError):. 
-00033d90: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00033da0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
-00033db0: 2020 2020 2020 2020 2022 4532 3133 3a20           "E213: 
-00033dc0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00033dd0: 2020 6622 4661 696c 6564 2074 6f20 7265    f"Failed to re
-00033de0: 6461 6374 2065 7665 6e74 207b 6576 656e  dact event {even
-00033df0: 745f 6964 7d20 696e 2072 6f6f 6d20 7b72  t_id} in room {r
-00033e00: 6f6f 6d5f 6964 7d20 220a 2020 2020 2020  oom_id} ".      
-00033e10: 2020 2020 2020 2020 2020 6622 7769 7468            f"with
-00033e20: 2072 6561 736f 6e20 277b 7265 6173 6f6e   reason '{reason
-00033e30: 7d27 2e20 220a 2020 2020 2020 2020 2020  }'. ".          
-00033e40: 2020 2020 2020 6622 5265 7370 6f6e 7365        f"Response
-00033e50: 3a20 7b70 7269 7661 6379 5f66 696c 7465  : {privacy_filte
-00033e60: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-00033e70: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00033e80: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-00033e90: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00033ea0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00033eb0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00033ec0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00033ed0: 2020 2022 726f 6f6d 5f72 6564 6163 7420     "room_redact 
-00033ee0: 7375 6363 6573 7366 756c 2e20 5265 7370  successful. Resp
-00033ef0: 6f6e 7365 2069 733a 2022 0a20 2020 2020  onse is: ".     
-00033f00: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
-00033f10: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
-00033f20: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
-00033f30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00033f40: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
-00033f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033f60: 2066 2253 7563 6365 7373 6675 6c6c 7920   f"Successfully 
-00033f70: 7265 6461 6374 6564 2065 7665 6e74 207b  redacted event {
-00033f80: 6576 656e 745f 6964 7d20 696e 2072 6f6f  event_id} in roo
-00033f90: 6d20 7b72 6f6f 6d5f 6964 7d20 220a 2020  m {room_id} ".  
-00033fa0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00033fb0: 7072 6f76 6964 696e 6720 7265 6173 6f6e  providing reason
-00033fc0: 2027 7b27 2720 6966 2072 6561 736f 6e20   '{'' if reason 
-00033fd0: 6973 204e 6f6e 6520 656c 7365 2072 6561  is None else rea
-00033fe0: 736f 6e7d 272e 220a 2020 2020 2020 2020  son}'.".        
-00033ff0: 2020 2020 290a 0a0a 6173 796e 6320 6465      )...async de
-00034000: 6620 6163 7469 6f6e 5f77 686f 616d 6928  f action_whoami(
-00034010: 636c 6965 6e74 3a20 4173 796e 6343 6c69  client: AsyncCli
-00034020: 656e 742c 2063 7265 6465 6e74 6961 6c73  ent, credentials
-00034030: 3a20 6469 6374 2920 2d3e 204e 6f6e 653a  : dict) -> None:
-00034040: 0a20 2020 2022 2222 4765 7420 7573 6572  .    """Get user
-00034050: 2069 6420 7768 696c 6520 616c 7265 6164   id while alread
-00034060: 7920 6c6f 6767 6564 2069 6e2e 2222 220a  y logged in.""".
-00034070: 2020 2020 7768 6f61 6d69 203d 2063 7265      whoami = cre
-00034080: 6465 6e74 6961 6c73 5b22 7573 6572 5f69  dentials["user_i
-00034090: 6422 5d0a 2020 2020 6773 2e6c 6f67 2e64  d"].    gs.log.d
-000340a0: 6562 7567 2866 2277 686f 616d 693a 2075  ebug(f"whoami: u
-000340b0: 7365 7220 6964 3a20 7b77 686f 616d 697d  ser id: {whoami}
-000340c0: 2229 0a20 2020 2023 206f 7574 7075 7420  ").    # output 
-000340d0: 666f 726d 6174 2063 6f6e 7472 6f6c 6c65  format controlle
-000340e0: 6420 7669 6120 2d2d 6f75 7470 7574 2066  d via --output f
-000340f0: 6c61 670a 2020 2020 7465 7874 203d 2077  lag.    text = w
-00034100: 686f 616d 690a 2020 2020 6a73 6f6e 5f6d  hoami.    json_m
-00034110: 6178 203d 207b 2275 7365 725f 6964 223a  ax = {"user_id":
-00034120: 2077 686f 616d 697d 0a20 2020 2023 206a   whoami}.    # j
-00034130: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
-00034140: 226b 6579 223a 2076 616c 7565 7d29 2020  "key": value})  
-00034150: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
-00034160: 0a20 2020 206a 736f 6e5f 203d 206a 736f  .    json_ = jso
-00034170: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
-00034180: 2023 206a 736f 6e5f 2e70 6f70 2822 6b65   # json_.pop("ke
-00034190: 7922 290a 2020 2020 6a73 6f6e 5f73 7065  y").    json_spe
-000341a0: 6320 3d20 4e6f 6e65 0a20 2020 2070 7269  c = None.    pri
-000341b0: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
-000341c0: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
-000341d0: 0a20 2020 2020 2020 2074 6578 743d 7465  .        text=te
-000341e0: 7874 2c0a 2020 2020 2020 2020 6a73 6f6e  xt,.        json
-000341f0: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
-00034200: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
-00034210: 6178 2c0a 2020 2020 2020 2020 6a73 6f6e  ax,.        json
-00034220: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
-00034230: 0a20 2020 2029 0a0a 0a61 7379 6e63 2064  .    )...async d
-00034240: 6566 2061 6374 696f 6e5f 726f 6f6d 7365  ef action_roomse
-00034250: 7467 6574 2829 202d 3e20 4e6f 6e65 3a0a  tget() -> None:.
-00034260: 2020 2020 2222 2250 6572 666f 726d 2072      """Perform r
-00034270: 6f6f 6d2c 2067 6574 2c20 7365 7420 6163  oom, get, set ac
-00034280: 7469 6f6e 7320 7768 696c 6520 6265 696e  tions while bein
-00034290: 6720 6c6f 6767 6564 2069 6e2e 2222 220a  g logged in.""".
-000342a0: 2020 2020 6966 206e 6f74 2067 732e 636c      if not gs.cl
-000342b0: 6965 6e74 2061 6e64 206e 6f74 2067 732e  ient and not gs.
-000342c0: 6372 6564 656e 7469 616c 733a 0a20 2020  credentials:.   
-000342d0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
-000342e0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-000342f0: 4532 3134 3a20 2220 2243 6c69 656e 7420  E214: " "Client 
-00034300: 6f72 2063 7265 6465 6e74 6961 6c73 206e  or credentials n
-00034310: 6f74 2073 6574 2e20 536b 6970 7069 6e67  ot set. Skipping
-00034320: 2061 6374 696f 6e2e 220a 2020 2020 2020   action.".      
-00034330: 2020 290a 2020 2020 2020 2020 6773 2e65    ).        gs.e
-00034340: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-00034350: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00034360: 2074 7279 3a0a 2020 2020 2020 2020 2320   try:.        # 
-00034370: 726f 6f6d 5f61 6374 696f 6e0a 2020 2020  room_action.    
-00034380: 2020 2020 2320 7765 2061 6c72 6561 6479      # we already
-00034390: 2063 6865 636b 6564 2061 7267 7320 6174   checked args at
-000343a0: 2074 6865 2062 6567 696e 6e69 6e67 2c20   the beginning, 
-000343b0: 6e6f 206e 6565 6420 746f 2063 6865 636b  no need to check
-000343c0: 0a20 2020 2020 2020 2023 2072 6f6f 6d20  .        # room 
-000343d0: 616e 6420 7573 6572 2061 7267 756d 656e  and user argumen
-000343e0: 7420 636f 6d62 696e 6174 696f 6e73 2061  t combinations a
-000343f0: 6761 696e 2e0a 2020 2020 2020 2020 2320  gain..        # 
-00034400: 726f 6f6d 2073 6574 2061 6374 696f 6e73  room set actions
-00034410: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-00034420: 612e 726f 6f6d 5f63 7265 6174 653a 0a20  a.room_create:. 
-00034430: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00034440: 2061 6374 696f 6e5f 726f 6f6d 5f63 7265   action_room_cre
-00034450: 6174 6528 6773 2e63 6c69 656e 742c 2067  ate(gs.client, g
-00034460: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00034470: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-00034480: 726f 6f6d 5f64 6d5f 6372 6561 7465 3a0a  room_dm_create:.
-00034490: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-000344a0: 7420 6163 7469 6f6e 5f72 6f6f 6d5f 646d  t action_room_dm
-000344b0: 5f63 7265 6174 6528 6773 2e63 6c69 656e  _create(gs.clien
-000344c0: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-000344d0: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-000344e0: 2e70 612e 726f 6f6d 5f6a 6f69 6e3a 0a20  .pa.room_join:. 
-000344f0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00034500: 2061 6374 696f 6e5f 726f 6f6d 5f6a 6f69   action_room_joi
-00034510: 6e28 6773 2e63 6c69 656e 742c 2067 732e  n(gs.client, gs.
-00034520: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-00034530: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
-00034540: 6f6d 5f6c 6561 7665 3a0a 2020 2020 2020  om_leave:.      
-00034550: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
-00034560: 6f6e 5f72 6f6f 6d5f 6c65 6176 6528 6773  on_room_leave(gs
-00034570: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
-00034580: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
-00034590: 2069 6620 6773 2e70 612e 726f 6f6d 5f66   if gs.pa.room_f
-000345a0: 6f72 6765 743a 0a20 2020 2020 2020 2020  orget:.         
-000345b0: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
-000345c0: 726f 6f6d 5f66 6f72 6765 7428 6773 2e63  room_forget(gs.c
-000345d0: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
-000345e0: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
-000345f0: 6620 6773 2e70 612e 726f 6f6d 5f69 6e76  f gs.pa.room_inv
-00034600: 6974 6520 616e 6420 6773 2e70 612e 7573  ite and gs.pa.us
-00034610: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-00034620: 6177 6169 7420 6163 7469 6f6e 5f72 6f6f  await action_roo
-00034630: 6d5f 696e 7669 7465 2867 732e 636c 6965  m_invite(gs.clie
-00034640: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
-00034650: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
-00034660: 732e 7061 2e72 6f6f 6d5f 6261 6e20 616e  s.pa.room_ban an
-00034670: 6420 6773 2e70 612e 7573 6572 3a0a 2020  d gs.pa.user:.  
-00034680: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00034690: 6163 7469 6f6e 5f72 6f6f 6d5f 6261 6e28  action_room_ban(
-000346a0: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
-000346b0: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
-000346c0: 2020 2069 6620 6773 2e70 612e 726f 6f6d     if gs.pa.room
-000346d0: 5f75 6e62 616e 2061 6e64 2067 732e 7061  _unban and gs.pa
-000346e0: 2e75 7365 723a 0a20 2020 2020 2020 2020  .user:.         
-000346f0: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
-00034700: 726f 6f6d 5f75 6e62 616e 2867 732e 636c  room_unban(gs.cl
-00034710: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-00034720: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-00034730: 2067 732e 7061 2e72 6f6f 6d5f 6b69 636b   gs.pa.room_kick
-00034740: 2061 6e64 2067 732e 7061 2e75 7365 723a   and gs.pa.user:
-00034750: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00034760: 6974 2061 6374 696f 6e5f 726f 6f6d 5f6b  it action_room_k
-00034770: 6963 6b28 6773 2e63 6c69 656e 742c 2067  ick(gs.client, g
-00034780: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00034790: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-000347a0: 726f 6f6d 5f72 6564 6163 743a 0a20 2020  room_redact:.   
-000347b0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-000347c0: 6374 696f 6e5f 726f 6f6d 5f72 6564 6163  ction_room_redac
-000347d0: 7428 6773 2e63 6c69 656e 742c 2067 732e  t(gs.client, gs.
-000347e0: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-000347f0: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
-00034800: 6f6d 5f73 6574 5f61 6c69 6173 3a0a 2020  om_set_alias:.  
-00034810: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00034820: 6163 7469 6f6e 5f72 6f6f 6d5f 7365 745f  action_room_set_
-00034830: 616c 6961 7328 6773 2e63 6c69 656e 742c  alias(gs.client,
-00034840: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
-00034850: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-00034860: 612e 726f 6f6d 5f64 656c 6574 655f 616c  a.room_delete_al
-00034870: 6961 733a 0a20 2020 2020 2020 2020 2020  ias:.           
-00034880: 2061 7761 6974 2061 6374 696f 6e5f 726f   await action_ro
-00034890: 6f6d 5f64 656c 6574 655f 616c 6961 7328  om_delete_alias(
-000348a0: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
-000348b0: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
-000348c0: 2020 2023 2072 6f6f 6d20 6765 7420 6163     # room get ac
-000348d0: 7469 6f6e 730a 2020 2020 2020 2020 6966  tions.        if
-000348e0: 2067 732e 7061 2e72 6f6f 6d5f 6765 745f   gs.pa.room_get_
-000348f0: 7669 7369 6269 6c69 7479 2069 7320 6e6f  visibility is no
-00034900: 7420 4e6f 6e65 3a20 2023 2065 6d70 7479  t None:  # empty
-00034910: 205b 5d20 6d75 7374 2069 6e76 6f6b 6520   [] must invoke 
-00034920: 6675 6e63 0a20 2020 2020 2020 2020 2020  func.           
-00034930: 2061 7761 6974 2061 6374 696f 6e5f 726f   await action_ro
-00034940: 6f6d 5f67 6574 5f76 6973 6962 696c 6974  om_get_visibilit
-00034950: 7928 6773 2e63 6c69 656e 742c 2067 732e  y(gs.client, gs.
-00034960: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-00034970: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
-00034980: 6f6d 5f67 6574 5f73 7461 7465 2069 7320  om_get_state is 
-00034990: 6e6f 7420 4e6f 6e65 3a20 2023 2065 6d70  not None:  # emp
-000349a0: 7479 206c 6973 7420 6d75 7374 2069 6e76  ty list must inv
-000349b0: 6f6b 6520 6675 6e63 0a20 2020 2020 2020  oke func.       
-000349c0: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
-000349d0: 6e5f 726f 6f6d 5f67 6574 5f73 7461 7465  n_room_get_state
-000349e0: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
-000349f0: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00034a00: 2020 2020 6966 2067 732e 7061 2e72 6f6f      if gs.pa.roo
-00034a10: 6d5f 7265 736f 6c76 655f 616c 6961 733a  m_resolve_alias:
-00034a20: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00034a30: 6974 2061 6374 696f 6e5f 726f 6f6d 5f72  it action_room_r
-00034a40: 6573 6f6c 7665 5f61 6c69 6173 2867 732e  esolve_alias(gs.
-00034a50: 636c 6965 6e74 2c20 6773 2e63 7265 6465  client, gs.crede
-00034a60: 6e74 6961 6c73 290a 2020 2020 2020 2020  ntials).        
-00034a70: 6966 2067 732e 726f 6f6d 5f61 6374 696f  if gs.room_actio
-00034a80: 6e3a 0a20 2020 2020 2020 2020 2020 2067  n:.            g
-00034a90: 732e 6c6f 672e 6465 6275 6728 2252 6f6f  s.log.debug("Roo
-00034aa0: 6d20 6163 7469 6f6e 2873 2920 7765 7265  m action(s) were
-00034ab0: 2070 6572 666f 726d 6564 206f 7220 6174   performed or at
-00034ac0: 7465 6d70 7465 642e 2229 0a0a 2020 2020  tempted.")..    
-00034ad0: 2020 2020 2320 7365 745f 6163 7469 6f6e      # set_action
-00034ae0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-00034af0: 612e 7365 745f 6469 7370 6c61 795f 6e61  a.set_display_na
-00034b00: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
-00034b10: 6177 6169 7420 6163 7469 6f6e 5f73 6574  await action_set
-00034b20: 5f64 6973 706c 6179 5f6e 616d 6528 6773  _display_name(gs
-00034b30: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
-00034b40: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
-00034b50: 2069 6620 6773 2e70 612e 7365 745f 6465   if gs.pa.set_de
-00034b60: 7669 6365 5f6e 616d 653a 0a20 2020 2020  vice_name:.     
-00034b70: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-00034b80: 696f 6e5f 7365 745f 6465 7669 6365 5f6e  ion_set_device_n
-00034b90: 616d 6528 6773 2e63 6c69 656e 742c 2067  ame(gs.client, g
-00034ba0: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00034bb0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-00034bc0: 7365 745f 7072 6573 656e 6365 3a0a 2020  set_presence:.  
-00034bd0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00034be0: 6163 7469 6f6e 5f73 6574 5f70 7265 7365  action_set_prese
-00034bf0: 6e63 6528 6773 2e63 6c69 656e 742c 2067  nce(gs.client, g
-00034c00: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00034c10: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-00034c20: 7570 6c6f 6164 3a0a 2020 2020 2020 2020  upload:.        
-00034c30: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
-00034c40: 5f75 706c 6f61 6428 6773 2e63 6c69 656e  _upload(gs.clien
-00034c50: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-00034c60: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00034c70: 2e70 612e 6465 6c65 7465 5f6d 7863 3a0a  .pa.delete_mxc:.
-00034c80: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00034c90: 7420 6163 7469 6f6e 5f64 656c 6574 655f  t action_delete_
-00034ca0: 6d78 6328 6773 2e63 6c69 656e 742c 2067  mxc(gs.client, g
-00034cb0: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00034cc0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-00034cd0: 6465 6c65 7465 5f6d 7863 5f62 6566 6f72  delete_mxc_befor
-00034ce0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00034cf0: 7761 6974 2061 6374 696f 6e5f 6465 6c65  wait action_dele
-00034d00: 7465 5f6d 7863 5f62 6566 6f72 6528 6773  te_mxc_before(gs
-00034d10: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
-00034d20: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
-00034d30: 2069 6620 6773 2e70 612e 7265 7374 3a0a   if gs.pa.rest:.
-00034d40: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00034d50: 7420 6163 7469 6f6e 5f72 6573 7428 6773  t action_rest(gs
-00034d60: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
-00034d70: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
-00034d80: 2069 6620 6773 2e70 612e 7365 745f 6176   if gs.pa.set_av
-00034d90: 6174 6172 3a0a 2020 2020 2020 2020 2020  atar:.          
-00034da0: 2020 6177 6169 7420 6163 7469 6f6e 5f73    await action_s
-00034db0: 6574 5f61 7661 7461 7228 6773 2e63 6c69  et_avatar(gs.cli
-00034dc0: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
-00034dd0: 616c 7329 0a20 2020 2020 2020 2069 6620  als).        if 
-00034de0: 6773 2e70 612e 696d 706f 7274 5f6b 6579  gs.pa.import_key
-00034df0: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
-00034e00: 7761 6974 2061 6374 696f 6e5f 696d 706f  wait action_impo
-00034e10: 7274 5f6b 6579 7328 6773 2e63 6c69 656e  rt_keys(gs.clien
-00034e20: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-00034e30: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00034e40: 2e70 612e 6465 6c65 7465 5f64 6576 6963  .pa.delete_devic
-00034e50: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00034e60: 7761 6974 2061 6374 696f 6e5f 6465 6c65  wait action_dele
-00034e70: 7465 5f64 6576 6963 6528 6773 2e63 6c69  te_device(gs.cli
-00034e80: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
-00034e90: 616c 7329 0a0a 2020 2020 2020 2020 2320  als)..        # 
-00034ea0: 6765 745f 6163 7469 6f6e 0a20 2020 2020  get_action.     
-00034eb0: 2020 2069 6620 6773 2e70 612e 6765 745f     if gs.pa.get_
-00034ec0: 6469 7370 6c61 795f 6e61 6d65 3a0a 2020  display_name:.  
-00034ed0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00034ee0: 6163 7469 6f6e 5f67 6574 5f64 6973 706c  action_get_displ
-00034ef0: 6179 5f6e 616d 6528 6773 2e63 6c69 656e  ay_name(gs.clien
-00034f00: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-00034f10: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00034f20: 2e70 612e 6765 745f 7072 6573 656e 6365  .pa.get_presence
-00034f30: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00034f40: 6169 7420 6163 7469 6f6e 5f67 6574 5f70  ait action_get_p
-00034f50: 7265 7365 6e63 6528 6773 2e63 6c69 656e  resence(gs.clien
-00034f60: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-00034f70: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00034f80: 2e70 612e 646f 776e 6c6f 6164 3a0a 2020  .pa.download:.  
-00034f90: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00034fa0: 6163 7469 6f6e 5f64 6f77 6e6c 6f61 6428  action_download(
-00034fb0: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
-00034fc0: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
-00034fd0: 2020 2069 6620 6773 2e70 612e 6a6f 696e     if gs.pa.join
-00034fe0: 6564 5f72 6f6f 6d73 3a0a 2020 2020 2020  ed_rooms:.      
-00034ff0: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
-00035000: 6f6e 5f6a 6f69 6e65 645f 726f 6f6d 7328  on_joined_rooms(
-00035010: 6773 2e63 6c69 656e 742c 2067 732e 6372  gs.client, gs.cr
-00035020: 6564 656e 7469 616c 7329 0a20 2020 2020  edentials).     
-00035030: 2020 2069 6620 6773 2e70 612e 6a6f 696e     if gs.pa.join
-00035040: 6564 5f6d 656d 6265 7273 3a0a 2020 2020  ed_members:.    
-00035050: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
-00035060: 7469 6f6e 5f6a 6f69 6e65 645f 6d65 6d62  tion_joined_memb
-00035070: 6572 7328 6773 2e63 6c69 656e 742c 2067  ers(gs.client, g
-00035080: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
-00035090: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
-000350a0: 6d78 635f 746f 5f68 7474 703a 0a20 2020  mxc_to_http:.   
-000350b0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-000350c0: 6374 696f 6e5f 6d78 635f 746f 5f68 7474  ction_mxc_to_htt
-000350d0: 7028 6773 2e63 6c69 656e 742c 2067 732e  p(gs.client, gs.
-000350e0: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-000350f0: 2020 2020 2069 6620 6773 2e70 612e 6465       if gs.pa.de
-00035100: 7669 6365 733a 0a20 2020 2020 2020 2020  vices:.         
-00035110: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
-00035120: 6465 7669 6365 7328 6773 2e63 6c69 656e  devices(gs.clien
-00035130: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-00035140: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00035150: 2e70 612e 6469 7363 6f76 6572 795f 696e  .pa.discovery_in
-00035160: 666f 3a0a 2020 2020 2020 2020 2020 2020  fo:.            
-00035170: 6177 6169 7420 6163 7469 6f6e 5f64 6973  await action_dis
-00035180: 636f 7665 7279 5f69 6e66 6f28 6773 2e63  covery_info(gs.c
-00035190: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
-000351a0: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
-000351b0: 6620 6773 2e70 612e 6c6f 6769 6e5f 696e  f gs.pa.login_in
-000351c0: 666f 3a0a 2020 2020 2020 2020 2020 2020  fo:.            
-000351d0: 6177 6169 7420 6163 7469 6f6e 5f6c 6f67  await action_log
-000351e0: 696e 5f69 6e66 6f28 6773 2e63 6c69 656e  in_info(gs.clien
-000351f0: 742c 2067 732e 6372 6564 656e 7469 616c  t, gs.credential
-00035200: 7329 0a20 2020 2020 2020 2069 6620 6773  s).        if gs
-00035210: 2e70 612e 636f 6e74 656e 745f 7265 706f  .pa.content_repo
-00035220: 7369 746f 7279 5f63 6f6e 6669 673a 0a20  sitory_config:. 
-00035230: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00035240: 2061 6374 696f 6e5f 636f 6e74 656e 745f   action_content_
-00035250: 7265 706f 7369 746f 7279 5f63 6f6e 6669  repository_confi
-00035260: 6728 6773 2e63 6c69 656e 742c 2067 732e  g(gs.client, gs.
-00035270: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
-00035280: 2020 2020 2069 6620 6773 2e70 612e 6765       if gs.pa.ge
-00035290: 745f 6176 6174 6172 2069 7320 6e6f 7420  t_avatar is not 
-000352a0: 4e6f 6e65 3a20 2023 2065 6d70 7479 206c  None:  # empty l
-000352b0: 6973 7420 6d75 7374 2069 6e76 6f6b 6520  ist must invoke 
-000352c0: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
-000352d0: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
-000352e0: 6e5f 6765 745f 6176 6174 6172 2867 732e  n_get_avatar(gs.
-000352f0: 636c 6965 6e74 2c20 6773 2e63 7265 6465  client, gs.crede
-00035300: 6e74 6961 6c73 290a 2020 2020 2020 2020  ntials).        
-00035310: 6966 2067 732e 7061 2e67 6574 5f70 726f  if gs.pa.get_pro
-00035320: 6669 6c65 2069 7320 6e6f 7420 4e6f 6e65  file is not None
-00035330: 3a20 2023 2065 6d70 7479 206c 6973 7420  :  # empty list 
-00035340: 6d75 7374 2069 6e76 6f6b 6520 6675 6e63  must invoke func
-00035350: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00035360: 2061 7761 6974 2061 6374 696f 6e5f 6765   await action_ge
-00035370: 745f 7072 6f66 696c 6528 6773 2e63 6c69  t_profile(gs.cli
-00035380: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
-00035390: 616c 7329 0a20 2020 2020 2020 2069 6620  als).        if 
-000353a0: 6773 2e70 612e 6765 745f 726f 6f6d 5f69  gs.pa.get_room_i
-000353b0: 6e66 6f20 6973 206e 6f74 204e 6f6e 653a  nfo is not None:
-000353c0: 2020 2320 656d 7074 7920 6c69 7374 206d    # empty list m
-000353d0: 7573 7420 696e 766f 6b65 2066 756e 6374  ust invoke funct
-000353e0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-000353f0: 6177 6169 7420 6163 7469 6f6e 5f67 6574  await action_get
-00035400: 5f72 6f6f 6d5f 696e 666f 2867 732e 636c  _room_info(gs.cl
-00035410: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
-00035420: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
-00035430: 2067 732e 7061 2e67 6574 5f63 6c69 656e   gs.pa.get_clien
-00035440: 745f 696e 666f 3a0a 2020 2020 2020 2020  t_info:.        
-00035450: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
-00035460: 5f67 6574 5f63 6c69 656e 745f 696e 666f  _get_client_info
-00035470: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
-00035480: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
-00035490: 2020 2020 6966 2067 732e 7061 2e68 6173      if gs.pa.has
-000354a0: 5f70 6572 6d69 7373 696f 6e3a 0a20 2020  _permission:.   
-000354b0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-000354c0: 6374 696f 6e5f 6861 735f 7065 726d 6973  ction_has_permis
-000354d0: 7369 6f6e 2867 732e 636c 6965 6e74 2c20  sion(gs.client, 
-000354e0: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
-000354f0: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-00035500: 2e65 7870 6f72 745f 6b65 7973 3a0a 2020  .export_keys:.  
-00035510: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00035520: 6163 7469 6f6e 5f65 7870 6f72 745f 6b65  action_export_ke
-00035530: 7973 2867 732e 636c 6965 6e74 2c20 6773  ys(gs.client, gs
-00035540: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
-00035550: 2020 2020 2020 6966 2067 732e 7061 2e67        if gs.pa.g
-00035560: 6574 5f6f 7065 6e69 645f 746f 6b65 6e20  et_openid_token 
-00035570: 6973 206e 6f74 204e 6f6e 653a 2020 2320  is not None:  # 
-00035580: 656d 7074 7920 6c69 7374 206d 7573 7420  empty list must 
-00035590: 696e 766f 6b65 2066 756e 630a 2020 2020  invoke func.    
-000355a0: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
-000355b0: 7469 6f6e 5f67 6574 5f6f 7065 6e69 645f  tion_get_openid_
-000355c0: 746f 6b65 6e28 6773 2e63 6c69 656e 742c  token(gs.client,
-000355d0: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
-000355e0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
-000355f0: 612e 7768 6f61 6d69 3a0a 2020 2020 2020  a.whoami:.      
-00035600: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
-00035610: 6f6e 5f77 686f 616d 6928 6773 2e63 6c69  on_whoami(gs.cli
-00035620: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
-00035630: 616c 7329 0a20 2020 2020 2020 2069 6620  als).        if 
-00035640: 6773 2e73 6574 6765 745f 6163 7469 6f6e  gs.setget_action
-00035650: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
-00035660: 2e6c 6f67 2e64 6562 7567 2822 5365 7420  .log.debug("Set 
-00035670: 6f72 2067 6574 2061 6374 696f 6e28 7329  or get action(s)
-00035680: 2077 6572 6520 7065 7266 6f72 6d65 6420   were performed 
-00035690: 6f72 2061 7474 656d 7074 6564 2e22 290a  or attempted.").
-000356a0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000356b0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-000356c0: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
-000356d0: 0a20 2020 2020 2020 2020 2020 2022 4532  .            "E2
-000356e0: 3135 3a20 220a 2020 2020 2020 2020 2020  15: ".          
-000356f0: 2020 2245 7272 6f72 2064 7572 696e 6720    "Error during 
-00035700: 726f 6f6d 2c20 7365 742c 2067 6574 2061  room, set, get a
-00035710: 6374 696f 6e73 2e20 436f 6e74 696e 7569  ctions. Continui
-00035720: 6e67 2064 6573 7069 7465 2065 7272 6f72  ng despite error
-00035730: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-00035740: 6622 4578 6365 7074 696f 6e3a 207b 657d  f"Exception: {e}
-00035750: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00035760: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00035770: 2822 4865 7265 2069 7320 7468 6520 7472  ("Here is the tr
-00035780: 6163 6562 6163 6b2e 5c6e 2220 2b20 7472  aceback.\n" + tr
-00035790: 6163 6562 6163 6b2e 666f 726d 6174 5f65  aceback.format_e
-000357a0: 7863 2829 290a 2020 2020 2020 2020 6773  xc()).        gs
-000357b0: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-000357c0: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
-000357d0: 6f6e 5f76 6572 6966 7928 2920 2d3e 204e  on_verify() -> N
-000357e0: 6f6e 653a 0a20 2020 2022 2222 5665 7269  one:.    """Veri
-000357f0: 6679 2077 6869 6c65 2061 6c72 6561 6479  fy while already
-00035800: 206c 6f67 6765 6420 696e 2e22 2222 0a20   logged in.""". 
-00035810: 2020 2069 6620 6e6f 7420 6773 2e63 6c69     if not gs.cli
-00035820: 656e 7420 616e 6420 6e6f 7420 6773 2e63  ent and not gs.c
-00035830: 7265 6465 6e74 6961 6c73 3a0a 2020 2020  redentials:.    
-00035840: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00035850: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
-00035860: 3231 363a 2022 2022 436c 6965 6e74 206f  216: " "Client o
-00035870: 7220 6372 6564 656e 7469 616c 7320 6e6f  r credentials no
-00035880: 7420 7365 742e 2053 6b69 7070 696e 6720  t set. Skipping 
-00035890: 6163 7469 6f6e 2e22 0a20 2020 2020 2020  action.".       
-000358a0: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
-000358b0: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-000358c0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-000358d0: 7472 793a 0a20 2020 2020 2020 2023 2053  try:.        # S
-000358e0: 6574 2075 7020 6576 656e 7420 6361 6c6c  et up event call
-000358f0: 6261 636b 730a 2020 2020 2020 2020 6361  backs.        ca
-00035900: 6c6c 6261 636b 7320 3d20 4361 6c6c 6261  llbacks = Callba
-00035910: 636b 7328 6773 2e63 6c69 656e 7429 0a20  cks(gs.client). 
-00035920: 2020 2020 2020 2067 732e 636c 6965 6e74         gs.client
-00035930: 2e61 6464 5f74 6f5f 6465 7669 6365 5f63  .add_to_device_c
-00035940: 616c 6c62 6163 6b28 0a20 2020 2020 2020  allback(.       
-00035950: 2020 2020 2063 616c 6c62 6163 6b73 2e74       callbacks.t
-00035960: 6f5f 6465 7669 6365 5f63 616c 6c62 6163  o_device_callbac
-00035970: 6b2c 2028 4b65 7956 6572 6966 6963 6174  k, (KeyVerificat
-00035980: 696f 6e45 7665 6e74 2c29 0a20 2020 2020  ionEvent,).     
-00035990: 2020 2029 0a20 2020 2020 2020 2023 2053     ).        # S
-000359a0: 796e 6320 656e 6372 7970 7469 6f6e 206b  ync encryption k
-000359b0: 6579 7320 7769 7468 2074 6865 2073 6572  eys with the ser
-000359c0: 7665 720a 2020 2020 2020 2020 2320 5265  ver.        # Re
-000359d0: 7175 6972 6564 2066 6f72 2070 6172 7469  quired for parti
-000359e0: 6369 7061 7469 6e67 2069 6e20 656e 6372  cipating in encr
-000359f0: 7970 7465 6420 726f 6f6d 730a 2020 2020  ypted rooms.    
-00035a00: 2020 2020 6966 2067 732e 636c 6965 6e74      if gs.client
-00035a10: 2e73 686f 756c 645f 7570 6c6f 6164 5f6b  .should_upload_k
-00035a20: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-00035a30: 2061 7761 6974 2067 732e 636c 6965 6e74   await gs.client
-00035a40: 2e6b 6579 735f 7570 6c6f 6164 2829 0a20  .keys_upload(). 
-00035a50: 2020 2020 2020 2070 7269 6e74 280a 2020         print(.  
-00035a60: 2020 2020 2020 2020 2020 6622 7b50 524f            f"{PRO
-00035a70: 475f 5749 5448 4f55 545f 4558 547d 2069  G_WITHOUT_EXT} i
-00035a80: 7320 7265 6164 7920 616e 6420 7761 6974  s ready and wait
-00035a90: 696e 6720 666f 7220 7468 6520 6f74 6865  ing for the othe
-00035aa0: 7220 7061 7274 7920 746f 2022 0a20 2020  r party to ".   
-00035ab0: 2020 2020 2020 2020 2022 696e 6974 6961           "initia
-00035ac0: 7465 2061 6e20 656d 6f6a 6920 7665 7269  te an emoji veri
-00035ad0: 6669 6361 7469 6f6e 2077 6974 6820 7573  fication with us
-00035ae0: 2062 7920 7365 6c65 6374 696e 6720 220a   by selecting ".
-00035af0: 2020 2020 2020 2020 2020 2020 2227 5665              "'Ve
-00035b00: 7269 6679 2062 7920 456d 6f6a 6927 2022  rify by Emoji' "
-00035b10: 0a20 2020 2020 2020 2020 2020 2022 696e  .            "in
-00035b20: 2074 6865 6972 204d 6174 7269 7820 636c   their Matrix cl
-00035b30: 6965 6e74 2e20 5265 6164 202d 2d76 6572  ient. Read --ver
-00035b40: 6966 7920 696e 7374 7275 6374 696f 6e73  ify instructions
-00035b50: 2069 6e20 2d2d 6d61 6e75 616c 2022 0a20   in --manual ". 
-00035b60: 2020 2020 2020 2020 2020 2022 6361 7265             "care
-00035b70: 6675 6c6c 7920 746f 2061 7373 6973 7420  fully to assist 
-00035b80: 796f 7520 696e 2068 6f77 2074 6f20 646f  you in how to do
-00035b90: 2074 6869 7320 7175 6963 6b6c 792e 222c   this quickly.",
-00035ba0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00035bb0: 653d 7379 732e 7374 646f 7574 2c0a 2020  e=sys.stdout,.  
-00035bc0: 2020 2020 2020 2020 2020 666c 7573 683d            flush=
-00035bd0: 5472 7565 2c0a 2020 2020 2020 2020 290a  True,.        ).
-00035be0: 2020 2020 2020 2020 2320 7468 6520 7379          # the sy
-00035bf0: 6e63 5f6c 6f6f 7020 7769 6c6c 2062 6520  nc_loop will be 
-00035c00: 7465 726d 696e 6174 6564 2062 7920 7573  terminated by us
-00035c10: 6572 2068 6974 7469 6e67 2043 6f6e 7472  er hitting Contr
-00035c20: 6f6c 2d43 0a20 2020 2020 2020 2061 7761  ol-C.        awa
-00035c30: 6974 2067 732e 636c 6965 6e74 2e73 796e  it gs.client.syn
-00035c40: 635f 666f 7265 7665 7228 7469 6d65 6f75  c_forever(timeou
-00035c50: 743d 3330 3030 302c 2066 756c 6c5f 7374  t=30000, full_st
-00035c60: 6174 653d 5472 7565 290a 2020 2020 6578  ate=True).    ex
-00035c70: 6365 7074 204b 6579 626f 6172 6449 6e74  cept KeyboardInt
-00035c80: 6572 7275 7074 3a0a 2020 2020 2020 2020  errupt:.        
-00035c90: 2320 5468 6973 2077 696c 6c20 6e65 7665  # This will neve
-00035ca0: 7220 6265 2063 6175 6768 742e 2049 2064  r be caught. I d
-00035cb0: 6f20 6e6f 7420 6b6e 6f77 2077 6879 2e0a  o not know why..
-00035cc0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-00035cd0: 6562 7567 2822 4b65 7962 6f61 7264 2069  ebug("Keyboard i
-00035ce0: 6e74 6572 7275 7074 2061 6674 6572 2045  nterrupt after E
-00035cf0: 6d6f 6a69 2076 6572 6966 6963 6174 696f  moji verificatio
-00035d00: 6e2e 2229 0a20 2020 2065 7863 6570 7420  n.").    except 
-00035d10: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-00035d20: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
-00035d30: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00035d40: 2020 2245 3231 373a 2022 0a20 2020 2020    "E217: ".     
-00035d50: 2020 2020 2020 2022 4572 726f 7220 6475         "Error du
-00035d60: 7269 6e67 2076 6572 6966 792e 2043 6f6e  ring verify. Con
-00035d70: 7469 6e75 696e 6720 6465 7370 6974 6520  tinuing despite 
-00035d80: 6572 726f 722e 2022 0a20 2020 2020 2020  error. ".       
-00035d90: 2020 2020 2066 2245 7863 6570 7469 6f6e       f"Exception
-00035da0: 3a20 7b65 7d22 0a20 2020 2020 2020 2029  : {e}".        )
-00035db0: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
-00035dc0: 636f 756e 7420 2b3d 2031 0a0a 0a61 7379  count += 1...asy
-00035dd0: 6e63 2064 6566 2061 6374 696f 6e5f 7365  nc def action_se
-00035de0: 6e64 2829 202d 3e20 4e6f 6e65 3a0a 2020  nd() -> None:.  
-00035df0: 2020 2222 2253 656e 6420 6d65 7373 6167    """Send messag
-00035e00: 6573 2077 6869 6c65 2061 6c72 6561 6479  es while already
-00035e10: 206c 6f67 6765 6420 696e 2e22 2222 0a20   logged in.""". 
-00035e20: 2020 2069 6620 6e6f 7420 6773 2e63 6c69     if not gs.cli
-00035e30: 656e 7420 616e 6420 6e6f 7420 6773 2e63  ent and not gs.c
-00035e40: 7265 6465 6e74 6961 6c73 3a0a 2020 2020  redentials:.    
-00035e50: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
-00035e60: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
-00035e70: 3231 383a 2022 2022 436c 6965 6e74 206f  218: " "Client o
-00035e80: 7220 6372 6564 656e 7469 616c 7320 6e6f  r credentials no
-00035e90: 7420 7365 742e 2053 6b69 7070 696e 6720  t set. Skipping 
-00035ea0: 6163 7469 6f6e 2e22 0a20 2020 2020 2020  action.".       
-00035eb0: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
-00035ec0: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-00035ed0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00035ee0: 7472 793a 0a20 2020 2020 2020 2023 2061  try:.        # a
-00035ef0: 2066 6577 206d 6f72 6520 7374 6570 7320   few more steps 
-00035f00: 746f 2070 7265 7061 7265 2066 6f72 2073  to prepare for s
-00035f10: 656e 6469 6e67 206d 6573 7361 6765 730a  ending messages.
-00035f20: 2020 2020 2020 2020 726f 6f6d 7320 3d20          rooms = 
-00035f30: 6177 6169 7420 6465 7465 726d 696e 655f  await determine_
-00035f40: 726f 6f6d 7328 0a20 2020 2020 2020 2020  rooms(.         
-00035f50: 2020 2067 732e 6372 6564 656e 7469 616c     gs.credential
-00035f60: 735b 2272 6f6f 6d5f 6964 225d 2c20 6773  s["room_id"], gs
-00035f70: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
-00035f80: 656e 7469 616c 730a 2020 2020 2020 2020  entials.        
-00035f90: 290a 2020 2020 2020 2020 6773 2e6c 6f67  ).        gs.log
-00035fa0: 2e64 6562 7567 2866 2252 6f6f 6d73 2061  .debug(f"Rooms a
-00035fb0: 7265 3a20 7b72 6f6f 6d73 7d22 290a 2020  re: {rooms}").  
-00035fc0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00035fd0: 7567 2866 2267 732e 636c 6965 6e74 2e72  ug(f"gs.client.r
-00035fe0: 6f6f 6d73 2061 7265 3a20 7b67 732e 636c  ooms are: {gs.cl
-00035ff0: 6965 6e74 2e72 6f6f 6d73 7d22 290a 2020  ient.rooms}").  
-00036000: 2020 2020 2020 2320 5379 6e63 2065 6e63        # Sync enc
-00036010: 7279 7074 696f 6e20 6b65 7973 2077 6974  ryption keys wit
-00036020: 6820 7468 6520 7365 7276 6572 0a20 2020  h the server.   
-00036030: 2020 2020 2023 2052 6571 7569 7265 6420       # Required 
-00036040: 666f 7220 7061 7274 6963 6970 6174 696e  for participatin
-00036050: 6720 696e 2065 6e63 7279 7074 6564 2072  g in encrypted r
-00036060: 6f6f 6d73 0a20 2020 2020 2020 2069 6620  ooms.        if 
-00036070: 6773 2e63 6c69 656e 742e 7368 6f75 6c64  gs.client.should
-00036080: 5f75 706c 6f61 645f 6b65 7973 3a0a 2020  _upload_keys:.  
-00036090: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-000360a0: 2e64 6562 7567 2822 5374 6172 7469 6e67  .debug("Starting
-000360b0: 206b 6579 735f 7570 6c6f 6164 2229 0a20   keys_upload"). 
-000360c0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000360d0: 2067 732e 636c 6965 6e74 2e6b 6579 735f   gs.client.keys_
-000360e0: 7570 6c6f 6164 2829 0a20 2020 2020 2020  upload().       
-000360f0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00036100: 6728 2246 696e 6973 6865 6420 6b65 7973  g("Finished keys
-00036110: 5f75 706c 6f61 6422 290a 2020 2020 2020  _upload").      
-00036120: 2020 6966 2067 732e 7061 2e73 796e 6320    if gs.pa.sync 
-00036130: 3d3d 2053 594e 435f 4f46 463a 0a20 2020  == SYNC_OFF:.   
-00036140: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00036150: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00036160: 2020 2020 2020 2066 2244 7565 2074 6f20         f"Due to 
-00036170: 272d 2d73 796e 6320 7b53 594e 435f 4f46  '--sync {SYNC_OF
-00036180: 467d 2720 6f70 7469 6f6e 2c20 7379 6e63  F}' option, sync
-00036190: 2829 2077 696c 6c20 6265 2073 6b69 7070  () will be skipp
-000361a0: 6564 2e22 0a20 2020 2020 2020 2020 2020  ed.".           
-000361b0: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
-000361c0: 2050 7265 6669 6c6c 2072 6f6f 6d73 2061   Prefill rooms a
-000361d0: 7320 6f75 746c 696e 6564 2069 6e20 4973  s outlined in Is
-000361e0: 7375 6520 2339 310a 2020 2020 2020 2020  sue #91.        
-000361f0: 2020 2020 2320 5369 6e63 6520 7379 6e63      # Since sync
-00036200: 2829 2069 7320 6e6f 7420 6361 6c6c 6564  () is not called
-00036210: 2077 6520 4d55 5354 2066 696c 6c20 696e   we MUST fill in
-00036220: 2074 6865 2072 6f6f 6d73 206d 616e 7561   the rooms manua
-00036230: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-00036240: 2023 2054 6869 7320 6c69 6e65 2077 6173   # This line was
-00036250: 2073 7567 6765 7374 6564 2061 7320 776f   suggested as wo
-00036260: 726b 6172 6f75 6e64 3a0a 2020 2020 2020  rkaround:.      
-00036270: 2020 2020 2020 2320 6173 796e 635f 636c        # async_cl
-00036280: 6965 6e74 2e72 6f6f 6d73 5b72 6f6f 6d5f  ient.rooms[room_
-00036290: 6964 5d20 3d20 6e69 6f2e 726f 6f6d 732e  id] = nio.rooms.
-000362a0: 4d61 7472 6978 526f 6f6d 280a 2020 2020  MatrixRoom(.    
-000362b0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
-000362c0: 2020 2072 6f6f 6d5f 6964 3d72 6f6f 6d5f     room_id=room_
-000362d0: 6964 2c20 6f77 6e5f 7573 6572 5f69 643d  id, own_user_id=
-000362e0: 7573 6572 5f69 642c 2065 6e63 7279 7074  user_id, encrypt
-000362f0: 6564 3d54 7275 6529 0a20 2020 2020 2020  ed=True).       
-00036300: 2020 2020 2023 2057 6520 6d75 7374 2061       # We must a
-00036310: 6c73 6f20 6d61 7020 726f 6f6d 2061 6c69  lso map room ali
-00036320: 6173 6573 2074 6f20 726f 6f6d 2069 6473  ases to room ids
-00036330: 2e0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-00036340: 7220 726f 6f6d 5f69 6420 696e 2072 6f6f  r room_id in roo
-00036350: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
-00036360: 2020 2020 726f 6f6d 5f69 6420 3d20 6177      room_id = aw
-00036370: 6169 7420 6d61 705f 726f 6f6d 696e 666f  ait map_roominfo
-00036380: 5f74 6f5f 726f 6f6d 6964 2867 732e 636c  _to_roomid(gs.cl
-00036390: 6965 6e74 2c20 726f 6f6d 5f69 6429 0a20  ient, room_id). 
-000363a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000363b0: 732e 636c 6965 6e74 2e72 6f6f 6d73 5b72  s.client.rooms[r
-000363c0: 6f6f 6d5f 6964 5d20 3d20 4d61 7472 6978  oom_id] = Matrix
-000363d0: 526f 6f6d 280a 2020 2020 2020 2020 2020  Room(.          
-000363e0: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
-000363f0: 643d 726f 6f6d 5f69 642c 0a20 2020 2020  d=room_id,.     
-00036400: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00036410: 776e 5f75 7365 725f 6964 3d67 732e 6372  wn_user_id=gs.cr
-00036420: 6564 656e 7469 616c 735b 2275 7365 725f  edentials["user_
-00036430: 6964 225d 2c0a 2020 2020 2020 2020 2020  id"],.          
-00036440: 2020 2020 2020 2020 2020 656e 6372 7970            encryp
-00036450: 7465 643d 5472 7565 2c0a 2020 2020 2020  ted=True,.      
-00036460: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00036470: 2020 2020 656c 7365 3a20 2023 2053 594e      else:  # SYN
-00036480: 435f 4655 4c4c 0a20 2020 2020 2020 2020  C_FULL.         
-00036490: 2020 2023 2044 6566 6175 6c74 2063 6173     # Default cas
-000364a0: 652c 2073 7461 6e64 6172 643a 0a20 2020  e, standard:.   
-000364b0: 2020 2020 2020 2020 2023 204f 6e65 206d           # One m
-000364c0: 7573 7420 7379 6e63 2066 6972 7374 2074  ust sync first t
-000364d0: 6f20 6765 7420 726f 6f6d 2069 6473 2066  o get room ids f
-000364e0: 6f72 2065 6e63 7279 7074 6564 2072 6f6f  or encrypted roo
-000364f0: 6d73 0a20 2020 2020 2020 2020 2020 2023  ms.            #
-00036500: 2073 696e 6365 2077 6520 6f6e 6c79 2073   since we only s
-00036510: 656e 6420 6120 6d73 6720 616e 6420 7468  end a msg and th
-00036520: 656e 2073 746f 702c 0a20 2020 2020 2020  en stop,.       
-00036530: 2020 2020 2023 2077 6520 6361 6e20 7573       # we can us
-00036540: 6520 7379 6e63 2829 2069 6e73 7465 6164  e sync() instead
-00036550: 206f 6620 7379 6e63 5f66 6f72 6576 6572   of sync_forever
-00036560: 2829 2e0a 2020 2020 2020 2020 2020 2020  ()..            
-00036570: 6675 6c6c 5f73 7461 7465 203d 2054 7275  full_state = Tru
-00036580: 650a 2020 2020 2020 2020 2020 2020 6773  e.            gs
-00036590: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-000365a0: 2020 2020 2020 2020 2020 2020 6622 5374              f"St
-000365b0: 6172 7469 6e67 2073 796e 6328 6675 6c6c  arting sync(full
-000365c0: 5f73 7461 7465 3d7b 6675 6c6c 5f73 7461  _state={full_sta
-000365d0: 7465 7d29 2022 0a20 2020 2020 2020 2020  te}) ".         
-000365e0: 2020 2020 2020 2022 746f 2073 796e 6368         "to synch
-000365f0: 726f 6e69 7a65 2065 7665 6e74 7320 7769  ronize events wi
-00036600: 7468 2073 6572 7665 722e 220a 2020 2020  th server.".    
-00036610: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00036620: 2020 2020 2020 6177 6169 7420 6773 2e63        await gs.c
-00036630: 6c69 656e 742e 7379 6e63 2874 696d 656f  lient.sync(timeo
-00036640: 7574 3d33 3030 3030 2c20 6675 6c6c 5f73  ut=30000, full_s
-00036650: 7461 7465 3d66 756c 6c5f 7374 6174 6529  tate=full_state)
-00036660: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00036670: 6c6f 672e 6465 6275 6728 2246 696e 6973  log.debug("Finis
-00036680: 6865 6420 7379 6e63 2829 2077 6974 6820  hed sync() with 
-00036690: 7365 7276 6572 2e22 290a 2020 2020 2020  server.").      
-000366a0: 2020 2320 4e6f 7720 7765 2063 616e 2073    # Now we can s
-000366b0: 656e 6420 6d65 7373 6167 6573 2061 7320  end messages as 
-000366c0: 7468 6520 7573 6572 0a20 2020 2020 2020  the user.       
-000366d0: 2061 7761 6974 2070 726f 6365 7373 5f61   await process_a
-000366e0: 7267 756d 656e 7473 5f61 6e64 5f69 6e70  rguments_and_inp
-000366f0: 7574 2867 732e 636c 6965 6e74 2c20 726f  ut(gs.client, ro
-00036700: 6f6d 7329 0a20 2020 2020 2020 2023 2067  oms).        # g
-00036710: 732e 6c6f 672e 6465 6275 6728 6622 6773  s.log.debug(f"gs
-00036720: 2e63 6c69 656e 742e 726f 6f6d 7320 6172  .client.rooms ar
-00036730: 653a 207b 6773 2e63 6c69 656e 742e 726f  e: {gs.client.ro
-00036740: 6f6d 737d 2229 0a20 2020 2020 2020 2067  oms}").        g
-00036750: 732e 6c6f 672e 6465 6275 6728 224d 6573  s.log.debug("Mes
-00036760: 7361 6765 2073 656e 6420 6163 7469 6f6e  sage send action
-00036770: 2066 696e 6973 6865 642e 2229 0a20 2020   finished.").   
-00036780: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00036790: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-000367a0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-000367b0: 2020 2020 2020 2020 2020 2245 3231 393a            "E219:
-000367c0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-000367d0: 4572 726f 7220 6475 7269 6e67 2073 656e  Error during sen
-000367e0: 6469 6e67 2e20 436f 6e74 696e 7569 6e67  ding. Continuing
-000367f0: 2064 6573 7069 7465 2065 7272 6f72 2e20   despite error. 
-00036800: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00036810: 4578 6365 7074 696f 6e3a 207b 657d 220a  Exception: {e}".
-00036820: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00036830: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00036840: 3d20 310a 0a0a 6173 796e 6320 6465 6620  = 1...async def 
-00036850: 6163 7469 6f6e 5f6c 6f67 6f75 7428 2920  action_logout() 
-00036860: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
-00036870: 4c6f 6720 6f75 7420 6f6e 6520 6f72 2061  Log out one or a
-00036880: 6c6c 2064 6576 6963 6573 2066 726f 6d20  ll devices from 
-00036890: 4d61 7472 6978 2073 6572 7665 722e 2222  Matrix server.""
-000368a0: 220a 2020 2020 6966 206e 6f74 2067 732e  ".    if not gs.
-000368b0: 636c 6965 6e74 2061 6e64 206e 6f74 2067  client and not g
-000368c0: 732e 6372 6564 656e 7469 616c 733a 0a20  s.credentials:. 
-000368d0: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
-000368e0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-000368f0: 2022 4532 3230 3a20 2220 2243 6c69 656e   "E220: " "Clien
-00036900: 7420 6f72 2063 7265 6465 6e74 6961 6c73  t or credentials
-00036910: 206e 6f74 2073 6574 2e20 536b 6970 7069   not set. Skippi
-00036920: 6e67 2061 6374 696f 6e2e 220a 2020 2020  ng action.".    
-00036930: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
-00036940: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-00036950: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00036960: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00036970: 6465 7669 6365 203d 2067 732e 7061 2e6c  device = gs.pa.l
-00036980: 6f67 6f75 742e 6c6f 7765 7228 290a 2020  ogout.lower().  
-00036990: 2020 2020 2020 6966 2064 6576 6963 6520        if device 
-000369a0: 3d3d 2022 6d65 223a 0a20 2020 2020 2020  == "me":.       
-000369b0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-000369c0: 6728 6622 2d2d 6c6f 676f 7574 2068 6173  g(f"--logout has
-000369d0: 2063 686f 7365 6e20 746f 206c 6f67 206f   chosen to log o
-000369e0: 7574 2064 6576 6963 6520 7b64 6576 6963  ut device {devic
-000369f0: 657d 2229 0a20 2020 2020 2020 2020 2020  e}").           
-00036a00: 2061 6c6c 5f64 6576 6963 6573 203d 2046   all_devices = F
-00036a10: 616c 7365 0a20 2020 2020 2020 2065 6c69  alse.        eli
-00036a20: 6620 6465 7669 6365 203d 3d20 2261 6c6c  f device == "all
-00036a30: 223a 0a20 2020 2020 2020 2020 2020 2067  ":.            g
-00036a40: 732e 6c6f 672e 6465 6275 6728 6622 2d2d  s.log.debug(f"--
-00036a50: 6c6f 676f 7574 2068 6173 2063 686f 7365  logout has chose
-00036a60: 6e20 746f 206c 6f67 206f 7574 2064 6576  n to log out dev
-00036a70: 6963 6573 207b 6465 7669 6365 7d22 290a  ices {device}").
-00036a80: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
-00036a90: 6465 7669 6365 7320 3d20 5472 7565 0a20  devices = True. 
-00036aa0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00036ab0: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
-00036ac0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
-00036ad0: 2020 2020 2020 2022 4532 3231 3a20 220a         "E221: ".
-00036ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036af0: 2245 7272 6f72 2064 7572 696e 6720 6c6f  "Error during lo
-00036b00: 676f 7574 2e20 4f6e 6c79 2027 6d65 2720  gout. Only 'me' 
-00036b10: 616e 6420 2761 6c6c 2720 6172 6520 7375  and 'all' are su
-00036b20: 7070 6f72 7465 642e 2022 0a20 2020 2020  pported. ".     
-00036b30: 2020 2020 2020 2020 2020 2066 2242 7574             f"But
-00036b40: 2066 6f75 6e64 202d 2d6c 6f67 6f75 7420   found --logout 
-00036b50: 277b 6465 7669 6365 7d27 2e20 436f 6e74  '{device}'. Cont
-00036b60: 696e 7569 6e67 2064 6573 7069 7465 2065  inuing despite e
-00036b70: 7272 6f72 2e20 220a 2020 2020 2020 2020  rror. ".        
-00036b80: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00036b90: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
-00036ba0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00036bb0: 7265 7475 726e 0a20 2020 2020 2020 2072  return.        r
-00036bc0: 6573 7020 3d20 6177 6169 7420 6773 2e63  esp = await gs.c
-00036bd0: 6c69 656e 742e 6c6f 676f 7574 2861 6c6c  lient.logout(all
-00036be0: 5f64 6576 6963 6573 290a 2020 2020 2020  _devices).      
-00036bf0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00036c00: 7265 7370 2c20 4c6f 676f 7574 4572 726f  resp, LogoutErro
-00036c10: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00036c20: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-00036c30: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00036c40: 3232 323a 2022 0a20 2020 2020 2020 2020  222: ".         
-00036c50: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-00036c60: 746f 206c 6f67 6f75 7420 7b64 6576 6963  to logout {devic
-00036c70: 657d 2e20 5265 7370 6f6e 7365 3a20 220a  e}. Response: ".
-00036c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036c90: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
-00036ca0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
-00036cb0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00036cc0: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
-00036cd0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00036ce0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00036cf0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00036d00: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00036d10: 2020 2066 226c 6f67 6f75 7420 7375 6363     f"logout succ
-00036d20: 6573 7366 756c 2e20 5265 7370 6f6e 7365  essful. Response
-00036d30: 2069 733a 207b 7072 6976 6163 795f 6669   is: {privacy_fi
-00036d40: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
-00036d50: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00036d60: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
-00036d70: 6f67 2e69 6e66 6f28 6622 5375 6363 6573  og.info(f"Succes
-00036d80: 7366 756c 6c79 206c 6f67 6765 6420 6f75  sfully logged ou
-00036d90: 7420 7b64 6576 6963 657d 2e22 290a 0a20  t {device}.").. 
-00036da0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00036db0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00036dc0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-00036dd0: 2020 2020 2020 2020 2020 2020 2245 3232              "E22
-00036de0: 333a 2022 0a20 2020 2020 2020 2020 2020  3: ".           
-00036df0: 2022 4572 726f 7220 6475 7269 6e67 206c   "Error during l
-00036e00: 6f67 6f75 742e 2043 6f6e 7469 6e75 696e  ogout. Continuin
-00036e10: 6720 6465 7370 6974 6520 6572 726f 722e  g despite error.
-00036e20: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00036e30: 2245 7863 6570 7469 6f6e 3a20 7b65 7d22  "Exception: {e}"
-00036e40: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00036e50: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
-00036e60: 2b3d 2031 0a0a 0a61 7379 6e63 2064 6566  += 1...async def
-00036e70: 2061 6374 696f 6e5f 6c6f 6769 6e28 2920   action_login() 
-00036e80: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
-00036e90: 4c6f 6720 696e 2075 7369 6e67 2053 534f  Log in using SSO
-00036ea0: 206f 7220 7061 7373 776f 7264 2c20 6372   or password, cr
-00036eb0: 6561 7465 2063 7265 6465 6e74 6961 6c73  eate credentials
-00036ec0: 2066 696c 652c 2063 7265 6174 6520 7374   file, create st
-00036ed0: 6f72 652c 0a20 2020 2061 6e64 2072 656d  ore,.    and rem
-00036ee0: 6169 6e20 6c6f 6767 6564 2069 6e2e 0a20  ain logged in.. 
-00036ef0: 2020 2022 2222 0a20 2020 2063 7265 6465     """.    crede
-00036f00: 6e74 6961 6c73 5f66 696c 6520 3d20 6465  ntials_file = de
-00036f10: 7465 726d 696e 655f 6372 6564 656e 7469  termine_credenti
-00036f20: 616c 735f 6669 6c65 2829 0a20 2020 2069  als_file().    i
-00036f30: 6620 6372 6564 656e 7469 616c 735f 6578  f credentials_ex
-00036f40: 6973 7428 6372 6564 656e 7469 616c 735f  ist(credentials_
-00036f50: 6669 6c65 293a 0a20 2020 2020 2020 2072  file):.        r
-00036f60: 6169 7365 204d 6174 7269 7843 6f6d 6d61  aise MatrixComma
-00036f70: 6e64 6572 4572 726f 7228 0a20 2020 2020  nderError(.     
-00036f80: 2020 2020 2020 2022 4532 3234 3a20 220a         "E224: ".
-00036f90: 2020 2020 2020 2020 2020 2020 222d 2d6c              "--l
-00036fa0: 6f67 696e 2077 6173 2075 7365 6420 6275  ogin was used bu
-00036fb0: 7420 6372 6564 656e 7469 616c 7320 616c  t credentials al
-00036fc0: 7265 6164 7920 6578 6973 7420 220a 2020  ready exist ".  
-00036fd0: 2020 2020 2020 2020 2020 6622 696e 2027            f"in '
-00036fe0: 7b63 7265 6465 6e74 6961 6c73 5f66 696c  {credentials_fil
-00036ff0: 657d 272e 220a 2020 2020 2020 2020 2920  e}'.".        ) 
-00037000: 6672 6f6d 204e 6f6e 650a 2020 2020 7374  from None.    st
-00037010: 6f72 655f 6469 7220 3d20 6465 7465 726d  ore_dir = determ
-00037020: 696e 655f 7374 6f72 655f 6469 7228 290a  ine_store_dir().
-00037030: 2020 2020 6966 2073 746f 7265 5f65 7869      if store_exi
-00037040: 7374 7328 7374 6f72 655f 6469 7229 3a0a  sts(store_dir):.
-00037050: 2020 2020 2020 2020 7261 6973 6520 4d61          raise Ma
-00037060: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
-00037070: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00037080: 2245 3232 353a 2022 0a20 2020 2020 2020  "E225: ".       
-00037090: 2020 2020 2066 222d 2d6c 6f67 696e 2077       f"--login w
-000370a0: 6173 2075 7365 6420 6275 7420 7374 6f72  as used but stor
-000370b0: 6520 616c 7265 6164 7920 6578 6973 7473  e already exists
-000370c0: 2069 6e20 277b 7374 6f72 655f 6469 727d   in '{store_dir}
-000370d0: 272e 220a 2020 2020 2020 2020 2920 6672  '.".        ) fr
-000370e0: 6f6d 204e 6f6e 650a 2020 2020 6d65 7468  om None.    meth
-000370f0: 6f64 203d 2067 732e 7061 2e6c 6f67 696e  od = gs.pa.login
-00037100: 2e6c 6f77 6572 2829 0a20 2020 2069 6e74  .lower().    int
-00037110: 6572 6163 7469 7665 203d 2046 616c 7365  eractive = False
-00037120: 0a20 2020 2069 6620 6d65 7468 6f64 203d  .    if method =
-00037130: 3d20 2270 6173 7377 6f72 6422 3a0a 2020  = "password":.  
-00037140: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00037150: 7567 2822 2d2d 6c6f 6769 6e20 6861 7320  ug("--login has 
-00037160: 6368 6f73 656e 2070 6173 7377 6f72 6420  chosen password 
-00037170: 6d65 7468 6f64 2066 6f72 2061 7574 6865  method for authe
-00037180: 6e74 6963 6174 696f 6e22 290a 2020 2020  ntication").    
-00037190: 656c 6966 206d 6574 686f 6420 3d3d 2022  elif method == "
-000371a0: 7373 6f22 3a0a 2020 2020 2020 2020 6773  sso":.        gs
-000371b0: 2e6c 6f67 2e64 6562 7567 2822 2d2d 6c6f  .log.debug("--lo
-000371c0: 6769 6e20 6861 7320 6368 6f73 656e 2053  gin has chosen S
-000371d0: 534f 206d 6574 686f 6420 666f 7220 6175  SO method for au
-000371e0: 7468 656e 7469 6361 7469 6f6e 2229 0a20  thentication"). 
-000371f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00037200: 2072 6169 7365 204d 6174 7269 7843 6f6d   raise MatrixCom
-00037210: 6d61 6e64 6572 4572 726f 7228 0a20 2020  manderError(.   
-00037220: 2020 2020 2020 2020 2022 4532 3236 3a20           "E226: 
-00037230: 220a 2020 2020 2020 2020 2020 2020 222d  ".            "-
-00037240: 2d6c 6f67 696e 2073 7065 6369 6669 6573  -login specifies
-00037250: 2069 6e76 616c 6964 2061 7574 6865 6e74   invalid authent
-00037260: 6963 6174 696e 206d 6574 686f 6420 220a  icatin method ".
-00037270: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
-00037280: 6d65 7468 6f64 7d27 2e20 4f6e 6c79 2027  method}'. Only '
-00037290: 7061 7373 776f 7264 2720 616e 6420 2773  password' and 's
-000372a0: 736f 2720 616c 6c6f 7765 642e 220a 2020  so' allowed.".  
-000372b0: 2020 2020 2020 2920 6672 6f6d 204e 6f6e        ) from Non
-000372c0: 650a 2020 2020 6966 2067 732e 7061 2e68  e.    if gs.pa.h
-000372d0: 6f6d 6573 6572 7665 723a 0a20 2020 2020  omeserver:.     
-000372e0: 2020 2068 6f6d 6573 6572 7665 7220 3d20     homeserver = 
-000372f0: 6773 2e70 612e 686f 6d65 7365 7276 6572  gs.pa.homeserver
-00037300: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00037310: 2020 2069 6e74 6572 6163 7469 7665 203d     interactive =
-00037320: 2054 7275 650a 2020 2020 2020 2020 686f   True.        ho
-00037330: 6d65 7365 7276 6572 203d 2022 6874 7470  meserver = "http
-00037340: 733a 2f2f 6d61 7472 6978 2e65 7861 6d70  s://matrix.examp
-00037350: 6c65 2e6f 7267 220a 2020 2020 2020 2020  le.org".        
-00037360: 686f 6d65 7365 7276 6572 203d 2069 6e70  homeserver = inp
-00037370: 7574 2866 2245 6e74 6572 2055 524c 206f  ut(f"Enter URL o
-00037380: 6620 796f 7572 2068 6f6d 6573 6572 7665  f your homeserve
-00037390: 723a 205b 7b68 6f6d 6573 6572 7665 727d  r: [{homeserver}
-000373a0: 5d20 2229 0a20 2020 2020 2020 2069 6620  ] ").        if 
-000373b0: 6e6f 7420 686f 6d65 7365 7276 6572 3a0a  not homeserver:.
-000373c0: 2020 2020 2020 2020 2020 2020 686f 6d65              home
-000373d0: 7365 7276 6572 203d 2022 6874 7470 733a  server = "https:
-000373e0: 2f2f 6d61 7472 6978 2e6f 7267 2220 2023  //matrix.org"  #
-000373f0: 2062 6574 7465 7220 6572 726f 7220 6d73   better error ms
-00037400: 6720 6c61 7465 720a 2020 2020 6966 206e  g later.    if n
-00037410: 6f74 2028 0a20 2020 2020 2020 2068 6f6d  ot (.        hom
-00037420: 6573 6572 7665 722e 7374 6172 7473 7769  eserver.startswi
-00037430: 7468 2822 6874 7470 733a 2f2f 2229 206f  th("https://") o
-00037440: 7220 686f 6d65 7365 7276 6572 2e73 7461  r homeserver.sta
-00037450: 7274 7377 6974 6828 2268 7474 703a 2f2f  rtswith("http://
-00037460: 2229 0a20 2020 2029 3a0a 2020 2020 2020  ").    ):.      
-00037470: 2020 686f 6d65 7365 7276 6572 203d 2022    homeserver = "
-00037480: 6874 7470 733a 2f2f 2220 2b20 686f 6d65  https://" + home
-00037490: 7365 7276 6572 0a20 2020 2068 6f6d 6573  server.    homes
-000374a0: 6572 7665 725f 7368 6f72 7420 3d20 7572  erver_short = ur
-000374b0: 6c70 6172 7365 2868 6f6d 6573 6572 7665  lparse(homeserve
-000374c0: 7229 2e68 6f73 746e 616d 6520 2023 206d  r).hostname  # m
-000374d0: 6174 7269 782e 6578 616d 706c 652e 6f72  atrix.example.or
-000374e0: 670a 0a20 2020 2023 2046 6f72 2053 534f  g..    # For SSO
-000374f0: 206c 6f67 696e 2c20 7573 6572 5f69 6420   login, user_id 
-00037500: 6973 206e 6f74 206e 6565 6465 642e 2042  is not needed. B
-00037510: 7574 206d 6174 7269 782d 636f 6d6d 616e  ut matrix-comman
-00037520: 6465 7220 6e65 6564 730a 2020 2020 2320  der needs.    # 
-00037530: 7573 6572 5f69 6420 666f 7220 6372 6564  user_id for cred
-00037540: 656e 7469 616c 7320 666f 7220 6172 6775  entials for argu
-00037550: 6d65 6e74 7320 6c69 6b65 202d 2d77 686f  ments like --who
-00037560: 616d 692e 0a20 2020 2023 2046 6f72 2053  ami..    # For S
-00037570: 534f 2c20 7765 2067 6574 2074 6865 2075  SO, we get the u
-00037580: 7365 725f 6964 2066 726f 6d20 6c6f 6769  ser_id from logi
-00037590: 6e28 2920 4150 4920 6361 6c6c 2c20 692e  n() API call, i.
-000375a0: 652e 2066 726f 6d20 7365 7276 6572 2e0a  e. from server..
-000375b0: 2020 2020 6966 2067 732e 7061 2e75 7365      if gs.pa.use
-000375c0: 725f 6c6f 6769 6e3a 0a20 2020 2020 2020  r_login:.       
-000375d0: 2075 7365 725f 6964 203d 2067 732e 7061   user_id = gs.pa
-000375e0: 2e75 7365 725f 6c6f 6769 6e0a 2020 2020  .user_login.    
-000375f0: 656c 7365 3a0a 2020 2020 2020 2020 7573  else:.        us
-00037600: 6572 5f69 6420 3d20 4e6f 6e65 0a20 2020  er_id = None.   
-00037610: 2069 6620 6d65 7468 6f64 203d 3d20 2270   if method == "p
-00037620: 6173 7377 6f72 6422 2061 6e64 206e 6f74  assword" and not
-00037630: 2075 7365 725f 6964 3a0a 2020 2020 2020   user_id:.      
-00037640: 2020 696e 7465 7261 6374 6976 6520 3d20    interactive = 
-00037650: 5472 7565 0a20 2020 2020 2020 2075 7365  True.        use
-00037660: 725f 6964 203d 2022 406a 6f68 6e3a 6578  r_id = "@john:ex
-00037670: 616d 706c 652e 6f72 6722 0a20 2020 2020  ample.org".     
-00037680: 2020 2075 7365 725f 6964 3220 3d20 2240     user_id2 = "@
-00037690: 6a6f 686e 3a22 202b 2068 6f6d 6573 6572  john:" + homeser
-000376a0: 7665 725f 7368 6f72 740a 2020 2020 2020  ver_short.      
-000376b0: 2020 7573 6572 5f69 6420 3d20 696e 7075    user_id = inpu
-000376c0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
-000376d0: 2245 6e74 6572 2079 6f75 7220 7573 6572  "Enter your user
-000376e0: 2049 443a 2020 5b7b 7573 6572 5f69 647d   ID:  [{user_id}
-000376f0: 5d20 206f 7220 205b 6a6f 686e 5d20 666f  ]  or  [john] fo
-00037700: 7220 7b75 7365 725f 6964 327d 203a 2022  r {user_id2} : "
-00037710: 0a20 2020 2020 2020 2029 2e73 7472 6970  .        ).strip
-00037720: 2829 0a20 2020 2069 6620 6d65 7468 6f64  ().    if method
-00037730: 203d 3d20 2270 6173 7377 6f72 6422 3a0a   == "password":.
-00037740: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-00037750: 2e70 6173 7377 6f72 643a 0a20 2020 2020  .password:.     
-00037760: 2020 2020 2020 2070 6173 7377 6f72 6420         password 
-00037770: 3d20 6773 2e70 612e 7061 7373 776f 7264  = gs.pa.password
-00037780: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00037790: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-000377a0: 6163 7469 7665 203d 2054 7275 650a 2020  active = True.  
-000377b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000377c0: 2250 6c65 6173 6520 7072 6f76 6964 6520  "Please provide 
-000377d0: 796f 7572 204d 6174 7269 7820 6163 636f  your Matrix acco
-000377e0: 756e 7420 7061 7373 776f 7264 2e22 290a  unt password.").
-000377f0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00037800: 776f 7264 203d 2067 6574 7061 7373 2e67  word = getpass.g
-00037810: 6574 7061 7373 2829 0a20 2020 2065 6c69  etpass().    eli
-00037820: 6620 6d65 7468 6f64 203d 3d20 2273 736f  f method == "sso
-00037830: 223a 0a20 2020 2020 2020 2070 6173 7377  ":.        passw
-00037840: 6f72 6420 3d20 4e6f 6e65 0a20 2020 2069  ord = None.    i
-00037850: 6620 6773 2e70 612e 6465 7669 6365 2069  f gs.pa.device i
-00037860: 7320 6e6f 7420 4e6f 6e65 3a20 2023 2073  s not None:  # s
-00037870: 6f6d 6574 6869 6e67 2077 6173 2073 7065  omething was spe
-00037880: 6369 6669 6564 0a20 2020 2020 2020 2064  cified.        d
-00037890: 6576 6963 655f 6e61 6d65 203d 2067 732e  evice_name = gs.
-000378a0: 7061 2e64 6576 6963 652e 7374 7269 7028  pa.device.strip(
-000378b0: 290a 2020 2020 2020 2020 6966 2064 6576  ).        if dev
-000378c0: 6963 655f 6e61 6d65 203d 3d20 2222 3a0a  ice_name == "":.
-000378d0: 2020 2020 2020 2020 2020 2020 6465 7669              devi
-000378e0: 6365 5f6e 616d 6520 3d20 5052 4f47 5f57  ce_name = PROG_W
-000378f0: 4954 484f 5554 5f45 5854 2020 2320 6465  ITHOUT_EXT  # de
-00037900: 6661 756c 740a 2020 2020 656c 7365 3a0a  fault.    else:.
-00037910: 2020 2020 2020 2020 696e 7465 7261 6374          interact
-00037920: 6976 6520 3d20 5472 7565 0a20 2020 2020  ive = True.     
-00037930: 2020 2064 6576 6963 655f 6e61 6d65 203d     device_name =
-00037940: 2050 524f 475f 5749 5448 4f55 545f 4558   PROG_WITHOUT_EX
-00037950: 540a 2020 2020 2020 2020 6465 7669 6365  T.        device
-00037960: 5f6e 616d 6520 3d20 696e 7075 7428 0a20  _name = input(. 
-00037970: 2020 2020 2020 2020 2020 2066 2243 686f             f"Cho
-00037980: 6f73 6520 6120 6e61 6d65 2066 6f72 2074  ose a name for t
-00037990: 6869 7320 6465 7669 6365 3a20 5b7b 6465  his device: [{de
-000379a0: 7669 6365 5f6e 616d 657d 5d20 220a 2020  vice_name}] ".  
-000379b0: 2020 2020 2020 292e 7374 7269 7028 290a        ).strip().
-000379c0: 2020 2020 2020 2020 6966 2064 6576 6963          if devic
-000379d0: 655f 6e61 6d65 203d 3d20 2222 3a0a 2020  e_name == "":.  
-000379e0: 2020 2020 2020 2020 2020 6465 7669 6365            device
-000379f0: 5f6e 616d 6520 3d20 5052 4f47 5f57 4954  _name = PROG_WIT
-00037a00: 484f 5554 5f45 5854 2020 2320 6465 6661  HOUT_EXT  # defa
-00037a10: 756c 740a 2020 2020 6966 2067 732e 7061  ult.    if gs.pa
-00037a20: 2e72 6f6f 6d5f 6465 6661 756c 7420 6973  .room_default is
-00037a30: 206e 6f74 204e 6f6e 653a 2020 2320 736f   not None:  # so
-00037a40: 6d65 7468 696e 6720 7761 7320 7370 6563  mething was spec
-00037a50: 6966 6965 640a 2020 2020 2020 2020 726f  ified.        ro
-00037a60: 6f6d 5f69 6420 3d20 6773 2e70 612e 726f  om_id = gs.pa.ro
-00037a70: 6f6d 5f64 6566 6175 6c74 2e73 7472 6970  om_default.strip
-00037a80: 2829 0a20 2020 2020 2020 2072 6f6f 6d5f  ().        room_
-00037a90: 6964 203d 2072 6f6f 6d5f 6964 2e72 6570  id = room_id.rep
-00037aa0: 6c61 6365 2872 225c 2122 2c20 2221 2229  lace(r"\!", "!")
-00037ab0: 2020 2320 7265 6d6f 7665 2070 6f73 7369    # remove possi
-00037ac0: 626c 6520 6573 6361 7065 0a20 2020 2065  ble escape.    e
-00037ad0: 6c73 653a 0a20 2020 2020 2020 2069 6e74  lse:.        int
-00037ae0: 6572 6163 7469 7665 203d 2054 7275 650a  eractive = True.
-00037af0: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
-00037b00: 3d20 2221 536f 6d65 526f 6f6d 4964 5374  = "!SomeRoomIdSt
-00037b10: 7269 6e67 3a65 7861 6d70 6c65 2e6f 7267  ring:example.org
-00037b20: 220a 2020 2020 2020 2020 726f 6f6d 5f69  ".        room_i
-00037b30: 6432 203d 2022 2361 6c69 6173 3a22 202b  d2 = "#alias:" +
-00037b40: 2068 6f6d 6573 6572 7665 725f 7368 6f72   homeserver_shor
-00037b50: 740a 2020 2020 2020 2020 726f 6f6d 5f69  t.        room_i
-00037b60: 6420 3d20 696e 7075 7428 0a20 2020 2020  d = input(.     
-00037b70: 2020 2020 2020 2066 2245 6e74 6572 2072         f"Enter r
-00037b80: 6f6f 6d20 4944 2066 6f72 2064 6566 6175  oom ID for defau
-00037b90: 6c74 2072 6f6f 6d3a 2020 5b7b 726f 6f6d  lt room:  [{room
-00037ba0: 5f69 647d 5d20 2022 0a20 2020 2020 2020  _id}]  ".       
-00037bb0: 2020 2020 2066 226f 7220 205b 616c 6961       f"or  [alia
-00037bc0: 735d 2066 6f72 207b 726f 6f6d 5f69 6432  s] for {room_id2
-00037bd0: 7d20 3a20 220a 2020 2020 2020 2020 292e  } : ".        ).
-00037be0: 7374 7269 7028 290a 2020 2020 6966 2075  strip().    if u
-00037bf0: 7365 725f 6964 2069 7320 6e6f 7420 4e6f  ser_id is not No
-00037c00: 6e65 3a0a 2020 2020 2020 2020 6966 2069  ne:.        if i
-00037c10: 735f 7061 7274 6961 6c5f 7573 6572 5f69  s_partial_user_i
-00037c20: 6428 7573 6572 5f69 6429 3a0a 2020 2020  d(user_id):.    
-00037c30: 2020 2020 2020 2020 7573 6572 5f69 6420          user_id 
-00037c40: 3d20 7573 6572 5f69 6420 2b20 223a 2220  = user_id + ":" 
-00037c50: 2b20 686f 6d65 7365 7276 6572 5f73 686f  + homeserver_sho
-00037c60: 7274 2020 2320 646f 6e74 2075 7365 2066  rt  # dont use f
-00037c70: 6e0a 2020 2020 2020 2020 6966 2069 735f  n.        if is_
-00037c80: 7368 6f72 745f 7573 6572 5f69 6428 7573  short_user_id(us
-00037c90: 6572 5f69 6429 3a0a 2020 2020 2020 2020  er_id):.        
-00037ca0: 2020 2020 7573 6572 5f69 6420 3d20 2240      user_id = "@
-00037cb0: 2220 2b20 7573 6572 5f69 6420 2b20 223a  " + user_id + ":
-00037cc0: 2220 2b20 686f 6d65 7365 7276 6572 5f73  " + homeserver_s
-00037cd0: 686f 7274 2020 2320 646f 6e74 2075 7365  hort  # dont use
-00037ce0: 2066 6e0a 2020 2020 2020 2020 6966 206e   fn.        if n
-00037cf0: 6f74 2069 735f 7573 6572 5f69 6428 7573  ot is_user_id(us
-00037d00: 6572 5f69 6429 3a0a 2020 2020 2020 2020  er_id):.        
-00037d10: 2020 2020 7261 6973 6520 4d61 7472 6978      raise Matrix
-00037d20: 436f 6d6d 616e 6465 7245 7272 6f72 280a  CommanderError(.
-00037d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037d40: 2245 3232 373a 2022 0a20 2020 2020 2020  "E227: ".       
-00037d50: 2020 2020 2020 2020 2066 2255 7365 7220           f"User 
-00037d60: 6964 2027 7b75 7365 725f 6964 7d27 2066  id '{user_id}' f
-00037d70: 6f72 202d 2d6c 6f67 696e 2069 7320 696e  or --login is in
-00037d80: 7661 6c69 642e 2022 0a20 2020 2020 2020  valid. ".       
-00037d90: 2020 2020 2020 2020 2022 5370 6563 6966           "Specif
-00037da0: 7920 636f 7272 6563 7420 7573 6572 2069  y correct user i
-00037db0: 642e 220a 2020 2020 2020 2020 2020 2020  d.".            
-00037dc0: 2920 6672 6f6d 204e 6f6e 650a 2020 2020  ) from None.    
-00037dd0: 6966 2069 735f 7368 6f72 745f 726f 6f6d  if is_short_room
-00037de0: 5f61 6c69 6173 2872 6f6f 6d5f 6964 293a  _alias(room_id):
-00037df0: 0a20 2020 2020 2020 2069 6620 726f 6f6d  .        if room
-00037e00: 5f69 645b 305d 2021 3d20 2223 223a 0a20  _id[0] != "#":. 
-00037e10: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
-00037e20: 6964 203d 2022 2322 202b 2072 6f6f 6d5f  id = "#" + room_
-00037e30: 6964 0a20 2020 2020 2020 2072 6f6f 6d5f  id.        room_
-00037e40: 6964 203d 2072 6f6f 6d5f 6964 202b 2022  id = room_id + "
-00037e50: 3a22 202b 2068 6f6d 6573 6572 7665 725f  :" + homeserver_
-00037e60: 7368 6f72 7420 2023 2064 6f6e 7420 7573  short  # dont us
-00037e70: 6520 666e 0a20 2020 2069 6620 6e6f 7420  e fn.    if not 
-00037e80: 6973 5f72 6f6f 6d28 726f 6f6d 5f69 6429  is_room(room_id)
-00037e90: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00037ea0: 4d61 7472 6978 436f 6d6d 616e 6465 7245  MatrixCommanderE
-00037eb0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00037ec0: 2020 2245 3232 383a 2022 0a20 2020 2020    "E228: ".     
-00037ed0: 2020 2020 2020 2066 2252 6f6f 6d20 6964         f"Room id
-00037ee0: 2027 7b72 6f6f 6d5f 6964 7d27 2066 6f72   '{room_id}' for
-00037ef0: 202d 2d6c 6f67 696e 2069 7320 696e 7661   --login is inva
-00037f00: 6c69 642e 2022 0a20 2020 2020 2020 2020  lid. ".         
-00037f10: 2020 2022 5370 6563 6966 7920 636f 7272     "Specify corr
-00037f20: 6563 7420 726f 6f6d 2069 642e 220a 2020  ect room id.".  
-00037f30: 2020 2020 2020 2920 6672 6f6d 204e 6f6e        ) from Non
-00037f40: 650a 0a20 2020 2067 732e 6c6f 672e 696e  e..    gs.log.in
-00037f50: 666f 2866 2254 6865 2070 726f 7669 6465  fo(f"The provide
-00037f60: 6420 6c6f 6769 6e20 6461 7461 2069 733a  d login data is:
-00037f70: 2068 6f6d 6573 6572 7665 723d 277b 686f   homeserver='{ho
-00037f80: 6d65 7365 7276 6572 7d27 2229 0a20 2020  meserver}'").   
-00037f90: 2067 732e 6c6f 672e 696e 666f 2866 2220   gs.log.info(f" 
-00037fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037fb0: 2020 2020 2020 2020 2020 2075 7365 7220             user 
-00037fc0: 6964 3d27 7b75 7365 725f 6964 7d27 2229  id='{user_id}'")
-00037fd0: 0a20 2020 2023 2067 732e 6c6f 672e 696e  .    # gs.log.in
-00037fe0: 666f 2866 2220 2020 2020 2020 2020 2020  fo(f"           
-00037ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038000: 2070 6173 7377 6f72 643d 277b 7061 7373   password='{pass
-00038010: 776f 7264 7d27 2229 0a20 2020 2067 732e  word}'").    gs.
-00038020: 6c6f 672e 696e 666f 2866 2220 2020 2020  log.info(f"     
-00038030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038040: 2020 2020 2020 2064 6576 6963 6520 6e61         device na
-00038050: 6d65 3d27 7b64 6576 6963 655f 6e61 6d65  me='{device_name
-00038060: 7d27 2229 0a20 2020 2067 732e 6c6f 672e  }'").    gs.log.
-00038070: 696e 666f 2866 2220 2020 2020 2020 2020  info(f"         
-00038080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038090: 2020 2072 6f6f 6d20 6964 3d27 7b72 6f6f     room id='{roo
-000380a0: 6d5f 6964 7d27 2229 0a20 2020 2069 6620  m_id}'").    if 
-000380b0: 696e 7465 7261 6374 6976 653a 0a20 2020  interactive:.   
-000380c0: 2020 2020 2070 7269 6e74 2866 2254 6865       print(f"The
-000380d0: 2070 726f 7669 6465 6420 6c6f 6769 6e20   provided login 
-000380e0: 6461 7461 2069 733a 2068 6f6d 6573 6572  data is: homeser
-000380f0: 7665 723d 277b 686f 6d65 7365 7276 6572  ver='{homeserver
-00038100: 7d27 2229 0a20 2020 2020 2020 2070 7269  }'").        pri
-00038110: 6e74 2866 2220 2020 2020 2020 2020 2020  nt(f"           
-00038120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038130: 2075 7365 7220 6964 3d27 7b75 7365 725f   user id='{user_
-00038140: 6964 7d27 2229 0a20 2020 2020 2020 2023  id}'").        #
-00038150: 2070 7269 6e74 2866 2220 2020 2020 2020   print(f"       
-00038160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038170: 2020 2020 2070 6173 7377 6f72 643d 277b       password='{
-00038180: 7061 7373 776f 7264 7d27 2229 0a20 2020  password}'").   
-00038190: 2020 2020 2070 7269 6e74 2822 2020 2020       print("    
-000381a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000381b0: 2020 2020 2020 2020 7061 7373 776f 7264          password
-000381c0: 3d27 2a2a 2a27 2229 0a20 2020 2020 2020  ='***'").       
-000381d0: 2070 7269 6e74 2866 2220 2020 2020 2020   print(f"       
-000381e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000381f0: 2020 2020 2064 6576 6963 6520 6e61 6d65       device name
-00038200: 3d27 7b64 6576 6963 655f 6e61 6d65 7d27  ='{device_name}'
-00038210: 2229 0a20 2020 2020 2020 2070 7269 6e74  ").        print
-00038220: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00038230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038240: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
-00038250: 2069 643d 277b 726f 6f6d 5f69 647d 2722   id='{room_id}'"
-00038260: 2c0a 2020 2020 2020 2020 2020 2020 666c  ,.            fl
-00038270: 7573 683d 5472 7565 2c0a 2020 2020 2020  ush=True,.      
-00038280: 2020 290a 2020 2020 2020 2020 636f 6e66    ).        conf
-00038290: 6972 6d20 3d20 696e 7075 7428 2243 6f72  irm = input("Cor
-000382a0: 7265 6374 3f20 2859 6573 206f 7220 4374  rect? (Yes or Ct
-000382b0: 726c 2d43 2074 6f20 6162 6f72 7429 2022  rl-C to abort) "
-000382c0: 290a 2020 2020 2020 2020 6966 2063 6f6e  ).        if con
-000382d0: 6669 726d 2e6c 6f77 6572 2829 2021 3d20  firm.lower() != 
-000382e0: 2279 6573 2220 616e 6420 636f 6e66 6972  "yes" and confir
-000382f0: 6d2e 6c6f 7765 7228 2920 213d 2022 7922  m.lower() != "y"
-00038300: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-00038310: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-00038320: 2020 2020 2022 222c 0a20 2020 2020 2020       "",.       
-00038330: 2020 2020 2020 2020 2066 6c75 7368 3d54           flush=T
-00038340: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00038350: 2029 2020 2320 6164 6420 6e65 776c 696e   )  # add newlin
-00038360: 6520 746f 2073 7464 6f75 7420 746f 2073  e to stdout to s
-00038370: 6570 6172 6174 6520 616e 7920 6c6f 6720  eparate any log 
-00038380: 696e 666f 0a20 2020 2020 2020 2020 2020  info.           
-00038390: 2067 732e 6c6f 672e 696e 666f 2822 4162   gs.log.info("Ab
-000383a0: 6f72 7469 6e67 2064 7565 2074 6f20 7573  orting due to us
-000383b0: 6572 2072 6571 7565 7374 2e22 290a 2020  er request.").  
-000383c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000383d0: 0a0a 2020 2020 2320 616c 6c20 7468 6520  ..    # all the 
-000383e0: 696e 7075 7420 7265 7175 6972 6564 2066  input required f
-000383f0: 6f72 206c 6f67 696e 2069 7320 636f 6c6c  or login is coll
-00038400: 6563 7465 642c 0a20 2020 2023 206c 6174  ected,.    # lat
-00038410: 6572 2077 6520 6765 7420 7573 6572 5f69  er we get user_i
-00038420: 6420 666f 7220 5353 4f20 2872 6574 7572  d for SSO (retur
-00038430: 6e65 6420 6174 206c 6f67 696e 2041 5049  ned at login API
-00038440: 2063 616c 6c29 0a0a 2020 2020 6966 2067   call)..    if g
-00038450: 732e 7061 2e70 726f 7879 3a0a 2020 2020  s.pa.proxy:.    
-00038460: 2020 2020 6773 2e6c 6f67 2e69 6e66 6f28      gs.log.info(
-00038470: 6622 5072 6f78 7920 7b67 732e 7061 2e70  f"Proxy {gs.pa.p
-00038480: 726f 7879 7d20 7769 6c6c 2062 6520 7573  roxy} will be us
-00038490: 6564 2e22 290a 0a20 2020 2023 2063 6865  ed.")..    # che
-000384a0: 636b 2066 6f72 2070 6173 7377 6f72 642f  ck for password/
-000384b0: 5353 4f0a 2020 2020 636f 6e6e 6563 746f  SSO.    connecto
-000384c0: 7220 3d20 5443 5043 6f6e 6e65 6374 6f72  r = TCPConnector
-000384d0: 2873 736c 3d67 732e 7373 6c29 2020 2320  (ssl=gs.ssl)  # 
-000384e0: 7365 7474 696e 6720 7373 6c63 6f6e 7465  setting sslconte
-000384f0: 7874 0a20 2020 2061 7379 6e63 2077 6974  xt.    async wit
-00038500: 6820 436c 6965 6e74 5365 7373 696f 6e28  h ClientSession(
-00038510: 636f 6e6e 6563 746f 723d 636f 6e6e 6563  connector=connec
-00038520: 746f 7229 2061 7320 7365 7373 696f 6e3a  tor) as session:
-00038530: 2020 2320 6169 6f68 7474 700a 2020 2020    # aiohttp.    
-00038540: 2020 2020 6173 796e 6320 7769 7468 2073      async with s
-00038550: 6573 7369 6f6e 2e67 6574 280a 2020 2020  ession.get(.    
-00038560: 2020 2020 2020 2020 6622 7b68 6f6d 6573          f"{homes
-00038570: 6572 7665 727d 2f5f 6d61 7472 6978 2f63  erver}/_matrix/c
-00038580: 6c69 656e 742f 7230 2f6c 6f67 696e 222c  lient/r0/login",
-00038590: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000385a0: 7365 5f66 6f72 5f73 7461 7475 733d 5472  se_for_status=Tr
-000385b0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-000385c0: 7072 6f78 793d 6773 2e70 612e 7072 6f78  proxy=gs.pa.prox
-000385d0: 792c 0a20 2020 2020 2020 2029 2061 7320  y,.        ) as 
-000385e0: 7265 7370 6f6e 7365 3a0a 2020 2020 2020  response:.      
-000385f0: 2020 2020 2020 666c 6f77 5f74 7970 6573        flow_types
-00038600: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00038610: 2020 2020 2078 5b22 7479 7065 225d 2066       x["type"] f
-00038620: 6f72 2078 2069 6e20 2861 7761 6974 2072  or x in (await r
-00038630: 6573 706f 6e73 652e 6a73 6f6e 2829 292e  esponse.json()).
-00038640: 6765 7428 2266 6c6f 7773 222c 205b 5d29  get("flows", [])
-00038650: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00038660: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
-00038670: 672e 6465 6275 6728 2253 7570 706f 7274  g.debug("Support
-00038680: 6564 206c 6f67 696e 2066 6c6f 7773 3a20  ed login flows: 
-00038690: 2572 222c 2066 6c6f 775f 7479 7065 7329  %r", flow_types)
-000386a0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000386b0: 746f 6b65 6e5f 6176 6169 6c61 626c 6520  token_available 
-000386c0: 3d20 226d 2e6c 6f67 696e 2e74 6f6b 656e  = "m.login.token
-000386d0: 2220 696e 2066 6c6f 775f 7479 7065 730a  " in flow_types.
-000386e0: 2020 2020 2020 2020 2020 2020 2320 6d2e              # m.
-000386f0: 6c6f 6769 6e2e 746f 6b65 6e20 646f 6573  login.token does
-00038700: 206e 6f74 2072 6566 6572 2074 6f20 7374   not refer to st
-00038710: 6420 6163 6365 7373 2d74 6f6b 656e 206c  d access-token l
-00038720: 6f67 696e 0a20 2020 2020 2020 2020 2020  ogin.           
-00038730: 2070 6173 7377 6f72 645f 6176 6169 6c61   password_availa
-00038740: 626c 6520 3d20 226d 2e6c 6f67 696e 2e70  ble = "m.login.p
-00038750: 6173 7377 6f72 6422 2069 6e20 666c 6f77  assword" in flow
-00038760: 5f74 7970 6573 0a20 2020 2020 2020 2020  _types.         
-00038770: 2020 2073 736f 5f61 7661 696c 6162 6c65     sso_available
-00038780: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00038790: 2020 2020 2022 6d2e 6c6f 6769 6e2e 7373       "m.login.ss
-000387a0: 6f22 2069 6e20 666c 6f77 5f74 7970 6573  o" in flow_types
-000387b0: 2061 6e64 2022 6d2e 6c6f 6769 6e2e 746f   and "m.login.to
-000387c0: 6b65 6e22 2069 6e20 666c 6f77 5f74 7970  ken" in flow_typ
-000387d0: 6573 0a20 2020 2020 2020 2020 2020 2029  es.            )
-000387e0: 0a0a 2020 2020 6966 206d 6574 686f 6420  ..    if method 
-000387f0: 3d3d 2022 7373 6f22 2061 6e64 206e 6f74  == "sso" and not
-00038800: 2073 736f 5f61 7661 696c 6162 6c65 3a0a   sso_available:.
-00038810: 2020 2020 2020 2020 7261 6973 6520 4d61          raise Ma
-00038820: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
-00038830: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00038840: 2245 3232 393a 2022 0a20 2020 2020 2020  "E229: ".       
-00038850: 2020 2020 2022 4d65 7468 6f64 2027 7373       "Method 'ss
-00038860: 6f27 2077 6173 2073 656c 6563 7465 6420  o' was selected 
-00038870: 666f 7220 2d2d 6c6f 6769 6e20 6275 7420  for --login but 
-00038880: 4d61 7472 6978 2073 6572 7665 7220 646f  Matrix server do
-00038890: 6573 2022 0a20 2020 2020 2020 2020 2020  es ".           
-000388a0: 2022 6e6f 7420 7375 7070 6f72 7420 5369   "not support Si
-000388b0: 6e67 6c65 2053 6967 6e2d 4f6e 2e20 5472  ngle Sign-On. Tr
-000388c0: 7920 2d2d 6c6f 6769 6e20 7769 7468 206d  y --login with m
-000388d0: 6574 686f 6420 2770 6173 7377 6f72 6427  ethod 'password'
-000388e0: 2e22 0a20 2020 2020 2020 2029 2066 726f  .".        ) fro
-000388f0: 6d20 4e6f 6e65 0a20 2020 2069 6620 6d65  m None.    if me
-00038900: 7468 6f64 203d 3d20 2270 6173 7377 6f72  thod == "passwor
-00038910: 6422 2061 6e64 206e 6f74 2070 6173 7377  d" and not passw
-00038920: 6f72 645f 6176 6169 6c61 626c 653a 0a20  ord_available:. 
-00038930: 2020 2020 2020 2072 6169 7365 204d 6174         raise Mat
-00038940: 7269 7843 6f6d 6d61 6e64 6572 4572 726f  rixCommanderErro
-00038950: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
-00038960: 4532 3330 3a20 220a 2020 2020 2020 2020  E230: ".        
-00038970: 2020 2020 224d 6574 686f 6420 2770 6173      "Method 'pas
-00038980: 7377 6f72 6427 2077 6173 2073 656c 6563  sword' was selec
-00038990: 7465 6420 666f 7220 2d2d 6c6f 6769 6e20  ted for --login 
-000389a0: 6275 7420 4d61 7472 6978 2073 6572 7665  but Matrix serve
-000389b0: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
-000389c0: 2264 6f65 7320 6e6f 7420 7375 7070 6f72  "does not suppor
-000389d0: 7420 7061 7373 776f 7264 206c 6f67 696e  t password login
-000389e0: 2e20 5472 7920 2d2d 6c6f 6769 6e20 7769  . Try --login wi
-000389f0: 7468 206d 6574 686f 6420 2773 736f 272e  th method 'sso'.
-00038a00: 220a 2020 2020 2020 2020 2920 6672 6f6d  ".        ) from
-00038a10: 204e 6f6e 650a 0a20 2020 2023 2053 534f   None..    # SSO
-00038a20: 3a20 5369 6e67 6c65 2053 6967 6e2d 4f6e  : Single Sign-On
-00038a30: 3a0a 2020 2020 2320 7365 6520 6874 7470  :.    # see http
-00038a40: 733a 2f2f 6d61 7472 6978 2e6f 7267 2f64  s://matrix.org/d
-00038a50: 6f63 732f 6775 6964 6573 2f73 736f 2d66  ocs/guides/sso-f
-00038a60: 6f72 2d63 6c69 656e 742d 6465 7665 6c6f  or-client-develo
-00038a70: 7065 7273 0a20 2020 2069 6620 7373 6f5f  pers.    if sso_
-00038a80: 6176 6169 6c61 626c 653a 0a20 2020 2020  available:.     
-00038a90: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00038aa0: 2253 6572 7665 7220 7375 7070 6f72 7473  "Server supports
-00038ab0: 2053 534f 2066 6f72 206c 6f67 696e 2e22   SSO for login."
-00038ac0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00038ad0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
-00038ae0: 2822 5365 7276 6572 2064 6f65 7320 6e6f  ("Server does no
-00038af0: 7420 7375 7070 6f72 7420 5353 4f20 666f  t support SSO fo
-00038b00: 7220 6c6f 6769 6e2e 2229 0a0a 2020 2020  r login.")..    
-00038b10: 6966 206d 6574 686f 6420 3d3d 2022 7373  if method == "ss
-00038b20: 6f22 3a0a 2020 2020 2020 2020 2320 7374  o":.        # st
-00038b30: 6172 7475 7020 7365 7276 6572 2074 6f20  artup server to 
-00038b40: 6861 6e64 6c65 2072 6573 706f 6e73 650a  handle response.
-00038b50: 2020 2020 2020 2020 7374 6f70 5f73 6572          stop_ser
-00038b60: 7665 725f 6576 7420 3d20 6173 796e 6369  ver_evt = asynci
-00038b70: 6f2e 4576 656e 7428 290a 2020 2020 2020  o.Event().      
-00038b80: 2020 6c6f 6769 6e5f 746f 6b65 6e20 3d20    login_token = 
-00038b90: 4e6f 6e65 0a0a 2020 2020 2020 2020 6173  None..        as
-00038ba0: 796e 6320 6465 6620 6861 6e64 6c65 2872  ync def handle(r
-00038bb0: 6571 7565 7374 293a 0a20 2020 2020 2020  equest):.       
-00038bc0: 2020 2020 206e 6f6e 6c6f 6361 6c20 6c6f       nonlocal lo
-00038bd0: 6769 6e5f 746f 6b65 6e0a 2020 2020 2020  gin_token.      
-00038be0: 2020 2020 2020 6c6f 6769 6e5f 746f 6b65        login_toke
-00038bf0: 6e20 3d20 7265 7175 6573 742e 7175 6572  n = request.quer
-00038c00: 792e 6765 7428 226c 6f67 696e 546f 6b65  y.get("loginToke
-00038c10: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
-00038c20: 7374 6f70 5f73 6572 7665 725f 6576 742e  stop_server_evt.
-00038c30: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
-00038c40: 2020 7265 7475 726e 2077 6562 2e52 6573    return web.Res
-00038c50: 706f 6e73 6528 0a20 2020 2020 2020 2020  ponse(.         
-00038c60: 2020 2020 2020 2062 6f64 793d 224c 6f67         body="Log
-00038c70: 696e 2063 6f6d 706c 6574 652e 2059 6f75  in complete. You
-00038c80: 2063 616e 206e 6f77 2063 6c6f 7365 2074   can now close t
-00038c90: 6869 7320 7061 6765 2e22 0a20 2020 2020  his page.".     
-00038ca0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00038cb0: 2020 6170 7020 3d20 7765 622e 4170 706c    app = web.Appl
-00038cc0: 6963 6174 696f 6e28 290a 2020 2020 2020  ication().      
-00038cd0: 2020 6170 702e 6164 645f 726f 7574 6573    app.add_routes
-00038ce0: 285b 7765 622e 6765 7428 222f 222c 2068  ([web.get("/", h
-00038cf0: 616e 646c 6529 5d29 0a0a 2020 2020 2020  andle)])..      
-00038d00: 2020 6c6f 6767 696e 672e 6765 744c 6f67    logging.getLog
-00038d10: 6765 7228 2261 696f 6874 7470 2e61 6363  ger("aiohttp.acc
-00038d20: 6573 7322 292e 7365 744c 6576 656c 286c  ess").setLevel(l
-00038d30: 6f67 6769 6e67 2e57 4152 4e49 4e47 290a  ogging.WARNING).
-00038d40: 2020 2020 2020 2020 7275 6e6e 6572 203d          runner =
-00038d50: 2077 6562 2e41 7070 5275 6e6e 6572 2861   web.AppRunner(a
-00038d60: 7070 290a 2020 2020 2020 2020 6177 6169  pp).        awai
-00038d70: 7420 7275 6e6e 6572 2e73 6574 7570 2829  t runner.setup()
-00038d80: 0a20 2020 2020 2020 2073 6974 6520 3d20  .        site = 
-00038d90: 7765 622e 5443 5053 6974 6528 7275 6e6e  web.TCPSite(runn
-00038da0: 6572 2c20 226c 6f63 616c 686f 7374 222c  er, "localhost",
-00038db0: 2033 3830 3830 290a 2020 2020 2020 2020   38080).        
-00038dc0: 6177 6169 7420 7369 7465 2e73 7461 7274  await site.start
-00038dd0: 2829 0a0a 2020 2020 2020 2020 7472 793a  ()..        try:
-00038de0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
-00038df0: 6c6f 672e 696e 666f 2822 4c61 756e 6368  log.info("Launch
-00038e00: 696e 6720 6272 6f77 7365 7220 746f 2063  ing browser to c
-00038e10: 6f6d 706c 6574 6520 5353 4f20 6c6f 6769  omplete SSO logi
-00038e20: 6e2e 2229 0a20 2020 2020 2020 2020 2020  n.").           
-00038e30: 2069 6620 6773 2e70 612e 7072 6f78 793a   if gs.pa.proxy:
-00038e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038e50: 2067 732e 6c6f 672e 7761 726e 696e 6728   gs.log.warning(
-00038e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038e70: 2020 2020 2022 5731 3130 3a20 220a 2020       "W110: ".  
+000283b0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+000283c0: 3d20 310a 2020 2020 2020 2020 7265 7475  = 1.        retu
+000283d0: 726e 0a20 2020 2073 697a 6520 3d20 300a  rn.    size = 0.
+000283e0: 2020 2020 6966 206c 656e 2867 732e 7061      if len(gs.pa
+000283f0: 2e64 656c 6574 655f 6d78 635f 6265 666f  .delete_mxc_befo
+00028400: 7265 2920 3d3d 2032 3a0a 2020 2020 2020  re) == 2:.      
+00028410: 2020 7369 7a65 203d 2067 732e 7061 2e64    size = gs.pa.d
+00028420: 656c 6574 655f 6d78 635f 6265 666f 7265  elete_mxc_before
+00028430: 5b31 5d0a 2020 2020 6265 666f 7265 5f73  [1].    before_s
+00028440: 7472 203d 2067 732e 7061 2e64 656c 6574  tr = gs.pa.delet
+00028450: 655f 6d78 635f 6265 666f 7265 5b30 5d0a  e_mxc_before[0].
+00028460: 2020 2020 6d69 6c6c 6973 6563 203d 2069      millisec = i
+00028470: 6e74 280a 2020 2020 2020 2020 6461 7465  nt(.        date
+00028480: 7469 6d65 2e64 6174 6574 696d 652e 7374  time.datetime.st
+00028490: 7270 7469 6d65 2862 6566 6f72 655f 7374  rptime(before_st
+000284a0: 722c 2022 2564 2e25 6d2e 2559 2025 483a  r, "%d.%m.%Y %H:
+000284b0: 254d 3a25 5322 292e 7469 6d65 7374 616d  %M:%S").timestam
+000284c0: 7028 290a 2020 2020 2020 2020 2a20 3130  p().        * 10
+000284d0: 3030 0a20 2020 2029 0a0a 2020 2020 6773  00.    )..    gs
+000284e0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
+000284f0: 2020 2020 6622 5072 6570 6172 696e 6720      f"Preparing 
+00028500: 746f 2064 656c 6574 6520 6f62 6a65 6374  to delete object
+00028510: 7320 6f6c 6465 7220 7468 616e 207b 6265  s older than {be
+00028520: 666f 7265 5f73 7472 7d20 220a 2020 2020  fore_str} ".    
+00028530: 2020 2020 6622 2855 6e69 7820 7469 6d65      f"(Unix time
+00028540: 207b 6d69 6c6c 6973 6563 7d29 2061 6e64   {millisec}) and
+00028550: 206c 6172 6765 7220 7468 616e 207b 7369   larger than {si
+00028560: 7a65 7d2e 220a 2020 2020 290a 2020 2020  ze}.".    ).    
+00028570: 6966 2067 732e 7061 2e61 6363 6573 735f  if gs.pa.access_
+00028580: 746f 6b65 6e3a 0a20 2020 2020 2020 2061  token:.        a
+00028590: 7420 3d20 6773 2e70 612e 6163 6365 7373  t = gs.pa.access
+000285a0: 5f74 6f6b 656e 0a20 2020 2020 2020 2067  _token.        g
+000285b0: 732e 6c6f 672e 6465 6275 6728 2255 7369  s.log.debug("Usi
+000285c0: 6e67 2061 6363 6573 7320 746f 6b65 6e20  ng access token 
+000285d0: 6672 6f6d 202d 2d61 6363 6573 732d 746f  from --access-to
+000285e0: 6b65 6e20 6172 6775 6d65 6e74 2e22 290a  ken argument.").
+000285f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00028600: 2020 6174 203d 2063 7265 6465 6e74 6961    at = credentia
+00028610: 6c73 5b22 6163 6365 7373 5f74 6f6b 656e  ls["access_token
+00028620: 225d 0a20 2020 2020 2020 2067 732e 6c6f  "].        gs.lo
+00028630: 672e 6465 6275 6728 2255 7369 6e67 2061  g.debug("Using a
+00028640: 6363 6573 7320 746f 6b65 6e20 6672 6f6d  ccess token from
+00028650: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+00028660: 652e 2229 0a20 2020 2073 7276 5f66 756c  e.").    srv_ful
+00028670: 6c20 3d20 6372 6564 656e 7469 616c 735b  l = credentials[
+00028680: 2268 6f6d 6573 6572 7665 7222 5d20 2023  "homeserver"]  #
+00028690: 2068 7474 7073 3a2f 2f65 7861 6d70 6c65   https://example
+000286a0: 2e6d 6174 7269 782e 6f72 670a 2020 2020  .matrix.org.    
+000286b0: 7372 765f 686f 7374 203d 2075 726c 7061  srv_host = urlpa
+000286c0: 7273 6528 7372 765f 6675 6c6c 292e 686f  rse(srv_full).ho
+000286d0: 7374 6e61 6d65 2020 2320 6578 616d 706c  stname  # exampl
+000286e0: 652e 6d61 7472 6978 2e6f 7267 0a20 2020  e.matrix.org.   
+000286f0: 2072 6573 7420 3d20 280a 2020 2020 2020   rest = (.      
+00028700: 2020 7372 765f 6675 6c6c 0a20 2020 2020    srv_full.     
+00028710: 2020 202b 2022 2f5f 7379 6e61 7073 652f     + "/_synapse/
+00028720: 6164 6d69 6e2f 7631 2f6d 6564 6961 2f22  admin/v1/media/"
+00028730: 0a20 2020 2020 2020 202b 2073 7276 5f68  .        + srv_h
+00028740: 6f73 740a 2020 2020 2020 2020 2b20 222f  ost.        + "/
+00028750: 6465 6c65 7465 3f62 6566 6f72 655f 7473  delete?before_ts
+00028760: 3d22 0a20 2020 2020 2020 202b 2073 7472  =".        + str
+00028770: 286d 696c 6c69 7365 6329 0a20 2020 2020  (millisec).     
+00028780: 2020 202b 2022 2673 697a 655f 6774 3d22     + "&size_gt="
+00028790: 0a20 2020 2020 2020 202b 2073 7472 2873  .        + str(s
+000287a0: 697a 6529 0a20 2020 2020 2020 202b 2022  ize).        + "
+000287b0: 2661 6363 6573 735f 746f 6b65 6e3d 220a  &access_token=".
+000287c0: 2020 2020 2020 2020 2b20 6174 0a20 2020          + at.   
+000287d0: 2029 0a20 2020 2067 732e 6c6f 672e 6465   ).    gs.log.de
+000287e0: 6275 6728 6622 4973 7375 696e 6720 5245  bug(f"Issuing RE
+000287f0: 5354 204d 6174 7269 7820 4150 4920 6361  ST Matrix API ca
+00028800: 6c6c 3a20 504f 5354 207b 7265 7374 7d22  ll: POST {rest}"
+00028810: 290a 2020 2020 636f 6e6e 6563 746f 7220  ).    connector 
+00028820: 3d20 5443 5043 6f6e 6e65 6374 6f72 2873  = TCPConnector(s
+00028830: 736c 3d67 732e 7373 6c29 2020 2320 7365  sl=gs.ssl)  # se
+00028840: 7474 696e 6720 7373 6c63 6f6e 7465 7874  tting sslcontext
+00028850: 0a20 2020 2061 7379 6e63 2077 6974 6820  .    async with 
+00028860: 436c 6965 6e74 5365 7373 696f 6e28 636f  ClientSession(co
+00028870: 6e6e 6563 746f 723d 636f 6e6e 6563 746f  nnector=connecto
+00028880: 7229 2061 7320 7365 7373 696f 6e3a 2020  r) as session:  
+00028890: 2320 6169 6f68 7474 700a 2020 2020 2020  # aiohttp.      
+000288a0: 2020 6173 796e 6320 7769 7468 2073 6573    async with ses
+000288b0: 7369 6f6e 2e70 6f73 7428 7265 7374 2920  sion.post(rest) 
+000288c0: 6173 2072 6573 703a 0a20 2020 2020 2020  as resp:.       
+000288d0: 2020 2020 2073 7461 7475 7320 3d20 7265       status = re
+000288e0: 7370 2e73 7461 7475 7320 2023 2069 6e74  sp.status  # int
+000288f0: 2c20 3230 3020 7375 6363 6573 730a 2020  , 200 success.  
+00028900: 2020 2020 2020 2020 2020 7478 7420 3d20            txt = 
+00028910: 6177 6169 7420 7265 7370 2e74 6578 7428  await resp.text(
+00028920: 2920 2023 2073 7472 2069 6e20 6469 6374  )  # str in dict
+00028930: 2066 6f72 6d61 740a 2020 2020 6966 2073   format.    if s
+00028940: 7461 7475 7320 213d 2032 3030 3a0a 2020  tatus != 200:.  
+00028950: 2020 2020 2020 2320 7478 7420 6973 2073        # txt is s
+00028960: 7472 206c 696b 6520 7468 6973 3a0a 2020  tr like this:.  
+00028970: 2020 2020 2020 2320 7b22 6572 7263 6f64        # {"errcod
+00028980: 6522 3a22 4d5f 464f 5242 4944 4445 4e22  e":"M_FORBIDDEN"
+00028990: 2c22 6572 726f 7222 3a22 596f 7520 6172  ,"error":"You ar
+000289a0: 6520 6e6f 7420 6120 7365 7276 6572 2061  e not a server a
+000289b0: 646d 696e 227d 0a20 2020 2020 2020 2067  dmin"}.        g
+000289c0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+000289d0: 2020 2020 2020 2020 2022 4531 3735 3a20           "E175: 
+000289e0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+000289f0: 4661 696c 6564 2074 6f20 6465 6c65 7465  Failed to delete
+00028a00: 206f 626a 6563 7473 2062 6566 6f72 6520   objects before 
+00028a10: 277b 6265 666f 7265 5f73 7472 7d27 2066  '{before_str}' f
+00028a20: 726f 6d20 7365 7276 6572 2022 0a20 2020  rom server ".   
+00028a30: 2020 2020 2020 2020 2066 2227 7b73 7276           f"'{srv
+00028a40: 5f66 756c 6c7d 272e 2046 6169 6c65 6420  _full}'. Failed 
+00028a50: 7769 7468 2065 7272 6f72 2063 6f64 6520  with error code 
+00028a60: 7b73 7461 7475 737d 2061 6e64 2022 0a20  {status} and ". 
+00028a70: 2020 2020 2020 2020 2020 2066 2265 7272             f"err
+00028a80: 6f72 2074 6578 7420 7b74 7874 7d2e 220a  or text {txt}.".
+00028a90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00028aa0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00028ab0: 3d20 310a 2020 2020 656c 7365 3a0a 2020  = 1.    else:.  
+00028ac0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00028ad0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00028ae0: 6622 4f62 6a65 6374 7320 6f6c 6465 7220  f"Objects older 
+00028af0: 7468 616e 207b 6265 666f 7265 5f73 7472  than {before_str
+00028b00: 7d20 616e 6420 6c61 7267 6572 2074 6861  } and larger tha
+00028b10: 6e20 7b73 697a 657d 2022 0a20 2020 2020  n {size} ".     
+00028b20: 2020 2020 2020 2022 7765 7265 2073 7563         "were suc
+00028b30: 6365 7373 6675 6c6c 7920 6465 6c65 7465  cessfully delete
+00028b40: 6420 6672 6f6d 2073 6572 7665 7220 220a  d from server ".
+00028b50: 2020 2020 2020 2020 2020 2020 6622 7b73              f"{s
+00028b60: 7276 5f66 756c 6c7d 2e20 5265 7370 6f6e  rv_full}. Respon
+00028b70: 7365 2069 733a 205c 6e7b 7478 747d 2e22  se is: \n{txt}."
+00028b80: 0a20 2020 2020 2020 2029 0a0a 0a61 7379  .        )...asy
+00028b90: 6e63 2064 6566 2061 6374 696f 6e5f 646f  nc def action_do
+00028ba0: 776e 6c6f 6164 2863 6c69 656e 743a 2041  wnload(client: A
+00028bb0: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+00028bc0: 656e 7469 616c 733a 2064 6963 7429 202d  entials: dict) -
+00028bd0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2244  > None:.    """D
+00028be0: 6f77 6e6c 6f61 6420 6120 6669 6c65 2066  ownload a file f
+00028bf0: 726f 6d20 636f 6e74 656e 7420 7265 706f  rom content repo
+00028c00: 7369 746f 7279 206f 6620 4d61 7472 6978  sitory of Matrix
+00028c10: 2073 6572 7665 722e 0a20 2020 2041 7373   server..    Ass
+00028c20: 756d 6573 2074 6861 7420 7573 6572 2069  umes that user i
+00028c30: 7320 616c 7265 6164 7920 6c6f 6767 6564  s already logged
+00028c40: 2069 6e2e 0a20 2020 2022 2222 0a20 2020   in..    """.   
+00028c50: 2069 6620 6e6f 7420 6773 2e70 612e 646f   if not gs.pa.do
+00028c60: 776e 6c6f 6164 3a0a 2020 2020 2020 2020  wnload:.        
+00028c70: 6773 2e6c 6f67 2e64 6562 7567 2822 446f  gs.log.debug("Do
+00028c80: 776e 6c6f 6164 206c 6973 7420 6973 2065  wnload list is e
+00028c90: 6d70 7479 2e20 4e6f 7468 696e 6720 746f  mpty. Nothing to
+00028ca0: 2064 6f77 6e6c 6f61 642e 2053 6b69 7070   download. Skipp
+00028cb0: 696e 672e 2229 0a20 2020 2020 2020 2072  ing.").        r
+00028cc0: 6574 7572 6e0a 2020 2020 6669 6c65 6e61  eturn.    filena
+00028cd0: 6d65 7320 3d20 6773 2e70 612e 6669 6c65  mes = gs.pa.file
+00028ce0: 5f6e 616d 650a 2020 2020 6966 2066 696c  _name.    if fil
+00028cf0: 656e 616d 6573 3a0a 2020 2020 2020 2020  enames:.        
+00028d00: 7768 696c 6520 6c65 6e28 6669 6c65 6e61  while len(filena
+00028d10: 6d65 7329 203c 206c 656e 2867 732e 7061  mes) < len(gs.pa
+00028d20: 2e64 6f77 6e6c 6f61 6429 3a0a 2020 2020  .download):.    
+00028d30: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+00028d40: 732e 6170 7065 6e64 284e 6f6e 6529 0a20  s.append(None). 
+00028d50: 2020 2064 6563 7279 7074 696f 6e5f 7374     decryption_st
+00028d60: 7269 6e67 7320 3d20 6773 2e70 612e 6b65  rings = gs.pa.ke
+00028d70: 795f 6469 6374 0a20 2020 2069 6620 6465  y_dict.    if de
+00028d80: 6372 7970 7469 6f6e 5f73 7472 696e 6773  cryption_strings
+00028d90: 3a0a 2020 2020 2020 2020 7768 696c 6520  :.        while 
+00028da0: 6c65 6e28 6465 6372 7970 7469 6f6e 5f73  len(decryption_s
+00028db0: 7472 696e 6773 2920 3c20 6c65 6e28 6773  trings) < len(gs
+00028dc0: 2e70 612e 6b65 795f 6469 6374 293a 0a20  .pa.key_dict):. 
+00028dd0: 2020 2020 2020 2020 2020 2064 6563 7279             decry
+00028de0: 7074 696f 6e5f 7374 7269 6e67 732e 6170  ption_strings.ap
+00028df0: 7065 6e64 284e 6f6e 6529 0a20 2020 2023  pend(None).    #
+00028e00: 2066 696c 656e 616d 6573 2069 7320 6e6f   filenames is no
+00028e10: 7720 4e6f 6e65 206f 7220 6c69 7374 2061  w None or list a
+00028e20: 7420 6c65 6173 7420 6173 206c 6f6e 6720  t least as long 
+00028e30: 6173 2064 6f77 6e6c 6f61 6473 0a20 2020  as downloads.   
+00028e40: 2023 2064 6563 7279 7074 696f 6e5f 7374   # decryption_st
+00028e50: 7269 6e67 7320 6973 206e 6f77 204e 6f6e  rings is now Non
+00028e60: 6520 6f72 206c 6973 7420 6174 206c 6561  e or list at lea
+00028e70: 7374 2061 7320 6c6f 6e67 2061 7320 646f  st as long as do
+00028e80: 776e 6c6f 6164 730a 2020 2020 6773 2e6c  wnloads.    gs.l
+00028e90: 6f67 2e64 6562 7567 2866 2246 696c 6520  og.debug(f"File 
+00028ea0: 6e61 6d65 7320 7072 6f76 6964 6564 2069  names provided i
+00028eb0: 6e20 6172 6775 6d65 6e74 733a 207b 6669  n arguments: {fi
+00028ec0: 6c65 6e61 6d65 737d 2229 0a20 2020 2067  lenames}").    g
+00028ed0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+00028ee0: 2020 2020 2022 4465 6372 7970 7469 6f6e       "Decryption
+00028ef0: 2073 7472 696e 6773 2070 726f 7669 6465   strings provide
+00028f00: 6420 696e 2061 7267 756d 656e 7473 3a20  d in arguments: 
+00028f10: 220a 2020 2020 2020 2020 2227 2a2a 2a20  ".        "'*** 
+00028f20: 6869 6464 656e 2074 6f20 7072 6576 656e  hidden to preven
+00028f30: 7420 6c65 616b 7327 220a 2020 2020 2020  t leaks'".      
+00028f40: 2020 2320 6622 7b64 6563 7279 7074 696f    # f"{decryptio
+00028f50: 6e5f 7374 7269 6e67 737d 220a 2020 2020  n_strings}".    
+00028f60: 290a 2020 2020 6969 203d 2030 0a20 2020  ).    ii = 0.   
+00028f70: 2066 6f72 2064 6f77 6e6c 6f61 6420 696e   for download in
+00028f80: 2067 732e 7061 2e64 6f77 6e6c 6f61 643a   gs.pa.download:
+00028f90: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+00028fa0: 612e 6669 6c65 5f6e 616d 653a 0a20 2020  a.file_name:.   
+00028fb0: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
+00028fc0: 6520 3d20 6669 6c65 6e61 6d65 735b 6969  e = filenames[ii
+00028fd0: 5d20 2023 2031 7374 2063 686f 6963 650a  ]  # 1st choice.
+00028fe0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00028ff0: 2020 2020 2020 2020 2020 2320 326e 6420            # 2nd 
+00029000: 6368 6f69 6365 3b20 6765 7420 6669 6c65  choice; get file
+00029010: 6e61 6d65 2066 726f 6d20 7365 7276 6572  name from server
+00029020: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+00029030: 2e65 2e20 7573 6520 7468 6520 6f72 6967  .e. use the orig
+00029040: 696e 616c 2066 696c 656e 616d 6520 6672  inal filename fr
+00029050: 6f6d 2075 706c 6f61 640a 2020 2020 2020  om upload.      
+00029060: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
+00029070: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
+00029080: 2067 732e 7061 2e6b 6579 5f64 6963 743a   gs.pa.key_dict:
+00029090: 0a20 2020 2020 2020 2020 2020 2064 6563  .            dec
+000290a0: 7279 7074 696f 6e5f 7374 7220 3d20 6465  ryption_str = de
+000290b0: 6372 7970 7469 6f6e 5f73 7472 696e 6773  cryption_strings
+000290c0: 5b69 695d 0a20 2020 2020 2020 2065 6c73  [ii].        els
+000290d0: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+000290e0: 6563 7279 7074 696f 6e5f 7374 7220 3d20  ecryption_str = 
+000290f0: 4e6f 6e65 0a20 2020 2020 2020 2065 6e63  None.        enc
+00029100: 7279 7074 6564 203d 2054 7275 6520 6966  rypted = True if
+00029110: 2064 6563 7279 7074 696f 6e5f 7374 7220   decryption_str 
+00029120: 656c 7365 2046 616c 7365 0a20 2020 2020  else False.     
+00029130: 2020 2069 6620 6e6f 7420 656e 6372 7970     if not encryp
+00029140: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
+00029150: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+00029160: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00029170: 4e6f 206b 6579 2064 6963 7469 6f6e 6172  No key dictionar
+00029180: 7920 7370 6563 6966 6965 6420 7769 7468  y specified with
+00029190: 202d 2d6b 6579 2d64 6963 742e 2053 6f2c   --key-dict. So,
+000291a0: 2069 7420 6973 2022 0a20 2020 2020 2020   it is ".       
+000291b0: 2020 2020 2020 2020 2022 6173 7375 6d65           "assume
+000291c0: 6420 7468 6174 2074 6865 2064 6f77 6e6c  d that the downl
+000291d0: 6f61 6420 6973 206e 6f74 2065 6e63 7279  oad is not encry
+000291e0: 7074 6564 2022 0a20 2020 2020 2020 2020  pted ".         
+000291f0: 2020 2020 2020 2022 2869 2e65 2e20 706c         "(i.e. pl
+00029200: 6169 6e2d 7465 7874 292e 204e 6f20 6465  ain-text). No de
+00029210: 6372 7970 7469 6f6e 2077 696c 6c20 6265  cryption will be
+00029220: 2061 7474 656d 7074 6564 2e22 0a20 2020   attempted.".   
+00029230: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00029240: 2020 206d 7863 203d 2064 6f77 6e6c 6f61     mxc = downloa
+00029250: 640a 2020 2020 2020 2020 7265 7370 203d  d.        resp =
+00029260: 2061 7761 6974 2064 6f77 6e6c 6f61 645f   await download_
+00029270: 6d78 6328 636c 6965 6e74 2c20 6d78 633d  mxc(client, mxc=
+00029280: 6d78 632c 2066 696c 656e 616d 653d 6669  mxc, filename=fi
+00029290: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
+000292a0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+000292b0: 7370 2c20 446f 776e 6c6f 6164 4572 726f  sp, DownloadErro
+000292c0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000292d0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+000292e0: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+000292f0: 3137 363a 2022 0a20 2020 2020 2020 2020  176: ".         
+00029300: 2020 2020 2020 2066 2264 6f77 6e6c 6f61         f"downloa
+00029310: 6420 6f66 2055 5249 2027 7b6d 7863 7d27  d of URI '{mxc}'
+00029320: 2074 6f20 6c6f 6361 6c20 6669 6c65 2027   to local file '
+00029330: 7b66 696c 656e 616d 657d 2720 220a 2020  {filename}' ".  
+00029340: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00029350: 6661 696c 6564 2077 6974 6820 7265 7370  failed with resp
+00029360: 6f6e 7365 207b 7072 6976 6163 795f 6669  onse {privacy_fi
+00029370: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+00029380: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00029390: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
+000293a0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+000293b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000293c0: 2020 2020 2020 2020 7572 6c20 3d20 7572          url = ur
+000293d0: 6c70 6172 7365 286d 7863 290a 2020 2020  lparse(mxc).    
+000293e0: 2020 2020 2020 2020 6d65 6469 615f 6964          media_id
+000293f0: 203d 2075 726c 2e70 6174 682e 7374 7269   = url.path.stri
+00029400: 7028 222f 2229 0a20 2020 2020 2020 2020  p("/").         
+00029410: 2020 2069 6620 6669 6c65 6e61 6d65 203d     if filename =
+00029420: 3d20 2222 3a0a 2020 2020 2020 2020 2020  = "":.          
+00029430: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
+00029440: 2022 6d78 632d 2220 2b20 4d58 435f 4944   "mxc-" + MXC_ID
+00029450: 5f50 4c41 4345 484f 4c44 4552 0a20 2020  _PLACEHOLDER.   
+00029460: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00029470: 6669 6c65 6e61 6d65 3a0a 2020 2020 2020  filename:.      
+00029480: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
+00029490: 6d65 203d 2072 6573 702e 6669 6c65 6e61  me = resp.filena
+000294a0: 6d65 2020 2320 326e 6420 6368 6f69 6365  me  # 2nd choice
+000294b0: 2c20 6672 6f6d 2073 6572 7665 720a 2020  , from server.  
+000294c0: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+000294d0: 2e6c 6f67 2e64 6562 7567 2866 2246 696c  .log.debug(f"Fil
+000294e0: 6520 6e61 6d65 206f 6e20 7365 7276 6572  e name on server
+000294f0: 3a20 7b66 696c 656e 616d 6573 7d22 290a  : {filenames}").
+00029500: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00029510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029520: 2020 6669 6c65 6e61 6d65 203d 2066 696c    filename = fil
+00029530: 656e 616d 652e 7265 706c 6163 6528 4d58  ename.replace(MX
+00029540: 435f 4944 5f50 4c41 4345 484f 4c44 4552  C_ID_PLACEHOLDER
+00029550: 2c20 6d65 6469 615f 6964 290a 2020 2020  , media_id).    
+00029560: 2020 2020 2020 2020 6966 206e 6f74 2066          if not f
+00029570: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
+00029580: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
+00029590: 6520 3d20 226d 7863 2d22 202b 206d 6564  e = "mxc-" + med
+000295a0: 6961 5f69 6420 2023 2033 7264 2063 686f  ia_id  # 3rd cho
+000295b0: 6963 652c 206d 7863 5f69 640a 2020 2020  ice, mxc_id.    
+000295c0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+000295d0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+000295e0: 2020 2020 2020 6622 446f 776e 6c6f 6164        f"Download
+000295f0: 206f 6620 5552 4920 277b 6d78 637d 2720   of URI '{mxc}' 
+00029600: 746f 206c 6f63 616c 2066 696c 6520 277b  to local file '{
+00029610: 6669 6c65 6e61 6d65 7d27 2022 0a20 2020  filename}' ".   
+00029620: 2020 2020 2020 2020 2020 2020 2066 2273               f"s
+00029630: 7563 6365 7373 6675 6c20 7769 7468 207b  uccessful with {
+00029640: 6c65 6e28 7265 7370 2e62 6f64 7929 7d20  len(resp.body)} 
+00029650: 6279 7465 7320 6f66 2064 6174 6120 646f  bytes of data do
+00029660: 776e 6c6f 6164 6564 2c20 220a 2020 2020  wnloaded, ".    
+00029670: 2020 2020 2020 2020 2020 2020 6622 636f              f"co
+00029680: 6e74 656e 745f 7479 7065 207b 7265 7370  ntent_type {resp
+00029690: 2e63 6f6e 7465 6e74 5f74 7970 657d 3b20  .content_type}; 
+000296a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000296b0: 2020 6622 7265 6d6f 7465 2066 696c 656e    f"remote filen
+000296c0: 616d 6520 7b72 6573 702e 6669 6c65 6e61  ame {resp.filena
+000296d0: 6d65 7d3b 2022 0a20 2020 2020 2020 2020  me}; ".         
+000296e0: 2020 2020 2020 2066 2265 6e63 7279 7074         f"encrypt
+000296f0: 6564 207b 656e 6372 7970 7465 647d 3b20  ed {encrypted}; 
+00029700: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00029710: 2020 226b 6579 2064 6963 7469 6f6e 6172    "key dictionar
+00029720: 7920 272a 2a2a 2068 6964 6465 6e20 746f  y '*** hidden to
+00029730: 2070 7265 7665 6e74 206c 6561 6b73 272e   prevent leaks'.
+00029740: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00029750: 2020 2023 2066 226b 6579 2064 6963 7469     # f"key dicti
+00029760: 6f6e 6172 7920 7b64 6563 7279 7074 696f  onary {decryptio
+00029770: 6e5f 7374 727d 2e20 220a 2020 2020 2020  n_str}. ".      
+00029780: 2020 2020 2020 2020 2020 2254 7279 696e            "Tryin
+00029790: 6720 746f 2073 6176 6520 6461 7461 206e  g to save data n
+000297a0: 6f77 2e22 0a20 2020 2020 2020 2020 2020  ow.".           
+000297b0: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+000297c0: 6620 656e 6372 7970 7465 643a 0a20 2020  f encrypted:.   
+000297d0: 2020 2020 2020 2020 2020 2020 2064 6563               dec
+000297e0: 7279 7074 696f 6e5f 6469 6374 203d 2061  ryption_dict = a
+000297f0: 7374 2e6c 6974 6572 616c 5f65 7661 6c28  st.literal_eval(
+00029800: 6465 6372 7970 7469 6f6e 5f73 7472 290a  decryption_str).
+00029810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029820: 7769 7468 206f 7065 6e28 6669 6c65 6e61  with open(filena
+00029830: 6d65 2c20 2277 6222 2920 6173 2066 696c  me, "wb") as fil
+00029840: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00029850: 2020 2020 2020 2066 696c 652e 7772 6974         file.writ
+00029860: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00029870: 2020 2020 2020 2020 2020 2063 7279 7074             crypt
+00029880: 6f2e 6174 7461 6368 6d65 6e74 732e 6465  o.attachments.de
+00029890: 6372 7970 745f 6174 7461 6368 6d65 6e74  crypt_attachment
+000298a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000298b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000298c0: 7370 2e62 6f64 792c 0a20 2020 2020 2020  sp.body,.       
+000298d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000298e0: 2020 2020 2064 6563 7279 7074 696f 6e5f       decryption_
+000298f0: 6469 6374 5b22 6b65 7922 5d5b 226b 225d  dict["key"]["k"]
+00029900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029910: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00029920: 6372 7970 7469 6f6e 5f64 6963 745b 2268  cryption_dict["h
+00029930: 6173 6865 7322 5d5b 2273 6861 3235 3622  ashes"]["sha256"
+00029940: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00029950: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00029960: 6563 7279 7074 696f 6e5f 6469 6374 5b22  ecryption_dict["
+00029970: 6976 225d 2c0a 2020 2020 2020 2020 2020  iv"],.          
+00029980: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00029990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000299a0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000299b0: 2020 656c 7365 3a20 2023 2070 6c61 696e    else:  # plain
+000299c0: 2c20 756e 656e 6372 7970 7465 640a 2020  , unencrypted.  
+000299d0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+000299e0: 7468 206f 7065 6e28 6669 6c65 6e61 6d65  th open(filename
+000299f0: 2c20 2277 6222 2920 6173 2066 696c 653a  , "wb") as file:
+00029a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029a10: 2020 2020 2066 696c 652e 7772 6974 6528       file.write(
+00029a20: 7265 7370 2e62 6f64 7929 0a20 2020 2020  resp.body).     
+00029a30: 2020 2069 6920 2b3d 2031 0a0a 0a61 7379     ii += 1...asy
+00029a40: 6e63 2064 6566 2061 6374 696f 6e5f 6a6f  nc def action_jo
+00029a50: 696e 6564 5f72 6f6f 6d73 2863 6c69 656e  ined_rooms(clien
+00029a60: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
+00029a70: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
+00029a80: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+00029a90: 2222 2247 6574 206a 6f69 6e65 6420 726f  """Get joined ro
+00029aa0: 6f6d 7320 7768 696c 6520 616c 7265 6164  oms while alread
+00029ab0: 7920 6c6f 6767 6564 2069 6e2e 2222 220a  y logged in.""".
+00029ac0: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
+00029ad0: 2063 6c69 656e 742e 6a6f 696e 6564 5f72   client.joined_r
+00029ae0: 6f6f 6d73 2829 0a20 2020 2069 6620 6973  ooms().    if is
+00029af0: 696e 7374 616e 6365 2872 6573 702c 204a  instance(resp, J
+00029b00: 6f69 6e65 6452 6f6f 6d73 4572 726f 7229  oinedRoomsError)
+00029b10: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+00029b20: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+00029b30: 2020 2020 2245 3137 373a 2022 2066 226a      "E177: " f"j
+00029b40: 6f69 6e65 645f 726f 6f6d 7320 6661 696c  oined_rooms fail
+00029b50: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
+00029b60: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+00029b70: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
+00029b80: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+00029b90: 756e 7420 2b3d 2031 0a20 2020 2065 6c73  unt += 1.    els
+00029ba0: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+00029bb0: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00029bc0: 2020 2020 2066 226a 6f69 6e65 645f 726f       f"joined_ro
+00029bd0: 6f6d 7320 7375 6363 6573 7366 756c 2077  oms successful w
+00029be0: 6974 6820 7b70 7269 7661 6379 5f66 696c  ith {privacy_fil
+00029bf0: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00029c00: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00029c10: 2020 2023 206f 7574 7075 7420 666f 726d     # output form
+00029c20: 6174 2063 6f6e 7472 6f6c 6c65 6420 7669  at controlled vi
+00029c30: 6120 2d2d 6f75 7470 7574 2066 6c61 670a  a --output flag.
+00029c40: 2020 2020 2020 2020 7465 7874 203d 2022          text = "
+00029c50: 220a 2020 2020 2020 2020 666f 7220 7272  ".        for rr
+00029c60: 2069 6e20 7265 7370 2e72 6f6f 6d73 3a0a   in resp.rooms:.
+00029c70: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00029c80: 202b 3d20 7272 202b 2022 5c6e 220a 2020   += rr + "\n".  
+00029c90: 2020 2020 2020 7465 7874 203d 2074 6578        text = tex
+00029ca0: 742e 7374 7269 7028 290a 2020 2020 2020  t.strip().      
+00029cb0: 2020 2320 4f62 6a65 6374 206f 6620 7479    # Object of ty
+00029cc0: 7065 2078 7878 5265 7370 6f6e 7365 2069  pe xxxResponse i
+00029cd0: 7320 6e6f 7420 4a53 4f4e 0a20 2020 2020  s not JSON.     
+00029ce0: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
+00029cf0: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
+00029d00: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
+00029d10: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+00029d20: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
+00029d30: 0a20 2020 2020 2020 2023 206a 736f 6e5f  .        # json_
+00029d40: 6d61 782e 7570 6461 7465 287b 226b 6579  max.update({"key
+00029d50: 223a 2076 616c 7565 7d29 2020 2320 6164  ": value})  # ad
+00029d60: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
+00029d70: 2020 2020 206a 736f 6e5f 203d 206a 736f       json_ = jso
+00029d80: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
+00029d90: 2020 2020 206a 736f 6e5f 2e70 6f70 2822       json_.pop("
+00029da0: 7472 616e 7370 6f72 745f 7265 7370 6f6e  transport_respon
+00029db0: 7365 2229 0a20 2020 2020 2020 206a 736f  se").        jso
+00029dc0: 6e5f 7370 6563 203d 204e 6f6e 650a 2020  n_spec = None.  
+00029dd0: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
+00029de0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+00029df0: 6773 2e70 612e 6f75 7470 7574 2c0a 2020  gs.pa.output,.  
+00029e00: 2020 2020 2020 2020 2020 7465 7874 3d74            text=t
+00029e10: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
+00029e20: 206a 736f 6e5f 3d6a 736f 6e5f 2c0a 2020   json_=json_,.  
+00029e30: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+00029e40: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
+00029e50: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+00029e60: 6563 3d6a 736f 6e5f 7370 6563 2c0a 2020  ec=json_spec,.  
+00029e70: 2020 2020 2020 290a 0a0a 6173 796e 6320        )...async 
+00029e80: 6465 6620 6163 7469 6f6e 5f6a 6f69 6e65  def action_joine
+00029e90: 645f 6d65 6d62 6572 7328 0a20 2020 2063  d_members(.    c
+00029ea0: 6c69 656e 743a 2041 7379 6e63 436c 6965  lient: AsyncClie
+00029eb0: 6e74 2c20 6372 6564 656e 7469 616c 733a  nt, credentials:
+00029ec0: 2064 6963 740a 2920 2d3e 204e 6f6e 653a   dict.) -> None:
+00029ed0: 0a20 2020 2022 2222 4765 7420 6d65 6d62  .    """Get memb
+00029ee0: 6572 7320 6f66 2067 6976 656e 2072 6f6f  ers of given roo
+00029ef0: 6d73 2077 6869 6c65 2061 6c72 6561 6479  ms while already
+00029f00: 2062 6569 6e67 206c 6f67 6765 6420 696e   being logged in
+00029f10: 2e22 2222 0a20 2020 2072 6f6f 6d73 203d  .""".    rooms =
+00029f20: 2067 732e 7061 2e6a 6f69 6e65 645f 6d65   gs.pa.joined_me
+00029f30: 6d62 6572 730a 2020 2020 6966 206e 6f74  mbers.    if not
+00029f40: 2072 6f6f 6d73 3a0a 2020 2020 2020 2020   rooms:.        
+00029f50: 6773 2e6c 6f67 2e77 6172 6e69 6e67 280a  gs.log.warning(.
+00029f60: 2020 2020 2020 2020 2020 2020 2257 3130              "W10
+00029f70: 373a 2022 0a20 2020 2020 2020 2020 2020  7: ".           
+00029f80: 2022 4e6f 206d 656d 6265 7273 6869 7020   "No membership 
+00029f90: 6163 7469 6f6e 2873 2920 7765 7265 2070  action(s) were p
+00029fa0: 6572 666f 726d 6564 2062 6563 6175 7365  erformed because
+00029fb0: 206e 6f20 726f 6f6d 7320 220a 2020 2020   no rooms ".    
+00029fc0: 2020 2020 2020 2020 2277 6572 6520 7370          "were sp
+00029fd0: 6563 6966 6965 642e 2055 7365 202d 2d6a  ecified. Use --j
+00029fe0: 6f69 6e65 642d 6d65 6d62 6572 7320 6f70  oined-members op
+00029ff0: 7469 6f6e 2061 6e64 2073 7065 6369 6679  tion and specify
+0002a000: 2072 6f6f 6d73 2e22 0a20 2020 2020 2020   rooms.".       
+0002a010: 2029 0a20 2020 2020 2020 2067 732e 7761   ).        gs.wa
+0002a020: 726e 5f63 6f75 6e74 202b 3d20 310a 2020  rn_count += 1.  
+0002a030: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0002a040: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
+0002a050: 2254 7279 696e 6720 746f 2067 6574 206d  "Trying to get m
+0002a060: 656d 6265 7273 2066 6f72 2074 6865 7365  embers for these
+0002a070: 2072 6f6f 6d73 3a20 7b72 6f6f 6d73 7d22   rooms: {rooms}"
+0002a080: 290a 2020 2020 6966 2022 2a22 2069 6e20  ).    if "*" in 
+0002a090: 726f 6f6d 733a 0a20 2020 2020 2020 2072  rooms:.        r
+0002a0a0: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+0002a0b0: 6e74 2e6a 6f69 6e65 645f 726f 6f6d 7328  nt.joined_rooms(
+0002a0c0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
+0002a0d0: 6e73 7461 6e63 6528 7265 7370 2c20 4a6f  nstance(resp, Jo
+0002a0e0: 696e 6564 526f 6f6d 7345 7272 6f72 293a  inedRoomsError):
+0002a0f0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0002a100: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+0002a110: 2020 2020 2020 2020 2020 2022 4531 3738             "E178
+0002a120: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+0002a130: 2020 2020 226a 6f69 6e65 645f 726f 6f6d      "joined_room
+0002a140: 7320 6661 696c 6564 2077 6974 6820 220a  s failed with ".
+0002a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a160: 6622 7b70 7269 7661 6379 5f66 696c 7465  f"{privacy_filte
+0002a170: 7228 7374 7228 7265 7370 2929 7d2e 204e  r(str(resp))}. N
+0002a180: 6f74 2061 626c 6520 746f 2022 0a20 2020  ot able to ".   
+0002a190: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
+0002a1a0: 7420 616c 6c20 726f 6f6d 7320 6173 2073  t all rooms as s
+0002a1b0: 7065 6369 6669 6564 2062 7920 272a 272e  pecified by '*'.
+0002a1c0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0002a1d0: 2020 2022 5468 6520 6d65 6d62 6572 206c     "The member l
+0002a1e0: 6973 7469 6e67 2077 696c 6c20 6265 2069  isting will be i
+0002a1f0: 6e63 6f6d 706c 6574 6520 6f72 206d 6973  ncomplete or mis
+0002a200: 7369 6e67 2e22 0a20 2020 2020 2020 2020  sing.".         
+0002a210: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002a220: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+0002a230: 2031 0a20 2020 2020 2020 2020 2020 2023   1.            #
+0002a240: 2073 696e 6365 2077 6520 6361 6e27 7420   since we can't 
+0002a250: 6765 7420 616c 6c20 726f 6f6d 7320 6c65  get all rooms le
+0002a260: 6176 6520 726f 6f6d 206c 6973 7420 6173  ave room list as
+0002a270: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+0002a280: 726f 6f6d 7320 3d20 6669 6c74 6572 286c  rooms = filter(l
+0002a290: 616d 6264 6120 7661 6c3a 2076 616c 2021  ambda val: val !
+0002a2a0: 3d20 222a 222c 2072 6f6f 6d73 2920 2023  = "*", rooms)  #
+0002a2b0: 2072 656d 6f76 6520 616c 6c20 2a0a 2020   remove all *.  
+0002a2c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002a2d0: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0002a2e0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0002a2f0: 2020 2020 2020 6622 6a6f 696e 6564 5f72        f"joined_r
+0002a300: 6f6f 6d73 2073 7563 6365 7373 6675 6c20  ooms successful 
+0002a310: 7769 7468 207b 7072 6976 6163 795f 6669  with {privacy_fi
+0002a320: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+0002a330: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0002a340: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0002a350: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+0002a360: 2020 2020 2020 2020 2020 2252 6f6f 6d20            "Room 
+0002a370: 6c69 7374 2068 6173 2062 6565 6e20 7375  list has been su
+0002a380: 6363 6573 7366 756c 6c79 206f 7665 7277  ccessfully overw
+0002a390: 7269 7474 656e 2077 6974 6820 272a 2722  ritten with '*'"
+0002a3a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0002a3b0: 2020 2020 2020 2020 2020 2072 6f6f 6d73             rooms
+0002a3c0: 203d 2072 6573 702e 726f 6f6d 7320 2023   = resp.rooms  #
+0002a3d0: 206f 7665 7277 7269 7465 2061 7267 7320   overwrite args 
+0002a3e0: 7769 7468 2066 756c 6c20 6c69 7374 0a20  with full list. 
+0002a3f0: 2020 2066 6f72 2072 6f6f 6d20 696e 2072     for room in r
+0002a400: 6f6f 6d73 3a0a 2020 2020 2020 2020 726f  ooms:.        ro
+0002a410: 6f6d 203d 2072 6f6f 6d2e 7265 706c 6163  om = room.replac
+0002a420: 6528 7222 5c21 222c 2022 2122 2920 2023  e(r"\!", "!")  #
+0002a430: 2072 656d 6f76 6520 706f 7373 6962 6c65   remove possible
+0002a440: 2065 7363 6170 650a 2020 2020 2020 2020   escape.        
+0002a450: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+0002a460: 656e 742e 6a6f 696e 6564 5f6d 656d 6265  ent.joined_membe
+0002a470: 7273 2872 6f6f 6d29 0a20 2020 2020 2020  rs(room).       
+0002a480: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+0002a490: 6573 702c 204a 6f69 6e65 644d 656d 6265  esp, JoinedMembe
+0002a4a0: 7273 4572 726f 7229 3a0a 2020 2020 2020  rsError):.      
+0002a4b0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+0002a4c0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0002a4d0: 2020 2020 2245 3137 393a 2022 0a20 2020      "E179: ".   
+0002a4e0: 2020 2020 2020 2020 2020 2020 2066 226a               f"j
+0002a4f0: 6f69 6e65 645f 6d65 6d62 6572 7320 6661  oined_members fa
+0002a500: 696c 6564 2077 6974 6820 7b70 7269 7661  iled with {priva
+0002a510: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+0002a520: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+0002a530: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002a540: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+0002a550: 2031 0a20 2020 2020 2020 2065 6c73 653a   1.        else:
+0002a560: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0002a570: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0002a580: 2020 2020 2020 2020 2020 2066 226a 6f69             f"joi
+0002a590: 6e65 645f 6d65 6d62 6572 7320 7375 6363  ned_members succ
+0002a5a0: 6573 7366 756c 2077 6974 6820 7b70 7269  essful with {pri
+0002a5b0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+0002a5c0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+0002a5d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002a5e0: 2020 2023 206d 656d 6265 7273 203d 204c     # members = L
+0002a5f0: 6973 745b 526f 6f6d 4d65 6d62 6572 5d20  ist[RoomMember] 
+0002a600: 3b20 526f 6f6d 4d65 6d62 6572 0a20 2020  ; RoomMember.   
+0002a610: 2020 2020 2020 2020 2023 206f 7574 7075           # outpu
+0002a620: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
+0002a630: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
+0002a640: 2066 6c61 670a 2020 2020 2020 2020 2020   flag.          
+0002a650: 2020 7465 7874 203d 2072 6573 702e 726f    text = resp.ro
+0002a660: 6f6d 5f69 6420 2b20 225c 6e22 0a20 2020  om_id + "\n".   
+0002a670: 2020 2020 2020 2020 2066 6f72 206d 656d           for mem
+0002a680: 6265 7220 696e 2072 6573 702e 6d65 6d62  ber in resp.memb
+0002a690: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0002a6a0: 2020 2020 2023 2063 6f6e 7665 7274 204e       # convert N
+0002a6b0: 6f6e 6520 746f 2027 270a 2020 2020 2020  one to ''.      
+0002a6c0: 2020 2020 2020 2020 2020 7465 7874 202b            text +
+0002a6d0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0002a6e0: 2020 2020 2020 2020 5345 500a 2020 2020          SEP.    
+0002a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a700: 2b20 6d65 6d62 6572 2e75 7365 725f 6964  + member.user_id
+0002a710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a720: 2020 2020 202b 2053 4550 0a20 2020 2020       + SEP.     
+0002a730: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0002a740: 207a 6e28 6d65 6d62 6572 2e64 6973 706c   zn(member.displ
+0002a750: 6179 5f6e 616d 6529 0a20 2020 2020 2020  ay_name).       
+0002a760: 2020 2020 2020 2020 2020 2020 202b 2053               + S
+0002a770: 4550 0a20 2020 2020 2020 2020 2020 2020  EP.             
+0002a780: 2020 2020 2020 202b 207a 6e28 6d65 6d62         + zn(memb
+0002a790: 6572 2e61 7661 7461 725f 7572 6c29 0a20  er.avatar_url). 
+0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7b0: 2020 202b 2022 5c6e 220a 2020 2020 2020     + "\n".      
+0002a7c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002a7d0: 2020 2020 2020 2020 7465 7874 203d 2074          text = t
+0002a7e0: 6578 742e 7374 7269 7028 290a 2020 2020  ext.strip().    
+0002a7f0: 2020 2020 2020 2020 2320 4f62 6a65 6374          # Object
+0002a800: 206f 6620 7479 7065 2078 7878 5265 7370   of type xxxResp
+0002a810: 6f6e 7365 2069 7320 6e6f 7420 4a53 4f4e  onse is not JSON
+0002a820: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+0002a830: 6572 6961 6c69 7a61 626c 652c 2068 656e  erializable, hen
+0002a840: 6365 2077 6520 7573 6520 7468 6520 6469  ce we use the di
+0002a850: 6374 696f 6e61 7279 2e0a 2020 2020 2020  ctionary..      
+0002a860: 2020 2020 2020 6a73 6f6e 5f6d 6178 203d        json_max =
+0002a870: 2072 6573 702e 5f5f 6469 6374 5f5f 0a20   resp.__dict__. 
+0002a880: 2020 2020 2020 2020 2020 2023 206a 736f             # jso
+0002a890: 6e5f 6d61 782e 7570 6461 7465 287b 226b  n_max.update({"k
+0002a8a0: 6579 223a 2076 616c 7565 7d29 2020 2320  ey": value})  # 
+0002a8b0: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
+0002a8c0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002a8d0: 203d 206a 736f 6e5f 6d61 782e 636f 7079   = json_max.copy
+0002a8e0: 2829 0a20 2020 2020 2020 2020 2020 206a  ().            j
+0002a8f0: 736f 6e5f 2e70 6f70 2822 7472 616e 7370  son_.pop("transp
+0002a900: 6f72 745f 7265 7370 6f6e 7365 2229 0a20  ort_response"). 
+0002a910: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002a920: 7370 6563 203d 204e 6f6e 650a 2020 2020  spec = None.    
+0002a930: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
+0002a940: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+0002a950: 2020 2020 2020 6773 2e70 612e 6f75 7470        gs.pa.outp
+0002a960: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+0002a970: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
+0002a980: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0002a990: 736f 6e5f 3d6a 736f 6e5f 2c0a 2020 2020  son_=json_,.    
+0002a9a0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002a9b0: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
+0002a9c0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0002a9d0: 736f 6e5f 7370 6563 3d6a 736f 6e5f 7370  son_spec=json_sp
+0002a9e0: 6563 2c0a 2020 2020 2020 2020 2020 2020  ec,.            
+0002a9f0: 290a 0a0a 6173 796e 6320 6465 6620 6163  )...async def ac
+0002aa00: 7469 6f6e 5f6d 7863 5f74 6f5f 6874 7470  tion_mxc_to_http
+0002aa10: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
+0002aa20: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
+0002aa30: 733a 2064 6963 7429 202d 3e20 4e6f 6e65  s: dict) -> None
+0002aa40: 3a0a 2020 2020 2222 2243 6f6e 7665 7274  :.    """Convert
+0002aa50: 204d 5843 2055 5249 2074 6f20 4854 5450   MXC URI to HTTP
+0002aa60: 2055 524c 2077 6869 6c65 2061 6c72 6561   URL while alrea
+0002aa70: 6479 206c 6f67 6765 6420 696e 2e22 2222  dy logged in."""
+0002aa80: 0a20 2020 2066 6f72 206d 7863 2069 6e20  .    for mxc in 
+0002aa90: 6773 2e70 612e 6d78 635f 746f 5f68 7474  gs.pa.mxc_to_htt
+0002aaa0: 703a 0a20 2020 2020 2020 206d 7863 203d  p:.        mxc =
+0002aab0: 206d 7863 2e73 7472 6970 2829 0a20 2020   mxc.strip().   
+0002aac0: 2020 2020 2068 7474 7020 3d20 6177 6169       http = awai
+0002aad0: 7420 636c 6965 6e74 2e6d 7863 5f74 6f5f  t client.mxc_to_
+0002aae0: 6874 7470 286d 7863 2920 2023 2072 6574  http(mxc)  # ret
+0002aaf0: 7572 6e73 204e 6f6e 6520 6f72 2073 7472  urns None or str
+0002ab00: 0a20 2020 2020 2020 2023 206f 7574 7075  .        # outpu
+0002ab10: 7420 666f 726d 6174 2063 6f6e 7472 6f6c  t format control
+0002ab20: 6c65 6420 7669 6120 2d2d 6f75 7470 7574  led via --output
+0002ab30: 2066 6c61 670a 2020 2020 2020 2020 7465   flag.        te
+0002ab40: 7874 203d 2066 227b 6d78 637d 7b53 4550  xt = f"{mxc}{SEP
+0002ab50: 7d7b 6874 7470 7d22 0a20 2020 2020 2020  }{http}".       
+0002ab60: 206a 736f 6e5f 6d61 7820 3d20 7b22 6d78   json_max = {"mx
+0002ab70: 6322 3a20 6d78 632c 2022 6874 7470 223a  c": mxc, "http":
+0002ab80: 2068 7474 707d 0a20 2020 2020 2020 2023   http}.        #
+0002ab90: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
+0002aba0: 287b 226b 6579 223a 2076 616c 7565 7d29  ({"key": value})
+0002abb0: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
+0002abc0: 6d73 0a20 2020 2020 2020 206a 736f 6e5f  ms.        json_
+0002abd0: 203d 206a 736f 6e5f 6d61 782e 636f 7079   = json_max.copy
+0002abe0: 2829 0a20 2020 2020 2020 2023 206a 736f  ().        # jso
+0002abf0: 6e5f 2e70 6f70 2822 6b65 7922 290a 2020  n_.pop("key").  
+0002ac00: 2020 2020 2020 6a73 6f6e 5f73 7065 6320        json_spec 
+0002ac10: 3d20 4e6f 6e65 0a20 2020 2020 2020 2070  = None.        p
+0002ac20: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
+0002ac30: 2020 2020 2020 2020 2067 732e 7061 2e6f           gs.pa.o
+0002ac40: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+0002ac50: 2020 2074 6578 743d 7465 7874 2c0a 2020     text=text,.  
+0002ac60: 2020 2020 2020 2020 2020 6a73 6f6e 5f3d            json_=
+0002ac70: 6a73 6f6e 5f2c 0a20 2020 2020 2020 2020  json_,.         
+0002ac80: 2020 206a 736f 6e5f 6d61 783d 6a73 6f6e     json_max=json
+0002ac90: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
+0002aca0: 2020 6a73 6f6e 5f73 7065 633d 6a73 6f6e    json_spec=json
+0002acb0: 5f73 7065 632c 0a20 2020 2020 2020 2029  _spec,.        )
+0002acc0: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
+0002acd0: 696f 6e5f 6465 7669 6365 7328 636c 6965  ion_devices(clie
+0002ace0: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
+0002acf0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
+0002ad00: 6374 2920 2d3e 204e 6f6e 653a 0a20 2020  ct) -> None:.   
+0002ad10: 2022 2222 4c69 7374 2064 6576 6963 6573   """List devices
+0002ad20: 206f 6620 6163 636f 756e 7420 7768 696c   of account whil
+0002ad30: 6520 616c 7265 6164 7920 6c6f 6767 6564  e already logged
+0002ad40: 2069 6e2e 2222 220a 2020 2020 7265 7370   in.""".    resp
+0002ad50: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0002ad60: 6465 7669 6365 7328 290a 2020 2020 6966  devices().    if
+0002ad70: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+0002ad80: 2c20 4465 7669 6365 7345 7272 6f72 293a  , DevicesError):
+0002ad90: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+0002ada0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+0002adb0: 2020 2022 4531 3830 3a20 2220 6622 6465     "E180: " f"de
+0002adc0: 7669 6365 7320 6661 696c 6564 2077 6974  vices failed wit
+0002add0: 6820 7b70 7269 7661 6379 5f66 696c 7465  h {privacy_filte
+0002ade0: 7228 7374 7228 7265 7370 2929 7d22 0a20  r(str(resp))}". 
+0002adf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002ae00: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+0002ae10: 2031 0a20 2020 2065 6c73 653a 0a20 2020   1.    else:.   
+0002ae20: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+0002ae30: 6728 6622 6465 7669 6365 7320 7375 6363  g(f"devices succ
+0002ae40: 6573 7366 756c 2077 6974 6820 7b70 7269  essful with {pri
+0002ae50: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+0002ae60: 7265 7370 2929 7d22 290a 2020 2020 2020  resp))}").      
+0002ae70: 2020 2320 6f75 7470 7574 2066 6f72 6d61    # output forma
+0002ae80: 7420 636f 6e74 726f 6c6c 6564 2076 6961  t controlled via
+0002ae90: 202d 2d6f 7574 7075 7420 666c 6167 0a20   --output flag. 
+0002aea0: 2020 2020 2020 2074 6578 7420 3d20 2222         text = ""
+0002aeb0: 0a20 2020 2020 2020 2066 6f72 2072 7220  .        for rr 
+0002aec0: 696e 2072 6573 702e 6465 7669 6365 733a  in resp.devices:
+0002aed0: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
+0002aee0: 7420 2b3d 2028 0a20 2020 2020 2020 2020  t += (.         
+0002aef0: 2020 2020 2020 2072 722e 6964 0a20 2020         rr.id.   
+0002af00: 2020 2020 2020 2020 2020 2020 202b 2053               + S
+0002af10: 4550 0a20 2020 2020 2020 2020 2020 2020  EP.             
+0002af20: 2020 202b 2072 722e 6469 7370 6c61 795f     + rr.display_
+0002af30: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+0002af40: 2020 2020 202b 2053 4550 0a20 2020 2020       + SEP.     
+0002af50: 2020 2020 2020 2020 2020 202b 2072 722e             + rr.
+0002af60: 6c61 7374 5f73 6565 6e5f 6970 0a20 2020  last_seen_ip.   
+0002af70: 2020 2020 2020 2020 2020 2020 202b 2053               + S
+0002af80: 4550 0a20 2020 2020 2020 2020 2020 2020  EP.             
+0002af90: 2020 202b 2073 7472 2872 722e 6c61 7374     + str(rr.last
+0002afa0: 5f73 6565 6e5f 6461 7465 290a 2020 2020  _seen_date).    
+0002afb0: 2020 2020 2020 2020 2020 2020 2b20 225c              + "\
+0002afc0: 6e22 0a20 2020 2020 2020 2020 2020 2029  n".            )
+0002afd0: 0a20 2020 2020 2020 2074 6578 7420 3d20  .        text = 
+0002afe0: 7465 7874 2e73 7472 6970 2829 0a20 2020  text.strip().   
+0002aff0: 2020 2020 2023 204f 626a 6563 7420 6f66       # Object of
+0002b000: 2074 7970 6520 7878 7852 6573 706f 6e73   type xxxRespons
+0002b010: 6520 6973 206e 6f74 204a 534f 4e0a 2020  e is not JSON.  
+0002b020: 2020 2020 2020 2320 7365 7269 616c 697a        # serializ
+0002b030: 6162 6c65 2c20 6865 6e63 6520 7765 2075  able, hence we u
+0002b040: 7365 2074 6865 2064 6963 7469 6f6e 6172  se the dictionar
+0002b050: 792e 0a20 2020 2020 2020 206a 736f 6e5f  y..        json_
+0002b060: 6d61 7820 3d20 7265 7370 2e5f 5f64 6963  max = resp.__dic
+0002b070: 745f 5f0a 2020 2020 2020 2020 2320 6a73  t__.        # js
+0002b080: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
+0002b090: 6b65 7922 3a20 7661 6c75 657d 2920 2023  key": value})  #
+0002b0a0: 2061 6464 2064 6963 7420 6974 656d 730a   add dict items.
+0002b0b0: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
+0002b0c0: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
+0002b0d0: 2020 2020 2020 2020 6a73 6f6e 5f2e 706f          json_.po
+0002b0e0: 7028 2274 7261 6e73 706f 7274 5f72 6573  p("transport_res
+0002b0f0: 706f 6e73 6522 290a 2020 2020 2020 2020  ponse").        
+0002b100: 6a73 6f6e 5f73 7065 6320 3d20 4e6f 6e65  json_spec = None
+0002b110: 0a20 2020 2020 2020 2070 7269 6e74 5f6f  .        print_o
+0002b120: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
+0002b130: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
+0002b140: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
+0002b150: 743d 7465 7874 2c0a 2020 2020 2020 2020  t=text,.        
+0002b160: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
+0002b170: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002b180: 6e5f 6d61 783d 6a73 6f6e 5f6d 6178 2c0a  n_max=json_max,.
+0002b190: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002b1a0: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
+0002b1b0: 0a20 2020 2020 2020 2029 0a0a 0a61 7379  .        )...asy
+0002b1c0: 6e63 2064 6566 2061 6374 696f 6e5f 6469  nc def action_di
+0002b1d0: 7363 6f76 6572 795f 696e 666f 280a 2020  scovery_info(.  
+0002b1e0: 2020 636c 6965 6e74 3a20 4173 796e 6343    client: AsyncC
+0002b1f0: 6c69 656e 742c 2063 7265 6465 6e74 6961  lient, credentia
+0002b200: 6c73 3a20 6469 6374 0a29 202d 3e20 4e6f  ls: dict.) -> No
+0002b210: 6e65 3a0a 2020 2020 2222 224c 6973 7420  ne:.    """List 
+0002b220: 6469 7363 6f76 6572 795f 696e 666f 206f  discovery_info o
+0002b230: 6620 686f 6d65 2073 6572 7665 7220 7768  f home server wh
+0002b240: 696c 6520 616c 7265 6164 7920 6c6f 6767  ile already logg
+0002b250: 6564 2069 6e2e 2222 220a 2020 2020 7265  ed in.""".    re
+0002b260: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
+0002b270: 742e 6469 7363 6f76 6572 795f 696e 666f  t.discovery_info
+0002b280: 2829 0a20 2020 2069 6620 6973 696e 7374  ().    if isinst
+0002b290: 616e 6365 2872 6573 702c 2044 6973 636f  ance(resp, Disco
+0002b2a0: 7665 7279 496e 666f 4572 726f 7229 3a0a  veryInfoError):.
+0002b2b0: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+0002b2c0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0002b2d0: 2020 2245 3138 313a 2022 2066 2264 6973    "E181: " f"dis
+0002b2e0: 636f 7665 7279 5f69 6e66 6f20 6661 696c  covery_info fail
+0002b2f0: 6564 2077 6974 6820 7b70 7269 7661 6379  ed with {privacy
+0002b300: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+0002b310: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
+0002b320: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+0002b330: 756e 7420 2b3d 2031 0a20 2020 2065 6c73  unt += 1.    els
+0002b340: 653a 0a20 2020 2020 2020 2067 732e 6c6f  e:.        gs.lo
+0002b350: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+0002b360: 2020 2020 2066 2264 6973 636f 7665 7279       f"discovery
+0002b370: 5f69 6e66 6f20 7375 6363 6573 7366 756c  _info successful
+0002b380: 2077 6974 6820 7b70 7269 7661 6379 5f66   with {privacy_f
+0002b390: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+0002b3a0: 7d22 0a20 2020 2020 2020 2029 0a20 2020  }".        ).   
+0002b3b0: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
+0002b3c0: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
+0002b3d0: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
+0002b3e0: 670a 2020 2020 2020 2020 7465 7874 203d  g.        text =
+0002b3f0: 2066 227b 7265 7370 2e68 6f6d 6573 6572   f"{resp.homeser
+0002b400: 7665 725f 7572 6c7d 7b53 4550 7d7b 7265  ver_url}{SEP}{re
+0002b410: 7370 2e69 6465 6e74 6974 795f 7365 7276  sp.identity_serv
+0002b420: 6572 5f75 726c 7d22 0a20 2020 2020 2020  er_url}".       
+0002b430: 2023 204f 626a 6563 7420 6f66 2074 7970   # Object of typ
+0002b440: 6520 7878 7852 6573 706f 6e73 6520 6973  e xxxResponse is
+0002b450: 206e 6f74 204a 534f 4e0a 2020 2020 2020   not JSON.      
+0002b460: 2020 2320 7365 7269 616c 697a 6162 6c65    # serializable
+0002b470: 2c20 6865 6e63 6520 7765 2075 7365 2074  , hence we use t
+0002b480: 6865 2064 6963 7469 6f6e 6172 792e 0a20  he dictionary.. 
+0002b490: 2020 2020 2020 206a 736f 6e5f 6d61 7820         json_max 
+0002b4a0: 3d20 7265 7370 2e5f 5f64 6963 745f 5f0a  = resp.__dict__.
+0002b4b0: 2020 2020 2020 2020 2320 6a73 6f6e 5f6d          # json_m
+0002b4c0: 6178 2e75 7064 6174 6528 7b22 6b65 7922  ax.update({"key"
+0002b4d0: 3a20 7661 6c75 657d 2920 2023 2061 6464  : value})  # add
+0002b4e0: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
+0002b4f0: 2020 2020 6a73 6f6e 5f20 3d20 6a73 6f6e      json_ = json
+0002b500: 5f6d 6178 2e63 6f70 7928 290a 2020 2020  _max.copy().    
+0002b510: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
+0002b520: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
+0002b530: 6522 290a 2020 2020 2020 2020 6a73 6f6e  e").        json
+0002b540: 5f73 7065 6320 3d20 4e6f 6e65 0a20 2020  _spec = None.   
+0002b550: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
+0002b560: 7428 0a20 2020 2020 2020 2020 2020 2067  t(.            g
+0002b570: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
+0002b580: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+0002b590: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+0002b5a0: 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020  json_=json_,.   
+0002b5b0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+0002b5c0: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
+0002b5d0: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
+0002b5e0: 633d 6a73 6f6e 5f73 7065 632c 0a20 2020  c=json_spec,.   
+0002b5f0: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
+0002b600: 6566 2061 6374 696f 6e5f 6c6f 6769 6e5f  ef action_login_
+0002b610: 696e 666f 2863 6c69 656e 743a 2041 7379  info(client: Asy
+0002b620: 6e63 436c 6965 6e74 2c20 6372 6564 656e  ncClient, creden
+0002b630: 7469 616c 733a 2064 6963 7429 202d 3e20  tials: dict) -> 
+0002b640: 4e6f 6e65 3a0a 2020 2020 2222 224c 6973  None:.    """Lis
+0002b650: 7420 6c6f 6769 6e20 6d65 7468 6f64 7320  t login methods 
+0002b660: 6f66 2068 6f6d 6520 7365 7276 6572 2077  of home server w
+0002b670: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
+0002b680: 6765 6420 696e 2e22 2222 0a20 2020 2072  ged in.""".    r
+0002b690: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+0002b6a0: 6e74 2e6c 6f67 696e 5f69 6e66 6f28 290a  nt.login_info().
+0002b6b0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0002b6c0: 6528 7265 7370 2c20 4c6f 6769 6e49 6e66  e(resp, LoginInf
+0002b6d0: 6f45 7272 6f72 293a 0a20 2020 2020 2020  oError):.       
+0002b6e0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0002b6f0: 2020 2020 2020 2020 2020 2022 4531 3832             "E182
+0002b700: 3a20 2220 6622 6c6f 6769 6e5f 696e 666f  : " f"login_info
+0002b710: 2066 6169 6c65 6420 7769 7468 207b 7072   failed with {pr
+0002b720: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+0002b730: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+0002b740: 2020 290a 2020 2020 2020 2020 6773 2e65    ).        gs.e
+0002b750: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+0002b760: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002b770: 6773 2e6c 6f67 2e64 6562 7567 2866 226c  gs.log.debug(f"l
+0002b780: 6f67 696e 5f69 6e66 6f20 7375 6363 6573  ogin_info succes
+0002b790: 7366 756c 2077 6974 6820 7b70 7269 7661  sful with {priva
+0002b7a0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+0002b7b0: 7370 2929 7d22 290a 2020 2020 2020 2020  sp))}").        
+0002b7c0: 2320 6f75 7470 7574 2066 6f72 6d61 7420  # output format 
+0002b7d0: 636f 6e74 726f 6c6c 6564 2076 6961 202d  controlled via -
+0002b7e0: 2d6f 7574 7075 7420 666c 6167 0a20 2020  -output flag.   
+0002b7f0: 2020 2020 2074 6578 7420 3d20 2222 0a20       text = "". 
+0002b800: 2020 2020 2020 2066 6f72 2072 7220 696e         for rr in
+0002b810: 2072 6573 702e 666c 6f77 733a 0a20 2020   resp.flows:.   
+0002b820: 2020 2020 2020 2020 2074 6578 7420 2b3d           text +=
+0002b830: 2073 7472 2872 7229 202b 2022 5c6e 220a   str(rr) + "\n".
+0002b840: 2020 2020 2020 2020 7465 7874 203d 2074          text = t
+0002b850: 6578 742e 7374 7269 7028 290a 2020 2020  ext.strip().    
+0002b860: 2020 2020 2320 4f62 6a65 6374 206f 6620      # Object of 
+0002b870: 7479 7065 2078 7878 5265 7370 6f6e 7365  type xxxResponse
+0002b880: 2069 7320 6e6f 7420 4a53 4f4e 0a20 2020   is not JSON.   
+0002b890: 2020 2020 2023 2073 6572 6961 6c69 7a61       # serializa
+0002b8a0: 626c 652c 2068 656e 6365 2077 6520 7573  ble, hence we us
+0002b8b0: 6520 7468 6520 6469 6374 696f 6e61 7279  e the dictionary
+0002b8c0: 2e0a 2020 2020 2020 2020 6a73 6f6e 5f6d  ..        json_m
+0002b8d0: 6178 203d 2072 6573 702e 5f5f 6469 6374  ax = resp.__dict
+0002b8e0: 5f5f 0a20 2020 2020 2020 2023 206a 736f  __.        # jso
+0002b8f0: 6e5f 6d61 782e 7570 6461 7465 287b 226b  n_max.update({"k
+0002b900: 6579 223a 2076 616c 7565 7d29 2020 2320  ey": value})  # 
+0002b910: 6164 6420 6469 6374 2069 7465 6d73 0a20  add dict items. 
+0002b920: 2020 2020 2020 206a 736f 6e5f 203d 206a         json_ = j
+0002b930: 736f 6e5f 6d61 782e 636f 7079 2829 0a20  son_max.copy(). 
+0002b940: 2020 2020 2020 206a 736f 6e5f 2e70 6f70         json_.pop
+0002b950: 2822 7472 616e 7370 6f72 745f 7265 7370  ("transport_resp
+0002b960: 6f6e 7365 2229 0a20 2020 2020 2020 206a  onse").        j
+0002b970: 736f 6e5f 7370 6563 203d 204e 6f6e 650a  son_spec = None.
+0002b980: 2020 2020 2020 2020 7072 696e 745f 6f75          print_ou
+0002b990: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+0002b9a0: 2020 6773 2e70 612e 6f75 7470 7574 2c0a    gs.pa.output,.
+0002b9b0: 2020 2020 2020 2020 2020 2020 7465 7874              text
+0002b9c0: 3d74 6578 742c 0a20 2020 2020 2020 2020  =text,.         
+0002b9d0: 2020 206a 736f 6e5f 3d6a 736f 6e5f 2c0a     json_=json_,.
+0002b9e0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002b9f0: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
+0002ba00: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002ba10: 7370 6563 3d6a 736f 6e5f 7370 6563 2c0a  spec=json_spec,.
+0002ba20: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
+0002ba30: 6320 6465 6620 6163 7469 6f6e 5f63 6f6e  c def action_con
+0002ba40: 7465 6e74 5f72 6570 6f73 6974 6f72 795f  tent_repository_
+0002ba50: 636f 6e66 6967 280a 2020 2020 636c 6965  config(.    clie
+0002ba60: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
+0002ba70: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
+0002ba80: 6374 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ct.) -> None:.  
+0002ba90: 2020 2222 224c 6973 7420 636f 6e66 6967    """List config
+0002baa0: 206f 6620 636f 6e74 656e 7420 7265 706f   of content repo
+0002bab0: 206f 6620 686f 6d65 2073 6572 7665 7220   of home server 
+0002bac0: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
+0002bad0: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
+0002bae0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+0002baf0: 656e 742e 636f 6e74 656e 745f 7265 706f  ent.content_repo
+0002bb00: 7369 746f 7279 5f63 6f6e 6669 6728 290a  sitory_config().
+0002bb10: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0002bb20: 6528 7265 7370 2c20 436f 6e74 656e 7452  e(resp, ContentR
+0002bb30: 6570 6f73 6974 6f72 7943 6f6e 6669 6745  epositoryConfigE
+0002bb40: 7272 6f72 293a 0a20 2020 2020 2020 2067  rror):.        g
+0002bb50: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+0002bb60: 2020 2020 2020 2020 2022 4531 3833 3a20           "E183: 
+0002bb70: 220a 2020 2020 2020 2020 2020 2020 2263  ".            "c
+0002bb80: 6f6e 7465 6e74 5f72 6570 6f73 6974 6f72  ontent_repositor
+0002bb90: 795f 636f 6e66 6967 2066 6169 6c65 6420  y_config failed 
+0002bba0: 7769 7468 2022 0a20 2020 2020 2020 2020  with ".         
+0002bbb0: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
+0002bbc0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+0002bbd0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0002bbe0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+0002bbf0: 202b 3d20 310a 2020 2020 656c 7365 3a0a   += 1.    else:.
+0002bc00: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+0002bc10: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0002bc20: 2020 2263 6f6e 7465 6e74 5f72 6570 6f73    "content_repos
+0002bc30: 6974 6f72 795f 636f 6e66 6967 2073 7563  itory_config suc
+0002bc40: 6365 7373 6675 6c20 7769 7468 2022 0a20  cessful with ". 
+0002bc50: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
+0002bc60: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+0002bc70: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+0002bc80: 2020 290a 2020 2020 2020 2020 2320 6f75    ).        # ou
+0002bc90: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
+0002bca0: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
+0002bcb0: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
+0002bcc0: 2074 6578 7420 3d20 7265 7370 2e75 706c   text = resp.upl
+0002bcd0: 6f61 645f 7369 7a65 2020 2320 7265 7475  oad_size  # retu
+0002bce0: 726e 7320 6f6e 6c79 2031 2076 616c 7565  rns only 1 value
+0002bcf0: 0a20 2020 2020 2020 2023 204f 626a 6563  .        # Objec
+0002bd00: 7420 6f66 2074 7970 6520 7878 7852 6573  t of type xxxRes
+0002bd10: 706f 6e73 6520 6973 206e 6f74 204a 534f  ponse is not JSO
+0002bd20: 4e0a 2020 2020 2020 2020 2320 7365 7269  N.        # seri
+0002bd30: 616c 697a 6162 6c65 2c20 6865 6e63 6520  alizable, hence 
+0002bd40: 7765 2075 7365 2074 6865 2064 6963 7469  we use the dicti
+0002bd50: 6f6e 6172 792e 0a20 2020 2020 2020 206a  onary..        j
+0002bd60: 736f 6e5f 6d61 7820 3d20 7265 7370 2e5f  son_max = resp._
+0002bd70: 5f64 6963 745f 5f0a 2020 2020 2020 2020  _dict__.        
+0002bd80: 2320 6a73 6f6e 5f6d 6178 2e75 7064 6174  # json_max.updat
+0002bd90: 6528 7b22 6b65 7922 3a20 7661 6c75 657d  e({"key": value}
+0002bda0: 2920 2023 2061 6464 2064 6963 7420 6974  )  # add dict it
+0002bdb0: 656d 730a 2020 2020 2020 2020 6a73 6f6e  ems.        json
+0002bdc0: 5f20 3d20 6a73 6f6e 5f6d 6178 2e63 6f70  _ = json_max.cop
+0002bdd0: 7928 290a 2020 2020 2020 2020 6a73 6f6e  y().        json
+0002bde0: 5f2e 706f 7028 2274 7261 6e73 706f 7274  _.pop("transport
+0002bdf0: 5f72 6573 706f 6e73 6522 290a 2020 2020  _response").    
+0002be00: 2020 2020 6a73 6f6e 5f73 7065 6320 3d20      json_spec = 
+0002be10: 4e6f 6e65 0a20 2020 2020 2020 2070 7269  None.        pri
+0002be20: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
+0002be30: 2020 2020 2020 2067 732e 7061 2e6f 7574         gs.pa.out
+0002be40: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+0002be50: 2074 6578 743d 7465 7874 2c0a 2020 2020   text=text,.    
+0002be60: 2020 2020 2020 2020 6a73 6f6e 5f3d 6a73          json_=js
+0002be70: 6f6e 5f2c 0a20 2020 2020 2020 2020 2020  on_,.           
+0002be80: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
+0002be90: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
+0002bea0: 6a73 6f6e 5f73 7065 633d 6a73 6f6e 5f73  json_spec=json_s
+0002beb0: 7065 632c 0a20 2020 2020 2020 2029 0a0a  pec,.        )..
+0002bec0: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
+0002bed0: 6e5f 7265 7374 2863 6c69 656e 743a 2041  n_rest(client: A
+0002bee0: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+0002bef0: 656e 7469 616c 733a 2064 6963 7429 202d  entials: dict) -
+0002bf00: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2249  > None:.    """I
+0002bf10: 6e76 6f6b 6520 5245 5354 2041 5049 206f  nvoke REST API o
+0002bf20: 6e20 4d61 7472 6978 2073 6572 7665 722e  n Matrix server.
+0002bf30: 0a20 2020 2041 7373 756d 6573 2074 6861  .    Assumes tha
+0002bf40: 7420 7573 6572 2069 7320 616c 7265 6164  t user is alread
+0002bf50: 7920 6c6f 6767 6564 2069 6e2e 0a20 2020  y logged in..   
+0002bf60: 2022 2222 0a20 2020 2023 2073 6565 3a20   """.    # see: 
+0002bf70: 6874 7470 733a 2f2f 646f 6373 2e61 696f  https://docs.aio
+0002bf80: 6874 7470 2e6f 7267 2f65 6e2f 7374 6162  http.org/en/stab
+0002bf90: 6c65 2f63 6c69 656e 745f 7175 6963 6b73  le/client_quicks
+0002bfa0: 7461 7274 2e68 746d 6c0a 2020 2020 2320  tart.html.    # 
+0002bfb0: 7765 206d 7573 7420 656d 756c 6174 6520  we must emulate 
+0002bfc0: 6120 6375 726c 206c 696b 6520 7468 6973  a curl like this
+0002bfd0: 3a0a 2020 2020 2320 6375 726c 202d 5844  :.    # curl -XD
+0002bfe0: 454c 4554 4520 2022 6874 7470 733a 2f2f  ELETE  "https://
+0002bff0: 5345 5256 4552 4845 5245 2f5f 7379 6e61  SERVERHERE/_syna
+0002c000: 7073 652f 6164 6d69 6e2f 7631 2f6d 6564  pse/admin/v1/med
+0002c010: 6961 2f53 4552 5645 5248 4552 452f 0a20  ia/SERVERHERE/. 
+0002c020: 2020 2023 2020 2020 2020 4d58 4349 4448     #      MXCIDH
+0002c030: 4552 453f 6163 6365 7373 5f74 6f6b 656e  ERE?access_token
+0002c040: 3d41 4343 4553 535f 544f 4b45 4e5f 4845  =ACCESS_TOKEN_HE
+0002c050: 5245 220a 2020 2020 2320 6375 726c 202d  RE".    # curl -
+0002c060: 5850 4f53 5420 2d64 2027 7b22 6d73 6774  XPOST -d '{"msgt
+0002c070: 7970 6522 3a22 6d2e 7465 7874 222c 2022  ype":"m.text", "
+0002c080: 626f 6479 223a 2268 656c 6c6f 227d 2720  body":"hello"}' 
+0002c090: 5c0a 2020 2020 2320 2020 225f 5f68 6f6d  \.    #   "__hom
+0002c0a0: 6573 6572 7665 725f 5f2f 5f6d 6174 7269  eserver__/_matri
+0002c0b0: 782f 636c 6965 6e74 2f72 302f 726f 6f6d  x/client/r0/room
+0002c0c0: 732f 5f5f 656e 636f 6465 645f 6675 6c6c  s/__encoded_full
+0002c0d0: 5f72 6f6f 6d5f 6964 5f5f 2f5c 0a20 2020  _room_id__/\.   
+0002c0e0: 2023 2020 2073 656e 642f 6d2e 726f 6f6d   #   send/m.room
+0002c0f0: 2e6d 6573 7361 6765 3f61 6363 6573 735f  .message?access_
+0002c100: 746f 6b65 6e3d 594f 5552 544f 4b45 4e48  token=YOURTOKENH
+0002c110: 4552 4522 0a20 2020 2023 2063 7572 6c20  ERE".    # curl 
+0002c120: 2d58 4745 5420 2d64 2022 2220 275f 5f68  -XGET -d "" '__h
+0002c130: 6f6d 6573 6572 7665 725f 5f2f 5f6d 6174  omeserver__/_mat
+0002c140: 7269 782f 636c 6965 6e74 2f76 6572 7369  rix/client/versi
+0002c150: 6f6e 7327 0a20 2020 2069 6620 6e6f 7420  ons'.    if not 
+0002c160: 6c65 6e28 6773 2e70 612e 7265 7374 2920  len(gs.pa.rest) 
+0002c170: 2520 3320 3d3d 2030 3a0a 2020 2020 2020  % 3 == 0:.      
+0002c180: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+0002c190: 2020 2020 2020 2020 2020 2020 2245 3138              "E18
+0002c1a0: 343a 2022 0a20 2020 2020 2020 2020 2020  4: ".           
+0002c1b0: 2022 496e 636f 7272 6563 7420 6e75 6d62   "Incorrect numb
+0002c1c0: 6572 206f 6620 6172 6775 6d65 6e74 7320  er of arguments 
+0002c1d0: 666f 7220 2d2d 7265 7374 2e20 4172 6775  for --rest. Argu
+0002c1e0: 6d65 6e74 7320 6d75 7374 2062 6520 220a  ments must be ".
+0002c1f0: 2020 2020 2020 2020 2020 2020 6622 7472              f"tr
+0002c200: 6970 6c65 732c 2069 2e65 2e20 6d75 6c74  iples, i.e. mult
+0002c210: 6970 6c65 7320 6f66 2033 2c20 6275 7420  iples of 3, but 
+0002c220: 666f 756e 6420 7b6c 656e 2867 732e 7061  found {len(gs.pa
+0002c230: 2e72 6573 7429 7d20 220a 2020 2020 2020  .rest)} ".      
+0002c240: 2020 2020 2020 2261 7267 756d 656e 7473        "arguments
+0002c250: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+0002c260: 2020 2020 2067 732e 6572 725f 636f 756e       gs.err_coun
+0002c270: 7420 2b3d 2031 0a20 2020 2020 2020 2072  t += 1.        r
+0002c280: 6574 7572 6e0a 2020 2020 666f 7220 6969  eturn.    for ii
+0002c290: 2069 6e20 7261 6e67 6528 6c65 6e28 6773   in range(len(gs
+0002c2a0: 2e70 612e 7265 7374 2920 2f2f 2033 293a  .pa.rest) // 3):
+0002c2b0: 0a20 2020 2020 2020 206d 6574 686f 6420  .        method 
+0002c2c0: 3d20 6773 2e70 612e 7265 7374 5b69 6920  = gs.pa.rest[ii 
+0002c2d0: 2a20 3320 2b20 305d 0a20 2020 2020 2020  * 3 + 0].       
+0002c2e0: 2064 6174 6120 3d20 6773 2e70 612e 7265   data = gs.pa.re
+0002c2f0: 7374 5b69 6920 2a20 3320 2b20 315d 0a20  st[ii * 3 + 1]. 
+0002c300: 2020 2020 2020 2075 726c 203d 2067 732e         url = gs.
+0002c310: 7061 2e72 6573 745b 6969 202a 2033 202b  pa.rest[ii * 3 +
+0002c320: 2032 5d0a 2020 2020 2020 2020 6966 206e   2].        if n
+0002c330: 6f74 206d 6574 686f 6420 6f72 206d 6574  ot method or met
+0002c340: 686f 642e 7570 7065 7228 292e 7374 7269  hod.upper().stri
+0002c350: 7028 2920 6e6f 7420 696e 205b 0a20 2020  p() not in [.   
+0002c360: 2020 2020 2020 2020 2022 4745 5422 2c0a           "GET",.
+0002c370: 2020 2020 2020 2020 2020 2020 2250 4f53              "POS
+0002c380: 5422 2c0a 2020 2020 2020 2020 2020 2020  T",.            
+0002c390: 2250 5554 222c 0a20 2020 2020 2020 2020  "PUT",.         
+0002c3a0: 2020 2022 4445 4c45 5445 222c 0a20 2020     "DELETE",.   
+0002c3b0: 2020 2020 2020 2020 2022 4f50 5449 4f4e           "OPTION
+0002c3c0: 5322 2c0a 2020 2020 2020 2020 5d3a 0a20  S",.        ]:. 
+0002c3d0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0002c3e0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
+0002c3f0: 2020 2020 2020 2020 2022 4531 3835 3a20           "E185: 
+0002c400: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002c410: 2020 6622 496e 636f 7272 6563 7420 5245    f"Incorrect RE
+0002c420: 5354 206d 6574 686f 6420 7b6d 6574 686f  ST method {metho
+0002c430: 647d 2e20 220a 2020 2020 2020 2020 2020  d}. ".          
+0002c440: 2020 2020 2020 274d 7573 7420 6265 206f        'Must be o
+0002c450: 6e65 206f 663a 2022 4745 5422 2c20 2250  ne of: "GET", "P
+0002c460: 4f53 5422 2c20 2250 5554 222c 2022 4445  OST", "PUT", "DE
+0002c470: 4c45 5445 222c 2022 4f50 5449 4f4e 5322  LETE", "OPTIONS"
+0002c480: 2e27 0a20 2020 2020 2020 2020 2020 2029  .'.            )
+0002c490: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0002c4a0: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+0002c4b0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0002c4c0: 6e75 650a 2020 2020 2020 2020 6d65 7468  nue.        meth
+0002c4d0: 6f64 203d 206d 6574 686f 642e 7570 7065  od = method.uppe
+0002c4e0: 7228 292e 7374 7269 7028 290a 2020 2020  r().strip().    
+0002c4f0: 2020 2020 6966 206e 6f74 2064 6174 613a      if not data:
+0002c500: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+0002c510: 6120 3d20 2222 0a20 2020 2020 2020 2069  a = "".        i
+0002c520: 6620 6e6f 7420 7572 6c20 6f72 2075 726c  f not url or url
+0002c530: 2e73 7472 6970 2829 203d 3d20 2222 3a0a  .strip() == "":.
+0002c540: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+0002c550: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+0002c560: 2020 2020 2020 2020 2020 2245 3138 363a            "E186:
+0002c570: 2022 2066 2249 6e63 6f72 7265 6374 2052   " f"Incorrect R
+0002c580: 4553 5420 5552 4c20 7b75 726c 7d2e 204d  EST URL {url}. M
+0002c590: 7573 7420 6e6f 7420 6265 2065 6d70 7479  ust not be empty
+0002c5a0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+0002c5b0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0002c5c0: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+0002c5d0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0002c5e0: 6e75 650a 2020 2020 2020 2020 6966 2067  nue.        if g
+0002c5f0: 732e 7061 2e61 6363 6573 735f 746f 6b65  s.pa.access_toke
+0002c600: 6e3a 0a20 2020 2020 2020 2020 2020 2061  n:.            a
+0002c610: 7420 3d20 6773 2e70 612e 6163 6365 7373  t = gs.pa.access
+0002c620: 5f74 6f6b 656e 0a20 2020 2020 2020 2020  _token.         
+0002c630: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0002c640: 2255 7369 6e67 2061 6363 6573 7320 746f  "Using access to
+0002c650: 6b65 6e20 6672 6f6d 202d 2d61 6363 6573  ken from --acces
+0002c660: 732d 746f 6b65 6e20 6172 6775 6d65 6e74  s-token argument
+0002c670: 2e22 290a 2020 2020 2020 2020 656c 7365  .").        else
+0002c680: 3a0a 2020 2020 2020 2020 2020 2020 6174  :.            at
+0002c690: 203d 2063 7265 6465 6e74 6961 6c73 5b22   = credentials["
+0002c6a0: 6163 6365 7373 5f74 6f6b 656e 225d 0a20  access_token"]. 
+0002c6b0: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+0002c6c0: 672e 6465 6275 6728 2255 7369 6e67 2061  g.debug("Using a
+0002c6d0: 6363 6573 7320 746f 6b65 6e20 6672 6f6d  ccess token from
+0002c6e0: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+0002c6f0: 652e 2229 0a20 2020 2020 2020 2066 6f72  e.").        for
+0002c700: 2070 6820 696e 205b 0a20 2020 2020 2020   ph in [.       
+0002c710: 2020 2020 2048 4f4d 4553 4552 5645 525f       HOMESERVER_
+0002c720: 504c 4143 4548 4f4c 4445 522c 0a20 2020  PLACEHOLDER,.   
+0002c730: 2020 2020 2020 2020 2048 4f53 544e 414d           HOSTNAM
+0002c740: 455f 504c 4143 4548 4f4c 4445 522c 0a20  E_PLACEHOLDER,. 
+0002c750: 2020 2020 2020 2020 2020 2041 4343 4553             ACCES
+0002c760: 535f 544f 4b45 4e5f 504c 4143 4548 4f4c  S_TOKEN_PLACEHOL
+0002c770: 4445 522c 0a20 2020 2020 2020 2020 2020  DER,.           
+0002c780: 2055 5345 525f 4944 5f50 4c41 4345 484f   USER_ID_PLACEHO
+0002c790: 4c44 4552 2c0a 2020 2020 2020 2020 2020  LDER,.          
+0002c7a0: 2020 4445 5649 4345 5f49 445f 504c 4143    DEVICE_ID_PLAC
+0002c7b0: 4548 4f4c 4445 522c 0a20 2020 2020 2020  EHOLDER,.       
+0002c7c0: 2020 2020 2052 4f4f 4d5f 4944 5f50 4c41       ROOM_ID_PLA
+0002c7d0: 4345 484f 4c44 4552 2c0a 2020 2020 2020  CEHOLDER,.      
+0002c7e0: 2020 5d3a 0a20 2020 2020 2020 2020 2020    ]:.           
+0002c7f0: 2069 6620 7068 203d 3d20 484f 4d45 5345   if ph == HOMESE
+0002c800: 5256 4552 5f50 4c41 4345 484f 4c44 4552  RVER_PLACEHOLDER
+0002c810: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002c820: 2020 6461 7461 203d 2064 6174 612e 7265    data = data.re
+0002c830: 706c 6163 6528 7068 2c20 6372 6564 656e  place(ph, creden
+0002c840: 7469 616c 735b 2268 6f6d 6573 6572 7665  tials["homeserve
+0002c850: 7222 5d29 0a20 2020 2020 2020 2020 2020  r"]).           
+0002c860: 2020 2020 2075 726c 203d 2075 726c 2e72       url = url.r
+0002c870: 6570 6c61 6365 2870 682c 2063 7265 6465  eplace(ph, crede
+0002c880: 6e74 6961 6c73 5b22 686f 6d65 7365 7276  ntials["homeserv
+0002c890: 6572 225d 290a 2020 2020 2020 2020 2020  er"]).          
+0002c8a0: 2020 656c 6966 2070 6820 3d3d 2048 4f53    elif ph == HOS
+0002c8b0: 544e 414d 455f 504c 4143 4548 4f4c 4445  TNAME_PLACEHOLDE
+0002c8c0: 523a 0a20 2020 2020 2020 2020 2020 2020  R:.             
+0002c8d0: 2020 2068 6f73 746e 616d 6520 3d20 7572     hostname = ur
+0002c8e0: 6c70 6172 7365 2863 7265 6465 6e74 6961  lparse(credentia
+0002c8f0: 6c73 5b22 686f 6d65 7365 7276 6572 225d  ls["homeserver"]
+0002c900: 292e 686f 7374 6e61 6d65 0a20 2020 2020  ).hostname.     
+0002c910: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+0002c920: 3d20 6461 7461 2e72 6570 6c61 6365 2870  = data.replace(p
+0002c930: 682c 2068 6f73 746e 616d 6529 0a20 2020  h, hostname).   
+0002c940: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0002c950: 203d 2075 726c 2e72 6570 6c61 6365 2870   = url.replace(p
+0002c960: 682c 2068 6f73 746e 616d 6529 0a20 2020  h, hostname).   
+0002c970: 2020 2020 2020 2020 2065 6c69 6620 7068           elif ph
+0002c980: 203d 3d20 4143 4345 5353 5f54 4f4b 454e   == ACCESS_TOKEN
+0002c990: 5f50 4c41 4345 484f 4c44 4552 3a0a 2020  _PLACEHOLDER:.  
+0002c9a0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0002c9b0: 7461 203d 2064 6174 612e 7265 706c 6163  ta = data.replac
+0002c9c0: 6528 7068 2c20 6174 290a 2020 2020 2020  e(ph, at).      
+0002c9d0: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+0002c9e0: 7572 6c2e 7265 706c 6163 6528 7068 2c20  url.replace(ph, 
+0002c9f0: 6174 290a 2020 2020 2020 2020 2020 2020  at).            
+0002ca00: 656c 6966 2070 6820 3d3d 2055 5345 525f  elif ph == USER_
+0002ca10: 4944 5f50 4c41 4345 484f 4c44 4552 3a0a  ID_PLACEHOLDER:.
+0002ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca30: 6461 7461 203d 2064 6174 612e 7265 706c  data = data.repl
+0002ca40: 6163 6528 7068 2c20 6372 6564 656e 7469  ace(ph, credenti
+0002ca50: 616c 735b 2275 7365 725f 6964 225d 290a  als["user_id"]).
+0002ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca70: 7572 6c20 3d20 7572 6c2e 7265 706c 6163  url = url.replac
+0002ca80: 6528 7068 2c20 6372 6564 656e 7469 616c  e(ph, credential
+0002ca90: 735b 2275 7365 725f 6964 225d 290a 2020  s["user_id"]).  
+0002caa0: 2020 2020 2020 2020 2020 656c 6966 2070            elif p
+0002cab0: 6820 3d3d 2044 4556 4943 455f 4944 5f50  h == DEVICE_ID_P
+0002cac0: 4c41 4345 484f 4c44 4552 3a0a 2020 2020  LACEHOLDER:.    
+0002cad0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0002cae0: 203d 2064 6174 612e 7265 706c 6163 6528   = data.replace(
+0002caf0: 7068 2c20 6372 6564 656e 7469 616c 735b  ph, credentials[
+0002cb00: 2264 6576 6963 655f 6964 225d 290a 2020  "device_id"]).  
+0002cb10: 2020 2020 2020 2020 2020 2020 2020 7572                ur
+0002cb20: 6c20 3d20 7572 6c2e 7265 706c 6163 6528  l = url.replace(
+0002cb30: 7068 2c20 6372 6564 656e 7469 616c 735b  ph, credentials[
+0002cb40: 2264 6576 6963 655f 6964 225d 290a 2020  "device_id"]).  
+0002cb50: 2020 2020 2020 2020 2020 656c 6966 2070            elif p
+0002cb60: 6820 3d3d 2052 4f4f 4d5f 4944 5f50 4c41  h == ROOM_ID_PLA
+0002cb70: 4345 484f 4c44 4552 3a0a 2020 2020 2020  CEHOLDER:.      
+0002cb80: 2020 2020 2020 2020 2020 726f 6f6d 5f69            room_i
+0002cb90: 6420 3d20 6372 6564 656e 7469 616c 735b  d = credentials[
+0002cba0: 2272 6f6f 6d5f 6964 225d 0a20 2020 2020  "room_id"].     
+0002cbb0: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
+0002cbc0: 6964 203d 2061 7761 6974 206d 6170 5f72  id = await map_r
+0002cbd0: 6f6f 6d69 6e66 6f5f 746f 5f72 6f6f 6d69  oominfo_to_roomi
+0002cbe0: 6428 636c 6965 6e74 2c20 726f 6f6d 5f69  d(client, room_i
+0002cbf0: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+0002cc00: 2020 2072 6f6f 6d5f 6964 203d 2071 756f     room_id = quo
+0002cc10: 7465 2872 6f6f 6d5f 6964 290a 2020 2020  te(room_id).    
+0002cc20: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0002cc30: 203d 2064 6174 612e 7265 706c 6163 6528   = data.replace(
+0002cc40: 7068 2c20 726f 6f6d 5f69 6429 0a20 2020  ph, room_id).   
+0002cc50: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0002cc60: 203d 2075 726c 2e72 6570 6c61 6365 2870   = url.replace(p
+0002cc70: 682c 2072 6f6f 6d5f 6964 290a 2020 2020  h, room_id).    
+0002cc80: 2020 2020 7572 6c20 3d20 7572 6c2e 7374      url = url.st
+0002cc90: 7269 7028 290a 2020 2020 2020 2020 6966  rip().        if
+0002cca0: 2064 6174 6120 213d 2022 2220 616e 6420   data != "" and 
+0002ccb0: 286d 6574 686f 6420 696e 2028 2247 4554  (method in ("GET
+0002ccc0: 222c 2022 4445 4c45 5445 222c 2022 4f50  ", "DELETE", "OP
+0002ccd0: 5449 4f4e 5322 2929 3a0a 2020 2020 2020  TIONS")):.      
+0002cce0: 2020 2020 2020 6773 2e6c 6f67 2e77 6172        gs.log.war
+0002ccf0: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+0002cd00: 2020 2020 2020 2257 3130 383a 2022 0a20        "W108: ". 
+0002cd10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002cd20: 2746 6f75 6e64 2052 4553 5420 6461 7461  'Found REST data
+0002cd30: 2022 7b64 6174 617d 2220 666f 7220 6d65   "{data}" for me
+0002cd40: 7468 6f64 207b 6d65 7468 6f64 7d2e 2027  thod {method}. '
+0002cd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cd60: 2027 5468 6572 6520 6973 2075 7375 616c   'There is usual
+0002cd70: 6c79 206e 6f20 6461 7461 2066 6f72 3a20  ly no data for: 
+0002cd80: 2247 4554 222c 2022 4445 4c45 5445 222c  "GET", "DELETE",
+0002cd90: 2022 4f50 5449 4f4e 5322 2e20 270a 2020   "OPTIONS". '.  
+0002cda0: 2020 2020 2020 2020 2020 2020 2020 224d                "M
+0002cdb0: 6f73 7420 6c69 6b65 6c79 2074 6869 7320  ost likely this 
+0002cdc0: 6973 206e 6f74 2077 6861 7420 796f 7520  is not what you 
+0002cdd0: 7761 6e74 2e20 220a 2020 2020 2020 2020  want. ".        
+0002cde0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002cdf0: 2020 6773 2e77 6172 6e5f 636f 756e 7420    gs.warn_count 
+0002ce00: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+0002ce10: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+0002ce20: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+0002ce30: 2020 2020 2020 2020 2020 2020 6622 5072              f"Pr
+0002ce40: 6570 6172 696e 6720 746f 2069 6e76 6f6b  eparing to invok
+0002ce50: 6520 5245 5354 2041 5049 2063 616c 6c3a  e REST API call:
+0002ce60: 206d 6574 686f 643d 7b6d 6574 686f 647d   method={method}
+0002ce70: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+0002ce80: 2264 6174 613d 7b64 6174 617d 2c20 7572  "data={data}, ur
+0002ce90: 6c3d 7b70 7269 7661 6379 5f66 696c 7465  l={privacy_filte
+0002cea0: 7228 7374 7228 7572 6c29 297d 2e22 0a20  r(str(url))}.". 
+0002ceb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002cec0: 2063 6f6e 6e65 6374 6f72 203d 2054 4350   connector = TCP
+0002ced0: 436f 6e6e 6563 746f 7228 7373 6c3d 6773  Connector(ssl=gs
+0002cee0: 2e73 736c 2920 2023 2073 6574 7469 6e67  .ssl)  # setting
+0002cef0: 2073 736c 636f 6e74 6578 740a 2020 2020   sslcontext.    
+0002cf00: 2020 2020 6173 796e 6320 7769 7468 2043      async with C
+0002cf10: 6c69 656e 7453 6573 7369 6f6e 2863 6f6e  lientSession(con
+0002cf20: 6e65 6374 6f72 3d63 6f6e 6e65 6374 6f72  nector=connector
+0002cf30: 2920 6173 2073 6573 7369 6f6e 3a20 2023  ) as session:  #
+0002cf40: 2061 696f 6874 7470 0a20 2020 2020 2020   aiohttp.       
+0002cf50: 2020 2020 2069 6620 6d65 7468 6f64 203d       if method =
+0002cf60: 3d20 2247 4554 223a 0a20 2020 2020 2020  = "GET":.       
+0002cf70: 2020 2020 2020 2020 2061 7379 6e63 2077           async w
+0002cf80: 6974 6820 7365 7373 696f 6e2e 6765 7428  ith session.get(
+0002cf90: 7572 6c2c 2064 6174 613d 6461 7461 2920  url, data=data) 
+0002cfa0: 6173 2072 6573 703a 0a20 2020 2020 2020  as resp:.       
+0002cfb0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0002cfc0: 7475 7320 3d20 7265 7370 2e73 7461 7475  tus = resp.statu
+0002cfd0: 7320 2023 2069 6e74 2c20 3230 3020 7375  s  # int, 200 su
+0002cfe0: 6363 6573 730a 2020 2020 2020 2020 2020  ccess.          
+0002cff0: 2020 2020 2020 2020 2020 7478 7420 3d20            txt = 
+0002d000: 6177 6169 7420 7265 7370 2e74 6578 7428  await resp.text(
+0002d010: 2920 2023 2073 7472 2069 6e20 6469 6374  )  # str in dict
+0002d020: 2066 6f72 6d61 740a 2020 2020 2020 2020   format.        
+0002d030: 2020 2020 656c 6966 206d 6574 686f 6420      elif method 
+0002d040: 3d3d 2022 504f 5354 223a 0a20 2020 2020  == "POST":.     
+0002d050: 2020 2020 2020 2020 2020 2061 7379 6e63             async
+0002d060: 2077 6974 6820 7365 7373 696f 6e2e 706f   with session.po
+0002d070: 7374 2875 726c 2c20 6461 7461 3d64 6174  st(url, data=dat
+0002d080: 6129 2061 7320 7265 7370 3a0a 2020 2020  a) as resp:.    
+0002d090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d0a0: 7374 6174 7573 203d 2072 6573 702e 7374  status = resp.st
+0002d0b0: 6174 7573 2020 2320 696e 742c 2032 3030  atus  # int, 200
+0002d0c0: 2073 7563 6365 7373 0a20 2020 2020 2020   success.       
+0002d0d0: 2020 2020 2020 2020 2020 2020 2074 7874               txt
+0002d0e0: 203d 2061 7761 6974 2072 6573 702e 7465   = await resp.te
+0002d0f0: 7874 2829 2020 2320 7374 7220 696e 2064  xt()  # str in d
+0002d100: 6963 7420 666f 726d 6174 0a20 2020 2020  ict format.     
+0002d110: 2020 2020 2020 2065 6c69 6620 6d65 7468         elif meth
+0002d120: 6f64 203d 3d20 2250 5554 223a 0a20 2020  od == "PUT":.   
+0002d130: 2020 2020 2020 2020 2020 2020 2061 7379               asy
+0002d140: 6e63 2077 6974 6820 7365 7373 696f 6e2e  nc with session.
+0002d150: 7075 7428 7572 6c2c 2064 6174 613d 6461  put(url, data=da
+0002d160: 7461 2920 6173 2072 6573 703a 0a20 2020  ta) as resp:.   
+0002d170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d180: 2073 7461 7475 7320 3d20 7265 7370 2e73   status = resp.s
+0002d190: 7461 7475 7320 2023 2069 6e74 2c20 3230  tatus  # int, 20
+0002d1a0: 3020 7375 6363 6573 730a 2020 2020 2020  0 success.      
+0002d1b0: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+0002d1c0: 7420 3d20 6177 6169 7420 7265 7370 2e74  t = await resp.t
+0002d1d0: 6578 7428 2920 2023 2073 7472 2069 6e20  ext()  # str in 
+0002d1e0: 6469 6374 2066 6f72 6d61 740a 2020 2020  dict format.    
+0002d1f0: 2020 2020 2020 2020 656c 6966 206d 6574          elif met
+0002d200: 686f 6420 3d3d 2022 4445 4c45 5445 223a  hod == "DELETE":
+0002d210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d220: 2061 7379 6e63 2077 6974 6820 7365 7373   async with sess
+0002d230: 696f 6e2e 6465 6c65 7465 2875 726c 2c20  ion.delete(url, 
+0002d240: 6461 7461 3d64 6174 6129 2061 7320 7265  data=data) as re
+0002d250: 7370 3a0a 2020 2020 2020 2020 2020 2020  sp:.            
+0002d260: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+0002d270: 2072 6573 702e 7374 6174 7573 2020 2320   resp.status  # 
+0002d280: 696e 742c 2032 3030 2073 7563 6365 7373  int, 200 success
+0002d290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d2a0: 2020 2020 2074 7874 203d 2061 7761 6974       txt = await
+0002d2b0: 2072 6573 702e 7465 7874 2829 2020 2320   resp.text()  # 
+0002d2c0: 7374 7220 696e 2064 6963 7420 666f 726d  str in dict form
+0002d2d0: 6174 0a20 2020 2020 2020 2020 2020 2065  at.            e
+0002d2e0: 6c69 6620 6d65 7468 6f64 203d 3d20 224f  lif method == "O
+0002d2f0: 5054 494f 4e53 223a 0a20 2020 2020 2020  PTIONS":.       
+0002d300: 2020 2020 2020 2020 2061 7379 6e63 2077           async w
+0002d310: 6974 6820 7365 7373 696f 6e2e 6f70 7469  ith session.opti
+0002d320: 6f6e 7328 7572 6c2c 2064 6174 613d 6461  ons(url, data=da
+0002d330: 7461 2920 6173 2072 6573 703a 0a20 2020  ta) as resp:.   
+0002d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d350: 2073 7461 7475 7320 3d20 7265 7370 2e73   status = resp.s
+0002d360: 7461 7475 7320 2023 2069 6e74 2c20 3230  tatus  # int, 20
+0002d370: 3020 7375 6363 6573 730a 2020 2020 2020  0 success.      
+0002d380: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+0002d390: 7420 3d20 6177 6169 7420 7265 7370 2e74  t = await resp.t
+0002d3a0: 6578 7428 2920 2023 2073 7472 2069 6e20  ext()  # str in 
+0002d3b0: 6469 6374 2066 6f72 6d61 740a 2020 2020  dict format.    
+0002d3c0: 2020 2020 6966 2073 7461 7475 7320 213d      if status !=
+0002d3d0: 2032 3030 3a0a 2020 2020 2020 2020 2020   200:.          
+0002d3e0: 2020 2320 7478 7420 6973 2073 7472 206c    # txt is str l
+0002d3f0: 696b 6520 7468 6973 3a0a 2020 2020 2020  ike this:.      
+0002d400: 2020 2020 2020 2320 7b22 6572 7263 6f64        # {"errcod
+0002d410: 6522 3a22 4d5f 464f 5242 4944 4445 4e22  e":"M_FORBIDDEN"
+0002d420: 2c22 6572 726f 7222 3a22 596f 7520 6172  ,"error":"You ar
+0002d430: 6520 6e6f 7420 6120 7365 7276 6572 2061  e not a server a
+0002d440: 646d 696e 227d 0a20 2020 2020 2020 2020  dmin"}.         
+0002d450: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+0002d460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d470: 2022 4531 3837 3a20 220a 2020 2020 2020   "E187: ".      
+0002d480: 2020 2020 2020 2020 2020 6622 5245 5354            f"REST
+0002d490: 2041 5049 2063 616c 6c20 6661 696c 6564   API call failed
+0002d4a0: 2e20 4661 696c 6564 2077 6974 6820 6572  . Failed with er
+0002d4b0: 726f 7220 636f 6465 207b 7374 6174 7573  ror code {status
+0002d4c0: 7d20 616e 6420 220a 2020 2020 2020 2020  } and ".        
+0002d4d0: 2020 2020 2020 2020 6622 6572 726f 7220          f"error 
+0002d4e0: 7465 7874 207b 7478 747d 2e20 496e 7075  text {txt}. Inpu
+0002d4f0: 7420 7761 733a 206d 6574 686f 643d 7b6d  t was: method={m
+0002d500: 6574 686f 647d 2022 0a20 2020 2020 2020  ethod} ".       
+0002d510: 2020 2020 2020 2020 2066 2264 6174 613d           f"data=
+0002d520: 7b64 6174 617d 2c20 7572 6c3d 7b70 7269  {data}, url={pri
+0002d530: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+0002d540: 7572 6c29 297d 2e22 0a20 2020 2020 2020  url))}.".       
+0002d550: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002d560: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+0002d570: 2b3d 2031 0a20 2020 2020 2020 2065 6c73  += 1.        els
+0002d580: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+0002d590: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+0002d5a0: 2020 2020 2020 2020 2020 2020 2066 2252               f"R
+0002d5b0: 4553 5420 4150 4920 6361 6c6c 2077 6173  EST API call was
+0002d5c0: 2073 7563 6365 7373 6675 6c2e 2022 0a20   successful. ". 
+0002d5d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002d5e0: 2252 6573 706f 6e73 6520 6973 3a20 7b74  "Response is: {t
+0002d5f0: 7874 7d2e 2049 6e70 7574 2077 6173 3a20  xt}. Input was: 
+0002d600: 6d65 7468 6f64 3d7b 6d65 7468 6f64 7d20  method={method} 
+0002d610: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002d620: 2020 6622 6461 7461 3d7b 6461 7461 7d2c    f"data={data},
+0002d630: 2075 726c 3d7b 7072 6976 6163 795f 6669   url={privacy_fi
+0002d640: 6c74 6572 2873 7472 2875 726c 2929 7d2e  lter(str(url))}.
+0002d650: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0002d660: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
+0002d670: 7470 7574 2066 6f72 6d61 7420 636f 6e74  tput format cont
+0002d680: 726f 6c6c 6564 2076 6961 202d 2d6f 7574  rolled via --out
+0002d690: 7075 7420 666c 6167 0a20 2020 2020 2020  put flag.       
+0002d6a0: 2020 2020 2074 6578 7420 3d20 6622 7b74       text = f"{t
+0002d6b0: 7874 7d22 2020 2320 7265 7475 726e 7320  xt}"  # returns 
+0002d6c0: 6f6e 6c79 2031 2076 616c 7565 0a20 2020  only 1 value.   
+0002d6d0: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+0002d6e0: 7820 3d20 7265 7370 2e5f 5f64 6963 745f  x = resp.__dict_
+0002d6f0: 5f0a 2020 2020 2020 2020 2020 2020 6a73  _.            js
+0002d700: 6f6e 5f6d 6178 2e75 7064 6174 6528 7b22  on_max.update({"
+0002d710: 7265 7370 6f6e 7365 223a 2074 7874 7d29  response": txt})
+0002d720: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
+0002d730: 6d73 0a20 2020 2020 2020 2020 2020 206a  ms.            j
+0002d740: 736f 6e5f 203d 206a 736f 6e5f 6d61 782e  son_ = json_max.
+0002d750: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+0002d760: 2020 2023 206a 736f 6e5f 2e70 6f70 2822     # json_.pop("
+0002d770: 6b65 7922 290a 2020 2020 2020 2020 2020  key").          
+0002d780: 2020 6a73 6f6e 5f73 7065 6320 3d20 4e6f    json_spec = No
+0002d790: 6e65 0a20 2020 2020 2020 2020 2020 2070  ne.            p
+0002d7a0: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
+0002d7b0: 2020 2020 2020 2020 2020 2020 2067 732e               gs.
+0002d7c0: 7061 2e6f 7574 7075 742c 0a20 2020 2020  pa.output,.     
+0002d7d0: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+0002d7e0: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
+0002d7f0: 2020 2020 2020 6a73 6f6e 5f3d 6a73 6f6e        json_=json
+0002d800: 5f2c 0a20 2020 2020 2020 2020 2020 2020  _,.             
+0002d810: 2020 206a 736f 6e5f 6d61 783d 6a73 6f6e     json_max=json
+0002d820: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
+0002d830: 2020 2020 2020 6a73 6f6e 5f73 7065 633d        json_spec=
+0002d840: 6a73 6f6e 5f73 7065 632c 0a20 2020 2020  json_spec,.     
+0002d850: 2020 2020 2020 2029 0a0a 0a61 7379 6e63         )...async
+0002d860: 2064 6566 2061 6374 696f 6e5f 6765 745f   def action_get_
+0002d870: 6176 6174 6172 2863 6c69 656e 743a 2041  avatar(client: A
+0002d880: 7379 6e63 436c 6965 6e74 2c20 6372 6564  syncClient, cred
+0002d890: 656e 7469 616c 733a 2064 6963 7429 202d  entials: dict) -
+0002d8a0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2247  > None:.    """G
+0002d8b0: 6574 2061 7661 7461 7228 7329 206f 6620  et avatar(s) of 
+0002d8c0: 6974 7365 6c66 206f 7220 7573 6572 7320  itself or users 
+0002d8d0: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
+0002d8e0: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
+0002d8f0: 6966 2067 732e 7061 2e67 6574 5f61 7661  if gs.pa.get_ava
+0002d900: 7461 7220 3d3d 205b 5d3a 0a20 2020 2020  tar == []:.     
+0002d910: 2020 2067 732e 7061 2e67 6574 5f61 7661     gs.pa.get_ava
+0002d920: 7461 722e 6170 7065 6e64 2863 7265 6465  tar.append(crede
+0002d930: 6e74 6961 6c73 5b22 7573 6572 5f69 6422  ntials["user_id"
+0002d940: 5d29 2020 2320 7768 6f61 6d69 0a20 2020  ])  # whoami.   
+0002d950: 2067 732e 6c6f 672e 6465 6275 6728 6622   gs.log.debug(f"
+0002d960: 4765 7474 696e 6720 6176 6174 6172 7320  Getting avatars 
+0002d970: 666f 7220 7468 6573 6520 7573 6572 733a  for these users:
+0002d980: 207b 6773 2e70 612e 6765 745f 6176 6174   {gs.pa.get_avat
+0002d990: 6172 7d22 290a 2020 2020 666f 7220 7573  ar}").    for us
+0002d9a0: 6572 5f69 6420 696e 2067 732e 7061 2e67  er_id in gs.pa.g
+0002d9b0: 6574 5f61 7661 7461 723a 0a20 2020 2020  et_avatar:.     
+0002d9c0: 2020 2075 7365 725f 6964 203d 2075 7365     user_id = use
+0002d9d0: 725f 6964 2e73 7472 6970 2829 0a20 2020  r_id.strip().   
+0002d9e0: 2020 2020 2072 6573 7020 3d20 6177 6169       resp = awai
+0002d9f0: 7420 636c 6965 6e74 2e67 6574 5f61 7661  t client.get_ava
+0002da00: 7461 7228 7573 6572 5f69 6429 0a20 2020  tar(user_id).   
+0002da10: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0002da20: 6365 2872 6573 702c 2050 726f 6669 6c65  ce(resp, Profile
+0002da30: 4765 7441 7661 7461 7252 6573 706f 6e73  GetAvatarRespons
+0002da40: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0002da50: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
+0002da60: 2020 2020 2020 2020 2020 2020 2020 2250                "P
+0002da70: 726f 6669 6c65 4765 7441 7661 7461 7252  rofileGetAvatarR
+0002da80: 6573 706f 6e73 652e 2052 6573 706f 6e73  esponse. Respons
+0002da90: 6520 6973 3a20 220a 2020 2020 2020 2020  e is: ".        
+0002daa0: 2020 2020 2020 2020 6622 7b70 7269 7661          f"{priva
+0002dab0: 6379 5f66 696c 7465 7228 7374 7228 7265  cy_filter(str(re
+0002dac0: 7370 2929 7d22 0a20 2020 2020 2020 2020  sp))}".         
+0002dad0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002dae0: 2061 7661 7461 725f 6d78 6320 3d20 7265   avatar_mxc = re
+0002daf0: 7370 2e61 7661 7461 725f 7572 6c0a 2020  sp.avatar_url.  
+0002db00: 2020 2020 2020 2020 2020 6176 6174 6172            avatar
+0002db10: 5f75 726c 203d 204e 6f6e 650a 2020 2020  _url = None.    
+0002db20: 2020 2020 2020 2020 6966 2061 7661 7461          if avata
+0002db30: 725f 6d78 633a 2020 2320 636f 756c 6420  r_mxc:  # could 
+0002db40: 6265 204e 6f6e 6520 6966 206e 6f20 6176  be None if no av
+0002db50: 6174 6172 0a20 2020 2020 2020 2020 2020  atar.           
+0002db60: 2020 2020 2061 7661 7461 725f 7572 6c20       avatar_url 
+0002db70: 3d20 6177 6169 7420 636c 6965 6e74 2e6d  = await client.m
+0002db80: 7863 5f74 6f5f 6874 7470 2861 7661 7461  xc_to_http(avata
+0002db90: 725f 6d78 6329 0a20 2020 2020 2020 2020  r_mxc).         
+0002dba0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0002dbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002dbc0: 2066 2261 7661 7461 725f 6d78 6320 6973   f"avatar_mxc is
+0002dbd0: 207b 6176 6174 6172 5f6d 7863 7d2e 2061   {avatar_mxc}. a
+0002dbe0: 7661 7461 725f 7572 6c20 6973 207b 6176  vatar_url is {av
+0002dbf0: 6174 6172 5f75 726c 7d22 0a20 2020 2020  atar_url}".     
+0002dc00: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002dc10: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
+0002dc20: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
+0002dc30: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
+0002dc40: 670a 2020 2020 2020 2020 2020 2020 7465  g.            te
+0002dc50: 7874 203d 2066 227b 6176 6174 6172 5f6d  xt = f"{avatar_m
+0002dc60: 7863 7d7b 5345 507d 7b61 7661 7461 725f  xc}{SEP}{avatar_
+0002dc70: 7572 6c7d 220a 2020 2020 2020 2020 2020  url}".          
+0002dc80: 2020 2320 4f62 6a65 6374 206f 6620 7479    # Object of ty
+0002dc90: 7065 2078 7878 5265 7370 6f6e 7365 2069  pe xxxResponse i
+0002dca0: 7320 6e6f 7420 4a53 4f4e 0a20 2020 2020  s not JSON.     
+0002dcb0: 2020 2020 2020 2023 2073 6572 6961 6c69         # seriali
+0002dcc0: 7a61 626c 652c 2068 656e 6365 2077 6520  zable, hence we 
+0002dcd0: 7573 6520 7468 6520 6469 6374 696f 6e61  use the dictiona
+0002dce0: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+0002dcf0: 6a73 6f6e 5f6d 6178 203d 2072 6573 702e  json_max = resp.
+0002dd00: 5f5f 6469 6374 5f5f 0a20 2020 2020 2020  __dict__.       
+0002dd10: 2020 2020 206a 736f 6e5f 6d61 782e 7570       json_max.up
+0002dd20: 6461 7465 287b 2261 7661 7461 725f 6874  date({"avatar_ht
+0002dd30: 7470 223a 2061 7661 7461 725f 7572 6c7d  tp": avatar_url}
+0002dd40: 2920 2023 2061 6464 2064 6963 7420 6974  )  # add dict it
+0002dd50: 656d 730a 2020 2020 2020 2020 2020 2020  ems.            
+0002dd60: 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178  json_ = json_max
+0002dd70: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+0002dd80: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
+0002dd90: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
+0002dda0: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+0002ddb0: 6a73 6f6e 5f73 7065 6320 3d20 4e6f 6e65  json_spec = None
+0002ddc0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0002ddd0: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
+0002dde0: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
+0002ddf0: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
+0002de00: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+0002de10: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+0002de20: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
+0002de30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002de40: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
+0002de50: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
+0002de60: 2020 2020 6a73 6f6e 5f73 7065 633d 6a73      json_spec=js
+0002de70: 6f6e 5f73 7065 632c 0a20 2020 2020 2020  on_spec,.       
+0002de80: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+0002de90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002dea0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0002deb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002dec0: 4531 3838 3a20 220a 2020 2020 2020 2020  E188: ".        
+0002ded0: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
+0002dee0: 2067 6574 7469 6e67 2061 7661 7461 7220   getting avatar 
+0002def0: 666f 7220 7573 6572 207b 7573 6572 5f69  for user {user_i
+0002df00: 647d 2022 0a20 2020 2020 2020 2020 2020  d} ".           
+0002df10: 2020 2020 2066 2266 726f 6d20 7365 7276       f"from serv
+0002df20: 6572 2e20 7b70 7269 7661 6379 5f66 696c  er. {privacy_fil
+0002df30: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+0002df40: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0002df50: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
+0002df60: 725f 636f 756e 7420 2b3d 2031 0a0a 0a61  r_count += 1...a
+0002df70: 7379 6e63 2064 6566 2061 6374 696f 6e5f  sync def action_
+0002df80: 6765 745f 7072 6f66 696c 6528 636c 6965  get_profile(clie
+0002df90: 6e74 3a20 4173 796e 6343 6c69 656e 742c  nt: AsyncClient,
+0002dfa0: 2063 7265 6465 6e74 6961 6c73 3a20 6469   credentials: di
+0002dfb0: 6374 2920 2d3e 204e 6f6e 653a 0a20 2020  ct) -> None:.   
+0002dfc0: 2022 2222 4765 7420 7573 6572 2070 726f   """Get user pro
+0002dfd0: 6669 6c65 2873 2920 6f66 2069 7473 656c  file(s) of itsel
+0002dfe0: 6620 6f72 2075 7365 7273 2077 6869 6c65  f or users while
+0002dff0: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
+0002e000: 696e 2e22 2222 0a20 2020 2069 6620 6773  in.""".    if gs
+0002e010: 2e70 612e 6765 745f 7072 6f66 696c 6520  .pa.get_profile 
+0002e020: 3d3d 205b 5d3a 0a20 2020 2020 2020 2067  == []:.        g
+0002e030: 732e 7061 2e67 6574 5f70 726f 6669 6c65  s.pa.get_profile
+0002e040: 2e61 7070 656e 6428 6372 6564 656e 7469  .append(credenti
+0002e050: 616c 735b 2275 7365 725f 6964 225d 2920  als["user_id"]) 
+0002e060: 2023 2077 686f 616d 690a 2020 2020 6773   # whoami.    gs
+0002e070: 2e6c 6f67 2e64 6562 7567 2866 2247 6574  .log.debug(f"Get
+0002e080: 7469 6e67 2075 7365 7220 7072 6f66 696c  ting user profil
+0002e090: 6573 2066 6f72 2074 6865 7365 2075 7365  es for these use
+0002e0a0: 7273 3a20 7b67 732e 7061 2e67 6574 5f70  rs: {gs.pa.get_p
+0002e0b0: 726f 6669 6c65 7d22 290a 2020 2020 666f  rofile}").    fo
+0002e0c0: 7220 7573 6572 5f69 6420 696e 2067 732e  r user_id in gs.
+0002e0d0: 7061 2e67 6574 5f70 726f 6669 6c65 3a0a  pa.get_profile:.
+0002e0e0: 2020 2020 2020 2020 7573 6572 5f69 6420          user_id 
+0002e0f0: 3d20 7573 6572 5f69 642e 7374 7269 7028  = user_id.strip(
+0002e100: 290a 2020 2020 2020 2020 7265 7370 203d  ).        resp =
+0002e110: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
+0002e120: 745f 7072 6f66 696c 6528 7573 6572 5f69  t_profile(user_i
+0002e130: 6429 0a20 2020 2020 2020 2069 6620 6973  d).        if is
+0002e140: 696e 7374 616e 6365 2872 6573 702c 2050  instance(resp, P
+0002e150: 726f 6669 6c65 4765 7445 7272 6f72 293a  rofileGetError):
+0002e160: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+0002e170: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+0002e180: 2020 2020 2020 2020 2020 2022 4531 3839             "E189
+0002e190: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+0002e1a0: 2020 2020 6622 4661 696c 6564 2067 6574      f"Failed get
+0002e1b0: 7469 6e67 2070 726f 6669 6c65 2066 6f72  ting profile for
+0002e1c0: 2075 7365 7220 7b75 7365 725f 6964 7d20   user {user_id} 
+0002e1d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002e1e0: 2020 6622 6672 6f6d 2073 6572 7665 722e    f"from server.
+0002e1f0: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+0002e200: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+0002e210: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002e220: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+0002e230: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+0002e240: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002e250: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+0002e260: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002e270: 2020 6622 5072 6f66 696c 6547 6574 5265    f"ProfileGetRe
+0002e280: 7370 6f6e 7365 2e20 5265 7370 6f6e 7365  sponse. Response
+0002e290: 2069 733a 207b 7072 6976 6163 795f 6669   is: {privacy_fi
+0002e2a0: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+0002e2b0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0002e2c0: 2020 2020 2020 2020 2020 2020 6469 7370              disp
+0002e2d0: 6c61 796e 616d 6520 3d20 7265 7370 2e64  layname = resp.d
+0002e2e0: 6973 706c 6179 6e61 6d65 0a20 2020 2020  isplayname.     
+0002e2f0: 2020 2020 2020 2061 7661 7461 725f 6d78         avatar_mx
+0002e300: 6320 3d20 7265 7370 2e61 7661 7461 725f  c = resp.avatar_
+0002e310: 7572 6c0a 2020 2020 2020 2020 2020 2020  url.            
+0002e320: 6176 6174 6172 5f75 726c 203d 204e 6f6e  avatar_url = Non
+0002e330: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+0002e340: 2061 7661 7461 725f 6d78 633a 2020 2320   avatar_mxc:  # 
+0002e350: 636f 756c 6420 6265 204e 6f6e 6520 6966  could be None if
+0002e360: 206e 6f20 6176 6174 6172 0a20 2020 2020   no avatar.     
+0002e370: 2020 2020 2020 2020 2020 2061 7661 7461             avata
+0002e380: 725f 7572 6c20 3d20 6177 6169 7420 636c  r_url = await cl
+0002e390: 6965 6e74 2e6d 7863 5f74 6f5f 6874 7470  ient.mxc_to_http
+0002e3a0: 2861 7661 7461 725f 6d78 6329 0a20 2020  (avatar_mxc).   
+0002e3b0: 2020 2020 2020 2020 206f 7468 6572 5f69           other_i
+0002e3c0: 6e66 6f20 3d20 7265 7370 2e6f 7468 6572  nfo = resp.other
+0002e3d0: 5f69 6e66 6f0a 2020 2020 2020 2020 2020  _info.          
+0002e3e0: 2020 6966 206e 6f74 206f 7468 6572 5f69    if not other_i
+0002e3f0: 6e66 6f3a 2020 2320 656d 7074 7920 6469  nfo:  # empty di
+0002e400: 6374 0a20 2020 2020 2020 2020 2020 2020  ct.             
+0002e410: 2020 206f 7468 6572 5f69 6e66 6f20 3d20     other_info = 
+0002e420: 2222 0a20 2020 2020 2020 2020 2020 2067  "".            g
+0002e430: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+0002e440: 2020 2020 2020 2020 2020 2020 2066 2264               f"d
+0002e450: 6973 706c 6179 6e61 6d65 2069 7320 7b64  isplayname is {d
+0002e460: 6973 706c 6179 6e61 6d65 7d2e 2061 7661  isplayname}. ava
+0002e470: 7461 725f 6d78 6320 6973 207b 6176 6174  tar_mxc is {avat
+0002e480: 6172 5f6d 7863 7d2e 2022 0a20 2020 2020  ar_mxc}. ".     
+0002e490: 2020 2020 2020 2020 2020 2066 2261 7661             f"ava
+0002e4a0: 7461 725f 7572 6c20 6973 207b 6176 6174  tar_url is {avat
+0002e4b0: 6172 5f75 726c 7d2e 206f 7468 6572 5f69  ar_url}. other_i
+0002e4c0: 6e66 6f20 6973 207b 7265 7370 2e6f 7468  nfo is {resp.oth
+0002e4d0: 6572 5f69 6e66 6f7d 2e22 0a20 2020 2020  er_info}.".     
+0002e4e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002e4f0: 2020 2020 2023 206f 7574 7075 7420 666f       # output fo
+0002e500: 726d 6174 2063 6f6e 7472 6f6c 6c65 6420  rmat controlled 
+0002e510: 7669 6120 2d2d 6f75 7470 7574 2066 6c61  via --output fla
+0002e520: 670a 2020 2020 2020 2020 2020 2020 7465  g.            te
+0002e530: 7874 203d 2028 0a20 2020 2020 2020 2020  xt = (.         
+0002e540: 2020 2020 2020 2066 227b 6469 7370 6c61         f"{displa
+0002e550: 796e 616d 657d 7b53 4550 7d7b 6176 6174  yname}{SEP}{avat
+0002e560: 6172 5f6d 7863 7d7b 5345 507d 7b61 7661  ar_mxc}{SEP}{ava
+0002e570: 7461 725f 7572 6c7d 220a 2020 2020 2020  tar_url}".      
+0002e580: 2020 2020 2020 2020 2020 6622 7b53 4550            f"{SEP
+0002e590: 7d7b 6f74 6865 725f 696e 666f 7d22 0a20  }{other_info}". 
+0002e5a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002e5b0: 2020 2020 2020 2020 2023 204f 626a 6563           # Objec
+0002e5c0: 7420 6f66 2074 7970 6520 7878 7852 6573  t of type xxxRes
+0002e5d0: 706f 6e73 6520 6973 206e 6f74 204a 534f  ponse is not JSO
+0002e5e0: 4e0a 2020 2020 2020 2020 2020 2020 2320  N.            # 
+0002e5f0: 7365 7269 616c 697a 6162 6c65 2c20 6865  serializable, he
+0002e600: 6e63 6520 7765 2075 7365 2074 6865 2064  nce we use the d
+0002e610: 6963 7469 6f6e 6172 792e 0a20 2020 2020  ictionary..     
+0002e620: 2020 2020 2020 206a 736f 6e5f 6d61 7820         json_max 
+0002e630: 3d20 7265 7370 2e5f 5f64 6963 745f 5f0a  = resp.__dict__.
+0002e640: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002e650: 5f6d 6178 2e75 7064 6174 6528 7b22 6176  _max.update({"av
+0002e660: 6174 6172 5f68 7474 7022 3a20 6176 6174  atar_http": avat
+0002e670: 6172 5f75 726c 7d29 2020 2320 6164 6420  ar_url})  # add 
+0002e680: 6469 6374 2069 7465 6d73 0a20 2020 2020  dict items.     
+0002e690: 2020 2020 2020 206a 736f 6e5f 203d 206a         json_ = j
+0002e6a0: 736f 6e5f 6d61 782e 636f 7079 2829 0a20  son_max.copy(). 
+0002e6b0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002e6c0: 2e70 6f70 2822 7472 616e 7370 6f72 745f  .pop("transport_
+0002e6d0: 7265 7370 6f6e 7365 2229 0a20 2020 2020  response").     
+0002e6e0: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
+0002e6f0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0002e700: 2020 2020 7072 696e 745f 6f75 7470 7574      print_output
+0002e710: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002e720: 2020 6773 2e70 612e 6f75 7470 7574 2c0a    gs.pa.output,.
+0002e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e740: 7465 7874 3d74 6578 742c 0a20 2020 2020  text=text,.     
+0002e750: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002e760: 3d6a 736f 6e5f 2c0a 2020 2020 2020 2020  =json_,.        
+0002e770: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+0002e780: 3d6a 736f 6e5f 6d61 782c 0a20 2020 2020  =json_max,.     
+0002e790: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0002e7a0: 7370 6563 3d6a 736f 6e5f 7370 6563 2c0a  spec=json_spec,.
+0002e7b0: 2020 2020 2020 2020 2020 2020 290a 0a0a              )...
+0002e7c0: 6173 796e 6320 6465 6620 6163 7469 6f6e  async def action
+0002e7d0: 5f67 6574 5f63 6c69 656e 745f 696e 666f  _get_client_info
+0002e7e0: 280a 2020 2020 636c 6965 6e74 3a20 4173  (.    client: As
+0002e7f0: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
+0002e800: 6e74 6961 6c73 3a20 6469 6374 0a29 202d  ntials: dict.) -
+0002e810: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2247  > None:.    """G
+0002e820: 6574 2063 6c69 656e 7420 696e 666f 2077  et client info w
+0002e830: 6869 6c65 2061 6c72 6561 6479 206c 6f67  hile already log
+0002e840: 6765 6420 696e 2e22 2222 0a20 2020 2067  ged in.""".    g
+0002e850: 732e 6c6f 672e 6465 6275 6728 2247 6574  s.log.debug("Get
+0002e860: 7469 6e67 2063 6c69 656e 7420 696e 666f  ting client info
+0002e870: 2e22 290a 2020 2020 6177 6169 7420 7379  .").    await sy
+0002e880: 6e63 6872 6f6e 697a 6528 636c 6965 6e74  nchronize(client
+0002e890: 2920 2023 2073 796e 6328 2920 746f 2067  )  # sync() to g
+0002e8a0: 6574 2072 6f6f 6d73 0a20 2020 2070 7269  et rooms.    pri
+0002e8b0: 6e74 286a 736f 6e2e 6475 6d70 7328 636c  nt(json.dumps(cl
+0002e8c0: 6965 6e74 2e5f 5f64 6963 745f 5f2c 2064  ient.__dict__, d
+0002e8d0: 6566 6175 6c74 3d6f 626a 5f74 6f5f 6469  efault=obj_to_di
+0002e8e0: 6374 2929 0a0a 0a61 7379 6e63 2064 6566  ct))...async def
+0002e8f0: 2061 6374 696f 6e5f 6765 745f 726f 6f6d   action_get_room
+0002e900: 5f69 6e66 6f28 636c 6965 6e74 3a20 4173  _info(client: As
+0002e910: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
+0002e920: 6e74 6961 6c73 3a20 6469 6374 2920 2d3e  ntials: dict) ->
+0002e930: 204e 6f6e 653a 0a20 2020 2022 2222 4765   None:.    """Ge
+0002e940: 7420 726f 6f6d 2064 6973 706c 6179 206e  t room display n
+0002e950: 616d 6528 7329 206f 6620 6974 7365 6c66  ame(s) of itself
+0002e960: 206f 7220 726f 6f6d 7320 7768 696c 6520   or rooms while 
+0002e970: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
+0002e980: 6e2e 2222 220a 2020 2020 6966 2067 732e  n.""".    if gs.
+0002e990: 7061 2e67 6574 5f72 6f6f 6d5f 696e 666f  pa.get_room_info
+0002e9a0: 203d 3d20 5b5d 3a0a 2020 2020 2020 2020   == []:.        
+0002e9b0: 6773 2e70 612e 6765 745f 726f 6f6d 5f69  gs.pa.get_room_i
+0002e9c0: 6e66 6f2e 6170 7065 6e64 2863 7265 6465  nfo.append(crede
+0002e9d0: 6e74 6961 6c73 5b22 726f 6f6d 5f69 6422  ntials["room_id"
+0002e9e0: 5d29 0a20 2020 2067 732e 6c6f 672e 6465  ]).    gs.log.de
+0002e9f0: 6275 6728 0a20 2020 2020 2020 2022 4765  bug(.        "Ge
+0002ea00: 7474 696e 6720 726f 6f6d 2064 6973 706c  tting room displ
+0002ea10: 6179 206e 616d 6573 2066 6f72 2074 6865  ay names for the
+0002ea20: 7365 2072 6f6f 6d73 3a20 2220 6622 7b67  se rooms: " f"{g
+0002ea30: 732e 7061 2e67 6574 5f72 6f6f 6d5f 696e  s.pa.get_room_in
+0002ea40: 666f 7d22 0a20 2020 2029 0a20 2020 2061  fo}".    ).    a
+0002ea50: 7761 6974 2073 796e 6368 726f 6e69 7a65  wait synchronize
+0002ea60: 2863 6c69 656e 7429 2020 2320 7379 6e63  (client)  # sync
+0002ea70: 2829 2074 6f20 6765 7420 726f 6f6d 730a  () to get rooms.
+0002ea80: 2020 2020 2320 7573 6572 5f69 6420 3d20      # user_id = 
+0002ea90: 6372 6564 656e 7469 616c 735b 2275 7365  credentials["use
+0002eaa0: 725f 6964 225d 0a20 2020 2066 6f72 2072  r_id"].    for r
+0002eab0: 6f6f 6d5f 6964 2069 6e20 6773 2e70 612e  oom_id in gs.pa.
+0002eac0: 6765 745f 726f 6f6d 5f69 6e66 6f3a 0a20  get_room_info:. 
+0002ead0: 2020 2020 2020 2072 6f6f 6d5f 6964 203d         room_id =
+0002eae0: 2061 7761 6974 206d 6170 5f72 6f6f 6d69   await map_roomi
+0002eaf0: 6e66 6f5f 746f 5f72 6f6f 6d69 6428 636c  nfo_to_roomid(cl
+0002eb00: 6965 6e74 2c20 726f 6f6d 5f69 6429 0a20  ient, room_id). 
+0002eb10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0002eb20: 2020 2020 2020 2020 726f 6f6d 203d 2063          room = c
+0002eb30: 6c69 656e 742e 726f 6f6d 735b 726f 6f6d  lient.rooms[room
+0002eb40: 5f69 645d 0a20 2020 2020 2020 2020 2020  _id].           
+0002eb50: 2072 6f6f 6d5f 6469 7370 6c61 796e 616d   room_displaynam
+0002eb60: 6520 3d20 726f 6f6d 2e64 6973 706c 6179  e = room.display
+0002eb70: 5f6e 616d 650a 2020 2020 2020 2020 6578  _name.        ex
+0002eb80: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0002eb90: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0002eba0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0002ebb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002ebc0: 4531 3930 3a20 220a 2020 2020 2020 2020  E190: ".        
+0002ebd0: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
+0002ebe0: 2067 6574 7469 6e67 2072 6f6f 6d20 6469   getting room di
+0002ebf0: 7370 6c61 7920 6e61 6d65 2066 6f72 2072  splay name for r
+0002ec00: 6f6f 6d20 7b72 6f6f 6d5f 6964 7d20 220a  oom {room_id} ".
+0002ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec20: 6622 6672 6f6d 2073 6572 7665 722e 2022  f"from server. "
+0002ec30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ec40: 2066 2245 7863 6570 7469 6f6e 2069 7320   f"Exception is 
+0002ec50: 7b65 7d2e 2022 0a20 2020 2020 2020 2020  {e}. ".         
+0002ec60: 2020 2020 2020 2066 2252 6f6f 6d20 6973         f"Room is
+0002ec70: 207b 726f 6f6d 7d2e 2052 6f6f 6d20 6469   {room}. Room di
+0002ec80: 6374 2069 7320 7b72 6f6f 6d2e 5f5f 6469  ct is {room.__di
+0002ec90: 6374 5f5f 7d2e 2022 0a20 2020 2020 2020  ct__}. ".       
+0002eca0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002ecb0: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+0002ecc0: 2b3d 2031 0a20 2020 2020 2020 2065 6c73  += 1.        els
+0002ecd0: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+0002ece0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+0002ecf0: 2020 2020 2020 2020 2020 2020 2066 2272               f"r
+0002ed00: 6f6f 6d20 6964 2069 7320 7b72 6f6f 6d5f  oom id is {room_
+0002ed10: 6964 7d2c 2022 0a20 2020 2020 2020 2020  id}, ".         
+0002ed20: 2020 2020 2020 2066 2272 6f6f 6d20 6469         f"room di
+0002ed30: 7370 6c61 7920 6e61 6d65 2069 7320 7b72  splay name is {r
+0002ed40: 6f6f 6d5f 6469 7370 6c61 796e 616d 657d  oom_displayname}
+0002ed50: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+0002ed60: 2020 2020 6622 726f 6f6d 2069 7320 7b72      f"room is {r
+0002ed70: 6f6f 6d7d 2e20 220a 2020 2020 2020 2020  oom}. ".        
+0002ed80: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0002ed90: 2020 7265 7370 203d 2072 6f6f 6d0a 2020    resp = room.  
+0002eda0: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
+0002edb0: 7574 2066 6f72 6d61 7420 636f 6e74 726f  ut format contro
+0002edc0: 6c6c 6564 2076 6961 202d 2d6f 7574 7075  lled via --outpu
+0002edd0: 7420 666c 6167 0a20 2020 2020 2020 2020  t flag.         
+0002ede0: 2020 2074 6578 7420 3d20 280a 2020 2020     text = (.    
+0002edf0: 2020 2020 2020 2020 2020 2020 6622 7b72              f"{r
+0002ee00: 6f6f 6d5f 6964 7d7b 5345 507d 7b72 6f6f  oom_id}{SEP}{roo
+0002ee10: 6d5f 6469 7370 6c61 796e 616d 657d 7b53  m_displayname}{S
+0002ee20: 4550 7d22 0a20 2020 2020 2020 2020 2020  EP}".           
+0002ee30: 2020 2020 2066 227b 726f 6f6d 2e63 616e       f"{room.can
+0002ee40: 6f6e 6963 616c 5f61 6c69 6173 7d7b 5345  onical_alias}{SE
+0002ee50: 507d 7b72 6f6f 6d2e 746f 7069 637d 7b53  P}{room.topic}{S
+0002ee60: 4550 7d22 0a20 2020 2020 2020 2020 2020  EP}".           
+0002ee70: 2020 2020 2066 227b 726f 6f6d 2e63 7265       f"{room.cre
+0002ee80: 6174 6f72 7d7b 5345 507d 7b72 6f6f 6d2e  ator}{SEP}{room.
+0002ee90: 656e 6372 7970 7465 647d 220a 2020 2020  encrypted}".    
+0002eea0: 2020 2020 2020 2020 2020 2020 2320 6622              # f"
+0002eeb0: 7b53 4550 7d7b 7573 6572 5f69 647d 220a  {SEP}{user_id}".
+0002eec0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002eed0: 2020 2020 2020 2020 2020 2320 4f62 6a65            # Obje
+0002eee0: 6374 206f 6620 7479 7065 2078 7878 5265  ct of type xxxRe
+0002eef0: 7370 6f6e 7365 2069 7320 6e6f 7420 4a53  sponse is not JS
+0002ef00: 4f4e 0a20 2020 2020 2020 2020 2020 2023  ON.            #
+0002ef10: 2073 6572 6961 6c69 7a61 626c 652c 2068   serializable, h
+0002ef20: 656e 6365 2077 6520 7573 6520 7468 6520  ence we use the 
+0002ef30: 6469 6374 696f 6e61 7279 2e0a 2020 2020  dictionary..    
+0002ef40: 2020 2020 2020 2020 6a73 6f6e 5f6d 6178          json_max
+0002ef50: 203d 2072 6573 702e 5f5f 6469 6374 5f5f   = resp.__dict__
+0002ef60: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002ef70: 6e5f 6d61 782e 7570 6461 7465 280a 2020  n_max.update(.  
+0002ef80: 2020 2020 2020 2020 2020 2020 2020 7b22                {"
+0002ef90: 6469 7370 6c61 795f 6e61 6d65 223a 2072  display_name": r
+0002efa0: 6f6f 6d5f 6469 7370 6c61 796e 616d 657d  oom_displayname}
+0002efb0: 0a20 2020 2020 2020 2020 2020 2029 2020  .            )  
+0002efc0: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
+0002efd0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+0002efe0: 6e5f 203d 206a 736f 6e5f 6d61 782e 636f  n_ = json_max.co
+0002eff0: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+0002f000: 2023 206a 736f 6e5f 2e70 6f70 2822 6b65   # json_.pop("ke
+0002f010: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
+0002f020: 6a73 6f6e 5f73 7065 6320 3d20 4e6f 6e65  json_spec = None
+0002f030: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0002f040: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
+0002f050: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
+0002f060: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
+0002f070: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+0002f080: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+0002f090: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
+0002f0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f0b0: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
+0002f0c0: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
+0002f0d0: 2020 2020 6a73 6f6e 5f73 7065 633d 6a73      json_spec=js
+0002f0e0: 6f6e 5f73 7065 632c 0a20 2020 2020 2020  on_spec,.       
+0002f0f0: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
+0002f100: 6566 2061 6374 696f 6e5f 6861 735f 7065  ef action_has_pe
+0002f110: 726d 6973 7369 6f6e 280a 2020 2020 636c  rmission(.    cl
+0002f120: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+0002f130: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
+0002f140: 6469 6374 0a29 202d 3e20 4e6f 6e65 3a0a  dict.) -> None:.
+0002f150: 2020 2020 2222 2249 6e71 7569 7265 2061      """Inquire a
+0002f160: 626f 7574 2070 6572 6d69 7373 696f 6e73  bout permissions
+0002f170: 2069 6e20 726f 6f6d 7320 7768 696c 6520   in rooms while 
+0002f180: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
+0002f190: 6e2e 2222 220a 2020 2020 6966 206e 6f74  n.""".    if not
+0002f1a0: 206c 656e 2867 732e 7061 2e68 6173 5f70   len(gs.pa.has_p
+0002f1b0: 6572 6d69 7373 696f 6e29 2025 2032 203d  ermission) % 2 =
+0002f1c0: 3d20 303a 0a20 2020 2020 2020 2067 732e  = 0:.        gs.
+0002f1d0: 6c6f 672e 6572 726f 7228 0a20 2020 2020  log.error(.     
+0002f1e0: 2020 2020 2020 2022 4531 3931 3a20 220a         "E191: ".
+0002f1f0: 2020 2020 2020 2020 2020 2020 2249 6e63              "Inc
+0002f200: 6f72 7265 6374 206e 756d 6265 7220 6f66  orrect number of
+0002f210: 2061 7267 756d 656e 7473 2066 6f72 202d   arguments for -
+0002f220: 2d68 6173 2d70 6572 6d69 7373 696f 6e2e  -has-permission.
+0002f230: 2041 7267 756d 656e 7473 2022 0a20 2020   Arguments ".   
+0002f240: 2020 2020 2020 2020 2022 6d75 7374 2062           "must b
+0002f250: 6520 7061 6972 732c 2069 2e65 2e20 6d75  e pairs, i.e. mu
+0002f260: 6c74 6970 6c65 7320 6f66 2032 2c20 6275  ltiples of 2, bu
+0002f270: 7420 666f 756e 6420 220a 2020 2020 2020  t found ".      
+0002f280: 2020 2020 2020 6622 7b6c 656e 2867 732e        f"{len(gs.
+0002f290: 7061 2e68 6173 5f70 6572 6d69 7373 696f  pa.has_permissio
+0002f2a0: 6e29 7d20 6172 6775 6d65 6e74 732e 220a  n)} arguments.".
+0002f2b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002f2c0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+0002f2d0: 3d20 310a 2020 2020 2020 2020 7265 7475  = 1.        retu
+0002f2e0: 726e 0a20 2020 2075 7365 725f 6964 203d  rn.    user_id =
+0002f2f0: 2063 7265 6465 6e74 6961 6c73 5b22 7573   credentials["us
+0002f300: 6572 5f69 6422 5d20 2023 2077 686f 616d  er_id"]  # whoam
+0002f310: 690a 2020 2020 666f 7220 6969 2069 6e20  i.    for ii in 
+0002f320: 7261 6e67 6528 6c65 6e28 6773 2e70 612e  range(len(gs.pa.
+0002f330: 6861 735f 7065 726d 6973 7369 6f6e 2920  has_permission) 
+0002f340: 2f2f 2032 293a 0a20 2020 2020 2020 2072  // 2):.        r
+0002f350: 6f6f 6d5f 6964 203d 2067 732e 7061 2e68  oom_id = gs.pa.h
+0002f360: 6173 5f70 6572 6d69 7373 696f 6e5b 6969  as_permission[ii
+0002f370: 202a 2032 202b 2030 5d0a 2020 2020 2020   * 2 + 0].      
+0002f380: 2020 726f 6f6d 5f69 6420 3d20 726f 6f6d    room_id = room
+0002f390: 5f69 642e 7265 706c 6163 6528 7222 5c21  _id.replace(r"\!
+0002f3a0: 222c 2022 2122 2920 2023 2072 656d 6f76  ", "!")  # remov
+0002f3b0: 6520 706f 7373 6962 6c65 2065 7363 6170  e possible escap
+0002f3c0: 650a 2020 2020 2020 2020 726f 6f6d 5f69  e.        room_i
+0002f3d0: 6420 3d20 6177 6169 7420 6d61 705f 726f  d = await map_ro
+0002f3e0: 6f6d 696e 666f 5f74 6f5f 726f 6f6d 6964  ominfo_to_roomid
+0002f3f0: 2863 6c69 656e 742c 2072 6f6f 6d5f 6964  (client, room_id
+0002f400: 290a 2020 2020 2020 2020 7065 726d 6973  ).        permis
+0002f410: 7369 6f6e 5f74 7970 6520 3d20 6773 2e70  sion_type = gs.p
+0002f420: 612e 6861 735f 7065 726d 6973 7369 6f6e  a.has_permission
+0002f430: 5b69 6920 2a20 3220 2b20 315d 2e73 7472  [ii * 2 + 1].str
+0002f440: 6970 2829 0a20 2020 2020 2020 2067 732e  ip().        gs.
+0002f450: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0002f460: 2020 2020 2020 2022 5072 6570 6172 696e         "Preparin
+0002f470: 6720 746f 2061 736b 2061 626f 7574 2070  g to ask about p
+0002f480: 6572 6d69 7373 696f 6e20 666f 7220 7065  ermission for pe
+0002f490: 726d 6973 7369 6f6e 2074 7970 6520 220a  rmission type ".
+0002f4a0: 2020 2020 2020 2020 2020 2020 6622 277b              f"'{
+0002f4b0: 7065 726d 6973 7369 6f6e 5f74 7970 657d  permission_type}
+0002f4c0: 2720 696e 2072 6f6f 6d20 7b72 6f6f 6d5f  ' in room {room_
+0002f4d0: 6964 7d2e 220a 2020 2020 2020 2020 290a  id}.".        ).
+0002f4e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0002f4f0: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+0002f500: 6177 6169 7420 636c 6965 6e74 2e68 6173  await client.has
+0002f510: 5f70 6572 6d69 7373 696f 6e28 726f 6f6d  _permission(room
+0002f520: 5f69 642c 2070 6572 6d69 7373 696f 6e5f  _id, permission_
+0002f530: 7479 7065 290a 2020 2020 2020 2020 6578  type).        ex
+0002f540: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0002f550: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0002f560: 2072 6573 7020 3d20 4572 726f 7252 6573   resp = ErrorRes
+0002f570: 706f 6e73 6528 0a20 2020 2020 2020 2020  ponse(.         
+0002f580: 2020 2020 2020 2022 4531 3932 3a20 220a         "E192: ".
+0002f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f5a0: 6622 6861 735f 7065 726d 6973 7369 6f6e  f"has_permission
+0002f5b0: 2829 2066 6169 6c65 6420 7769 7468 2027  () failed with '
+0002f5c0: 7b65 7d27 2e20 220a 2020 2020 2020 2020  {e}'. ".        
+0002f5d0: 2020 2020 2020 2020 6622 4973 2074 6865          f"Is the
+0002f5e0: 2072 6f6f 6d20 6964 207b 726f 6f6d 5f69   room id {room_i
+0002f5f0: 647d 2063 6f72 7265 6374 3f22 0a20 2020  d} correct?".   
+0002f600: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002f610: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0002f620: 2872 6573 702c 2045 7272 6f72 5265 7370  (resp, ErrorResp
+0002f630: 6f6e 7365 293a 0a20 2020 2020 2020 2020  onse):.         
+0002f640: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+0002f650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f660: 2022 4531 3933 3a20 220a 2020 2020 2020   "E193: ".      
+0002f670: 2020 2020 2020 2020 2020 2246 6169 6c65            "Faile
+0002f680: 6420 746f 2061 736b 2061 626f 7574 2070  d to ask about p
+0002f690: 6572 6d69 7373 696f 6e20 666f 7220 7065  ermission for pe
+0002f6a0: 726d 6973 7369 6f6e 2074 7970 6520 220a  rmission type ".
+0002f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f6c0: 6622 277b 7065 726d 6973 7369 6f6e 5f74  f"'{permission_t
+0002f6d0: 7970 657d 2720 696e 2072 6f6f 6d20 7b72  ype}' in room {r
+0002f6e0: 6f6f 6d5f 6964 7d2e 2022 0a20 2020 2020  oom_id}. ".     
+0002f6f0: 2020 2020 2020 2020 2020 2066 2252 6573             f"Res
+0002f700: 706f 6e73 6520 6973 207b 7072 6976 6163  ponse is {privac
+0002f710: 795f 6669 6c74 6572 2873 7472 2872 6573  y_filter(str(res
+0002f720: 7029 297d 220a 2020 2020 2020 2020 2020  p))}".          
+0002f730: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002f740: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+0002f750: 310a 2020 2020 2020 2020 2020 2020 2320  1.            # 
+0002f760: 6f75 7470 7574 2066 6f72 6d61 7420 636f  output format co
+0002f770: 6e74 726f 6c6c 6564 2076 6961 202d 2d6f  ntrolled via --o
+0002f780: 7574 7075 7420 666c 6167 0a20 2020 2020  utput flag.     
+0002f790: 2020 2020 2020 2023 2066 6f72 204a 534f         # for JSO
+0002f7a0: 4e20 7468 6520 7573 6572 2063 616e 2064  N the user can d
+0002f7b0: 6574 6572 6d69 6e65 2077 6869 6368 206f  etermine which o
+0002f7c0: 6e65 2066 726f 6d20 7468 6520 6c69 7374  ne from the list
+0002f7d0: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
+0002f7e0: 6173 2073 7563 6365 7373 6675 6c20 616e  as successful an
+0002f7f0: 6420 7768 6963 6820 6f6e 6520 6661 696c  d which one fail
+0002f800: 6564 2e20 466f 7220 3420 696e 7075 7473  ed. For 4 inputs
+0002f810: 2074 6865 7265 0a20 2020 2020 2020 2020   there.         
+0002f820: 2020 2023 206d 6967 6874 206f 6e6c 7920     # might only 
+0002f830: 6265 2033 206f 7574 7075 7420 4a53 4f4e  be 3 output JSON
+0002f840: 206f 626a 6563 7473 2069 6620 7468 6572   objects if ther
+0002f850: 6520 7761 7320 3120 6572 726f 722e 0a20  e was 1 error.. 
+0002f860: 2020 2020 2020 2020 2020 2023 2049 6e20             # In 
+0002f870: 7465 7874 206d 6f64 6520 7765 2070 7269  text mode we pri
+0002f880: 6e74 2074 6869 7320 6572 726f 7220 6c69  nt this error li
+0002f890: 6e65 2c20 736f 2074 6861 7420 666f 7220  ne, so that for 
+0002f8a0: 3420 696e 7075 7473 0a20 2020 2020 2020  4 inputs.       
+0002f8b0: 2020 2020 2023 2074 6865 7265 2077 696c       # there wil
+0002f8c0: 6c20 6265 2034 206f 7574 7075 7420 6c69  l be 4 output li
+0002f8d0: 6e65 732e 0a20 2020 2020 2020 2020 2020  nes..           
+0002f8e0: 2070 7269 6e74 5f6f 7574 7075 7428 0a20   print_output(. 
+0002f8f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0002f900: 732e 7061 2e6f 7574 7075 742c 0a20 2020  s.pa.output,.   
+0002f910: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+0002f920: 743d 280a 2020 2020 2020 2020 2020 2020  t=(.            
+0002f930: 2020 2020 2020 2020 6622 4572 726f 727b          f"Error{
+0002f940: 5345 507d 7b75 7365 725f 6964 7d7b 5345  SEP}{user_id}{SE
+0002f950: 507d 7b72 6f6f 6d5f 6964 7d22 0a20 2020  P}{room_id}".   
+0002f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f970: 2066 227b 5345 507d 7b70 6572 6d69 7373   f"{SEP}{permiss
+0002f980: 696f 6e5f 7479 7065 7d22 0a20 2020 2020  ion_type}".     
+0002f990: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0002f9a0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0002f9b0: 6f6e 5f3d 4e6f 6e65 2c0a 2020 2020 2020  on_=None,.      
+0002f9c0: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+0002f9d0: 6178 3d4e 6f6e 652c 0a20 2020 2020 2020  ax=None,.       
+0002f9e0: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+0002f9f0: 6563 3d4e 6f6e 652c 0a20 2020 2020 2020  ec=None,.       
+0002fa00: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+0002fa10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002fa20: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
+0002fa30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002fa40: 2268 6173 5f70 6572 6d69 7373 696f 6e20  "has_permission 
+0002fa50: 7b75 7365 725f 6964 7d20 666f 7220 7065  {user_id} for pe
+0002fa60: 726d 6973 7369 6f6e 2074 7970 6520 220a  rmission type ".
+0002fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fa80: 6622 277b 7065 726d 6973 7369 6f6e 5f74  f"'{permission_t
+0002fa90: 7970 657d 2720 696e 2072 6f6f 6d20 7b72  ype}' in room {r
+0002faa0: 6f6f 6d5f 6964 7d3a 2022 0a20 2020 2020  oom_id}: ".     
+0002fab0: 2020 2020 2020 2020 2020 2066 227b 7072             f"{pr
+0002fac0: 6976 6163 795f 6669 6c74 6572 2873 7472  ivacy_filter(str
+0002fad0: 2872 6573 7029 297d 220a 2020 2020 2020  (resp))}".      
+0002fae0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002faf0: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
+0002fb00: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
+0002fb10: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
+0002fb20: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
+0002fb30: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
+0002fb40: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+0002fb50: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+0002fb60: 2929 7d7b 5345 507d 7b75 7365 725f 6964  ))}{SEP}{user_id
+0002fb70: 7d7b 5345 507d 7b72 6f6f 6d5f 6964 7d7b  }{SEP}{room_id}{
+0002fb80: 5345 507d 220a 2020 2020 2020 2020 2020  SEP}".          
+0002fb90: 2020 2020 2020 6622 7b70 6572 6d69 7373        f"{permiss
+0002fba0: 696f 6e5f 7479 7065 7d22 0a20 2020 2020  ion_type}".     
+0002fbb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002fbc0: 2020 2020 2023 204f 626a 6563 7420 6f66       # Object of
+0002fbd0: 2074 7970 6520 7878 7852 6573 706f 6e73   type xxxRespons
+0002fbe0: 6520 6973 206e 6f74 204a 534f 4e0a 2020  e is not JSON.  
+0002fbf0: 2020 2020 2020 2020 2020 2320 7365 7269            # seri
+0002fc00: 616c 697a 6162 6c65 2c20 6865 6e63 6520  alizable, hence 
+0002fc10: 7765 2075 7365 2074 6865 2064 6963 7469  we use the dicti
+0002fc20: 6f6e 6172 792e 0a20 2020 2020 2020 2020  onary..         
+0002fc30: 2020 206a 736f 6e5f 6d61 7820 3d20 7265     json_max = re
+0002fc40: 7370 2e5f 5f64 6963 745f 5f0a 2020 2020  sp.__dict__.    
+0002fc50: 2020 2020 2020 2020 2320 6a73 6f6e 5f6d          # json_m
+0002fc60: 6178 2e75 7064 6174 6528 7b22 6b65 7922  ax.update({"key"
+0002fc70: 3a20 7661 6c75 657d 2920 2023 2061 6464  : value})  # add
+0002fc80: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
+0002fc90: 2020 2020 2020 2020 6a73 6f6e 5f20 3d20          json_ = 
+0002fca0: 6a73 6f6e 5f6d 6178 2e63 6f70 7928 290a  json_max.copy().
+0002fcb0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002fcc0: 5f2e 706f 7028 2274 7261 6e73 706f 7274  _.pop("transport
+0002fcd0: 5f72 6573 706f 6e73 6522 290a 2020 2020  _response").    
+0002fce0: 2020 2020 2020 2020 6a73 6f6e 5f73 7065          json_spe
+0002fcf0: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
+0002fd00: 2020 2020 2070 7269 6e74 5f6f 7574 7075       print_outpu
+0002fd10: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0002fd20: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
+0002fd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fd40: 2074 6578 743d 7465 7874 2c0a 2020 2020   text=text,.    
+0002fd50: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002fd60: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
+0002fd70: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+0002fd80: 783d 6a73 6f6e 5f6d 6178 2c0a 2020 2020  x=json_max,.    
+0002fd90: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0002fda0: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
+0002fdb0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0002fdc0: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
+0002fdd0: 6e5f 7365 745f 6176 6174 6172 2863 6c69  n_set_avatar(cli
+0002fde0: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
+0002fdf0: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
+0002fe00: 6963 7429 202d 3e20 4e6f 6e65 3a0a 2020  ict) -> None:.  
+0002fe10: 2020 2222 2253 6574 2061 7661 7461 7220    """Set avatar 
+0002fe20: 6f66 2069 7473 656c 6620 7768 696c 6520  of itself while 
+0002fe30: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
+0002fe40: 6e2e 2222 220a 2020 2020 7573 6572 5f69  n.""".    user_i
+0002fe50: 6420 3d20 6372 6564 656e 7469 616c 735b  d = credentials[
+0002fe60: 2275 7365 725f 6964 225d 2020 2320 7768  "user_id"]  # wh
+0002fe70: 6f61 6d69 0a20 2020 2061 7661 7461 725f  oami.    avatar_
+0002fe80: 6d78 6320 3d20 6773 2e70 612e 7365 745f  mxc = gs.pa.set_
+0002fe90: 6176 6174 6172 0a20 2020 2067 732e 6c6f  avatar.    gs.lo
+0002fea0: 672e 6465 6275 6728 6622 5365 7474 696e  g.debug(f"Settin
+0002feb0: 6720 6176 6174 6172 2066 6f72 2075 7365  g avatar for use
+0002fec0: 7220 7b75 7365 725f 6964 7d20 746f 2055  r {user_id} to U
+0002fed0: 5249 207b 6176 6174 6172 5f6d 7863 7d2e  RI {avatar_mxc}.
+0002fee0: 2229 0a20 2020 2072 6573 7020 3d20 6177  ").    resp = aw
+0002fef0: 6169 7420 636c 6965 6e74 2e73 6574 5f61  ait client.set_a
+0002ff00: 7661 7461 7228 6176 6174 6172 5f6d 7863  vatar(avatar_mxc
+0002ff10: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
+0002ff20: 6e63 6528 7265 7370 2c20 5072 6f66 696c  nce(resp, Profil
+0002ff30: 6553 6574 4176 6174 6172 5265 7370 6f6e  eSetAvatarRespon
+0002ff40: 7365 293a 0a20 2020 2020 2020 2067 732e  se):.        gs.
+0002ff50: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+0002ff60: 2020 2020 2020 2022 5072 6f66 696c 6553         "ProfileS
+0002ff70: 6574 4176 6174 6172 5265 7370 6f6e 7365  etAvatarResponse
+0002ff80: 2e20 5265 7370 6f6e 7365 2069 733a 2022  . Response is: "
+0002ff90: 0a20 2020 2020 2020 2020 2020 2066 227b  .            f"{
+0002ffa0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+0002ffb0: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+0002ffc0: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
+0002ffd0: 2e6c 6f67 2e69 6e66 6f28 0a20 2020 2020  .log.info(.     
+0002ffe0: 2020 2020 2020 2066 2253 7563 6365 7373         f"Success
+0002fff0: 6675 6c6c 7920 7365 7420 6176 6174 6172  fully set avatar
+00030000: 2066 6f72 2075 7365 7220 7b75 7365 725f   for user {user_
+00030010: 6964 7d20 220a 2020 2020 2020 2020 2020  id} ".          
+00030020: 2020 6622 746f 2055 5249 207b 6176 6174    f"to URI {avat
+00030030: 6172 5f6d 7863 7d2e 220a 2020 2020 2020  ar_mxc}.".      
+00030040: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
+00030050: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+00030060: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00030070: 2245 3139 353a 2022 0a20 2020 2020 2020  "E195: ".       
+00030080: 2020 2020 2066 2246 6169 6c65 6420 7365       f"Failed se
+00030090: 7474 696e 6720 6176 6174 6172 2066 6f72  tting avatar for
+000300a0: 2075 7365 7220 7b75 7365 725f 6964 7d20   user {user_id} 
+000300b0: 6f6e 2073 6572 7665 722e 2022 0a20 2020  on server. ".   
+000300c0: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
+000300d0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+000300e0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+000300f0: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
+00030100: 5f63 6f75 6e74 202b 3d20 310a 0a0a 6173  _count += 1...as
+00030110: 796e 6320 6465 6620 6163 7469 6f6e 5f69  ync def action_i
+00030120: 6d70 6f72 745f 6b65 7973 2863 6c69 656e  mport_keys(clien
+00030130: 743a 2041 7379 6e63 436c 6965 6e74 2c20  t: AsyncClient, 
+00030140: 6372 6564 656e 7469 616c 733a 2064 6963  credentials: dic
+00030150: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+00030160: 2222 2249 6d70 6f72 7420 4d65 676f 6c6d  """Import Megolm
+00030170: 206b 6579 7320 6672 6f6d 2066 696c 6520   keys from file 
+00030180: 7768 696c 6520 616c 7265 6164 7920 6c6f  while already lo
+00030190: 6767 6564 2069 6e2e 2222 220a 2020 2020  gged in.""".    
+000301a0: 6669 6c65 203d 2067 732e 7061 2e69 6d70  file = gs.pa.imp
+000301b0: 6f72 745f 6b65 7973 5b30 5d0a 2020 2020  ort_keys[0].    
+000301c0: 7061 7373 7068 7261 7365 203d 2067 732e  passphrase = gs.
+000301d0: 7061 2e69 6d70 6f72 745f 6b65 7973 5b31  pa.import_keys[1
+000301e0: 5d0a 2020 2020 6773 2e6c 6f67 2e64 6562  ].    gs.log.deb
+000301f0: 7567 2866 2249 6d70 6f72 7469 6e67 206b  ug(f"Importing k
+00030200: 6579 7320 6672 6f6d 2066 696c 6520 7b66  eys from file {f
+00030210: 696c 657d 2075 7369 6e67 2061 2070 6173  ile} using a pas
+00030220: 7370 6872 6173 652e 2229 0a20 2020 2072  sphrase.").    r
+00030230: 6573 7020 3d20 6177 6169 7420 636c 6965  esp = await clie
+00030240: 6e74 2e69 6d70 6f72 745f 6b65 7973 2866  nt.import_keys(f
+00030250: 696c 652c 2070 6173 7370 6872 6173 6529  ile, passphrase)
+00030260: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
+00030270: 6365 2872 6573 702c 2045 6e63 7279 7074  ce(resp, Encrypt
+00030280: 696f 6e45 7272 6f72 293a 0a20 2020 2020  ionError):.     
+00030290: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+000302a0: 0a20 2020 2020 2020 2020 2020 2022 4531  .            "E1
+000302b0: 3936 3a20 220a 2020 2020 2020 2020 2020  96: ".          
+000302c0: 2020 6622 4661 696c 6564 2074 6f20 6465    f"Failed to de
+000302d0: 6372 7970 7420 6b65 7973 2066 696c 652e  crypt keys file.
+000302e0: 2046 696c 6520 7b66 696c 657d 2069 7320   File {file} is 
+000302f0: 696e 7661 6c69 6420 6f72 2022 0a20 2020  invalid or ".   
+00030300: 2020 2020 2020 2020 2066 2263 6f75 6c64           f"could
+00030310: 6ee2 8099 7420 6265 2064 6563 7279 7074  n...t be decrypt
+00030320: 6564 2e20 7b70 7269 7661 6379 5f66 696c  ed. {privacy_fil
+00030330: 7465 7228 7374 7228 7265 7370 2929 7d22  ter(str(resp))}"
+00030340: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00030350: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00030360: 2b3d 2031 0a20 2020 2065 6c73 653a 0a20  += 1.    else:. 
+00030370: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00030380: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
+00030390: 2066 2269 6d70 6f72 745f 6b65 7973 2073   f"import_keys s
+000303a0: 7563 6365 7373 6675 6c2e 2052 6573 706f  uccessful. Respo
+000303b0: 6e73 6520 6973 3a20 7b70 7269 7661 6379  nse is: {privacy
+000303c0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+000303d0: 2929 7d22 0a20 2020 2020 2020 2029 0a20  ))}".        ). 
+000303e0: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
+000303f0: 666f 2866 2253 7563 6365 7373 6675 6c6c  fo(f"Successfull
+00030400: 7920 696d 706f 7274 6564 206b 6579 7320  y imported keys 
+00030410: 6672 6f6d 2066 696c 6520 7b66 696c 657d  from file {file}
+00030420: 2e22 290a 0a0a 6173 796e 6320 6465 6620  .")...async def 
+00030430: 6163 7469 6f6e 5f65 7870 6f72 745f 6b65  action_export_ke
+00030440: 7973 2863 6c69 656e 743a 2041 7379 6e63  ys(client: Async
+00030450: 436c 6965 6e74 2c20 6372 6564 656e 7469  Client, credenti
+00030460: 616c 733a 2064 6963 7429 202d 3e20 4e6f  als: dict) -> No
+00030470: 6e65 3a0a 2020 2020 2222 2245 7870 6f72  ne:.    """Expor
+00030480: 7420 4d65 676f 6c6d 206b 6579 7320 6672  t Megolm keys fr
+00030490: 6f6d 2066 696c 6520 7768 696c 6520 616c  om file while al
+000304a0: 7265 6164 7920 6c6f 6767 6564 2069 6e2e  ready logged in.
+000304b0: 2222 220a 2020 2020 6669 6c65 203d 2067  """.    file = g
+000304c0: 732e 7061 2e65 7870 6f72 745f 6b65 7973  s.pa.export_keys
+000304d0: 5b30 5d0a 2020 2020 7061 7373 7068 7261  [0].    passphra
+000304e0: 7365 203d 2067 732e 7061 2e65 7870 6f72  se = gs.pa.expor
+000304f0: 745f 6b65 7973 5b31 5d0a 2020 2020 6773  t_keys[1].    gs
+00030500: 2e6c 6f67 2e64 6562 7567 2866 2245 7870  .log.debug(f"Exp
+00030510: 6f72 7469 6e67 206b 6579 7320 746f 2066  orting keys to f
+00030520: 696c 6520 7b66 696c 657d 2075 7369 6e67  ile {file} using
+00030530: 2061 2070 6173 7370 6872 6173 652e 2229   a passphrase.")
+00030540: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+00030550: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
+00030560: 6c69 656e 742e 6578 706f 7274 5f6b 6579  lient.export_key
+00030570: 7328 6669 6c65 2c20 7061 7373 7068 7261  s(file, passphra
+00030580: 7365 290a 2020 2020 6578 6365 7074 2045  se).    except E
+00030590: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+000305a0: 2020 6773 2e6c 6f67 2e65 7272 6f72 2822    gs.log.error("
+000305b0: 4531 3937 3a20 2220 6622 4661 696c 6564  E197: " f"Failed
+000305c0: 2074 6f20 6578 706f 7274 206b 6579 7320   to export keys 
+000305d0: 746f 2066 696c 6520 7b66 696c 657d 2e22  to file {file}."
+000305e0: 290a 2020 2020 2020 2020 7261 6973 650a  ).        raise.
+000305f0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00030600: 280a 2020 2020 2020 2020 6622 6578 706f  (.        f"expo
+00030610: 7274 5f6b 6579 7320 7375 6363 6573 7366  rt_keys successf
+00030620: 756c 2e20 5265 7370 6f6e 7365 2069 733a  ul. Response is:
+00030630: 207b 7072 6976 6163 795f 6669 6c74 6572   {privacy_filter
+00030640: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+00030650: 2020 290a 2020 2020 6773 2e6c 6f67 2e69    ).    gs.log.i
+00030660: 6e66 6f28 6622 5375 6363 6573 7366 756c  nfo(f"Successful
+00030670: 6c79 2065 7870 6f72 7465 6420 6b65 7973  ly exported keys
+00030680: 2074 6f20 6669 6c65 207b 6669 6c65 7d2e   to file {file}.
+00030690: 2229 0a0a 0a61 7379 6e63 2064 6566 2061  ")...async def a
+000306a0: 6374 696f 6e5f 726f 6f6d 5f73 6574 5f61  ction_room_set_a
+000306b0: 6c69 6173 280a 2020 2020 636c 6965 6e74  lias(.    client
+000306c0: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
+000306d0: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
+000306e0: 0a29 202d 3e20 4e6f 6e65 3a0a 2020 2020  .) -> None:.    
+000306f0: 2222 2241 6464 2061 6c69 6173 2865 7329  """Add alias(es)
+00030700: 2074 6f20 726f 6f6d 2873 2920 7768 696c   to room(s) whil
+00030710: 6520 616c 7265 6164 7920 6c6f 6767 6564  e already logged
+00030720: 2069 6e2e 2222 220a 2020 2020 6966 206c   in.""".    if l
+00030730: 656e 2867 732e 7061 2e72 6f6f 6d5f 7365  en(gs.pa.room_se
+00030740: 745f 616c 6961 7329 203d 3d20 313a 2020  t_alias) == 1:  
+00030750: 2320 7370 6563 6961 6c20 6361 7365 0a20  # special case. 
+00030760: 2020 2020 2020 2067 732e 7061 2e72 6f6f         gs.pa.roo
+00030770: 6d5f 7365 745f 616c 6961 732e 6170 7065  m_set_alias.appe
+00030780: 6e64 2863 7265 6465 6e74 6961 6c73 5b22  nd(credentials["
+00030790: 726f 6f6d 5f69 6422 5d29 0a20 2020 2069  room_id"]).    i
+000307a0: 6620 6e6f 7420 6c65 6e28 6773 2e70 612e  f not len(gs.pa.
+000307b0: 726f 6f6d 5f73 6574 5f61 6c69 6173 2920  room_set_alias) 
+000307c0: 2520 3220 3d3d 2030 3a0a 2020 2020 2020  % 2 == 0:.      
+000307d0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+000307e0: 2020 2020 2020 2020 2020 2020 2245 3139              "E19
+000307f0: 383a 2022 0a20 2020 2020 2020 2020 2020  8: ".           
+00030800: 2022 496e 636f 7272 6563 7420 6e75 6d62   "Incorrect numb
+00030810: 6572 206f 6620 6172 6775 6d65 6e74 7320  er of arguments 
+00030820: 666f 7220 2d2d 726f 6f6d 2d73 6574 2d61  for --room-set-a
+00030830: 6c69 6173 2e20 4172 6775 6d65 6e74 7320  lias. Arguments 
+00030840: 220a 2020 2020 2020 2020 2020 2020 226d  ".            "m
+00030850: 7573 7420 6265 2070 6169 7273 2c20 692e  ust be pairs, i.
+00030860: 652e 206d 756c 7469 706c 6573 206f 6620  e. multiples of 
+00030870: 322c 2062 7574 2066 6f75 6e64 2022 0a20  2, but found ". 
+00030880: 2020 2020 2020 2020 2020 2066 227b 6c65             f"{le
+00030890: 6e28 6773 2e70 612e 726f 6f6d 5f73 6574  n(gs.pa.room_set
+000308a0: 5f61 6c69 6173 297d 2061 7267 756d 656e  _alias)} argumen
+000308b0: 7473 2e20 3120 6973 2061 6c6c 6f77 6564  ts. 1 is allowed
+000308c0: 2074 6f6f 2e22 0a20 2020 2020 2020 2029   too.".        )
+000308d0: 0a20 2020 2020 2020 2067 732e 6572 725f  .        gs.err_
+000308e0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+000308f0: 2020 2072 6574 7572 6e0a 2020 2020 666f     return.    fo
+00030900: 7220 6969 2069 6e20 7261 6e67 6528 6c65  r ii in range(le
+00030910: 6e28 6773 2e70 612e 726f 6f6d 5f73 6574  n(gs.pa.room_set
+00030920: 5f61 6c69 6173 2920 2f2f 2032 293a 0a20  _alias) // 2):. 
+00030930: 2020 2020 2020 2061 6c69 6173 203d 2067         alias = g
+00030940: 732e 7061 2e72 6f6f 6d5f 7365 745f 616c  s.pa.room_set_al
+00030950: 6961 735b 6969 202a 2032 202b 2030 5d2e  ias[ii * 2 + 0].
+00030960: 7374 7269 7028 290a 2020 2020 2020 2020  strip().        
+00030970: 726f 6f6d 5f69 6420 3d20 6773 2e70 612e  room_id = gs.pa.
+00030980: 726f 6f6d 5f73 6574 5f61 6c69 6173 5b69  room_set_alias[i
+00030990: 6920 2a20 3220 2b20 315d 0a20 2020 2020  i * 2 + 1].     
+000309a0: 2020 2072 6f6f 6d5f 6964 203d 2061 7761     room_id = awa
+000309b0: 6974 206d 6170 5f72 6f6f 6d69 6e66 6f5f  it map_roominfo_
+000309c0: 746f 5f72 6f6f 6d69 6428 636c 6965 6e74  to_roomid(client
+000309d0: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
+000309e0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+000309f0: 6622 4164 6469 6e67 2061 6c69 6173 2027  f"Adding alias '
+00030a00: 7b61 6c69 6173 7d27 2074 6f20 726f 6f6d  {alias}' to room
+00030a10: 2027 7b72 6f6f 6d5f 6964 7d27 2e22 290a   '{room_id}'.").
+00030a20: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00030a30: 735f 726f 6f6d 5f61 6c69 6173 2861 6c69  s_room_alias(ali
+00030a40: 6173 2920 616e 6420 6e6f 7420 6973 5f73  as) and not is_s
+00030a50: 686f 7274 5f72 6f6f 6d5f 616c 6961 7328  hort_room_alias(
+00030a60: 616c 6961 7329 3a0a 2020 2020 2020 2020  alias):.        
+00030a70: 2020 2020 2320 6e6f 7420 616e 2065 7868      # not an exh
+00030a80: 6175 7374 6976 6520 6368 6563 6b0a 2020  austive check.  
+00030a90: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00030aa0: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+00030ab0: 2020 2020 2020 2020 2245 3139 393a 2022          "E199: "
+00030ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030ad0: 2066 2249 6e76 616c 6964 2061 6c69 6173   f"Invalid alias
+00030ae0: 2027 7b61 6c69 6173 7d27 2e20 5468 6973   '{alias}'. This
+00030af0: 2069 7320 6e65 6974 6865 7220 6120 6675   is neither a fu
+00030b00: 6c6c 2072 6f6f 6d20 616c 6961 7320 220a  ll room alias ".
+00030b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b20: 226e 6f72 2061 2073 686f 7274 2072 6f6f  "nor a short roo
+00030b30: 6d20 616c 6961 732e 2049 7420 7368 6f75  m alias. It shou
+00030b40: 6c64 2065 6974 6865 7220 6265 2022 0a20  ld either be ". 
+00030b50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00030b60: 2723 536f 6d65 526f 6f6d 416c 6961 733a  '#SomeRoomAlias:
+00030b70: 6d61 7472 6978 2e65 7861 6d70 6c65 2e63  matrix.example.c
+00030b80: 6f6d 2720 6f72 2022 0a20 2020 2020 2020  om' or ".       
+00030b90: 2020 2020 2020 2020 2022 2723 536f 6d65           "'#Some
+00030ba0: 526f 6f6d 416c 6961 7327 206f 7220 2753  RoomAlias' or 'S
+00030bb0: 6f6d 6552 6f6f 6d41 6c69 6173 272e 220a  omeRoomAlias'.".
+00030bc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00030bd0: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00030be0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00030bf0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00030c00: 0a20 2020 2020 2020 2069 6620 223a 2220  .        if ":" 
+00030c10: 6e6f 7420 696e 2061 6c69 6173 3a0a 2020  not in alias:.  
+00030c20: 2020 2020 2020 2020 2020 2320 446f 204e            # Do N
+00030c30: 4f54 2075 7365 2073 686f 7274 5f72 6f6f  OT use short_roo
+00030c40: 6d5f 616c 6961 735f 746f 5f72 6f6f 6d5f  m_alias_to_room_
+00030c50: 616c 6961 7328 292e 0a20 2020 2020 2020  alias()..       
+00030c60: 2020 2020 2023 2057 6520 7761 6e74 2074       # We want t
+00030c70: 6869 7320 746f 2062 6520 6261 7365 6420  his to be based 
+00030c80: 6f6e 2070 726f 7669 6465 6420 726f 6f6d  on provided room
+00030c90: 5f69 6420 6e6f 7420 7468 6520 6465 6661  _id not the defa
+00030ca0: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
+00030cb0: 2320 686f 6d65 7365 7276 6572 210a 2020  # homeserver!.  
+00030cc0: 2020 2020 2020 2020 2020 6966 2061 6c69            if ali
+00030cd0: 6173 5b30 5d20 213d 2022 2322 3a0a 2020  as[0] != "#":.  
+00030ce0: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00030cf0: 6961 7320 3d20 2223 2220 2b20 616c 6961  ias = "#" + alia
+00030d00: 730a 2020 2020 2020 2020 2020 2020 616c  s.            al
+00030d10: 6961 7320 3d20 616c 6961 7320 2b20 223a  ias = alias + ":
+00030d20: 2220 2b20 726f 6f6d 5f69 642e 7370 6c69  " + room_id.spli
+00030d30: 7428 223a 2229 5b31 5d0a 2020 2020 2020  t(":")[1].      
+00030d40: 2020 7265 7370 203d 2061 7761 6974 2063    resp = await c
+00030d50: 6c69 656e 742e 726f 6f6d 5f70 7574 5f61  lient.room_put_a
+00030d60: 6c69 6173 2861 6c69 6173 2c20 726f 6f6d  lias(alias, room
+00030d70: 5f69 6429 0a20 2020 2020 2020 2069 6620  _id).        if 
+00030d80: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
+00030d90: 2052 6f6f 6d50 7574 416c 6961 7352 6573   RoomPutAliasRes
+00030da0: 706f 6e73 6529 3a0a 2020 2020 2020 2020  ponse):.        
+00030db0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00030dc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00030dd0: 2020 2272 6f6f 6d5f 7075 745f 616c 6961    "room_put_alia
+00030de0: 7320 7375 6363 6573 7366 756c 2e20 5265  s successful. Re
+00030df0: 7370 6f6e 7365 2069 733a 2022 0a20 2020  sponse is: ".   
+00030e00: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00030e10: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+00030e20: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+00030e30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00030e40: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+00030e50: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+00030e60: 2020 2066 2253 7563 6365 7373 6675 6c6c     f"Successfull
+00030e70: 7920 6164 6465 6420 616c 6961 7320 277b  y added alias '{
+00030e80: 616c 6961 737d 2720 746f 2072 6f6f 6d20  alias}' to room 
+00030e90: 277b 726f 6f6d 5f69 647d 272e 220a 2020  '{room_id}'.".  
+00030ea0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00030eb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00030ec0: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+00030ed0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00030ee0: 2020 2020 2245 3230 303a 2022 0a20 2020      "E200: ".   
+00030ef0: 2020 2020 2020 2020 2020 2020 2066 2246               f"F
+00030f00: 6169 6c65 6420 746f 2061 6464 2061 6c69  ailed to add ali
+00030f10: 6173 2027 7b61 6c69 6173 7d27 2074 6f20  as '{alias}' to 
+00030f20: 726f 6f6d 2027 7b72 6f6f 6d5f 6964 7d27  room '{room_id}'
+00030f30: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00030f40: 2020 2020 6622 7b70 7269 7661 6379 5f66      f"{privacy_f
+00030f50: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+00030f60: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+00030f70: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00030f80: 6572 725f 636f 756e 7420 2b3d 2031 0a0a  err_count += 1..
+00030f90: 0a61 7379 6e63 2064 6566 2061 6374 696f  .async def actio
+00030fa0: 6e5f 726f 6f6d 5f72 6573 6f6c 7665 5f61  n_room_resolve_a
+00030fb0: 6c69 6173 280a 2020 2020 636c 6965 6e74  lias(.    client
+00030fc0: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
+00030fd0: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
+00030fe0: 0a29 202d 3e20 4e6f 6e65 3a0a 2020 2020  .) -> None:.    
+00030ff0: 2222 2252 6573 6f6c 7665 2072 6f6f 6d20  """Resolve room 
+00031000: 616c 6961 7328 6573 2920 7768 696c 6520  alias(es) while 
+00031010: 616c 7265 6164 7920 6c6f 6767 6564 2069  already logged i
+00031020: 6e2e 2222 220a 2020 2020 666f 7220 616c  n.""".    for al
+00031030: 6961 7320 696e 2067 732e 7061 2e72 6f6f  ias in gs.pa.roo
+00031040: 6d5f 7265 736f 6c76 655f 616c 6961 733a  m_resolve_alias:
+00031050: 0a20 2020 2020 2020 2061 6c69 6173 203d  .        alias =
+00031060: 2061 6c69 6173 2e73 7472 6970 2829 0a20   alias.strip(). 
+00031070: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00031080: 6275 6728 6622 5265 736f 6c76 696e 6720  bug(f"Resolving 
+00031090: 726f 6f6d 2061 6c69 6173 2027 7b61 6c69  room alias '{ali
+000310a0: 6173 7d27 2e22 290a 2020 2020 2020 2020  as}'.").        
+000310b0: 6966 206e 6f74 2069 735f 726f 6f6d 5f61  if not is_room_a
+000310c0: 6c69 6173 2861 6c69 6173 2920 616e 6420  lias(alias) and 
+000310d0: 6e6f 7420 6973 5f73 686f 7274 5f72 6f6f  not is_short_roo
+000310e0: 6d5f 616c 6961 7328 616c 6961 7329 3a0a  m_alias(alias):.
+000310f0: 2020 2020 2020 2020 2020 2020 2320 6e6f              # no
+00031100: 7420 616e 2065 7868 6175 7374 6976 6520  t an exhaustive 
+00031110: 6368 6563 6b0a 2020 2020 2020 2020 2020  check.          
+00031120: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+00031130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031140: 2245 3230 313a 2022 0a20 2020 2020 2020  "E201: ".       
+00031150: 2020 2020 2020 2020 2066 2249 6e76 616c           f"Inval
+00031160: 6964 2061 6c69 6173 2027 7b61 6c69 6173  id alias '{alias
+00031170: 7d27 2e20 5468 6973 2069 7320 6e65 6974  }'. This is neit
+00031180: 6865 7220 6120 6675 6c6c 2072 6f6f 6d20  her a full room 
+00031190: 616c 6961 7320 220a 2020 2020 2020 2020  alias ".        
+000311a0: 2020 2020 2020 2020 226e 6f72 2061 2073          "nor a s
+000311b0: 686f 7274 2072 6f6f 6d20 616c 6961 732e  hort room alias.
+000311c0: 2049 7420 7368 6f75 6c64 2065 6974 6865   It should eithe
+000311d0: 7220 6265 2022 0a20 2020 2020 2020 2020  r be ".         
+000311e0: 2020 2020 2020 2022 2723 536f 6d65 526f         "'#SomeRo
+000311f0: 6f6d 416c 6961 733a 6d61 7472 6978 2e65  omAlias:matrix.e
+00031200: 7861 6d70 6c65 2e63 6f6d 2720 6f72 2022  xample.com' or "
+00031210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031220: 2022 2723 536f 6d65 526f 6f6d 416c 6961   "'#SomeRoomAlia
+00031230: 7327 206f 7220 2753 6f6d 6552 6f6f 6d41  s' or 'SomeRoomA
+00031240: 6c69 6173 272e 220a 2020 2020 2020 2020  lias'.".        
+00031250: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00031260: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00031270: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00031280: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00031290: 2069 6620 223a 2220 6e6f 7420 696e 2061   if ":" not in a
+000312a0: 6c69 6173 3a20 2023 2073 686f 7274 2061  lias:  # short a
+000312b0: 6c69 6173 2c20 7769 7468 6f75 7420 686f  lias, without ho
+000312c0: 6d65 7365 7276 6572 0a20 2020 2020 2020  meserver.       
+000312d0: 2020 2020 2061 6c69 6173 203d 2073 686f       alias = sho
+000312e0: 7274 5f72 6f6f 6d5f 616c 6961 735f 746f  rt_room_alias_to
+000312f0: 5f72 6f6f 6d5f 616c 6961 7328 616c 6961  _room_alias(alia
+00031300: 732c 2063 7265 6465 6e74 6961 6c73 290a  s, credentials).
+00031310: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+00031320: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
+00031330: 5f72 6573 6f6c 7665 5f61 6c69 6173 2861  _resolve_alias(a
+00031340: 6c69 6173 290a 2020 2020 2020 2020 6966  lias).        if
+00031350: 2069 7369 6e73 7461 6e63 6528 7265 7370   isinstance(resp
+00031360: 2c20 526f 6f6d 5265 736f 6c76 6541 6c69  , RoomResolveAli
+00031370: 6173 5265 7370 6f6e 7365 293a 0a20 2020  asResponse):.   
+00031380: 2020 2020 2020 2020 2067 732e 6c6f 672e           gs.log.
+00031390: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+000313a0: 2020 2020 2020 2022 726f 6f6d 5f72 6573         "room_res
+000313b0: 6f6c 7665 5f61 6c69 6173 2073 7563 6365  olve_alias succe
+000313c0: 7373 6675 6c2e 2052 6573 706f 6e73 6520  ssful. Response 
+000313d0: 6973 3a20 220a 2020 2020 2020 2020 2020  is: ".          
+000313e0: 2020 2020 2020 6622 7b70 7269 7661 6379        f"{privacy
+000313f0: 5f66 696c 7465 7228 7374 7228 7265 7370  _filter(str(resp
+00031400: 2929 7d22 0a20 2020 2020 2020 2020 2020  ))}".           
+00031410: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+00031420: 732e 6c6f 672e 696e 666f 280a 2020 2020  s.log.info(.    
+00031430: 2020 2020 2020 2020 2020 2020 6622 5375              f"Su
+00031440: 6363 6573 7366 756c 6c79 2072 6573 6f6c  ccessfully resol
+00031450: 7665 6420 726f 6f6d 2061 6c69 6173 2027  ved room alias '
+00031460: 7b61 6c69 6173 7d27 2074 6f20 220a 2020  {alias}' to ".  
+00031470: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00031480: 7b72 6573 702e 726f 6f6d 5f69 647d 2e22  {resp.room_id}."
+00031490: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000314a0: 2020 2020 2020 2020 2020 2023 206f 7574             # out
+000314b0: 7075 7420 666f 726d 6174 2063 6f6e 7472  put format contr
+000314c0: 6f6c 6c65 6420 7669 6120 2d2d 6f75 7470  olled via --outp
+000314d0: 7574 2066 6c61 670a 2020 2020 2020 2020  ut flag.        
+000314e0: 2020 2020 7465 7874 203d 2028 0a20 2020      text = (.   
+000314f0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00031500: 7265 7370 2e72 6f6f 6d5f 616c 6961 737d  resp.room_alias}
+00031510: 7b53 4550 7d7b 7265 7370 2e72 6f6f 6d5f  {SEP}{resp.room_
+00031520: 6964 7d7b 5345 507d 2220 6622 7b72 6573  id}{SEP}" f"{res
+00031530: 702e 7365 7276 6572 737d 220a 2020 2020  p.servers}".    
+00031540: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00031550: 2020 2020 2020 2320 4f62 6a65 6374 206f        # Object o
+00031560: 6620 7479 7065 2078 7878 5265 7370 6f6e  f type xxxRespon
+00031570: 7365 2069 7320 6e6f 7420 4a53 4f4e 0a20  se is not JSON. 
+00031580: 2020 2020 2020 2020 2020 2023 2073 6572             # ser
+00031590: 6961 6c69 7a61 626c 652c 2068 656e 6365  ializable, hence
+000315a0: 2077 6520 7573 6520 7468 6520 6469 6374   we use the dict
+000315b0: 696f 6e61 7279 2e0a 2020 2020 2020 2020  ionary..        
+000315c0: 2020 2020 6a73 6f6e 5f6d 6178 203d 2072      json_max = r
+000315d0: 6573 702e 5f5f 6469 6374 5f5f 0a20 2020  esp.__dict__.   
+000315e0: 2020 2020 2020 2020 2023 206a 736f 6e5f           # json_
+000315f0: 6d61 782e 7570 6461 7465 287b 226b 6579  max.update({"key
+00031600: 223a 2076 616c 7565 7d29 2020 2320 6164  ": value})  # ad
+00031610: 6420 6469 6374 2069 7465 6d73 0a20 2020  d dict items.   
+00031620: 2020 2020 2020 2020 206a 736f 6e5f 203d           json_ =
+00031630: 206a 736f 6e5f 6d61 782e 636f 7079 2829   json_max.copy()
+00031640: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00031650: 6e5f 2e70 6f70 2822 7472 616e 7370 6f72  n_.pop("transpor
+00031660: 745f 7265 7370 6f6e 7365 2229 0a20 2020  t_response").   
+00031670: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+00031680: 6563 203d 204e 6f6e 650a 2020 2020 2020  ec = None.      
+00031690: 2020 2020 2020 7072 696e 745f 6f75 7470        print_outp
+000316a0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+000316b0: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
+000316c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000316d0: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
+000316e0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+000316f0: 6e5f 3d6a 736f 6e5f 2c0a 2020 2020 2020  n_=json_,.      
+00031700: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+00031710: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
+00031720: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00031730: 6e5f 7370 6563 3d6a 736f 6e5f 7370 6563  n_spec=json_spec
+00031740: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00031750: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00031760: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00031770: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+00031780: 2020 2020 2020 2020 2245 3230 323a 2022          "E202: "
+00031790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000317a0: 2066 2246 6169 6c65 6420 746f 2072 6573   f"Failed to res
+000317b0: 6f6c 7665 2072 6f6f 6d20 616c 6961 7320  olve room alias 
+000317c0: 277b 616c 6961 737d 273a 2022 0a20 2020  '{alias}': ".   
+000317d0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+000317e0: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+000317f0: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+00031800: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00031810: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
+00031820: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+00031830: 2020 2020 2320 6f75 7470 7574 2066 6f72      # output for
+00031840: 6d61 7420 636f 6e74 726f 6c6c 6564 2076  mat controlled v
+00031850: 6961 202d 2d6f 7574 7075 7420 666c 6167  ia --output flag
+00031860: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
+00031870: 6f72 204a 534f 4e20 7468 6520 7573 6572  or JSON the user
+00031880: 2063 616e 2064 6574 6572 6d69 6e65 2077   can determine w
+00031890: 6869 6368 206f 6e65 2066 726f 6d20 7468  hich one from th
+000318a0: 6520 6c69 7374 0a20 2020 2020 2020 2020  e list.         
+000318b0: 2020 2023 2077 6173 2073 7563 6365 7373     # was success
+000318c0: 6675 6c20 616e 6420 7768 6963 6820 6f6e  ful and which on
+000318d0: 6520 6661 696c 6564 2e20 466f 7220 3420  e failed. For 4 
+000318e0: 696e 7075 7473 2074 6865 7265 0a20 2020  inputs there.   
+000318f0: 2020 2020 2020 2020 2023 206d 6967 6874           # might
+00031900: 206f 6e6c 7920 6265 2033 206f 7574 7075   only be 3 outpu
+00031910: 7420 4a53 4f4e 206f 626a 6563 7473 2069  t JSON objects i
+00031920: 6620 7468 6572 6520 7761 7320 3120 6572  f there was 1 er
+00031930: 726f 722e 0a20 2020 2020 2020 2020 2020  ror..           
+00031940: 2023 2049 6e20 7465 7874 206d 6f64 6520   # In text mode 
+00031950: 7765 2070 7269 6e74 2074 6869 7320 6572  we print this er
+00031960: 726f 7220 6c69 6e65 2c20 736f 2074 6861  ror line, so tha
+00031970: 7420 666f 7220 3420 696e 7075 7473 0a20  t for 4 inputs. 
+00031980: 2020 2020 2020 2020 2020 2023 2074 6865             # the
+00031990: 7265 2077 696c 6c20 6265 2034 206f 7574  re will be 4 out
+000319a0: 7075 7420 6c69 6e65 732e 0a20 2020 2020  put lines..     
+000319b0: 2020 2020 2020 2070 7269 6e74 5f6f 7574         print_out
+000319c0: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
+000319d0: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
+000319e0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000319f0: 2020 2074 6578 743d 2866 227b 616c 6961     text=(f"{alia
+00031a00: 737d 7b53 4550 7d45 7272 6f72 7b53 4550  s}{SEP}Error{SEP
+00031a10: 7d5b 5d22 292c 0a20 2020 2020 2020 2020  }[]"),.         
+00031a20: 2020 2020 2020 206a 736f 6e5f 3d4e 6f6e         json_=Non
+00031a30: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00031a40: 2020 206a 736f 6e5f 6d61 783d 4e6f 6e65     json_max=None
+00031a50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00031a60: 2020 6a73 6f6e 5f73 7065 633d 4e6f 6e65    json_spec=None
+00031a70: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00031a80: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
+00031a90: 6f6e 5f72 6f6f 6d5f 6465 6c65 7465 5f61  on_room_delete_a
+00031aa0: 6c69 6173 280a 2020 2020 636c 6965 6e74  lias(.    client
+00031ab0: 3a20 4173 796e 6343 6c69 656e 742c 2063  : AsyncClient, c
+00031ac0: 7265 6465 6e74 6961 6c73 3a20 6469 6374  redentials: dict
+00031ad0: 0a29 202d 3e20 4e6f 6e65 3a0a 2020 2020  .) -> None:.    
+00031ae0: 2222 2244 656c 6574 6520 726f 6f6d 2061  """Delete room a
+00031af0: 6c69 6173 2865 7329 2077 6869 6c65 2061  lias(es) while a
+00031b00: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+00031b10: 2e22 2222 0a20 2020 2066 6f72 2061 6c69  .""".    for ali
+00031b20: 6173 2069 6e20 6773 2e70 612e 726f 6f6d  as in gs.pa.room
+00031b30: 5f64 656c 6574 655f 616c 6961 733a 0a20  _delete_alias:. 
+00031b40: 2020 2020 2020 2061 6c69 6173 203d 2061         alias = a
+00031b50: 6c69 6173 2e73 7472 6970 2829 0a20 2020  lias.strip().   
+00031b60: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00031b70: 6728 6622 4465 6c65 7469 6e67 2072 6f6f  g(f"Deleting roo
+00031b80: 6d20 616c 6961 7320 277b 616c 6961 737d  m alias '{alias}
+00031b90: 272e 2229 0a20 2020 2020 2020 2069 6620  '.").        if 
+00031ba0: 6e6f 7420 6973 5f72 6f6f 6d5f 616c 6961  not is_room_alia
+00031bb0: 7328 616c 6961 7329 2061 6e64 206e 6f74  s(alias) and not
+00031bc0: 2069 735f 7368 6f72 745f 726f 6f6d 5f61   is_short_room_a
+00031bd0: 6c69 6173 2861 6c69 6173 293a 0a20 2020  lias(alias):.   
+00031be0: 2020 2020 2020 2020 2023 206e 6f74 2061           # not a
+00031bf0: 6e20 6578 6861 7573 7469 7665 2063 6865  n exhaustive che
+00031c00: 636b 0a20 2020 2020 2020 2020 2020 2067  ck.            g
+00031c10: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+00031c20: 2020 2020 2020 2020 2020 2020 2022 4532               "E2
+00031c30: 3033 3a20 220a 2020 2020 2020 2020 2020  03: ".          
+00031c40: 2020 2020 2020 6622 496e 7661 6c69 6420        f"Invalid 
+00031c50: 616c 6961 7320 277b 616c 6961 737d 272e  alias '{alias}'.
+00031c60: 2054 6869 7320 6973 206e 6569 7468 6572   This is neither
+00031c70: 2061 2066 756c 6c20 726f 6f6d 2061 6c69   a full room ali
+00031c80: 6173 2022 0a20 2020 2020 2020 2020 2020  as ".           
+00031c90: 2020 2020 2022 6e6f 7220 6120 7368 6f72       "nor a shor
+00031ca0: 7420 726f 6f6d 2061 6c69 6173 2e20 4974  t room alias. It
+00031cb0: 2073 686f 756c 6420 6569 7468 6572 2062   should either b
+00031cc0: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+00031cd0: 2020 2020 2227 2353 6f6d 6552 6f6f 6d41      "'#SomeRoomA
+00031ce0: 6c69 6173 3a6d 6174 7269 782e 6578 616d  lias:matrix.exam
+00031cf0: 706c 652e 636f 6d27 206f 7220 2753 6f6d  ple.com' or 'Som
+00031d00: 6552 6f6f 6d41 6c69 6173 272e 220a 2020  eRoomAlias'.".  
+00031d10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00031d20: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+00031d30: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+00031d40: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00031d50: 2020 2020 2020 2069 6620 223a 2220 6e6f         if ":" no
+00031d60: 7420 696e 2061 6c69 6173 3a20 2023 2073  t in alias:  # s
+00031d70: 686f 7274 2061 6c69 6173 2c20 7769 7468  hort alias, with
+00031d80: 6f75 7420 686f 6d65 7365 7276 6572 0a20  out homeserver. 
+00031d90: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
+00031da0: 203d 2073 686f 7274 5f72 6f6f 6d5f 616c   = short_room_al
+00031db0: 6961 735f 746f 5f72 6f6f 6d5f 616c 6961  ias_to_room_alia
+00031dc0: 7328 616c 6961 732c 2063 7265 6465 6e74  s(alias, credent
+00031dd0: 6961 6c73 290a 2020 2020 2020 2020 7265  ials).        re
+00031de0: 7370 203d 2061 7761 6974 2063 6c69 656e  sp = await clien
+00031df0: 742e 726f 6f6d 5f64 656c 6574 655f 616c  t.room_delete_al
+00031e00: 6961 7328 616c 6961 7329 0a20 2020 2020  ias(alias).     
+00031e10: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00031e20: 2872 6573 702c 2052 6f6f 6d44 656c 6574  (resp, RoomDelet
+00031e30: 6541 6c69 6173 5265 7370 6f6e 7365 293a  eAliasResponse):
+00031e40: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00031e50: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+00031e60: 2020 2020 2020 2020 2020 2022 726f 6f6d             "room
+00031e70: 5f64 656c 6574 655f 616c 6961 7320 7375  _delete_alias su
+00031e80: 6363 6573 7366 756c 2e20 5265 7370 6f6e  ccessful. Respon
+00031e90: 7365 2069 733a 2022 0a20 2020 2020 2020  se is: ".       
+00031ea0: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
+00031eb0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+00031ec0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+00031ed0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00031ee0: 2020 6773 2e6c 6f67 2e69 6e66 6f28 6622    gs.log.info(f"
+00031ef0: 5375 6363 6573 7366 756c 6c79 2064 656c  Successfully del
+00031f00: 6574 6564 2072 6f6f 6d20 616c 6961 7320  eted room alias 
+00031f10: 277b 616c 6961 737d 272e 2229 0a20 2020  '{alias}'.").   
+00031f20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00031f30: 2020 2020 2020 2067 732e 6c6f 672e 6572         gs.log.er
+00031f40: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00031f50: 2020 2020 2022 4532 3034 3a20 220a 2020       "E204: ".  
+00031f60: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00031f70: 4661 696c 6564 2074 6f20 6465 6c65 7465  Failed to delete
+00031f80: 2072 6f6f 6d20 616c 6961 7320 277b 616c   room alias '{al
+00031f90: 6961 737d 273a 2022 0a20 2020 2020 2020  ias}': ".       
+00031fa0: 2020 2020 2020 2020 2066 227b 7072 6976           f"{priv
+00031fb0: 6163 795f 6669 6c74 6572 2873 7472 2872  acy_filter(str(r
+00031fc0: 6573 7029 297d 220a 2020 2020 2020 2020  esp))}".        
+00031fd0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00031fe0: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00031ff0: 3d20 310a 0a0a 6173 796e 6320 6465 6620  = 1...async def 
+00032000: 6163 7469 6f6e 5f67 6574 5f6f 7065 6e69  action_get_openi
+00032010: 645f 746f 6b65 6e28 0a20 2020 2063 6c69  d_token(.    cli
+00032020: 656e 743a 2041 7379 6e63 436c 6965 6e74  ent: AsyncClient
+00032030: 2c20 6372 6564 656e 7469 616c 733a 2064  , credentials: d
+00032040: 6963 740a 2920 2d3e 204e 6f6e 653a 0a20  ict.) -> None:. 
+00032050: 2020 2022 2222 4765 7420 4f70 656e 4964     """Get OpenId
+00032060: 2074 6f6b 656e 2873 2920 666f 7220 6974   token(s) for it
+00032070: 7365 6c66 206f 7220 7573 6572 7320 7768  self or users wh
+00032080: 696c 6520 616c 7265 6164 7920 6c6f 6767  ile already logg
+00032090: 6564 2069 6e2e 2222 220a 2020 2020 6966  ed in.""".    if
+000320a0: 206e 6f74 2048 4156 455f 4f50 454e 4944   not HAVE_OPENID
+000320b0: 3a0a 2020 2020 2020 2020 6e69 6f5f 7665  :.        nio_ve
+000320c0: 7273 696f 6e20 3d20 706b 675f 7265 736f  rsion = pkg_reso
+000320d0: 7572 6365 732e 6765 745f 6469 7374 7269  urces.get_distri
+000320e0: 6275 7469 6f6e 2822 6d61 7472 6978 2d6e  bution("matrix-n
+000320f0: 696f 2229 2e76 6572 7369 6f6e 0a20 2020  io").version.   
+00032100: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00032110: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+00032120: 4532 3035 3a20 220a 2020 2020 2020 2020  E205: ".        
+00032130: 2020 2020 6622 596f 7520 6172 6520 7275      f"You are ru
+00032140: 6e6e 696e 6720 6d61 7472 6978 2d6e 696f  nning matrix-nio
+00032150: 2076 6572 7369 6f6e 207b 6e69 6f5f 7665   version {nio_ve
+00032160: 7273 696f 6e7d 2e20 220a 2020 2020 2020  rsion}. ".      
+00032170: 2020 2020 2020 6622 5468 6973 2066 6561        f"This fea
+00032180: 7475 7265 2069 7320 6f6e 6c79 2061 7661  ture is only ava
+00032190: 696c 6162 6c65 206f 6e20 7665 7273 696f  ilable on versio
+000321a0: 6e73 206c 6172 6765 7220 7468 616e 2030  ns larger than 0
+000321b0: 2e31 392e 302e 2022 0a20 2020 2020 2020  .19.0. ".       
+000321c0: 2020 2020 2022 5570 6461 7465 2069 6620       "Update if 
+000321d0: 6e65 6365 7373 6172 792e 2022 0a20 2020  necessary. ".   
+000321e0: 2020 2020 2020 2020 2022 5761 6974 2066           "Wait f
+000321f0: 6f72 2076 6572 7369 6f6e 2030 2e31 392e  or version 0.19.
+00032200: 3120 6f72 2030 2e32 3020 746f 2062 6520  1 or 0.20 to be 
+00032210: 7265 6c65 6173 6564 2e20 220a 2020 2020  released. ".    
+00032220: 2020 2020 2020 2020 224f 7220 7573 6520          "Or use 
+00032230: 756e 7265 6c65 6173 6564 2063 6f64 6520  unreleased code 
+00032240: 6672 6f6d 206d 6173 7465 7220 6272 616e  from master bran
+00032250: 6368 206f 6e20 4769 7468 7562 2e22 0a20  ch on Github.". 
+00032260: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00032270: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+00032280: 2031 0a20 2020 2020 2020 2072 6574 7572   1.        retur
+00032290: 6e0a 2020 2020 6966 2067 732e 7061 2e67  n.    if gs.pa.g
+000322a0: 6574 5f6f 7065 6e69 645f 746f 6b65 6e20  et_openid_token 
+000322b0: 3d3d 205b 5d3a 0a20 2020 2020 2020 2067  == []:.        g
+000322c0: 732e 7061 2e67 6574 5f6f 7065 6e69 645f  s.pa.get_openid_
+000322d0: 746f 6b65 6e2e 6170 7065 6e64 2863 7265  token.append(cre
+000322e0: 6465 6e74 6961 6c73 5b22 7573 6572 5f69  dentials["user_i
+000322f0: 6422 5d29 2020 2320 7768 6f61 6d69 0a20  d"])  # whoami. 
+00032300: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00032310: 6622 4765 7474 696e 6720 4f70 656e 4944  f"Getting OpenID
+00032320: 7320 666f 7220 7468 6573 6520 7573 6572  s for these user
+00032330: 733a 207b 6773 2e70 612e 6765 745f 6f70  s: {gs.pa.get_op
+00032340: 656e 6964 5f74 6f6b 656e 7d22 290a 2020  enid_token}").  
+00032350: 2020 666f 7220 7573 6572 5f69 6420 696e    for user_id in
+00032360: 2067 732e 7061 2e67 6574 5f6f 7065 6e69   gs.pa.get_openi
+00032370: 645f 746f 6b65 6e3a 0a20 2020 2020 2020  d_token:.       
+00032380: 2075 7365 725f 6964 203d 2075 7365 725f   user_id = user_
+00032390: 6964 2e73 7472 6970 2829 0a20 2020 2020  id.strip().     
+000323a0: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+000323b0: 636c 6965 6e74 2e67 6574 5f6f 7065 6e69  client.get_openi
+000323c0: 645f 746f 6b65 6e28 7573 6572 5f69 6429  d_token(user_id)
+000323d0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+000323e0: 7374 616e 6365 2872 6573 702c 2047 6574  stance(resp, Get
+000323f0: 4f70 656e 4944 546f 6b65 6e45 7272 6f72  OpenIDTokenError
+00032400: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
+00032410: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+00032420: 2020 2020 2020 2020 2020 2020 2022 4532               "E2
+00032430: 3036 3a20 220a 2020 2020 2020 2020 2020  06: ".          
+00032440: 2020 2020 2020 6622 4661 696c 6564 2074        f"Failed t
+00032450: 6f20 6765 7420 4f70 656e 4964 2066 6f72  o get OpenId for
+00032460: 2075 7365 7220 7b75 7365 725f 6964 7d2e   user {user_id}.
+00032470: 2052 6573 706f 6e73 653a 2022 0a20 2020   Response: ".   
+00032480: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00032490: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+000324a0: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+000324b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000324c0: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
+000324d0: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+000324e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000324f0: 2020 6773 2e6c 6f67 2e64 6562 7567 280a    gs.log.debug(.
+00032500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032510: 2267 6574 5f6f 7065 6e69 645f 746f 6b65  "get_openid_toke
+00032520: 6e20 7375 6363 6573 7366 756c 2e20 5265  n successful. Re
+00032530: 7370 6f6e 7365 2069 733a 2022 0a20 2020  sponse is: ".   
+00032540: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00032550: 7072 6976 6163 795f 6669 6c74 6572 2873  privacy_filter(s
+00032560: 7472 2872 6573 7029 297d 220a 2020 2020  tr(resp))}".    
+00032570: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00032580: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+00032590: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+000325a0: 2020 2066 2253 7563 6365 7373 6675 6c6c     f"Successfull
+000325b0: 7920 6f62 7461 696e 6564 204f 7065 6e49  y obtained OpenI
+000325c0: 6420 746f 6b65 6e20 220a 2020 2020 2020  d token ".      
+000325d0: 2020 2020 2020 2020 2020 6622 7b72 6573            f"{res
+000325e0: 702e 6163 6365 7373 5f74 6f6b 656e 7d20  p.access_token} 
+000325f0: 666f 7220 7573 6572 207b 7573 6572 5f69  for user {user_i
+00032600: 647d 2e22 0a20 2020 2020 2020 2020 2020  d}.".           
+00032610: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
+00032620: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
+00032630: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
+00032640: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
+00032650: 2020 2020 2020 2020 7465 7874 203d 2028          text = (
+00032660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032670: 2066 227b 7573 6572 5f69 647d 7b53 4550   f"{user_id}{SEP
+00032680: 7d7b 7265 7370 2e61 6363 6573 735f 746f  }{resp.access_to
+00032690: 6b65 6e7d 7b53 4550 7d7b 7265 7370 2e65  ken}{SEP}{resp.e
+000326a0: 7870 6972 6573 5f69 6e7d 220a 2020 2020  xpires_in}".    
+000326b0: 2020 2020 2020 2020 2020 2020 6622 7b53              f"{S
+000326c0: 4550 7d7b 7265 7370 2e6d 6174 7269 785f  EP}{resp.matrix_
+000326d0: 7365 7276 6572 5f6e 616d 657d 7b53 4550  server_name}{SEP
+000326e0: 7d7b 7265 7370 2e74 6f6b 656e 5f74 7970  }{resp.token_typ
+000326f0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
+00032700: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00032710: 4f62 6a65 6374 206f 6620 7479 7065 2078  Object of type x
+00032720: 7878 5265 7370 6f6e 7365 2069 7320 6e6f  xxResponse is no
+00032730: 7420 4a53 4f4e 0a20 2020 2020 2020 2020  t JSON.         
+00032740: 2020 2023 2073 6572 6961 6c69 7a61 626c     # serializabl
+00032750: 652c 2068 656e 6365 2077 6520 7573 6520  e, hence we use 
+00032760: 7468 6520 6469 6374 696f 6e61 7279 2e0a  the dictionary..
+00032770: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+00032780: 5f6d 6178 203d 2072 6573 702e 5f5f 6469  _max = resp.__di
+00032790: 6374 5f5f 0a20 2020 2020 2020 2020 2020  ct__.           
+000327a0: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
+000327b0: 287b 2275 7365 725f 6964 223a 2075 7365  ({"user_id": use
+000327c0: 725f 6964 7d29 2020 2320 6164 6420 6469  r_id})  # add di
+000327d0: 6374 2069 7465 6d73 0a20 2020 2020 2020  ct items.       
+000327e0: 2020 2020 206a 736f 6e5f 203d 206a 736f       json_ = jso
+000327f0: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
+00032800: 2020 2020 2020 2020 206a 736f 6e5f 2e70           json_.p
+00032810: 6f70 2822 7472 616e 7370 6f72 745f 7265  op("transport_re
+00032820: 7370 6f6e 7365 2229 0a20 2020 2020 2020  sponse").       
+00032830: 2020 2020 206a 736f 6e5f 7370 6563 203d       json_spec =
+00032840: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00032850: 2020 7072 696e 745f 6f75 7470 7574 280a    print_output(.
+00032860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032870: 6773 2e70 612e 6f75 7470 7574 2c0a 2020  gs.pa.output,.  
+00032880: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00032890: 7874 3d74 6578 742c 0a20 2020 2020 2020  xt=text,.       
+000328a0: 2020 2020 2020 2020 206a 736f 6e5f 3d6a           json_=j
+000328b0: 736f 6e5f 2c0a 2020 2020 2020 2020 2020  son_,.          
+000328c0: 2020 2020 2020 6a73 6f6e 5f6d 6178 3d6a        json_max=j
+000328d0: 736f 6e5f 6d61 782c 0a20 2020 2020 2020  son_max,.       
+000328e0: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+000328f0: 6563 3d6a 736f 6e5f 7370 6563 2c0a 2020  ec=json_spec,.  
+00032900: 2020 2020 2020 2020 2020 290a 0a0a 6173            )...as
+00032910: 796e 6320 6465 6620 6163 7469 6f6e 5f72  ync def action_r
+00032920: 6f6f 6d5f 6765 745f 7669 7369 6269 6c69  oom_get_visibili
+00032930: 7479 280a 2020 2020 636c 6965 6e74 3a20  ty(.    client: 
+00032940: 4173 796e 6343 6c69 656e 742c 2063 7265  AsyncClient, cre
+00032950: 6465 6e74 6961 6c73 3a20 6469 6374 0a29  dentials: dict.)
+00032960: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00032970: 2247 6574 2076 6973 6962 696c 6974 7920  "Get visibility 
+00032980: 6f66 2072 6f6f 6d28 7329 2077 6869 6c65  of room(s) while
+00032990: 2061 6c72 6561 6479 206c 6f67 6765 6420   already logged 
+000329a0: 696e 2e22 2222 0a20 2020 2069 6620 6773  in.""".    if gs
+000329b0: 2e70 612e 726f 6f6d 5f67 6574 5f76 6973  .pa.room_get_vis
+000329c0: 6962 696c 6974 7920 3d3d 205b 5d3a 0a20  ibility == []:. 
+000329d0: 2020 2020 2020 2067 732e 7061 2e72 6f6f         gs.pa.roo
+000329e0: 6d5f 6765 745f 7669 7369 6269 6c69 7479  m_get_visibility
+000329f0: 2e61 7070 656e 6428 6372 6564 656e 7469  .append(credenti
+00032a00: 616c 735b 2272 6f6f 6d5f 6964 225d 2920  als["room_id"]) 
+00032a10: 2023 2064 6566 2e20 726f 6f6d 0a20 2020   # def. room.   
+00032a20: 2066 6f72 2072 6f6f 6d5f 6964 2069 6e20   for room_id in 
+00032a30: 6773 2e70 612e 726f 6f6d 5f67 6574 5f76  gs.pa.room_get_v
+00032a40: 6973 6962 696c 6974 793a 0a20 2020 2020  isibility:.     
+00032a50: 2020 2072 6f6f 6d5f 6964 203d 2061 7761     room_id = awa
+00032a60: 6974 206d 6170 5f72 6f6f 6d69 6e66 6f5f  it map_roominfo_
+00032a70: 746f 5f72 6f6f 6d69 6428 636c 6965 6e74  to_roomid(client
+00032a80: 2c20 726f 6f6d 5f69 6429 0a20 2020 2020  , room_id).     
+00032a90: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00032aa0: 6622 4765 7474 696e 6720 7669 7369 6269  f"Getting visibi
+00032ab0: 6c69 7479 2066 6f72 2072 6f6f 6d20 7b72  lity for room {r
+00032ac0: 6f6f 6d5f 6964 7d2e 2229 0a20 2020 2020  oom_id}.").     
+00032ad0: 2020 2072 6573 7020 3d20 6177 6169 7420     resp = await 
+00032ae0: 636c 6965 6e74 2e72 6f6f 6d5f 6765 745f  client.room_get_
+00032af0: 7669 7369 6269 6c69 7479 2872 6f6f 6d5f  visibility(room_
+00032b00: 6964 290a 2020 2020 2020 2020 6966 2069  id).        if i
+00032b10: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
+00032b20: 526f 6f6d 4765 7456 6973 6962 696c 6974  RoomGetVisibilit
+00032b30: 7952 6573 706f 6e73 6529 3a0a 2020 2020  yResponse):.    
+00032b40: 2020 2020 2020 2020 6773 2e6c 6f67 2e69          gs.log.i
+00032b50: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+00032b60: 2020 2020 2066 2253 7563 6365 7373 6675       f"Successfu
+00032b70: 6c6c 7920 676f 7420 7669 7369 6269 6c69  lly got visibili
+00032b80: 7479 2066 6f72 2072 6f6f 6d20 7b72 6573  ty for room {res
+00032b90: 702e 726f 6f6d 5f69 647d 3a20 220a 2020  p.room_id}: ".  
+00032ba0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00032bb0: 7b72 6573 702e 7669 7369 6269 6c69 7479  {resp.visibility
+00032bc0: 7d2e 220a 2020 2020 2020 2020 2020 2020  }.".            
+00032bd0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00032be0: 6f75 7470 7574 2066 6f72 6d61 7420 636f  output format co
+00032bf0: 6e74 726f 6c6c 6564 2076 6961 202d 2d6f  ntrolled via --o
+00032c00: 7574 7075 7420 666c 6167 0a20 2020 2020  utput flag.     
+00032c10: 2020 2020 2020 2074 6578 7420 3d20 6622         text = f"
+00032c20: 7b72 6573 702e 7669 7369 6269 6c69 7479  {resp.visibility
+00032c30: 7d7b 5345 507d 7b72 6f6f 6d5f 6964 7d22  }{SEP}{room_id}"
+00032c40: 0a20 2020 2020 2020 2020 2020 2023 204f  .            # O
+00032c50: 626a 6563 7420 6f66 2074 7970 6520 7878  bject of type xx
+00032c60: 7852 6573 706f 6e73 6520 6973 206e 6f74  xResponse is not
+00032c70: 204a 534f 4e0a 2020 2020 2020 2020 2020   JSON.          
+00032c80: 2020 2320 7365 7269 616c 697a 6162 6c65    # serializable
+00032c90: 2c20 6865 6e63 6520 7765 2075 7365 2074  , hence we use t
+00032ca0: 6865 2064 6963 7469 6f6e 6172 792e 0a20  he dictionary.. 
+00032cb0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+00032cc0: 6d61 7820 3d20 7265 7370 2e5f 5f64 6963  max = resp.__dic
+00032cd0: 745f 5f0a 2020 2020 2020 2020 2020 2020  t__.            
+00032ce0: 2320 6a73 6f6e 5f6d 6178 2e75 7064 6174  # json_max.updat
+00032cf0: 6528 7b22 6b65 7922 3a20 7661 6c75 657d  e({"key": value}
+00032d00: 2920 2023 2061 6464 2064 6963 7420 6974  )  # add dict it
+00032d10: 656d 730a 2020 2020 2020 2020 2020 2020  ems.            
+00032d20: 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178  json_ = json_max
+00032d30: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+00032d40: 2020 2020 6a73 6f6e 5f2e 706f 7028 2274      json_.pop("t
+00032d50: 7261 6e73 706f 7274 5f72 6573 706f 6e73  ransport_respons
+00032d60: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+00032d70: 6a73 6f6e 5f73 7065 6320 3d20 4e6f 6e65  json_spec = None
+00032d80: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00032d90: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
+00032da0: 2020 2020 2020 2020 2020 2067 732e 7061             gs.pa
+00032db0: 2e6f 7574 7075 742c 0a20 2020 2020 2020  .output,.       
+00032dc0: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+00032dd0: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+00032de0: 2020 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c      json_=json_,
+00032df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032e00: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
+00032e10: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
+00032e20: 2020 2020 6a73 6f6e 5f73 7065 633d 6a73      json_spec=js
+00032e30: 6f6e 5f73 7065 632c 0a20 2020 2020 2020  on_spec,.       
+00032e40: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00032e50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00032e60: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00032e70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00032e80: 4532 3037 3a20 220a 2020 2020 2020 2020  E207: ".        
+00032e90: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
+00032ea0: 2067 6574 7469 6e67 2076 6973 6962 696c   getting visibil
+00032eb0: 6974 7920 666f 7220 726f 6f6d 207b 726f  ity for room {ro
+00032ec0: 6f6d 5f69 647d 2e20 220a 2020 2020 2020  om_id}. ".      
+00032ed0: 2020 2020 2020 2020 2020 6622 7b70 7269            f"{pri
+00032ee0: 7661 6379 5f66 696c 7465 7228 7374 7228  vacy_filter(str(
+00032ef0: 7265 7370 2929 7d22 0a20 2020 2020 2020  resp))}".       
+00032f00: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00032f10: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00032f20: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00032f30: 2065 7272 6d73 6720 3d20 2245 7272 6f72   errmsg = "Error
+00032f40: 3a20 2220 2b20 7374 7228 7265 7370 2e73  : " + str(resp.s
+00032f50: 7461 7475 735f 636f 6465 2920 2b20 2220  tatus_code) + " 
+00032f60: 2220 2b20 7265 7370 2e6d 6573 7361 6765  " + resp.message
+00032f70: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+00032f80: 7574 7075 7420 666f 726d 6174 2063 6f6e  utput format con
+00032f90: 7472 6f6c 6c65 6420 7669 6120 2d2d 6f75  trolled via --ou
+00032fa0: 7470 7574 2066 6c61 670a 2020 2020 2020  tput flag.      
+00032fb0: 2020 2020 2020 2320 666f 7220 4a53 4f4e        # for JSON
+00032fc0: 2074 6865 2075 7365 7220 6361 6e20 6465   the user can de
+00032fd0: 7465 726d 696e 6520 7768 6963 6820 6f6e  termine which on
+00032fe0: 6520 6672 6f6d 2074 6865 206c 6973 740a  e from the list.
+00032ff0: 2020 2020 2020 2020 2020 2020 2320 7761              # wa
+00033000: 7320 7375 6363 6573 7366 756c 2061 6e64  s successful and
+00033010: 2077 6869 6368 206f 6e65 2066 6169 6c65   which one faile
+00033020: 642e 2046 6f72 2034 2069 6e70 7574 7320  d. For 4 inputs 
+00033030: 7468 6572 650a 2020 2020 2020 2020 2020  there.          
+00033040: 2020 2320 6d69 6768 7420 6f6e 6c79 2062    # might only b
+00033050: 6520 3320 6f75 7470 7574 204a 534f 4e20  e 3 output JSON 
+00033060: 6f62 6a65 6374 7320 6966 2074 6865 7265  objects if there
+00033070: 2077 6173 2031 2065 7272 6f72 2e0a 2020   was 1 error..  
+00033080: 2020 2020 2020 2020 2020 2320 496e 2074            # In t
+00033090: 6578 7420 6d6f 6465 2077 6520 7072 696e  ext mode we prin
+000330a0: 7420 7468 6973 2065 7272 6f72 206c 696e  t this error lin
+000330b0: 652c 2073 6f20 7468 6174 2066 6f72 2034  e, so that for 4
+000330c0: 2069 6e70 7574 730a 2020 2020 2020 2020   inputs.        
+000330d0: 2020 2020 2320 7468 6572 6520 7769 6c6c      # there will
+000330e0: 2062 6520 3420 6f75 7470 7574 206c 696e   be 4 output lin
+000330f0: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
+00033100: 7072 696e 745f 6f75 7470 7574 280a 2020  print_output(.  
+00033110: 2020 2020 2020 2020 2020 2020 2020 6773                gs
+00033120: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
+00033130: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00033140: 3d28 6622 7b65 7272 6d73 677d 7b53 4550  =(f"{errmsg}{SEP
+00033150: 7d7b 726f 6f6d 5f69 647d 2229 2c0a 2020  }{room_id}"),.  
+00033160: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+00033170: 6f6e 5f3d 4e6f 6e65 2c0a 2020 2020 2020  on_=None,.      
+00033180: 2020 2020 2020 2020 2020 6a73 6f6e 5f6d            json_m
+00033190: 6178 3d4e 6f6e 652c 0a20 2020 2020 2020  ax=None,.       
+000331a0: 2020 2020 2020 2020 206a 736f 6e5f 7370           json_sp
+000331b0: 6563 3d4e 6f6e 652c 0a20 2020 2020 2020  ec=None,.       
+000331c0: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
+000331d0: 6566 2061 6374 696f 6e5f 726f 6f6d 5f67  ef action_room_g
+000331e0: 6574 5f73 7461 7465 280a 2020 2020 636c  et_state(.    cl
+000331f0: 6965 6e74 3a20 4173 796e 6343 6c69 656e  ient: AsyncClien
+00033200: 742c 2063 7265 6465 6e74 6961 6c73 3a20  t, credentials: 
+00033210: 6469 6374 0a29 202d 3e20 4e6f 6e65 3a0a  dict.) -> None:.
+00033220: 2020 2020 2222 2247 6574 2073 7461 7465      """Get state
+00033230: 206f 6620 726f 6f6d 2873 2920 7768 696c   of room(s) whil
+00033240: 6520 616c 7265 6164 7920 6c6f 6767 6564  e already logged
+00033250: 2069 6e2e 2222 220a 2020 2020 6966 2067   in.""".    if g
+00033260: 732e 7061 2e72 6f6f 6d5f 6765 745f 7374  s.pa.room_get_st
+00033270: 6174 6520 3d3d 205b 5d3a 0a20 2020 2020  ate == []:.     
+00033280: 2020 2067 732e 7061 2e72 6f6f 6d5f 6765     gs.pa.room_ge
+00033290: 745f 7374 6174 652e 6170 7065 6e64 2863  t_state.append(c
+000332a0: 7265 6465 6e74 6961 6c73 5b22 726f 6f6d  redentials["room
+000332b0: 5f69 6422 5d29 2020 2320 6465 6661 756c  _id"])  # defaul
+000332c0: 7420 726f 6f6d 0a20 2020 2066 6f72 2072  t room.    for r
+000332d0: 6f6f 6d5f 6964 2069 6e20 6773 2e70 612e  oom_id in gs.pa.
+000332e0: 726f 6f6d 5f67 6574 5f73 7461 7465 3a0a  room_get_state:.
+000332f0: 2020 2020 2020 2020 726f 6f6d 5f69 6420          room_id 
+00033300: 3d20 6177 6169 7420 6d61 705f 726f 6f6d  = await map_room
+00033310: 696e 666f 5f74 6f5f 726f 6f6d 6964 2863  info_to_roomid(c
+00033320: 6c69 656e 742c 2072 6f6f 6d5f 6964 290a  lient, room_id).
+00033330: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
+00033340: 6562 7567 2866 2247 6574 7469 6e67 2076  ebug(f"Getting v
+00033350: 6973 6962 696c 6974 7920 666f 7220 726f  isibility for ro
+00033360: 6f6d 207b 726f 6f6d 5f69 647d 2e22 290a  om {room_id}.").
+00033370: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+00033380: 7761 6974 2063 6c69 656e 742e 726f 6f6d  wait client.room
+00033390: 5f67 6574 5f73 7461 7465 2872 6f6f 6d5f  _get_state(room_
+000333a0: 6964 290a 2020 2020 2020 2020 6966 2069  id).        if i
+000333b0: 7369 6e73 7461 6e63 6528 7265 7370 2c20  sinstance(resp, 
+000333c0: 526f 6f6d 4765 7453 7461 7465 5265 7370  RoomGetStateResp
+000333d0: 6f6e 7365 293a 0a20 2020 2020 2020 2020  onse):.         
+000333e0: 2020 2067 732e 6c6f 672e 696e 666f 280a     gs.log.info(.
+000333f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033400: 6622 5375 6363 6573 7366 756c 6c79 2067  f"Successfully g
+00033410: 6f74 2073 7461 7465 2066 6f72 2072 6f6f  ot state for roo
+00033420: 6d20 7b72 6573 702e 726f 6f6d 5f69 647d  m {resp.room_id}
+00033430: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00033440: 2020 2020 6622 7b72 6573 702e 6576 656e      f"{resp.even
+00033450: 7473 7d2e 220a 2020 2020 2020 2020 2020  ts}.".          
+00033460: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00033470: 2320 6f75 7470 7574 2066 6f72 6d61 7420  # output format 
+00033480: 636f 6e74 726f 6c6c 6564 2076 6961 202d  controlled via -
+00033490: 2d6f 7574 7075 7420 666c 6167 0a20 2020  -output flag.   
+000334a0: 2020 2020 2020 2020 2074 6578 7420 3d20           text = 
+000334b0: 6622 7b72 6573 702e 6576 656e 7473 7d7b  f"{resp.events}{
+000334c0: 5345 507d 7b72 6f6f 6d5f 6964 7d22 0a20  SEP}{room_id}". 
+000334d0: 2020 2020 2020 2020 2020 2023 204f 626a             # Obj
+000334e0: 6563 7420 6f66 2074 7970 6520 7878 7852  ect of type xxxR
+000334f0: 6573 706f 6e73 6520 6973 206e 6f74 204a  esponse is not J
+00033500: 534f 4e0a 2020 2020 2020 2020 2020 2020  SON.            
+00033510: 2320 7365 7269 616c 697a 6162 6c65 2c20  # serializable, 
+00033520: 6865 6e63 6520 7765 2075 7365 2074 6865  hence we use the
+00033530: 2064 6963 7469 6f6e 6172 792e 0a20 2020   dictionary..   
+00033540: 2020 2020 2020 2020 206a 736f 6e5f 6d61           json_ma
+00033550: 7820 3d20 7265 7370 2e5f 5f64 6963 745f  x = resp.__dict_
+00033560: 5f0a 2020 2020 2020 2020 2020 2020 2320  _.            # 
+00033570: 6a73 6f6e 5f6d 6178 2e75 7064 6174 6528  json_max.update(
+00033580: 7b22 6b65 7922 3a20 7661 6c75 657d 2920  {"key": value}) 
+00033590: 2023 2061 6464 2064 6963 7420 6974 656d   # add dict item
+000335a0: 730a 2020 2020 2020 2020 2020 2020 6a73  s.            js
+000335b0: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
+000335c0: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+000335d0: 2020 6a73 6f6e 5f2e 706f 7028 2274 7261    json_.pop("tra
+000335e0: 6e73 706f 7274 5f72 6573 706f 6e73 6522  nsport_response"
+000335f0: 290a 2020 2020 2020 2020 2020 2020 6a73  ).            js
+00033600: 6f6e 5f73 7065 6320 3d20 4e6f 6e65 0a20  on_spec = None. 
+00033610: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00033620: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
+00033630: 2020 2020 2020 2020 2067 732e 7061 2e6f           gs.pa.o
+00033640: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+00033650: 2020 2020 2020 2074 6578 743d 7465 7874         text=text
+00033660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00033670: 2020 6a73 6f6e 5f3d 6a73 6f6e 5f2c 0a20    json_=json_,. 
+00033680: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00033690: 736f 6e5f 6d61 783d 6a73 6f6e 5f6d 6178  son_max=json_max
+000336a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000336b0: 2020 6a73 6f6e 5f73 7065 633d 6a73 6f6e    json_spec=json
+000336c0: 5f73 7065 632c 0a20 2020 2020 2020 2020  _spec,.         
+000336d0: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
+000336e0: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+000336f0: 732e 6c6f 672e 6572 726f 7228 0a20 2020  s.log.error(.   
+00033700: 2020 2020 2020 2020 2020 2020 2022 4532               "E2
+00033710: 3038 3a20 220a 2020 2020 2020 2020 2020  08: ".          
+00033720: 2020 2020 2020 6622 4661 696c 6564 2067        f"Failed g
+00033730: 6574 7469 6e67 2073 7461 7465 2066 6f72  etting state for
+00033740: 2072 6f6f 6d20 7b72 6f6f 6d5f 6964 7d2e   room {room_id}.
+00033750: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00033760: 2020 2066 227b 7072 6976 6163 795f 6669     f"{privacy_fi
+00033770: 6c74 6572 2873 7472 2872 6573 7029 297d  lter(str(resp))}
+00033780: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00033790: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
+000337a0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+000337b0: 2020 2020 2020 2020 2020 6572 726d 7367            errmsg
+000337c0: 203d 2022 4572 726f 723a 2022 202b 2073   = "Error: " + s
+000337d0: 7472 2872 6573 702e 7374 6174 7573 5f63  tr(resp.status_c
+000337e0: 6f64 6529 202b 2022 2022 202b 2072 6573  ode) + " " + res
+000337f0: 702e 6d65 7373 6167 650a 2020 2020 2020  p.message.      
+00033800: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+00033810: 6f72 6d61 7420 636f 6e74 726f 6c6c 6564  ormat controlled
+00033820: 2076 6961 202d 2d6f 7574 7075 7420 666c   via --output fl
+00033830: 6167 0a20 2020 2020 2020 2020 2020 2023  ag.            #
+00033840: 2066 6f72 204a 534f 4e20 7468 6520 7573   for JSON the us
+00033850: 6572 2063 616e 2064 6574 6572 6d69 6e65  er can determine
+00033860: 2077 6869 6368 206f 6e65 2066 726f 6d20   which one from 
+00033870: 7468 6520 6c69 7374 0a20 2020 2020 2020  the list.       
+00033880: 2020 2020 2023 2077 6173 2073 7563 6365       # was succe
+00033890: 7373 6675 6c20 616e 6420 7768 6963 6820  ssful and which 
+000338a0: 6f6e 6520 6661 696c 6564 2e20 466f 7220  one failed. For 
+000338b0: 3420 696e 7075 7473 2074 6865 7265 0a20  4 inputs there. 
+000338c0: 2020 2020 2020 2020 2020 2023 206d 6967             # mig
+000338d0: 6874 206f 6e6c 7920 6265 2033 206f 7574  ht only be 3 out
+000338e0: 7075 7420 4a53 4f4e 206f 626a 6563 7473  put JSON objects
+000338f0: 2069 6620 7468 6572 6520 7761 7320 3120   if there was 1 
+00033900: 6572 726f 722e 0a20 2020 2020 2020 2020  error..         
+00033910: 2020 2023 2049 6e20 7465 7874 206d 6f64     # In text mod
+00033920: 6520 7765 2070 7269 6e74 2074 6869 7320  e we print this 
+00033930: 6572 726f 7220 6c69 6e65 2c20 736f 2074  error line, so t
+00033940: 6861 7420 666f 7220 3420 696e 7075 7473  hat for 4 inputs
+00033950: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+00033960: 6865 7265 2077 696c 6c20 6265 2034 206f  here will be 4 o
+00033970: 7574 7075 7420 6c69 6e65 732e 0a20 2020  utput lines..   
+00033980: 2020 2020 2020 2020 2070 7269 6e74 5f6f           print_o
+00033990: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
+000339a0: 2020 2020 2020 2067 732e 7061 2e6f 7574         gs.pa.out
+000339b0: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
+000339c0: 2020 2020 2074 6578 743d 2866 227b 6572       text=(f"{er
+000339d0: 726d 7367 7d7b 5345 507d 7b72 6f6f 6d5f  rmsg}{SEP}{room_
+000339e0: 6964 7d22 292c 0a20 2020 2020 2020 2020  id}"),.         
+000339f0: 2020 2020 2020 206a 736f 6e5f 3d4e 6f6e         json_=Non
+00033a00: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00033a10: 2020 206a 736f 6e5f 6d61 783d 4e6f 6e65     json_max=None
+00033a20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00033a30: 2020 6a73 6f6e 5f73 7065 633d 4e6f 6e65    json_spec=None
+00033a40: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00033a50: 0a0a 6173 796e 6320 6465 6620 6163 7469  ..async def acti
+00033a60: 6f6e 5f64 656c 6574 655f 6465 7669 6365  on_delete_device
+00033a70: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
+00033a80: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
+00033a90: 733a 2064 6963 7429 202d 3e20 4e6f 6e65  s: dict) -> None
+00033aa0: 3a0a 2020 2020 2222 2244 656c 6574 6520  :.    """Delete 
+00033ab0: 6465 7669 6365 2873 2920 666f 7220 6974  device(s) for it
+00033ac0: 7365 6c66 206f 7220 6f74 6865 7220 7573  self or other us
+00033ad0: 6572 2077 6869 6c65 2061 6c72 6561 6479  er while already
+00033ae0: 206c 6f67 6765 6420 696e 2e0a 0a20 2020   logged in...   
+00033af0: 2046 6f72 2064 6f63 756d 656e 7461 7469   For documentati
+00033b00: 6f6e 2072 6561 643a 0a20 2020 2068 7474  on read:.    htt
+00033b10: 7073 3a2f 2f6d 6174 7269 782d 6e69 6f2e  ps://matrix-nio.
+00033b20: 7265 6164 7468 6564 6f63 732e 696f 2f65  readthedocs.io/e
+00033b30: 6e2f 6c61 7465 7374 2f6e 696f 2e68 746d  n/latest/nio.htm
+00033b40: 6c23 6173 796e 6363 6c69 656e 740a 2020  l#asyncclient.  
+00033b50: 2020 6874 7470 733a 2f2f 6d61 7472 6978    https://matrix
+00033b60: 2e6f 7267 2f64 6f63 732f 7370 6563 2f63  .org/docs/spec/c
+00033b70: 6c69 656e 745f 7365 7276 6572 2f72 302e  lient_server/r0.
+00033b80: 362e 3023 6175 7468 656e 7469 6361 7469  6.0#authenticati
+00033b90: 6f6e 2d74 7970 6573 0a0a 2020 2020 5468  on-types..    Th
+00033ba0: 6572 6520 6172 6520 7365 7665 7261 6c20  ere are several 
+00033bb0: 7761 7973 2074 6f20 6175 7468 656e 7469  ways to authenti
+00033bc0: 6361 7465 2c20 736f 6d65 206f 6620 7468  cate, some of th
+00033bd0: 6573 6520 7761 7973 206d 6179 206f 7220  ese ways may or 
+00033be0: 6d61 7920 6e6f 740a 2020 2020 6265 2073  may not.    be s
+00033bf0: 7570 706f 7274 6564 2062 7920 7468 6520  upported by the 
+00033c00: 7365 7276 6572 2e20 536f 2c20 7468 6973  server. So, this
+00033c10: 2069 7320 7365 7276 6572 2073 7065 6369   is server speci
+00033c20: 6669 632e 0a20 2020 2054 6865 2022 6d2e  fic..    The "m.
+00033c30: 6c6f 6769 6e2e 746f 6b65 6e22 206f 7074  login.token" opt
+00033c40: 696f 6e20 7365 656d 7320 7573 6566 756c  ion seems useful
+00033c50: 2061 7420 6669 7273 7420 676c 616e 6365   at first glance
+00033c60: 2c20 6275 7420 6e6f 7465 2074 6861 740a  , but note that.
+00033c70: 2020 2020 7468 6973 2069 7320 4e4f 5420      this is NOT 
+00033c80: 616e 2061 6363 6573 7320 746f 6b65 6e2c  an access token,
+00033c90: 2062 7574 2061 206c 6f67 696e 2074 6f6b   but a login tok
+00033ca0: 656e 2072 6563 6569 7665 6420 6672 6f6d  en received from
+00033cb0: 2073 6f6d 6577 6865 7265 0a20 2020 2065   somewhere.    e
+00033cc0: 6c73 652e 2053 6f2c 2069 6e20 7265 616c  lse. So, in real
+00033cd0: 6974 7920 7468 6520 226d 2e6c 6f67 696e  ity the "m.login
+00033ce0: 2e74 6f6b 656e 2220 6f70 7469 6f6e 2069  .token" option i
+00033cf0: 7320 6e6f 7420 7573 6566 756c 2e0a 2020  s not useful..  
+00033d00: 2020 7b0a 2020 2020 2020 2274 7970 6522    {.      "type"
+00033d10: 3a20 226d 2e6c 6f67 696e 2e74 6f6b 656e  : "m.login.token
+00033d20: 222c 0a20 2020 2020 2022 746f 6b65 6e22  ",.      "token"
+00033d30: 3a20 223c 746f 6b65 6e3e 222c 2020 3c3d  : "<token>",  <=
+00033d40: 3d20 7468 6973 2069 7320 6120 6c6f 6769  = this is a logi
+00033d50: 6e20 746f 6b65 6e2c 204e 4f54 2061 6e20  n token, NOT an 
+00033d60: 6163 6365 7373 2074 6f6b 656e 210a 2020  access token!.  
+00033d70: 2020 2020 2274 786e 5f69 6422 3a20 223c      "txn_id": "<
+00033d80: 636c 6965 6e74 2067 656e 6572 6174 6564  client generated
+00033d90: 206e 6f6e 6365 3e22 2c0a 2020 2020 2020   nonce>",.      
+00033da0: 2273 6573 7369 6f6e 223a 2022 3c73 6573  "session": "<ses
+00033db0: 7369 6f6e 2049 443e 220a 2020 2020 7d0a  sion ID>".    }.
+00033dc0: 0a20 2020 2054 6865 2022 6d2e 6c6f 6769  .    The "m.logi
+00033dd0: 6e2e 7373 6f22 206f 7074 696f 6e20 776f  n.sso" option wo
+00033de0: 756c 6420 6265 2075 7365 6675 6c2c 2062  uld be useful, b
+00033df0: 7574 2049 2068 6176 656e 2774 2069 6d70  ut I haven't imp
+00033e00: 6c65 6d65 6e74 6564 2069 740a 2020 2020  lemented it.    
+00033e10: 7965 742e 2049 7420 776f 756c 6420 6265  yet. It would be
+00033e20: 2061 2062 6974 2073 696d 696c 6172 2061   a bit similar a
+00033e30: 7320 746f 2074 6865 2063 6f64 6520 696e  s to the code in
+00033e40: 2061 6374 696f 6e5f 6c6f 6769 6e28 292e   action_login().
+00033e50: 0a0a 2020 2020 5468 6520 6d6f 7374 2063  ..    The most c
+00033e60: 6f6d 6d6f 6e20 6f70 7469 6f6e 2069 7320  ommon option is 
+00033e70: 226d 2e6c 6f67 696e 2e70 6173 7377 6f72  "m.login.passwor
+00033e80: 6422 2e20 5468 6973 206f 7074 696f 6e20  d". This option 
+00033e90: 6973 2069 6d70 6c65 6d65 6e74 6564 2e0a  is implemented..
+00033ea0: 2020 2020 2222 220a 2020 2020 6966 206e      """.    if n
+00033eb0: 6f74 2067 732e 7061 2e70 6173 7377 6f72  ot gs.pa.passwor
+00033ec0: 643a 0a20 2020 2020 2020 2067 732e 6c6f  d:.        gs.lo
+00033ed0: 672e 6572 726f 7228 0a20 2020 2020 2020  g.error(.       
+00033ee0: 2020 2020 2022 4532 3039 3a20 220a 2020       "E209: ".  
+00033ef0: 2020 2020 2020 2020 2020 6622 4661 696c            f"Fail
+00033f00: 6564 2074 6f20 6465 6c65 7465 2064 6576  ed to delete dev
+00033f10: 6963 6573 2062 6563 6175 7365 202d 2d70  ices because --p
+00033f20: 6173 7377 6f72 6420 7761 7320 6e6f 7420  assword was not 
+00033f30: 7365 742e 2022 0a20 2020 2020 2020 2020  set. ".         
+00033f40: 2020 2066 2228 7b67 732e 7061 2e70 6173     f"({gs.pa.pas
+00033f50: 7377 6f72 647d 2922 0a20 2020 2020 2020  sword})".       
+00033f60: 2029 0a20 2020 2020 2020 2067 732e 6572   ).        gs.er
+00033f70: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
+00033f80: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00033f90: 656c 7365 3a0a 2020 2020 2020 2020 7061  else:.        pa
+00033fa0: 7373 776f 7264 203d 2067 732e 7061 2e70  ssword = gs.pa.p
+00033fb0: 6173 7377 6f72 640a 2020 2020 6966 206e  assword.    if n
+00033fc0: 6f74 2067 732e 7061 2e75 7365 723a 0a20  ot gs.pa.user:. 
+00033fd0: 2020 2020 2020 2023 2067 6574 2070 7265         # get pre
+00033fe0: 7365 6e63 6520 6e61 6d65 206f 6620 6d79  sence name of my
+00033ff0: 7365 6c66 0a20 2020 2020 2020 2075 7365  self.        use
+00034000: 725f 6964 203d 2063 7265 6465 6e74 6961  r_id = credentia
+00034010: 6c73 5b22 7573 6572 5f69 6422 5d0a 2020  ls["user_id"].  
+00034020: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00034030: 7573 6572 5f69 6420 3d20 6773 2e70 612e  user_id = gs.pa.
+00034040: 7573 6572 5b30 5d0a 2020 2020 2020 2020  user[0].        
+00034050: 6966 206c 656e 2867 732e 7061 2e75 7365  if len(gs.pa.use
+00034060: 7229 203e 2031 3a0a 2020 2020 2020 2020  r) > 1:.        
+00034070: 2020 2020 6773 2e6c 6f67 2e77 6172 6e69      gs.log.warni
+00034080: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+00034090: 2020 2020 2257 3130 393a 2022 0a20 2020      "W109: ".   
+000340a0: 2020 2020 2020 2020 2020 2020 2022 5761               "Wa
+000340b0: 726e 696e 672e 2022 0a20 2020 2020 2020  rning. ".       
+000340c0: 2020 2020 2020 2020 2022 2d2d 7573 6572           "--user
+000340d0: 2073 7065 6369 6669 6573 206d 6f72 6520   specifies more 
+000340e0: 7468 656e 206f 6e65 2075 7365 722e 2049  then one user. I
+000340f0: 6620 2d2d 7573 6572 2069 7320 7573 6564  f --user is used
+00034100: 2061 7420 220a 2020 2020 2020 2020 2020   at ".          
+00034110: 2020 2020 2020 2261 6c6c 2c20 7468 656e        "all, then
+00034120: 2065 7861 6374 6c79 206f 6e65 2075 7365   exactly one use
+00034130: 7220 7368 6f75 6c64 2062 6520 6769 7665  r should be give
+00034140: 6e2e 220a 2020 2020 2020 2020 2020 2020  n.".            
+00034150: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+00034160: 2e77 6172 6e5f 636f 756e 7420 2b3d 2031  .warn_count += 1
+00034170: 0a20 2020 2064 6576 6963 6573 203d 2067  .    devices = g
+00034180: 732e 7061 2e64 656c 6574 655f 6465 7669  s.pa.delete_devi
+00034190: 6365 0a20 2020 2023 2074 6869 7320 6175  ce.    # this au
+000341a0: 746f 6d61 7469 6361 6c6c 7920 6573 6361  tomatically esca
+000341b0: 7065 7320 7468 6520 2220 6c65 7474 6572  pes the " letter
+000341c0: 7320 696e 2074 6865 2070 6173 7377 6f72  s in the passwor
+000341d0: 642c 0a20 2020 2023 2061 6e64 2074 616b  d,.    # and tak
+000341e0: 6573 2063 6172 6520 6f66 2073 7061 6365  es care of space
+000341f0: 732c 2065 7463 2e0a 2020 2020 6175 7468  s, etc..    auth
+00034200: 203d 207b 0a20 2020 2020 2020 2022 7479   = {.        "ty
+00034210: 7065 223a 2022 6d2e 6c6f 6769 6e2e 7061  pe": "m.login.pa
+00034220: 7373 776f 7264 222c 0a20 2020 2020 2020  ssword",.       
+00034230: 2022 6964 656e 7469 6669 6572 223a 207b   "identifier": {
+00034240: 2274 7970 6522 3a20 226d 2e69 642e 7573  "type": "m.id.us
+00034250: 6572 222c 2022 7573 6572 223a 2075 7365  er", "user": use
+00034260: 725f 6964 7d2c 0a20 2020 2020 2020 2022  r_id},.        "
+00034270: 7061 7373 776f 7264 223a 2070 6173 7377  password": passw
+00034280: 6f72 642c 0a20 2020 207d 0a20 2020 2070  ord,.    }.    p
+00034290: 6173 7377 6f72 6466 616b 6520 3d20 222a  asswordfake = "*
+000342a0: 2a2a 220a 2020 2020 6175 7468 6661 6b65  **".    authfake
+000342b0: 203d 207b 0a20 2020 2020 2020 2022 7479   = {.        "ty
+000342c0: 7065 223a 2022 6d2e 6c6f 6769 6e2e 7061  pe": "m.login.pa
+000342d0: 7373 776f 7264 222c 0a20 2020 2020 2020  ssword",.       
+000342e0: 2022 6964 656e 7469 6669 6572 223a 207b   "identifier": {
+000342f0: 2274 7970 6522 3a20 226d 2e69 642e 7573  "type": "m.id.us
+00034300: 6572 222c 2022 7573 6572 223a 2075 7365  er", "user": use
+00034310: 725f 6964 7d2c 0a20 2020 2020 2020 2022  r_id},.        "
+00034320: 7061 7373 776f 7264 223a 2070 6173 7377  password": passw
+00034330: 6f72 6466 616b 652c 0a20 2020 207d 0a20  ordfake,.    }. 
+00034340: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+00034350: 0a20 2020 2020 2020 2066 2241 626f 7574  .        f"About
+00034360: 2074 6f20 6465 6c65 7465 2064 6576 6963   to delete devic
+00034370: 6573 207b 6465 7669 6365 737d 2066 6f72  es {devices} for
+00034380: 2075 7365 7220 7b75 7365 725f 6964 7d20   user {user_id} 
+00034390: 220a 2020 2020 2020 2020 6622 7769 7468  ".        f"with
+000343a0: 2070 6173 7377 6f72 6420 7b70 6173 7377   password {passw
+000343b0: 6f72 6466 616b 657d 2061 6e64 2061 7574  ordfake} and aut
+000343c0: 6820 7b61 7574 6866 616b 657d 2e22 0a20  h {authfake}.". 
+000343d0: 2020 2029 0a20 2020 2072 6573 7020 3d20     ).    resp = 
+000343e0: 6177 6169 7420 636c 6965 6e74 2e64 656c  await client.del
+000343f0: 6574 655f 6465 7669 6365 7328 6465 7669  ete_devices(devi
+00034400: 6365 732c 2061 7574 6829 0a20 2020 2069  ces, auth).    i
+00034410: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+00034420: 702c 2044 656c 6574 6544 6576 6963 6573  p, DeleteDevices
+00034430: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00034440: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
+00034450: 2020 2020 2020 2020 2020 2245 3231 303a            "E210:
+00034460: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00034470: 2246 6169 6c65 6420 746f 2064 656c 6574  "Failed to delet
+00034480: 6520 6465 7669 6365 7320 7b64 6576 6963  e devices {devic
+00034490: 6573 7d20 666f 7220 7573 6572 207b 7573  es} for user {us
+000344a0: 6572 5f69 647d 2022 0a20 2020 2020 2020  er_id} ".       
+000344b0: 2020 2020 2066 2277 6974 6820 7061 7373       f"with pass
+000344c0: 776f 7264 207b 7061 7373 776f 7264 6661  word {passwordfa
+000344d0: 6b65 7d20 616e 6420 6175 7468 207b 6175  ke} and auth {au
+000344e0: 7468 6661 6b65 7d2e 2022 0a20 2020 2020  thfake}. ".     
+000344f0: 2020 2020 2020 2066 2252 6573 706f 6e73         f"Respons
+00034500: 653a 207b 7072 6976 6163 795f 6669 6c74  e: {privacy_filt
+00034510: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00034520: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00034530: 2020 6773 2e65 7272 5f63 6f75 6e74 202b    gs.err_count +
+00034540: 3d20 310a 2020 2020 656c 6966 2069 7369  = 1.    elif isi
+00034550: 6e73 7461 6e63 6528 7265 7370 2c20 4465  nstance(resp, De
+00034560: 6c65 7465 4465 7669 6365 7341 7574 6852  leteDevicesAuthR
+00034570: 6573 706f 6e73 6529 3a0a 2020 2020 2020  esponse):.      
+00034580: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+00034590: 2020 2020 2020 2020 2020 2020 2245 3231              "E21
+000345a0: 313a 2022 0a20 2020 2020 2020 2020 2020  1: ".           
+000345b0: 2066 2246 6169 6c65 6420 746f 2064 656c   f"Failed to del
+000345c0: 6574 6520 6465 7669 6365 7320 7b64 6576  ete devices {dev
+000345d0: 6963 6573 7d20 666f 7220 7573 6572 207b  ices} for user {
+000345e0: 7573 6572 5f69 647d 2064 7565 2074 6f20  user_id} due to 
+000345f0: 220a 2020 2020 2020 2020 2020 2020 2261  ".            "a
+00034600: 7574 6865 6e74 6963 6174 696f 6e20 6661  uthentication fa
+00034610: 696c 7572 652e 2041 7265 2079 6f75 2061  ilure. Are you a
+00034620: 7574 686f 7269 7a65 643f 2022 0a20 2020  uthorized? ".   
+00034630: 2020 2020 2020 2020 2066 2241 7574 6865           f"Authe
+00034640: 6e74 6963 6174 696f 6e3a 207b 6175 7468  ntication: {auth
+00034650: 6661 6b65 7d2c 2052 6573 706f 6e73 653a  fake}, Response:
+00034660: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00034670: 227b 7072 6976 6163 795f 6669 6c74 6572  "{privacy_filter
+00034680: 2873 7472 2872 6573 7029 297d 220a 2020  (str(resp))}".  
+00034690: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000346a0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
+000346b0: 310a 2020 2020 656c 7365 3a0a 2020 2020  1.    else:.    
+000346c0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000346d0: 280a 2020 2020 2020 2020 2020 2020 2264  (.            "d
+000346e0: 656c 6574 655f 6465 7669 6365 7320 7375  elete_devices su
+000346f0: 6363 6573 7366 756c 2e20 5265 7370 6f6e  ccessful. Respon
+00034700: 7365 2069 733a 2022 0a20 2020 2020 2020  se is: ".       
+00034710: 2020 2020 2066 227b 7072 6976 6163 795f       f"{privacy_
+00034720: 6669 6c74 6572 2873 7472 2872 6573 7029  filter(str(resp)
+00034730: 297d 220a 2020 2020 2020 2020 290a 2020  )}".        ).  
+00034740: 2020 2020 2020 6773 2e6c 6f67 2e69 6e66        gs.log.inf
+00034750: 6f28 0a20 2020 2020 2020 2020 2020 2066  o(.            f
+00034760: 2253 7563 6365 7373 6675 6c6c 7920 6465  "Successfully de
+00034770: 6c65 7465 6420 6465 7669 6365 7320 7b64  leted devices {d
+00034780: 6576 6963 6573 7d20 666f 7220 7573 6572  evices} for user
+00034790: 207b 7573 6572 5f69 647d 2e22 0a20 2020   {user_id}.".   
+000347a0: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
+000347b0: 6566 2061 6374 696f 6e5f 726f 6f6d 5f72  ef action_room_r
+000347c0: 6564 6163 7428 636c 6965 6e74 3a20 4173  edact(client: As
+000347d0: 796e 6343 6c69 656e 742c 2063 7265 6465  yncClient, crede
+000347e0: 6e74 6961 6c73 3a20 6469 6374 2920 2d3e  ntials: dict) ->
+000347f0: 204e 6f6e 653a 0a20 2020 2022 2222 5265   None:.    """Re
+00034800: 6461 6374 2065 7665 6e74 2873 2920 6f66  dact event(s) of
+00034810: 2072 6f6f 6d28 7329 2077 6869 6c65 2061   room(s) while a
+00034820: 6c72 6561 6479 206c 6f67 6765 6420 696e  lready logged in
+00034830: 2e22 2222 0a20 2020 2069 6620 6c65 6e28  .""".    if len(
+00034840: 6773 2e70 612e 726f 6f6d 5f72 6564 6163  gs.pa.room_redac
+00034850: 7429 203d 3d20 323a 0a20 2020 2020 2020  t) == 2:.       
+00034860: 2067 732e 7061 2e72 6f6f 6d5f 7265 6461   gs.pa.room_reda
+00034870: 6374 2e61 7070 656e 6428 2222 290a 2020  ct.append("").  
+00034880: 2020 6966 206e 6f74 206c 656e 2867 732e    if not len(gs.
+00034890: 7061 2e72 6f6f 6d5f 7265 6461 6374 2920  pa.room_redact) 
+000348a0: 2520 3320 3d3d 2030 3a0a 2020 2020 2020  % 3 == 0:.      
+000348b0: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
+000348c0: 2020 2020 2020 2020 2020 2020 2245 3231              "E21
+000348d0: 323a 2022 0a20 2020 2020 2020 2020 2020  2: ".           
+000348e0: 2022 496e 636f 7272 6563 7420 6e75 6d62   "Incorrect numb
+000348f0: 6572 206f 6620 6172 6775 6d65 6e74 7320  er of arguments 
+00034900: 666f 7220 2d2d 726f 6f6d 2d72 6564 6163  for --room-redac
+00034910: 742e 2041 7267 756d 656e 7473 206d 7573  t. Arguments mus
+00034920: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
+00034930: 6622 6265 2074 7269 706c 6573 2c20 692e  f"be triples, i.
+00034940: 652e 206d 756c 7469 706c 6573 206f 6620  e. multiples of 
+00034950: 332c 2062 7574 2066 6f75 6e64 2022 0a20  3, but found ". 
+00034960: 2020 2020 2020 2020 2020 2066 227b 6c65             f"{le
+00034970: 6e28 6773 2e70 612e 726f 6f6d 5f72 6564  n(gs.pa.room_red
+00034980: 6163 7429 7d20 6172 6775 6d65 6e74 732e  act)} arguments.
+00034990: 2032 2069 7320 616c 736f 2061 6c6c 6f77   2 is also allow
+000349a0: 6564 2e22 0a20 2020 2020 2020 2029 0a20  ed.".        ). 
+000349b0: 2020 2020 2020 2067 732e 6572 725f 636f         gs.err_co
+000349c0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+000349d0: 2072 6574 7572 6e0a 2020 2020 666f 7220   return.    for 
+000349e0: 6969 2069 6e20 7261 6e67 6528 6c65 6e28  ii in range(len(
+000349f0: 6773 2e70 612e 726f 6f6d 5f72 6564 6163  gs.pa.room_redac
+00034a00: 7429 202f 2f20 3329 3a0a 2020 2020 2020  t) // 3):.      
+00034a10: 2020 726f 6f6d 5f69 6420 3d20 6773 2e70    room_id = gs.p
+00034a20: 612e 726f 6f6d 5f72 6564 6163 745b 6969  a.room_redact[ii
+00034a30: 202a 2033 202b 2030 5d0a 2020 2020 2020   * 3 + 0].      
+00034a40: 2020 726f 6f6d 5f69 6420 3d20 6177 6169    room_id = awai
+00034a50: 7420 6d61 705f 726f 6f6d 696e 666f 5f74  t map_roominfo_t
+00034a60: 6f5f 726f 6f6d 6964 2863 6c69 656e 742c  o_roomid(client,
+00034a70: 2072 6f6f 6d5f 6964 290a 2020 2020 2020   room_id).      
+00034a80: 2020 6576 656e 745f 6964 203d 2067 732e    event_id = gs.
+00034a90: 7061 2e72 6f6f 6d5f 7265 6461 6374 5b69  pa.room_redact[i
+00034aa0: 6920 2a20 3320 2b20 315d 0a20 2020 2020  i * 3 + 1].     
+00034ab0: 2020 2072 6561 736f 6e20 3d20 6773 2e70     reason = gs.p
+00034ac0: 612e 726f 6f6d 5f72 6564 6163 745b 6969  a.room_redact[ii
+00034ad0: 202a 2033 202b 2032 5d2e 7374 7269 7028   * 3 + 2].strip(
+00034ae0: 290a 2020 2020 2020 2020 6966 2072 6561  ).        if rea
+00034af0: 736f 6e20 3d3d 2022 223a 0a20 2020 2020  son == "":.     
+00034b00: 2020 2020 2020 2072 6561 736f 6e20 3d20         reason = 
+00034b10: 4e6f 6e65 0a20 2020 2020 2020 2067 732e  None.        gs.
+00034b20: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
+00034b30: 2020 2020 2020 2066 2250 7265 7061 7269         f"Prepari
+00034b40: 6e67 2074 6f20 7265 6461 6374 2065 7665  ng to redact eve
+00034b50: 6e74 207b 6576 656e 745f 6964 7d20 696e  nt {event_id} in
+00034b60: 2072 6f6f 6d20 7b72 6f6f 6d5f 6964 7d20   room {room_id} 
+00034b70: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00034b80: 7072 6f76 6964 696e 6720 7265 6173 6f6e  providing reason
+00034b90: 2027 7b72 6561 736f 6e7d 272e 220a 2020   '{reason}'.".  
+00034ba0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00034bb0: 7265 7370 203d 2061 7761 6974 2063 6c69  resp = await cli
+00034bc0: 656e 742e 726f 6f6d 5f72 6564 6163 7428  ent.room_redact(
+00034bd0: 726f 6f6d 5f69 642c 2065 7665 6e74 5f69  room_id, event_i
+00034be0: 642c 2072 6561 736f 6e3d 7265 6173 6f6e  d, reason=reason
+00034bf0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
+00034c00: 6e73 7461 6e63 6528 7265 7370 2c20 526f  nstance(resp, Ro
+00034c10: 6f6d 5265 6461 6374 4572 726f 7229 3a0a  omRedactError):.
+00034c20: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00034c30: 6f67 2e65 7272 6f72 280a 2020 2020 2020  og.error(.      
+00034c40: 2020 2020 2020 2020 2020 2245 3231 333a            "E213:
+00034c50: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00034c60: 2020 2066 2246 6169 6c65 6420 746f 2072     f"Failed to r
+00034c70: 6564 6163 7420 6576 656e 7420 7b65 7665  edact event {eve
+00034c80: 6e74 5f69 647d 2069 6e20 726f 6f6d 207b  nt_id} in room {
+00034c90: 726f 6f6d 5f69 647d 2022 0a20 2020 2020  room_id} ".     
+00034ca0: 2020 2020 2020 2020 2020 2066 2277 6974             f"wit
+00034cb0: 6820 7265 6173 6f6e 2027 7b72 6561 736f  h reason '{reaso
+00034cc0: 6e7d 272e 2022 0a20 2020 2020 2020 2020  n}'. ".         
+00034cd0: 2020 2020 2020 2066 2252 6573 706f 6e73         f"Respons
+00034ce0: 653a 207b 7072 6976 6163 795f 6669 6c74  e: {privacy_filt
+00034cf0: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00034d00: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00034d10: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00034d20: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00034d30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00034d40: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00034d50: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00034d60: 2020 2020 2272 6f6f 6d5f 7265 6461 6374      "room_redact
+00034d70: 2073 7563 6365 7373 6675 6c2e 2052 6573   successful. Res
+00034d80: 706f 6e73 6520 6973 3a20 220a 2020 2020  ponse is: ".    
+00034d90: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
+00034da0: 7269 7661 6379 5f66 696c 7465 7228 7374  rivacy_filter(st
+00034db0: 7228 7265 7370 2929 7d22 0a20 2020 2020  r(resp))}".     
+00034dc0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00034dd0: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+00034de0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00034df0: 2020 6622 5375 6363 6573 7366 756c 6c79    f"Successfully
+00034e00: 2072 6564 6163 7465 6420 6576 656e 7420   redacted event 
+00034e10: 7b65 7665 6e74 5f69 647d 2069 6e20 726f  {event_id} in ro
+00034e20: 6f6d 207b 726f 6f6d 5f69 647d 2022 0a20  om {room_id} ". 
+00034e30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00034e40: 2270 726f 7669 6469 6e67 2072 6561 736f  "providing reaso
+00034e50: 6e20 277b 2727 2069 6620 7265 6173 6f6e  n '{'' if reason
+00034e60: 2069 7320 4e6f 6e65 2065 6c73 6520 7265   is None else re
+00034e70: 6173 6f6e 7d27 2e22 0a20 2020 2020 2020  ason}'.".       
+00034e80: 2020 2020 2029 0a0a 0a61 7379 6e63 2064       )...async d
+00034e90: 6566 2061 6374 696f 6e5f 7768 6f61 6d69  ef action_whoami
+00034ea0: 2863 6c69 656e 743a 2041 7379 6e63 436c  (client: AsyncCl
+00034eb0: 6965 6e74 2c20 6372 6564 656e 7469 616c  ient, credential
+00034ec0: 733a 2064 6963 7429 202d 3e20 4e6f 6e65  s: dict) -> None
+00034ed0: 3a0a 2020 2020 2222 2247 6574 2075 7365  :.    """Get use
+00034ee0: 7220 6964 2077 6869 6c65 2061 6c72 6561  r id while alrea
+00034ef0: 6479 206c 6f67 6765 6420 696e 2e22 2222  dy logged in."""
+00034f00: 0a20 2020 2077 686f 616d 6920 3d20 6372  .    whoami = cr
+00034f10: 6564 656e 7469 616c 735b 2275 7365 725f  edentials["user_
+00034f20: 6964 225d 0a20 2020 2067 732e 6c6f 672e  id"].    gs.log.
+00034f30: 6465 6275 6728 6622 7768 6f61 6d69 3a20  debug(f"whoami: 
+00034f40: 7573 6572 2069 643a 207b 7768 6f61 6d69  user id: {whoami
+00034f50: 7d22 290a 2020 2020 2320 6f75 7470 7574  }").    # output
+00034f60: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
+00034f70: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
+00034f80: 666c 6167 0a20 2020 2074 6578 7420 3d20  flag.    text = 
+00034f90: 7768 6f61 6d69 0a20 2020 206a 736f 6e5f  whoami.    json_
+00034fa0: 6d61 7820 3d20 7b22 7573 6572 5f69 6422  max = {"user_id"
+00034fb0: 3a20 7768 6f61 6d69 7d0a 2020 2020 2320  : whoami}.    # 
+00034fc0: 6a73 6f6e 5f6d 6178 2e75 7064 6174 6528  json_max.update(
+00034fd0: 7b22 6b65 7922 3a20 7661 6c75 657d 2920  {"key": value}) 
+00034fe0: 2023 2061 6464 2064 6963 7420 6974 656d   # add dict item
+00034ff0: 730a 2020 2020 6a73 6f6e 5f20 3d20 6a73  s.    json_ = js
+00035000: 6f6e 5f6d 6178 2e63 6f70 7928 290a 2020  on_max.copy().  
+00035010: 2020 2320 6a73 6f6e 5f2e 706f 7028 226b    # json_.pop("k
+00035020: 6579 2229 0a20 2020 206a 736f 6e5f 7370  ey").    json_sp
+00035030: 6563 203d 204e 6f6e 650a 2020 2020 7072  ec = None.    pr
+00035040: 696e 745f 6f75 7470 7574 280a 2020 2020  int_output(.    
+00035050: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
+00035060: 2c0a 2020 2020 2020 2020 7465 7874 3d74  ,.        text=t
+00035070: 6578 742c 0a20 2020 2020 2020 206a 736f  ext,.        jso
+00035080: 6e5f 3d6a 736f 6e5f 2c0a 2020 2020 2020  n_=json_,.      
+00035090: 2020 6a73 6f6e 5f6d 6178 3d6a 736f 6e5f    json_max=json_
+000350a0: 6d61 782c 0a20 2020 2020 2020 206a 736f  max,.        jso
+000350b0: 6e5f 7370 6563 3d6a 736f 6e5f 7370 6563  n_spec=json_spec
+000350c0: 2c0a 2020 2020 290a 0a0a 6173 796e 6320  ,.    )...async 
+000350d0: 6465 6620 6163 7469 6f6e 5f72 6f6f 6d73  def action_rooms
+000350e0: 6574 6765 7428 2920 2d3e 204e 6f6e 653a  etget() -> None:
+000350f0: 0a20 2020 2022 2222 5065 7266 6f72 6d20  .    """Perform 
+00035100: 726f 6f6d 2c20 6765 742c 2073 6574 2061  room, get, set a
+00035110: 6374 696f 6e73 2077 6869 6c65 2062 6569  ctions while bei
+00035120: 6e67 206c 6f67 6765 6420 696e 2e22 2222  ng logged in."""
+00035130: 0a20 2020 2069 6620 6e6f 7420 6773 2e63  .    if not gs.c
+00035140: 6c69 656e 7420 616e 6420 6e6f 7420 6773  lient and not gs
+00035150: 2e63 7265 6465 6e74 6961 6c73 3a0a 2020  .credentials:.  
+00035160: 2020 2020 2020 6773 2e6c 6f67 2e65 7272        gs.log.err
+00035170: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00035180: 2245 3231 343a 2022 2022 436c 6965 6e74  "E214: " "Client
+00035190: 206f 7220 6372 6564 656e 7469 616c 7320   or credentials 
+000351a0: 6e6f 7420 7365 742e 2053 6b69 7070 696e  not set. Skippin
+000351b0: 6720 6163 7469 6f6e 2e22 0a20 2020 2020  g action.".     
+000351c0: 2020 2029 0a20 2020 2020 2020 2067 732e     ).        gs.
+000351d0: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+000351e0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+000351f0: 2020 7472 793a 0a20 2020 2020 2020 2023    try:.        #
+00035200: 2072 6f6f 6d5f 6163 7469 6f6e 0a20 2020   room_action.   
+00035210: 2020 2020 2023 2077 6520 616c 7265 6164       # we alread
+00035220: 7920 6368 6563 6b65 6420 6172 6773 2061  y checked args a
+00035230: 7420 7468 6520 6265 6769 6e6e 696e 672c  t the beginning,
+00035240: 206e 6f20 6e65 6564 2074 6f20 6368 6563   no need to chec
+00035250: 6b0a 2020 2020 2020 2020 2320 726f 6f6d  k.        # room
+00035260: 2061 6e64 2075 7365 7220 6172 6775 6d65   and user argume
+00035270: 6e74 2063 6f6d 6269 6e61 7469 6f6e 7320  nt combinations 
+00035280: 6167 6169 6e2e 0a20 2020 2020 2020 2023  again..        #
+00035290: 2072 6f6f 6d20 7365 7420 6163 7469 6f6e   room set action
+000352a0: 730a 2020 2020 2020 2020 6966 2067 732e  s.        if gs.
+000352b0: 7061 2e72 6f6f 6d5f 6372 6561 7465 3a0a  pa.room_create:.
+000352c0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000352d0: 7420 6163 7469 6f6e 5f72 6f6f 6d5f 6372  t action_room_cr
+000352e0: 6561 7465 2867 732e 636c 6965 6e74 2c20  eate(gs.client, 
+000352f0: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
+00035300: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
+00035310: 2e72 6f6f 6d5f 646d 5f63 7265 6174 653a  .room_dm_create:
+00035320: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00035330: 6974 2061 6374 696f 6e5f 726f 6f6d 5f64  it action_room_d
+00035340: 6d5f 6372 6561 7465 2867 732e 636c 6965  m_create(gs.clie
+00035350: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00035360: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00035370: 732e 7061 2e72 6f6f 6d5f 6a6f 696e 3a0a  s.pa.room_join:.
+00035380: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00035390: 7420 6163 7469 6f6e 5f72 6f6f 6d5f 6a6f  t action_room_jo
+000353a0: 696e 2867 732e 636c 6965 6e74 2c20 6773  in(gs.client, gs
+000353b0: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
+000353c0: 2020 2020 2020 6966 2067 732e 7061 2e72        if gs.pa.r
+000353d0: 6f6f 6d5f 6c65 6176 653a 0a20 2020 2020  oom_leave:.     
+000353e0: 2020 2020 2020 2061 7761 6974 2061 6374         await act
+000353f0: 696f 6e5f 726f 6f6d 5f6c 6561 7665 2867  ion_room_leave(g
+00035400: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
+00035410: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
+00035420: 2020 6966 2067 732e 7061 2e72 6f6f 6d5f    if gs.pa.room_
+00035430: 666f 7267 6574 3a0a 2020 2020 2020 2020  forget:.        
+00035440: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
+00035450: 5f72 6f6f 6d5f 666f 7267 6574 2867 732e  _room_forget(gs.
+00035460: 636c 6965 6e74 2c20 6773 2e63 7265 6465  client, gs.crede
+00035470: 6e74 6961 6c73 290a 2020 2020 2020 2020  ntials).        
+00035480: 6966 2067 732e 7061 2e72 6f6f 6d5f 696e  if gs.pa.room_in
+00035490: 7669 7465 2061 6e64 2067 732e 7061 2e75  vite and gs.pa.u
+000354a0: 7365 723a 0a20 2020 2020 2020 2020 2020  ser:.           
+000354b0: 2061 7761 6974 2061 6374 696f 6e5f 726f   await action_ro
+000354c0: 6f6d 5f69 6e76 6974 6528 6773 2e63 6c69  om_invite(gs.cli
+000354d0: 656e 742c 2067 732e 6372 6564 656e 7469  ent, gs.credenti
+000354e0: 616c 7329 0a20 2020 2020 2020 2069 6620  als).        if 
+000354f0: 6773 2e70 612e 726f 6f6d 5f62 616e 2061  gs.pa.room_ban a
+00035500: 6e64 2067 732e 7061 2e75 7365 723a 0a20  nd gs.pa.user:. 
+00035510: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00035520: 2061 6374 696f 6e5f 726f 6f6d 5f62 616e   action_room_ban
+00035530: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
+00035540: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+00035550: 2020 2020 6966 2067 732e 7061 2e72 6f6f      if gs.pa.roo
+00035560: 6d5f 756e 6261 6e20 616e 6420 6773 2e70  m_unban and gs.p
+00035570: 612e 7573 6572 3a0a 2020 2020 2020 2020  a.user:.        
+00035580: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
+00035590: 5f72 6f6f 6d5f 756e 6261 6e28 6773 2e63  _room_unban(gs.c
+000355a0: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
+000355b0: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
+000355c0: 6620 6773 2e70 612e 726f 6f6d 5f6b 6963  f gs.pa.room_kic
+000355d0: 6b20 616e 6420 6773 2e70 612e 7573 6572  k and gs.pa.user
+000355e0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+000355f0: 6169 7420 6163 7469 6f6e 5f72 6f6f 6d5f  ait action_room_
+00035600: 6b69 636b 2867 732e 636c 6965 6e74 2c20  kick(gs.client, 
+00035610: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
+00035620: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
+00035630: 2e72 6f6f 6d5f 7265 6461 6374 3a0a 2020  .room_redact:.  
+00035640: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00035650: 6163 7469 6f6e 5f72 6f6f 6d5f 7265 6461  action_room_reda
+00035660: 6374 2867 732e 636c 6965 6e74 2c20 6773  ct(gs.client, gs
+00035670: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
+00035680: 2020 2020 2020 6966 2067 732e 7061 2e72        if gs.pa.r
+00035690: 6f6f 6d5f 7365 745f 616c 6961 733a 0a20  oom_set_alias:. 
+000356a0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+000356b0: 2061 6374 696f 6e5f 726f 6f6d 5f73 6574   action_room_set
+000356c0: 5f61 6c69 6173 2867 732e 636c 6965 6e74  _alias(gs.client
+000356d0: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
+000356e0: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
+000356f0: 7061 2e72 6f6f 6d5f 6465 6c65 7465 5f61  pa.room_delete_a
+00035700: 6c69 6173 3a0a 2020 2020 2020 2020 2020  lias:.          
+00035710: 2020 6177 6169 7420 6163 7469 6f6e 5f72    await action_r
+00035720: 6f6f 6d5f 6465 6c65 7465 5f61 6c69 6173  oom_delete_alias
+00035730: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
+00035740: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+00035750: 2020 2020 2320 726f 6f6d 2067 6574 2061      # room get a
+00035760: 6374 696f 6e73 0a20 2020 2020 2020 2069  ctions.        i
+00035770: 6620 6773 2e70 612e 726f 6f6d 5f67 6574  f gs.pa.room_get
+00035780: 5f76 6973 6962 696c 6974 7920 6973 206e  _visibility is n
+00035790: 6f74 204e 6f6e 653a 2020 2320 656d 7074  ot None:  # empt
+000357a0: 7920 5b5d 206d 7573 7420 696e 766f 6b65  y [] must invoke
+000357b0: 2066 756e 630a 2020 2020 2020 2020 2020   func.          
+000357c0: 2020 6177 6169 7420 6163 7469 6f6e 5f72    await action_r
+000357d0: 6f6f 6d5f 6765 745f 7669 7369 6269 6c69  oom_get_visibili
+000357e0: 7479 2867 732e 636c 6965 6e74 2c20 6773  ty(gs.client, gs
+000357f0: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
+00035800: 2020 2020 2020 6966 2067 732e 7061 2e72        if gs.pa.r
+00035810: 6f6f 6d5f 6765 745f 7374 6174 6520 6973  oom_get_state is
+00035820: 206e 6f74 204e 6f6e 653a 2020 2320 656d   not None:  # em
+00035830: 7074 7920 6c69 7374 206d 7573 7420 696e  pty list must in
+00035840: 766f 6b65 2066 756e 630a 2020 2020 2020  voke func.      
+00035850: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
+00035860: 6f6e 5f72 6f6f 6d5f 6765 745f 7374 6174  on_room_get_stat
+00035870: 6528 6773 2e63 6c69 656e 742c 2067 732e  e(gs.client, gs.
+00035880: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00035890: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
+000358a0: 6f6d 5f72 6573 6f6c 7665 5f61 6c69 6173  om_resolve_alias
+000358b0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+000358c0: 6169 7420 6163 7469 6f6e 5f72 6f6f 6d5f  ait action_room_
+000358d0: 7265 736f 6c76 655f 616c 6961 7328 6773  resolve_alias(gs
+000358e0: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
+000358f0: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
+00035900: 2069 6620 6773 2e72 6f6f 6d5f 6163 7469   if gs.room_acti
+00035910: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00035920: 6773 2e6c 6f67 2e64 6562 7567 2822 526f  gs.log.debug("Ro
+00035930: 6f6d 2061 6374 696f 6e28 7329 2077 6572  om action(s) wer
+00035940: 6520 7065 7266 6f72 6d65 6420 6f72 2061  e performed or a
+00035950: 7474 656d 7074 6564 2e22 290a 0a20 2020  ttempted.")..   
+00035960: 2020 2020 2023 2073 6574 5f61 6374 696f       # set_actio
+00035970: 6e0a 2020 2020 2020 2020 6966 2067 732e  n.        if gs.
+00035980: 7061 2e73 6574 5f64 6973 706c 6179 5f6e  pa.set_display_n
+00035990: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
+000359a0: 2061 7761 6974 2061 6374 696f 6e5f 7365   await action_se
+000359b0: 745f 6469 7370 6c61 795f 6e61 6d65 2867  t_display_name(g
+000359c0: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
+000359d0: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
+000359e0: 2020 6966 2067 732e 7061 2e73 6574 5f64    if gs.pa.set_d
+000359f0: 6576 6963 655f 6e61 6d65 3a0a 2020 2020  evice_name:.    
+00035a00: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+00035a10: 7469 6f6e 5f73 6574 5f64 6576 6963 655f  tion_set_device_
+00035a20: 6e61 6d65 2867 732e 636c 6965 6e74 2c20  name(gs.client, 
+00035a30: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
+00035a40: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
+00035a50: 2e73 6574 5f70 7265 7365 6e63 653a 0a20  .set_presence:. 
+00035a60: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00035a70: 2061 6374 696f 6e5f 7365 745f 7072 6573   action_set_pres
+00035a80: 656e 6365 2867 732e 636c 6965 6e74 2c20  ence(gs.client, 
+00035a90: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
+00035aa0: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
+00035ab0: 2e75 706c 6f61 643a 0a20 2020 2020 2020  .upload:.       
+00035ac0: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
+00035ad0: 6e5f 7570 6c6f 6164 2867 732e 636c 6965  n_upload(gs.clie
+00035ae0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00035af0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00035b00: 732e 7061 2e64 656c 6574 655f 6d78 633a  s.pa.delete_mxc:
+00035b10: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00035b20: 6974 2061 6374 696f 6e5f 6465 6c65 7465  it action_delete
+00035b30: 5f6d 7863 2867 732e 636c 6965 6e74 2c20  _mxc(gs.client, 
+00035b40: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
+00035b50: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
+00035b60: 2e64 656c 6574 655f 6d78 635f 6265 666f  .delete_mxc_befo
+00035b70: 7265 3a0a 2020 2020 2020 2020 2020 2020  re:.            
+00035b80: 6177 6169 7420 6163 7469 6f6e 5f64 656c  await action_del
+00035b90: 6574 655f 6d78 635f 6265 666f 7265 2867  ete_mxc_before(g
+00035ba0: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
+00035bb0: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
+00035bc0: 2020 6966 2067 732e 7061 2e72 6573 743a    if gs.pa.rest:
+00035bd0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00035be0: 6974 2061 6374 696f 6e5f 7265 7374 2867  it action_rest(g
+00035bf0: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
+00035c00: 6465 6e74 6961 6c73 290a 2020 2020 2020  dentials).      
+00035c10: 2020 6966 2067 732e 7061 2e73 6574 5f61    if gs.pa.set_a
+00035c20: 7661 7461 723a 0a20 2020 2020 2020 2020  vatar:.         
+00035c30: 2020 2061 7761 6974 2061 6374 696f 6e5f     await action_
+00035c40: 7365 745f 6176 6174 6172 2867 732e 636c  set_avatar(gs.cl
+00035c50: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
+00035c60: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
+00035c70: 2067 732e 7061 2e69 6d70 6f72 745f 6b65   gs.pa.import_ke
+00035c80: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00035c90: 6177 6169 7420 6163 7469 6f6e 5f69 6d70  await action_imp
+00035ca0: 6f72 745f 6b65 7973 2867 732e 636c 6965  ort_keys(gs.clie
+00035cb0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00035cc0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00035cd0: 732e 7061 2e64 656c 6574 655f 6465 7669  s.pa.delete_devi
+00035ce0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00035cf0: 6177 6169 7420 6163 7469 6f6e 5f64 656c  await action_del
+00035d00: 6574 655f 6465 7669 6365 2867 732e 636c  ete_device(gs.cl
+00035d10: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
+00035d20: 6961 6c73 290a 0a20 2020 2020 2020 2023  ials)..        #
+00035d30: 2067 6574 5f61 6374 696f 6e0a 2020 2020   get_action.    
+00035d40: 2020 2020 6966 2067 732e 7061 2e67 6574      if gs.pa.get
+00035d50: 5f64 6973 706c 6179 5f6e 616d 653a 0a20  _display_name:. 
+00035d60: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00035d70: 2061 6374 696f 6e5f 6765 745f 6469 7370   action_get_disp
+00035d80: 6c61 795f 6e61 6d65 2867 732e 636c 6965  lay_name(gs.clie
+00035d90: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00035da0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00035db0: 732e 7061 2e67 6574 5f70 7265 7365 6e63  s.pa.get_presenc
+00035dc0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00035dd0: 7761 6974 2061 6374 696f 6e5f 6765 745f  wait action_get_
+00035de0: 7072 6573 656e 6365 2867 732e 636c 6965  presence(gs.clie
+00035df0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00035e00: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00035e10: 732e 7061 2e64 6f77 6e6c 6f61 643a 0a20  s.pa.download:. 
+00035e20: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00035e30: 2061 6374 696f 6e5f 646f 776e 6c6f 6164   action_download
+00035e40: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
+00035e50: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+00035e60: 2020 2020 6966 2067 732e 7061 2e6a 6f69      if gs.pa.joi
+00035e70: 6e65 645f 726f 6f6d 733a 0a20 2020 2020  ned_rooms:.     
+00035e80: 2020 2020 2020 2061 7761 6974 2061 6374         await act
+00035e90: 696f 6e5f 6a6f 696e 6564 5f72 6f6f 6d73  ion_joined_rooms
+00035ea0: 2867 732e 636c 6965 6e74 2c20 6773 2e63  (gs.client, gs.c
+00035eb0: 7265 6465 6e74 6961 6c73 290a 2020 2020  redentials).    
+00035ec0: 2020 2020 6966 2067 732e 7061 2e6a 6f69      if gs.pa.joi
+00035ed0: 6e65 645f 6d65 6d62 6572 733a 0a20 2020  ned_members:.   
+00035ee0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00035ef0: 6374 696f 6e5f 6a6f 696e 6564 5f6d 656d  ction_joined_mem
+00035f00: 6265 7273 2867 732e 636c 6965 6e74 2c20  bers(gs.client, 
+00035f10: 6773 2e63 7265 6465 6e74 6961 6c73 290a  gs.credentials).
+00035f20: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
+00035f30: 2e6d 7863 5f74 6f5f 6874 7470 3a0a 2020  .mxc_to_http:.  
+00035f40: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00035f50: 6163 7469 6f6e 5f6d 7863 5f74 6f5f 6874  action_mxc_to_ht
+00035f60: 7470 2867 732e 636c 6965 6e74 2c20 6773  tp(gs.client, gs
+00035f70: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
+00035f80: 2020 2020 2020 6966 2067 732e 7061 2e64        if gs.pa.d
+00035f90: 6576 6963 6573 3a0a 2020 2020 2020 2020  evices:.        
+00035fa0: 2020 2020 6177 6169 7420 6163 7469 6f6e      await action
+00035fb0: 5f64 6576 6963 6573 2867 732e 636c 6965  _devices(gs.clie
+00035fc0: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00035fd0: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+00035fe0: 732e 7061 2e64 6973 636f 7665 7279 5f69  s.pa.discovery_i
+00035ff0: 6e66 6f3a 0a20 2020 2020 2020 2020 2020  nfo:.           
+00036000: 2061 7761 6974 2061 6374 696f 6e5f 6469   await action_di
+00036010: 7363 6f76 6572 795f 696e 666f 2867 732e  scovery_info(gs.
+00036020: 636c 6965 6e74 2c20 6773 2e63 7265 6465  client, gs.crede
+00036030: 6e74 6961 6c73 290a 2020 2020 2020 2020  ntials).        
+00036040: 6966 2067 732e 7061 2e6c 6f67 696e 5f69  if gs.pa.login_i
+00036050: 6e66 6f3a 0a20 2020 2020 2020 2020 2020  nfo:.           
+00036060: 2061 7761 6974 2061 6374 696f 6e5f 6c6f   await action_lo
+00036070: 6769 6e5f 696e 666f 2867 732e 636c 6965  gin_info(gs.clie
+00036080: 6e74 2c20 6773 2e63 7265 6465 6e74 6961  nt, gs.credentia
+00036090: 6c73 290a 2020 2020 2020 2020 6966 2067  ls).        if g
+000360a0: 732e 7061 2e63 6f6e 7465 6e74 5f72 6570  s.pa.content_rep
+000360b0: 6f73 6974 6f72 795f 636f 6e66 6967 3a0a  ository_config:.
+000360c0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000360d0: 7420 6163 7469 6f6e 5f63 6f6e 7465 6e74  t action_content
+000360e0: 5f72 6570 6f73 6974 6f72 795f 636f 6e66  _repository_conf
+000360f0: 6967 2867 732e 636c 6965 6e74 2c20 6773  ig(gs.client, gs
+00036100: 2e63 7265 6465 6e74 6961 6c73 290a 2020  .credentials).  
+00036110: 2020 2020 2020 6966 2067 732e 7061 2e67        if gs.pa.g
+00036120: 6574 5f61 7661 7461 7220 6973 206e 6f74  et_avatar is not
+00036130: 204e 6f6e 653a 2020 2320 656d 7074 7920   None:  # empty 
+00036140: 6c69 7374 206d 7573 7420 696e 766f 6b65  list must invoke
+00036150: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
+00036160: 2020 2020 2020 6177 6169 7420 6163 7469        await acti
+00036170: 6f6e 5f67 6574 5f61 7661 7461 7228 6773  on_get_avatar(gs
+00036180: 2e63 6c69 656e 742c 2067 732e 6372 6564  .client, gs.cred
+00036190: 656e 7469 616c 7329 0a20 2020 2020 2020  entials).       
+000361a0: 2069 6620 6773 2e70 612e 6765 745f 7072   if gs.pa.get_pr
+000361b0: 6f66 696c 6520 6973 206e 6f74 204e 6f6e  ofile is not Non
+000361c0: 653a 2020 2320 656d 7074 7920 6c69 7374  e:  # empty list
+000361d0: 206d 7573 7420 696e 766f 6b65 2066 756e   must invoke fun
+000361e0: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
+000361f0: 2020 6177 6169 7420 6163 7469 6f6e 5f67    await action_g
+00036200: 6574 5f70 726f 6669 6c65 2867 732e 636c  et_profile(gs.cl
+00036210: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
+00036220: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
+00036230: 2067 732e 7061 2e67 6574 5f72 6f6f 6d5f   gs.pa.get_room_
+00036240: 696e 666f 2069 7320 6e6f 7420 4e6f 6e65  info is not None
+00036250: 3a20 2023 2065 6d70 7479 206c 6973 7420  :  # empty list 
+00036260: 6d75 7374 2069 6e76 6f6b 6520 6675 6e63  must invoke func
+00036270: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00036280: 2061 7761 6974 2061 6374 696f 6e5f 6765   await action_ge
+00036290: 745f 726f 6f6d 5f69 6e66 6f28 6773 2e63  t_room_info(gs.c
+000362a0: 6c69 656e 742c 2067 732e 6372 6564 656e  lient, gs.creden
+000362b0: 7469 616c 7329 0a20 2020 2020 2020 2069  tials).        i
+000362c0: 6620 6773 2e70 612e 6765 745f 636c 6965  f gs.pa.get_clie
+000362d0: 6e74 5f69 6e66 6f3a 0a20 2020 2020 2020  nt_info:.       
+000362e0: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
+000362f0: 6e5f 6765 745f 636c 6965 6e74 5f69 6e66  n_get_client_inf
+00036300: 6f28 6773 2e63 6c69 656e 742c 2067 732e  o(gs.client, gs.
+00036310: 6372 6564 656e 7469 616c 7329 0a20 2020  credentials).   
+00036320: 2020 2020 2069 6620 6773 2e70 612e 6861       if gs.pa.ha
+00036330: 735f 7065 726d 6973 7369 6f6e 3a0a 2020  s_permission:.  
+00036340: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00036350: 6163 7469 6f6e 5f68 6173 5f70 6572 6d69  action_has_permi
+00036360: 7373 696f 6e28 6773 2e63 6c69 656e 742c  ssion(gs.client,
+00036370: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
+00036380: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+00036390: 612e 6578 706f 7274 5f6b 6579 733a 0a20  a.export_keys:. 
+000363a0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+000363b0: 2061 6374 696f 6e5f 6578 706f 7274 5f6b   action_export_k
+000363c0: 6579 7328 6773 2e63 6c69 656e 742c 2067  eys(gs.client, g
+000363d0: 732e 6372 6564 656e 7469 616c 7329 0a20  s.credentials). 
+000363e0: 2020 2020 2020 2069 6620 6773 2e70 612e         if gs.pa.
+000363f0: 6765 745f 6f70 656e 6964 5f74 6f6b 656e  get_openid_token
+00036400: 2069 7320 6e6f 7420 4e6f 6e65 3a20 2023   is not None:  #
+00036410: 2065 6d70 7479 206c 6973 7420 6d75 7374   empty list must
+00036420: 2069 6e76 6f6b 6520 6675 6e63 0a20 2020   invoke func.   
+00036430: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00036440: 6374 696f 6e5f 6765 745f 6f70 656e 6964  ction_get_openid
+00036450: 5f74 6f6b 656e 2867 732e 636c 6965 6e74  _token(gs.client
+00036460: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
+00036470: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
+00036480: 7061 2e77 686f 616d 693a 0a20 2020 2020  pa.whoami:.     
+00036490: 2020 2020 2020 2061 7761 6974 2061 6374         await act
+000364a0: 696f 6e5f 7768 6f61 6d69 2867 732e 636c  ion_whoami(gs.cl
+000364b0: 6965 6e74 2c20 6773 2e63 7265 6465 6e74  ient, gs.credent
+000364c0: 6961 6c73 290a 2020 2020 2020 2020 6966  ials).        if
+000364d0: 2067 732e 7365 7467 6574 5f61 6374 696f   gs.setget_actio
+000364e0: 6e3a 0a20 2020 2020 2020 2020 2020 2067  n:.            g
+000364f0: 732e 6c6f 672e 6465 6275 6728 2253 6574  s.log.debug("Set
+00036500: 206f 7220 6765 7420 6163 7469 6f6e 2873   or get action(s
+00036510: 2920 7765 7265 2070 6572 666f 726d 6564  ) were performed
+00036520: 206f 7220 6174 7465 6d70 7465 642e 2229   or attempted.")
+00036530: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+00036540: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00036550: 2020 2020 6773 2e6c 6f67 2e65 7272 6f72      gs.log.error
+00036560: 280a 2020 2020 2020 2020 2020 2020 2245  (.            "E
+00036570: 3231 353a 2022 0a20 2020 2020 2020 2020  215: ".         
+00036580: 2020 2022 4572 726f 7220 6475 7269 6e67     "Error during
+00036590: 2072 6f6f 6d2c 2073 6574 2c20 6765 7420   room, set, get 
+000365a0: 6163 7469 6f6e 732e 2043 6f6e 7469 6e75  actions. Continu
+000365b0: 696e 6720 6465 7370 6974 6520 6572 726f  ing despite erro
+000365c0: 722e 2022 0a20 2020 2020 2020 2020 2020  r. ".           
+000365d0: 2066 2245 7863 6570 7469 6f6e 3a20 7b65   f"Exception: {e
+000365e0: 7d22 0a20 2020 2020 2020 2029 0a20 2020  }".        ).   
+000365f0: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00036600: 6728 2248 6572 6520 6973 2074 6865 2074  g("Here is the t
+00036610: 7261 6365 6261 636b 2e5c 6e22 202b 2074  raceback.\n" + t
+00036620: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
+00036630: 6578 6328 2929 0a20 2020 2020 2020 2067  exc()).        g
+00036640: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+00036650: 0a0a 0a61 7379 6e63 2064 6566 2061 6374  ...async def act
+00036660: 696f 6e5f 7665 7269 6679 2829 202d 3e20  ion_verify() -> 
+00036670: 4e6f 6e65 3a0a 2020 2020 2222 2256 6572  None:.    """Ver
+00036680: 6966 7920 7768 696c 6520 616c 7265 6164  ify while alread
+00036690: 7920 6c6f 6767 6564 2069 6e2e 2222 220a  y logged in.""".
+000366a0: 2020 2020 6966 206e 6f74 2067 732e 636c      if not gs.cl
+000366b0: 6965 6e74 2061 6e64 206e 6f74 2067 732e  ient and not gs.
+000366c0: 6372 6564 656e 7469 616c 733a 0a20 2020  credentials:.   
+000366d0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+000366e0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+000366f0: 4532 3136 3a20 2220 2243 6c69 656e 7420  E216: " "Client 
+00036700: 6f72 2063 7265 6465 6e74 6961 6c73 206e  or credentials n
+00036710: 6f74 2073 6574 2e20 536b 6970 7069 6e67  ot set. Skipping
+00036720: 2061 6374 696f 6e2e 220a 2020 2020 2020   action.".      
+00036730: 2020 290a 2020 2020 2020 2020 6773 2e65    ).        gs.e
+00036740: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+00036750: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00036760: 2074 7279 3a0a 2020 2020 2020 2020 2320   try:.        # 
+00036770: 5365 7420 7570 2065 7665 6e74 2063 616c  Set up event cal
+00036780: 6c62 6163 6b73 0a20 2020 2020 2020 2063  lbacks.        c
+00036790: 616c 6c62 6163 6b73 203d 2043 616c 6c62  allbacks = Callb
+000367a0: 6163 6b73 2867 732e 636c 6965 6e74 290a  acks(gs.client).
+000367b0: 2020 2020 2020 2020 6773 2e63 6c69 656e          gs.clien
+000367c0: 742e 6164 645f 746f 5f64 6576 6963 655f  t.add_to_device_
+000367d0: 6361 6c6c 6261 636b 280a 2020 2020 2020  callback(.      
+000367e0: 2020 2020 2020 6361 6c6c 6261 636b 732e        callbacks.
+000367f0: 746f 5f64 6576 6963 655f 6361 6c6c 6261  to_device_callba
+00036800: 636b 2c20 284b 6579 5665 7269 6669 6361  ck, (KeyVerifica
+00036810: 7469 6f6e 4576 656e 742c 290a 2020 2020  tionEvent,).    
+00036820: 2020 2020 290a 2020 2020 2020 2020 2320      ).        # 
+00036830: 5379 6e63 2065 6e63 7279 7074 696f 6e20  Sync encryption 
+00036840: 6b65 7973 2077 6974 6820 7468 6520 7365  keys with the se
+00036850: 7276 6572 0a20 2020 2020 2020 2023 2052  rver.        # R
+00036860: 6571 7569 7265 6420 666f 7220 7061 7274  equired for part
+00036870: 6963 6970 6174 696e 6720 696e 2065 6e63  icipating in enc
+00036880: 7279 7074 6564 2072 6f6f 6d73 0a20 2020  rypted rooms.   
+00036890: 2020 2020 2069 6620 6773 2e63 6c69 656e       if gs.clien
+000368a0: 742e 7368 6f75 6c64 5f75 706c 6f61 645f  t.should_upload_
+000368b0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+000368c0: 2020 6177 6169 7420 6773 2e63 6c69 656e    await gs.clien
+000368d0: 742e 6b65 7973 5f75 706c 6f61 6428 290a  t.keys_upload().
+000368e0: 2020 2020 2020 2020 7072 696e 7428 0a20          print(. 
+000368f0: 2020 2020 2020 2020 2020 2066 227b 5052             f"{PR
+00036900: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
+00036910: 6973 2072 6561 6479 2061 6e64 2077 6169  is ready and wai
+00036920: 7469 6e67 2066 6f72 2074 6865 206f 7468  ting for the oth
+00036930: 6572 2070 6172 7479 2074 6f20 220a 2020  er party to ".  
+00036940: 2020 2020 2020 2020 2020 2269 6e69 7469            "initi
+00036950: 6174 6520 616e 2065 6d6f 6a69 2076 6572  ate an emoji ver
+00036960: 6966 6963 6174 696f 6e20 7769 7468 2075  ification with u
+00036970: 7320 6279 2073 656c 6563 7469 6e67 2022  s by selecting "
+00036980: 0a20 2020 2020 2020 2020 2020 2022 2756  .            "'V
+00036990: 6572 6966 7920 6279 2045 6d6f 6a69 2720  erify by Emoji' 
+000369a0: 220a 2020 2020 2020 2020 2020 2020 2269  ".            "i
+000369b0: 6e20 7468 6569 7220 4d61 7472 6978 2063  n their Matrix c
+000369c0: 6c69 656e 742e 2052 6561 6420 2d2d 7665  lient. Read --ve
+000369d0: 7269 6679 2069 6e73 7472 7563 7469 6f6e  rify instruction
+000369e0: 7320 696e 202d 2d6d 616e 7561 6c20 220a  s in --manual ".
+000369f0: 2020 2020 2020 2020 2020 2020 2263 6172              "car
+00036a00: 6566 756c 6c79 2074 6f20 6173 7369 7374  efully to assist
+00036a10: 2079 6f75 2069 6e20 686f 7720 746f 2064   you in how to d
+00036a20: 6f20 7468 6973 2071 7569 636b 6c79 2e22  o this quickly."
+00036a30: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+00036a40: 6c65 3d73 7973 2e73 7464 6f75 742c 0a20  le=sys.stdout,. 
+00036a50: 2020 2020 2020 2020 2020 2066 6c75 7368             flush
+00036a60: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
+00036a70: 0a20 2020 2020 2020 2023 2074 6865 2073  .        # the s
+00036a80: 796e 635f 6c6f 6f70 2077 696c 6c20 6265  ync_loop will be
+00036a90: 2074 6572 6d69 6e61 7465 6420 6279 2075   terminated by u
+00036aa0: 7365 7220 6869 7474 696e 6720 436f 6e74  ser hitting Cont
+00036ab0: 726f 6c2d 430a 2020 2020 2020 2020 6177  rol-C.        aw
+00036ac0: 6169 7420 6773 2e63 6c69 656e 742e 7379  ait gs.client.sy
+00036ad0: 6e63 5f66 6f72 6576 6572 2874 696d 656f  nc_forever(timeo
+00036ae0: 7574 3d33 3030 3030 2c20 6675 6c6c 5f73  ut=30000, full_s
+00036af0: 7461 7465 3d54 7275 6529 0a20 2020 2065  tate=True).    e
+00036b00: 7863 6570 7420 4b65 7962 6f61 7264 496e  xcept KeyboardIn
+00036b10: 7465 7272 7570 743a 0a20 2020 2020 2020  terrupt:.       
+00036b20: 2023 2054 6869 7320 7769 6c6c 206e 6576   # This will nev
+00036b30: 6572 2062 6520 6361 7567 6874 2e20 4920  er be caught. I 
+00036b40: 646f 206e 6f74 206b 6e6f 7720 7768 792e  do not know why.
+00036b50: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00036b60: 6465 6275 6728 224b 6579 626f 6172 6420  debug("Keyboard 
+00036b70: 696e 7465 7272 7570 7420 6166 7465 7220  interrupt after 
+00036b80: 456d 6f6a 6920 7665 7269 6669 6361 7469  Emoji verificati
+00036b90: 6f6e 2e22 290a 2020 2020 6578 6365 7074  on.").    except
+00036ba0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+00036bb0: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+00036bc0: 6572 726f 7228 0a20 2020 2020 2020 2020  error(.         
+00036bd0: 2020 2022 4532 3137 3a20 220a 2020 2020     "E217: ".    
+00036be0: 2020 2020 2020 2020 2245 7272 6f72 2064          "Error d
+00036bf0: 7572 696e 6720 7665 7269 6679 2e20 436f  uring verify. Co
+00036c00: 6e74 696e 7569 6e67 2064 6573 7069 7465  ntinuing despite
+00036c10: 2065 7272 6f72 2e20 220a 2020 2020 2020   error. ".      
+00036c20: 2020 2020 2020 6622 4578 6365 7074 696f        f"Exceptio
+00036c30: 6e3a 207b 657d 220a 2020 2020 2020 2020  n: {e}".        
+00036c40: 290a 2020 2020 2020 2020 6773 2e65 7272  ).        gs.err
+00036c50: 5f63 6f75 6e74 202b 3d20 310a 0a0a 6173  _count += 1...as
+00036c60: 796e 6320 6465 6620 6163 7469 6f6e 5f73  ync def action_s
+00036c70: 656e 6428 2920 2d3e 204e 6f6e 653a 0a20  end() -> None:. 
+00036c80: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
+00036c90: 6765 7320 7768 696c 6520 616c 7265 6164  ges while alread
+00036ca0: 7920 6c6f 6767 6564 2069 6e2e 2222 220a  y logged in.""".
+00036cb0: 2020 2020 6966 206e 6f74 2067 732e 636c      if not gs.cl
+00036cc0: 6965 6e74 2061 6e64 206e 6f74 2067 732e  ient and not gs.
+00036cd0: 6372 6564 656e 7469 616c 733a 0a20 2020  credentials:.   
+00036ce0: 2020 2020 2067 732e 6c6f 672e 6572 726f       gs.log.erro
+00036cf0: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+00036d00: 4532 3138 3a20 2220 2243 6c69 656e 7420  E218: " "Client 
+00036d10: 6f72 2063 7265 6465 6e74 6961 6c73 206e  or credentials n
+00036d20: 6f74 2073 6574 2e20 536b 6970 7069 6e67  ot set. Skipping
+00036d30: 2061 6374 696f 6e2e 220a 2020 2020 2020   action.".      
+00036d40: 2020 290a 2020 2020 2020 2020 6773 2e65    ).        gs.e
+00036d50: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
+00036d60: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00036d70: 2074 7279 3a0a 2020 2020 2020 2020 2320   try:.        # 
+00036d80: 6120 6665 7720 6d6f 7265 2073 7465 7073  a few more steps
+00036d90: 2074 6f20 7072 6570 6172 6520 666f 7220   to prepare for 
+00036da0: 7365 6e64 696e 6720 6d65 7373 6167 6573  sending messages
+00036db0: 0a20 2020 2020 2020 2072 6f6f 6d73 203d  .        rooms =
+00036dc0: 2061 7761 6974 2064 6574 6572 6d69 6e65   await determine
+00036dd0: 5f72 6f6f 6d73 280a 2020 2020 2020 2020  _rooms(.        
+00036de0: 2020 2020 6773 2e63 7265 6465 6e74 6961      gs.credentia
+00036df0: 6c73 5b22 726f 6f6d 5f69 6422 5d2c 2067  ls["room_id"], g
+00036e00: 732e 636c 6965 6e74 2c20 6773 2e63 7265  s.client, gs.cre
+00036e10: 6465 6e74 6961 6c73 0a20 2020 2020 2020  dentials.       
+00036e20: 2029 0a20 2020 2020 2020 2067 732e 6c6f   ).        gs.lo
+00036e30: 672e 6465 6275 6728 6622 526f 6f6d 7320  g.debug(f"Rooms 
+00036e40: 6172 653a 207b 726f 6f6d 737d 2229 0a20  are: {rooms}"). 
+00036e50: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00036e60: 6275 6728 6622 6773 2e63 6c69 656e 742e  bug(f"gs.client.
+00036e70: 726f 6f6d 7320 6172 653a 207b 6773 2e63  rooms are: {gs.c
+00036e80: 6c69 656e 742e 726f 6f6d 737d 2229 0a20  lient.rooms}"). 
+00036e90: 2020 2020 2020 2023 2053 796e 6320 656e         # Sync en
+00036ea0: 6372 7970 7469 6f6e 206b 6579 7320 7769  cryption keys wi
+00036eb0: 7468 2074 6865 2073 6572 7665 720a 2020  th the server.  
+00036ec0: 2020 2020 2020 2320 5265 7175 6972 6564        # Required
+00036ed0: 2066 6f72 2070 6172 7469 6369 7061 7469   for participati
+00036ee0: 6e67 2069 6e20 656e 6372 7970 7465 6420  ng in encrypted 
+00036ef0: 726f 6f6d 730a 2020 2020 2020 2020 6966  rooms.        if
+00036f00: 2067 732e 636c 6965 6e74 2e73 686f 756c   gs.client.shoul
+00036f10: 645f 7570 6c6f 6164 5f6b 6579 733a 0a20  d_upload_keys:. 
+00036f20: 2020 2020 2020 2020 2020 2067 732e 6c6f             gs.lo
+00036f30: 672e 6465 6275 6728 2253 7461 7274 696e  g.debug("Startin
+00036f40: 6720 6b65 7973 5f75 706c 6f61 6422 290a  g keys_upload").
+00036f50: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00036f60: 7420 6773 2e63 6c69 656e 742e 6b65 7973  t gs.client.keys
+00036f70: 5f75 706c 6f61 6428 290a 2020 2020 2020  _upload().      
+00036f80: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00036f90: 7567 2822 4669 6e69 7368 6564 206b 6579  ug("Finished key
+00036fa0: 735f 7570 6c6f 6164 2229 0a20 2020 2020  s_upload").     
+00036fb0: 2020 2069 6620 6773 2e70 612e 7379 6e63     if gs.pa.sync
+00036fc0: 203d 3d20 5359 4e43 5f4f 4646 3a0a 2020   == SYNC_OFF:.  
+00036fd0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00036fe0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00036ff0: 2020 2020 2020 2020 6622 4475 6520 746f          f"Due to
+00037000: 2027 2d2d 7379 6e63 207b 5359 4e43 5f4f   '--sync {SYNC_O
+00037010: 4646 7d27 206f 7074 696f 6e2c 2073 796e  FF}' option, syn
+00037020: 6328 2920 7769 6c6c 2062 6520 736b 6970  c() will be skip
+00037030: 7065 642e 220a 2020 2020 2020 2020 2020  ped.".          
+00037040: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00037050: 2320 5072 6566 696c 6c20 726f 6f6d 7320  # Prefill rooms 
+00037060: 6173 206f 7574 6c69 6e65 6420 696e 2049  as outlined in I
+00037070: 7373 7565 2023 3931 0a20 2020 2020 2020  ssue #91.       
+00037080: 2020 2020 2023 2053 696e 6365 2073 796e       # Since syn
+00037090: 6328 2920 6973 206e 6f74 2063 616c 6c65  c() is not calle
+000370a0: 6420 7765 204d 5553 5420 6669 6c6c 2069  d we MUST fill i
+000370b0: 6e20 7468 6520 726f 6f6d 7320 6d61 6e75  n the rooms manu
+000370c0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+000370d0: 2020 2320 5468 6973 206c 696e 6520 7761    # This line wa
+000370e0: 7320 7375 6767 6573 7465 6420 6173 2077  s suggested as w
+000370f0: 6f72 6b61 726f 756e 643a 0a20 2020 2020  orkaround:.     
+00037100: 2020 2020 2020 2023 2061 7379 6e63 5f63         # async_c
+00037110: 6c69 656e 742e 726f 6f6d 735b 726f 6f6d  lient.rooms[room
+00037120: 5f69 645d 203d 206e 696f 2e72 6f6f 6d73  _id] = nio.rooms
+00037130: 2e4d 6174 7269 7852 6f6f 6d28 0a20 2020  .MatrixRoom(.   
+00037140: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00037150: 2020 2020 726f 6f6d 5f69 643d 726f 6f6d      room_id=room
+00037160: 5f69 642c 206f 776e 5f75 7365 725f 6964  _id, own_user_id
+00037170: 3d75 7365 725f 6964 2c20 656e 6372 7970  =user_id, encryp
+00037180: 7465 643d 5472 7565 290a 2020 2020 2020  ted=True).      
+00037190: 2020 2020 2020 2320 5765 206d 7573 7420        # We must 
+000371a0: 616c 736f 206d 6170 2072 6f6f 6d20 616c  also map room al
+000371b0: 6961 7365 7320 746f 2072 6f6f 6d20 6964  iases to room id
+000371c0: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
+000371d0: 6f72 2072 6f6f 6d5f 6964 2069 6e20 726f  or room_id in ro
+000371e0: 6f6d 733a 0a20 2020 2020 2020 2020 2020  oms:.           
+000371f0: 2020 2020 2072 6f6f 6d5f 6964 203d 2061       room_id = a
+00037200: 7761 6974 206d 6170 5f72 6f6f 6d69 6e66  wait map_roominf
+00037210: 6f5f 746f 5f72 6f6f 6d69 6428 6773 2e63  o_to_roomid(gs.c
+00037220: 6c69 656e 742c 2072 6f6f 6d5f 6964 290a  lient, room_id).
+00037230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037240: 6773 2e63 6c69 656e 742e 726f 6f6d 735b  gs.client.rooms[
+00037250: 726f 6f6d 5f69 645d 203d 204d 6174 7269  room_id] = Matri
+00037260: 7852 6f6f 6d28 0a20 2020 2020 2020 2020  xRoom(.         
+00037270: 2020 2020 2020 2020 2020 2072 6f6f 6d5f             room_
+00037280: 6964 3d72 6f6f 6d5f 6964 2c0a 2020 2020  id=room_id,.    
+00037290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000372a0: 6f77 6e5f 7573 6572 5f69 643d 6773 2e63  own_user_id=gs.c
+000372b0: 7265 6465 6e74 6961 6c73 5b22 7573 6572  redentials["user
+000372c0: 5f69 6422 5d2c 0a20 2020 2020 2020 2020  _id"],.         
+000372d0: 2020 2020 2020 2020 2020 2065 6e63 7279             encry
+000372e0: 7074 6564 3d54 7275 652c 0a20 2020 2020  pted=True,.     
+000372f0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00037300: 2020 2020 2065 6c73 653a 2020 2320 5359       else:  # SY
+00037310: 4e43 5f46 554c 4c0a 2020 2020 2020 2020  NC_FULL.        
+00037320: 2020 2020 2320 4465 6661 756c 7420 6361      # Default ca
+00037330: 7365 2c20 7374 616e 6461 7264 3a0a 2020  se, standard:.  
+00037340: 2020 2020 2020 2020 2020 2320 4f6e 6520            # One 
+00037350: 6d75 7374 2073 796e 6320 6669 7273 7420  must sync first 
+00037360: 746f 2067 6574 2072 6f6f 6d20 6964 7320  to get room ids 
+00037370: 666f 7220 656e 6372 7970 7465 6420 726f  for encrypted ro
+00037380: 6f6d 730a 2020 2020 2020 2020 2020 2020  oms.            
+00037390: 2320 7369 6e63 6520 7765 206f 6e6c 7920  # since we only 
+000373a0: 7365 6e64 2061 206d 7367 2061 6e64 2074  send a msg and t
+000373b0: 6865 6e20 7374 6f70 2c0a 2020 2020 2020  hen stop,.      
+000373c0: 2020 2020 2020 2320 7765 2063 616e 2075        # we can u
+000373d0: 7365 2073 796e 6328 2920 696e 7374 6561  se sync() instea
+000373e0: 6420 6f66 2073 796e 635f 666f 7265 7665  d of sync_foreve
+000373f0: 7228 292e 0a20 2020 2020 2020 2020 2020  r()..           
+00037400: 2066 756c 6c5f 7374 6174 6520 3d20 5472   full_state = Tr
+00037410: 7565 0a20 2020 2020 2020 2020 2020 2067  ue.            g
+00037420: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+00037430: 2020 2020 2020 2020 2020 2020 2066 2253               f"S
+00037440: 7461 7274 696e 6720 7379 6e63 2866 756c  tarting sync(ful
+00037450: 6c5f 7374 6174 653d 7b66 756c 6c5f 7374  l_state={full_st
+00037460: 6174 657d 2920 220a 2020 2020 2020 2020  ate}) ".        
+00037470: 2020 2020 2020 2020 2274 6f20 7379 6e63          "to sync
+00037480: 6872 6f6e 697a 6520 6576 656e 7473 2077  hronize events w
+00037490: 6974 6820 7365 7276 6572 2e22 0a20 2020  ith server.".   
+000374a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000374b0: 2020 2020 2020 2061 7761 6974 2067 732e         await gs.
+000374c0: 636c 6965 6e74 2e73 796e 6328 7469 6d65  client.sync(time
+000374d0: 6f75 743d 3330 3030 302c 2066 756c 6c5f  out=30000, full_
+000374e0: 7374 6174 653d 6675 6c6c 5f73 7461 7465  state=full_state
+000374f0: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
+00037500: 2e6c 6f67 2e64 6562 7567 2822 4669 6e69  .log.debug("Fini
+00037510: 7368 6564 2073 796e 6328 2920 7769 7468  shed sync() with
+00037520: 2073 6572 7665 722e 2229 0a20 2020 2020   server.").     
+00037530: 2020 2023 204e 6f77 2077 6520 6361 6e20     # Now we can 
+00037540: 7365 6e64 206d 6573 7361 6765 7320 6173  send messages as
+00037550: 2074 6865 2075 7365 720a 2020 2020 2020   the user.      
+00037560: 2020 6177 6169 7420 7072 6f63 6573 735f    await process_
+00037570: 6172 6775 6d65 6e74 735f 616e 645f 696e  arguments_and_in
+00037580: 7075 7428 6773 2e63 6c69 656e 742c 2072  put(gs.client, r
+00037590: 6f6f 6d73 290a 2020 2020 2020 2020 2320  ooms).        # 
+000375a0: 6773 2e6c 6f67 2e64 6562 7567 2866 2267  gs.log.debug(f"g
+000375b0: 732e 636c 6965 6e74 2e72 6f6f 6d73 2061  s.client.rooms a
+000375c0: 7265 3a20 7b67 732e 636c 6965 6e74 2e72  re: {gs.client.r
+000375d0: 6f6f 6d73 7d22 290a 2020 2020 2020 2020  ooms}").        
+000375e0: 6773 2e6c 6f67 2e64 6562 7567 2822 4d65  gs.log.debug("Me
+000375f0: 7373 6167 6520 7365 6e64 2061 6374 696f  ssage send actio
+00037600: 6e20 6669 6e69 7368 6564 2e22 290a 2020  n finished.").  
+00037610: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00037620: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00037630: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00037640: 2020 2020 2020 2020 2020 2022 4532 3139             "E219
+00037650: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00037660: 2245 7272 6f72 2064 7572 696e 6720 7365  "Error during se
+00037670: 6e64 696e 672e 2043 6f6e 7469 6e75 696e  nding. Continuin
+00037680: 6720 6465 7370 6974 6520 6572 726f 722e  g despite error.
+00037690: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+000376a0: 2245 7863 6570 7469 6f6e 3a20 7b65 7d22  "Exception: {e}"
+000376b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000376c0: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+000376d0: 2b3d 2031 0a0a 0a61 7379 6e63 2064 6566  += 1...async def
+000376e0: 2061 6374 696f 6e5f 6c6f 676f 7574 2829   action_logout()
+000376f0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00037700: 224c 6f67 206f 7574 206f 6e65 206f 7220  "Log out one or 
+00037710: 616c 6c20 6465 7669 6365 7320 6672 6f6d  all devices from
+00037720: 204d 6174 7269 7820 7365 7276 6572 2e22   Matrix server."
+00037730: 2222 0a20 2020 2069 6620 6e6f 7420 6773  "".    if not gs
+00037740: 2e63 6c69 656e 7420 616e 6420 6e6f 7420  .client and not 
+00037750: 6773 2e63 7265 6465 6e74 6961 6c73 3a0a  gs.credentials:.
+00037760: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00037770: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00037780: 2020 2245 3232 303a 2022 2022 436c 6965    "E220: " "Clie
+00037790: 6e74 206f 7220 6372 6564 656e 7469 616c  nt or credential
+000377a0: 7320 6e6f 7420 7365 742e 2053 6b69 7070  s not set. Skipp
+000377b0: 696e 6720 6163 7469 6f6e 2e22 0a20 2020  ing action.".   
+000377c0: 2020 2020 2029 0a20 2020 2020 2020 2067       ).        g
+000377d0: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+000377e0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+000377f0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00037800: 2064 6576 6963 6520 3d20 6773 2e70 612e   device = gs.pa.
+00037810: 6c6f 676f 7574 2e6c 6f77 6572 2829 0a20  logout.lower(). 
+00037820: 2020 2020 2020 2069 6620 6465 7669 6365         if device
+00037830: 203d 3d20 226d 6522 3a0a 2020 2020 2020   == "me":.      
+00037840: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00037850: 7567 2866 222d 2d6c 6f67 6f75 7420 6861  ug(f"--logout ha
+00037860: 7320 6368 6f73 656e 2074 6f20 6c6f 6720  s chosen to log 
+00037870: 6f75 7420 6465 7669 6365 207b 6465 7669  out device {devi
+00037880: 6365 7d22 290a 2020 2020 2020 2020 2020  ce}").          
+00037890: 2020 616c 6c5f 6465 7669 6365 7320 3d20    all_devices = 
+000378a0: 4661 6c73 650a 2020 2020 2020 2020 656c  False.        el
+000378b0: 6966 2064 6576 6963 6520 3d3d 2022 616c  if device == "al
+000378c0: 6c22 3a0a 2020 2020 2020 2020 2020 2020  l":.            
+000378d0: 6773 2e6c 6f67 2e64 6562 7567 2866 222d  gs.log.debug(f"-
+000378e0: 2d6c 6f67 6f75 7420 6861 7320 6368 6f73  -logout has chos
+000378f0: 656e 2074 6f20 6c6f 6720 6f75 7420 6465  en to log out de
+00037900: 7669 6365 7320 7b64 6576 6963 657d 2229  vices {device}")
+00037910: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+00037920: 5f64 6576 6963 6573 203d 2054 7275 650a  _devices = True.
+00037930: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00037940: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
+00037950: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+00037960: 2020 2020 2020 2020 2245 3232 313a 2022          "E221: "
+00037970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037980: 2022 4572 726f 7220 6475 7269 6e67 206c   "Error during l
+00037990: 6f67 6f75 742e 204f 6e6c 7920 276d 6527  ogout. Only 'me'
+000379a0: 2061 6e64 2027 616c 6c27 2061 7265 2073   and 'all' are s
+000379b0: 7570 706f 7274 6564 2e20 220a 2020 2020  upported. ".    
+000379c0: 2020 2020 2020 2020 2020 2020 6622 4275              f"Bu
+000379d0: 7420 666f 756e 6420 2d2d 6c6f 676f 7574  t found --logout
+000379e0: 2027 7b64 6576 6963 657d 272e 2043 6f6e   '{device}'. Con
+000379f0: 7469 6e75 696e 6720 6465 7370 6974 6520  tinuing despite 
+00037a00: 6572 726f 722e 2022 0a20 2020 2020 2020  error. ".       
+00037a10: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00037a20: 2020 2067 732e 6572 725f 636f 756e 7420     gs.err_count 
+00037a30: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00037a40: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00037a50: 7265 7370 203d 2061 7761 6974 2067 732e  resp = await gs.
+00037a60: 636c 6965 6e74 2e6c 6f67 6f75 7428 616c  client.logout(al
+00037a70: 6c5f 6465 7669 6365 7329 0a20 2020 2020  l_devices).     
+00037a80: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00037a90: 2872 6573 702c 204c 6f67 6f75 7445 7272  (resp, LogoutErr
+00037aa0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00037ab0: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+00037ac0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00037ad0: 4532 3232 3a20 220a 2020 2020 2020 2020  E222: ".        
+00037ae0: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
+00037af0: 2074 6f20 6c6f 676f 7574 207b 6465 7669   to logout {devi
+00037b00: 6365 7d2e 2052 6573 706f 6e73 653a 2022  ce}. Response: "
+00037b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037b20: 2066 227b 7072 6976 6163 795f 6669 6c74   f"{privacy_filt
+00037b30: 6572 2873 7472 2872 6573 7029 297d 220a  er(str(resp))}".
+00037b40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00037b50: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00037b60: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00037b70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00037b80: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+00037b90: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00037ba0: 2020 2020 6622 6c6f 676f 7574 2073 7563      f"logout suc
+00037bb0: 6365 7373 6675 6c2e 2052 6573 706f 6e73  cessful. Respons
+00037bc0: 6520 6973 3a20 7b70 7269 7661 6379 5f66  e is: {privacy_f
+00037bd0: 696c 7465 7228 7374 7228 7265 7370 2929  ilter(str(resp))
+00037be0: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+00037bf0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+00037c00: 6c6f 672e 696e 666f 2866 2253 7563 6365  log.info(f"Succe
+00037c10: 7373 6675 6c6c 7920 6c6f 6767 6564 206f  ssfully logged o
+00037c20: 7574 207b 6465 7669 6365 7d2e 2229 0a0a  ut {device}.")..
+00037c30: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00037c40: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00037c50: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+00037c60: 0a20 2020 2020 2020 2020 2020 2022 4532  .            "E2
+00037c70: 3233 3a20 220a 2020 2020 2020 2020 2020  23: ".          
+00037c80: 2020 2245 7272 6f72 2064 7572 696e 6720    "Error during 
+00037c90: 6c6f 676f 7574 2e20 436f 6e74 696e 7569  logout. Continui
+00037ca0: 6e67 2064 6573 7069 7465 2065 7272 6f72  ng despite error
+00037cb0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+00037cc0: 6622 4578 6365 7074 696f 6e3a 207b 657d  f"Exception: {e}
+00037cd0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00037ce0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+00037cf0: 202b 3d20 310a 0a0a 6173 796e 6320 6465   += 1...async de
+00037d00: 6620 6163 7469 6f6e 5f6c 6f67 696e 2829  f action_login()
+00037d10: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00037d20: 224c 6f67 2069 6e20 7573 696e 6720 5353  "Log in using SS
+00037d30: 4f20 6f72 2070 6173 7377 6f72 642c 2063  O or password, c
+00037d40: 7265 6174 6520 6372 6564 656e 7469 616c  reate credential
+00037d50: 7320 6669 6c65 2c20 6372 6561 7465 2073  s file, create s
+00037d60: 746f 7265 2c0a 2020 2020 616e 6420 7265  tore,.    and re
+00037d70: 6d61 696e 206c 6f67 6765 6420 696e 2e0a  main logged in..
+00037d80: 2020 2020 2222 220a 2020 2020 6372 6564      """.    cred
+00037d90: 656e 7469 616c 735f 6669 6c65 203d 2064  entials_file = d
+00037da0: 6574 6572 6d69 6e65 5f63 7265 6465 6e74  etermine_credent
+00037db0: 6961 6c73 5f66 696c 6528 290a 2020 2020  ials_file().    
+00037dc0: 6966 2063 7265 6465 6e74 6961 6c73 5f65  if credentials_e
+00037dd0: 7869 7374 2863 7265 6465 6e74 6961 6c73  xist(credentials
+00037de0: 5f66 696c 6529 3a0a 2020 2020 2020 2020  _file):.        
+00037df0: 7261 6973 6520 4d61 7472 6978 436f 6d6d  raise MatrixComm
+00037e00: 616e 6465 7245 7272 6f72 280a 2020 2020  anderError(.    
+00037e10: 2020 2020 2020 2020 2245 3232 343a 2022          "E224: "
+00037e20: 0a20 2020 2020 2020 2020 2020 2022 2d2d  .            "--
+00037e30: 6c6f 6769 6e20 7761 7320 7573 6564 2062  login was used b
+00037e40: 7574 2063 7265 6465 6e74 6961 6c73 2061  ut credentials a
+00037e50: 6c72 6561 6479 2065 7869 7374 2022 0a20  lready exist ". 
+00037e60: 2020 2020 2020 2020 2020 2066 2269 6e20             f"in 
+00037e70: 277b 6372 6564 656e 7469 616c 735f 6669  '{credentials_fi
+00037e80: 6c65 7d27 2e22 0a20 2020 2020 2020 2029  le}'.".        )
+00037e90: 2066 726f 6d20 4e6f 6e65 0a20 2020 2073   from None.    s
+00037ea0: 746f 7265 5f64 6972 203d 2064 6574 6572  tore_dir = deter
+00037eb0: 6d69 6e65 5f73 746f 7265 5f64 6972 2829  mine_store_dir()
+00037ec0: 0a20 2020 2069 6620 7374 6f72 655f 6578  .    if store_ex
+00037ed0: 6973 7473 2873 746f 7265 5f64 6972 293a  ists(store_dir):
+00037ee0: 0a20 2020 2020 2020 2072 6169 7365 204d  .        raise M
+00037ef0: 6174 7269 7843 6f6d 6d61 6e64 6572 4572  atrixCommanderEr
+00037f00: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00037f10: 2022 4532 3235 3a20 220a 2020 2020 2020   "E225: ".      
+00037f20: 2020 2020 2020 6622 2d2d 6c6f 6769 6e20        f"--login 
+00037f30: 7761 7320 7573 6564 2062 7574 2073 746f  was used but sto
+00037f40: 7265 2061 6c72 6561 6479 2065 7869 7374  re already exist
+00037f50: 7320 696e 2027 7b73 746f 7265 5f64 6972  s in '{store_dir
+00037f60: 7d27 2e22 0a20 2020 2020 2020 2029 2066  }'.".        ) f
+00037f70: 726f 6d20 4e6f 6e65 0a20 2020 206d 6574  rom None.    met
+00037f80: 686f 6420 3d20 6773 2e70 612e 6c6f 6769  hod = gs.pa.logi
+00037f90: 6e2e 6c6f 7765 7228 290a 2020 2020 696e  n.lower().    in
+00037fa0: 7465 7261 6374 6976 6520 3d20 4661 6c73  teractive = Fals
+00037fb0: 650a 2020 2020 6966 206d 6574 686f 6420  e.    if method 
+00037fc0: 3d3d 2022 7061 7373 776f 7264 223a 0a20  == "password":. 
+00037fd0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+00037fe0: 6275 6728 222d 2d6c 6f67 696e 2068 6173  bug("--login has
+00037ff0: 2063 686f 7365 6e20 7061 7373 776f 7264   chosen password
+00038000: 206d 6574 686f 6420 666f 7220 6175 7468   method for auth
+00038010: 656e 7469 6361 7469 6f6e 2229 0a20 2020  entication").   
+00038020: 2065 6c69 6620 6d65 7468 6f64 203d 3d20   elif method == 
+00038030: 2273 736f 223a 0a20 2020 2020 2020 2067  "sso":.        g
+00038040: 732e 6c6f 672e 6465 6275 6728 222d 2d6c  s.log.debug("--l
+00038050: 6f67 696e 2068 6173 2063 686f 7365 6e20  ogin has chosen 
+00038060: 5353 4f20 6d65 7468 6f64 2066 6f72 2061  SSO method for a
+00038070: 7574 6865 6e74 6963 6174 696f 6e22 290a  uthentication").
+00038080: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00038090: 2020 7261 6973 6520 4d61 7472 6978 436f    raise MatrixCo
+000380a0: 6d6d 616e 6465 7245 7272 6f72 280a 2020  mmanderError(.  
+000380b0: 2020 2020 2020 2020 2020 2245 3232 363a            "E226:
+000380c0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+000380d0: 2d2d 6c6f 6769 6e20 7370 6563 6966 6965  --login specifie
+000380e0: 7320 696e 7661 6c69 6420 6175 7468 656e  s invalid authen
+000380f0: 7469 6361 7469 6e20 6d65 7468 6f64 2022  ticatin method "
+00038100: 0a20 2020 2020 2020 2020 2020 2066 2227  .            f"'
+00038110: 7b6d 6574 686f 647d 272e 204f 6e6c 7920  {method}'. Only 
+00038120: 2770 6173 7377 6f72 6427 2061 6e64 2027  'password' and '
+00038130: 7373 6f27 2061 6c6c 6f77 6564 2e22 0a20  sso' allowed.". 
+00038140: 2020 2020 2020 2029 2066 726f 6d20 4e6f         ) from No
+00038150: 6e65 0a20 2020 2069 6620 6773 2e70 612e  ne.    if gs.pa.
+00038160: 686f 6d65 7365 7276 6572 3a0a 2020 2020  homeserver:.    
+00038170: 2020 2020 686f 6d65 7365 7276 6572 203d      homeserver =
+00038180: 2067 732e 7061 2e68 6f6d 6573 6572 7665   gs.pa.homeserve
+00038190: 720a 2020 2020 656c 7365 3a0a 2020 2020  r.    else:.    
+000381a0: 2020 2020 696e 7465 7261 6374 6976 6520      interactive 
+000381b0: 3d20 5472 7565 0a20 2020 2020 2020 2068  = True.        h
+000381c0: 6f6d 6573 6572 7665 7220 3d20 2268 7474  omeserver = "htt
+000381d0: 7073 3a2f 2f6d 6174 7269 782e 6578 616d  ps://matrix.exam
+000381e0: 706c 652e 6f72 6722 0a20 2020 2020 2020  ple.org".       
+000381f0: 2068 6f6d 6573 6572 7665 7220 3d20 696e   homeserver = in
+00038200: 7075 7428 6622 456e 7465 7220 5552 4c20  put(f"Enter URL 
+00038210: 6f66 2079 6f75 7220 686f 6d65 7365 7276  of your homeserv
+00038220: 6572 3a20 5b7b 686f 6d65 7365 7276 6572  er: [{homeserver
+00038230: 7d5d 2022 290a 2020 2020 2020 2020 6966  }] ").        if
+00038240: 206e 6f74 2068 6f6d 6573 6572 7665 723a   not homeserver:
+00038250: 0a20 2020 2020 2020 2020 2020 2068 6f6d  .            hom
+00038260: 6573 6572 7665 7220 3d20 2268 7474 7073  eserver = "https
+00038270: 3a2f 2f6d 6174 7269 782e 6f72 6722 2020  ://matrix.org"  
+00038280: 2320 6265 7474 6572 2065 7272 6f72 206d  # better error m
+00038290: 7367 206c 6174 6572 0a20 2020 2069 6620  sg later.    if 
+000382a0: 6e6f 7420 280a 2020 2020 2020 2020 686f  not (.        ho
+000382b0: 6d65 7365 7276 6572 2e73 7461 7274 7377  meserver.startsw
+000382c0: 6974 6828 2268 7474 7073 3a2f 2f22 2920  ith("https://") 
+000382d0: 6f72 2068 6f6d 6573 6572 7665 722e 7374  or homeserver.st
+000382e0: 6172 7473 7769 7468 2822 6874 7470 3a2f  artswith("http:/
+000382f0: 2f22 290a 2020 2020 293a 0a20 2020 2020  /").    ):.     
+00038300: 2020 2068 6f6d 6573 6572 7665 7220 3d20     homeserver = 
+00038310: 2268 7474 7073 3a2f 2f22 202b 2068 6f6d  "https://" + hom
+00038320: 6573 6572 7665 720a 2020 2020 686f 6d65  eserver.    home
+00038330: 7365 7276 6572 5f73 686f 7274 203d 2075  server_short = u
+00038340: 726c 7061 7273 6528 686f 6d65 7365 7276  rlparse(homeserv
+00038350: 6572 292e 686f 7374 6e61 6d65 2020 2320  er).hostname  # 
+00038360: 6d61 7472 6978 2e65 7861 6d70 6c65 2e6f  matrix.example.o
+00038370: 7267 0a0a 2020 2020 2320 466f 7220 5353  rg..    # For SS
+00038380: 4f20 6c6f 6769 6e2c 2075 7365 725f 6964  O login, user_id
+00038390: 2069 7320 6e6f 7420 6e65 6564 6564 2e20   is not needed. 
+000383a0: 4275 7420 6d61 7472 6978 2d63 6f6d 6d61  But matrix-comma
+000383b0: 6e64 6572 206e 6565 6473 0a20 2020 2023  nder needs.    #
+000383c0: 2075 7365 725f 6964 2066 6f72 2063 7265   user_id for cre
+000383d0: 6465 6e74 6961 6c73 2066 6f72 2061 7267  dentials for arg
+000383e0: 756d 656e 7473 206c 696b 6520 2d2d 7768  uments like --wh
+000383f0: 6f61 6d69 2e0a 2020 2020 2320 466f 7220  oami..    # For 
+00038400: 5353 4f2c 2077 6520 6765 7420 7468 6520  SSO, we get the 
+00038410: 7573 6572 5f69 6420 6672 6f6d 206c 6f67  user_id from log
+00038420: 696e 2829 2041 5049 2063 616c 6c2c 2069  in() API call, i
+00038430: 2e65 2e20 6672 6f6d 2073 6572 7665 722e  .e. from server.
+00038440: 0a20 2020 2069 6620 6773 2e70 612e 7573  .    if gs.pa.us
+00038450: 6572 5f6c 6f67 696e 3a0a 2020 2020 2020  er_login:.      
+00038460: 2020 7573 6572 5f69 6420 3d20 6773 2e70    user_id = gs.p
+00038470: 612e 7573 6572 5f6c 6f67 696e 0a20 2020  a.user_login.   
+00038480: 2065 6c73 653a 0a20 2020 2020 2020 2075   else:.        u
+00038490: 7365 725f 6964 203d 204e 6f6e 650a 2020  ser_id = None.  
+000384a0: 2020 6966 206d 6574 686f 6420 3d3d 2022    if method == "
+000384b0: 7061 7373 776f 7264 2220 616e 6420 6e6f  password" and no
+000384c0: 7420 7573 6572 5f69 643a 0a20 2020 2020  t user_id:.     
+000384d0: 2020 2069 6e74 6572 6163 7469 7665 203d     interactive =
+000384e0: 2054 7275 650a 2020 2020 2020 2020 7573   True.        us
+000384f0: 6572 5f69 6420 3d20 2240 6a6f 686e 3a65  er_id = "@john:e
+00038500: 7861 6d70 6c65 2e6f 7267 220a 2020 2020  xample.org".    
+00038510: 2020 2020 7573 6572 5f69 6432 203d 2022      user_id2 = "
+00038520: 406a 6f68 6e3a 2220 2b20 686f 6d65 7365  @john:" + homese
+00038530: 7276 6572 5f73 686f 7274 0a20 2020 2020  rver_short.     
+00038540: 2020 2075 7365 725f 6964 203d 2069 6e70     user_id = inp
+00038550: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+00038560: 6622 456e 7465 7220 796f 7572 2075 7365  f"Enter your use
+00038570: 7220 4944 3a20 205b 7b75 7365 725f 6964  r ID:  [{user_id
+00038580: 7d5d 2020 6f72 2020 5b6a 6f68 6e5d 2066  }]  or  [john] f
+00038590: 6f72 207b 7573 6572 5f69 6432 7d20 3a20  or {user_id2} : 
+000385a0: 220a 2020 2020 2020 2020 292e 7374 7269  ".        ).stri
+000385b0: 7028 290a 2020 2020 6966 206d 6574 686f  p().    if metho
+000385c0: 6420 3d3d 2022 7061 7373 776f 7264 223a  d == "password":
+000385d0: 0a20 2020 2020 2020 2069 6620 6773 2e70  .        if gs.p
+000385e0: 612e 7061 7373 776f 7264 3a0a 2020 2020  a.password:.    
+000385f0: 2020 2020 2020 2020 7061 7373 776f 7264          password
+00038600: 203d 2067 732e 7061 2e70 6173 7377 6f72   = gs.pa.passwor
+00038610: 640a 2020 2020 2020 2020 656c 7365 3a0a  d.        else:.
+00038620: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00038630: 7261 6374 6976 6520 3d20 5472 7565 0a20  ractive = True. 
+00038640: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00038650: 2822 506c 6561 7365 2070 726f 7669 6465  ("Please provide
+00038660: 2079 6f75 7220 4d61 7472 6978 2061 6363   your Matrix acc
+00038670: 6f75 6e74 2070 6173 7377 6f72 642e 2229  ount password.")
+00038680: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00038690: 7377 6f72 6420 3d20 6765 7470 6173 732e  sword = getpass.
+000386a0: 6765 7470 6173 7328 290a 2020 2020 656c  getpass().    el
+000386b0: 6966 206d 6574 686f 6420 3d3d 2022 7373  if method == "ss
+000386c0: 6f22 3a0a 2020 2020 2020 2020 7061 7373  o":.        pass
+000386d0: 776f 7264 203d 204e 6f6e 650a 2020 2020  word = None.    
+000386e0: 6966 2067 732e 7061 2e64 6576 6963 6520  if gs.pa.device 
+000386f0: 6973 206e 6f74 204e 6f6e 653a 2020 2320  is not None:  # 
+00038700: 736f 6d65 7468 696e 6720 7761 7320 7370  something was sp
+00038710: 6563 6966 6965 640a 2020 2020 2020 2020  ecified.        
+00038720: 6465 7669 6365 5f6e 616d 6520 3d20 6773  device_name = gs
+00038730: 2e70 612e 6465 7669 6365 2e73 7472 6970  .pa.device.strip
+00038740: 2829 0a20 2020 2020 2020 2069 6620 6465  ().        if de
+00038750: 7669 6365 5f6e 616d 6520 3d3d 2022 223a  vice_name == "":
+00038760: 0a20 2020 2020 2020 2020 2020 2064 6576  .            dev
+00038770: 6963 655f 6e61 6d65 203d 2050 524f 475f  ice_name = PROG_
+00038780: 5749 5448 4f55 545f 4558 5420 2023 2064  WITHOUT_EXT  # d
+00038790: 6566 6175 6c74 0a20 2020 2065 6c73 653a  efault.    else:
+000387a0: 0a20 2020 2020 2020 2069 6e74 6572 6163  .        interac
+000387b0: 7469 7665 203d 2054 7275 650a 2020 2020  tive = True.    
+000387c0: 2020 2020 6465 7669 6365 5f6e 616d 6520      device_name 
+000387d0: 3d20 5052 4f47 5f57 4954 484f 5554 5f45  = PROG_WITHOUT_E
+000387e0: 5854 0a20 2020 2020 2020 2064 6576 6963  XT.        devic
+000387f0: 655f 6e61 6d65 203d 2069 6e70 7574 280a  e_name = input(.
+00038800: 2020 2020 2020 2020 2020 2020 6622 4368              f"Ch
+00038810: 6f6f 7365 2061 206e 616d 6520 666f 7220  oose a name for 
+00038820: 7468 6973 2064 6576 6963 653a 205b 7b64  this device: [{d
+00038830: 6576 6963 655f 6e61 6d65 7d5d 2022 0a20  evice_name}] ". 
+00038840: 2020 2020 2020 2029 2e73 7472 6970 2829         ).strip()
+00038850: 0a20 2020 2020 2020 2069 6620 6465 7669  .        if devi
+00038860: 6365 5f6e 616d 6520 3d3d 2022 223a 0a20  ce_name == "":. 
+00038870: 2020 2020 2020 2020 2020 2064 6576 6963             devic
+00038880: 655f 6e61 6d65 203d 2050 524f 475f 5749  e_name = PROG_WI
+00038890: 5448 4f55 545f 4558 5420 2023 2064 6566  THOUT_EXT  # def
+000388a0: 6175 6c74 0a20 2020 2069 6620 6773 2e70  ault.    if gs.p
+000388b0: 612e 726f 6f6d 5f64 6566 6175 6c74 2069  a.room_default i
+000388c0: 7320 6e6f 7420 4e6f 6e65 3a20 2023 2073  s not None:  # s
+000388d0: 6f6d 6574 6869 6e67 2077 6173 2073 7065  omething was spe
+000388e0: 6369 6669 6564 0a20 2020 2020 2020 2072  cified.        r
+000388f0: 6f6f 6d5f 6964 203d 2067 732e 7061 2e72  oom_id = gs.pa.r
+00038900: 6f6f 6d5f 6465 6661 756c 742e 7374 7269  oom_default.stri
+00038910: 7028 290a 2020 2020 2020 2020 726f 6f6d  p().        room
+00038920: 5f69 6420 3d20 726f 6f6d 5f69 642e 7265  _id = room_id.re
+00038930: 706c 6163 6528 7222 5c21 222c 2022 2122  place(r"\!", "!"
+00038940: 2920 2023 2072 656d 6f76 6520 706f 7373  )  # remove poss
+00038950: 6962 6c65 2065 7363 6170 650a 2020 2020  ible escape.    
+00038960: 656c 7365 3a0a 2020 2020 2020 2020 696e  else:.        in
+00038970: 7465 7261 6374 6976 6520 3d20 5472 7565  teractive = True
+00038980: 0a20 2020 2020 2020 2072 6f6f 6d5f 6964  .        room_id
+00038990: 203d 2022 2153 6f6d 6552 6f6f 6d49 6453   = "!SomeRoomIdS
+000389a0: 7472 696e 673a 6578 616d 706c 652e 6f72  tring:example.or
+000389b0: 6722 0a20 2020 2020 2020 2072 6f6f 6d5f  g".        room_
+000389c0: 6964 3220 3d20 2223 616c 6961 733a 2220  id2 = "#alias:" 
+000389d0: 2b20 686f 6d65 7365 7276 6572 5f73 686f  + homeserver_sho
+000389e0: 7274 0a20 2020 2020 2020 2072 6f6f 6d5f  rt.        room_
+000389f0: 6964 203d 2069 6e70 7574 280a 2020 2020  id = input(.    
+00038a00: 2020 2020 2020 2020 6622 456e 7465 7220          f"Enter 
+00038a10: 726f 6f6d 2049 4420 666f 7220 6465 6661  room ID for defa
+00038a20: 756c 7420 726f 6f6d 3a20 205b 7b72 6f6f  ult room:  [{roo
+00038a30: 6d5f 6964 7d5d 2020 220a 2020 2020 2020  m_id}]  ".      
+00038a40: 2020 2020 2020 6622 6f72 2020 5b61 6c69        f"or  [ali
+00038a50: 6173 5d20 666f 7220 7b72 6f6f 6d5f 6964  as] for {room_id
+00038a60: 327d 203a 2022 0a20 2020 2020 2020 2029  2} : ".        )
+00038a70: 2e73 7472 6970 2829 0a20 2020 2069 6620  .strip().    if 
+00038a80: 7573 6572 5f69 6420 6973 206e 6f74 204e  user_id is not N
+00038a90: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
+00038aa0: 6973 5f70 6172 7469 616c 5f75 7365 725f  is_partial_user_
+00038ab0: 6964 2875 7365 725f 6964 293a 0a20 2020  id(user_id):.   
+00038ac0: 2020 2020 2020 2020 2075 7365 725f 6964           user_id
+00038ad0: 203d 2075 7365 725f 6964 202b 2022 3a22   = user_id + ":"
+00038ae0: 202b 2068 6f6d 6573 6572 7665 725f 7368   + homeserver_sh
+00038af0: 6f72 7420 2023 2064 6f6e 7420 7573 6520  ort  # dont use 
+00038b00: 666e 0a20 2020 2020 2020 2069 6620 6973  fn.        if is
+00038b10: 5f73 686f 7274 5f75 7365 725f 6964 2875  _short_user_id(u
+00038b20: 7365 725f 6964 293a 0a20 2020 2020 2020  ser_id):.       
+00038b30: 2020 2020 2075 7365 725f 6964 203d 2022       user_id = "
+00038b40: 4022 202b 2075 7365 725f 6964 202b 2022  @" + user_id + "
+00038b50: 3a22 202b 2068 6f6d 6573 6572 7665 725f  :" + homeserver_
+00038b60: 7368 6f72 7420 2023 2064 6f6e 7420 7573  short  # dont us
+00038b70: 6520 666e 0a20 2020 2020 2020 2069 6620  e fn.        if 
+00038b80: 6e6f 7420 6973 5f75 7365 725f 6964 2875  not is_user_id(u
+00038b90: 7365 725f 6964 293a 0a20 2020 2020 2020  ser_id):.       
+00038ba0: 2020 2020 2072 6169 7365 204d 6174 7269       raise Matri
+00038bb0: 7843 6f6d 6d61 6e64 6572 4572 726f 7228  xCommanderError(
+00038bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038bd0: 2022 4532 3237 3a20 220a 2020 2020 2020   "E227: ".      
+00038be0: 2020 2020 2020 2020 2020 6622 5573 6572            f"User
+00038bf0: 2069 6420 277b 7573 6572 5f69 647d 2720   id '{user_id}' 
+00038c00: 666f 7220 2d2d 6c6f 6769 6e20 6973 2069  for --login is i
+00038c10: 6e76 616c 6964 2e20 220a 2020 2020 2020  nvalid. ".      
+00038c20: 2020 2020 2020 2020 2020 2253 7065 6369            "Speci
+00038c30: 6679 2063 6f72 7265 6374 2075 7365 7220  fy correct user 
+00038c40: 6964 2e22 0a20 2020 2020 2020 2020 2020  id.".           
+00038c50: 2029 2066 726f 6d20 4e6f 6e65 0a20 2020   ) from None.   
+00038c60: 2069 6620 6973 5f73 686f 7274 5f72 6f6f   if is_short_roo
+00038c70: 6d5f 616c 6961 7328 726f 6f6d 5f69 6429  m_alias(room_id)
+00038c80: 3a0a 2020 2020 2020 2020 6966 2072 6f6f  :.        if roo
+00038c90: 6d5f 6964 5b30 5d20 213d 2022 2322 3a0a  m_id[0] != "#":.
+00038ca0: 2020 2020 2020 2020 2020 2020 726f 6f6d              room
+00038cb0: 5f69 6420 3d20 2223 2220 2b20 726f 6f6d  _id = "#" + room
+00038cc0: 5f69 640a 2020 2020 2020 2020 726f 6f6d  _id.        room
+00038cd0: 5f69 6420 3d20 726f 6f6d 5f69 6420 2b20  _id = room_id + 
+00038ce0: 223a 2220 2b20 686f 6d65 7365 7276 6572  ":" + homeserver
+00038cf0: 5f73 686f 7274 2020 2320 646f 6e74 2075  _short  # dont u
+00038d00: 7365 2066 6e0a 2020 2020 6966 206e 6f74  se fn.    if not
+00038d10: 2069 735f 726f 6f6d 2872 6f6f 6d5f 6964   is_room(room_id
+00038d20: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
+00038d30: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+00038d40: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00038d50: 2020 2022 4532 3238 3a20 220a 2020 2020     "E228: ".    
+00038d60: 2020 2020 2020 2020 6622 526f 6f6d 2069          f"Room i
+00038d70: 6420 277b 726f 6f6d 5f69 647d 2720 666f  d '{room_id}' fo
+00038d80: 7220 2d2d 6c6f 6769 6e20 6973 2069 6e76  r --login is inv
+00038d90: 616c 6964 2e20 220a 2020 2020 2020 2020  alid. ".        
+00038da0: 2020 2020 2253 7065 6369 6679 2063 6f72      "Specify cor
+00038db0: 7265 6374 2072 6f6f 6d20 6964 2e22 0a20  rect room id.". 
+00038dc0: 2020 2020 2020 2029 2066 726f 6d20 4e6f         ) from No
+00038dd0: 6e65 0a0a 2020 2020 6773 2e6c 6f67 2e69  ne..    gs.log.i
+00038de0: 6e66 6f28 6622 5468 6520 7072 6f76 6964  nfo(f"The provid
+00038df0: 6564 206c 6f67 696e 2064 6174 6120 6973  ed login data is
+00038e00: 3a20 686f 6d65 7365 7276 6572 3d27 7b68  : homeserver='{h
+00038e10: 6f6d 6573 6572 7665 727d 2722 290a 2020  omeserver}'").  
+00038e20: 2020 6773 2e6c 6f67 2e69 6e66 6f28 6622    gs.log.info(f"
+00038e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038e40: 2020 2020 2020 2020 2020 2020 7573 6572              user
+00038e50: 2069 643d 277b 7573 6572 5f69 647d 2722   id='{user_id}'"
+00038e60: 290a 2020 2020 2320 6773 2e6c 6f67 2e69  ).    # gs.log.i
+00038e70: 6e66 6f28 6622 2020 2020 2020 2020 2020  nfo(f"          
 00038e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038e90: 2020 6622 5370 6563 6966 6965 6420 7072    f"Specified pr
-00038ea0: 6f78 7920 7b67 732e 7061 2e70 726f 7879  oxy {gs.pa.proxy
-00038eb0: 7d20 6361 6e6e 6f74 2022 0a20 2020 2020  } cannot ".     
-00038ec0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00038ed0: 6265 2063 6f6e 6669 6775 7265 6420 666f  be configured fo
-00038ee0: 7220 6272 6f77 7365 722e 220a 2020 2020  r browser.".    
-00038ef0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00038f00: 2020 2020 2020 2020 2020 2020 2020 6773                gs
-00038f10: 2e77 6172 6e5f 636f 756e 7420 2b3d 2031  .warn_count += 1
-00038f20: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00038f30: 6c61 756e 6368 2077 6562 2d62 726f 7773  launch web-brows
-00038f40: 6572 0a20 2020 2020 2020 2020 2020 2069  er.            i
-00038f50: 6620 7379 732e 706c 6174 666f 726d 2e73  f sys.platform.s
-00038f60: 7461 7274 7377 6974 6828 2264 6172 7769  tartswith("darwi
-00038f70: 6e22 293a 0a20 2020 2020 2020 2020 2020  n"):.           
-00038f80: 2020 2020 2063 6d64 203d 205b 7368 7574       cmd = [shut
-00038f90: 696c 2e77 6869 6368 2822 6f70 656e 2229  il.which("open")
-00038fa0: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
-00038fb0: 6966 2073 7973 2e70 6c61 7466 6f72 6d2e  if sys.platform.
-00038fc0: 7374 6172 7473 7769 7468 2822 7769 6e22  startswith("win"
-00038fd0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00038fe0: 2020 2063 6d64 203d 205b 2273 7461 7274     cmd = ["start
-00038ff0: 225d 0a20 2020 2020 2020 2020 2020 2065  "].            e
-00039000: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00039010: 2020 2020 2063 6d64 203d 205b 7368 7574       cmd = [shut
-00039020: 696c 2e77 6869 6368 2822 7864 672d 6f70  il.which("xdg-op
-00039030: 656e 2229 5d0a 2020 2020 2020 2020 2020  en")].          
-00039040: 2020 2020 2020 6966 2063 6d64 203d 3d20        if cmd == 
-00039050: 5b4e 6f6e 655d 3a0a 2020 2020 2020 2020  [None]:.        
-00039060: 2020 2020 2020 2020 2020 2020 636d 6420              cmd 
-00039070: 3d20 5b73 6875 7469 6c2e 7768 6963 6828  = [shutil.which(
-00039080: 2278 2d77 7777 2d62 726f 7773 6572 2229  "x-www-browser")
-00039090: 5d0a 2020 2020 2020 2020 2020 2020 636d  ].            cm
-000390a0: 642e 6170 7065 6e64 280a 2020 2020 2020  d.append(.      
-000390b0: 2020 2020 2020 2020 2020 6622 7b68 6f6d            f"{hom
-000390c0: 6573 6572 7665 727d 2f5f 6d61 7472 6978  eserver}/_matrix
-000390d0: 2f63 6c69 656e 742f 7230 2f6c 6f67 696e  /client/r0/login
-000390e0: 2f73 736f 2f72 6564 6972 6563 7422 0a20  /sso/redirect". 
-000390f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00039100: 3f72 6564 6972 6563 7455 726c 3d68 7474  ?redirectUrl=htt
-00039110: 703a 2f2f 6c6f 6361 6c68 6f73 743a 3338  p://localhost:38
-00039120: 3038 302f 220a 2020 2020 2020 2020 2020  080/".          
-00039130: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00039140: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00039150: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-00039160: 6368 6563 6b5f 6f75 7470 7574 2863 6d64  check_output(cmd
-00039170: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-00039180: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-00039190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000391a0: 6773 2e6c 6f67 2e65 7272 6f72 280a 2020  gs.log.error(.  
-000391b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000391c0: 2020 2245 3233 313a 2022 0a20 2020 2020    "E231: ".     
-000391d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000391e0: 4272 6f77 7365 7220 636f 756c 6420 6e6f  Browser could no
-000391f0: 7420 6265 206c 6175 6e63 6865 642e 2022  t be launched. "
-00039200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039210: 2020 2020 2022 4865 6e63 6520 5353 4f20       "Hence SSO 
-00039220: 2853 696e 676c 6520 5369 676e 2d4f 6e29  (Single Sign-On)
-00039230: 206c 6f67 696e 2063 6f75 6c64 206e 6f74   login could not
-00039240: 2062 6520 220a 2020 2020 2020 2020 2020   be ".          
-00039250: 2020 2020 2020 2020 2020 2263 6f6d 706c            "compl
-00039260: 6574 6564 2e20 536f 7272 792e 2049 6620  eted. Sorry. If 
-00039270: 796f 7520 7468 696e 6b20 7468 6520 6272  you think the br
-00039280: 6f77 7365 7220 616e 6420 220a 2020 2020  owser and ".    
-00039290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000392a0: 2253 534f 2073 686f 756c 6420 776f 726b  "SSO should work
-000392b0: 2074 6865 6e20 7472 7920 6167 6169 6e2e   then try again.
-000392c0: 2049 6620 796f 7520 646f 206e 6f74 2068   If you do not h
-000392d0: 6176 6520 220a 2020 2020 2020 2020 2020  ave ".          
-000392e0: 2020 2020 2020 2020 2020 2261 2062 726f            "a bro
-000392f0: 7773 6572 206f 7220 646f 6e27 7420 7761  wser or don't wa
-00039300: 6e74 2053 534f 206f 7220 7761 6e74 2074  nt SSO or want t
-00039310: 6f20 6c6f 6769 6e20 7769 7468 2061 2022  o login with a "
-00039320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039330: 2020 2020 2022 7061 7373 776f 7264 2069       "password i
-00039340: 6e73 7465 6164 2c20 7468 656e 2075 7365  nstead, then use
-00039350: 2027 2d2d 6c6f 6769 6e20 7061 7373 776f   '--login passwo
-00039360: 7264 2720 696e 2022 0a20 2020 2020 2020  rd' in ".       
-00039370: 2020 2020 2020 2020 2020 2020 2022 7468               "th
-00039380: 6520 636f 6d6d 616e 6420 6c69 6e65 2e22  e command line."
-00039390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000393a0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000393b0: 2020 2072 6169 7365 0a0a 2020 2020 2020     raise..      
-000393c0: 2020 2020 2020 2320 7761 6974 2061 6e64        # wait and
-000393d0: 2073 6875 7464 6f77 6e20 7365 7276 6572   shutdown server
-000393e0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-000393f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039400: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-00039410: 7761 6974 5f66 6f72 2873 746f 705f 7365  wait_for(stop_se
-00039420: 7276 6572 5f65 7674 2e77 6169 7428 292c  rver_evt.wait(),
-00039430: 2035 202a 2036 3029 0a20 2020 2020 2020   5 * 60).       
-00039440: 2020 2020 2065 7863 6570 7420 6173 796e       except asyn
-00039450: 6369 6f2e 5469 6d65 6f75 7445 7272 6f72  cio.TimeoutError
-00039460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039470: 2020 6773 2e6c 6f67 2e65 7272 6f72 280a    gs.log.error(.
-00039480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039490: 2020 2020 2245 3233 323a 2022 0a20 2020      "E232: ".   
-000394a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394b0: 2066 2254 6865 2070 726f 6772 616d 207b   f"The program {
-000394c0: 5052 4f47 5f57 4954 485f 4558 547d 2066  PROG_WITH_EXT} f
-000394d0: 6169 6c65 642e 2022 0a20 2020 2020 2020  ailed. ".       
-000394e0: 2020 2020 2020 2020 2020 2020 2022 4e6f               "No
-000394f0: 2072 6573 706f 6e73 6520 7761 7320 7265   response was re
-00039500: 6365 6976 6564 2066 726f 6d20 5353 4f20  ceived from SSO 
-00039510: 7072 6f76 6964 6572 2e20 220a 2020 2020  provider. ".    
-00039520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039530: 2254 6865 7265 2077 6173 2061 2074 696d  "There was a tim
-00039540: 656f 7574 2e20 536f 7272 792e 220a 2020  eout. Sorry.".  
-00039550: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00039560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039570: 7261 6973 650a 2020 2020 2020 2020 6669  raise.        fi
-00039580: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-00039590: 2020 2061 7761 6974 2072 756e 6e65 722e     await runner.
-000395a0: 636c 6561 6e75 7028 290a 0a20 2020 2023  cleanup()..    #
-000395b0: 2043 6f6e 6669 6775 7261 7469 6f6e 206f   Configuration o
-000395c0: 7074 696f 6e73 2066 6f72 2074 6865 2041  ptions for the A
-000395d0: 7379 6e63 436c 6965 6e74 0a20 2020 2063  syncClient.    c
-000395e0: 6c69 656e 745f 636f 6e66 6967 203d 2041  lient_config = A
-000395f0: 7379 6e63 436c 6965 6e74 436f 6e66 6967  syncClientConfig
-00039600: 280a 2020 2020 2020 2020 6d61 785f 6c69  (.        max_li
-00039610: 6d69 745f 6578 6365 6564 6564 3d30 2c0a  mit_exceeded=0,.
-00039620: 2020 2020 2020 2020 6d61 785f 7469 6d65          max_time
-00039630: 6f75 7473 3d30 2c0a 2020 2020 2020 2020  outs=0,.        
-00039640: 7374 6f72 655f 7379 6e63 5f74 6f6b 656e  store_sync_token
-00039650: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00039660: 656e 6372 7970 7469 6f6e 5f65 6e61 626c  encryption_enabl
-00039670: 6564 3d54 7275 652c 0a20 2020 2029 0a0a  ed=True,.    )..
-00039680: 2020 2020 7374 6f72 655f 6372 6561 7465      store_create
-00039690: 2873 746f 7265 5f64 6972 290a 0a20 2020  (store_dir)..   
-000396a0: 2023 2049 6e69 7469 616c 697a 6520 7468   # Initialize th
-000396b0: 6520 6d61 7472 6978 2063 6c69 656e 740a  e matrix client.
-000396c0: 2020 2020 636c 6965 6e74 203d 2041 7379      client = Asy
-000396d0: 6e63 436c 6965 6e74 280a 2020 2020 2020  ncClient(.      
-000396e0: 2020 686f 6d65 7365 7276 6572 2c0a 2020    homeserver,.  
-000396f0: 2020 2020 2020 2222 2069 6620 6e6f 7420        "" if not 
-00039700: 7573 6572 5f69 6420 656c 7365 2075 7365  user_id else use
-00039710: 725f 6964 2c0a 2020 2020 2020 2020 7374  r_id,.        st
-00039720: 6f72 655f 7061 7468 3d73 746f 7265 5f64  ore_path=store_d
-00039730: 6972 2c0a 2020 2020 2020 2020 636f 6e66  ir,.        conf
-00039740: 6967 3d63 6c69 656e 745f 636f 6e66 6967  ig=client_config
-00039750: 2c0a 2020 2020 2020 2020 7373 6c3d 6773  ,.        ssl=gs
-00039760: 2e73 736c 2c0a 2020 2020 2020 2020 7072  .ssl,.        pr
-00039770: 6f78 793d 6773 2e70 612e 7072 6f78 792c  oxy=gs.pa.proxy,
-00039780: 0a20 2020 2029 0a20 2020 2074 7279 3a0a  .    ).    try:.
-00039790: 2020 2020 2020 2020 6966 206d 6574 686f          if metho
-000397a0: 6420 3d3d 2022 7373 6f22 3a0a 2020 2020  d == "sso":.    
-000397b0: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
-000397c0: 7761 6974 2063 6c69 656e 742e 6c6f 6769  wait client.logi
-000397d0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-000397e0: 2020 2074 6f6b 656e 3d6c 6f67 696e 5f74     token=login_t
-000397f0: 6f6b 656e 2c20 6465 7669 6365 5f6e 616d  oken, device_nam
-00039800: 653d 6465 7669 6365 5f6e 616d 650a 2020  e=device_name.  
-00039810: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00039820: 2020 2020 656c 6966 206d 6574 686f 6420      elif method 
-00039830: 3d3d 2022 7061 7373 776f 7264 223a 0a20  == "password":. 
-00039840: 2020 2020 2020 2020 2020 2072 6573 7020             resp 
-00039850: 3d20 6177 6169 7420 636c 6965 6e74 2e6c  = await client.l
-00039860: 6f67 696e 2870 6173 7377 6f72 642c 2064  ogin(password, d
-00039870: 6576 6963 655f 6e61 6d65 3d64 6576 6963  evice_name=devic
-00039880: 655f 6e61 6d65 290a 0a20 2020 2020 2020  e_name)..       
-00039890: 2023 2063 6865 636b 2074 6861 7420 7765   # check that we
-000398a0: 206c 6f67 6765 6420 696e 2073 7563 6365   logged in succe
-000398b0: 7366 756c 6c79 0a20 2020 2020 2020 2069  sfully.        i
-000398c0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-000398d0: 702c 204c 6f67 696e 5265 7370 6f6e 7365  p, LoginResponse
-000398e0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-000398f0: 2077 6865 6e20 7772 6974 696e 672c 2061   when writing, a
-00039900: 6c77 6179 7320 7772 6974 6520 746f 2070  lways write to p
-00039910: 7269 6d61 7279 206c 6f63 6174 696f 6e20  rimary location 
-00039920: 2865 2e67 2e20 2e29 0a20 2020 2020 2020  (e.g. .).       
-00039930: 2020 2020 2077 7269 7465 5f63 7265 6465       write_crede
-00039940: 6e74 6961 6c73 5f74 6f5f 6469 736b 280a  ntials_to_disk(.
-00039950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039960: 686f 6d65 7365 7276 6572 2c0a 2020 2020  homeserver,.    
-00039970: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-00039980: 2e75 7365 725f 6964 2c0a 2020 2020 2020  .user_id,.      
-00039990: 2020 2020 2020 2020 2020 7265 7370 2e64            resp.d
-000399a0: 6576 6963 655f 6964 2c20 2023 206e 6f74  evice_id,  # not
-000399b0: 6520 7468 6973 2069 7320 616e 2069 642c  e this is an id,
-000399c0: 206e 6f74 2061 206e 616d 6521 0a20 2020   not a name!.   
-000399d0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-000399e0: 702e 6163 6365 7373 5f74 6f6b 656e 2c0a  p.access_token,.
-000399f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039a00: 726f 6f6d 5f69 642c 0a20 2020 2020 2020  room_id,.       
-00039a10: 2020 2020 2020 2020 2067 732e 7061 2e63           gs.pa.c
-00039a20: 7265 6465 6e74 6961 6c73 2c0a 2020 2020  redentials,.    
-00039a30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00039a40: 2020 2020 2020 6773 2e63 6c69 656e 7420        gs.client 
-00039a50: 3d20 636c 6965 6e74 0a20 2020 2020 2020  = client.       
-00039a60: 2020 2020 2067 732e 6372 6564 656e 7469       gs.credenti
-00039a70: 616c 7320 3d20 7265 6164 5f63 7265 6465  als = read_crede
-00039a80: 6e74 6961 6c73 5f66 726f 6d5f 6469 736b  ntials_from_disk
-00039a90: 2863 7265 6465 6e74 6961 6c73 5f66 696c  (credentials_fil
-00039aa0: 6529 0a20 2020 2020 2020 2020 2020 2074  e).            t
-00039ab0: 7874 203d 2028 0a20 2020 2020 2020 2020  xt = (.         
-00039ac0: 2020 2020 2020 2022 4532 3333 3a20 220a         "E233: ".
-00039ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039ae0: 6622 4c6f 6720 696e 2075 7369 6e67 206d  f"Log in using m
-00039af0: 6574 686f 6420 277b 6d65 7468 6f64 7d27  ethod '{method}'
-00039b00: 2077 6173 2073 7563 6365 7373 6675 6c2e   was successful.
-00039b10: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00039b20: 2020 2066 2243 7265 6465 6e74 6961 6c73     f"Credentials
-00039b30: 2077 6572 6520 7374 6f72 6564 2069 6e20   were stored in 
-00039b40: 6669 6c65 2027 7b67 732e 7061 2e63 7265  file '{gs.pa.cre
-00039b50: 6465 6e74 6961 6c73 7d27 2e20 220a 2020  dentials}'. ".  
-00039b60: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00039b70: 4672 6f6d 206e 6f77 206f 6e20 796f 7520  From now on you 
-00039b80: 6361 6e20 7275 6e20 7072 6f67 7261 6d20  can run program 
-00039b90: 277b 5052 4f47 5f57 4954 485f 4558 547d  '{PROG_WITH_EXT}
-00039ba0: 2720 220a 2020 2020 2020 2020 2020 2020  ' ".            
-00039bb0: 2020 2020 2277 6974 686f 7574 206c 6f67      "without log
-00039bc0: 2069 6e2c 2061 7320 616e 2061 6363 6573   in, as an acces
-00039bd0: 7320 746f 6b65 6e20 6973 2073 746f 7265  s token is store
-00039be0: 6420 696e 2079 6f75 7220 220a 2020 2020  d in your ".    
-00039bf0: 2020 2020 2020 2020 2020 2020 2263 7265              "cre
-00039c00: 6465 6e74 6961 6c73 2066 696c 652e 2022  dentials file. "
-00039c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039c20: 2022 4966 2079 6f75 2070 6c61 6e20 6f6e   "If you plan on
-00039c30: 2068 6176 696e 6720 6d61 6e79 2063 7265   having many cre
-00039c40: 6465 6e74 6961 6c20 6669 6c65 732c 2063  dential files, c
-00039c50: 6f6e 7369 6465 7220 220a 2020 2020 2020  onsider ".      
-00039c60: 2020 2020 2020 2020 2020 6622 6d6f 7669            f"movi
-00039c70: 6e67 2074 6865 6d20 746f 2064 6972 6563  ng them to direc
-00039c80: 746f 7279 2027 7b43 5245 4445 4e54 4941  tory '{CREDENTIA
-00039c90: 4c53 5f44 4952 5f4c 4153 5452 4553 4f52  LS_DIR_LASTRESOR
-00039ca0: 547d 272e 220a 2020 2020 2020 2020 2020  T}'.".          
-00039cb0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00039cc0: 6773 2e6c 6f67 2e69 6e66 6f28 7478 7429  gs.log.info(txt)
-00039cd0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00039ce0: 2020 2020 2020 2020 2020 2023 2069 7369             # isi
-00039cf0: 6e73 7461 6e63 6528 7265 7370 2c20 4c6f  nstance(resp, Lo
-00039d00: 6769 6e45 7272 6f72 2920 3d3d 2074 7275  ginError) == tru
-00039d10: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00039d20: 636c 6561 6e75 700a 2020 2020 2020 2020  cleanup.        
-00039d30: 2020 2020 6177 6169 7420 636c 6965 6e74      await client
-00039d40: 2e63 6c6f 7365 2829 2020 2320 6e6f 7420  .close()  # not 
-00039d50: 7965 7420 696e 2067 732e 0a20 2020 2020  yet in gs..     
-00039d60: 2020 2020 2020 2073 746f 7265 5f64 656c         store_del
-00039d70: 6574 6528 7374 6f72 655f 6469 7229 2020  ete(store_dir)  
-00039d80: 2320 656d 7074 792c 206a 7573 7420 6372  # empty, just cr
-00039d90: 6561 7465 640a 2020 2020 2020 2020 2020  eated.          
-00039da0: 2020 2320 7265 7370 2064 6f65 7320 6e6f    # resp does no
-00039db0: 7420 636f 6e74 6169 6e20 7365 6372 6574  t contain secret
-00039dc0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
-00039dd0: 7265 7370 2069 733a 206d 6573 7361 6765  resp is: message
-00039de0: 3d22 496e 7661 6c69 6420 7573 6572 6e61  ="Invalid userna
-00039df0: 6d65 206f 7220 7061 7373 776f 7264 222c  me or password",
-00039e00: 2063 6f64 653d 4d5f 464f 5242 4944 4445   code=M_FORBIDDE
-00039e10: 4e0a 2020 2020 2020 2020 2020 2020 7478  N.            tx
-00039e20: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
-00039e30: 2020 2020 2020 2245 3233 343a 2022 0a20        "E234: ". 
-00039e40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00039e50: 4c6f 6720 696e 2066 6169 6c65 642e 2022  Log in failed. "
-00039e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039e70: 2022 4d6f 7374 206c 696b 656c 7920 7772   "Most likely wr
-00039e80: 6f6e 6720 6372 6564 656e 7469 616c 7320  ong credentials 
-00039e90: 7765 7265 2065 6e74 6572 6564 2e20 220a  were entered. ".
-00039ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039eb0: 6622 686f 6d65 7365 7276 6572 3d27 7b68  f"homeserver='{h
-00039ec0: 6f6d 6573 6572 7665 727d 273b 2064 6576  omeserver}'; dev
-00039ed0: 6963 6520 6e61 6d65 3d27 7b64 6576 6963  ice name='{devic
-00039ee0: 655f 6e61 6d65 7d27 3b20 220a 2020 2020  e_name}'; ".    
-00039ef0: 2020 2020 2020 2020 2020 2020 6622 7573              f"us
-00039f00: 6572 3d27 7b75 7365 725f 6964 7d27 3b20  er='{user_id}'; 
-00039f10: 726f 6f6d 5f69 643d 277b 726f 6f6d 5f69  room_id='{room_i
-00039f20: 647d 272e 2022 0a20 2020 2020 2020 2020  d}'. ".         
-00039f30: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-00039f40: 746f 206c 6f67 2069 6e3a 207b 7265 7370  to log in: {resp
-00039f50: 2e6d 6573 7361 6765 7d2c 207b 7374 7228  .message}, {str(
-00039f60: 7265 7370 2e73 7461 7475 735f 636f 6465  resp.status_code
-00039f70: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-00039f80: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-00039f90: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
-00039fa0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00039fb0: 6520 4d61 7472 6978 436f 6d6d 616e 6465  e MatrixCommande
-00039fc0: 7245 7272 6f72 2874 7874 290a 2020 2020  rError(txt).    
-00039fd0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00039fe0: 2061 7320 653a 0a20 2020 2020 2020 2074   as e:.        t
-00039ff0: 7874 203d 2028 0a20 2020 2020 2020 2020  xt = (.         
-0003a000: 2020 2022 4532 3335 3a20 220a 2020 2020     "E235: ".    
-0003a010: 2020 2020 2020 2020 224c 6f67 2069 6e20          "Log in 
-0003a020: 6661 696c 6564 2e20 536f 7272 792e 220a  failed. Sorry.".
-0003a030: 2020 2020 2020 2020 2020 2020 6622 686f              f"ho
-0003a040: 6d65 7365 7276 6572 3d27 7b68 6f6d 6573  meserver='{homes
-0003a050: 6572 7665 727d 273b 2064 6576 6963 6520  erver}'; device 
-0003a060: 6e61 6d65 3d27 7b64 6576 6963 655f 6e61  name='{device_na
-0003a070: 6d65 7d27 3b20 220a 2020 2020 2020 2020  me}'; ".        
-0003a080: 2020 2020 6622 7573 6572 3d27 7b75 7365      f"user='{use
-0003a090: 725f 6964 7d27 3b20 726f 6f6d 5f69 643d  r_id}'; room_id=
-0003a0a0: 277b 726f 6f6d 5f69 647d 272e 2022 0a20  '{room_id}'. ". 
-0003a0b0: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
-0003a0c0: 6c65 6420 746f 206c 6f67 2069 6e3a 207b  led to log in: {
-0003a0d0: 657d 220a 2020 2020 2020 2020 290a 2020  e}".        ).  
-0003a0e0: 2020 2020 2020 2320 6773 2e65 7272 5f63        # gs.err_c
-0003a0f0: 6f75 6e74 202b 3d20 3120 2023 2064 6f6e  ount += 1  # don
-0003a100: 2774 2069 6e63 7265 6d65 6e74 2073 696e  't increment sin
-0003a110: 6365 206e 6f74 204d 6174 7269 7843 6f6d  ce not MatrixCom
-0003a120: 6d61 6e64 6572 4572 726f 720a 2020 2020  manderError.    
-0003a130: 2020 2020 7261 6973 650a 2020 2020 2320      raise.    # 
-0003a140: 7765 2061 7265 206e 6f77 2061 7574 6865  we are now authe
-0003a150: 6e74 6963 6174 6564 2c20 7765 2061 7265  nticated, we are
-0003a160: 206e 6f77 206c 6f67 6765 6420 696e 0a20   now logged in. 
-0003a170: 2020 2023 2067 7320 6e6f 7720 6861 7320     # gs now has 
-0003a180: 636c 6965 6e74 2061 6e64 2063 7265 6465  client and crede
-0003a190: 6e74 6961 6c73 2c20 6e65 6564 6564 2062  ntials, needed b
-0003a1a0: 7920 6675 7274 6865 7220 6163 7469 6f6e  y further action
-0003a1b0: 730a 0a0a 6173 796e 6320 6465 6620 696d  s...async def im
-0003a1c0: 706c 6963 6974 5f6c 6f67 696e 2829 202d  plicit_login() -
-0003a1d0: 3e20 4e6f 6e65 3a0a 2020 2020 2222 224c  > None:.    """L
-0003a1e0: 6f67 2069 6e20 7573 696e 6720 6372 6564  og in using cred
-0003a1f0: 656e 7469 616c 7320 6669 6c65 2061 6e64  entials file and
-0003a200: 2072 656d 6169 6e20 6c6f 6767 6564 2069   remain logged i
-0003a210: 6e2e 2222 220a 2020 2020 636c 6965 6e74  n.""".    client
-0003a220: 2c20 6372 6564 656e 7469 616c 7320 3d20  , credentials = 
-0003a230: 6177 6169 7420 6c6f 6769 6e5f 7573 696e  await login_usin
-0003a240: 675f 6372 6564 656e 7469 616c 735f 6669  g_credentials_fi
-0003a250: 6c65 2829 0a20 2020 2067 732e 636c 6965  le().    gs.clie
-0003a260: 6e74 203d 2063 6c69 656e 740a 2020 2020  nt = client.    
-0003a270: 6773 2e63 7265 6465 6e74 6961 6c73 203d  gs.credentials =
-0003a280: 2063 7265 6465 6e74 6961 6c73 0a0a 0a64   credentials...d
-0003a290: 6566 2072 6f6f 6d73 5f74 6f5f 6c6f 6e67  ef rooms_to_long
-0003a2a0: 5f72 6f6f 6d5f 6e61 6d65 7328 2920 2d3e  _room_names() ->
-0003a2b0: 204e 6f6e 653a 0a20 2020 2022 2222 436f   None:.    """Co
-0003a2c0: 6e76 6572 7420 666f 6f20 746f 2023 666f  nvert foo to #fo
-0003a2d0: 6f3a 6578 616d 706c 652e 636f 6d20 696e  o:example.com in
-0003a2e0: 2067 732e 7061 2e72 6f6f 6d20 7768 6572   gs.pa.room wher
-0003a2f0: 6520 6e65 6365 7373 6172 792e 2222 220a  e necessary.""".
-0003a300: 2020 2020 6966 2067 732e 7061 2e72 6f6f      if gs.pa.roo
-0003a310: 6d3a 0a20 2020 2020 2020 206c 6f6e 675f  m:.        long_
-0003a320: 726f 6f6d 7320 3d20 5b5d 0a20 2020 2020  rooms = [].     
-0003a330: 2020 2066 6f72 2072 6f6f 6d20 696e 2067     for room in g
-0003a340: 732e 7061 2e72 6f6f 6d3a 0a20 2020 2020  s.pa.room:.     
-0003a350: 2020 2020 2020 2069 6620 6973 5f73 686f         if is_sho
-0003a360: 7274 5f72 6f6f 6d5f 616c 6961 7328 726f  rt_room_alias(ro
-0003a370: 6f6d 293a 0a20 2020 2020 2020 2020 2020  om):.           
-0003a380: 2020 2020 206c 6f6e 675f 726f 6f6d 732e       long_rooms.
-0003a390: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-0003a3a0: 2020 2020 2020 2020 2020 2020 7368 6f72              shor
-0003a3b0: 745f 726f 6f6d 5f61 6c69 6173 5f74 6f5f  t_room_alias_to_
-0003a3c0: 726f 6f6d 5f61 6c69 6173 2872 6f6f 6d2c  room_alias(room,
-0003a3d0: 2067 732e 6372 6564 656e 7469 616c 7329   gs.credentials)
-0003a3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a3f0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-0003a400: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003a410: 2020 2020 206c 6f6e 675f 726f 6f6d 732e       long_rooms.
-0003a420: 6170 7065 6e64 2872 6f6f 6d29 0a20 2020  append(room).   
-0003a430: 2020 2020 2067 732e 7061 2e72 6f6f 6d20       gs.pa.room 
-0003a440: 3d20 6c6f 6e67 5f72 6f6f 6d73 0a0a 0a61  = long_rooms...a
-0003a450: 7379 6e63 2064 6566 2061 7379 6e63 5f6d  sync def async_m
-0003a460: 6169 6e28 2920 2d3e 204e 6f6e 653a 0a20  ain() -> None:. 
-0003a470: 2020 2022 2222 5275 6e20 6d61 696e 2066     """Run main f
-0003a480: 756e 6374 696f 6e73 2062 6569 6e67 2069  unctions being i
-0003a490: 6e73 6964 6520 7468 6520 6576 656e 7420  nside the event 
-0003a4a0: 6c6f 6f70 2e22 2222 0a20 2020 2023 206c  loop.""".    # l
-0003a4b0: 6f67 696e 2065 7870 6c69 6369 746c 790a  ogin explicitly.
-0003a4c0: 2020 2020 2320 6c6f 6769 6e20 696d 706c      # login impl
-0003a4d0: 6963 6974 6c79 0a20 2020 2023 2076 6572  icitly.    # ver
-0003a4e0: 6966 790a 2020 2020 2320 7365 742c 2067  ify.    # set, g
-0003a4f0: 6574 2c20 726f 6f6d 2c0a 2020 2020 2320  et, room,.    # 
-0003a500: 7365 6e64 0a20 2020 2023 206c 6973 7465  send.    # liste
-0003a510: 6e0a 2020 2020 2320 6c6f 676f 7574 0a20  n.    # logout. 
-0003a520: 2020 2023 2063 6c6f 7365 2063 6c69 656e     # close clien
-0003a530: 740a 2020 2020 2320 7379 732e 6172 6776  t.    # sys.argv
-0003a540: 206f 7264 6572 696e 673f 2023 2074 6f64   ordering? # tod
-0003a550: 6f0a 2020 2020 7472 793a 0a20 2020 2020  o.    try:.     
-0003a560: 2020 2069 6620 6773 2e70 612e 6c6f 6769     if gs.pa.logi
-0003a570: 6e3a 0a20 2020 2020 2020 2020 2020 2061  n:.            a
-0003a580: 7761 6974 2061 6374 696f 6e5f 6c6f 6769  wait action_logi
-0003a590: 6e28 2920 2023 2065 7870 6c69 6369 7420  n()  # explicit 
-0003a5a0: 6c6f 6769 6e0a 2020 2020 2020 2020 656c  login.        el
-0003a5b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003a5c0: 6177 6169 7420 696d 706c 6963 6974 5f6c  await implicit_l
-0003a5d0: 6f67 696e 2829 0a20 2020 2020 2020 2069  ogin().        i
-0003a5e0: 6620 6773 2e70 612e 7665 7269 6679 3a0a  f gs.pa.verify:.
-0003a5f0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0003a600: 7420 6163 7469 6f6e 5f76 6572 6966 7928  t action_verify(
-0003a610: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-0003a620: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-0003a630: 2020 2020 2020 2020 2020 2020 224b 6579              "Key
-0003a640: 626f 6172 6420 696e 7465 7272 7570 7420  board interrupt 
-0003a650: 7265 6365 6976 6564 2061 6674 6572 2045  received after E
-0003a660: 6d6f 6a69 2076 6572 6966 6963 6174 696f  moji verificatio
-0003a670: 6e2e 220a 2020 2020 2020 2020 2020 2020  n.".            
-0003a680: 290a 2020 2020 2020 2020 726f 6f6d 735f  ).        rooms_
-0003a690: 746f 5f6c 6f6e 675f 726f 6f6d 5f6e 616d  to_long_room_nam
-0003a6a0: 6573 2829 2020 2320 636f 6d70 6c65 7465  es()  # complete
-0003a6b0: 2072 6f6f 6d20 6e61 6d65 730a 2020 2020   room names.    
-0003a6c0: 2020 2020 6966 2067 732e 726f 6f6d 5f61      if gs.room_a
-0003a6d0: 6374 696f 6e20 6f72 2067 732e 7365 7467  ction or gs.setg
-0003a6e0: 6574 5f61 6374 696f 6e3a 0a20 2020 2020  et_action:.     
-0003a6f0: 2020 2020 2020 2061 7761 6974 2061 6374         await act
-0003a700: 696f 6e5f 726f 6f6d 7365 7467 6574 2829  ion_roomsetget()
-0003a710: 0a20 2020 2020 2020 2069 6620 6773 2e73  .        if gs.s
-0003a720: 656e 645f 6163 7469 6f6e 3a0a 2020 2020  end_action:.    
-0003a730: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
-0003a740: 7469 6f6e 5f73 656e 6428 290a 2020 2020  tion_send().    
-0003a750: 2020 2020 6966 2067 732e 6c69 7374 656e      if gs.listen
-0003a760: 5f61 6374 696f 6e3a 0a20 2020 2020 2020  _action:.       
-0003a770: 2020 2020 2061 7761 6974 2061 6374 696f       await actio
-0003a780: 6e5f 6c69 7374 656e 2829 0a20 2020 2020  n_listen().     
-0003a790: 2020 2069 6620 6773 2e70 612e 6c6f 676f     if gs.pa.logo
-0003a7a0: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-0003a7b0: 6177 6169 7420 6163 7469 6f6e 5f6c 6f67  await action_log
-0003a7c0: 6f75 7428 290a 2020 2020 6578 6365 7074  out().    except
-0003a7d0: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-0003a7e0: 2020 2020 7261 6973 650a 2020 2020 6669      raise.    fi
-0003a7f0: 6e61 6c6c 793a 0a20 2020 2020 2020 2069  nally:.        i
-0003a800: 6620 6773 2e63 6c69 656e 743a 0a20 2020  f gs.client:.   
-0003a810: 2020 2020 2020 2020 2061 7761 6974 2067           await g
-0003a820: 732e 636c 6965 6e74 2e63 6c6f 7365 2829  s.client.close()
-0003a830: 0a0a 0a64 6566 2063 6865 636b 5f61 7267  ...def check_arg
-0003a840: 5f66 696c 6573 5f72 6561 6461 626c 6528  _files_readable(
-0003a850: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-0003a860: 2222 4368 6563 6b20 6966 2066 696c 6573  ""Check if files
-0003a870: 2066 726f 6d20 636f 6d6d 616e 6420 6c69   from command li
-0003a880: 6e65 2061 7265 2072 6561 6461 626c 652e  ne are readable.
-0003a890: 2222 220a 2020 2020 6172 675f 6669 6c65  """.    arg_file
-0003a8a0: 7320 3d20 6773 2e70 612e 696d 6167 6520  s = gs.pa.image 
-0003a8b0: 6966 2067 732e 7061 2e69 6d61 6765 2065  if gs.pa.image e
-0003a8c0: 6c73 6520 5b5d 0a20 2020 2061 7267 5f66  lse [].    arg_f
-0003a8d0: 696c 6573 202b 3d20 6773 2e70 612e 6175  iles += gs.pa.au
-0003a8e0: 6469 6f20 6966 2067 732e 7061 2e61 7564  dio if gs.pa.aud
-0003a8f0: 696f 2065 6c73 6520 5b5d 0a20 2020 2061  io else [].    a
-0003a900: 7267 5f66 696c 6573 202b 3d20 6773 2e70  rg_files += gs.p
-0003a910: 612e 6669 6c65 2069 6620 6773 2e70 612e  a.file if gs.pa.
-0003a920: 6669 6c65 2065 6c73 6520 5b5d 0a20 2020  file else [].   
-0003a930: 2061 7267 5f66 696c 6573 202b 3d20 6773   arg_files += gs
-0003a940: 2e70 612e 6576 656e 7420 6966 2067 732e  .pa.event if gs.
-0003a950: 7061 2e65 7665 6e74 2065 6c73 6520 5b5d  pa.event else []
-0003a960: 0a20 2020 2072 203d 2054 7275 650a 2020  .    r = True.  
-0003a970: 2020 6572 7274 7874 203d 2028 0a20 2020    errtxt = (.   
-0003a980: 2020 2020 2022 4532 3336 3a20 220a 2020       "E236: ".  
-0003a990: 2020 2020 2020 2254 6865 7365 2066 696c        "These fil
-0003a9a0: 6573 2073 7065 6369 6669 6564 2069 6e20  es specified in 
-0003a9b0: 7468 6520 636f 6d6d 616e 6420 6c69 6e65  the command line
-0003a9c0: 2077 6572 6520 6e6f 7420 666f 756e 6420   were not found 
-0003a9d0: 220a 2020 2020 2020 2020 226f 7220 6172  ".        "or ar
-0003a9e0: 6520 6e6f 7420 7265 6164 6162 6c65 3a20  e not readable: 
-0003a9f0: 220a 2020 2020 290a 2020 2020 666f 7220  ".    ).    for 
-0003aa00: 666e 2069 6e20 6172 675f 6669 6c65 733a  fn in arg_files:
-0003aa10: 0a20 2020 2020 2020 2069 6620 2866 6e20  .        if (fn 
-0003aa20: 213d 2022 2d22 2920 616e 6420 6e6f 7420  != "-") and not 
-0003aa30: 2869 7366 696c 6528 666e 2920 616e 6420  (isfile(fn) and 
-0003aa40: 6163 6365 7373 2866 6e2c 2052 5f4f 4b29  access(fn, R_OK)
-0003aa50: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0003aa60: 6620 6e6f 7420 723a 0a20 2020 2020 2020  f not r:.       
-0003aa70: 2020 2020 2020 2020 2065 7272 7478 7420           errtxt 
-0003aa80: 2b3d 2022 2c20 220a 2020 2020 2020 2020  += ", ".        
-0003aa90: 2020 2020 6572 7274 7874 202b 3d20 6627      errtxt += f'
-0003aaa0: 227b 666e 7d22 270a 2020 2020 2020 2020  "{fn}"'.        
-0003aab0: 2020 2020 7220 3d20 4661 6c73 650a 2020      r = False.  
-0003aac0: 2020 2020 2020 2020 2020 6572 7266 696c            errfil
-0003aad0: 6520 3d20 666e 0a20 2020 2069 6620 6e6f  e = fn.    if no
-0003aae0: 7420 723a 0a20 2020 2020 2020 2072 6169  t r:.        rai
-0003aaf0: 7365 2046 696c 654e 6f74 466f 756e 6445  se FileNotFoundE
-0003ab00: 7272 6f72 2865 7272 6e6f 2e45 4e4f 454e  rror(errno.ENOEN
-0003ab10: 542c 2065 7272 7478 742c 2065 7272 6669  T, errtxt, errfi
-0003ab20: 6c65 290a 0a0a 6465 6620 6368 6563 6b5f  le)...def check_
-0003ab30: 646f 776e 6c6f 6164 5f6d 6564 6961 5f64  download_media_d
-0003ab40: 6972 2829 202d 3e20 4e6f 6e65 3a0a 2020  ir() -> None:.  
-0003ab50: 2020 2222 2243 6865 636b 2069 6620 6d65    """Check if me
-0003ab60: 6469 6120 646f 776e 6c6f 6164 2064 6972  dia download dir
-0003ab70: 6563 746f 7279 2069 7320 636f 7272 6563  ectory is correc
-0003ab80: 742e 2222 220a 2020 2020 6966 206e 6f74  t.""".    if not
-0003ab90: 2067 732e 7061 2e64 6f77 6e6c 6f61 645f   gs.pa.download_
-0003aba0: 6d65 6469 613a 0a20 2020 2020 2020 2072  media:.        r
-0003abb0: 6574 7572 6e20 2023 2022 223a 2074 6861  eturn  # "": tha
-0003abc0: 7420 6d65 616e 7320 6e6f 2064 6f77 6e6c  t means no downl
-0003abd0: 6f61 6420 6f66 206d 6564 6961 2c20 7661  oad of media, va
-0003abe0: 6c69 6420 7661 6c75 650a 2020 2020 2320  lid value.    # 
-0003abf0: 6e6f 726d 6169 6c7a 6564 2066 6f72 2068  normailzed for h
-0003ac00: 756d 616e 730a 2020 2020 646c 203d 206f  umans.    dl = o
-0003ac10: 732e 7061 7468 2e6e 6f72 6d70 6174 6828  s.path.normpath(
-0003ac20: 6773 2e70 612e 646f 776e 6c6f 6164 5f6d  gs.pa.download_m
-0003ac30: 6564 6961 290a 2020 2020 6773 2e70 612e  edia).    gs.pa.
-0003ac40: 646f 776e 6c6f 6164 5f6d 6564 6961 203d  download_media =
-0003ac50: 2064 6c0a 2020 2020 6966 206f 732e 7061   dl.    if os.pa
-0003ac60: 7468 2e69 7366 696c 6528 646c 293a 0a20  th.isfile(dl):. 
-0003ac70: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
-0003ac80: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
-0003ac90: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-0003aca0: 6e6f 2e45 4e4f 5444 4952 2c0a 2020 2020  no.ENOTDIR,.    
-0003acb0: 2020 2020 2020 2020 2245 3233 373a 2022          "E237: "
-0003acc0: 0a20 2020 2020 2020 2020 2020 2066 2722  .            f'"
-0003acd0: 7b64 6c7d 2220 6361 6e6e 6f74 2062 6520  {dl}" cannot be 
-0003ace0: 7573 6564 2061 7320 6d65 6469 6120 6469  used as media di
-0003acf0: 7265 6374 6f72 792c 2062 6563 6175 7365  rectory, because
-0003ad00: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-0003ad10: 2722 7b64 6c7d 2220 6973 2061 2066 696c  '"{dl}" is a fil
-0003ad20: 652e 2053 7065 6369 6679 2061 2064 6966  e. Specify a dif
-0003ad30: 6665 7265 6e74 2064 6972 6563 746f 7279  ferent directory
-0003ad40: 2066 6f72 2064 6f77 6e6c 6f61 6469 6e67   for downloading
-0003ad50: 2027 0a20 2020 2020 2020 2020 2020 2022   '.            "
-0003ad60: 6d65 6469 612e 222c 0a20 2020 2020 2020  media.",.       
-0003ad70: 2020 2020 2064 6c2c 0a20 2020 2020 2020       dl,.       
-0003ad80: 2029 0a20 2020 2069 6620 6f73 2e70 6174   ).    if os.pat
-0003ad90: 682e 6973 6469 7228 646c 293a 0a20 2020  h.isdir(dl):.   
-0003ada0: 2020 2020 2069 6620 6f73 2e61 6363 6573       if os.acces
-0003adb0: 7328 646c 2c20 6f73 2e57 5f4f 4b29 3a20  s(dl, os.W_OK): 
-0003adc0: 2023 2043 6865 636b 2066 6f72 2077 7269   # Check for wri
-0003add0: 7465 2061 6363 6573 730a 2020 2020 2020  te access.      
-0003ade0: 2020 2020 2020 7265 7475 726e 2020 2320        return  # 
-0003adf0: 616c 6c20 4f4b 0a20 2020 2020 2020 2065  all OK.        e
-0003ae00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003ae10: 2072 6169 7365 2050 6572 6d69 7373 696f   raise Permissio
-0003ae20: 6e45 7272 6f72 280a 2020 2020 2020 2020  nError(.        
-0003ae30: 2020 2020 2020 2020 6572 726e 6f2e 4550          errno.EP
-0003ae40: 4552 4d2c 0a20 2020 2020 2020 2020 2020  ERM,.           
-0003ae50: 2020 2020 2022 4532 3338 3a20 220a 2020       "E238: ".  
-0003ae60: 2020 2020 2020 2020 2020 2020 2020 2246                "F
-0003ae70: 6f75 6e64 2061 6e20 6578 6973 7469 6e67  ound an existing
-0003ae80: 206d 6564 6961 2064 6f77 6e6c 6f61 6420   media download 
-0003ae90: 6469 7265 6374 6f72 7920 220a 2020 2020  directory ".    
-0003aea0: 2020 2020 2020 2020 2020 2020 6627 227b              f'"{
-0003aeb0: 646c 7d22 2e20 4275 7420 7468 6973 2064  dl}". But this d
-0003aec0: 6972 6563 746f 7279 2069 7320 6c61 636b  irectory is lack
-0003aed0: 696e 6720 7772 6974 6520 270a 2020 2020  ing write '.    
-0003aee0: 2020 2020 2020 2020 2020 2020 2270 6572              "per
-0003aef0: 6d69 7373 696f 6e73 2e20 4164 6420 7772  missions. Add wr
-0003af00: 6974 6520 7065 726d 6973 7369 6f6e 7320  ite permissions 
-0003af10: 746f 2069 742e 222c 0a20 2020 2020 2020  to it.",.       
-0003af20: 2020 2020 2020 2020 2064 6c2c 0a20 2020           dl,.   
-0003af30: 2020 2020 2020 2020 2029 0a20 2020 2065           ).    e
-0003af40: 6c73 653a 0a20 2020 2020 2020 2023 206e  lse:.        # n
-0003af50: 6f74 2061 2066 696c 652c 206e 6f74 2061  ot a file, not a
-0003af60: 2064 6972 6563 746f 7279 2c20 6372 6561   directory, crea
-0003af70: 7465 2064 6972 6563 746f 7279 0a20 2020  te directory.   
-0003af80: 2020 2020 206d 6f64 6520 3d20 306f 3737       mode = 0o77
-0003af90: 370a 2020 2020 2020 2020 7472 793a 0a20  7.        try:. 
-0003afa0: 2020 2020 2020 2020 2020 206f 732e 6d6b             os.mk
-0003afb0: 6469 7228 646c 2c20 6d6f 6465 290a 2020  dir(dl, mode).  
-0003afc0: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
-0003afd0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-0003afe0: 2020 2020 2020 2072 6169 7365 204f 5345         raise OSE
-0003aff0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0003b000: 2020 2020 2020 652e 6572 726e 6f2c 0a20        e.errno,. 
-0003b010: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003b020: 4532 3339 3a20 220a 2020 2020 2020 2020  E239: ".        
-0003b030: 2020 2020 2020 2020 2243 6f75 6c64 206e          "Could n
-0003b040: 6f74 2063 7265 6174 6520 6d65 6469 6120  ot create media 
-0003b050: 646f 776e 6c6f 6164 2064 6972 6563 746f  download directo
-0003b060: 7279 2022 0a20 2020 2020 2020 2020 2020  ry ".           
-0003b070: 2020 2020 2066 227b 646c 7d20 666f 7220       f"{dl} for 
-0003b080: 796f 752e 2028 7b65 7d29 222c 0a20 2020  you. ({e})",.   
-0003b090: 2020 2020 2020 2020 2020 2020 2064 6c2c               dl,
-0003b0a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0003b0b0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0003b0c0: 6275 6728 6627 4372 6561 7465 6420 6d65  bug(f'Created me
-0003b0d0: 6469 6120 646f 776e 6c6f 6164 2064 6972  dia download dir
-0003b0e0: 6563 746f 7279 2022 7b64 6c7d 2220 666f  ectory "{dl}" fo
-0003b0f0: 7220 796f 752e 2729 0a0a 0a64 6566 2063  r you.')...def c
-0003b100: 6865 636b 5f76 6572 7369 6f6e 2829 202d  heck_version() -
-0003b110: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2243  > None:.    """C
-0003b120: 6865 636b 2069 6620 6c61 7465 7374 2076  heck if latest v
-0003b130: 6572 7369 6f6e 2e22 2222 0a20 2020 2070  ersion.""".    p
-0003b140: 6b67 203d 2050 524f 475f 5749 5448 4f55  kg = PROG_WITHOU
-0003b150: 545f 4558 540a 2020 2020 7665 7220 3d20  T_EXT.    ver = 
-0003b160: 5645 5253 494f 4e4e 5220 2023 2064 6566  VERSIONNR  # def
-0003b170: 6175 6c74 2c20 6661 6c6c 6261 636b 0a20  ault, fallback. 
-0003b180: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0003b190: 7665 7220 3d20 706b 675f 7265 736f 7572  ver = pkg_resour
-0003b1a0: 6365 732e 6765 745f 6469 7374 7269 6275  ces.get_distribu
-0003b1b0: 7469 6f6e 2870 6b67 292e 7665 7273 696f  tion(pkg).versio
-0003b1c0: 6e0a 2020 2020 6578 6365 7074 2045 7863  n.    except Exc
-0003b1d0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0003b1e0: 7061 7373 2020 2320 6966 2069 6e73 7461  pass  # if insta
-0003b1f0: 6c6c 6564 2076 6961 2067 6974 2063 6c6f  lled via git clo
-0003b200: 6e65 2c20 7061 636b 6167 6520 7769 6c6c  ne, package will
-0003b210: 206e 6f74 2065 7869 7374 730a 0a20 2020   not exists..   
-0003b220: 2069 6e73 7461 6c6c 6564 5f76 6572 7369   installed_versi
-0003b230: 6f6e 203d 204c 6f6f 7365 5665 7273 696f  on = LooseVersio
-0003b240: 6e28 7665 7229 0a20 2020 2023 2066 6574  n(ver).    # fet
-0003b250: 6368 2070 6163 6b61 6765 206d 6574 6164  ch package metad
-0003b260: 6174 6120 6672 6f6d 2050 7950 490a 2020  ata from PyPI.  
-0003b270: 2020 7079 7069 5f75 726c 203d 2066 2268    pypi_url = f"h
-0003b280: 7474 7073 3a2f 2f70 7970 692e 6f72 672f  ttps://pypi.org/
-0003b290: 7079 7069 2f7b 706b 677d 2f6a 736f 6e22  pypi/{pkg}/json"
-0003b2a0: 0a20 2020 2072 6573 706f 6e73 6520 3d20  .    response = 
-0003b2b0: 7572 6c6c 6962 2e72 6571 7565 7374 2e75  urllib.request.u
-0003b2c0: 726c 6f70 656e 2870 7970 695f 7572 6c29  rlopen(pypi_url)
-0003b2d0: 2e72 6561 6428 292e 6465 636f 6465 2829  .read().decode()
-0003b2e0: 0a20 2020 206c 6174 6573 745f 7665 7273  .    latest_vers
-0003b2f0: 696f 6e20 3d20 6d61 7828 0a20 2020 2020  ion = max(.     
-0003b300: 2020 204c 6f6f 7365 5665 7273 696f 6e28     LooseVersion(
-0003b310: 7329 2066 6f72 2073 2069 6e20 6a73 6f6e  s) for s in json
-0003b320: 2e6c 6f61 6473 2872 6573 706f 6e73 6529  .loads(response)
-0003b330: 5b22 7265 6c65 6173 6573 225d 2e6b 6579  ["releases"].key
-0003b340: 7328 290a 2020 2020 290a 2020 2020 6966  s().    ).    if
-0003b350: 2069 6e73 7461 6c6c 6564 5f76 6572 7369   installed_versi
-0003b360: 6f6e 203e 3d20 6c61 7465 7374 5f76 6572  on >= latest_ver
-0003b370: 7369 6f6e 3a0a 2020 2020 2020 2020 7574  sion:.        ut
-0003b380: 6420 3d20 2259 6f75 2061 7265 2075 702d  d = "You are up-
-0003b390: 746f 2d64 6174 6521 220a 2020 2020 656c  to-date!".    el
-0003b3a0: 7365 3a0a 2020 2020 2020 2020 7574 6420  se:.        utd 
-0003b3b0: 3d20 2243 6f6e 7369 6465 7220 7570 6461  = "Consider upda
-0003b3c0: 7469 6e67 2122 0a20 2020 2076 6572 7369  ting!".    versi
-0003b3d0: 6f6e 5f69 6e66 6f20 3d20 280a 2020 2020  on_info = (.    
-0003b3e0: 2020 2020 6622 7061 636b 6167 653a 207b      f"package: {
-0003b3f0: 706b 677d 2c20 696e 7374 616c 6c65 643a  pkg}, installed:
-0003b400: 207b 696e 7374 616c 6c65 645f 7665 7273   {installed_vers
-0003b410: 696f 6e7d 2c20 220a 2020 2020 2020 2020  ion}, ".        
-0003b420: 6622 6c61 7465 7374 3a20 7b6c 6174 6573  f"latest: {lates
-0003b430: 745f 7665 7273 696f 6e7d 203d 3d3e 207b  t_version} ==> {
-0003b440: 7574 647d 220a 2020 2020 290a 2020 2020  utd}".    ).    
-0003b450: 6773 2e6c 6f67 2e64 6562 7567 2876 6572  gs.log.debug(ver
-0003b460: 7369 6f6e 5f69 6e66 6f29 0a20 2020 2023  sion_info).    #
-0003b470: 206f 7574 7075 7420 666f 726d 6174 2063   output format c
-0003b480: 6f6e 7472 6f6c 6c65 6420 7669 6120 2d2d  ontrolled via --
-0003b490: 6f75 7470 7574 2066 6c61 670a 2020 2020  output flag.    
-0003b4a0: 7465 7874 203d 2076 6572 7369 6f6e 5f69  text = version_i
-0003b4b0: 6e66 6f0a 2020 2020 6a73 6f6e 5f6d 6178  nfo.    json_max
-0003b4c0: 203d 207b 0a20 2020 2020 2020 2022 7061   = {.        "pa
-0003b4d0: 636b 6167 6522 3a20 6622 7b70 6b67 7d22  ckage": f"{pkg}"
-0003b4e0: 2c0a 2020 2020 2020 2020 2276 6572 7369  ,.        "versi
-0003b4f0: 6f6e 5f69 6e73 7461 6c6c 6564 223a 2066  on_installed": f
-0003b500: 227b 696e 7374 616c 6c65 645f 7665 7273  "{installed_vers
-0003b510: 696f 6e7d 222c 0a20 2020 2020 2020 2022  ion}",.        "
-0003b520: 7665 7273 696f 6e5f 6c61 7465 7374 223a  version_latest":
-0003b530: 2066 227b 6c61 7465 7374 5f76 6572 7369   f"{latest_versi
-0003b540: 6f6e 7d22 2c0a 2020 2020 2020 2020 2263  on}",.        "c
-0003b550: 6f6d 6d65 6e74 223a 2066 227b 7574 647d  omment": f"{utd}
-0003b560: 222c 0a20 2020 207d 0a20 2020 2023 206a  ",.    }.    # j
-0003b570: 736f 6e5f 6d61 782e 7570 6461 7465 287b  son_max.update({
-0003b580: 226b 6579 223a 2076 616c 7565 7d29 2020  "key": value})  
-0003b590: 2320 6164 6420 6469 6374 2069 7465 6d73  # add dict items
-0003b5a0: 0a20 2020 206a 736f 6e5f 203d 206a 736f  .    json_ = jso
-0003b5b0: 6e5f 6d61 782e 636f 7079 2829 0a20 2020  n_max.copy().   
-0003b5c0: 2023 206a 736f 6e5f 2e70 6f70 2822 6b65   # json_.pop("ke
-0003b5d0: 7922 290a 2020 2020 6a73 6f6e 5f73 7065  y").    json_spe
-0003b5e0: 6320 3d20 4e6f 6e65 0a20 2020 2070 7269  c = None.    pri
-0003b5f0: 6e74 5f6f 7574 7075 7428 0a20 2020 2020  nt_output(.     
-0003b600: 2020 2067 732e 7061 2e6f 7574 7075 742c     gs.pa.output,
-0003b610: 0a20 2020 2020 2020 2074 6578 743d 7465  .        text=te
-0003b620: 7874 2c0a 2020 2020 2020 2020 6a73 6f6e  xt,.        json
-0003b630: 5f3d 6a73 6f6e 5f2c 0a20 2020 2020 2020  _=json_,.       
-0003b640: 206a 736f 6e5f 6d61 783d 6a73 6f6e 5f6d   json_max=json_m
-0003b650: 6178 2c0a 2020 2020 2020 2020 6a73 6f6e  ax,.        json
-0003b660: 5f73 7065 633d 6a73 6f6e 5f73 7065 632c  _spec=json_spec,
-0003b670: 0a20 2020 2029 0a0a 0a64 6566 2076 6572  .    )...def ver
-0003b680: 7369 6f6e 2829 202d 3e20 4e6f 6e65 3a0a  sion() -> None:.
-0003b690: 2020 2020 2222 2250 7269 6e74 2076 6572      """Print ver
-0003b6a0: 7369 6f6e 2069 6e66 6f2e 2222 220a 2020  sion info.""".  
-0003b6b0: 2020 6e69 6f5f 7665 7273 696f 6e20 3d20    nio_version = 
-0003b6c0: 706b 675f 7265 736f 7572 6365 732e 6765  pkg_resources.ge
-0003b6d0: 745f 6469 7374 7269 6275 7469 6f6e 2822  t_distribution("
-0003b6e0: 6d61 7472 6978 2d6e 696f 2229 2e76 6572  matrix-nio").ver
-0003b6f0: 7369 6f6e 0a20 2020 2070 7974 686f 6e5f  sion.    python_
-0003b700: 7665 7273 696f 6e20 3d20 7379 732e 7665  version = sys.ve
-0003b710: 7273 696f 6e0a 2020 2020 7079 7468 6f6e  rsion.    python
-0003b720: 5f76 6572 7369 6f6e 5f6e 7220 3d20 280a  _version_nr = (.
-0003b730: 2020 2020 2020 2020 7374 7228 7379 732e          str(sys.
-0003b740: 7665 7273 696f 6e5f 696e 666f 2e6d 616a  version_info.maj
-0003b750: 6f72 290a 2020 2020 2020 2020 2b20 222e  or).        + ".
-0003b760: 220a 2020 2020 2020 2020 2b20 7374 7228  ".        + str(
-0003b770: 7379 732e 7665 7273 696f 6e5f 696e 666f  sys.version_info
-0003b780: 2e6d 696e 6f72 290a 2020 2020 2020 2020  .minor).        
-0003b790: 2b20 222e 220a 2020 2020 2020 2020 2b20  + ".".        + 
-0003b7a0: 7374 7228 7379 732e 7665 7273 696f 6e5f  str(sys.version_
-0003b7b0: 696e 666f 2e6d 6963 726f 290a 2020 2020  info.micro).    
-0003b7c0: 290a 2020 2020 7665 7273 696f 6e5f 696e  ).    version_in
-0003b7d0: 666f 203d 2028 0a20 2020 2020 2020 2022  fo = (.        "
-0003b7e0: 5c6e 220a 2020 2020 2020 2020 6622 2020  \n".        f"  
-0003b7f0: 5f7c 2020 2020 2020 5f7c 2020 2020 2020  _|      _|      
-0003b800: 5f7c 5f7c 5f7c 2020 2020 5f7c 2020 2020  _|_|_|    _|    
-0003b810: 2020 207b 5052 4f47 5f57 4954 484f 5554     {PROG_WITHOUT
-0003b820: 5f45 5854 7d3a 2022 0a20 2020 2020 2020  _EXT}: ".       
-0003b830: 2066 227b 5645 5253 494f 4e4e 527d 207b   f"{VERSIONNR} {
-0003b840: 5645 5253 494f 4e7d 5c6e 220a 2020 2020  VERSION}\n".    
-0003b850: 2020 2020 2220 205f 7c5f 7c20 205f 7c5f      "  _|_|  _|_
-0003b860: 7c20 2020 205f 7c20 2020 2020 2020 2020  |    _|         
-0003b870: 2020 205f 7c20 2020 2020 6120 4d61 7472     _|     a Matr
-0003b880: 6978 2043 4c49 2063 6c69 656e 745c 6e22  ix CLI client\n"
-0003b890: 0a20 2020 2020 2020 2022 2020 5f7c 2020  .        "  _|  
-0003b8a0: 5f7c 2020 5f7c 2020 2020 5f7c 2020 2020  _|  _|    _|    
-0003b8b0: 2020 2020 2020 2020 2020 5f7c 2020 2065            _|   e
-0003b8c0: 6e6a 6f79 2061 6e64 2073 7562 6d69 7420  njoy and submit 
-0003b8d0: 5052 735c 6e22 0a20 2020 2020 2020 2066  PRs\n".        f
-0003b8e0: 2220 205f 7c20 2020 2020 205f 7c20 2020  "  _|      _|   
-0003b8f0: 205f 7c20 2020 2020 2020 2020 2020 205f   _|            _
-0003b900: 7c20 2020 2020 6d61 7472 6978 2d6e 696f  |     matrix-nio
-0003b910: 3a20 7b6e 696f 5f76 6572 7369 6f6e 7d5c  : {nio_version}\
-0003b920: 6e22 0a20 2020 2020 2020 2066 2220 205f  n".        f"  _
-0003b930: 7c20 2020 2020 205f 7c20 2020 2020 205f  |      _|      _
-0003b940: 7c5f 7c5f 7c20 2020 205f 7c20 2020 2020  |_|_|    _|     
-0003b950: 2020 5079 7468 6f6e 3a20 7b70 7974 686f    Python: {pytho
-0003b960: 6e5f 7665 7273 696f 6e5f 6e72 7d5c 6e22  n_version_nr}\n"
-0003b970: 0a20 2020 2020 2020 2022 5c6e 220a 2020  .        "\n".  
-0003b980: 2020 290a 2020 2020 6773 2e6c 6f67 2e64    ).    gs.log.d
-0003b990: 6562 7567 2876 6572 7369 6f6e 5f69 6e66  ebug(version_inf
-0003b9a0: 6f29 0a20 2020 2023 206f 7574 7075 7420  o).    # output 
-0003b9b0: 666f 726d 6174 2063 6f6e 7472 6f6c 6c65  format controlle
-0003b9c0: 6420 7669 6120 2d2d 6f75 7470 7574 2066  d via --output f
-0003b9d0: 6c61 670a 2020 2020 7465 7874 203d 2076  lag.    text = v
-0003b9e0: 6572 7369 6f6e 5f69 6e66 6f0a 2020 2020  ersion_info.    
-0003b9f0: 6a73 6f6e 5f6d 6178 203d 207b 0a20 2020  json_max = {.   
-0003ba00: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
-0003ba10: 484f 5554 5f45 5854 7d22 3a20 7b0a 2020  HOUT_EXT}": {.  
-0003ba20: 2020 2020 2020 2020 2020 2276 6572 7369            "versi
-0003ba30: 6f6e 223a 2066 227b 5645 5253 494f 4e4e  on": f"{VERSIONN
-0003ba40: 527d 222c 0a20 2020 2020 2020 2020 2020  R}",.           
-0003ba50: 2022 6461 7465 223a 2066 227b 5645 5253   "date": f"{VERS
-0003ba60: 494f 4e7d 222c 0a20 2020 2020 2020 207d  ION}",.        }
-0003ba70: 2c0a 2020 2020 2020 2020 226d 6174 7269  ,.        "matri
-0003ba80: 782d 6e69 6f22 3a20 7b0a 2020 2020 2020  x-nio": {.      
-0003ba90: 2020 2020 2020 2276 6572 7369 6f6e 223a        "version":
-0003baa0: 2066 227b 6e69 6f5f 7665 7273 696f 6e7d   f"{nio_version}
-0003bab0: 222c 0a20 2020 2020 2020 207d 2c0a 2020  ",.        },.  
-0003bac0: 2020 2020 2020 2270 7974 686f 6e22 3a20        "python": 
-0003bad0: 7b0a 2020 2020 2020 2020 2020 2020 2276  {.            "v
-0003bae0: 6572 7369 6f6e 223a 2066 227b 7079 7468  ersion": f"{pyth
-0003baf0: 6f6e 5f76 6572 7369 6f6e 5f6e 727d 222c  on_version_nr}",
-0003bb00: 0a20 2020 2020 2020 2020 2020 2022 696e  .            "in
-0003bb10: 666f 223a 2066 227b 7079 7468 6f6e 5f76  fo": f"{python_v
-0003bb20: 6572 7369 6f6e 7d22 2c0a 2020 2020 2020  ersion}",.      
-0003bb30: 2020 7d2c 0a20 2020 207d 0a20 2020 2023    },.    }.    #
-0003bb40: 206a 736f 6e5f 6d61 782e 7570 6461 7465   json_max.update
-0003bb50: 287b 226b 6579 223a 2076 616c 7565 7d29  ({"key": value})
-0003bb60: 2020 2320 6164 6420 6469 6374 2069 7465    # add dict ite
-0003bb70: 6d73 0a20 2020 206a 736f 6e5f 203d 206a  ms.    json_ = j
-0003bb80: 736f 6e5f 6d61 782e 636f 7079 2829 0a20  son_max.copy(). 
-0003bb90: 2020 2023 206a 736f 6e5f 2e70 6f70 2822     # json_.pop("
-0003bba0: 6b65 7922 290a 2020 2020 6a73 6f6e 5f73  key").    json_s
-0003bbb0: 7065 6320 3d20 4e6f 6e65 0a20 2020 2070  pec = None.    p
-0003bbc0: 7269 6e74 5f6f 7574 7075 7428 0a20 2020  rint_output(.   
-0003bbd0: 2020 2020 2067 732e 7061 2e6f 7574 7075       gs.pa.outpu
-0003bbe0: 742c 0a20 2020 2020 2020 2074 6578 743d  t,.        text=
-0003bbf0: 7465 7874 2c0a 2020 2020 2020 2020 6a73  text,.        js
-0003bc00: 6f6e 5f3d 6a73 6f6e 5f2c 0a20 2020 2020  on_=json_,.     
-0003bc10: 2020 206a 736f 6e5f 6d61 783d 6a73 6f6e     json_max=json
-0003bc20: 5f6d 6178 2c0a 2020 2020 2020 2020 6a73  _max,.        js
-0003bc30: 6f6e 5f73 7065 633d 6a73 6f6e 5f73 7065  on_spec=json_spe
-0003bc40: 632c 0a20 2020 2029 0a0a 0a64 6566 2069  c,.    )...def i
-0003bc50: 6e69 7469 616c 5f63 6865 636b 5f6f 665f  nitial_check_of_
-0003bc60: 6c6f 675f 6172 6773 2829 202d 3e20 4e6f  log_args() -> No
-0003bc70: 6e65 3a0a 2020 2020 2222 2243 6865 636b  ne:.    """Check
-0003bc80: 206c 6f67 6769 6e67 2072 656c 6174 6564   logging related
-0003bc90: 2061 7267 756d 656e 7473 2e0a 0a20 2020   arguments...   
-0003bca0: 2041 7267 756d 656e 7473 3a0a 2020 2020   Arguments:.    
-0003bcb0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 4e6f  ---------.    No
-0003bcc0: 6e65 0a0a 2020 2020 5265 7475 726e 733a  ne..    Returns:
-0003bcd0: 204e 6f6e 650a 0a20 2020 2052 6169 7365   None..    Raise
-0003bce0: 7320 6578 6365 7074 696f 6e20 6f6e 2065  s exception on e
-0003bcf0: 7272 6f72 2e0a 2020 2020 2222 220a 2020  rror..    """.  
-0003bd00: 2020 6966 206e 6f74 2067 732e 7061 2e6c    if not gs.pa.l
-0003bd10: 6f67 5f6c 6576 656c 3a0a 2020 2020 2020  og_level:.      
-0003bd20: 2020 7265 7475 726e 2020 2320 616c 6c20    return  # all 
-0003bd30: 4f4b 0a20 2020 2066 6f72 2069 2069 6e20  OK.    for i in 
-0003bd40: 7261 6e67 6528 6c65 6e28 6773 2e70 612e  range(len(gs.pa.
-0003bd50: 6c6f 675f 6c65 7665 6c29 293a 0a20 2020  log_level)):.   
-0003bd60: 2020 2020 2075 7020 3d20 6773 2e70 612e       up = gs.pa.
-0003bd70: 6c6f 675f 6c65 7665 6c5b 695d 2e75 7070  log_level[i].upp
-0003bd80: 6572 2829 0a20 2020 2020 2020 2067 732e  er().        gs.
-0003bd90: 7061 2e6c 6f67 5f6c 6576 656c 5b69 5d20  pa.log_level[i] 
-0003bda0: 3d20 7570 0a20 2020 2020 2020 2069 6620  = up.        if 
-0003bdb0: 7570 206e 6f74 2069 6e20 5b22 4445 4255  up not in ["DEBU
-0003bdc0: 4722 2c20 2249 4e46 4f22 2c20 2257 4152  G", "INFO", "WAR
-0003bdd0: 4e49 4e47 222c 2022 4552 524f 5222 2c20  NING", "ERROR", 
-0003bde0: 2243 5249 5449 4341 4c22 5d3a 0a20 2020  "CRITICAL"]:.   
-0003bdf0: 2020 2020 2020 2020 2023 2067 732e 6572           # gs.er
-0003be00: 725f 636f 756e 7420 2b3d 2031 2020 2320  r_count += 1  # 
-0003be10: 7772 6f6e 670a 2020 2020 2020 2020 2020  wrong.          
-0003be20: 2020 7261 6973 6520 4d61 7472 6978 436f    raise MatrixCo
-0003be30: 6d6d 616e 6465 7245 7272 6f72 280a 2020  mmanderError(.  
-0003be40: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-0003be50: 3234 313a 2022 0a20 2020 2020 2020 2020  241: ".         
-0003be60: 2020 2020 2020 2027 2d2d 6c6f 672d 6c65         '--log-le
-0003be70: 7665 6c20 6f6e 6c79 2061 6c6c 6f77 7320  vel only allows 
-0003be80: 7661 6c75 6573 2022 4445 4255 4722 2c20  values "DEBUG", 
-0003be90: 2249 4e46 4f22 2c20 2257 4152 4e49 4e47  "INFO", "WARNING
-0003bea0: 222c 2027 0a20 2020 2020 2020 2020 2020  ", '.           
-0003beb0: 2020 2020 2027 2245 5252 4f52 222c 206f       '"ERROR", o
-0003bec0: 7220 2243 5249 5449 4341 4c22 2e20 2d2d  r "CRITICAL". --
-0003bed0: 6c6f 672d 6c65 7665 6c20 6172 6775 6d65  log-level argume
-0003bee0: 6e74 2069 6e63 6f72 7265 6374 2e20 270a  nt incorrect. '.
-0003bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bf00: 6622 287b 7570 7d29 220a 2020 2020 2020  f"({up})".      
-0003bf10: 2020 2020 2020 2920 6672 6f6d 204e 6f6e        ) from Non
-0003bf20: 650a 0a0a 2320 6163 636f 7264 696e 6720  e...# according 
-0003bf30: 746f 2070 796c 616d 613a 2066 756e 6374  to pylama: funct
-0003bf40: 696f 6e20 746f 6f20 636f 6d70 6c65 783a  ion too complex:
-0003bf50: 2043 3930 3120 2320 6e6f 7161 3a20 4339   C901 # noqa: C9
-0003bf60: 3031 0a64 6566 2069 6e69 7469 616c 5f63  01.def initial_c
-0003bf70: 6865 636b 5f6f 665f 6172 6773 2829 202d  heck_of_args() -
-0003bf80: 3e20 4e6f 6e65 3a20 2023 206e 6f71 613a  > None:  # noqa:
-0003bf90: 2043 3930 310a 2020 2020 2222 2243 6865   C901.    """Che
-0003bfa0: 636b 2061 7267 756d 656e 7473 2e22 2222  ck arguments."""
-0003bfb0: 0a20 2020 2023 2046 6972 7374 2c20 7468  .    # First, th
-0003bfc0: 6520 6164 6a75 7374 6d65 6e74 730a 2020  e adjustments.  
-0003bfd0: 2020 6966 206e 6f74 2067 732e 7061 2e65    if not gs.pa.e
-0003bfe0: 6e63 7279 7074 6564 3a0a 2020 2020 2020  ncrypted:.      
-0003bff0: 2020 6773 2e70 612e 656e 6372 7970 7465    gs.pa.encrypte
-0003c000: 6420 3d20 5472 7565 2020 2320 666f 7263  d = True  # forc
-0003c010: 6520 6974 206f 6e0a 2020 2020 2020 2020  e it on.        
-0003c020: 6773 2e6c 6f67 2e64 6562 7567 280a 2020  gs.log.debug(.  
-0003c030: 2020 2020 2020 2020 2020 2245 6e63 7279            "Encry
-0003c040: 7074 696f 6e20 6973 2061 6c77 6179 7320  ption is always 
-0003c050: 656e 6162 6c65 642e 2049 7420 6361 6e6e  enabled. It cann
-0003c060: 6f74 2062 6520 7475 726e 6564 206f 6666  ot be turned off
-0003c070: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0003c080: 2255 7365 202d 2d74 6169 6c20 746f 2064  "Use --tail to d
-0003c090: 6973 6162 6c65 2069 7420 666f 7220 7370  isable it for sp
-0003c0a0: 6563 6966 6963 2075 7365 2063 6173 6573  ecific use cases
-0003c0b0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-0003c0c0: 2069 6620 6e6f 7420 6773 2e70 612e 656e   if not gs.pa.en
-0003c0d0: 6372 7970 7465 643a 2020 2320 6a75 7374  crypted:  # just
-0003c0e0: 2069 6e20 6361 7365 2077 6520 6576 6572   in case we ever
-0003c0f0: 2067 6f20 6261 636b 2064 6973 6162 6c69   go back disabli
-0003c100: 6e67 2065 3265 0a20 2020 2020 2020 2067  ng e2e.        g
-0003c110: 732e 7061 2e73 746f 7265 203d 204e 6f6e  s.pa.store = Non
-0003c120: 650a 2020 2020 6966 2067 732e 7061 2e6c  e.    if gs.pa.l
-0003c130: 6973 7465 6e3a 0a20 2020 2020 2020 2067  isten:.        g
-0003c140: 732e 7061 2e6c 6973 7465 6e20 3d20 6773  s.pa.listen = gs
-0003c150: 2e70 612e 6c69 7374 656e 2e6c 6f77 6572  .pa.listen.lower
-0003c160: 2829 0a20 2020 2069 6620 6773 2e70 612e  ().    if gs.pa.
-0003c170: 6c69 7374 656e 203d 3d20 4e45 5645 5220  listen == NEVER 
-0003c180: 616e 6420 6773 2e70 612e 7461 696c 2021  and gs.pa.tail !
-0003c190: 3d20 303a 0a20 2020 2020 2020 2067 732e  = 0:.        gs.
-0003c1a0: 7061 2e6c 6973 7465 6e20 3d20 5441 494c  pa.listen = TAIL
-0003c1b0: 2020 2320 2d2d 7461 696c 2074 7572 6e73    # --tail turns
-0003c1c0: 206f 6e20 2d2d 6c69 7374 656e 2054 4149   on --listen TAI
-0003c1d0: 4c0a 2020 2020 2020 2020 6773 2e6c 6f67  L.        gs.log
-0003c1e0: 2e64 6562 7567 2827 2d2d 6c69 7374 656e  .debug('--listen
-0003c1f0: 2073 6574 2074 6f20 2274 6169 6c22 2062   set to "tail" b
-0003c200: 6563 6175 7365 2022 2d2d 7461 696c 2220  ecause "--tail" 
-0003c210: 6973 2075 7365 642e 2729 0a20 2020 2069  is used.').    i
-0003c220: 6620 6773 2e70 612e 7379 6e63 2069 7320  f gs.pa.sync is 
-0003c230: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0003c240: 2020 6773 2e70 612e 7379 6e63 203d 2067    gs.pa.sync = g
-0003c250: 732e 7061 2e73 796e 632e 6c6f 7765 7228  s.pa.sync.lower(
-0003c260: 290a 2020 2020 6966 2067 732e 7061 2e6f  ).    if gs.pa.o
-0003c270: 7574 7075 7420 6973 206e 6f74 204e 6f6e  utput is not Non
-0003c280: 653a 0a20 2020 2020 2020 2067 732e 7061  e:.        gs.pa
-0003c290: 2e6f 7574 7075 7420 3d20 6773 2e70 612e  .output = gs.pa.
-0003c2a0: 6f75 7470 7574 2e6c 6f77 6572 2829 0a0a  output.lower()..
-0003c2b0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-0003c2c0: 2067 732e 7061 2e6d 6573 7361 6765 0a20   gs.pa.message. 
-0003c2d0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003c2e0: 696d 6167 650a 2020 2020 2020 2020 6f72  image.        or
-0003c2f0: 2067 732e 7061 2e61 7564 696f 0a20 2020   gs.pa.audio.   
-0003c300: 2020 2020 206f 7220 6773 2e70 612e 6669       or gs.pa.fi
-0003c310: 6c65 0a20 2020 2020 2020 206f 7220 6773  le.        or gs
-0003c320: 2e70 612e 6576 656e 740a 2020 2020 293a  .pa.event.    ):
-0003c330: 0a20 2020 2020 2020 2067 732e 7365 6e64  .        gs.send
-0003c340: 5f61 6374 696f 6e20 3d20 5472 7565 0a20  _action = True. 
-0003c350: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003c360: 2067 732e 7365 6e64 5f61 6374 696f 6e20   gs.send_action 
-0003c370: 3d20 4661 6c73 650a 0a20 2020 2069 6620  = False..    if 
-0003c380: 6773 2e70 612e 6c69 7374 656e 2069 6e20  gs.pa.listen in 
-0003c390: 2846 4f52 4556 4552 2c20 4f4e 4345 2c20  (FOREVER, ONCE, 
-0003c3a0: 5441 494c 2c20 414c 4c29 3a0a 2020 2020  TAIL, ALL):.    
-0003c3b0: 2020 2020 6773 2e6c 6973 7465 6e5f 6163      gs.listen_ac
-0003c3c0: 7469 6f6e 203d 2054 7275 650a 2020 2020  tion = True.    
-0003c3d0: 656c 7365 3a0a 2020 2020 2020 2020 6773  else:.        gs
-0003c3e0: 2e6c 6973 7465 6e5f 6163 7469 6f6e 203d  .listen_action =
-0003c3f0: 2046 616c 7365 0a0a 2020 2020 6966 2028   False..    if (
-0003c400: 0a20 2020 2020 2020 2023 2072 6f6f 6d20  .        # room 
-0003c410: 7365 740a 2020 2020 2020 2020 6773 2e70  set.        gs.p
-0003c420: 612e 726f 6f6d 5f63 7265 6174 650a 2020  a.room_create.  
-0003c430: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
-0003c440: 6f6f 6d5f 646d 5f63 7265 6174 650a 2020  oom_dm_create.  
-0003c450: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
-0003c460: 6f6f 6d5f 6a6f 696e 0a20 2020 2020 2020  oom_join.       
-0003c470: 206f 7220 6773 2e70 612e 726f 6f6d 5f6c   or gs.pa.room_l
-0003c480: 6561 7665 0a20 2020 2020 2020 206f 7220  eave.        or 
-0003c490: 6773 2e70 612e 726f 6f6d 5f66 6f72 6765  gs.pa.room_forge
-0003c4a0: 740a 2020 2020 2020 2020 6f72 2067 732e  t.        or gs.
-0003c4b0: 7061 2e72 6f6f 6d5f 696e 7669 7465 0a20  pa.room_invite. 
-0003c4c0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003c4d0: 726f 6f6d 5f62 616e 0a20 2020 2020 2020  room_ban.       
-0003c4e0: 206f 7220 6773 2e70 612e 726f 6f6d 5f75   or gs.pa.room_u
-0003c4f0: 6e62 616e 0a20 2020 2020 2020 206f 7220  nban.        or 
-0003c500: 6773 2e70 612e 726f 6f6d 5f6b 6963 6b0a  gs.pa.room_kick.
-0003c510: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003c520: 2e72 6f6f 6d5f 7265 6461 6374 0a20 2020  .room_redact.   
-0003c530: 2020 2020 206f 7220 6773 2e70 612e 726f       or gs.pa.ro
-0003c540: 6f6d 5f73 6574 5f61 6c69 6173 0a20 2020  om_set_alias.   
-0003c550: 2020 2020 206f 7220 6773 2e70 612e 726f       or gs.pa.ro
-0003c560: 6f6d 5f64 656c 6574 655f 616c 6961 730a  om_delete_alias.
-0003c570: 2020 2020 2020 2020 2320 726f 6f6d 2067          # room g
-0003c580: 6574 0a20 2020 2020 2020 206f 7220 6773  et.        or gs
-0003c590: 2e70 612e 726f 6f6d 5f67 6574 5f76 6973  .pa.room_get_vis
-0003c5a0: 6962 696c 6974 7920 6973 206e 6f74 204e  ibility is not N
-0003c5b0: 6f6e 6520 2023 2065 6d70 7479 206c 6973  one  # empty lis
-0003c5c0: 7420 6d75 7374 2069 6e76 6f6b 6520 6675  t must invoke fu
-0003c5d0: 6e63 0a20 2020 2020 2020 206f 7220 6773  nc.        or gs
-0003c5e0: 2e70 612e 726f 6f6d 5f67 6574 5f73 7461  .pa.room_get_sta
-0003c5f0: 7465 2069 7320 6e6f 7420 4e6f 6e65 2020  te is not None  
-0003c600: 2320 656d 7074 7920 6c69 7374 206d 7573  # empty list mus
-0003c610: 7420 696e 766f 6b65 2066 756e 630a 2020  t invoke func.  
-0003c620: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
-0003c630: 6f6f 6d5f 7265 736f 6c76 655f 616c 6961  oom_resolve_alia
-0003c640: 730a 2020 2020 293a 0a20 2020 2020 2020  s.    ):.       
-0003c650: 2067 732e 726f 6f6d 5f61 6374 696f 6e20   gs.room_action 
-0003c660: 3d20 5472 7565 0a20 2020 2065 6c73 653a  = True.    else:
-0003c670: 0a20 2020 2020 2020 2067 732e 726f 6f6d  .        gs.room
-0003c680: 5f61 6374 696f 6e20 3d20 4661 6c73 650a  _action = False.
-0003c690: 0a20 2020 2069 6620 280a 2020 2020 2020  .    if (.      
-0003c6a0: 2020 6773 2e70 612e 7365 745f 6465 7669    gs.pa.set_devi
-0003c6b0: 6365 5f6e 616d 6520 2023 2073 6574 0a20  ce_name  # set. 
-0003c6c0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003c6d0: 7365 745f 6469 7370 6c61 795f 6e61 6d65  set_display_name
-0003c6e0: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
-0003c6f0: 612e 7365 745f 7072 6573 656e 6365 0a20  a.set_presence. 
-0003c700: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003c710: 7570 6c6f 6164 0a20 2020 2020 2020 206f  upload.        o
-0003c720: 7220 6773 2e70 612e 6465 6c65 7465 5f6d  r gs.pa.delete_m
-0003c730: 7863 0a20 2020 2020 2020 206f 7220 6773  xc.        or gs
-0003c740: 2e70 612e 6465 6c65 7465 5f6d 7863 5f62  .pa.delete_mxc_b
-0003c750: 6566 6f72 650a 2020 2020 2020 2020 6f72  efore.        or
-0003c760: 2067 732e 7061 2e72 6573 740a 2020 2020   gs.pa.rest.    
-0003c770: 2020 2020 6f72 2067 732e 7061 2e73 6574      or gs.pa.set
-0003c780: 5f61 7661 7461 720a 2020 2020 2020 2020  _avatar.        
-0003c790: 6f72 2067 732e 7061 2e69 6d70 6f72 745f  or gs.pa.import_
-0003c7a0: 6b65 7973 0a20 2020 2020 2020 206f 7220  keys.        or 
-0003c7b0: 6773 2e70 612e 6465 6c65 7465 5f64 6576  gs.pa.delete_dev
-0003c7c0: 6963 650a 2020 2020 293a 0a20 2020 2020  ice.    ):.     
-0003c7d0: 2020 2067 732e 7365 745f 6163 7469 6f6e     gs.set_action
-0003c7e0: 203d 2054 7275 650a 2020 2020 656c 7365   = True.    else
-0003c7f0: 3a0a 2020 2020 2020 2020 6773 2e73 6574  :.        gs.set
-0003c800: 5f61 6374 696f 6e20 3d20 4661 6c73 650a  _action = False.
-0003c810: 0a20 2020 2069 6620 280a 2020 2020 2020  .    if (.      
-0003c820: 2020 6773 2e70 612e 6765 745f 6469 7370    gs.pa.get_disp
-0003c830: 6c61 795f 6e61 6d65 2020 2320 6765 740a  lay_name  # get.
-0003c840: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003c850: 2e67 6574 5f70 7265 7365 6e63 650a 2020  .get_presence.  
-0003c860: 2020 2020 2020 6f72 2067 732e 7061 2e64        or gs.pa.d
-0003c870: 6f77 6e6c 6f61 640a 2020 2020 2020 2020  ownload.        
-0003c880: 6f72 2067 732e 7061 2e6a 6f69 6e65 645f  or gs.pa.joined_
-0003c890: 726f 6f6d 730a 2020 2020 2020 2020 6f72  rooms.        or
-0003c8a0: 2067 732e 7061 2e6a 6f69 6e65 645f 6d65   gs.pa.joined_me
-0003c8b0: 6d62 6572 730a 2020 2020 2020 2020 6f72  mbers.        or
-0003c8c0: 2067 732e 7061 2e6d 7863 5f74 6f5f 6874   gs.pa.mxc_to_ht
-0003c8d0: 7470 0a20 2020 2020 2020 206f 7220 6773  tp.        or gs
-0003c8e0: 2e70 612e 6465 7669 6365 730a 2020 2020  .pa.devices.    
-0003c8f0: 2020 2020 6f72 2067 732e 7061 2e64 6973      or gs.pa.dis
-0003c900: 636f 7665 7279 5f69 6e66 6f0a 2020 2020  covery_info.    
-0003c910: 2020 2020 6f72 2067 732e 7061 2e6c 6f67      or gs.pa.log
-0003c920: 696e 5f69 6e66 6f0a 2020 2020 2020 2020  in_info.        
-0003c930: 6f72 2067 732e 7061 2e63 6f6e 7465 6e74  or gs.pa.content
-0003c940: 5f72 6570 6f73 6974 6f72 795f 636f 6e66  _repository_conf
-0003c950: 6967 0a20 2020 2020 2020 206f 7220 6773  ig.        or gs
-0003c960: 2e70 612e 6765 745f 6176 6174 6172 2069  .pa.get_avatar i
-0003c970: 7320 6e6f 7420 4e6f 6e65 2020 2320 656d  s not None  # em
-0003c980: 7074 7920 6c69 7374 206d 7573 7420 696e  pty list must in
-0003c990: 766f 6b65 2066 756e 6374 696f 6e0a 2020  voke function.  
-0003c9a0: 2020 2020 2020 6f72 2067 732e 7061 2e67        or gs.pa.g
-0003c9b0: 6574 5f70 726f 6669 6c65 2069 7320 6e6f  et_profile is no
-0003c9c0: 7420 4e6f 6e65 2020 2320 656d 7074 7920  t None  # empty 
-0003c9d0: 6c69 7374 206d 7573 7420 696e 766f 6b65  list must invoke
-0003c9e0: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
-0003c9f0: 2020 6f72 2067 732e 7061 2e67 6574 5f72    or gs.pa.get_r
-0003ca00: 6f6f 6d5f 696e 666f 2069 7320 6e6f 7420  oom_info is not 
-0003ca10: 4e6f 6e65 2020 2320 656d 7074 7920 6c69  None  # empty li
-0003ca20: 7374 206d 7573 7420 696e 766f 6b65 2066  st must invoke f
-0003ca30: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
-0003ca40: 6f72 2067 732e 7061 2e67 6574 5f63 6c69  or gs.pa.get_cli
-0003ca50: 656e 745f 696e 666f 0a20 2020 2020 2020  ent_info.       
-0003ca60: 206f 7220 6773 2e70 612e 6861 735f 7065   or gs.pa.has_pe
-0003ca70: 726d 6973 7369 6f6e 0a20 2020 2020 2020  rmission.       
-0003ca80: 206f 7220 6773 2e70 612e 6578 706f 7274   or gs.pa.export
-0003ca90: 5f6b 6579 730a 2020 2020 2020 2020 6f72  _keys.        or
-0003caa0: 2067 732e 7061 2e67 6574 5f6f 7065 6e69   gs.pa.get_openi
-0003cab0: 645f 746f 6b65 6e20 6973 206e 6f74 204e  d_token is not N
-0003cac0: 6f6e 6520 2023 2065 6d70 7479 206c 6973  one  # empty lis
-0003cad0: 7420 6d75 7374 2069 6e76 6f6b 6520 6675  t must invoke fu
-0003cae0: 6e63 0a20 2020 2020 2020 206f 7220 6773  nc.        or gs
-0003caf0: 2e70 612e 7768 6f61 6d69 0a20 2020 2029  .pa.whoami.    )
-0003cb00: 3a0a 2020 2020 2020 2020 6773 2e67 6574  :.        gs.get
-0003cb10: 5f61 6374 696f 6e20 3d20 5472 7565 0a20  _action = True. 
-0003cb20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003cb30: 2067 732e 6765 745f 6163 7469 6f6e 203d   gs.get_action =
-0003cb40: 2046 616c 7365 0a0a 2020 2020 6966 2067   False..    if g
-0003cb50: 732e 7365 745f 6163 7469 6f6e 206f 7220  s.set_action or 
-0003cb60: 6773 2e67 6574 5f61 6374 696f 6e3a 0a20  gs.get_action:. 
-0003cb70: 2020 2020 2020 2067 732e 7365 7467 6574         gs.setget
-0003cb80: 5f61 6374 696f 6e20 3d20 5472 7565 0a20  _action = True. 
-0003cb90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003cba0: 2067 732e 7365 7467 6574 5f61 6374 696f   gs.setget_actio
-0003cbb0: 6e20 3d20 4661 6c73 650a 0a20 2020 2023  n = False..    #
-0003cbc0: 206f 6e6c 7920 3220 5353 4c20 7374 6174   only 2 SSL stat
-0003cbd0: 6573 2061 6c6c 6f77 6564 3a20 4e6f 6e65  es allowed: None
-0003cbe0: 2028 5353 4c20 6465 6661 756c 7420 6f6e   (SSL default on
-0003cbf0: 292c 2046 616c 7365 2028 5353 4c20 6f66  ), False (SSL of
-0003cc00: 6629 0a20 2020 2069 6620 6773 2e70 612e  f).    if gs.pa.
-0003cc10: 6e6f 5f73 736c 2069 7320 6e6f 7420 5472  no_ssl is not Tr
-0003cc20: 7565 3a0a 2020 2020 2020 2020 6773 2e70  ue:.        gs.p
-0003cc30: 612e 6e6f 5f73 736c 203d 204e 6f6e 650a  a.no_ssl = None.
-0003cc40: 2020 2020 6966 2067 732e 7061 2e70 726f      if gs.pa.pro
-0003cc50: 7879 203d 3d20 2222 3a0a 2020 2020 2020  xy == "":.      
-0003cc60: 2020 6773 2e70 612e 7072 6f78 7920 3d20    gs.pa.proxy = 
-0003cc70: 4e6f 6e65 0a0a 2020 2020 2320 686f 7720  None..    # how 
-0003cc80: 6f66 7465 6e20 6973 2022 2d22 2075 7365  often is "-" use
-0003cc90: 6420 746f 2072 6570 7265 7365 6e74 2073  d to represent s
-0003cca0: 7464 696e 0a20 2020 2023 206d 7573 7420  tdin.    # must 
-0003ccb0: 6265 2030 206f 7220 313b 2063 616e 6e6f  be 0 or 1; canno
-0003ccc0: 7420 6265 2075 7365 6420 7477 6963 6520  t be used twice 
-0003ccd0: 6f72 206d 6f72 650a 2020 2020 5354 4449  or more.    STDI
-0003cce0: 4e5f 4d45 5353 4147 4520 3d20 300a 2020  N_MESSAGE = 0.  
-0003ccf0: 2020 5354 4449 4e5f 494d 4147 4520 3d20    STDIN_IMAGE = 
-0003cd00: 300a 2020 2020 5354 4449 4e5f 4155 4449  0.    STDIN_AUDI
-0003cd10: 4f20 3d20 300a 2020 2020 5354 4449 4e5f  O = 0.    STDIN_
-0003cd20: 4649 4c45 203d 2030 0a20 2020 2053 5444  FILE = 0.    STD
-0003cd30: 494e 5f45 5645 4e54 203d 2030 0a20 2020  IN_EVENT = 0.   
-0003cd40: 2053 5444 494e 5f54 4f54 414c 203d 2030   STDIN_TOTAL = 0
-0003cd50: 0a20 2020 2069 6620 6773 2e70 612e 696d  .    if gs.pa.im
-0003cd60: 6167 653a 0a20 2020 2020 2020 2066 6f72  age:.        for
-0003cd70: 2069 6d61 6765 2069 6e20 6773 2e70 612e   image in gs.pa.
-0003cd80: 696d 6167 653a 0a20 2020 2020 2020 2020  image:.         
-0003cd90: 2020 2069 6620 696d 6167 6520 3d3d 2022     if image == "
-0003cda0: 2d22 3a0a 2020 2020 2020 2020 2020 2020  -":.            
-0003cdb0: 2020 2020 5354 4449 4e5f 494d 4147 4520      STDIN_IMAGE 
-0003cdc0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-0003cdd0: 2020 2020 2067 732e 7374 6469 6e5f 7573       gs.stdin_us
-0003cde0: 6520 3d20 2269 6d61 6765 220a 2020 2020  e = "image".    
-0003cdf0: 6966 2067 732e 7061 2e61 7564 696f 3a0a  if gs.pa.audio:.
-0003ce00: 2020 2020 2020 2020 666f 7220 6175 6469          for audi
-0003ce10: 6f20 696e 2067 732e 7061 2e61 7564 696f  o in gs.pa.audio
-0003ce20: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0003ce30: 2061 7564 696f 203d 3d20 222d 223a 0a20   audio == "-":. 
-0003ce40: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-0003ce50: 5444 494e 5f41 5544 494f 202b 3d20 310a  TDIN_AUDIO += 1.
-0003ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ce70: 6773 2e73 7464 696e 5f75 7365 203d 2022  gs.stdin_use = "
-0003ce80: 6175 6469 6f22 0a20 2020 2069 6620 6773  audio".    if gs
-0003ce90: 2e70 612e 6669 6c65 3a0a 2020 2020 2020  .pa.file:.      
-0003cea0: 2020 666f 7220 6669 6c65 2069 6e20 6773    for file in gs
-0003ceb0: 2e70 612e 6669 6c65 3a0a 2020 2020 2020  .pa.file:.      
-0003cec0: 2020 2020 2020 6966 2066 696c 6520 3d3d        if file ==
-0003ced0: 2022 2d22 3a0a 2020 2020 2020 2020 2020   "-":.          
-0003cee0: 2020 2020 2020 5354 4449 4e5f 4649 4c45        STDIN_FILE
-0003cef0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-0003cf00: 2020 2020 2020 6773 2e73 7464 696e 5f75        gs.stdin_u
-0003cf10: 7365 203d 2022 6669 6c65 220a 2020 2020  se = "file".    
-0003cf20: 6966 2067 732e 7061 2e65 7665 6e74 3a0a  if gs.pa.event:.
-0003cf30: 2020 2020 2020 2020 666f 7220 6576 656e          for even
-0003cf40: 7420 696e 2067 732e 7061 2e65 7665 6e74  t in gs.pa.event
-0003cf50: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0003cf60: 2065 7665 6e74 203d 3d20 222d 223a 0a20   event == "-":. 
-0003cf70: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-0003cf80: 5444 494e 5f45 5645 4e54 202b 3d20 310a  TDIN_EVENT += 1.
-0003cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cfa0: 6773 2e73 7464 696e 5f75 7365 203d 2022  gs.stdin_use = "
-0003cfb0: 6576 656e 7422 0a20 2020 2069 6620 6773  event".    if gs
-0003cfc0: 2e70 612e 6d65 7373 6167 653a 0a20 2020  .pa.message:.   
-0003cfd0: 2020 2020 2066 6f72 206d 6573 7361 6765       for message
-0003cfe0: 2069 6e20 6773 2e70 612e 6d65 7373 6167   in gs.pa.messag
-0003cff0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0003d000: 6620 6d65 7373 6167 6520 3d3d 2022 2d22  f message == "-"
-0003d010: 206f 7220 6d65 7373 6167 6520 3d3d 2022   or message == "
-0003d020: 5f22 3a0a 2020 2020 2020 2020 2020 2020  _":.            
-0003d030: 2020 2020 5354 4449 4e5f 4d45 5353 4147      STDIN_MESSAG
-0003d040: 4520 2b3d 2031 0a20 2020 2020 2020 2020  E += 1.         
-0003d050: 2020 2020 2020 2067 732e 7374 6469 6e5f         gs.stdin_
-0003d060: 7573 6520 3d20 226d 6573 7361 6765 220a  use = "message".
-0003d070: 2020 2020 5354 4449 4e5f 544f 5441 4c20      STDIN_TOTAL 
-0003d080: 3d20 280a 2020 2020 2020 2020 5354 4449  = (.        STDI
-0003d090: 4e5f 4d45 5353 4147 4520 2b20 5354 4449  N_MESSAGE + STDI
-0003d0a0: 4e5f 494d 4147 4520 2b20 5354 4449 4e5f  N_IMAGE + STDIN_
-0003d0b0: 4155 4449 4f20 2b20 5354 4449 4e5f 4649  AUDIO + STDIN_FI
-0003d0c0: 4c45 202b 2053 5444 494e 5f45 5645 4e54  LE + STDIN_EVENT
-0003d0d0: 0a20 2020 2029 0a0a 2020 2020 2320 5365  .    )..    # Se
-0003d0e0: 636f 6e64 6c79 2c20 7468 6520 6368 6563  condly, the chec
-0003d0f0: 6b73 0a20 2020 2069 6620 6773 2e70 612e  ks.    if gs.pa.
-0003d100: 636f 6e66 6967 3a0a 2020 2020 2020 2020  config:.        
-0003d110: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
-0003d120: 2020 2254 6869 7320 6665 6174 7572 6520    "This feature 
-0003d130: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-0003d140: 6564 2079 6574 2061 6e64 2077 696c 6c20  ed yet and will 
-0003d150: 6d6f 7374 206c 696b 656c 7920 220a 2020  most likely ".  
-0003d160: 2020 2020 2020 2020 2020 226e 6f74 2062            "not b
-0003d170: 6520 696d 706c 656d 656e 7465 642e 2053  e implemented. S
-0003d180: 6565 2049 7373 7565 2023 3334 206f 6e20  ee Issue #34 on 
-0003d190: 4769 7468 7562 2e22 0a20 2020 2020 2020  Github.".       
-0003d1a0: 2029 0a20 2020 2065 6c69 6620 6773 2e70   ).    elif gs.p
-0003d1b0: 612e 6c69 7374 656e 2069 6e20 2846 4f52  a.listen in (FOR
-0003d1c0: 4556 4552 2c20 4f4e 4345 2c20 414c 4c29  EVER, ONCE, ALL)
-0003d1d0: 2061 6e64 2067 732e 7061 2e74 6169 6c20   and gs.pa.tail 
-0003d1e0: 213d 2030 3a0a 2020 2020 2020 2020 7420  != 0:.        t 
-0003d1f0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0003d200: 2244 6f6e 2774 2075 7365 202d 2d6c 6973  "Don't use --lis
-0003d210: 7465 6e20 666f 7265 7665 722c 202d 2d6c  ten forever, --l
-0003d220: 6973 7465 6e20 6f6e 6365 206f 7220 2d2d  isten once or --
-0003d230: 6c69 7374 656e 2061 6c6c 2022 0a20 2020  listen all ".   
-0003d240: 2020 2020 2020 2020 2022 746f 6765 7468           "togeth
-0003d250: 6572 2077 6974 6820 2d2d 7461 696c 2e20  er with --tail. 
-0003d260: 4974 2773 206f 6e65 206f 7220 7468 6520  It's one or the 
-0003d270: 6f74 6865 722e 220a 2020 2020 2020 2020  other.".        
-0003d280: 290a 2020 2020 2320 7468 6973 2069 7320  ).    # this is 
-0003d290: 7365 7420 6279 2064 6566 6175 6c74 2061  set by default a
-0003d2a0: 6e79 7761 792c 206a 7573 7420 6465 6665  nyway, just defe
-0003d2b0: 6e73 6976 6520 7072 6f67 7261 6d6d 696e  nsive programmin
-0003d2c0: 670a 2020 2020 656c 6966 2067 732e 7061  g.    elif gs.pa
-0003d2d0: 2e65 6e63 7279 7074 6564 2061 6e64 2067  .encrypted and g
-0003d2e0: 732e 7061 2e73 746f 7265 2069 6e20 284e  s.pa.store in (N
-0003d2f0: 6f6e 652c 2022 2229 3a0a 2020 2020 2020  one, ""):.      
-0003d300: 2020 7420 3d20 280a 2020 2020 2020 2020    t = (.        
-0003d310: 2020 2020 2249 6620 2d2d 656e 6372 7970      "If --encryp
-0003d320: 7465 6420 6973 2075 7365 6420 2d2d 7374  ted is used --st
-0003d330: 6f72 6520 6d75 7374 2062 6520 7365 7420  ore must be set 
-0003d340: 746f 6f2e 2022 0a20 2020 2020 2020 2020  too. ".         
-0003d350: 2020 2022 5370 6563 6966 7920 2d2d 7374     "Specify --st
-0003d360: 6f72 6520 616e 6420 7275 6e20 7072 6f67  ore and run prog
-0003d370: 7261 6d20 6167 6169 6e2e 220a 2020 2020  ram again.".    
-0003d380: 2020 2020 290a 2020 2020 656c 6966 2067      ).    elif g
-0003d390: 732e 7061 2e76 6572 6966 7920 616e 6420  s.pa.verify and 
-0003d3a0: 2867 732e 7061 2e76 6572 6966 792e 6c6f  (gs.pa.verify.lo
-0003d3b0: 7765 7228 2920 213d 2045 4d4f 4a49 293a  wer() != EMOJI):
-0003d3c0: 0a20 2020 2020 2020 2074 203d 2066 2746  .        t = f'F
-0003d3d0: 6f72 202d 2d76 6572 6966 7920 6375 7272  or --verify curr
-0003d3e0: 656e 746c 7920 6f6e 6c79 2022 7b45 4d4f  ently only "{EMO
-0003d3f0: 4a49 7d22 2069 7320 616c 6c6f 7765 6420  JI}" is allowed 
-0003d400: 6173 206b 6579 776f 7264 2e27 0a20 2020  as keyword.'.   
-0003d410: 2065 6c69 6620 6773 2e70 612e 7665 7273   elif gs.pa.vers
-0003d420: 696f 6e20 616e 6420 280a 2020 2020 2020  ion and (.      
-0003d430: 2020 6773 2e70 612e 7665 7273 696f 6e2e    gs.pa.version.
-0003d440: 6c6f 7765 7228 2920 213d 2050 5249 4e54  lower() != PRINT
-0003d450: 2061 6e64 2067 732e 7061 2e76 6572 7369   and gs.pa.versi
-0003d460: 6f6e 2e6c 6f77 6572 2829 2021 3d20 4348  on.lower() != CH
-0003d470: 4543 4b0a 2020 2020 293a 0a20 2020 2020  ECK.    ):.     
-0003d480: 2020 2074 203d 2028 0a20 2020 2020 2020     t = (.       
-0003d490: 2020 2020 2066 2746 6f72 202d 2d76 6572       f'For --ver
-0003d4a0: 7369 6f6e 2063 7572 7265 6e74 6c79 206f  sion currently o
-0003d4b0: 6e6c 7920 227b 5052 494e 547d 2220 270a  nly "{PRINT}" '.
-0003d4c0: 2020 2020 2020 2020 2020 2020 6627 6f72              f'or
-0003d4d0: 2022 7b43 4845 434b 7d22 2069 7320 616c   "{CHECK}" is al
-0003d4e0: 6c6f 7765 6420 6173 206b 6579 776f 7264  lowed as keyword
-0003d4f0: 2e27 0a20 2020 2020 2020 2029 0a20 2020  .'.        ).   
-0003d500: 2065 6c69 6620 6773 2e70 612e 726f 6f6d   elif gs.pa.room
-0003d510: 5f69 6e76 6974 6573 2061 6e64 2028 0a20  _invites and (. 
-0003d520: 2020 2020 2020 2067 732e 7061 2e72 6f6f         gs.pa.roo
-0003d530: 6d5f 696e 7669 7465 732e 6c6f 7765 7228  m_invites.lower(
-0003d540: 2920 213d 2049 4e56 4954 4553 5f4c 4953  ) != INVITES_LIS
-0003d550: 540a 2020 2020 2020 2020 616e 6420 6773  T.        and gs
-0003d560: 2e70 612e 726f 6f6d 5f69 6e76 6974 6573  .pa.room_invites
-0003d570: 2e6c 6f77 6572 2829 2021 3d20 494e 5649  .lower() != INVI
-0003d580: 5445 535f 4a4f 494e 0a20 2020 2020 2020  TES_JOIN.       
-0003d590: 2061 6e64 2067 732e 7061 2e72 6f6f 6d5f   and gs.pa.room_
-0003d5a0: 696e 7669 7465 732e 6c6f 7765 7228 2920  invites.lower() 
-0003d5b0: 213d 2049 4e56 4954 4553 5f4c 4953 545f  != INVITES_LIST_
-0003d5c0: 4a4f 494e 0a20 2020 2029 3a0a 2020 2020  JOIN.    ):.    
-0003d5d0: 2020 2020 7420 3d20 280a 2020 2020 2020      t = (.      
-0003d5e0: 2020 2020 2020 6627 466f 7220 2d2d 726f        f'For --ro
-0003d5f0: 6f6d 2d69 6e76 6974 6573 2063 7572 7265  om-invites curre
-0003d600: 6e74 6c79 206f 6e6c 7920 227b 494e 5649  ntly only "{INVI
-0003d610: 5445 535f 4c49 5354 7d22 2027 0a20 2020  TES_LIST}" '.   
-0003d620: 2020 2020 2020 2020 2066 2722 7b49 4e56           f'"{INV
-0003d630: 4954 4553 5f4a 4f49 4e7d 2220 6f72 2022  ITES_JOIN}" or "
-0003d640: 7b49 4e56 4954 4553 5f4c 4953 545f 4a4f  {INVITES_LIST_JO
-0003d650: 494e 7d22 2061 7265 2061 6c6c 6f77 6564  IN}" are allowed
-0003d660: 2061 7320 270a 2020 2020 2020 2020 2020   as '.          
-0003d670: 2020 226b 6579 776f 7264 732e 220a 2020    "keywords.".  
-0003d680: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
-0003d690: 2067 732e 7061 2e72 6f6f 6d5f 696e 7669   gs.pa.room_invi
-0003d6a0: 7465 7320 616e 6420 6773 2e70 612e 6c69  tes and gs.pa.li
-0003d6b0: 7374 656e 206e 6f74 2069 6e20 2846 4f52  sten not in (FOR
-0003d6c0: 4556 4552 2c20 4f4e 4345 293a 0a20 2020  EVER, ONCE):.   
-0003d6d0: 2020 2020 2074 203d 2028 0a20 2020 2020       t = (.     
-0003d6e0: 2020 2020 2020 2022 466f 7220 2d2d 726f         "For --ro
-0003d6f0: 6f6d 2d69 6e76 6974 6573 2074 6f20 776f  om-invites to wo
-0003d700: 726b 2079 6f75 206d 7573 7420 616c 736f  rk you must also
-0003d710: 2062 6520 6c69 7374 656e 696e 672e 2022   be listening. "
-0003d720: 0a20 2020 2020 2020 2020 2020 2027 5573  .            'Us
-0003d730: 6520 222d 2d6c 6973 7465 6e20 6f6e 6365  e "--listen once
-0003d740: 2220 6f72 2022 2d2d 6c69 7374 656e 2066  " or "--listen f
-0003d750: 6f72 6576 6572 222e 270a 2020 2020 2020  orever".'.      
-0003d760: 2020 290a 2020 2020 2320 616c 6c6f 7720    ).    # allow 
-0003d770: 7665 7269 6679 2077 6974 6820 6576 6572  verify with ever
-0003d780: 7974 6869 6e67 0a20 2020 2023 2061 6c6c  ything.    # all
-0003d790: 6f77 2073 656e 6420 7769 7468 2065 7665  ow send with eve
-0003d7a0: 7279 7468 696e 670a 2020 2020 2320 616c  rything.    # al
-0003d7b0: 6c6f 7720 6c69 7374 656e 2077 6974 6820  low listen with 
-0003d7c0: 6576 6572 7974 6869 6e67 0a20 2020 2065  everything.    e
-0003d7d0: 6c69 6620 6773 2e70 612e 7365 745f 6465  lif gs.pa.set_de
-0003d7e0: 7669 6365 5f6e 616d 6520 616e 6420 2867  vice_name and (g
-0003d7f0: 732e 7061 2e73 6574 5f64 6576 6963 655f  s.pa.set_device_
-0003d800: 6e61 6d65 2e73 7472 6970 2829 203d 3d20  name.strip() == 
-0003d810: 2222 293a 0a20 2020 2020 2020 2074 203d  ""):.        t =
-0003d820: 2022 446f 6e27 7420 7573 6520 616e 2065   "Don't use an e
-0003d830: 6d70 7479 206e 616d 6520 666f 7220 2d2d  mpty name for --
-0003d840: 7365 742d 6465 7669 6365 2d6e 616d 652e  set-device-name.
-0003d850: 220a 2020 2020 656c 6966 2067 732e 7061  ".    elif gs.pa
-0003d860: 2e73 6574 5f64 6973 706c 6179 5f6e 616d  .set_display_nam
-0003d870: 6520 616e 6420 2867 732e 7061 2e73 6574  e and (gs.pa.set
-0003d880: 5f64 6973 706c 6179 5f6e 616d 652e 7374  _display_name.st
-0003d890: 7269 7028 2920 3d3d 2022 2229 3a0a 2020  rip() == ""):.  
-0003d8a0: 2020 2020 2020 7420 3d20 2244 6f6e 2774        t = "Don't
-0003d8b0: 2075 7365 2061 6e20 656d 7074 7920 6e61   use an empty na
-0003d8c0: 6d65 2066 6f72 202d 2d73 6574 2d64 6973  me for --set-dis
-0003d8d0: 706c 6179 2d6e 616d 652e 220a 2020 2020  play-name.".    
-0003d8e0: 656c 6966 2028 6773 2e70 612e 7573 6572  elif (gs.pa.user
-0003d8f0: 2920 616e 6420 6e6f 7420 280a 2020 2020  ) and not (.    
-0003d900: 2020 2020 6773 2e73 656e 645f 6163 7469      gs.send_acti
-0003d910: 6f6e 0a20 2020 2020 2020 206f 7220 6773  on.        or gs
-0003d920: 2e72 6f6f 6d5f 6163 7469 6f6e 0a20 2020  .room_action.   
-0003d930: 2020 2020 206f 7220 6773 2e70 612e 6765       or gs.pa.ge
-0003d940: 745f 6469 7370 6c61 795f 6e61 6d65 0a20  t_display_name. 
-0003d950: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
-0003d960: 6765 745f 7072 6573 656e 6365 0a20 2020  get_presence.   
-0003d970: 2020 2020 206f 7220 6773 2e70 612e 6465       or gs.pa.de
-0003d980: 6c65 7465 5f64 6576 6963 650a 2020 2020  lete_device.    
-0003d990: 293a 0a20 2020 2020 2020 2074 203d 2028  ):.        t = (
-0003d9a0: 0a20 2020 2020 2020 2020 2020 2022 4966  .            "If
-0003d9b0: 202d 2d75 7365 7220 6973 2073 7065 6369   --user is speci
-0003d9c0: 6669 6564 2c20 6f6e 6c79 2061 2073 656e  fied, only a sen
-0003d9d0: 6420 6163 7469 6f6e 2c20 6120 726f 6f6d  d action, a room
-0003d9e0: 2061 6374 696f 6e2c 2022 0a20 2020 2020   action, ".     
-0003d9f0: 2020 2020 2020 2022 2d2d 6765 742d 6469         "--get-di
-0003da00: 7370 6c61 792d 6e61 6d65 2c20 2d2d 6765  splay-name, --ge
-0003da10: 742d 7072 6573 656e 6365 2c20 6f72 202d  t-presence, or -
-0003da20: 2d64 656c 6574 652d 6465 7669 6365 2063  -delete-device c
-0003da30: 616e 2062 6520 220a 2020 2020 2020 2020  an be ".        
-0003da40: 2020 2020 2264 6f6e 652e 2041 646a 7573      "done. Adjus
-0003da50: 7420 796f 7572 2061 7267 756d 656e 7473  t your arguments
-0003da60: 2061 6363 6f72 6469 6e67 6c79 2e22 0a20   accordingly.". 
-0003da70: 2020 2020 2020 2029 0a20 2020 2065 6c69         ).    eli
-0003da80: 6620 2867 732e 7061 2e73 796e 6320 6973  f (gs.pa.sync is
-0003da90: 206e 6f74 204e 6f6e 6529 2061 6e64 206e   not None) and n
-0003daa0: 6f74 2028 6773 2e73 656e 645f 6163 7469  ot (gs.send_acti
-0003dab0: 6f6e 293a 0a20 2020 2020 2020 2074 203d  on):.        t =
-0003dac0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-0003dad0: 4f6e 6c79 2069 6620 6120 7365 6e64 2061  Only if a send a
-0003dae0: 6374 696f 6e20 6973 2070 726f 7669 6465  ction is provide
-0003daf0: 6420 6973 2069 7420 6d65 616e 696e 6766  d is it meaningf
-0003db00: 756c 2074 6f20 7370 6563 6966 7920 220a  ul to specify ".
-0003db10: 2020 2020 2020 2020 2020 2020 222d 2d73              "--s
-0003db20: 796e 632e 2052 656d 6f76 6520 2d2d 7379  ync. Remove --sy
-0003db30: 6e63 206f 7220 6164 6420 6120 7365 6e64  nc or add a send
-0003db40: 2061 6374 696f 6e2e 2022 0a20 2020 2020   action. ".     
-0003db50: 2020 2020 2020 2022 4164 6a75 7374 2079         "Adjust y
-0003db60: 6f75 7220 6172 6775 6d65 6e74 7320 6163  our arguments ac
-0003db70: 636f 7264 696e 676c 792e 220a 2020 2020  cordingly.".    
-0003db80: 2020 2020 290a 2020 2020 656c 6966 2028      ).    elif (
-0003db90: 6773 2e70 612e 7379 6e63 2069 7320 6e6f  gs.pa.sync is no
-0003dba0: 7420 4e6f 6e65 2920 616e 6420 6773 2e70  t None) and gs.p
-0003dbb0: 612e 7379 6e63 206e 6f74 2069 6e20 2853  a.sync not in (S
-0003dbc0: 594e 435f 4655 4c4c 2c20 5359 4e43 5f4f  YNC_FULL, SYNC_O
-0003dbd0: 4646 293a 0a20 2020 2020 2020 2074 203d  FF):.        t =
-0003dbe0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-0003dbf0: 496e 636f 7272 6563 7420 7661 6c75 6520  Incorrect value 
-0003dc00: 6769 7665 6e20 666f 7220 2d2d 7379 6e63  given for --sync
-0003dc10: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0003dc20: 6622 4f6e 6c79 2027 7b53 594e 435f 4655  f"Only '{SYNC_FU
-0003dc30: 4c4c 7d27 2061 6e64 2027 7b53 594e 435f  LL}' and '{SYNC_
-0003dc40: 4f46 467d 2720 6172 6520 616c 6c6f 7765  OFF}' are allowe
-0003dc50: 642e 220a 2020 2020 2020 2020 290a 2020  d.".        ).  
-0003dc60: 2020 656c 6966 2067 732e 7061 2e6f 7574    elif gs.pa.out
-0003dc70: 7075 7420 6e6f 7420 696e 2028 0a20 2020  put not in (.   
-0003dc80: 2020 2020 204f 5554 5055 545f 5445 5854       OUTPUT_TEXT
-0003dc90: 2c0a 2020 2020 2020 2020 4f55 5450 5554  ,.        OUTPUT
-0003dca0: 5f4a 534f 4e2c 0a20 2020 2020 2020 204f  _JSON,.        O
-0003dcb0: 5554 5055 545f 4a53 4f4e 5f53 5045 432c  UTPUT_JSON_SPEC,
-0003dcc0: 0a20 2020 2020 2020 204f 5554 5055 545f  .        OUTPUT_
-0003dcd0: 4a53 4f4e 5f4d 4158 2c0a 2020 2020 293a  JSON_MAX,.    ):
-0003dce0: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
-0003dcf0: 2020 2020 2020 2020 2020 2022 496e 636f             "Inco
-0003dd00: 7272 6563 7420 7661 6c75 6520 6769 7665  rrect value give
-0003dd10: 6e20 666f 7220 2d2d 6f75 7470 7574 2e20  n for --output. 
-0003dd20: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-0003dd30: 4f6e 6c79 2027 7b4f 5554 5055 545f 5445  Only '{OUTPUT_TE
-0003dd40: 5854 7d27 2c20 277b 4f55 5450 5554 5f4a  XT}', '{OUTPUT_J
-0003dd50: 534f 4e7d 272c 2022 0a20 2020 2020 2020  SON}', ".       
-0003dd60: 2020 2020 2066 2227 7b4f 5554 5055 545f       f"'{OUTPUT_
-0003dd70: 4a53 4f4e 5f53 5045 437d 2720 616e 6420  JSON_SPEC}' and 
-0003dd80: 277b 4f55 5450 5554 5f4a 534f 4e5f 4d41  '{OUTPUT_JSON_MA
-0003dd90: 587d 2720 6172 6520 616c 6c6f 7765 642e  X}' are allowed.
-0003dda0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0003ddb0: 656c 6966 206e 6f74 2067 732e 7061 2e75  elif not gs.pa.u
-0003ddc0: 7365 7220 616e 6420 280a 2020 2020 2020  ser and (.      
-0003ddd0: 2020 6773 2e70 612e 726f 6f6d 5f69 6e76    gs.pa.room_inv
-0003dde0: 6974 650a 2020 2020 2020 2020 6f72 2067  ite.        or g
-0003ddf0: 732e 7061 2e72 6f6f 6d5f 6261 6e0a 2020  s.pa.room_ban.  
-0003de00: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
-0003de10: 6f6f 6d5f 756e 6261 6e0a 2020 2020 2020  oom_unban.      
-0003de20: 2020 6f72 2067 732e 7061 2e72 6f6f 6d5f    or gs.pa.room_
-0003de30: 6b69 636b 0a20 2020 2029 3a0a 2020 2020  kick.    ):.    
-0003de40: 2020 2020 7420 3d20 280a 2020 2020 2020      t = (.      
-0003de50: 2020 2020 2020 2255 7365 7220 6e6f 7420        "User not 
-0003de60: 7370 6563 6966 6965 6420 666f 7220 726f  specified for ro
-0003de70: 6f6d 2061 6374 696f 6e2e 2022 0a20 2020  om action. ".   
-0003de80: 2020 2020 2020 2020 2022 5573 6520 2d2d           "Use --
-0003de90: 7573 6572 206f 7074 696f 6e20 746f 2073  user option to s
-0003dea0: 7065 6369 6679 2075 7365 7228 7329 2066  pecify user(s) f
-0003deb0: 6f72 2067 6976 656e 2072 6f6f 6d20 6163  or given room ac
-0003dec0: 7469 6f6e 2e22 0a20 2020 2020 2020 2029  tion.".        )
-0003ded0: 0a20 2020 2065 6c69 6620 6773 2e70 612e  .    elif gs.pa.
-0003dee0: 6c69 7374 656e 2069 6e20 284f 4e43 452c  listen in (ONCE,
-0003def0: 2046 4f52 4556 4552 2920 616e 6420 6773   FOREVER) and gs
-0003df00: 2e70 612e 726f 6f6d 3a0a 2020 2020 2020  .pa.room:.      
-0003df10: 2020 7420 3d20 280a 2020 2020 2020 2020    t = (.        
-0003df20: 2020 2020 2249 6620 2d2d 6c69 7374 656e      "If --listen
-0003df30: 206f 6e63 6520 6f72 202d 2d6c 6973 7465   once or --liste
-0003df40: 6e20 666f 7265 7665 7220 6172 6520 7370  n forever are sp
-0003df50: 6563 6966 6965 642c 2022 0a20 2020 2020  ecified, ".     
-0003df60: 2020 2020 2020 2022 2d2d 726f 6f6d 206d         "--room m
-0003df70: 7573 7420 6e6f 7420 6265 2073 7065 6369  ust not be speci
-0003df80: 6669 6564 2062 6563 6175 7365 2022 0a20  fied because ". 
-0003df90: 2020 2020 2020 2020 2020 2022 7468 6573             "thes
-0003dfa0: 6520 6f70 7469 6f6e 7320 6c69 7374 656e  e options listen
-0003dfb0: 2069 6e20 414c 4c20 726f 6f6d 732e 220a   in ALL rooms.".
-0003dfc0: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0003dfd0: 6966 2067 732e 7061 2e6c 6973 7465 6e20  if gs.pa.listen 
-0003dfe0: 6e6f 7420 696e 2028 4e45 5645 522c 2046  not in (NEVER, F
-0003dff0: 4f52 4556 4552 2c20 4f4e 4345 2c20 5441  OREVER, ONCE, TA
-0003e000: 494c 2c20 414c 4c29 3a0a 2020 2020 2020  IL, ALL):.      
-0003e010: 2020 7420 3d20 280a 2020 2020 2020 2020    t = (.        
-0003e020: 2020 2020 2249 6620 2d2d 6c69 7374 656e      "If --listen
-0003e030: 2069 7320 7370 6563 6966 6965 642c 206f   is specified, o
-0003e040: 6e6c 7920 7468 6573 6520 6368 6f69 6365  nly these choice
-0003e050: 7320 6172 6520 220a 2020 2020 2020 2020  s are ".        
-0003e060: 2020 2020 6622 706f 7373 6962 6c65 3a20      f"possible: 
-0003e070: 7b4f 4e43 457d 2c20 7b4e 4556 4552 7d2c  {ONCE}, {NEVER},
-0003e080: 207b 464f 5245 5645 527d 2c20 7b54 4149   {FOREVER}, {TAI
-0003e090: 4c7d 206f 7220 7b41 4c4c 7d2e 2022 0a20  L} or {ALL}. ". 
-0003e0a0: 2020 2020 2020 2020 2020 2066 2746 6f75             f'Fou
-0003e0b0: 6e64 2022 7b67 732e 7061 2e6c 6973 7465  nd "{gs.pa.liste
-0003e0c0: 6e7d 222e 270a 2020 2020 2020 2020 290a  n}".'.        ).
-0003e0d0: 2020 2020 656c 6966 2067 732e 7061 2e6c      elif gs.pa.l
-0003e0e0: 6973 7465 6e20 3d3d 204e 4556 4552 2061  isten == NEVER a
-0003e0f0: 6e64 2067 732e 7061 2e6c 6973 7465 6e5f  nd gs.pa.listen_
-0003e100: 7365 6c66 3a0a 2020 2020 2020 2020 7420  self:.        t 
-0003e110: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0003e120: 2249 6620 6e65 6974 6865 7220 2d2d 6c69  "If neither --li
-0003e130: 7374 656e 206e 6f72 202d 2d74 6169 6c20  sten nor --tail 
-0003e140: 6172 6520 7573 6564 2c20 220a 2020 2020  are used, ".    
-0003e150: 2020 2020 2020 2020 2274 6865 6e20 2d2d          "then --
-0003e160: 6c69 7374 656e 2d73 656c 6620 6d75 7374  listen-self must
-0003e170: 206e 6f74 2062 6520 7573 6564 2022 0a20   not be used ". 
-0003e180: 2020 2020 2020 2020 2020 2022 6569 7468             "eith
-0003e190: 6572 2e20 5370 6563 6966 7920 2d2d 6c69  er. Specify --li
-0003e1a0: 7374 656e 206f 7220 2d2d 7461 696c 2022  sten or --tail "
-0003e1b0: 0a20 2020 2020 2020 2020 2020 2022 616e  .            "an
-0003e1c0: 6420 7275 6e20 7072 6f67 7261 6d20 6167  d run program ag
-0003e1d0: 6169 6e2e 220a 2020 2020 2020 2020 290a  ain.".        ).
-0003e1e0: 2020 2020 656c 6966 2067 732e 7061 2e6c      elif gs.pa.l
-0003e1f0: 6973 7465 6e20 3d3d 204e 4556 4552 2061  isten == NEVER a
-0003e200: 6e64 2028 6773 2e70 612e 646f 776e 6c6f  nd (gs.pa.downlo
-0003e210: 6164 5f6d 6564 6961 2021 3d20 2222 293a  ad_media != ""):
-0003e220: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
-0003e230: 2020 2020 2020 2020 2020 2022 4966 206e             "If n
-0003e240: 6569 7468 6572 202d 2d6c 6973 7465 6e20  either --listen 
-0003e250: 6e6f 7220 2d2d 7461 696c 2061 7265 2075  nor --tail are u
-0003e260: 7365 642c 2022 0a20 2020 2020 2020 2020  sed, ".         
-0003e270: 2020 2022 7468 656e 202d 2d64 6f77 6e6c     "then --downl
-0003e280: 6f61 642d 6d65 6469 6120 6d75 7374 206e  oad-media must n
-0003e290: 6f74 2062 6520 7573 6564 2022 0a20 2020  ot be used ".   
-0003e2a0: 2020 2020 2020 2020 2022 6569 7468 6572           "either
-0003e2b0: 2e20 5370 6563 6966 7920 2d2d 6c69 7374  . Specify --list
-0003e2c0: 656e 206f 7220 2d2d 7461 696c 2022 0a20  en or --tail ". 
-0003e2d0: 2020 2020 2020 2020 2020 2066 2261 6e64             f"and
-0003e2e0: 2072 756e 2070 726f 6772 616d 2061 6761   run program aga
-0003e2f0: 696e 2e20 287b 6773 2e70 612e 646f 776e  in. ({gs.pa.down
-0003e300: 6c6f 6164 5f6d 6564 6961 7d29 220a 2020  load_media})".  
-0003e310: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
-0003e320: 2067 732e 7061 2e6c 6973 7465 6e20 3d3d   gs.pa.listen ==
-0003e330: 2054 4149 4c20 616e 6420 2867 732e 7061   TAIL and (gs.pa
-0003e340: 2e74 6169 6c20 3c3d 2030 293a 0a20 2020  .tail <= 0):.   
-0003e350: 2020 2020 2074 203d 2028 0a20 2020 2020       t = (.     
-0003e360: 2020 2020 2020 2022 416e 2069 6e74 6567         "An integ
-0003e370: 6572 2031 206f 7220 6c61 7267 6572 206d  er 1 or larger m
-0003e380: 7573 7420 6265 2073 7065 6369 6669 6564  ust be specified
-0003e390: 2077 6974 6820 2d2d 7461 696c 2022 0a20   with --tail ". 
-0003e3a0: 2020 2020 2020 2020 2020 2066 2228 7b67             f"({g
-0003e3b0: 732e 7061 2e74 6169 6c7d 292e 220a 2020  s.pa.tail}).".  
-0003e3c0: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
-0003e3d0: 2067 732e 7061 2e70 726f 7879 2061 6e64   gs.pa.proxy and
-0003e3e0: 206e 6f74 2028 0a20 2020 2020 2020 2067   not (.        g
-0003e3f0: 732e 7061 2e70 726f 7879 2e73 7461 7274  s.pa.proxy.start
-0003e400: 7377 6974 6828 2268 7474 703a 2f2f 2229  swith("http://")
-0003e410: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
-0003e420: 612e 7072 6f78 792e 7374 6172 7473 7769  a.proxy.startswi
-0003e430: 7468 2822 736f 636b 7334 3a2f 2f22 290a  th("socks4://").
-0003e440: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
-0003e450: 2e70 726f 7879 2e73 7461 7274 7377 6974  .proxy.startswit
-0003e460: 6828 2273 6f63 6b73 353a 2f2f 2229 0a20  h("socks5://"). 
-0003e470: 2020 2029 3a0a 2020 2020 2020 2020 7420     ):.        t 
-0003e480: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0003e490: 2250 726f 7879 2069 7320 6e6f 7420 636f  "Proxy is not co
-0003e4a0: 7272 6563 742e 2050 726f 7879 2073 686f  rrect. Proxy sho
-0003e4b0: 756c 6420 7374 6172 7420 7769 7468 2022  uld start with "
-0003e4c0: 0a20 2020 2020 2020 2020 2020 2027 2268  .            '"h
-0003e4d0: 7474 703a 2f2f 222c 2022 736f 636b 7334  ttp://", "socks4
-0003e4e0: 3a2f 2f22 206f 7220 2273 6f63 6b73 353a  ://" or "socks5:
-0003e4f0: 2f2f 222e 2027 0a20 2020 2020 2020 2020  //". '.         
-0003e500: 2020 2066 2720 596f 7572 2070 726f 7879     f' Your proxy
-0003e510: 2069 7320 7365 7420 746f 2022 7b67 732e   is set to "{gs.
-0003e520: 7061 2e70 726f 7879 7d22 2e27 0a20 2020  pa.proxy}".'.   
-0003e530: 2020 2020 2029 0a20 2020 2065 6c69 6620       ).    elif 
-0003e540: 5354 4449 4e5f 544f 5441 4c20 3e20 313a  STDIN_TOTAL > 1:
-0003e550: 0a20 2020 2020 2020 2074 203d 2028 0a20  .        t = (. 
-0003e560: 2020 2020 2020 2020 2020 2027 5468 6520             'The 
-0003e570: 6368 6172 6163 7465 7220 222d 2220 6973  character "-" is
-0003e580: 2075 7365 6420 6d6f 7265 2074 6861 6e20   used more than 
-0003e590: 6f6e 6365 2027 0a20 2020 2020 2020 2020  once '.         
-0003e5a0: 2020 2027 746f 2072 6570 7265 7365 6e74     'to represent
-0003e5b0: 2022 7374 6469 6e22 2066 6f72 2070 6970   "stdin" for pip
-0003e5c0: 696e 6720 696e 666f 726d 6174 696f 6e20  ing information 
-0003e5d0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-0003e5e0: 696e 746f 2022 7b50 524f 475f 5749 5448  into "{PROG_WITH
-0003e5f0: 4f55 545f 4558 547d 222e 2053 7464 696e  OUT_EXT}". Stdin
-0003e600: 2070 6970 6520 6361 6e20 270a 2020 2020   pipe can '.    
-0003e610: 2020 2020 2020 2020 2262 6520 7573 6564          "be used
-0003e620: 2061 7420 6d6f 7374 206f 6e63 652e 220a   at most once.".
-0003e630: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
-0003e640: 6966 2067 732e 7061 2e6e 6f5f 7373 6c20  if gs.pa.no_ssl 
-0003e650: 616e 6420 6773 2e70 612e 7373 6c5f 6365  and gs.pa.ssl_ce
-0003e660: 7274 6966 6963 6174 6520 213d 2053 534c  rtificate != SSL
-0003e670: 5f43 4552 5449 4649 4341 5445 5f44 4546  _CERTIFICATE_DEF
-0003e680: 4155 4c54 3a0a 2020 2020 2020 2020 7420  AULT:.        t 
-0003e690: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0003e6a0: 224f 7074 696f 6e73 202d 2d6e 6f2d 7373  "Options --no-ss
-0003e6b0: 6c20 616e 6420 2d2d 7373 6c2d 6365 7274  l and --ssl-cert
-0003e6c0: 6966 6963 6174 6520 6361 6e6e 6f74 2062  ificate cannot b
-0003e6d0: 6520 7573 6564 2022 0a20 2020 2020 2020  e used ".       
-0003e6e0: 2020 2020 2022 746f 6765 7468 6572 2e20       "together. 
-0003e6f0: 5573 6520 6f6e 6520 6f72 2074 6865 206f  Use one or the o
-0003e700: 7468 6572 2e22 0a20 2020 2020 2020 2029  ther.".        )
-0003e710: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0003e720: 2020 2069 6620 6773 2e70 612e 7379 6e63     if gs.pa.sync
-0003e730: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003e740: 2020 2020 2020 6773 2e70 612e 7379 6e63        gs.pa.sync
-0003e750: 203d 2053 594e 435f 4445 4641 554c 540a   = SYNC_DEFAULT.
-0003e760: 2020 2020 2020 2020 6773 2e6c 6f67 2e64          gs.log.d
-0003e770: 6562 7567 2866 224f 7074 696f 6e20 2d2d  ebug(f"Option --
-0003e780: 7379 6e63 2069 7320 7365 7420 746f 207b  sync is set to {
-0003e790: 6773 2e70 612e 7379 6e63 7d2e 2229 0a20  gs.pa.sync}."). 
-0003e7a0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-0003e7b0: 6275 6728 2241 6c6c 2061 7267 756d 656e  bug("All argumen
-0003e7c0: 7473 2061 7265 2076 616c 6964 2e20 416c  ts are valid. Al
-0003e7d0: 6c20 6368 6563 6b73 2070 6173 7365 642e  l checks passed.
-0003e7e0: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-0003e7f0: 6e20 2023 2061 6c6c 204f 4b0a 2020 2020  n  # all OK.    
-0003e800: 2320 6773 2e65 7272 5f63 6f75 6e74 202b  # gs.err_count +
-0003e810: 3d20 3120 2320 646f 206e 6f74 2069 6e63  = 1 # do not inc
-0003e820: 7265 6d65 6e74 2066 6f72 204d 6174 7269  rement for Matri
-0003e830: 7843 6f6d 6d61 6e64 6572 4572 726f 720a  xCommanderError.
-0003e840: 2020 2020 7261 6973 6520 4d61 7472 6978      raise Matrix
-0003e850: 436f 6d6d 616e 6465 7245 7272 6f72 2822  CommanderError("
-0003e860: 4532 3430 3a20 2220 2b20 7429 2066 726f  E240: " + t) fro
-0003e870: 6d20 4e6f 6e65 0a0a 0a63 6c61 7373 2063  m None...class c
-0003e880: 6f6c 6f72 733a 0a20 2020 2022 2222 436f  olors:.    """Co
-0003e890: 6c6f 7273 2063 6c61 7373 2e0a 0a20 2020  lors class...   
-0003e8a0: 2072 6573 6574 2061 6c6c 2063 6f6c 6f72   reset all color
-0003e8b0: 7320 7769 7468 2063 6f6c 6f72 732e 7265  s with colors.re
-0003e8c0: 7365 742e 0a20 2020 2032 2073 7562 2063  set..    2 sub c
-0003e8d0: 6c61 7373 6573 3a20 6667 2066 6f72 2066  lasses: fg for f
-0003e8e0: 6f72 6567 726f 756e 6420 616e 6420 6267  oreground and bg
-0003e8f0: 2066 6f72 2062 6163 6b67 726f 756e 643b   for background;
-0003e900: 0a20 2020 2075 7365 2061 7320 636f 6c6f  .    use as colo
-0003e910: 7273 2e73 7562 636c 6173 732e 636f 6c6f  rs.subclass.colo
-0003e920: 726e 616d 652e 0a20 2020 2069 2e65 2e20  rname..    i.e. 
-0003e930: 636f 6c6f 7273 2e66 672e 7265 6420 6f72  colors.fg.red or
-0003e940: 2063 6f6c 6f72 732e 6267 2e67 7265 656e   colors.bg.green
-0003e950: 0a20 2020 2061 6c73 6f2c 2074 6865 2067  .    also, the g
-0003e960: 656e 6572 6963 2062 6f6c 642c 2064 6973  eneric bold, dis
-0003e970: 6162 6c65 2c20 756e 6465 726c 696e 652c  able, underline,
-0003e980: 2072 6576 6572 7365 2c20 7374 7269 6b65   reverse, strike
-0003e990: 2074 6872 6f75 6768 2c0a 2020 2020 616e   through,.    an
-0003e9a0: 6420 696e 7669 7369 626c 6520 776f 726b  d invisible work
-0003e9b0: 2077 6974 6820 7468 6520 6d61 696e 2063   with the main c
-0003e9c0: 6c61 7373 2069 2e65 2e20 636f 6c6f 7273  lass i.e. colors
-0003e9d0: 2e62 6f6c 640a 0a20 2020 2075 7365 206c  .bold..    use l
-0003e9e0: 696b 6520 7468 6973 3a0a 2020 2020 7072  ike this:.    pr
-0003e9f0: 696e 7428 636f 6c6f 7273 2e62 672e 6772  int(colors.bg.gr
-0003ea00: 6565 6e2c 2022 534b 6b22 2c20 636f 6c6f  een, "SKk", colo
-0003ea10: 7273 2e66 672e 7265 642c 2022 416d 6172  rs.fg.red, "Amar
-0003ea20: 7479 6122 290a 2020 2020 7072 696e 7428  tya").    print(
-0003ea30: 636f 6c6f 7273 2e62 672e 6c69 6768 7467  colors.bg.lightg
-0003ea40: 7265 792c 2022 534b 6b22 2c20 636f 6c6f  rey, "SKk", colo
-0003ea50: 7273 2e66 672e 7265 642c 2022 416d 6172  rs.fg.red, "Amar
-0003ea60: 7479 6122 290a 2020 2020 2222 220a 0a20  tya").    """.. 
-0003ea70: 2020 2072 6573 6574 203d 2022 5c30 3333     reset = "\033
-0003ea80: 5b30 6d22 0a20 2020 2062 6f6c 6420 3d20  [0m".    bold = 
-0003ea90: 225c 3033 335b 3031 6d22 0a20 2020 2064  "\033[01m".    d
-0003eaa0: 6973 6162 6c65 203d 2022 5c30 3333 5b30  isable = "\033[0
-0003eab0: 326d 220a 2020 2020 696e 7665 7273 6520  2m".    inverse 
-0003eac0: 3d20 225c 3033 335b 3033 6d22 0a20 2020  = "\033[03m".   
-0003ead0: 2075 6e64 6572 6c69 6e65 203d 2022 5c30   underline = "\0
-0003eae0: 3333 5b30 346d 220a 2020 2020 626c 696e  33[04m".    blin
-0003eaf0: 6b20 3d20 225c 3033 335b 3035 6d22 0a20  k = "\033[05m". 
-0003eb00: 2020 2062 6c69 6e6b 3220 3d20 225c 3033     blink2 = "\03
-0003eb10: 335b 3036 6d22 0a20 2020 2072 6576 6572  3[06m".    rever
-0003eb20: 7365 203d 2022 5c30 3333 5b30 376d 220a  se = "\033[07m".
-0003eb30: 2020 2020 696e 7669 7369 626c 6520 3d20      invisible = 
-0003eb40: 225c 3033 335b 3038 6d22 0a20 2020 2073  "\033[08m".    s
-0003eb50: 7472 696b 6574 6872 6f75 6768 203d 2022  trikethrough = "
-0003eb60: 5c30 3333 5b30 396d 220a 0a20 2020 2063  \033[09m"..    c
-0003eb70: 6c61 7373 2066 673a 0a20 2020 2020 2020  lass fg:.       
-0003eb80: 2062 6c61 636b 203d 2022 5c30 3333 5b33   black = "\033[3
-0003eb90: 306d 220a 2020 2020 2020 2020 7265 6420  0m".        red 
-0003eba0: 3d20 225c 3033 335b 3331 6d22 0a20 2020  = "\033[31m".   
-0003ebb0: 2020 2020 2067 7265 656e 203d 2022 5c30       green = "\0
-0003ebc0: 3333 5b33 326d 220a 2020 2020 2020 2020  33[32m".        
-0003ebd0: 6f72 616e 6765 203d 2022 5c30 3333 5b33  orange = "\033[3
-0003ebe0: 336d 220a 2020 2020 2020 2020 626c 7565  3m".        blue
-0003ebf0: 203d 2022 5c30 3333 5b33 346d 220a 2020   = "\033[34m".  
-0003ec00: 2020 2020 2020 7075 7270 6c65 203d 2022        purple = "
-0003ec10: 5c30 3333 5b33 356d 220a 2020 2020 2020  \033[35m".      
-0003ec20: 2020 6379 616e 203d 2022 5c30 3333 5b33    cyan = "\033[3
-0003ec30: 366d 220a 2020 2020 2020 2020 6c69 6768  6m".        ligh
-0003ec40: 7467 7265 7920 3d20 225c 3033 335b 3337  tgrey = "\033[37
-0003ec50: 6d22 0a20 2020 2020 2020 2064 6172 6b67  m".        darkg
-0003ec60: 7265 7920 3d20 225c 3033 335b 3930 6d22  rey = "\033[90m"
-0003ec70: 0a20 2020 2020 2020 206c 6967 6874 7265  .        lightre
-0003ec80: 6420 3d20 225c 3033 335b 3931 6d22 0a20  d = "\033[91m". 
-0003ec90: 2020 2020 2020 206c 6967 6874 6772 6565         lightgree
-0003eca0: 6e20 3d20 225c 3033 335b 3932 6d22 0a20  n = "\033[92m". 
-0003ecb0: 2020 2020 2020 2079 656c 6c6f 7720 3d20         yellow = 
-0003ecc0: 225c 3033 335b 3933 6d22 0a20 2020 2020  "\033[93m".     
-0003ecd0: 2020 206c 6967 6874 626c 7565 203d 2022     lightblue = "
-0003ece0: 5c30 3333 5b39 346d 220a 2020 2020 2020  \033[94m".      
-0003ecf0: 2020 7069 6e6b 203d 2022 5c30 3333 5b39    pink = "\033[9
-0003ed00: 356d 220a 2020 2020 2020 2020 6c69 6768  5m".        ligh
-0003ed10: 7463 7961 6e20 3d20 225c 3033 335b 3936  tcyan = "\033[96
-0003ed20: 6d22 0a0a 2020 2020 636c 6173 7320 6267  m"..    class bg
-0003ed30: 3a0a 2020 2020 2020 2020 626c 6163 6b20  :.        black 
-0003ed40: 3d20 225c 3033 335b 3430 6d22 0a20 2020  = "\033[40m".   
-0003ed50: 2020 2020 2072 6564 203d 2022 5c30 3333       red = "\033
-0003ed60: 5b34 316d 220a 2020 2020 2020 2020 6772  [41m".        gr
-0003ed70: 6565 6e20 3d20 225c 3033 335b 3432 6d22  een = "\033[42m"
-0003ed80: 0a20 2020 2020 2020 206f 7261 6e67 6520  .        orange 
-0003ed90: 3d20 225c 3033 335b 3433 6d22 0a20 2020  = "\033[43m".   
-0003eda0: 2020 2020 2062 6c75 6520 3d20 225c 3033       blue = "\03
-0003edb0: 335b 3434 6d22 0a20 2020 2020 2020 2070  3[44m".        p
-0003edc0: 7572 706c 6520 3d20 225c 3033 335b 3435  urple = "\033[45
-0003edd0: 6d22 0a20 2020 2020 2020 2063 7961 6e20  m".        cyan 
-0003ede0: 3d20 225c 3033 335b 3436 6d22 0a20 2020  = "\033[46m".   
-0003edf0: 2020 2020 206c 6967 6874 6772 6579 203d       lightgrey =
-0003ee00: 2022 5c30 3333 5b34 376d 220a 0a0a 2320   "\033[47m"...# 
-0003ee10: 6163 636f 7264 696e 6720 746f 206c 696e  according to lin
-0003ee20: 7465 723a 2066 756e 6374 696f 6e20 6973  ter: function is
-0003ee30: 2074 6f6f 2063 6f6d 706c 6578 2c20 4339   too complex, C9
-0003ee40: 3031 0a64 6566 206d 6169 6e5f 696e 6e65  01.def main_inne
-0003ee50: 7228 0a20 2020 2061 7267 763a 2055 6e69  r(.    argv: Uni
-0003ee60: 6f6e 5b4e 6f6e 652c 206c 6973 745d 203d  on[None, list] =
-0003ee70: 204e 6f6e 650a 2920 2d3e 204e 6f6e 653a   None.) -> None:
-0003ee80: 2020 2320 6e6f 7161 3a20 4339 3031 2023    # noqa: C901 #
-0003ee90: 2069 676e 6f72 6520 6d63 6361 6265 2069   ignore mccabe i
-0003eea0: 662d 746f 6f2d 636f 6d70 6c65 780a 2020  f-too-complex.  
-0003eeb0: 2020 2222 2252 756e 2074 6865 2070 726f    """Run the pro
-0003eec0: 6772 616d 2e0a 0a20 2020 2046 756e 6374  gram...    Funct
-0003eed0: 696f 6e20 7369 676e 6174 7572 6520 6964  ion signature id
-0003eee0: 656e 7469 6361 6c20 746f 206d 6169 6e28  entical to main(
-0003eef0: 292e 0a20 2020 2050 6c65 6173 6520 7365  )..    Please se
-0003ef00: 6520 6d61 696e 2829 2e0a 0a20 2020 2052  e main()...    R
-0003ef10: 6574 7572 6e73 204e 6f6e 652e 2052 6574  eturns None. Ret
-0003ef20: 7572 6e73 206e 6f74 6869 6e67 2e0a 0a20  urns nothing... 
-0003ef30: 2020 2052 6169 7365 7320 6578 6365 7074     Raises except
-0003ef40: 696f 6e20 6966 2061 6e20 6572 726f 7220  ion if an error 
-0003ef50: 6973 2064 6574 6563 7465 642e 204d 616e  is detected. Man
-0003ef60: 7920 6578 6365 7074 696f 6e73 2061 7265  y exceptions are
-0003ef70: 0a20 2020 2020 2020 2070 6f73 7369 626c  .        possibl
-0003ef80: 652e 204f 6e65 206f 6620 7468 656d 2069  e. One of them i
-0003ef90: 733a 204d 6174 7269 7843 6f6d 6d61 6e64  s: MatrixCommand
-0003efa0: 6572 4572 726f 722e 0a20 2020 2020 2020  erError..       
-0003efb0: 2053 6574 7320 676c 6f62 616c 2073 7461   Sets global sta
-0003efc0: 7465 2074 6f20 636f 6d6d 756e 6963 6174  te to communicat
-0003efd0: 6520 6572 726f 7273 2e0a 0a20 2020 2022  e errors...    "
-0003efe0: 2222 0a20 2020 2069 6620 6172 6776 3a0a  "".    if argv:.
-0003eff0: 2020 2020 2020 2020 7379 732e 6172 6776          sys.argv
-0003f000: 203d 2061 7267 760a 2020 2020 2320 7072   = argv.    # pr
-0003f010: 6570 6172 6520 7468 6520 676c 6f62 616c  epare the global
-0003f020: 2073 7461 7465 0a20 2020 2067 6c6f 6261   state.    globa
-0003f030: 6c20 6773 0a20 2020 2067 7320 3d20 476c  l gs.    gs = Gl
-0003f040: 6f62 616c 5374 6174 6528 290a 2020 2020  obalState().    
-0003f050: 676c 6f62 616c 2053 4550 0a20 2020 2023  global SEP.    #
-0003f060: 2043 6f6e 7374 7275 6374 2074 6865 2061   Construct the a
-0003f070: 7267 756d 656e 7420 7061 7273 6572 0a20  rgument parser. 
-0003f080: 2020 2061 7020 3d20 6172 6770 6172 7365     ap = argparse
-0003f090: 2e41 7267 756d 656e 7450 6172 7365 7228  .ArgumentParser(
-0003f0a0: 0a20 2020 2020 2020 2061 6464 5f68 656c  .        add_hel
-0003f0b0: 703d 4661 6c73 652c 0a20 2020 2020 2020  p=False,.       
-0003f0c0: 2064 6573 6372 6970 7469 6f6e 3d28 6622   description=(f"
-0003f0d0: 5765 6c63 6f6d 6520 746f 207b 5052 4f47  Welcome to {PROG
-0003f0e0: 5f57 4954 484f 5554 5f45 5854 7d2c 2061  _WITHOUT_EXT}, a
-0003f0f0: 204d 6174 7269 7820 434c 4920 636c 6965   Matrix CLI clie
-0003f100: 6e74 2e20 2229 2c0a 2020 2020 2020 2020  nt. "),.        
-0003f110: 6570 696c 6f67 3d22 596f 7520 6172 6520  epilog="You are 
-0003f120: 7275 6e6e 696e 6720 220a 2020 2020 2020  running ".      
-0003f130: 2020 6622 7665 7273 696f 6e20 7b56 4552    f"version {VER
-0003f140: 5349 4f4e 4e52 7d20 7b56 4552 5349 4f4e  SIONNR} {VERSION
-0003f150: 7d2e 2045 6e6a 6f79 2c20 7374 6172 206f  }. Enjoy, star o
-0003f160: 6e20 4769 7468 7562 2061 6e64 2022 0a20  n Github and ". 
-0003f170: 2020 2020 2020 2022 636f 6e74 7269 6275         "contribu
-0003f180: 7465 2062 7920 7375 626d 6974 7469 6e67  te by submitting
-0003f190: 2061 2050 756c 6c20 5265 7175 6573 742e   a Pull Request.
-0003f1a0: 2022 0a20 2020 2020 2020 2066 2241 6c73   ".        f"Als
-0003f1b0: 6f20 6861 7665 2061 206c 6f6f 6b20 6174  o have a look at
-0003f1c0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-0003f1d0: 5854 7d2d 7475 692e 2022 2c0a 2020 2020  XT}-tui. ",.    
-0003f1e0: 290a 2020 2020 2320 2d68 2c20 7365 6520  ).    # -h, see 
-0003f1f0: 6164 645f 6865 6c70 3d46 616c 7365 0a20  add_help=False. 
-0003f200: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-0003f210: 6e74 280a 2020 2020 2020 2020 2320 7365  nt(.        # se
-0003f220: 6520 7363 7269 7074 2063 7265 6174 6520  e script create 
-0003f230: 6865 6c70 2e68 656c 702e 7478 740a 2020  help.help.txt.  
-0003f240: 2020 2020 2020 2320 6865 6c70 2073 7472        # help str
-0003f250: 696e 6720 7570 2074 6f20 6275 7420 6578  ing up to but ex
-0003f260: 636c 7564 696e 6720 2244 6574 6169 6c73  cluding "Details
-0003f270: 3a3a 2220 6973 2075 7365 6420 666f 720a  ::" is used for.
-0003f280: 2020 2020 2020 2020 2320 2873 686f 7274          # (short
-0003f290: 2920 602d 2d68 656c 7060 2e20 5468 6520  ) `--help`. The 
-0003f2a0: 6675 6c6c 2074 6578 7420 7769 6c6c 2062  full text will b
-0003f2b0: 6520 7573 6564 2066 6f72 206c 6f6e 6720  e used for long 
-0003f2c0: 602d 2d6d 616e 7561 6c60 2e0a 2020 2020  `--manual`..    
-0003f2d0: 2020 2020 222d 2d75 7361 6765 222c 0a20      "--usage",. 
-0003f2e0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-0003f2f0: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-0003f300: 6374 696f 6e3d 2273 746f 7265 5f74 7275  ction="store_tru
-0003f310: 6522 2c0a 2020 2020 2020 2020 6865 6c70  e",.        help
-0003f320: 3d22 5072 696e 7420 7573 6167 652e 2022  ="Print usage. "
-0003f330: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-0003f340: 733a 3a20 5365 6520 616c 736f 202d 2d68  s:: See also --h
-0003f350: 656c 7020 666f 7220 7072 696e 7469 6e67  elp for printing
-0003f360: 2061 2062 6974 206d 6f72 6520 616e 6420   a bit more and 
-0003f370: 2d2d 6d61 6e75 616c 2022 0a20 2020 2020  --manual ".     
-0003f380: 2020 2022 666f 7220 7072 696e 7469 6e67     "for printing
-0003f390: 2061 206c 6f74 206d 6f72 6520 6465 7461   a lot more deta
-0003f3a0: 696c 6564 2069 6e66 6f72 6d61 7469 6f6e  iled information
-0003f3b0: 2e22 2c0a 2020 2020 290a 2020 2020 2320  .",.    ).    # 
-0003f3c0: 2d68 2c20 7365 6520 6164 645f 6865 6c70  -h, see add_help
-0003f3d0: 3d46 616c 7365 0a20 2020 2061 702e 6164  =False.    ap.ad
-0003f3e0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-0003f3f0: 2020 2020 222d 6822 2c0a 2020 2020 2020      "-h",.      
-0003f400: 2020 222d 2d68 656c 7022 2c0a 2020 2020    "--help",.    
-0003f410: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-0003f420: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-0003f430: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
-0003f440: 0a20 2020 2020 2020 2068 656c 703d 2250  .        help="P
-0003f450: 7269 6e74 2068 656c 702e 2022 0a20 2020  rint help. ".   
-0003f460: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-0003f470: 5365 6520 616c 736f 202d 2d75 7361 6765  See also --usage
-0003f480: 2066 6f72 2070 7269 6e74 696e 6720 6576   for printing ev
-0003f490: 656e 206c 6573 7320 696e 666f 726d 6174  en less informat
-0003f4a0: 696f 6e2c 2022 0a20 2020 2020 2020 2022  ion, ".        "
-0003f4b0: 616e 6420 2d2d 6d61 6e75 616c 2066 6f72  and --manual for
-0003f4c0: 2070 7269 6e74 696e 6720 6d6f 7265 2064   printing more d
-0003f4d0: 6574 6169 6c65 6420 696e 666f 726d 6174  etailed informat
-0003f4e0: 696f 6e2e 222c 0a20 2020 2029 0a20 2020  ion.",.    ).   
-0003f4f0: 2023 2073 6565 202d 682c 2073 6565 2061   # see -h, see a
-0003f500: 6464 5f68 656c 703d 4661 6c73 650a 2020  dd_help=False.  
-0003f510: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-0003f520: 7428 0a20 2020 2020 2020 2022 2d2d 6d61  t(.        "--ma
-0003f530: 6e75 616c 222c 0a20 2020 2020 2020 2072  nual",.        r
-0003f540: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-0003f550: 2020 2020 2020 2061 6374 696f 6e3d 2273         action="s
-0003f560: 746f 7265 5f74 7275 6522 2c0a 2020 2020  tore_true",.    
-0003f570: 2020 2020 6865 6c70 3d22 5072 696e 7420      help="Print 
-0003f580: 6d61 6e75 616c 2e20 220a 2020 2020 2020  manual. ".      
-0003f590: 2020 2244 6574 6169 6c73 3a3a 2053 6565    "Details:: See
-0003f5a0: 2061 6c73 6f20 2d2d 7573 6167 6520 666f   also --usage fo
-0003f5b0: 7220 7072 696e 7469 6e67 2074 6865 2061  r printing the a
-0003f5c0: 6273 6f6c 7574 6520 6d69 6e69 6d75 6d2c  bsolute minimum,
-0003f5d0: 2022 0a20 2020 2020 2020 2022 616e 6420   ".        "and 
-0003f5e0: 2d2d 6865 6c70 2066 6f72 2070 7269 6e74  --help for print
-0003f5f0: 696e 6720 6c65 7373 2e22 2c0a 2020 2020  ing less.",.    
-0003f600: 290a 2020 2020 2320 7365 6520 2d68 2c20  ).    # see -h, 
-0003f610: 7365 6520 6164 645f 6865 6c70 3d46 616c  see add_help=Fal
-0003f620: 7365 0a20 2020 2061 702e 6164 645f 6172  se.    ap.add_ar
-0003f630: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0003f640: 222d 2d72 6561 646d 6522 2c0a 2020 2020  "--readme",.    
-0003f650: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-0003f660: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-0003f670: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
-0003f680: 0a20 2020 2020 2020 2068 656c 703d 2250  .        help="P
-0003f690: 7269 6e74 2052 4541 444d 452e 6d64 2066  rint README.md f
-0003f6a0: 696c 652e 2022 0a20 2020 2020 2020 2022  ile. ".        "
-0003f6b0: 4465 7461 696c 733a 3a20 5472 6965 7320  Details:: Tries 
-0003f6c0: 746f 2070 7269 6e74 2074 6865 206c 6f63  to print the loc
-0003f6d0: 616c 2052 4541 444d 452e 6d64 2066 696c  al README.md fil
-0003f6e0: 6520 6672 6f6d 2069 6e73 7461 6c6c 6174  e from installat
-0003f6f0: 696f 6e2e 2022 0a20 2020 2020 2020 2022  ion. ".        "
-0003f700: 4966 206e 6f74 2066 6f75 6e64 2069 7420  If not found it 
-0003f710: 7769 6c6c 2067 6574 2074 6865 2052 4541  will get the REA
-0003f720: 444d 452e 6d64 2066 696c 6520 6672 6f6d  DME.md file from
-0003f730: 2067 6974 6875 622e 636f 6d20 616e 6420   github.com and 
-0003f740: 220a 2020 2020 2020 2020 2270 7269 6e74  ".        "print
-0003f750: 2069 742e 2053 6565 2061 6c73 6f20 2d2d   it. See also --
-0003f760: 7573 6167 652c 202d 2d68 656c 702c 2061  usage, --help, a
-0003f770: 6e64 202d 2d6d 616e 7561 6c2e 222c 0a20  nd --manual.",. 
-0003f780: 2020 2029 0a20 2020 2023 2041 6464 2074     ).    # Add t
-0003f790: 6865 2061 7267 756d 656e 7473 2074 6f20  he arguments to 
-0003f7a0: 7468 6520 7061 7273 6572 0a20 2020 2061  the parser.    a
-0003f7b0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-0003f7c0: 2020 2020 2020 2020 222d 6422 2c0a 2020          "-d",.  
-0003f7d0: 2020 2020 2020 222d 2d64 6562 7567 222c        "--debug",
-0003f7e0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-0003f7f0: 2263 6f75 6e74 222c 0a20 2020 2020 2020  "count",.       
-0003f800: 2064 6566 6175 6c74 3d30 2c0a 2020 2020   default=0,.    
-0003f810: 2020 2020 6865 6c70 3d22 5072 696e 7420      help="Print 
-0003f820: 6465 6275 6720 696e 666f 726d 6174 696f  debug informatio
-0003f830: 6e2e 2022 0a20 2020 2020 2020 2022 4465  n. ".        "De
-0003f840: 7461 696c 733a 3a20 4966 2075 7365 6420  tails:: If used 
-0003f850: 6f6e 6365 2c20 6f6e 6c79 2074 6865 206c  once, only the l
-0003f860: 6f67 206c 6576 656c 206f 6620 220a 2020  og level of ".  
-0003f870: 2020 2020 2020 6622 7b50 524f 475f 5749        f"{PROG_WI
-0003f880: 5448 4f55 545f 4558 547d 2069 7320 7365  THOUT_EXT} is se
-0003f890: 7420 746f 2044 4542 5547 2e20 220a 2020  t to DEBUG. ".  
-0003f8a0: 2020 2020 2020 2749 6620 7573 6564 2074        'If used t
-0003f8b0: 7769 6365 2028 222d 6420 2d64 2220 6f72  wice ("-d -d" or
-0003f8c0: 2022 2d64 6422 2920 7468 656e 2027 0a20   "-dd") then '. 
-0003f8d0: 2020 2020 2020 2066 226c 6f67 206c 6576         f"log lev
-0003f8e0: 656c 7320 6f66 2062 6f74 6820 7b50 524f  els of both {PRO
-0003f8f0: 475f 5749 5448 4f55 545f 4558 547d 2061  G_WITHOUT_EXT} a
-0003f900: 6e64 2075 6e64 6572 6c79 696e 6720 6d6f  nd underlying mo
-0003f910: 6475 6c65 7320 6172 6520 220a 2020 2020  dules are ".    
-0003f920: 2020 2020 2773 6574 2074 6f20 4445 4255      'set to DEBU
-0003f930: 472e 2022 2d64 2220 6973 2061 2073 686f  G. "-d" is a sho
-0003f940: 7274 6375 7420 666f 7220 222d 2d6c 6f67  rtcut for "--log
-0003f950: 2d6c 6576 656c 2044 4542 5547 222e 2027  -level DEBUG". '
-0003f960: 0a20 2020 2020 2020 2027 5365 6520 616c  .        'See al
-0003f970: 736f 202d 2d6c 6f67 2d6c 6576 656c 2e20  so --log-level. 
-0003f980: 222d 6422 2074 616b 6573 2070 7265 6365  "-d" takes prece
-0003f990: 6465 6e63 6520 6f76 6572 2022 2d2d 6c6f  dence over "--lo
-0003f9a0: 672d 6c65 7665 6c22 2e20 270a 2020 2020  g-level". '.    
-0003f9b0: 2020 2020 2741 6464 6974 696f 6e61 6c6c      'Additionall
-0003f9c0: 792c 2068 6176 6520 6120 6c6f 6f6b 2061  y, have a look a
-0003f9d0: 6c73 6f20 6174 2074 6865 206f 7074 696f  lso at the optio
-0003f9e0: 6e20 222d 2d76 6572 626f 7365 222e 2027  n "--verbose". '
-0003f9f0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-0003fa00: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-0003fa10: 2020 2020 2022 2d2d 6c6f 672d 6c65 7665       "--log-leve
-0003fa20: 6c22 2c0a 2020 2020 2020 2020 7265 7175  l",.        requ
-0003fa30: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0003fa40: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-0003fa50: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-0003fa60: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
-0003fa70: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0003fa80: 2020 6d65 7461 7661 723d 2822 4445 4255    metavar=("DEBU
-0003fa90: 477c 494e 464f 7c57 4152 4e49 4e47 7c45  G|INFO|WARNING|E
-0003faa0: 5252 4f52 7c43 5249 5449 4341 4c22 292c  RROR|CRITICAL"),
-0003fab0: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
-0003fac0: 6574 2074 6865 206c 6f67 206c 6576 656c  et the log level
-0003fad0: 2873 292e 2022 0a20 2020 2020 2020 2022  (s). ".        "
-0003fae0: 4465 7461 696c 733a 3a20 506f 7373 6962  Details:: Possib
-0003faf0: 6c65 2076 616c 7565 7320 6172 6520 220a  le values are ".
-0003fb00: 2020 2020 2020 2020 2722 4445 4255 4722          '"DEBUG"
-0003fb10: 2c20 2249 4e46 4f22 2c20 2257 4152 4e49  , "INFO", "WARNI
-0003fb20: 4e47 222c 2022 4552 524f 5222 2c20 616e  NG", "ERROR", an
-0003fb30: 6420 2243 5249 5449 4341 4c22 2e20 270a  d "CRITICAL". '.
-0003fb40: 2020 2020 2020 2020 2249 6620 2d2d 6c6f          "If --lo
-0003fb50: 675f 6c65 7665 6c20 6973 2075 7365 6420  g_level is used 
-0003fb60: 7769 7468 206f 6e65 206c 6576 656c 2061  with one level a
-0003fb70: 7267 756d 656e 742c 206f 6e6c 7920 7468  rgument, only th
-0003fb80: 6520 6c6f 6720 6c65 7665 6c20 220a 2020  e log level ".  
-0003fb90: 2020 2020 2020 6622 6f66 207b 5052 4f47        f"of {PROG
-0003fba0: 5f57 4954 484f 5554 5f45 5854 7d20 6973  _WITHOUT_EXT} is
-0003fbb0: 2073 6574 2074 6f20 7468 6520 7370 6563   set to the spec
-0003fbc0: 6966 6965 6420 7661 6c75 652e 2022 0a20  ified value. ". 
-0003fbd0: 2020 2020 2020 2022 4966 202d 2d6c 6f67         "If --log
-0003fbe0: 5f6c 6576 656c 2069 7320 7573 6564 2077  _level is used w
-0003fbf0: 6974 6820 7477 6f20 6c65 7665 6c20 6172  ith two level ar
-0003fc00: 6775 6d65 6e74 2022 0a20 2020 2020 2020  gument ".       
-0003fc10: 2027 2865 2e67 2e20 222d 2d6c 6f67 2d6c   '(e.g. "--log-l
-0003fc20: 6576 656c 2057 4152 4e49 4e47 2045 5252  evel WARNING ERR
-0003fc30: 4f52 2229 2074 6865 6e20 270a 2020 2020  OR") then '.    
-0003fc40: 2020 2020 6622 6c6f 6720 6c65 7665 6c73      f"log levels
-0003fc50: 206f 6620 626f 7468 207b 5052 4f47 5f57   of both {PROG_W
-0003fc60: 4954 484f 5554 5f45 5854 7d20 616e 6420  ITHOUT_EXT} and 
-0003fc70: 756e 6465 726c 7969 6e67 206d 6f64 756c  underlying modul
-0003fc80: 6573 2061 7265 2022 0a20 2020 2020 2020  es are ".       
-0003fc90: 2022 7365 7420 746f 2074 6865 2073 7065   "set to the spe
-0003fca0: 6369 6669 6564 2076 616c 7565 732e 2022  cified values. "
-0003fcb0: 0a20 2020 2020 2020 2022 5365 6520 616c  .        "See al
-0003fcc0: 736f 202d 2d64 6562 7567 2e22 2c0a 2020  so --debug.",.  
-0003fcd0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-0003fce0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-0003fcf0: 2022 2d2d 7665 7262 6f73 6522 2c0a 2020   "--verbose",.  
-0003fd00: 2020 2020 2020 6163 7469 6f6e 3d22 636f        action="co
-0003fd10: 756e 7422 2c0a 2020 2020 2020 2020 6465  unt",.        de
-0003fd20: 6661 756c 743d 302c 0a20 2020 2020 2020  fault=0,.       
-0003fd30: 2068 656c 703d 2253 6574 2074 6865 2076   help="Set the v
-0003fd40: 6572 626f 7369 7479 206c 6576 656c 2e20  erbosity level. 
-0003fd50: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-0003fd60: 6c73 3a3a 2049 6620 6e6f 7420 7573 6564  ls:: If not used
-0003fd70: 2c20 7468 656e 2076 6572 626f 7369 7479  , then verbosity
-0003fd80: 2077 696c 6c20 6265 2022 0a20 2020 2020   will be ".     
-0003fd90: 2020 2022 7365 7420 746f 206c 6f77 2e20     "set to low. 
-0003fda0: 4966 2075 7365 6420 6f6e 6365 2c20 7665  If used once, ve
-0003fdb0: 7262 6f73 6974 7920 7769 6c6c 2062 6520  rbosity will be 
-0003fdc0: 6869 6768 2e20 220a 2020 2020 2020 2020  high. ".        
-0003fdd0: 2249 6620 7573 6564 206d 6f72 6520 7468  "If used more th
-0003fde0: 616e 206f 6e63 652c 2076 6572 626f 7369  an once, verbosi
-0003fdf0: 7479 2077 696c 6c20 6265 2076 6572 7920  ty will be very 
-0003fe00: 6869 6768 2e20 220a 2020 2020 2020 2020  high. ".        
-0003fe10: 2256 6572 626f 7369 7479 206f 6e6c 7920  "Verbosity only 
-0003fe20: 6166 6665 6374 7320 7468 6520 6465 6275  affects the debu
-0003fe30: 6720 696e 666f 726d 6174 696f 6e2e 2022  g information. "
-0003fe40: 0a20 2020 2020 2020 2022 536f 2c20 6966  .        "So, if
-0003fe50: 2027 2d2d 6465 6275 6727 2069 7320 6e6f   '--debug' is no
-0003fe60: 7420 7573 6564 2074 6865 6e20 272d 2d76  t used then '--v
-0003fe70: 6572 626f 7365 2720 7769 6c6c 2062 6520  erbose' will be 
-0003fe80: 6967 6e6f 7265 642e 222c 0a20 2020 2029  ignored.",.    )
-0003fe90: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
-0003fea0: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
-0003feb0: 2d6c 6f67 696e 222c 0a20 2020 2020 2020  -login",.       
-0003fec0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0003fed0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0003fee0: 722c 2020 2320 6c6f 6769 6e20 6d65 7468  r,  # login meth
-0003fef0: 6f64 3a20 7061 7373 776f 7264 2c20 7373  od: password, ss
-0003ff00: 6f2c 2028 6163 6365 7373 2d74 6f6b 656e  o, (access-token
-0003ff10: 290a 2020 2020 2020 2020 6d65 7461 7661  ).        metava
-0003ff20: 723d 2250 4153 5357 4f52 447c 5353 4f22  r="PASSWORD|SSO"
-0003ff30: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-0003ff40: 4c6f 6769 6e20 746f 2061 6e64 2061 7574  Login to and aut
-0003ff50: 6865 6e74 6963 6174 6520 7769 7468 2074  henticate with t
-0003ff60: 6865 204d 6174 7269 7820 686f 6d65 7365  he Matrix homese
-0003ff70: 7276 6572 2e20 220a 2020 2020 2020 2020  rver. ".        
-0003ff80: 2244 6574 6169 6c73 3a3a 2054 6869 7320  "Details:: This 
-0003ff90: 7265 7175 6972 6573 2065 7861 6374 6c79  requires exactly
-0003ffa0: 206f 6e65 2061 7267 756d 656e 742c 2074   one argument, t
-0003ffb0: 6865 206c 6f67 696e 206d 6574 686f 642e  he login method.
-0003ffc0: 2022 0a20 2020 2020 2020 2022 4375 7272   ".        "Curr
-0003ffd0: 656e 746c 7920 7477 6f20 6368 6f69 6365  ently two choice
-0003ffe0: 7320 6172 6520 6f66 6665 7265 643a 2027  s are offered: '
-0003fff0: 7061 7373 776f 7264 2720 616e 6420 2773  password' and 's
-00040000: 736f 272e 2022 0a20 2020 2020 2020 2022  so'. ".        "
-00040010: 5072 6f76 6964 6520 6f6e 6520 6f66 2074  Provide one of t
-00040020: 6865 7365 206d 6574 686f 6473 2e20 220a  hese methods. ".
-00040030: 2020 2020 2020 2020 2249 6620 796f 7520          "If you 
-00040040: 6861 7665 2063 686f 7365 6e20 2770 6173  have chosen 'pas
-00040050: 7377 6f72 6427 2c20 220a 2020 2020 2020  sword', ".      
-00040060: 2020 2279 6f75 2077 696c 6c20 6175 7468    "you will auth
-00040070: 656e 7469 6361 7465 2074 6872 6f75 6768  enticate through
-00040080: 2079 6f75 7220 6163 636f 756e 7420 7061   your account pa
-00040090: 7373 776f 7264 2e20 596f 7520 6361 6e20  ssword. You can 
-000400a0: 220a 2020 2020 2020 2020 226f 7074 696f  ".        "optio
-000400b0: 6e61 6c6c 7920 7072 6f76 6964 6520 7468  nally provide th
-000400c0: 6573 6520 6164 6469 7469 6f6e 616c 2061  ese additional a
-000400d0: 7267 756d 656e 7473 3a20 220a 2020 2020  rguments: ".    
-000400e0: 2020 2020 222d 2d68 6f6d 6573 6572 7665      "--homeserve
-000400f0: 7220 746f 2073 7065 6369 6679 2074 6865  r to specify the
-00040100: 204d 6174 7269 7820 686f 6d65 7365 7276   Matrix homeserv
-00040110: 6572 2c20 220a 2020 2020 2020 2020 222d  er, ".        "-
-00040120: 2d75 7365 722d 6c6f 6769 6e20 746f 2073  -user-login to s
-00040130: 7065 6369 6679 2074 6865 206c 6f67 2069  pecify the log i
-00040140: 6e20 7573 6572 2069 642c 2022 0a20 2020  n user id, ".   
-00040150: 2020 2020 2022 2d2d 7061 7373 776f 7264       "--password
-00040160: 2074 6f20 7370 6563 6966 7920 7468 6520   to specify the 
-00040170: 7061 7373 776f 7264 2c20 220a 2020 2020  password, ".    
-00040180: 2020 2020 222d 2d64 6576 6963 6520 746f      "--device to
-00040190: 2073 7065 6369 6679 2061 2064 6576 6963   specify a devic
-000401a0: 6520 6e61 6d65 2c20 220a 2020 2020 2020  e name, ".      
-000401b0: 2020 222d 2d72 6f6f 6d2d 6465 6661 756c    "--room-defaul
-000401c0: 7420 746f 2073 7065 6369 6679 2061 2064  t to specify a d
-000401d0: 6566 6175 6c74 2072 6f6f 6d20 666f 7220  efault room for 
-000401e0: 7365 6e64 696e 672f 6c69 7374 656e 696e  sending/listenin
-000401f0: 672e 2022 0a20 2020 2020 2020 2022 4966  g. ".        "If
-00040200: 2079 6f75 2068 6176 6520 6368 6f73 656e   you have chosen
-00040210: 2027 7373 6f27 2c20 220a 2020 2020 2020   'sso', ".      
-00040220: 2020 2279 6f75 2077 696c 6c20 6175 7468    "you will auth
-00040230: 656e 7469 6361 7465 2074 6872 6f75 6768  enticate through
-00040240: 2053 696e 676c 6520 5369 676e 2d4f 6e2e   Single Sign-On.
-00040250: 2041 2077 6562 2d62 726f 7773 6572 2077   A web-browser w
-00040260: 696c 6c20 220a 2020 2020 2020 2020 2262  ill ".        "b
-00040270: 6520 7374 6172 7465 6420 616e 6420 796f  e started and yo
-00040280: 7520 6175 7468 656e 7469 6361 7465 206f  u authenticate o
-00040290: 6e20 7468 6520 7765 6270 6167 652e 2059  n the webpage. Y
-000402a0: 6f75 2063 616e 2022 0a20 2020 2020 2020  ou can ".       
-000402b0: 2022 6f70 7469 6f6e 616c 6c79 2070 726f   "optionally pro
-000402c0: 7669 6465 2074 6865 7365 2061 6464 6974  vide these addit
-000402d0: 696f 6e61 6c20 6172 6775 6d65 6e74 733a  ional arguments:
-000402e0: 2022 0a20 2020 2020 2020 2022 2d2d 686f   ".        "--ho
-000402f0: 6d65 7365 7276 6572 2074 6f20 7370 6563  meserver to spec
-00040300: 6966 7920 7468 6520 4d61 7472 6978 2068  ify the Matrix h
-00040310: 6f6d 6573 6572 7665 722c 2022 0a20 2020  omeserver, ".   
-00040320: 2020 2020 2022 2d2d 7573 6572 2d6c 6f67       "--user-log
-00040330: 696e 2074 6f20 7370 6563 6966 7920 7468  in to specify th
-00040340: 6520 6c6f 6720 696e 2075 7365 7220 6964  e log in user id
-00040350: 2c20 220a 2020 2020 2020 2020 222d 2d64  , ".        "--d
-00040360: 6576 6963 6520 746f 2073 7065 6369 6679  evice to specify
-00040370: 2061 2064 6576 6963 6520 6e61 6d65 2c20   a device name, 
-00040380: 220a 2020 2020 2020 2020 222d 2d72 6f6f  ".        "--roo
-00040390: 6d2d 6465 6661 756c 7420 746f 2073 7065  m-default to spe
-000403a0: 6369 6679 2061 2064 6566 6175 6c74 2072  cify a default r
-000403b0: 6f6f 6d20 666f 7220 7365 6e64 696e 672f  oom for sending/
-000403c0: 6c69 7374 656e 696e 672e 2022 0a20 2020  listening. ".   
-000403d0: 2020 2020 2022 5365 6520 616c 6c20 7468       "See all th
-000403e0: 6520 6578 7472 6120 6172 6775 6d65 6e74  e extra argument
-000403f0: 7320 666f 7220 6675 7274 6865 7220 6578  s for further ex
-00040400: 706c 616e 6174 696f 6e73 2e20 2d2d 2d2d  planations. ----
-00040410: 2d20 220a 2020 2020 2020 2020 2253 534f  - ".        "SSO
-00040420: 2028 5369 6e67 6c65 2053 6967 6e2d 4f6e   (Single Sign-On
-00040430: 2920 7374 6172 7473 2061 2077 6562 2022  ) starts a web "
-00040440: 0a20 2020 2020 2020 2022 6272 6f77 7365  .        "browse
-00040450: 7220 616e 6420 636f 6e6e 6563 7473 2074  r and connects t
-00040460: 6865 2075 7365 7220 746f 2061 2077 6562  he user to a web
-00040470: 2070 6167 6520 6f6e 2074 6865 2022 0a20   page on the ". 
-00040480: 2020 2020 2020 2022 7365 7276 6572 2066         "server f
-00040490: 6f72 206c 6f67 696e 2e20 5353 4f20 7769  or login. SSO wi
-000404a0: 6c6c 206f 6e6c 7920 776f 726b 2069 6620  ll only work if 
-000404b0: 7468 6520 7365 7276 6572 2022 0a20 2020  the server ".   
-000404c0: 2020 2020 2022 7375 7070 6f72 7473 2069       "supports i
-000404d0: 7420 616e 6420 6966 2074 6865 7265 2069  t and if there i
-000404e0: 7320 6163 6365 7373 2074 6f20 6120 6272  s access to a br
-000404f0: 6f77 7365 722e 2053 6f2c 2064 6f6e 2774  owser. So, don't
-00040500: 2075 7365 2053 534f 2022 0a20 2020 2020   use SSO ".     
-00040510: 2020 2022 6f6e 2068 6561 646c 6573 7320     "on headless 
-00040520: 686f 6d65 7365 7276 6572 7320 7768 6572  homeservers wher
-00040530: 6520 7468 6572 6520 6973 206e 6f20 220a  e there is no ".
-00040540: 2020 2020 2020 2020 2262 726f 7773 6572          "browser
-00040550: 2069 6e73 7461 6c6c 6564 206f 7220 6163   installed or ac
-00040560: 6365 7373 6962 6c65 2e22 2c0a 2020 2020  cessible.",.    
-00040570: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-00040580: 756d 656e 7428 0a20 2020 2020 2020 2023  ument(.        #
-00040590: 2022 2d76 222c 2023 2320 696e 636f 6d70   "-v", ## incomp
-000405a0: 6174 6962 6c65 2063 6861 6e67 652c 202d  atible change, -
-000405b0: 7620 6d6f 7665 6420 746f 202d 2d76 6572  v moved to --ver
-000405c0: 7369 6f6e 0a20 2020 2020 2020 2022 2d2d  sion.        "--
-000405d0: 7665 7269 6679 222c 0a20 2020 2020 2020  verify",.       
-000405e0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-000405f0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00040600: 722c 0a20 2020 2020 2020 2064 6566 6175  r,.        defau
-00040610: 6c74 3d56 4552 4946 595f 554e 5553 4544  lt=VERIFY_UNUSED
-00040620: 5f44 4546 4155 4c54 2c20 2023 2077 6865  _DEFAULT,  # whe
-00040630: 6e20 2d74 2069 7320 6e6f 7420 7573 6564  n -t is not used
-00040640: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-00040650: 3f22 2c20 2023 206d 616b 6573 2074 6865  ?",  # makes the
-00040660: 2077 6f72 6420 6f70 7469 6f6e 616c 0a20   word optional. 
-00040670: 2020 2020 2020 2023 2077 6865 6e20 2d76         # when -v
-00040680: 2069 7320 7573 6564 2c20 6275 7420 7465   is used, but te
-00040690: 7874 2069 7320 6e6f 7420 6164 6465 640a  xt is not added.
-000406a0: 2020 2020 2020 2020 636f 6e73 743d 5645          const=VE
-000406b0: 5249 4659 5f55 5345 445f 4445 4641 554c  RIFY_USED_DEFAUL
-000406c0: 542c 0a20 2020 2020 2020 206d 6574 6176  T,.        metav
-000406d0: 6172 3d22 454d 4f4a 4922 2c0a 2020 2020  ar="EMOJI",.    
-000406e0: 2020 2020 6865 6c70 3d22 5065 7266 6f72      help="Perfor
-000406f0: 6d20 7665 7269 6669 6361 7469 6f6e 2e20  m verification. 
-00040700: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-00040710: 6c73 3a3a 2042 7920 6465 6661 756c 742c  ls:: By default,
-00040720: 206e 6f20 220a 2020 2020 2020 2020 2276   no ".        "v
-00040730: 6572 6966 6963 6174 696f 6e20 6973 2070  erification is p
-00040740: 6572 666f 726d 6564 2e20 220a 2020 2020  erformed. ".    
-00040750: 2020 2020 6627 506f 7373 6962 6c65 2076      f'Possible v
-00040760: 616c 7565 7320 6172 653a 2022 7b45 4d4f  alues are: "{EMO
-00040770: 4a49 7d22 2e20 270a 2020 2020 2020 2020  JI}". '.        
-00040780: 2249 6620 7665 7269 6669 6361 7469 6f6e  "If verification
-00040790: 2069 7320 6465 7369 7265 642c 2072 756e   is desired, run
-000407a0: 2074 6869 7320 7072 6f67 7261 6d20 696e   this program in
-000407b0: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
-000407c0: 666f 7265 6772 6f75 6e64 2028 6e6f 7420  foreground (not 
-000407d0: 6173 2061 2073 6572 7669 6365 2920 616e  as a service) an
-000407e0: 6420 7769 7468 6f75 7420 6120 7069 7065  d without a pipe
-000407f0: 2e20 220a 2020 2020 2020 2020 2257 6869  . ".        "Whi
-00040800: 6c65 2076 6572 6966 6963 6174 696f 6e20  le verification 
-00040810: 6973 206f 7074 696f 6e61 6c20 6974 2069  is optional it i
-00040820: 7320 6869 6768 6c79 2072 6563 6f6d 6d65  s highly recomme
-00040830: 6e64 6564 2c20 616e 6420 6974 2022 0a20  nded, and it ". 
-00040840: 2020 2020 2020 2022 6973 2072 6563 6f6d         "is recom
-00040850: 6d65 6e64 6564 2074 6f20 6265 2064 6f6e  mended to be don
-00040860: 6520 7269 6768 7420 6166 7465 7220 286f  e right after (o
-00040870: 7220 746f 6765 7468 6572 2077 6974 6829  r together with)
-00040880: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
-00040890: 2d2d 6c6f 6769 6e20 6163 7469 6f6e 2e20  --login action. 
-000408a0: 5665 7269 6669 6361 7469 6f6e 2069 7320  Verification is 
-000408b0: 616c 7761 7973 2069 6e74 6572 6163 7469  always interacti
-000408c0: 7665 2c20 692e 652e 2069 7420 220a 2020  ve, i.e. it ".  
-000408d0: 2020 2020 2020 2272 6571 7569 7265 6420        "required 
-000408e0: 6b65 7962 6f61 7264 2069 6e70 7574 2e20  keyboard input. 
-000408f0: 220a 2020 2020 2020 2020 2256 6572 6966  ".        "Verif
-00040900: 6963 6174 696f 6e20 7175 6573 7469 6f6e  ication question
-00040910: 7320 220a 2020 2020 2020 2020 2277 696c  s ".        "wil
-00040920: 6c20 6265 2070 7269 6e74 6564 206f 6e20  l be printed on 
-00040930: 7374 646f 7574 2061 6e64 2074 6865 2075  stdout and the u
-00040940: 7365 7220 6861 7320 746f 2072 6573 706f  ser has to respo
-00040950: 6e64 2022 0a20 2020 2020 2020 2022 7669  nd ".        "vi
-00040960: 6120 7468 6520 6b65 7962 6f61 7264 2074  a the keyboard t
-00040970: 6f20 6163 6365 7074 206f 7220 7265 6a65  o accept or reje
-00040980: 6374 2076 6572 6966 6963 6174 696f 6e2e  ct verification.
-00040990: 2022 0a20 2020 2020 2020 2022 4f6e 6365   ".        "Once
-000409a0: 2076 6572 6966 6963 6174 696f 6e20 6973   verification is
-000409b0: 2063 6f6d 706c 6574 652c 2074 6865 2070   complete, the p
-000409c0: 726f 6772 616d 206d 6179 2062 6520 220a  rogram may be ".
-000409d0: 2020 2020 2020 2020 2272 756e 2061 7320          "run as 
-000409e0: 6120 7365 7276 6963 652e 2056 6572 6966  a service. Verif
-000409f0: 6963 6174 696f 6e20 6973 2062 6573 7420  ication is best 
-00040a00: 646f 6e65 2061 7320 666f 6c6c 6f77 733a  done as follows:
-00040a10: 2022 0a20 2020 2020 2020 2022 5065 7266   ".        "Perf
-00040a20: 6f72 6d20 6120 6372 6f73 732d 6465 7669  orm a cross-devi
-00040a30: 6365 2076 6572 6966 6963 6174 696f 6e2c  ce verification,
-00040a40: 2074 6861 7420 6d65 616e 732c 2070 6572   that means, per
-00040a50: 666f 726d 2061 2022 0a20 2020 2020 2020  form a ".       
-00040a60: 2022 7665 7269 6669 6361 7469 6f6e 2062   "verification b
-00040a70: 6574 7765 656e 2074 776f 2064 6576 6963  etween two devic
-00040a80: 6573 206f 6620 7468 6520 2a73 616d 652a  es of the *same*
-00040a90: 2075 7365 722e 2046 6f72 2074 6861 742c   user. For that,
-00040aa0: 2022 0a20 2020 2020 2020 2022 6f70 656e   ".        "open
-00040ab0: 2028 652e 672e 2920 456c 656d 656e 7420   (e.g.) Element 
-00040ac0: 696e 2061 2062 726f 7773 6572 2c20 6d61  in a browser, ma
-00040ad0: 6b65 2073 7572 6520 456c 656d 656e 7420  ke sure Element 
-00040ae0: 6973 2075 7369 6e67 2074 6865 2022 0a20  is using the ". 
-00040af0: 2020 2020 2020 2066 2273 616d 6520 7573         f"same us
-00040b00: 6572 2061 6363 6f75 6e74 2061 7320 7468  er account as th
-00040b10: 6520 7b50 524f 475f 5749 5448 4f55 545f  e {PROG_WITHOUT_
-00040b20: 4558 547d 2075 7365 7220 2873 7065 6369  EXT} user (speci
-00040b30: 6669 6564 2077 6974 6820 220a 2020 2020  fied with ".    
-00040b40: 2020 2020 222d 2d75 7365 722d 6c6f 6769      "--user-logi
-00040b50: 6e20 6174 202d 2d6c 6f67 696e 292e 204e  n at --login). N
-00040b60: 6f77 2069 6e20 7468 6520 456c 656d 656e  ow in the Elemen
-00040b70: 7420 7765 6270 6167 6520 676f 2074 6f20  t webpage go to 
-00040b80: 7468 6520 726f 6f6d 2022 0a20 2020 2020  the room ".     
-00040b90: 2020 2066 2274 6861 7420 6973 2074 6865     f"that is the
-00040ba0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-00040bb0: 5854 7d20 6465 6661 756c 7420 726f 6f6d  XT} default room
-00040bc0: 2028 7370 6563 6966 6965 6420 7769 7468   (specified with
-00040bd0: 2022 0a20 2020 2020 2020 2022 2d2d 726f   ".        "--ro
-00040be0: 6f6d 2d64 6566 6175 6c74 2061 7420 2d2d  om-default at --
-00040bf0: 6c6f 6769 6e29 2e20 4f4b 2c20 696e 2074  login). OK, in t
-00040c00: 6865 2077 6562 2d62 726f 7773 6572 2079  he web-browser y
-00040c10: 6f75 2061 7265 206e 6f77 2074 6865 2022  ou are now the "
-00040c20: 0a20 2020 2020 2020 2066 2273 616d 6520  .        f"same 
-00040c30: 7573 6572 2061 6e64 2069 6e20 7468 6520  user and in the 
-00040c40: 7361 6d65 2072 6f6f 6d20 6173 207b 5052  same room as {PR
-00040c50: 4f47 5f57 4954 484f 5554 5f45 5854 7d2e  OG_WITHOUT_EXT}.
-00040c60: 2022 0a20 2020 2020 2020 2022 4e6f 7720   ".        "Now 
-00040c70: 636c 6963 6b20 7468 6520 726f 756e 6420  click the round 
-00040c80: 2769 2720 2752 6f6f 6d20 496e 666f 2720  'i' 'Room Info' 
-00040c90: 6963 6f6e 2c20 7468 656e 2063 6c69 636b  icon, then click
-00040ca0: 2027 5065 6f70 6c65 272c 2022 0a20 2020   'People', ".   
-00040cb0: 2020 2020 2066 2263 6c69 636b 2074 6865       f"click the
-00040cc0: 2061 7070 726f 7072 6961 7465 2075 7365   appropriate use
-00040cd0: 7220 2874 6865 207b 5052 4f47 5f57 4954  r (the {PROG_WIT
-00040ce0: 484f 5554 5f45 5854 7d20 7573 6572 292c  HOUT_EXT} user),
-00040cf0: 2022 0a20 2020 2020 2020 2022 636c 6963   ".        "clic
-00040d00: 6b20 7265 6420 274e 6f74 2054 7275 7374  k red 'Not Trust
-00040d10: 6564 2720 7465 7874 2022 0a20 2020 2020  ed' text ".     
-00040d20: 2020 2022 7768 6963 6820 696e 6469 6361     "which indica
-00040d30: 7465 6420 616e 2075 6e74 7275 7374 6564  ted an untrusted
-00040d40: 2064 6576 6963 652c 2074 6865 6e20 636c   device, then cl
-00040d50: 6963 6b20 7468 6520 7371 7561 7265 2022  ick the square "
-00040d60: 0a20 2020 2020 2020 2022 2749 6e74 6572  .        "'Inter
-00040d70: 6163 7469 7665 6c79 2076 6572 6966 7920  actively verify 
-00040d80: 6279 2045 6d6f 6a69 2720 6275 7474 6f6e  by Emoji' button
-00040d90: 2028 6f6e 6520 6f66 2033 2062 7574 746f   (one of 3 butto
-00040da0: 6e20 6368 6f69 6365 7329 2e20 220a 2020  n choices). ".  
-00040db0: 2020 2020 2020 6622 4174 2074 6869 7320        f"At this 
-00040dc0: 706f 696e 7420 626f 7468 2077 6562 2d70  point both web-p
-00040dd0: 6167 6520 616e 6420 7b50 524f 475f 5749  age and {PROG_WI
-00040de0: 5448 4f55 545f 4558 547d 2069 6e20 7465  THOUT_EXT} in te
-00040df0: 726d 696e 616c 2022 0a20 2020 2020 2020  rminal ".       
-00040e00: 2022 7368 6f77 2061 2073 6574 206f 6620   "show a set of 
-00040e10: 656d 6f6a 6920 6963 6f6e 7320 616e 6420  emoji icons and 
-00040e20: 6e61 6d65 732e 2043 6f6d 7061 7265 2074  names. Compare t
-00040e30: 6865 6d20 7669 7375 616c 6c79 2e20 220a  hem visually. ".
-00040e40: 2020 2020 2020 2020 2243 6f6e 6669 726d          "Confirm
-00040e50: 206f 6e20 626f 7468 2073 6964 6573 2028   on both sides (
-00040e60: 5965 732c 2054 6865 7920 4d61 7463 682c  Yes, They Match,
-00040e70: 2047 6f74 2069 7429 2c20 6669 6e61 6c6c   Got it), finall
-00040e80: 7920 636c 6963 6b20 4f4b 2e20 220a 2020  y click OK. ".  
-00040e90: 2020 2020 2020 2259 6f75 2073 686f 756c        "You shoul
-00040ea0: 6420 7365 6520 6120 6772 6565 6e20 7368  d see a green sh
-00040eb0: 6965 6c64 2061 6e64 2061 6c73 6f20 7365  ield and also se
-00040ec0: 6520 7468 6174 2074 6865 2022 0a20 2020  e that the ".   
-00040ed0: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
-00040ee0: 484f 5554 5f45 5854 7d20 6465 7669 6365  HOUT_EXT} device
-00040ef0: 2069 7320 6e6f 7720 6772 6565 6e20 616e   is now green an
-00040f00: 6420 7665 7269 6669 6564 2069 6e20 7468  d verified in th
-00040f10: 6520 7765 6270 6167 652e 2022 0a20 2020  e webpage. ".   
-00040f20: 2020 2020 2022 496e 2074 6865 2074 6572       "In the ter
-00040f30: 6d69 6e61 6c20 796f 7520 7368 6f75 6c64  minal you should
-00040f40: 2073 6565 2061 2074 6578 7420 6d65 7373   see a text mess
-00040f50: 6167 6520 696e 6469 6361 7469 6e67 2073  age indicating s
-00040f60: 7563 6365 7373 2e20 220a 2020 2020 2020  uccess. ".      
-00040f70: 2020 2259 6f75 2073 686f 756c 6420 6e6f    "You should no
-00040f80: 7720 6265 2076 6572 6966 6965 6420 6163  w be verified ac
-00040f90: 726f 7373 2061 6c6c 2064 6576 6963 6573  ross all devices
-00040fa0: 2061 6e64 2061 6372 6f73 7320 616c 6c20   and across all 
-00040fb0: 7573 6572 732e 222c 0a20 2020 2029 0a20  users.",.    ). 
-00040fc0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-00040fd0: 6e74 280a 2020 2020 2020 2020 222d 2d6c  nt(.        "--l
-00040fe0: 6f67 6f75 7422 2c0a 2020 2020 2020 2020  ogout",.        
-00040ff0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-00041000: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-00041010: 2c20 2023 206c 6f67 6f75 7420 6f70 7469  ,  # logout opti
-00041020: 6f6e 733a 206d 6520 616e 6420 616c 6c0a  ons: me and all.
-00041030: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-00041040: 224d 457c 414c 4c22 2c0a 2020 2020 2020  "ME|ALL",.      
-00041050: 2020 6865 6c70 3d22 4c6f 676f 7574 2e20    help="Logout. 
-00041060: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-00041070: 6c73 3a3a 204c 6f67 6f75 7420 7468 6973  ls:: Logout this
-00041080: 206f 7220 616c 6c20 6465 7669 6365 7320   or all devices 
-00041090: 6672 6f6d 2074 6865 204d 6174 7269 7820  from the Matrix 
-000410a0: 686f 6d65 7365 7276 6572 2e20 220a 2020  homeserver. ".  
-000410b0: 2020 2020 2020 2254 6869 7320 7265 7175        "This requ
-000410c0: 6972 6573 2065 7861 6374 6c79 206f 6e65  ires exactly one
-000410d0: 2061 7267 756d 656e 742e 2022 0a20 2020   argument. ".   
-000410e0: 2020 2020 2022 5477 6f20 6368 6f69 6365       "Two choice
-000410f0: 7320 6172 6520 6f66 6665 7265 643a 2027  s are offered: '
-00041100: 6d65 2720 616e 6420 2761 6c6c 272e 2022  me' and 'all'. "
-00041110: 0a20 2020 2020 2020 2022 5072 6f76 6964  .        "Provid
-00041120: 6520 6f6e 6520 6f66 2074 6865 7365 2063  e one of these c
-00041130: 686f 6963 6573 2e20 220a 2020 2020 2020  hoices. ".      
-00041140: 2020 6622 4966 2079 6f75 2063 686f 6f73    f"If you choos
-00041150: 6520 276d 6527 2c20 6f6e 6c79 2074 6865  e 'me', only the
-00041160: 206f 6e65 2064 6576 6963 6520 7b50 524f   one device {PRO
-00041170: 475f 5749 5448 4f55 545f 4558 547d 2022  G_WITHOUT_EXT} "
-00041180: 0a20 2020 2020 2020 2022 6973 2063 7572  .        "is cur
-00041190: 7265 6e74 6c79 2075 7369 6e67 2077 696c  rently using wil
-000411a0: 6c20 6265 206c 6f67 6765 6420 6f75 742e  l be logged out.
-000411b0: 2022 0a20 2020 2020 2020 2022 4966 2079   ".        "If y
-000411c0: 6f75 2063 686f 6f73 6520 2761 6c6c 272c  ou choose 'all',
-000411d0: 2061 6c6c 2064 6576 6963 6573 206f 6620   all devices of 
-000411e0: 7468 6520 7573 6572 2075 7365 6420 6279  the user used by
-000411f0: 2022 0a20 2020 2020 2020 2066 227b 5052   ".        f"{PR
-00041200: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
-00041210: 7769 6c6c 2062 6520 6c6f 6767 6564 206f  will be logged o
-00041220: 7574 2e20 220a 2020 2020 2020 2020 2257  ut. ".        "W
-00041230: 6869 6c65 202d 2d6c 6f67 6f75 7420 6e65  hile --logout ne
-00041240: 6974 6865 7220 7265 6d6f 7665 7320 7468  ither removes th
-00041250: 6520 6372 6564 656e 7469 616c 7320 6e6f  e credentials no
-00041260: 7220 7468 6520 7374 6f72 652c 2074 6865  r the store, the
-00041270: 2022 0a20 2020 2020 2020 2022 6c6f 676f   ".        "logo
-00041280: 7574 2061 6374 696f 6e20 7265 6d6f 7665  ut action remove
-00041290: 7320 7468 6520 6465 7669 6365 2061 6e64  s the device and
-000412a0: 206d 616b 6573 2074 6865 2061 6363 6573   makes the acces
-000412b0: 732d 746f 6b65 6e20 7374 6f72 6564 2022  s-token stored "
-000412c0: 0a20 2020 2020 2020 2022 696e 2074 6865  .        "in the
-000412d0: 2063 7265 6465 6e74 6961 6c73 2069 6e76   credentials inv
-000412e0: 616c 6964 2e20 4865 6e63 652c 2061 6674  alid. Hence, aft
-000412f0: 6572 2061 202d 2d6c 6f67 6f75 742c 206f  er a --logout, o
-00041300: 6e65 206d 7573 7420 220a 2020 2020 2020  ne must ".      
-00041310: 2020 226d 616e 7561 6c6c 7920 7265 6d6f    "manually remo
-00041320: 7665 2063 7265 6465 6e74 6961 6c73 2061  ve credentials a
-00041330: 6e64 2073 746f 7265 2c20 616e 6420 7468  nd store, and th
-00041340: 656e 2070 6572 666f 726d 2061 206e 6577  en perform a new
-00041350: 2022 0a20 2020 2020 2020 2066 222d 2d6c   ".        f"--l
-00041360: 6f67 696e 2074 6f20 7573 6520 7b50 524f  ogin to use {PRO
-00041370: 475f 5749 5448 4f55 545f 4558 547d 2061  G_WITHOUT_EXT} a
-00041380: 6761 696e 2e20 220a 2020 2020 2020 2020  gain. ".        
-00041390: 2259 6f75 2063 616e 2070 6572 6665 6374  "You can perfect
-000413a0: 6c79 2075 7365 2022 0a20 2020 2020 2020  ly use ".       
-000413b0: 2066 227b 5052 4f47 5f57 4954 484f 5554   f"{PROG_WITHOUT
-000413c0: 5f45 5854 7d20 7769 7468 6f75 7420 6576  _EXT} without ev
-000413d0: 6572 206c 6f67 6769 6e67 206f 7574 2e20  er logging out. 
-000413e0: 2d2d 6c6f 676f 7574 2069 7320 6120 636c  --logout is a cl
-000413f0: 6561 6e75 7020 220a 2020 2020 2020 2020  eanup ".        
-00041400: 2269 6620 796f 7520 6861 7665 2064 6563  "if you have dec
-00041410: 6964 6564 206e 6f74 2074 6f20 7573 6520  ided not to use 
-00041420: 7468 6973 2028 6f72 2061 6c6c 2920 6465  this (or all) de
-00041430: 7669 6365 2873 2920 6576 6572 2061 6761  vice(s) ever aga
-00041440: 696e 2e22 2c0a 2020 2020 290a 2020 2020  in.",.    ).    
-00041450: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-00041460: 0a20 2020 2020 2020 2022 2d63 222c 0a20  .        "-c",. 
-00041470: 2020 2020 2020 2022 2d2d 6372 6564 656e         "--creden
-00041480: 7469 616c 7322 2c0a 2020 2020 2020 2020  tials",.        
-00041490: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-000414a0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-000414b0: 2c0a 2020 2020 2020 2020 6465 6661 756c  ,.        defaul
-000414c0: 743d 4352 4544 454e 5449 414c 535f 4649  t=CREDENTIALS_FI
-000414d0: 4c45 5f44 4546 4155 4c54 2c0a 2020 2020  LE_DEFAULT,.    
-000414e0: 2020 2020 6d65 7461 7661 723d 2243 5245      metavar="CRE
-000414f0: 4445 4e54 4941 4c53 5f46 494c 4522 2c0a  DENTIALS_FILE",.
-00041500: 2020 2020 2020 2020 6865 6c70 3d22 5370          help="Sp
-00041510: 6563 6966 7920 6c6f 6361 7469 6f6e 206f  ecify location o
-00041520: 6620 6372 6564 656e 7469 616c 7320 6669  f credentials fi
-00041530: 6c65 2e20 220a 2020 2020 2020 2020 2244  le. ".        "D
-00041540: 6574 6169 6c73 3a3a 204f 6e20 6669 7273  etails:: On firs
-00041550: 7420 7275 6e2c 2069 6e66 6f72 6d61 7469  t run, informati
-00041560: 6f6e 2061 626f 7574 2068 6f6d 6573 6572  on about homeser
-00041570: 7665 722c 2022 0a20 2020 2020 2020 2022  ver, ".        "
-00041580: 7573 6572 2c20 726f 6f6d 2069 642c 2065  user, room id, e
-00041590: 7463 2e20 7769 6c6c 2062 6520 7772 6974  tc. will be writ
-000415a0: 7465 6e20 746f 2061 2063 7265 6465 6e74  ten to a credent
-000415b0: 6961 6c73 2022 0a20 2020 2020 2020 2022  ials ".        "
-000415c0: 6669 6c65 2e20 4279 2064 6566 6175 6c74  file. By default
-000415d0: 2c20 7468 6973 2066 696c 6520 220a 2020  , this file ".  
-000415e0: 2020 2020 2020 6627 6973 2022 7b43 5245        f'is "{CRE
-000415f0: 4445 4e54 4941 4c53 5f46 494c 455f 4445  DENTIALS_FILE_DE
-00041600: 4641 554c 547d 222e 2027 0a20 2020 2020  FAULT}". '.     
-00041610: 2020 2022 4f6e 2066 7572 7468 6572 2072     "On further r
-00041620: 756e 7320 7468 6520 6372 6564 656e 7469  uns the credenti
-00041630: 616c 7320 6669 6c65 2069 7320 7265 6164  als file is read
-00041640: 2074 6f20 220a 2020 2020 2020 2020 2270   to ".        "p
-00041650: 6572 6d69 7420 6c6f 6767 696e 6720 696e  ermit logging in
-00041660: 746f 2074 6865 2063 6f72 7265 6374 204d  to the correct M
-00041670: 6174 7269 7820 6163 636f 756e 7420 220a  atrix account ".
-00041680: 2020 2020 2020 2020 2261 6e64 2073 656e          "and sen
-00041690: 6469 6e67 206d 6573 7361 6765 7320 746f  ding messages to
-000416a0: 2074 6865 2070 7265 636f 6e66 6967 7572   the preconfigur
-000416b0: 6564 2072 6f6f 6d2e 2022 0a20 2020 2020  ed room. ".     
-000416c0: 2020 2022 4966 2074 6869 7320 6f70 7469     "If this opti
-000416d0: 6f6e 2069 7320 7072 6f76 6964 6564 2c20  on is provided, 
-000416e0: 7468 6520 7072 6f76 6964 6564 2066 696c  the provided fil
-000416f0: 6520 6e61 6d65 2022 0a20 2020 2020 2020  e name ".       
-00041700: 2022 7769 6c6c 2062 6520 7573 6564 2061   "will be used a
-00041710: 7320 6372 6564 656e 7469 616c 7320 6669  s credentials fi
-00041720: 6c65 2069 6e73 7465 6164 206f 6620 7468  le instead of th
-00041730: 6520 220a 2020 2020 2020 2020 2264 6566  e ".        "def
-00041740: 6175 6c74 206f 6e65 2e20 222c 0a20 2020  ault one. ",.   
-00041750: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-00041760: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-00041770: 222d 7322 2c0a 2020 2020 2020 2020 222d  "-s",.        "-
-00041780: 2d73 746f 7265 222c 0a20 2020 2020 2020  -store",.       
-00041790: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-000417a0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-000417b0: 722c 0a20 2020 2020 2020 2064 6566 6175  r,.        defau
-000417c0: 6c74 3d53 544f 5245 5f44 4952 5f44 4546  lt=STORE_DIR_DEF
-000417d0: 4155 4c54 2c0a 2020 2020 2020 2020 6d65  AULT,.        me
-000417e0: 7461 7661 723d 2253 544f 5245 5f44 4952  tavar="STORE_DIR
-000417f0: 4543 544f 5259 222c 0a20 2020 2020 2020  ECTORY",.       
-00041800: 2068 656c 703d 2253 7065 6369 6679 206c   help="Specify l
-00041810: 6f63 6174 696f 6e20 6f66 2073 746f 7265  ocation of store
-00041820: 2064 6972 6563 746f 7279 2e20 220a 2020   directory. ".  
-00041830: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-00041840: 2050 6174 6820 746f 2064 6972 6563 746f   Path to directo
-00041850: 7279 2074 6f20 6265 2022 0a20 2020 2020  ry to be ".     
-00041860: 2020 2027 7573 6564 2061 7320 2273 746f     'used as "sto
-00041870: 7265 2220 666f 7220 656e 6372 7970 7465  re" for encrypte
-00041880: 6420 6d65 7373 6167 696e 672e 2027 0a20  d messaging. '. 
-00041890: 2020 2020 2020 2022 4279 2064 6566 6175         "By defau
-000418a0: 6c74 2c20 7468 6973 2064 6972 6563 746f  lt, this directo
-000418b0: 7279 2022 0a20 2020 2020 2020 2066 2769  ry ".        f'i
-000418c0: 7320 227b 5354 4f52 455f 4449 525f 4445  s "{STORE_DIR_DE
-000418d0: 4641 554c 547d 222e 2027 0a20 2020 2020  FAULT}". '.     
-000418e0: 2020 2022 5369 6e63 6520 656e 6372 7970     "Since encryp
-000418f0: 7469 6f6e 2069 7320 616c 7761 7973 2065  tion is always e
-00041900: 6e61 626c 6564 2c20 6120 7374 6f72 6520  nabled, a store 
-00041910: 6973 2022 0a20 2020 2020 2020 2022 616c  is ".        "al
-00041920: 7761 7973 206e 6565 6465 642e 2022 0a20  ways needed. ". 
-00041930: 2020 2020 2020 2022 5468 6520 7072 6f76         "The prov
-00041940: 6964 6564 2064 6972 6563 746f 7279 206e  ided directory n
-00041950: 616d 6520 220a 2020 2020 2020 2020 2277  ame ".        "w
-00041960: 696c 6c20 6265 2075 7365 6420 6173 2070  ill be used as p
-00041970: 6572 7369 7374 656e 7420 7374 6f72 6167  ersistent storag
-00041980: 6520 6469 7265 6374 6f72 7920 696e 7374  e directory inst
-00041990: 6561 6420 6f66 2022 0a20 2020 2020 2020  ead of ".       
-000419a0: 2022 7468 6520 6465 6661 756c 7420 6f6e   "the default on
-000419b0: 652e 2050 7265 6665 7261 626c 792c 2066  e. Preferably, f
-000419c0: 6f72 206d 756c 7469 706c 6520 6578 6563  or multiple exec
-000419d0: 7574 696f 6e73 2022 0a20 2020 2020 2020  utions ".       
-000419e0: 2022 6f66 2074 6869 7320 7072 6f67 7261   "of this progra
-000419f0: 6d20 7573 6520 7468 6520 7361 6d65 2073  m use the same s
-00041a00: 746f 7265 2066 6f72 2074 6865 2073 616d  tore for the sam
-00041a10: 6520 6465 7669 6365 2e20 220a 2020 2020  e device. ".    
-00041a20: 2020 2020 2254 6865 2073 746f 7265 2064      "The store d
-00041a30: 6972 6563 746f 7279 2063 616e 2062 6520  irectory can be 
-00041a40: 7368 6172 6564 2062 6574 7765 656e 206d  shared between m
-00041a50: 756c 7469 706c 6520 220a 2020 2020 2020  ultiple ".      
-00041a60: 2020 2264 6966 6665 7265 6e74 2064 6576    "different dev
-00041a70: 6963 6573 2061 6e64 2075 7365 7273 2e22  ices and users."
-00041a80: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-00041a90: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-00041aa0: 2020 2020 2022 2d72 222c 0a20 2020 2020       "-r",.     
-00041ab0: 2020 2022 2d2d 726f 6f6d 222c 0a20 2020     "--room",.   
-00041ac0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00041ad0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00041ae0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-00041af0: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-00041b00: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00041b10: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-00041b20: 6172 3d22 524f 4f4d 222c 0a20 2020 2020  ar="ROOM",.     
-00041b30: 2020 2068 656c 703d 2253 7065 6369 6679     help="Specify
-00041b40: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-00041b50: 2072 6f6f 6d73 2e20 220a 2020 2020 2020   rooms. ".      
-00041b60: 2020 2244 6574 6169 6c73 3a3a 204f 7074    "Details:: Opt
-00041b70: 696f 6e61 6c6c 7920 7370 6563 6966 7920  ionally specify 
-00041b80: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
-00041b90: 726f 6f6d 7320 7669 6120 726f 6f6d 2069  rooms via room i
-00041ba0: 6473 206f 7220 220a 2020 2020 2020 2020  ds or ".        
-00041bb0: 2272 6f6f 6d20 616c 6961 7365 732e 202d  "room aliases. -
-00041bc0: 2d72 6f6f 6d20 6973 2075 7365 6420 6279  -room is used by
-00041bd0: 2076 6172 696f 7573 2073 656e 6420 6163   various send ac
-00041be0: 7469 6f6e 7320 616e 6420 220a 2020 2020  tions and ".    
-00041bf0: 2020 2020 2276 6172 696f 7573 206c 6973      "various lis
-00041c00: 7465 6e20 6163 7469 6f6e 732e 2022 0a20  ten actions. ". 
-00041c10: 2020 2020 2020 2022 5468 6520 6465 6661         "The defa
-00041c20: 756c 7420 726f 6f6d 2069 7320 7072 6f76  ult room is prov
-00041c30: 6964 6564 2022 0a20 2020 2020 2020 2022  ided ".        "
-00041c40: 696e 2074 6865 2063 7265 6465 6e74 6961  in the credentia
-00041c50: 6c73 2066 696c 6520 2873 7065 6369 6669  ls file (specifi
-00041c60: 6564 2061 7420 2d2d 6c6f 6769 6e20 7769  ed at --login wi
-00041c70: 7468 202d 2d72 6f6f 6d2d 6465 6661 756c  th --room-defaul
-00041c80: 7429 2e20 220a 2020 2020 2020 2020 2249  t). ".        "I
-00041c90: 6620 6120 726f 6f6d 2028 6f72 206d 756c  f a room (or mul
-00041ca0: 7469 706c 6520 6f6e 6573 2920 220a 2020  tiple ones) ".  
-00041cb0: 2020 2020 2020 2269 7320 286f 7220 6172        "is (or ar
-00041cc0: 6529 2070 726f 7669 6465 6420 696e 2074  e) provided in t
-00041cd0: 6865 202d 2d72 6f6f 6d20 6172 6775 6d65  he --room argume
-00041ce0: 6e74 732c 2074 6865 6e20 6974 2022 0a20  nts, then it ". 
-00041cf0: 2020 2020 2020 2022 286f 7220 7468 6579         "(or they
-00041d00: 2920 7769 6c6c 2062 6520 7573 6564 2022  ) will be used "
-00041d10: 0a20 2020 2020 2020 2022 696e 7374 6561  .        "instea
-00041d20: 6420 6f66 2074 6865 206f 6e65 2066 726f  d of the one fro
-00041d30: 6d20 7468 6520 6372 6564 656e 7469 616c  m the credential
-00041d40: 7320 6669 6c65 2e20 220a 2020 2020 2020  s file. ".      
-00041d50: 2020 2254 6865 2075 7365 7220 6d75 7374    "The user must
-00041d60: 2068 6176 6520 6163 6365 7373 2074 6f20   have access to 
-00041d70: 7468 6520 7370 6563 6966 6965 6420 726f  the specified ro
-00041d80: 6f6d 2022 0a20 2020 2020 2020 2022 696e  om ".        "in
-00041d90: 206f 7264 6572 2074 6f20 7365 6e64 206d   order to send m
-00041da0: 6573 7361 6765 7320 7468 6572 6520 6f72  essages there or
-00041db0: 206c 6973 7465 6e20 6f6e 2074 6865 2072   listen on the r
-00041dc0: 6f6f 6d2e 2022 0a20 2020 2020 2020 2022  oom. ".        "
-00041dd0: 4d65 7373 6167 6573 2063 616e 6e6f 7420  Messages cannot 
-00041de0: 220a 2020 2020 2020 2020 2262 6520 7365  ".        "be se
-00041df0: 6e74 2074 6f20 6172 6269 7472 6172 7920  nt to arbitrary 
-00041e00: 726f 6f6d 732e 2057 6865 6e20 7370 6563  rooms. When spec
-00041e10: 6966 7969 6e67 2074 6865 2022 0a20 2020  ifying the ".   
-00041e20: 2020 2020 2022 726f 6f6d 2069 6420 736f       "room id so
-00041e30: 6d65 2073 6865 6c6c 7320 7265 7175 6972  me shells requir
-00041e40: 6520 7468 6520 6578 636c 616d 6174 696f  e the exclamatio
-00041e50: 6e20 6d61 726b 2022 0a20 2020 2020 2020  n mark ".       
-00041e60: 2022 746f 2062 6520 6573 6361 7065 6420   "to be escaped 
-00041e70: 7769 7468 2061 2062 6163 6b73 6c61 7368  with a backslash
-00041e80: 2e20 220a 2020 2020 2020 2020 2241 7320  . ".        "As 
-00041e90: 616e 2061 6c74 6572 6e61 7469 7665 2074  an alternative t
-00041ea0: 6f20 7370 6563 6966 7969 6e67 2061 2072  o specifying a r
-00041eb0: 6f6f 6d20 6173 2064 6573 7469 6e61 7469  oom as destinati
-00041ec0: 6f6e 2c20 220a 2020 2020 2020 2020 226f  on, ".        "o
-00041ed0: 6e65 2063 616e 2073 7065 6369 6679 2061  ne can specify a
-00041ee0: 2075 7365 7220 6173 2061 2064 6573 7469   user as a desti
-00041ef0: 6e61 7469 6f6e 2077 6974 6820 7468 6520  nation with the 
-00041f00: 272d 2d75 7365 7227 2022 0a20 2020 2020  '--user' ".     
-00041f10: 2020 2022 6172 6775 6d65 6e74 2e20 5365     "argument. Se
-00041f20: 6520 272d 2d75 7365 7227 2061 6e64 2074  e '--user' and t
-00041f30: 6865 2074 6572 6d20 2744 4d20 2864 6972  he term 'DM (dir
-00041f40: 6563 7420 6d65 7373 6167 696e 6729 2720  ect messaging)' 
-00041f50: 220a 2020 2020 2020 2020 2266 6f72 2064  ".        "for d
-00041f60: 6574 6169 6c73 2e20 5370 6563 6966 7969  etails. Specifyi
-00041f70: 6e67 2061 2072 6f6f 6d20 6973 2061 6c77  ng a room is alw
-00041f80: 6179 7320 6661 7374 6572 2061 6e64 206d  ays faster and m
-00041f90: 6f72 6520 220a 2020 2020 2020 2020 2265  ore ".        "e
-00041fa0: 6666 6963 6965 6e74 2074 6861 6e20 7370  fficient than sp
-00041fb0: 6563 6966 7969 6e67 2061 2075 7365 722e  ecifying a user.
-00041fc0: 204e 6f74 2061 6c6c 206c 6973 7465 6e20   Not all listen 
-00041fd0: 6f70 6572 6174 696f 6e73 2022 0a20 2020  operations ".   
-00041fe0: 2020 2020 2022 616c 6c6f 7720 7365 7474       "allow sett
-00041ff0: 696e 6720 6120 726f 6f6d 2e20 5265 6164  ing a room. Read
-00042000: 206d 6f72 6520 756e 6465 7220 7468 6520   more under the 
-00042010: 2d2d 6c69 7374 656e 206f 7074 696f 6e73  --listen options
-00042020: 2022 0a20 2020 2020 2020 2022 616e 6420   ".        "and 
-00042030: 7369 6d69 6c61 722e 204d 6f73 7420 6163  similar. Most ac
-00042040: 7469 6f6e 7320 616c 736f 2073 7570 706f  tions also suppo
-00042050: 7274 2072 6f6f 6d20 616c 6961 7365 7320  rt room aliases 
-00042060: 696e 7374 6561 6420 6f66 2022 0a20 2020  instead of ".   
-00042070: 2020 2020 2022 726f 6f6d 2069 6473 2e20       "room ids. 
-00042080: 536f 6d65 2065 7665 6e20 7368 6f72 7420  Some even short 
-00042090: 726f 6f6d 2061 6c69 6173 6573 2e22 2c0a  room aliases.",.
-000420a0: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-000420b0: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-000420c0: 2020 2022 2d2d 726f 6f6d 2d64 6566 6175     "--room-defau
-000420d0: 6c74 222c 0a20 2020 2020 2020 2072 6571  lt",.        req
-000420e0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-000420f0: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
-00042100: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-00042110: 4445 4641 554c 545f 524f 4f4d 222c 0a20  DEFAULT_ROOM",. 
-00042120: 2020 2020 2020 2068 656c 703d 2253 7065         help="Spe
-00042130: 6369 6679 2074 6865 2064 6566 6175 6c74  cify the default
-00042140: 2072 6f6f 6d20 6174 202d 2d6c 6f67 696e   room at --login
-00042150: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00042160: 6169 6c73 3a3a 204f 7074 696f 6e61 6c6c  ails:: Optionall
-00042170: 7920 7370 6563 6966 7920 6120 726f 6f6d  y specify a room
-00042180: 2061 7320 7468 6520 220a 2020 2020 2020   as the ".      
-00042190: 2020 2264 6566 6175 6c74 2072 6f6f 6d20    "default room 
-000421a0: 666f 7220 6675 7475 7265 2061 6374 696f  for future actio
-000421b0: 6e73 2e20 4966 206e 6f74 2073 7065 6369  ns. If not speci
-000421c0: 6669 6564 2066 6f72 202d 2d6c 6f67 696e  fied for --login
-000421d0: 2c20 6974 2022 0a20 2020 2020 2020 2022  , it ".        "
-000421e0: 7769 6c6c 2062 6520 7175 6572 6965 6420  will be queried 
-000421f0: 7669 6120 7468 6520 6b65 7962 6f61 7264  via the keyboard
-00042200: 2e20 2d2d 6c6f 6769 6e20 7374 6f72 6573  . --login stores
-00042210: 2074 6865 2073 7065 6369 6669 6564 2072   the specified r
-00042220: 6f6f 6d20 220a 2020 2020 2020 2020 2261  oom ".        "a
-00042230: 7320 6465 6661 756c 7420 726f 6f6d 2069  s default room i
-00042240: 6e20 796f 7572 2063 7265 6465 6e74 6961  n your credentia
-00042250: 6c73 2066 696c 652e 2054 6869 7320 6f70  ls file. This op
-00042260: 7469 6f6e 2069 7320 6f6e 6c79 2075 7365  tion is only use
-00042270: 6420 220a 2020 2020 2020 2020 2269 6e20  d ".        "in 
-00042280: 636f 6d62 696e 6174 696f 6e20 7769 7468  combination with
-00042290: 202d 2d6c 6f67 696e 2e20 4120 6465 6661   --login. A defa
-000422a0: 756c 7420 726f 6f6d 2069 7320 6e65 6564  ult room is need
-000422b0: 6564 2e20 5370 6563 6966 7920 6120 220a  ed. Specify a ".
-000422c0: 2020 2020 2020 2020 2276 616c 6964 2072          "valid r
-000422d0: 6f6f 6d20 6569 7468 6572 2077 6974 6820  oom either with 
-000422e0: 2d2d 726f 6f6d 2d64 6566 6175 6c74 206f  --room-default o
-000422f0: 7220 7072 6f76 6964 6520 6974 2076 6961  r provide it via
-00042300: 206b 6579 626f 6172 642e 222c 0a20 2020   keyboard.",.   
-00042310: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-00042320: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-00042330: 222d 2d72 6f6f 6d2d 6372 6561 7465 222c  "--room-create",
-00042340: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-00042350: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-00042360: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
-00042370: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
-00042380: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
-00042390: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
-000423a0: 6574 6176 6172 3d22 524f 4f4d 5f41 4c49  etavar="ROOM_ALI
-000423b0: 4153 222c 0a20 2020 2020 2020 2068 656c  AS",.        hel
-000423c0: 703d 2243 7265 6174 6520 6f6e 6520 6f72  p="Create one or
-000423d0: 206d 756c 7469 706c 6520 726f 6f6d 7320   multiple rooms 
-000423e0: 666f 7220 6769 7665 6e20 616c 6961 7328  for given alias(
-000423f0: 6573 292e 2022 0a20 2020 2020 2020 2022  es). ".        "
-00042400: 4465 7461 696c 733a 3a20 4f6e 6520 6f72  Details:: One or
-00042410: 206d 756c 7469 706c 6520 220a 2020 2020   multiple ".    
-00042420: 2020 2020 2272 6f6f 6d20 616c 6961 7365      "room aliase
-00042430: 7320 6361 6e20 6265 2073 7065 6369 6669  s can be specifi
-00042440: 6564 2e20 220a 2020 2020 2020 2020 2246  ed. ".        "F
-00042450: 6f72 2065 6163 6820 616c 6961 7320 7370  or each alias sp
-00042460: 6563 6966 6965 6420 6120 726f 6f6d 2077  ecified a room w
-00042470: 696c 6c20 6265 2063 7265 6174 6564 2e20  ill be created. 
-00042480: 220a 2020 2020 2020 2020 2246 6f72 2065  ".        "For e
-00042490: 6163 6820 6372 6561 7465 6420 726f 6f6d  ach created room
-000424a0: 206f 6e65 206c 696e 6520 7769 7468 2072   one line with r
-000424b0: 6f6f 6d20 6964 2061 6e64 2061 6c69 6173  oom id and alias
-000424c0: 2022 0a20 2020 2020 2020 2022 7769 6c6c   ".        "will
-000424d0: 2062 6520 7072 696e 7465 6420 746f 2073   be printed to s
-000424e0: 7464 6f75 742e 2022 0a20 2020 2020 2020  tdout. ".       
-000424f0: 2022 4966 2079 6f75 2061 7265 206e 6f74   "If you are not
-00042500: 2069 6e74 6572 6573 7465 6420 696e 2061   interested in a
-00042510: 6e20 220a 2020 2020 2020 2020 2761 6c69  n ".        'ali
-00042520: 6173 2c20 7072 6f76 6964 6520 616e 2065  as, provide an e
-00042530: 6d70 7479 2073 7472 696e 6720 6c69 6b65  mpty string like
-00042540: 2022 222e 2027 0a20 2020 2020 2020 2022   "". '.        "
-00042550: 5468 6520 616c 6961 7320 7072 6f76 6964  The alias provid
-00042560: 6564 206d 7573 7420 6265 2069 6e20 6361  ed must be in ca
-00042570: 6e6f 6e69 6361 6c20 6c6f 6361 6c20 666f  nonical local fo
-00042580: 726d 2c20 692e 652e 2022 0a20 2020 2020  rm, i.e. ".     
-00042590: 2020 2022 6966 2079 6f75 2077 616e 7420     "if you want 
-000425a0: 6120 6669 6e61 6c20 6675 6c6c 2061 6c69  a final full ali
-000425b0: 6173 206c 696b 6520 220a 2020 2020 2020  as like ".      
-000425c0: 2020 2722 2353 6f6d 6552 6f6f 6d41 6c69    '"#SomeRoomAli
-000425d0: 6173 3a6d 6174 7269 782e 6578 616d 706c  as:matrix.exampl
-000425e0: 652e 636f 6d22 2027 0a20 2020 2020 2020  e.com" '.       
-000425f0: 2022 796f 7520 6d75 7374 2070 726f 7669   "you must provi
-00042600: 6465 2074 6865 2073 7472 696e 6720 2753  de the string 'S
-00042610: 6f6d 6552 6f6f 6d41 6c69 6173 272e 2022  omeRoomAlias'. "
-00042620: 0a20 2020 2020 2020 2022 5468 6520 7573  .        "The us
-00042630: 6572 206d 7573 7420 6265 2070 6572 6d69  er must be permi
-00042640: 7474 6564 2074 6f20 6372 6561 7465 2072  tted to create r
-00042650: 6f6f 6d73 2e20 220a 2020 2020 2020 2020  ooms. ".        
-00042660: 2243 6f6d 6269 6e65 202d 2d72 6f6f 6d2d  "Combine --room-
-00042670: 6372 6561 7465 2077 6974 6820 2d2d 6e61  create with --na
-00042680: 6d65 2061 6e64 202d 2d74 6f70 6963 2074  me and --topic t
-00042690: 6f20 6164 6420 220a 2020 2020 2020 2020  o add ".        
-000426a0: 226e 616d 6573 2061 6e64 2074 6f70 6963  "names and topic
-000426b0: 7320 746f 2074 6865 2072 6f6f 6d28 7329  s to the room(s)
-000426c0: 2074 6f20 6265 2063 7265 6174 6564 2e20   to be created. 
-000426d0: 220a 2020 2020 2020 2020 2252 6f6f 6d73  ".        "Rooms
-000426e0: 2061 7265 2062 7920 6465 6661 756c 7420   are by default 
-000426f0: 6372 6561 7465 6420 656e 6372 7970 7465  created encrypte
-00042700: 643b 2022 0a20 2020 2020 2020 2022 746f  d; ".        "to
-00042710: 206f 7665 7277 7269 7465 2074 6861 7420   overwrite that 
-00042720: 616e 6420 746f 2063 7265 6174 6520 6120  and to create a 
-00042730: 726f 6f6d 2077 6974 6820 656e 6372 7970  room with encryp
-00042740: 7469 6f6e 2064 6973 6162 6c65 6420 220a  tion disabled ".
-00042750: 2020 2020 2020 2020 2275 7365 2027 2d2d          "use '--
-00042760: 706c 6169 6e27 2e20 220a 2020 2020 2020  plain'. ".      
-00042770: 2020 2252 6f6f 6d20 6964 2c20 726f 6f6d    "Room id, room
-00042780: 2061 6c69 6173 2c20 656e 6372 7970 7469   alias, encrypti
-00042790: 6f6e 2061 6e64 206f 7468 6572 2066 6965  on and other fie
-000427a0: 6c64 7320 220a 2020 2020 2020 2020 2261  lds ".        "a
-000427b0: 7265 2070 7269 6e74 6564 2061 7320 6f75  re printed as ou
-000427c0: 7470 7574 2c20 6f6e 6520 6c69 6e65 2070  tput, one line p
-000427d0: 6572 2063 7265 6174 6564 2072 6f6f 6d2e  er created room.
-000427e0: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-000427f0: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00042800: 2020 2020 2020 222d 2d72 6f6f 6d2d 646d        "--room-dm
-00042810: 2d63 7265 6174 6522 2c0a 2020 2020 2020  -create",.      
-00042820: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-00042830: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
-00042840: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
-00042850: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
-00042860: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-00042870: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-00042880: 2255 5345 5222 2c0a 2020 2020 2020 2020  "USER",.        
-00042890: 6865 6c70 3d22 4372 6561 7465 206f 6e65  help="Create one
-000428a0: 206f 7220 6d75 6c74 6970 6c65 2044 4d20   or multiple DM 
-000428b0: 726f 6f6d 7320 7769 7468 2074 6865 2073  rooms with the s
-000428c0: 7065 6369 6669 6564 2075 7365 7273 2e20  pecified users. 
-000428d0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-000428e0: 6c73 3a3a 2046 6f72 2065 6163 6820 7573  ls:: For each us
-000428f0: 6572 2073 7065 6369 6669 6564 2061 2044  er specified a D
-00042900: 4d20 726f 6f6d 2077 696c 6c20 6265 2063  M room will be c
-00042910: 7265 6174 6564 2061 6e64 2074 6865 2022  reated and the "
-00042920: 0a20 2020 2020 2020 2022 7573 6572 2069  .        "user i
-00042930: 6e76 6974 6564 2074 6f20 6974 2e20 466f  nvited to it. Fo
-00042940: 7220 6561 6368 2063 7265 6174 6564 2072  r each created r
-00042950: 6f6f 6d20 6f6e 6520 6c69 6e65 2077 6974  oom one line wit
-00042960: 6820 220a 2020 2020 2020 2020 2272 6f6f  h ".        "roo
-00042970: 6d20 6964 2061 6e64 2061 6c69 6173 2077  m id and alias w
-00042980: 696c 6c20 6265 2070 7269 6e74 6564 2074  ill be printed t
-00042990: 6f20 7374 646f 7574 2e20 5468 6520 7573  o stdout. The us
-000429a0: 6572 2022 0a20 2020 2020 2020 2022 6d75  er ".        "mu
-000429b0: 7374 2062 6520 7065 726d 6974 7465 6420  st be permitted 
-000429c0: 746f 2063 7265 6174 6520 726f 6f6d 732e  to create rooms.
-000429d0: 2043 6f6d 6269 6e65 202d 2d72 6f6f 6d2d   Combine --room-
-000429e0: 646d 2d63 7265 6174 6520 220a 2020 2020  dm-create ".    
-000429f0: 2020 2020 2277 6974 6820 2d2d 6e61 6d65      "with --name
-00042a00: 2c20 2d2d 746f 7069 632c 202d 2d61 6c69  , --topic, --ali
-00042a10: 6173 2074 6f20 6164 6420 6e61 6d65 732c  as to add names,
-00042a20: 2074 6f70 6963 7320 616e 6420 220a 2020   topics and ".  
-00042a30: 2020 2020 2020 2261 6c69 6173 6573 2074        "aliases t
-00042a40: 6f20 7468 6520 726f 6f6d 2873 2920 746f  o the room(s) to
-00042a50: 2062 6520 6372 6561 7465 642e 2022 0a20   be created. ". 
-00042a60: 2020 2020 2020 2022 444d 2072 6f6f 6d73         "DM rooms
-00042a70: 2061 7265 2062 7920 6465 6661 756c 7420   are by default 
-00042a80: 6372 6561 7465 6420 656e 6372 7970 7465  created encrypte
-00042a90: 643b 2022 0a20 2020 2020 2020 2022 746f  d; ".        "to
-00042aa0: 206f 7665 7277 7269 7465 2074 6861 7420   overwrite that 
-00042ab0: 616e 6420 746f 2063 7265 6174 6520 6120  and to create a 
-00042ac0: 726f 6f6d 2077 6974 6820 656e 6372 7970  room with encryp
-00042ad0: 7469 6f6e 2064 6973 6162 6c65 6420 220a  tion disabled ".
-00042ae0: 2020 2020 2020 2020 2275 7365 2027 2d2d          "use '--
-00042af0: 706c 6169 6e27 2e20 220a 2020 2020 2020  plain'. ".      
-00042b00: 2020 2252 6f6f 6d20 6964 2c20 726f 6f6d    "Room id, room
-00042b10: 2061 6c69 6173 2c20 656e 6372 7970 7469   alias, encrypti
-00042b20: 6f6e 2061 6e64 206f 7468 6572 2066 6965  on and other fie
-00042b30: 6c64 7320 220a 2020 2020 2020 2020 2261  lds ".        "a
-00042b40: 7265 2070 7269 6e74 6564 2061 7320 6f75  re printed as ou
-00042b50: 7470 7574 2c20 6f6e 6520 6c69 6e65 2070  tput, one line p
-00042b60: 6572 2063 7265 6174 6564 2072 6f6f 6d2e  er created room.
-00042b70: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-00042b80: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00042b90: 2020 2020 2020 222d 2d72 6f6f 6d2d 6a6f        "--room-jo
-00042ba0: 696e 222c 0a20 2020 2020 2020 2072 6571  in",.        req
-00042bb0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00042bc0: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-00042bd0: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-00042be0: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-00042bf0: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-00042c00: 2020 206d 6574 6176 6172 3d22 524f 4f4d     metavar="ROOM
-00042c10: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-00042c20: 224a 6f69 6e20 6f6e 6520 726f 6f6d 206f  "Join one room o
-00042c30: 7220 6d75 6c74 6970 6c65 2072 6f6f 6d73  r multiple rooms
-00042c40: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00042c50: 6169 6c73 3a3a 204f 6e65 206f 7220 6d75  ails:: One or mu
-00042c60: 6c74 6970 6c65 2022 0a20 2020 2020 2020  ltiple ".       
-00042c70: 2022 726f 6f6d 2061 6c69 6173 6573 2063   "room aliases c
-00042c80: 616e 2062 6520 7370 6563 6966 6965 642e  an be specified.
-00042c90: 2054 6865 2072 6f6f 6d20 286f 7220 6d75   The room (or mu
-00042ca0: 6c74 6970 6c65 2022 0a20 2020 2020 2020  ltiple ".       
-00042cb0: 2022 6f6e 6573 2920 7072 6f76 6964 6564   "ones) provided
-00042cc0: 2069 6e20 7468 6520 6172 6775 6d65 6e74   in the argument
-00042cd0: 7320 7769 6c6c 2062 6520 6a6f 696e 6564  s will be joined
-00042ce0: 2e20 220a 2020 2020 2020 2020 2254 6865  . ".        "The
-00042cf0: 2075 7365 7220 6d75 7374 2068 6176 6520   user must have 
-00042d00: 7065 726d 6973 7369 6f6e 7320 746f 206a  permissions to j
-00042d10: 6f69 6e20 7468 6573 6520 726f 6f6d 732e  oin these rooms.
-00042d20: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-00042d30: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00042d40: 2020 2020 2020 222d 2d72 6f6f 6d2d 6c65        "--room-le
-00042d50: 6176 6522 2c0a 2020 2020 2020 2020 7265  ave",.        re
-00042d60: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
-00042d70: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
-00042d80: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
-00042d90: 6172 6773 3d22 2b22 2c0a 2020 2020 2020  args="+",.      
-00042da0: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
-00042db0: 2020 2020 6d65 7461 7661 723d 2252 4f4f      metavar="ROO
-00042dc0: 4d22 2c0a 2020 2020 2020 2020 6865 6c70  M",.        help
-00042dd0: 3d22 4c65 6176 6520 6f6e 6520 726f 6f6d  ="Leave one room
-00042de0: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-00042df0: 6d73 2e20 220a 2020 2020 2020 2020 2244  ms. ".        "D
-00042e00: 6574 6169 6c73 3a3a 204f 6e65 206f 7220  etails:: One or 
-00042e10: 6d75 6c74 6970 6c65 2022 0a20 2020 2020  multiple ".     
-00042e20: 2020 2022 726f 6f6d 2061 6c69 6173 6573     "room aliases
-00042e30: 2063 616e 2062 6520 7370 6563 6966 6965   can be specifie
-00042e40: 642e 2054 6865 2072 6f6f 6d20 286f 7220  d. The room (or 
-00042e50: 6d75 6c74 6970 6c65 2022 0a20 2020 2020  multiple ".     
-00042e60: 2020 2022 6f6e 6573 2920 7072 6f76 6964     "ones) provid
-00042e70: 6564 2069 6e20 7468 6520 6172 6775 6d65  ed in the argume
-00042e80: 6e74 7320 7769 6c6c 2062 6520 6c65 6674  nts will be left
-00042e90: 2e20 222c 0a20 2020 2029 0a20 2020 2061  . ",.    ).    a
-00042ea0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00042eb0: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
-00042ec0: 666f 7267 6574 222c 0a20 2020 2020 2020  forget",.       
-00042ed0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-00042ee0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-00042ef0: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
-00042f00: 2020 6e61 7267 733d 222b 222c 0a20 2020    nargs="+",.   
-00042f10: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
-00042f20: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-00042f30: 524f 4f4d 222c 0a20 2020 2020 2020 2068  ROOM",.        h
-00042f40: 656c 703d 2246 6f72 6765 7420 6f6e 6520  elp="Forget one 
-00042f50: 726f 6f6d 206f 7220 6d75 6c74 6970 6c65  room or multiple
-00042f60: 2072 6f6f 6d73 2e20 220a 2020 2020 2020   rooms. ".      
-00042f70: 2020 2244 6574 6169 6c73 3a3a 2041 6674    "Details:: Aft
-00042f80: 6572 206c 6561 7669 6e67 2061 2072 6f6f  er leaving a roo
-00042f90: 6d20 796f 7520 7368 6f75 6c64 2028 6d6f  m you should (mo
-00042fa0: 7374 206c 696b 656c 7929 2066 6f72 6765  st likely) forge
-00042fb0: 7420 7468 6520 220a 2020 2020 2020 2020  t the ".        
-00042fc0: 2272 6f6f 6d2e 2046 6f72 6765 7474 696e  "room. Forgettin
-00042fd0: 6720 6120 726f 6f6d 2072 656d 6f76 6573  g a room removes
-00042fe0: 2074 6865 2075 7365 7273 2720 726f 6f6d   the users' room
-00042ff0: 2068 6973 746f 7279 2e20 220a 2020 2020   history. ".    
-00043000: 2020 2020 224f 6e65 206f 7220 6d75 6c74      "One or mult
-00043010: 6970 6c65 2022 0a20 2020 2020 2020 2022  iple ".        "
-00043020: 726f 6f6d 2061 6c69 6173 6573 2063 616e  room aliases can
-00043030: 2062 6520 7370 6563 6966 6965 642e 2054   be specified. T
-00043040: 6865 2072 6f6f 6d20 286f 7220 6d75 6c74  he room (or mult
-00043050: 6970 6c65 2022 0a20 2020 2020 2020 2022  iple ".        "
-00043060: 6f6e 6573 2920 7072 6f76 6964 6564 2069  ones) provided i
-00043070: 6e20 7468 6520 6172 6775 6d65 6e74 7320  n the arguments 
-00043080: 7769 6c6c 2062 6520 666f 7267 6f74 7465  will be forgotte
-00043090: 6e2e 2022 0a20 2020 2020 2020 2022 4966  n. ".        "If
-000430a0: 2061 6c6c 2075 7365 7273 2066 6f72 6765   all users forge
-000430b0: 7420 6120 726f 6f6d 2c20 7468 6520 726f  t a room, the ro
-000430c0: 6f6d 2063 616e 2065 7665 6e74 7561 6c6c  om can eventuall
-000430d0: 7920 6265 2022 0a20 2020 2020 2020 2022  y be ".        "
-000430e0: 6465 6c65 7465 6420 6f6e 2074 6865 2073  deleted on the s
-000430f0: 6572 7665 722e 222c 0a20 2020 2029 0a20  erver.",.    ). 
-00043100: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-00043110: 6e74 280a 2020 2020 2020 2020 222d 2d72  nt(.        "--r
-00043120: 6f6f 6d2d 696e 7669 7465 222c 0a20 2020  oom-invite",.   
-00043130: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00043140: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00043150: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-00043160: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-00043170: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00043180: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-00043190: 6172 3d22 524f 4f4d 222c 0a20 2020 2020  ar="ROOM",.     
-000431a0: 2020 2068 656c 703d 2249 6e76 6974 6520     help="Invite 
-000431b0: 6f6e 6520 6f72 6520 6d6f 7265 2075 7365  one ore more use
-000431c0: 7273 2074 6f20 6a6f 696e 206f 6e65 206f  rs to join one o
-000431d0: 7220 6d6f 7265 2072 6f6f 6d73 2e20 220a  r more rooms. ".
-000431e0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-000431f0: 3a3a 2053 7065 6369 6679 2074 6865 2075  :: Specify the u
-00043200: 7365 7228 7329 2061 7320 6172 6775 6d65  ser(s) as argume
-00043210: 6e74 7320 746f 202d 2d75 7365 722e 2022  nts to --user. "
-00043220: 0a20 2020 2020 2020 2022 5370 6563 6966  .        "Specif
-00043230: 7920 7468 6520 726f 6f6d 7320 6173 2061  y the rooms as a
-00043240: 7267 756d 656e 7473 2074 6f20 7468 6973  rguments to this
-00043250: 206f 7074 696f 6e2c 2069 2e65 2e20 220a   option, i.e. ".
-00043260: 2020 2020 2020 2020 2261 7320 6172 6775          "as argu
-00043270: 6d65 6e74 7320 746f 202d 2d72 6f6f 6d2d  ments to --room-
-00043280: 696e 7669 7465 2e20 220a 2020 2020 2020  invite. ".      
-00043290: 2020 2254 6865 2075 7365 7220 6d75 7374    "The user must
-000432a0: 2068 6176 6520 7065 726d 6973 7369 6f6e   have permission
-000432b0: 7320 746f 2069 6e76 6974 6520 7573 6572  s to invite user
-000432c0: 732e 2022 0a20 2020 2020 2020 2022 446f  s. ".        "Do
-000432d0: 6e27 7420 636f 6e66 7573 6520 7468 6973  n't confuse this
-000432e0: 206f 7074 696f 6e20 7769 7468 202d 2d72   option with --r
-000432f0: 6f6f 6d2d 696e 7669 7465 732e 222c 0a20  oom-invites.",. 
-00043300: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-00043310: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00043320: 2020 222d 2d72 6f6f 6d2d 6261 6e22 2c0a    "--room-ban",.
-00043330: 2020 2020 2020 2020 7265 7175 6972 6564          required
-00043340: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00043350: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
-00043360: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-00043370: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
-00043380: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
-00043390: 7461 7661 723d 2252 4f4f 4d22 2c0a 2020  tavar="ROOM",.  
-000433a0: 2020 2020 2020 6865 6c70 3d22 4261 6e20        help="Ban 
-000433b0: 6f6e 6520 6f72 6520 6d6f 7265 2075 7365  one ore more use
-000433c0: 7273 2066 726f 6d20 6f6e 6520 6f72 206d  rs from one or m
-000433d0: 6f72 6520 726f 6f6d 732e 2022 0a20 2020  ore rooms. ".   
-000433e0: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
-000433f0: 5370 6563 6966 7920 7468 6520 7573 6572  Specify the user
-00043400: 2873 2920 6173 2061 7267 756d 656e 7473  (s) as arguments
-00043410: 2074 6f20 2d2d 7573 6572 2e20 220a 2020   to --user. ".  
-00043420: 2020 2020 2020 2253 7065 6369 6679 2074        "Specify t
-00043430: 6865 2072 6f6f 6d73 2061 7320 6172 6775  he rooms as argu
-00043440: 6d65 6e74 7320 746f 2074 6869 7320 6f70  ments to this op
-00043450: 7469 6f6e 2c20 692e 652e 2022 0a20 2020  tion, i.e. ".   
-00043460: 2020 2020 2022 6173 2061 7267 756d 656e       "as argumen
-00043470: 7473 2074 6f20 2d2d 726f 6f6d 2d62 616e  ts to --room-ban
-00043480: 2e20 220a 2020 2020 2020 2020 2254 6865  . ".        "The
-00043490: 2075 7365 7220 6d75 7374 2068 6176 6520   user must have 
-000434a0: 7065 726d 6973 7369 6f6e 7320 746f 2062  permissions to b
-000434b0: 616e 2075 7365 7273 2e22 2c0a 2020 2020  an users.",.    
-000434c0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-000434d0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-000434e0: 2d2d 726f 6f6d 2d75 6e62 616e 222c 0a20  --room-unban",. 
-000434f0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00043500: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-00043510: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
-00043520: 2020 2020 2020 2020 6e61 7267 733d 222b          nargs="+
-00043530: 222c 0a20 2020 2020 2020 2074 7970 653d  ",.        type=
-00043540: 7374 722c 0a20 2020 2020 2020 206d 6574  str,.        met
-00043550: 6176 6172 3d22 524f 4f4d 222c 0a20 2020  avar="ROOM",.   
-00043560: 2020 2020 2068 656c 703d 2255 6e62 616e       help="Unban
-00043570: 206f 6e65 206f 7265 206d 6f72 6520 7573   one ore more us
-00043580: 6572 7320 6672 6f6d 206f 6e65 206f 7220  ers from one or 
-00043590: 6d6f 7265 2072 6f6f 6d73 2e20 220a 2020  more rooms. ".  
-000435a0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-000435b0: 2053 7065 6369 6679 2074 6865 2075 7365   Specify the use
-000435c0: 7228 7329 2061 7320 6172 6775 6d65 6e74  r(s) as argument
-000435d0: 7320 746f 202d 2d75 7365 722e 2022 0a20  s to --user. ". 
-000435e0: 2020 2020 2020 2022 5370 6563 6966 7920         "Specify 
-000435f0: 7468 6520 726f 6f6d 7320 6173 2061 7267  the rooms as arg
-00043600: 756d 656e 7473 2074 6f20 7468 6973 206f  uments to this o
-00043610: 7074 696f 6e2c 2069 2e65 2e20 220a 2020  ption, i.e. ".  
-00043620: 2020 2020 2020 2261 7320 6172 6775 6d65        "as argume
-00043630: 6e74 7320 746f 202d 2d72 6f6f 6d2d 756e  nts to --room-un
-00043640: 6261 6e2e 2022 0a20 2020 2020 2020 2022  ban. ".        "
-00043650: 5468 6520 7573 6572 206d 7573 7420 6861  The user must ha
-00043660: 7665 2070 6572 6d69 7373 696f 6e73 2074  ve permissions t
-00043670: 6f20 756e 6261 6e20 7573 6572 732e 222c  o unban users.",
-00043680: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-00043690: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-000436a0: 2020 2020 222d 2d72 6f6f 6d2d 6b69 636b      "--room-kick
-000436b0: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-000436c0: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-000436d0: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
-000436e0: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
-000436f0: 733d 222b 222c 0a20 2020 2020 2020 2074  s="+",.        t
-00043700: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-00043710: 206d 6574 6176 6172 3d22 524f 4f4d 222c   metavar="ROOM",
-00043720: 0a20 2020 2020 2020 2068 656c 703d 224b  .        help="K
-00043730: 6963 6b20 6f6e 6520 6f72 6520 6d6f 7265  ick one ore more
-00043740: 2075 7365 7273 2066 726f 6d20 6f6e 6520   users from one 
-00043750: 6f72 206d 6f72 6520 726f 6f6d 732e 2022  or more rooms. "
-00043760: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-00043770: 733a 3a20 5370 6563 6966 7920 7468 6520  s:: Specify the 
-00043780: 7573 6572 2873 2920 6173 2061 7267 756d  user(s) as argum
-00043790: 656e 7473 2074 6f20 2d2d 7573 6572 2e20  ents to --user. 
-000437a0: 220a 2020 2020 2020 2020 2253 7065 6369  ".        "Speci
-000437b0: 6679 2074 6865 2072 6f6f 6d73 2061 7320  fy the rooms as 
-000437c0: 6172 6775 6d65 6e74 7320 746f 2074 6869  arguments to thi
-000437d0: 7320 6f70 7469 6f6e 2c20 692e 652e 2022  s option, i.e. "
-000437e0: 0a20 2020 2020 2020 2022 6173 2061 7267  .        "as arg
-000437f0: 756d 656e 7473 2074 6f20 2d2d 726f 6f6d  uments to --room
-00043800: 2d6b 6963 6b2e 2022 0a20 2020 2020 2020  -kick. ".       
-00043810: 2022 5468 6520 7573 6572 206d 7573 7420   "The user must 
-00043820: 6861 7665 2070 6572 6d69 7373 696f 6e73  have permissions
-00043830: 2074 6f20 6b69 636b 2075 7365 7273 2e22   to kick users."
-00043840: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-00043850: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-00043860: 2020 2020 2023 2073 7461 7274 696e 6720       # starting 
-00043870: 7769 7468 2076 6572 7369 6f6e 2032 2e31  with version 2.1
-00043880: 3920 222d 7522 2068 6173 2062 6565 6e20  9 "-u" has been 
-00043890: 6d6f 7665 6420 6672 6f6d 0a20 2020 2020  moved from.     
-000438a0: 2020 2023 202d 2d64 6f77 6e6c 6f61 642d     # --download-
-000438b0: 6d65 6469 6120 746f 202d 2d75 7365 7221  media to --user!
-000438c0: 0a20 2020 2020 2020 2022 2d75 222c 0a20  .        "-u",. 
-000438d0: 2020 2020 2020 2022 2d2d 7573 6572 222c         "--user",
-000438e0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-000438f0: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-00043900: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
-00043910: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
-00043920: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
-00043930: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
-00043940: 6574 6176 6172 3d22 5553 4552 222c 0a20  etavar="USER",. 
-00043950: 2020 2020 2020 2068 656c 703d 2253 7065         help="Spe
-00043960: 6369 6679 206f 6e65 206f 7220 6d75 6c74  cify one or mult
-00043970: 6970 6c65 2075 7365 7273 2e20 220a 2020  iple users. ".  
-00043980: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-00043990: 2054 6869 7320 6f70 7469 6f6e 2069 7320   This option is 
-000439a0: 6d65 616e 696e 6766 756c 2022 0a20 2020  meaningful ".   
-000439b0: 2020 2020 2022 696e 2063 6f6d 6269 6e61       "in combina
-000439c0: 7469 6f6e 2077 6974 6820 6129 2072 6f6f  tion with a) roo
-000439d0: 6d20 6163 7469 6f6e 7320 6c69 6b65 202d  m actions like -
-000439e0: 2d72 6f6f 6d2d 696e 7669 7465 2c20 2d2d  -room-invite, --
-000439f0: 726f 6f6d 2d62 616e 2c20 220a 2020 2020  room-ban, ".    
-00043a00: 2020 2020 222d 2d72 6f6f 6d2d 756e 6261      "--room-unba
-00043a10: 6e2c 2065 7463 2e20 616e 6420 6229 2073  n, etc. and b) s
-00043a20: 656e 6420 6163 7469 6f6e 7320 6c69 6b65  end actions like
-00043a30: 202d 6d2c 202d 692c 202d 662c 2065 7463   -m, -i, -f, etc
-00043a40: 2e20 220a 2020 2020 2020 2020 2263 2920  . ".        "c) 
-00043a50: 736f 6d65 206c 6973 7465 6e20 6163 7469  some listen acti
-00043a60: 6f6e 7320 2d2d 6c69 7374 656e 2c20 6173  ons --listen, as
-00043a70: 2077 656c 6c20 6173 2064 2920 6163 7469   well as d) acti
-00043a80: 6f6e 7320 6c69 6b65 2022 0a20 2020 2020  ons like ".     
-00043a90: 2020 2022 2d2d 6465 6c65 7465 2d64 6576     "--delete-dev
-00043aa0: 6963 652e 2022 0a20 2020 2020 2020 2022  ice. ".        "
-00043ab0: 496e 2063 6173 6520 6f66 2061 2920 7468  In case of a) th
-00043ac0: 6973 206f 7074 696f 6e20 2d2d 7573 6572  is option --user
-00043ad0: 2073 7065 6369 6669 6573 2074 6865 2075   specifies the u
-00043ae0: 7365 7273 2022 0a20 2020 2020 2020 2022  sers ".        "
-00043af0: 746f 2062 6520 7573 6564 2077 6974 6820  to be used with 
-00043b00: 726f 6f6d 2063 6f6d 6d61 6e64 7320 286c  room commands (l
-00043b10: 696b 6520 696e 7669 7465 2c20 6261 6e2c  ike invite, ban,
-00043b20: 2065 7463 2e29 2e20 220a 2020 2020 2020   etc.). ".      
-00043b30: 2020 2249 6e20 6361 7365 206f 6620 6229    "In case of b)
-00043b40: 2074 6865 206f 7074 696f 6e20 2d2d 7573   the option --us
-00043b50: 6572 2063 616e 2062 6520 7573 6564 2061  er can be used a
-00043b60: 7320 616e 2061 6c74 6572 6e61 7469 7665  s an alternative
-00043b70: 2022 0a20 2020 2020 2020 2022 746f 2073   ".        "to s
-00043b80: 7065 6369 6679 696e 6720 6120 726f 6f6d  pecifying a room
-00043b90: 2061 7320 6465 7374 696e 6174 696f 6e20   as destination 
-00043ba0: 666f 7220 7465 7874 2028 2d6d 292c 2069  for text (-m), i
-00043bb0: 6d61 6765 7320 282d 6929 2c20 220a 2020  mages (-i), ".  
-00043bc0: 2020 2020 2020 2265 7463 2e20 466f 7220        "etc. For 
-00043bd0: 7365 6e64 2061 6374 696f 6e73 2027 2d2d  send actions '--
-00043be0: 7573 6572 2720 6973 2070 726f 7669 6469  user' is providi
-00043bf0: 6e67 2074 6865 2066 756e 6374 696f 6e61  ng the functiona
-00043c00: 6c69 7479 206f 6620 220a 2020 2020 2020  lity of ".      
-00043c10: 2020 2227 444d 2028 6469 7265 6374 206d    "'DM (direct m
-00043c20: 6573 7361 6769 6e67 2927 2e20 466f 7220  essaging)'. For 
-00043c30: 6329 2074 6869 7320 6f70 7469 6f6e 2061  c) this option a
-00043c40: 6c6c 6f77 7320 616e 2061 6c74 6572 6e61  llows an alterna
-00043c50: 7469 7665 2022 0a20 2020 2020 2020 2022  tive ".        "
-00043c60: 746f 2073 7065 6369 6679 696e 6720 6120  to specifying a 
-00043c70: 726f 6f6d 2061 7320 6465 7374 696e 6174  room as destinat
-00043c80: 696f 6e20 666f 7220 736f 6d65 202d 2d6c  ion for some --l
-00043c90: 6973 7465 6e20 6163 7469 6f6e 732e 2022  isten actions. "
-00043ca0: 0a20 2020 2020 2020 2022 466f 7220 6429  .        "For d)
-00043cb0: 2074 6869 7320 6769 7665 7320 7468 6520   this gives the 
-00043cc0: 6f70 7469 6f6e 2074 6f20 6465 6c65 7465  option to delete
-00043cd0: 2074 6865 2064 6576 6963 6520 6f66 2061   the device of a
-00043ce0: 2064 6966 6665 7265 6e74 2022 0a20 2020   different ".   
-00043cf0: 2020 2020 2022 7573 6572 2e20 220a 2020       "user. ".  
-00043d00: 2020 2020 2020 6622 2d2d 2d2d 2d20 5768        f"----- Wh
-00043d10: 6174 2069 7320 6120 444d 3f20 7b50 524f  at is a DM? {PRO
-00043d20: 475f 5749 5448 4f55 545f 4558 547d 2074  G_WITHOUT_EXT} t
-00043d30: 7269 6573 2074 6f20 6669 6e64 2061 2022  ries to find a "
-00043d40: 0a20 2020 2020 2020 2022 726f 6f6d 2074  .        "room t
-00043d50: 6861 7420 636f 6e74 6169 6e73 206f 6e6c  hat contains onl
-00043d60: 7920 7468 6520 7365 6e64 6572 2061 6e64  y the sender and
-00043d70: 2074 6865 2072 6563 6569 7665 722c 2068   the receiver, h
-00043d80: 656e 6365 2044 4d2e 2022 0a20 2020 2020  ence DM. ".     
-00043d90: 2020 2022 5468 6573 6520 726f 6f6d 7320     "These rooms 
-00043da0: 6861 7665 206e 6f74 6869 6e67 2073 7065  have nothing spe
-00043db0: 6369 616c 206f 7468 6572 2074 6865 2066  cial other the f
-00043dc0: 6163 7420 7468 6174 2074 6865 7920 6f6e  act that they on
-00043dd0: 6c79 2068 6176 6520 220a 2020 2020 2020  ly have ".      
-00043de0: 2020 2232 206d 656d 6265 7273 2061 6e64    "2 members and
-00043df0: 2074 6865 6d20 6265 696e 6720 7468 6520   them being the 
-00043e00: 7365 6e64 6572 2061 6e64 2072 6563 6970  sender and recip
-00043e10: 6965 6e74 2072 6573 7065 6374 6976 656c  ient respectivel
-00043e20: 792e 2022 0a20 2020 2020 2020 2022 4966  y. ".        "If
-00043e30: 2073 7563 6820 6120 726f 6f6d 2069 7320   such a room is 
-00043e40: 666f 756e 642c 2074 6865 2066 6972 7374  found, the first
-00043e50: 206f 6e65 2066 6f75 6e64 2077 696c 6c20   one found will 
-00043e60: 6265 2075 7365 6420 6173 2022 0a20 2020  be used as ".   
-00043e70: 2020 2020 2022 6465 7374 696e 6174 696f       "destinatio
-00043e80: 6e2e 2049 6620 6e6f 2073 7563 6820 726f  n. If no such ro
-00043e90: 6f6d 2069 7320 666f 756e 642c 2074 6865  om is found, the
-00043ea0: 2073 656e 6420 6661 696c 7320 616e 6420   send fails and 
-00043eb0: 7468 6520 7573 6572 2022 0a20 2020 2020  the user ".     
-00043ec0: 2020 2022 7368 6f75 6c64 2064 6f20 6120     "should do a 
-00043ed0: 2d2d 726f 6f6d 2d63 7265 6174 6520 616e  --room-create an
-00043ee0: 6420 2d2d 726f 6f6d 2d69 6e76 6974 6520  d --room-invite 
-00043ef0: 6669 7273 742e 2049 6620 6d75 6c74 6970  first. If multip
-00043f00: 6c65 2022 0a20 2020 2020 2020 2022 7375  le ".        "su
-00043f10: 6368 2072 6f6f 6d73 2065 7869 7374 2c20  ch rooms exist, 
-00043f20: 6f6e 6520 6f66 2074 6865 6d20 7769 6c6c  one of them will
-00043f30: 2062 6520 7573 6564 2028 6172 6269 7472   be used (arbitr
-00043f40: 6172 696c 7929 2e20 220a 2020 2020 2020  arily). ".      
-00043f50: 2020 2246 6f72 2073 656e 6469 6e67 2061    "For sending a
-00043f60: 6e64 206c 6973 7465 6e69 6e67 2c20 7370  nd listening, sp
-00043f70: 6563 6966 7969 6e67 2061 2072 6f6f 6d20  ecifying a room 
-00043f80: 6469 7265 6374 6c79 2069 7320 616c 7761  directly is alwa
-00043f90: 7973 2022 0a20 2020 2020 2020 2022 6661  ys ".        "fa
-00043fa0: 7374 6572 2061 6e64 206d 6f72 6520 6566  ster and more ef
-00043fb0: 6669 6369 656e 7420 7468 616e 2073 7065  ficient than spe
-00043fc0: 6369 6679 696e 6720 6120 7573 6572 2e20  cifying a user. 
-00043fd0: 536f 2c20 6966 2079 6f75 206b 6e6f 7720  So, if you know 
-00043fe0: 220a 2020 2020 2020 2020 2274 6865 2072  ".        "the r
-00043ff0: 6f6f 6d2c 2069 7420 6973 2070 7265 6665  oom, it is prefe
-00044000: 7272 6564 2074 6f20 7573 6520 2d2d 726f  rred to use --ro
-00044010: 6f6d 2069 6e73 7465 6164 206f 6620 2d2d  om instead of --
-00044020: 7573 6572 2e20 220a 2020 2020 2020 2020  user. ".        
-00044030: 2246 6f72 2062 2920 616e 6420 6329 202d  "For b) and c) -
-00044040: 2d75 7365 7220 6361 6e20 6265 2073 7065  -user can be spe
-00044050: 6369 6669 6564 2069 6e20 3320 7761 7973  cified in 3 ways
-00044060: 3a20 3129 2066 756c 6c20 7573 6572 2069  : 1) full user i
-00044070: 6420 220a 2020 2020 2020 2020 2261 7320  d ".        "as 
-00044080: 696e 2027 406a 6f68 6e3a 6578 616d 706c  in '@john:exampl
-00044090: 652e 6f72 6727 2c20 3229 2070 6172 7469  e.org', 2) parti
-000440a0: 616c 2075 7365 7220 6964 2061 7320 696e  al user id as in
-000440b0: 2027 406a 6f68 6e27 2077 6865 6e20 220a   '@john' when ".
-000440c0: 2020 2020 2020 2020 2274 6865 2075 7365          "the use
-000440d0: 7220 6973 206f 6e20 7468 6520 7361 6d65  r is on the same
-000440e0: 2068 6f6d 6573 6572 7665 7220 2865 7861   homeserver (exa
-000440f0: 6d70 6c65 2e6f 7267 2077 696c 6c20 6265  mple.org will be
-00044100: 2022 0a20 2020 2020 2020 2022 6175 746f   ".        "auto
-00044110: 6d61 7469 6361 6c6c 7920 6170 7065 6e64  matically append
-00044120: 6564 292c 206f 7220 3329 2061 2064 6973  ed), or 3) a dis
-00044130: 706c 6179 206e 616d 6520 6173 2069 6e20  play name as in 
-00044140: 276a 6f68 6e27 2e20 220a 2020 2020 2020  'john'. ".      
-00044150: 2020 2242 6520 6361 7265 6675 6c2c 2077    "Be careful, w
-00044160: 6865 6e20 220a 2020 2020 2020 2020 2275  hen ".        "u
-00044170: 7369 6e67 2064 6973 706c 6179 206e 616d  sing display nam
-00044180: 6573 2061 7320 7468 6579 206d 6967 6874  es as they might
-00044190: 206e 6f74 2062 6520 756e 6971 7565 2c20   not be unique, 
-000441a0: 616e 6420 796f 7520 636f 756c 6420 220a  and you could ".
-000441b0: 2020 2020 2020 2020 2262 6520 7365 6e64          "be send
-000441c0: 696e 6720 746f 2074 6865 2077 726f 6e67  ing to the wrong
-000441d0: 2070 6572 736f 6e2e 2054 6f20 7365 6520   person. To see 
-000441e0: 706f 7373 6962 6c65 2064 6973 706c 6179  possible display
-000441f0: 206e 616d 6573 2075 7365 2022 0a20 2020   names use ".   
-00044200: 2020 2020 2022 7468 6520 2d2d 6a6f 696e       "the --join
-00044210: 6564 2d6d 656d 6265 7273 2027 2a27 206f  ed-members '*' o
-00044220: 7074 696f 6e20 7768 6963 6820 7769 6c6c  ption which will
-00044230: 2073 686f 7720 796f 7520 7468 6520 6469   show you the di
-00044240: 7370 6c61 7920 220a 2020 2020 2020 2020  splay ".        
-00044250: 226e 616d 6573 2069 6e20 7468 6520 6d69  "names in the mi
-00044260: 6464 6c65 2063 6f6c 756d 6e2e 222c 0a20  ddle column.",. 
-00044270: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-00044280: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00044290: 2020 222d 2d75 7365 722d 6c6f 6769 6e22    "--user-login"
-000442a0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
-000442b0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-000442c0: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
-000442d0: 2020 2020 2320 406a 6f68 6e3a 6578 616d      # @john:exam
-000442e0: 706c 652e 636f 6d20 616e 6420 406a 6f68  ple.com and @joh
-000442f0: 6e20 616e 6420 6a6f 686e 2061 6363 6570  n and john accep
-00044300: 7465 640a 2020 2020 2020 2020 6d65 7461  ted.        meta
-00044310: 7661 723d 2255 5345 5222 2c0a 2020 2020  var="USER",.    
-00044320: 2020 2020 6865 6c70 3d22 5370 6563 6966      help="Specif
-00044330: 7920 7573 6572 2066 6f72 202d 2d6c 6f67  y user for --log
-00044340: 696e 2e20 220a 2020 2020 2020 2020 2244  in. ".        "D
-00044350: 6574 6169 6c73 3a3a 204f 7074 696f 6e61  etails:: Optiona
-00044360: 6c20 6172 6775 6d65 6e74 2074 6f20 7370  l argument to sp
-00044370: 6563 6966 7920 7468 6520 7573 6572 2066  ecify the user f
-00044380: 6f72 202d 2d6c 6f67 696e 2e20 220a 2020  or --login. ".  
-00044390: 2020 2020 2020 2254 6869 7320 6769 7665        "This give
-000443a0: 7320 7468 6520 6f70 7469 6f6e 2074 6f20  s the option to 
-000443b0: 7370 6563 6966 7920 7468 6520 7573 6572  specify the user
-000443c0: 2069 6420 666f 7220 6c6f 6769 6e2e 2022   id for login. "
-000443d0: 0a20 2020 2020 2020 2022 466f 7220 272d  .        "For '-
-000443e0: 2d6c 6f67 696e 2073 736f 2720 7468 6520  -login sso' the 
-000443f0: 2d2d 7573 6572 2d6c 6f67 696e 2069 7320  --user-login is 
-00044400: 6e6f 7420 6e65 6564 6564 2061 7320 7573  not needed as us
-00044410: 6572 2069 6420 6361 6e20 6265 2022 0a20  er id can be ". 
-00044420: 2020 2020 2020 2022 6f62 7461 696e 6564         "obtained
-00044430: 2066 726f 6d20 7365 7276 6572 2076 6961   from server via
-00044440: 2053 534f 2e20 466f 7220 272d 2d6c 6f67   SSO. For '--log
-00044450: 696e 2070 6173 7377 6f72 6427 2c20 6966  in password', if
-00044460: 206e 6f74 2022 0a20 2020 2020 2020 2022   not ".        "
-00044470: 7072 6f76 6964 6564 2069 7420 7769 6c6c  provided it will
-00044480: 2062 6520 7175 6572 6965 6420 7669 6120   be queried via 
-00044490: 6b65 7962 6f61 7264 2e20 4120 6675 6c6c  keyboard. A full
-000444a0: 2075 7365 7220 6964 206c 696b 6520 220a   user id like ".
-000444b0: 2020 2020 2020 2020 2227 406a 6f68 6e3a          "'@john:
-000444c0: 6578 616d 706c 652e 636f 6d27 2c20 6120  example.com', a 
-000444d0: 7061 7274 6961 6c20 7573 6572 206e 616d  partial user nam
-000444e0: 6520 6c69 6b65 2027 406a 6f68 6e27 2c20  e like '@john', 
-000444f0: 616e 6420 220a 2020 2020 2020 2020 2261  and ".        "a
-00044500: 2073 686f 7274 2075 7365 7220 6e61 6d65   short user name
-00044510: 206c 696b 6520 276a 6f68 6e27 2063 616e   like 'john' can
-00044520: 2062 6520 6769 7665 6e2e 2022 0a20 2020   be given. ".   
-00044530: 2020 2020 2022 2d2d 7573 6572 2d6c 6f67       "--user-log
-00044540: 696e 2069 7320 6f6e 6c79 2075 7365 6420  in is only used 
-00044550: 6279 202d 2d6c 6f67 696e 2061 6e64 2069  by --login and i
-00044560: 676e 6f72 6564 2062 7920 616c 6c20 6f74  gnored by all ot
-00044570: 6865 7220 220a 2020 2020 2020 2020 2261  her ".        "a
-00044580: 6374 696f 6e73 2e22 2c0a 2020 2020 290a  ctions.",.    ).
-00044590: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
-000445a0: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
-000445b0: 6e61 6d65 222c 0a20 2020 2020 2020 2072  name",.        r
-000445c0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-000445d0: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
-000445e0: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
-000445f0: 6e61 7267 733d 222b 222c 0a20 2020 2020  nargs="+",.     
-00044600: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-00044610: 2020 2020 206d 6574 6176 6172 3d22 524f       metavar="RO
-00044620: 4f4d 5f4e 414d 4522 2c0a 2020 2020 2020  OM_NAME",.      
-00044630: 2020 6865 6c70 3d22 5370 6563 6966 7920    help="Specify 
-00044640: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
-00044650: 726f 6f6d 206e 616d 6573 2e20 220a 2020  room names. ".  
-00044660: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-00044670: 2054 6869 7320 6f70 7469 6f6e 2069 7320   This option is 
-00044680: 6f6e 6c79 206d 6561 6e69 6e67 6675 6c20  only meaningful 
-00044690: 220a 2020 2020 2020 2020 2269 6e20 636f  ".        "in co
-000446a0: 6d62 696e 6174 696f 6e20 7769 7468 206f  mbination with o
-000446b0: 7074 696f 6e20 2d2d 726f 6f6d 2d63 7265  ption --room-cre
-000446c0: 6174 652e 2022 0a20 2020 2020 2020 2022  ate. ".        "
-000446d0: 5468 6973 206f 7074 696f 6e20 2d2d 6e61  This option --na
-000446e0: 6d65 2073 7065 6369 6669 6573 2074 6865  me specifies the
-000446f0: 206e 616d 6573 2022 0a20 2020 2020 2020   names ".       
-00044700: 2022 746f 2062 6520 7573 6564 2077 6974   "to be used wit
-00044710: 6820 7468 6520 636f 6d6d 616e 6420 2d2d  h the command --
-00044720: 726f 6f6d 2d63 7265 6174 652e 222c 0a20  room-create.",. 
-00044730: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-00044740: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00044750: 2020 222d 2d74 6f70 6963 222c 0a20 2020    "--topic",.   
-00044760: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00044770: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00044780: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-00044790: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-000447a0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-000447b0: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-000447c0: 6172 3d22 524f 4f4d 5f54 4f50 4943 222c  ar="ROOM_TOPIC",
-000447d0: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
-000447e0: 7065 6369 6679 206f 6e65 206f 7220 6d75  pecify one or mu
-000447f0: 6c74 6970 6c65 2072 6f6f 6d20 746f 7069  ltiple room topi
-00044800: 6373 2e20 220a 2020 2020 2020 2020 2244  cs. ".        "D
-00044810: 6574 6169 6c73 3a3a 2054 6869 7320 6f70  etails:: This op
-00044820: 7469 6f6e 2069 7320 6f6e 6c79 206d 6561  tion is only mea
-00044830: 6e69 6e67 6675 6c20 220a 2020 2020 2020  ningful ".      
-00044840: 2020 2269 6e20 636f 6d62 696e 6174 696f    "in combinatio
-00044850: 6e20 7769 7468 206f 7074 696f 6e20 2d2d  n with option --
-00044860: 726f 6f6d 2d63 7265 6174 652e 2022 0a20  room-create. ". 
-00044870: 2020 2020 2020 2022 5468 6973 206f 7074         "This opt
-00044880: 696f 6e20 2d2d 746f 7069 6320 7370 6563  ion --topic spec
-00044890: 6966 6965 7320 7468 6520 746f 7069 6373  ifies the topics
-000448a0: 2022 0a20 2020 2020 2020 2022 746f 2062   ".        "to b
-000448b0: 6520 7573 6564 2077 6974 6820 7468 6520  e used with the 
-000448c0: 636f 6d6d 616e 6420 2d2d 726f 6f6d 2d63  command --room-c
-000448d0: 7265 6174 652e 222c 0a20 2020 2029 0a20  reate.",.    ). 
-000448e0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-000448f0: 6e74 280a 2020 2020 2020 2020 222d 2d61  nt(.        "--a
-00044900: 6c69 6173 222c 0a20 2020 2020 2020 2072  lias",.        r
-00044910: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-00044920: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
-00044930: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
-00044940: 6e61 7267 733d 222b 222c 0a20 2020 2020  nargs="+",.     
-00044950: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-00044960: 2020 2020 206d 6574 6176 6172 3d22 524f       metavar="RO
-00044970: 4f4d 5f41 4c49 4153 222c 0a20 2020 2020  OM_ALIAS",.     
-00044980: 2020 2068 656c 703d 2253 7065 6369 6679     help="Specify
-00044990: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-000449a0: 2072 6f6f 6d20 616c 6961 7365 732e 2022   room aliases. "
-000449b0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-000449c0: 733a 3a20 5468 6973 206f 7074 696f 6e20  s:: This option 
-000449d0: 6973 206f 6e6c 7920 220a 2020 2020 2020  is only ".      
-000449e0: 2020 226d 6561 6e69 6e67 6675 6c20 696e    "meaningful in
-000449f0: 2063 6f6d 6269 6e61 7469 6f6e 2077 6974   combination wit
-00044a00: 6820 6f70 7469 6f6e 202d 2d72 6f6f 6d2d  h option --room-
-00044a10: 646d 2d63 7265 6174 652e 2022 0a20 2020  dm-create. ".   
-00044a20: 2020 2020 2022 5468 6973 206f 7074 696f       "This optio
-00044a30: 6e20 2d2d 616c 6961 7320 7370 6563 6966  n --alias specif
-00044a40: 6965 7320 7468 6520 616c 6961 7365 7320  ies the aliases 
-00044a50: 746f 2062 6520 7573 6564 2022 0a20 2020  to be used ".   
-00044a60: 2020 2020 2022 7769 7468 2074 6865 2063       "with the c
-00044a70: 6f6d 6d61 6e64 202d 2d72 6f6f 6d2d 646d  ommand --room-dm
-00044a80: 2d63 7265 6174 652e 222c 0a20 2020 2029  -create.",.    )
-00044a90: 0a20 2020 2023 2061 6c6c 6f77 206d 756c  .    # allow mul
-00044aa0: 7469 706c 6520 6d65 7373 6167 6573 202c  tiple messages ,
-00044ab0: 2065 2e67 2e20 2d6d 2022 6d31 2220 226d   e.g. -m "m1" "m
-00044ac0: 3222 206f 7220 2d6d 2022 6d31 2220 2d6d  2" or -m "m1" -m
-00044ad0: 2022 6d32 220a 2020 2020 2320 6d65 7373   "m2".    # mess
-00044ae0: 6167 6520 6973 2067 6f69 6e67 2074 6f20  age is going to 
-00044af0: 6265 2061 206c 6973 7420 6f66 2073 7472  be a list of str
-00044b00: 696e 6773 0a20 2020 2023 2065 2e67 2e20  ings.    # e.g. 
-00044b10: 6d65 7373 6167 653d 5b20 276d 3127 2c20  message=[ 'm1', 
-00044b20: 276d 3227 205d 0a20 2020 2061 702e 6164  'm2' ].    ap.ad
-00044b30: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-00044b40: 2020 2020 222d 6d22 2c0a 2020 2020 2020      "-m",.      
-00044b50: 2020 222d 2d6d 6573 7361 6765 222c 0a20    "--message",. 
-00044b60: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00044b70: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-00044b80: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
-00044b90: 2020 2020 2020 2020 6e61 7267 733d 222b          nargs="+
-00044ba0: 222c 0a20 2020 2020 2020 2074 7970 653d  ",.        type=
-00044bb0: 7374 722c 0a20 2020 2020 2020 206d 6574  str,.        met
-00044bc0: 6176 6172 3d22 5445 5854 222c 0a20 2020  avar="TEXT",.   
-00044bd0: 2020 2020 2068 656c 703d 2253 656e 6420       help="Send 
-00044be0: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
-00044bf0: 7465 7874 206d 6573 7361 6765 732e 2022  text messages. "
-00044c00: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-00044c10: 733a 3a20 4d65 7373 6167 6520 6461 7461  s:: Message data
-00044c20: 206d 7573 7420 6e6f 7420 6265 2062 696e   must not be bin
-00044c30: 6172 7920 6461 7461 2c20 6974 2022 0a20  ary data, it ". 
-00044c40: 2020 2020 2020 2022 6d75 7374 2062 6520         "must be 
-00044c50: 7465 7874 2e20 4966 206e 6f20 272d 6d27  text. If no '-m'
-00044c60: 2069 7320 7573 6564 2061 6e64 206e 6f20   is used and no 
-00044c70: 6f74 6865 7220 636f 6e66 6c69 6374 696e  other conflictin
-00044c80: 6720 220a 2020 2020 2020 2020 2261 7267  g ".        "arg
-00044c90: 756d 656e 7473 2061 7265 2070 726f 7669  uments are provi
-00044ca0: 6465 642c 2061 6e64 2069 6e66 6f72 6d61  ded, and informa
-00044cb0: 7469 6f6e 2069 7320 7069 7065 6420 696e  tion is piped in
-00044cc0: 746f 2074 6865 2070 726f 6772 616d 2c20  to the program, 
-00044cd0: 220a 2020 2020 2020 2020 2274 6865 6e20  ".        "then 
-00044ce0: 7468 6520 7069 7065 6420 6461 7461 2077  the piped data w
-00044cf0: 696c 6c20 6265 2075 7365 6420 6173 206d  ill be used as m
-00044d00: 6573 7361 6765 2e20 220a 2020 2020 2020  essage. ".      
-00044d10: 2020 2246 696e 616c 6c79 2c20 6966 2074    "Finally, if t
-00044d20: 6865 7265 2061 7265 206e 6f20 6f70 6572  here are no oper
-00044d30: 6174 696f 6e73 2061 7420 616c 6c20 696e  ations at all in
-00044d40: 2074 6865 2061 7267 756d 656e 7473 2c20   the arguments, 
-00044d50: 7468 656e 2022 0a20 2020 2020 2020 2022  then ".        "
-00044d60: 6120 6d65 7373 6167 6520 7769 6c6c 2062  a message will b
-00044d70: 6520 7265 6164 2066 726f 6d20 7374 6469  e read from stdi
-00044d80: 6e2c 2069 2e65 2e20 6672 6f6d 2074 6865  n, i.e. from the
-00044d90: 206b 6579 626f 6172 642e 2022 0a20 2020   keyboard. ".   
-00044da0: 2020 2020 2022 5468 6973 206f 7074 696f       "This optio
-00044db0: 6e20 6361 6e20 6265 2075 7365 6420 6d75  n can be used mu
-00044dc0: 6c74 6970 6c65 2074 696d 6573 2074 6f20  ltiple times to 
-00044dd0: 7365 6e64 2022 0a20 2020 2020 2020 2022  send ".        "
-00044de0: 6d75 6c74 6970 6c65 206d 6573 7361 6765  multiple message
-00044df0: 732e 2049 6620 7468 6572 6520 6973 2064  s. If there is d
-00044e00: 6174 6120 7069 7065 6420 220a 2020 2020  ata piped ".    
-00044e10: 2020 2020 2269 6e74 6f20 7468 6973 2070      "into this p
-00044e20: 726f 6772 616d 2c20 7468 656e 2066 6972  rogram, then fir
-00044e30: 7374 2064 6174 6120 6672 6f6d 2074 6865  st data from the
-00044e40: 2022 0a20 2020 2020 2020 2022 7069 7065   ".        "pipe
-00044e50: 2069 7320 7075 626c 6973 6865 642c 2074   is published, t
-00044e60: 6865 6e20 6d65 7373 6167 6573 2066 726f  hen messages fro
-00044e70: 6d20 7468 6973 2022 0a20 2020 2020 2020  m this ".       
-00044e80: 2022 6f70 7469 6f6e 2061 7265 2070 7562   "option are pub
-00044e90: 6c69 7368 6564 2e20 4d65 7373 6167 6573  lished. Messages
-00044ea0: 2077 696c 6c20 6265 2073 656e 7420 6c61   will be sent la
-00044eb0: 7374 2c20 220a 2020 2020 2020 2020 2269  st, ".        "i
-00044ec0: 2e65 2e20 6166 7465 7220 6f62 6a65 6374  .e. after object
-00044ed0: 7320 6c69 6b65 2069 6d61 6765 732c 2061  s like images, a
-00044ee0: 7564 696f 2c20 6669 6c65 732c 2065 7665  udio, files, eve
-00044ef0: 6e74 732c 2065 7463 2e20 220a 2020 2020  nts, etc. ".    
-00044f00: 2020 2020 2249 6e70 7574 2070 6970 6564      "Input piped
-00044f10: 2076 6961 2073 7464 696e 2063 616e 2061   via stdin can a
-00044f20: 6464 6974 696f 6e61 6c6c 7920 6265 2073  dditionally be s
-00044f30: 7065 6369 6669 6564 2077 6974 6820 7468  pecified with th
-00044f40: 6520 220a 2020 2020 2020 2020 2273 7065  e ".        "spe
-00044f50: 6369 616c 2063 6861 7261 6374 6572 2027  cial character '
-00044f60: 2d27 2e20 220a 2020 2020 2020 2020 6622  -'. ".        f"
-00044f70: 4966 2079 6f75 2077 616e 7420 746f 2066  If you want to f
-00044f80: 6565 6420 6120 7465 7874 206d 6573 7361  eed a text messa
-00044f90: 6765 2069 6e74 6f20 7b50 524f 475f 5749  ge into {PROG_WI
-00044fa0: 5448 4f55 545f 4558 547d 2022 0a20 2020  THOUT_EXT} ".   
-00044fb0: 2020 2020 2022 7669 6120 6120 7069 7065       "via a pipe
-00044fc0: 2c20 7669 6120 7374 6469 6e2c 2074 6865  , via stdin, the
-00044fd0: 6e20 7370 6563 6966 7920 7468 6520 7370  n specify the sp
-00044fe0: 6563 6961 6c20 220a 2020 2020 2020 2020  ecial ".        
-00044ff0: 2263 6861 7261 6374 6572 2027 2d27 2e20  "character '-'. 
-00045000: 4966 2027 2d27 2069 7320 7370 6563 6966  If '-' is specif
-00045010: 6965 6420 6173 206d 6573 7361 6765 2c20  ied as message, 
-00045020: 220a 2020 2020 2020 2020 2274 6865 6e20  ".        "then 
-00045030: 7468 6520 7072 6f67 7261 6d20 7769 6c6c  the program will
-00045040: 2072 6561 6420 7468 6520 6d65 7373 6167   read the messag
-00045050: 6520 6672 6f6d 2073 7464 696e 2e20 220a  e from stdin. ".
-00045060: 2020 2020 2020 2020 2257 6974 6820 272d          "With '-
-00045070: 2720 7468 6520 7768 6f6c 6520 6d65 7373  ' the whole mess
-00045080: 6167 652c 2061 6c6c 206c 696e 6573 2c20  age, all lines, 
-00045090: 7769 6c6c 2062 6520 636f 6e73 6964 6572  will be consider
-000450a0: 6564 2022 0a20 2020 2020 2020 2022 6120  ed ".        "a 
-000450b0: 7369 6e67 6c65 206d 6573 7361 6765 2061  single message a
-000450c0: 6e64 2073 656e 7420 6173 206f 6e65 206d  nd sent as one m
-000450d0: 6573 7361 6765 2e20 220a 2020 2020 2020  essage. ".      
-000450e0: 2020 2249 6620 796f 7572 206d 6573 7361    "If your messa
-000450f0: 6765 2069 7320 6c69 7465 7261 6c6c 7920  ge is literally 
-00045100: 272d 2720 7468 656e 2075 7365 2027 5c5c  '-' then use '\\
-00045110: 2d27 2022 0a20 2020 2020 2020 2022 6173  -' ".        "as
-00045120: 206d 6573 7361 6765 2069 6e20 7468 6520   message in the 
-00045130: 6172 6775 6d65 6e74 2e20 220a 2020 2020  argument. ".    
-00045140: 2020 2020 2227 2d27 206d 6179 2061 7070      "'-' may app
-00045150: 6561 7220 696e 2061 6e79 2070 6f73 6974  ear in any posit
-00045160: 696f 6e2c 2069 2e65 2e20 272d 6d20 5c22  ion, i.e. '-m \"
-00045170: 7374 6172 745c 2220 2d20 5c22 656e 645c  start\" - \"end\
-00045180: 2227 2022 0a20 2020 2020 2020 2022 7769  "' ".        "wi
-00045190: 6c6c 2073 656e 6420 3320 6d65 7373 6167  ll send 3 messag
-000451a0: 6573 206f 7574 206f 6620 7768 6963 6820  es out of which 
-000451b0: 7468 6520 7365 636f 6e64 206f 6e65 2069  the second one i
-000451c0: 7320 7265 6164 2066 726f 6d20 7374 6469  s read from stdi
-000451d0: 6e2e 2022 0a20 2020 2020 2020 2022 272d  n. ".        "'-
-000451e0: 2720 6d61 7920 6170 7065 6172 206f 6e6c  ' may appear onl
-000451f0: 7920 6f6e 6365 206f 7665 7261 6c6c 2069  y once overall i
-00045200: 6e20 616c 6c20 6172 6775 6d65 6e74 732e  n all arguments.
-00045210: 2022 0a20 2020 2020 2020 2022 5369 6d69   ".        "Simi
-00045220: 6c61 7220 746f 2027 2d27 2c20 616e 6f74  lar to '-', anot
-00045230: 6865 7220 7368 6f72 7463 7574 2063 6861  her shortcut cha
-00045240: 7261 6374 6572 2069 7320 275f 272e 2054  racter is '_'. T
-00045250: 6865 2022 0a20 2020 2020 2020 2022 7370  he ".        "sp
-00045260: 6563 6961 6c20 6368 6172 6163 7465 7220  ecial character 
-00045270: 275f 2720 6973 2075 7365 6420 666f 7220  '_' is used for 
-00045280: 7374 7265 616d 696e 6720 6461 7461 2076  streaming data v
-00045290: 6961 2022 0a20 2020 2020 2020 2022 6120  ia ".        "a 
-000452a0: 7069 7065 206f 6e20 7374 6469 6e2e 2057  pipe on stdin. W
-000452b0: 6974 6820 275f 2720 7468 6520 7374 6469  ith '_' the stdi
-000452c0: 6e20 7069 7065 2069 7320 7265 6164 206c  n pipe is read l
-000452d0: 696e 652d 6279 2d6c 696e 6520 220a 2020  ine-by-line ".  
-000452e0: 2020 2020 2020 2261 6e64 2065 6163 6820        "and each 
-000452f0: 6c69 6e65 2069 7320 7472 6561 7465 6420  line is treated 
-00045300: 6173 2061 2073 6570 6172 6174 6520 6d65  as a separate me
-00045310: 7373 6167 6520 616e 6420 7365 6e74 2072  ssage and sent r
-00045320: 6967 6874 2022 0a20 2020 2020 2020 2022  ight ".        "
-00045330: 6177 6179 2e20 5468 6520 7072 6f67 7261  away. The progra
-00045340: 6d20 7761 6974 7320 666f 7220 7069 7065  m waits for pipe
-00045350: 2069 6e70 7574 2075 6e74 696c 2074 6865   input until the
-00045360: 2070 6970 6520 6973 2022 0a20 2020 2020   pipe is ".     
-00045370: 2020 2022 636c 6f73 6564 2e20 452e 672e     "closed. E.g.
-00045380: 2049 6d61 6769 6e65 2061 2074 6f6f 6c20   Imagine a tool 
-00045390: 7468 6174 2067 656e 6572 6174 6573 206f  that generates o
-000453a0: 7574 7075 7420 7370 6f72 6164 6963 616c  utput sporadical
-000453b0: 6c79 2022 0a20 2020 2020 2020 2066 2232  ly ".        f"2
-000453c0: 3478 372e 2049 7420 6361 6e20 6265 2070  4x7. It can be p
-000453d0: 6970 6564 2c20 692e 652e 2073 7472 6561  iped, i.e. strea
-000453e0: 6d65 642c 2069 6e74 6f20 7b50 524f 475f  med, into {PROG_
-000453f0: 5749 5448 4f55 545f 4558 547d 2c20 616e  WITHOUT_EXT}, an
-00045400: 6420 220a 2020 2020 2020 2020 6622 7b50  d ".        f"{P
-00045410: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
-00045420: 2073 7461 7973 2061 6374 6976 652c 2073   stays active, s
-00045430: 656e 6469 6e67 2061 6c6c 2069 6e70 7574  ending all input
-00045440: 2069 6e73 7461 6e74 6c79 2e20 220a 2020   instantly. ".  
-00045450: 2020 2020 2020 2249 6620 796f 7520 7761        "If you wa
-00045460: 6e74 2074 6f20 7365 6e64 2074 6865 206c  nt to send the l
-00045470: 6974 6572 616c 206c 6574 7465 7220 275f  iteral letter '_
-00045480: 2720 7468 656e 2065 7363 6170 6520 6974  ' then escape it
-00045490: 2022 0a20 2020 2020 2020 2022 616e 6420   ".        "and 
-000454a0: 7365 6e64 2027 5c5c 5f27 2e20 220a 2020  send '\\_'. ".  
-000454b0: 2020 2020 2020 2227 5f27 2063 616e 2062        "'_' can b
-000454c0: 6520 7573 6564 206f 6e6c 7920 6f6e 6365  e used only once
-000454d0: 2e20 416e 6420 6569 7468 6572 2027 2d27  . And either '-'
-000454e0: 206f 7220 275f 2720 6361 6e20 6265 2075   or '_' can be u
-000454f0: 7365 642e 2022 2c0a 2020 2020 290a 2020  sed. ",.    ).  
-00045500: 2020 2320 616c 6c6f 7720 6d75 6c74 6970    # allow multip
-00045510: 6c65 206d 6573 7361 6765 7320 2c20 652e  le messages , e.
-00045520: 672e 202d 6920 2269 312e 6a70 6722 2022  g. -i "i1.jpg" "
-00045530: 6932 2e67 6966 220a 2020 2020 2320 6f72  i2.gif".    # or
-00045540: 202d 6920 2269 312e 706e 6722 202d 6920   -i "i1.png" -i 
-00045550: 2269 322e 6a70 6567 220a 2020 2020 2320  "i2.jpeg".    # 
-00045560: 696d 6167 6520 6973 2067 6f69 6e67 2074  image is going t
-00045570: 6f20 6265 2061 206c 6973 7420 6f66 2073  o be a list of s
-00045580: 7472 696e 6773 0a20 2020 2023 2065 2e67  trings.    # e.g
-00045590: 2e20 696d 6167 653d 5b20 2769 312e 6a70  . image=[ 'i1.jp
-000455a0: 6727 2c20 2769 322e 706e 6727 205d 0a20  g', 'i2.png' ]. 
-000455b0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-000455c0: 6e74 280a 2020 2020 2020 2020 222d 6922  nt(.        "-i"
-000455d0: 2c0a 2020 2020 2020 2020 222d 2d69 6d61  ,.        "--ima
-000455e0: 6765 222c 0a20 2020 2020 2020 2072 6571  ge",.        req
-000455f0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00045600: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-00045610: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-00045620: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-00045630: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-00045640: 2020 206d 6574 6176 6172 3d22 494d 4147     metavar="IMAG
-00045650: 455f 4649 4c45 222c 0a20 2020 2020 2020  E_FILE",.       
-00045660: 2068 656c 703d 2253 656e 6420 6f6e 6520   help="Send one 
-00045670: 6f72 206d 756c 7469 706c 6520 696d 6167  or multiple imag
-00045680: 6520 6669 6c65 732e 2022 0a20 2020 2020  e files. ".     
-00045690: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
-000456a0: 6973 206f 7074 696f 6e20 6361 6e20 6265  is option can be
-000456b0: 2075 7365 6420 6d75 6c74 6970 6c65 2074   used multiple t
-000456c0: 696d 6573 2074 6f20 7365 6e64 2022 0a20  imes to send ". 
-000456d0: 2020 2020 2020 2022 6d75 6c74 6970 6c65         "multiple
-000456e0: 2069 6d61 6765 732e 2046 6972 7374 2069   images. First i
-000456f0: 6d61 6765 7320 6172 6520 7365 6e74 2c20  mages are sent, 
-00045700: 220a 2020 2020 2020 2020 2274 6865 6e20  ".        "then 
-00045710: 7465 7874 206d 6573 7361 6765 7320 6172  text messages ar
-00045720: 6520 7365 6e74 2e20 220a 2020 2020 2020  e sent. ".      
-00045730: 2020 6622 4966 2079 6f75 2077 616e 7420    f"If you want 
-00045740: 746f 2066 6565 6420 616e 2069 6d61 6765  to feed an image
-00045750: 2069 6e74 6f20 7b50 524f 475f 5749 5448   into {PROG_WITH
-00045760: 4f55 545f 4558 547d 2022 0a20 2020 2020  OUT_EXT} ".     
-00045770: 2020 2022 7669 6120 6120 7069 7065 2c20     "via a pipe, 
-00045780: 7669 6120 7374 6469 6e2c 2074 6865 6e20  via stdin, then 
-00045790: 7370 6563 6966 7920 7468 6520 7370 6563  specify the spec
-000457a0: 6961 6c20 220a 2020 2020 2020 2020 2263  ial ".        "c
-000457b0: 6861 7261 6374 6572 2027 2d27 2e20 4966  haracter '-'. If
-000457c0: 2027 2d27 2069 7320 7370 6563 6966 6965   '-' is specifie
-000457d0: 6420 6173 2069 6d61 6765 2066 696c 6520  d as image file 
-000457e0: 6e61 6d65 2c20 220a 2020 2020 2020 2020  name, ".        
-000457f0: 2274 6865 6e20 7468 6520 7072 6f67 7261  "then the progra
-00045800: 6d20 7769 6c6c 2072 6561 6420 7468 6520  m will read the 
-00045810: 696d 6167 6520 6461 7461 2066 726f 6d20  image data from 
-00045820: 7374 6469 6e2e 2022 0a20 2020 2020 2020  stdin. ".       
-00045830: 2022 4966 2079 6f75 7220 696d 6167 6520   "If your image 
-00045840: 6669 6c65 2069 7320 6c69 7465 7261 6c6c  file is literall
-00045850: 7920 6e61 6d65 6420 272d 2720 7468 656e  y named '-' then
-00045860: 2075 7365 2027 5c5c 2d27 2022 0a20 2020   use '\\-' ".   
-00045870: 2020 2020 2022 6173 2066 696c 6520 6e61       "as file na
-00045880: 6d65 2069 6e20 7468 6520 6172 6775 6d65  me in the argume
-00045890: 6e74 2e20 220a 2020 2020 2020 2020 2227  nt. ".        "'
-000458a0: 2d27 206d 6179 2061 7070 6561 7220 696e  -' may appear in
-000458b0: 2061 6e79 2070 6f73 6974 696f 6e2c 2069   any position, i
-000458c0: 2e65 2e20 272d 6920 696d 6167 6531 2e6a  .e. '-i image1.j
-000458d0: 7067 202d 2069 6d61 6765 332e 706e 6727  pg - image3.png'
-000458e0: 2022 0a20 2020 2020 2020 2022 7769 6c6c   ".        "will
-000458f0: 2073 656e 6420 3320 696d 6167 6573 206f   send 3 images o
-00045900: 7574 206f 6620 7768 6963 6820 7468 6520  ut of which the 
-00045910: 7365 636f 6e64 206f 6e65 2069 7320 7265  second one is re
-00045920: 6164 2066 726f 6d20 7374 6469 6e2e 2022  ad from stdin. "
-00045930: 0a20 2020 2020 2020 2022 272d 2720 6d61  .        "'-' ma
-00045940: 7920 6170 7065 6172 206f 6e6c 7920 6f6e  y appear only on
-00045950: 6365 206f 7665 7261 6c6c 2069 6e20 616c  ce overall in al
-00045960: 6c20 6172 6775 6d65 6e74 732e 2022 0a20  l arguments. ". 
-00045970: 2020 2020 2020 2022 4966 2074 6865 2066         "If the f
-00045980: 696c 6520 6578 6973 7473 2061 6c72 6561  ile exists alrea
-00045990: 6479 2c20 6974 2069 7320 6d6f 7265 2065  dy, it is more e
-000459a0: 6666 6963 6965 6e74 2074 6f20 7370 6563  fficient to spec
-000459b0: 6966 7920 7468 6520 220a 2020 2020 2020  ify the ".      
-000459c0: 2020 2266 696c 6520 6e61 6d65 2074 6861    "file name tha
-000459d0: 6e20 746f 2070 6970 6520 7468 6520 6669  n to pipe the fi
-000459e0: 6c65 2074 6872 6f75 6768 2073 7464 696e  le through stdin
-000459f0: 2e22 2c0a 2020 2020 290a 2020 2020 2320  .",.    ).    # 
-00045a00: 616c 6c6f 7720 6d75 6c74 6970 6c65 2061  allow multiple a
-00045a10: 7564 696f 2066 696c 6573 202c 2065 2e67  udio files , e.g
-00045a20: 2e20 2d69 2022 6131 2e6d 7033 2220 2261  . -i "a1.mp3" "a
-00045a30: 322e 7761 7622 0a20 2020 2023 206f 7220  2.wav".    # or 
-00045a40: 2d69 2022 6131 2e6d 7033 2220 2d69 2022  -i "a1.mp3" -i "
-00045a50: 6132 2e6d 3461 220a 2020 2020 2320 6175  a2.m4a".    # au
-00045a60: 6469 6f20 6973 2067 6f69 6e67 2074 6f20  dio is going to 
-00045a70: 6265 2061 206c 6973 7420 6f66 2073 7472  be a list of str
-00045a80: 696e 6773 0a20 2020 2023 2065 2e67 2e20  ings.    # e.g. 
-00045a90: 6175 6469 6f3d 5b20 2761 312e 6d70 3327  audio=[ 'a1.mp3'
-00045aa0: 2c20 2761 322e 6d34 6127 205d 0a20 2020  , 'a2.m4a' ].   
-00045ab0: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00045ac0: 280a 2020 2020 2020 2020 222d 6122 2c0a  (.        "-a",.
-00045ad0: 2020 2020 2020 2020 222d 2d61 7564 696f          "--audio
-00045ae0: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-00045af0: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-00045b00: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
-00045b10: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
-00045b20: 733d 222b 222c 0a20 2020 2020 2020 2074  s="+",.        t
-00045b30: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-00045b40: 206d 6574 6176 6172 3d22 4155 4449 4f5f   metavar="AUDIO_
-00045b50: 4649 4c45 222c 0a20 2020 2020 2020 2068  FILE",.        h
-00045b60: 656c 703d 2253 656e 6420 6f6e 6520 6f72  elp="Send one or
-00045b70: 206d 756c 7469 706c 6520 6175 6469 6f20   multiple audio 
-00045b80: 6669 6c65 732e 2022 0a20 2020 2020 2020  files. ".       
-00045b90: 2022 4465 7461 696c 733a 3a20 5468 6973   "Details:: This
-00045ba0: 206f 7074 696f 6e20 6361 6e20 6265 2075   option can be u
-00045bb0: 7365 6420 6d75 6c74 6970 6c65 2074 696d  sed multiple tim
-00045bc0: 6573 2074 6f20 7365 6e64 2022 0a20 2020  es to send ".   
-00045bd0: 2020 2020 2022 6d75 6c74 6970 6c65 2061       "multiple a
-00045be0: 7564 696f 2066 696c 6573 2e20 4669 7273  udio files. Firs
-00045bf0: 7420 6175 6469 6f73 2061 7265 2073 656e  t audios are sen
-00045c00: 742c 2022 0a20 2020 2020 2020 2022 7468  t, ".        "th
-00045c10: 656e 2074 6578 7420 6d65 7373 6167 6573  en text messages
-00045c20: 2061 7265 2073 656e 742e 2022 0a20 2020   are sent. ".   
-00045c30: 2020 2020 2066 2249 6620 796f 7520 7761       f"If you wa
-00045c40: 6e74 2074 6f20 6665 6564 2061 6e20 6175  nt to feed an au
-00045c50: 6469 6f20 696e 746f 207b 5052 4f47 5f57  dio into {PROG_W
-00045c60: 4954 484f 5554 5f45 5854 7d20 220a 2020  ITHOUT_EXT} ".  
-00045c70: 2020 2020 2020 2276 6961 2061 2070 6970        "via a pip
-00045c80: 652c 2076 6961 2073 7464 696e 2c20 7468  e, via stdin, th
-00045c90: 656e 2073 7065 6369 6679 2074 6865 2073  en specify the s
-00045ca0: 7065 6369 616c 2022 0a20 2020 2020 2020  pecial ".       
-00045cb0: 2022 6368 6172 6163 7465 7220 272d 272e   "character '-'.
-00045cc0: 2053 6565 2064 6573 6372 6970 7469 6f6e   See description
-00045cd0: 206f 6620 272d 6927 2074 6f20 7365 6520   of '-i' to see 
-00045ce0: 686f 7720 272d 2720 6973 2068 616e 646c  how '-' is handl
-00045cf0: 6564 2e22 2c0a 2020 2020 290a 2020 2020  ed.",.    ).    
-00045d00: 2320 616c 6c6f 7720 6d75 6c74 6970 6c65  # allow multiple
-00045d10: 2066 696c 6573 202c 2065 2e67 2e20 2d66   files , e.g. -f
-00045d20: 2022 6131 2e70 6466 2220 2261 322e 646f   "a1.pdf" "a2.do
-00045d30: 6322 0a20 2020 2023 206f 7220 2d66 2022  c".    # or -f "
-00045d40: 6131 2e70 6466 2220 2d66 2022 6132 2e64  a1.pdf" -f "a2.d
-00045d50: 6f63 220a 2020 2020 2320 6669 6c65 2069  oc".    # file i
-00045d60: 7320 676f 696e 6720 746f 2062 6520 6120  s going to be a 
-00045d70: 6c69 7374 206f 6620 7374 7269 6e67 730a  list of strings.
-00045d80: 2020 2020 2320 652e 672e 2066 696c 653d      # e.g. file=
-00045d90: 5b20 2761 312e 7064 6627 2c20 2761 322e  [ 'a1.pdf', 'a2.
-00045da0: 646f 6327 205d 0a20 2020 2061 702e 6164  doc' ].    ap.ad
-00045db0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-00045dc0: 2020 2020 222d 6622 2c0a 2020 2020 2020      "-f",.      
-00045dd0: 2020 222d 2d66 696c 6522 2c0a 2020 2020    "--file",.    
-00045de0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-00045df0: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
-00045e00: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
-00045e10: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
-00045e20: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-00045e30: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
-00045e40: 723d 2246 494c 4522 2c0a 2020 2020 2020  r="FILE",.      
-00045e50: 2020 6865 6c70 3d22 5365 6e64 206f 6e65    help="Send one
-00045e60: 206f 7220 6d75 6c74 6970 6c65 2066 696c   or multiple fil
-00045e70: 6573 2028 652e 672e 2050 4446 2c20 444f  es (e.g. PDF, DO
-00045e80: 432c 204d 5034 292e 2022 0a20 2020 2020  C, MP4). ".     
-00045e90: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
-00045ea0: 6973 206f 7074 696f 6e20 6361 6e20 6265  is option can be
-00045eb0: 2075 7365 6420 6d75 6c74 6970 6c65 2074   used multiple t
-00045ec0: 696d 6573 2074 6f20 7365 6e64 2022 0a20  imes to send ". 
-00045ed0: 2020 2020 2020 2022 6d75 6c74 6970 6c65         "multiple
-00045ee0: 2066 696c 6573 2e20 4669 7273 7420 6669   files. First fi
-00045ef0: 6c65 7320 6172 6520 7365 6e74 2c20 220a  les are sent, ".
-00045f00: 2020 2020 2020 2020 2274 6865 6e20 7465          "then te
-00045f10: 7874 206d 6573 7361 6765 7320 6172 6520  xt messages are 
-00045f20: 7365 6e74 2e20 220a 2020 2020 2020 2020  sent. ".        
-00045f30: 6622 4966 2079 6f75 2077 616e 7420 746f  f"If you want to
-00045f40: 2066 6565 6420 6120 6669 6c65 2069 6e74   feed a file int
-00045f50: 6f20 7b50 524f 475f 5749 5448 4f55 545f  o {PROG_WITHOUT_
-00045f60: 4558 547d 2022 0a20 2020 2020 2020 2022  EXT} ".        "
-00045f70: 7669 6120 6120 7069 7065 2c20 7669 6120  via a pipe, via 
-00045f80: 7374 6469 6e2c 2074 6865 6e20 7370 6563  stdin, then spec
-00045f90: 6966 7920 7468 6520 7370 6563 6961 6c20  ify the special 
-00045fa0: 220a 2020 2020 2020 2020 2263 6861 7261  ".        "chara
-00045fb0: 6374 6572 2027 2d27 2e20 5365 6520 6465  cter '-'. See de
-00045fc0: 7363 7269 7074 696f 6e20 6f66 2027 2d69  scription of '-i
-00045fd0: 2720 746f 2073 6565 2068 6f77 2027 2d27  ' to see how '-'
-00045fe0: 2069 7320 6861 6e64 6c65 642e 222c 0a20   is handled.",. 
-00045ff0: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-00046000: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00046010: 2020 222d 6522 2c0a 2020 2020 2020 2020    "-e",.        
-00046020: 222d 2d65 7665 6e74 222c 0a20 2020 2020  "--event",.     
-00046030: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-00046040: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-00046050: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
-00046060: 2020 2020 6e61 7267 733d 222b 222c 0a20      nargs="+",. 
-00046070: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
-00046080: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
-00046090: 3d22 4d41 5452 4958 5f4a 534f 4e5f 4f42  ="MATRIX_JSON_OB
-000460a0: 4a45 4354 222c 0a20 2020 2020 2020 2068  JECT",.        h
-000460b0: 656c 703d 2253 656e 6420 6120 4d61 7472  elp="Send a Matr
-000460c0: 6978 204a 534f 4e20 6576 656e 742e 2022  ix JSON event. "
-000460d0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-000460e0: 733a 3a20 5365 6e64 2061 6e20 6576 656e  s:: Send an even
-000460f0: 7420 7468 6174 2069 7320 666f 726d 6174  t that is format
-00046100: 7465 6420 6173 2061 204a 534f 4e20 6f62  ted as a JSON ob
-00046110: 6a65 6374 2061 7320 220a 2020 2020 2020  ject as ".      
-00046120: 2020 2273 7065 6369 6669 6564 2062 7920    "specified by 
-00046130: 7468 6520 4d61 7472 6978 2070 726f 746f  the Matrix proto
-00046140: 636f 6c2e 2054 6869 7320 616c 6c6f 7773  col. This allows
-00046150: 2074 6865 2061 6476 616e 6365 6420 220a   the advanced ".
-00046160: 2020 2020 2020 2020 2275 7365 7220 746f          "user to
-00046170: 2073 656e 6420 6164 6469 7469 6f6e 616c   send additional
-00046180: 2074 7970 6573 206f 6620 6576 656e 7473   types of events
-00046190: 2073 7563 6820 6173 2072 6561 6374 696f   such as reactio
-000461a0: 6e73 2c20 220a 2020 2020 2020 2020 2273  ns, ".        "s
-000461b0: 656e 6420 7265 706c 6965 7320 746f 2070  end replies to p
-000461c0: 7265 7669 6f75 7320 6576 656e 7473 2c20  revious events, 
-000461d0: 6f72 2065 6469 7420 7072 6576 696f 7573  or edit previous
-000461e0: 206d 6573 7361 6765 732e 2022 0a20 2020   messages. ".   
-000461f0: 2020 2020 2022 5370 6563 6966 6963 6174       "Specificat
-00046200: 696f 6e73 2066 6f72 2065 7665 6e74 7320  ions for events 
-00046210: 6361 6e20 6265 2066 6f75 6e64 2022 0a20  can be found ". 
-00046220: 2020 2020 2020 2022 6174 2068 7474 7073         "at https
-00046230: 3a2f 2f73 7065 632e 6d61 7472 6978 2e6f  ://spec.matrix.o
-00046240: 7267 2f75 6e73 7461 626c 652f 7072 6f70  rg/unstable/prop
-00046250: 6f73 616c 732f 2e20 220a 2020 2020 2020  osals/. ".      
-00046260: 2020 2254 6869 7320 6f70 7469 6f6e 2063    "This option c
-00046270: 616e 2062 6520 7573 6564 206d 756c 7469  an be used multi
-00046280: 706c 6520 7469 6d65 7320 746f 2073 656e  ple times to sen
-00046290: 6420 220a 2020 2020 2020 2020 226d 756c  d ".        "mul
-000462a0: 7469 706c 6520 6576 656e 7473 2e20 4669  tiple events. Fi
-000462b0: 7273 7420 6576 656e 7473 2061 7265 2073  rst events are s
-000462c0: 656e 742c 2022 0a20 2020 2020 2020 2022  ent, ".        "
-000462d0: 7468 656e 2074 6578 7420 6d65 7373 6167  then text messag
-000462e0: 6573 2061 7265 2073 656e 742e 2022 0a20  es are sent. ". 
-000462f0: 2020 2020 2020 2066 2249 6620 796f 7520         f"If you 
-00046300: 7761 6e74 2074 6f20 6665 6564 2061 6e20  want to feed an 
-00046310: 6576 656e 7420 696e 746f 207b 5052 4f47  event into {PROG
-00046320: 5f57 4954 484f 5554 5f45 5854 7d20 220a  _WITHOUT_EXT} ".
-00046330: 2020 2020 2020 2020 2276 6961 2061 2070          "via a p
-00046340: 6970 652c 2076 6961 2073 7464 696e 2c20  ipe, via stdin, 
-00046350: 7468 656e 2073 7065 6369 6679 2074 6865  then specify the
-00046360: 2073 7065 6369 616c 2022 0a20 2020 2020   special ".     
-00046370: 2020 2022 6368 6172 6163 7465 7220 272d     "character '-
-00046380: 272e 2053 6565 2064 6573 6372 6970 7469  '. See descripti
-00046390: 6f6e 206f 6620 272d 6927 2074 6f20 7365  on of '-i' to se
-000463a0: 6520 686f 7720 272d 2720 6973 2068 616e  e how '-' is han
-000463b0: 646c 6564 2e20 220a 2020 2020 2020 2020  dled. ".        
-000463c0: 2253 6565 2074 6573 7473 2f74 6573 742d  "See tests/test-
-000463d0: 6576 656e 742e 7368 2066 6f72 2065 7861  event.sh for exa
-000463e0: 6d70 6c65 732e 222c 0a20 2020 2029 0a20  mples.",.    ). 
-000463f0: 2020 2023 202d 6820 616c 7265 6164 7920     # -h already 
-00046400: 7573 6564 2066 6f72 202d 2d68 656c 702c  used for --help,
-00046410: 202d 7720 666f 7220 2277 6562 220a 2020   -w for "web".  
-00046420: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-00046430: 7428 0a20 2020 2020 2020 2022 2d77 222c  t(.        "-w",
-00046440: 0a20 2020 2020 2020 2022 2d2d 6874 6d6c  .        "--html
-00046450: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-00046460: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-00046470: 2020 2061 6374 696f 6e3d 2273 746f 7265     action="store
-00046480: 5f74 7275 6522 2c0a 2020 2020 2020 2020  _true",.        
-00046490: 6865 6c70 3d27 5365 6e64 206d 6573 7361  help='Send messa
-000464a0: 6765 2061 7320 666f 726d 6174 2022 4854  ge as format "HT
-000464b0: 4d4c 222e 2027 0a20 2020 2020 2020 2022  ML". '.        "
-000464c0: 4465 7461 696c 733a 3a20 4966 206e 6f74  Details:: If not
-000464d0: 2073 7065 6369 6669 6564 2c20 6d65 7373   specified, mess
-000464e0: 6167 6520 7769 6c6c 2062 6520 7365 6e74  age will be sent
-000464f0: 2022 0a20 2020 2020 2020 2027 6173 2066   ".        'as f
-00046500: 6f72 6d61 7420 2254 4558 5422 2e20 452e  ormat "TEXT". E.
-00046510: 672e 2074 6861 7420 616c 6c6f 7773 2073  g. that allows s
-00046520: 6f6d 6520 7465 7874 2027 0a20 2020 2020  ome text '.     
-00046530: 2020 2022 746f 2062 6520 626f 6c64 2c20     "to be bold, 
-00046540: 6574 632e 204f 6e6c 7920 6120 7375 6273  etc. Only a subs
-00046550: 6574 206f 6620 4854 4d4c 2074 6167 7320  et of HTML tags 
-00046560: 6172 6520 220a 2020 2020 2020 2020 2261  are ".        "a
-00046570: 6363 6570 7465 6420 6279 204d 6174 7269  ccepted by Matri
-00046580: 782e 222c 0a20 2020 2029 0a20 2020 2023  x.",.    ).    #
-00046590: 202d 6d20 616c 7265 6164 7920 7573 6564   -m already used
-000465a0: 2066 6f72 202d 2d6d 6573 7361 6765 2c20   for --message, 
-000465b0: 2d7a 2062 6563 6175 7365 2074 6865 7265  -z because there
-000465c0: 2077 6572 6520 6e6f 206c 6574 7465 7273   were no letters
-000465d0: 206c 6566 740a 2020 2020 6170 2e61 6464   left.    ap.add
-000465e0: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-000465f0: 2020 2022 2d7a 222c 0a20 2020 2020 2020     "-z",.       
-00046600: 2022 2d2d 6d61 726b 646f 776e 222c 0a20   "--markdown",. 
-00046610: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00046620: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
-00046630: 6374 696f 6e3d 2273 746f 7265 5f74 7275  ction="store_tru
-00046640: 6522 2c0a 2020 2020 2020 2020 6865 6c70  e",.        help
-00046650: 3d27 5365 6e64 206d 6573 7361 6765 2061  ='Send message a
-00046660: 7320 666f 726d 6174 2022 4d41 524b 444f  s format "MARKDO
-00046670: 574e 222e 2027 0a20 2020 2020 2020 2022  WN". '.        "
-00046680: 4465 7461 696c 733a 3a20 4966 206e 6f74  Details:: If not
-00046690: 2073 7065 6369 6669 6564 2c20 6d65 7373   specified, mess
-000466a0: 6167 6520 7769 6c6c 2062 6520 7365 6e74  age will be sent
-000466b0: 2022 0a20 2020 2020 2020 2027 6173 2066   ".        'as f
-000466c0: 6f72 6d61 7420 2254 4558 5422 2e20 452e  ormat "TEXT". E.
-000466d0: 672e 2074 6861 7420 616c 6c6f 7773 2073  g. that allows s
-000466e0: 656e 6469 6e67 206f 6620 7465 7874 2027  ending of text '
-000466f0: 0a20 2020 2020 2020 2022 666f 726d 6174  .        "format
-00046700: 7465 6420 696e 204d 6172 6b44 6f77 6e20  ted in MarkDown 
-00046710: 6c61 6e67 7561 6765 2e22 2c0a 2020 2020  language.",.    
-00046720: 290a 2020 2020 2320 202d 6320 6973 2061  ).    #  -c is a
-00046730: 6c72 6561 6479 2075 7365 6420 666f 7220  lready used for 
-00046740: 2d2d 6372 6564 656e 7469 616c 732c 202d  --credentials, -
-00046750: 6b20 6173 2069 7420 736f 756e 6473 206c  k as it sounds l
-00046760: 696b 6520 630a 2020 2020 6170 2e61 6464  ike c.    ap.add
-00046770: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-00046780: 2020 2022 2d6b 222c 0a20 2020 2020 2020     "-k",.       
-00046790: 2022 2d2d 636f 6465 222c 0a20 2020 2020   "--code",.     
-000467a0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-000467b0: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-000467c0: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
-000467d0: 2020 2020 2020 2020 6865 6c70 3d27 5365          help='Se
-000467e0: 6e64 206d 6573 7361 6765 2061 7320 666f  nd message as fo
-000467f0: 726d 6174 2022 434f 4445 222e 2027 0a20  rmat "CODE". '. 
-00046800: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-00046810: 3a20 4966 206e 6f74 2073 7065 6369 6669  : If not specifi
-00046820: 6564 2c20 6d65 7373 6167 6520 7769 6c6c  ed, message will
-00046830: 2062 6520 7365 6e74 2022 0a20 2020 2020   be sent ".     
-00046840: 2020 2027 6173 2066 6f72 6d61 7420 2254     'as format "T
-00046850: 4558 5422 2e20 4966 2062 6f74 6820 2d2d  EXT". If both --
-00046860: 6874 6d6c 2061 6e64 202d 2d63 6f64 6520  html and --code 
-00046870: 6172 6520 270a 2020 2020 2020 2020 2273  are '.        "s
-00046880: 7065 6369 6669 6564 2074 6865 6e20 2d2d  pecified then --
-00046890: 636f 6465 2074 616b 6573 2070 7269 6f72  code takes prior
-000468a0: 6974 792e 2054 6869 7320 6973 2022 0a20  ity. This is ". 
-000468b0: 2020 2020 2020 2022 7573 6566 756c 2066         "useful f
-000468c0: 6f72 2073 656e 6469 6e67 2041 5343 4949  or sending ASCII
-000468d0: 2d61 7274 206f 7220 7461 6262 6564 206f  -art or tabbed o
-000468e0: 7574 7075 7420 220a 2020 2020 2020 2020  utput ".        
-000468f0: 226c 696b 6520 7461 626c 6573 2061 7320  "like tables as 
-00046900: 6120 6669 7865 642d 7369 7a65 6420 666f  a fixed-sized fo
-00046910: 6e74 2077 696c 6c20 6265 2075 7365 6420  nt will be used 
-00046920: 220a 2020 2020 2020 2020 2266 6f72 2064  ".        "for d
-00046930: 6973 706c 6179 2e22 2c0a 2020 2020 290a  isplay.",.    ).
-00046940: 2020 2020 2320 202d 6a20 666f 7220 656d      #  -j for em
-00046950: 6f4a 697a 650a 2020 2020 6170 2e61 6464  oJize.    ap.add
-00046960: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-00046970: 2020 2022 2d6a 222c 0a20 2020 2020 2020     "-j",.       
-00046980: 2022 2d2d 656d 6f6a 697a 6522 2c0a 2020   "--emojize",.  
-00046990: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
-000469a0: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
-000469b0: 7469 6f6e 3d22 7374 6f72 655f 7472 7565  tion="store_true
-000469c0: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-000469d0: 2253 656e 6420 6d65 7373 6167 6520 6166  "Send message af
-000469e0: 7465 7220 656d 6f6a 697a 696e 672e 2022  ter emojizing. "
-000469f0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-00046a00: 733a 3a20 4966 206e 6f74 2073 7065 6369  s:: If not speci
-00046a10: 6669 6564 2c20 6d65 7373 6167 6520 7769  fied, message wi
-00046a20: 6c6c 2062 6520 7365 6e74 2022 0a20 2020  ll be sent ".   
-00046a30: 2020 2020 2027 6173 2066 6f72 6d61 7420       'as format 
-00046a40: 2254 4558 5422 2e20 4966 2062 6f74 6820  "TEXT". If both 
-00046a50: 2d2d 636f 6465 2061 6e64 202d 2d65 6d6f  --code and --emo
-00046a60: 6a69 7a65 2061 7265 2027 0a20 2020 2020  jize are '.     
-00046a70: 2020 2022 7370 6563 6966 6965 6420 7468     "specified th
-00046a80: 656e 202d 2d63 6f64 6520 7461 6b65 7320  en --code takes 
-00046a90: 7072 696f 7269 7479 2e20 5468 6973 2069  priority. This i
-00046aa0: 7320 220a 2020 2020 2020 2020 2275 7365  s ".        "use
-00046ab0: 6675 6c20 666f 7220 7365 6e64 696e 6720  ful for sending 
-00046ac0: 656d 6f6a 6973 2069 6e20 7368 6f72 7463  emojis in shortc
-00046ad0: 6f64 6520 666f 726d 203a 636f 6c6c 6973  ode form :collis
-00046ae0: 696f 6e3a 2e22 2c0a 2020 2020 290a 0a20  ion:.",.    ).. 
-00046af0: 2020 2023 202d 7320 6973 2061 6c72 6561     # -s is alrea
-00046b00: 6479 2075 7365 6420 666f 7220 2d2d 7374  dy used for --st
-00046b10: 6f72 652c 202d 6920 666f 7220 7350 6c69  ore, -i for sPli
-00046b20: 740a 2020 2020 6170 2e61 6464 5f61 7267  t.    ap.add_arg
-00046b30: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-00046b40: 2d70 222c 0a20 2020 2020 2020 2022 2d2d  -p",.        "--
-00046b50: 7370 6c69 7422 2c0a 2020 2020 2020 2020  split",.        
-00046b60: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-00046b70: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
-00046b80: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
-00046b90: 723d 2253 4550 4152 4154 4f52 222c 0a20  r="SEPARATOR",. 
-00046ba0: 2020 2020 2020 2068 656c 703d 2253 706c         help="Spl
-00046bb0: 6974 206d 6573 7361 6765 2074 6578 7420  it message text 
-00046bc0: 696e 746f 206d 756c 7469 706c 6520 4d61  into multiple Ma
-00046bd0: 7472 6978 206d 6573 7361 6765 732e 2022  trix messages. "
-00046be0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-00046bf0: 733a 3a20 4966 2073 6574 2c20 7370 6c69  s:: If set, spli
-00046c00: 7420 7468 6520 6d65 7373 6167 6528 7329  t the message(s)
-00046c10: 2069 6e74 6f20 6d75 6c74 6970 6c65 206d   into multiple m
-00046c20: 6573 7361 6765 7320 220a 2020 2020 2020  essages ".      
-00046c30: 2020 2277 6865 7265 7665 7220 7468 6520    "wherever the 
-00046c40: 7374 7269 6e67 2073 7065 6369 6669 6564  string specified
-00046c50: 2077 6974 6820 2d2d 7370 6c69 7420 6f63   with --split oc
-00046c60: 6375 7273 2e20 220a 2020 2020 2020 2020  curs. ".        
-00046c70: 2245 2e67 2e20 4f6e 6520 7069 7065 7320  "E.g. One pipes 
-00046c80: 6120 7374 7265 616d 206f 6620 5253 5320  a stream of RSS 
-00046c90: 6172 7469 636c 6573 2069 6e74 6f20 7468  articles into th
-00046ca0: 6520 220a 2020 2020 2020 2020 2270 726f  e ".        "pro
-00046cb0: 6772 616d 2061 6e64 2074 6865 2061 7274  gram and the art
-00046cc0: 6963 6c65 7320 6172 6520 7365 7061 7261  icles are separa
-00046cd0: 7465 6420 6279 2074 6872 6565 2022 0a20  ted by three ". 
-00046ce0: 2020 2020 2020 2022 6e65 776c 696e 6573         "newlines
-00046cf0: 2e20 220a 2020 2020 2020 2020 2754 6865  . ".        'The
-00046d00: 6e20 7769 7468 202d 2d73 706c 6974 2073  n with --split s
-00046d10: 6574 2074 6f20 225c 5c6e 5c5c 6e5c 5c6e  et to "\\n\\n\\n
-00046d20: 2220 6561 6368 2061 7274 6963 6c65 2027  " each article '
-00046d30: 0a20 2020 2020 2020 2022 7769 6c6c 2062  .        "will b
-00046d40: 6520 7072 696e 7465 6420 696e 2061 2073  e printed in a s
-00046d50: 6570 6172 6174 6520 6d65 7373 6167 652e  eparate message.
-00046d60: 2022 0a20 2020 2020 2020 2022 4279 2064   ".        "By d
-00046d70: 6566 6175 6c74 2c20 692e 652e 2069 6620  efault, i.e. if 
-00046d80: 6e6f 7420 7365 742c 206e 6f20 6d65 7373  not set, no mess
-00046d90: 6167 6573 2077 696c 6c20 6265 2073 706c  ages will be spl
-00046da0: 6974 2e22 2c0a 2020 2020 290a 2020 2020  it.",.    ).    
-00046db0: 2320 2d63 2069 7320 616c 7265 6164 7920  # -c is already 
-00046dc0: 7573 6564 2066 6f72 202d 2d63 7265 6465  used for --crede
-00046dd0: 6e74 6961 6c73 0a20 2020 2061 702e 6164  ntials.    ap.ad
-00046de0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-00046df0: 2020 2020 222d 2d63 6f6e 6669 6722 2c0a      "--config",.
-00046e00: 2020 2020 2020 2020 7265 7175 6972 6564          required
-00046e10: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00046e20: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-00046e30: 2020 6d65 7461 7661 723d 2243 4f4e 4649    metavar="CONFI
-00046e40: 475f 4649 4c45 222c 0a20 2020 2020 2020  G_FILE",.       
-00046e50: 2068 656c 703d 2253 7065 6369 6679 2074   help="Specify t
-00046e60: 6865 206c 6f63 6174 696f 6e20 6f66 2061  he location of a
-00046e70: 2063 6f6e 6669 6720 6669 6c65 2e20 220a   config file. ".
-00046e80: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
-00046e90: 3a3a 2042 7920 6465 6661 756c 742c 206e  :: By default, n
-00046ea0: 6f20 220a 2020 2020 2020 2020 2263 6f6e  o ".        "con
-00046eb0: 6669 6720 6669 6c65 2069 7320 7573 6564  fig file is used
-00046ec0: 2e20 220a 2020 2020 2020 2020 2249 6620  . ".        "If 
-00046ed0: 7468 6973 206f 7074 696f 6e20 6973 2070  this option is p
-00046ee0: 726f 7669 6465 642c 2074 6865 2070 726f  rovided, the pro
-00046ef0: 7669 6465 6420 6669 6c65 206e 616d 6520  vided file name 
-00046f00: 220a 2020 2020 2020 2020 2277 696c 6c20  ".        "will 
-00046f10: 6265 2075 7365 6420 746f 2072 6561 6420  be used to read 
-00046f20: 636f 6e66 6967 7572 6174 696f 6e20 6672  configuration fr
-00046f30: 6f6d 2e20 4e6f 7420 696d 706c 656d 656e  om. Not implemen
-00046f40: 7465 642e 222c 0a20 2020 2029 0a20 2020  ted.",.    ).   
-00046f50: 2023 202d 7020 6973 2061 6c72 6561 6479   # -p is already
-00046f60: 2075 7365 6420 666f 7220 2d2d 7370 6c69   used for --spli
-00046f70: 740a 2020 2020 6170 2e61 6464 5f61 7267  t.    ap.add_arg
-00046f80: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-00046f90: 2d2d 7072 6f78 7922 2c0a 2020 2020 2020  --proxy",.      
-00046fa0: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-00046fb0: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
-00046fc0: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
-00046fd0: 7661 723d 2250 524f 5859 222c 0a20 2020  var="PROXY",.   
-00046fe0: 2020 2020 2068 656c 703d 2253 7065 6369       help="Speci
-00046ff0: 6679 2061 2070 726f 7879 2066 6f72 2063  fy a proxy for c
-00047000: 6f6e 6e65 6374 6976 6974 792e 2022 0a20  onnectivity. ". 
-00047010: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-00047020: 3a20 4279 2064 6566 6175 6c74 2c20 220a  : By default, ".
-00047030: 2020 2020 2020 2020 2269 2e65 2e20 6966          "i.e. if
-00047040: 2074 6869 7320 6f70 7469 6f6e 2069 7320   this option is 
-00047050: 6e6f 7420 7365 742c 206e 6f20 7072 6f78  not set, no prox
-00047060: 7920 6973 2075 7365 642e 2022 0a20 2020  y is used. ".   
-00047070: 2020 2020 2022 4966 2074 6869 7320 6f70       "If this op
-00047080: 7469 6f6e 2069 7320 7573 6564 2061 2070  tion is used a p
-00047090: 726f 7879 2055 524c 206d 7573 7420 6265  roxy URL must be
-000470a0: 2070 726f 7669 6465 642e 2022 0a20 2020   provided. ".   
-000470b0: 2020 2020 2022 5468 6520 7072 6f76 6964       "The provid
-000470c0: 6564 2070 726f 7879 2055 524c 2022 0a20  ed proxy URL ". 
-000470d0: 2020 2020 2020 2022 7769 6c6c 2062 6520         "will be 
-000470e0: 7573 6564 2066 6f72 2074 6865 2048 5454  used for the HTT
-000470f0: 5020 636f 6e6e 6563 7469 6f6e 2074 6f20  P connection to 
-00047100: 7468 6520 7365 7276 6572 2e20 220a 2020  the server. ".  
-00047110: 2020 2020 2020 2254 6865 2070 726f 7879        "The proxy
-00047120: 2073 7570 706f 7274 7320 534f 434b 5334   supports SOCKS4
-00047130: 2861 292c 2053 4f43 4b53 352c 2061 6e64  (a), SOCKS5, and
-00047140: 2048 5454 5020 2874 756e 6e65 6c69 6e67   HTTP (tunneling
-00047150: 292e 2022 0a20 2020 2020 2020 2027 4578  ). ".        'Ex
-00047160: 616d 706c 6573 206f 6620 7661 6c69 6420  amples of valid 
-00047170: 5552 4c73 2061 7265 2022 6874 7470 3a2f  URLs are "http:/
-00047180: 2f31 302e 3130 2e31 302e 3130 3a38 3131  /10.10.10.10:811
-00047190: 3822 2027 0a20 2020 2020 2020 2027 6f72  8" '.        'or
-000471a0: 2022 736f 636b 7335 3a2f 2f75 7365 723a   "socks5://user:
-000471b0: 7061 7373 776f 7264 4031 3237 2e30 2e30  password@127.0.0
-000471c0: 2e31 3a31 3038 3022 2e20 270a 2020 2020  .1:1080". '.    
-000471d0: 2020 2020 2755 524c 7320 7769 7468 2022      'URLs with "
-000471e0: 6874 7470 7322 206f 7220 2273 6f63 6b73  https" or "socks
-000471f0: 3461 2220 6172 6520 6e6f 7420 7661 6c69  4a" are not vali
-00047200: 642e 204f 6e6c 7920 270a 2020 2020 2020  d. Only '.      
-00047210: 2020 2722 6874 7470 222c 2022 736f 636b    '"http", "sock
-00047220: 7334 2220 616e 6420 2273 6f63 6b73 3522  s4" and "socks5"
-00047230: 2061 7265 2076 616c 6964 2e27 2c0a 2020   are valid.',.  
-00047240: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-00047250: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-00047260: 2022 2d6e 222c 0a20 2020 2020 2020 2022   "-n",.        "
-00047270: 2d2d 6e6f 7469 6365 222c 0a20 2020 2020  --notice",.     
-00047280: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-00047290: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-000472a0: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
-000472b0: 2020 2020 2020 2020 6865 6c70 3d22 5365          help="Se
-000472c0: 6e64 206d 6573 7361 6765 2061 7320 6e6f  nd message as no
-000472d0: 7469 6365 2e20 220a 2020 2020 2020 2020  tice. ".        
-000472e0: 2244 6574 6169 6c73 3a3a 2049 6620 6e6f  "Details:: If no
-000472f0: 7420 7370 6563 6966 6965 642c 206d 6573  t specified, mes
-00047300: 7361 6765 2077 696c 6c20 6265 2073 656e  sage will be sen
-00047310: 7420 6173 2074 6578 742e 222c 0a20 2020  t as text.",.   
-00047320: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-00047330: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-00047340: 2320 6e6f 2073 696e 676c 6520 6368 6172  # no single char
-00047350: 2066 6c61 670a 2020 2020 2020 2020 222d   flag.        "-
-00047360: 2d65 6e63 7279 7074 6564 222c 0a20 2020  -encrypted",.   
-00047370: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00047380: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00047390: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
-000473a0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-000473b0: 5365 6e64 206d 6573 7361 6765 2065 6e64  Send message end
-000473c0: 2d74 6f2d 656e 6420 656e 6372 7970 7465  -to-end encrypte
-000473d0: 642e 2022 0a20 2020 2020 2020 2022 4465  d. ".        "De
-000473e0: 7461 696c 733a 3a20 456e 6372 7970 7469  tails:: Encrypti
-000473f0: 6f6e 2069 7320 616c 7761 7973 2074 7572  on is always tur
-00047400: 6e65 6420 6f6e 2061 6e64 2022 0a20 2020  ned on and ".   
-00047410: 2020 2020 2022 7769 6c6c 2061 6c77 6179       "will alway
-00047420: 7320 6265 2075 7365 6420 7768 6572 6520  s be used where 
-00047430: 706f 7373 6962 6c65 2e20 220a 2020 2020  possible. ".    
-00047440: 2020 2020 2249 7420 6361 6e6e 6f74 2062      "It cannot b
-00047450: 6520 7475 726e 6564 206f 6666 2e20 5468  e turned off. Th
-00047460: 6973 2066 6c61 6720 646f 6573 206e 6f74  is flag does not
-00047470: 6869 6e67 2022 0a20 2020 2020 2020 2022  hing ".        "
-00047480: 6173 2065 6e63 7279 7074 696f 6e20 6973  as encryption is
-00047490: 2074 7572 6e65 6420 6f6e 2077 6974 6820   turned on with 
-000474a0: 6f72 2077 6974 686f 7574 2074 6869 7320  or without this 
-000474b0: 220a 2020 2020 2020 2020 2261 7267 756d  ".        "argum
-000474c0: 656e 742e 2054 6869 7320 666c 6167 2065  ent. This flag e
-000474d0: 7869 7374 7320 6f6e 6c79 2066 6f72 2068  xists only for h
-000474e0: 6973 746f 7269 6320 7265 6173 6f6e 732e  istoric reasons.
-000474f0: 2022 0a20 2020 2020 2020 2022 496e 2073   ".        "In s
-00047500: 6f6d 6520 7370 6563 6966 6963 2063 6173  ome specific cas
-00047510: 6520 656e 6372 7970 7469 6f6e 2022 0a20  e encryption ". 
-00047520: 2020 2020 2020 2022 6361 6e20 6265 2064         "can be d
-00047530: 6973 6162 6c65 642c 2070 6c65 6173 6520  isabled, please 
-00047540: 7365 6520 2d2d 706c 6169 6e2e 222c 0a20  see --plain.",. 
-00047550: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-00047560: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-00047570: 2020 222d 6c22 2c0a 2020 2020 2020 2020    "-l",.        
-00047580: 222d 2d6c 6973 7465 6e22 2c0a 2020 2020  "--listen",.    
-00047590: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-000475a0: 7365 2c0a 2020 2020 2020 2020 7479 7065  se,.        type
-000475b0: 3d73 7472 2c0a 2020 2020 2020 2020 6465  =str,.        de
-000475c0: 6661 756c 743d 4c49 5354 454e 5f44 4546  fault=LISTEN_DEF
-000475d0: 4155 4c54 2c20 2023 2077 6865 6e20 2d6c  AULT,  # when -l
-000475e0: 2069 7320 6e6f 7420 7573 6564 0a20 2020   is not used.   
-000475f0: 2020 2020 206e 6172 6773 3d22 3f22 2c20       nargs="?", 
-00047600: 2023 206d 616b 6573 2074 6865 2077 6f72   # makes the wor
-00047610: 6420 6f70 7469 6f6e 616c 0a20 2020 2020  d optional.     
-00047620: 2020 2063 6f6e 7374 3d46 4f52 4556 4552     const=FOREVER
-00047630: 2c20 2023 2077 6865 6e20 2d6c 2069 7320  ,  # when -l is 
-00047640: 7573 6564 2c20 6275 7420 464f 5245 5645  used, but FOREVE
-00047650: 5220 6973 206e 6f74 2061 6464 6564 0a20  R is not added. 
-00047660: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-00047670: 4e45 5645 527c 4f4e 4345 7c46 4f52 4556  NEVER|ONCE|FOREV
-00047680: 4552 7c54 4149 4c7c 414c 4c22 2c0a 2020  ER|TAIL|ALL",.  
-00047690: 2020 2020 2020 6865 6c70 3d22 5072 696e        help="Prin
-000476a0: 7420 7265 6365 6976 6564 206d 6573 7361  t received messa
-000476b0: 6765 7320 616e 6420 6c69 7374 656e 2074  ges and listen t
-000476c0: 6f20 6d65 7373 6167 6573 2e20 220a 2020  o messages. ".  
-000476d0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-000476e0: 2054 6865 202d 2d6c 6973 7465 6e20 6f70   The --listen op
-000476f0: 7469 6f6e 2074 616b 6573 206f 6e65 2061  tion takes one a
-00047700: 7267 756d 656e 742e 2054 6865 7265 2022  rgument. There "
-00047710: 0a20 2020 2020 2020 2066 2761 7265 2073  .        f'are s
-00047720: 6576 6572 616c 2063 686f 6963 6573 3a20  everal choices: 
-00047730: 227b 4e45 5645 527d 222c 2022 7b4f 4e43  "{NEVER}", "{ONC
-00047740: 457d 222c 2027 0a20 2020 2020 2020 2066  E}", '.        f
-00047750: 2722 7b46 4f52 4556 4552 7d22 2c20 227b  '"{FOREVER}", "{
-00047760: 5441 494c 7d22 2c20 616e 6420 227b 414c  TAIL}", and "{AL
-00047770: 4c7d 222e 2027 0a20 2020 2020 2020 2066  L}". '.        f
-00047780: 2742 7920 6465 6661 756c 742c 202d 2d6c  'By default, --l
-00047790: 6973 7465 6e20 6973 2073 6574 2074 6f20  isten is set to 
-000477a0: 227b 4e45 5645 527d 222e 2020 536f 2c20  "{NEVER}".  So, 
-000477b0: 6279 2027 0a20 2020 2020 2020 2022 6465  by '.        "de
-000477c0: 6661 756c 7420 6e6f 206c 6973 7465 6e69  fault no listeni
-000477d0: 6e67 2077 696c 6c20 6265 2064 6f6e 652e  ng will be done.
-000477e0: 2053 6574 2069 7420 746f 2022 0a20 2020   Set it to ".   
-000477f0: 2020 2020 2066 2722 7b46 4f52 4556 4552       f'"{FOREVER
-00047800: 7d22 2074 6f20 6c69 7374 656e 2066 6f72  }" to listen for
-00047810: 2061 6e64 2070 7269 6e74 2069 6e63 6f6d   and print incom
-00047820: 696e 6720 6d65 7373 6167 6573 2027 0a20  ing messages '. 
-00047830: 2020 2020 2020 2022 746f 2073 7464 6f75         "to stdou
-00047840: 742e 2022 0a20 2020 2020 2020 2066 2722  t. ".        f'"
-00047850: 2d2d 6c69 7374 656e 207b 464f 5245 5645  --listen {FOREVE
-00047860: 527d 2220 7769 6c6c 206c 6973 7465 6e20  R}" will listen 
-00047870: 746f 2061 6c6c 206d 6573 7361 6765 7320  to all messages 
-00047880: 6f6e 2027 0a20 2020 2020 2020 2022 616c  on '.        "al
-00047890: 6c20 726f 6f6d 7320 666f 7265 7665 722e  l rooms forever.
-000478a0: 2022 0a20 2020 2020 2020 2066 2754 6f20   ".        f'To 
-000478b0: 7374 6f70 206c 6973 7465 6e69 6e67 2022  stop listening "
-000478c0: 7b46 4f52 4556 4552 7d22 2c20 7573 6520  {FOREVER}", use 
-000478d0: 436f 6e74 726f 6c2d 4320 6f6e 2027 0a20  Control-C on '. 
-000478e0: 2020 2020 2020 2022 7468 6520 6b65 7962         "the keyb
-000478f0: 6f61 7264 206f 7220 7365 6e64 2061 2073  oard or send a s
-00047900: 6967 6e61 6c20 746f 2074 6865 2070 726f  ignal to the pro
-00047910: 6365 7373 206f 7220 7365 7276 6963 652e  cess or service.
-00047920: 2022 0a20 2020 2020 2020 2022 5468 6520   ".        "The 
-00047930: 5049 4420 666f 7220 7369 676e 616c 696e  PID for signalin
-00047940: 6720 6361 6e20 6265 2066 6f75 6e64 2069  g can be found i
-00047950: 6e20 6120 5049 4420 6669 6c65 2069 6e20  n a PID file in 
-00047960: 220a 2020 2020 2020 2020 6627 6469 7265  ".        f'dire
-00047970: 6374 6f72 7920 227b 5049 445f 4449 525f  ctory "{PID_DIR_
-00047980: 4445 4641 554c 547d 222e 2027 0a20 2020  DEFAULT}". '.   
-00047990: 2020 2020 2066 2722 2d2d 6c69 7374 656e       f'"--listen
-000479a0: 207b 4f4e 4345 7d22 2077 696c 6c20 6765   {ONCE}" will ge
-000479b0: 7420 616c 6c20 7468 6520 6d65 7373 6167  t all the messag
-000479c0: 6573 2066 726f 6d20 270a 2020 2020 2020  es from '.      
-000479d0: 2020 2261 6c6c 2072 6f6f 6d73 2074 6861    "all rooms tha
-000479e0: 7420 6172 6520 6375 7272 656e 746c 7920  t are currently 
-000479f0: 7175 6575 6564 2075 702e 2053 6f2c 2077  queued up. So, w
-00047a00: 6974 6820 220a 2020 2020 2020 2020 6627  ith ".        f'
-00047a10: 227b 4f4e 4345 7d22 2074 6865 2070 726f  "{ONCE}" the pro
-00047a20: 6772 616d 2077 696c 6c20 7374 6172 742c  gram will start,
-00047a30: 2070 7269 6e74 2077 6169 7469 6e67 2027   print waiting '
-00047a40: 0a20 2020 2020 2020 2022 6d65 7373 6167  .        "messag
-00047a50: 6573 2028 6966 2061 6e79 2920 616e 6420  es (if any) and 
-00047a60: 7468 656e 2073 746f 702e 2054 6865 2074  then stop. The t
-00047a70: 696d 656f 7574 2066 6f72 2022 0a20 2020  imeout for ".   
-00047a80: 2020 2020 2066 2722 7b4f 4e43 457d 2220       f'"{ONCE}" 
-00047a90: 6973 2073 6574 2074 6f20 3130 2073 6563  is set to 10 sec
-00047aa0: 6f6e 6473 2e20 536f 2c20 6265 2070 6174  onds. So, be pat
-00047ab0: 6965 6e74 2c20 6974 2027 0a20 2020 2020  ient, it '.     
-00047ac0: 2020 2022 6d69 6768 7420 7461 6b65 2075     "might take u
-00047ad0: 7020 746f 2074 6861 7420 616d 6f75 6e74  p to that amount
-00047ae0: 206f 6620 7469 6d65 2e20 220a 2020 2020   of time. ".    
-00047af0: 2020 2020 6627 227b 5441 494c 7d22 2072      f'"{TAIL}" r
-00047b00: 6561 6473 2061 6e64 2070 7269 6e74 7320  eads and prints 
-00047b10: 7468 6520 6c61 7374 204e 2027 0a20 2020  the last N '.   
-00047b20: 2020 2020 2022 6d65 7373 6167 6573 2066       "messages f
-00047b30: 726f 6d20 7468 6520 7370 6563 6966 6965  rom the specifie
-00047b40: 6420 726f 6f6d 732c 2074 6865 6e20 7175  d rooms, then qu
-00047b50: 6974 732e 2054 6865 2022 0a20 2020 2020  its. The ".     
-00047b60: 2020 2022 6e75 6d62 6572 204e 2063 616e     "number N can
-00047b70: 2062 6520 7365 7420 7769 7468 2074 6865   be set with the
-00047b80: 202d 2d74 6169 6c20 6f70 7469 6f6e 2e20   --tail option. 
-00047b90: 5769 7468 2022 0a20 2020 2020 2020 2066  With ".        f
-00047ba0: 2722 7b54 4149 4c7d 2220 736f 6d65 206d  '"{TAIL}" some m
-00047bb0: 6573 7361 6765 7320 7265 6164 206d 6967  essages read mig
-00047bc0: 6874 2062 6520 6f6c 642c 2027 0a20 2020  ht be old, '.   
-00047bd0: 2020 2020 2022 692e 652e 2061 6c72 6561       "i.e. alrea
-00047be0: 6479 2072 6561 6420 6265 666f 7265 2c20  dy read before, 
-00047bf0: 736f 6d65 206d 6967 6874 2062 6520 6e65  some might be ne
-00047c00: 772c 2022 0a20 2020 2020 2020 2022 692e  w, ".        "i.
-00047c10: 652e 206e 6576 6572 2072 6561 6420 6265  e. never read be
-00047c20: 666f 7265 2e20 4974 2070 7269 6e74 7320  fore. It prints 
-00047c30: 7468 6520 6d65 7373 6167 6573 2061 6e64  the messages and
-00047c40: 2074 6865 6e20 220a 2020 2020 2020 2020   then ".        
-00047c50: 6622 7468 6520 7072 6f67 7261 6d20 7374  f"the program st
-00047c60: 6f70 732e 2022 0a20 2020 2020 2020 2022  ops. ".        "
-00047c70: 4d65 7373 6167 6573 2061 7265 2073 6f72  Messages are sor
-00047c80: 7465 642c 206c 6173 742d 6669 7273 742e  ted, last-first.
-00047c90: 2022 0a20 2020 2020 2020 2022 4c6f 6f6b   ".        "Look
-00047ca0: 2061 7420 2d2d 7461 696c 2061 7320 7468   at --tail as th
-00047cb0: 6174 206f 7074 696f 6e20 6973 2072 656c  at option is rel
-00047cc0: 6174 6564 2022 0a20 2020 2020 2020 2022  ated ".        "
-00047cd0: 746f 202d 2d6c 6973 7465 6e20 7461 696c  to --listen tail
-00047ce0: 2e20 220a 2020 2020 2020 2020 6627 5468  . ".        f'Th
-00047cf0: 6520 6f70 7469 6f6e 2022 7b41 4c4c 7d22  e option "{ALL}"
-00047d00: 2067 6574 7320 616c 6c20 6d65 7373 6167   gets all messag
-00047d10: 6573 2061 7661 696c 6162 6c65 2c20 270a  es available, '.
-00047d20: 2020 2020 2020 2020 226f 6c64 2061 6e64          "old and
-00047d30: 206e 6577 2e20 220a 2020 2020 2020 2020   new. ".        
-00047d40: 6627 556e 6c69 6b65 2022 7b4f 4e43 457d  f'Unlike "{ONCE}
-00047d50: 2220 616e 6420 270a 2020 2020 2020 2020  " and '.        
-00047d60: 6627 227b 464f 5245 5645 527d 2220 7468  f'"{FOREVER}" th
-00047d70: 6174 206c 6973 7465 6e20 696e 2041 4c4c  at listen in ALL
-00047d80: 2072 6f6f 6d73 2c20 227b 5441 494c 7d22   rooms, "{TAIL}"
-00047d90: 2027 0a20 2020 2020 2020 2066 2761 6e64   '.        f'and
-00047da0: 2022 7b41 4c4c 7d22 206c 6973 7465 6e20   "{ALL}" listen 
-00047db0: 270a 2020 2020 2020 2020 226f 6e6c 7920  '.        "only 
-00047dc0: 746f 2074 6865 2072 6f6f 6d20 7370 6563  to the room spec
-00047dd0: 6966 6965 6420 696e 2074 6865 2063 7265  ified in the cre
-00047de0: 6465 6e74 6961 6c73 2022 0a20 2020 2020  dentials ".     
-00047df0: 2020 2022 6669 6c65 206f 7220 7468 6520     "file or the 
-00047e00: 2d2d 726f 6f6d 206f 7074 696f 6e73 2e20  --room options. 
-00047e10: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
-00047e20: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
-00047e30: 2020 2020 2020 222d 7422 2c0a 2020 2020        "-t",.    
-00047e40: 2020 2020 222d 2d74 6169 6c22 2c0a 2020      "--tail",.  
-00047e50: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
-00047e60: 616c 7365 2c0a 2020 2020 2020 2020 7479  alse,.        ty
-00047e70: 7065 3d69 6e74 2c0a 2020 2020 2020 2020  pe=int,.        
-00047e80: 6465 6661 756c 743d 5441 494c 5f55 4e55  default=TAIL_UNU
-00047e90: 5345 445f 4445 4641 554c 542c 2020 2320  SED_DEFAULT,  # 
-00047ea0: 7768 656e 202d 7420 6973 206e 6f74 2075  when -t is not u
-00047eb0: 7365 640a 2020 2020 2020 2020 6e61 7267  sed.        narg
-00047ec0: 733d 223f 222c 2020 2320 6d61 6b65 7320  s="?",  # makes 
-00047ed0: 7468 6520 776f 7264 206f 7074 696f 6e61  the word optiona
-00047ee0: 6c0a 2020 2020 2020 2020 2320 7768 656e  l.        # when
-00047ef0: 202d 7420 6973 2075 7365 642c 2062 7574   -t is used, but
-00047f00: 206e 756d 6265 7220 6973 206e 6f74 2061   number is not a
-00047f10: 6464 6564 0a20 2020 2020 2020 2063 6f6e  dded.        con
-00047f20: 7374 3d54 4149 4c5f 5553 4544 5f44 4546  st=TAIL_USED_DEF
-00047f30: 4155 4c54 2c0a 2020 2020 2020 2020 6d65  AULT,.        me
-00047f40: 7461 7661 723d 224e 554d 4245 5222 2c0a  tavar="NUMBER",.
-00047f50: 2020 2020 2020 2020 6865 6c70 3d22 5072          help="Pr
-00047f60: 696e 7420 6c61 7374 206d 6573 7361 6765  int last message
-00047f70: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
-00047f80: 7461 696c 733a 3a20 5468 6520 2d2d 7461  tails:: The --ta
-00047f90: 696c 206f 7074 696f 6e20 7265 6164 7320  il option reads 
-00047fa0: 616e 6420 7072 696e 7473 2075 7020 746f  and prints up to
-00047fb0: 2074 6865 206c 6173 7420 4e20 220a 2020   the last N ".  
-00047fc0: 2020 2020 2020 226d 6573 7361 6765 7320        "messages 
-00047fd0: 6672 6f6d 2074 6865 2073 7065 6369 6669  from the specifi
-00047fe0: 6564 2072 6f6f 6d73 2c20 7468 656e 2071  ed rooms, then q
-00047ff0: 7569 7473 2e20 220a 2020 2020 2020 2020  uits. ".        
-00048000: 2249 7420 7461 6b65 7320 6f6e 6520 220a  "It takes one ".
-00048010: 2020 2020 2020 2020 2261 7267 756d 656e          "argumen
-00048020: 742c 2061 6e20 696e 7465 6765 722c 2022  t, an integer, "
-00048030: 0a20 2020 2020 2020 2022 7768 6963 6820  .        "which 
-00048040: 7765 2063 616c 6c20 4e20 6865 7265 2e20  we call N here. 
-00048050: 4966 2074 6865 7265 2061 7265 2066 6577  If there are few
-00048060: 6572 2074 6861 6e20 4e20 6d65 7373 6167  er than N messag
-00048070: 6573 2022 0a20 2020 2020 2020 2022 696e  es ".        "in
-00048080: 2061 2072 6f6f 6d2c 2069 7420 7265 6164   a room, it read
-00048090: 7320 616e 6420 7072 696e 7473 2075 7020  s and prints up 
-000480a0: 746f 204e 206d 6573 7361 6765 732e 2022  to N messages. "
-000480b0: 0a20 2020 2020 2020 2022 4974 2067 6574  .        "It get
-000480c0: 7320 7468 6520 6c61 7374 204e 206d 6573  s the last N mes
-000480d0: 7361 6765 7320 696e 2072 6576 6572 7365  sages in reverse
-000480e0: 206f 7264 6572 2e20 220a 2020 2020 2020   order. ".      
-000480f0: 2020 2249 7420 7072 696e 7420 7468 6520    "It print the 
-00048100: 6e65 7765 7374 206d 6573 7361 6765 2066  newest message f
-00048110: 6972 7374 2c20 616e 6420 7468 6520 220a  irst, and the ".
-00048120: 2020 2020 2020 2020 226f 6c64 6573 7420          "oldest 
-00048130: 6d65 7373 6167 6520 6c61 7374 2e20 220a  message last. ".
-00048140: 2020 2020 2020 2020 2249 6620 2d2d 6c69          "If --li
-00048150: 7374 656e 2d73 656c 6620 6973 206e 6f74  sten-self is not
-00048160: 2073 6574 2069 7420 7769 6c6c 2070 7269   set it will pri
-00048170: 6e74 206c 6573 7320 7468 616e 2022 0a20  nt less than ". 
-00048180: 2020 2020 2020 2022 4e20 6d65 7373 6167         "N messag
-00048190: 6573 2069 6e20 6d61 6e79 2063 6173 6573  es in many cases
-000481a0: 2062 6563 6175 7365 204e 206d 6573 7361   because N messa
-000481b0: 6765 7320 6172 6520 220a 2020 2020 2020  ges are ".      
-000481c0: 2020 226f 6274 6169 6e65 642c 2062 7574    "obtained, but
-000481d0: 2073 6f6d 6520 6f66 2074 6865 6d20 6172   some of them ar
-000481e0: 6520 6469 7363 6172 6465 6420 6279 2064  e discarded by d
-000481f0: 6566 6175 6c74 2069 6620 220a 2020 2020  efault if ".    
-00048200: 2020 2020 2274 6865 7920 6172 6520 6672      "they are fr
-00048210: 6f6d 2074 6865 2075 7365 7220 6974 7365  om the user itse
-00048220: 6c66 2e20 220a 2020 2020 2020 2020 224c  lf. ".        "L
-00048230: 6f6f 6b20 6174 202d 2d6c 6973 7465 6e20  ook at --listen 
-00048240: 6173 2074 6869 7320 6f70 7469 6f6e 2069  as this option i
-00048250: 7320 7265 6c61 7465 6420 746f 202d 2d74  s related to --t
-00048260: 6169 6c2e 222c 0a20 2020 2029 0a20 2020  ail.",.    ).   
-00048270: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00048280: 280a 2020 2020 2020 2020 222d 7922 2c0a  (.        "-y",.
-00048290: 2020 2020 2020 2020 222d 2d6c 6973 7465          "--liste
-000482a0: 6e2d 7365 6c66 222c 0a20 2020 2020 2020  n-self",.       
-000482b0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-000482c0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-000482d0: 2273 746f 7265 5f74 7275 6522 2c0a 2020  "store_true",.  
-000482e0: 2020 2020 2020 6865 6c70 3d22 5072 696e        help="Prin
-000482f0: 7420 796f 7572 206f 776e 206d 6573 7361  t your own messa
-00048300: 6765 7320 6173 2077 656c 6c2e 2022 0a20  ges as well. ". 
-00048310: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-00048320: 3a20 4966 2073 6574 2061 6e64 206c 6973  : If set and lis
-00048330: 7465 6e69 6e67 2c20 220a 2020 2020 2020  tening, ".      
-00048340: 2020 2274 6865 6e20 7072 6f67 7261 6d20    "then program 
-00048350: 7769 6c6c 206c 6973 7465 6e20 746f 2061  will listen to a
-00048360: 6e64 2070 7269 6e74 2061 6c73 6f20 220a  nd print also ".
-00048370: 2020 2020 2020 2020 2274 6865 206d 6573          "the mes
-00048380: 7361 6765 7320 7365 6e74 2062 7920 6974  sages sent by it
-00048390: 7320 6f77 6e20 7573 6572 2e20 220a 2020  s own user. ".  
-000483a0: 2020 2020 2020 2242 7920 6465 6661 756c        "By defaul
-000483b0: 7420 6d65 7373 6167 6573 2066 726f 6d20  t messages from 
-000483c0: 6f6e 6573 656c 6620 6172 6520 6e6f 7420  oneself are not 
-000483d0: 7072 696e 7465 642e 222c 0a20 2020 2029  printed.",.    )
-000483e0: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
-000483f0: 6d65 6e74 280a 2020 2020 2020 2020 2320  ment(.        # 
-00048400: 6e6f 2073 696e 676c 6520 6368 6172 2066  no single char f
-00048410: 6c61 670a 2020 2020 2020 2020 222d 2d70  lag.        "--p
-00048420: 7269 6e74 2d65 7665 6e74 2d69 6422 2c0a  rint-event-id",.
-00048430: 2020 2020 2020 2020 7265 7175 6972 6564          required
-00048440: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00048450: 6163 7469 6f6e 3d22 7374 6f72 655f 7472  action="store_tr
-00048460: 7565 222c 0a20 2020 2020 2020 2068 656c  ue",.        hel
-00048470: 703d 2250 7269 6e74 2065 7665 6e74 2069  p="Print event i
-00048480: 6473 206f 6620 7265 6365 6976 6564 206d  ds of received m
-00048490: 6573 7361 6765 732e 2022 0a20 2020 2020  essages. ".     
-000484a0: 2020 2022 4465 7461 696c 733a 3a20 4966     "Details:: If
-000484b0: 2073 6574 2061 6e64 206c 6973 7465 6e69   set and listeni
-000484c0: 6e67 2c20 220a 2020 2020 2020 2020 6622  ng, ".        f"
-000484d0: 7468 656e 2027 7b50 524f 475f 5749 5448  then '{PROG_WITH
-000484e0: 4f55 545f 4558 547d 2720 7769 6c6c 2070  OUT_EXT}' will p
-000484f0: 7269 6e74 2061 6c73 6f20 7468 6520 6576  rint also the ev
-00048500: 656e 7420 6964 2066 6f72 2022 0a20 2020  ent id for ".   
-00048510: 2020 2020 2022 6561 6368 2072 6563 6569       "each recei
-00048520: 7665 6420 6d65 7373 6167 6520 6f72 206f  ved message or o
-00048530: 7468 6572 2072 6563 6569 7665 6420 6576  ther received ev
-00048540: 656e 742e 2049 6620 7365 7420 616e 6420  ent. If set and 
-00048550: 220a 2020 2020 2020 2020 6622 7365 6e64  ".        f"send
-00048560: 696e 672c 2074 6865 6e20 277b 5052 4f47  ing, then '{PROG
-00048570: 5f57 4954 484f 5554 5f45 5854 7d27 2077  _WITHOUT_EXT}' w
-00048580: 696c 6c20 7072 696e 7420 7468 6520 6576  ill print the ev
-00048590: 656e 7420 6964 2022 0a20 2020 2020 2020  ent id ".       
-000485a0: 2022 6f66 2074 6865 2073 656e 7420 6d65   "of the sent me
-000485b0: 7373 6167 6520 6f72 2074 6865 2073 656e  ssage or the sen
-000485c0: 7420 6f62 6a65 6374 2028 6175 6469 6f2c  t object (audio,
-000485d0: 2066 696c 652c 2065 7665 6e74 2920 746f   file, event) to
-000485e0: 2022 0a20 2020 2020 2020 2022 7374 646f   ".        "stdo
-000485f0: 7574 2e20 4f74 6865 7220 696e 666f 726d  ut. Other inform
-00048600: 6174 696f 6e20 6c69 6b65 2072 6f6f 6d20  ation like room 
-00048610: 6964 2061 6e64 2072 6566 6572 656e 6365  id and reference
-00048620: 2074 6f20 7768 6174 2077 6173 2022 0a20   to what was ". 
-00048630: 2020 2020 2020 2022 7365 6e74 2077 696c         "sent wil
-00048640: 6c20 6265 2070 7269 6e74 6564 2074 6f6f  l be printed too
-00048650: 2e20 466f 7220 7365 6e64 696e 6720 7468  . For sending th
-00048660: 6973 2069 7320 7573 6566 756c 2c20 220a  is is useful, ".
-00048670: 2020 2020 2020 2020 2269 6620 6166 7465          "if afte
-00048680: 7220 7365 6e64 696e 6720 7468 6520 7573  r sending the us
-00048690: 6572 2022 0a20 2020 2020 2020 2022 7769  er ".        "wi
-000486a0: 7368 6573 2074 6f20 7065 7266 6f72 6d20  shes to perform 
-000486b0: 6675 7274 6865 7220 6f70 6572 6174 696f  further operatio
-000486c0: 6e73 206f 6e20 7468 6520 7365 6e74 206f  ns on the sent o
-000486d0: 626a 6563 742c 2022 0a20 2020 2020 2020  bject, ".       
-000486e0: 2022 652e 672e 2072 6564 6163 7469 6e67   "e.g. redacting
-000486f0: 2f64 656c 6574 696e 6720 6974 2061 6674  /deleting it aft
-00048700: 6572 2061 6e20 6578 7069 7261 7469 6f6e  er an expiration
-00048710: 2074 696d 652c 2065 7463 2e22 2c0a 2020   time, etc.",.  
-00048720: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-00048730: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-00048740: 2023 2073 7461 7274 696e 6720 7769 7468   # starting with
-00048750: 2076 6572 7369 6f6e 2032 2e31 3920 222d   version 2.19 "-
-00048760: 7522 2068 6173 2062 6565 6e20 6d6f 7665  u" has been move
-00048770: 6420 746f 202d 2d75 7365 7221 0a20 2020  d to --user!.   
-00048780: 2020 2020 2022 2d2d 646f 776e 6c6f 6164       "--download
-00048790: 2d6d 6564 6961 222c 0a20 2020 2020 2020  -media",.       
-000487a0: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-000487b0: 2020 2064 6566 6175 6c74 3d22 222c 2020     default="",  
-000487c0: 2320 6966 202d 2d64 6f77 6e6c 6f61 642d  # if --download-
-000487d0: 6d65 6469 6120 6973 206e 6f74 2075 7365  media is not use
-000487e0: 640a 2020 2020 2020 2020 6163 7469 6f6e  d.        action
-000487f0: 3d22 7374 6f72 6522 2c0a 2020 2020 2020  ="store",.      
-00048800: 2020 6e61 7267 733d 223f 222c 2020 2320    nargs="?",  # 
-00048810: 6d61 6b65 7320 7468 6520 776f 7264 206f  makes the word o
-00048820: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
-00048830: 636f 6e73 743d 4d45 4449 415f 4449 525f  const=MEDIA_DIR_
-00048840: 4445 4641 554c 542c 2020 2320 7768 656e  DEFAULT,  # when
-00048850: 206f 7074 696f 6e20 6973 2075 7365 642c   option is used,
-00048860: 2062 7574 206e 6f20 6469 7220 6164 6465   but no dir adde
-00048870: 640a 2020 2020 2020 2020 6d65 7461 7661  d.        metava
-00048880: 723d 2244 4f57 4e4c 4f41 445f 4449 5245  r="DOWNLOAD_DIRE
-00048890: 4354 4f52 5922 2c0a 2020 2020 2020 2020  CTORY",.        
-000488a0: 6865 6c70 3d22 446f 776e 6c6f 6164 206d  help="Download m
-000488b0: 6564 6961 2066 696c 6573 2077 6869 6c65  edia files while
-000488c0: 206c 6973 7465 6e69 6e67 2e20 220a 2020   listening. ".  
-000488d0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-000488e0: 2049 6620 7365 7420 616e 6420 6c69 7374   If set and list
-000488f0: 656e 696e 672c 2022 0a20 2020 2020 2020  ening, ".       
-00048900: 2022 7468 656e 2070 726f 6772 616d 2077   "then program w
-00048910: 696c 6c20 646f 776e 6c6f 6164 2022 0a20  ill download ". 
-00048920: 2020 2020 2020 2022 7265 6365 6976 6564         "received
-00048930: 206d 6564 6961 2066 696c 6573 2028 652e   media files (e.
-00048940: 672e 2069 6d61 6765 2c20 6175 6469 6f2c  g. image, audio,
-00048950: 2076 6964 656f 2c20 7465 7874 2c20 5044   video, text, PD
-00048960: 4620 6669 6c65 7329 2e20 220a 2020 2020  F files). ".    
-00048970: 2020 2020 226d 6564 6961 2077 696c 6c20      "media will 
-00048980: 6265 2064 6f77 6e6c 6f61 6465 6420 746f  be downloaded to
-00048990: 206c 6f63 616c 2064 6972 6563 746f 7279   local directory
-000489a0: 2e20 220a 2020 2020 2020 2020 2242 7920  . ".        "By 
-000489b0: 6465 6661 756c 742c 206d 6564 6961 2077  default, media w
-000489c0: 696c 6c20 6265 2064 6f77 6e6c 6f61 6465  ill be downloade
-000489d0: 6420 746f 2022 0a20 2020 2020 2020 2066  d to ".        f
-000489e0: 2769 7320 227b 4d45 4449 415f 4449 525f  'is "{MEDIA_DIR_
-000489f0: 4445 4641 554c 547d 222e 2027 0a20 2020  DEFAULT}". '.   
-00048a00: 2020 2020 2022 596f 7520 6361 6e20 6f76       "You can ov
-00048a10: 6572 7772 6974 6520 6465 6661 756c 7420  erwrite default 
-00048a20: 7769 7468 2079 6f75 7220 7072 6566 6572  with your prefer
-00048a30: 7265 6420 6469 7265 6374 6f72 792e 2022  red directory. "
-00048a40: 0a20 2020 2020 2020 2022 4966 206d 6564  .        "If med
-00048a50: 6961 2069 7320 656e 6372 7970 7465 6420  ia is encrypted 
-00048a60: 6974 2077 696c 6c20 6265 2064 6563 7279  it will be decry
-00048a70: 7074 6564 2061 6e64 2073 746f 7265 6420  pted and stored 
-00048a80: 6465 6372 7970 7465 642e 2022 0a20 2020  decrypted. ".   
-00048a90: 2020 2020 2022 4279 2064 6566 6175 6c74       "By default
-00048aa0: 206d 6564 6961 2066 696c 6573 2077 696c   media files wil
-00048ab0: 6c20 6e6f 7420 6265 2064 6f77 6e6c 6f61  l not be downloa
-00048ac0: 6465 642e 222c 0a20 2020 2029 0a20 2020  ded.",.    ).   
-00048ad0: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-00048ae0: 280a 2020 2020 2020 2020 2320 222d 6f22  (.        # "-o"
-00048af0: 2c20 2320 696e 636f 6d70 6174 6962 6c65  , # incompatible
-00048b00: 2063 6861 6e67 6520 4465 6320 3230 3232   change Dec 2022
-00048b10: 2c20 2d6f 206d 6f76 6564 2074 6f20 2d2d  , -o moved to --
-00048b20: 6f75 7470 7574 0a20 2020 2020 2020 2022  output.        "
-00048b30: 2d2d 6f73 2d6e 6f74 6966 7922 2c0a 2020  --os-notify",.  
-00048b40: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
-00048b50: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
-00048b60: 7469 6f6e 3d22 7374 6f72 655f 7472 7565  tion="store_true
-00048b70: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-00048b80: 224e 6f74 6966 7920 6d65 206f 6620 6172  "Notify me of ar
-00048b90: 7269 7669 6e67 206d 6573 7361 6765 732e  riving messages.
-00048ba0: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
-00048bb0: 696c 733a 3a20 4966 2073 6574 2061 6e64  ils:: If set and
-00048bc0: 206c 6973 7465 6e69 6e67 2c20 220a 2020   listening, ".  
-00048bd0: 2020 2020 2020 2274 6865 6e20 7072 6f67        "then prog
-00048be0: 7261 6d20 7769 6c6c 2061 7474 656d 7074  ram will attempt
-00048bf0: 2074 6f20 7669 7375 616c 6c79 206e 6f74   to visually not
-00048c00: 6966 7920 6f66 2022 0a20 2020 2020 2020  ify of ".       
-00048c10: 2022 6172 7269 7669 6e67 206d 6573 7361   "arriving messa
-00048c20: 6765 7320 7468 726f 7567 6820 7468 6520  ges through the 
-00048c30: 6f70 6572 6174 696e 6720 7379 7374 656d  operating system
-00048c40: 2e20 220a 2020 2020 2020 2020 2242 7920  . ".        "By 
-00048c50: 6465 6661 756c 7420 7468 6572 6520 6973  default there is
-00048c60: 206e 6f20 6e6f 7469 6669 6361 7469 6f6e   no notification
-00048c70: 2076 6961 204f 532e 222c 0a20 2020 2029   via OS.",.    )
-00048c80: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
-00048c90: 6d65 6e74 280a 2020 2020 2020 2020 2320  ment(.        # 
-00048ca0: 7265 6d6f 7665 6420 222d 7822 2c20 7374  removed "-x", st
-00048cb0: 6172 7469 6e67 2076 322e 3231 202d 7820  arting v2.21 -x 
-00048cc0: 6973 206e 6f20 6c6f 6e67 6572 2073 7570  is no longer sup
-00048cd0: 706f 7274 6564 0a20 2020 2020 2020 2022  ported.        "
-00048ce0: 2d2d 7365 742d 6465 7669 6365 2d6e 616d  --set-device-nam
-00048cf0: 6522 2c0a 2020 2020 2020 2020 7265 7175  e",.        requ
-00048d00: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-00048d10: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
-00048d20: 2020 2020 2020 6465 6661 756c 743d 5345        default=SE
-00048d30: 545f 4445 5649 4345 5f4e 414d 455f 554e  T_DEVICE_NAME_UN
-00048d40: 5553 4544 5f44 4546 4155 4c54 2c20 2023  USED_DEFAULT,  #
-00048d50: 2077 6865 6e20 6f70 7469 6f6e 2069 736e   when option isn
-00048d60: 2774 2075 7365 640a 2020 2020 2020 2020  't used.        
-00048d70: 6d65 7461 7661 723d 2244 4556 4943 455f  metavar="DEVICE_
-00048d80: 4e41 4d45 222c 0a20 2020 2020 2020 2068  NAME",.        h
-00048d90: 656c 703d 2253 6574 206f 7220 7265 6e61  elp="Set or rena
-00048da0: 6d65 2074 6865 2063 7572 7265 6e74 2064  me the current d
-00048db0: 6576 6963 652e 2022 0a20 2020 2020 2020  evice. ".       
-00048dc0: 2022 4465 7461 696c 733a 3a20 5365 7420   "Details:: Set 
-00048dd0: 6f72 2072 656e 616d 6520 7468 6520 6375  or rename the cu
-00048de0: 7272 656e 7420 6465 7669 6365 2074 6f20  rrent device to 
-00048df0: 7468 6520 220a 2020 2020 2020 2020 2264  the ".        "d
-00048e00: 6576 6963 6520 6e61 6d65 2070 726f 7669  evice name provi
-00048e10: 6465 642e 2022 0a20 2020 2020 2020 2022  ded. ".        "
-00048e20: 5365 6e64 2c20 6c69 7374 656e 2061 6e64  Send, listen and
-00048e30: 2076 6572 6966 7920 6f70 6572 6174 696f   verify operatio
-00048e40: 6e73 2061 7265 2061 6c6c 6f77 6564 2077  ns are allowed w
-00048e50: 6865 6e20 220a 2020 2020 2020 2020 2272  hen ".        "r
-00048e60: 656e 616d 696e 6720 7468 6520 6465 7669  enaming the devi
-00048e70: 6365 2e22 2c0a 2020 2020 290a 2020 2020  ce.",.    ).    
-00048e80: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-00048e90: 0a20 2020 2020 2020 2022 2d2d 7365 742d  .        "--set-
-00048ea0: 6469 7370 6c61 792d 6e61 6d65 222c 0a20  display-name",. 
-00048eb0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00048ec0: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
-00048ed0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-00048ee0: 2064 6566 6175 6c74 3d53 4554 5f44 4953   default=SET_DIS
-00048ef0: 504c 4159 5f4e 414d 455f 554e 5553 4544  PLAY_NAME_UNUSED
-00048f00: 5f44 4546 4155 4c54 2c20 2023 2077 6865  _DEFAULT,  # whe
-00048f10: 6e20 6f70 7469 6f6e 2069 736e 2774 2075  n option isn't u
-00048f20: 7365 640a 2020 2020 2020 2020 6d65 7461  sed.        meta
-00048f30: 7661 723d 2244 4953 504c 4159 5f4e 414d  var="DISPLAY_NAM
-00048f40: 4522 2c0a 2020 2020 2020 2020 6865 6c70  E",.        help
-00048f50: 3d22 5365 7420 6f72 2072 656e 616d 6520  ="Set or rename 
-00048f60: 7468 6520 6469 7370 6c61 7920 6e61 6d65  the display name
-00048f70: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-00048f80: 6169 6c73 3a3a 2053 6574 206f 7220 7265  ails:: Set or re
-00048f90: 6e61 6d65 2074 6865 2064 6973 706c 6179  name the display
-00048fa0: 206e 616d 6520 220a 2020 2020 2020 2020   name ".        
-00048fb0: 2266 6f72 2074 6865 2063 7572 7265 6e74  "for the current
-00048fc0: 2075 7365 7220 746f 2074 6865 2022 0a20   user to the ". 
-00048fd0: 2020 2020 2020 2022 6469 7370 6c61 7920         "display 
-00048fe0: 6e61 6d65 2070 726f 7669 6465 642e 2022  name provided. "
-00048ff0: 0a20 2020 2020 2020 2022 5365 6e64 2c20  .        "Send, 
-00049000: 6c69 7374 656e 2061 6e64 2076 6572 6966  listen and verif
-00049010: 7920 6f70 6572 6174 696f 6e73 2061 7265  y operations are
-00049020: 2061 6c6c 6f77 6564 2077 6865 6e20 220a   allowed when ".
-00049030: 2020 2020 2020 2020 2273 6574 7469 6e67          "setting
-00049040: 2074 6865 2064 6973 706c 6179 206e 616d   the display nam
-00049050: 652e 2022 0a20 2020 2020 2020 2022 446f  e. ".        "Do
-00049060: 206e 6f74 2063 6f6e 6675 7365 2074 6869   not confuse thi
-00049070: 7320 6f70 7469 6f6e 2077 6974 6820 7468  s option with th
-00049080: 6520 6f70 7469 6f6e 2027 2d2d 6765 742d  e option '--get-
-00049090: 726f 6f6d 2d69 6e66 6f27 2022 0a20 2020  room-info' ".   
-000490a0: 2020 2020 2022 7768 6963 6820 6765 7473       "which gets
-000490b0: 2074 6865 2072 6f6f 6d20 6469 7370 6c61   the room displa
-000490c0: 7920 6e61 6d65 2c20 6e6f 7420 7468 6520  y name, not the 
-000490d0: 7573 6572 2064 6973 706c 6179 206e 616d  user display nam
-000490e0: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
-000490f0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00049100: 2020 2020 2020 2020 222d 2d67 6574 2d64          "--get-d
-00049110: 6973 706c 6179 2d6e 616d 6522 2c0a 2020  isplay-name",.  
-00049120: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
-00049130: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
-00049140: 7469 6f6e 3d22 7374 6f72 655f 7472 7565  tion="store_true
-00049150: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-00049160: 2247 6574 2074 6865 2064 6973 706c 6179  "Get the display
-00049170: 206e 616d 6520 6f66 2079 6f75 7273 656c   name of yoursel
-00049180: 662e 2022 0a20 2020 2020 2020 2022 4465  f. ".        "De
-00049190: 7461 696c 733a 3a20 4765 7420 7468 6520  tails:: Get the 
-000491a0: 6469 7370 6c61 7920 6e61 6d65 206f 6620  display name of 
-000491b0: 220a 2020 2020 2020 2020 6622 7b50 524f  ".        f"{PRO
-000491c0: 475f 5749 5448 4f55 545f 4558 547d 2028  G_WITHOUT_EXT} (
-000491d0: 6974 7365 6c66 292c 2022 0a20 2020 2020  itself), ".     
-000491e0: 2020 2022 6f72 206f 6620 6f6e 6520 6f72     "or of one or
-000491f0: 206d 756c 7469 706c 6520 7573 6572 732e   multiple users.
-00049200: 2053 7065 6369 6679 2075 7365 7228 7329   Specify user(s)
-00049210: 2077 6974 6820 7468 6520 220a 2020 2020   with the ".    
-00049220: 2020 2020 222d 2d75 7365 7220 6f70 7469      "--user opti
-00049230: 6f6e 2e20 4966 206e 6f20 7573 6572 2069  on. If no user i
-00049240: 7320 7370 6563 6966 6965 6420 6765 7420  s specified get 
-00049250: 7468 6520 6469 7370 6c61 7920 6e61 6d65  the display name
-00049260: 206f 6620 220a 2020 2020 2020 2020 2269   of ".        "i
-00049270: 7473 656c 662e 2022 0a20 2020 2020 2020  tself. ".       
-00049280: 2022 5365 6e64 2c20 6c69 7374 656e 2061   "Send, listen a
-00049290: 6e64 2076 6572 6966 7920 6f70 6572 6174  nd verify operat
-000492a0: 696f 6e73 2061 7265 2061 6c6c 6f77 6564  ions are allowed
-000492b0: 2077 6865 6e20 220a 2020 2020 2020 2020   when ".        
-000492c0: 2267 6574 7469 6e67 2064 6973 706c 6179  "getting display
-000492d0: 206e 616d 6528 7329 2e20 220a 2020 2020   name(s). ".    
-000492e0: 2020 2020 2244 6f20 6e6f 7420 636f 6e66      "Do not conf
-000492f0: 7573 6520 7468 6973 206f 7074 696f 6e20  use this option 
-00049300: 7769 7468 2074 6865 206f 7074 696f 6e20  with the option 
-00049310: 272d 2d67 6574 2d72 6f6f 6d2d 696e 666f  '--get-room-info
-00049320: 2720 220a 2020 2020 2020 2020 2277 6869  ' ".        "whi
-00049330: 6368 2067 6574 7320 7468 6520 726f 6f6d  ch gets the room
-00049340: 2064 6973 706c 6179 206e 616d 652c 206e   display name, n
-00049350: 6f74 2074 6865 2075 7365 7220 6469 7370  ot the user disp
-00049360: 6c61 7920 6e61 6d65 2e22 2c0a 2020 2020  lay name.",.    
-00049370: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-00049380: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-00049390: 2d2d 7365 742d 7072 6573 656e 6365 222c  --set-presence",
-000493a0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-000493b0: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-000493c0: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-000493d0: 2020 2023 2064 6566 6175 6c74 7320 746f     # defaults to
-000493e0: 204e 6f6e 6520 6966 206e 6f74 2075 7365   None if not use
-000493f0: 642c 2069 7320 7374 7220 6966 2075 7365  d, is str if use
-00049400: 640a 2020 2020 2020 2020 6d65 7461 7661  d.        metava
-00049410: 723d 224f 4e4c 494e 457c 4f46 464c 494e  r="ONLINE|OFFLIN
-00049420: 457c 554e 4156 4149 4c41 424c 4522 2c0a  E|UNAVAILABLE",.
-00049430: 2020 2020 2020 2020 6865 6c70 3d22 5365          help="Se
-00049440: 7420 796f 7572 2070 7265 7365 6e63 652e  t your presence.
-00049450: 2022 0a20 2020 2020 2020 2066 2244 6574   ".        f"Det
-00049460: 6169 6c73 3a3a 2053 6574 2070 7265 7365  ails:: Set prese
-00049470: 6e63 6520 6f66 207b 5052 4f47 5f57 4954  nce of {PROG_WIT
-00049480: 484f 5554 5f45 5854 7d20 746f 2074 6865  HOUT_EXT} to the
-00049490: 2067 6976 656e 2076 616c 7565 2e20 220a   given value. ".
-000494a0: 2020 2020 2020 2020 224d 7573 7420 6265          "Must be
-000494b0: 206f 6e65 206f 6620 7468 6573 6520 7661   one of these va
-000494c0: 6c75 6573 3a20 e280 9c6f 6e6c 696e 65e2  lues: ...online.
-000494d0: 809d 2c20 e280 9c6f 6666 6c69 6e65 e280  .., ...offline..
-000494e0: 9d2c 20e2 809c 756e 6176 6169 6c61 626c  ., ...unavailabl
-000494f0: 65e2 809d 2e20 220a 2020 2020 2020 2020  e.... ".        
-00049500: 224f 7468 6572 7769 7365 2061 6e20 6572  "Otherwise an er
-00049510: 726f 7220 7769 6c6c 2062 6520 7072 6f64  ror will be prod
-00049520: 7563 6564 2e22 2c0a 2020 2020 290a 2020  uced.",.    ).  
-00049530: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-00049540: 7428 0a20 2020 2020 2020 2022 2d2d 6765  t(.        "--ge
-00049550: 742d 7072 6573 656e 6365 222c 0a20 2020  t-presence",.   
-00049560: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00049570: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00049580: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
-00049590: 2c0a 2020 2020 2020 2020 2320 6465 6661  ,.        # defa
-000495a0: 756c 7473 2074 6f20 4661 6c73 6520 6966  ults to False if
-000495b0: 206e 6f74 2075 7365 640a 2020 2020 2020   not used.      
-000495c0: 2020 6865 6c70 3d22 4765 7420 796f 7572    help="Get your
-000495d0: 2070 7265 7365 6e63 652e 2022 0a20 2020   presence. ".   
-000495e0: 2020 2020 2066 2244 6574 6169 6c73 3a3a       f"Details::
-000495f0: 2047 6574 2070 7265 7365 6e63 6520 6f66   Get presence of
-00049600: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
-00049610: 5854 7d20 2869 7473 656c 6629 2c20 220a  XT} (itself), ".
-00049620: 2020 2020 2020 2020 226f 7220 6f66 206f          "or of o
-00049630: 6e65 206f 7220 6d75 6c74 6970 6c65 2075  ne or multiple u
-00049640: 7365 7273 2e20 5370 6563 6966 7920 7573  sers. Specify us
-00049650: 6572 2873 2920 7769 7468 2074 6865 2022  er(s) with the "
-00049660: 0a20 2020 2020 2020 2022 2d2d 7573 6572  .        "--user
-00049670: 206f 7074 696f 6e2e 2049 6620 6e6f 2075   option. If no u
-00049680: 7365 7220 6973 2073 7065 6369 6669 6564  ser is specified
-00049690: 2067 6574 2074 6865 2070 7265 7365 6e63   get the presenc
-000496a0: 6520 6f66 2022 0a20 2020 2020 2020 2022  e of ".        "
-000496b0: 6974 7365 6c66 2e20 220a 2020 2020 2020  itself. ".      
-000496c0: 2020 2253 656e 642c 206c 6973 7465 6e20    "Send, listen 
-000496d0: 616e 6420 7665 7269 6679 206f 7065 7261  and verify opera
-000496e0: 7469 6f6e 7320 6172 6520 616c 6c6f 7765  tions are allowe
-000496f0: 6420 7768 656e 2022 0a20 2020 2020 2020  d when ".       
-00049700: 2022 6765 7474 696e 6720 7072 6573 656e   "getting presen
-00049710: 6365 2873 292e 222c 0a20 2020 2029 0a20  ce(s).",.    ). 
-00049720: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-00049730: 6e74 280a 2020 2020 2020 2020 222d 2d75  nt(.        "--u
-00049740: 706c 6f61 6422 2c0a 2020 2020 2020 2020  pload",.        
-00049750: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-00049760: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
-00049770: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
-00049780: 206e 6172 6773 3d22 2b22 2c0a 2020 2020   nargs="+",.    
-00049790: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
-000497a0: 2020 2020 2020 6d65 7461 7661 723d 2246        metavar="F
-000497b0: 494c 4522 2c0a 2020 2020 2020 2020 6865  ILE",.        he
-000497c0: 6c70 3d22 5570 6c6f 6164 206f 6e65 206f  lp="Upload one o
-000497d0: 7220 6d75 6c74 6970 6c65 2066 696c 6573  r multiple files
-000497e0: 2074 6f20 7468 6520 636f 6e74 656e 7420   to the content 
-000497f0: 7265 706f 7369 746f 7279 2e20 220a 2020  repository. ".  
-00049800: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-00049810: 2022 0a20 2020 2020 2020 2022 5468 6520   ".        "The 
-00049820: 6669 6c65 7320 7769 6c6c 2062 6520 6769  files will be gi
-00049830: 7665 6e20 6120 4d61 7472 6978 2055 5249  ven a Matrix URI
-00049840: 2061 6e64 2022 0a20 2020 2020 2020 2022   and ".        "
-00049850: 7374 6f72 6564 206f 6e20 7468 6520 7365  stored on the se
-00049860: 7276 6572 2e20 2d2d 7570 6c6f 6164 2061  rver. --upload a
-00049870: 6c6c 6f77 7320 7468 6520 6f70 7469 6f6e  llows the option
-00049880: 616c 2061 7267 756d 656e 7420 220a 2020  al argument ".  
-00049890: 2020 2020 2020 222d 2d70 6c61 696e 2074        "--plain t
-000498a0: 6f20 736b 6970 2065 6e63 7279 7074 696f  o skip encryptio
-000498b0: 6e20 666f 7220 7570 6c6f 6164 2e20 220a  n for upload. ".
-000498c0: 2020 2020 2020 2020 2253 6565 2074 6573          "See tes
-000498d0: 7473 2f74 6573 742d 7570 6c6f 6164 2e73  ts/test-upload.s
-000498e0: 6820 666f 7220 616e 2065 7861 6d70 6c65  h for an example
-000498f0: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
-00049900: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
-00049910: 2020 2020 2020 2022 2d2d 646f 776e 6c6f         "--downlo
-00049920: 6164 222c 0a20 2020 2020 2020 2072 6571  ad",.        req
-00049930: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-00049940: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-00049950: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-00049960: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-00049970: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-00049980: 2020 206d 6574 6176 6172 3d22 4d58 435f     metavar="MXC_
-00049990: 5552 4922 2c0a 2020 2020 2020 2020 6865  URI",.        he
-000499a0: 6c70 3d22 446f 776e 6c6f 6164 206f 6e65  lp="Download one
-000499b0: 206f 7220 6d75 6c74 6970 6c65 2066 696c   or multiple fil
-000499c0: 6573 2066 726f 6d20 7468 6520 636f 6e74  es from the cont
-000499d0: 656e 7420 7265 706f 7369 746f 7279 2e20  ent repository. 
-000499e0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-000499f0: 6c73 3a3a 2022 0a20 2020 2020 2020 2022  ls:: ".        "
-00049a00: 596f 7520 6d75 7374 2070 726f 7669 6465  You must provide
-00049a10: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-00049a20: 204d 6174 7269 7820 5552 4973 2028 4d58   Matrix URIs (MX
-00049a30: 4373 2920 7768 6963 6820 6172 6520 220a  Cs) which are ".
-00049a40: 2020 2020 2020 2020 2273 7472 696e 6773          "strings
-00049a50: 206c 696b 6520 220a 2020 2020 2020 2020   like ".        
-00049a60: 2274 6869 7320 276d 7863 3a2f 2f65 7861  "this 'mxc://exa
-00049a70: 6d70 6c65 2e63 6f6d 2f53 6f6d 6553 7472  mple.com/SomeStr
-00049a80: 616e 6765 5572 694b 6579 272e 2049 6620  angeUriKey'. If 
-00049a90: 666f 756e 6420 7468 6579 2077 696c 6c20  found they will 
-00049aa0: 220a 2020 2020 2020 2020 2262 6520 646f  ".        "be do
-00049ab0: 776e 6c6f 6164 6564 2c20 6465 6372 7970  wnloaded, decryp
-00049ac0: 7465 642c 2061 6e64 2073 746f 7265 6420  ted, and stored 
-00049ad0: 696e 206c 6f63 616c 2066 696c 6573 2e20  in local files. 
-00049ae0: 220a 2020 2020 2020 2020 2249 6620 6669  ".        "If fi
-00049af0: 6c65 206e 616d 6573 2061 7265 2073 7065  le names are spe
-00049b00: 6369 6669 6564 2077 6974 6820 2d2d 6669  cified with --fi
-00049b10: 6c65 2d6e 616d 6520 7468 6520 646f 776e  le-name the down
-00049b20: 6c6f 6164 7320 220a 2020 2020 2020 2020  loads ".        
-00049b30: 2277 696c 6c20 6265 2073 6176 6564 2077  "will be saved w
-00049b40: 6974 6820 7468 6573 6520 6669 6c65 206e  ith these file n
-00049b50: 616d 6573 2e20 4966 202d 2d66 696c 652d  ames. If --file-
-00049b60: 6e61 6d65 2069 7320 6e6f 7420 220a 2020  name is not ".  
-00049b70: 2020 2020 2020 2273 7065 6369 6669 6564        "specified
-00049b80: 2074 6865 206f 7269 6769 6e61 6c20 6669   the original fi
-00049b90: 6c65 206e 616d 6520 6672 6f6d 2074 6865  le name from the
-00049ba0: 2075 706c 6f61 6420 7769 6c6c 2062 6520   upload will be 
-00049bb0: 7573 6564 2e20 220a 2020 2020 2020 2020  used. ".        
-00049bc0: 2249 6620 6e65 6974 6865 7220 7370 6563  "If neither spec
-00049bd0: 6966 6965 6420 6e6f 7220 6176 6169 6c61  ified nor availa
-00049be0: 626c 6520 6f6e 2073 6572 7665 722c 2074  ble on server, t
-00049bf0: 6865 6e20 7468 6520 6669 6c65 2022 0a20  hen the file ". 
-00049c00: 2020 2020 2020 2066 226e 616d 6520 6f66         f"name of
-00049c10: 206c 6173 7420 7265 736f 7274 2027 6d78   last resort 'mx
-00049c20: 632d 3c6d 7863 2d69 643e 2720 7769 6c6c  c-<mxc-id>' will
-00049c30: 2062 6520 7573 6564 2e20 220a 2020 2020   be used. ".    
-00049c40: 2020 2020 6622 4966 2061 2066 696c 6520      f"If a file 
-00049c50: 6e61 6d65 2069 6e20 2d2d 6669 6c65 2d6e  name in --file-n
-00049c60: 616d 6520 636f 6e74 6169 6e73 2074 6865  ame contains the
-00049c70: 2070 6c61 6365 686f 6c64 6572 2022 0a20   placeholder ". 
-00049c80: 2020 2020 2020 2066 227b 4d58 435f 4944         f"{MXC_ID
-00049c90: 5f50 4c41 4345 484f 4c44 4552 7d2c 2069  _PLACEHOLDER}, i
-00049ca0: 7420 7769 6c6c 2062 6520 7265 706c 6163  t will be replac
-00049cb0: 6564 2077 6974 6820 7468 6520 6d78 632d  ed with the mxc-
-00049cc0: 6964 2e20 220a 2020 2020 2020 2020 2249  id. ".        "I
-00049cd0: 6620 6120 6669 6c65 206e 616d 6520 6973  f a file name is
-00049ce0: 2073 7065 6369 6669 6564 2061 7320 656d   specified as em
-00049cf0: 7074 7920 7374 7269 6e67 2069 6e20 2d2d  pty string in --
-00049d00: 6669 6c65 2d6e 616d 652c 2074 6865 6e20  file-name, then 
-00049d10: 220a 2020 2020 2020 2020 2261 6c73 6f20  ".        "also 
-00049d20: 7468 6520 6e61 6d65 2027 6d78 632d 3c6d  the name 'mxc-<m
-00049d30: 7863 2d69 643e 2720 7769 6c6c 2062 6520  xc-id>' will be 
-00049d40: 7573 6564 2e20 220a 2020 2020 2020 2020  used. ".        
-00049d50: 2242 7920 6465 6661 756c 742c 2074 6865  "By default, the
-00049d60: 2075 706c 6f61 6420 7761 7320 656e 6372   upload was encr
-00049d70: 7970 7465 6420 736f 2061 2064 6563 7279  ypted so a decry
-00049d80: 7074 696f 6e20 6469 6374 696f 6e61 7279  ption dictionary
-00049d90: 2022 0a20 2020 2020 2020 2022 6d75 7374   ".        "must
-00049da0: 2062 6520 7072 6f76 6964 6564 2074 6f20   be provided to 
-00049db0: 6465 6372 7970 7420 7468 6520 6461 7461  decrypt the data
-00049dc0: 2e20 5370 6563 6966 7920 6f6e 6520 6f72  . Specify one or
-00049dd0: 206d 756c 7469 706c 6520 220a 2020 2020   multiple ".    
-00049de0: 2020 2020 2264 6563 7279 7074 696f 6e20      "decryption 
-00049df0: 6b65 7973 2022 0a20 2020 2020 2020 2022  keys ".        "
-00049e00: 7769 7468 202d 2d6b 6579 2d64 6963 742e  with --key-dict.
-00049e10: 2049 6620 2d2d 6b65 792d 6469 6374 2069   If --key-dict i
-00049e20: 7320 6e6f 7420 7365 742c 206e 6f74 2064  s not set, not d
-00049e30: 6563 7279 7074 696f 6e20 6973 2022 0a20  ecryption is ". 
-00049e40: 2020 2020 2020 2022 6174 7465 6d70 7465         "attempte
-00049e50: 643b 2061 6e64 2074 6865 2064 6174 6120  d; and the data 
-00049e60: 6d69 6768 7420 6265 2073 746f 7265 6420  might be stored 
-00049e70: 696e 2065 6e63 7279 7074 6564 2066 6173  in encrypted fas
-00049e80: 6869 6f6e 2c20 220a 2020 2020 2020 2020  hion, ".        
-00049e90: 226f 7220 6d69 6768 7420 6265 2070 6c61  "or might be pla
-00049ea0: 696e 2d74 6578 7420 6966 2074 6865 202d  in-text if the -
-00049eb0: 2d75 706c 6f61 6420 736b 6970 7065 6420  -upload skipped 
-00049ec0: 656e 6372 7970 7469 6f6e 2077 6974 6820  encryption with 
-00049ed0: 220a 2020 2020 2020 2020 222d 2d70 6c61  ".        "--pla
-00049ee0: 696e 2e20 220a 2020 2020 2020 2020 2253  in. ".        "S
-00049ef0: 6565 2074 6573 7473 2f74 6573 742d 7570  ee tests/test-up
-00049f00: 6c6f 6164 2e73 6820 666f 7220 616e 2065  load.sh for an e
-00049f10: 7861 6d70 6c65 2e22 2c0a 2020 2020 290a  xample.",.    ).
-00049f20: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
-00049f30: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
-00049f40: 6465 6c65 7465 2d6d 7863 222c 0a20 2020  delete-mxc",.   
-00049f50: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-00049f60: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-00049f70: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-00049f80: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-00049f90: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-00049fa0: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-00049fb0: 6172 3d22 4d58 435f 5552 4922 2c0a 2020  ar="MXC_URI",.  
-00049fc0: 2020 2020 2020 6865 6c70 3d22 4465 6c65        help="Dele
-00049fd0: 7465 206f 6e65 206f 7220 6d75 6c74 6970  te one or multip
-00049fe0: 6c65 206f 626a 6563 7473 2066 726f 6d20  le objects from 
-00049ff0: 7468 6520 636f 6e74 656e 7420 7265 706f  the content repo
-0004a000: 7369 746f 7279 2e20 220a 2020 2020 2020  sitory. ".      
-0004a010: 2020 2244 6574 6169 6c73 3a3a 2059 6f75    "Details:: You
-0004a020: 206d 7573 7420 7072 6f76 6964 6520 6f6e   must provide on
-0004a030: 6520 6f72 206d 756c 7469 706c 6520 4d61  e or multiple Ma
-0004a040: 7472 6978 2055 5249 7320 284d 5843 2920  trix URIs (MXC) 
-0004a050: 220a 2020 2020 2020 2020 2277 6869 6368  ".        "which
-0004a060: 2061 7265 2073 7472 696e 6773 206c 696b   are strings lik
-0004a070: 6520 220a 2020 2020 2020 2020 2274 6869  e ".        "thi
-0004a080: 7320 276d 7863 3a2f 2f65 7861 6d70 6c65  s 'mxc://example
-0004a090: 2e63 6f6d 2f53 6f6d 6553 7472 616e 6765  .com/SomeStrange
-0004a0a0: 5572 694b 6579 272e 2041 6c74 6572 6e61  UriKey'. Alterna
-0004a0b0: 7469 7665 6c79 2c20 796f 7520 220a 2020  tively, you ".  
-0004a0c0: 2020 2020 2020 2263 616e 206a 7573 7420        "can just 
-0004a0d0: 7072 6f76 6964 6520 7468 6520 4d58 4320  provide the MXC 
-0004a0e0: 6964 2c20 692e 652e 2074 6865 2070 6172  id, i.e. the par
-0004a0f0: 7420 6166 7465 7220 7468 6520 6c61 7374  t after the last
-0004a100: 2073 6c61 7368 2e20 220a 2020 2020 2020   slash. ".      
-0004a110: 2020 2249 6620 666f 756e 6420 7468 6579    "If found they
-0004a120: 2028 692e 652e 2074 6865 2066 696c 6573   (i.e. the files
-0004a130: 2074 6865 7920 7265 7072 6573 656e 7429   they represent)
-0004a140: 2077 696c 6c20 220a 2020 2020 2020 2020   will ".        
-0004a150: 2262 6520 6465 6c65 7465 6420 6672 6f6d  "be deleted from
-0004a160: 2074 6865 2073 6572 7665 7220 6461 7461   the server data
-0004a170: 6261 7365 2e20 496e 206f 7264 6572 2074  base. In order t
-0004a180: 6f20 6465 6c65 7465 206f 626a 6563 7473  o delete objects
-0004a190: 2022 0a20 2020 2020 2020 2022 6f6e 6520   ".        "one 
-0004a1a0: 6d75 7374 2068 6176 6520 7365 7276 6572  must have server
-0004a1b0: 2061 646d 696e 2070 6572 6d69 7373 696f   admin permissio
-0004a1c0: 6e73 2e20 4861 7669 6e67 206f 6e6c 7920  ns. Having only 
-0004a1d0: 726f 6f6d 2061 646d 696e 2022 0a20 2020  room admin ".   
-0004a1e0: 2020 2020 2022 7065 726d 6973 7369 6f6e       "permission
-0004a1f0: 7320 6973 206e 6f74 2073 7566 6669 6369  s is not suffici
-0004a200: 656e 7420 616e 6420 6974 2077 696c 6c20  ent and it will 
-0004a210: 6661 696c 2e20 220a 2020 2020 2020 2020  fail. ".        
-0004a220: 2252 6561 6420 220a 2020 2020 2020 2020  "Read ".        
-0004a230: 2268 7474 7073 3a2f 2f6d 6174 7269 782d  "https://matrix-
-0004a240: 6f72 672e 6769 7468 7562 2e69 6f2f 7379  org.github.io/sy
-0004a250: 6e61 7073 652f 220a 2020 2020 2020 2020  napse/".        
-0004a260: 226c 6174 6573 742f 7573 6167 652f 6164  "latest/usage/ad
-0004a270: 6d69 6e69 7374 7261 7469 6f6e 2f61 646d  ministration/adm
-0004a280: 696e 5f61 7069 2f20 220a 2020 2020 2020  in_api/ ".      
-0004a290: 2020 2266 6f72 206c 6561 726e 696e 6720    "for learning 
-0004a2a0: 686f 7720 746f 2073 6574 2073 6572 7665  how to set serve
-0004a2b0: 7220 6164 6d69 6e20 7065 726d 6973 7369  r admin permissi
-0004a2c0: 6f6e 7320 6f6e 2074 6865 2022 0a20 2020  ons on the ".   
-0004a2d0: 2020 2020 2022 7365 7276 6572 2e20 416c       "server. Al
-0004a2e0: 7465 726e 6174 6976 656c 792c 2061 6e64  ternatively, and
-0004a2f0: 206f 7074 696f 6e61 6c6c 792c 206f 6e65   optionally, one
-0004a300: 2063 616e 2073 7065 6369 6679 2022 0a20   can specify ". 
-0004a310: 2020 2020 2020 2022 616e 2061 6363 6573         "an acces
-0004a320: 7320 746f 6b65 6e20 7768 6963 6820 6861  s token which ha
-0004a330: 7320 7365 7276 6572 2061 646d 696e 2070  s server admin p
-0004a340: 6572 6d69 7373 696f 6e73 2077 6974 6820  ermissions with 
-0004a350: 7468 6520 220a 2020 2020 2020 2020 222d  the ".        "-
-0004a360: 2d61 6363 6573 732d 746f 6b65 6e20 6172  -access-token ar
-0004a370: 6775 6d65 6e74 2e20 220a 2020 2020 2020  gument. ".      
-0004a380: 2020 2253 6565 2074 6573 7473 2f74 6573    "See tests/tes
-0004a390: 742d 7570 6c6f 6164 2e73 6820 666f 7220  t-upload.sh for 
-0004a3a0: 616e 2065 7861 6d70 6c65 2e22 2c0a 2020  an example.",.  
-0004a3b0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-0004a3c0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-0004a3d0: 2022 2d2d 6465 6c65 7465 2d6d 7863 2d62   "--delete-mxc-b
-0004a3e0: 6566 6f72 6522 2c0a 2020 2020 2020 2020  efore",.        
-0004a3f0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-0004a400: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
-0004a410: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
-0004a420: 206e 6172 6773 3d22 2b22 2c0a 2020 2020   nargs="+",.    
-0004a430: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
-0004a440: 2020 2020 2020 6d65 7461 7661 723d 2254        metavar="T
-0004a450: 494d 4553 5441 4d50 222c 0a20 2020 2020  IMESTAMP",.     
-0004a460: 2020 2068 656c 703d 2244 656c 6574 6520     help="Delete 
-0004a470: 6f6c 6420 6f62 6a65 6374 7320 6672 6f6d  old objects from
-0004a480: 2074 6865 2063 6f6e 7465 6e74 2072 6570   the content rep
-0004a490: 6f73 6974 6f72 7922 0a20 2020 2020 2020  ository".       
-0004a4a0: 2022 4465 7461 696c 733a 3a20 4465 6c65   "Details:: Dele
-0004a4b0: 7465 2066 696c 6573 2066 726f 6d20 7468  te files from th
-0004a4c0: 6520 636f 6e74 656e 7420 7265 706f 7369  e content reposi
-0004a4d0: 746f 7279 2022 0a20 2020 2020 2020 2022  tory ".        "
-0004a4e0: 7468 6174 2061 7265 206f 6c64 6572 2074  that are older t
-0004a4f0: 6861 6e20 6120 6769 7665 6e20 7469 6d65  han a given time
-0004a500: 7374 616d 702e 2022 0a20 2020 2020 2020  stamp. ".       
-0004a510: 2022 4974 2069 7320 7468 6520 7469 6d65   "It is the time
-0004a520: 7374 616d 7020 6f66 206c 6173 7420 6163  stamp of last ac
-0004a530: 6365 7373 2c20 6e6f 7420 7468 6520 7469  cess, not the ti
-0004a540: 6d65 7374 616d 7020 7768 656e 2022 0a20  mestamp when ". 
-0004a550: 2020 2020 2020 2022 7468 6520 6669 6c65         "the file
-0004a560: 2077 6173 2063 7265 6174 6564 2e20 220a   was created. ".
-0004a570: 2020 2020 2020 2020 2241 6464 6974 696f          "Additio
-0004a580: 6e61 6c6c 7920 796f 7520 6361 6e20 7370  nally you can sp
-0004a590: 6563 6966 7920 6120 7369 7a65 2069 6e20  ecify a size in 
-0004a5a0: 6279 7465 7320 746f 2069 6e64 6963 6174  bytes to indicat
-0004a5b0: 6520 220a 2020 2020 2020 2020 2274 6861  e ".        "tha
-0004a5c0: 7420 6f6e 6c79 2066 696c 6573 206f 6c64  t only files old
-0004a5d0: 6572 2074 6861 6e20 7469 6d65 7374 616d  er than timestam
-0004a5e0: 7020 616e 6420 6c61 7267 6572 2074 6861  p and larger tha
-0004a5f0: 6e20 7369 7a65 2022 0a20 2020 2020 2020  n size ".       
-0004a600: 2022 7769 6c6c 2062 6520 6465 6c65 7465   "will be delete
-0004a610: 642e 2022 0a20 2020 2020 2020 2022 596f  d. ".        "Yo
-0004a620: 7520 6d75 7374 2070 726f 7669 6465 2061  u must provide a
-0004a630: 2074 696d 6573 7461 6d70 206f 6620 7468   timestamp of th
-0004a640: 6520 666f 6c6c 6f77 696e 6720 666f 726d  e following form
-0004a650: 6174 3a20 220a 2020 2020 2020 2020 2227  at: ".        "'
-0004a660: 4444 2e4d 4d2e 5959 5959 2048 483a 4d4d  DD.MM.YYYY HH:MM
-0004a670: 3a53 5327 206c 696b 6520 2732 302e 3031  :SS' like '20.01
-0004a680: 2e32 3032 3220 3139 3a33 383a 3432 2720  .2022 19:38:42' 
-0004a690: 666f 7220 4a61 6e75 6172 7920 3230 2c20  for January 20, 
-0004a6a0: 220a 2020 2020 2020 2020 2232 3032 322c  ".        "2022,
-0004a6b0: 2037 706d 2033 386d 696e 2034 3273 6563   7pm 38min 42sec
-0004a6c0: 2e20 220a 2020 2020 2020 2020 2246 696c  . ".        "Fil
-0004a6d0: 6573 2074 6861 7420 6172 6520 7374 696c  es that are stil
-0004a6e0: 6c20 7573 6564 2069 6e20 696d 6167 6520  l used in image 
-0004a6f0: 6461 7461 2028 652e 6720 7573 6572 2070  data (e.g user p
-0004a700: 726f 6669 6c65 2c20 220a 2020 2020 2020  rofile, ".      
-0004a710: 2020 2272 6f6f 6d20 6176 6174 6172 2920    "room avatar) 
-0004a720: 7769 6c6c 206e 6f74 2062 6520 6465 6c65  will not be dele
-0004a730: 7465 6420 6672 6f6d 2074 6865 2073 6572  ted from the ser
-0004a740: 7665 7220 6461 7461 6261 7365 2e20 220a  ver database. ".
-0004a750: 2020 2020 2020 2020 2249 6e20 6f72 6465          "In orde
-0004a760: 7220 746f 2064 656c 6574 6520 6f62 6a65  r to delete obje
-0004a770: 6374 7320 220a 2020 2020 2020 2020 226f  cts ".        "o
-0004a780: 6e65 206d 7573 7420 6861 7665 2073 6572  ne must have ser
-0004a790: 7665 7220 6164 6d69 6e20 7065 726d 6973  ver admin permis
-0004a7a0: 7369 6f6e 732e 2048 6176 696e 6720 6f6e  sions. Having on
-0004a7b0: 6c79 2072 6f6f 6d20 6164 6d69 6e20 220a  ly room admin ".
-0004a7c0: 2020 2020 2020 2020 2270 6572 6d69 7373          "permiss
-0004a7d0: 696f 6e73 2069 7320 6e6f 7420 7375 6666  ions is not suff
-0004a7e0: 6963 6965 6e74 2061 6e64 2069 7420 7769  icient and it wi
-0004a7f0: 6c6c 2066 6169 6c2e 2022 0a20 2020 2020  ll fail. ".     
-0004a800: 2020 2022 5265 6164 2022 0a20 2020 2020     "Read ".     
-0004a810: 2020 2022 6874 7470 733a 2f2f 6d61 7472     "https://matr
-0004a820: 6978 2d6f 7267 2e67 6974 6875 622e 696f  ix-org.github.io
-0004a830: 2f73 796e 6170 7365 2f22 0a20 2020 2020  /synapse/".     
-0004a840: 2020 2022 6c61 7465 7374 2f75 7361 6765     "latest/usage
-0004a850: 2f61 646d 696e 6973 7472 6174 696f 6e2f  /administration/
-0004a860: 6164 6d69 6e5f 6170 692f 2022 0a20 2020  admin_api/ ".   
-0004a870: 2020 2020 2022 666f 7220 6c65 6172 6e69       "for learni
-0004a880: 6e67 2068 6f77 2074 6f20 7365 7420 7365  ng how to set se
-0004a890: 7276 6572 2061 646d 696e 2070 6572 6d69  rver admin permi
-0004a8a0: 7373 696f 6e73 206f 6e20 7468 6520 220a  ssions on the ".
-0004a8b0: 2020 2020 2020 2020 2273 6572 7665 722e          "server.
-0004a8c0: 2041 6c74 6572 6e61 7469 7665 6c79 2c20   Alternatively, 
-0004a8d0: 616e 6420 6f70 7469 6f6e 616c 6c79 2c20  and optionally, 
-0004a8e0: 6f6e 6520 6361 6e20 7370 6563 6966 7920  one can specify 
-0004a8f0: 220a 2020 2020 2020 2020 2261 6e20 6163  ".        "an ac
-0004a900: 6365 7373 2074 6f6b 656e 2077 6869 6368  cess token which
-0004a910: 2068 6173 2073 6572 7665 7220 6164 6d69   has server admi
-0004a920: 6e20 7065 726d 6973 7369 6f6e 7320 7769  n permissions wi
-0004a930: 7468 2074 6865 2022 0a20 2020 2020 2020  th the ".       
-0004a940: 2022 2d2d 6163 6365 7373 2d74 6f6b 656e   "--access-token
-0004a950: 2061 7267 756d 656e 742e 2022 0a20 2020   argument. ".   
-0004a960: 2020 2020 2022 5365 6520 7465 7374 732f       "See tests/
-0004a970: 7465 7374 2d75 706c 6f61 642e 7368 2066  test-upload.sh f
-0004a980: 6f72 2061 6e20 6578 616d 706c 652e 222c  or an example.",
-0004a990: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-0004a9a0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-0004a9b0: 2020 2020 2320 6e6f 2073 696e 676c 6520      # no single 
-0004a9c0: 6368 6172 2066 6c61 670a 2020 2020 2020  char flag.      
-0004a9d0: 2020 222d 2d6a 6f69 6e65 642d 726f 6f6d    "--joined-room
-0004a9e0: 7322 2c0a 2020 2020 2020 2020 7265 7175  s",.        requ
-0004a9f0: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004aa00: 2020 2020 6163 7469 6f6e 3d22 7374 6f72      action="stor
-0004aa10: 655f 7472 7565 222c 0a20 2020 2020 2020  e_true",.       
-0004aa20: 2068 656c 703d 2250 7269 6e74 2074 6865   help="Print the
-0004aa30: 206c 6973 7420 6f66 206a 6f69 6e65 6420   list of joined 
-0004aa40: 726f 6f6d 732e 2022 0a20 2020 2020 2020  rooms. ".       
-0004aa50: 2022 4465 7461 696c 733a 3a20 416c 6c20   "Details:: All 
-0004aa60: 726f 6f6d 7320 7468 6174 2079 6f75 2061  rooms that you a
-0004aa70: 7265 2061 2022 0a20 2020 2020 2020 2022  re a ".        "
-0004aa80: 6d65 6d62 6572 206f 6620 7769 6c6c 2062  member of will b
-0004aa90: 6520 7072 696e 7465 642c 206f 6e65 2072  e printed, one r
-0004aaa0: 6f6f 6d20 7065 7220 6c69 6e65 2e22 2c0a  oom per line.",.
-0004aab0: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-0004aac0: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-0004aad0: 2020 2023 206e 6f20 7369 6e67 6c65 2063     # no single c
-0004aae0: 6861 7220 666c 6167 0a20 2020 2020 2020  har flag.       
-0004aaf0: 2022 2d2d 6a6f 696e 6564 2d6d 656d 6265   "--joined-membe
-0004ab00: 7273 222c 0a20 2020 2020 2020 2072 6571  rs",.        req
-0004ab10: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-0004ab20: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-0004ab30: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-0004ab40: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
-0004ab50: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
-0004ab60: 2020 206d 6574 6176 6172 3d22 524f 4f4d     metavar="ROOM
-0004ab70: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-0004ab80: 2250 7269 6e74 2074 6865 206c 6973 7420  "Print the list 
-0004ab90: 6f66 206a 6f69 6e65 6420 6d65 6d62 6572  of joined member
-0004aba0: 7320 666f 7220 6f6e 6520 6f72 206d 756c  s for one or mul
-0004abb0: 7469 706c 6520 726f 6f6d 732e 2022 0a20  tiple rooms. ". 
-0004abc0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-0004abd0: 3a20 4966 2079 6f75 2077 616e 7420 746f  : If you want to
-0004abe0: 2070 7269 6e74 2074 6865 206a 6f69 6e65   print the joine
-0004abf0: 6420 6d65 6d62 6572 7320 6f66 2061 6c6c  d members of all
-0004ac00: 2072 6f6f 6d73 2074 6861 7420 220a 2020   rooms that ".  
-0004ac10: 2020 2020 2020 2279 6f75 2061 7265 206d        "you are m
-0004ac20: 656d 6265 7220 6f66 2c20 7468 656e 2075  ember of, then u
-0004ac30: 7365 2074 6865 2073 7065 6369 616c 2063  se the special c
-0004ac40: 6861 7261 6374 6572 2027 2a27 2e22 2c0a  haracter '*'.",.
-0004ac50: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-0004ac60: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-0004ac70: 2020 2022 2d2d 6d78 632d 746f 2d68 7474     "--mxc-to-htt
-0004ac80: 7022 2c0a 2020 2020 2020 2020 7265 7175  p",.        requ
-0004ac90: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004aca0: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-0004acb0: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-0004acc0: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
-0004acd0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0004ace0: 2020 6d65 7461 7661 723d 224d 5843 5f55    metavar="MXC_U
-0004acf0: 5249 222c 0a20 2020 2020 2020 2068 656c  RI",.        hel
-0004ad00: 703d 2243 6f6e 7665 7274 204d 5843 2055  p="Convert MXC U
-0004ad10: 5249 7320 746f 2048 5454 5020 5552 4c73  RIs to HTTP URLs
-0004ad20: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-0004ad30: 6169 6c73 3a3a 2043 6f6e 7665 7274 206f  ails:: Convert o
-0004ad40: 6e65 206f 7220 6d6f 7265 206d 6174 7269  ne or more matri
-0004ad50: 7820 636f 6e74 656e 7420 5552 4973 2074  x content URIs t
-0004ad60: 6f20 7468 6520 220a 2020 2020 2020 2020  o the ".        
-0004ad70: 2263 6f72 7265 7370 6f6e 6469 6e67 2048  "corresponding H
-0004ad80: 5454 5020 5552 4c73 2e20 5468 6520 4d58  TTP URLs. The MX
-0004ad90: 4320 5552 4973 2022 0a20 2020 2020 2020  C URIs ".       
-0004ada0: 2022 746f 2070 726f 7669 6465 206c 6f6f   "to provide loo
-0004adb0: 6b20 736f 6d65 7468 696e 6720 6c69 6b65  k something like
-0004adc0: 2074 6869 7320 220a 2020 2020 2020 2020   this ".        
-0004add0: 2227 6d78 633a 2f2f 6578 616d 706c 652e  "'mxc://example.
-0004ade0: 636f 6d2f 536f 6d65 5374 7261 6e67 6555  com/SomeStrangeU
-0004adf0: 7269 4b65 7927 2e20 220a 2020 2020 2020  riKey'. ".      
-0004ae00: 2020 2253 6565 2074 6573 7473 2f74 6573    "See tests/tes
-0004ae10: 742d 7570 6c6f 6164 2e73 6820 666f 7220  t-upload.sh for 
-0004ae20: 616e 2065 7861 6d70 6c65 2e22 2c0a 2020  an example.",.  
-0004ae30: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-0004ae40: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-0004ae50: 2023 206e 6f20 7369 6e67 6c65 2063 6861   # no single cha
-0004ae60: 7220 666c 6167 0a20 2020 2020 2020 2022  r flag.        "
-0004ae70: 2d2d 6465 7669 6365 7322 2c0a 2020 2020  --devices",.    
-0004ae80: 2020 2020 222d 2d67 6574 2d64 6576 6963      "--get-devic
-0004ae90: 6573 222c 2020 2320 616c 6961 732c 2063  es",  # alias, c
-0004aea0: 6175 7365 202d 2d64 6576 6963 6564 2069  ause --deviced i
-0004aeb0: 7320 7665 7279 2073 696d 696c 6172 2074  s very similar t
-0004aec0: 6f20 2d2d 6465 7669 6365 0a20 2020 2020  o --device.     
-0004aed0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-0004aee0: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-0004aef0: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
-0004af00: 2020 2020 2020 2020 6865 6c70 3d22 5072          help="Pr
-0004af10: 696e 7420 7468 6520 6c69 7374 206f 6620  int the list of 
-0004af20: 6465 7669 6365 732e 2022 0a20 2020 2020  devices. ".     
-0004af30: 2020 2022 4465 7461 696c 733a 3a20 416c     "Details:: Al
-0004af40: 6c20 6465 7669 6365 206f 6620 7468 6973  l device of this
-0004af50: 2022 0a20 2020 2020 2020 2022 6163 636f   ".        "acco
-0004af60: 756e 7420 7769 6c6c 2062 6520 7072 696e  unt will be prin
-0004af70: 7465 642c 206f 6e65 2064 6576 6963 6520  ted, one device 
-0004af80: 7065 7220 6c69 6e65 2e22 2c0a 2020 2020  per line.",.    
-0004af90: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0004afa0: 756d 656e 7428 0a20 2020 2020 2020 2023  ument(.        #
-0004afb0: 206e 6f20 7369 6e67 6c65 2063 6861 7220   no single char 
-0004afc0: 666c 6167 0a20 2020 2020 2020 2022 2d2d  flag.        "--
-0004afd0: 6469 7363 6f76 6572 792d 696e 666f 222c  discovery-info",
-0004afe0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-0004aff0: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-0004b000: 2061 6374 696f 6e3d 2273 746f 7265 5f74   action="store_t
-0004b010: 7275 6522 2c0a 2020 2020 2020 2020 6865  rue",.        he
-0004b020: 6c70 3d22 5072 696e 7420 6469 7363 6f76  lp="Print discov
-0004b030: 6572 7920 696e 666f 726d 6174 696f 6e20  ery information 
-0004b040: 6162 6f75 7420 6375 7272 656e 7420 686f  about current ho
-0004b050: 6d65 7365 7276 6572 2e20 220a 2020 2020  meserver. ".    
-0004b060: 2020 2020 2244 6574 6169 6c73 3a3a 204e      "Details:: N
-0004b070: 6f74 6520 7468 6174 206e 6f74 2061 6c6c  ote that not all
-0004b080: 2068 6f6d 6573 6572 7665 7273 2073 7570   homeservers sup
-0004b090: 706f 7274 2064 6973 636f 7665 7279 2061  port discovery a
-0004b0a0: 6e64 2061 6e20 220a 2020 2020 2020 2020  nd an ".        
-0004b0b0: 2265 7272 6f72 206d 6967 6874 2062 6520  "error might be 
-0004b0c0: 7265 706f 7274 6564 2e22 2c0a 2020 2020  reported.",.    
-0004b0d0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0004b0e0: 756d 656e 7428 0a20 2020 2020 2020 2023  ument(.        #
-0004b0f0: 206e 6f20 7369 6e67 6c65 2063 6861 7220   no single char 
-0004b100: 666c 6167 0a20 2020 2020 2020 2022 2d2d  flag.        "--
-0004b110: 6c6f 6769 6e2d 696e 666f 222c 0a20 2020  login-info",.   
-0004b120: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-0004b130: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-0004b140: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
-0004b150: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-0004b160: 5072 696e 7420 6c6f 6769 6e20 6d65 7468  Print login meth
-0004b170: 6f64 7320 7375 7070 6f72 7465 6420 6279  ods supported by
-0004b180: 2074 6865 2068 6f6d 6573 6572 7665 722e   the homeserver.
-0004b190: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
-0004b1a0: 696c 733a 3a20 4974 2070 7269 6e74 7320  ils:: It prints 
-0004b1b0: 6f6e 6520 6c6f 6769 6e20 6d65 7468 6f64  one login method
-0004b1c0: 2070 6572 206c 696e 652e 222c 0a20 2020   per line.",.   
-0004b1d0: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-0004b1e0: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0004b1f0: 2320 6e6f 2073 696e 676c 6520 6368 6172  # no single char
-0004b200: 2066 6c61 670a 2020 2020 2020 2020 222d   flag.        "-
-0004b210: 2d63 6f6e 7465 6e74 2d72 6570 6f73 6974  -content-reposit
-0004b220: 6f72 792d 636f 6e66 6967 222c 0a20 2020  ory-config",.   
-0004b230: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-0004b240: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-0004b250: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
-0004b260: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-0004b270: 5072 696e 7420 7468 6520 636f 6e74 656e  Print the conten
-0004b280: 7420 7265 706f 7369 746f 7279 2063 6f6e  t repository con
-0004b290: 6669 6775 7261 7469 6f6e 2e20 220a 2020  figuration. ".  
-0004b2a0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-0004b2b0: 2054 6869 7320 6375 7272 656e 746c 7920   This currently 
-0004b2c0: 6a75 7374 2070 7269 6e74 7320 220a 2020  just prints ".  
-0004b2d0: 2020 2020 2020 2274 6865 2075 706c 6f61        "the uploa
-0004b2e0: 6420 7369 7a65 206c 696d 6974 2069 6e20  d size limit in 
-0004b2f0: 6279 7465 732e 222c 0a20 2020 2029 0a20  bytes.",.    ). 
-0004b300: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-0004b310: 6e74 280a 2020 2020 2020 2020 2320 6e6f  nt(.        # no
-0004b320: 2073 696e 676c 6520 6368 6172 2066 6c61   single char fla
-0004b330: 670a 2020 2020 2020 2020 222d 2d72 6573  g.        "--res
-0004b340: 7422 2c0a 2020 2020 2020 2020 7265 7175  t",.        requ
-0004b350: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004b360: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-0004b370: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-0004b380: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
-0004b390: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
-0004b3a0: 2020 6d65 7461 7661 723d 2252 4553 545f    metavar="REST_
-0004b3b0: 4d45 5448 4f44 2044 4154 4120 5552 4c22  METHOD DATA URL"
-0004b3c0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-0004b3d0: 5573 6520 7468 6520 4d61 7472 6978 2043  Use the Matrix C
-0004b3e0: 6c69 656e 7420 5245 5354 2041 5049 2e20  lient REST API. 
-0004b3f0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-0004b400: 6c73 3a3a 204d 6174 7269 7820 6861 7320  ls:: Matrix has 
-0004b410: 7365 7665 7261 6c20 6578 7465 6e73 6976  several extensiv
-0004b420: 6520 220a 2020 2020 2020 2020 2252 4553  e ".        "RES
-0004b430: 5420 4150 4973 2e20 5769 7468 2074 6865  T APIs. With the
-0004b440: 202d 2d72 6573 7420 6172 6775 6d65 6e74   --rest argument
-0004b450: 2079 6f75 2063 616e 2069 6e76 6f6b 6520   you can invoke 
-0004b460: 6120 4d61 7472 6978 2052 4553 5420 220a  a Matrix REST ".
-0004b470: 2020 2020 2020 2020 2241 5049 2063 616c          "API cal
-0004b480: 6c2e 2054 6869 7320 616c 6c6f 7773 2074  l. This allows t
-0004b490: 6865 2075 7365 7220 746f 2064 6f20 7072  he user to do pr
-0004b4a0: 6574 7479 206d 7563 6820 616e 7974 6869  etty much anythi
-0004b4b0: 6e67 2c20 6174 2074 6865 2022 0a20 2020  ng, at the ".   
-0004b4c0: 2020 2020 2022 7072 6963 6520 6f66 206e       "price of n
-0004b4d0: 6f74 2062 6569 6e67 2076 6572 7920 636f  ot being very co
-0004b4e0: 6e76 656e 6965 6e74 2e20 5468 6520 4150  nvenient. The AP
-0004b4f0: 4973 2061 7265 2064 6573 6372 6962 6564  Is are described
-0004b500: 2069 6e20 220a 2020 2020 2020 2020 2268   in ".        "h
-0004b510: 7474 7073 3a2f 2f6d 6174 7269 782e 6f72  ttps://matrix.or
-0004b520: 672f 646f 6373 2f61 7069 2f2c 2022 0a20  g/docs/api/, ". 
-0004b530: 2020 2020 2020 2022 6874 7470 733a 2f2f         "https://
-0004b540: 7370 6563 2e6d 6174 7269 782e 6f72 672f  spec.matrix.org/
-0004b550: 6c61 7465 7374 2f63 6c69 656e 742d 7365  latest/client-se
-0004b560: 7276 6572 2d61 7069 2f2c 2022 0a20 2020  rver-api/, ".   
-0004b570: 2020 2020 2022 6874 7470 733a 2f2f 6d61       "https://ma
-0004b580: 7472 6978 2d6f 7267 2e67 6974 6875 622e  trix-org.github.
-0004b590: 696f 2f73 796e 6170 7365 2f6c 6174 6573  io/synapse/lates
-0004b5a0: 742f 7573 6167 652f 6164 6d69 6e69 7374  t/usage/administ
-0004b5b0: 7261 7469 6f6e 2f22 0a20 2020 2020 2020  ration/".       
-0004b5c0: 2022 6164 6d69 6e5f 6170 692f 2c20 6574   "admin_api/, et
-0004b5d0: 632e 2022 0a20 2020 2020 2020 2022 4561  c. ".        "Ea
-0004b5e0: 6368 2052 4553 5420 6361 6c6c 2072 6571  ch REST call req
-0004b5f0: 7569 7265 7320 6578 6163 746c 7920 3320  uires exactly 3 
-0004b600: 6172 6775 6d65 6e74 732e 2022 0a20 2020  arguments. ".   
-0004b610: 2020 2020 2022 536f 2c20 7468 6520 746f       "So, the to
-0004b620: 7461 6c20 6e75 6d62 6572 206f 6620 6172  tal number of ar
-0004b630: 6775 6d65 6e74 7320 7573 6564 2077 6974  guments used wit
-0004b640: 6820 2d2d 7265 7374 206d 7573 7420 6265  h --rest must be
-0004b650: 2061 2022 0a20 2020 2020 2020 2022 6d75   a ".        "mu
-0004b660: 6c74 6970 6c65 206f 6620 332e 2054 6865  ltiple of 3. The
-0004b670: 2061 7267 756d 656e 7420 7472 6970 6c65   argument triple
-0004b680: 7320 6172 653a 2022 0a20 2020 2020 2020  s are: ".       
-0004b690: 2022 2861 2920 7468 6520 6d65 7468 6f64   "(a) the method
-0004b6a0: 2c20 6120 7374 7269 6e67 206f 6620 4745  , a string of GE
-0004b6b0: 542c 2050 4f53 542c 2050 5554 2c20 4445  T, POST, PUT, DE
-0004b6c0: 4c45 5445 2c20 6f72 204f 5054 494f 4e53  LETE, or OPTIONS
-0004b6d0: 2e20 220a 2020 2020 2020 2020 2228 6229  . ".        "(b)
-0004b6e0: 2061 2073 7472 696e 6720 636f 6e74 6169   a string contai
-0004b6f0: 6e69 6e67 2074 6865 2064 6174 6120 2869  ning the data (i
-0004b700: 6620 616e 7929 2069 6e20 4a53 4f4e 2066  f any) in JSON f
-0004b710: 6f72 6d61 742e 2022 0a20 2020 2020 2020  ormat. ".       
-0004b720: 2022 2863 2920 6120 7374 7269 6e67 2063   "(c) a string c
-0004b730: 6f6e 7461 696e 696e 6720 7468 6520 5552  ontaining the UR
-0004b740: 4c2e 2041 6c6c 2073 7472 696e 6773 206d  L. All strings m
-0004b750: 7573 7420 6265 2055 5446 2d38 2e20 220a  ust be UTF-8. ".
-0004b760: 2020 2020 2020 2020 2254 6865 7265 2061          "There a
-0004b770: 7265 2061 2066 6577 2070 6c61 6365 686f  re a few placeho
-0004b780: 6c64 6572 732e 2054 6865 7920 6172 653a  lders. They are:
-0004b790: 2022 0a20 2020 2020 2020 2022 5f5f 686f   ".        "__ho
-0004b7a0: 6d65 7365 7276 6572 5f5f 2028 6c69 6b65  meserver__ (like
-0004b7b0: 2068 7474 7073 3a2f 2f6d 6174 7269 782e   https://matrix.
-0004b7c0: 6578 616d 706c 652e 6f72 6729 2c20 220a  example.org), ".
-0004b7d0: 2020 2020 2020 2020 225f 5f68 6f73 746e          "__hostn
-0004b7e0: 616d 655f 5f20 286c 696b 6520 6d61 7472  ame__ (like matr
-0004b7f0: 6978 2e65 7861 6d70 6c65 2e6f 7267 292c  ix.example.org),
-0004b800: 2022 0a20 2020 2020 2020 2022 5f5f 6163   ".        "__ac
-0004b810: 6365 7373 5f74 6f6b 656e 5f5f 2c20 5f5f  cess_token__, __
-0004b820: 7573 6572 5f69 645f 5f20 286c 696b 6520  user_id__ (like 
-0004b830: 406d 633a 6d61 7472 6978 2e65 7861 6d70  @mc:matrix.examp
-0004b840: 6c65 2e63 6f6d 292c 2022 0a20 2020 2020  le.com), ".     
-0004b850: 2020 2022 5f5f 6465 7669 6365 5f69 645f     "__device_id_
-0004b860: 5f2c 2061 6e64 205f 5f72 6f6f 6d5f 6964  _, and __room_id
-0004b870: 5f5f 2e20 4966 2061 2070 6c61 6365 686f  __. If a placeho
-0004b880: 6c64 6572 2069 7320 666f 756e 6420 6974  lder is found it
-0004b890: 2069 7320 220a 2020 2020 2020 2020 2272   is ".        "r
-0004b8a0: 6570 6c61 6365 6420 7769 7468 2074 6865  eplaced with the
-0004b8b0: 2076 616c 7565 2066 726f 6d20 7468 6520   value from the 
-0004b8c0: 6c6f 6361 6c20 6372 6564 656e 7469 616c  local credential
-0004b8d0: 7320 6669 6c65 2e20 220a 2020 2020 2020  s file. ".      
-0004b8e0: 2020 2241 6e20 6578 616d 706c 6520 776f    "An example wo
-0004b8f0: 756c 6420 6265 3a20 220a 2020 2020 2020  uld be: ".      
-0004b900: 2020 222d 2d72 6573 7420 2747 4554 2720    "--rest 'GET' 
-0004b910: 2727 2027 5f5f 686f 6d65 7365 7276 6572  '' '__homeserver
-0004b920: 5f5f 2f5f 6d61 7472 6978 2f63 6c69 656e  __/_matrix/clien
-0004b930: 742f 7665 7273 696f 6e73 272e 2022 0a20  t/versions'. ". 
-0004b940: 2020 2020 2020 2022 4966 2074 6865 7265         "If there
-0004b950: 2069 7320 6e6f 2064 6174 612c 2069 2e65   is no data, i.e
-0004b960: 2e20 6461 7461 2028 6229 2069 7320 656d  . data (b) is em
-0004b970: 7074 792c 2074 6865 6e20 7573 6520 2727  pty, then use ''
-0004b980: 2066 6f72 2069 742e 2022 0a20 2020 2020   for it. ".     
-0004b990: 2020 2022 4f70 7469 6f6e 616c 6c79 2c20     "Optionally, 
-0004b9a0: 2d2d 6163 6365 7373 2d74 6f6b 656e 2063  --access-token c
-0004b9b0: 616e 2062 6520 7573 6564 2074 6f20 6f76  an be used to ov
-0004b9c0: 6572 7772 6974 6520 7468 6520 220a 2020  erwrite the ".  
-0004b9d0: 2020 2020 2020 2261 6363 6573 7320 746f        "access to
-0004b9e0: 6b65 6e20 6672 6f6d 2063 7265 6465 6e74  ken from credent
-0004b9f0: 6961 6c73 2028 6966 206e 6565 6465 6429  ials (if needed)
-0004ba00: 2e20 220a 2020 2020 2020 2020 2253 6565  . ".        "See
-0004ba10: 2074 6573 7473 2f74 6573 742d 7265 7374   tests/test-rest
-0004ba20: 2e73 6820 666f 7220 616e 2065 7861 6d70  .sh for an examp
-0004ba30: 6c65 2e22 2c0a 2020 2020 290a 2020 2020  le.",.    ).    
-0004ba40: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-0004ba50: 0a20 2020 2020 2020 2022 2d2d 7365 742d  .        "--set-
-0004ba60: 6176 6174 6172 222c 0a20 2020 2020 2020  avatar",.       
-0004ba70: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0004ba80: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0004ba90: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-0004baa0: 6172 3d22 4156 4154 4152 5f4d 5843 5f55  ar="AVATAR_MXC_U
-0004bab0: 5249 222c 0a20 2020 2020 2020 2023 2064  RI",.        # d
-0004bac0: 6566 6175 6c74 7320 746f 204e 6f6e 6520  efaults to None 
-0004bad0: 6966 206e 6f74 2075 7365 642c 2069 7320  if not used, is 
-0004bae0: 7374 7220 6966 2075 7365 640a 2020 2020  str if used.    
-0004baf0: 2020 2020 6865 6c70 3d22 5365 7420 796f      help="Set yo
-0004bb00: 7572 2061 7661 7461 722e 2022 0a20 2020  ur avatar. ".   
-0004bb10: 2020 2020 2066 2244 6574 6169 6c73 3a3a       f"Details::
-0004bb20: 2053 6574 2074 6865 2061 7661 7461 7220   Set the avatar 
-0004bb30: 4d58 4320 7265 736f 7572 6365 2075 7365  MXC resource use
-0004bb40: 6420 6279 207b 5052 4f47 5f57 4954 484f  d by {PROG_WITHO
-0004bb50: 5554 5f45 5854 7d2e 2022 0a20 2020 2020  UT_EXT}. ".     
-0004bb60: 2020 2022 5072 6f76 6964 6520 6f6e 6520     "Provide one 
-0004bb70: 4d58 4320 5552 4920 7468 6174 206c 6f6f  MXC URI that loo
-0004bb80: 6b73 206c 696b 6520 7468 6973 2022 0a20  ks like this ". 
-0004bb90: 2020 2020 2020 2022 276d 7863 3a2f 2f65         "'mxc://e
-0004bba0: 7861 6d70 6c65 2e63 6f6d 2f53 6f6d 6553  xample.com/SomeS
-0004bbb0: 7472 616e 6765 5572 694b 6579 272e 222c  trangeUriKey'.",
-0004bbc0: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-0004bbd0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-0004bbe0: 2020 2020 222d 2d67 6574 2d61 7661 7461      "--get-avata
-0004bbf0: 7222 2c0a 2020 2020 2020 2020 7265 7175  r",.        requ
-0004bc00: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
-0004bc10: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
-0004bc20: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
-0004bc30: 6773 3d22 2a22 2c20 2023 204e 6f6e 6520  gs="*",  # None 
-0004bc40: 6966 206e 6f74 2075 7365 642c 205b 5d20  if not used, [] 
-0004bc50: 6973 2075 7365 6420 7769 7468 6f75 7420  is used without 
-0004bc60: 6578 7472 6120 6172 6773 0a20 2020 2020  extra args.     
-0004bc70: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-0004bc80: 2020 2020 206d 6574 6176 6172 3d22 5553       metavar="US
-0004bc90: 4552 222c 0a20 2020 2020 2020 2068 656c  ER",.        hel
-0004bca0: 703d 2247 6574 2061 6e20 6176 6174 6172  p="Get an avatar
-0004bcb0: 2e20 220a 2020 2020 2020 2020 6622 4465  . ".        f"De
-0004bcc0: 7461 696c 733a 3a20 4765 7420 7468 6520  tails:: Get the 
-0004bcd0: 6176 6174 6172 204d 5843 2072 6573 6f75  avatar MXC resou
-0004bce0: 7263 6520 7573 6564 2062 7920 7b50 524f  rce used by {PRO
-0004bcf0: 475f 5749 5448 4f55 545f 4558 547d 2c20  G_WITHOUT_EXT}, 
-0004bd00: 220a 2020 2020 2020 2020 226f 7220 6f6e  ".        "or on
-0004bd10: 6520 6f72 206d 756c 7469 706c 6520 6f74  e or multiple ot
-0004bd20: 6865 7220 7573 6572 732e 2053 7065 6369  her users. Speci
-0004bd30: 6679 207a 6572 6f20 6f72 206d 6f72 6520  fy zero or more 
-0004bd40: 7573 6572 2069 6473 2e20 220a 2020 2020  user ids. ".    
-0004bd50: 2020 2020 6622 4966 206e 6f20 7573 6572      f"If no user
-0004bd60: 2069 6420 6973 2073 7065 6369 6669 6564   id is specified
-0004bd70: 2c20 7468 6520 6176 6174 6172 206f 6620  , the avatar of 
-0004bd80: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
-0004bd90: 547d 2077 696c 6c20 220a 2020 2020 2020  T} will ".      
-0004bda0: 2020 2262 6520 6665 7463 6865 642e 2049    "be fetched. I
-0004bdb0: 6620 6f6e 6520 6f72 206d 6f72 6520 7573  f one or more us
-0004bdc0: 6572 2069 6473 2061 7265 2067 6976 656e  er ids are given
-0004bdd0: 2c20 7468 6520 6176 6174 6172 7320 6f66  , the avatars of
-0004bde0: 2022 0a20 2020 2020 2020 2022 7468 6573   ".        "thes
-0004bdf0: 6520 7573 6572 7320 7769 6c6c 2062 6520  e users will be 
-0004be00: 6665 7463 6865 642e 2041 7320 7265 7370  fetched. As resp
-0004be10: 6f6e 7365 2062 6f74 6820 4d58 4320 5552  onse both MXC UR
-0004be20: 4920 6173 2077 656c 6c20 6173 2055 524c  I as well as URL
-0004be30: 2022 0a20 2020 2020 2020 2022 7769 6c6c   ".        "will
-0004be40: 2062 6520 7072 696e 7465 642e 222c 0a20   be printed.",. 
-0004be50: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-0004be60: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-0004be70: 2020 222d 2d67 6574 2d70 726f 6669 6c65    "--get-profile
-0004be80: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-0004be90: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-0004bea0: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
-0004beb0: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
-0004bec0: 733d 222a 222c 2020 2320 4e6f 6e65 2069  s="*",  # None i
-0004bed0: 6620 6e6f 7420 7573 6564 2c20 5b5d 2069  f not used, [] i
-0004bee0: 7320 7573 6564 2077 6974 686f 7574 2065  s used without e
-0004bef0: 7874 7261 2061 7267 730a 2020 2020 2020  xtra args.      
-0004bf00: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
-0004bf10: 2020 2020 6d65 7461 7661 723d 2255 5345      metavar="USE
-0004bf20: 5222 2c0a 2020 2020 2020 2020 6865 6c70  R",.        help
-0004bf30: 3d22 4765 7420 6120 7573 6572 2070 726f  ="Get a user pro
-0004bf40: 6669 6c65 2e20 220a 2020 2020 2020 2020  file. ".        
-0004bf50: 6622 4465 7461 696c 733a 3a20 4765 7420  f"Details:: Get 
-0004bf60: 7468 6520 7573 6572 2070 726f 6669 6c65  the user profile
-0004bf70: 2075 7365 6420 6279 207b 5052 4f47 5f57   used by {PROG_W
-0004bf80: 4954 484f 5554 5f45 5854 7d2c 206f 7220  ITHOUT_EXT}, or 
-0004bf90: 220a 2020 2020 2020 2020 226f 6e65 206f  ".        "one o
-0004bfa0: 7220 6d75 6c74 6970 6c65 206f 7468 6572  r multiple other
-0004bfb0: 2075 7365 7273 2e20 5370 6563 6966 7920   users. Specify 
-0004bfc0: 7a65 726f 206f 7220 6d6f 7265 2075 7365  zero or more use
-0004bfd0: 7220 6964 732e 2022 0a20 2020 2020 2020  r ids. ".       
-0004bfe0: 2066 2249 6620 6e6f 2075 7365 7220 6964   f"If no user id
-0004bff0: 2069 7320 7370 6563 6966 6965 642c 2074   is specified, t
-0004c000: 6865 2075 7365 7220 7072 6f66 696c 6520  he user profile 
-0004c010: 6f66 207b 5052 4f47 5f57 4954 484f 5554  of {PROG_WITHOUT
-0004c020: 5f45 5854 7d20 220a 2020 2020 2020 2020  _EXT} ".        
-0004c030: 2277 696c 6c20 6265 2066 6574 6368 6564  "will be fetched
-0004c040: 2e20 4966 206f 6e65 206f 7220 6d6f 7265  . If one or more
-0004c050: 2075 7365 7220 6964 7320 6172 6520 6769   user ids are gi
-0004c060: 7665 6e2c 2074 6865 2075 7365 7220 220a  ven, the user ".
-0004c070: 2020 2020 2020 2020 2270 726f 6669 6c65          "profile
-0004c080: 7320 6f66 2074 6865 7365 2075 7365 7273  s of these users
-0004c090: 2077 696c 6c20 6265 2066 6574 6368 6564   will be fetched
-0004c0a0: 2e20 4173 2072 6573 706f 6e73 6520 220a  . As response ".
-0004c0b0: 2020 2020 2020 2020 2264 6973 706c 6179          "display
-0004c0c0: 206e 616d 6520 616e 6420 6176 6174 6172   name and avatar
-0004c0d0: 204d 5843 2055 5249 2061 7320 7765 6c6c   MXC URI as well
-0004c0e0: 2061 7320 706f 7373 6962 6c65 2061 6464   as possible add
-0004c0f0: 6974 696f 6e61 6c20 220a 2020 2020 2020  itional ".      
-0004c100: 2020 2270 726f 6669 6c65 2069 6e66 6f72    "profile infor
-0004c110: 6d61 7469 6f6e 2028 6966 2070 7265 7365  mation (if prese
-0004c120: 6e74 2920 220a 2020 2020 2020 2020 2277  nt) ".        "w
-0004c130: 696c 6c20 6265 2070 7269 6e74 6564 2e20  ill be printed. 
-0004c140: 4f6e 6520 6c69 6e65 2070 6572 2075 7365  One line per use
-0004c150: 7220 7769 6c6c 2062 6520 7072 696e 7465  r will be printe
-0004c160: 642e 222c 0a20 2020 2029 0a20 2020 2061  d.",.    ).    a
-0004c170: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-0004c180: 2020 2020 2020 2020 222d 2d67 6574 2d72          "--get-r
-0004c190: 6f6f 6d2d 696e 666f 222c 0a20 2020 2020  oom-info",.     
-0004c1a0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-0004c1b0: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
-0004c1c0: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
-0004c1d0: 2020 2020 6e61 7267 733d 222a 222c 2020      nargs="*",  
-0004c1e0: 2320 4e6f 6e65 2069 6620 6e6f 7420 7573  # None if not us
-0004c1f0: 6564 2c20 5b5d 2069 7320 7573 6564 2077  ed, [] is used w
-0004c200: 6974 686f 7574 2065 7874 7261 2061 7267  ithout extra arg
-0004c210: 730a 2020 2020 2020 2020 7479 7065 3d73  s.        type=s
-0004c220: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
-0004c230: 7661 723d 2252 4f4f 4d22 2c0a 2020 2020  var="ROOM",.    
-0004c240: 2020 2020 6865 6c70 3d22 4765 7420 7468      help="Get th
-0004c250: 6520 726f 6f6d 2069 6e66 6f72 6d61 7469  e room informati
-0004c260: 6f6e 2e20 220a 2020 2020 2020 2020 2244  on. ".        "D
-0004c270: 6574 6169 6c73 3a3a 2047 6574 2074 6865  etails:: Get the
-0004c280: 2072 6f6f 6d20 696e 666f 726d 6174 696f   room informatio
-0004c290: 6e20 7375 6368 2061 7320 726f 6f6d 2064  n such as room d
-0004c2a0: 6973 706c 6179 206e 616d 652c 2022 0a20  isplay name, ". 
-0004c2b0: 2020 2020 2020 2022 726f 6f6d 2061 6c69         "room ali
-0004c2c0: 6173 2c20 726f 6f6d 2063 7265 6174 6f72  as, room creator
-0004c2d0: 2c20 6574 632e 2066 6f72 2022 0a20 2020  , etc. for ".   
-0004c2e0: 2020 2020 2022 6f6e 6520 6f72 206d 756c       "one or mul
-0004c2f0: 7469 706c 6520 7370 6563 6966 6965 6420  tiple specified 
-0004c300: 726f 6f6d 732e 2054 6865 2069 6e63 6c75  rooms. The inclu
-0004c310: 6465 6420 726f 6f6d 2027 6469 7370 6c61  ded room 'displa
-0004c320: 7920 6e61 6d65 2720 6973 2022 0a20 2020  y name' is ".   
-0004c330: 2020 2020 2022 616c 736f 2072 6566 6572       "also refer
-0004c340: 7265 6420 746f 2061 7320 2772 6f6f 6d20  red to as 'room 
-0004c350: 6e61 6d65 2720 6f72 2069 6e63 6f72 7265  name' or incorre
-0004c360: 6374 6c79 2065 7665 6e20 6173 2072 6f6f  ctly even as roo
-0004c370: 6d20 7469 746c 652e 2022 0a20 2020 2020  m title. ".     
-0004c380: 2020 2022 4966 206f 6e65 206f 7220 6d6f     "If one or mo
-0004c390: 7265 2072 6f6f 6d20 6172 6520 6769 7665  re room are give
-0004c3a0: 6e2c 2074 6865 2072 6f6f 6d20 220a 2020  n, the room ".  
-0004c3b0: 2020 2020 2020 2269 6e66 6f72 6d61 7469        "informati
-0004c3c0: 6f6e 7320 6f66 2074 6865 7365 2072 6f6f  ons of these roo
-0004c3d0: 6d73 2077 696c 6c20 6265 2066 6574 6368  ms will be fetch
-0004c3e0: 6564 2e20 220a 2020 2020 2020 2020 2249  ed. ".        "I
-0004c3f0: 6620 6e6f 2072 6f6f 6d20 6973 2073 7065  f no room is spe
-0004c400: 6369 6669 6564 2c20 7468 6520 726f 6f6d  cified, the room
-0004c410: 2069 6e66 6f72 6d61 7469 6f6e 2066 6f72   information for
-0004c420: 2074 6865 2022 0a20 2020 2020 2020 2066   the ".        f
-0004c430: 2264 6566 6175 6c74 2072 6f6f 6d20 636f  "default room co
-0004c440: 6e66 6967 7572 6564 2066 6f72 207b 5052  nfigured for {PR
-0004c450: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
-0004c460: 6973 2066 6574 6368 6564 2e20 220a 2020  is fetched. ".  
-0004c470: 2020 2020 2020 2252 6f6f 6d73 2063 616e        "Rooms can
-0004c480: 2062 6520 6769 7665 6e20 7669 6120 220a   be given via ".
-0004c490: 2020 2020 2020 2020 2272 6f6f 6d20 6964          "room id
-0004c4a0: 2028 652e 672e 2027 5c5c 2153 6f6d 6552   (e.g. '\\!SomeR
-0004c4b0: 6f6f 6d49 643a 6d61 7472 6978 2e65 7861  oomId:matrix.exa
-0004c4c0: 6d70 6c65 2e63 6f6d 2729 2c20 220a 2020  mple.com'), ".  
-0004c4d0: 2020 2020 2020 2263 616e 6f6e 6963 616c        "canonical
-0004c4e0: 2028 6675 6c6c 2920 726f 6f6d 2061 6c69   (full) room ali
-0004c4f0: 6173 2022 0a20 2020 2020 2020 2022 2865  as ".        "(e
-0004c500: 2e67 2e20 2723 536f 6d65 526f 6f6d 416c  .g. '#SomeRoomAl
-0004c510: 6961 733a 6d61 7472 6978 2e65 7861 6d70  ias:matrix.examp
-0004c520: 6c65 2e63 6f6d 2729 2c20 220a 2020 2020  le.com'), ".    
-0004c530: 2020 2020 226f 7220 7368 6f72 7420 616c      "or short al
-0004c540: 6961 7320 2865 2e67 2e20 2753 6f6d 6552  ias (e.g. 'SomeR
-0004c550: 6f6f 6d41 6c69 6173 2720 6f72 2027 2353  oomAlias' or '#S
-0004c560: 6f6d 6552 6f6f 6d41 6c69 6173 2729 2e20  omeRoomAlias'). 
-0004c570: 220a 2020 2020 2020 2020 2241 7320 7265  ".        "As re
-0004c580: 7370 6f6e 7365 2022 0a20 2020 2020 2020  sponse ".       
-0004c590: 2022 726f 6f6d 2069 642c 2072 6f6f 6d20   "room id, room 
-0004c5a0: 6469 7370 6c61 7920 6e61 6d65 2c20 726f  display name, ro
-0004c5b0: 6f6d 2063 616e 6f6e 6963 616c 2061 6c69  om canonical ali
-0004c5c0: 6173 2c20 726f 6f6d 2074 6f70 6963 2c20  as, room topic, 
-0004c5d0: 220a 2020 2020 2020 2020 2272 6f6f 6d20  ".        "room 
-0004c5e0: 6372 6561 746f 722c 2061 6e64 2072 6f6f  creator, and roo
-0004c5f0: 6d20 656e 6372 7970 7469 6f6e 2022 0a20  m encryption ". 
-0004c600: 2020 2020 2020 2022 6172 6520 7072 696e         "are prin
-0004c610: 7465 642e 204f 6e65 206c 696e 6520 7065  ted. One line pe
-0004c620: 7220 726f 6f6d 2077 696c 6c20 6265 2070  r room will be p
-0004c630: 7269 6e74 6564 2e20 220a 2020 2020 2020  rinted. ".      
-0004c640: 2020 2253 696e 6365 2065 6974 6865 7220    "Since either 
-0004c650: 726f 6f6d 2069 6420 6f72 2072 6f6f 6d20  room id or room 
-0004c660: 616c 6961 7320 6172 6520 6163 6365 7074  alias are accept
-0004c670: 6564 2061 7320 696e 7075 7420 616e 6420  ed as input and 
-0004c680: 626f 7468 2022 0a20 2020 2020 2020 2022  both ".        "
-0004c690: 726f 6f6d 2069 6420 616e 6420 726f 6f6d  room id and room
-0004c6a0: 2061 6c69 6173 2061 7265 2067 6976 656e   alias are given
-0004c6b0: 2061 7320 6f75 7470 7574 2c20 6f6e 6520   as output, one 
-0004c6c0: 6361 6e20 6865 6e63 6520 7573 6520 7468  can hence use th
-0004c6d0: 6973 2022 0a20 2020 2020 2020 2022 6f70  is ".        "op
-0004c6e0: 7469 6f6e 2074 6f20 6d61 7020 6672 6f6d  tion to map from
-0004c6f0: 2072 6f6f 6d20 6964 2074 6f20 726f 6f6d   room id to room
-0004c700: 2061 6c69 6173 2022 0a20 2020 2020 2020   alias ".       
-0004c710: 2022 6173 2077 656c 6c20 6173 2076 6963   "as well as vic
-0004c720: 6520 7665 7273 6120 6672 6f6d 2072 6f6f  e versa from roo
-0004c730: 6d20 616c 6961 7320 746f 2072 6f6f 6d20  m alias to room 
-0004c740: 6964 2e20 220a 2020 2020 2020 2020 2244  id. ".        "D
-0004c750: 6f20 6e6f 7420 636f 6e66 7573 6520 7468  o not confuse th
-0004c760: 6973 206f 7074 696f 6e20 7769 7468 2074  is option with t
-0004c770: 6865 206f 7074 696f 6e73 2027 2d2d 6765  he options '--ge
-0004c780: 742d 6469 7370 6c61 792d 6e61 6d65 2720  t-display-name' 
-0004c790: 220a 2020 2020 2020 2020 2261 6e64 2027  ".        "and '
-0004c7a0: 2d2d 7365 742d 6469 7370 6c61 792d 6e61  --set-display-na
-0004c7b0: 6d65 272c 2077 6869 6368 2067 6574 2f73  me', which get/s
-0004c7c0: 6574 2074 6865 2075 7365 7220 6469 7370  et the user disp
-0004c7d0: 6c61 7920 6e61 6d65 2c20 6e6f 7420 220a  lay name, not ".
-0004c7e0: 2020 2020 2020 2020 2274 6865 2072 6f6f          "the roo
-0004c7f0: 6d20 6469 7370 6c61 7920 6e61 6d65 2e22  m display name."
-0004c800: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-0004c810: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-0004c820: 2020 2020 2022 2d2d 6765 742d 636c 6965       "--get-clie
-0004c830: 6e74 2d69 6e66 6f22 2c0a 2020 2020 2020  nt-info",.      
-0004c840: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-0004c850: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
-0004c860: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
-0004c870: 2020 2020 2020 2068 656c 703d 2250 7269         help="Pri
-0004c880: 6e74 2063 6c69 656e 7420 696e 666f 726d  nt client inform
-0004c890: 6174 696f 6e2e 2022 0a20 2020 2020 2020  ation. ".       
-0004c8a0: 2022 4465 7461 696c 733a 3a20 5072 696e   "Details:: Prin
-0004c8b0: 7420 696e 666f 726d 6174 696f 6e20 6b65  t information ke
-0004c8c0: 7074 2069 6e20 7468 6520 636c 6965 6e74  pt in the client
-0004c8d0: 2c20 692e 652e 2022 0a20 2020 2020 2020  , i.e. ".       
-0004c8e0: 2066 227b 5052 4f47 5f57 4954 484f 5554   f"{PROG_WITHOUT
-0004c8f0: 5f45 5854 7d2e 2022 0a20 2020 2020 2020  _EXT}. ".       
-0004c900: 2022 4f75 7470 7574 2069 7320 7072 696e   "Output is prin
-0004c910: 7465 6420 696e 204a 534f 4e20 666f 726d  ted in JSON form
-0004c920: 6174 2e22 2c0a 2020 2020 290a 2020 2020  at.",.    ).    
-0004c930: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-0004c940: 0a20 2020 2020 2020 2022 2d2d 6861 732d  .        "--has-
-0004c950: 7065 726d 6973 7369 6f6e 222c 0a20 2020  permission",.   
-0004c960: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-0004c970: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-0004c980: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-0004c990: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-0004c9a0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0004c9b0: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-0004c9c0: 6172 3d22 524f 4f4d 2042 414e 7c49 4e56  ar="ROOM BAN|INV
-0004c9d0: 4954 457c 4b49 434b 7c4e 4f54 4946 4943  ITE|KICK|NOTIFIC
-0004c9e0: 4154 494f 4e53 7c52 4544 4143 547c 6574  ATIONS|REDACT|et
-0004c9f0: 6322 2c0a 2020 2020 2020 2020 6865 6c70  c",.        help
-0004ca00: 3d22 496e 7175 6972 6520 6162 6f75 7420  ="Inquire about 
-0004ca10: 7065 726d 6973 7369 6f6e 732e 2022 0a20  permissions. ". 
-0004ca20: 2020 2020 2020 2066 2244 6574 6169 6c73         f"Details
-0004ca30: 3a3a 2049 6e71 7569 7265 2069 6620 7573  :: Inquire if us
-0004ca40: 6572 2075 7365 6420 6279 207b 5052 4f47  er used by {PROG
-0004ca50: 5f57 4954 484f 5554 5f45 5854 7d20 6861  _WITHOUT_EXT} ha
-0004ca60: 7320 220a 2020 2020 2020 2020 2270 6572  s ".        "per
-0004ca70: 6d69 7373 696f 6e20 666f 7220 6f6e 6520  mission for one 
-0004ca80: 6f72 206d 756c 7469 706c 6520 6163 7469  or multiple acti
-0004ca90: 6f6e 7320 696e 206f 6e65 206f 7220 6d75  ons in one or mu
-0004caa0: 6c74 6970 6c65 2072 6f6f 6d73 2e20 220a  ltiple rooms. ".
-0004cab0: 2020 2020 2020 2020 2245 6163 6820 696e          "Each in
-0004cac0: 7175 6972 7920 7265 7175 6972 6573 2032  quiry requires 2
-0004cad0: 2070 6172 616d 6574 6572 733a 2074 6865   parameters: the
-0004cae0: 2072 6f6f 6d20 6964 2061 6e64 2074 6865   room id and the
-0004caf0: 2070 6572 6d69 7373 696f 6e20 220a 2020   permission ".  
-0004cb00: 2020 2020 2020 2274 7970 652e 204f 6e65        "type. One
-0004cb10: 206f 7220 6d75 6c74 6970 6c65 206f 6620   or multiple of 
-0004cb20: 7468 6573 6520 7061 7261 6d65 7465 7220  these parameter 
-0004cb30: 7061 6972 7320 6d61 7920 6265 2073 7065  pairs may be spe
-0004cb40: 6369 6669 6564 2e20 220a 2020 2020 2020  cified. ".      
-0004cb50: 2020 2246 6f72 2065 6163 6820 7061 7261    "For each para
-0004cb60: 6d65 7465 7220 7061 6972 2074 6865 7265  meter pair there
-0004cb70: 2077 696c 6c20 6265 206f 6e65 206c 696e   will be one lin
-0004cb80: 6520 7072 696e 7465 6420 746f 2073 7464  e printed to std
-0004cb90: 6f75 742e 2022 0a20 2020 2020 2020 2022  out. ".        "
-0004cba0: 5661 6c75 6573 2066 6f72 2074 6865 2070  Values for the p
-0004cbb0: 6572 6d69 7373 696f 6e20 7479 7065 2061  ermission type a
-0004cbc0: 7265 2027 6261 6e27 2c20 220a 2020 2020  re 'ban', ".    
-0004cbd0: 2020 2020 2227 696e 7669 7465 272c 2027      "'invite', '
-0004cbe0: 6b69 636b 272c 2027 6e6f 7469 6669 6361  kick', 'notifica
-0004cbf0: 7469 6f6e 7327 2c20 2772 6564 6163 7427  tions', 'redact'
-0004cc00: 2c20 6574 632e 2022 0a20 2020 2020 2020  , etc. ".       
-0004cc10: 2022 5365 6520 6874 7470 733a 2f2f 7370   "See https://sp
-0004cc20: 6563 2e6d 6174 7269 782e 6f72 672f 7631  ec.matrix.org/v1
-0004cc30: 2e32 2f63 6c69 656e 742d 7365 7276 6572  .2/client-server
-0004cc40: 2d61 7069 2f23 6d72 6f6f 6d70 6f77 6572  -api/#mroompower
-0004cc50: 5f6c 6576 656c 7322 0a20 2020 2020 2020  _levels".       
-0004cc60: 2022 2e22 2c0a 2020 2020 2020 2020 2320   ".",.        # 
-0004cc70: 2765 7665 6e74 7327 2c20 2765 7665 6e74  'events', 'event
-0004cc80: 735f 6465 6661 756c 7427 2c20 2773 7461  s_default', 'sta
-0004cc90: 7465 5f64 6566 6175 6c74 273a 2076 616c  te_default': val
-0004cca0: 6964 2070 6572 6d69 7373 696f 6e20 7479  id permission ty
-0004ccb0: 7065 733f 0a20 2020 2029 0a20 2020 2061  pes?.    ).    a
-0004ccc0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-0004ccd0: 2020 2020 2020 2020 222d 2d69 6d70 6f72          "--impor
-0004cce0: 742d 6b65 7973 222c 0a20 2020 2020 2020  t-keys",.       
-0004ccf0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0004cd00: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-0004cd10: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
-0004cd20: 2020 6e61 7267 733d 322c 2020 2320 6669    nargs=2,  # fi
-0004cd30: 6c65 6e61 6d65 2066 6f72 2069 6d70 6f72  lename for impor
-0004cd40: 742c 2070 6173 7370 6872 6173 650a 2020  t, passphrase.  
-0004cd50: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-0004cd60: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-0004cd70: 2246 494c 4520 5041 5353 5048 5241 5345  "FILE PASSPHRASE
-0004cd80: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
-0004cd90: 2249 6d70 6f72 7420 4d65 676f 6c6d 2064  "Import Megolm d
-0004cda0: 6563 7279 7074 696f 6e20 6b65 7973 2066  ecryption keys f
-0004cdb0: 726f 6d20 6120 6669 6c65 2e20 220a 2020  rom a file. ".  
-0004cdc0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-0004cdd0: 2054 6869 7320 6973 2061 6e20 6f70 7469   This is an opti
-0004cde0: 6f6e 616c 2061 7267 756d 656e 742e 2049  onal argument. I
-0004cdf0: 6620 7573 6564 2069 7420 6d75 7374 2062  f used it must b
-0004ce00: 6520 666f 6c6c 6f77 6564 2022 0a20 2020  e followed ".   
-0004ce10: 2020 2020 2022 6279 2074 776f 2076 616c       "by two val
-0004ce20: 7565 732e 2028 6129 2061 2066 696c 6520  ues. (a) a file 
-0004ce30: 6e61 6d65 2066 726f 6d20 7768 6963 6820  name from which 
-0004ce40: 7468 6520 6b65 7973 2077 696c 6c20 6265  the keys will be
-0004ce50: 2072 6561 642e 2022 0a20 2020 2020 2020   read. ".       
-0004ce60: 2022 2862 2920 6120 7061 7373 7068 7261   "(b) a passphra
-0004ce70: 7365 2077 6974 6820 7768 6963 6820 7468  se with which th
-0004ce80: 6520 6669 6c65 2063 616e 2062 6520 6465  e file can be de
-0004ce90: 6372 7970 7465 6420 7769 7468 2e20 220a  crypted with. ".
-0004cea0: 2020 2020 2020 2020 2254 6865 206b 6579          "The key
-0004ceb0: 7320 7769 6c6c 2062 6520 6164 6465 6420  s will be added 
-0004cec0: 746f 2074 6865 2063 7572 7265 6e74 2069  to the current i
-0004ced0: 6e73 7461 6e63 6520 6173 2077 656c 6c20  nstance as well 
-0004cee0: 6173 2022 0a20 2020 2020 2020 2022 7772  as ".        "wr
-0004cef0: 6974 7465 6e20 746f 2074 6865 2064 6174  itten to the dat
-0004cf00: 6162 6173 652e 2053 6565 2061 6c73 6f20  abase. See also 
-0004cf10: 2d2d 6578 706f 7274 2d6b 6579 732e 222c  --export-keys.",
-0004cf20: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-0004cf30: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-0004cf40: 2020 2020 222d 2d65 7870 6f72 742d 6b65      "--export-ke
-0004cf50: 7973 222c 0a20 2020 2020 2020 2072 6571  ys",.        req
-0004cf60: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
-0004cf70: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
-0004cf80: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
-0004cf90: 7267 733d 322c 2020 2320 6669 6c65 6e61  rgs=2,  # filena
-0004cfa0: 6d65 2066 6f72 2065 7870 6f72 742c 2070  me for export, p
-0004cfb0: 6173 7370 6872 6173 650a 2020 2020 2020  assphrase.      
-0004cfc0: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
-0004cfd0: 2020 2020 6d65 7461 7661 723d 2246 494c      metavar="FIL
-0004cfe0: 4520 5041 5353 5048 5241 5345 222c 0a20  E PASSPHRASE",. 
-0004cff0: 2020 2020 2020 2068 656c 703d 2245 7870         help="Exp
-0004d000: 6f72 7420 616c 6c20 7468 6520 4d65 676f  ort all the Mego
-0004d010: 6c6d 2064 6563 7279 7074 696f 6e20 6b65  lm decryption ke
-0004d020: 7973 206f 6620 7468 6973 2064 6576 6963  ys of this devic
-0004d030: 652e 2022 0a20 2020 2020 2020 2022 4465  e. ".        "De
-0004d040: 7461 696c 733a 3a20 5468 6973 2069 7320  tails:: This is 
-0004d050: 616e 206f 7074 696f 6e61 6c20 6172 6775  an optional argu
-0004d060: 6d65 6e74 2e20 4966 2075 7365 6420 6974  ment. If used it
-0004d070: 206d 7573 7420 6265 2066 6f6c 6c6f 7765   must be followe
-0004d080: 6420 220a 2020 2020 2020 2020 2262 7920  d ".        "by 
-0004d090: 7477 6f20 7661 6c75 6573 2e20 2861 2920  two values. (a) 
-0004d0a0: 6120 6669 6c65 206e 616d 6520 746f 2077  a file name to w
-0004d0b0: 6869 6368 2074 6865 206b 6579 7320 7769  hich the keys wi
-0004d0c0: 6c6c 2062 6520 7772 6974 7465 6e20 746f  ll be written to
-0004d0d0: 2e20 220a 2020 2020 2020 2020 2228 6229  . ".        "(b)
-0004d0e0: 2061 2070 6173 7370 6872 6173 6520 7769   a passphrase wi
-0004d0f0: 7468 2077 6869 6368 2074 6865 2066 696c  th which the fil
-0004d100: 6520 7769 6c6c 2062 6520 656e 6372 7970  e will be encryp
-0004d110: 7465 6420 7769 7468 2e20 220a 2020 2020  ted with. ".    
-0004d120: 2020 2020 224e 6f74 6520 7468 6174 2074      "Note that t
-0004d130: 6869 7320 646f 6573 206e 6f74 2073 6176  his does not sav
-0004d140: 6520 6f74 6865 7220 696e 666f 726d 6174  e other informat
-0004d150: 696f 6e20 7375 6368 2061 7320 7468 6520  ion such as the 
-0004d160: 7072 6976 6174 6520 220a 2020 2020 2020  private ".      
-0004d170: 2020 2269 6465 6e74 6974 7920 6b65 7973    "identity keys
-0004d180: 206f 6620 7468 6520 6465 7669 6365 2e22   of the device."
-0004d190: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
-0004d1a0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
-0004d1b0: 2020 2020 2022 2d2d 726f 6f6d 2d73 6574       "--room-set
-0004d1c0: 2d61 6c69 6173 222c 0a20 2020 2020 2020  -alias",.       
-0004d1d0: 2022 2d2d 726f 6f6d 2d70 7574 2d61 6c69   "--room-put-ali
-0004d1e0: 6173 222c 2020 2320 6e61 6d65 2075 7365  as",  # name use
-0004d1f0: 6420 6279 206e 696f 0a20 2020 2020 2020  d by nio.       
-0004d200: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-0004d210: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
-0004d220: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
-0004d230: 2020 6e61 7267 733d 222b 222c 0a20 2020    nargs="+",.   
-0004d240: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
-0004d250: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
-0004d260: 524f 4f4d 5f41 4c49 4153 2052 4f4f 4d22  ROOM_ALIAS ROOM"
-0004d270: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-0004d280: 4164 6420 616c 6961 7365 7320 746f 2072  Add aliases to r
-0004d290: 6f6f 6d73 2e20 220a 2020 2020 2020 2020  ooms. ".        
-0004d2a0: 2244 6574 6169 6c73 3a3a 2041 6464 2061  "Details:: Add a
-0004d2b0: 6e20 616c 6961 7320 746f 2061 2072 6f6f  n alias to a roo
-0004d2c0: 6d2c 206f 7220 616c 6961 7365 7320 746f  m, or aliases to
-0004d2d0: 206d 756c 7469 706c 6520 726f 6f6d 732e   multiple rooms.
-0004d2e0: 2022 0a20 2020 2020 2020 2022 5072 6f76   ".        "Prov
-0004d2f0: 6964 6520 7061 6972 7320 6f66 2061 7267  ide pairs of arg
-0004d300: 756d 656e 7473 2e20 496e 2065 6163 6820  uments. In each 
-0004d310: 7061 6972 2c20 7468 6520 6669 7273 7420  pair, the first 
-0004d320: 6172 6775 6d65 6e74 206d 7573 7420 6265  argument must be
-0004d330: 2022 0a20 2020 2020 2020 2022 7468 6520   ".        "the 
-0004d340: 616c 6961 7320 796f 7520 7761 6e74 2074  alias you want t
-0004d350: 6f20 6173 7369 676e 2074 6f20 7468 6520  o assign to the 
-0004d360: 726f 6f6d 2067 6976 656e 2076 6961 2072  room given via r
-0004d370: 6f6f 6d20 6964 2069 6e20 7468 6520 220a  oom id in the ".
-0004d380: 2020 2020 2020 2020 2273 6563 6f6e 6420          "second 
-0004d390: 6172 6775 6d65 6e74 206f 6620 7468 6520  argument of the 
-0004d3a0: 7061 6972 2e20 452e 672e 2074 6865 2034  pair. E.g. the 4
-0004d3b0: 2061 7267 756d 656e 7473 2027 6131 2072   arguments 'a1 r
-0004d3c0: 3120 6132 2072 3227 2022 0a20 2020 2020  1 a2 r2' ".     
-0004d3d0: 2020 2022 776f 756c 6420 6173 7369 676e     "would assign
-0004d3e0: 2074 6865 2061 6c69 6173 2027 6131 2720   the alias 'a1' 
-0004d3f0: 746f 2072 6f6f 6d20 2772 3127 2061 6e64  to room 'r1' and
-0004d400: 2074 6865 2061 6c69 6173 2027 6132 2720   the alias 'a2' 
-0004d410: 746f 2072 6f6f 6d20 220a 2020 2020 2020  to room ".      
-0004d420: 2020 2227 7232 272e 2049 6620 796f 7520    "'r2'. If you 
-0004d430: 6a75 7374 2068 6176 6520 6f6e 6520 7369  just have one si
-0004d440: 6e67 6c65 2070 6169 7220 7468 656e 2074  ngle pair then t
-0004d450: 6865 2073 6563 6f6e 6420 6172 6775 6d65  he second argume
-0004d460: 6e74 2069 7320 220a 2020 2020 2020 2020  nt is ".        
-0004d470: 226f 7074 696f 6e61 6c2e 2049 6620 6a75  "optional. If ju
-0004d480: 7374 2061 2073 696e 676c 6520 7661 6c75  st a single valu
-0004d490: 6520 6973 2067 6976 656e 2028 616e 2061  e is given (an a
-0004d4a0: 6c69 6173 2920 7468 656e 2074 6869 7320  lias) then this 
-0004d4b0: 220a 2020 2020 2020 2020 2261 6c69 6173  ".        "alias
-0004d4c0: 2069 7320 6173 7369 676e 6564 2074 6f20   is assigned to 
-0004d4d0: 7468 6520 6465 6661 756c 7420 726f 6f6d  the default room
-0004d4e0: 206f 6620 220a 2020 2020 2020 2020 6622   of ".        f"
-0004d4f0: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
-0004d500: 547d 2028 6173 2066 6f75 6e64 2069 6e20  T} (as found in 
-0004d510: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
-0004d520: 292e 2049 6e20 7368 6f72 742c 2022 0a20  ). In short, ". 
-0004d530: 2020 2020 2020 2022 796f 7520 6361 6e20         "you can 
-0004d540: 6861 7665 206a 7573 7420 6120 7369 6e67  have just a sing
-0004d550: 6c65 2061 7267 756d 656e 7420 6f72 2061  le argument or a
-0004d560: 6e20 6576 656e 206e 756d 6265 7220 6f66  n even number of
-0004d570: 2061 7267 756d 656e 7473 2022 0a20 2020   arguments ".   
-0004d580: 2020 2020 2022 666f 726d 696e 6720 7061       "forming pa
-0004d590: 6972 732e 2059 6f75 2063 616e 2068 6176  irs. You can hav
-0004d5a0: 6520 6d75 6c74 6970 6c65 2072 6f6f 6d20  e multiple room 
-0004d5b0: 616c 6961 7365 7320 7065 7220 726f 6f6d  aliases per room
-0004d5c0: 2e20 536f 2c20 220a 2020 2020 2020 2020  . So, ".        
-0004d5d0: 2279 6f75 206d 6179 2061 6464 206d 756c  "you may add mul
-0004d5e0: 7469 706c 6520 616c 6961 7365 7320 746f  tiple aliases to
-0004d5f0: 2074 6865 2073 616d 6520 726f 6f6d 2e20   the same room. 
-0004d600: 220a 2020 2020 2020 2020 2241 2072 6f6f  ".        "A roo
-0004d610: 6d20 616c 6961 7320 6c6f 6f6b 7320 6c69  m alias looks li
-0004d620: 6b65 2074 6869 733a 2022 0a20 2020 2020  ke this: ".     
-0004d630: 2020 2022 2723 736f 6d65 526f 6f6d 416c     "'#someRoomAl
-0004d640: 6961 733a 6d61 7472 6978 2e65 7861 6d70  ias:matrix.examp
-0004d650: 6c65 2e6f 7267 272e 2053 686f 7274 2061  le.org'. Short a
-0004d660: 6c69 6173 6573 206c 696b 6520 220a 2020  liases like ".  
-0004d670: 2020 2020 2020 2227 736f 6d65 526f 6f6d        "'someRoom
-0004d680: 416c 6961 7327 206f 7220 2723 736f 6d65  Alias' or '#some
-0004d690: 526f 6f6d 416c 6961 7327 2061 7265 2061  RoomAlias' are a
-0004d6a0: 6c73 6f20 6163 6365 7074 6564 2e20 220a  lso accepted. ".
-0004d6b0: 2020 2020 2020 2020 2249 6e20 6361 7365          "In case
-0004d6c0: 206f 6620 6120 7368 6f72 7420 616c 6961   of a short alia
-0004d6d0: 732c 2022 0a20 2020 2020 2020 2022 6974  s, ".        "it
-0004d6e0: 2077 696c 6c20 6265 2061 7574 6f6d 6174   will be automat
-0004d6f0: 6963 616c 6c79 2070 7265 6669 7865 6420  ically prefixed 
-0004d700: 7769 7468 2027 2327 2061 6e64 2074 6865  with '#' and the
-0004d710: 2022 0a20 2020 2020 2020 2022 686f 6d65   ".        "home
-0004d720: 7365 7276 6572 2077 696c 6c20 6265 2061  server will be a
-0004d730: 7574 6f6d 6174 6963 616c 6c79 2061 7070  utomatically app
-0004d740: 656e 6465 642e 2022 0a20 2020 2020 2020  ended. ".       
-0004d750: 2022 4164 6469 6e67 2074 6865 2073 616d   "Adding the sam
-0004d760: 6520 616c 6961 7320 220a 2020 2020 2020  e alias ".      
-0004d770: 2020 226d 756c 7469 706c 6520 7469 6d65    "multiple time
-0004d780: 7320 746f 2074 6865 2073 616d 6520 726f  s to the same ro
-0004d790: 6f6d 2072 6573 756c 7473 2069 6e20 616e  om results in an
-0004d7a0: 2065 7272 6f72 2e20 220a 2020 2020 2020   error. ".      
-0004d7b0: 2020 222d 2d72 6f6f 6d2d 7075 742d 616c    "--room-put-al
-0004d7c0: 6961 7320 6973 2065 7169 7661 6c65 6e74  ias is eqivalent
-0004d7d0: 2074 6f20 2d2d 726f 6f6d 2d73 6574 2d61   to --room-set-a
-0004d7e0: 6c69 6173 2e22 2c0a 2020 2020 290a 2020  lias.",.    ).  
-0004d7f0: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-0004d800: 7428 0a20 2020 2020 2020 2022 2d2d 726f  t(.        "--ro
-0004d810: 6f6d 2d72 6573 6f6c 7665 2d61 6c69 6173  om-resolve-alias
-0004d820: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-0004d830: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-0004d840: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
-0004d850: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
-0004d860: 733d 222b 222c 0a20 2020 2020 2020 2074  s="+",.        t
-0004d870: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-0004d880: 206d 6574 6176 6172 3d22 524f 4f4d 5f41   metavar="ROOM_A
-0004d890: 4c49 4153 222c 0a20 2020 2020 2020 2068  LIAS",.        h
-0004d8a0: 656c 703d 2253 686f 7720 726f 6f6d 2069  elp="Show room i
-0004d8b0: 6473 2063 6f72 7265 7370 6f6e 6469 6e67  ds corresponding
-0004d8c0: 2074 6f20 726f 6f6d 2061 6c69 6173 6573   to room aliases
-0004d8d0: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-0004d8e0: 6169 6c73 3a3a 2052 6573 6f6c 7665 7320  ails:: Resolves 
-0004d8f0: 6120 726f 6f6d 2061 6c69 6173 2074 6f20  a room alias to 
-0004d900: 7468 6520 636f 7272 6573 706f 6e64 696e  the correspondin
-0004d910: 6720 726f 6f6d 2069 642c 2022 0a20 2020  g room id, ".   
-0004d920: 2020 2020 2022 6f72 206d 756c 7469 706c       "or multipl
-0004d930: 6520 726f 6f6d 2061 6c69 6173 6573 2074  e room aliases t
-0004d940: 6f20 7468 6569 7220 636f 7272 6573 706f  o their correspo
-0004d950: 6e64 696e 6720 726f 6f6d 2069 6473 2e20  nding room ids. 
-0004d960: 220a 2020 2020 2020 2020 2250 726f 7669  ".        "Provi
-0004d970: 6465 206f 6e65 206f 7220 6d75 6c74 6970  de one or multip
-0004d980: 6c65 2072 6f6f 6d20 616c 6961 7365 732e  le room aliases.
-0004d990: 2022 0a20 2020 2020 2020 2022 4120 726f   ".        "A ro
-0004d9a0: 6f6d 2061 6c69 6173 206c 6f6f 6b73 206c  om alias looks l
-0004d9b0: 696b 6520 7468 6973 3a20 220a 2020 2020  ike this: ".    
-0004d9c0: 2020 2020 2227 2373 6f6d 6552 6f6f 6d41      "'#someRoomA
-0004d9d0: 6c69 6173 3a6d 6174 7269 782e 6578 616d  lias:matrix.exam
-0004d9e0: 706c 652e 6f72 6727 2e20 5368 6f72 7420  ple.org'. Short 
-0004d9f0: 616c 6961 7365 7320 6c69 6b65 2022 0a20  aliases like ". 
-0004da00: 2020 2020 2020 2022 2773 6f6d 6552 6f6f         "'someRoo
-0004da10: 6d41 6c69 6173 2720 6f72 2027 2373 6f6d  mAlias' or '#som
-0004da20: 6552 6f6f 6d41 6c69 6173 2720 6172 6520  eRoomAlias' are 
-0004da30: 616c 736f 2061 6363 6570 7465 642e 2022  also accepted. "
-0004da40: 0a20 2020 2020 2020 2022 496e 2063 6173  .        "In cas
-0004da50: 6520 6f66 2061 2073 686f 7274 2061 6c69  e of a short ali
-0004da60: 6173 2c20 220a 2020 2020 2020 2020 2269  as, ".        "i
-0004da70: 7420 7769 6c6c 2062 6520 6175 746f 6d61  t will be automa
-0004da80: 7469 6361 6c6c 7920 7072 6566 6978 6564  tically prefixed
-0004da90: 2077 6974 6820 2723 2720 616e 6420 7468   with '#' and th
-0004daa0: 6520 220a 2020 2020 2020 2020 6622 686f  e ".        f"ho
-0004dab0: 6d65 7365 7276 6572 2066 726f 6d20 7468  meserver from th
-0004dac0: 6520 6465 6661 756c 7420 726f 6f6d 206f  e default room o
-0004dad0: 6620 7b50 524f 475f 5749 5448 4f55 545f  f {PROG_WITHOUT_
-0004dae0: 4558 547d 2028 6173 2066 6f75 6e64 2022  EXT} (as found "
-0004daf0: 0a20 2020 2020 2020 2022 696e 2063 7265  .        "in cre
-0004db00: 6465 6e74 6961 6c73 2066 696c 6529 2077  dentials file) w
-0004db10: 696c 6c20 6265 2061 7574 6f6d 6174 6963  ill be automatic
-0004db20: 616c 6c79 2061 7070 656e 6465 642e 2022  ally appended. "
-0004db30: 0a20 2020 2020 2020 2022 5265 736f 6c76  .        "Resolv
-0004db40: 696e 6720 616e 2061 6c69 6173 2074 6861  ing an alias tha
-0004db50: 7420 646f 6573 206e 6f74 2065 7869 7374  t does not exist
-0004db60: 2072 6573 756c 7473 2069 6e20 616e 2065   results in an e
-0004db70: 7272 6f72 2e20 220a 2020 2020 2020 2020  rror. ".        
-0004db80: 2246 6f72 2065 6163 6820 726f 6f6d 2061  "For each room a
-0004db90: 6c69 6173 206f 6e65 206c 696e 6520 7769  lias one line wi
-0004dba0: 6c6c 2062 6520 7072 696e 7465 6420 746f  ll be printed to
-0004dbb0: 2073 7464 6f75 7420 7769 7468 2074 6865   stdout with the
-0004dbc0: 2022 0a20 2020 2020 2020 2022 7265 7375   ".        "resu
-0004dbd0: 6c74 2e22 2c0a 2020 2020 290a 2020 2020  lt.",.    ).    
-0004dbe0: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-0004dbf0: 0a20 2020 2020 2020 2022 2d2d 726f 6f6d  .        "--room
-0004dc00: 2d64 656c 6574 652d 616c 6961 7322 2c0a  -delete-alias",.
-0004dc10: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0004dc20: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0004dc30: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
-0004dc40: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-0004dc50: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
-0004dc60: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
-0004dc70: 7461 7661 723d 2252 4f4f 4d5f 414c 4941  tavar="ROOM_ALIA
-0004dc80: 5322 2c0a 2020 2020 2020 2020 6865 6c70  S",.        help
-0004dc90: 3d22 4465 6c65 7465 206f 6e65 206f 7220  ="Delete one or 
-0004dca0: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2061  multiple rooms a
-0004dcb0: 6c69 6173 6573 2e20 220a 2020 2020 2020  liases. ".      
-0004dcc0: 2020 2244 6574 6169 6c73 3a3a 2050 726f    "Details:: Pro
-0004dcd0: 7669 6465 206f 6e65 206f 7220 6d75 6c74  vide one or mult
-0004dce0: 6970 6c65 2072 6f6f 6d20 616c 6961 7365  iple room aliase
-0004dcf0: 732e 2022 0a20 2020 2020 2020 2022 596f  s. ".        "Yo
-0004dd00: 7520 6361 6e20 6861 7665 206d 756c 7469  u can have multi
-0004dd10: 706c 6520 726f 6f6d 2061 6c69 6173 6573  ple room aliases
-0004dd20: 2070 6572 2072 6f6f 6d2e 2053 6f2c 2022   per room. So, "
-0004dd30: 0a20 2020 2020 2020 2022 796f 7520 6d61  .        "you ma
-0004dd40: 7920 6465 6c65 7465 206d 756c 7469 706c  y delete multipl
-0004dd50: 6520 616c 6961 7365 7320 6672 6f6d 2074  e aliases from t
-0004dd60: 6865 2073 616d 6520 726f 6f6d 206f 7220  he same room or 
-0004dd70: 6672 6f6d 2064 6966 6665 7265 6e74 2022  from different "
-0004dd80: 0a20 2020 2020 2020 2022 726f 6f6d 732e  .        "rooms.
-0004dd90: 2022 0a20 2020 2020 2020 2022 4120 726f   ".        "A ro
-0004dda0: 6f6d 2061 6c69 6173 206c 6f6f 6b73 206c  om alias looks l
-0004ddb0: 696b 6520 7468 6973 3a20 220a 2020 2020  ike this: ".    
-0004ddc0: 2020 2020 2227 2373 6f6d 6552 6f6f 6d41      "'#someRoomA
-0004ddd0: 6c69 6173 3a6d 6174 7269 782e 6578 616d  lias:matrix.exam
-0004dde0: 706c 652e 6f72 6727 2e20 5368 6f72 7420  ple.org'. Short 
-0004ddf0: 616c 6961 7365 7320 6c69 6b65 2022 0a20  aliases like ". 
-0004de00: 2020 2020 2020 2022 2773 6f6d 6552 6f6f         "'someRoo
-0004de10: 6d41 6c69 6173 2720 6f72 2027 2373 6f6d  mAlias' or '#som
-0004de20: 6552 6f6f 6d41 6c69 6173 2720 6172 6520  eRoomAlias' are 
-0004de30: 616c 736f 2061 6363 6570 7465 642e 2022  also accepted. "
-0004de40: 0a20 2020 2020 2020 2022 496e 2063 6173  .        "In cas
-0004de50: 6520 6f66 2061 2073 686f 7274 2061 6c69  e of a short ali
-0004de60: 6173 2c20 220a 2020 2020 2020 2020 2269  as, ".        "i
-0004de70: 7420 7769 6c6c 2062 6520 6175 746f 6d61  t will be automa
-0004de80: 7469 6361 6c6c 7920 7072 6566 6978 6564  tically prefixed
-0004de90: 2077 6974 6820 2723 2720 616e 6420 7468   with '#' and th
-0004dea0: 6520 220a 2020 2020 2020 2020 6622 686f  e ".        f"ho
-0004deb0: 6d65 7365 7276 6572 2066 726f 6d20 7468  meserver from th
-0004dec0: 6520 6465 6661 756c 7420 726f 6f6d 206f  e default room o
-0004ded0: 6620 7b50 524f 475f 5749 5448 4f55 545f  f {PROG_WITHOUT_
-0004dee0: 4558 547d 2028 6173 2066 6f75 6e64 2022  EXT} (as found "
-0004def0: 0a20 2020 2020 2020 2022 696e 2063 7265  .        "in cre
-0004df00: 6465 6e74 6961 6c73 2066 696c 6529 2077  dentials file) w
-0004df10: 696c 6c20 6265 2061 7574 6f6d 6174 6963  ill be automatic
-0004df20: 616c 6c79 2061 7070 656e 6465 642e 2022  ally appended. "
-0004df30: 0a20 2020 2020 2020 2022 4465 6c65 7469  .        "Deleti
-0004df40: 6e67 2061 6e20 616c 6961 7320 7468 6174  ng an alias that
-0004df50: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
-0004df60: 7265 7375 6c74 7320 696e 2061 6e20 6572  results in an er
-0004df70: 726f 722e 222c 0a20 2020 2029 0a20 2020  ror.",.    ).   
-0004df80: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-0004df90: 280a 2020 2020 2020 2020 222d 2d67 6574  (.        "--get
-0004dfa0: 2d6f 7065 6e69 642d 746f 6b65 6e22 2c0a  -openid-token",.
-0004dfb0: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0004dfc0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0004dfd0: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
-0004dfe0: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-0004dff0: 2a22 2c20 2023 204e 6f6e 6520 6966 206e  *",  # None if n
-0004e000: 6f74 2075 7365 642c 205b 5d20 6973 2075  ot used, [] is u
-0004e010: 7365 6420 7769 7468 6f75 7420 6578 7472  sed without extr
-0004e020: 6120 6172 6773 0a20 2020 2020 2020 2074  a args.        t
-0004e030: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-0004e040: 206d 6574 6176 6172 3d22 5553 4552 222c   metavar="USER",
-0004e050: 0a20 2020 2020 2020 2068 656c 703d 2247  .        help="G
-0004e060: 6574 2061 6e20 4f70 656e 4944 2074 6f6b  et an OpenID tok
-0004e070: 656e 2e20 220a 2020 2020 2020 2020 6622  en. ".        f"
-0004e080: 4465 7461 696c 733a 3a20 4765 7420 616e  Details:: Get an
-0004e090: 204f 7065 6e49 4420 746f 6b65 6e20 666f   OpenID token fo
-0004e0a0: 7220 7b50 524f 475f 5749 5448 4f55 545f  r {PROG_WITHOUT_
-0004e0b0: 4558 547d 2c20 6f72 2066 6f72 2022 0a20  EXT}, or for ". 
-0004e0c0: 2020 2020 2020 2022 6f6e 6520 6f72 206d         "one or m
-0004e0d0: 756c 7469 706c 6520 6f74 6865 7220 7573  ultiple other us
-0004e0e0: 6572 732e 2049 7420 7072 696e 7473 2061  ers. It prints a
-0004e0f0: 6e20 4f70 656e 4944 2074 6f6b 656e 206f  n OpenID token o
-0004e100: 626a 6563 7420 220a 2020 2020 2020 2020  bject ".        
-0004e110: 2274 6861 7420 7468 6520 7265 7175 6573  "that the reques
-0004e120: 7465 7220 6d61 7920 7375 7070 6c79 2074  ter may supply t
-0004e130: 6f20 616e 6f74 6865 7220 7365 7276 6963  o another servic
-0004e140: 6520 746f 2076 6572 6966 7920 7468 6569  e to verify thei
-0004e150: 7220 220a 2020 2020 2020 2020 2269 6465  r ".        "ide
-0004e160: 6e74 6974 7920 696e 204d 6174 7269 782e  ntity in Matrix.
-0004e170: 2053 6565 2068 7474 703a 2f2f 7777 772e   See http://www.
-0004e180: 6f70 656e 6964 2e6e 6574 2f2e 2022 0a20  openid.net/. ". 
-0004e190: 2020 2020 2020 2022 5370 6563 6966 7920         "Specify 
-0004e1a0: 7a65 726f 206f 7220 6d6f 7265 2075 7365  zero or more use
-0004e1b0: 7220 6964 732e 2022 0a20 2020 2020 2020  r ids. ".       
-0004e1c0: 2066 2249 6620 6e6f 2075 7365 7220 6964   f"If no user id
-0004e1d0: 2069 7320 7370 6563 6966 6965 642c 2061   is specified, a
-0004e1e0: 6e20 4f70 656e 4944 2066 6f72 207b 5052  n OpenID for {PR
-0004e1f0: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
-0004e200: 7769 6c6c 2022 0a20 2020 2020 2020 2022  will ".        "
-0004e210: 6265 2066 6574 6368 6564 2e20 4966 206f  be fetched. If o
-0004e220: 6e65 206f 7220 6d6f 7265 2075 7365 7220  ne or more user 
-0004e230: 6964 7320 6172 6520 6769 7665 6e2c 2074  ids are given, t
-0004e240: 6865 204f 7065 6e49 4420 6f66 2022 0a20  he OpenID of ". 
-0004e250: 2020 2020 2020 2022 7468 6573 6520 7573         "these us
-0004e260: 6572 7320 7769 6c6c 2062 6520 6665 7463  ers will be fetc
-0004e270: 6865 642e 2041 7320 7265 7370 6f6e 7365  hed. As response
-0004e280: 2074 6865 2075 7365 7220 6964 2873 2920   the user id(s) 
-0004e290: 616e 6420 220a 2020 2020 2020 2020 224f  and ".        "O
-0004e2a0: 7065 6e49 4428 7329 2077 696c 6c20 6265  penID(s) will be
-0004e2b0: 2070 7269 6e74 6564 2e22 2c0a 2020 2020   printed.",.    
-0004e2c0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-0004e2d0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-0004e2e0: 2d2d 726f 6f6d 2d67 6574 2d76 6973 6962  --room-get-visib
-0004e2f0: 696c 6974 7922 2c0a 2020 2020 2020 2020  ility",.        
-0004e300: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
-0004e310: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
-0004e320: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
-0004e330: 206e 6172 6773 3d22 2a22 2c20 2023 204e   nargs="*",  # N
-0004e340: 6f6e 6520 6966 206e 6f74 2075 7365 642c  one if not used,
-0004e350: 205b 5d20 6973 2075 7365 6420 7769 7468   [] is used with
-0004e360: 6f75 7420 6578 7472 6120 6172 6773 0a20  out extra args. 
-0004e370: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
-0004e380: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
-0004e390: 3d22 524f 4f4d 222c 0a20 2020 2020 2020  ="ROOM",.       
-0004e3a0: 2068 656c 703d 2247 6574 2074 6865 2076   help="Get the v
-0004e3b0: 6973 6962 696c 6974 7920 6f66 206f 6e65  isibility of one
-0004e3c0: 206f 7220 6d6f 7265 2072 6f6f 6d73 2e20   or more rooms. 
-0004e3d0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-0004e3e0: 6c73 3a3a 2050 726f 7669 6465 207a 6572  ls:: Provide zer
-0004e3f0: 6f20 6f72 206d 6f72 6520 726f 6f6d 2069  o or more room i
-0004e400: 6473 2061 7320 6172 6775 6d65 6e74 732e  ds as arguments.
-0004e410: 2022 0a20 2020 2020 2020 2022 4966 206e   ".        "If n
-0004e420: 6f20 6172 6775 6d65 6e74 2069 7320 6769  o argument is gi
-0004e430: 7665 6e2c 2074 6865 6e20 7468 6520 6465  ven, then the de
-0004e440: 6661 756c 7420 726f 6f6d 206f 6620 220a  fault room of ".
-0004e450: 2020 2020 2020 2020 6622 7b50 524f 475f          f"{PROG_
-0004e460: 5749 5448 4f55 545f 4558 547d 2028 6173  WITHOUT_EXT} (as
-0004e470: 2066 6f75 6e64 2069 6e20 6372 6564 656e   found in creden
-0004e480: 7469 616c 7320 6669 6c65 2920 7769 6c6c  tials file) will
-0004e490: 2062 6520 7573 6564 2e20 220a 2020 2020   be used. ".    
-0004e4a0: 2020 2020 2246 6f72 2065 6163 6820 726f      "For each ro
-0004e4b0: 6f6d 2074 6865 2076 6973 6962 696c 6974  om the visibilit
-0004e4c0: 7920 7769 6c6c 2062 6520 7072 696e 7465  y will be printe
-0004e4d0: 642e 2043 7572 7265 6e74 6c79 2c20 7468  d. Currently, th
-0004e4e0: 6973 2022 0a20 2020 2020 2020 2022 6973  is ".        "is
-0004e4f0: 2065 6974 6865 7220 7468 6520 7374 7269   either the stri
-0004e500: 6e67 2027 7072 6976 6174 6527 206f 7220  ng 'private' or 
-0004e510: 2770 7562 6c69 6327 2e20 220a 2020 2020  'public'. ".    
-0004e520: 2020 2020 2241 7320 7265 7370 6f6e 7365      "As response
-0004e530: 206f 6e65 206c 696e 6520 7065 7220 726f   one line per ro
-0004e540: 6f6d 2077 696c 6c20 6265 2070 7269 6e74  om will be print
-0004e550: 6564 2074 6f20 7374 646f 7574 2e22 2c0a  ed to stdout.",.
-0004e560: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
-0004e570: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
-0004e580: 2020 2022 2d2d 726f 6f6d 2d67 6574 2d73     "--room-get-s
-0004e590: 7461 7465 222c 0a20 2020 2020 2020 2072  tate",.        r
-0004e5a0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-0004e5b0: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
-0004e5c0: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
-0004e5d0: 6e61 7267 733d 222a 222c 2020 2320 4e6f  nargs="*",  # No
-0004e5e0: 6e65 2069 6620 6e6f 7420 7573 6564 2c20  ne if not used, 
-0004e5f0: 5b5d 2069 7320 7573 6564 2077 6974 686f  [] is used witho
-0004e600: 7574 2065 7874 7261 2061 7267 730a 2020  ut extra args.  
-0004e610: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
-0004e620: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-0004e630: 2252 4f4f 4d22 2c0a 2020 2020 2020 2020  "ROOM",.        
-0004e640: 6865 6c70 3d22 4765 7420 7468 6520 7374  help="Get the st
-0004e650: 6174 6520 6f66 206f 6e65 206f 7220 6d6f  ate of one or mo
-0004e660: 7265 2072 6f6f 6d73 2e20 220a 2020 2020  re rooms. ".    
-0004e670: 2020 2020 2244 6574 6169 6c73 3a3a 5072      "Details::Pr
-0004e680: 6f76 6964 6520 7a65 726f 206f 7220 6d6f  ovide zero or mo
-0004e690: 7265 2072 6f6f 6d20 6964 7320 6173 2061  re room ids as a
-0004e6a0: 7267 756d 656e 7473 2e20 220a 2020 2020  rguments. ".    
-0004e6b0: 2020 2020 2249 6620 6e6f 2061 7267 756d      "If no argum
-0004e6c0: 656e 7420 6973 2067 6976 656e 2c20 7468  ent is given, th
-0004e6d0: 656e 2074 6865 2064 6566 6175 6c74 2072  en the default r
-0004e6e0: 6f6f 6d20 6f66 2022 0a20 2020 2020 2020  oom of ".       
-0004e6f0: 2066 227b 5052 4f47 5f57 4954 484f 5554   f"{PROG_WITHOUT
-0004e700: 5f45 5854 7d20 2861 7320 666f 756e 6420  _EXT} (as found 
-0004e710: 696e 2063 7265 6465 6e74 6961 6c73 2066  in credentials f
-0004e720: 696c 6529 2077 696c 6c20 6265 2075 7365  ile) will be use
-0004e730: 642e 2022 0a20 2020 2020 2020 2022 466f  d. ".        "Fo
-0004e740: 7220 6561 6368 2072 6f6f 6d20 7468 6520  r each room the 
-0004e750: 7374 6174 6520 7769 6c6c 2062 6520 7072  state will be pr
-0004e760: 696e 7465 642e 2054 6865 2073 7461 7465  inted. The state
-0004e770: 2069 7320 6120 6c6f 6e67 2022 0a20 2020   is a long ".   
-0004e780: 2020 2020 2022 6c69 7374 206f 6620 6576       "list of ev
-0004e790: 656e 7473 2069 6e63 6c75 6469 6e67 2065  ents including e
-0004e7a0: 7665 6e74 7320 6c69 6b65 2027 6d2e 726f  vents like 'm.ro
-0004e7b0: 6f6d 2e63 7265 6174 6527 2c20 220a 2020  om.create', ".  
-0004e7c0: 2020 2020 2020 2227 6d2e 726f 6f6d 2e65        "'m.room.e
-0004e7d0: 6e63 7279 7074 696f 6e27 2c20 276d 2e72  ncryption', 'm.r
-0004e7e0: 6f6f 6d2e 6775 6573 745f 6163 6365 7373  oom.guest_access
-0004e7f0: 272c 2022 0a20 2020 2020 2020 2022 276d  ', ".        "'m
-0004e800: 2e72 6f6f 6d2e 6869 7374 6f72 795f 7669  .room.history_vi
-0004e810: 7369 6269 6c69 7479 272c 2027 6d2e 726f  sibility', 'm.ro
-0004e820: 6f6d 2e6a 6f69 6e5f 7275 6c65 7327 2c20  om.join_rules', 
-0004e830: 220a 2020 2020 2020 2020 2227 6d2e 726f  ".        "'m.ro
-0004e840: 6f6d 2e6d 656d 6265 7227 2c20 276d 2e72  om.member', 'm.r
-0004e850: 6f6f 6d2e 706f 7765 725f 6c65 7665 6c73  oom.power_levels
-0004e860: 272c 2065 7463 2e20 220a 2020 2020 2020  ', etc. ".      
-0004e870: 2020 2241 7320 7265 7370 6f6e 7365 206f    "As response o
-0004e880: 6e65 206c 696e 6520 7065 7220 726f 6f6d  ne line per room
-0004e890: 2077 696c 6c20 6265 2070 7269 6e74 6564   will be printed
-0004e8a0: 2074 6f20 7374 646f 7574 2e20 220a 2020   to stdout. ".  
-0004e8b0: 2020 2020 2020 2254 6865 206c 696e 6520        "The line 
-0004e8c0: 6361 6e20 6265 2076 6572 7920 6c6f 6e67  can be very long
-0004e8d0: 2061 7320 7468 6520 6c69 7374 206f 6620   as the list of 
-0004e8e0: 6576 656e 7473 2063 616e 2062 6520 7665  events can be ve
-0004e8f0: 7279 206c 6172 6765 2e20 220a 2020 2020  ry large. ".    
-0004e900: 2020 2020 2254 6f20 6765 7420 6f75 7470      "To get outp
-0004e910: 7574 2069 6e74 6f20 6120 6875 6d61 6e20  ut into a human 
-0004e920: 7265 6164 6162 6c65 2066 6f72 6d20 7069  readable form pi
-0004e930: 7065 206f 7574 7075 7420 7468 726f 7567  pe output throug
-0004e940: 6820 7365 6420 220a 2020 2020 2020 2020  h sed ".        
-0004e950: 2261 6e64 206a 7120 6173 2073 686f 776e  "and jq as shown
-0004e960: 2069 6e20 616e 2065 7861 6d70 6c65 2069   in an example i
-0004e970: 6e20 7465 7374 732f 7465 7374 2d73 6574  n tests/test-set
-0004e980: 6765 742e 7368 2e22 2c0a 2020 2020 290a  get.sh.",.    ).
-0004e990: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
-0004e9a0: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
-0004e9b0: 6465 6c65 7465 2d64 6576 6963 6522 2c0a  delete-device",.
-0004e9c0: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0004e9d0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0004e9e0: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
-0004e9f0: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
-0004ea00: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
-0004ea10: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
-0004ea20: 7461 7661 723d 2244 4556 4943 4522 2c0a  tavar="DEVICE",.
-0004ea30: 2020 2020 2020 2020 6865 6c70 3d66 2244          help=f"D
-0004ea40: 656c 6574 6520 6f6e 6520 6f72 206d 756c  elete one or mul
-0004ea50: 7469 706c 6520 6465 7669 6365 732e 2022  tiple devices. "
-0004ea60: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
-0004ea70: 733a 3a20 4279 2064 6566 6175 6c74 2064  s:: By default d
-0004ea80: 6576 6963 6573 2062 656c 6f6e 6769 6e67  evices belonging
-0004ea90: 2022 0a20 2020 2020 2020 2066 2274 6f20   ".        f"to 
-0004eaa0: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
-0004eab0: 547d 2077 696c 6c20 6265 2064 656c 6574  T} will be delet
-0004eac0: 6564 2e20 4966 2074 6865 2064 6576 6963  ed. If the devic
-0004ead0: 6573 2062 656c 6f6e 6720 220a 2020 2020  es belong ".    
-0004eae0: 2020 2020 2274 6f20 6120 6469 6666 6572      "to a differ
-0004eaf0: 656e 7420 7573 6572 2c20 7573 6520 7468  ent user, use th
-0004eb00: 6520 2d2d 7573 6572 2061 7267 756d 656e  e --user argumen
-0004eb10: 7420 746f 2073 7065 6369 6679 2074 6865  t to specify the
-0004eb20: 2075 7365 722c 2022 0a20 2020 2020 2020   user, ".       
-0004eb30: 2022 692e 652e 206f 776e 6572 2e20 4f6e   "i.e. owner. On
-0004eb40: 6c79 2022 0a20 2020 2020 2020 2022 6578  ly ".        "ex
-0004eb50: 6163 746c 7920 6f6e 6520 7573 6572 2063  actly one user c
-0004eb60: 616e 2062 6520 7370 6563 6966 6965 6420  an be specified 
-0004eb70: 7769 7468 2074 6865 206f 7074 696f 6e61  with the optiona
-0004eb80: 6c20 2d2d 7573 6572 2061 7267 756d 656e  l --user argumen
-0004eb90: 742e 2022 0a20 2020 2020 2020 2022 4465  t. ".        "De
-0004eba0: 7669 6365 2064 656c 6574 696f 6e20 7265  vice deletion re
-0004ebb0: 7175 6972 6573 2074 6865 2075 7365 7220  quires the user 
-0004ebc0: 7061 7373 776f 7264 2e20 4974 206d 7573  password. It mus
-0004ebd0: 7420 6265 2073 7065 6369 6669 6564 2022  t be specified "
-0004ebe0: 0a20 2020 2020 2020 2022 7769 7468 2074  .        "with t
-0004ebf0: 6865 202d 2d70 6173 7377 6f72 6420 6172  he --password ar
-0004ec00: 6775 6d65 6e74 2e20 4966 2074 6865 2073  gument. If the s
-0004ec10: 6572 7665 7220 7573 6573 206f 6e6c 7920  erver uses only 
-0004ec20: 4854 5450 2028 616e 6420 220a 2020 2020  HTTP (and ".    
-0004ec30: 2020 2020 226e 6f74 2048 5454 5053 292c      "not HTTPS),
-0004ec40: 2074 6865 6e20 7468 6520 7061 7373 776f   then the passwo
-0004ec50: 7264 2063 616e 2062 6520 7669 7369 626c  rd can be visibl
-0004ec60: 6520 746f 2061 7474 6163 6b65 7273 2e20  e to attackers. 
-0004ec70: 4865 6e63 652c 2022 0a20 2020 2020 2020  Hence, ".       
-0004ec80: 2022 6966 2074 6865 2073 6572 7665 7220   "if the server 
-0004ec90: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0004eca0: 2048 5454 5053 2074 6869 7320 6f70 6572   HTTPS this oper
-0004ecb0: 6174 696f 6e20 6973 2064 6973 636f 7572  ation is discour
-0004ecc0: 6167 6564 2e22 2c0a 2020 2020 290a 2020  aged.",.    ).  
-0004ecd0: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
-0004ece0: 7428 0a20 2020 2020 2020 2022 2d2d 726f  t(.        "--ro
-0004ecf0: 6f6d 2d72 6564 6163 7422 2c0a 2020 2020  om-redact",.    
-0004ed00: 2020 2020 222d 2d72 6f6f 6d2d 6465 6c65      "--room-dele
-0004ed10: 7465 2d63 6f6e 7465 6e74 222c 0a20 2020  te-content",.   
-0004ed20: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
-0004ed30: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
-0004ed40: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
-0004ed50: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
-0004ed60: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-0004ed70: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-0004ed80: 6172 3d22 524f 4f4d 5f49 4420 4556 454e  ar="ROOM_ID EVEN
-0004ed90: 545f 4944 2052 4541 534f 4e22 2c0a 2020  T_ID REASON",.  
-0004eda0: 2020 2020 2020 6865 6c70 3d22 5374 7269        help="Stri
-0004edb0: 7020 696e 666f 726d 6174 696f 6e20 6f75  p information ou
-0004edc0: 7420 6f66 206f 6e65 206f 7220 7365 7665  t of one or seve
-0004edd0: 7261 6c20 6576 656e 7473 2e20 220a 2020  ral events. ".  
-0004ede0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
-0004edf0: 2022 0a20 2020 2020 2020 2022 5374 7269   ".        "Stri
-0004ee00: 7020 696e 666f 726d 6174 696f 6e20 6672  p information fr
-0004ee10: 6f6d 2065 7665 6e74 732c 2065 2e67 2e20  om events, e.g. 
-0004ee20: 6d65 7373 6167 6573 2e20 220a 2020 2020  messages. ".    
-0004ee30: 2020 2020 2252 6564 6163 7420 6973 2075      "Redact is u
-0004ee40: 7365 6420 696e 2074 6865 206d 6561 6e69  sed in the meani
-0004ee50: 6e67 206f 6620 2773 7472 6970 2c20 7769  ng of 'strip, wi
-0004ee60: 7065 2c20 626c 6163 6b2d 6f75 7427 2c20  pe, black-out', 
-0004ee70: 6e6f 7420 220a 2020 2020 2020 2020 2269  not ".        "i
-0004ee80: 6e20 7468 6520 6d65 616e 696e 6720 6f66  n the meaning of
-0004ee90: 2027 6564 6974 272e 2054 6869 7320 6163   'edit'. This ac
-0004eea0: 7469 6f6e 2072 656d 6f76 6573 2c20 6465  tion removes, de
-0004eeb0: 6c65 7465 7320 7468 6520 636f 6e74 656e  letes the conten
-0004eec0: 7420 220a 2020 2020 2020 2020 226f 6620  t ".        "of 
-0004eed0: 616e 2065 7665 6e74 2077 6869 6c65 206e  an event while n
-0004eee0: 6f74 2072 656d 6f76 696e 6720 7468 6520  ot removing the 
-0004eef0: 6576 656e 742e 2059 6f75 2063 616e 2077  event. You can w
-0004ef00: 6970 6520 7465 7874 2066 726f 6d20 6120  ipe text from a 
-0004ef10: 220a 2020 2020 2020 2020 2270 7265 7669  ".        "previ
-0004ef20: 6f75 7320 6d65 7373 6167 652c 2065 7463  ous message, etc
-0004ef30: 2e20 5479 7069 6361 6c20 4d61 7472 6978  . Typical Matrix
-0004ef40: 2063 6c69 656e 7473 206c 696b 6520 456c   clients like El
-0004ef50: 656d 656e 7420 7769 6c6c 2022 0a20 2020  ement will ".   
-0004ef60: 2020 2020 2022 6465 6c65 7465 206d 6573       "delete mes
-0004ef70: 7361 6765 732c 2069 6d61 6765 7320 616e  sages, images an
-0004ef80: 6420 6f74 6865 7220 6f62 6a65 6374 7320  d other objects 
-0004ef90: 6672 6f6d 2074 6865 2047 5549 206f 6e63  from the GUI onc
-0004efa0: 6520 7468 6579 2022 0a20 2020 2020 2020  e they ".       
-0004efb0: 2022 6861 7665 2062 6565 6e20 7265 6461   "have been reda
-0004efc0: 6374 6564 2e20 220a 2020 2020 2020 2020  cted. ".        
-0004efd0: 2253 6f2c 202d 2d72 6f6f 6d2d 7265 6461  "So, --room-reda
-0004efe0: 6374 2069 7320 6120 7761 7920 746f 2064  ct is a way to d
-0004eff0: 656c 6574 6520 6120 6d65 7373 6167 652c  elete a message,
-0004f000: 2069 6d61 6765 732c 2065 7463 2e20 220a   images, etc. ".
-0004f010: 2020 2020 2020 2020 2254 6865 2063 6f6e          "The con
-0004f020: 7465 6e74 2069 7320 220a 2020 2020 2020  tent is ".      
-0004f030: 2020 2277 6970 6564 2c20 7468 6520 4755    "wiped, the GU
-0004f040: 4920 6465 6c65 7465 7320 7468 6520 6d65  I deletes the me
-0004f050: 7373 6167 652c 2062 7574 2074 6865 2073  ssage, but the s
-0004f060: 6572 7665 7220 6b65 6570 7320 7468 6520  erver keeps the 
-0004f070: 6576 656e 7420 220a 2020 2020 2020 2020  event ".        
-0004f080: 2268 6973 746f 7279 2e20 4e6f 7465 2c20  "history. Note, 
-0004f090: 7768 696c 6520 7468 6973 2064 656c 6574  while this delet
-0004f0a0: 6573 2066 726f 6d20 7468 6520 636c 6965  es from the clie
-0004f0b0: 6e74 2028 4755 492c 2065 2e67 2e20 220a  nt (GUI, e.g. ".
-0004f0c0: 2020 2020 2020 2020 2245 6c65 6d65 6e74          "Element
-0004f0d0: 292c 2069 7420 646f 6573 206e 6f74 2064  ), it does not d
-0004f0e0: 656c 6574 6520 6672 6f6d 2074 6865 2064  elete from the d
-0004f0f0: 6174 6162 6173 6520 6f6e 2074 6865 2073  atabase on the s
-0004f100: 6572 7665 722e 2022 0a20 2020 2020 2020  erver. ".       
-0004f110: 2022 536f 2c20 7468 6973 2063 616c 6c20   "So, this call 
-0004f120: 6973 206e 6f74 2061 2077 6179 2074 6f20  is not a way to 
-0004f130: 636c 6561 6e20 7570 2074 6865 2073 6572  clean up the ser
-0004f140: 7665 7220 6461 7461 6261 7365 2e20 220a  ver database. ".
-0004f150: 2020 2020 2020 2020 2245 6163 6820 7265          "Each re
-0004f160: 6461 6374 2028 7769 7065 2c20 7374 7269  dact (wipe, stri
-0004f170: 702c 2064 656c 6574 6529 206f 7065 7261  p, delete) opera
-0004f180: 7469 6f6e 2072 6571 7569 7265 7320 6578  tion requires ex
-0004f190: 6163 746c 7920 3320 220a 2020 2020 2020  actly 3 ".      
-0004f1a0: 2020 2261 7267 756d 656e 7473 2e20 220a    "arguments. ".
-0004f1b0: 2020 2020 2020 2020 2254 6865 2061 7267          "The arg
-0004f1c0: 756d 656e 7420 7472 6970 6c65 7320 6172  ument triples ar
-0004f1d0: 653a 2022 0a20 2020 2020 2020 2022 2861  e: ".        "(a
-0004f1e0: 2920 7468 6520 726f 6f6d 2069 642e 2022  ) the room id. "
-0004f1f0: 0a20 2020 2020 2020 2022 2862 2920 7468  .        "(b) th
-0004f200: 6520 6964 206f 6620 7468 6520 6576 656e  e id of the even
-0004f210: 7420 746f 2062 6520 7265 6461 6374 6564  t to be redacted
-0004f220: 2e20 220a 2020 2020 2020 2020 2228 6329  . ".        "(c)
-0004f230: 2061 2073 7472 696e 6720 636f 6e74 6169   a string contai
-0004f240: 6e69 6e67 2074 6865 2072 6561 736f 6e20  ning the reason 
-0004f250: 666f 7220 7468 6520 7265 6461 6374 696f  for the redactio
-0004f260: 6e2e 2055 7365 2027 2720 6966 2079 6f75  n. Use '' if you
-0004f270: 2022 0a20 2020 2020 2020 2022 646f 206e   ".        "do n
-0004f280: 6f74 2077 616e 7420 746f 2067 6976 6520  ot want to give 
-0004f290: 6120 7265 6173 6f6e 2e20 220a 2020 2020  a reason. ".    
-0004f2a0: 2020 2020 2253 6f2c 2074 6865 2074 6f74      "So, the tot
-0004f2b0: 616c 206e 756d 6265 7220 6f66 2061 7267  al number of arg
-0004f2c0: 756d 656e 7473 2075 7365 6420 7769 7468  uments used with
-0004f2d0: 202d 2d72 6f6f 6d2d 7265 6461 6374 206d   --room-redact m
-0004f2e0: 7573 7420 6265 2061 2022 0a20 2020 2020  ust be a ".     
-0004f2f0: 2020 2022 6d75 6c74 6970 6c65 206f 6620     "multiple of 
-0004f300: 332c 2062 7574 2077 6520 616c 736f 2061  3, but we also a
-0004f310: 6363 6570 7420 3220 696e 2077 6869 6368  ccept 2 in which
-0004f320: 2063 6173 6520 6f6e 6c79 206f 6e65 2022   case only one "
-0004f330: 0a20 2020 2020 2020 2022 7265 6461 6374  .        "redact
-0004f340: 696f 6e20 7769 6c6c 2062 6520 646f 6e65  ion will be done
-0004f350: 2077 6974 686f 7574 2073 7065 6369 6679   without specify
-0004f360: 696e 6720 6120 7265 6173 6f6e 2e20 220a  ing a reason. ".
-0004f370: 2020 2020 2020 2020 2245 7665 6e74 2069          "Event i
-0004f380: 6473 2073 7461 7274 2077 6974 6820 7468  ds start with th
-0004f390: 6520 646f 6c6c 6172 2073 6967 6e20 2824  e dollar sign ($
-0004f3a0: 292e 2044 6570 656e 6469 6e67 206f 6e20  ). Depending on 
-0004f3b0: 796f 7572 2073 6865 6c6c 2c20 220a 2020  your shell, ".  
-0004f3c0: 2020 2020 2020 2279 6f75 206d 6967 6874        "you might
-0004f3d0: 2068 6176 6520 746f 2065 7363 6170 6520   have to escape 
-0004f3e0: 7468 6520 2724 2720 746f 2027 5c5c 2427  the '$' to '\\$'
-0004f3f0: 2e20 2d2d 726f 6f6d 2d64 656c 6574 652d  . --room-delete-
-0004f400: 636f 6e74 656e 7420 6973 2022 0a20 2020  content is ".   
-0004f410: 2020 2020 2022 616e 2061 6c69 6173 2066       "an alias f
-0004f420: 6f72 202d 2d72 6f6f 6d2d 7265 6461 6374  or --room-redact
-0004f430: 2e20 5468 6579 2063 616e 2062 6520 7573  . They can be us
-0004f440: 6564 2069 6e74 6572 6368 616e 6765 6162  ed interchangeab
-0004f450: 6c79 2e22 2c0a 2020 2020 290a 2020 2020  ly.",.    ).    
-0004f460: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-0004f470: 0a20 2020 2020 2020 2023 206e 6f20 7369  .        # no si
-0004f480: 6e67 6c65 2063 6861 7220 666c 6167 0a20  ngle char flag. 
-0004f490: 2020 2020 2020 2022 2d2d 7768 6f61 6d69         "--whoami
-0004f4a0: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-0004f4b0: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-0004f4c0: 2020 2061 6374 696f 6e3d 2273 746f 7265     action="store
-0004f4d0: 5f74 7275 6522 2c0a 2020 2020 2020 2020  _true",.        
-0004f4e0: 6865 6c70 3d22 5072 696e 7420 796f 7572  help="Print your
-0004f4f0: 2075 7365 7220 6964 2e20 220a 2020 2020   user id. ".    
-0004f500: 2020 2020 6622 4465 7461 696c 733a 3a20      f"Details:: 
-0004f510: 5072 696e 7420 7468 6520 7573 6572 2069  Print the user i
-0004f520: 6420 7573 6564 2062 7920 7b50 524f 475f  d used by {PROG_
-0004f530: 5749 5448 4f55 545f 4558 547d 2028 6974  WITHOUT_EXT} (it
-0004f540: 7365 6c66 292e 2022 0a20 2020 2020 2020  self). ".       
-0004f550: 2022 4f6e 6520 6361 6e20 6765 7420 220a   "One can get ".
-0004f560: 2020 2020 2020 2020 2274 6869 7320 696e          "this in
-0004f570: 666f 726d 6174 696f 6e20 616c 736f 2062  formation also b
-0004f580: 7920 6c6f 6f6b 696e 6720 6174 2074 6865  y looking at the
-0004f590: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
-0004f5a0: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
-0004f5b0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-0004f5c0: 2020 2020 2020 2020 2320 6e6f 2073 696e          # no sin
-0004f5d0: 676c 6520 6368 6172 2066 6c61 670a 2020  gle char flag.  
-0004f5e0: 2020 2020 2020 222d 2d6e 6f2d 7373 6c22        "--no-ssl"
-0004f5f0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
-0004f600: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-0004f610: 2020 6163 7469 6f6e 3d22 7374 6f72 655f    action="store_
-0004f620: 7472 7565 222c 0a20 2020 2020 2020 2064  true",.        d
-0004f630: 6566 6175 6c74 3d4e 4f5f 5353 4c5f 554e  efault=NO_SSL_UN
-0004f640: 5553 4544 5f44 4546 4155 4c54 2c20 2023  USED_DEFAULT,  #
-0004f650: 2077 6865 6e20 6f70 7469 6f6e 2069 736e   when option isn
-0004f660: 2774 2075 7365 640a 2020 2020 2020 2020  't used.        
-0004f670: 6865 6c70 3d22 536b 6970 2053 534c 2076  help="Skip SSL v
-0004f680: 6572 6966 6963 6174 696f 6e2e 2022 0a20  erification. ". 
-0004f690: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-0004f6a0: 3a20 4279 2064 6566 6175 6c74 2028 6966  : By default (if
-0004f6b0: 2074 6869 7320 6f70 7469 6f6e 2069 7320   this option is 
-0004f6c0: 6e6f 7420 7573 6564 2920 220a 2020 2020  not used) ".    
-0004f6d0: 2020 2020 2274 6865 2053 534c 2063 6572      "the SSL cer
-0004f6e0: 7469 6669 6361 7465 2069 7320 7661 6c69  tificate is vali
-0004f6f0: 6461 7465 6420 666f 7220 7468 6520 636f  dated for the co
-0004f700: 6e6e 6563 7469 6f6e 2e20 4275 742c 2069  nnection. But, i
-0004f710: 6620 7468 6973 2022 0a20 2020 2020 2020  f this ".       
-0004f720: 2022 6f70 7469 6f6e 2069 7320 7573 6564   "option is used
-0004f730: 2c20 7468 656e 2074 6865 2053 534c 2063  , then the SSL c
-0004f740: 6572 7469 6669 6361 7465 2076 616c 6964  ertificate valid
-0004f750: 6174 696f 6e20 7769 6c6c 2062 6520 736b  ation will be sk
-0004f760: 6970 7065 642e 2022 0a20 2020 2020 2020  ipped. ".       
-0004f770: 2022 5468 6973 2069 7320 7573 6566 756c   "This is useful
-0004f780: 2066 6f72 2068 6f6d 652d 7365 7276 6572   for home-server
-0004f790: 7320 7468 6174 2068 6176 6520 6e6f 2053  s that have no S
-0004f7a0: 534c 2063 6572 7469 6669 6361 7465 2e20  SL certificate. 
-0004f7b0: 220a 2020 2020 2020 2020 2749 6620 7573  ".        'If us
-0004f7c0: 6564 2074 6f67 6574 6865 7220 7769 7468  ed together with
-0004f7d0: 2074 6865 2022 2d2d 7373 6c2d 6365 7274   the "--ssl-cert
-0004f7e0: 6966 6963 6174 6522 2027 0a20 2020 2020  ificate" '.     
-0004f7f0: 2020 2022 7061 7261 6d65 7465 722c 2074     "parameter, t
-0004f800: 6869 7320 6f70 7469 6f6e 2069 7320 6d65  his option is me
-0004f810: 616e 696e 676c 6573 7320 616e 6420 616e  aningless and an
-0004f820: 2065 7272 6f72 2077 696c 6c20 6265 2072   error will be r
-0004f830: 6169 7365 642e 222c 0a20 2020 2029 0a20  aised.",.    ). 
-0004f840: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
-0004f850: 6e74 280a 2020 2020 2020 2020 2320 6e6f  nt(.        # no
-0004f860: 2073 696e 676c 6520 6368 6172 2066 6c61   single char fla
-0004f870: 670a 2020 2020 2020 2020 222d 2d73 736c  g.        "--ssl
-0004f880: 2d63 6572 7469 6669 6361 7465 222c 0a20  -certificate",. 
-0004f890: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-0004f8a0: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
-0004f8b0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-0004f8c0: 2064 6566 6175 6c74 3d53 534c 5f43 4552   default=SSL_CER
-0004f8d0: 5449 4649 4341 5445 5f44 4546 4155 4c54  TIFICATE_DEFAULT
-0004f8e0: 2c20 2023 2077 6865 6e20 6f70 7469 6f6e  ,  # when option
-0004f8f0: 2069 736e 2774 2075 7365 640a 2020 2020   isn't used.    
-0004f900: 2020 2020 6d65 7461 7661 723d 2253 534c      metavar="SSL
-0004f910: 5f43 4552 5449 4649 4341 5445 5f46 494c  _CERTIFICATE_FIL
-0004f920: 4522 2c0a 2020 2020 2020 2020 6865 6c70  E",.        help
-0004f930: 3d22 5573 6520 796f 7572 206f 776e 2053  ="Use your own S
-0004f940: 534c 2063 6572 7469 6669 6361 7465 2e20  SL certificate. 
-0004f950: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-0004f960: 6c73 3a3a 2055 7365 2074 6869 7320 6f70  ls:: Use this op
-0004f970: 7469 6f6e 2074 6f20 7573 6520 220a 2020  tion to use ".  
-0004f980: 2020 2020 2020 2279 6f75 7220 6f77 6e20        "your own 
-0004f990: 6c6f 6361 6c20 5353 4c20 6365 7274 6966  local SSL certif
-0004f9a0: 6963 6174 6520 6669 6c65 2e20 220a 2020  icate file. ".  
-0004f9b0: 2020 2020 2020 2254 6869 7320 6973 2061        "This is a
-0004f9c0: 6e20 6f70 7469 6f6e 616c 2070 6172 616d  n optional param
-0004f9d0: 6574 6572 2e20 5468 6973 2069 7320 7573  eter. This is us
-0004f9e0: 6566 756c 2066 6f72 2068 6f6d 6520 7365  eful for home se
-0004f9f0: 7276 6572 7320 7468 6174 2022 0a20 2020  rvers that ".   
-0004fa00: 2020 2020 2022 6861 7665 2074 6865 6972       "have their
-0004fa10: 206f 776e 2022 0a20 2020 2020 2020 2022   own ".        "
-0004fa20: 5353 4c20 6365 7274 6966 6963 6174 652e  SSL certificate.
-0004fa30: 2054 6869 7320 616c 6c6f 7773 2079 6f75   This allows you
-0004fa40: 2074 6f20 7573 6520 4854 5450 532f 544c   to use HTTPS/TL
-0004fa50: 5320 666f 7220 7468 6520 636f 6e6e 6563  S for the connec
-0004fa60: 7469 6f6e 2022 0a20 2020 2020 2020 2022  tion ".        "
-0004fa70: 7768 696c 6520 7573 696e 6720 796f 7572  while using your
-0004fa80: 206f 776e 206c 6f63 616c 2053 534c 2063   own local SSL c
-0004fa90: 6572 7469 6669 6361 7465 2e20 5370 6563  ertificate. Spec
-0004faa0: 6966 7920 7468 6520 7061 7468 2061 6e64  ify the path and
-0004fab0: 2022 0a20 2020 2020 2020 2027 6669 6c65   ".        'file
-0004fac0: 2074 6f20 796f 7572 2053 534c 2063 6572   to your SSL cer
-0004fad0: 7469 6669 6361 7465 2e20 4966 2075 7365  tificate. If use
-0004fae0: 6420 746f 6765 7468 6572 2077 6974 6820  d together with 
-0004faf0: 7468 6520 222d 2d6e 6f2d 7373 6c22 2027  the "--no-ssl" '
-0004fb00: 0a20 2020 2020 2020 2022 7061 7261 6d65  .        "parame
-0004fb10: 7465 722c 2074 6869 7320 6f70 7469 6f6e  ter, this option
-0004fb20: 2069 7320 6d65 616e 696e 676c 6573 7320   is meaningless 
-0004fb30: 616e 6420 616e 2065 7272 6f72 2077 696c  and an error wil
-0004fb40: 6c20 6265 2072 6169 7365 642e 222c 0a20  l be raised.",. 
-0004fb50: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
-0004fb60: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
-0004fb70: 2020 222d 2d66 696c 652d 6e61 6d65 222c    "--file-name",
-0004fb80: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
-0004fb90: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
-0004fba0: 2061 6374 696f 6e3d 2265 7874 656e 6422   action="extend"
-0004fbb0: 2c0a 2020 2020 2020 2020 6e61 7267 733d  ,.        nargs=
-0004fbc0: 222b 222c 0a20 2020 2020 2020 2074 7970  "+",.        typ
-0004fbd0: 653d 7374 722c 0a20 2020 2020 2020 206d  e=str,.        m
-0004fbe0: 6574 6176 6172 3d22 4649 4c45 222c 0a20  etavar="FILE",. 
-0004fbf0: 2020 2020 2020 2068 656c 703d 2253 7065         help="Spe
-0004fc00: 6369 6679 206f 6e65 206f 7220 6d75 6c74  cify one or mult
-0004fc10: 6970 6c65 2066 696c 6520 6e61 6d65 7320  iple file names 
-0004fc20: 666f 7220 736f 6d65 2061 6374 696f 6e73  for some actions
-0004fc30: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
-0004fc40: 6169 6c73 3a3a 2054 6869 7320 6973 2061  ails:: This is a
-0004fc50: 6e20 6f70 7469 6f6e 616c 2061 7267 756d  n optional argum
-0004fc60: 656e 742e 2055 7365 2074 6869 7320 6f70  ent. Use this op
-0004fc70: 7469 6f6e 2022 0a20 2020 2020 2020 2022  tion ".        "
-0004fc80: 696e 2063 6f6d 6269 6e61 7469 6f6e 2077  in combination w
-0004fc90: 6974 6820 6f70 7469 6f6e 7320 6c69 6b65  ith options like
-0004fca0: 202d 2d64 6f77 6e6c 6f61 6420 746f 2073   --download to s
-0004fcb0: 7065 6369 6679 206f 6e65 206f 7220 220a  pecify one or ".
-0004fcc0: 2020 2020 2020 2020 226d 756c 7469 706c          "multipl
-0004fcd0: 6520 6669 6c65 206e 616d 6573 2e20 220a  e file names. ".
-0004fce0: 2020 2020 2020 2020 2249 676e 6f72 6564          "Ignored
-0004fcf0: 2069 6620 7573 6564 2062 7920 6974 7365   if used by itse
-0004fd00: 6c66 2077 6974 686f 7574 2061 6e20 6170  lf without an ap
-0004fd10: 7072 6f70 7269 6174 6520 636f 7272 6573  propriate corres
-0004fd20: 706f 6e64 696e 6720 220a 2020 2020 2020  ponding ".      
-0004fd30: 2020 2261 6374 696f 6e2e 222c 0a20 2020    "action.",.   
-0004fd40: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
-0004fd50: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
-0004fd60: 222d 2d6b 6579 2d64 6963 7422 2c0a 2020  "--key-dict",.  
-0004fd70: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
-0004fd80: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
-0004fd90: 7469 6f6e 3d22 6578 7465 6e64 222c 0a20  tion="extend",. 
-0004fda0: 2020 2020 2020 206e 6172 6773 3d22 2b22         nargs="+"
-0004fdb0: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
-0004fdc0: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
-0004fdd0: 7661 723d 224b 4559 5f44 4943 5449 4f4e  var="KEY_DICTION
-0004fde0: 4152 5922 2c0a 2020 2020 2020 2020 6865  ARY",.        he
-0004fdf0: 6c70 3d22 5370 6563 6966 7920 6f6e 6520  lp="Specify one 
-0004fe00: 6f72 206d 756c 7469 706c 6520 6b65 7920  or multiple key 
-0004fe10: 6469 6374 696f 6e61 7269 6573 2066 6f72  dictionaries for
-0004fe20: 2064 6563 7279 7074 696f 6e2e 2022 0a20   decryption. ". 
-0004fe30: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
-0004fe40: 3a20 4f6e 6520 6f72 206d 756c 7469 706c  : One or multipl
-0004fe50: 6520 6465 6372 7970 7469 6f6e 2022 0a20  e decryption ". 
-0004fe60: 2020 2020 2020 2022 6469 6374 696f 6e61         "dictiona
-0004fe70: 7269 6573 2061 7265 2070 726f 7669 6465  ries are provide
-0004fe80: 6420 6279 2074 6865 202d 2d75 706c 6f61  d by the --uploa
-0004fe90: 6420 6163 7469 6f6e 2061 7320 6120 7265  d action as a re
-0004fea0: 7375 6c74 2e20 220a 2020 2020 2020 2020  sult. ".        
-0004feb0: 2241 2064 6563 7279 7074 696f 6e20 6469  "A decryption di
-0004fec0: 6374 696f 6e61 7279 2069 7320 6120 7374  ctionary is a st
-0004fed0: 7269 6e67 206c 696b 6520 7468 6973 3a20  ring like this: 
-0004fee0: 220a 2020 2020 2020 2020 225c 227b 2776  ".        "\"{'v
-0004fef0: 273a 2027 7632 272c 2027 6b65 7927 3a20  ': 'v2', 'key': 
-0004ff00: 7b27 6b74 7927 3a20 276f 6374 272c 2027  {'kty': 'oct', '
-0004ff10: 616c 6727 3a20 2741 3235 3643 5452 272c  alg': 'A256CTR',
-0004ff20: 2027 6578 7427 3a20 5472 7565 2c20 220a   'ext': True, ".
-0004ff30: 2020 2020 2020 2020 2227 6b27 3a20 2773          "'k': 's
-0004ff40: 6f6d 656b 6579 272c 2027 6b65 795f 6f70  omekey', 'key_op
-0004ff50: 7327 3a20 5b27 656e 6372 7970 7427 2c20  s': ['encrypt', 
-0004ff60: 2764 6563 7279 7074 275d 7d2c 2022 0a20  'decrypt']}, ". 
-0004ff70: 2020 2020 2020 2022 2769 7627 3a20 2773         "'iv': 's
-0004ff80: 6f6d 6569 7627 2c20 2768 6173 6865 7327  omeiv', 'hashes'
-0004ff90: 3a20 7b27 7368 6132 3536 273a 2027 736f  : {'sha256': 'so
-0004ffa0: 6d65 5348 4127 7d7d 5c22 2e20 4966 2079  meSHA'}}\". If y
-0004ffb0: 6f75 2068 6176 6520 6120 220a 2020 2020  ou have a ".    
-0004ffc0: 2020 2020 226c 6973 7420 6f66 206b 6579      "list of key
-0004ffd0: 2064 6963 7469 6f6e 6172 6965 7320 616e   dictionaries an
-0004ffe0: 6420 7761 6e74 2074 6f20 736b 6970 206f  d want to skip o
-0004fff0: 6e65 2c20 7573 6520 7468 6520 656d 7074  ne, use the empt
-00050000: 7920 7374 7269 6e67 2e22 2c0a 2020 2020  y string.",.    
-00050010: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-00050020: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-00050030: 2d2d 706c 6169 6e22 2c0a 2020 2020 2020  --plain",.      
-00050040: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-00050050: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
-00050060: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
-00050070: 2020 2020 2020 2068 656c 703d 2244 6973         help="Dis
-00050080: 6162 6c65 2065 6e63 7279 7074 696f 6e20  able encryption 
-00050090: 666f 7220 6120 7370 6563 6966 6963 2061  for a specific a
-000500a0: 6374 696f 6e2e 2022 0a20 2020 2020 2020  ction. ".       
-000500b0: 2022 4465 7461 696c 733a 3a20 4279 2064   "Details:: By d
-000500c0: 6566 6175 6c74 2c20 220a 2020 2020 2020  efault, ".      
-000500d0: 2020 2265 7665 7279 7468 696e 6720 6973    "everything is
-000500e0: 2061 6c77 6179 7320 656e 6372 7970 7465   always encrypte
-000500f0: 642e 2022 0a20 2020 2020 2020 2022 4163  d. ".        "Ac
-00050100: 7469 6f6e 7320 7468 6174 2073 7570 706f  tions that suppo
-00050110: 7274 2074 6869 7320 6f70 7469 6f6e 2061  rt this option a
-00050120: 7265 3a20 2d2d 7570 6c6f 6164 2c20 2d2d  re: --upload, --
-00050130: 726f 6f6d 2d63 7265 6174 652c 2022 0a20  room-create, ". 
-00050140: 2020 2020 2020 2022 616e 6420 2d2d 726f         "and --ro
-00050150: 6f6d 2d64 6d2d 6372 6561 7465 2e20 220a  om-dm-create. ".
-00050160: 2020 2020 2020 2020 2252 6f6f 6d73 2061          "Rooms a
-00050170: 7265 2062 7920 6465 6661 756c 7420 6372  re by default cr
-00050180: 6561 7465 6420 656e 6372 7970 7465 643b  eated encrypted;
-00050190: 2022 0a20 2020 2020 2020 2022 746f 206f   ".        "to o
-000501a0: 7665 7277 7269 7465 2074 6861 7420 616e  verwrite that an
-000501b0: 6420 746f 2063 7265 6174 6520 6120 726f  d to create a ro
-000501c0: 6f6d 2077 6974 6820 656e 6372 7970 7469  om with encrypti
-000501d0: 6f6e 2064 6973 6162 6c65 6420 220a 2020  on disabled ".  
-000501e0: 2020 2020 2020 2275 7365 2027 2d2d 706c        "use '--pl
-000501f0: 6169 6e27 2e20 5365 6520 7468 6520 696e  ain'. See the in
-00050200: 6469 7669 6475 616c 2063 6f6d 6d61 6e64  dividual command
-00050210: 732e 222c 0a20 2020 2029 0a20 2020 2061  s.",.    ).    a
-00050220: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-00050230: 2020 2020 2020 2020 222d 2d73 6570 6172          "--separ
-00050240: 6174 6f72 222c 0a20 2020 2020 2020 2072  ator",.        r
-00050250: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
-00050260: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
-00050270: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
-00050280: 3d44 4546 4155 4c54 5f53 4550 4152 4154  =DEFAULT_SEPARAT
-00050290: 4f52 2c20 2023 2064 6566 6175 6c74 7320  OR,  # defaults 
-000502a0: 746f 2053 4550 2069 6620 6e6f 7420 7573  to SEP if not us
-000502b0: 6564 0a20 2020 2020 2020 2023 2054 6578  ed.        # Tex
-000502c0: 7420 6973 2073 6361 6e6e 6564 2061 6e64  t is scanned and
-000502d0: 2072 6570 6561 7465 6420 7370 6163 6573   repeated spaces
-000502e0: 2061 7265 2072 656d 6f76 6573 2c20 736f   are removes, so
-000502f0: 2022 2020 2020 220a 2020 2020 2020 2020   "    ".        
-00050300: 2320 6f72 207b 4445 4641 554c 545f 5345  # or {DEFAULT_SE
-00050310: 5041 5241 544f 527d 2077 696c 6c20 6265  PARATOR} will be
-00050320: 2074 7275 6e63 6174 6564 2074 6f20 2220   truncated to " 
-00050330: 222e 2048 656e 6365 2022 3420 7370 6163  ". Hence "4 spac
-00050340: 6573 220a 2020 2020 2020 2020 6d65 7461  es".        meta
-00050350: 7661 723d 2253 4550 4152 4154 4f52 222c  var="SEPARATOR",
-00050360: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
-00050370: 6574 2061 2063 7573 746f 6d20 7365 7061  et a custom sepa
-00050380: 7261 746f 7220 7573 6564 2066 6f72 2063  rator used for c
-00050390: 6572 7461 696e 2070 7269 6e74 206f 7574  ertain print out
-000503a0: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
-000503b0: 7461 696c 733a 3a20 4279 2064 6566 6175  tails:: By defau
-000503c0: 6c74 2c20 692e 652e 2069 6620 2d2d 7365  lt, i.e. if --se
-000503d0: 7061 7261 746f 7220 6973 206e 6f74 2075  parator is not u
-000503e0: 7365 642c 2022 0a20 2020 2020 2020 2022  sed, ".        "
-000503f0: 3420 7370 6163 6573 2061 7265 2075 7365  4 spaces are use
-00050400: 6420 6173 2022 0a20 2020 2020 2020 2022  d as ".        "
-00050410: 7365 7061 7261 746f 7220 6265 7477 6565  separator betwee
-00050420: 6e20 636f 6c75 6d6e 7320 696e 2070 7269  n columns in pri
-00050430: 6e74 2073 7461 7465 6d65 6e74 732e 2059  nt statements. Y
-00050440: 6f75 2063 6f75 6c64 2073 6574 2022 0a20  ou could set ". 
-00050450: 2020 2020 2020 2022 6974 2074 6f20 275c         "it to '\
-00050460: 5c74 2720 6966 2079 6f75 2070 7265 6665  \t' if you prefe
-00050470: 7220 6120 7461 622c 2062 7574 2074 6162  r a tab, but tab
-00050480: 7320 6172 6520 7573 7561 6c6c 7920 7265  s are usually re
-00050490: 706c 6163 6564 2022 0a20 2020 2020 2020  placed ".       
-000504a0: 2022 7769 7468 2073 7061 6365 7320 6279   "with spaces by
-000504b0: 2074 6865 2074 6572 6d69 6e61 6c2e 2053   the terminal. S
-000504c0: 6f2c 2074 6861 7420 6d69 6768 7420 6e6f  o, that might no
-000504d0: 7420 6769 7665 2079 6f75 2077 6861 7420  t give you what 
-000504e0: 796f 7520 220a 2020 2020 2020 2020 2277  you ".        "w
-000504f0: 616e 742e 204d 6179 6265 2027 207c 7c20  ant. Maybe ' || 
-00050500: 2720 6973 2061 6e20 616c 7465 726e 6174  ' is an alternat
-00050510: 6976 6520 6368 6f69 6365 2e22 2c0a 2020  ive choice.",.  
-00050520: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-00050530: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-00050540: 2022 2d2d 6163 6365 7373 2d74 6f6b 656e   "--access-token
-00050550: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
-00050560: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
-00050570: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
-00050580: 2020 2020 206d 6574 6176 6172 3d22 4143       metavar="AC
-00050590: 4345 5353 5f54 4f4b 454e 222c 0a20 2020  CESS_TOKEN",.   
-000505a0: 2020 2020 2068 656c 703d 2253 6574 2061       help="Set a
-000505b0: 2063 7573 746f 6d20 6163 6365 7373 2074   custom access t
-000505c0: 6f6b 656e 2066 6f72 2075 7365 2062 7920  oken for use by 
-000505d0: 6365 7274 6169 6e20 6163 7469 6f6e 732e  certain actions.
-000505e0: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
-000505f0: 696c 733a 3a20 4974 2069 7320 616e 206f  ils:: It is an o
-00050600: 7074 696f 6e61 6c20 6172 6775 6d65 6e74  ptional argument
-00050610: 2e20 220a 2020 2020 2020 2020 2242 7920  . ".        "By 
-00050620: 6465 6661 756c 7420 2d2d 6163 6365 7373  default --access
-00050630: 2d74 6f6b 656e 2069 7320 6967 6e6f 7265  -token is ignore
-00050640: 6420 616e 6420 6e6f 7420 7573 6564 2e20  d and not used. 
-00050650: 220a 2020 2020 2020 2020 2249 7420 6973  ".        "It is
-00050660: 2075 7365 6420 6279 2074 6865 202d 2d64   used by the --d
-00050670: 656c 6574 652d 6d78 632c 202d 2d64 656c  elete-mxc, --del
-00050680: 6574 652d 6d78 632d 6265 666f 7265 2c20  ete-mxc-before, 
-00050690: 220a 2020 2020 2020 2020 2261 6e64 202d  ".        "and -
-000506a0: 2d72 6573 7420 6163 7469 6f6e 732e 222c  -rest actions.",
-000506b0: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-000506c0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-000506d0: 2020 2020 222d 2d70 6173 7377 6f72 6422      "--password"
-000506e0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
-000506f0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
-00050700: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
-00050710: 2020 2020 6d65 7461 7661 723d 2250 4153      metavar="PAS
-00050720: 5357 4f52 4422 2c0a 2020 2020 2020 2020  SWORD",.        
-00050730: 6865 6c70 3d22 5370 6563 6966 7920 6120  help="Specify a 
-00050740: 7061 7373 776f 7264 2066 6f72 2075 7365  password for use
-00050750: 2062 7920 6365 7274 6169 6e20 6163 7469   by certain acti
-00050760: 6f6e 732e 2022 0a20 2020 2020 2020 2022  ons. ".        "
-00050770: 4465 7461 696c 733a 3a20 4974 2069 7320  Details:: It is 
-00050780: 616e 206f 7074 696f 6e61 6c20 6172 6775  an optional argu
-00050790: 6d65 6e74 2e20 220a 2020 2020 2020 2020  ment. ".        
-000507a0: 2242 7920 6465 6661 756c 7420 2d2d 7061  "By default --pa
-000507b0: 7373 776f 7264 2069 7320 6967 6e6f 7265  ssword is ignore
-000507c0: 6420 616e 6420 6e6f 7420 7573 6564 2e20  d and not used. 
-000507d0: 220a 2020 2020 2020 2020 2249 7420 6973  ".        "It is
-000507e0: 2075 7365 6420 6279 2027 2d2d 6c6f 6769   used by '--logi
-000507f0: 6e20 7061 7373 776f 7264 2720 616e 6420  n password' and 
-00050800: 272d 2d64 656c 6574 652d 6465 7669 6365  '--delete-device
-00050810: 2720 220a 2020 2020 2020 2020 2261 6374  ' ".        "act
-00050820: 696f 6e73 2e20 220a 2020 2020 2020 2020  ions. ".        
-00050830: 2249 6620 6e6f 7420 7072 6f76 6964 6564  "If not provided
-00050840: 2066 6f72 202d 2d6c 6f67 696e 2074 6865   for --login the
-00050850: 2075 7365 7220 7769 6c6c 2062 6520 7175   user will be qu
-00050860: 6572 6965 6420 7669 6120 6b65 7962 6f61  eried via keyboa
-00050870: 7264 2e22 2c0a 2020 2020 290a 2020 2020  rd.",.    ).    
-00050880: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
-00050890: 0a20 2020 2020 2020 2022 2d2d 686f 6d65  .        "--home
-000508a0: 7365 7276 6572 222c 0a20 2020 2020 2020  server",.       
-000508b0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
-000508c0: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
-000508d0: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
-000508e0: 6172 3d22 484f 4d45 5345 5256 4552 5f55  ar="HOMESERVER_U
-000508f0: 524c 222c 0a20 2020 2020 2020 2068 656c  RL",.        hel
-00050900: 703d 2253 7065 6369 6679 2061 2068 6f6d  p="Specify a hom
-00050910: 6573 6572 7665 7220 666f 7220 7573 6520  eserver for use 
-00050920: 6279 2063 6572 7461 696e 2061 6374 696f  by certain actio
-00050930: 6e73 2e20 220a 2020 2020 2020 2020 2244  ns. ".        "D
-00050940: 6574 6169 6c73 3a3a 2049 7420 6973 2061  etails:: It is a
-00050950: 6e20 6f70 7469 6f6e 616c 2061 7267 756d  n optional argum
-00050960: 656e 742e 2022 0a20 2020 2020 2020 2022  ent. ".        "
-00050970: 4279 2064 6566 6175 6c74 202d 2d68 6f6d  By default --hom
-00050980: 6573 6572 7665 7220 6973 2069 676e 6f72  eserver is ignor
-00050990: 6564 2061 6e64 206e 6f74 2075 7365 642e  ed and not used.
-000509a0: 2022 0a20 2020 2020 2020 2022 4974 2069   ".        "It i
-000509b0: 7320 7573 6564 2062 7920 272d 2d6c 6f67  s used by '--log
-000509c0: 696e 2720 6163 7469 6f6e 2e20 220a 2020  in' action. ".  
-000509d0: 2020 2020 2020 2249 6620 6e6f 7420 7072        "If not pr
-000509e0: 6f76 6964 6564 2066 6f72 202d 2d6c 6f67  ovided for --log
-000509f0: 696e 2074 6865 2075 7365 7220 7769 6c6c  in the user will
-00050a00: 2062 6520 7175 6572 6965 6420 7669 6120   be queried via 
-00050a10: 6b65 7962 6f61 7264 2e22 2c0a 2020 2020  keyboard.",.    
-00050a20: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
-00050a30: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
-00050a40: 2d2d 6465 7669 6365 222c 2020 2320 646f  --device",  # do
-00050a50: 206e 6f74 2063 6f6e 6675 7365 2077 6974   not confuse wit
-00050a60: 6820 2d2d 6465 7669 6365 730a 2020 2020  h --devices.    
-00050a70: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
-00050a80: 7365 2c0a 2020 2020 2020 2020 7479 7065  se,.        type
-00050a90: 3d73 7472 2c20 2023 2064 6576 6963 6520  =str,  # device 
-00050aa0: 6964 2c20 6465 7669 6365 206e 616d 650a  id, device name.
-00050ab0: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
-00050ac0: 2244 4556 4943 455f 4e41 4d45 222c 0a20  "DEVICE_NAME",. 
-00050ad0: 2020 2020 2020 2068 656c 703d 2253 7065         help="Spe
-00050ae0: 6369 6679 2061 2064 6576 6963 6520 6e61  cify a device na
-00050af0: 6d65 2c20 666f 7220 7573 6520 6279 2063  me, for use by c
-00050b00: 6572 7461 696e 2061 6374 696f 6e73 2e20  ertain actions. 
-00050b10: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
-00050b20: 6c73 3a3a 2049 7420 6973 2061 6e20 6f70  ls:: It is an op
-00050b30: 7469 6f6e 616c 2061 7267 756d 656e 742e  tional argument.
-00050b40: 2022 0a20 2020 2020 2020 2022 4279 2064   ".        "By d
-00050b50: 6566 6175 6c74 202d 2d64 6576 6963 6520  efault --device 
-00050b60: 6973 2069 676e 6f72 6564 2061 6e64 206e  is ignored and n
-00050b70: 6f74 2075 7365 642e 2022 0a20 2020 2020  ot used. ".     
-00050b80: 2020 2022 4974 2069 7320 7573 6564 2062     "It is used b
-00050b90: 7920 272d 2d6c 6f67 696e 2720 6163 7469  y '--login' acti
-00050ba0: 6f6e 2e20 220a 2020 2020 2020 2020 2249  on. ".        "I
-00050bb0: 6620 6e6f 7420 7072 6f76 6964 6564 2066  f not provided f
-00050bc0: 6f72 202d 2d6c 6f67 696e 2074 6865 2075  or --login the u
-00050bd0: 7365 7220 7769 6c6c 2062 6520 7175 6572  ser will be quer
-00050be0: 6965 6420 7669 6120 6b65 7962 6f61 7264  ied via keyboard
-00050bf0: 2e20 220a 2020 2020 2020 2020 2249 6620  . ".        "If 
-00050c00: 796f 7520 7761 6e74 2074 6865 2064 6566  you want the def
-00050c10: 6175 6c74 2076 616c 7565 2073 7065 6369  ault value speci
-00050c20: 6679 2027 272e 2022 0a20 2020 2020 2020  fy ''. ".       
-00050c30: 2022 4d75 6c74 6970 6c65 2064 6576 6963   "Multiple devic
-00050c40: 6573 2028 7769 7468 2064 6966 6665 7265  es (with differe
-00050c50: 6e74 2064 6576 6963 6520 6964 2920 6d61  nt device id) ma
-00050c60: 7920 6861 7665 2074 6865 2073 616d 6520  y have the same 
-00050c70: 6465 7669 6365 2022 0a20 2020 2020 2020  device ".       
-00050c80: 2022 6e61 6d65 2e20 496e 2073 686f 7274   "name. In short
-00050c90: 2c20 7468 6520 7361 6d65 2064 6576 6963  , the same devic
-00050ca0: 6520 6e61 6d65 2063 616e 2062 6520 6173  e name can be as
-00050cb0: 7369 676e 6564 2074 6f20 6d75 6c74 6970  signed to multip
-00050cc0: 6c65 2022 0a20 2020 2020 2020 2022 6469  le ".        "di
-00050cd0: 6666 6572 656e 7420 6465 7669 6365 7320  fferent devices 
-00050ce0: 6966 2064 6573 6972 6564 2e22 2c0a 2020  if desired.",.  
-00050cf0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
-00050d00: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
-00050d10: 2022 2d2d 7379 6e63 222c 0a20 2020 2020   "--sync",.     
-00050d20: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
-00050d30: 652c 0a20 2020 2020 2020 2074 7970 653d  e,.        type=
-00050d40: 7374 722c 2020 2320 7379 6e63 206d 6574  str,  # sync met
-00050d50: 686f 643a 206f 6666 2c20 6675 6c6c 2c20  hod: off, full, 
-00050d60: 2870 6172 7469 616c 290a 2020 2020 2020  (partial).      
-00050d70: 2020 6d65 7461 7661 723d 2246 554c 4c7c    metavar="FULL|
-00050d80: 4f46 4622 2c0a 2020 2020 2020 2020 6865  OFF",.        he
-00050d90: 6c70 3d22 4368 6f6f 7365 2073 796e 6368  lp="Choose synch
-00050da0: 726f 6e69 7a61 7469 6f6e 206f 7074 696f  ronization optio
-00050db0: 6e73 2e20 220a 2020 2020 2020 2020 2244  ns. ".        "D
-00050dc0: 6574 6169 6c73 3a3a 2054 6869 7320 6f70  etails:: This op
-00050dd0: 7469 6f6e 2064 6563 6964 6573 206f 6e20  tion decides on 
-00050de0: 7768 6574 6865 7220 7468 6520 7072 6f67  whether the prog
-00050df0: 7261 6d20 220a 2020 2020 2020 2020 2273  ram ".        "s
-00050e00: 796e 6368 726f 6e69 7a65 7320 7468 6520  ynchronizes the 
-00050e10: 7374 6174 6520 7769 7468 2074 6865 2073  state with the s
-00050e20: 6572 7665 7220 6265 666f 7265 2061 2027  erver before a '
-00050e30: 7365 6e64 2720 6163 7469 6f6e 2e20 220a  send' action. ".
-00050e40: 2020 2020 2020 2020 6622 4375 7272 656e          f"Curren
-00050e50: 746c 7920 7477 6f20 6368 6f69 6365 7320  tly two choices 
-00050e60: 6172 6520 6f66 6665 7265 643a 2027 7b53  are offered: '{S
-00050e70: 594e 435f 4655 4c4c 7d27 2061 6e64 2027  YNC_FULL}' and '
-00050e80: 7b53 594e 435f 4f46 467d 272e 2022 0a20  {SYNC_OFF}'. ". 
-00050e90: 2020 2020 2020 2022 5072 6f76 6964 6520         "Provide 
-00050ea0: 6f6e 6520 6f66 2074 6865 7365 2063 686f  one of these cho
-00050eb0: 6963 6573 2e20 220a 2020 2020 2020 2020  ices. ".        
-00050ec0: 6622 5468 6520 6465 6661 756c 7420 6973  f"The default is
-00050ed0: 2027 7b53 594e 435f 4445 4641 554c 547d   '{SYNC_DEFAULT}
-00050ee0: 272e 2049 6620 796f 7520 7761 6e74 2074  '. If you want t
-00050ef0: 6f20 7573 6520 7468 6520 6465 6661 756c  o use the defaul
-00050f00: 742c 2022 0a20 2020 2020 2020 2022 7468  t, ".        "th
-00050f10: 656e 2074 6865 7265 2069 7320 6e6f 206e  en there is no n
-00050f20: 6565 6420 746f 2075 7365 2074 6869 7320  eed to use this 
-00050f30: 6f70 7469 6f6e 2e20 220a 2020 2020 2020  option. ".      
-00050f40: 2020 6622 4966 2079 6f75 2068 6176 6520    f"If you have 
-00050f50: 6368 6f73 656e 2027 7b53 594e 435f 4655  chosen '{SYNC_FU
-00050f60: 4c4c 7d27 2c20 220a 2020 2020 2020 2020  LL}', ".        
-00050f70: 2274 6865 2066 756c 6c20 7374 6174 652c  "the full state,
-00050f80: 2061 6c6c 2073 7461 7465 2065 7665 6e74   all state event
-00050f90: 7320 7769 6c6c 2062 6520 7379 6e63 6872  s will be synchr
-00050fa0: 6f6e 697a 6564 2062 6574 7765 656e 2022  onized between "
-00050fb0: 0a20 2020 2020 2020 2022 7468 6973 2070  .        "this p
-00050fc0: 726f 6772 616d 2061 6e64 2074 6865 2073  rogram and the s
-00050fd0: 6572 7665 7220 6265 666f 7265 2061 2027  erver before a '
-00050fe0: 7365 6e64 272e 2022 0a20 2020 2020 2020  send'. ".       
-00050ff0: 2066 2249 6620 796f 7520 6861 7665 2063   f"If you have c
-00051000: 686f 7365 6e20 277b 5359 4e43 5f4f 4646  hosen '{SYNC_OFF
-00051010: 7d27 2c20 220a 2020 2020 2020 2020 2273  }', ".        "s
-00051020: 796e 6368 726f 6e69 7a61 7469 6f6e 2077  ynchronization w
-00051030: 696c 6c20 6265 2073 6b69 7070 6564 2065  ill be skipped e
-00051040: 6e74 6972 656c 7920 6265 666f 7265 2074  ntirely before t
-00051050: 6865 2027 7365 6e64 2720 220a 2020 2020  he 'send' ".    
-00051060: 2020 2020 2277 6869 6368 2077 696c 6c20      "which will 
-00051070: 696d 7072 6f76 6520 7065 7266 6f72 6d61  improve performa
-00051080: 6e63 652e 222c 0a20 2020 2029 0a20 2020  nce.",.    ).   
-00051090: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
-000510a0: 280a 2020 2020 2020 2020 222d 6f22 2c20  (.        "-o", 
-000510b0: 2023 2069 6e63 6f6d 7061 7469 626c 6520   # incompatible 
-000510c0: 6368 616e 6765 2044 6563 2032 3032 322c  change Dec 2022,
-000510d0: 202d 6f20 6d6f 7665 6420 6672 6f6d 202d   -o moved from -
-000510e0: 2d6f 732d 6e6f 7469 6679 0a20 2020 2020  -os-notify.     
-000510f0: 2020 2022 2d2d 6f75 7470 7574 222c 0a20     "--output",. 
-00051100: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00051110: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
-00051120: 7970 653d 7374 722c 2020 2320 6f75 7470  ype=str,  # outp
-00051130: 7574 206d 6574 686f 643a 2074 6578 742c  ut method: text,
-00051140: 206a 736f 6e2c 206a 736f 6e2d 6d61 782c   json, json-max,
-00051150: 202e 2e2e 0a20 2020 2020 2020 2064 6566   ....        def
-00051160: 6175 6c74 3d4f 5554 5055 545f 4445 4641  ault=OUTPUT_DEFA
-00051170: 554c 542c 2020 2320 7768 656e 202d 2d6f  ULT,  # when --o
-00051180: 7574 7075 7420 6973 206e 6f74 2075 7365  utput is not use
-00051190: 640a 2020 2020 2020 2020 6d65 7461 7661  d.        metava
-000511a0: 723d 2254 4558 547c 4a53 4f4e 7c4a 534f  r="TEXT|JSON|JSO
-000511b0: 4e2d 4d41 587c 4a53 4f4e 2d53 5045 4322  N-MAX|JSON-SPEC"
-000511c0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
-000511d0: 5365 6c65 6374 2061 6e20 6f75 7470 7574  Select an output
-000511e0: 2066 6f72 6d61 742e 2022 0a20 2020 2020   format. ".     
-000511f0: 2020 2022 4465 7461 696c 733a 3a20 5468     "Details:: Th
-00051200: 6973 206f 7074 696f 6e20 6465 6369 6465  is option decide
-00051210: 7320 6f6e 2068 6f77 2074 6865 206f 7574  s on how the out
-00051220: 7075 7420 6973 2070 7265 7365 6e74 6564  put is presented
-00051230: 2e20 220a 2020 2020 2020 2020 6622 4375  . ".        f"Cu
-00051240: 7272 656e 746c 7920 6f66 6665 7265 6420  rrently offered 
-00051250: 6368 6f69 6365 7320 6172 653a 2027 7b4f  choices are: '{O
-00051260: 5554 5055 545f 5445 5854 7d27 2c20 277b  UTPUT_TEXT}', '{
-00051270: 4f55 5450 5554 5f4a 534f 4e7d 272c 2022  OUTPUT_JSON}', "
-00051280: 0a20 2020 2020 2020 2066 2227 7b4f 5554  .        f"'{OUT
-00051290: 5055 545f 4a53 4f4e 5f4d 4158 7d27 2c20  PUT_JSON_MAX}', 
-000512a0: 616e 6420 277b 4f55 5450 5554 5f4a 534f  and '{OUTPUT_JSO
-000512b0: 4e5f 5350 4543 7d27 2e20 220a 2020 2020  N_SPEC}'. ".    
-000512c0: 2020 2020 2250 726f 7669 6465 206f 6e65      "Provide one
-000512d0: 206f 6620 7468 6573 6520 6368 6f69 6365   of these choice
-000512e0: 732e 2022 0a20 2020 2020 2020 2066 2254  s. ".        f"T
-000512f0: 6865 2064 6566 6175 6c74 2069 7320 277b  he default is '{
-00051300: 4f55 5450 5554 5f44 4546 4155 4c54 7d27  OUTPUT_DEFAULT}'
-00051310: 2e20 4966 2079 6f75 2077 616e 7420 746f  . If you want to
-00051320: 2075 7365 2074 6865 2064 6566 6175 6c74   use the default
-00051330: 2c20 220a 2020 2020 2020 2020 2274 6865  , ".        "the
-00051340: 6e20 7468 6572 6520 6973 206e 6f20 6e65  n there is no ne
-00051350: 6564 2074 6f20 7573 6520 7468 6973 206f  ed to use this o
-00051360: 7074 696f 6e2e 2022 0a20 2020 2020 2020  ption. ".       
-00051370: 2066 2249 6620 796f 7520 6861 7665 2063   f"If you have c
-00051380: 686f 7365 6e20 277b 4f55 5450 5554 5f54  hosen '{OUTPUT_T
-00051390: 4558 547d 272c 2022 0a20 2020 2020 2020  EXT}', ".       
-000513a0: 2022 7468 6520 6f75 7470 7574 2077 696c   "the output wil
-000513b0: 6c20 6265 2066 6f72 6d61 7474 6564 2077  l be formatted w
-000513c0: 6974 6820 7468 6520 696e 7465 6e74 696f  ith the intentio
-000513d0: 6e20 746f 2062 6520 220a 2020 2020 2020  n to be ".      
-000513e0: 2020 2263 6f6e 7375 6d65 6420 6279 2068    "consumed by h
-000513f0: 756d 616e 732c 2069 2e65 2e20 7265 6164  umans, i.e. read
-00051400: 6162 6c65 2074 6578 742e 2022 0a20 2020  able text. ".   
-00051410: 2020 2020 2066 2249 6620 796f 7520 6861       f"If you ha
-00051420: 7665 2063 686f 7365 6e20 277b 4f55 5450  ve chosen '{OUTP
-00051430: 5554 5f4a 534f 4e7d 272c 2022 0a20 2020  UT_JSON}', ".   
-00051440: 2020 2020 2022 7468 6520 6f75 7470 7574       "the output
-00051450: 2077 696c 6c20 6265 2066 6f72 6d61 7474   will be formatt
-00051460: 6564 2061 7320 4a53 4f4e 2e20 220a 2020  ed as JSON. ".  
-00051470: 2020 2020 2020 2254 6865 2063 6f6e 7465        "The conte
-00051480: 6e74 206f 6620 7468 6520 4a53 4f4e 206f  nt of the JSON o
-00051490: 626a 6563 7420 6d61 7463 6865 7320 7468  bject matches th
-000514a0: 6520 6461 7461 2070 726f 7669 6465 6420  e data provided 
-000514b0: 6279 2074 6865 2022 0a20 2020 2020 2020  by the ".       
-000514c0: 2022 6d61 7472 6978 2d6e 696f 2053 444b   "matrix-nio SDK
-000514d0: 2e20 496e 2073 6f6d 6520 6f63 6361 7369  . In some occasi
-000514e0: 6f6e 7320 7468 6520 6f75 7470 7574 2069  ons the output i
-000514f0: 7320 656e 6861 6e63 6564 2022 0a20 2020  s enhanced ".   
-00051500: 2020 2020 2022 6279 2068 6176 696e 6720       "by having 
-00051510: 6120 6665 7720 6578 7472 6120 6461 7461  a few extra data
-00051520: 2069 7465 6d73 2061 6464 6564 2066 6f72   items added for
-00051530: 2063 6f6e 7665 6e69 656e 6365 2e20 220a   convenience. ".
-00051540: 2020 2020 2020 2020 2249 6e20 6d6f 7374          "In most
-00051550: 2063 6173 6573 2074 6865 206f 7574 7075   cases the outpu
-00051560: 7420 7769 6c6c 2062 6520 7072 6f63 6573  t will be proces
-00051570: 7365 6420 6279 206f 7468 6572 2070 726f  sed by other pro
-00051580: 6772 616d 7320 220a 2020 2020 2020 2020  grams ".        
-00051590: 2272 6174 6865 7220 7468 616e 2072 6561  "rather than rea
-000515a0: 6420 6279 2068 756d 616e 732e 2022 0a20  d by humans. ". 
-000515b0: 2020 2020 2020 2066 224f 7074 696f 6e20         f"Option 
-000515c0: 277b 4f55 5450 5554 5f4a 534f 4e5f 4d41  '{OUTPUT_JSON_MA
-000515d0: 587d 2720 6973 2070 7261 6374 6963 616c  X}' is practical
-000515e0: 6c79 2074 6865 2073 616d 6520 6173 2022  ly the same as "
-000515f0: 0a20 2020 2020 2020 2066 2227 7b4f 5554  .        f"'{OUT
-00051600: 5055 545f 4a53 4f4e 7d27 2c20 220a 2020  PUT_JSON}', ".  
-00051610: 2020 2020 2020 2262 7574 2079 6574 2061        "but yet a
-00051620: 6e6f 7468 6572 2061 6464 6974 696f 6e61  nother additiona
-00051630: 6c20 6669 656c 6420 6973 2061 6464 6564  l field is added
-00051640: 2e20 220a 2020 2020 2020 2020 2254 6865  . ".        "The
-00051650: 2064 6174 6120 6974 656d 2027 7472 616e   data item 'tran
-00051660: 7370 6f72 745f 7265 7370 6f6e 7365 2720  sport_response' 
-00051670: 7768 6963 6820 6769 7665 7320 696e 666f  which gives info
-00051680: 726d 6174 696f 6e20 6f6e 2022 0a20 2020  rmation on ".   
-00051690: 2020 2020 2022 686f 7720 7468 6520 6461       "how the da
-000516a0: 7461 2077 6173 206f 6274 6169 6e65 6420  ta was obtained 
-000516b0: 616e 6420 7472 616e 7370 6f72 7465 6420  and transported 
-000516c0: 6973 2061 6c73 6f20 6265 696e 6720 6164  is also being ad
-000516d0: 6465 642e 2022 0a20 2020 2020 2020 2022  ded. ".        "
-000516e0: 466f 7220 272d 2d6c 6973 7465 6e27 2061  For '--listen' a
-000516f0: 2066 6577 206d 6f72 6520 6669 656c 6473   few more fields
-00051700: 2061 7265 2061 6464 6564 2e20 220a 2020   are added. ".  
-00051710: 2020 2020 2020 2249 6e20 6d6f 7374 2063        "In most c
-00051720: 6173 6573 2074 6865 206f 7574 7075 7420  ases the output 
-00051730: 7769 6c6c 2062 6520 7072 6f63 6573 7365  will be processe
-00051740: 6420 6279 206f 7468 6572 2070 726f 6772  d by other progr
-00051750: 616d 7320 220a 2020 2020 2020 2020 2272  ams ".        "r
-00051760: 6174 6865 7220 7468 616e 2072 6561 6420  ather than read 
-00051770: 6279 2068 756d 616e 732e 2022 0a20 2020  by humans. ".   
-00051780: 2020 2020 2066 224f 7074 696f 6e20 277b       f"Option '{
-00051790: 4f55 5450 5554 5f4a 534f 4e5f 5350 4543  OUTPUT_JSON_SPEC
-000517a0: 7d27 206f 6e6c 7920 7072 696e 7473 2069  }' only prints i
-000517b0: 6e66 6f72 6d61 7469 6f6e 2074 6861 7420  nformation that 
-000517c0: 6164 6865 7265 7320 220a 2020 2020 2020  adheres ".      
-000517d0: 2020 2231 2d74 6f2d 3120 746f 2074 6865    "1-to-1 to the
-000517e0: 204d 6174 7269 7820 5370 6563 6966 6963   Matrix Specific
-000517f0: 6174 696f 6e2e 2043 7572 7265 6e74 6c79  ation. Currently
-00051800: 206f 6e6c 7920 7468 6520 6576 656e 7473   only the events
-00051810: 2022 0a20 2020 2020 2020 2022 6f6e 2027   ".        "on '
-00051820: 2d2d 6c69 7374 656e 2720 616e 6420 272d  --listen' and '-
-00051830: 2d74 6169 6c27 2070 726f 7669 6465 2064  -tail' provide d
-00051840: 6174 6120 6578 6163 746c 7920 6173 2069  ata exactly as i
-00051850: 6e20 7468 6520 220a 2020 2020 2020 2020  n the ".        
-00051860: 224d 6174 7269 7820 5370 6563 6966 6963  "Matrix Specific
-00051870: 6174 696f 6e2e 2049 6620 6e6f 2064 6174  ation. If no dat
-00051880: 6120 6973 2061 7661 696c 6162 6c65 2074  a is available t
-00051890: 6861 7420 636f 7272 6573 706f 6e64 7320  hat corresponds 
-000518a0: 220a 2020 2020 2020 2020 2265 7861 6374  ".        "exact
-000518b0: 6c79 2077 6974 6820 7468 6520 4d61 7472  ly with the Matr
-000518c0: 6978 2053 7065 6369 6669 6361 7469 6f6e  ix Specification
-000518d0: 2c20 6e6f 2064 6174 6120 7769 6c6c 2062  , no data will b
-000518e0: 6520 7072 696e 7465 642e 2022 0a20 2020  e printed. ".   
-000518f0: 2020 2020 2022 496e 2073 686f 7274 2c20       "In short, 
-00051900: 6375 7272 656e 746c 7920 272d 2d6a 736f  currently '--jso
-00051910: 6e2d 7370 6563 2720 6f6e 6c79 2070 726f  n-spec' only pro
-00051920: 7669 6465 7320 6f75 7470 7574 7320 666f  vides outputs fo
-00051930: 7220 220a 2020 2020 2020 2020 2227 2d2d  r ".        "'--
-00051940: 6c69 7374 656e 2720 616e 6420 272d 2d74  listen' and '--t
-00051950: 6169 6c27 2e20 416c 6c20 6f74 6865 7220  ail'. All other 
-00051960: 6172 6775 6d65 6e74 7320 6c69 6b65 2027  arguments like '
-00051970: 2d2d 6765 742d 726f 6f6d 2d69 6e66 6f27  --get-room-info'
-00051980: 2022 0a20 2020 2020 2020 2022 7769 6c6c   ".        "will
-00051990: 2070 7269 6e74 206e 6f20 6f75 7470 7574   print no output
-000519a0: 2e20 222c 0a20 2020 2029 0a20 2020 2061  . ",.    ).    a
-000519b0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
-000519c0: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
-000519d0: 696e 7669 7465 7322 2c0a 2020 2020 2020  invites",.      
-000519e0: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
-000519f0: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
-00051a00: 7472 2c0a 2020 2020 2020 2020 6465 6661  tr,.        defa
-00051a10: 756c 743d 494e 5649 5445 535f 554e 5553  ult=INVITES_UNUS
-00051a20: 4544 5f44 4546 4155 4c54 2c20 2023 2077  ED_DEFAULT,  # w
-00051a30: 6865 6e20 2d2d 726f 6f6d 2d69 6e76 6974  hen --room-invit
-00051a40: 6573 2069 7320 6e6f 7420 7573 6564 0a20  es is not used. 
-00051a50: 2020 2020 2020 206e 6172 6773 3d22 3f22         nargs="?"
-00051a60: 2c20 2023 206d 616b 6573 2074 6865 2077  ,  # makes the w
-00051a70: 6f72 6420 6f70 7469 6f6e 616c 0a20 2020  ord optional.   
-00051a80: 2020 2020 2023 2077 6865 6e20 2d2d 726f       # when --ro
-00051a90: 6f6d 2d69 6e76 6974 6573 2069 7320 7573  om-invites is us
-00051aa0: 6564 2c20 6275 7420 7465 7874 2069 7320  ed, but text is 
-00051ab0: 6e6f 7420 6164 6465 640a 2020 2020 2020  not added.      
-00051ac0: 2020 636f 6e73 743d 494e 5649 5445 535f    const=INVITES_
-00051ad0: 5553 4544 5f44 4546 4155 4c54 2c0a 2020  USED_DEFAULT,.  
-00051ae0: 2020 2020 2020 6d65 7461 7661 723d 224c        metavar="L
-00051af0: 4953 547c 4a4f 494e 7c4c 4953 542b 4a4f  IST|JOIN|LIST+JO
-00051b00: 494e 222c 0a20 2020 2020 2020 2068 656c  IN",.        hel
-00051b10: 703d 224c 6973 7420 726f 6f6d 2069 6e76  p="List room inv
-00051b20: 6974 6174 696f 6e73 2061 6e64 2f6f 7220  itations and/or 
-00051b30: 6a6f 696e 2069 6e76 6974 6564 2072 6f6f  join invited roo
-00051b40: 6d73 2e20 220a 2020 2020 2020 2020 2244  ms. ".        "D
-00051b50: 6574 6169 6c73 3a3a 2054 6869 7320 6f70  etails:: This op
-00051b60: 7469 6f6e 2074 616b 6573 207a 6572 6f20  tion takes zero 
-00051b70: 6f72 206f 6e65 2061 7267 756d 656e 742e  or one argument.
-00051b80: 2022 0a20 2020 2020 2020 2066 2249 6620   ".        f"If 
-00051b90: 6e6f 2061 7267 756d 656e 7420 6973 2067  no argument is g
-00051ba0: 6976 656e 2c20 277b 494e 5649 5445 535f  iven, '{INVITES_
-00051bb0: 4c49 5354 7d27 2069 7320 6173 7375 6d65  LIST}' is assume
-00051bc0: 6420 7768 6963 6820 7769 6c6c 2022 0a20  d which will ". 
-00051bd0: 2020 2020 2020 2066 226c 6973 7420 616c         f"list al
-00051be0: 6c20 726f 6f6d 2069 6e76 6974 6174 696f  l room invitatio
-00051bf0: 6e20 6576 656e 7473 2061 7320 7468 6579  n events as they
-00051c00: 2061 7265 2072 6563 6569 7665 642e 2022   are received. "
-00051c10: 0a20 2020 2020 2020 2066 2227 7b49 4e56  .        f"'{INV
-00051c20: 4954 4553 5f4a 4f49 4e7d 2720 7769 6c6c  ITES_JOIN}' will
-00051c30: 206a 6f69 6e20 7468 6520 726f 6f6d 2873   join the room(s
-00051c40: 2920 6561 6368 2074 696d 6520 6120 726f  ) each time a ro
-00051c50: 6f6d 2069 6e76 6974 6174 696f 6e20 220a  om invitation ".
-00051c60: 2020 2020 2020 2020 2269 7320 7265 6365          "is rece
-00051c70: 6976 6564 2e20 220a 2020 2020 2020 2020  ived. ".        
-00051c80: 6622 277b 494e 5649 5445 535f 4c49 5354  f"'{INVITES_LIST
-00051c90: 5f4a 4f49 4e7d 2720 7769 6c6c 2064 6f20  _JOIN}' will do 
-00051ca0: 626f 7468 2c20 6c69 7374 2074 6865 2069  both, list the i
-00051cb0: 6e76 6974 6174 696f 6e73 2061 7320 7765  nvitations as we
-00051cc0: 6c6c 2022 0a20 2020 2020 2020 2022 6173  ll ".        "as
-00051cd0: 2061 7574 6f6d 6174 6963 616c 6c79 206a   automatically j
-00051ce0: 6f69 6e20 7468 6520 726f 6f6d 7320 746f  oin the rooms to
-00051cf0: 2077 6869 6368 2061 6e20 696e 7669 7461   which an invita
-00051d00: 7469 6f6e 2077 6173 2072 6563 6569 7665  tion was receive
-00051d10: 642e 2022 0a20 2020 2020 2020 2022 5468  d. ".        "Th
-00051d20: 6973 206f 7074 696f 6e20 6f6e 6c79 2068  is option only h
-00051d30: 6173 2065 6666 6563 7420 6966 206c 6973  as effect if lis
-00051d40: 7465 6e69 6e67 206f 6e63 6520 6f72 2066  tening once or f
-00051d50: 6f72 6576 6572 2120 220a 2020 2020 2020  orever! ".      
-00051d60: 2020 2253 6f20 7573 6520 272d 2d6c 6973    "So use '--lis
-00051d70: 7465 6e20 6f6e 6365 2720 6f72 2027 2d2d  ten once' or '--
-00051d80: 6c69 7374 656e 2066 6f72 6576 6572 2720  listen forever' 
-00051d90: 746f 6765 7468 6572 2022 0a20 2020 2020  together ".     
-00051da0: 2020 2022 7769 7468 2074 6869 7320 6f70     "with this op
-00051db0: 7469 6f6e 2e20 220a 2020 2020 2020 2020  tion. ".        
-00051dc0: 2244 6f6e 2774 2063 6f6e 6675 7365 2074  "Don't confuse t
-00051dd0: 6869 7320 6f70 7469 6f6e 2077 6974 6820  his option with 
-00051de0: 2d2d 726f 6f6d 2d69 6e76 6974 652e 222c  --room-invite.",
-00051df0: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
-00051e00: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
-00051e10: 2020 2020 222d 7622 2c20 2023 2069 6e63      "-v",  # inc
-00051e20: 6f6d 7061 7469 626c 6520 6368 616e 6765  ompatible change
-00051e30: 2044 6563 2032 3032 322c 202d 7620 6d6f   Dec 2022, -v mo
-00051e40: 7665 6420 6865 7265 2066 726f 6d20 2d2d  ved here from --
-00051e50: 7665 7269 6679 0a20 2020 2020 2020 2022  verify.        "
-00051e60: 2d56 222c 2020 2320 6578 6365 7074 696f  -V",  # exceptio
-00051e70: 6e2c 2061 6c6c 6f77 2061 6c73 6f20 7570  n, allow also up
-00051e80: 7065 7263 6173 6520 560a 2020 2020 2020  percase V.      
-00051e90: 2020 222d 2d76 6572 7369 6f6e 222c 0a20    "--version",. 
-00051ea0: 2020 2020 2020 2072 6571 7569 7265 643d         required=
-00051eb0: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
-00051ec0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
-00051ed0: 2064 6566 6175 6c74 3d56 4552 5349 4f4e   default=VERSION
-00051ee0: 5f55 4e55 5345 445f 4445 4641 554c 542c  _UNUSED_DEFAULT,
-00051ef0: 2020 2320 7768 656e 202d 7420 6973 206e    # when -t is n
-00051f00: 6f74 2075 7365 640a 2020 2020 2020 2020  ot used.        
-00051f10: 6e61 7267 733d 223f 222c 2020 2320 6d61  nargs="?",  # ma
-00051f20: 6b65 7320 7468 6520 776f 7264 206f 7074  kes the word opt
-00051f30: 696f 6e61 6c0a 2020 2020 2020 2020 2320  ional.        # 
-00051f40: 7768 656e 202d 7620 6973 2075 7365 642c  when -v is used,
-00051f50: 2062 7574 2074 6578 7420 6973 206e 6f74   but text is not
-00051f60: 2061 6464 6564 0a20 2020 2020 2020 2063   added.        c
-00051f70: 6f6e 7374 3d56 4552 5349 4f4e 5f55 5345  onst=VERSION_USE
-00051f80: 445f 4445 4641 554c 542c 0a20 2020 2020  D_DEFAULT,.     
-00051f90: 2020 206d 6574 6176 6172 3d22 5052 494e     metavar="PRIN
-00051fa0: 547c 4348 4543 4b22 2c0a 2020 2020 2020  T|CHECK",.      
-00051fb0: 2020 6865 6c70 3d22 5072 696e 7420 7665    help="Print ve
-00051fc0: 7273 696f 6e20 696e 666f 726d 6174 696f  rsion informatio
-00051fd0: 6e20 6f72 2063 6865 636b 2066 6f72 2075  n or check for u
-00051fe0: 7064 6174 6573 2e20 220a 2020 2020 2020  pdates. ".      
-00051ff0: 2020 2244 6574 6169 6c73 3a3a 2054 6869    "Details:: Thi
-00052000: 7320 6f70 7469 6f6e 2074 616b 6573 207a  s option takes z
-00052010: 6572 6f20 6f72 206f 6e65 2061 7267 756d  ero or one argum
-00052020: 656e 742e 2022 0a20 2020 2020 2020 2066  ent. ".        f
-00052030: 2249 6620 6e6f 2061 7267 756d 656e 7420  "If no argument 
-00052040: 6973 2067 6976 656e 2c20 277b 5052 494e  is given, '{PRIN
-00052050: 547d 2720 6973 2061 7373 756d 6564 2077  T}' is assumed w
-00052060: 6869 6368 2077 696c 6c20 220a 2020 2020  hich will ".    
-00052070: 2020 2020 6622 7072 696e 7420 7468 6520      f"print the 
-00052080: 7665 7273 696f 6e20 6f66 2074 6865 2063  version of the c
-00052090: 7572 7265 6e74 6c79 2069 6e73 7461 6c6c  urrently install
-000520a0: 6564 2027 5052 4f47 5f57 4954 484f 5554  ed 'PROG_WITHOUT
-000520b0: 5f45 5854 2720 220a 2020 2020 2020 2020  _EXT' ".        
-000520c0: 6622 7061 636b 6167 652e 2027 7b43 4845  f"package. '{CHE
-000520d0: 434b 7d27 2069 7320 7468 6520 616c 7465  CK}' is the alte
-000520e0: 726e 6174 6976 652e 2022 0a20 2020 2020  rnative. ".     
-000520f0: 2020 2022 277b 4348 4543 4b7d 2720 636f     "'{CHECK}' co
-00052100: 6e6e 6563 7473 2074 6f20 6874 7470 733a  nnects to https:
-00052110: 2f2f 7079 7069 2e6f 7267 2061 6e64 2067  //pypi.org and g
-00052120: 6574 7320 7468 6520 7665 7273 696f 6e20  ets the version 
-00052130: 220a 2020 2020 2020 2020 226e 756d 6265  ".        "numbe
-00052140: 7220 6f66 206c 6174 6573 7420 7374 6162  r of latest stab
-00052150: 6c65 2072 656c 6561 7365 2e20 5468 6572  le release. Ther
-00052160: 6520 6973 206e 6f20 2763 616c 6c69 6e67  e is no 'calling
-00052170: 2068 6f6d 6527 2022 0a20 2020 2020 2020   home' ".       
-00052180: 2022 6f6e 2065 7665 7279 2072 756e 2c20   "on every run, 
-00052190: 6f6e 6c79 2061 2027 6368 6563 6b20 7079  only a 'check py
-000521a0: 7069 2e6f 7267 2720 7570 6f6e 2072 6571  pi.org' upon req
-000521b0: 7565 7374 2e20 596f 7572 2022 0a20 2020  uest. Your ".   
-000521c0: 2020 2020 2022 7072 6976 6163 7920 6973       "privacy is
-000521d0: 2070 726f 7465 6374 6564 2e20 5468 6520   protected. The 
-000521e0: 6e65 7720 7265 6c65 6173 6520 6973 206e  new release is n
-000521f0: 6569 7468 6572 2064 6f77 6e6c 6f61 6465  either downloade
-00052200: 642c 2022 0a20 2020 2020 2020 2022 6e6f  d, ".        "no
-00052210: 7220 696e 7374 616c 6c65 642e 2049 7420  r installed. It 
-00052220: 6a75 7374 2069 6e66 6f72 6d73 2079 6f75  just informs you
-00052230: 2e20 220a 2020 2020 2020 2020 2241 6674  . ".        "Aft
-00052240: 6572 2070 7269 6e74 696e 6720 7665 7273  er printing vers
-00052250: 696f 6e20 696e 666f 726d 6174 696f 6e20  ion information 
-00052260: 7468 6520 220a 2020 2020 2020 2020 2270  the ".        "p
-00052270: 726f 6772 616d 2077 696c 6c20 636f 6e74  rogram will cont
-00052280: 696e 7565 2074 6f20 7275 6e2e 2054 6869  inue to run. Thi
-00052290: 7320 6973 2075 7365 6675 6c20 666f 7220  s is useful for 
-000522a0: 6861 7669 6e67 2076 6572 7369 6f6e 2022  having version "
-000522b0: 0a20 2020 2020 2020 2022 6e75 6d62 6572  .        "number
-000522c0: 2069 6e20 7468 6520 6c6f 6720 6669 6c65   in the log file
-000522d0: 732e 222c 0a20 2020 2029 0a20 2020 2067  s.",.    ).    g
-000522e0: 732e 7061 203d 2061 702e 7061 7273 655f  s.pa = ap.parse_
-000522f0: 6172 6773 2829 0a20 2020 2023 2077 7261  args().    # wra
-00052300: 7020 616e 6420 696e 6465 6e74 3a20 6874  p and indent: ht
-00052310: 7470 733a 2f2f 746f 7761 7264 7364 6174  tps://towardsdat
-00052320: 6173 6369 656e 6365 2e63 6f6d 2f36 2d66  ascience.com/6-f
-00052330: 616e 6379 2d62 7569 6c74 2d69 6e2d 7465  ancy-built-in-te
-00052340: 7874 2d0a 2020 2020 2320 2020 2020 2020  xt-.    #       
-00052350: 2020 2020 2020 2020 2020 2077 7261 7070             wrapp
-00052360: 696e 672d 7465 6368 6e69 7175 6573 2d69  ing-techniques-i
-00052370: 6e2d 7079 7468 6f6e 2d61 3738 6363 3537  n-python-a78cc57
-00052380: 6332 3536 360a 2020 2020 2320 6966 206f  c2566.    # if o
-00052390: 7574 7075 7420 6973 206e 6f74 2054 5459  utput is not TTY
-000523a0: 2c20 7468 656e 2064 6f6e 2774 2061 6464  , then don't add
-000523b0: 2063 6f6c 6f72 732c 2065 2e67 2e20 7768   colors, e.g. wh
-000523c0: 656e 206f 7574 7075 7420 6973 2070 6970  en output is pip
-000523d0: 6564 0a20 2020 2069 6620 7379 732e 7374  ed.    if sys.st
-000523e0: 646f 7574 2e69 7361 7474 7928 293a 0a20  dout.isatty():. 
-000523f0: 2020 2020 2020 2023 2059 6f75 2772 6520         # You're 
-00052400: 7275 6e6e 696e 6720 696e 2061 2072 6561  running in a rea
-00052410: 6c20 7465 726d 696e 616c 0a20 2020 2020  l terminal.     
-00052420: 2020 2023 2063 6f6c 6f72 730a 2020 2020     # colors.    
-00052430: 2020 2020 2320 6164 6170 7420 7769 6474      # adapt widt
-00052440: 680a 2020 2020 2020 2020 7465 726d 5f77  h.        term_w
-00052450: 6964 7468 203d 206f 732e 6765 745f 7465  idth = os.get_te
-00052460: 726d 696e 616c 5f73 697a 6528 295b 305d  rminal_size()[0]
-00052470: 0a20 2020 2020 2020 2023 2070 7269 6e74  .        # print
-00052480: 2822 7465 726d 696e 616c 2077 6964 7468  ("terminal width
-00052490: 2022 2c20 7465 726d 5f77 6964 7468 290a   ", term_width).
-000524a0: 2020 2020 2020 2020 636f 6e20 3d20 636f          con = co
-000524b0: 6c6f 7273 2e66 672e 6772 6565 6e0a 2020  lors.fg.green.  
-000524c0: 2020 2020 2020 636f 6666 203d 2063 6f6c        coff = col
-000524d0: 6f72 732e 7265 7365 740a 2020 2020 2020  ors.reset.      
-000524e0: 2020 656f 6e20 3d20 636f 6c6f 7273 2e62    eon = colors.b
-000524f0: 6f6c 6420 2b20 636f 6e0a 2020 2020 2020  old + con.      
-00052500: 2020 656f 6666 203d 2063 6f6c 6f72 732e    eoff = colors.
-00052510: 7265 7365 7420 2b20 636f 6e0a 2020 2020  reset + con.    
-00052520: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00052530: 596f 7527 7265 2062 6569 6e67 2070 6970  You're being pip
-00052540: 6564 206f 7220 7265 6469 7265 6374 6564  ed or redirected
-00052550: 0a20 2020 2020 2020 2023 206e 6f20 436f  .        # no Co
-00052560: 6c6f 7273 0a20 2020 2020 2020 2023 2077  lors.        # w
-00052570: 6964 7468 203d 2038 300a 2020 2020 2020  idth = 80.      
-00052580: 2020 7465 726d 5f77 6964 7468 203d 2038    term_width = 8
-00052590: 300a 2020 2020 2020 2020 2320 7072 696e  0.        # prin
-000525a0: 7428 226e 6f74 2069 6e20 7465 726d 696e  t("not in termin
-000525b0: 616c 2c20 7573 696e 6720 6465 6661 756c  al, using defaul
-000525c0: 7420 7465 726d 696e 616c 2077 6964 7468  t terminal width
-000525d0: 2022 2c20 7465 726d 5f77 6964 7468 290a   ", term_width).
-000525e0: 2020 2020 2020 2020 636f 6e20 3d20 2222          con = ""
-000525f0: 0a20 2020 2020 2020 2063 6f66 6620 3d20  .        coff = 
-00052600: 2222 0a20 2020 2020 2020 2065 6f6e 203d  "".        eon =
-00052610: 2022 220a 2020 2020 2020 2020 656f 6666   "".        eoff
-00052620: 203d 2022 220a 2020 2020 6966 2067 732e   = "".    if gs.
-00052630: 7061 2e75 7361 6765 3a0a 2020 2020 2020  pa.usage:.      
-00052640: 2020 7072 696e 7428 7465 7874 7772 6170    print(textwrap
-00052650: 2e66 696c 6c28 6170 2e64 6573 6372 6970  .fill(ap.descrip
-00052660: 7469 6f6e 2c20 7769 6474 683d 7465 726d  tion, width=term
-00052670: 5f77 6964 7468 2929 0a20 2020 2020 2020  _width)).       
-00052680: 2070 7269 6e74 2822 2229 0a20 2020 2020   print("").     
-00052690: 2020 2061 702e 7072 696e 745f 7573 6167     ap.print_usag
-000526a0: 6528 290a 2020 2020 2020 2020 7072 696e  e().        prin
-000526b0: 7428 2222 290a 2020 2020 2020 2020 7072  t("").        pr
-000526c0: 696e 7428 7465 7874 7772 6170 2e66 696c  int(textwrap.fil
-000526d0: 6c28 6170 2e65 7069 6c6f 672c 2077 6964  l(ap.epilog, wid
-000526e0: 7468 3d74 6572 6d5f 7769 6474 6829 290a  th=term_width)).
-000526f0: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-00052700: 0a20 2020 2069 6620 6773 2e70 612e 6865  .    if gs.pa.he
-00052710: 6c70 3a0a 2020 2020 2020 2020 7072 696e  lp:.        prin
-00052720: 7428 7465 7874 7772 6170 2e66 696c 6c28  t(textwrap.fill(
-00052730: 6170 2e64 6573 6372 6970 7469 6f6e 2c20  ap.description, 
-00052740: 7769 6474 683d 7465 726d 5f77 6964 7468  width=term_width
-00052750: 2929 0a20 2020 2020 2020 2070 7269 6e74  )).        print
-00052760: 2822 2229 0a20 2020 2020 2020 2070 7269  ("").        pri
-00052770: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
-00052780: 7465 7874 7772 6170 2e66 696c 6c28 0a20  textwrap.fill(. 
-00052790: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000527a0: 227b 5052 4f47 5f57 4954 484f 5554 5f45  "{PROG_WITHOUT_E
-000527b0: 5854 7d20 7375 7070 6f72 7473 2074 6865  XT} supports the
-000527c0: 7365 2061 7267 756d 656e 7473 3a22 2c0a  se arguments:",.
-000527d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000527e0: 7769 6474 683d 7465 726d 5f77 6964 7468  width=term_width
-000527f0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00052800: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00052810: 2020 2320 7072 696e 7428 2222 290a 2020    # print("").  
-00052820: 2020 2020 2020 6865 6c70 5f68 656c 705f        help_help_
-00052830: 7072 6520 3d20 2222 220a 3c2d 2d75 7361  pre = """.<--usa
-00052840: 6765 3e0a 5072 696e 7420 7573 6167 652e  ge>.Print usage.
-00052850: 0a3c 2d68 3e2c 203c 2d2d 6865 6c70 3e0a  .<-h>, <--help>.
-00052860: 5072 696e 7420 6865 6c70 2e0a 3c2d 2d6d  Print help..<--m
-00052870: 616e 7561 6c3e 0a50 7269 6e74 206d 616e  anual>.Print man
-00052880: 7561 6c2e 0a3c 2d2d 7265 6164 6d65 3e0a  ual..<--readme>.
-00052890: 5072 696e 7420 5245 4144 4d45 2e6d 6420  Print README.md 
-000528a0: 6669 6c65 2e0a 3c2d 643e 2c20 3c2d 2d64  file..<-d>, <--d
-000528b0: 6562 7567 3e0a 5072 696e 7420 6465 6275  ebug>.Print debu
-000528c0: 6720 696e 666f 726d 6174 696f 6e2e 0a3c  g information..<
-000528d0: 2d2d 6c6f 672d 6c65 7665 6c3e 2044 4542  --log-level> DEB
-000528e0: 5547 7c49 4e46 4f7c 5741 524e 494e 477c  UG|INFO|WARNING|
-000528f0: 4552 524f 527c 4352 4954 4943 414c 205b  ERROR|CRITICAL [
-00052900: 4445 4255 477c 494e 464f 7c57 4152 4e49  DEBUG|INFO|WARNI
-00052910: 4e47 7c45 5252 4f52 7c43 5249 5449 4341  NG|ERROR|CRITICA
-00052920: 4c20 2e2e 2e5d 0a53 6574 2074 6865 206c  L ...].Set the l
-00052930: 6f67 206c 6576 656c 2873 292e 0a3c 2d2d  og level(s)..<--
-00052940: 7665 7262 6f73 653e 0a53 6574 2074 6865  verbose>.Set the
-00052950: 2076 6572 626f 7369 7479 206c 6576 656c   verbosity level
-00052960: 2e0a 3c2d 2d6c 6f67 696e 3e20 5041 5353  ..<--login> PASS
-00052970: 574f 5244 7c53 534f 0a4c 6f67 696e 2074  WORD|SSO.Login t
-00052980: 6f20 616e 6420 6175 7468 656e 7469 6361  o and authentica
-00052990: 7465 2077 6974 6820 7468 6520 4d61 7472  te with the Matr
-000529a0: 6978 2068 6f6d 6573 6572 7665 722e 0a3c  ix homeserver..<
-000529b0: 2d2d 7665 7269 6679 3e20 5b45 4d4f 4a49  --verify> [EMOJI
-000529c0: 5d0a 5065 7266 6f72 6d20 7665 7269 6669  ].Perform verifi
-000529d0: 6361 7469 6f6e 2e0a 3c2d 2d6c 6f67 6f75  cation..<--logou
-000529e0: 743e 204d 457c 414c 4c0a 4c6f 676f 7574  t> ME|ALL.Logout
-000529f0: 2e0a 3c2d 633e 2043 5245 4445 4e54 4941  ..<-c> CREDENTIA
-00052a00: 4c53 5f46 494c 452c 203c 2d2d 6372 6564  LS_FILE, <--cred
-00052a10: 656e 7469 616c 733e 2043 5245 4445 4e54  entials> CREDENT
-00052a20: 4941 4c53 5f46 494c 450a 5370 6563 6966  IALS_FILE.Specif
-00052a30: 7920 6c6f 6361 7469 6f6e 206f 6620 6372  y location of cr
-00052a40: 6564 656e 7469 616c 7320 6669 6c65 2e0a  edentials file..
-00052a50: 3c2d 733e 2053 544f 5245 5f44 4952 4543  <-s> STORE_DIREC
-00052a60: 544f 5259 2c20 3c2d 2d73 746f 7265 3e20  TORY, <--store> 
-00052a70: 5354 4f52 455f 4449 5245 4354 4f52 590a  STORE_DIRECTORY.
-00052a80: 5370 6563 6966 7920 6c6f 6361 7469 6f6e  Specify location
-00052a90: 206f 6620 7374 6f72 6520 6469 7265 6374   of store direct
-00052aa0: 6f72 792e 0a3c 2d72 3e20 524f 4f4d 205b  ory..<-r> ROOM [
-00052ab0: 524f 4f4d 202e 2e2e 5d2c 203c 2d2d 726f  ROOM ...], <--ro
-00052ac0: 6f6d 3e20 524f 4f4d 205b 524f 4f4d 202e  om> ROOM [ROOM .
-00052ad0: 2e2e 5d0a 5370 6563 6966 7920 6f6e 6520  ..].Specify one 
-00052ae0: 6f72 206d 756c 7469 706c 6520 726f 6f6d  or multiple room
-00052af0: 732e 0a3c 2d2d 726f 6f6d 2d64 6566 6175  s..<--room-defau
-00052b00: 6c74 3e20 4445 4641 554c 545f 524f 4f4d  lt> DEFAULT_ROOM
-00052b10: 0a53 7065 6369 6679 2074 6865 2064 6566  .Specify the def
-00052b20: 6175 6c74 2072 6f6f 6d20 6174 202d 2d6c  ault room at --l
-00052b30: 6f67 696e 2e0a 3c2d 2d72 6f6f 6d2d 6372  ogin..<--room-cr
-00052b40: 6561 7465 3e20 524f 4f4d 5f41 4c49 4153  eate> ROOM_ALIAS
-00052b50: 205b 524f 4f4d 5f41 4c49 4153 202e 2e2e   [ROOM_ALIAS ...
-00052b60: 5d0a 4372 6561 7465 206f 6e65 206f 7220  ].Create one or 
-00052b70: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2066  multiple rooms f
-00052b80: 6f72 2067 6976 656e 2061 6c69 6173 2865  or given alias(e
-00052b90: 7329 2e0a 3c2d 2d72 6f6f 6d2d 646d 2d63  s)..<--room-dm-c
-00052ba0: 7265 6174 653e 2055 5345 5220 5b55 5345  reate> USER [USE
-00052bb0: 5220 2e2e 2e5d 0a43 7265 6174 6520 6f6e  R ...].Create on
-00052bc0: 6520 6f72 206d 756c 7469 706c 6520 444d  e or multiple DM
-00052bd0: 2072 6f6f 6d73 2077 6974 6820 7468 6520   rooms with the 
-00052be0: 7370 6563 6966 6965 6420 7573 6572 732e  specified users.
-00052bf0: 0a3c 2d2d 726f 6f6d 2d6a 6f69 6e3e 2052  .<--room-join> R
-00052c00: 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a4a  OOM [ROOM ...].J
-00052c10: 6f69 6e20 6f6e 6520 726f 6f6d 206f 7220  oin one room or 
-00052c20: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2e0a  multiple rooms..
-00052c30: 3c2d 2d72 6f6f 6d2d 6c65 6176 653e 2052  <--room-leave> R
-00052c40: 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a4c  OOM [ROOM ...].L
-00052c50: 6561 7665 206f 6e65 2072 6f6f 6d20 6f72  eave one room or
-00052c60: 206d 756c 7469 706c 6520 726f 6f6d 732e   multiple rooms.
-00052c70: 0a3c 2d2d 726f 6f6d 2d66 6f72 6765 743e  .<--room-forget>
-00052c80: 2052 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d   ROOM [ROOM ...]
-00052c90: 0a46 6f72 6765 7420 6f6e 6520 726f 6f6d  .Forget one room
-00052ca0: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
-00052cb0: 6d73 2e0a 3c2d 2d72 6f6f 6d2d 696e 7669  ms..<--room-invi
-00052cc0: 7465 3e20 524f 4f4d 205b 524f 4f4d 202e  te> ROOM [ROOM .
-00052cd0: 2e2e 5d0a 496e 7669 7465 206f 6e65 206f  ..].Invite one o
-00052ce0: 7265 206d 6f72 6520 7573 6572 7320 746f  re more users to
-00052cf0: 206a 6f69 6e20 6f6e 6520 6f72 206d 6f72   join one or mor
-00052d00: 6520 726f 6f6d 732e 0a3c 2d2d 726f 6f6d  e rooms..<--room
-00052d10: 2d62 616e 3e20 524f 4f4d 205b 524f 4f4d  -ban> ROOM [ROOM
-00052d20: 202e 2e2e 5d0a 4261 6e20 6f6e 6520 6f72   ...].Ban one or
-00052d30: 6520 6d6f 7265 2075 7365 7273 2066 726f  e more users fro
-00052d40: 6d20 6f6e 6520 6f72 206d 6f72 6520 726f  m one or more ro
-00052d50: 6f6d 732e 0a3c 2d2d 726f 6f6d 2d75 6e62  oms..<--room-unb
-00052d60: 616e 3e20 524f 4f4d 205b 524f 4f4d 202e  an> ROOM [ROOM .
-00052d70: 2e2e 5d0a 556e 6261 6e20 6f6e 6520 6f72  ..].Unban one or
-00052d80: 6520 6d6f 7265 2075 7365 7273 2066 726f  e more users fro
-00052d90: 6d20 6f6e 6520 6f72 206d 6f72 6520 726f  m one or more ro
-00052da0: 6f6d 732e 0a3c 2d2d 726f 6f6d 2d6b 6963  oms..<--room-kic
-00052db0: 6b3e 2052 4f4f 4d20 5b52 4f4f 4d20 2e2e  k> ROOM [ROOM ..
-00052dc0: 2e5d 0a4b 6963 6b20 6f6e 6520 6f72 6520  .].Kick one ore 
-00052dd0: 6d6f 7265 2075 7365 7273 2066 726f 6d20  more users from 
-00052de0: 6f6e 6520 6f72 206d 6f72 6520 726f 6f6d  one or more room
-00052df0: 732e 0a3c 2d75 3e20 5553 4552 205b 5553  s..<-u> USER [US
-00052e00: 4552 202e 2e2e 5d2c 203c 2d2d 7573 6572  ER ...], <--user
-00052e10: 3e20 5553 4552 205b 5553 4552 202e 2e2e  > USER [USER ...
-00052e20: 5d0a 5370 6563 6966 7920 6f6e 6520 6f72  ].Specify one or
-00052e30: 206d 756c 7469 706c 6520 7573 6572 732e   multiple users.
-00052e40: 0a3c 2d2d 7573 6572 2d6c 6f67 696e 3e20  .<--user-login> 
-00052e50: 5553 4552 0a53 7065 6369 6679 2075 7365  USER.Specify use
-00052e60: 7220 666f 7220 2d2d 6c6f 6769 6e2e 0a3c  r for --login..<
-00052e70: 2d2d 6e61 6d65 3e20 524f 4f4d 5f4e 414d  --name> ROOM_NAM
-00052e80: 4520 5b52 4f4f 4d5f 4e41 4d45 202e 2e2e  E [ROOM_NAME ...
-00052e90: 5d0a 5370 6563 6966 7920 6f6e 6520 6f72  ].Specify one or
-00052ea0: 206d 756c 7469 706c 6520 726f 6f6d 206e   multiple room n
-00052eb0: 616d 6573 2e0a 3c2d 2d74 6f70 6963 3e20  ames..<--topic> 
-00052ec0: 524f 4f4d 5f54 4f50 4943 205b 524f 4f4d  ROOM_TOPIC [ROOM
-00052ed0: 5f54 4f50 4943 202e 2e2e 5d0a 5370 6563  _TOPIC ...].Spec
-00052ee0: 6966 7920 6f6e 6520 6f72 206d 756c 7469  ify one or multi
-00052ef0: 706c 6520 726f 6f6d 2074 6f70 6963 732e  ple room topics.
-00052f00: 0a3c 2d2d 616c 6961 733e 2052 4f4f 4d5f  .<--alias> ROOM_
-00052f10: 414c 4941 5320 5b52 4f4f 4d5f 414c 4941  ALIAS [ROOM_ALIA
-00052f20: 5320 2e2e 2e5d 0a53 7065 6369 6679 206f  S ...].Specify o
-00052f30: 6e65 206f 7220 6d75 6c74 6970 6c65 2072  ne or multiple r
-00052f40: 6f6f 6d20 616c 6961 7365 732e 0a3c 2d6d  oom aliases..<-m
-00052f50: 3e20 5445 5854 205b 5445 5854 202e 2e2e  > TEXT [TEXT ...
-00052f60: 5d2c 203c 2d2d 6d65 7373 6167 653e 2054  ], <--message> T
-00052f70: 4558 5420 5b54 4558 5420 2e2e 2e5d 0a53  EXT [TEXT ...].S
-00052f80: 656e 6420 6f6e 6520 6f72 206d 756c 7469  end one or multi
-00052f90: 706c 6520 7465 7874 206d 6573 7361 6765  ple text message
-00052fa0: 732e 0a3c 2d69 3e20 494d 4147 455f 4649  s..<-i> IMAGE_FI
-00052fb0: 4c45 205b 494d 4147 455f 4649 4c45 202e  LE [IMAGE_FILE .
-00052fc0: 2e2e 5d2c 203c 2d2d 696d 6167 653e 2049  ..], <--image> I
-00052fd0: 4d41 4745 5f46 494c 4520 5b49 4d41 4745  MAGE_FILE [IMAGE
-00052fe0: 5f46 494c 4520 2e2e 2e5d 0a53 656e 6420  _FILE ...].Send 
-00052ff0: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
-00053000: 696d 6167 6520 6669 6c65 732e 0a3c 2d61  image files..<-a
-00053010: 3e20 4155 4449 4f5f 4649 4c45 205b 4155  > AUDIO_FILE [AU
-00053020: 4449 4f5f 4649 4c45 202e 2e2e 5d2c 203c  DIO_FILE ...], <
-00053030: 2d2d 6175 6469 6f3e 2041 5544 494f 5f46  --audio> AUDIO_F
-00053040: 494c 4520 5b41 5544 494f 5f46 494c 4520  ILE [AUDIO_FILE 
-00053050: 2e2e 2e5d 0a53 656e 6420 6f6e 6520 6f72  ...].Send one or
-00053060: 206d 756c 7469 706c 6520 6175 6469 6f20   multiple audio 
-00053070: 6669 6c65 732e 0a3c 2d66 3e20 4649 4c45  files..<-f> FILE
-00053080: 205b 4649 4c45 202e 2e2e 5d2c 203c 2d2d   [FILE ...], <--
-00053090: 6669 6c65 3e20 4649 4c45 205b 4649 4c45  file> FILE [FILE
-000530a0: 202e 2e2e 5d0a 5365 6e64 206f 6e65 206f   ...].Send one o
-000530b0: 7220 6d75 6c74 6970 6c65 2066 696c 6573  r multiple files
-000530c0: 2028 652e 672e 2050 4446 2c20 444f 432c   (e.g. PDF, DOC,
-000530d0: 204d 5034 292e 0a3c 2d65 3e20 4d41 5452   MP4)..<-e> MATR
-000530e0: 4958 5f4a 534f 4e5f 4f42 4a45 4354 205b  IX_JSON_OBJECT [
-000530f0: 4d41 5452 4958 5f4a 534f 4e5f 4f42 4a45  MATRIX_JSON_OBJE
-00053100: 4354 202e 2e2e 5d2c 203c 2d2d 6576 656e  CT ...], <--even
-00053110: 743e 204d 4154 5249 585f 4a53 4f4e 5f4f  t> MATRIX_JSON_O
-00053120: 424a 4543 5420 5b4d 4154 5249 585f 4a53  BJECT [MATRIX_JS
-00053130: 4f4e 5f4f 424a 4543 5420 2e2e 2e5d 0a53  ON_OBJECT ...].S
-00053140: 656e 6420 6120 4d61 7472 6978 204a 534f  end a Matrix JSO
-00053150: 4e20 6576 656e 742e 0a3c 2d77 3e2c 203c  N event..<-w>, <
-00053160: 2d2d 6874 6d6c 3e0a 5365 6e64 206d 6573  --html>.Send mes
-00053170: 7361 6765 2061 7320 666f 726d 6174 2022  sage as format "
-00053180: 4854 4d4c 222e 0a3c 2d7a 3e2c 203c 2d2d  HTML"..<-z>, <--
-00053190: 6d61 726b 646f 776e 3e0a 5365 6e64 206d  markdown>.Send m
-000531a0: 6573 7361 6765 2061 7320 666f 726d 6174  essage as format
-000531b0: 2022 4d41 524b 444f 574e 222e 0a3c 2d6b   "MARKDOWN"..<-k
-000531c0: 3e2c 203c 2d2d 636f 6465 3e0a 5365 6e64  >, <--code>.Send
-000531d0: 206d 6573 7361 6765 2061 7320 666f 726d   message as form
-000531e0: 6174 2022 434f 4445 222e 0a3c 2d6a 3e2c  at "CODE"..<-j>,
-000531f0: 203c 2d2d 656d 6f6a 697a 653e 0a53 656e   <--emojize>.Sen
-00053200: 6420 6d65 7373 6167 6520 6166 7465 7220  d message after 
-00053210: 656d 6f6a 697a 696e 672e 0a3c 2d70 3e20  emojizing..<-p> 
-00053220: 5345 5041 5241 544f 522c 203c 2d2d 7370  SEPARATOR, <--sp
-00053230: 6c69 743e 2053 4550 4152 4154 4f52 0a53  lit> SEPARATOR.S
-00053240: 706c 6974 206d 6573 7361 6765 2074 6578  plit message tex
-00053250: 7420 696e 746f 206d 756c 7469 706c 6520  t into multiple 
-00053260: 4d61 7472 6978 206d 6573 7361 6765 732e  Matrix messages.
-00053270: 0a3c 2d2d 636f 6e66 6967 3e20 434f 4e46  .<--config> CONF
-00053280: 4947 5f46 494c 450a 5370 6563 6966 7920  IG_FILE.Specify 
-00053290: 7468 6520 6c6f 6361 7469 6f6e 206f 6620  the location of 
-000532a0: 6120 636f 6e66 6967 2066 696c 652e 0a3c  a config file..<
-000532b0: 2d2d 7072 6f78 793e 2050 524f 5859 0a53  --proxy> PROXY.S
-000532c0: 7065 6369 6679 2061 2070 726f 7879 2066  pecify a proxy f
-000532d0: 6f72 2063 6f6e 6e65 6374 6976 6974 792e  or connectivity.
-000532e0: 0a3c 2d6e 3e2c 203c 2d2d 6e6f 7469 6365  .<-n>, <--notice
-000532f0: 3e0a 5365 6e64 206d 6573 7361 6765 2061  >.Send message a
-00053300: 7320 6e6f 7469 6365 2e0a 3c2d 2d65 6e63  s notice..<--enc
-00053310: 7279 7074 6564 3e0a 5365 6e64 206d 6573  rypted>.Send mes
-00053320: 7361 6765 2065 6e64 2d74 6f2d 656e 6420  sage end-to-end 
-00053330: 656e 6372 7970 7465 642e 0a3c 2d6c 3e20  encrypted..<-l> 
-00053340: 5b4e 4556 4552 7c4f 4e43 457c 464f 5245  [NEVER|ONCE|FORE
-00053350: 5645 527c 5441 494c 7c41 4c4c 5d2c 203c  VER|TAIL|ALL], <
-00053360: 2d2d 6c69 7374 656e 3e20 5b4e 4556 4552  --listen> [NEVER
-00053370: 7c4f 4e43 457c 464f 5245 5645 527c 5441  |ONCE|FOREVER|TA
-00053380: 494c 7c41 4c4c 5d0a 5072 696e 7420 7265  IL|ALL].Print re
-00053390: 6365 6976 6564 206d 6573 7361 6765 7320  ceived messages 
-000533a0: 616e 6420 6c69 7374 656e 2074 6f20 6d65  and listen to me
-000533b0: 7373 6167 6573 2e0a 3c2d 743e 205b 4e55  ssages..<-t> [NU
-000533c0: 4d42 4552 5d2c 203c 2d2d 7461 696c 3e20  MBER], <--tail> 
-000533d0: 5b4e 554d 4245 525d 0a50 7269 6e74 206c  [NUMBER].Print l
-000533e0: 6173 7420 6d65 7373 6167 6573 2e0a 3c2d  ast messages..<-
-000533f0: 793e 2c20 3c2d 2d6c 6973 7465 6e2d 7365  y>, <--listen-se
-00053400: 6c66 3e0a 5072 696e 7420 796f 7572 206f  lf>.Print your o
-00053410: 776e 206d 6573 7361 6765 7320 6173 2077  wn messages as w
-00053420: 656c 6c2e 0a3c 2d2d 7072 696e 742d 6576  ell..<--print-ev
-00053430: 656e 742d 6964 3e0a 5072 696e 7420 6576  ent-id>.Print ev
-00053440: 656e 7420 6964 7320 6f66 2072 6563 6569  ent ids of recei
-00053450: 7665 6420 6d65 7373 6167 6573 2e0a 3c2d  ved messages..<-
-00053460: 2d64 6f77 6e6c 6f61 642d 6d65 6469 613e  -download-media>
-00053470: 205b 444f 574e 4c4f 4144 5f44 4952 4543   [DOWNLOAD_DIREC
-00053480: 544f 5259 5d0a 446f 776e 6c6f 6164 206d  TORY].Download m
-00053490: 6564 6961 2066 696c 6573 2077 6869 6c65  edia files while
-000534a0: 206c 6973 7465 6e69 6e67 2e0a 3c2d 2d6f   listening..<--o
-000534b0: 732d 6e6f 7469 6679 3e0a 4e6f 7469 6679  s-notify>.Notify
-000534c0: 206d 6520 6f66 2061 7272 6976 696e 6720   me of arriving 
-000534d0: 6d65 7373 6167 6573 2e0a 3c2d 2d73 6574  messages..<--set
-000534e0: 2d64 6576 6963 652d 6e61 6d65 3e20 4445  -device-name> DE
-000534f0: 5649 4345 5f4e 414d 450a 5365 7420 6f72  VICE_NAME.Set or
-00053500: 2072 656e 616d 6520 7468 6520 6375 7272   rename the curr
-00053510: 656e 7420 6465 7669 6365 2e0a 3c2d 2d73  ent device..<--s
-00053520: 6574 2d64 6973 706c 6179 2d6e 616d 653e  et-display-name>
-00053530: 2044 4953 504c 4159 5f4e 414d 450a 5365   DISPLAY_NAME.Se
-00053540: 7420 6f72 2072 656e 616d 6520 7468 6520  t or rename the 
-00053550: 6469 7370 6c61 7920 6e61 6d65 2e0a 3c2d  display name..<-
-00053560: 2d67 6574 2d64 6973 706c 6179 2d6e 616d  -get-display-nam
-00053570: 653e 0a47 6574 2074 6865 2064 6973 706c  e>.Get the displ
-00053580: 6179 206e 616d 6520 6f66 2079 6f75 7273  ay name of yours
-00053590: 656c 662e 0a3c 2d2d 7365 742d 7072 6573  elf..<--set-pres
-000535a0: 656e 6365 3e20 4f4e 4c49 4e45 7c4f 4646  ence> ONLINE|OFF
-000535b0: 4c49 4e45 7c55 4e41 5641 494c 4142 4c45  LINE|UNAVAILABLE
-000535c0: 0a53 6574 2079 6f75 7220 7072 6573 656e  .Set your presen
-000535d0: 6365 2e0a 3c2d 2d67 6574 2d70 7265 7365  ce..<--get-prese
-000535e0: 6e63 653e 0a47 6574 2079 6f75 7220 7072  nce>.Get your pr
-000535f0: 6573 656e 6365 2e0a 3c2d 2d75 706c 6f61  esence..<--uploa
-00053600: 643e 2046 494c 4520 5b46 494c 4520 2e2e  d> FILE [FILE ..
-00053610: 2e5d 0a55 706c 6f61 6420 6f6e 6520 6f72  .].Upload one or
-00053620: 206d 756c 7469 706c 6520 6669 6c65 7320   multiple files 
-00053630: 746f 2074 6865 2063 6f6e 7465 6e74 2072  to the content r
-00053640: 6570 6f73 6974 6f72 792e 0a3c 2d2d 646f  epository..<--do
-00053650: 776e 6c6f 6164 3e20 4d58 435f 5552 4920  wnload> MXC_URI 
-00053660: 5b4d 5843 5f55 5249 202e 2e2e 5d0a 446f  [MXC_URI ...].Do
-00053670: 776e 6c6f 6164 206f 6e65 206f 7220 6d75  wnload one or mu
-00053680: 6c74 6970 6c65 2066 696c 6573 2066 726f  ltiple files fro
-00053690: 6d20 7468 6520 636f 6e74 656e 7420 7265  m the content re
-000536a0: 706f 7369 746f 7279 2e0a 3c2d 2d64 656c  pository..<--del
-000536b0: 6574 652d 6d78 633e 204d 5843 5f55 5249  ete-mxc> MXC_URI
-000536c0: 205b 4d58 435f 5552 4920 2e2e 2e5d 0a44   [MXC_URI ...].D
-000536d0: 656c 6574 6520 6f6e 6520 6f72 206d 756c  elete one or mul
-000536e0: 7469 706c 6520 6f62 6a65 6374 7320 6672  tiple objects fr
-000536f0: 6f6d 2074 6865 2063 6f6e 7465 6e74 2072  om the content r
-00053700: 6570 6f73 6974 6f72 792e 0a3c 2d2d 6465  epository..<--de
-00053710: 6c65 7465 2d6d 7863 2d62 6566 6f72 653e  lete-mxc-before>
-00053720: 2054 494d 4553 5441 4d50 205b 5449 4d45   TIMESTAMP [TIME
-00053730: 5354 414d 5020 2e2e 2e5d 0a44 656c 6574  STAMP ...].Delet
-00053740: 6520 6f6c 6420 6f62 6a65 6374 7320 6672  e old objects fr
-00053750: 6f6d 2074 6865 2063 6f6e 7465 6e74 2072  om the content r
-00053760: 6570 6f73 6974 6f72 790a 3c2d 2d6a 6f69  epository.<--joi
-00053770: 6e65 642d 726f 6f6d 733e 0a50 7269 6e74  ned-rooms>.Print
-00053780: 2074 6865 206c 6973 7420 6f66 206a 6f69   the list of joi
-00053790: 6e65 6420 726f 6f6d 732e 0a3c 2d2d 6a6f  ned rooms..<--jo
-000537a0: 696e 6564 2d6d 656d 6265 7273 3e20 524f  ined-members> RO
-000537b0: 4f4d 205b 524f 4f4d 202e 2e2e 5d0a 5072  OM [ROOM ...].Pr
-000537c0: 696e 7420 7468 6520 6c69 7374 206f 6620  int the list of 
-000537d0: 6a6f 696e 6564 206d 656d 6265 7273 2066  joined members f
-000537e0: 6f72 206f 6e65 206f 7220 6d75 6c74 6970  or one or multip
-000537f0: 6c65 2072 6f6f 6d73 2e0a 3c2d 2d6d 7863  le rooms..<--mxc
-00053800: 2d74 6f2d 6874 7470 3e20 4d58 435f 5552  -to-http> MXC_UR
-00053810: 4920 5b4d 5843 5f55 5249 202e 2e2e 5d0a  I [MXC_URI ...].
-00053820: 436f 6e76 6572 7420 4d58 4320 5552 4973  Convert MXC URIs
-00053830: 2074 6f20 4854 5450 2055 524c 732e 0a3c   to HTTP URLs..<
-00053840: 2d2d 6465 7669 6365 732c 3e20 3c2d 2d67  --devices,> <--g
-00053850: 6574 2d64 6576 6963 6573 3e0a 5072 696e  et-devices>.Prin
-00053860: 7420 7468 6520 6c69 7374 206f 6620 6465  t the list of de
-00053870: 7669 6365 732e 0a3c 2d2d 6469 7363 6f76  vices..<--discov
-00053880: 6572 792d 696e 666f 3e0a 5072 696e 7420  ery-info>.Print 
-00053890: 6469 7363 6f76 6572 7920 696e 666f 726d  discovery inform
-000538a0: 6174 696f 6e20 6162 6f75 7420 6375 7272  ation about curr
-000538b0: 656e 7420 686f 6d65 7365 7276 6572 2e0a  ent homeserver..
-000538c0: 3c2d 2d6c 6f67 696e 2d69 6e66 6f3e 0a50  <--login-info>.P
-000538d0: 7269 6e74 206c 6f67 696e 206d 6574 686f  rint login metho
-000538e0: 6473 2073 7570 706f 7274 6564 2062 7920  ds supported by 
-000538f0: 7468 6520 686f 6d65 7365 7276 6572 2e0a  the homeserver..
-00053900: 3c2d 2d63 6f6e 7465 6e74 2d72 6570 6f73  <--content-repos
-00053910: 6974 6f72 792d 636f 6e66 6967 3e0a 5072  itory-config>.Pr
-00053920: 696e 7420 7468 6520 636f 6e74 656e 7420  int the content 
-00053930: 7265 706f 7369 746f 7279 2063 6f6e 6669  repository confi
-00053940: 6775 7261 7469 6f6e 2e0a 3c2d 2d72 6573  guration..<--res
-00053950: 743e 2052 4553 545f 4d45 5448 4f44 2044  t> REST_METHOD D
-00053960: 4154 4120 5552 4c20 5b52 4553 545f 4d45  ATA URL [REST_ME
-00053970: 5448 4f44 2044 4154 4120 5552 4c20 2e2e  THOD DATA URL ..
-00053980: 2e5d 0a55 7365 2074 6865 204d 6174 7269  .].Use the Matri
-00053990: 7820 436c 6965 6e74 2052 4553 5420 4150  x Client REST AP
-000539a0: 492e 0a3c 2d2d 7365 742d 6176 6174 6172  I..<--set-avatar
-000539b0: 3e20 4156 4154 4152 5f4d 5843 5f55 5249  > AVATAR_MXC_URI
-000539c0: 0a53 6574 2079 6f75 7220 6176 6174 6172  .Set your avatar
-000539d0: 2e0a 3c2d 2d67 6574 2d61 7661 7461 723e  ..<--get-avatar>
-000539e0: 205b 5553 4552 202e 2e2e 5d0a 4765 7420   [USER ...].Get 
-000539f0: 616e 2061 7661 7461 722e 0a3c 2d2d 6765  an avatar..<--ge
-00053a00: 742d 7072 6f66 696c 653e 205b 5553 4552  t-profile> [USER
-00053a10: 202e 2e2e 5d0a 4765 7420 6120 7573 6572   ...].Get a user
-00053a20: 2070 726f 6669 6c65 2e0a 3c2d 2d67 6574   profile..<--get
-00053a30: 2d72 6f6f 6d2d 696e 666f 3e20 5b52 4f4f  -room-info> [ROO
-00053a40: 4d20 2e2e 2e5d 0a47 6574 2074 6865 2072  M ...].Get the r
-00053a50: 6f6f 6d20 696e 666f 726d 6174 696f 6e2e  oom information.
-00053a60: 0a3c 2d2d 6765 742d 636c 6965 6e74 2d69  .<--get-client-i
-00053a70: 6e66 6f3e 0a50 7269 6e74 2063 6c69 656e  nfo>.Print clien
-00053a80: 7420 696e 666f 726d 6174 696f 6e2e 0a3c  t information..<
-00053a90: 2d2d 6861 732d 7065 726d 6973 7369 6f6e  --has-permission
-00053aa0: 3e20 524f 4f4d 2042 414e 7c49 4e56 4954  > ROOM BAN|INVIT
-00053ab0: 457c 4b49 434b 7c4e 4f54 4946 4943 4154  E|KICK|NOTIFICAT
-00053ac0: 494f 4e53 7c52 4544 4143 547c 6574 6320  IONS|REDACT|etc 
-00053ad0: 5b52 4f4f 4d20 4241 4e7c 494e 5649 5445  [ROOM BAN|INVITE
-00053ae0: 7c4b 4943 4b7c 4e4f 5449 4649 4341 5449  |KICK|NOTIFICATI
-00053af0: 4f4e 537c 5245 4441 4354 7c65 7463 202e  ONS|REDACT|etc .
-00053b00: 2e2e 5d0a 496e 7175 6972 6520 6162 6f75  ..].Inquire abou
-00053b10: 7420 7065 726d 6973 7369 6f6e 732e 0a3c  t permissions..<
-00053b20: 2d2d 696d 706f 7274 2d6b 6579 733e 2046  --import-keys> F
-00053b30: 494c 4520 5041 5353 5048 5241 5345 2046  ILE PASSPHRASE F
-00053b40: 494c 4520 5041 5353 5048 5241 5345 0a49  ILE PASSPHRASE.I
-00053b50: 6d70 6f72 7420 4d65 676f 6c6d 2064 6563  mport Megolm dec
-00053b60: 7279 7074 696f 6e20 6b65 7973 2066 726f  ryption keys fro
-00053b70: 6d20 6120 6669 6c65 2e0a 3c2d 2d65 7870  m a file..<--exp
-00053b80: 6f72 742d 6b65 7973 3e20 4649 4c45 2050  ort-keys> FILE P
-00053b90: 4153 5350 4852 4153 4520 4649 4c45 2050  ASSPHRASE FILE P
-00053ba0: 4153 5350 4852 4153 450a 4578 706f 7274  ASSPHRASE.Export
-00053bb0: 2061 6c6c 2074 6865 204d 6567 6f6c 6d20   all the Megolm 
-00053bc0: 6465 6372 7970 7469 6f6e 206b 6579 7320  decryption keys 
-00053bd0: 6f66 2074 6869 7320 6465 7669 6365 2e0a  of this device..
-00053be0: 3c2d 2d72 6f6f 6d2d 7365 742d 616c 6961  <--room-set-alia
-00053bf0: 733e 2052 4f4f 4d5f 414c 4941 5320 524f  s> ROOM_ALIAS RO
-00053c00: 4f4d 205b 524f 4f4d 5f41 4c49 4153 2052  OM [ROOM_ALIAS R
-00053c10: 4f4f 4d20 2e2e 2e5d 2c20 3c2d 2d72 6f6f  OOM ...], <--roo
-00053c20: 6d2d 7075 742d 616c 6961 733e 2052 4f4f  m-put-alias> ROO
-00053c30: 4d5f 414c 4941 5320 524f 4f4d 205b 524f  M_ALIAS ROOM [RO
-00053c40: 4f4d 5f41 4c49 4153 2052 4f4f 4d20 2e2e  OM_ALIAS ROOM ..
-00053c50: 2e5d 0a41 6464 2061 6c69 6173 6573 2074  .].Add aliases t
-00053c60: 6f20 726f 6f6d 732e 0a3c 2d2d 726f 6f6d  o rooms..<--room
-00053c70: 2d72 6573 6f6c 7665 2d61 6c69 6173 3e20  -resolve-alias> 
-00053c80: 524f 4f4d 5f41 4c49 4153 205b 524f 4f4d  ROOM_ALIAS [ROOM
-00053c90: 5f41 4c49 4153 202e 2e2e 5d0a 5368 6f77  _ALIAS ...].Show
-00053ca0: 2072 6f6f 6d20 6964 7320 636f 7272 6573   room ids corres
-00053cb0: 706f 6e64 696e 6720 746f 2072 6f6f 6d20  ponding to room 
-00053cc0: 616c 6961 7365 732e 0a3c 2d2d 726f 6f6d  aliases..<--room
-00053cd0: 2d64 656c 6574 652d 616c 6961 733e 2052  -delete-alias> R
-00053ce0: 4f4f 4d5f 414c 4941 5320 5b52 4f4f 4d5f  OOM_ALIAS [ROOM_
-00053cf0: 414c 4941 5320 2e2e 2e5d 0a44 656c 6574  ALIAS ...].Delet
-00053d00: 6520 6f6e 6520 6f72 206d 756c 7469 706c  e one or multipl
-00053d10: 6520 726f 6f6d 7320 616c 6961 7365 732e  e rooms aliases.
-00053d20: 0a3c 2d2d 6765 742d 6f70 656e 6964 2d74  .<--get-openid-t
-00053d30: 6f6b 656e 3e20 5b55 5345 5220 2e2e 2e5d  oken> [USER ...]
-00053d40: 0a47 6574 2061 6e20 4f70 656e 4944 2074  .Get an OpenID t
-00053d50: 6f6b 656e 2e0a 3c2d 2d72 6f6f 6d2d 6765  oken..<--room-ge
-00053d60: 742d 7669 7369 6269 6c69 7479 3e20 5b52  t-visibility> [R
-00053d70: 4f4f 4d20 2e2e 2e5d 0a47 6574 2074 6865  OOM ...].Get the
-00053d80: 2076 6973 6962 696c 6974 7920 6f66 206f   visibility of o
-00053d90: 6e65 206f 7220 6d6f 7265 2072 6f6f 6d73  ne or more rooms
-00053da0: 2e0a 3c2d 2d72 6f6f 6d2d 6765 742d 7374  ..<--room-get-st
-00053db0: 6174 653e 205b 524f 4f4d 202e 2e2e 5d0a  ate> [ROOM ...].
-00053dc0: 4765 7420 7468 6520 7374 6174 6520 6f66  Get the state of
-00053dd0: 206f 6e65 206f 7220 6d6f 7265 2072 6f6f   one or more roo
-00053de0: 6d73 2e0a 3c2d 2d64 656c 6574 652d 6465  ms..<--delete-de
-00053df0: 7669 6365 3e20 4445 5649 4345 205b 4445  vice> DEVICE [DE
-00053e00: 5649 4345 202e 2e2e 5d0a 4465 6c65 7465  VICE ...].Delete
-00053e10: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
-00053e20: 2064 6576 6963 6573 2e0a 3c2d 2d72 6f6f   devices..<--roo
-00053e30: 6d2d 7265 6461 6374 3e20 524f 4f4d 5f49  m-redact> ROOM_I
-00053e40: 4420 4556 454e 545f 4944 2052 4541 534f  D EVENT_ID REASO
-00053e50: 4e20 5b52 4f4f 4d5f 4944 2045 5645 4e54  N [ROOM_ID EVENT
-00053e60: 5f49 4420 5245 4153 4f4e 202e 2e2e 5d2c  _ID REASON ...],
-00053e70: 203c 2d2d 726f 6f6d 2d64 656c 6574 652d   <--room-delete-
-00053e80: 636f 6e74 656e 743e 2052 4f4f 4d5f 4944  content> ROOM_ID
-00053e90: 2045 5645 4e54 5f49 4420 5245 4153 4f4e   EVENT_ID REASON
-00053ea0: 205b 524f 4f4d 5f49 4420 4556 454e 545f   [ROOM_ID EVENT_
-00053eb0: 4944 2052 4541 534f 4e20 2e2e 2e5d 0a53  ID REASON ...].S
-00053ec0: 7472 6970 2069 6e66 6f72 6d61 7469 6f6e  trip information
-00053ed0: 206f 7574 206f 6620 6f6e 6520 6f72 2073   out of one or s
-00053ee0: 6576 6572 616c 2065 7665 6e74 732e 0a3c  everal events..<
-00053ef0: 2d2d 7768 6f61 6d69 3e0a 5072 696e 7420  --whoami>.Print 
-00053f00: 796f 7572 2075 7365 7220 6964 2e0a 3c2d  your user id..<-
-00053f10: 2d6e 6f2d 7373 6c3e 0a53 6b69 7020 5353  -no-ssl>.Skip SS
-00053f20: 4c20 7665 7269 6669 6361 7469 6f6e 2e0a  L verification..
-00053f30: 3c2d 2d73 736c 2d63 6572 7469 6669 6361  <--ssl-certifica
-00053f40: 7465 3e20 5353 4c5f 4345 5254 4946 4943  te> SSL_CERTIFIC
-00053f50: 4154 455f 4649 4c45 0a55 7365 2079 6f75  ATE_FILE.Use you
-00053f60: 7220 6f77 6e20 5353 4c20 6365 7274 6966  r own SSL certif
-00053f70: 6963 6174 652e 0a3c 2d2d 6669 6c65 2d6e  icate..<--file-n
-00053f80: 616d 653e 2046 494c 4520 5b46 494c 4520  ame> FILE [FILE 
-00053f90: 2e2e 2e5d 0a53 7065 6369 6679 206f 6e65  ...].Specify one
-00053fa0: 206f 7220 6d75 6c74 6970 6c65 2066 696c   or multiple fil
-00053fb0: 6520 6e61 6d65 7320 666f 7220 736f 6d65  e names for some
-00053fc0: 2061 6374 696f 6e73 2e0a 3c2d 2d6b 6579   actions..<--key
-00053fd0: 2d64 6963 743e 204b 4559 5f44 4943 5449  -dict> KEY_DICTI
-00053fe0: 4f4e 4152 5920 5b4b 4559 5f44 4943 5449  ONARY [KEY_DICTI
-00053ff0: 4f4e 4152 5920 2e2e 2e5d 0a53 7065 6369  ONARY ...].Speci
-00054000: 6679 206f 6e65 206f 7220 6d75 6c74 6970  fy one or multip
-00054010: 6c65 206b 6579 2064 6963 7469 6f6e 6172  le key dictionar
-00054020: 6965 7320 666f 7220 6465 6372 7970 7469  ies for decrypti
-00054030: 6f6e 2e0a 3c2d 2d70 6c61 696e 3e0a 4469  on..<--plain>.Di
-00054040: 7361 626c 6520 656e 6372 7970 7469 6f6e  sable encryption
-00054050: 2066 6f72 2061 2073 7065 6369 6669 6320   for a specific 
-00054060: 6163 7469 6f6e 2e0a 3c2d 2d73 6570 6172  action..<--separ
-00054070: 6174 6f72 3e20 5345 5041 5241 544f 520a  ator> SEPARATOR.
-00054080: 5365 7420 6120 6375 7374 6f6d 2073 6570  Set a custom sep
-00054090: 6172 6174 6f72 2075 7365 6420 666f 7220  arator used for 
-000540a0: 6365 7274 6169 6e20 7072 696e 7420 6f75  certain print ou
-000540b0: 7473 2e0a 3c2d 2d61 6363 6573 732d 746f  ts..<--access-to
-000540c0: 6b65 6e3e 2041 4343 4553 535f 544f 4b45  ken> ACCESS_TOKE
-000540d0: 4e0a 5365 7420 6120 6375 7374 6f6d 2061  N.Set a custom a
-000540e0: 6363 6573 7320 746f 6b65 6e20 666f 7220  ccess token for 
-000540f0: 7573 6520 6279 2063 6572 7461 696e 2061  use by certain a
-00054100: 6374 696f 6e73 2e0a 3c2d 2d70 6173 7377  ctions..<--passw
-00054110: 6f72 643e 2050 4153 5357 4f52 440a 5370  ord> PASSWORD.Sp
-00054120: 6563 6966 7920 6120 7061 7373 776f 7264  ecify a password
-00054130: 2066 6f72 2075 7365 2062 7920 6365 7274   for use by cert
-00054140: 6169 6e20 6163 7469 6f6e 732e 0a3c 2d2d  ain actions..<--
-00054150: 686f 6d65 7365 7276 6572 3e20 484f 4d45  homeserver> HOME
-00054160: 5345 5256 4552 5f55 524c 0a53 7065 6369  SERVER_URL.Speci
-00054170: 6679 2061 2068 6f6d 6573 6572 7665 7220  fy a homeserver 
-00054180: 666f 7220 7573 6520 6279 2063 6572 7461  for use by certa
-00054190: 696e 2061 6374 696f 6e73 2e0a 3c2d 2d64  in actions..<--d
-000541a0: 6576 6963 653e 2044 4556 4943 455f 4e41  evice> DEVICE_NA
-000541b0: 4d45 0a53 7065 6369 6679 2061 2064 6576  ME.Specify a dev
-000541c0: 6963 6520 6e61 6d65 2c20 666f 7220 7573  ice name, for us
-000541d0: 6520 6279 2063 6572 7461 696e 2061 6374  e by certain act
-000541e0: 696f 6e73 2e0a 3c2d 2d73 796e 633e 2046  ions..<--sync> F
-000541f0: 554c 4c7c 4f46 460a 4368 6f6f 7365 2073  ULL|OFF.Choose s
-00054200: 796e 6368 726f 6e69 7a61 7469 6f6e 206f  ynchronization o
-00054210: 7074 696f 6e73 2e0a 3c2d 6f3e 2054 4558  ptions..<-o> TEX
-00054220: 547c 4a53 4f4e 7c4a 534f 4e2d 4d41 587c  T|JSON|JSON-MAX|
-00054230: 4a53 4f4e 2d53 5045 432c 203c 2d2d 6f75  JSON-SPEC, <--ou
-00054240: 7470 7574 3e20 5445 5854 7c4a 534f 4e7c  tput> TEXT|JSON|
-00054250: 4a53 4f4e 2d4d 4158 7c4a 534f 4e2d 5350  JSON-MAX|JSON-SP
-00054260: 4543 0a53 656c 6563 7420 616e 206f 7574  EC.Select an out
-00054270: 7075 7420 666f 726d 6174 2e0a 3c2d 2d72  put format..<--r
-00054280: 6f6f 6d2d 696e 7669 7465 733e 205b 4c49  oom-invites> [LI
-00054290: 5354 7c4a 4f49 4e7c 4c49 5354 2b4a 4f49  ST|JOIN|LIST+JOI
-000542a0: 4e5d 0a4c 6973 7420 726f 6f6d 2069 6e76  N].List room inv
-000542b0: 6974 6174 696f 6e73 2061 6e64 2f6f 7220  itations and/or 
-000542c0: 6a6f 696e 2069 6e76 6974 6564 2072 6f6f  join invited roo
-000542d0: 6d73 2e0a 3c2d 763e 205b 5052 494e 547c  ms..<-v> [PRINT|
-000542e0: 4348 4543 4b5d 2c20 2d56 205b 5052 494e  CHECK], -V [PRIN
-000542f0: 547c 4348 4543 4b5d 2c20 3c2d 2d76 6572  T|CHECK], <--ver
-00054300: 7369 6f6e 3e20 5b50 5249 4e54 7c43 4845  sion> [PRINT|CHE
-00054310: 434b 5d0a 5072 696e 7420 7665 7273 696f  CK].Print versio
-00054320: 6e20 696e 666f 726d 6174 696f 6e20 6f72  n information or
-00054330: 2063 6865 636b 2066 6f72 2075 7064 6174   check for updat
-00054340: 6573 2e0a 2222 222e 7265 706c 6163 6528  es..""".replace(
-00054350: 0a20 2020 2020 2020 2020 2020 2022 3c22  .            "<"
-00054360: 2c20 656f 6e0a 2020 2020 2020 2020 292e  , eon.        ).
-00054370: 7265 706c 6163 6528 0a20 2020 2020 2020  replace(.       
-00054380: 2020 2020 2022 3e22 2c20 656f 6666 0a20       ">", eoff. 
-00054390: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000543a0: 2068 6561 6465 7220 3d20 4661 6c73 6520   header = False 
-000543b0: 2023 2066 6972 7374 206c 696e 6520 6973   # first line is
-000543c0: 206e 6577 6c69 6e65 0a20 2020 2020 2020   newline.       
-000543d0: 2066 6f72 206c 696e 6520 696e 2068 656c   for line in hel
-000543e0: 705f 6865 6c70 5f70 7265 2e73 706c 6974  p_help_pre.split
-000543f0: 2822 5c6e 2229 3a0a 2020 2020 2020 2020  ("\n"):.        
-00054400: 2020 2020 6966 2068 6561 6465 723a 0a20      if header:. 
-00054410: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00054420: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
-00054430: 2020 2020 2020 2020 2020 7465 7874 7772            textwr
-00054440: 6170 2e66 696c 6c28 636f 6e20 2b20 6c69  ap.fill(con + li
-00054450: 6e65 202b 2063 6f66 662c 2077 6964 7468  ne + coff, width
-00054460: 3d74 6572 6d5f 7769 6474 6829 2c0a 2020  =term_width),.  
-00054470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054480: 2020 666c 7573 683d 5472 7565 2c0a 2020    flush=True,.  
-00054490: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000544a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000544b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000544c0: 2020 7072 696e 7428 0a20 2020 2020 2020    print(.       
-000544d0: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-000544e0: 7477 7261 702e 696e 6465 6e74 280a 2020  twrap.indent(.  
-000544f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054500: 2020 2020 2020 7465 7874 7772 6170 2e66        textwrap.f
-00054510: 696c 6c28 6c69 6e65 2c20 7769 6474 683d  ill(line, width=
-00054520: 7465 726d 5f77 6964 7468 202d 2032 292c  term_width - 2),
-00054530: 2022 2020 220a 2020 2020 2020 2020 2020   "  ".          
-00054540: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00054550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054560: 2066 6c75 7368 3d54 7275 652c 0a20 2020   flush=True,.   
-00054570: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00054580: 2020 2020 2020 2020 2020 2020 6865 6164              head
-00054590: 6572 203d 206e 6f74 2068 6561 6465 720a  er = not header.
-000545a0: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-000545b0: 2222 290a 2020 2020 2020 2020 7072 696e  "").        prin
-000545c0: 7428 7465 7874 7772 6170 2e66 696c 6c28  t(textwrap.fill(
-000545d0: 6170 2e65 7069 6c6f 672c 2077 6964 7468  ap.epilog, width
-000545e0: 3d74 6572 6d5f 7769 6474 6829 290a 2020  =term_width)).  
-000545f0: 2020 2020 2020 7265 7475 726e 2030 0a20        return 0. 
-00054600: 2020 2069 6620 6773 2e70 612e 6d61 6e75     if gs.pa.manu
-00054610: 616c 3a0a 2020 2020 2020 2020 6465 7363  al:.        desc
-00054620: 7269 7074 696f 6e20 3d20 280a 2020 2020  ription = (.    
-00054630: 2020 2020 2020 2020 6622 5765 6c63 6f6d          f"Welcom
-00054640: 6520 746f 207b 5052 4f47 5f57 4954 484f  e to {PROG_WITHO
-00054650: 5554 5f45 5854 7d2c 2061 204d 6174 7269  UT_EXT}, a Matri
-00054660: 7820 434c 4920 636c 6965 6e74 2e20 e294  x CLI client. ..
-00054670: 80e2 9480 e294 8020 220a 2020 2020 2020  ....... ".      
-00054680: 2020 2020 2020 224f 6e20 6669 7273 7420        "On first 
-00054690: 7275 6e20 7573 6520 2d2d 6c6f 6769 6e20  run use --login 
-000546a0: 746f 206c 6f67 2069 6e2c 2074 6f20 6175  to log in, to au
-000546b0: 7468 656e 7469 6361 7465 2e20 220a 2020  thenticate. ".  
-000546c0: 2020 2020 2020 2020 2020 224f 6e20 7365            "On se
-000546d0: 636f 6e64 2072 756e 2077 6520 7375 6767  cond run we sugg
-000546e0: 6573 7420 746f 2075 7365 202d 2d76 6572  est to use --ver
-000546f0: 6966 7920 746f 2067 6574 2076 6572 6966  ify to get verif
-00054700: 6965 642e 2022 0a20 2020 2020 2020 2020  ied. ".         
-00054710: 2020 2022 456d 6f6a 6920 7665 7269 6669     "Emoji verifi
-00054720: 6361 7469 6f6e 2069 7320 6275 696c 742d  cation is built-
-00054730: 696e 2077 6869 6368 2063 616e 2062 6520  in which can be 
-00054740: 7573 6564 2022 0a20 2020 2020 2020 2020  used ".         
-00054750: 2020 2022 746f 2076 6572 6966 7920 6465     "to verify de
-00054760: 7669 6365 732e 2022 0a20 2020 2020 2020  vices. ".       
-00054770: 2020 2020 2022 4f6e 2066 7572 7468 6572       "On further
-00054780: 2072 756e 7320 7468 6973 2070 726f 6772   runs this progr
-00054790: 616d 2069 6d70 6c65 6d65 6e74 7320 6120  am implements a 
-000547a0: 7369 6d70 6c65 204d 6174 7269 7820 434c  simple Matrix CL
-000547b0: 4920 220a 2020 2020 2020 2020 2020 2020  I ".            
-000547c0: 2263 6c69 656e 7420 7468 6174 2063 616e  "client that can
-000547d0: 2073 656e 6420 6d65 7373 6167 6573 2c20   send messages, 
-000547e0: 6c69 7374 656e 2074 6f20 6d65 7373 6167  listen to messag
-000547f0: 6573 2c20 7665 7269 6679 2022 0a20 2020  es, verify ".   
-00054800: 2020 2020 2020 2020 2022 6465 7669 6365           "device
-00054810: 732c 2065 7463 2e20 4974 2063 616e 2073  s, etc. It can s
-00054820: 656e 6420 6f6e 6520 6f72 206d 756c 7469  end one or multi
-00054830: 706c 6520 6d65 7373 6167 6520 746f 206f  ple message to o
-00054840: 6e65 206f 7220 220a 2020 2020 2020 2020  ne or ".        
-00054850: 2020 2020 226d 756c 7469 706c 6520 4d61      "multiple Ma
-00054860: 7472 6978 2072 6f6f 6d73 2061 6e64 2f6f  trix rooms and/o
-00054870: 7220 7573 6572 732e 2054 6865 2074 6578  r users. The tex
-00054880: 7420 6d65 7373 6167 6573 2063 616e 2062  t messages can b
-00054890: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
-000548a0: 226f 6620 7661 7269 6f75 7320 220a 2020  "of various ".  
-000548b0: 2020 2020 2020 2020 2020 2766 6f72 6d61            'forma
-000548c0: 7473 2073 7563 6820 6173 2022 7465 7874  ts such as "text
-000548d0: 222c 2022 6874 6d6c 222c 2022 6d61 726b  ", "html", "mark
-000548e0: 646f 776e 2220 6f72 2022 636f 6465 222e  down" or "code".
-000548f0: 2027 0a20 2020 2020 2020 2020 2020 2022   '.            "
-00054900: 496d 6167 6573 2c20 6175 6469 6f2c 2061  Images, audio, a
-00054910: 7262 6974 7261 7279 2066 696c 6573 2c20  rbitrary files, 
-00054920: 6f72 2065 7665 6e74 7320 6361 6e20 6265  or events can be
-00054930: 2073 656e 7420 6173 2077 656c 6c2e 2022   sent as well. "
-00054940: 0a20 2020 2020 2020 2020 2020 2022 466f  .            "Fo
-00054950: 7220 7265 6365 6976 696e 6720 7468 6572  r receiving ther
-00054960: 6520 6172 6520 7468 7265 6520 6d61 696e  e are three main
-00054970: 206f 7074 696f 6e73 3a20 6c69 7374 656e   options: listen
-00054980: 2066 6f72 6576 6572 2c20 220a 2020 2020   forever, ".    
-00054990: 2020 2020 2020 2020 226c 6973 7465 6e20          "listen 
-000549a0: 6f6e 6365 2061 6e64 2071 7569 742c 2061  once and quit, a
-000549b0: 6e64 2067 6574 2074 6865 206c 6173 7420  nd get the last 
-000549c0: 4e20 6d65 7373 6167 6573 2022 0a20 2020  N messages ".   
-000549d0: 2020 2020 2020 2020 2022 616e 6420 7175           "and qu
-000549e0: 6974 2e20 456e 642d 746f 2d65 6e64 2065  it. End-to-end e
-000549f0: 6e63 7279 7074 696f 6e20 6973 2065 6e61  ncryption is ena
-00054a00: 626c 6564 2062 7920 6465 6661 756c 7420  bled by default 
-00054a10: 220a 2020 2020 2020 2020 2020 2020 2261  ".            "a
-00054a20: 6e64 2063 616e 6e6f 7420 6265 2074 7572  nd cannot be tur
-00054a30: 6e65 6420 6f66 662c 2062 7574 2069 7420  ned off, but it 
-00054a40: 6361 6e20 6265 2064 6973 6162 6c65 6420  can be disabled 
-00054a50: 666f 7220 7370 6563 6966 6963 2022 0a20  for specific ". 
-00054a60: 2020 2020 2020 2020 2020 2022 7573 6520             "use 
-00054a70: 6361 7365 732e 2020 e294 80e2 9480 e294  cases.  ........
-00054a80: 8020 220a 2020 2020 2020 2020 2020 2020  . ".            
-00054a90: 2242 756e 646c 696e 6720 7365 7665 7261  "Bundling severa
-00054aa0: 6c20 6163 7469 6f6e 7320 746f 6765 7468  l actions togeth
-00054ab0: 6572 2069 6e74 6f20 6120 7369 6e67 6c65  er into a single
-00054ac0: 2063 616c 6c20 746f 2022 0a20 2020 2020   call to ".     
-00054ad0: 2020 2020 2020 2066 227b 5052 4f47 5f57         f"{PROG_W
-00054ae0: 4954 484f 5554 5f45 5854 7d20 6973 2066  ITHOUT_EXT} is f
-00054af0: 6173 7465 7220 7468 616e 2063 616c 6c69  aster than calli
-00054b00: 6e67 207b 5052 4f47 5f57 4954 484f 5554  ng {PROG_WITHOUT
-00054b10: 5f45 5854 7d20 220a 2020 2020 2020 2020  _EXT} ".        
-00054b20: 2020 2020 226d 756c 7469 706c 6520 7469      "multiple ti
-00054b30: 6d65 7320 7769 7468 206f 6e6c 7920 6f6e  mes with only on
-00054b40: 6520 6163 7469 6f6e 2e20 4966 2074 6865  e action. If the
-00054b50: 7265 2061 7265 2062 6f74 6820 2773 6574  re are both 'set
-00054b60: 2720 220a 2020 2020 2020 2020 2020 2020  ' ".            
-00054b70: 2261 6e64 2027 6765 7427 2061 6374 696f  "and 'get' actio
-00054b80: 6e73 2070 7265 7365 6e74 2069 6e20 7468  ns present in th
-00054b90: 6520 6172 6775 6d65 6e74 732c 2074 6865  e arguments, the
-00054ba0: 6e20 7468 6520 2773 6574 2720 220a 2020  n the 'set' ".  
-00054bb0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-00054bc0: 6e73 2077 696c 6c20 6265 2070 6572 666f  ns will be perfo
-00054bd0: 726d 6564 2062 6566 6f72 6520 7468 6520  rmed before the 
-00054be0: 2767 6574 2720 6163 7469 6f6e 732e 2054  'get' actions. T
-00054bf0: 6865 6e20 220a 2020 2020 2020 2020 2020  hen ".          
-00054c00: 2020 2273 656e 6420 6163 7469 6f6e 7320    "send actions 
-00054c10: 616e 6420 6174 2074 6865 2076 6572 7920  and at the very 
-00054c20: 656e 6420 6c69 7374 656e 2061 6374 696f  end listen actio
-00054c30: 6e73 2077 696c 6c20 6265 2022 0a20 2020  ns will be ".   
-00054c40: 2020 2020 2020 2020 2022 7065 7266 6f72           "perfor
-00054c50: 6d65 642e 20e2 9480 e294 80e2 9480 2022  med. ......... "
-00054c60: 0a20 2020 2020 2020 2020 2020 2022 466f  .            "Fo
-00054c70: 7220 6576 656e 206d 6f72 6520 6578 706c  r even more expl
-00054c80: 6963 6174 696f 6e73 2061 6e64 2065 7861  ications and exa
-00054c90: 6d70 6c65 7320 616c 736f 2072 6561 6420  mples also read 
-00054ca0: 7468 6520 220a 2020 2020 2020 2020 2020  the ".          
-00054cb0: 2020 2264 6f63 756d 656e 7461 7469 6f6e    "documentation
-00054cc0: 2070 726f 7669 6465 6420 696e 2074 6865   provided in the
-00054cd0: 206f 6e2d 6c69 6e65 2047 6974 6875 6220   on-line Github 
-00054ce0: 5245 4144 4d45 2e6d 6420 6669 6c65 2022  README.md file "
-00054cf0: 0a20 2020 2020 2020 2020 2020 2022 6f72  .            "or
-00054d00: 2074 6865 2052 4541 444d 452e 6d64 2069   the README.md i
-00054d10: 6e20 796f 7572 206c 6f63 616c 2069 6e73  n your local ins
-00054d20: 7461 6c6c 6174 696f 6e2e 2020 e294 80e2  tallation.  ....
-00054d30: 9480 e294 8020 220a 2020 2020 2020 2020  ..... ".        
-00054d40: 2020 2020 2246 6f72 206c 6573 7320 696e      "For less in
-00054d50: 666f 726d 6174 696f 6e20 6a75 7374 2075  formation just u
-00054d60: 7365 202d 2d68 656c 7020 696e 7374 6561  se --help instea
-00054d70: 6420 6f66 202d 2d6d 616e 7561 6c2e 220a  d of --manual.".
-00054d80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00054d90: 2020 7072 696e 7428 7465 7874 7772 6170    print(textwrap
-00054da0: 2e66 696c 6c28 6465 7363 7269 7074 696f  .fill(descriptio
-00054db0: 6e2c 2077 6964 7468 3d74 6572 6d5f 7769  n, width=term_wi
-00054dc0: 6474 6829 2c20 666c 7573 683d 5472 7565  dth), flush=True
-00054dd0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-00054de0: 2222 290a 2020 2020 2020 2020 6170 2e70  "").        ap.p
-00054df0: 7269 6e74 5f68 656c 7028 6669 6c65 3d4e  rint_help(file=N
-00054e00: 6f6e 6529 2020 2320 6170 2e70 7269 6e74  one)  # ap.print
-00054e10: 5f75 7361 6765 2829 2069 7320 696e 636c  _usage() is incl
-00054e20: 7564 6564 0a20 2020 2020 2020 2072 6574  uded.        ret
-00054e30: 7572 6e20 300a 2020 2020 6966 2067 732e  urn 0.    if gs.
-00054e40: 7061 2e72 6561 646d 653a 0a20 2020 2020  pa.readme:.     
-00054e50: 2020 2023 2054 6f64 6f0a 2020 2020 2020     # Todo.      
-00054e60: 2020 6578 6564 6972 203d 206f 732e 7061    exedir = os.pa
-00054e70: 7468 2e64 6972 6e61 6d65 286f 732e 7061  th.dirname(os.pa
-00054e80: 7468 2e72 6561 6c70 6174 6828 5f5f 6669  th.realpath(__fi
-00054e90: 6c65 5f5f 2929 0a20 2020 2020 2020 2072  le__)).        r
-00054ea0: 6561 646d 6520 3d20 6578 6564 6972 202b  eadme = exedir +
-00054eb0: 2022 2f2e 2e2f 2220 2b20 2252 4541 444d   "/../" + "READM
-00054ec0: 452e 6d64 220a 2020 2020 2020 2020 7265  E.md".        re
-00054ed0: 6164 6d65 5f70 7269 6d61 7279 203d 2072  adme_primary = r
-00054ee0: 6561 646d 650a 2020 2020 2020 2020 666f  eadme.        fo
-00054ef0: 756e 6470 6174 6820 3d20 4e6f 6e65 0a20  undpath = None. 
-00054f00: 2020 2020 2020 2069 6620 6f73 2e70 6174         if os.pat
-00054f10: 682e 6578 6973 7473 2872 6561 646d 6529  h.exists(readme)
-00054f20: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00054f30: 756e 6470 6174 6820 3d20 7265 6164 6d65  undpath = readme
-00054f40: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00054f50: 6e74 2866 2246 6f75 6e64 206c 6f63 616c  nt(f"Found local
-00054f60: 2052 4541 444d 452e 6d64 2068 6572 653a   README.md here:
-00054f70: 207b 7265 6164 6d65 7d22 290a 2020 2020   {readme}").    
-00054f80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00054f90: 2020 2020 2020 7265 6164 6d65 203d 2065        readme = e
-00054fa0: 7865 6469 7220 2b20 222f 2220 2b20 2252  xedir + "/" + "R
-00054fb0: 4541 444d 452e 6d64 220a 2020 2020 2020  EADME.md".      
-00054fc0: 2020 2020 2020 6966 206f 732e 7061 7468        if os.path
-00054fd0: 2e65 7869 7374 7328 7265 6164 6d65 293a  .exists(readme):
-00054fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00054ff0: 2066 6f75 6e64 7061 7468 203d 2072 6561   foundpath = rea
-00055000: 646d 650a 2020 2020 2020 2020 2020 2020  dme.            
-00055010: 2020 2020 7072 696e 7428 6622 466f 756e      print(f"Foun
-00055020: 6420 6c6f 6361 6c20 5245 4144 4d45 2e6d  d local README.m
-00055030: 6420 6865 7265 3a20 7b72 6561 646d 657d  d here: {readme}
-00055040: 2229 0a20 2020 2020 2020 2069 6620 666f  ").        if fo
-00055050: 756e 6470 6174 6820 6973 204e 6f6e 653a  undpath is None:
-00055060: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00055070: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
-00055080: 2020 2020 2253 6f72 7279 2c20 5245 4144      "Sorry, READ
-00055090: 4d45 2e6d 6420 6e6f 7420 666f 756e 6420  ME.md not found 
-000550a0: 6c6f 6361 6c6c 7920 220a 2020 2020 2020  locally ".      
-000550b0: 2020 2020 2020 2020 2020 6622 696e 2069            f"in i
-000550c0: 6e73 7461 6c6c 6174 696f 6e20 6469 7265  nstallation dire
-000550d0: 6374 6f72 7920 7b72 6561 646d 655f 7072  ctory {readme_pr
-000550e0: 696d 6172 797d 2e22 0a20 2020 2020 2020  imary}.".       
-000550f0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00055100: 2020 2070 7269 6e74 2866 2248 656e 6365     print(f"Hence
-00055110: 2064 6f77 6e6c 6f61 6469 6e67 2069 7420   downloading it 
-00055120: 6672 6f6d 207b 5245 4144 4d45 5f46 494c  from {README_FIL
-00055130: 455f 5241 575f 5552 4c7d 2e22 290a 2020  E_RAW_URL}.").  
-00055140: 2020 2020 2020 2020 2020 6e6f 7475 7365            notuse
-00055150: 642c 2066 6f75 6e64 7061 7468 203d 2074  d, foundpath = t
-00055160: 656d 7066 696c 652e 6d6b 7374 656d 7028  empfile.mkstemp(
-00055170: 290a 2020 2020 2020 2020 2020 2020 7572  ).            ur
-00055180: 6c6c 6962 2e72 6571 7565 7374 2e75 726c  llib.request.url
-00055190: 7265 7472 6965 7665 2852 4541 444d 455f  retrieve(README_
-000551a0: 4649 4c45 5f52 4157 5f55 524c 2c20 666f  FILE_RAW_URL, fo
-000551b0: 756e 6470 6174 6829 0a20 2020 2020 2020  undpath).       
-000551c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000551d0: 2020 7769 7468 206f 7065 6e28 666f 756e    with open(foun
-000551e0: 6470 6174 682c 2022 722b 2229 2061 7320  dpath, "r+") as 
-000551f0: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
-00055200: 2020 2074 6578 7420 3d20 662e 7265 6164     text = f.read
-00055210: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
-00055220: 7269 6e74 2866 227b 7465 7874 7d22 290a  rint(f"{text}").
-00055230: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00055240: 7863 6570 7469 6f6e 3a20 2023 2028 4272  xception:  # (Br
-00055250: 6f6b 656e 5069 7065 4572 726f 722c 2049  okenPipeError, I
-00055260: 4f45 7272 6f72 293a 0a20 2020 2020 2020  OError):.       
-00055270: 2020 2020 2023 2070 7269 6e74 2822 4272       # print("Br
-00055280: 6f6b 656e 5069 7065 4572 726f 7220 6361  okenPipeError ca
-00055290: 7567 6874 222c 2066 696c 653d 7379 732e  ught", file=sys.
-000552a0: 7374 6465 7272 290a 2020 2020 2020 2020  stderr).        
-000552b0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-000552c0: 2072 6574 7572 6e20 300a 0a20 2020 206c   return 0..    l
-000552d0: 6f67 6769 6e67 2e62 6173 6963 436f 6e66  ogging.basicConf
-000552e0: 6967 2820 2023 2069 6e69 7469 616c 697a  ig(  # initializ
-000552f0: 6520 726f 6f74 206c 6f67 6765 722c 2061  e root logger, a
-00055300: 206d 7573 740a 2020 2020 2020 2020 666f   must.        fo
-00055310: 726d 6174 3d22 7b61 7363 7469 6d65 7d3a  rmat="{asctime}:
-00055320: 207b 6c65 7665 6c6e 616d 653a 3e38 7d3a   {levelname:>8}:
-00055330: 207b 6e61 6d65 3a3e 3136 7d3a 207b 6d65   {name:>16}: {me
-00055340: 7373 6167 657d 222c 2073 7479 6c65 3d22  ssage}", style="
-00055350: 7b22 0a20 2020 2029 0a20 2020 2023 2073  {".    ).    # s
-00055360: 6574 206c 6f67 206c 6576 656c 206f 6e20  et log level on 
-00055370: 726f 6f74 0a20 2020 2069 6620 2244 4542  root.    if "DEB
-00055380: 5547 2220 696e 206f 732e 656e 7669 726f  UG" in os.enviro
-00055390: 6e3a 0a20 2020 2020 2020 206c 6f67 6769  n:.        loggi
-000553a0: 6e67 2e67 6574 4c6f 6767 6572 2829 2e73  ng.getLogger().s
-000553b0: 6574 4c65 7665 6c28 6c6f 6767 696e 672e  etLevel(logging.
-000553c0: 4445 4255 4729 0a20 2020 2065 6c73 653a  DEBUG).    else:
-000553d0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-000553e0: 2e67 6574 4c6f 6767 6572 2829 2e73 6574  .getLogger().set
-000553f0: 4c65 7665 6c28 6c6f 6767 696e 672e 494e  Level(logging.IN
-00055400: 464f 290a 0a20 2020 2067 732e 6c6f 6720  FO)..    gs.log 
-00055410: 3d20 6c6f 6767 696e 672e 6765 744c 6f67  = logging.getLog
-00055420: 6765 7228 5052 4f47 5f57 4954 484f 5554  ger(PROG_WITHOUT
-00055430: 5f45 5854 290a 0a20 2020 2069 6620 6773  _EXT)..    if gs
-00055440: 2e70 612e 6c6f 675f 6c65 7665 6c3a 0a20  .pa.log_level:. 
-00055450: 2020 2020 2020 2069 6e69 7469 616c 5f63         initial_c
-00055460: 6865 636b 5f6f 665f 6c6f 675f 6172 6773  heck_of_log_args
-00055470: 2829 0a20 2020 2020 2020 2069 6620 6c65  ().        if le
-00055480: 6e28 6773 2e70 612e 6c6f 675f 6c65 7665  n(gs.pa.log_leve
-00055490: 6c29 203e 2030 3a0a 2020 2020 2020 2020  l) > 0:.        
-000554a0: 2020 2020 6966 206c 656e 2867 732e 7061      if len(gs.pa
-000554b0: 2e6c 6f67 5f6c 6576 656c 2920 3e20 313a  .log_level) > 1:
-000554c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000554d0: 2023 2073 6574 206c 6f67 206c 6576 656c   # set log level
-000554e0: 2066 6f72 2045 5645 5259 5448 494e 470a   for EVERYTHING.
-000554f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055500: 6c6f 6767 696e 672e 6765 744c 6f67 6765  logging.getLogge
-00055510: 7228 292e 7365 744c 6576 656c 2867 732e  r().setLevel(gs.
-00055520: 7061 2e6c 6f67 5f6c 6576 656c 5b31 5d29  pa.log_level[1])
-00055530: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-00055540: 6574 206c 6f67 206c 6576 656c 2066 6f72  et log level for
-00055550: 206d 6174 7269 782d 636f 6d6d 616e 6465   matrix-commande
-00055560: 720a 2020 2020 2020 2020 2020 2020 6773  r.            gs
-00055570: 2e6c 6f67 2e73 6574 4c65 7665 6c28 6773  .log.setLevel(gs
-00055580: 2e70 612e 6c6f 675f 6c65 7665 6c5b 305d  .pa.log_level[0]
-00055590: 290a 2020 2020 2020 2020 2020 2020 6773  ).            gs
-000555a0: 2e6c 6f67 2e64 6562 7567 280a 2020 2020  .log.debug(.    
-000555b0: 2020 2020 2020 2020 2020 2020 6622 4c6f              f"Lo
-000555c0: 6720 6c65 7665 6c20 6973 2073 6574 2066  g level is set f
-000555d0: 6f72 206d 6f64 756c 6520 7b50 524f 475f  or module {PROG_
-000555e0: 5749 5448 4f55 545f 4558 547d 2e20 220a  WITHOUT_EXT}. ".
-000555f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055600: 6622 6c6f 675f 6c65 7665 6c3d 7b67 732e  f"log_level={gs.
-00055610: 7061 2e6c 6f67 5f6c 6576 656c 5b30 5d7d  pa.log_level[0]}
-00055620: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00055630: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00055640: 656e 2867 732e 7061 2e6c 6f67 5f6c 6576  en(gs.pa.log_lev
-00055650: 656c 2920 3e20 313a 0a20 2020 2020 2020  el) > 1:.       
-00055660: 2020 2020 2020 2020 2023 206f 6e6c 7920           # only 
-00055670: 6e6f 7720 7468 6174 206c 6f63 616c 206c  now that local l
-00055680: 6f67 206c 6576 656c 2069 7320 7365 742c  og level is set,
-00055690: 2077 6520 6361 6e20 6c6f 6720 7072 6576   we can log prev
-000556a0: 2e20 696e 666f 0a20 2020 2020 2020 2020  . info.         
-000556b0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
-000556c0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-000556d0: 2020 2020 2020 2020 2066 224c 6f67 206c           f"Log l
-000556e0: 6576 656c 2069 7320 7365 7420 666f 7220  evel is set for 
-000556f0: 6d6f 6475 6c65 7320 6265 6c6f 7720 7b50  modules below {P
-00055700: 524f 475f 5749 5448 4f55 545f 4558 547d  ROG_WITHOUT_EXT}
-00055710: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-00055720: 2020 2020 2020 2020 6622 6c6f 675f 6c65          f"log_le
-00055730: 7665 6c3d 7b67 732e 7061 2e6c 6f67 5f6c  vel={gs.pa.log_l
-00055740: 6576 656c 5b31 5d7d 220a 2020 2020 2020  evel[1]}".      
-00055750: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00055760: 6966 2067 732e 7061 2e64 6562 7567 203e  if gs.pa.debug >
-00055770: 2030 3a0a 2020 2020 2020 2020 6966 2067   0:.        if g
-00055780: 732e 7061 2e64 6562 7567 203e 2031 3a0a  s.pa.debug > 1:.
-00055790: 2020 2020 2020 2020 2020 2020 2320 7475              # tu
-000557a0: 726e 206f 6e20 6465 6275 6720 6c6f 6767  rn on debug logg
-000557b0: 696e 6720 666f 7220 4556 4552 5954 4849  ing for EVERYTHI
-000557c0: 4e47 0a20 2020 2020 2020 2020 2020 206c  NG.            l
-000557d0: 6f67 6769 6e67 2e67 6574 4c6f 6767 6572  ogging.getLogger
-000557e0: 2829 2e73 6574 4c65 7665 6c28 6c6f 6767  ().setLevel(logg
-000557f0: 696e 672e 4445 4255 4729 0a20 2020 2020  ing.DEBUG).     
-00055800: 2020 2023 2074 7572 6e20 6f6e 2064 6562     # turn on deb
-00055810: 7567 206c 6f67 6769 6e67 2066 6f72 206d  ug logging for m
-00055820: 6174 7269 782d 636f 6d6d 616e 6465 720a  atrix-commander.
-00055830: 2020 2020 2020 2020 6773 2e6c 6f67 2e73          gs.log.s
-00055840: 6574 4c65 7665 6c28 6c6f 6767 696e 672e  etLevel(logging.
-00055850: 4445 4255 4729 0a20 2020 2020 2020 2067  DEBUG).        g
-00055860: 732e 6c6f 672e 6465 6275 6728 6622 4465  s.log.debug(f"De
-00055870: 6275 6720 6973 2074 7572 6e65 6420 6f6e  bug is turned on
-00055880: 2e20 6465 6275 6720 636f 756e 743d 7b67  . debug count={g
-00055890: 732e 7061 2e64 6562 7567 7d22 290a 2020  s.pa.debug}").  
-000558a0: 2020 2020 2020 6966 2067 732e 7061 2e6c        if gs.pa.l
-000558b0: 6f67 5f6c 6576 656c 2061 6e64 206c 656e  og_level and len
-000558c0: 2867 732e 7061 2e6c 6f67 5f6c 6576 656c  (gs.pa.log_level
-000558d0: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-000558e0: 2020 2067 732e 6c6f 672e 7761 726e 696e     gs.log.warnin
-000558f0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00055900: 2020 2022 5731 3131 3a20 2220 2244 6562     "W111: " "Deb
-00055910: 7567 206f 7074 696f 6e20 2d64 206f 7665  ug option -d ove
-00055920: 7277 726f 7465 206f 7074 696f 6e20 2d2d  rwrote option --
-00055930: 6c6f 672d 6c65 7665 6c2e 220a 2020 2020  log-level.".    
-00055940: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00055950: 2020 2020 2020 6773 2e77 6172 6e5f 636f        gs.warn_co
-00055960: 756e 7420 2b3d 2031 0a0a 2020 2020 5345  unt += 1..    SE
-00055970: 5020 3d20 6279 7465 7328 6773 2e70 612e  P = bytes(gs.pa.
-00055980: 7365 7061 7261 746f 722c 2022 7574 662d  separator, "utf-
-00055990: 3822 292e 6465 636f 6465 2822 756e 6963  8").decode("unic
-000559a0: 6f64 655f 6573 6361 7065 2229 0a20 2020  ode_escape").   
-000559b0: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-000559c0: 2020 2020 2020 2066 2753 6570 6172 6174         f'Separat
-000559d0: 6f72 2069 7320 7365 7420 746f 2022 7b53  or is set to "{S
-000559e0: 4550 7d22 206f 6620 270a 2020 2020 2020  EP}" of '.      
-000559f0: 2020 6622 6c65 6e67 7468 207b 6c65 6e28    f"length {len(
-00055a00: 5345 5029 7d2e 2045 2e67 2e20 436f 6c31  SEP)}. E.g. Col1
-00055a10: 7b53 4550 7d43 6f6c 322e 220a 2020 2020  {SEP}Col2.".    
-00055a20: 290a 2020 2020 696e 6974 6961 6c5f 6368  ).    initial_ch
-00055a30: 6563 6b5f 6f66 5f61 7267 7328 290a 2020  eck_of_args().  
-00055a40: 2020 6368 6563 6b5f 646f 776e 6c6f 6164    check_download
-00055a50: 5f6d 6564 6961 5f64 6972 2829 0a20 2020  _media_dir().   
-00055a60: 2074 7279 3a0a 2020 2020 2020 2020 6368   try:.        ch
-00055a70: 6563 6b5f 6172 675f 6669 6c65 735f 7265  eck_arg_files_re
-00055a80: 6164 6162 6c65 2829 0a20 2020 2065 7863  adable().    exc
-00055a90: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00055aa0: 2065 3a0a 2020 2020 2020 2020 6773 2e6c   e:.        gs.l
-00055ab0: 6f67 2e65 7272 6f72 2865 2920 2023 2061  og.error(e)  # a
-00055ac0: 6c72 6561 6479 2068 6173 2045 7878 783a  lready has Exxx:
-00055ad0: 2075 6e69 7175 6520 6572 726f 7220 6e75   unique error nu
-00055ae0: 6d62 6572 0a20 2020 2020 2020 2072 6169  mber.        rai
-00055af0: 7365 204d 6174 7269 7843 6f6d 6d61 6e64  se MatrixCommand
-00055b00: 6572 4572 726f 7228 0a20 2020 2020 2020  erError(.       
-00055b10: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
-00055b20: 484f 5554 5f45 5854 7d20 666f 7263 6573  HOUT_EXT} forces
-00055b30: 2061 6e20 6561 726c 7920 6162 6f72 742e   an early abort.
-00055b40: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00055b50: 546f 2061 766f 6964 2070 6172 7469 616c  To avoid partial
-00055b60: 2065 7865 6375 7469 6f6e 2c20 6e6f 2061   execution, no a
-00055b70: 6374 696f 6e20 6861 7320 6265 656e 2070  ction has been p
-00055b80: 6572 666f 726d 6564 2061 7420 616c 6c2e  erformed at all.
-00055b90: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00055ba0: 4e6f 7468 696e 6720 6861 7320 6265 656e  Nothing has been
-00055bb0: 2073 656e 742e 2046 6978 2079 6f75 7220   sent. Fix your 
-00055bc0: 6172 6775 6d65 6e74 7320 616e 6420 7275  arguments and ru
-00055bd0: 6e20 7468 6520 636f 6d6d 616e 6420 220a  n the command ".
-00055be0: 2020 2020 2020 2020 2020 2020 2261 6761              "aga
-00055bf0: 696e 2e22 0a20 2020 2020 2020 2029 2066  in.".        ) f
-00055c00: 726f 6d20 4e6f 6e65 0a0a 2020 2020 6966  rom None..    if
-00055c10: 2067 732e 7061 2e76 6572 7369 6f6e 3a0a   gs.pa.version:.
-00055c20: 2020 2020 2020 2020 6966 2067 732e 7061          if gs.pa
-00055c30: 2e76 6572 7369 6f6e 2e6c 6f77 6572 2829  .version.lower()
-00055c40: 203d 3d20 5052 494e 543a 0a20 2020 2020   == PRINT:.     
-00055c50: 2020 2020 2020 2076 6572 7369 6f6e 2829         version()
-00055c60: 2020 2320 636f 6e74 696e 7565 2065 7865    # continue exe
-00055c70: 6375 7469 6f6e 0a20 2020 2020 2020 2065  cution.        e
-00055c80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00055c90: 2063 6865 636b 5f76 6572 7369 6f6e 2829   check_version()
-00055ca0: 2020 2320 636f 6e74 696e 7565 2065 7865    # continue exe
-00055cb0: 6375 7469 6f6e 0a20 2020 2020 2020 2069  cution.        i
-00055cc0: 6620 6e6f 7420 280a 2020 2020 2020 2020  f not (.        
-00055cd0: 2020 2020 6773 2e73 656e 645f 6163 7469      gs.send_acti
-00055ce0: 6f6e 0a20 2020 2020 2020 2020 2020 206f  on.            o
-00055cf0: 7220 6773 2e72 6f6f 6d5f 6163 7469 6f6e  r gs.room_action
-00055d00: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
-00055d10: 6773 2e70 612e 6c69 7374 656e 2021 3d20  gs.pa.listen != 
-00055d20: 4c49 5354 454e 5f44 4546 4155 4c54 0a20  LISTEN_DEFAULT. 
-00055d30: 2020 2020 2020 2020 2020 206f 7220 6773             or gs
-00055d40: 2e70 612e 7461 696c 2021 3d20 5441 494c  .pa.tail != TAIL
-00055d50: 5f55 4e55 5345 445f 4445 4641 554c 540a  _UNUSED_DEFAULT.
-00055d60: 2020 2020 2020 2020 2020 2020 6f72 2067              or g
-00055d70: 732e 7061 2e76 6572 6966 790a 2020 2020  s.pa.verify.    
-00055d80: 2020 2020 2020 2020 6f72 2067 732e 7365          or gs.se
-00055d90: 7467 6574 5f61 6374 696f 6e0a 2020 2020  tget_action.    
-00055da0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00055db0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
-00055dc0: 224f 6e6c 7920 2d2d 7665 7273 696f 6e2e  "Only --version.
-00055dd0: 2050 7269 6e74 2061 6e64 2071 7569 742e   Print and quit.
-00055de0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00055df0: 6574 7572 6e20 2023 206a 7573 7420 7665  eturn  # just ve
-00055e00: 7273 696f 6e2c 2071 7569 740a 0a20 2020  rsion, quit..   
-00055e10: 2063 7265 6174 655f 7069 645f 6669 6c65   create_pid_file
-00055e20: 2829 0a0a 2020 2020 6773 2e6c 6f67 2e64  ()..    gs.log.d
-00055e30: 6562 7567 2866 2750 7974 686f 6e20 7665  ebug(f'Python ve
-00055e40: 7273 696f 6e20 6973 2022 7b73 7973 2e76  rsion is "{sys.v
-00055e50: 6572 7369 6f6e 7d22 2729 0a20 2020 2067  ersion}"').    g
-00055e60: 732e 6c6f 672e 6465 6275 6728 6627 5374  s.log.debug(f'St
-00055e70: 6469 6e20 7069 7065 2069 7320 6173 7369  din pipe is assi
-00055e80: 676e 6564 2074 6f20 227b 6773 2e73 7464  gned to "{gs.std
-00055e90: 696e 5f75 7365 7d22 2e27 290a 2020 2020  in_use}".').    
-00055ea0: 6966 2067 732e 7061 2e73 736c 5f63 6572  if gs.pa.ssl_cer
-00055eb0: 7469 6669 6361 7465 2021 3d20 5353 4c5f  tificate != SSL_
-00055ec0: 4345 5254 4946 4943 4154 455f 4445 4641  CERTIFICATE_DEFA
-00055ed0: 554c 543a 0a20 2020 2020 2020 2067 732e  ULT:.        gs.
-00055ee0: 6c6f 672e 6465 6275 6728 0a20 2020 2020  log.debug(.     
-00055ef0: 2020 2020 2020 2022 5353 4c20 7769 6c6c         "SSL will
-00055f00: 2062 6520 7573 6564 2e20 4120 6375 7374   be used. A cust
-00055f10: 6f6d 2053 534c 2063 6572 7469 6669 6361  om SSL certifica
-00055f20: 7465 2077 6173 2070 726f 7669 6465 642e  te was provided.
-00055f30: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00055f40: 2743 7573 746f 6d20 6365 7274 6966 6963  'Custom certific
-00055f50: 6174 6520 6672 6f6d 2066 696c 6520 227b  ate from file "{
-00055f60: 6773 2e70 612e 7373 6c5f 6365 7274 6966  gs.pa.ssl_certif
-00055f70: 6963 6174 657d 2220 7769 6c6c 2027 0a20  icate}" will '. 
-00055f80: 2020 2020 2020 2020 2020 2022 6265 2075             "be u
-00055f90: 7365 6420 666f 7220 7468 6973 2063 6f6e  sed for this con
-00055fa0: 6e65 6374 696f 6e2e 220a 2020 2020 2020  nection.".      
-00055fb0: 2020 290a 2020 2020 2020 2020 7472 793a    ).        try:
-00055fc0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-00055fd0: 7970 6520 5353 4c43 6f6e 7465 7874 0a20  ype SSLContext. 
-00055fe0: 2020 2020 2020 2020 2020 2067 732e 7373             gs.ss
-00055ff0: 6c20 3d20 7373 6c2e 6372 6561 7465 5f64  l = ssl.create_d
-00056000: 6566 6175 6c74 5f63 6f6e 7465 7874 2863  efault_context(c
-00056010: 6166 696c 653d 6773 2e70 612e 7373 6c5f  afile=gs.pa.ssl_
-00056020: 6365 7274 6966 6963 6174 6529 0a20 2020  certificate).   
-00056030: 2020 2020 2065 7863 6570 7420 4669 6c65       except File
-00056040: 4e6f 7446 6f75 6e64 4572 726f 723a 0a20  NotFoundError:. 
-00056050: 2020 2020 2020 2020 2020 2067 732e 6572             gs.er
-00056060: 725f 636f 756e 7420 2b3d 2031 0a20 2020  r_count += 1.   
-00056070: 2020 2020 2020 2020 2072 6169 7365 204d           raise M
-00056080: 6174 7269 7843 6f6d 6d61 6e64 6572 4572  atrixCommanderEr
-00056090: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-000560a0: 2020 2020 2022 4532 3433 3a20 220a 2020       "E243: ".  
-000560b0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000560c0: 5353 4c20 6365 7274 6966 6963 6174 6520  SSL certificate 
-000560d0: 6669 6c65 2022 7b67 732e 7061 2e73 736c  file "{gs.pa.ssl
-000560e0: 5f63 6572 7469 6669 6361 7465 7d22 2077  _certificate}" w
-000560f0: 6173 2027 0a20 2020 2020 2020 2020 2020  as '.           
-00056100: 2020 2020 2022 6e6f 7420 666f 756e 642e       "not found.
-00056110: 220a 2020 2020 2020 2020 2020 2020 2920  ".            ) 
-00056120: 6672 6f6d 204e 6f6e 650a 2020 2020 2020  from None.      
-00056130: 2020 6578 6365 7074 2050 6572 6d69 7373    except Permiss
-00056140: 696f 6e45 7272 6f72 3a0a 2020 2020 2020  ionError:.      
-00056150: 2020 2020 2020 6773 2e65 7272 5f63 6f75        gs.err_cou
-00056160: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-00056170: 2020 2020 7261 6973 6520 4d61 7472 6978      raise Matrix
-00056180: 436f 6d6d 616e 6465 7245 7272 6f72 280a  CommanderError(.
-00056190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000561a0: 2245 3234 343a 2022 0a20 2020 2020 2020  "E244: ".       
-000561b0: 2020 2020 2020 2020 2066 2753 534c 2063           f'SSL c
-000561c0: 6572 7469 6669 6361 7465 2066 696c 6520  ertificate file 
-000561d0: 227b 6773 2e70 612e 7373 6c5f 6365 7274  "{gs.pa.ssl_cert
-000561e0: 6966 6963 6174 657d 2220 646f 6573 2027  ificate}" does '
-000561f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00056200: 2022 6e6f 7420 6861 7665 2072 6561 6420   "not have read 
-00056210: 7065 726d 6973 7369 6f6e 732e 220a 2020  permissions.".  
-00056220: 2020 2020 2020 2020 2020 2920 6672 6f6d            ) from
-00056230: 204e 6f6e 650a 2020 2020 2020 2020 6578   None.        ex
-00056240: 6365 7074 2073 736c 2e53 534c 4572 726f  cept ssl.SSLErro
-00056250: 723a 0a20 2020 2020 2020 2020 2020 2067  r:.            g
-00056260: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
-00056270: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00056280: 7365 204d 6174 7269 7843 6f6d 6d61 6e64  se MatrixCommand
-00056290: 6572 4572 726f 7228 0a20 2020 2020 2020  erError(.       
-000562a0: 2020 2020 2020 2020 2022 4532 3435 3a20           "E245: 
-000562b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000562c0: 2020 6627 5353 4c20 6365 7274 6966 6963    f'SSL certific
-000562d0: 6174 6520 6669 6c65 2022 7b67 732e 7061  ate file "{gs.pa
-000562e0: 2e73 736c 5f63 6572 7469 6669 6361 7465  .ssl_certificate
-000562f0: 7d22 2068 6173 2027 0a20 2020 2020 2020  }" has '.       
-00056300: 2020 2020 2020 2020 2022 696e 7661 6c69           "invali
-00056310: 6420 636f 6e74 656e 742e 2044 6f65 7320  d content. Does 
-00056320: 6e6f 7420 7365 656d 2074 6f20 6265 2061  not seem to be a
-00056330: 2063 6572 7469 6669 6361 7465 2e22 0a20   certificate.". 
-00056340: 2020 2020 2020 2020 2020 2029 2066 726f             ) fro
-00056350: 6d20 4e6f 6e65 0a20 2020 2065 6c69 6620  m None.    elif 
-00056360: 6773 2e70 612e 6e6f 5f73 736c 3a0a 2020  gs.pa.no_ssl:.  
-00056370: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
-00056380: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00056390: 2253 534c 2077 696c 6c20 6265 206e 6f74  "SSL will be not
-000563a0: 2062 6520 7573 6564 2e20 5468 6520 5353   be used. The SS
-000563b0: 4c20 6365 7274 6966 6963 6174 6520 7661  L certificate va
-000563c0: 6c69 6461 7469 6f6e 2022 0a20 2020 2020  lidation ".     
-000563d0: 2020 2020 2020 2022 7769 6c6c 2062 6520         "will be 
-000563e0: 736b 6970 7065 6420 666f 7220 7468 6973  skipped for this
-000563f0: 2063 6f6e 6e65 6374 696f 6e2e 220a 2020   connection.".  
-00056400: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00056410: 6773 2e73 736c 203d 2046 616c 7365 0a20  gs.ssl = False. 
-00056420: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00056430: 2067 732e 6c6f 672e 6465 6275 6728 0a20   gs.log.debug(. 
-00056440: 2020 2020 2020 2020 2020 2022 5353 4c20             "SSL 
-00056450: 7769 6c6c 2062 6520 7573 6564 2e20 4465  will be used. De
-00056460: 6661 756c 7420 5353 4c20 6365 7274 6966  fault SSL certif
-00056470: 6963 6174 6520 7661 6c69 6461 7469 6f6e  icate validation
-00056480: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00056490: 7769 6c6c 2062 6520 646f 6e65 2066 6f72  will be done for
-000564a0: 2074 6869 7320 636f 6e6e 6563 7469 6f6e   this connection
-000564b0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
-000564c0: 2020 2020 2067 732e 7373 6c20 3d20 4e6f       gs.ssl = No
-000564d0: 6e65 0a0a 2020 2020 7472 793a 0a20 2020  ne..    try:.   
-000564e0: 2020 2020 2061 7379 6e63 696f 2e72 756e       asyncio.run
-000564f0: 2861 7379 6e63 5f6d 6169 6e28 2929 2020  (async_main())  
-00056500: 2320 646f 2065 7665 7279 7468 696e 6720  # do everything 
-00056510: 696e 2074 6865 2065 7665 6e74 206c 6f6f  in the event loo
-00056520: 700a 2020 2020 2020 2020 2320 7468 6520  p.        # the 
-00056530: 6e65 7874 2063 616e 2062 6520 7265 6163  next can be reac
-00056540: 6865 6420 6f6e 2073 7563 6365 7373 206f  hed on success o
-00056550: 7220 6661 696c 7572 650a 2020 2020 2020  r failure.      
-00056560: 2020 6773 2e6c 6f67 2e64 6562 7567 2866    gs.log.debug(f
-00056570: 2254 6865 2070 726f 6772 616d 207b 5052  "The program {PR
-00056580: 4f47 5f57 4954 485f 4558 547d 206c 6566  OG_WITH_EXT} lef
-00056590: 7420 7468 6520 6576 656e 7420 6c6f 6f70  t the event loop
-000565a0: 2e22 290a 2020 2020 6578 6365 7074 2054  .").    except T
-000565b0: 696d 656f 7574 4572 726f 7220 6173 2065  imeoutError as e
-000565c0: 3a0a 2020 2020 2020 2020 6773 2e65 7272  :.        gs.err
-000565d0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-000565e0: 2020 2020 7261 6973 6520 4d61 7472 6978      raise Matrix
-000565f0: 436f 6d6d 616e 6465 7245 7272 6f72 280a  CommanderError(.
-00056600: 2020 2020 2020 2020 2020 2020 2245 3234              "E24
-00056610: 373a 2022 0a20 2020 2020 2020 2020 2020  7: ".           
-00056620: 2066 2254 6865 2070 726f 6772 616d 207b   f"The program {
-00056630: 5052 4f47 5f57 4954 485f 4558 547d 2072  PROG_WITH_EXT} r
-00056640: 616e 2069 6e74 6f20 6120 7469 6d65 6f75  an into a timeou
-00056650: 742e 2022 0a20 2020 2020 2020 2020 2020  t. ".           
-00056660: 2022 4d6f 7374 206c 696b 656c 7920 636f   "Most likely co
-00056670: 6e6e 6563 7469 7669 7479 2074 6f20 696e  nnectivity to in
-00056680: 7465 726e 6574 2077 6173 206c 6f73 742e  ternet was lost.
-00056690: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-000566a0: 4966 2074 6869 7320 6861 7070 656e 7320  If this happens 
-000566b0: 6672 6571 7565 6e74 6c79 2063 6f6e 7369  frequently consi
-000566c0: 6465 7220 7275 6e6e 696e 6720 7468 6973  der running this
-000566d0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-000566e0: 7072 6f67 7261 6d20 6173 2061 2073 6572  program as a ser
-000566f0: 7669 6365 2073 6f20 6974 2077 696c 6c20  vice so it will 
-00056700: 7265 7374 6172 7420 6175 746f 6d61 7469  restart automati
-00056710: 6361 6c6c 792e 2053 6f72 7279 2e22 0a20  cally. Sorry.". 
-00056720: 2020 2020 2020 2029 2066 726f 6d20 650a         ) from e.
-00056730: 2020 2020 6578 6365 7074 204d 6174 7269      except Matri
-00056740: 7843 6f6d 6d61 6e64 6572 4572 726f 723a  xCommanderError:
-00056750: 0a20 2020 2020 2020 2072 6169 7365 0a20  .        raise. 
-00056760: 2020 2065 7863 6570 7420 4b65 7962 6f61     except Keyboa
-00056770: 7264 496e 7465 7272 7570 743a 0a20 2020  rdInterrupt:.   
-00056780: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
-00056790: 6728 224b 6579 626f 6172 6420 696e 7465  g("Keyboard inte
-000567a0: 7272 7570 7420 7265 6365 6976 6564 2e22  rrupt received."
-000567b0: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-000567c0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-000567d0: 6773 2e65 7272 5f63 6f75 6e74 202b 3d20  gs.err_count += 
-000567e0: 310a 2020 2020 2020 2020 6773 2e6c 6f67  1.        gs.log
-000567f0: 2e65 7272 6f72 2822 4532 3438 3a20 2220  .error("E248: " 
-00056800: 6622 5468 6520 7072 6f67 7261 6d20 7b50  f"The program {P
-00056810: 524f 475f 5749 5448 5f45 5854 7d20 6661  ROG_WITH_EXT} fa
-00056820: 696c 6564 2e20 536f 7272 792e 2229 0a20  iled. Sorry."). 
-00056830: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00056840: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-00056850: 2020 636c 6561 6e75 7028 290a 0a0a 6465    cleanup()...de
-00056860: 6620 6d61 696e 2861 7267 763a 2055 6e69  f main(argv: Uni
-00056870: 6f6e 5b4e 6f6e 652c 206c 6973 745d 203d  on[None, list] =
-00056880: 204e 6f6e 6529 202d 3e20 696e 743a 0a20   None) -> int:. 
-00056890: 2020 2022 2222 5275 6e20 7468 6520 7072     """Run the pr
-000568a0: 6f67 7261 6d2e 0a0a 2020 2020 6d61 696e  ogram...    main
-000568b0: 2829 2069 7320 616e 2065 6e74 7279 2070  () is an entry p
-000568c0: 6f69 6e74 2061 6c6c 6f77 696e 6720 6f74  oint allowing ot
-000568d0: 6865 7220 5079 7468 6f6e 2070 726f 6772  her Python progr
-000568e0: 616d 7320 746f 0a20 2020 2065 6173 696c  ams to.    easil
-000568f0: 7920 6361 6c6c 206d 6174 7269 782d 636f  y call matrix-co
-00056900: 6d6d 616e 6465 722e 0a0a 2020 2020 4172  mmander...    Ar
-00056910: 6775 6d65 6e74 733a 0a20 2020 202d 2d2d  guments:.    ---
-00056920: 2d2d 2d2d 2d2d 0a20 2020 2061 7267 7620  ------.    argv 
-00056930: 3a20 6c69 7374 206f 6620 6172 6775 6d65  : list of argume
-00056940: 6e74 7320 6173 2069 6e20 7379 732e 6172  nts as in sys.ar
-00056950: 6776 3b20 6669 7273 7420 656c 656d 656e  gv; first elemen
-00056960: 7420 6973 2074 6865 0a20 2020 2020 2020  t is the.       
-00056970: 2070 726f 6772 616d 206e 616d 652c 2066   program name, f
-00056980: 7572 7468 6572 2065 6c65 6d65 6e74 7320  urther elements 
-00056990: 6172 6520 7468 6520 6172 6775 6d65 6e74  are the argument
-000569a0: 733b 2065 7665 7279 0a20 2020 2020 2020  s; every.       
-000569b0: 2065 6c65 6d65 6e74 206d 7573 7420 6265   element must be
-000569c0: 206f 6620 7479 7065 2022 7374 7222 2e0a   of type "str"..
-000569d0: 2020 2020 2020 2020 6172 6776 2069 7320          argv is 
-000569e0: 6f70 7469 6f6e 616c 2061 6e64 2063 616e  optional and can
-000569f0: 2062 6520 4e6f 6e65 2e0a 2020 2020 2020   be None..      
-00056a00: 2020 4966 2061 7267 7620 6973 2073 6574    If argv is set
-00056a10: 2074 6865 6e20 7468 6573 6520 6172 6775   then these argu
-00056a20: 6d65 6e74 7320 7769 6c6c 2062 6520 7573  ments will be us
-00056a30: 6564 2061 7320 6172 6775 6d65 6e74 7320  ed as arguments 
-00056a40: 666f 720a 2020 2020 2020 2020 6d61 7472  for.        matr
-00056a50: 6978 2d63 6f6d 6d61 6e64 6572 2e20 4966  ix-commander. If
-00056a60: 2061 7267 7620 6973 206e 6f74 2073 6574   argv is not set
-00056a70: 2028 4e6f 6e65 206f 7220 656d 7074 7920   (None or empty 
-00056a80: 6c69 7374 292c 2074 6865 6e0a 2020 2020  list), then.    
-00056a90: 2020 2020 7379 732e 6172 6776 2077 696c      sys.argv wil
-00056aa0: 6c20 6265 2075 7365 6420 6173 2061 7267  l be used as arg
-00056ab0: 756d 656e 7473 2066 6f72 206d 6174 7269  uments for matri
-00056ac0: 782d 636f 6d6d 616e 6465 722e 0a0a 2020  x-commander...  
-00056ad0: 2020 4578 616d 706c 6520 696e 7075 7420    Example input 
-00056ae0: 6172 6776 3a20 5b22 6d61 7472 6978 2d63  argv: ["matrix-c
-00056af0: 6f6d 6d61 6e64 6572 225d 0a20 2020 2020  ommander"].     
-00056b00: 2020 205b 226d 6174 7269 782d 636f 6d6d     ["matrix-comm
-00056b10: 616e 6465 7222 2022 2d2d 7665 7273 696f  ander" "--versio
-00056b20: 6e22 5d0a 2020 2020 2020 2020 5b22 6d61  n"].        ["ma
-00056b30: 7472 6978 2d63 6f6d 6d61 6e64 6572 2220  trix-commander" 
-00056b40: 222d 2d6d 6573 7361 6765 2220 2248 656c  "--message" "Hel
-00056b50: 6c6f 2220 2d2d 696d 6167 6520 2270 6963  lo" --image "pic
-00056b60: 2e6a 7067 225d 0a0a 2020 2020 5265 7475  .jpg"]..    Retu
-00056b70: 726e 7320 696e 742e 2030 2066 6f72 2073  rns int. 0 for s
-00056b80: 7563 6365 7373 2e20 506f 7369 7469 7665  uccess. Positive
-00056b90: 2069 6e74 6567 6572 2066 6f72 2066 6169   integer for fai
-00056ba0: 6c75 7265 2e0a 2020 2020 2020 2020 5265  lure..        Re
-00056bb0: 7475 726e 7320 7468 6520 746f 7461 6c20  turns the total 
-00056bc0: 6e75 6d62 6572 206f 6620 6572 726f 7273  number of errors
-00056bd0: 2065 6e63 6f75 6e74 6572 6564 2e0a 0a20   encountered... 
-00056be0: 2020 2054 7269 6573 2074 6f20 6176 6f69     Tries to avoi
-00056bf0: 6420 7261 6973 696e 6720 6578 6365 7074  d raising except
-00056c00: 696f 6e73 2e0a 0a20 2020 2022 2222 0a20  ions...    """. 
-00056c10: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00056c20: 6d61 696e 5f69 6e6e 6572 2861 7267 7629  main_inner(argv)
-00056c30: 0a20 2020 2065 7863 6570 7420 2845 7863  .    except (Exc
-00056c40: 6570 7469 6f6e 2c20 4d61 7472 6978 436f  eption, MatrixCo
-00056c50: 6d6d 616e 6465 7245 7272 6f72 2c20 4d61  mmanderError, Ma
-00056c60: 7472 6978 436f 6d6d 616e 6465 7257 6172  trixCommanderWar
-00056c70: 6e69 6e67 2920 6173 2065 3a0a 2020 2020  ning) as e:.    
-00056c80: 2020 2020 6966 2065 206e 6f74 2069 6e20      if e not in 
-00056c90: 284d 6174 7269 7843 6f6d 6d61 6e64 6572  (MatrixCommander
-00056ca0: 4572 726f 722c 204d 6174 7269 7843 6f6d  Error, MatrixCom
-00056cb0: 6d61 6e64 6572 5761 726e 696e 6729 3a0a  manderWarning):.
-00056cc0: 2020 2020 2020 2020 2020 2020 6773 2e65              gs.e
-00056cd0: 7272 5f63 6f75 6e74 202b 3d20 310a 2020  rr_count += 1.  
-00056ce0: 2020 2020 2020 7462 203d 2022 220a 2020        tb = "".  
-00056cf0: 2020 2020 2020 6966 2067 732e 7061 2e64        if gs.pa.d
-00056d00: 6562 7567 203e 2030 3a0a 2020 2020 2020  ebug > 0:.      
-00056d10: 2020 2020 2020 7462 203d 2066 225c 6e48        tb = f"\nH
-00056d20: 6572 6520 6973 2074 6865 2074 7261 6365  ere is the trace
-00056d30: 6261 636b 2e5c 6e7b 7472 6163 6562 6163  back.\n{tracebac
-00056d40: 6b2e 666f 726d 6174 5f65 7863 2829 7d22  k.format_exc()}"
-00056d50: 0a20 2020 2020 2020 2069 6620 6520 3d3d  .        if e ==
-00056d60: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
-00056d70: 5761 726e 696e 673a 0a20 2020 2020 2020  Warning:.       
-00056d80: 2020 2020 2067 732e 6c6f 672e 7761 726e       gs.log.warn
-00056d90: 696e 6728 6622 7b65 7d7b 7462 7d22 290a  ing(f"{e}{tb}").
-00056da0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00056db0: 2020 2020 2020 2020 2020 6773 2e6c 6f67            gs.log
-00056dc0: 2e65 7272 6f72 2866 227b 657d 7b74 627d  .error(f"{e}{tb}
-00056dd0: 2229 0a20 2020 2069 6620 6773 2e65 7272  ").    if gs.err
-00056de0: 5f63 6f75 6e74 203e 2030 206f 7220 6773  _count > 0 or gs
-00056df0: 2e77 6172 6e5f 636f 756e 7420 3e20 303a  .warn_count > 0:
-00056e00: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
-00056e10: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-00056e20: 2020 6622 7b67 732e 6572 725f 636f 756e    f"{gs.err_coun
-00056e30: 747d 2022 0a20 2020 2020 2020 2020 2020  t} ".           
-00056e40: 2066 2265 7272 6f72 7b27 2720 6966 2067   f"error{'' if g
-00056e50: 732e 6572 725f 636f 756e 7420 3d3d 2031  s.err_count == 1
-00056e60: 2065 6c73 6520 2773 277d 2061 6e64 2022   else 's'} and "
-00056e70: 0a20 2020 2020 2020 2020 2020 2066 227b  .            f"{
-00056e80: 6773 2e77 6172 6e5f 636f 756e 747d 2022  gs.warn_count} "
-00056e90: 0a20 2020 2020 2020 2020 2020 2066 2277  .            f"w
-00056ea0: 6172 6e69 6e67 7b27 2720 6966 2067 732e  arning{'' if gs.
-00056eb0: 7761 726e 5f63 6f75 6e74 203d 3d20 3120  warn_count == 1 
-00056ec0: 656c 7365 2027 7327 7d20 6f63 6375 7272  else 's'} occurr
-00056ed0: 6564 2e22 0a20 2020 2020 2020 2029 0a20  ed.".        ). 
-00056ee0: 2020 2072 6574 7572 6e20 6773 2e65 7272     return gs.err
-00056ef0: 5f63 6f75 6e74 2020 2320 3020 666f 7220  _count  # 0 for 
-00056f00: 7375 6363 6573 730a 0a0a 6966 205f 5f6e  success...if __n
-00056f10: 616d 655f 5f20 3d3d 2022 5f5f 6d61 696e  ame__ == "__main
-00056f20: 5f5f 223a 0a20 2020 2073 7973 2e65 7869  __":.    sys.exi
-00056f30: 7428 6d61 696e 2829 290a 2320 454f 460a  t(main()).# EOF.
+00038e90: 2020 7061 7373 776f 7264 3d27 7b70 6173    password='{pas
+00038ea0: 7377 6f72 647d 2722 290a 2020 2020 6773  sword}'").    gs
+00038eb0: 2e6c 6f67 2e69 6e66 6f28 6622 2020 2020  .log.info(f"    
+00038ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038ed0: 2020 2020 2020 2020 6465 7669 6365 206e          device n
+00038ee0: 616d 653d 277b 6465 7669 6365 5f6e 616d  ame='{device_nam
+00038ef0: 657d 2722 290a 2020 2020 6773 2e6c 6f67  e}'").    gs.log
+00038f00: 2e69 6e66 6f28 6622 2020 2020 2020 2020  .info(f"        
+00038f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038f20: 2020 2020 726f 6f6d 2069 643d 277b 726f      room id='{ro
+00038f30: 6f6d 5f69 647d 2722 290a 2020 2020 6966  om_id}'").    if
+00038f40: 2069 6e74 6572 6163 7469 7665 3a0a 2020   interactive:.  
+00038f50: 2020 2020 2020 7072 696e 7428 6622 5468        print(f"Th
+00038f60: 6520 7072 6f76 6964 6564 206c 6f67 696e  e provided login
+00038f70: 2064 6174 6120 6973 3a20 686f 6d65 7365   data is: homese
+00038f80: 7276 6572 3d27 7b68 6f6d 6573 6572 7665  rver='{homeserve
+00038f90: 727d 2722 290a 2020 2020 2020 2020 7072  r}'").        pr
+00038fa0: 696e 7428 6622 2020 2020 2020 2020 2020  int(f"          
+00038fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038fc0: 2020 7573 6572 2069 643d 277b 7573 6572    user id='{user
+00038fd0: 5f69 647d 2722 290a 2020 2020 2020 2020  _id}'").        
+00038fe0: 2320 7072 696e 7428 6622 2020 2020 2020  # print(f"      
+00038ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039000: 2020 2020 2020 7061 7373 776f 7264 3d27        password='
+00039010: 7b70 6173 7377 6f72 647d 2722 290a 2020  {password}'").  
+00039020: 2020 2020 2020 7072 696e 7428 2220 2020        print("   
+00039030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039040: 2020 2020 2020 2020 2070 6173 7377 6f72           passwor
+00039050: 643d 272a 2a2a 2722 290a 2020 2020 2020  d='***'").      
+00039060: 2020 7072 696e 7428 6622 2020 2020 2020    print(f"      
+00039070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039080: 2020 2020 2020 6465 7669 6365 206e 616d        device nam
+00039090: 653d 277b 6465 7669 6365 5f6e 616d 657d  e='{device_name}
+000390a0: 2722 290a 2020 2020 2020 2020 7072 696e  '").        prin
+000390b0: 7428 0a20 2020 2020 2020 2020 2020 2066  t(.            f
+000390c0: 2220 2020 2020 2020 2020 2020 2020 2020  "               
+000390d0: 2020 2020 2020 2020 2020 2020 2072 6f6f               roo
+000390e0: 6d20 6964 3d27 7b72 6f6f 6d5f 6964 7d27  m id='{room_id}'
+000390f0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+00039100: 6c75 7368 3d54 7275 652c 0a20 2020 2020  lush=True,.     
+00039110: 2020 2029 0a20 2020 2020 2020 2063 6f6e     ).        con
+00039120: 6669 726d 203d 2069 6e70 7574 2822 436f  firm = input("Co
+00039130: 7272 6563 743f 2028 5965 7320 6f72 2043  rrect? (Yes or C
+00039140: 7472 6c2d 4320 746f 2061 626f 7274 2920  trl-C to abort) 
+00039150: 2229 0a20 2020 2020 2020 2069 6620 636f  ").        if co
+00039160: 6e66 6972 6d2e 6c6f 7765 7228 2920 213d  nfirm.lower() !=
+00039170: 2022 7965 7322 2061 6e64 2063 6f6e 6669   "yes" and confi
+00039180: 726d 2e6c 6f77 6572 2829 2021 3d20 2279  rm.lower() != "y
+00039190: 223a 0a20 2020 2020 2020 2020 2020 2070  ":.            p
+000391a0: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
+000391b0: 2020 2020 2020 2222 2c0a 2020 2020 2020        "",.      
+000391c0: 2020 2020 2020 2020 2020 666c 7573 683d            flush=
+000391d0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000391e0: 2020 2920 2023 2061 6464 206e 6577 6c69    )  # add newli
+000391f0: 6e65 2074 6f20 7374 646f 7574 2074 6f20  ne to stdout to 
+00039200: 7365 7061 7261 7465 2061 6e79 206c 6f67  separate any log
+00039210: 2069 6e66 6f0a 2020 2020 2020 2020 2020   info.          
+00039220: 2020 6773 2e6c 6f67 2e69 6e66 6f28 2241    gs.log.info("A
+00039230: 626f 7274 696e 6720 6475 6520 746f 2075  borting due to u
+00039240: 7365 7220 7265 7175 6573 742e 2229 0a20  ser request."). 
+00039250: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00039260: 6e0a 0a20 2020 2023 2061 6c6c 2074 6865  n..    # all the
+00039270: 2069 6e70 7574 2072 6571 7569 7265 6420   input required 
+00039280: 666f 7220 6c6f 6769 6e20 6973 2063 6f6c  for login is col
+00039290: 6c65 6374 6564 2c0a 2020 2020 2320 6c61  lected,.    # la
+000392a0: 7465 7220 7765 2067 6574 2075 7365 725f  ter we get user_
+000392b0: 6964 2066 6f72 2053 534f 2028 7265 7475  id for SSO (retu
+000392c0: 726e 6564 2061 7420 6c6f 6769 6e20 4150  rned at login AP
+000392d0: 4920 6361 6c6c 290a 0a20 2020 2069 6620  I call)..    if 
+000392e0: 6773 2e70 612e 7072 6f78 793a 0a20 2020  gs.pa.proxy:.   
+000392f0: 2020 2020 2067 732e 6c6f 672e 696e 666f       gs.log.info
+00039300: 2866 2250 726f 7879 207b 6773 2e70 612e  (f"Proxy {gs.pa.
+00039310: 7072 6f78 797d 2077 696c 6c20 6265 2075  proxy} will be u
+00039320: 7365 642e 2229 0a0a 2020 2020 2320 6368  sed.")..    # ch
+00039330: 6563 6b20 666f 7220 7061 7373 776f 7264  eck for password
+00039340: 2f53 534f 0a20 2020 2063 6f6e 6e65 6374  /SSO.    connect
+00039350: 6f72 203d 2054 4350 436f 6e6e 6563 746f  or = TCPConnecto
+00039360: 7228 7373 6c3d 6773 2e73 736c 2920 2023  r(ssl=gs.ssl)  #
+00039370: 2073 6574 7469 6e67 2073 736c 636f 6e74   setting sslcont
+00039380: 6578 740a 2020 2020 6173 796e 6320 7769  ext.    async wi
+00039390: 7468 2043 6c69 656e 7453 6573 7369 6f6e  th ClientSession
+000393a0: 2863 6f6e 6e65 6374 6f72 3d63 6f6e 6e65  (connector=conne
+000393b0: 6374 6f72 2920 6173 2073 6573 7369 6f6e  ctor) as session
+000393c0: 3a20 2023 2061 696f 6874 7470 0a20 2020  :  # aiohttp.   
+000393d0: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
+000393e0: 7365 7373 696f 6e2e 6765 7428 0a20 2020  session.get(.   
+000393f0: 2020 2020 2020 2020 2066 227b 686f 6d65           f"{home
+00039400: 7365 7276 6572 7d2f 5f6d 6174 7269 782f  server}/_matrix/
+00039410: 636c 6965 6e74 2f72 302f 6c6f 6769 6e22  client/r0/login"
+00039420: 2c0a 2020 2020 2020 2020 2020 2020 7261  ,.            ra
+00039430: 6973 655f 666f 725f 7374 6174 7573 3d54  ise_for_status=T
+00039440: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00039450: 2070 726f 7879 3d67 732e 7061 2e70 726f   proxy=gs.pa.pro
+00039460: 7879 2c0a 2020 2020 2020 2020 2920 6173  xy,.        ) as
+00039470: 2072 6573 706f 6e73 653a 0a20 2020 2020   response:.     
+00039480: 2020 2020 2020 2066 6c6f 775f 7479 7065         flow_type
+00039490: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+000394a0: 2020 2020 2020 785b 2274 7970 6522 5d20        x["type"] 
+000394b0: 666f 7220 7820 696e 2028 6177 6169 7420  for x in (await 
+000394c0: 7265 7370 6f6e 7365 2e6a 736f 6e28 2929  response.json())
+000394d0: 2e67 6574 2822 666c 6f77 7322 2c20 5b5d  .get("flows", []
+000394e0: 290a 2020 2020 2020 2020 2020 2020 7d0a  ).            }.
+000394f0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+00039500: 6f67 2e64 6562 7567 2822 5375 7070 6f72  og.debug("Suppor
+00039510: 7465 6420 6c6f 6769 6e20 666c 6f77 733a  ted login flows:
+00039520: 2025 7222 2c20 666c 6f77 5f74 7970 6573   %r", flow_types
+00039530: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00039540: 2074 6f6b 656e 5f61 7661 696c 6162 6c65   token_available
+00039550: 203d 2022 6d2e 6c6f 6769 6e2e 746f 6b65   = "m.login.toke
+00039560: 6e22 2069 6e20 666c 6f77 5f74 7970 6573  n" in flow_types
+00039570: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+00039580: 2e6c 6f67 696e 2e74 6f6b 656e 2064 6f65  .login.token doe
+00039590: 7320 6e6f 7420 7265 6665 7220 746f 2073  s not refer to s
+000395a0: 7464 2061 6363 6573 732d 746f 6b65 6e20  td access-token 
+000395b0: 6c6f 6769 6e0a 2020 2020 2020 2020 2020  login.          
+000395c0: 2020 7061 7373 776f 7264 5f61 7661 696c    password_avail
+000395d0: 6162 6c65 203d 2022 6d2e 6c6f 6769 6e2e  able = "m.login.
+000395e0: 7061 7373 776f 7264 2220 696e 2066 6c6f  password" in flo
+000395f0: 775f 7479 7065 730a 2020 2020 2020 2020  w_types.        
+00039600: 2020 2020 7373 6f5f 6176 6169 6c61 626c      sso_availabl
+00039610: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
+00039620: 2020 2020 2020 226d 2e6c 6f67 696e 2e73        "m.login.s
+00039630: 736f 2220 696e 2066 6c6f 775f 7479 7065  so" in flow_type
+00039640: 7320 616e 6420 226d 2e6c 6f67 696e 2e74  s and "m.login.t
+00039650: 6f6b 656e 2220 696e 2066 6c6f 775f 7479  oken" in flow_ty
+00039660: 7065 730a 2020 2020 2020 2020 2020 2020  pes.            
+00039670: 290a 0a20 2020 2069 6620 6d65 7468 6f64  )..    if method
+00039680: 203d 3d20 2273 736f 2220 616e 6420 6e6f   == "sso" and no
+00039690: 7420 7373 6f5f 6176 6169 6c61 626c 653a  t sso_available:
+000396a0: 0a20 2020 2020 2020 2072 6169 7365 204d  .        raise M
+000396b0: 6174 7269 7843 6f6d 6d61 6e64 6572 4572  atrixCommanderEr
+000396c0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+000396d0: 2022 4532 3239 3a20 220a 2020 2020 2020   "E229: ".      
+000396e0: 2020 2020 2020 224d 6574 686f 6420 2773        "Method 's
+000396f0: 736f 2720 7761 7320 7365 6c65 6374 6564  so' was selected
+00039700: 2066 6f72 202d 2d6c 6f67 696e 2062 7574   for --login but
+00039710: 204d 6174 7269 7820 7365 7276 6572 2064   Matrix server d
+00039720: 6f65 7320 220a 2020 2020 2020 2020 2020  oes ".          
+00039730: 2020 226e 6f74 2073 7570 706f 7274 2053    "not support S
+00039740: 696e 676c 6520 5369 676e 2d4f 6e2e 2054  ingle Sign-On. T
+00039750: 7279 202d 2d6c 6f67 696e 2077 6974 6820  ry --login with 
+00039760: 6d65 7468 6f64 2027 7061 7373 776f 7264  method 'password
+00039770: 272e 220a 2020 2020 2020 2020 2920 6672  '.".        ) fr
+00039780: 6f6d 204e 6f6e 650a 2020 2020 6966 206d  om None.    if m
+00039790: 6574 686f 6420 3d3d 2022 7061 7373 776f  ethod == "passwo
+000397a0: 7264 2220 616e 6420 6e6f 7420 7061 7373  rd" and not pass
+000397b0: 776f 7264 5f61 7661 696c 6162 6c65 3a0a  word_available:.
+000397c0: 2020 2020 2020 2020 7261 6973 6520 4d61          raise Ma
+000397d0: 7472 6978 436f 6d6d 616e 6465 7245 7272  trixCommanderErr
+000397e0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+000397f0: 2245 3233 303a 2022 0a20 2020 2020 2020  "E230: ".       
+00039800: 2020 2020 2022 4d65 7468 6f64 2027 7061       "Method 'pa
+00039810: 7373 776f 7264 2720 7761 7320 7365 6c65  ssword' was sele
+00039820: 6374 6564 2066 6f72 202d 2d6c 6f67 696e  cted for --login
+00039830: 2062 7574 204d 6174 7269 7820 7365 7276   but Matrix serv
+00039840: 6572 2022 0a20 2020 2020 2020 2020 2020  er ".           
+00039850: 2022 646f 6573 206e 6f74 2073 7570 706f   "does not suppo
+00039860: 7274 2070 6173 7377 6f72 6420 6c6f 6769  rt password logi
+00039870: 6e2e 2054 7279 202d 2d6c 6f67 696e 2077  n. Try --login w
+00039880: 6974 6820 6d65 7468 6f64 2027 7373 6f27  ith method 'sso'
+00039890: 2e22 0a20 2020 2020 2020 2029 2066 726f  .".        ) fro
+000398a0: 6d20 4e6f 6e65 0a0a 2020 2020 2320 5353  m None..    # SS
+000398b0: 4f3a 2053 696e 676c 6520 5369 676e 2d4f  O: Single Sign-O
+000398c0: 6e3a 0a20 2020 2023 2073 6565 2068 7474  n:.    # see htt
+000398d0: 7073 3a2f 2f6d 6174 7269 782e 6f72 672f  ps://matrix.org/
+000398e0: 646f 6373 2f67 7569 6465 732f 7373 6f2d  docs/guides/sso-
+000398f0: 666f 722d 636c 6965 6e74 2d64 6576 656c  for-client-devel
+00039900: 6f70 6572 730a 2020 2020 6966 2073 736f  opers.    if sso
+00039910: 5f61 7661 696c 6162 6c65 3a0a 2020 2020  _available:.    
+00039920: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+00039930: 2822 5365 7276 6572 2073 7570 706f 7274  ("Server support
+00039940: 7320 5353 4f20 666f 7220 6c6f 6769 6e2e  s SSO for login.
+00039950: 2229 0a20 2020 2065 6c73 653a 0a20 2020  ").    else:.   
+00039960: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00039970: 6728 2253 6572 7665 7220 646f 6573 206e  g("Server does n
+00039980: 6f74 2073 7570 706f 7274 2053 534f 2066  ot support SSO f
+00039990: 6f72 206c 6f67 696e 2e22 290a 0a20 2020  or login.")..   
+000399a0: 2069 6620 6d65 7468 6f64 203d 3d20 2273   if method == "s
+000399b0: 736f 223a 0a20 2020 2020 2020 2023 2073  so":.        # s
+000399c0: 7461 7274 7570 2073 6572 7665 7220 746f  tartup server to
+000399d0: 2068 616e 646c 6520 7265 7370 6f6e 7365   handle response
+000399e0: 0a20 2020 2020 2020 2073 746f 705f 7365  .        stop_se
+000399f0: 7276 6572 5f65 7674 203d 2061 7379 6e63  rver_evt = async
+00039a00: 696f 2e45 7665 6e74 2829 0a20 2020 2020  io.Event().     
+00039a10: 2020 206c 6f67 696e 5f74 6f6b 656e 203d     login_token =
+00039a20: 204e 6f6e 650a 0a20 2020 2020 2020 2061   None..        a
+00039a30: 7379 6e63 2064 6566 2068 616e 646c 6528  sync def handle(
+00039a40: 7265 7175 6573 7429 3a0a 2020 2020 2020  request):.      
+00039a50: 2020 2020 2020 6e6f 6e6c 6f63 616c 206c        nonlocal l
+00039a60: 6f67 696e 5f74 6f6b 656e 0a20 2020 2020  ogin_token.     
+00039a70: 2020 2020 2020 206c 6f67 696e 5f74 6f6b         login_tok
+00039a80: 656e 203d 2072 6571 7565 7374 2e71 7565  en = request.que
+00039a90: 7279 2e67 6574 2822 6c6f 6769 6e54 6f6b  ry.get("loginTok
+00039aa0: 656e 2229 0a20 2020 2020 2020 2020 2020  en").           
+00039ab0: 2073 746f 705f 7365 7276 6572 5f65 7674   stop_server_evt
+00039ac0: 2e73 6574 2829 0a20 2020 2020 2020 2020  .set().         
+00039ad0: 2020 2072 6574 7572 6e20 7765 622e 5265     return web.Re
+00039ae0: 7370 6f6e 7365 280a 2020 2020 2020 2020  sponse(.        
+00039af0: 2020 2020 2020 2020 626f 6479 3d22 4c6f          body="Lo
+00039b00: 6769 6e20 636f 6d70 6c65 7465 2e20 596f  gin complete. Yo
+00039b10: 7520 6361 6e20 6e6f 7720 636c 6f73 6520  u can now close 
+00039b20: 7468 6973 2070 6167 652e 220a 2020 2020  this page.".    
+00039b30: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00039b40: 2020 2061 7070 203d 2077 6562 2e41 7070     app = web.App
+00039b50: 6c69 6361 7469 6f6e 2829 0a20 2020 2020  lication().     
+00039b60: 2020 2061 7070 2e61 6464 5f72 6f75 7465     app.add_route
+00039b70: 7328 5b77 6562 2e67 6574 2822 2f22 2c20  s([web.get("/", 
+00039b80: 6861 6e64 6c65 295d 290a 0a20 2020 2020  handle)])..     
+00039b90: 2020 206c 6f67 6769 6e67 2e67 6574 4c6f     logging.getLo
+00039ba0: 6767 6572 2822 6169 6f68 7474 702e 6163  gger("aiohttp.ac
+00039bb0: 6365 7373 2229 2e73 6574 4c65 7665 6c28  cess").setLevel(
+00039bc0: 6c6f 6767 696e 672e 5741 524e 494e 4729  logging.WARNING)
+00039bd0: 0a20 2020 2020 2020 2072 756e 6e65 7220  .        runner 
+00039be0: 3d20 7765 622e 4170 7052 756e 6e65 7228  = web.AppRunner(
+00039bf0: 6170 7029 0a20 2020 2020 2020 2061 7761  app).        awa
+00039c00: 6974 2072 756e 6e65 722e 7365 7475 7028  it runner.setup(
+00039c10: 290a 2020 2020 2020 2020 7369 7465 203d  ).        site =
+00039c20: 2077 6562 2e54 4350 5369 7465 2872 756e   web.TCPSite(run
+00039c30: 6e65 722c 2022 6c6f 6361 6c68 6f73 7422  ner, "localhost"
+00039c40: 2c20 3338 3038 3029 0a20 2020 2020 2020  , 38080).       
+00039c50: 2061 7761 6974 2073 6974 652e 7374 6172   await site.star
+00039c60: 7428 290a 0a20 2020 2020 2020 2074 7279  t()..        try
+00039c70: 3a0a 2020 2020 2020 2020 2020 2020 6773  :.            gs
+00039c80: 2e6c 6f67 2e69 6e66 6f28 224c 6175 6e63  .log.info("Launc
+00039c90: 6869 6e67 2062 726f 7773 6572 2074 6f20  hing browser to 
+00039ca0: 636f 6d70 6c65 7465 2053 534f 206c 6f67  complete SSO log
+00039cb0: 696e 2e22 290a 2020 2020 2020 2020 2020  in.").          
+00039cc0: 2020 6966 2067 732e 7061 2e70 726f 7879    if gs.pa.proxy
+00039cd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039ce0: 2020 6773 2e6c 6f67 2e77 6172 6e69 6e67    gs.log.warning
+00039cf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00039d00: 2020 2020 2020 2257 3131 303a 2022 0a20        "W110: ". 
+00039d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d20: 2020 2066 2253 7065 6369 6669 6564 2070     f"Specified p
+00039d30: 726f 7879 207b 6773 2e70 612e 7072 6f78  roxy {gs.pa.prox
+00039d40: 797d 2063 616e 6e6f 7420 220a 2020 2020  y} cannot ".    
+00039d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d60: 2262 6520 636f 6e66 6967 7572 6564 2066  "be configured f
+00039d70: 6f72 2062 726f 7773 6572 2e22 0a20 2020  or browser.".   
+00039d80: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00039d90: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00039da0: 732e 7761 726e 5f63 6f75 6e74 202b 3d20  s.warn_count += 
+00039db0: 310a 0a20 2020 2020 2020 2020 2020 2023  1..            #
+00039dc0: 206c 6175 6e63 6820 7765 622d 6272 6f77   launch web-brow
+00039dd0: 7365 720a 2020 2020 2020 2020 2020 2020  ser.            
+00039de0: 6966 2073 7973 2e70 6c61 7466 6f72 6d2e  if sys.platform.
+00039df0: 7374 6172 7473 7769 7468 2822 6461 7277  startswith("darw
+00039e00: 696e 2229 3a0a 2020 2020 2020 2020 2020  in"):.          
+00039e10: 2020 2020 2020 636d 6420 3d20 5b73 6875        cmd = [shu
+00039e20: 7469 6c2e 7768 6963 6828 226f 7065 6e22  til.which("open"
+00039e30: 295d 0a20 2020 2020 2020 2020 2020 2065  )].            e
+00039e40: 6c69 6620 7379 732e 706c 6174 666f 726d  lif sys.platform
+00039e50: 2e73 7461 7274 7377 6974 6828 2277 696e  .startswith("win
+00039e60: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00039e70: 2020 2020 636d 6420 3d20 5b22 7374 6172      cmd = ["star
+00039e80: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
+00039e90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00039ea0: 2020 2020 2020 636d 6420 3d20 5b73 6875        cmd = [shu
+00039eb0: 7469 6c2e 7768 6963 6828 2278 6467 2d6f  til.which("xdg-o
+00039ec0: 7065 6e22 295d 0a20 2020 2020 2020 2020  pen")].         
+00039ed0: 2020 2020 2020 2069 6620 636d 6420 3d3d         if cmd ==
+00039ee0: 205b 4e6f 6e65 5d3a 0a20 2020 2020 2020   [None]:.       
+00039ef0: 2020 2020 2020 2020 2020 2020 2063 6d64               cmd
+00039f00: 203d 205b 7368 7574 696c 2e77 6869 6368   = [shutil.which
+00039f10: 2822 782d 7777 772d 6272 6f77 7365 7222  ("x-www-browser"
+00039f20: 295d 0a20 2020 2020 2020 2020 2020 2063  )].            c
+00039f30: 6d64 2e61 7070 656e 6428 0a20 2020 2020  md.append(.     
+00039f40: 2020 2020 2020 2020 2020 2066 227b 686f             f"{ho
+00039f50: 6d65 7365 7276 6572 7d2f 5f6d 6174 7269  meserver}/_matri
+00039f60: 782f 636c 6965 6e74 2f72 302f 6c6f 6769  x/client/r0/logi
+00039f70: 6e2f 7373 6f2f 7265 6469 7265 6374 220a  n/sso/redirect".
+00039f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039f90: 223f 7265 6469 7265 6374 5572 6c3d 6874  "?redirectUrl=ht
+00039fa0: 7470 3a2f 2f6c 6f63 616c 686f 7374 3a33  tp://localhost:3
+00039fb0: 3830 3830 2f22 0a20 2020 2020 2020 2020  8080/".         
+00039fc0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00039fd0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00039fe0: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+00039ff0: 2e63 6865 636b 5f6f 7574 7075 7428 636d  .check_output(cm
+0003a000: 6429 0a20 2020 2020 2020 2020 2020 2065  d).            e
+0003a010: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+0003a020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a030: 2067 732e 6c6f 672e 6572 726f 7228 0a20   gs.log.error(. 
+0003a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a050: 2020 2022 4532 3331 3a20 220a 2020 2020     "E231: ".    
+0003a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a070: 2242 726f 7773 6572 2063 6f75 6c64 206e  "Browser could n
+0003a080: 6f74 2062 6520 6c61 756e 6368 6564 2e20  ot be launched. 
+0003a090: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0003a0a0: 2020 2020 2020 2248 656e 6365 2053 534f        "Hence SSO
+0003a0b0: 2028 5369 6e67 6c65 2053 6967 6e2d 4f6e   (Single Sign-On
+0003a0c0: 2920 6c6f 6769 6e20 636f 756c 6420 6e6f  ) login could no
+0003a0d0: 7420 6265 2022 0a20 2020 2020 2020 2020  t be ".         
+0003a0e0: 2020 2020 2020 2020 2020 2022 636f 6d70             "comp
+0003a0f0: 6c65 7465 642e 2053 6f72 7279 2e20 4966  leted. Sorry. If
+0003a100: 2079 6f75 2074 6869 6e6b 2074 6865 2062   you think the b
+0003a110: 726f 7773 6572 2061 6e64 2022 0a20 2020  rowser and ".   
+0003a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a130: 2022 5353 4f20 7368 6f75 6c64 2077 6f72   "SSO should wor
+0003a140: 6b20 7468 656e 2074 7279 2061 6761 696e  k then try again
+0003a150: 2e20 4966 2079 6f75 2064 6f20 6e6f 7420  . If you do not 
+0003a160: 6861 7665 2022 0a20 2020 2020 2020 2020  have ".         
+0003a170: 2020 2020 2020 2020 2020 2022 6120 6272             "a br
+0003a180: 6f77 7365 7220 6f72 2064 6f6e 2774 2077  owser or don't w
+0003a190: 616e 7420 5353 4f20 6f72 2077 616e 7420  ant SSO or want 
+0003a1a0: 746f 206c 6f67 696e 2077 6974 6820 6120  to login with a 
+0003a1b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0003a1c0: 2020 2020 2020 2270 6173 7377 6f72 6420        "password 
+0003a1d0: 696e 7374 6561 642c 2074 6865 6e20 7573  instead, then us
+0003a1e0: 6520 272d 2d6c 6f67 696e 2070 6173 7377  e '--login passw
+0003a1f0: 6f72 6427 2069 6e20 220a 2020 2020 2020  ord' in ".      
+0003a200: 2020 2020 2020 2020 2020 2020 2020 2274                "t
+0003a210: 6865 2063 6f6d 6d61 6e64 206c 696e 652e  he command line.
+0003a220: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0003a230: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0003a240: 2020 2020 7261 6973 650a 0a20 2020 2020      raise..     
+0003a250: 2020 2020 2020 2023 2077 6169 7420 616e         # wait an
+0003a260: 6420 7368 7574 646f 776e 2073 6572 7665  d shutdown serve
+0003a270: 720a 2020 2020 2020 2020 2020 2020 7472  r.            tr
+0003a280: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0003a290: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
+0003a2a0: 2e77 6169 745f 666f 7228 7374 6f70 5f73  .wait_for(stop_s
+0003a2b0: 6572 7665 725f 6576 742e 7761 6974 2829  erver_evt.wait()
+0003a2c0: 2c20 3520 2a20 3630 290a 2020 2020 2020  , 5 * 60).      
+0003a2d0: 2020 2020 2020 6578 6365 7074 2061 7379        except asy
+0003a2e0: 6e63 696f 2e54 696d 656f 7574 4572 726f  ncio.TimeoutErro
+0003a2f0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0003a300: 2020 2067 732e 6c6f 672e 6572 726f 7228     gs.log.error(
+0003a310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a320: 2020 2020 2022 4532 3332 3a20 220a 2020       "E232: ".  
+0003a330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a340: 2020 6622 5468 6520 7072 6f67 7261 6d20    f"The program 
+0003a350: 7b50 524f 475f 5749 5448 5f45 5854 7d20  {PROG_WITH_EXT} 
+0003a360: 6661 696c 6564 2e20 220a 2020 2020 2020  failed. ".      
+0003a370: 2020 2020 2020 2020 2020 2020 2020 224e                "N
+0003a380: 6f20 7265 7370 6f6e 7365 2077 6173 2072  o response was r
+0003a390: 6563 6569 7665 6420 6672 6f6d 2053 534f  eceived from SSO
+0003a3a0: 2070 726f 7669 6465 722e 2022 0a20 2020   provider. ".   
+0003a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a3c0: 2022 5468 6572 6520 7761 7320 6120 7469   "There was a ti
+0003a3d0: 6d65 6f75 742e 2053 6f72 7279 2e22 0a20  meout. Sorry.". 
+0003a3e0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0003a3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a400: 2072 6169 7365 0a20 2020 2020 2020 2066   raise.        f
+0003a410: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+0003a420: 2020 2020 6177 6169 7420 7275 6e6e 6572      await runner
+0003a430: 2e63 6c65 616e 7570 2829 0a0a 2020 2020  .cleanup()..    
+0003a440: 2320 436f 6e66 6967 7572 6174 696f 6e20  # Configuration 
+0003a450: 6f70 7469 6f6e 7320 666f 7220 7468 6520  options for the 
+0003a460: 4173 796e 6343 6c69 656e 740a 2020 2020  AsyncClient.    
+0003a470: 636c 6965 6e74 5f63 6f6e 6669 6720 3d20  client_config = 
+0003a480: 4173 796e 6343 6c69 656e 7443 6f6e 6669  AsyncClientConfi
+0003a490: 6728 0a20 2020 2020 2020 206d 6178 5f6c  g(.        max_l
+0003a4a0: 696d 6974 5f65 7863 6565 6465 643d 302c  imit_exceeded=0,
+0003a4b0: 0a20 2020 2020 2020 206d 6178 5f74 696d  .        max_tim
+0003a4c0: 656f 7574 733d 302c 0a20 2020 2020 2020  eouts=0,.       
+0003a4d0: 2073 746f 7265 5f73 796e 635f 746f 6b65   store_sync_toke
+0003a4e0: 6e73 3d54 7275 652c 0a20 2020 2020 2020  ns=True,.       
+0003a4f0: 2065 6e63 7279 7074 696f 6e5f 656e 6162   encryption_enab
+0003a500: 6c65 643d 5472 7565 2c0a 2020 2020 290a  led=True,.    ).
+0003a510: 0a20 2020 2073 746f 7265 5f63 7265 6174  .    store_creat
+0003a520: 6528 7374 6f72 655f 6469 7229 0a0a 2020  e(store_dir)..  
+0003a530: 2020 2320 496e 6974 6961 6c69 7a65 2074    # Initialize t
+0003a540: 6865 206d 6174 7269 7820 636c 6965 6e74  he matrix client
+0003a550: 0a20 2020 2063 6c69 656e 7420 3d20 4173  .    client = As
+0003a560: 796e 6343 6c69 656e 7428 0a20 2020 2020  yncClient(.     
+0003a570: 2020 2068 6f6d 6573 6572 7665 722c 0a20     homeserver,. 
+0003a580: 2020 2020 2020 2022 2220 6966 206e 6f74         "" if not
+0003a590: 2075 7365 725f 6964 2065 6c73 6520 7573   user_id else us
+0003a5a0: 6572 5f69 642c 0a20 2020 2020 2020 2073  er_id,.        s
+0003a5b0: 746f 7265 5f70 6174 683d 7374 6f72 655f  tore_path=store_
+0003a5c0: 6469 722c 0a20 2020 2020 2020 2063 6f6e  dir,.        con
+0003a5d0: 6669 673d 636c 6965 6e74 5f63 6f6e 6669  fig=client_confi
+0003a5e0: 672c 0a20 2020 2020 2020 2073 736c 3d67  g,.        ssl=g
+0003a5f0: 732e 7373 6c2c 0a20 2020 2020 2020 2070  s.ssl,.        p
+0003a600: 726f 7879 3d67 732e 7061 2e70 726f 7879  roxy=gs.pa.proxy
+0003a610: 2c0a 2020 2020 290a 2020 2020 7472 793a  ,.    ).    try:
+0003a620: 0a20 2020 2020 2020 2069 6620 6d65 7468  .        if meth
+0003a630: 6f64 203d 3d20 2273 736f 223a 0a20 2020  od == "sso":.   
+0003a640: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+0003a650: 6177 6169 7420 636c 6965 6e74 2e6c 6f67  await client.log
+0003a660: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+0003a670: 2020 2020 746f 6b65 6e3d 6c6f 6769 6e5f      token=login_
+0003a680: 746f 6b65 6e2c 2064 6576 6963 655f 6e61  token, device_na
+0003a690: 6d65 3d64 6576 6963 655f 6e61 6d65 0a20  me=device_name. 
+0003a6a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003a6b0: 2020 2020 2065 6c69 6620 6d65 7468 6f64       elif method
+0003a6c0: 203d 3d20 2270 6173 7377 6f72 6422 3a0a   == "password":.
+0003a6d0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+0003a6e0: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
+0003a6f0: 6c6f 6769 6e28 7061 7373 776f 7264 2c20  login(password, 
+0003a700: 6465 7669 6365 5f6e 616d 653d 6465 7669  device_name=devi
+0003a710: 6365 5f6e 616d 6529 0a0a 2020 2020 2020  ce_name)..      
+0003a720: 2020 2320 6368 6563 6b20 7468 6174 2077    # check that w
+0003a730: 6520 6c6f 6767 6564 2069 6e20 7375 6363  e logged in succ
+0003a740: 6573 6675 6c6c 790a 2020 2020 2020 2020  esfully.        
+0003a750: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+0003a760: 7370 2c20 4c6f 6769 6e52 6573 706f 6e73  sp, LoginRespons
+0003a770: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0003a780: 2320 7768 656e 2077 7269 7469 6e67 2c20  # when writing, 
+0003a790: 616c 7761 7973 2077 7269 7465 2074 6f20  always write to 
+0003a7a0: 7072 696d 6172 7920 6c6f 6361 7469 6f6e  primary location
+0003a7b0: 2028 652e 672e 202e 290a 2020 2020 2020   (e.g. .).      
+0003a7c0: 2020 2020 2020 7772 6974 655f 6372 6564        write_cred
+0003a7d0: 656e 7469 616c 735f 746f 5f64 6973 6b28  entials_to_disk(
+0003a7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a7f0: 2068 6f6d 6573 6572 7665 722c 0a20 2020   homeserver,.   
+0003a800: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0003a810: 702e 7573 6572 5f69 642c 0a20 2020 2020  p.user_id,.     
+0003a820: 2020 2020 2020 2020 2020 2072 6573 702e             resp.
+0003a830: 6465 7669 6365 5f69 642c 2020 2320 6e6f  device_id,  # no
+0003a840: 7465 2074 6869 7320 6973 2061 6e20 6964  te this is an id
+0003a850: 2c20 6e6f 7420 6120 6e61 6d65 210a 2020  , not a name!.  
+0003a860: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0003a870: 7370 2e61 6363 6573 735f 746f 6b65 6e2c  sp.access_token,
+0003a880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a890: 2072 6f6f 6d5f 6964 2c0a 2020 2020 2020   room_id,.      
+0003a8a0: 2020 2020 2020 2020 2020 6773 2e70 612e            gs.pa.
+0003a8b0: 6372 6564 656e 7469 616c 732c 0a20 2020  credentials,.   
+0003a8c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0003a8d0: 2020 2020 2020 2067 732e 636c 6965 6e74         gs.client
+0003a8e0: 203d 2063 6c69 656e 740a 2020 2020 2020   = client.      
+0003a8f0: 2020 2020 2020 6773 2e63 7265 6465 6e74        gs.credent
+0003a900: 6961 6c73 203d 2072 6561 645f 6372 6564  ials = read_cred
+0003a910: 656e 7469 616c 735f 6672 6f6d 5f64 6973  entials_from_dis
+0003a920: 6b28 6372 6564 656e 7469 616c 735f 6669  k(credentials_fi
+0003a930: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
+0003a940: 7478 7420 3d20 280a 2020 2020 2020 2020  txt = (.        
+0003a950: 2020 2020 2020 2020 2245 3233 333a 2022          "E233: "
+0003a960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a970: 2066 224c 6f67 2069 6e20 7573 696e 6720   f"Log in using 
+0003a980: 6d65 7468 6f64 2027 7b6d 6574 686f 647d  method '{method}
+0003a990: 2720 7761 7320 7375 6363 6573 7366 756c  ' was successful
+0003a9a0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0003a9b0: 2020 2020 6622 4372 6564 656e 7469 616c      f"Credential
+0003a9c0: 7320 7765 7265 2073 746f 7265 6420 696e  s were stored in
+0003a9d0: 2066 696c 6520 277b 6773 2e70 612e 6372   file '{gs.pa.cr
+0003a9e0: 6564 656e 7469 616c 737d 272e 2022 0a20  edentials}'. ". 
+0003a9f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003aa00: 2246 726f 6d20 6e6f 7720 6f6e 2079 6f75  "From now on you
+0003aa10: 2063 616e 2072 756e 2070 726f 6772 616d   can run program
+0003aa20: 2027 7b50 524f 475f 5749 5448 5f45 5854   '{PROG_WITH_EXT
+0003aa30: 7d27 2022 0a20 2020 2020 2020 2020 2020  }' ".           
+0003aa40: 2020 2020 2022 7769 7468 6f75 7420 6c6f       "without lo
+0003aa50: 6720 696e 2c20 6173 2061 6e20 6163 6365  g in, as an acce
+0003aa60: 7373 2074 6f6b 656e 2069 7320 7374 6f72  ss token is stor
+0003aa70: 6564 2069 6e20 796f 7572 2022 0a20 2020  ed in your ".   
+0003aa80: 2020 2020 2020 2020 2020 2020 2022 6372               "cr
+0003aa90: 6564 656e 7469 616c 7320 6669 6c65 2e20  edentials file. 
+0003aaa0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0003aab0: 2020 2249 6620 796f 7520 706c 616e 206f    "If you plan o
+0003aac0: 6e20 6861 7669 6e67 206d 616e 7920 6372  n having many cr
+0003aad0: 6564 656e 7469 616c 2066 696c 6573 2c20  edential files, 
+0003aae0: 636f 6e73 6964 6572 2022 0a20 2020 2020  consider ".     
+0003aaf0: 2020 2020 2020 2020 2020 2066 226d 6f76             f"mov
+0003ab00: 696e 6720 7468 656d 2074 6f20 6469 7265  ing them to dire
+0003ab10: 6374 6f72 7920 277b 4352 4544 454e 5449  ctory '{CREDENTI
+0003ab20: 414c 535f 4449 525f 4c41 5354 5245 534f  ALS_DIR_LASTRESO
+0003ab30: 5254 7d27 2e22 0a20 2020 2020 2020 2020  RT}'.".         
+0003ab40: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003ab50: 2067 732e 6c6f 672e 696e 666f 2874 7874   gs.log.info(txt
+0003ab60: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0003ab70: 2020 2020 2020 2020 2020 2020 2320 6973              # is
+0003ab80: 696e 7374 616e 6365 2872 6573 702c 204c  instance(resp, L
+0003ab90: 6f67 696e 4572 726f 7229 203d 3d20 7472  oginError) == tr
+0003aba0: 7565 0a20 2020 2020 2020 2020 2020 2023  ue.            #
+0003abb0: 2063 6c65 616e 7570 0a20 2020 2020 2020   cleanup.       
+0003abc0: 2020 2020 2061 7761 6974 2063 6c69 656e       await clien
+0003abd0: 742e 636c 6f73 6528 2920 2023 206e 6f74  t.close()  # not
+0003abe0: 2079 6574 2069 6e20 6773 2e0a 2020 2020   yet in gs..    
+0003abf0: 2020 2020 2020 2020 7374 6f72 655f 6465          store_de
+0003ac00: 6c65 7465 2873 746f 7265 5f64 6972 2920  lete(store_dir) 
+0003ac10: 2023 2065 6d70 7479 2c20 6a75 7374 2063   # empty, just c
+0003ac20: 7265 6174 6564 0a20 2020 2020 2020 2020  reated.         
+0003ac30: 2020 2023 2072 6573 7020 646f 6573 206e     # resp does n
+0003ac40: 6f74 2063 6f6e 7461 696e 2073 6563 7265  ot contain secre
+0003ac50: 7473 0a20 2020 2020 2020 2020 2020 2023  ts.            #
+0003ac60: 2072 6573 7020 6973 3a20 6d65 7373 6167   resp is: messag
+0003ac70: 653d 2249 6e76 616c 6964 2075 7365 726e  e="Invalid usern
+0003ac80: 616d 6520 6f72 2070 6173 7377 6f72 6422  ame or password"
+0003ac90: 2c20 636f 6465 3d4d 5f46 4f52 4249 4444  , code=M_FORBIDD
+0003aca0: 454e 0a20 2020 2020 2020 2020 2020 2074  EN.            t
+0003acb0: 7874 203d 2028 0a20 2020 2020 2020 2020  xt = (.         
+0003acc0: 2020 2020 2020 2022 4532 3334 3a20 220a         "E234: ".
+0003acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ace0: 224c 6f67 2069 6e20 6661 696c 6564 2e20  "Log in failed. 
+0003acf0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0003ad00: 2020 224d 6f73 7420 6c69 6b65 6c79 2077    "Most likely w
+0003ad10: 726f 6e67 2063 7265 6465 6e74 6961 6c73  rong credentials
+0003ad20: 2077 6572 6520 656e 7465 7265 642e 2022   were entered. "
+0003ad30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ad40: 2066 2268 6f6d 6573 6572 7665 723d 277b   f"homeserver='{
+0003ad50: 686f 6d65 7365 7276 6572 7d27 3b20 6465  homeserver}'; de
+0003ad60: 7669 6365 206e 616d 653d 277b 6465 7669  vice name='{devi
+0003ad70: 6365 5f6e 616d 657d 273b 2022 0a20 2020  ce_name}'; ".   
+0003ad80: 2020 2020 2020 2020 2020 2020 2066 2275               f"u
+0003ad90: 7365 723d 277b 7573 6572 5f69 647d 273b  ser='{user_id}';
+0003ada0: 2072 6f6f 6d5f 6964 3d27 7b72 6f6f 6d5f   room_id='{room_
+0003adb0: 6964 7d27 2e20 220a 2020 2020 2020 2020  id}'. ".        
+0003adc0: 2020 2020 2020 2020 6622 4661 696c 6564          f"Failed
+0003add0: 2074 6f20 6c6f 6720 696e 3a20 7b72 6573   to log in: {res
+0003ade0: 702e 6d65 7373 6167 657d 2c20 7b73 7472  p.message}, {str
+0003adf0: 2872 6573 702e 7374 6174 7573 5f63 6f64  (resp.status_cod
+0003ae00: 6529 7d22 0a20 2020 2020 2020 2020 2020  e)}".           
+0003ae10: 2029 0a20 2020 2020 2020 2020 2020 2067   ).            g
+0003ae20: 732e 6572 725f 636f 756e 7420 2b3d 2031  s.err_count += 1
+0003ae30: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0003ae40: 7365 204d 6174 7269 7843 6f6d 6d61 6e64  se MatrixCommand
+0003ae50: 6572 4572 726f 7228 7478 7429 0a20 2020  erError(txt).   
+0003ae60: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0003ae70: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+0003ae80: 7478 7420 3d20 280a 2020 2020 2020 2020  txt = (.        
+0003ae90: 2020 2020 2245 3233 353a 2022 0a20 2020      "E235: ".   
+0003aea0: 2020 2020 2020 2020 2022 4c6f 6720 696e           "Log in
+0003aeb0: 2066 6169 6c65 642e 2053 6f72 7279 2e22   failed. Sorry."
+0003aec0: 0a20 2020 2020 2020 2020 2020 2066 2268  .            f"h
+0003aed0: 6f6d 6573 6572 7665 723d 277b 686f 6d65  omeserver='{home
+0003aee0: 7365 7276 6572 7d27 3b20 6465 7669 6365  server}'; device
+0003aef0: 206e 616d 653d 277b 6465 7669 6365 5f6e   name='{device_n
+0003af00: 616d 657d 273b 2022 0a20 2020 2020 2020  ame}'; ".       
+0003af10: 2020 2020 2066 2275 7365 723d 277b 7573       f"user='{us
+0003af20: 6572 5f69 647d 273b 2072 6f6f 6d5f 6964  er_id}'; room_id
+0003af30: 3d27 7b72 6f6f 6d5f 6964 7d27 2e20 220a  ='{room_id}'. ".
+0003af40: 2020 2020 2020 2020 2020 2020 6622 4661              f"Fa
+0003af50: 696c 6564 2074 6f20 6c6f 6720 696e 3a20  iled to log in: 
+0003af60: 7b65 7d22 0a20 2020 2020 2020 2029 0a20  {e}".        ). 
+0003af70: 2020 2020 2020 2023 2067 732e 6572 725f         # gs.err_
+0003af80: 636f 756e 7420 2b3d 2031 2020 2320 646f  count += 1  # do
+0003af90: 6e27 7420 696e 6372 656d 656e 7420 7369  n't increment si
+0003afa0: 6e63 6520 6e6f 7420 4d61 7472 6978 436f  nce not MatrixCo
+0003afb0: 6d6d 616e 6465 7245 7272 6f72 0a20 2020  mmanderError.   
+0003afc0: 2020 2020 2072 6169 7365 0a20 2020 2023       raise.    #
+0003afd0: 2077 6520 6172 6520 6e6f 7720 6175 7468   we are now auth
+0003afe0: 656e 7469 6361 7465 642c 2077 6520 6172  enticated, we ar
+0003aff0: 6520 6e6f 7720 6c6f 6767 6564 2069 6e0a  e now logged in.
+0003b000: 2020 2020 2320 6773 206e 6f77 2068 6173      # gs now has
+0003b010: 2063 6c69 656e 7420 616e 6420 6372 6564   client and cred
+0003b020: 656e 7469 616c 732c 206e 6565 6465 6420  entials, needed 
+0003b030: 6279 2066 7572 7468 6572 2061 6374 696f  by further actio
+0003b040: 6e73 0a0a 0a61 7379 6e63 2064 6566 2069  ns...async def i
+0003b050: 6d70 6c69 6369 745f 6c6f 6769 6e28 2920  mplicit_login() 
+0003b060: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0003b070: 4c6f 6720 696e 2075 7369 6e67 2063 7265  Log in using cre
+0003b080: 6465 6e74 6961 6c73 2066 696c 6520 616e  dentials file an
+0003b090: 6420 7265 6d61 696e 206c 6f67 6765 6420  d remain logged 
+0003b0a0: 696e 2e22 2222 0a20 2020 2063 6c69 656e  in.""".    clien
+0003b0b0: 742c 2063 7265 6465 6e74 6961 6c73 203d  t, credentials =
+0003b0c0: 2061 7761 6974 206c 6f67 696e 5f75 7369   await login_usi
+0003b0d0: 6e67 5f63 7265 6465 6e74 6961 6c73 5f66  ng_credentials_f
+0003b0e0: 696c 6528 290a 2020 2020 6773 2e63 6c69  ile().    gs.cli
+0003b0f0: 656e 7420 3d20 636c 6965 6e74 0a20 2020  ent = client.   
+0003b100: 2067 732e 6372 6564 656e 7469 616c 7320   gs.credentials 
+0003b110: 3d20 6372 6564 656e 7469 616c 730a 0a0a  = credentials...
+0003b120: 6465 6620 726f 6f6d 735f 746f 5f6c 6f6e  def rooms_to_lon
+0003b130: 675f 726f 6f6d 5f6e 616d 6573 2829 202d  g_room_names() -
+0003b140: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2243  > None:.    """C
+0003b150: 6f6e 7665 7274 2066 6f6f 2074 6f20 2366  onvert foo to #f
+0003b160: 6f6f 3a65 7861 6d70 6c65 2e63 6f6d 2069  oo:example.com i
+0003b170: 6e20 6773 2e70 612e 726f 6f6d 2077 6865  n gs.pa.room whe
+0003b180: 7265 206e 6563 6573 7361 7279 2e22 2222  re necessary."""
+0003b190: 0a20 2020 2069 6620 6773 2e70 612e 726f  .    if gs.pa.ro
+0003b1a0: 6f6d 3a0a 2020 2020 2020 2020 6c6f 6e67  om:.        long
+0003b1b0: 5f72 6f6f 6d73 203d 205b 5d0a 2020 2020  _rooms = [].    
+0003b1c0: 2020 2020 666f 7220 726f 6f6d 2069 6e20      for room in 
+0003b1d0: 6773 2e70 612e 726f 6f6d 3a0a 2020 2020  gs.pa.room:.    
+0003b1e0: 2020 2020 2020 2020 6966 2069 735f 7368          if is_sh
+0003b1f0: 6f72 745f 726f 6f6d 5f61 6c69 6173 2872  ort_room_alias(r
+0003b200: 6f6f 6d29 3a0a 2020 2020 2020 2020 2020  oom):.          
+0003b210: 2020 2020 2020 6c6f 6e67 5f72 6f6f 6d73        long_rooms
+0003b220: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+0003b230: 2020 2020 2020 2020 2020 2020 2073 686f               sho
+0003b240: 7274 5f72 6f6f 6d5f 616c 6961 735f 746f  rt_room_alias_to
+0003b250: 5f72 6f6f 6d5f 616c 6961 7328 726f 6f6d  _room_alias(room
+0003b260: 2c20 6773 2e63 7265 6465 6e74 6961 6c73  , gs.credentials
+0003b270: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003b280: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0003b290: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003b2a0: 2020 2020 2020 6c6f 6e67 5f72 6f6f 6d73        long_rooms
+0003b2b0: 2e61 7070 656e 6428 726f 6f6d 290a 2020  .append(room).  
+0003b2c0: 2020 2020 2020 6773 2e70 612e 726f 6f6d        gs.pa.room
+0003b2d0: 203d 206c 6f6e 675f 726f 6f6d 730a 0a0a   = long_rooms...
+0003b2e0: 6173 796e 6320 6465 6620 6173 796e 635f  async def async_
+0003b2f0: 6d61 696e 2829 202d 3e20 4e6f 6e65 3a0a  main() -> None:.
+0003b300: 2020 2020 2222 2252 756e 206d 6169 6e20      """Run main 
+0003b310: 6675 6e63 7469 6f6e 7320 6265 696e 6720  functions being 
+0003b320: 696e 7369 6465 2074 6865 2065 7665 6e74  inside the event
+0003b330: 206c 6f6f 702e 2222 220a 2020 2020 2320   loop.""".    # 
+0003b340: 6c6f 6769 6e20 6578 706c 6963 6974 6c79  login explicitly
+0003b350: 0a20 2020 2023 206c 6f67 696e 2069 6d70  .    # login imp
+0003b360: 6c69 6369 746c 790a 2020 2020 2320 7665  licitly.    # ve
+0003b370: 7269 6679 0a20 2020 2023 2073 6574 2c20  rify.    # set, 
+0003b380: 6765 742c 2072 6f6f 6d2c 0a20 2020 2023  get, room,.    #
+0003b390: 2073 656e 640a 2020 2020 2320 6c69 7374   send.    # list
+0003b3a0: 656e 0a20 2020 2023 206c 6f67 6f75 740a  en.    # logout.
+0003b3b0: 2020 2020 2320 636c 6f73 6520 636c 6965      # close clie
+0003b3c0: 6e74 0a20 2020 2023 2073 7973 2e61 7267  nt.    # sys.arg
+0003b3d0: 7620 6f72 6465 7269 6e67 3f20 2320 746f  v ordering? # to
+0003b3e0: 646f 0a20 2020 2074 7279 3a0a 2020 2020  do.    try:.    
+0003b3f0: 2020 2020 6966 2067 732e 7061 2e6c 6f67      if gs.pa.log
+0003b400: 696e 3a0a 2020 2020 2020 2020 2020 2020  in:.            
+0003b410: 6177 6169 7420 6163 7469 6f6e 5f6c 6f67  await action_log
+0003b420: 696e 2829 2020 2320 6578 706c 6963 6974  in()  # explicit
+0003b430: 206c 6f67 696e 0a20 2020 2020 2020 2065   login.        e
+0003b440: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003b450: 2061 7761 6974 2069 6d70 6c69 6369 745f   await implicit_
+0003b460: 6c6f 6769 6e28 290a 2020 2020 2020 2020  login().        
+0003b470: 6966 2067 732e 7061 2e76 6572 6966 793a  if gs.pa.verify:
+0003b480: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0003b490: 6974 2061 6374 696f 6e5f 7665 7269 6679  it action_verify
+0003b4a0: 2829 0a20 2020 2020 2020 2020 2020 2067  ().            g
+0003b4b0: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+0003b4c0: 2020 2020 2020 2020 2020 2020 2022 4b65               "Ke
+0003b4d0: 7962 6f61 7264 2069 6e74 6572 7275 7074  yboard interrupt
+0003b4e0: 2072 6563 6569 7665 6420 6166 7465 7220   received after 
+0003b4f0: 456d 6f6a 6920 7665 7269 6669 6361 7469  Emoji verificati
+0003b500: 6f6e 2e22 0a20 2020 2020 2020 2020 2020  on.".           
+0003b510: 2029 0a20 2020 2020 2020 2072 6f6f 6d73   ).        rooms
+0003b520: 5f74 6f5f 6c6f 6e67 5f72 6f6f 6d5f 6e61  _to_long_room_na
+0003b530: 6d65 7328 2920 2023 2063 6f6d 706c 6574  mes()  # complet
+0003b540: 6520 726f 6f6d 206e 616d 6573 0a20 2020  e room names.   
+0003b550: 2020 2020 2069 6620 6773 2e72 6f6f 6d5f       if gs.room_
+0003b560: 6163 7469 6f6e 206f 7220 6773 2e73 6574  action or gs.set
+0003b570: 6765 745f 6163 7469 6f6e 3a0a 2020 2020  get_action:.    
+0003b580: 2020 2020 2020 2020 6177 6169 7420 6163          await ac
+0003b590: 7469 6f6e 5f72 6f6f 6d73 6574 6765 7428  tion_roomsetget(
+0003b5a0: 290a 2020 2020 2020 2020 6966 2067 732e  ).        if gs.
+0003b5b0: 7365 6e64 5f61 6374 696f 6e3a 0a20 2020  send_action:.   
+0003b5c0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+0003b5d0: 6374 696f 6e5f 7365 6e64 2829 0a20 2020  ction_send().   
+0003b5e0: 2020 2020 2069 6620 6773 2e70 612e 726f       if gs.pa.ro
+0003b5f0: 6f6d 5f69 6e76 6974 6573 2061 6e64 2067  om_invites and g
+0003b600: 732e 7061 2e6c 6973 7465 6e20 6e6f 7420  s.pa.listen not 
+0003b610: 696e 2028 464f 5245 5645 522c 204f 4e43  in (FOREVER, ONC
+0003b620: 4529 3a0a 2020 2020 2020 2020 2020 2020  E):.            
+0003b630: 6177 6169 7420 6c69 7374 656e 5f69 6e76  await listen_inv
+0003b640: 6974 6573 5f6f 6e63 6528 6773 2e63 6c69  ites_once(gs.cli
+0003b650: 656e 7429 0a20 2020 2020 2020 2069 6620  ent).        if 
+0003b660: 6773 2e6c 6973 7465 6e5f 6163 7469 6f6e  gs.listen_action
+0003b670: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+0003b680: 6169 7420 6163 7469 6f6e 5f6c 6973 7465  ait action_liste
+0003b690: 6e28 290a 2020 2020 2020 2020 6966 2067  n().        if g
+0003b6a0: 732e 7061 2e6c 6f67 6f75 743a 0a20 2020  s.pa.logout:.   
+0003b6b0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+0003b6c0: 6374 696f 6e5f 6c6f 676f 7574 2829 0a20  ction_logout(). 
+0003b6d0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0003b6e0: 696f 6e3a 0a20 2020 2020 2020 2072 6169  ion:.        rai
+0003b6f0: 7365 0a20 2020 2066 696e 616c 6c79 3a0a  se.    finally:.
+0003b700: 2020 2020 2020 2020 6966 2067 732e 636c          if gs.cl
+0003b710: 6965 6e74 3a0a 2020 2020 2020 2020 2020  ient:.          
+0003b720: 2020 6177 6169 7420 6773 2e63 6c69 656e    await gs.clien
+0003b730: 742e 636c 6f73 6528 290a 0a0a 6465 6620  t.close()...def 
+0003b740: 6368 6563 6b5f 6172 675f 6669 6c65 735f  check_arg_files_
+0003b750: 7265 6164 6162 6c65 2829 202d 3e20 4e6f  readable() -> No
+0003b760: 6e65 3a0a 2020 2020 2222 2243 6865 636b  ne:.    """Check
+0003b770: 2069 6620 6669 6c65 7320 6672 6f6d 2063   if files from c
+0003b780: 6f6d 6d61 6e64 206c 696e 6520 6172 6520  ommand line are 
+0003b790: 7265 6164 6162 6c65 2e22 2222 0a20 2020  readable.""".   
+0003b7a0: 2061 7267 5f66 696c 6573 203d 2067 732e   arg_files = gs.
+0003b7b0: 7061 2e69 6d61 6765 2069 6620 6773 2e70  pa.image if gs.p
+0003b7c0: 612e 696d 6167 6520 656c 7365 205b 5d0a  a.image else [].
+0003b7d0: 2020 2020 6172 675f 6669 6c65 7320 2b3d      arg_files +=
+0003b7e0: 2067 732e 7061 2e61 7564 696f 2069 6620   gs.pa.audio if 
+0003b7f0: 6773 2e70 612e 6175 6469 6f20 656c 7365  gs.pa.audio else
+0003b800: 205b 5d0a 2020 2020 6172 675f 6669 6c65   [].    arg_file
+0003b810: 7320 2b3d 2067 732e 7061 2e66 696c 6520  s += gs.pa.file 
+0003b820: 6966 2067 732e 7061 2e66 696c 6520 656c  if gs.pa.file el
+0003b830: 7365 205b 5d0a 2020 2020 6172 675f 6669  se [].    arg_fi
+0003b840: 6c65 7320 2b3d 2067 732e 7061 2e65 7665  les += gs.pa.eve
+0003b850: 6e74 2069 6620 6773 2e70 612e 6576 656e  nt if gs.pa.even
+0003b860: 7420 656c 7365 205b 5d0a 2020 2020 7220  t else [].    r 
+0003b870: 3d20 5472 7565 0a20 2020 2065 7272 7478  = True.    errtx
+0003b880: 7420 3d20 280a 2020 2020 2020 2020 2245  t = (.        "E
+0003b890: 3233 363a 2022 0a20 2020 2020 2020 2022  236: ".        "
+0003b8a0: 5468 6573 6520 6669 6c65 7320 7370 6563  These files spec
+0003b8b0: 6966 6965 6420 696e 2074 6865 2063 6f6d  ified in the com
+0003b8c0: 6d61 6e64 206c 696e 6520 7765 7265 206e  mand line were n
+0003b8d0: 6f74 2066 6f75 6e64 2022 0a20 2020 2020  ot found ".     
+0003b8e0: 2020 2022 6f72 2061 7265 206e 6f74 2072     "or are not r
+0003b8f0: 6561 6461 626c 653a 2022 0a20 2020 2029  eadable: ".    )
+0003b900: 0a20 2020 2066 6f72 2066 6e20 696e 2061  .    for fn in a
+0003b910: 7267 5f66 696c 6573 3a0a 2020 2020 2020  rg_files:.      
+0003b920: 2020 6966 2028 666e 2021 3d20 222d 2229    if (fn != "-")
+0003b930: 2061 6e64 206e 6f74 2028 6973 6669 6c65   and not (isfile
+0003b940: 2866 6e29 2061 6e64 2061 6363 6573 7328  (fn) and access(
+0003b950: 666e 2c20 525f 4f4b 2929 3a0a 2020 2020  fn, R_OK)):.    
+0003b960: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
+0003b970: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003b980: 2020 6572 7274 7874 202b 3d20 222c 2022    errtxt += ", "
+0003b990: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+0003b9a0: 7478 7420 2b3d 2066 2722 7b66 6e7d 2227  txt += f'"{fn}"'
+0003b9b0: 0a20 2020 2020 2020 2020 2020 2072 203d  .            r =
+0003b9c0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+0003b9d0: 2020 2065 7272 6669 6c65 203d 2066 6e0a     errfile = fn.
+0003b9e0: 2020 2020 6966 206e 6f74 2072 3a0a 2020      if not r:.  
+0003b9f0: 2020 2020 2020 7261 6973 6520 4669 6c65        raise File
+0003ba00: 4e6f 7446 6f75 6e64 4572 726f 7228 6572  NotFoundError(er
+0003ba10: 726e 6f2e 454e 4f45 4e54 2c20 6572 7274  rno.ENOENT, errt
+0003ba20: 7874 2c20 6572 7266 696c 6529 0a0a 0a64  xt, errfile)...d
+0003ba30: 6566 2063 6865 636b 5f64 6f77 6e6c 6f61  ef check_downloa
+0003ba40: 645f 6d65 6469 615f 6469 7228 2920 2d3e  d_media_dir() ->
+0003ba50: 204e 6f6e 653a 0a20 2020 2022 2222 4368   None:.    """Ch
+0003ba60: 6563 6b20 6966 206d 6564 6961 2064 6f77  eck if media dow
+0003ba70: 6e6c 6f61 6420 6469 7265 6374 6f72 7920  nload directory 
+0003ba80: 6973 2063 6f72 7265 6374 2e22 2222 0a20  is correct.""". 
+0003ba90: 2020 2069 6620 6e6f 7420 6773 2e70 612e     if not gs.pa.
+0003baa0: 646f 776e 6c6f 6164 5f6d 6564 6961 3a0a  download_media:.
+0003bab0: 2020 2020 2020 2020 7265 7475 726e 2020          return  
+0003bac0: 2320 2222 3a20 7468 6174 206d 6561 6e73  # "": that means
+0003bad0: 206e 6f20 646f 776e 6c6f 6164 206f 6620   no download of 
+0003bae0: 6d65 6469 612c 2076 616c 6964 2076 616c  media, valid val
+0003baf0: 7565 0a20 2020 2023 206e 6f72 6d61 696c  ue.    # normail
+0003bb00: 7a65 6420 666f 7220 6875 6d61 6e73 0a20  zed for humans. 
+0003bb10: 2020 2064 6c20 3d20 6f73 2e70 6174 682e     dl = os.path.
+0003bb20: 6e6f 726d 7061 7468 2867 732e 7061 2e64  normpath(gs.pa.d
+0003bb30: 6f77 6e6c 6f61 645f 6d65 6469 6129 0a20  ownload_media). 
+0003bb40: 2020 2067 732e 7061 2e64 6f77 6e6c 6f61     gs.pa.downloa
+0003bb50: 645f 6d65 6469 6120 3d20 646c 0a20 2020  d_media = dl.   
+0003bb60: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+0003bb70: 6c65 2864 6c29 3a0a 2020 2020 2020 2020  le(dl):.        
+0003bb80: 7261 6973 6520 4e6f 7441 4469 7265 6374  raise NotADirect
+0003bb90: 6f72 7945 7272 6f72 280a 2020 2020 2020  oryError(.      
+0003bba0: 2020 2020 2020 6572 726e 6f2e 454e 4f54        errno.ENOT
+0003bbb0: 4449 522c 0a20 2020 2020 2020 2020 2020  DIR,.           
+0003bbc0: 2022 4532 3337 3a20 220a 2020 2020 2020   "E237: ".      
+0003bbd0: 2020 2020 2020 6627 227b 646c 7d22 2063        f'"{dl}" c
+0003bbe0: 616e 6e6f 7420 6265 2075 7365 6420 6173  annot be used as
+0003bbf0: 206d 6564 6961 2064 6972 6563 746f 7279   media directory
+0003bc00: 2c20 6265 6361 7573 6520 270a 2020 2020  , because '.    
+0003bc10: 2020 2020 2020 2020 6627 227b 646c 7d22          f'"{dl}"
+0003bc20: 2069 7320 6120 6669 6c65 2e20 5370 6563   is a file. Spec
+0003bc30: 6966 7920 6120 6469 6666 6572 656e 7420  ify a different 
+0003bc40: 6469 7265 6374 6f72 7920 666f 7220 646f  directory for do
+0003bc50: 776e 6c6f 6164 696e 6720 270a 2020 2020  wnloading '.    
+0003bc60: 2020 2020 2020 2020 226d 6564 6961 2e22          "media."
+0003bc70: 2c0a 2020 2020 2020 2020 2020 2020 646c  ,.            dl
+0003bc80: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0003bc90: 6966 206f 732e 7061 7468 2e69 7364 6972  if os.path.isdir
+0003bca0: 2864 6c29 3a0a 2020 2020 2020 2020 6966  (dl):.        if
+0003bcb0: 206f 732e 6163 6365 7373 2864 6c2c 206f   os.access(dl, o
+0003bcc0: 732e 575f 4f4b 293a 2020 2320 4368 6563  s.W_OK):  # Chec
+0003bcd0: 6b20 666f 7220 7772 6974 6520 6163 6365  k for write acce
+0003bce0: 7373 0a20 2020 2020 2020 2020 2020 2072  ss.            r
+0003bcf0: 6574 7572 6e20 2023 2061 6c6c 204f 4b0a  eturn  # all OK.
+0003bd00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003bd10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0003bd20: 5065 726d 6973 7369 6f6e 4572 726f 7228  PermissionError(
+0003bd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bd40: 2065 7272 6e6f 2e45 5045 524d 2c0a 2020   errno.EPERM,.  
+0003bd50: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+0003bd60: 3233 383a 2022 0a20 2020 2020 2020 2020  238: ".         
+0003bd70: 2020 2020 2020 2022 466f 756e 6420 616e         "Found an
+0003bd80: 2065 7869 7374 696e 6720 6d65 6469 6120   existing media 
+0003bd90: 646f 776e 6c6f 6164 2064 6972 6563 746f  download directo
+0003bda0: 7279 2022 0a20 2020 2020 2020 2020 2020  ry ".           
+0003bdb0: 2020 2020 2066 2722 7b64 6c7d 222e 2042       f'"{dl}". B
+0003bdc0: 7574 2074 6869 7320 6469 7265 6374 6f72  ut this director
+0003bdd0: 7920 6973 206c 6163 6b69 6e67 2077 7269  y is lacking wri
+0003bde0: 7465 2027 0a20 2020 2020 2020 2020 2020  te '.           
+0003bdf0: 2020 2020 2022 7065 726d 6973 7369 6f6e       "permission
+0003be00: 732e 2041 6464 2077 7269 7465 2070 6572  s. Add write per
+0003be10: 6d69 7373 696f 6e73 2074 6f20 6974 2e22  missions to it."
+0003be20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003be30: 2020 646c 2c0a 2020 2020 2020 2020 2020    dl,.          
+0003be40: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
+0003be50: 2020 2020 2020 2320 6e6f 7420 6120 6669        # not a fi
+0003be60: 6c65 2c20 6e6f 7420 6120 6469 7265 6374  le, not a direct
+0003be70: 6f72 792c 2063 7265 6174 6520 6469 7265  ory, create dire
+0003be80: 6374 6f72 790a 2020 2020 2020 2020 6d6f  ctory.        mo
+0003be90: 6465 203d 2030 6f37 3737 0a20 2020 2020  de = 0o777.     
+0003bea0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0003beb0: 2020 2020 6f73 2e6d 6b64 6972 2864 6c2c      os.mkdir(dl,
+0003bec0: 206d 6f64 6529 0a20 2020 2020 2020 2065   mode).        e
+0003bed0: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
+0003bee0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0003bef0: 7261 6973 6520 4f53 4572 726f 7228 0a20  raise OSError(. 
+0003bf00: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0003bf10: 2e65 7272 6e6f 2c0a 2020 2020 2020 2020  .errno,.        
+0003bf20: 2020 2020 2020 2020 2245 3233 393a 2022          "E239: "
+0003bf30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bf40: 2022 436f 756c 6420 6e6f 7420 6372 6561   "Could not crea
+0003bf50: 7465 206d 6564 6961 2064 6f77 6e6c 6f61  te media downloa
+0003bf60: 6420 6469 7265 6374 6f72 7920 220a 2020  d directory ".  
+0003bf70: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0003bf80: 7b64 6c7d 2066 6f72 2079 6f75 2e20 287b  {dl} for you. ({
+0003bf90: 657d 2922 2c0a 2020 2020 2020 2020 2020  e})",.          
+0003bfa0: 2020 2020 2020 646c 2c0a 2020 2020 2020        dl,.      
+0003bfb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0003bfc0: 6773 2e6c 6f67 2e64 6562 7567 2866 2743  gs.log.debug(f'C
+0003bfd0: 7265 6174 6564 206d 6564 6961 2064 6f77  reated media dow
+0003bfe0: 6e6c 6f61 6420 6469 7265 6374 6f72 7920  nload directory 
+0003bff0: 227b 646c 7d22 2066 6f72 2079 6f75 2e27  "{dl}" for you.'
+0003c000: 290a 0a0a 6465 6620 6368 6563 6b5f 7665  )...def check_ve
+0003c010: 7273 696f 6e28 2920 2d3e 204e 6f6e 653a  rsion() -> None:
+0003c020: 0a20 2020 2022 2222 4368 6563 6b20 6966  .    """Check if
+0003c030: 206c 6174 6573 7420 7665 7273 696f 6e2e   latest version.
+0003c040: 2222 220a 2020 2020 706b 6720 3d20 5052  """.    pkg = PR
+0003c050: 4f47 5f57 4954 484f 5554 5f45 5854 0a20  OG_WITHOUT_EXT. 
+0003c060: 2020 2076 6572 203d 2056 4552 5349 4f4e     ver = VERSION
+0003c070: 4e52 2020 2320 6465 6661 756c 742c 2066  NR  # default, f
+0003c080: 616c 6c62 6163 6b0a 2020 2020 7472 793a  allback.    try:
+0003c090: 0a20 2020 2020 2020 2076 6572 203d 2070  .        ver = p
+0003c0a0: 6b67 5f72 6573 6f75 7263 6573 2e67 6574  kg_resources.get
+0003c0b0: 5f64 6973 7472 6962 7574 696f 6e28 706b  _distribution(pk
+0003c0c0: 6729 2e76 6572 7369 6f6e 0a20 2020 2065  g).version.    e
+0003c0d0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+0003c0e0: 0a20 2020 2020 2020 2070 6173 7320 2023  .        pass  #
+0003c0f0: 2069 6620 696e 7374 616c 6c65 6420 7669   if installed vi
+0003c100: 6120 6769 7420 636c 6f6e 652c 2070 6163  a git clone, pac
+0003c110: 6b61 6765 2077 696c 6c20 6e6f 7420 6578  kage will not ex
+0003c120: 6973 7473 0a0a 2020 2020 696e 7374 616c  ists..    instal
+0003c130: 6c65 645f 7665 7273 696f 6e20 3d20 4c6f  led_version = Lo
+0003c140: 6f73 6556 6572 7369 6f6e 2876 6572 290a  oseVersion(ver).
+0003c150: 2020 2020 2320 6665 7463 6820 7061 636b      # fetch pack
+0003c160: 6167 6520 6d65 7461 6461 7461 2066 726f  age metadata fro
+0003c170: 6d20 5079 5049 0a20 2020 2070 7970 695f  m PyPI.    pypi_
+0003c180: 7572 6c20 3d20 6622 6874 7470 733a 2f2f  url = f"https://
+0003c190: 7079 7069 2e6f 7267 2f70 7970 692f 7b70  pypi.org/pypi/{p
+0003c1a0: 6b67 7d2f 6a73 6f6e 220a 2020 2020 7265  kg}/json".    re
+0003c1b0: 7370 6f6e 7365 203d 2075 726c 6c69 622e  sponse = urllib.
+0003c1c0: 7265 7175 6573 742e 7572 6c6f 7065 6e28  request.urlopen(
+0003c1d0: 7079 7069 5f75 726c 292e 7265 6164 2829  pypi_url).read()
+0003c1e0: 2e64 6563 6f64 6528 290a 2020 2020 6c61  .decode().    la
+0003c1f0: 7465 7374 5f76 6572 7369 6f6e 203d 206d  test_version = m
+0003c200: 6178 280a 2020 2020 2020 2020 4c6f 6f73  ax(.        Loos
+0003c210: 6556 6572 7369 6f6e 2873 2920 666f 7220  eVersion(s) for 
+0003c220: 7320 696e 206a 736f 6e2e 6c6f 6164 7328  s in json.loads(
+0003c230: 7265 7370 6f6e 7365 295b 2272 656c 6561  response)["relea
+0003c240: 7365 7322 5d2e 6b65 7973 2829 0a20 2020  ses"].keys().   
+0003c250: 2029 0a20 2020 2069 6620 696e 7374 616c   ).    if instal
+0003c260: 6c65 645f 7665 7273 696f 6e20 3e3d 206c  led_version >= l
+0003c270: 6174 6573 745f 7665 7273 696f 6e3a 0a20  atest_version:. 
+0003c280: 2020 2020 2020 2075 7464 203d 2022 596f         utd = "Yo
+0003c290: 7520 6172 6520 7570 2d74 6f2d 6461 7465  u are up-to-date
+0003c2a0: 2122 0a20 2020 2065 6c73 653a 0a20 2020  !".    else:.   
+0003c2b0: 2020 2020 2075 7464 203d 2022 436f 6e73       utd = "Cons
+0003c2c0: 6964 6572 2075 7064 6174 696e 6721 220a  ider updating!".
+0003c2d0: 2020 2020 7665 7273 696f 6e5f 696e 666f      version_info
+0003c2e0: 203d 2028 0a20 2020 2020 2020 2066 2270   = (.        f"p
+0003c2f0: 6163 6b61 6765 3a20 7b70 6b67 7d2c 2069  ackage: {pkg}, i
+0003c300: 6e73 7461 6c6c 6564 3a20 7b69 6e73 7461  nstalled: {insta
+0003c310: 6c6c 6564 5f76 6572 7369 6f6e 7d2c 2022  lled_version}, "
+0003c320: 0a20 2020 2020 2020 2066 226c 6174 6573  .        f"lates
+0003c330: 743a 207b 6c61 7465 7374 5f76 6572 7369  t: {latest_versi
+0003c340: 6f6e 7d20 3d3d 3e20 7b75 7464 7d22 0a20  on} ==> {utd}". 
+0003c350: 2020 2029 0a20 2020 2067 732e 6c6f 672e     ).    gs.log.
+0003c360: 6465 6275 6728 7665 7273 696f 6e5f 696e  debug(version_in
+0003c370: 666f 290a 2020 2020 2320 6f75 7470 7574  fo).    # output
+0003c380: 2066 6f72 6d61 7420 636f 6e74 726f 6c6c   format controll
+0003c390: 6564 2076 6961 202d 2d6f 7574 7075 7420  ed via --output 
+0003c3a0: 666c 6167 0a20 2020 2074 6578 7420 3d20  flag.    text = 
+0003c3b0: 7665 7273 696f 6e5f 696e 666f 0a20 2020  version_info.   
+0003c3c0: 206a 736f 6e5f 6d61 7820 3d20 7b0a 2020   json_max = {.  
+0003c3d0: 2020 2020 2020 2270 6163 6b61 6765 223a        "package":
+0003c3e0: 2066 227b 706b 677d 222c 0a20 2020 2020   f"{pkg}",.     
+0003c3f0: 2020 2022 7665 7273 696f 6e5f 696e 7374     "version_inst
+0003c400: 616c 6c65 6422 3a20 6622 7b69 6e73 7461  alled": f"{insta
+0003c410: 6c6c 6564 5f76 6572 7369 6f6e 7d22 2c0a  lled_version}",.
+0003c420: 2020 2020 2020 2020 2276 6572 7369 6f6e          "version
+0003c430: 5f6c 6174 6573 7422 3a20 6622 7b6c 6174  _latest": f"{lat
+0003c440: 6573 745f 7665 7273 696f 6e7d 222c 0a20  est_version}",. 
+0003c450: 2020 2020 2020 2022 636f 6d6d 656e 7422         "comment"
+0003c460: 3a20 6622 7b75 7464 7d22 2c0a 2020 2020  : f"{utd}",.    
+0003c470: 7d0a 2020 2020 2320 6a73 6f6e 5f6d 6178  }.    # json_max
+0003c480: 2e75 7064 6174 6528 7b22 6b65 7922 3a20  .update({"key": 
+0003c490: 7661 6c75 657d 2920 2023 2061 6464 2064  value})  # add d
+0003c4a0: 6963 7420 6974 656d 730a 2020 2020 6a73  ict items.    js
+0003c4b0: 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178 2e63  on_ = json_max.c
+0003c4c0: 6f70 7928 290a 2020 2020 2320 6a73 6f6e  opy().    # json
+0003c4d0: 5f2e 706f 7028 226b 6579 2229 0a20 2020  _.pop("key").   
+0003c4e0: 206a 736f 6e5f 7370 6563 203d 204e 6f6e   json_spec = Non
+0003c4f0: 650a 2020 2020 7072 696e 745f 6f75 7470  e.    print_outp
+0003c500: 7574 280a 2020 2020 2020 2020 6773 2e70  ut(.        gs.p
+0003c510: 612e 6f75 7470 7574 2c0a 2020 2020 2020  a.output,.      
+0003c520: 2020 7465 7874 3d74 6578 742c 0a20 2020    text=text,.   
+0003c530: 2020 2020 206a 736f 6e5f 3d6a 736f 6e5f       json_=json_
+0003c540: 2c0a 2020 2020 2020 2020 6a73 6f6e 5f6d  ,.        json_m
+0003c550: 6178 3d6a 736f 6e5f 6d61 782c 0a20 2020  ax=json_max,.   
+0003c560: 2020 2020 206a 736f 6e5f 7370 6563 3d6a       json_spec=j
+0003c570: 736f 6e5f 7370 6563 2c0a 2020 2020 290a  son_spec,.    ).
+0003c580: 0a0a 6465 6620 7665 7273 696f 6e28 2920  ..def version() 
+0003c590: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0003c5a0: 5072 696e 7420 7665 7273 696f 6e20 696e  Print version in
+0003c5b0: 666f 2e22 2222 0a20 2020 206e 696f 5f76  fo.""".    nio_v
+0003c5c0: 6572 7369 6f6e 203d 2070 6b67 5f72 6573  ersion = pkg_res
+0003c5d0: 6f75 7263 6573 2e67 6574 5f64 6973 7472  ources.get_distr
+0003c5e0: 6962 7574 696f 6e28 226d 6174 7269 782d  ibution("matrix-
+0003c5f0: 6e69 6f22 292e 7665 7273 696f 6e0a 2020  nio").version.  
+0003c600: 2020 7079 7468 6f6e 5f76 6572 7369 6f6e    python_version
+0003c610: 203d 2073 7973 2e76 6572 7369 6f6e 0a20   = sys.version. 
+0003c620: 2020 2070 7974 686f 6e5f 7665 7273 696f     python_versio
+0003c630: 6e5f 6e72 203d 2028 0a20 2020 2020 2020  n_nr = (.       
+0003c640: 2073 7472 2873 7973 2e76 6572 7369 6f6e   str(sys.version
+0003c650: 5f69 6e66 6f2e 6d61 6a6f 7229 0a20 2020  _info.major).   
+0003c660: 2020 2020 202b 2022 2e22 0a20 2020 2020       + ".".     
+0003c670: 2020 202b 2073 7472 2873 7973 2e76 6572     + str(sys.ver
+0003c680: 7369 6f6e 5f69 6e66 6f2e 6d69 6e6f 7229  sion_info.minor)
+0003c690: 0a20 2020 2020 2020 202b 2022 2e22 0a20  .        + ".". 
+0003c6a0: 2020 2020 2020 202b 2073 7472 2873 7973         + str(sys
+0003c6b0: 2e76 6572 7369 6f6e 5f69 6e66 6f2e 6d69  .version_info.mi
+0003c6c0: 6372 6f29 0a20 2020 2029 0a20 2020 2076  cro).    ).    v
+0003c6d0: 6572 7369 6f6e 5f69 6e66 6f20 3d20 280a  ersion_info = (.
+0003c6e0: 2020 2020 2020 2020 225c 6e22 0a20 2020          "\n".   
+0003c6f0: 2020 2020 2066 2220 205f 7c20 2020 2020       f"  _|     
+0003c700: 205f 7c20 2020 2020 205f 7c5f 7c5f 7c20   _|      _|_|_| 
+0003c710: 2020 205f 7c20 2020 2020 2020 7b50 524f     _|       {PRO
+0003c720: 475f 5749 5448 4f55 545f 4558 547d 3a20  G_WITHOUT_EXT}: 
+0003c730: 220a 2020 2020 2020 2020 6622 7b56 4552  ".        f"{VER
+0003c740: 5349 4f4e 4e52 7d20 7b56 4552 5349 4f4e  SIONNR} {VERSION
+0003c750: 7d5c 6e22 0a20 2020 2020 2020 2022 2020  }\n".        "  
+0003c760: 5f7c 5f7c 2020 5f7c 5f7c 2020 2020 5f7c  _|_|  _|_|    _|
+0003c770: 2020 2020 2020 2020 2020 2020 5f7c 2020              _|  
+0003c780: 2020 2061 204d 6174 7269 7820 434c 4920     a Matrix CLI 
+0003c790: 636c 6965 6e74 5c6e 220a 2020 2020 2020  client\n".      
+0003c7a0: 2020 2220 205f 7c20 205f 7c20 205f 7c20    "  _|  _|  _| 
+0003c7b0: 2020 205f 7c20 2020 2020 2020 2020 2020     _|           
+0003c7c0: 2020 205f 7c20 2020 656e 6a6f 7920 616e     _|   enjoy an
+0003c7d0: 6420 7375 626d 6974 2050 5273 5c6e 220a  d submit PRs\n".
+0003c7e0: 2020 2020 2020 2020 6622 2020 5f7c 2020          f"  _|  
+0003c7f0: 2020 2020 5f7c 2020 2020 5f7c 2020 2020      _|    _|    
+0003c800: 2020 2020 2020 2020 5f7c 2020 2020 206d          _|     m
+0003c810: 6174 7269 782d 6e69 6f3a 207b 6e69 6f5f  atrix-nio: {nio_
+0003c820: 7665 7273 696f 6e7d 5c6e 220a 2020 2020  version}\n".    
+0003c830: 2020 2020 6622 2020 5f7c 2020 2020 2020      f"  _|      
+0003c840: 5f7c 2020 2020 2020 5f7c 5f7c 5f7c 2020  _|      _|_|_|  
+0003c850: 2020 5f7c 2020 2020 2020 2050 7974 686f    _|       Pytho
+0003c860: 6e3a 207b 7079 7468 6f6e 5f76 6572 7369  n: {python_versi
+0003c870: 6f6e 5f6e 727d 5c6e 220a 2020 2020 2020  on_nr}\n".      
+0003c880: 2020 225c 6e22 0a20 2020 2029 0a20 2020    "\n".    ).   
+0003c890: 2067 732e 6c6f 672e 6465 6275 6728 7665   gs.log.debug(ve
+0003c8a0: 7273 696f 6e5f 696e 666f 290a 2020 2020  rsion_info).    
+0003c8b0: 2320 6f75 7470 7574 2066 6f72 6d61 7420  # output format 
+0003c8c0: 636f 6e74 726f 6c6c 6564 2076 6961 202d  controlled via -
+0003c8d0: 2d6f 7574 7075 7420 666c 6167 0a20 2020  -output flag.   
+0003c8e0: 2074 6578 7420 3d20 7665 7273 696f 6e5f   text = version_
+0003c8f0: 696e 666f 0a20 2020 206a 736f 6e5f 6d61  info.    json_ma
+0003c900: 7820 3d20 7b0a 2020 2020 2020 2020 6622  x = {.        f"
+0003c910: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+0003c920: 547d 223a 207b 0a20 2020 2020 2020 2020  T}": {.         
+0003c930: 2020 2022 7665 7273 696f 6e22 3a20 6622     "version": f"
+0003c940: 7b56 4552 5349 4f4e 4e52 7d22 2c0a 2020  {VERSIONNR}",.  
+0003c950: 2020 2020 2020 2020 2020 2264 6174 6522            "date"
+0003c960: 3a20 6622 7b56 4552 5349 4f4e 7d22 2c0a  : f"{VERSION}",.
+0003c970: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0003c980: 2020 2022 6d61 7472 6978 2d6e 696f 223a     "matrix-nio":
+0003c990: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+0003c9a0: 7665 7273 696f 6e22 3a20 6622 7b6e 696f  version": f"{nio
+0003c9b0: 5f76 6572 7369 6f6e 7d22 2c0a 2020 2020  _version}",.    
+0003c9c0: 2020 2020 7d2c 0a20 2020 2020 2020 2022      },.        "
+0003c9d0: 7079 7468 6f6e 223a 207b 0a20 2020 2020  python": {.     
+0003c9e0: 2020 2020 2020 2022 7665 7273 696f 6e22         "version"
+0003c9f0: 3a20 6622 7b70 7974 686f 6e5f 7665 7273  : f"{python_vers
+0003ca00: 696f 6e5f 6e72 7d22 2c0a 2020 2020 2020  ion_nr}",.      
+0003ca10: 2020 2020 2020 2269 6e66 6f22 3a20 6622        "info": f"
+0003ca20: 7b70 7974 686f 6e5f 7665 7273 696f 6e7d  {python_version}
+0003ca30: 222c 0a20 2020 2020 2020 207d 2c0a 2020  ",.        },.  
+0003ca40: 2020 7d0a 2020 2020 2320 6a73 6f6e 5f6d    }.    # json_m
+0003ca50: 6178 2e75 7064 6174 6528 7b22 6b65 7922  ax.update({"key"
+0003ca60: 3a20 7661 6c75 657d 2920 2023 2061 6464  : value})  # add
+0003ca70: 2064 6963 7420 6974 656d 730a 2020 2020   dict items.    
+0003ca80: 6a73 6f6e 5f20 3d20 6a73 6f6e 5f6d 6178  json_ = json_max
+0003ca90: 2e63 6f70 7928 290a 2020 2020 2320 6a73  .copy().    # js
+0003caa0: 6f6e 5f2e 706f 7028 226b 6579 2229 0a20  on_.pop("key"). 
+0003cab0: 2020 206a 736f 6e5f 7370 6563 203d 204e     json_spec = N
+0003cac0: 6f6e 650a 2020 2020 7072 696e 745f 6f75  one.    print_ou
+0003cad0: 7470 7574 280a 2020 2020 2020 2020 6773  tput(.        gs
+0003cae0: 2e70 612e 6f75 7470 7574 2c0a 2020 2020  .pa.output,.    
+0003caf0: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
+0003cb00: 2020 2020 2020 206a 736f 6e5f 3d6a 736f         json_=jso
+0003cb10: 6e5f 2c0a 2020 2020 2020 2020 6a73 6f6e  n_,.        json
+0003cb20: 5f6d 6178 3d6a 736f 6e5f 6d61 782c 0a20  _max=json_max,. 
+0003cb30: 2020 2020 2020 206a 736f 6e5f 7370 6563         json_spec
+0003cb40: 3d6a 736f 6e5f 7370 6563 2c0a 2020 2020  =json_spec,.    
+0003cb50: 290a 0a0a 6465 6620 696e 6974 6961 6c5f  )...def initial_
+0003cb60: 6368 6563 6b5f 6f66 5f6c 6f67 5f61 7267  check_of_log_arg
+0003cb70: 7328 2920 2d3e 204e 6f6e 653a 0a20 2020  s() -> None:.   
+0003cb80: 2022 2222 4368 6563 6b20 6c6f 6767 696e   """Check loggin
+0003cb90: 6720 7265 6c61 7465 6420 6172 6775 6d65  g related argume
+0003cba0: 6e74 732e 0a0a 2020 2020 4172 6775 6d65  nts...    Argume
+0003cbb0: 6e74 733a 0a20 2020 202d 2d2d 2d2d 2d2d  nts:.    -------
+0003cbc0: 2d2d 0a20 2020 204e 6f6e 650a 0a20 2020  --.    None..   
+0003cbd0: 2052 6574 7572 6e73 3a20 4e6f 6e65 0a0a   Returns: None..
+0003cbe0: 2020 2020 5261 6973 6573 2065 7863 6570      Raises excep
+0003cbf0: 7469 6f6e 206f 6e20 6572 726f 722e 0a20  tion on error.. 
+0003cc00: 2020 2022 2222 0a20 2020 2069 6620 6e6f     """.    if no
+0003cc10: 7420 6773 2e70 612e 6c6f 675f 6c65 7665  t gs.pa.log_leve
+0003cc20: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
+0003cc30: 6e20 2023 2061 6c6c 204f 4b0a 2020 2020  n  # all OK.    
+0003cc40: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
+0003cc50: 656e 2867 732e 7061 2e6c 6f67 5f6c 6576  en(gs.pa.log_lev
+0003cc60: 656c 2929 3a0a 2020 2020 2020 2020 7570  el)):.        up
+0003cc70: 203d 2067 732e 7061 2e6c 6f67 5f6c 6576   = gs.pa.log_lev
+0003cc80: 656c 5b69 5d2e 7570 7065 7228 290a 2020  el[i].upper().  
+0003cc90: 2020 2020 2020 6773 2e70 612e 6c6f 675f        gs.pa.log_
+0003cca0: 6c65 7665 6c5b 695d 203d 2075 700a 2020  level[i] = up.  
+0003ccb0: 2020 2020 2020 6966 2075 7020 6e6f 7420        if up not 
+0003ccc0: 696e 205b 2244 4542 5547 222c 2022 494e  in ["DEBUG", "IN
+0003ccd0: 464f 222c 2022 5741 524e 494e 4722 2c20  FO", "WARNING", 
+0003cce0: 2245 5252 4f52 222c 2022 4352 4954 4943  "ERROR", "CRITIC
+0003ccf0: 414c 225d 3a0a 2020 2020 2020 2020 2020  AL"]:.          
+0003cd00: 2020 2320 6773 2e65 7272 5f63 6f75 6e74    # gs.err_count
+0003cd10: 202b 3d20 3120 2023 2077 726f 6e67 0a20   += 1  # wrong. 
+0003cd20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0003cd30: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+0003cd40: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0003cd50: 2020 2020 2020 2022 4532 3431 3a20 220a         "E241: ".
+0003cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cd70: 272d 2d6c 6f67 2d6c 6576 656c 206f 6e6c  '--log-level onl
+0003cd80: 7920 616c 6c6f 7773 2076 616c 7565 7320  y allows values 
+0003cd90: 2244 4542 5547 222c 2022 494e 464f 222c  "DEBUG", "INFO",
+0003cda0: 2022 5741 524e 494e 4722 2c20 270a 2020   "WARNING", '.  
+0003cdb0: 2020 2020 2020 2020 2020 2020 2020 2722                '"
+0003cdc0: 4552 524f 5222 2c20 6f72 2022 4352 4954  ERROR", or "CRIT
+0003cdd0: 4943 414c 222e 202d 2d6c 6f67 2d6c 6576  ICAL". --log-lev
+0003cde0: 656c 2061 7267 756d 656e 7420 696e 636f  el argument inco
+0003cdf0: 7272 6563 742e 2027 0a20 2020 2020 2020  rrect. '.       
+0003ce00: 2020 2020 2020 2020 2066 2228 7b75 707d           f"({up}
+0003ce10: 2922 0a20 2020 2020 2020 2020 2020 2029  )".            )
+0003ce20: 2066 726f 6d20 4e6f 6e65 0a0a 0a23 2061   from None...# a
+0003ce30: 6363 6f72 6469 6e67 2074 6f20 7079 6c61  ccording to pyla
+0003ce40: 6d61 3a20 6675 6e63 7469 6f6e 2074 6f6f  ma: function too
+0003ce50: 2063 6f6d 706c 6578 3a20 4339 3031 2023   complex: C901 #
+0003ce60: 206e 6f71 613a 2043 3930 310a 6465 6620   noqa: C901.def 
+0003ce70: 696e 6974 6961 6c5f 6368 6563 6b5f 6f66  initial_check_of
+0003ce80: 5f61 7267 7328 2920 2d3e 204e 6f6e 653a  _args() -> None:
+0003ce90: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
+0003cea0: 2020 2022 2222 4368 6563 6b20 6172 6775     """Check argu
+0003ceb0: 6d65 6e74 732e 2222 220a 2020 2020 2320  ments.""".    # 
+0003cec0: 4669 7273 742c 2074 6865 2061 646a 7573  First, the adjus
+0003ced0: 746d 656e 7473 0a20 2020 2069 6620 6e6f  tments.    if no
+0003cee0: 7420 6773 2e70 612e 656e 6372 7970 7465  t gs.pa.encrypte
+0003cef0: 643a 0a20 2020 2020 2020 2067 732e 7061  d:.        gs.pa
+0003cf00: 2e65 6e63 7279 7074 6564 203d 2054 7275  .encrypted = Tru
+0003cf10: 6520 2023 2066 6f72 6365 2069 7420 6f6e  e  # force it on
+0003cf20: 0a20 2020 2020 2020 2067 732e 6c6f 672e  .        gs.log.
+0003cf30: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0003cf40: 2020 2022 456e 6372 7970 7469 6f6e 2069     "Encryption i
+0003cf50: 7320 616c 7761 7973 2065 6e61 626c 6564  s always enabled
+0003cf60: 2e20 4974 2063 616e 6e6f 7420 6265 2074  . It cannot be t
+0003cf70: 7572 6e65 6420 6f66 662e 2022 0a20 2020  urned off. ".   
+0003cf80: 2020 2020 2020 2020 2022 5573 6520 2d2d           "Use --
+0003cf90: 7461 696c 2074 6f20 6469 7361 626c 6520  tail to disable 
+0003cfa0: 6974 2066 6f72 2073 7065 6369 6669 6320  it for specific 
+0003cfb0: 7573 6520 6361 7365 732e 220a 2020 2020  use cases.".    
+0003cfc0: 2020 2020 290a 2020 2020 6966 206e 6f74      ).    if not
+0003cfd0: 2067 732e 7061 2e65 6e63 7279 7074 6564   gs.pa.encrypted
+0003cfe0: 3a20 2023 206a 7573 7420 696e 2063 6173  :  # just in cas
+0003cff0: 6520 7765 2065 7665 7220 676f 2062 6163  e we ever go bac
+0003d000: 6b20 6469 7361 626c 696e 6720 6532 650a  k disabling e2e.
+0003d010: 2020 2020 2020 2020 6773 2e70 612e 7374          gs.pa.st
+0003d020: 6f72 6520 3d20 4e6f 6e65 0a20 2020 2069  ore = None.    i
+0003d030: 6620 6773 2e70 612e 6c69 7374 656e 3a0a  f gs.pa.listen:.
+0003d040: 2020 2020 2020 2020 6773 2e70 612e 6c69          gs.pa.li
+0003d050: 7374 656e 203d 2067 732e 7061 2e6c 6973  sten = gs.pa.lis
+0003d060: 7465 6e2e 6c6f 7765 7228 290a 2020 2020  ten.lower().    
+0003d070: 6966 2067 732e 7061 2e6c 6973 7465 6e20  if gs.pa.listen 
+0003d080: 3d3d 204e 4556 4552 2061 6e64 2067 732e  == NEVER and gs.
+0003d090: 7061 2e74 6169 6c20 213d 2030 3a0a 2020  pa.tail != 0:.  
+0003d0a0: 2020 2020 2020 6773 2e70 612e 6c69 7374        gs.pa.list
+0003d0b0: 656e 203d 2054 4149 4c20 2023 202d 2d74  en = TAIL  # --t
+0003d0c0: 6169 6c20 7475 726e 7320 6f6e 202d 2d6c  ail turns on --l
+0003d0d0: 6973 7465 6e20 5441 494c 0a20 2020 2020  isten TAIL.     
+0003d0e0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+0003d0f0: 272d 2d6c 6973 7465 6e20 7365 7420 746f  '--listen set to
+0003d100: 2022 7461 696c 2220 6265 6361 7573 6520   "tail" because 
+0003d110: 222d 2d74 6169 6c22 2069 7320 7573 6564  "--tail" is used
+0003d120: 2e27 290a 2020 2020 6966 2067 732e 7061  .').    if gs.pa
+0003d130: 2e73 796e 6320 6973 206e 6f74 204e 6f6e  .sync is not Non
+0003d140: 653a 0a20 2020 2020 2020 2067 732e 7061  e:.        gs.pa
+0003d150: 2e73 796e 6320 3d20 6773 2e70 612e 7379  .sync = gs.pa.sy
+0003d160: 6e63 2e6c 6f77 6572 2829 0a20 2020 2069  nc.lower().    i
+0003d170: 6620 6773 2e70 612e 6f75 7470 7574 2069  f gs.pa.output i
+0003d180: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0003d190: 2020 2020 6773 2e70 612e 6f75 7470 7574      gs.pa.output
+0003d1a0: 203d 2067 732e 7061 2e6f 7574 7075 742e   = gs.pa.output.
+0003d1b0: 6c6f 7765 7228 290a 2020 2020 6966 2067  lower().    if g
+0003d1c0: 732e 7061 2e72 6f6f 6d5f 696e 7669 7465  s.pa.room_invite
+0003d1d0: 733a 0a20 2020 2020 2020 2067 732e 7061  s:.        gs.pa
+0003d1e0: 2e72 6f6f 6d5f 696e 7669 7465 7320 3d20  .room_invites = 
+0003d1f0: 6773 2e70 612e 726f 6f6d 5f69 6e76 6974  gs.pa.room_invit
+0003d200: 6573 2e6c 6f77 6572 2829 0a0a 2020 2020  es.lower()..    
+0003d210: 6966 2028 0a20 2020 2020 2020 2067 732e  if (.        gs.
+0003d220: 7061 2e6d 6573 7361 6765 0a20 2020 2020  pa.message.     
+0003d230: 2020 206f 7220 6773 2e70 612e 696d 6167     or gs.pa.imag
+0003d240: 650a 2020 2020 2020 2020 6f72 2067 732e  e.        or gs.
+0003d250: 7061 2e61 7564 696f 0a20 2020 2020 2020  pa.audio.       
+0003d260: 206f 7220 6773 2e70 612e 6669 6c65 0a20   or gs.pa.file. 
+0003d270: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003d280: 6576 656e 740a 2020 2020 293a 0a20 2020  event.    ):.   
+0003d290: 2020 2020 2067 732e 7365 6e64 5f61 6374       gs.send_act
+0003d2a0: 696f 6e20 3d20 5472 7565 0a20 2020 2065  ion = True.    e
+0003d2b0: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
+0003d2c0: 7365 6e64 5f61 6374 696f 6e20 3d20 4661  send_action = Fa
+0003d2d0: 6c73 650a 0a20 2020 2069 6620 6773 2e70  lse..    if gs.p
+0003d2e0: 612e 6c69 7374 656e 2069 6e20 2846 4f52  a.listen in (FOR
+0003d2f0: 4556 4552 2c20 4f4e 4345 2c20 5441 494c  EVER, ONCE, TAIL
+0003d300: 2c20 414c 4c29 3a0a 2020 2020 2020 2020  , ALL):.        
+0003d310: 6773 2e6c 6973 7465 6e5f 6163 7469 6f6e  gs.listen_action
+0003d320: 203d 2054 7275 650a 2020 2020 656c 7365   = True.    else
+0003d330: 3a0a 2020 2020 2020 2020 6773 2e6c 6973  :.        gs.lis
+0003d340: 7465 6e5f 6163 7469 6f6e 203d 2046 616c  ten_action = Fal
+0003d350: 7365 0a0a 2020 2020 6966 2028 0a20 2020  se..    if (.   
+0003d360: 2020 2020 2023 2072 6f6f 6d20 7365 740a       # room set.
+0003d370: 2020 2020 2020 2020 6773 2e70 612e 726f          gs.pa.ro
+0003d380: 6f6d 5f63 7265 6174 650a 2020 2020 2020  om_create.      
+0003d390: 2020 6f72 2067 732e 7061 2e72 6f6f 6d5f    or gs.pa.room_
+0003d3a0: 646d 5f63 7265 6174 650a 2020 2020 2020  dm_create.      
+0003d3b0: 2020 6f72 2067 732e 7061 2e72 6f6f 6d5f    or gs.pa.room_
+0003d3c0: 6a6f 696e 0a20 2020 2020 2020 206f 7220  join.        or 
+0003d3d0: 6773 2e70 612e 726f 6f6d 5f6c 6561 7665  gs.pa.room_leave
+0003d3e0: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003d3f0: 612e 726f 6f6d 5f66 6f72 6765 740a 2020  a.room_forget.  
+0003d400: 2020 2020 2020 6f72 2067 732e 7061 2e72        or gs.pa.r
+0003d410: 6f6f 6d5f 696e 7669 7465 0a20 2020 2020  oom_invite.     
+0003d420: 2020 206f 7220 6773 2e70 612e 726f 6f6d     or gs.pa.room
+0003d430: 5f62 616e 0a20 2020 2020 2020 206f 7220  _ban.        or 
+0003d440: 6773 2e70 612e 726f 6f6d 5f75 6e62 616e  gs.pa.room_unban
+0003d450: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003d460: 612e 726f 6f6d 5f6b 6963 6b0a 2020 2020  a.room_kick.    
+0003d470: 2020 2020 6f72 2067 732e 7061 2e72 6f6f      or gs.pa.roo
+0003d480: 6d5f 7265 6461 6374 0a20 2020 2020 2020  m_redact.       
+0003d490: 206f 7220 6773 2e70 612e 726f 6f6d 5f73   or gs.pa.room_s
+0003d4a0: 6574 5f61 6c69 6173 0a20 2020 2020 2020  et_alias.       
+0003d4b0: 206f 7220 6773 2e70 612e 726f 6f6d 5f64   or gs.pa.room_d
+0003d4c0: 656c 6574 655f 616c 6961 730a 2020 2020  elete_alias.    
+0003d4d0: 2020 2020 2320 726f 6f6d 2067 6574 0a20      # room get. 
+0003d4e0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003d4f0: 726f 6f6d 5f67 6574 5f76 6973 6962 696c  room_get_visibil
+0003d500: 6974 7920 6973 206e 6f74 204e 6f6e 6520  ity is not None 
+0003d510: 2023 2065 6d70 7479 206c 6973 7420 6d75   # empty list mu
+0003d520: 7374 2069 6e76 6f6b 6520 6675 6e63 0a20  st invoke func. 
+0003d530: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003d540: 726f 6f6d 5f67 6574 5f73 7461 7465 2069  room_get_state i
+0003d550: 7320 6e6f 7420 4e6f 6e65 2020 2320 656d  s not None  # em
+0003d560: 7074 7920 6c69 7374 206d 7573 7420 696e  pty list must in
+0003d570: 766f 6b65 2066 756e 630a 2020 2020 2020  voke func.      
+0003d580: 2020 6f72 2067 732e 7061 2e72 6f6f 6d5f    or gs.pa.room_
+0003d590: 7265 736f 6c76 655f 616c 6961 730a 2020  resolve_alias.  
+0003d5a0: 2020 293a 0a20 2020 2020 2020 2067 732e    ):.        gs.
+0003d5b0: 726f 6f6d 5f61 6374 696f 6e20 3d20 5472  room_action = Tr
+0003d5c0: 7565 0a20 2020 2065 6c73 653a 0a20 2020  ue.    else:.   
+0003d5d0: 2020 2020 2067 732e 726f 6f6d 5f61 6374       gs.room_act
+0003d5e0: 696f 6e20 3d20 4661 6c73 650a 0a20 2020  ion = False..   
+0003d5f0: 2069 6620 280a 2020 2020 2020 2020 6773   if (.        gs
+0003d600: 2e70 612e 7365 745f 6465 7669 6365 5f6e  .pa.set_device_n
+0003d610: 616d 6520 2023 2073 6574 0a20 2020 2020  ame  # set.     
+0003d620: 2020 206f 7220 6773 2e70 612e 7365 745f     or gs.pa.set_
+0003d630: 6469 7370 6c61 795f 6e61 6d65 0a20 2020  display_name.   
+0003d640: 2020 2020 206f 7220 6773 2e70 612e 7365       or gs.pa.se
+0003d650: 745f 7072 6573 656e 6365 0a20 2020 2020  t_presence.     
+0003d660: 2020 206f 7220 6773 2e70 612e 7570 6c6f     or gs.pa.uplo
+0003d670: 6164 0a20 2020 2020 2020 206f 7220 6773  ad.        or gs
+0003d680: 2e70 612e 6465 6c65 7465 5f6d 7863 0a20  .pa.delete_mxc. 
+0003d690: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003d6a0: 6465 6c65 7465 5f6d 7863 5f62 6566 6f72  delete_mxc_befor
+0003d6b0: 650a 2020 2020 2020 2020 6f72 2067 732e  e.        or gs.
+0003d6c0: 7061 2e72 6573 740a 2020 2020 2020 2020  pa.rest.        
+0003d6d0: 6f72 2067 732e 7061 2e73 6574 5f61 7661  or gs.pa.set_ava
+0003d6e0: 7461 720a 2020 2020 2020 2020 6f72 2067  tar.        or g
+0003d6f0: 732e 7061 2e69 6d70 6f72 745f 6b65 7973  s.pa.import_keys
+0003d700: 0a20 2020 2020 2020 206f 7220 6773 2e70  .        or gs.p
+0003d710: 612e 6465 6c65 7465 5f64 6576 6963 650a  a.delete_device.
+0003d720: 2020 2020 293a 0a20 2020 2020 2020 2067      ):.        g
+0003d730: 732e 7365 745f 6163 7469 6f6e 203d 2054  s.set_action = T
+0003d740: 7275 650a 2020 2020 656c 7365 3a0a 2020  rue.    else:.  
+0003d750: 2020 2020 2020 6773 2e73 6574 5f61 6374        gs.set_act
+0003d760: 696f 6e20 3d20 4661 6c73 650a 0a20 2020  ion = False..   
+0003d770: 2069 6620 280a 2020 2020 2020 2020 6773   if (.        gs
+0003d780: 2e70 612e 6765 745f 6469 7370 6c61 795f  .pa.get_display_
+0003d790: 6e61 6d65 2020 2320 6765 740a 2020 2020  name  # get.    
+0003d7a0: 2020 2020 6f72 2067 732e 7061 2e67 6574      or gs.pa.get
+0003d7b0: 5f70 7265 7365 6e63 650a 2020 2020 2020  _presence.      
+0003d7c0: 2020 6f72 2067 732e 7061 2e64 6f77 6e6c    or gs.pa.downl
+0003d7d0: 6f61 640a 2020 2020 2020 2020 6f72 2067  oad.        or g
+0003d7e0: 732e 7061 2e6a 6f69 6e65 645f 726f 6f6d  s.pa.joined_room
+0003d7f0: 730a 2020 2020 2020 2020 6f72 2067 732e  s.        or gs.
+0003d800: 7061 2e6a 6f69 6e65 645f 6d65 6d62 6572  pa.joined_member
+0003d810: 730a 2020 2020 2020 2020 6f72 2067 732e  s.        or gs.
+0003d820: 7061 2e6d 7863 5f74 6f5f 6874 7470 0a20  pa.mxc_to_http. 
+0003d830: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003d840: 6465 7669 6365 730a 2020 2020 2020 2020  devices.        
+0003d850: 6f72 2067 732e 7061 2e64 6973 636f 7665  or gs.pa.discove
+0003d860: 7279 5f69 6e66 6f0a 2020 2020 2020 2020  ry_info.        
+0003d870: 6f72 2067 732e 7061 2e6c 6f67 696e 5f69  or gs.pa.login_i
+0003d880: 6e66 6f0a 2020 2020 2020 2020 6f72 2067  nfo.        or g
+0003d890: 732e 7061 2e63 6f6e 7465 6e74 5f72 6570  s.pa.content_rep
+0003d8a0: 6f73 6974 6f72 795f 636f 6e66 6967 0a20  ository_config. 
+0003d8b0: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003d8c0: 6765 745f 6176 6174 6172 2069 7320 6e6f  get_avatar is no
+0003d8d0: 7420 4e6f 6e65 2020 2320 656d 7074 7920  t None  # empty 
+0003d8e0: 6c69 7374 206d 7573 7420 696e 766f 6b65  list must invoke
+0003d8f0: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
+0003d900: 2020 6f72 2067 732e 7061 2e67 6574 5f70    or gs.pa.get_p
+0003d910: 726f 6669 6c65 2069 7320 6e6f 7420 4e6f  rofile is not No
+0003d920: 6e65 2020 2320 656d 7074 7920 6c69 7374  ne  # empty list
+0003d930: 206d 7573 7420 696e 766f 6b65 2066 756e   must invoke fun
+0003d940: 6374 696f 6e0a 2020 2020 2020 2020 6f72  ction.        or
+0003d950: 2067 732e 7061 2e67 6574 5f72 6f6f 6d5f   gs.pa.get_room_
+0003d960: 696e 666f 2069 7320 6e6f 7420 4e6f 6e65  info is not None
+0003d970: 2020 2320 656d 7074 7920 6c69 7374 206d    # empty list m
+0003d980: 7573 7420 696e 766f 6b65 2066 756e 6374  ust invoke funct
+0003d990: 696f 6e0a 2020 2020 2020 2020 6f72 2067  ion.        or g
+0003d9a0: 732e 7061 2e67 6574 5f63 6c69 656e 745f  s.pa.get_client_
+0003d9b0: 696e 666f 0a20 2020 2020 2020 206f 7220  info.        or 
+0003d9c0: 6773 2e70 612e 6861 735f 7065 726d 6973  gs.pa.has_permis
+0003d9d0: 7369 6f6e 0a20 2020 2020 2020 206f 7220  sion.        or 
+0003d9e0: 6773 2e70 612e 6578 706f 7274 5f6b 6579  gs.pa.export_key
+0003d9f0: 730a 2020 2020 2020 2020 6f72 2067 732e  s.        or gs.
+0003da00: 7061 2e67 6574 5f6f 7065 6e69 645f 746f  pa.get_openid_to
+0003da10: 6b65 6e20 6973 206e 6f74 204e 6f6e 6520  ken is not None 
+0003da20: 2023 2065 6d70 7479 206c 6973 7420 6d75   # empty list mu
+0003da30: 7374 2069 6e76 6f6b 6520 6675 6e63 0a20  st invoke func. 
+0003da40: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003da50: 7768 6f61 6d69 0a20 2020 2029 3a0a 2020  whoami.    ):.  
+0003da60: 2020 2020 2020 6773 2e67 6574 5f61 6374        gs.get_act
+0003da70: 696f 6e20 3d20 5472 7565 0a20 2020 2065  ion = True.    e
+0003da80: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
+0003da90: 6765 745f 6163 7469 6f6e 203d 2046 616c  get_action = Fal
+0003daa0: 7365 0a0a 2020 2020 6966 2067 732e 7365  se..    if gs.se
+0003dab0: 745f 6163 7469 6f6e 206f 7220 6773 2e67  t_action or gs.g
+0003dac0: 6574 5f61 6374 696f 6e3a 0a20 2020 2020  et_action:.     
+0003dad0: 2020 2067 732e 7365 7467 6574 5f61 6374     gs.setget_act
+0003dae0: 696f 6e20 3d20 5472 7565 0a20 2020 2065  ion = True.    e
+0003daf0: 6c73 653a 0a20 2020 2020 2020 2067 732e  lse:.        gs.
+0003db00: 7365 7467 6574 5f61 6374 696f 6e20 3d20  setget_action = 
+0003db10: 4661 6c73 650a 0a20 2020 2023 206f 6e6c  False..    # onl
+0003db20: 7920 3220 5353 4c20 7374 6174 6573 2061  y 2 SSL states a
+0003db30: 6c6c 6f77 6564 3a20 4e6f 6e65 2028 5353  llowed: None (SS
+0003db40: 4c20 6465 6661 756c 7420 6f6e 292c 2046  L default on), F
+0003db50: 616c 7365 2028 5353 4c20 6f66 6629 0a20  alse (SSL off). 
+0003db60: 2020 2069 6620 6773 2e70 612e 6e6f 5f73     if gs.pa.no_s
+0003db70: 736c 2069 7320 6e6f 7420 5472 7565 3a0a  sl is not True:.
+0003db80: 2020 2020 2020 2020 6773 2e70 612e 6e6f          gs.pa.no
+0003db90: 5f73 736c 203d 204e 6f6e 650a 2020 2020  _ssl = None.    
+0003dba0: 6966 2067 732e 7061 2e70 726f 7879 203d  if gs.pa.proxy =
+0003dbb0: 3d20 2222 3a0a 2020 2020 2020 2020 6773  = "":.        gs
+0003dbc0: 2e70 612e 7072 6f78 7920 3d20 4e6f 6e65  .pa.proxy = None
+0003dbd0: 0a0a 2020 2020 2320 686f 7720 6f66 7465  ..    # how ofte
+0003dbe0: 6e20 6973 2022 2d22 2075 7365 6420 746f  n is "-" used to
+0003dbf0: 2072 6570 7265 7365 6e74 2073 7464 696e   represent stdin
+0003dc00: 0a20 2020 2023 206d 7573 7420 6265 2030  .    # must be 0
+0003dc10: 206f 7220 313b 2063 616e 6e6f 7420 6265   or 1; cannot be
+0003dc20: 2075 7365 6420 7477 6963 6520 6f72 206d   used twice or m
+0003dc30: 6f72 650a 2020 2020 5354 4449 4e5f 4d45  ore.    STDIN_ME
+0003dc40: 5353 4147 4520 3d20 300a 2020 2020 5354  SSAGE = 0.    ST
+0003dc50: 4449 4e5f 494d 4147 4520 3d20 300a 2020  DIN_IMAGE = 0.  
+0003dc60: 2020 5354 4449 4e5f 4155 4449 4f20 3d20    STDIN_AUDIO = 
+0003dc70: 300a 2020 2020 5354 4449 4e5f 4649 4c45  0.    STDIN_FILE
+0003dc80: 203d 2030 0a20 2020 2053 5444 494e 5f45   = 0.    STDIN_E
+0003dc90: 5645 4e54 203d 2030 0a20 2020 2053 5444  VENT = 0.    STD
+0003dca0: 494e 5f54 4f54 414c 203d 2030 0a20 2020  IN_TOTAL = 0.   
+0003dcb0: 2069 6620 6773 2e70 612e 696d 6167 653a   if gs.pa.image:
+0003dcc0: 0a20 2020 2020 2020 2066 6f72 2069 6d61  .        for ima
+0003dcd0: 6765 2069 6e20 6773 2e70 612e 696d 6167  ge in gs.pa.imag
+0003dce0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0003dcf0: 6620 696d 6167 6520 3d3d 2022 2d22 3a0a  f image == "-":.
+0003dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dd10: 5354 4449 4e5f 494d 4147 4520 2b3d 2031  STDIN_IMAGE += 1
+0003dd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003dd30: 2067 732e 7374 6469 6e5f 7573 6520 3d20   gs.stdin_use = 
+0003dd40: 2269 6d61 6765 220a 2020 2020 6966 2067  "image".    if g
+0003dd50: 732e 7061 2e61 7564 696f 3a0a 2020 2020  s.pa.audio:.    
+0003dd60: 2020 2020 666f 7220 6175 6469 6f20 696e      for audio in
+0003dd70: 2067 732e 7061 2e61 7564 696f 3a0a 2020   gs.pa.audio:.  
+0003dd80: 2020 2020 2020 2020 2020 6966 2061 7564            if aud
+0003dd90: 696f 203d 3d20 222d 223a 0a20 2020 2020  io == "-":.     
+0003dda0: 2020 2020 2020 2020 2020 2053 5444 494e             STDIN
+0003ddb0: 5f41 5544 494f 202b 3d20 310a 2020 2020  _AUDIO += 1.    
+0003ddc0: 2020 2020 2020 2020 2020 2020 6773 2e73              gs.s
+0003ddd0: 7464 696e 5f75 7365 203d 2022 6175 6469  tdin_use = "audi
+0003dde0: 6f22 0a20 2020 2069 6620 6773 2e70 612e  o".    if gs.pa.
+0003ddf0: 6669 6c65 3a0a 2020 2020 2020 2020 666f  file:.        fo
+0003de00: 7220 6669 6c65 2069 6e20 6773 2e70 612e  r file in gs.pa.
+0003de10: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+0003de20: 2020 6966 2066 696c 6520 3d3d 2022 2d22    if file == "-"
+0003de30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003de40: 2020 5354 4449 4e5f 4649 4c45 202b 3d20    STDIN_FILE += 
+0003de50: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0003de60: 2020 6773 2e73 7464 696e 5f75 7365 203d    gs.stdin_use =
+0003de70: 2022 6669 6c65 220a 2020 2020 6966 2067   "file".    if g
+0003de80: 732e 7061 2e65 7665 6e74 3a0a 2020 2020  s.pa.event:.    
+0003de90: 2020 2020 666f 7220 6576 656e 7420 696e      for event in
+0003dea0: 2067 732e 7061 2e65 7665 6e74 3a0a 2020   gs.pa.event:.  
+0003deb0: 2020 2020 2020 2020 2020 6966 2065 7665            if eve
+0003dec0: 6e74 203d 3d20 222d 223a 0a20 2020 2020  nt == "-":.     
+0003ded0: 2020 2020 2020 2020 2020 2053 5444 494e             STDIN
+0003dee0: 5f45 5645 4e54 202b 3d20 310a 2020 2020  _EVENT += 1.    
+0003def0: 2020 2020 2020 2020 2020 2020 6773 2e73              gs.s
+0003df00: 7464 696e 5f75 7365 203d 2022 6576 656e  tdin_use = "even
+0003df10: 7422 0a20 2020 2069 6620 6773 2e70 612e  t".    if gs.pa.
+0003df20: 6d65 7373 6167 653a 0a20 2020 2020 2020  message:.       
+0003df30: 2066 6f72 206d 6573 7361 6765 2069 6e20   for message in 
+0003df40: 6773 2e70 612e 6d65 7373 6167 653a 0a20  gs.pa.message:. 
+0003df50: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
+0003df60: 7373 6167 6520 3d3d 2022 2d22 206f 7220  ssage == "-" or 
+0003df70: 6d65 7373 6167 6520 3d3d 2022 5f22 3a0a  message == "_":.
+0003df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003df90: 5354 4449 4e5f 4d45 5353 4147 4520 2b3d  STDIN_MESSAGE +=
+0003dfa0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+0003dfb0: 2020 2067 732e 7374 6469 6e5f 7573 6520     gs.stdin_use 
+0003dfc0: 3d20 226d 6573 7361 6765 220a 2020 2020  = "message".    
+0003dfd0: 5354 4449 4e5f 544f 5441 4c20 3d20 280a  STDIN_TOTAL = (.
+0003dfe0: 2020 2020 2020 2020 5354 4449 4e5f 4d45          STDIN_ME
+0003dff0: 5353 4147 4520 2b20 5354 4449 4e5f 494d  SSAGE + STDIN_IM
+0003e000: 4147 4520 2b20 5354 4449 4e5f 4155 4449  AGE + STDIN_AUDI
+0003e010: 4f20 2b20 5354 4449 4e5f 4649 4c45 202b  O + STDIN_FILE +
+0003e020: 2053 5444 494e 5f45 5645 4e54 0a20 2020   STDIN_EVENT.   
+0003e030: 2029 0a0a 2020 2020 2320 5365 636f 6e64   )..    # Second
+0003e040: 6c79 2c20 7468 6520 6368 6563 6b73 0a20  ly, the checks. 
+0003e050: 2020 2069 6620 6773 2e70 612e 636f 6e66     if gs.pa.conf
+0003e060: 6967 3a0a 2020 2020 2020 2020 7420 3d20  ig:.        t = 
+0003e070: 280a 2020 2020 2020 2020 2020 2020 2254  (.            "T
+0003e080: 6869 7320 6665 6174 7572 6520 6973 206e  his feature is n
+0003e090: 6f74 2069 6d70 6c65 6d65 6e74 6564 2079  ot implemented y
+0003e0a0: 6574 2061 6e64 2077 696c 6c20 6d6f 7374  et and will most
+0003e0b0: 206c 696b 656c 7920 220a 2020 2020 2020   likely ".      
+0003e0c0: 2020 2020 2020 226e 6f74 2062 6520 696d        "not be im
+0003e0d0: 706c 656d 656e 7465 642e 2053 6565 2049  plemented. See I
+0003e0e0: 7373 7565 2023 3334 206f 6e20 4769 7468  ssue #34 on Gith
+0003e0f0: 7562 2e22 0a20 2020 2020 2020 2029 0a20  ub.".        ). 
+0003e100: 2020 2065 6c69 6620 6773 2e70 612e 6c69     elif gs.pa.li
+0003e110: 7374 656e 2069 6e20 2846 4f52 4556 4552  sten in (FOREVER
+0003e120: 2c20 4f4e 4345 2c20 414c 4c29 2061 6e64  , ONCE, ALL) and
+0003e130: 2067 732e 7061 2e74 6169 6c20 213d 2030   gs.pa.tail != 0
+0003e140: 3a0a 2020 2020 2020 2020 7420 3d20 280a  :.        t = (.
+0003e150: 2020 2020 2020 2020 2020 2020 2244 6f6e              "Don
+0003e160: 2774 2075 7365 202d 2d6c 6973 7465 6e20  't use --listen 
+0003e170: 666f 7265 7665 722c 202d 2d6c 6973 7465  forever, --liste
+0003e180: 6e20 6f6e 6365 206f 7220 2d2d 6c69 7374  n once or --list
+0003e190: 656e 2061 6c6c 2022 0a20 2020 2020 2020  en all ".       
+0003e1a0: 2020 2020 2022 746f 6765 7468 6572 2077       "together w
+0003e1b0: 6974 6820 2d2d 7461 696c 2e20 4974 2773  ith --tail. It's
+0003e1c0: 206f 6e65 206f 7220 7468 6520 6f74 6865   one or the othe
+0003e1d0: 722e 220a 2020 2020 2020 2020 290a 2020  r.".        ).  
+0003e1e0: 2020 2320 7468 6973 2069 7320 7365 7420    # this is set 
+0003e1f0: 6279 2064 6566 6175 6c74 2061 6e79 7761  by default anywa
+0003e200: 792c 206a 7573 7420 6465 6665 6e73 6976  y, just defensiv
+0003e210: 6520 7072 6f67 7261 6d6d 696e 670a 2020  e programming.  
+0003e220: 2020 656c 6966 2067 732e 7061 2e65 6e63    elif gs.pa.enc
+0003e230: 7279 7074 6564 2061 6e64 2067 732e 7061  rypted and gs.pa
+0003e240: 2e73 746f 7265 2069 6e20 284e 6f6e 652c  .store in (None,
+0003e250: 2022 2229 3a0a 2020 2020 2020 2020 7420   ""):.        t 
+0003e260: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0003e270: 2249 6620 2d2d 656e 6372 7970 7465 6420  "If --encrypted 
+0003e280: 6973 2075 7365 6420 2d2d 7374 6f72 6520  is used --store 
+0003e290: 6d75 7374 2062 6520 7365 7420 746f 6f2e  must be set too.
+0003e2a0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0003e2b0: 5370 6563 6966 7920 2d2d 7374 6f72 6520  Specify --store 
+0003e2c0: 616e 6420 7275 6e20 7072 6f67 7261 6d20  and run program 
+0003e2d0: 6167 6169 6e2e 220a 2020 2020 2020 2020  again.".        
+0003e2e0: 290a 2020 2020 656c 6966 2067 732e 7061  ).    elif gs.pa
+0003e2f0: 2e76 6572 6966 7920 616e 6420 2867 732e  .verify and (gs.
+0003e300: 7061 2e76 6572 6966 792e 6c6f 7765 7228  pa.verify.lower(
+0003e310: 2920 213d 2045 4d4f 4a49 293a 0a20 2020  ) != EMOJI):.   
+0003e320: 2020 2020 2074 203d 2066 2746 6f72 202d       t = f'For -
+0003e330: 2d76 6572 6966 7920 6375 7272 656e 746c  -verify currentl
+0003e340: 7920 6f6e 6c79 2022 7b45 4d4f 4a49 7d22  y only "{EMOJI}"
+0003e350: 2069 7320 616c 6c6f 7765 6420 6173 206b   is allowed as k
+0003e360: 6579 776f 7264 2e27 0a20 2020 2065 6c69  eyword.'.    eli
+0003e370: 6620 6773 2e70 612e 7665 7273 696f 6e20  f gs.pa.version 
+0003e380: 616e 6420 280a 2020 2020 2020 2020 6773  and (.        gs
+0003e390: 2e70 612e 7665 7273 696f 6e2e 6c6f 7765  .pa.version.lowe
+0003e3a0: 7228 2920 213d 2050 5249 4e54 2061 6e64  r() != PRINT and
+0003e3b0: 2067 732e 7061 2e76 6572 7369 6f6e 2e6c   gs.pa.version.l
+0003e3c0: 6f77 6572 2829 2021 3d20 4348 4543 4b0a  ower() != CHECK.
+0003e3d0: 2020 2020 293a 0a20 2020 2020 2020 2074      ):.        t
+0003e3e0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0003e3f0: 2066 2746 6f72 202d 2d76 6572 7369 6f6e   f'For --version
+0003e400: 2063 7572 7265 6e74 6c79 206f 6e6c 7920   currently only 
+0003e410: 227b 5052 494e 547d 2220 270a 2020 2020  "{PRINT}" '.    
+0003e420: 2020 2020 2020 2020 6627 6f72 2022 7b43          f'or "{C
+0003e430: 4845 434b 7d22 2069 7320 616c 6c6f 7765  HECK}" is allowe
+0003e440: 6420 6173 206b 6579 776f 7264 2e27 0a20  d as keyword.'. 
+0003e450: 2020 2020 2020 2029 0a20 2020 2065 6c69         ).    eli
+0003e460: 6620 6773 2e70 612e 726f 6f6d 5f69 6e76  f gs.pa.room_inv
+0003e470: 6974 6573 2061 6e64 2028 0a20 2020 2020  ites and (.     
+0003e480: 2020 2067 732e 7061 2e72 6f6f 6d5f 696e     gs.pa.room_in
+0003e490: 7669 7465 7320 213d 2049 4e56 4954 4553  vites != INVITES
+0003e4a0: 5f4c 4953 540a 2020 2020 2020 2020 616e  _LIST.        an
+0003e4b0: 6420 6773 2e70 612e 726f 6f6d 5f69 6e76  d gs.pa.room_inv
+0003e4c0: 6974 6573 2021 3d20 494e 5649 5445 535f  ites != INVITES_
+0003e4d0: 4a4f 494e 0a20 2020 2020 2020 2061 6e64  JOIN.        and
+0003e4e0: 2067 732e 7061 2e72 6f6f 6d5f 696e 7669   gs.pa.room_invi
+0003e4f0: 7465 7320 213d 2049 4e56 4954 4553 5f4c  tes != INVITES_L
+0003e500: 4953 545f 4a4f 494e 0a20 2020 2029 3a0a  IST_JOIN.    ):.
+0003e510: 2020 2020 2020 2020 7420 3d20 280a 2020          t = (.  
+0003e520: 2020 2020 2020 2020 2020 6627 466f 7220            f'For 
+0003e530: 2d2d 726f 6f6d 2d69 6e76 6974 6573 2063  --room-invites c
+0003e540: 7572 7265 6e74 6c79 206f 6e6c 7920 227b  urrently only "{
+0003e550: 494e 5649 5445 535f 4c49 5354 7d22 2c20  INVITES_LIST}", 
+0003e560: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+0003e570: 227b 494e 5649 5445 535f 4a4f 494e 7d22  "{INVITES_JOIN}"
+0003e580: 206f 7220 227b 494e 5649 5445 535f 4c49   or "{INVITES_LI
+0003e590: 5354 5f4a 4f49 4e7d 2220 6172 6520 616c  ST_JOIN}" are al
+0003e5a0: 6c6f 7765 6420 6173 2027 0a20 2020 2020  lowed as '.     
+0003e5b0: 2020 2020 2020 2022 6b65 7977 6f72 6473         "keywords
+0003e5c0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+0003e5d0: 2023 2065 6c69 6620 6773 2e70 612e 726f   # elif gs.pa.ro
+0003e5e0: 6f6d 5f69 6e76 6974 6573 2061 6e64 2067  om_invites and g
+0003e5f0: 732e 7061 2e6c 6973 7465 6e20 6e6f 7420  s.pa.listen not 
+0003e600: 696e 2028 464f 5245 5645 522c 204f 4e43  in (FOREVER, ONC
+0003e610: 4529 3a0a 2020 2020 2320 2020 2020 7420  E):.    #     t 
+0003e620: 3d20 280a 2020 2020 2320 2020 2020 2020  = (.    #       
+0003e630: 2020 2246 6f72 202d 2d72 6f6f 6d2d 696e    "For --room-in
+0003e640: 7669 7465 7320 746f 2077 6f72 6b20 796f  vites to work yo
+0003e650: 7520 6d75 7374 2061 6c73 6f20 6265 206c  u must also be l
+0003e660: 6973 7465 6e69 6e67 2e20 220a 2020 2020  istening. ".    
+0003e670: 2320 2020 2020 2020 2020 2755 7365 2022  #         'Use "
+0003e680: 2d2d 6c69 7374 656e 206f 6e63 6522 206f  --listen once" o
+0003e690: 7220 222d 2d6c 6973 7465 6e20 666f 7265  r "--listen fore
+0003e6a0: 7665 7222 2e27 0a20 2020 2023 2020 2020  ver".'.    #    
+0003e6b0: 2029 0a20 2020 2023 2061 6c6c 6f77 2076   ).    # allow v
+0003e6c0: 6572 6966 7920 7769 7468 2065 7665 7279  erify with every
+0003e6d0: 7468 696e 670a 2020 2020 2320 616c 6c6f  thing.    # allo
+0003e6e0: 7720 7365 6e64 2077 6974 6820 6576 6572  w send with ever
+0003e6f0: 7974 6869 6e67 0a20 2020 2023 2061 6c6c  ything.    # all
+0003e700: 6f77 206c 6973 7465 6e20 7769 7468 2065  ow listen with e
+0003e710: 7665 7279 7468 696e 670a 2020 2020 656c  verything.    el
+0003e720: 6966 2067 732e 7061 2e73 6574 5f64 6576  if gs.pa.set_dev
+0003e730: 6963 655f 6e61 6d65 2061 6e64 2028 6773  ice_name and (gs
+0003e740: 2e70 612e 7365 745f 6465 7669 6365 5f6e  .pa.set_device_n
+0003e750: 616d 652e 7374 7269 7028 2920 3d3d 2022  ame.strip() == "
+0003e760: 2229 3a0a 2020 2020 2020 2020 7420 3d20  "):.        t = 
+0003e770: 2244 6f6e 2774 2075 7365 2061 6e20 656d  "Don't use an em
+0003e780: 7074 7920 6e61 6d65 2066 6f72 202d 2d73  pty name for --s
+0003e790: 6574 2d64 6576 6963 652d 6e61 6d65 2e22  et-device-name."
+0003e7a0: 0a20 2020 2065 6c69 6620 6773 2e70 612e  .    elif gs.pa.
+0003e7b0: 7365 745f 6469 7370 6c61 795f 6e61 6d65  set_display_name
+0003e7c0: 2061 6e64 2028 6773 2e70 612e 7365 745f   and (gs.pa.set_
+0003e7d0: 6469 7370 6c61 795f 6e61 6d65 2e73 7472  display_name.str
+0003e7e0: 6970 2829 203d 3d20 2222 293a 0a20 2020  ip() == ""):.   
+0003e7f0: 2020 2020 2074 203d 2022 446f 6e27 7420       t = "Don't 
+0003e800: 7573 6520 616e 2065 6d70 7479 206e 616d  use an empty nam
+0003e810: 6520 666f 7220 2d2d 7365 742d 6469 7370  e for --set-disp
+0003e820: 6c61 792d 6e61 6d65 2e22 0a20 2020 2065  lay-name.".    e
+0003e830: 6c69 6620 2867 732e 7061 2e75 7365 7229  lif (gs.pa.user)
+0003e840: 2061 6e64 206e 6f74 2028 0a20 2020 2020   and not (.     
+0003e850: 2020 2067 732e 7365 6e64 5f61 6374 696f     gs.send_actio
+0003e860: 6e0a 2020 2020 2020 2020 6f72 2067 732e  n.        or gs.
+0003e870: 726f 6f6d 5f61 6374 696f 6e0a 2020 2020  room_action.    
+0003e880: 2020 2020 6f72 2067 732e 7061 2e67 6574      or gs.pa.get
+0003e890: 5f64 6973 706c 6179 5f6e 616d 650a 2020  _display_name.  
+0003e8a0: 2020 2020 2020 6f72 2067 732e 7061 2e67        or gs.pa.g
+0003e8b0: 6574 5f70 7265 7365 6e63 650a 2020 2020  et_presence.    
+0003e8c0: 2020 2020 6f72 2067 732e 7061 2e64 656c      or gs.pa.del
+0003e8d0: 6574 655f 6465 7669 6365 0a20 2020 2029  ete_device.    )
+0003e8e0: 3a0a 2020 2020 2020 2020 7420 3d20 280a  :.        t = (.
+0003e8f0: 2020 2020 2020 2020 2020 2020 2249 6620              "If 
+0003e900: 2d2d 7573 6572 2069 7320 7370 6563 6966  --user is specif
+0003e910: 6965 642c 206f 6e6c 7920 6120 7365 6e64  ied, only a send
+0003e920: 2061 6374 696f 6e2c 2061 2072 6f6f 6d20   action, a room 
+0003e930: 6163 7469 6f6e 2c20 220a 2020 2020 2020  action, ".      
+0003e940: 2020 2020 2020 222d 2d67 6574 2d64 6973        "--get-dis
+0003e950: 706c 6179 2d6e 616d 652c 202d 2d67 6574  play-name, --get
+0003e960: 2d70 7265 7365 6e63 652c 206f 7220 2d2d  -presence, or --
+0003e970: 6465 6c65 7465 2d64 6576 6963 6520 6361  delete-device ca
+0003e980: 6e20 6265 2022 0a20 2020 2020 2020 2020  n be ".         
+0003e990: 2020 2022 646f 6e65 2e20 4164 6a75 7374     "done. Adjust
+0003e9a0: 2079 6f75 7220 6172 6775 6d65 6e74 7320   your arguments 
+0003e9b0: 6163 636f 7264 696e 676c 792e 220a 2020  accordingly.".  
+0003e9c0: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
+0003e9d0: 2028 6773 2e70 612e 7379 6e63 2069 7320   (gs.pa.sync is 
+0003e9e0: 6e6f 7420 4e6f 6e65 2920 616e 6420 6e6f  not None) and no
+0003e9f0: 7420 2867 732e 7365 6e64 5f61 6374 696f  t (gs.send_actio
+0003ea00: 6e29 3a0a 2020 2020 2020 2020 7420 3d20  n):.        t = 
+0003ea10: 280a 2020 2020 2020 2020 2020 2020 224f  (.            "O
+0003ea20: 6e6c 7920 6966 2061 2073 656e 6420 6163  nly if a send ac
+0003ea30: 7469 6f6e 2069 7320 7072 6f76 6964 6564  tion is provided
+0003ea40: 2069 7320 6974 206d 6561 6e69 6e67 6675   is it meaningfu
+0003ea50: 6c20 746f 2073 7065 6369 6679 2022 0a20  l to specify ". 
+0003ea60: 2020 2020 2020 2020 2020 2022 2d2d 7379             "--sy
+0003ea70: 6e63 2e20 5265 6d6f 7665 202d 2d73 796e  nc. Remove --syn
+0003ea80: 6320 6f72 2061 6464 2061 2073 656e 6420  c or add a send 
+0003ea90: 6163 7469 6f6e 2e20 220a 2020 2020 2020  action. ".      
+0003eaa0: 2020 2020 2020 2241 646a 7573 7420 796f        "Adjust yo
+0003eab0: 7572 2061 7267 756d 656e 7473 2061 6363  ur arguments acc
+0003eac0: 6f72 6469 6e67 6c79 2e22 0a20 2020 2020  ordingly.".     
+0003ead0: 2020 2029 0a20 2020 2065 6c69 6620 2867     ).    elif (g
+0003eae0: 732e 7061 2e73 796e 6320 6973 206e 6f74  s.pa.sync is not
+0003eaf0: 204e 6f6e 6529 2061 6e64 2067 732e 7061   None) and gs.pa
+0003eb00: 2e73 796e 6320 6e6f 7420 696e 2028 5359  .sync not in (SY
+0003eb10: 4e43 5f46 554c 4c2c 2053 594e 435f 4f46  NC_FULL, SYNC_OF
+0003eb20: 4629 3a0a 2020 2020 2020 2020 7420 3d20  F):.        t = 
+0003eb30: 280a 2020 2020 2020 2020 2020 2020 2249  (.            "I
+0003eb40: 6e63 6f72 7265 6374 2076 616c 7565 2067  ncorrect value g
+0003eb50: 6976 656e 2066 6f72 202d 2d73 796e 632e  iven for --sync.
+0003eb60: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+0003eb70: 224f 6e6c 7920 277b 5359 4e43 5f46 554c  "Only '{SYNC_FUL
+0003eb80: 4c7d 2720 616e 6420 277b 5359 4e43 5f4f  L}' and '{SYNC_O
+0003eb90: 4646 7d27 2061 7265 2061 6c6c 6f77 6564  FF}' are allowed
+0003eba0: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+0003ebb0: 2065 6c69 6620 6773 2e70 612e 6f75 7470   elif gs.pa.outp
+0003ebc0: 7574 206e 6f74 2069 6e20 280a 2020 2020  ut not in (.    
+0003ebd0: 2020 2020 4f55 5450 5554 5f54 4558 542c      OUTPUT_TEXT,
+0003ebe0: 0a20 2020 2020 2020 204f 5554 5055 545f  .        OUTPUT_
+0003ebf0: 4a53 4f4e 2c0a 2020 2020 2020 2020 4f55  JSON,.        OU
+0003ec00: 5450 5554 5f4a 534f 4e5f 5350 4543 2c0a  TPUT_JSON_SPEC,.
+0003ec10: 2020 2020 2020 2020 4f55 5450 5554 5f4a          OUTPUT_J
+0003ec20: 534f 4e5f 4d41 582c 0a20 2020 2029 3a0a  SON_MAX,.    ):.
+0003ec30: 2020 2020 2020 2020 7420 3d20 280a 2020          t = (.  
+0003ec40: 2020 2020 2020 2020 2020 2249 6e63 6f72            "Incor
+0003ec50: 7265 6374 2076 616c 7565 2067 6976 656e  rect value given
+0003ec60: 2066 6f72 202d 2d6f 7574 7075 742e 2022   for --output. "
+0003ec70: 0a20 2020 2020 2020 2020 2020 2066 224f  .            f"O
+0003ec80: 6e6c 7920 277b 4f55 5450 5554 5f54 4558  nly '{OUTPUT_TEX
+0003ec90: 547d 272c 2027 7b4f 5554 5055 545f 4a53  T}', '{OUTPUT_JS
+0003eca0: 4f4e 7d27 2c20 220a 2020 2020 2020 2020  ON}', ".        
+0003ecb0: 2020 2020 6622 277b 4f55 5450 5554 5f4a      f"'{OUTPUT_J
+0003ecc0: 534f 4e5f 5350 4543 7d27 2061 6e64 2027  SON_SPEC}' and '
+0003ecd0: 7b4f 5554 5055 545f 4a53 4f4e 5f4d 4158  {OUTPUT_JSON_MAX
+0003ece0: 7d27 2061 7265 2061 6c6c 6f77 6564 2e22  }' are allowed."
+0003ecf0: 0a20 2020 2020 2020 2029 0a20 2020 2065  .        ).    e
+0003ed00: 6c69 6620 6e6f 7420 6773 2e70 612e 7573  lif not gs.pa.us
+0003ed10: 6572 2061 6e64 2028 0a20 2020 2020 2020  er and (.       
+0003ed20: 2067 732e 7061 2e72 6f6f 6d5f 696e 7669   gs.pa.room_invi
+0003ed30: 7465 0a20 2020 2020 2020 206f 7220 6773  te.        or gs
+0003ed40: 2e70 612e 726f 6f6d 5f62 616e 0a20 2020  .pa.room_ban.   
+0003ed50: 2020 2020 206f 7220 6773 2e70 612e 726f       or gs.pa.ro
+0003ed60: 6f6d 5f75 6e62 616e 0a20 2020 2020 2020  om_unban.       
+0003ed70: 206f 7220 6773 2e70 612e 726f 6f6d 5f6b   or gs.pa.room_k
+0003ed80: 6963 6b0a 2020 2020 293a 0a20 2020 2020  ick.    ):.     
+0003ed90: 2020 2074 203d 2028 0a20 2020 2020 2020     t = (.       
+0003eda0: 2020 2020 2022 5573 6572 206e 6f74 2073       "User not s
+0003edb0: 7065 6369 6669 6564 2066 6f72 2072 6f6f  pecified for roo
+0003edc0: 6d20 6163 7469 6f6e 2e20 220a 2020 2020  m action. ".    
+0003edd0: 2020 2020 2020 2020 2255 7365 202d 2d75          "Use --u
+0003ede0: 7365 7220 6f70 7469 6f6e 2074 6f20 7370  ser option to sp
+0003edf0: 6563 6966 7920 7573 6572 2873 2920 666f  ecify user(s) fo
+0003ee00: 7220 6769 7665 6e20 726f 6f6d 2061 6374  r given room act
+0003ee10: 696f 6e2e 220a 2020 2020 2020 2020 290a  ion.".        ).
+0003ee20: 2020 2020 656c 6966 2067 732e 7061 2e6c      elif gs.pa.l
+0003ee30: 6973 7465 6e20 696e 2028 4f4e 4345 2c20  isten in (ONCE, 
+0003ee40: 464f 5245 5645 5229 2061 6e64 2067 732e  FOREVER) and gs.
+0003ee50: 7061 2e72 6f6f 6d3a 0a20 2020 2020 2020  pa.room:.       
+0003ee60: 2074 203d 2028 0a20 2020 2020 2020 2020   t = (.         
+0003ee70: 2020 2022 4966 202d 2d6c 6973 7465 6e20     "If --listen 
+0003ee80: 6f6e 6365 206f 7220 2d2d 6c69 7374 656e  once or --listen
+0003ee90: 2066 6f72 6576 6572 2061 7265 2073 7065   forever are spe
+0003eea0: 6369 6669 6564 2c20 220a 2020 2020 2020  cified, ".      
+0003eeb0: 2020 2020 2020 222d 2d72 6f6f 6d20 6d75        "--room mu
+0003eec0: 7374 206e 6f74 2062 6520 7370 6563 6966  st not be specif
+0003eed0: 6965 6420 6265 6361 7573 6520 220a 2020  ied because ".  
+0003eee0: 2020 2020 2020 2020 2020 2274 6865 7365            "these
+0003eef0: 206f 7074 696f 6e73 206c 6973 7465 6e20   options listen 
+0003ef00: 696e 2041 4c4c 2072 6f6f 6d73 2e22 0a20  in ALL rooms.". 
+0003ef10: 2020 2020 2020 2029 0a20 2020 2065 6c69         ).    eli
+0003ef20: 6620 6773 2e70 612e 6c69 7374 656e 206e  f gs.pa.listen n
+0003ef30: 6f74 2069 6e20 284e 4556 4552 2c20 464f  ot in (NEVER, FO
+0003ef40: 5245 5645 522c 204f 4e43 452c 2054 4149  REVER, ONCE, TAI
+0003ef50: 4c2c 2041 4c4c 293a 0a20 2020 2020 2020  L, ALL):.       
+0003ef60: 2074 203d 2028 0a20 2020 2020 2020 2020   t = (.         
+0003ef70: 2020 2022 4966 202d 2d6c 6973 7465 6e20     "If --listen 
+0003ef80: 6973 2073 7065 6369 6669 6564 2c20 6f6e  is specified, on
+0003ef90: 6c79 2074 6865 7365 2063 686f 6963 6573  ly these choices
+0003efa0: 2061 7265 2022 0a20 2020 2020 2020 2020   are ".         
+0003efb0: 2020 2066 2270 6f73 7369 626c 653a 207b     f"possible: {
+0003efc0: 4f4e 4345 7d2c 207b 4e45 5645 527d 2c20  ONCE}, {NEVER}, 
+0003efd0: 7b46 4f52 4556 4552 7d2c 207b 5441 494c  {FOREVER}, {TAIL
+0003efe0: 7d20 6f72 207b 414c 4c7d 2e20 220a 2020  } or {ALL}. ".  
+0003eff0: 2020 2020 2020 2020 2020 6627 466f 756e            f'Foun
+0003f000: 6420 227b 6773 2e70 612e 6c69 7374 656e  d "{gs.pa.listen
+0003f010: 7d22 2e27 0a20 2020 2020 2020 2029 0a20  }".'.        ). 
+0003f020: 2020 2065 6c69 6620 6773 2e70 612e 6c69     elif gs.pa.li
+0003f030: 7374 656e 203d 3d20 4e45 5645 5220 616e  sten == NEVER an
+0003f040: 6420 6773 2e70 612e 6c69 7374 656e 5f73  d gs.pa.listen_s
+0003f050: 656c 663a 0a20 2020 2020 2020 2074 203d  elf:.        t =
+0003f060: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+0003f070: 4966 206e 6569 7468 6572 202d 2d6c 6973  If neither --lis
+0003f080: 7465 6e20 6e6f 7220 2d2d 7461 696c 2061  ten nor --tail a
+0003f090: 7265 2075 7365 642c 2022 0a20 2020 2020  re used, ".     
+0003f0a0: 2020 2020 2020 2022 7468 656e 202d 2d6c         "then --l
+0003f0b0: 6973 7465 6e2d 7365 6c66 206d 7573 7420  isten-self must 
+0003f0c0: 6e6f 7420 6265 2075 7365 6420 220a 2020  not be used ".  
+0003f0d0: 2020 2020 2020 2020 2020 2265 6974 6865            "eithe
+0003f0e0: 722e 2053 7065 6369 6679 202d 2d6c 6973  r. Specify --lis
+0003f0f0: 7465 6e20 6f72 202d 2d74 6169 6c20 220a  ten or --tail ".
+0003f100: 2020 2020 2020 2020 2020 2020 2261 6e64              "and
+0003f110: 2072 756e 2070 726f 6772 616d 2061 6761   run program aga
+0003f120: 696e 2e22 0a20 2020 2020 2020 2029 0a20  in.".        ). 
+0003f130: 2020 2065 6c69 6620 6773 2e70 612e 6c69     elif gs.pa.li
+0003f140: 7374 656e 203d 3d20 4e45 5645 5220 616e  sten == NEVER an
+0003f150: 6420 2867 732e 7061 2e64 6f77 6e6c 6f61  d (gs.pa.downloa
+0003f160: 645f 6d65 6469 6120 213d 2022 2229 3a0a  d_media != ""):.
+0003f170: 2020 2020 2020 2020 7420 3d20 280a 2020          t = (.  
+0003f180: 2020 2020 2020 2020 2020 2249 6620 6e65            "If ne
+0003f190: 6974 6865 7220 2d2d 6c69 7374 656e 206e  ither --listen n
+0003f1a0: 6f72 202d 2d74 6169 6c20 6172 6520 7573  or --tail are us
+0003f1b0: 6564 2c20 220a 2020 2020 2020 2020 2020  ed, ".          
+0003f1c0: 2020 2274 6865 6e20 2d2d 646f 776e 6c6f    "then --downlo
+0003f1d0: 6164 2d6d 6564 6961 206d 7573 7420 6e6f  ad-media must no
+0003f1e0: 7420 6265 2075 7365 6420 220a 2020 2020  t be used ".    
+0003f1f0: 2020 2020 2020 2020 2265 6974 6865 722e          "either.
+0003f200: 2053 7065 6369 6679 202d 2d6c 6973 7465   Specify --liste
+0003f210: 6e20 6f72 202d 2d74 6169 6c20 220a 2020  n or --tail ".  
+0003f220: 2020 2020 2020 2020 2020 6622 616e 6420            f"and 
+0003f230: 7275 6e20 7072 6f67 7261 6d20 6167 6169  run program agai
+0003f240: 6e2e 2028 7b67 732e 7061 2e64 6f77 6e6c  n. ({gs.pa.downl
+0003f250: 6f61 645f 6d65 6469 617d 2922 0a20 2020  oad_media})".   
+0003f260: 2020 2020 2029 0a20 2020 2065 6c69 6620       ).    elif 
+0003f270: 6773 2e70 612e 6c69 7374 656e 203d 3d20  gs.pa.listen == 
+0003f280: 5441 494c 2061 6e64 2028 6773 2e70 612e  TAIL and (gs.pa.
+0003f290: 7461 696c 203c 3d20 3029 3a0a 2020 2020  tail <= 0):.    
+0003f2a0: 2020 2020 7420 3d20 280a 2020 2020 2020      t = (.      
+0003f2b0: 2020 2020 2020 2241 6e20 696e 7465 6765        "An intege
+0003f2c0: 7220 3120 6f72 206c 6172 6765 7220 6d75  r 1 or larger mu
+0003f2d0: 7374 2062 6520 7370 6563 6966 6965 6420  st be specified 
+0003f2e0: 7769 7468 202d 2d74 6169 6c20 220a 2020  with --tail ".  
+0003f2f0: 2020 2020 2020 2020 2020 6622 287b 6773            f"({gs
+0003f300: 2e70 612e 7461 696c 7d29 2e22 0a20 2020  .pa.tail}).".   
+0003f310: 2020 2020 2029 0a20 2020 2065 6c69 6620       ).    elif 
+0003f320: 6773 2e70 612e 7072 6f78 7920 616e 6420  gs.pa.proxy and 
+0003f330: 6e6f 7420 280a 2020 2020 2020 2020 6773  not (.        gs
+0003f340: 2e70 612e 7072 6f78 792e 7374 6172 7473  .pa.proxy.starts
+0003f350: 7769 7468 2822 6874 7470 3a2f 2f22 290a  with("http://").
+0003f360: 2020 2020 2020 2020 6f72 2067 732e 7061          or gs.pa
+0003f370: 2e70 726f 7879 2e73 7461 7274 7377 6974  .proxy.startswit
+0003f380: 6828 2273 6f63 6b73 343a 2f2f 2229 0a20  h("socks4://"). 
+0003f390: 2020 2020 2020 206f 7220 6773 2e70 612e         or gs.pa.
+0003f3a0: 7072 6f78 792e 7374 6172 7473 7769 7468  proxy.startswith
+0003f3b0: 2822 736f 636b 7335 3a2f 2f22 290a 2020  ("socks5://").  
+0003f3c0: 2020 293a 0a20 2020 2020 2020 2074 203d    ):.        t =
+0003f3d0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+0003f3e0: 5072 6f78 7920 6973 206e 6f74 2063 6f72  Proxy is not cor
+0003f3f0: 7265 6374 2e20 5072 6f78 7920 7368 6f75  rect. Proxy shou
+0003f400: 6c64 2073 7461 7274 2077 6974 6820 220a  ld start with ".
+0003f410: 2020 2020 2020 2020 2020 2020 2722 6874              '"ht
+0003f420: 7470 3a2f 2f22 2c20 2273 6f63 6b73 343a  tp://", "socks4:
+0003f430: 2f2f 2220 6f72 2022 736f 636b 7335 3a2f  //" or "socks5:/
+0003f440: 2f22 2e20 270a 2020 2020 2020 2020 2020  /". '.          
+0003f450: 2020 6627 2059 6f75 7220 7072 6f78 7920    f' Your proxy 
+0003f460: 6973 2073 6574 2074 6f20 227b 6773 2e70  is set to "{gs.p
+0003f470: 612e 7072 6f78 797d 222e 270a 2020 2020  a.proxy}".'.    
+0003f480: 2020 2020 290a 2020 2020 656c 6966 2053      ).    elif S
+0003f490: 5444 494e 5f54 4f54 414c 203e 2031 3a0a  TDIN_TOTAL > 1:.
+0003f4a0: 2020 2020 2020 2020 7420 3d20 280a 2020          t = (.  
+0003f4b0: 2020 2020 2020 2020 2020 2754 6865 2063            'The c
+0003f4c0: 6861 7261 6374 6572 2022 2d22 2069 7320  haracter "-" is 
+0003f4d0: 7573 6564 206d 6f72 6520 7468 616e 206f  used more than o
+0003f4e0: 6e63 6520 270a 2020 2020 2020 2020 2020  nce '.          
+0003f4f0: 2020 2774 6f20 7265 7072 6573 656e 7420    'to represent 
+0003f500: 2273 7464 696e 2220 666f 7220 7069 7069  "stdin" for pipi
+0003f510: 6e67 2069 6e66 6f72 6d61 7469 6f6e 2027  ng information '
+0003f520: 0a20 2020 2020 2020 2020 2020 2066 2769  .            f'i
+0003f530: 6e74 6f20 227b 5052 4f47 5f57 4954 484f  nto "{PROG_WITHO
+0003f540: 5554 5f45 5854 7d22 2e20 5374 6469 6e20  UT_EXT}". Stdin 
+0003f550: 7069 7065 2063 616e 2027 0a20 2020 2020  pipe can '.     
+0003f560: 2020 2020 2020 2022 6265 2075 7365 6420         "be used 
+0003f570: 6174 206d 6f73 7420 6f6e 6365 2e22 0a20  at most once.". 
+0003f580: 2020 2020 2020 2029 0a20 2020 2065 6c69         ).    eli
+0003f590: 6620 6773 2e70 612e 6e6f 5f73 736c 2061  f gs.pa.no_ssl a
+0003f5a0: 6e64 2067 732e 7061 2e73 736c 5f63 6572  nd gs.pa.ssl_cer
+0003f5b0: 7469 6669 6361 7465 2021 3d20 5353 4c5f  tificate != SSL_
+0003f5c0: 4345 5254 4946 4943 4154 455f 4445 4641  CERTIFICATE_DEFA
+0003f5d0: 554c 543a 0a20 2020 2020 2020 2074 203d  ULT:.        t =
+0003f5e0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+0003f5f0: 4f70 7469 6f6e 7320 2d2d 6e6f 2d73 736c  Options --no-ssl
+0003f600: 2061 6e64 202d 2d73 736c 2d63 6572 7469   and --ssl-certi
+0003f610: 6669 6361 7465 2063 616e 6e6f 7420 6265  ficate cannot be
+0003f620: 2075 7365 6420 220a 2020 2020 2020 2020   used ".        
+0003f630: 2020 2020 2274 6f67 6574 6865 722e 2055      "together. U
+0003f640: 7365 206f 6e65 206f 7220 7468 6520 6f74  se one or the ot
+0003f650: 6865 722e 220a 2020 2020 2020 2020 290a  her.".        ).
+0003f660: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003f670: 2020 6966 2067 732e 7061 2e73 796e 6320    if gs.pa.sync 
+0003f680: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0003f690: 2020 2020 2067 732e 7061 2e73 796e 6320       gs.pa.sync 
+0003f6a0: 3d20 5359 4e43 5f44 4546 4155 4c54 0a20  = SYNC_DEFAULT. 
+0003f6b0: 2020 2020 2020 2067 732e 6c6f 672e 6465         gs.log.de
+0003f6c0: 6275 6728 6622 4f70 7469 6f6e 202d 2d73  bug(f"Option --s
+0003f6d0: 796e 6320 6973 2073 6574 2074 6f20 7b67  ync is set to {g
+0003f6e0: 732e 7061 2e73 796e 637d 2e22 290a 2020  s.pa.sync}.").  
+0003f6f0: 2020 2020 2020 6773 2e6c 6f67 2e64 6562        gs.log.deb
+0003f700: 7567 2822 416c 6c20 6172 6775 6d65 6e74  ug("All argument
+0003f710: 7320 6172 6520 7661 6c69 642e 2041 6c6c  s are valid. All
+0003f720: 2063 6865 636b 7320 7061 7373 6564 2e22   checks passed."
+0003f730: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0003f740: 2020 2320 616c 6c20 4f4b 0a20 2020 2023    # all OK.    #
+0003f750: 2067 732e 6572 725f 636f 756e 7420 2b3d   gs.err_count +=
+0003f760: 2031 2023 2064 6f20 6e6f 7420 696e 6372   1 # do not incr
+0003f770: 656d 656e 7420 666f 7220 4d61 7472 6978  ement for Matrix
+0003f780: 436f 6d6d 616e 6465 7245 7272 6f72 0a20  CommanderError. 
+0003f790: 2020 2072 6169 7365 204d 6174 7269 7843     raise MatrixC
+0003f7a0: 6f6d 6d61 6e64 6572 4572 726f 7228 2245  ommanderError("E
+0003f7b0: 3234 303a 2022 202b 2074 2920 6672 6f6d  240: " + t) from
+0003f7c0: 204e 6f6e 650a 0a0a 636c 6173 7320 636f   None...class co
+0003f7d0: 6c6f 7273 3a0a 2020 2020 2222 2243 6f6c  lors:.    """Col
+0003f7e0: 6f72 7320 636c 6173 732e 0a0a 2020 2020  ors class...    
+0003f7f0: 7265 7365 7420 616c 6c20 636f 6c6f 7273  reset all colors
+0003f800: 2077 6974 6820 636f 6c6f 7273 2e72 6573   with colors.res
+0003f810: 6574 2e0a 2020 2020 3220 7375 6220 636c  et..    2 sub cl
+0003f820: 6173 7365 733a 2066 6720 666f 7220 666f  asses: fg for fo
+0003f830: 7265 6772 6f75 6e64 2061 6e64 2062 6720  reground and bg 
+0003f840: 666f 7220 6261 636b 6772 6f75 6e64 3b0a  for background;.
+0003f850: 2020 2020 7573 6520 6173 2063 6f6c 6f72      use as color
+0003f860: 732e 7375 6263 6c61 7373 2e63 6f6c 6f72  s.subclass.color
+0003f870: 6e61 6d65 2e0a 2020 2020 692e 652e 2063  name..    i.e. c
+0003f880: 6f6c 6f72 732e 6667 2e72 6564 206f 7220  olors.fg.red or 
+0003f890: 636f 6c6f 7273 2e62 672e 6772 6565 6e0a  colors.bg.green.
+0003f8a0: 2020 2020 616c 736f 2c20 7468 6520 6765      also, the ge
+0003f8b0: 6e65 7269 6320 626f 6c64 2c20 6469 7361  neric bold, disa
+0003f8c0: 626c 652c 2075 6e64 6572 6c69 6e65 2c20  ble, underline, 
+0003f8d0: 7265 7665 7273 652c 2073 7472 696b 6520  reverse, strike 
+0003f8e0: 7468 726f 7567 682c 0a20 2020 2061 6e64  through,.    and
+0003f8f0: 2069 6e76 6973 6962 6c65 2077 6f72 6b20   invisible work 
+0003f900: 7769 7468 2074 6865 206d 6169 6e20 636c  with the main cl
+0003f910: 6173 7320 692e 652e 2063 6f6c 6f72 732e  ass i.e. colors.
+0003f920: 626f 6c64 0a0a 2020 2020 7573 6520 6c69  bold..    use li
+0003f930: 6b65 2074 6869 733a 0a20 2020 2070 7269  ke this:.    pri
+0003f940: 6e74 2863 6f6c 6f72 732e 6267 2e67 7265  nt(colors.bg.gre
+0003f950: 656e 2c20 2253 4b6b 222c 2063 6f6c 6f72  en, "SKk", color
+0003f960: 732e 6667 2e72 6564 2c20 2241 6d61 7274  s.fg.red, "Amart
+0003f970: 7961 2229 0a20 2020 2070 7269 6e74 2863  ya").    print(c
+0003f980: 6f6c 6f72 732e 6267 2e6c 6967 6874 6772  olors.bg.lightgr
+0003f990: 6579 2c20 2253 4b6b 222c 2063 6f6c 6f72  ey, "SKk", color
+0003f9a0: 732e 6667 2e72 6564 2c20 2241 6d61 7274  s.fg.red, "Amart
+0003f9b0: 7961 2229 0a20 2020 2022 2222 0a0a 2020  ya").    """..  
+0003f9c0: 2020 7265 7365 7420 3d20 225c 3033 335b    reset = "\033[
+0003f9d0: 306d 220a 2020 2020 626f 6c64 203d 2022  0m".    bold = "
+0003f9e0: 5c30 3333 5b30 316d 220a 2020 2020 6469  \033[01m".    di
+0003f9f0: 7361 626c 6520 3d20 225c 3033 335b 3032  sable = "\033[02
+0003fa00: 6d22 0a20 2020 2069 6e76 6572 7365 203d  m".    inverse =
+0003fa10: 2022 5c30 3333 5b30 336d 220a 2020 2020   "\033[03m".    
+0003fa20: 756e 6465 726c 696e 6520 3d20 225c 3033  underline = "\03
+0003fa30: 335b 3034 6d22 0a20 2020 2062 6c69 6e6b  3[04m".    blink
+0003fa40: 203d 2022 5c30 3333 5b30 356d 220a 2020   = "\033[05m".  
+0003fa50: 2020 626c 696e 6b32 203d 2022 5c30 3333    blink2 = "\033
+0003fa60: 5b30 366d 220a 2020 2020 7265 7665 7273  [06m".    revers
+0003fa70: 6520 3d20 225c 3033 335b 3037 6d22 0a20  e = "\033[07m". 
+0003fa80: 2020 2069 6e76 6973 6962 6c65 203d 2022     invisible = "
+0003fa90: 5c30 3333 5b30 386d 220a 2020 2020 7374  \033[08m".    st
+0003faa0: 7269 6b65 7468 726f 7567 6820 3d20 225c  rikethrough = "\
+0003fab0: 3033 335b 3039 6d22 0a0a 2020 2020 636c  033[09m"..    cl
+0003fac0: 6173 7320 6667 3a0a 2020 2020 2020 2020  ass fg:.        
+0003fad0: 626c 6163 6b20 3d20 225c 3033 335b 3330  black = "\033[30
+0003fae0: 6d22 0a20 2020 2020 2020 2072 6564 203d  m".        red =
+0003faf0: 2022 5c30 3333 5b33 316d 220a 2020 2020   "\033[31m".    
+0003fb00: 2020 2020 6772 6565 6e20 3d20 225c 3033      green = "\03
+0003fb10: 335b 3332 6d22 0a20 2020 2020 2020 206f  3[32m".        o
+0003fb20: 7261 6e67 6520 3d20 225c 3033 335b 3333  range = "\033[33
+0003fb30: 6d22 0a20 2020 2020 2020 2062 6c75 6520  m".        blue 
+0003fb40: 3d20 225c 3033 335b 3334 6d22 0a20 2020  = "\033[34m".   
+0003fb50: 2020 2020 2070 7572 706c 6520 3d20 225c       purple = "\
+0003fb60: 3033 335b 3335 6d22 0a20 2020 2020 2020  033[35m".       
+0003fb70: 2063 7961 6e20 3d20 225c 3033 335b 3336   cyan = "\033[36
+0003fb80: 6d22 0a20 2020 2020 2020 206c 6967 6874  m".        light
+0003fb90: 6772 6579 203d 2022 5c30 3333 5b33 376d  grey = "\033[37m
+0003fba0: 220a 2020 2020 2020 2020 6461 726b 6772  ".        darkgr
+0003fbb0: 6579 203d 2022 5c30 3333 5b39 306d 220a  ey = "\033[90m".
+0003fbc0: 2020 2020 2020 2020 6c69 6768 7472 6564          lightred
+0003fbd0: 203d 2022 5c30 3333 5b39 316d 220a 2020   = "\033[91m".  
+0003fbe0: 2020 2020 2020 6c69 6768 7467 7265 656e        lightgreen
+0003fbf0: 203d 2022 5c30 3333 5b39 326d 220a 2020   = "\033[92m".  
+0003fc00: 2020 2020 2020 7965 6c6c 6f77 203d 2022        yellow = "
+0003fc10: 5c30 3333 5b39 336d 220a 2020 2020 2020  \033[93m".      
+0003fc20: 2020 6c69 6768 7462 6c75 6520 3d20 225c    lightblue = "\
+0003fc30: 3033 335b 3934 6d22 0a20 2020 2020 2020  033[94m".       
+0003fc40: 2070 696e 6b20 3d20 225c 3033 335b 3935   pink = "\033[95
+0003fc50: 6d22 0a20 2020 2020 2020 206c 6967 6874  m".        light
+0003fc60: 6379 616e 203d 2022 5c30 3333 5b39 366d  cyan = "\033[96m
+0003fc70: 220a 0a20 2020 2063 6c61 7373 2062 673a  "..    class bg:
+0003fc80: 0a20 2020 2020 2020 2062 6c61 636b 203d  .        black =
+0003fc90: 2022 5c30 3333 5b34 306d 220a 2020 2020   "\033[40m".    
+0003fca0: 2020 2020 7265 6420 3d20 225c 3033 335b      red = "\033[
+0003fcb0: 3431 6d22 0a20 2020 2020 2020 2067 7265  41m".        gre
+0003fcc0: 656e 203d 2022 5c30 3333 5b34 326d 220a  en = "\033[42m".
+0003fcd0: 2020 2020 2020 2020 6f72 616e 6765 203d          orange =
+0003fce0: 2022 5c30 3333 5b34 336d 220a 2020 2020   "\033[43m".    
+0003fcf0: 2020 2020 626c 7565 203d 2022 5c30 3333      blue = "\033
+0003fd00: 5b34 346d 220a 2020 2020 2020 2020 7075  [44m".        pu
+0003fd10: 7270 6c65 203d 2022 5c30 3333 5b34 356d  rple = "\033[45m
+0003fd20: 220a 2020 2020 2020 2020 6379 616e 203d  ".        cyan =
+0003fd30: 2022 5c30 3333 5b34 366d 220a 2020 2020   "\033[46m".    
+0003fd40: 2020 2020 6c69 6768 7467 7265 7920 3d20      lightgrey = 
+0003fd50: 225c 3033 335b 3437 6d22 0a0a 0a23 2061  "\033[47m"...# a
+0003fd60: 6363 6f72 6469 6e67 2074 6f20 6c69 6e74  ccording to lint
+0003fd70: 6572 3a20 6675 6e63 7469 6f6e 2069 7320  er: function is 
+0003fd80: 746f 6f20 636f 6d70 6c65 782c 2043 3930  too complex, C90
+0003fd90: 310a 6465 6620 6d61 696e 5f69 6e6e 6572  1.def main_inner
+0003fda0: 280a 2020 2020 6172 6776 3a20 556e 696f  (.    argv: Unio
+0003fdb0: 6e5b 4e6f 6e65 2c20 6c69 7374 5d20 3d20  n[None, list] = 
+0003fdc0: 4e6f 6e65 0a29 202d 3e20 4e6f 6e65 3a20  None.) -> None: 
+0003fdd0: 2023 206e 6f71 613a 2043 3930 3120 2320   # noqa: C901 # 
+0003fde0: 6967 6e6f 7265 206d 6363 6162 6520 6966  ignore mccabe if
+0003fdf0: 2d74 6f6f 2d63 6f6d 706c 6578 0a20 2020  -too-complex.   
+0003fe00: 2022 2222 5275 6e20 7468 6520 7072 6f67   """Run the prog
+0003fe10: 7261 6d2e 0a0a 2020 2020 4675 6e63 7469  ram...    Functi
+0003fe20: 6f6e 2073 6967 6e61 7475 7265 2069 6465  on signature ide
+0003fe30: 6e74 6963 616c 2074 6f20 6d61 696e 2829  ntical to main()
+0003fe40: 2e0a 2020 2020 506c 6561 7365 2073 6565  ..    Please see
+0003fe50: 206d 6169 6e28 292e 0a0a 2020 2020 5265   main()...    Re
+0003fe60: 7475 726e 7320 4e6f 6e65 2e20 5265 7475  turns None. Retu
+0003fe70: 726e 7320 6e6f 7468 696e 672e 0a0a 2020  rns nothing...  
+0003fe80: 2020 5261 6973 6573 2065 7863 6570 7469    Raises excepti
+0003fe90: 6f6e 2069 6620 616e 2065 7272 6f72 2069  on if an error i
+0003fea0: 7320 6465 7465 6374 6564 2e20 4d61 6e79  s detected. Many
+0003feb0: 2065 7863 6570 7469 6f6e 7320 6172 650a   exceptions are.
+0003fec0: 2020 2020 2020 2020 706f 7373 6962 6c65          possible
+0003fed0: 2e20 4f6e 6520 6f66 2074 6865 6d20 6973  . One of them is
+0003fee0: 3a20 4d61 7472 6978 436f 6d6d 616e 6465  : MatrixCommande
+0003fef0: 7245 7272 6f72 2e0a 2020 2020 2020 2020  rError..        
+0003ff00: 5365 7473 2067 6c6f 6261 6c20 7374 6174  Sets global stat
+0003ff10: 6520 746f 2063 6f6d 6d75 6e69 6361 7465  e to communicate
+0003ff20: 2065 7272 6f72 732e 0a0a 2020 2020 2222   errors...    ""
+0003ff30: 220a 2020 2020 6966 2061 7267 763a 0a20  ".    if argv:. 
+0003ff40: 2020 2020 2020 2073 7973 2e61 7267 7620         sys.argv 
+0003ff50: 3d20 6172 6776 0a20 2020 2023 2070 7265  = argv.    # pre
+0003ff60: 7061 7265 2074 6865 2067 6c6f 6261 6c20  pare the global 
+0003ff70: 7374 6174 650a 2020 2020 676c 6f62 616c  state.    global
+0003ff80: 2067 730a 2020 2020 6773 203d 2047 6c6f   gs.    gs = Glo
+0003ff90: 6261 6c53 7461 7465 2829 0a20 2020 2067  balState().    g
+0003ffa0: 6c6f 6261 6c20 5345 500a 2020 2020 2320  lobal SEP.    # 
+0003ffb0: 436f 6e73 7472 7563 7420 7468 6520 6172  Construct the ar
+0003ffc0: 6775 6d65 6e74 2070 6172 7365 720a 2020  gument parser.  
+0003ffd0: 2020 6170 203d 2061 7267 7061 7273 652e    ap = argparse.
+0003ffe0: 4172 6775 6d65 6e74 5061 7273 6572 280a  ArgumentParser(.
+0003fff0: 2020 2020 2020 2020 6164 645f 6865 6c70          add_help
+00040000: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00040010: 6465 7363 7269 7074 696f 6e3d 2866 2257  description=(f"W
+00040020: 656c 636f 6d65 2074 6f20 7b50 524f 475f  elcome to {PROG_
+00040030: 5749 5448 4f55 545f 4558 547d 2c20 6120  WITHOUT_EXT}, a 
+00040040: 4d61 7472 6978 2043 4c49 2063 6c69 656e  Matrix CLI clien
+00040050: 742e 2022 292c 0a20 2020 2020 2020 2065  t. "),.        e
+00040060: 7069 6c6f 673d 2259 6f75 2061 7265 2072  pilog="You are r
+00040070: 756e 6e69 6e67 2022 0a20 2020 2020 2020  unning ".       
+00040080: 2066 2276 6572 7369 6f6e 207b 5645 5253   f"version {VERS
+00040090: 494f 4e4e 527d 207b 5645 5253 494f 4e7d  IONNR} {VERSION}
+000400a0: 2e20 456e 6a6f 792c 2073 7461 7220 6f6e  . Enjoy, star on
+000400b0: 2047 6974 6875 6220 616e 6420 220a 2020   Github and ".  
+000400c0: 2020 2020 2020 2263 6f6e 7472 6962 7574        "contribut
+000400d0: 6520 6279 2073 7562 6d69 7474 696e 6720  e by submitting 
+000400e0: 6120 5075 6c6c 2052 6571 7565 7374 2e20  a Pull Request. 
+000400f0: 220a 2020 2020 2020 2020 6622 416c 736f  ".        f"Also
+00040100: 2068 6176 6520 6120 6c6f 6f6b 2061 7420   have a look at 
+00040110: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+00040120: 547d 2d74 7569 2e20 222c 0a20 2020 2029  T}-tui. ",.    )
+00040130: 0a20 2020 2023 202d 682c 2073 6565 2061  .    # -h, see a
+00040140: 6464 5f68 656c 703d 4661 6c73 650a 2020  dd_help=False.  
+00040150: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+00040160: 7428 0a20 2020 2020 2020 2023 2073 6565  t(.        # see
+00040170: 2073 6372 6970 7420 6372 6561 7465 2068   script create h
+00040180: 656c 702e 6865 6c70 2e74 7874 0a20 2020  elp.help.txt.   
+00040190: 2020 2020 2023 2068 656c 7020 7374 7269       # help stri
+000401a0: 6e67 2075 7020 746f 2062 7574 2065 7863  ng up to but exc
+000401b0: 6c75 6469 6e67 2022 4465 7461 696c 733a  luding "Details:
+000401c0: 3a22 2069 7320 7573 6564 2066 6f72 0a20  :" is used for. 
+000401d0: 2020 2020 2020 2023 2028 7368 6f72 7429         # (short)
+000401e0: 2060 2d2d 6865 6c70 602e 2054 6865 2066   `--help`. The f
+000401f0: 756c 6c20 7465 7874 2077 696c 6c20 6265  ull text will be
+00040200: 2075 7365 6420 666f 7220 6c6f 6e67 2060   used for long `
+00040210: 2d2d 6d61 6e75 616c 602e 0a20 2020 2020  --manual`..     
+00040220: 2020 2022 2d2d 7573 6167 6522 2c0a 2020     "--usage",.  
+00040230: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+00040240: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+00040250: 7469 6f6e 3d22 7374 6f72 655f 7472 7565  tion="store_true
+00040260: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+00040270: 2250 7269 6e74 2075 7361 6765 2e20 220a  "Print usage. ".
+00040280: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+00040290: 3a3a 2053 6565 2061 6c73 6f20 2d2d 6865  :: See also --he
+000402a0: 6c70 2066 6f72 2070 7269 6e74 696e 6720  lp for printing 
+000402b0: 6120 6269 7420 6d6f 7265 2061 6e64 202d  a bit more and -
+000402c0: 2d6d 616e 7561 6c20 220a 2020 2020 2020  -manual ".      
+000402d0: 2020 2266 6f72 2070 7269 6e74 696e 6720    "for printing 
+000402e0: 6120 6c6f 7420 6d6f 7265 2064 6574 6169  a lot more detai
+000402f0: 6c65 6420 696e 666f 726d 6174 696f 6e2e  led information.
+00040300: 222c 0a20 2020 2029 0a20 2020 2023 202d  ",.    ).    # -
+00040310: 682c 2073 6565 2061 6464 5f68 656c 703d  h, see add_help=
+00040320: 4661 6c73 650a 2020 2020 6170 2e61 6464  False.    ap.add
+00040330: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00040340: 2020 2022 2d68 222c 0a20 2020 2020 2020     "-h",.       
+00040350: 2022 2d2d 6865 6c70 222c 0a20 2020 2020   "--help",.     
+00040360: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+00040370: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+00040380: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
+00040390: 2020 2020 2020 2020 6865 6c70 3d22 5072          help="Pr
+000403a0: 696e 7420 6865 6c70 2e20 220a 2020 2020  int help. ".    
+000403b0: 2020 2020 2244 6574 6169 6c73 3a3a 2053      "Details:: S
+000403c0: 6565 2061 6c73 6f20 2d2d 7573 6167 6520  ee also --usage 
+000403d0: 666f 7220 7072 696e 7469 6e67 2065 7665  for printing eve
+000403e0: 6e20 6c65 7373 2069 6e66 6f72 6d61 7469  n less informati
+000403f0: 6f6e 2c20 220a 2020 2020 2020 2020 2261  on, ".        "a
+00040400: 6e64 202d 2d6d 616e 7561 6c20 666f 7220  nd --manual for 
+00040410: 7072 696e 7469 6e67 206d 6f72 6520 6465  printing more de
+00040420: 7461 696c 6564 2069 6e66 6f72 6d61 7469  tailed informati
+00040430: 6f6e 2e22 2c0a 2020 2020 290a 2020 2020  on.",.    ).    
+00040440: 2320 7365 6520 2d68 2c20 7365 6520 6164  # see -h, see ad
+00040450: 645f 6865 6c70 3d46 616c 7365 0a20 2020  d_help=False.   
+00040460: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+00040470: 280a 2020 2020 2020 2020 222d 2d6d 616e  (.        "--man
+00040480: 7561 6c22 2c0a 2020 2020 2020 2020 7265  ual",.        re
+00040490: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+000404a0: 2020 2020 2020 6163 7469 6f6e 3d22 7374        action="st
+000404b0: 6f72 655f 7472 7565 222c 0a20 2020 2020  ore_true",.     
+000404c0: 2020 2068 656c 703d 2250 7269 6e74 206d     help="Print m
+000404d0: 616e 7561 6c2e 2022 0a20 2020 2020 2020  anual. ".       
+000404e0: 2022 4465 7461 696c 733a 3a20 5365 6520   "Details:: See 
+000404f0: 616c 736f 202d 2d75 7361 6765 2066 6f72  also --usage for
+00040500: 2070 7269 6e74 696e 6720 7468 6520 6162   printing the ab
+00040510: 736f 6c75 7465 206d 696e 696d 756d 2c20  solute minimum, 
+00040520: 220a 2020 2020 2020 2020 2261 6e64 202d  ".        "and -
+00040530: 2d68 656c 7020 666f 7220 7072 696e 7469  -help for printi
+00040540: 6e67 206c 6573 732e 222c 0a20 2020 2029  ng less.",.    )
+00040550: 0a20 2020 2023 2073 6565 202d 682c 2073  .    # see -h, s
+00040560: 6565 2061 6464 5f68 656c 703d 4661 6c73  ee add_help=Fals
+00040570: 650a 2020 2020 6170 2e61 6464 5f61 7267  e.    ap.add_arg
+00040580: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00040590: 2d2d 7265 6164 6d65 222c 0a20 2020 2020  --readme",.     
+000405a0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+000405b0: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+000405c0: 6e3d 2273 746f 7265 5f74 7275 6522 2c0a  n="store_true",.
+000405d0: 2020 2020 2020 2020 6865 6c70 3d22 5072          help="Pr
+000405e0: 696e 7420 5245 4144 4d45 2e6d 6420 6669  int README.md fi
+000405f0: 6c65 2e20 220a 2020 2020 2020 2020 2244  le. ".        "D
+00040600: 6574 6169 6c73 3a3a 2054 7269 6573 2074  etails:: Tries t
+00040610: 6f20 7072 696e 7420 7468 6520 6c6f 6361  o print the loca
+00040620: 6c20 5245 4144 4d45 2e6d 6420 6669 6c65  l README.md file
+00040630: 2066 726f 6d20 696e 7374 616c 6c61 7469   from installati
+00040640: 6f6e 2e20 220a 2020 2020 2020 2020 2249  on. ".        "I
+00040650: 6620 6e6f 7420 666f 756e 6420 6974 2077  f not found it w
+00040660: 696c 6c20 6765 7420 7468 6520 5245 4144  ill get the READ
+00040670: 4d45 2e6d 6420 6669 6c65 2066 726f 6d20  ME.md file from 
+00040680: 6769 7468 7562 2e63 6f6d 2061 6e64 2022  github.com and "
+00040690: 0a20 2020 2020 2020 2022 7072 696e 7420  .        "print 
+000406a0: 6974 2e20 5365 6520 616c 736f 202d 2d75  it. See also --u
+000406b0: 7361 6765 2c20 2d2d 6865 6c70 2c20 616e  sage, --help, an
+000406c0: 6420 2d2d 6d61 6e75 616c 2e22 2c0a 2020  d --manual.",.  
+000406d0: 2020 290a 2020 2020 2320 4164 6420 7468    ).    # Add th
+000406e0: 6520 6172 6775 6d65 6e74 7320 746f 2074  e arguments to t
+000406f0: 6865 2070 6172 7365 720a 2020 2020 6170  he parser.    ap
+00040700: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00040710: 2020 2020 2020 2022 2d64 222c 0a20 2020         "-d",.   
+00040720: 2020 2020 2022 2d2d 6465 6275 6722 2c0a       "--debug",.
+00040730: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+00040740: 636f 756e 7422 2c0a 2020 2020 2020 2020  count",.        
+00040750: 6465 6661 756c 743d 302c 0a20 2020 2020  default=0,.     
+00040760: 2020 2068 656c 703d 2250 7269 6e74 2064     help="Print d
+00040770: 6562 7567 2069 6e66 6f72 6d61 7469 6f6e  ebug information
+00040780: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+00040790: 6169 6c73 3a3a 2049 6620 7573 6564 206f  ails:: If used o
+000407a0: 6e63 652c 206f 6e6c 7920 7468 6520 6c6f  nce, only the lo
+000407b0: 6720 6c65 7665 6c20 6f66 2022 0a20 2020  g level of ".   
+000407c0: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
+000407d0: 484f 5554 5f45 5854 7d20 6973 2073 6574  HOUT_EXT} is set
+000407e0: 2074 6f20 4445 4255 472e 2022 0a20 2020   to DEBUG. ".   
+000407f0: 2020 2020 2027 4966 2075 7365 6420 7477       'If used tw
+00040800: 6963 6520 2822 2d64 202d 6422 206f 7220  ice ("-d -d" or 
+00040810: 222d 6464 2229 2074 6865 6e20 270a 2020  "-dd") then '.  
+00040820: 2020 2020 2020 6622 6c6f 6720 6c65 7665        f"log leve
+00040830: 6c73 206f 6620 626f 7468 207b 5052 4f47  ls of both {PROG
+00040840: 5f57 4954 484f 5554 5f45 5854 7d20 616e  _WITHOUT_EXT} an
+00040850: 6420 756e 6465 726c 7969 6e67 206d 6f64  d underlying mod
+00040860: 756c 6573 2061 7265 2022 0a20 2020 2020  ules are ".     
+00040870: 2020 2027 7365 7420 746f 2044 4542 5547     'set to DEBUG
+00040880: 2e20 222d 6422 2069 7320 6120 7368 6f72  . "-d" is a shor
+00040890: 7463 7574 2066 6f72 2022 2d2d 6c6f 672d  tcut for "--log-
+000408a0: 6c65 7665 6c20 4445 4255 4722 2e20 270a  level DEBUG". '.
+000408b0: 2020 2020 2020 2020 2753 6565 2061 6c73          'See als
+000408c0: 6f20 2d2d 6c6f 672d 6c65 7665 6c2e 2022  o --log-level. "
+000408d0: 2d64 2220 7461 6b65 7320 7072 6563 6564  -d" takes preced
+000408e0: 656e 6365 206f 7665 7220 222d 2d6c 6f67  ence over "--log
+000408f0: 2d6c 6576 656c 222e 2027 0a20 2020 2020  -level". '.     
+00040900: 2020 2027 4164 6469 7469 6f6e 616c 6c79     'Additionally
+00040910: 2c20 6861 7665 2061 206c 6f6f 6b20 616c  , have a look al
+00040920: 736f 2061 7420 7468 6520 6f70 7469 6f6e  so at the option
+00040930: 2022 2d2d 7665 7262 6f73 6522 2e20 272c   "--verbose". ',
+00040940: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
+00040950: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
+00040960: 2020 2020 222d 2d6c 6f67 2d6c 6576 656c      "--log-level
+00040970: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+00040980: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+00040990: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
+000409a0: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
+000409b0: 733d 222b 222c 0a20 2020 2020 2020 2074  s="+",.        t
+000409c0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+000409d0: 206d 6574 6176 6172 3d28 2244 4542 5547   metavar=("DEBUG
+000409e0: 7c49 4e46 4f7c 5741 524e 494e 477c 4552  |INFO|WARNING|ER
+000409f0: 524f 527c 4352 4954 4943 414c 2229 2c0a  ROR|CRITICAL"),.
+00040a00: 2020 2020 2020 2020 6865 6c70 3d22 5365          help="Se
+00040a10: 7420 7468 6520 6c6f 6720 6c65 7665 6c28  t the log level(
+00040a20: 7329 2e20 220a 2020 2020 2020 2020 2244  s). ".        "D
+00040a30: 6574 6169 6c73 3a3a 2050 6f73 7369 626c  etails:: Possibl
+00040a40: 6520 7661 6c75 6573 2061 7265 2022 0a20  e values are ". 
+00040a50: 2020 2020 2020 2027 2244 4542 5547 222c         '"DEBUG",
+00040a60: 2022 494e 464f 222c 2022 5741 524e 494e   "INFO", "WARNIN
+00040a70: 4722 2c20 2245 5252 4f52 222c 2061 6e64  G", "ERROR", and
+00040a80: 2022 4352 4954 4943 414c 222e 2027 0a20   "CRITICAL". '. 
+00040a90: 2020 2020 2020 2022 4966 202d 2d6c 6f67         "If --log
+00040aa0: 5f6c 6576 656c 2069 7320 7573 6564 2077  _level is used w
+00040ab0: 6974 6820 6f6e 6520 6c65 7665 6c20 6172  ith one level ar
+00040ac0: 6775 6d65 6e74 2c20 6f6e 6c79 2074 6865  gument, only the
+00040ad0: 206c 6f67 206c 6576 656c 2022 0a20 2020   log level ".   
+00040ae0: 2020 2020 2066 226f 6620 7b50 524f 475f       f"of {PROG_
+00040af0: 5749 5448 4f55 545f 4558 547d 2069 7320  WITHOUT_EXT} is 
+00040b00: 7365 7420 746f 2074 6865 2073 7065 6369  set to the speci
+00040b10: 6669 6564 2076 616c 7565 2e20 220a 2020  fied value. ".  
+00040b20: 2020 2020 2020 2249 6620 2d2d 6c6f 675f        "If --log_
+00040b30: 6c65 7665 6c20 6973 2075 7365 6420 7769  level is used wi
+00040b40: 7468 2074 776f 206c 6576 656c 2061 7267  th two level arg
+00040b50: 756d 656e 7420 220a 2020 2020 2020 2020  ument ".        
+00040b60: 2728 652e 672e 2022 2d2d 6c6f 672d 6c65  '(e.g. "--log-le
+00040b70: 7665 6c20 5741 524e 494e 4720 4552 524f  vel WARNING ERRO
+00040b80: 5222 2920 7468 656e 2027 0a20 2020 2020  R") then '.     
+00040b90: 2020 2066 226c 6f67 206c 6576 656c 7320     f"log levels 
+00040ba0: 6f66 2062 6f74 6820 7b50 524f 475f 5749  of both {PROG_WI
+00040bb0: 5448 4f55 545f 4558 547d 2061 6e64 2075  THOUT_EXT} and u
+00040bc0: 6e64 6572 6c79 696e 6720 6d6f 6475 6c65  nderlying module
+00040bd0: 7320 6172 6520 220a 2020 2020 2020 2020  s are ".        
+00040be0: 2273 6574 2074 6f20 7468 6520 7370 6563  "set to the spec
+00040bf0: 6966 6965 6420 7661 6c75 6573 2e20 220a  ified values. ".
+00040c00: 2020 2020 2020 2020 2253 6565 2061 6c73          "See als
+00040c10: 6f20 2d2d 6465 6275 672e 222c 0a20 2020  o --debug.",.   
+00040c20: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+00040c30: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+00040c40: 222d 2d76 6572 626f 7365 222c 0a20 2020  "--verbose",.   
+00040c50: 2020 2020 2061 6374 696f 6e3d 2263 6f75       action="cou
+00040c60: 6e74 222c 0a20 2020 2020 2020 2064 6566  nt",.        def
+00040c70: 6175 6c74 3d30 2c0a 2020 2020 2020 2020  ault=0,.        
+00040c80: 6865 6c70 3d22 5365 7420 7468 6520 7665  help="Set the ve
+00040c90: 7262 6f73 6974 7920 6c65 7665 6c2e 2022  rbosity level. "
+00040ca0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+00040cb0: 733a 3a20 4966 206e 6f74 2075 7365 642c  s:: If not used,
+00040cc0: 2074 6865 6e20 7665 7262 6f73 6974 7920   then verbosity 
+00040cd0: 7769 6c6c 2062 6520 220a 2020 2020 2020  will be ".      
+00040ce0: 2020 2273 6574 2074 6f20 6c6f 772e 2049    "set to low. I
+00040cf0: 6620 7573 6564 206f 6e63 652c 2076 6572  f used once, ver
+00040d00: 626f 7369 7479 2077 696c 6c20 6265 2068  bosity will be h
+00040d10: 6967 682e 2022 0a20 2020 2020 2020 2022  igh. ".        "
+00040d20: 4966 2075 7365 6420 6d6f 7265 2074 6861  If used more tha
+00040d30: 6e20 6f6e 6365 2c20 7665 7262 6f73 6974  n once, verbosit
+00040d40: 7920 7769 6c6c 2062 6520 7665 7279 2068  y will be very h
+00040d50: 6967 682e 2022 0a20 2020 2020 2020 2022  igh. ".        "
+00040d60: 5665 7262 6f73 6974 7920 6f6e 6c79 2061  Verbosity only a
+00040d70: 6666 6563 7473 2074 6865 2064 6562 7567  ffects the debug
+00040d80: 2069 6e66 6f72 6d61 7469 6f6e 2e20 220a   information. ".
+00040d90: 2020 2020 2020 2020 2253 6f2c 2069 6620          "So, if 
+00040da0: 272d 2d64 6562 7567 2720 6973 206e 6f74  '--debug' is not
+00040db0: 2075 7365 6420 7468 656e 2027 2d2d 7665   used then '--ve
+00040dc0: 7262 6f73 6527 2077 696c 6c20 6265 2069  rbose' will be i
+00040dd0: 676e 6f72 6564 2e22 2c0a 2020 2020 290a  gnored.",.    ).
+00040de0: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+00040df0: 656e 7428 0a20 2020 2020 2020 2022 2d2d  ent(.        "--
+00040e00: 6c6f 6769 6e22 2c0a 2020 2020 2020 2020  login",.        
+00040e10: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00040e20: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00040e30: 2c20 2023 206c 6f67 696e 206d 6574 686f  ,  # login metho
+00040e40: 643a 2070 6173 7377 6f72 642c 2073 736f  d: password, sso
+00040e50: 2c20 2861 6363 6573 732d 746f 6b65 6e29  , (access-token)
+00040e60: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+00040e70: 3d22 5041 5353 574f 5244 7c53 534f 222c  ="PASSWORD|SSO",
+00040e80: 0a20 2020 2020 2020 2068 656c 703d 224c  .        help="L
+00040e90: 6f67 696e 2074 6f20 616e 6420 6175 7468  ogin to and auth
+00040ea0: 656e 7469 6361 7465 2077 6974 6820 7468  enticate with th
+00040eb0: 6520 4d61 7472 6978 2068 6f6d 6573 6572  e Matrix homeser
+00040ec0: 7665 722e 2022 0a20 2020 2020 2020 2022  ver. ".        "
+00040ed0: 4465 7461 696c 733a 3a20 5468 6973 2072  Details:: This r
+00040ee0: 6571 7569 7265 7320 6578 6163 746c 7920  equires exactly 
+00040ef0: 6f6e 6520 6172 6775 6d65 6e74 2c20 7468  one argument, th
+00040f00: 6520 6c6f 6769 6e20 6d65 7468 6f64 2e20  e login method. 
+00040f10: 220a 2020 2020 2020 2020 2243 7572 7265  ".        "Curre
+00040f20: 6e74 6c79 2074 776f 2063 686f 6963 6573  ntly two choices
+00040f30: 2061 7265 206f 6666 6572 6564 3a20 2770   are offered: 'p
+00040f40: 6173 7377 6f72 6427 2061 6e64 2027 7373  assword' and 'ss
+00040f50: 6f27 2e20 220a 2020 2020 2020 2020 2250  o'. ".        "P
+00040f60: 726f 7669 6465 206f 6e65 206f 6620 7468  rovide one of th
+00040f70: 6573 6520 6d65 7468 6f64 732e 2022 0a20  ese methods. ". 
+00040f80: 2020 2020 2020 2022 4966 2079 6f75 2068         "If you h
+00040f90: 6176 6520 6368 6f73 656e 2027 7061 7373  ave chosen 'pass
+00040fa0: 776f 7264 272c 2022 0a20 2020 2020 2020  word', ".       
+00040fb0: 2022 796f 7520 7769 6c6c 2061 7574 6865   "you will authe
+00040fc0: 6e74 6963 6174 6520 7468 726f 7567 6820  nticate through 
+00040fd0: 796f 7572 2061 6363 6f75 6e74 2070 6173  your account pas
+00040fe0: 7377 6f72 642e 2059 6f75 2063 616e 2022  sword. You can "
+00040ff0: 0a20 2020 2020 2020 2022 6f70 7469 6f6e  .        "option
+00041000: 616c 6c79 2070 726f 7669 6465 2074 6865  ally provide the
+00041010: 7365 2061 6464 6974 696f 6e61 6c20 6172  se additional ar
+00041020: 6775 6d65 6e74 733a 2022 0a20 2020 2020  guments: ".     
+00041030: 2020 2022 2d2d 686f 6d65 7365 7276 6572     "--homeserver
+00041040: 2074 6f20 7370 6563 6966 7920 7468 6520   to specify the 
+00041050: 4d61 7472 6978 2068 6f6d 6573 6572 7665  Matrix homeserve
+00041060: 722c 2022 0a20 2020 2020 2020 2022 2d2d  r, ".        "--
+00041070: 7573 6572 2d6c 6f67 696e 2074 6f20 7370  user-login to sp
+00041080: 6563 6966 7920 7468 6520 6c6f 6720 696e  ecify the log in
+00041090: 2075 7365 7220 6964 2c20 220a 2020 2020   user id, ".    
+000410a0: 2020 2020 222d 2d70 6173 7377 6f72 6420      "--password 
+000410b0: 746f 2073 7065 6369 6679 2074 6865 2070  to specify the p
+000410c0: 6173 7377 6f72 642c 2022 0a20 2020 2020  assword, ".     
+000410d0: 2020 2022 2d2d 6465 7669 6365 2074 6f20     "--device to 
+000410e0: 7370 6563 6966 7920 6120 6465 7669 6365  specify a device
+000410f0: 206e 616d 652c 2022 0a20 2020 2020 2020   name, ".       
+00041100: 2022 2d2d 726f 6f6d 2d64 6566 6175 6c74   "--room-default
+00041110: 2074 6f20 7370 6563 6966 7920 6120 6465   to specify a de
+00041120: 6661 756c 7420 726f 6f6d 2066 6f72 2073  fault room for s
+00041130: 656e 6469 6e67 2f6c 6973 7465 6e69 6e67  ending/listening
+00041140: 2e20 220a 2020 2020 2020 2020 2249 6620  . ".        "If 
+00041150: 796f 7520 6861 7665 2063 686f 7365 6e20  you have chosen 
+00041160: 2773 736f 272c 2022 0a20 2020 2020 2020  'sso', ".       
+00041170: 2022 796f 7520 7769 6c6c 2061 7574 6865   "you will authe
+00041180: 6e74 6963 6174 6520 7468 726f 7567 6820  nticate through 
+00041190: 5369 6e67 6c65 2053 6967 6e2d 4f6e 2e20  Single Sign-On. 
+000411a0: 4120 7765 622d 6272 6f77 7365 7220 7769  A web-browser wi
+000411b0: 6c6c 2022 0a20 2020 2020 2020 2022 6265  ll ".        "be
+000411c0: 2073 7461 7274 6564 2061 6e64 2079 6f75   started and you
+000411d0: 2061 7574 6865 6e74 6963 6174 6520 6f6e   authenticate on
+000411e0: 2074 6865 2077 6562 7061 6765 2e20 596f   the webpage. Yo
+000411f0: 7520 6361 6e20 220a 2020 2020 2020 2020  u can ".        
+00041200: 226f 7074 696f 6e61 6c6c 7920 7072 6f76  "optionally prov
+00041210: 6964 6520 7468 6573 6520 6164 6469 7469  ide these additi
+00041220: 6f6e 616c 2061 7267 756d 656e 7473 3a20  onal arguments: 
+00041230: 220a 2020 2020 2020 2020 222d 2d68 6f6d  ".        "--hom
+00041240: 6573 6572 7665 7220 746f 2073 7065 6369  eserver to speci
+00041250: 6679 2074 6865 204d 6174 7269 7820 686f  fy the Matrix ho
+00041260: 6d65 7365 7276 6572 2c20 220a 2020 2020  meserver, ".    
+00041270: 2020 2020 222d 2d75 7365 722d 6c6f 6769      "--user-logi
+00041280: 6e20 746f 2073 7065 6369 6679 2074 6865  n to specify the
+00041290: 206c 6f67 2069 6e20 7573 6572 2069 642c   log in user id,
+000412a0: 2022 0a20 2020 2020 2020 2022 2d2d 6465   ".        "--de
+000412b0: 7669 6365 2074 6f20 7370 6563 6966 7920  vice to specify 
+000412c0: 6120 6465 7669 6365 206e 616d 652c 2022  a device name, "
+000412d0: 0a20 2020 2020 2020 2022 2d2d 726f 6f6d  .        "--room
+000412e0: 2d64 6566 6175 6c74 2074 6f20 7370 6563  -default to spec
+000412f0: 6966 7920 6120 6465 6661 756c 7420 726f  ify a default ro
+00041300: 6f6d 2066 6f72 2073 656e 6469 6e67 2f6c  om for sending/l
+00041310: 6973 7465 6e69 6e67 2e20 220a 2020 2020  istening. ".    
+00041320: 2020 2020 2253 6565 2061 6c6c 2074 6865      "See all the
+00041330: 2065 7874 7261 2061 7267 756d 656e 7473   extra arguments
+00041340: 2066 6f72 2066 7572 7468 6572 2065 7870   for further exp
+00041350: 6c61 6e61 7469 6f6e 732e 202d 2d2d 2d2d  lanations. -----
+00041360: 2022 0a20 2020 2020 2020 2022 5353 4f20   ".        "SSO 
+00041370: 2853 696e 676c 6520 5369 676e 2d4f 6e29  (Single Sign-On)
+00041380: 2073 7461 7274 7320 6120 7765 6220 220a   starts a web ".
+00041390: 2020 2020 2020 2020 2262 726f 7773 6572          "browser
+000413a0: 2061 6e64 2063 6f6e 6e65 6374 7320 7468   and connects th
+000413b0: 6520 7573 6572 2074 6f20 6120 7765 6220  e user to a web 
+000413c0: 7061 6765 206f 6e20 7468 6520 220a 2020  page on the ".  
+000413d0: 2020 2020 2020 2273 6572 7665 7220 666f        "server fo
+000413e0: 7220 6c6f 6769 6e2e 2053 534f 2077 696c  r login. SSO wil
+000413f0: 6c20 6f6e 6c79 2077 6f72 6b20 6966 2074  l only work if t
+00041400: 6865 2073 6572 7665 7220 220a 2020 2020  he server ".    
+00041410: 2020 2020 2273 7570 706f 7274 7320 6974      "supports it
+00041420: 2061 6e64 2069 6620 7468 6572 6520 6973   and if there is
+00041430: 2061 6363 6573 7320 746f 2061 2062 726f   access to a bro
+00041440: 7773 6572 2e20 536f 2c20 646f 6e27 7420  wser. So, don't 
+00041450: 7573 6520 5353 4f20 220a 2020 2020 2020  use SSO ".      
+00041460: 2020 226f 6e20 6865 6164 6c65 7373 2068    "on headless h
+00041470: 6f6d 6573 6572 7665 7273 2077 6865 7265  omeservers where
+00041480: 2074 6865 7265 2069 7320 6e6f 2022 0a20   there is no ". 
+00041490: 2020 2020 2020 2022 6272 6f77 7365 7220         "browser 
+000414a0: 696e 7374 616c 6c65 6420 6f72 2061 6363  installed or acc
+000414b0: 6573 7369 626c 652e 222c 0a20 2020 2029  essible.",.    )
+000414c0: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+000414d0: 6d65 6e74 280a 2020 2020 2020 2020 2320  ment(.        # 
+000414e0: 222d 7622 2c20 2323 2069 6e63 6f6d 7061  "-v", ## incompa
+000414f0: 7469 626c 6520 6368 616e 6765 2c20 2d76  tible change, -v
+00041500: 206d 6f76 6564 2074 6f20 2d2d 7665 7273   moved to --vers
+00041510: 696f 6e0a 2020 2020 2020 2020 222d 2d76  ion.        "--v
+00041520: 6572 6966 7922 2c0a 2020 2020 2020 2020  erify",.        
+00041530: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00041540: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00041550: 2c0a 2020 2020 2020 2020 6465 6661 756c  ,.        defaul
+00041560: 743d 5645 5249 4659 5f55 4e55 5345 445f  t=VERIFY_UNUSED_
+00041570: 4445 4641 554c 542c 2020 2320 7768 656e  DEFAULT,  # when
+00041580: 202d 7420 6973 206e 6f74 2075 7365 640a   -t is not used.
+00041590: 2020 2020 2020 2020 6e61 7267 733d 223f          nargs="?
+000415a0: 222c 2020 2320 6d61 6b65 7320 7468 6520  ",  # makes the 
+000415b0: 776f 7264 206f 7074 696f 6e61 6c0a 2020  word optional.  
+000415c0: 2020 2020 2020 2320 7768 656e 202d 7620        # when -v 
+000415d0: 6973 2075 7365 642c 2062 7574 2074 6578  is used, but tex
+000415e0: 7420 6973 206e 6f74 2061 6464 6564 0a20  t is not added. 
+000415f0: 2020 2020 2020 2063 6f6e 7374 3d56 4552         const=VER
+00041600: 4946 595f 5553 4544 5f44 4546 4155 4c54  IFY_USED_DEFAULT
+00041610: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+00041620: 723d 2245 4d4f 4a49 222c 0a20 2020 2020  r="EMOJI",.     
+00041630: 2020 2068 656c 703d 2250 6572 666f 726d     help="Perform
+00041640: 2076 6572 6966 6963 6174 696f 6e2e 2022   verification. "
+00041650: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+00041660: 733a 3a20 4279 2064 6566 6175 6c74 2c20  s:: By default, 
+00041670: 6e6f 2022 0a20 2020 2020 2020 2022 7665  no ".        "ve
+00041680: 7269 6669 6361 7469 6f6e 2069 7320 7065  rification is pe
+00041690: 7266 6f72 6d65 642e 2022 0a20 2020 2020  rformed. ".     
+000416a0: 2020 2066 2750 6f73 7369 626c 6520 7661     f'Possible va
+000416b0: 6c75 6573 2061 7265 3a20 227b 454d 4f4a  lues are: "{EMOJ
+000416c0: 497d 222e 2027 0a20 2020 2020 2020 2022  I}". '.        "
+000416d0: 4966 2076 6572 6966 6963 6174 696f 6e20  If verification 
+000416e0: 6973 2064 6573 6972 6564 2c20 7275 6e20  is desired, run 
+000416f0: 7468 6973 2070 726f 6772 616d 2069 6e20  this program in 
+00041700: 7468 6520 220a 2020 2020 2020 2020 2266  the ".        "f
+00041710: 6f72 6567 726f 756e 6420 286e 6f74 2061  oreground (not a
+00041720: 7320 6120 7365 7276 6963 6529 2061 6e64  s a service) and
+00041730: 2077 6974 686f 7574 2061 2070 6970 652e   without a pipe.
+00041740: 2022 0a20 2020 2020 2020 2022 5768 696c   ".        "Whil
+00041750: 6520 7665 7269 6669 6361 7469 6f6e 2069  e verification i
+00041760: 7320 6f70 7469 6f6e 616c 2069 7420 6973  s optional it is
+00041770: 2068 6967 686c 7920 7265 636f 6d6d 656e   highly recommen
+00041780: 6465 642c 2061 6e64 2069 7420 220a 2020  ded, and it ".  
+00041790: 2020 2020 2020 2269 7320 7265 636f 6d6d        "is recomm
+000417a0: 656e 6465 6420 746f 2062 6520 646f 6e65  ended to be done
+000417b0: 2072 6967 6874 2061 6674 6572 2028 6f72   right after (or
+000417c0: 2074 6f67 6574 6865 7220 7769 7468 2920   together with) 
+000417d0: 7468 6520 220a 2020 2020 2020 2020 222d  the ".        "-
+000417e0: 2d6c 6f67 696e 2061 6374 696f 6e2e 2056  -login action. V
+000417f0: 6572 6966 6963 6174 696f 6e20 6973 2061  erification is a
+00041800: 6c77 6179 7320 696e 7465 7261 6374 6976  lways interactiv
+00041810: 652c 2069 2e65 2e20 6974 2022 0a20 2020  e, i.e. it ".   
+00041820: 2020 2020 2022 7265 7175 6972 6564 206b       "required k
+00041830: 6579 626f 6172 6420 696e 7075 742e 2022  eyboard input. "
+00041840: 0a20 2020 2020 2020 2022 5665 7269 6669  .        "Verifi
+00041850: 6361 7469 6f6e 2071 7565 7374 696f 6e73  cation questions
+00041860: 2022 0a20 2020 2020 2020 2022 7769 6c6c   ".        "will
+00041870: 2062 6520 7072 696e 7465 6420 6f6e 2073   be printed on s
+00041880: 7464 6f75 7420 616e 6420 7468 6520 7573  tdout and the us
+00041890: 6572 2068 6173 2074 6f20 7265 7370 6f6e  er has to respon
+000418a0: 6420 220a 2020 2020 2020 2020 2276 6961  d ".        "via
+000418b0: 2074 6865 206b 6579 626f 6172 6420 746f   the keyboard to
+000418c0: 2061 6363 6570 7420 6f72 2072 656a 6563   accept or rejec
+000418d0: 7420 7665 7269 6669 6361 7469 6f6e 2e20  t verification. 
+000418e0: 220a 2020 2020 2020 2020 224f 6e63 6520  ".        "Once 
+000418f0: 7665 7269 6669 6361 7469 6f6e 2069 7320  verification is 
+00041900: 636f 6d70 6c65 7465 2c20 7468 6520 7072  complete, the pr
+00041910: 6f67 7261 6d20 6d61 7920 6265 2022 0a20  ogram may be ". 
+00041920: 2020 2020 2020 2022 7275 6e20 6173 2061         "run as a
+00041930: 2073 6572 7669 6365 2e20 5665 7269 6669   service. Verifi
+00041940: 6361 7469 6f6e 2069 7320 6265 7374 2064  cation is best d
+00041950: 6f6e 6520 6173 2066 6f6c 6c6f 7773 3a20  one as follows: 
+00041960: 220a 2020 2020 2020 2020 2250 6572 666f  ".        "Perfo
+00041970: 726d 2061 2063 726f 7373 2d64 6576 6963  rm a cross-devic
+00041980: 6520 7665 7269 6669 6361 7469 6f6e 2c20  e verification, 
+00041990: 7468 6174 206d 6561 6e73 2c20 7065 7266  that means, perf
+000419a0: 6f72 6d20 6120 220a 2020 2020 2020 2020  orm a ".        
+000419b0: 2276 6572 6966 6963 6174 696f 6e20 6265  "verification be
+000419c0: 7477 6565 6e20 7477 6f20 6465 7669 6365  tween two device
+000419d0: 7320 6f66 2074 6865 202a 7361 6d65 2a20  s of the *same* 
+000419e0: 7573 6572 2e20 466f 7220 7468 6174 2c20  user. For that, 
+000419f0: 220a 2020 2020 2020 2020 226f 7065 6e20  ".        "open 
+00041a00: 2865 2e67 2e29 2045 6c65 6d65 6e74 2069  (e.g.) Element i
+00041a10: 6e20 6120 6272 6f77 7365 722c 206d 616b  n a browser, mak
+00041a20: 6520 7375 7265 2045 6c65 6d65 6e74 2069  e sure Element i
+00041a30: 7320 7573 696e 6720 7468 6520 220a 2020  s using the ".  
+00041a40: 2020 2020 2020 6622 7361 6d65 2075 7365        f"same use
+00041a50: 7220 6163 636f 756e 7420 6173 2074 6865  r account as the
+00041a60: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
+00041a70: 5854 7d20 7573 6572 2028 7370 6563 6966  XT} user (specif
+00041a80: 6965 6420 7769 7468 2022 0a20 2020 2020  ied with ".     
+00041a90: 2020 2022 2d2d 7573 6572 2d6c 6f67 696e     "--user-login
+00041aa0: 2061 7420 2d2d 6c6f 6769 6e29 2e20 4e6f   at --login). No
+00041ab0: 7720 696e 2074 6865 2045 6c65 6d65 6e74  w in the Element
+00041ac0: 2077 6562 7061 6765 2067 6f20 746f 2074   webpage go to t
+00041ad0: 6865 2072 6f6f 6d20 220a 2020 2020 2020  he room ".      
+00041ae0: 2020 6622 7468 6174 2069 7320 7468 6520    f"that is the 
+00041af0: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+00041b00: 547d 2064 6566 6175 6c74 2072 6f6f 6d20  T} default room 
+00041b10: 2873 7065 6369 6669 6564 2077 6974 6820  (specified with 
+00041b20: 220a 2020 2020 2020 2020 222d 2d72 6f6f  ".        "--roo
+00041b30: 6d2d 6465 6661 756c 7420 6174 202d 2d6c  m-default at --l
+00041b40: 6f67 696e 292e 204f 4b2c 2069 6e20 7468  ogin). OK, in th
+00041b50: 6520 7765 622d 6272 6f77 7365 7220 796f  e web-browser yo
+00041b60: 7520 6172 6520 6e6f 7720 7468 6520 220a  u are now the ".
+00041b70: 2020 2020 2020 2020 6622 7361 6d65 2075          f"same u
+00041b80: 7365 7220 616e 6420 696e 2074 6865 2073  ser and in the s
+00041b90: 616d 6520 726f 6f6d 2061 7320 7b50 524f  ame room as {PRO
+00041ba0: 475f 5749 5448 4f55 545f 4558 547d 2e20  G_WITHOUT_EXT}. 
+00041bb0: 220a 2020 2020 2020 2020 224e 6f77 2063  ".        "Now c
+00041bc0: 6c69 636b 2074 6865 2072 6f75 6e64 2027  lick the round '
+00041bd0: 6927 2027 526f 6f6d 2049 6e66 6f27 2069  i' 'Room Info' i
+00041be0: 636f 6e2c 2074 6865 6e20 636c 6963 6b20  con, then click 
+00041bf0: 2750 656f 706c 6527 2c20 220a 2020 2020  'People', ".    
+00041c00: 2020 2020 6622 636c 6963 6b20 7468 6520      f"click the 
+00041c10: 6170 7072 6f70 7269 6174 6520 7573 6572  appropriate user
+00041c20: 2028 7468 6520 7b50 524f 475f 5749 5448   (the {PROG_WITH
+00041c30: 4f55 545f 4558 547d 2075 7365 7229 2c20  OUT_EXT} user), 
+00041c40: 220a 2020 2020 2020 2020 2263 6c69 636b  ".        "click
+00041c50: 2072 6564 2027 4e6f 7420 5472 7573 7465   red 'Not Truste
+00041c60: 6427 2074 6578 7420 220a 2020 2020 2020  d' text ".      
+00041c70: 2020 2277 6869 6368 2069 6e64 6963 6174    "which indicat
+00041c80: 6564 2061 6e20 756e 7472 7573 7465 6420  ed an untrusted 
+00041c90: 6465 7669 6365 2c20 7468 656e 2063 6c69  device, then cli
+00041ca0: 636b 2074 6865 2073 7175 6172 6520 220a  ck the square ".
+00041cb0: 2020 2020 2020 2020 2227 496e 7465 7261          "'Intera
+00041cc0: 6374 6976 656c 7920 7665 7269 6679 2062  ctively verify b
+00041cd0: 7920 456d 6f6a 6927 2062 7574 746f 6e20  y Emoji' button 
+00041ce0: 286f 6e65 206f 6620 3320 6275 7474 6f6e  (one of 3 button
+00041cf0: 2063 686f 6963 6573 292e 2022 0a20 2020   choices). ".   
+00041d00: 2020 2020 2066 2241 7420 7468 6973 2070       f"At this p
+00041d10: 6f69 6e74 2062 6f74 6820 7765 622d 7061  oint both web-pa
+00041d20: 6765 2061 6e64 207b 5052 4f47 5f57 4954  ge and {PROG_WIT
+00041d30: 484f 5554 5f45 5854 7d20 696e 2074 6572  HOUT_EXT} in ter
+00041d40: 6d69 6e61 6c20 220a 2020 2020 2020 2020  minal ".        
+00041d50: 2273 686f 7720 6120 7365 7420 6f66 2065  "show a set of e
+00041d60: 6d6f 6a69 2069 636f 6e73 2061 6e64 206e  moji icons and n
+00041d70: 616d 6573 2e20 436f 6d70 6172 6520 7468  ames. Compare th
+00041d80: 656d 2076 6973 7561 6c6c 792e 2022 0a20  em visually. ". 
+00041d90: 2020 2020 2020 2022 436f 6e66 6972 6d20         "Confirm 
+00041da0: 6f6e 2062 6f74 6820 7369 6465 7320 2859  on both sides (Y
+00041db0: 6573 2c20 5468 6579 204d 6174 6368 2c20  es, They Match, 
+00041dc0: 476f 7420 6974 292c 2066 696e 616c 6c79  Got it), finally
+00041dd0: 2063 6c69 636b 204f 4b2e 2022 0a20 2020   click OK. ".   
+00041de0: 2020 2020 2022 596f 7520 7368 6f75 6c64       "You should
+00041df0: 2073 6565 2061 2067 7265 656e 2073 6869   see a green shi
+00041e00: 656c 6420 616e 6420 616c 736f 2073 6565  eld and also see
+00041e10: 2074 6861 7420 7468 6520 220a 2020 2020   that the ".    
+00041e20: 2020 2020 6622 7b50 524f 475f 5749 5448      f"{PROG_WITH
+00041e30: 4f55 545f 4558 547d 2064 6576 6963 6520  OUT_EXT} device 
+00041e40: 6973 206e 6f77 2067 7265 656e 2061 6e64  is now green and
+00041e50: 2076 6572 6966 6965 6420 696e 2074 6865   verified in the
+00041e60: 2077 6562 7061 6765 2e20 220a 2020 2020   webpage. ".    
+00041e70: 2020 2020 2249 6e20 7468 6520 7465 726d      "In the term
+00041e80: 696e 616c 2079 6f75 2073 686f 756c 6420  inal you should 
+00041e90: 7365 6520 6120 7465 7874 206d 6573 7361  see a text messa
+00041ea0: 6765 2069 6e64 6963 6174 696e 6720 7375  ge indicating su
+00041eb0: 6363 6573 732e 2022 0a20 2020 2020 2020  ccess. ".       
+00041ec0: 2022 596f 7520 7368 6f75 6c64 206e 6f77   "You should now
+00041ed0: 2062 6520 7665 7269 6669 6564 2061 6372   be verified acr
+00041ee0: 6f73 7320 616c 6c20 6465 7669 6365 7320  oss all devices 
+00041ef0: 616e 6420 6163 726f 7373 2061 6c6c 2075  and across all u
+00041f00: 7365 7273 2e22 2c0a 2020 2020 290a 2020  sers.",.    ).  
+00041f10: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+00041f20: 7428 0a20 2020 2020 2020 2022 2d2d 6c6f  t(.        "--lo
+00041f30: 676f 7574 222c 0a20 2020 2020 2020 2072  gout",.        r
+00041f40: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+00041f50: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+00041f60: 2020 2320 6c6f 676f 7574 206f 7074 696f    # logout optio
+00041f70: 6e73 3a20 6d65 2061 6e64 2061 6c6c 0a20  ns: me and all. 
+00041f80: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+00041f90: 4d45 7c41 4c4c 222c 0a20 2020 2020 2020  ME|ALL",.       
+00041fa0: 2068 656c 703d 224c 6f67 6f75 742e 2022   help="Logout. "
+00041fb0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+00041fc0: 733a 3a20 4c6f 676f 7574 2074 6869 7320  s:: Logout this 
+00041fd0: 6f72 2061 6c6c 2064 6576 6963 6573 2066  or all devices f
+00041fe0: 726f 6d20 7468 6520 4d61 7472 6978 2068  rom the Matrix h
+00041ff0: 6f6d 6573 6572 7665 722e 2022 0a20 2020  omeserver. ".   
+00042000: 2020 2020 2022 5468 6973 2072 6571 7569       "This requi
+00042010: 7265 7320 6578 6163 746c 7920 6f6e 6520  res exactly one 
+00042020: 6172 6775 6d65 6e74 2e20 220a 2020 2020  argument. ".    
+00042030: 2020 2020 2254 776f 2063 686f 6963 6573      "Two choices
+00042040: 2061 7265 206f 6666 6572 6564 3a20 276d   are offered: 'm
+00042050: 6527 2061 6e64 2027 616c 6c27 2e20 220a  e' and 'all'. ".
+00042060: 2020 2020 2020 2020 2250 726f 7669 6465          "Provide
+00042070: 206f 6e65 206f 6620 7468 6573 6520 6368   one of these ch
+00042080: 6f69 6365 732e 2022 0a20 2020 2020 2020  oices. ".       
+00042090: 2066 2249 6620 796f 7520 6368 6f6f 7365   f"If you choose
+000420a0: 2027 6d65 272c 206f 6e6c 7920 7468 6520   'me', only the 
+000420b0: 6f6e 6520 6465 7669 6365 207b 5052 4f47  one device {PROG
+000420c0: 5f57 4954 484f 5554 5f45 5854 7d20 220a  _WITHOUT_EXT} ".
+000420d0: 2020 2020 2020 2020 2269 7320 6375 7272          "is curr
+000420e0: 656e 746c 7920 7573 696e 6720 7769 6c6c  ently using will
+000420f0: 2062 6520 6c6f 6767 6564 206f 7574 2e20   be logged out. 
+00042100: 220a 2020 2020 2020 2020 2249 6620 796f  ".        "If yo
+00042110: 7520 6368 6f6f 7365 2027 616c 6c27 2c20  u choose 'all', 
+00042120: 616c 6c20 6465 7669 6365 7320 6f66 2074  all devices of t
+00042130: 6865 2075 7365 7220 7573 6564 2062 7920  he user used by 
+00042140: 220a 2020 2020 2020 2020 6622 7b50 524f  ".        f"{PRO
+00042150: 475f 5749 5448 4f55 545f 4558 547d 2077  G_WITHOUT_EXT} w
+00042160: 696c 6c20 6265 206c 6f67 6765 6420 6f75  ill be logged ou
+00042170: 742e 2022 0a20 2020 2020 2020 2022 5768  t. ".        "Wh
+00042180: 696c 6520 2d2d 6c6f 676f 7574 206e 6569  ile --logout nei
+00042190: 7468 6572 2072 656d 6f76 6573 2074 6865  ther removes the
+000421a0: 2063 7265 6465 6e74 6961 6c73 206e 6f72   credentials nor
+000421b0: 2074 6865 2073 746f 7265 2c20 7468 6520   the store, the 
+000421c0: 220a 2020 2020 2020 2020 226c 6f67 6f75  ".        "logou
+000421d0: 7420 6163 7469 6f6e 2072 656d 6f76 6573  t action removes
+000421e0: 2074 6865 2064 6576 6963 6520 616e 6420   the device and 
+000421f0: 6d61 6b65 7320 7468 6520 6163 6365 7373  makes the access
+00042200: 2d74 6f6b 656e 2073 746f 7265 6420 220a  -token stored ".
+00042210: 2020 2020 2020 2020 2269 6e20 7468 6520          "in the 
+00042220: 6372 6564 656e 7469 616c 7320 696e 7661  credentials inva
+00042230: 6c69 642e 2048 656e 6365 2c20 6166 7465  lid. Hence, afte
+00042240: 7220 6120 2d2d 6c6f 676f 7574 2c20 6f6e  r a --logout, on
+00042250: 6520 6d75 7374 2022 0a20 2020 2020 2020  e must ".       
+00042260: 2022 6d61 6e75 616c 6c79 2072 656d 6f76   "manually remov
+00042270: 6520 6372 6564 656e 7469 616c 7320 616e  e credentials an
+00042280: 6420 7374 6f72 652c 2061 6e64 2074 6865  d store, and the
+00042290: 6e20 7065 7266 6f72 6d20 6120 6e65 7720  n perform a new 
+000422a0: 220a 2020 2020 2020 2020 6622 2d2d 6c6f  ".        f"--lo
+000422b0: 6769 6e20 746f 2075 7365 207b 5052 4f47  gin to use {PROG
+000422c0: 5f57 4954 484f 5554 5f45 5854 7d20 6167  _WITHOUT_EXT} ag
+000422d0: 6169 6e2e 2022 0a20 2020 2020 2020 2022  ain. ".        "
+000422e0: 596f 7520 6361 6e20 7065 7266 6563 746c  You can perfectl
+000422f0: 7920 7573 6520 220a 2020 2020 2020 2020  y use ".        
+00042300: 6622 7b50 524f 475f 5749 5448 4f55 545f  f"{PROG_WITHOUT_
+00042310: 4558 547d 2077 6974 686f 7574 2065 7665  EXT} without eve
+00042320: 7220 6c6f 6767 696e 6720 6f75 742e 202d  r logging out. -
+00042330: 2d6c 6f67 6f75 7420 6973 2061 2063 6c65  -logout is a cle
+00042340: 616e 7570 2022 0a20 2020 2020 2020 2022  anup ".        "
+00042350: 6966 2079 6f75 2068 6176 6520 6465 6369  if you have deci
+00042360: 6465 6420 6e6f 7420 746f 2075 7365 2074  ded not to use t
+00042370: 6869 7320 286f 7220 616c 6c29 2064 6576  his (or all) dev
+00042380: 6963 6528 7329 2065 7665 7220 6167 6169  ice(s) ever agai
+00042390: 6e2e 222c 0a20 2020 2029 0a20 2020 2061  n.",.    ).    a
+000423a0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+000423b0: 2020 2020 2020 2020 222d 6322 2c0a 2020          "-c",.  
+000423c0: 2020 2020 2020 222d 2d63 7265 6465 6e74        "--credent
+000423d0: 6961 6c73 222c 0a20 2020 2020 2020 2072  ials",.        r
+000423e0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+000423f0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+00042400: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+00042410: 3d43 5245 4445 4e54 4941 4c53 5f46 494c  =CREDENTIALS_FIL
+00042420: 455f 4445 4641 554c 542c 0a20 2020 2020  E_DEFAULT,.     
+00042430: 2020 206d 6574 6176 6172 3d22 4352 4544     metavar="CRED
+00042440: 454e 5449 414c 535f 4649 4c45 222c 0a20  ENTIALS_FILE",. 
+00042450: 2020 2020 2020 2068 656c 703d 2253 7065         help="Spe
+00042460: 6369 6679 206c 6f63 6174 696f 6e20 6f66  cify location of
+00042470: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+00042480: 652e 2022 0a20 2020 2020 2020 2022 4465  e. ".        "De
+00042490: 7461 696c 733a 3a20 4f6e 2066 6972 7374  tails:: On first
+000424a0: 2072 756e 2c20 696e 666f 726d 6174 696f   run, informatio
+000424b0: 6e20 6162 6f75 7420 686f 6d65 7365 7276  n about homeserv
+000424c0: 6572 2c20 220a 2020 2020 2020 2020 2275  er, ".        "u
+000424d0: 7365 722c 2072 6f6f 6d20 6964 2c20 6574  ser, room id, et
+000424e0: 632e 2077 696c 6c20 6265 2077 7269 7474  c. will be writt
+000424f0: 656e 2074 6f20 6120 6372 6564 656e 7469  en to a credenti
+00042500: 616c 7320 220a 2020 2020 2020 2020 2266  als ".        "f
+00042510: 696c 652e 2042 7920 6465 6661 756c 742c  ile. By default,
+00042520: 2074 6869 7320 6669 6c65 2022 0a20 2020   this file ".   
+00042530: 2020 2020 2066 2769 7320 227b 4352 4544       f'is "{CRED
+00042540: 454e 5449 414c 535f 4649 4c45 5f44 4546  ENTIALS_FILE_DEF
+00042550: 4155 4c54 7d22 2e20 270a 2020 2020 2020  AULT}". '.      
+00042560: 2020 224f 6e20 6675 7274 6865 7220 7275    "On further ru
+00042570: 6e73 2074 6865 2063 7265 6465 6e74 6961  ns the credentia
+00042580: 6c73 2066 696c 6520 6973 2072 6561 6420  ls file is read 
+00042590: 746f 2022 0a20 2020 2020 2020 2022 7065  to ".        "pe
+000425a0: 726d 6974 206c 6f67 6769 6e67 2069 6e74  rmit logging int
+000425b0: 6f20 7468 6520 636f 7272 6563 7420 4d61  o the correct Ma
+000425c0: 7472 6978 2061 6363 6f75 6e74 2022 0a20  trix account ". 
+000425d0: 2020 2020 2020 2022 616e 6420 7365 6e64         "and send
+000425e0: 696e 6720 6d65 7373 6167 6573 2074 6f20  ing messages to 
+000425f0: 7468 6520 7072 6563 6f6e 6669 6775 7265  the preconfigure
+00042600: 6420 726f 6f6d 2e20 220a 2020 2020 2020  d room. ".      
+00042610: 2020 2249 6620 7468 6973 206f 7074 696f    "If this optio
+00042620: 6e20 6973 2070 726f 7669 6465 642c 2074  n is provided, t
+00042630: 6865 2070 726f 7669 6465 6420 6669 6c65  he provided file
+00042640: 206e 616d 6520 220a 2020 2020 2020 2020   name ".        
+00042650: 2277 696c 6c20 6265 2075 7365 6420 6173  "will be used as
+00042660: 2063 7265 6465 6e74 6961 6c73 2066 696c   credentials fil
+00042670: 6520 696e 7374 6561 6420 6f66 2074 6865  e instead of the
+00042680: 2022 0a20 2020 2020 2020 2022 6465 6661   ".        "defa
+00042690: 756c 7420 6f6e 652e 2022 2c0a 2020 2020  ult one. ",.    
+000426a0: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+000426b0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+000426c0: 2d73 222c 0a20 2020 2020 2020 2022 2d2d  -s",.        "--
+000426d0: 7374 6f72 6522 2c0a 2020 2020 2020 2020  store",.        
+000426e0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+000426f0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00042700: 2c0a 2020 2020 2020 2020 6465 6661 756c  ,.        defaul
+00042710: 743d 5354 4f52 455f 4449 525f 4445 4641  t=STORE_DIR_DEFA
+00042720: 554c 542c 0a20 2020 2020 2020 206d 6574  ULT,.        met
+00042730: 6176 6172 3d22 5354 4f52 455f 4449 5245  avar="STORE_DIRE
+00042740: 4354 4f52 5922 2c0a 2020 2020 2020 2020  CTORY",.        
+00042750: 6865 6c70 3d22 5370 6563 6966 7920 6c6f  help="Specify lo
+00042760: 6361 7469 6f6e 206f 6620 7374 6f72 6520  cation of store 
+00042770: 6469 7265 6374 6f72 792e 2022 0a20 2020  directory. ".   
+00042780: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+00042790: 5061 7468 2074 6f20 6469 7265 6374 6f72  Path to director
+000427a0: 7920 746f 2062 6520 220a 2020 2020 2020  y to be ".      
+000427b0: 2020 2775 7365 6420 6173 2022 7374 6f72    'used as "stor
+000427c0: 6522 2066 6f72 2065 6e63 7279 7074 6564  e" for encrypted
+000427d0: 206d 6573 7361 6769 6e67 2e20 270a 2020   messaging. '.  
+000427e0: 2020 2020 2020 2242 7920 6465 6661 756c        "By defaul
+000427f0: 742c 2074 6869 7320 6469 7265 6374 6f72  t, this director
+00042800: 7920 220a 2020 2020 2020 2020 6627 6973  y ".        f'is
+00042810: 2022 7b53 544f 5245 5f44 4952 5f44 4546   "{STORE_DIR_DEF
+00042820: 4155 4c54 7d22 2e20 270a 2020 2020 2020  AULT}". '.      
+00042830: 2020 2253 696e 6365 2065 6e63 7279 7074    "Since encrypt
+00042840: 696f 6e20 6973 2061 6c77 6179 7320 656e  ion is always en
+00042850: 6162 6c65 642c 2061 2073 746f 7265 2069  abled, a store i
+00042860: 7320 220a 2020 2020 2020 2020 2261 6c77  s ".        "alw
+00042870: 6179 7320 6e65 6564 6564 2e20 220a 2020  ays needed. ".  
+00042880: 2020 2020 2020 2254 6865 2070 726f 7669        "The provi
+00042890: 6465 6420 6469 7265 6374 6f72 7920 6e61  ded directory na
+000428a0: 6d65 2022 0a20 2020 2020 2020 2022 7769  me ".        "wi
+000428b0: 6c6c 2062 6520 7573 6564 2061 7320 7065  ll be used as pe
+000428c0: 7273 6973 7465 6e74 2073 746f 7261 6765  rsistent storage
+000428d0: 2064 6972 6563 746f 7279 2069 6e73 7465   directory inste
+000428e0: 6164 206f 6620 220a 2020 2020 2020 2020  ad of ".        
+000428f0: 2274 6865 2064 6566 6175 6c74 206f 6e65  "the default one
+00042900: 2e20 5072 6566 6572 6162 6c79 2c20 666f  . Preferably, fo
+00042910: 7220 6d75 6c74 6970 6c65 2065 7865 6375  r multiple execu
+00042920: 7469 6f6e 7320 220a 2020 2020 2020 2020  tions ".        
+00042930: 226f 6620 7468 6973 2070 726f 6772 616d  "of this program
+00042940: 2075 7365 2074 6865 2073 616d 6520 7374   use the same st
+00042950: 6f72 6520 666f 7220 7468 6520 7361 6d65  ore for the same
+00042960: 2064 6576 6963 652e 2022 0a20 2020 2020   device. ".     
+00042970: 2020 2022 5468 6520 7374 6f72 6520 6469     "The store di
+00042980: 7265 6374 6f72 7920 6361 6e20 6265 2073  rectory can be s
+00042990: 6861 7265 6420 6265 7477 6565 6e20 6d75  hared between mu
+000429a0: 6c74 6970 6c65 2022 0a20 2020 2020 2020  ltiple ".       
+000429b0: 2022 6469 6666 6572 656e 7420 6465 7669   "different devi
+000429c0: 6365 7320 616e 6420 7573 6572 732e 222c  ces and users.",
+000429d0: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
+000429e0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
+000429f0: 2020 2020 222d 7222 2c0a 2020 2020 2020      "-r",.      
+00042a00: 2020 222d 2d72 6f6f 6d22 2c0a 2020 2020    "--room",.    
+00042a10: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00042a20: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+00042a30: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+00042a40: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+00042a50: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00042a60: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+00042a70: 723d 2252 4f4f 4d22 2c0a 2020 2020 2020  r="ROOM",.      
+00042a80: 2020 6865 6c70 3d22 5370 6563 6966 7920    help="Specify 
+00042a90: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+00042aa0: 726f 6f6d 732e 2022 0a20 2020 2020 2020  rooms. ".       
+00042ab0: 2022 4465 7461 696c 733a 3a20 4f70 7469   "Details:: Opti
+00042ac0: 6f6e 616c 6c79 2073 7065 6369 6679 206f  onally specify o
+00042ad0: 6e65 206f 7220 6d75 6c74 6970 6c65 2072  ne or multiple r
+00042ae0: 6f6f 6d73 2076 6961 2072 6f6f 6d20 6964  ooms via room id
+00042af0: 7320 6f72 2022 0a20 2020 2020 2020 2022  s or ".        "
+00042b00: 726f 6f6d 2061 6c69 6173 6573 2e20 2d2d  room aliases. --
+00042b10: 726f 6f6d 2069 7320 7573 6564 2062 7920  room is used by 
+00042b20: 7661 7269 6f75 7320 7365 6e64 2061 6374  various send act
+00042b30: 696f 6e73 2061 6e64 2022 0a20 2020 2020  ions and ".     
+00042b40: 2020 2022 7661 7269 6f75 7320 6c69 7374     "various list
+00042b50: 656e 2061 6374 696f 6e73 2e20 220a 2020  en actions. ".  
+00042b60: 2020 2020 2020 2254 6865 2064 6566 6175        "The defau
+00042b70: 6c74 2072 6f6f 6d20 6973 2070 726f 7669  lt room is provi
+00042b80: 6465 6420 220a 2020 2020 2020 2020 2269  ded ".        "i
+00042b90: 6e20 7468 6520 6372 6564 656e 7469 616c  n the credential
+00042ba0: 7320 6669 6c65 2028 7370 6563 6966 6965  s file (specifie
+00042bb0: 6420 6174 202d 2d6c 6f67 696e 2077 6974  d at --login wit
+00042bc0: 6820 2d2d 726f 6f6d 2d64 6566 6175 6c74  h --room-default
+00042bd0: 292e 2022 0a20 2020 2020 2020 2022 4966  ). ".        "If
+00042be0: 2061 2072 6f6f 6d20 286f 7220 6d75 6c74   a room (or mult
+00042bf0: 6970 6c65 206f 6e65 7329 2022 0a20 2020  iple ones) ".   
+00042c00: 2020 2020 2022 6973 2028 6f72 2061 7265       "is (or are
+00042c10: 2920 7072 6f76 6964 6564 2069 6e20 7468  ) provided in th
+00042c20: 6520 2d2d 726f 6f6d 2061 7267 756d 656e  e --room argumen
+00042c30: 7473 2c20 7468 656e 2069 7420 220a 2020  ts, then it ".  
+00042c40: 2020 2020 2020 2228 6f72 2074 6865 7929        "(or they)
+00042c50: 2077 696c 6c20 6265 2075 7365 6420 220a   will be used ".
+00042c60: 2020 2020 2020 2020 2269 6e73 7465 6164          "instead
+00042c70: 206f 6620 7468 6520 6f6e 6520 6672 6f6d   of the one from
+00042c80: 2074 6865 2063 7265 6465 6e74 6961 6c73   the credentials
+00042c90: 2066 696c 652e 2022 0a20 2020 2020 2020   file. ".       
+00042ca0: 2022 5468 6520 7573 6572 206d 7573 7420   "The user must 
+00042cb0: 6861 7665 2061 6363 6573 7320 746f 2074  have access to t
+00042cc0: 6865 2073 7065 6369 6669 6564 2072 6f6f  he specified roo
+00042cd0: 6d20 220a 2020 2020 2020 2020 2269 6e20  m ".        "in 
+00042ce0: 6f72 6465 7220 746f 2073 656e 6420 6d65  order to send me
+00042cf0: 7373 6167 6573 2074 6865 7265 206f 7220  ssages there or 
+00042d00: 6c69 7374 656e 206f 6e20 7468 6520 726f  listen on the ro
+00042d10: 6f6d 2e20 220a 2020 2020 2020 2020 224d  om. ".        "M
+00042d20: 6573 7361 6765 7320 6361 6e6e 6f74 2022  essages cannot "
+00042d30: 0a20 2020 2020 2020 2022 6265 2073 656e  .        "be sen
+00042d40: 7420 746f 2061 7262 6974 7261 7279 2072  t to arbitrary r
+00042d50: 6f6f 6d73 2e20 5768 656e 2073 7065 6369  ooms. When speci
+00042d60: 6679 696e 6720 7468 6520 220a 2020 2020  fying the ".    
+00042d70: 2020 2020 2272 6f6f 6d20 6964 2073 6f6d      "room id som
+00042d80: 6520 7368 656c 6c73 2072 6571 7569 7265  e shells require
+00042d90: 2074 6865 2065 7863 6c61 6d61 7469 6f6e   the exclamation
+00042da0: 206d 6172 6b20 220a 2020 2020 2020 2020   mark ".        
+00042db0: 2274 6f20 6265 2065 7363 6170 6564 2077  "to be escaped w
+00042dc0: 6974 6820 6120 6261 636b 736c 6173 682e  ith a backslash.
+00042dd0: 2022 0a20 2020 2020 2020 2022 4173 2061   ".        "As a
+00042de0: 6e20 616c 7465 726e 6174 6976 6520 746f  n alternative to
+00042df0: 2073 7065 6369 6679 696e 6720 6120 726f   specifying a ro
+00042e00: 6f6d 2061 7320 6465 7374 696e 6174 696f  om as destinatio
+00042e10: 6e2c 2022 0a20 2020 2020 2020 2022 6f6e  n, ".        "on
+00042e20: 6520 6361 6e20 7370 6563 6966 7920 6120  e can specify a 
+00042e30: 7573 6572 2061 7320 6120 6465 7374 696e  user as a destin
+00042e40: 6174 696f 6e20 7769 7468 2074 6865 2027  ation with the '
+00042e50: 2d2d 7573 6572 2720 220a 2020 2020 2020  --user' ".      
+00042e60: 2020 2261 7267 756d 656e 742e 2053 6565    "argument. See
+00042e70: 2027 2d2d 7573 6572 2720 616e 6420 7468   '--user' and th
+00042e80: 6520 7465 726d 2027 444d 2028 6469 7265  e term 'DM (dire
+00042e90: 6374 206d 6573 7361 6769 6e67 2927 2022  ct messaging)' "
+00042ea0: 0a20 2020 2020 2020 2022 666f 7220 6465  .        "for de
+00042eb0: 7461 696c 732e 2053 7065 6369 6679 696e  tails. Specifyin
+00042ec0: 6720 6120 726f 6f6d 2069 7320 616c 7761  g a room is alwa
+00042ed0: 7973 2066 6173 7465 7220 616e 6420 6d6f  ys faster and mo
+00042ee0: 7265 2022 0a20 2020 2020 2020 2022 6566  re ".        "ef
+00042ef0: 6669 6369 656e 7420 7468 616e 2073 7065  ficient than spe
+00042f00: 6369 6679 696e 6720 6120 7573 6572 2e20  cifying a user. 
+00042f10: 4e6f 7420 616c 6c20 6c69 7374 656e 206f  Not all listen o
+00042f20: 7065 7261 7469 6f6e 7320 220a 2020 2020  perations ".    
+00042f30: 2020 2020 2261 6c6c 6f77 2073 6574 7469      "allow setti
+00042f40: 6e67 2061 2072 6f6f 6d2e 2052 6561 6420  ng a room. Read 
+00042f50: 6d6f 7265 2075 6e64 6572 2074 6865 202d  more under the -
+00042f60: 2d6c 6973 7465 6e20 6f70 7469 6f6e 7320  -listen options 
+00042f70: 220a 2020 2020 2020 2020 2261 6e64 2073  ".        "and s
+00042f80: 696d 696c 6172 2e20 4d6f 7374 2061 6374  imilar. Most act
+00042f90: 696f 6e73 2061 6c73 6f20 7375 7070 6f72  ions also suppor
+00042fa0: 7420 726f 6f6d 2061 6c69 6173 6573 2069  t room aliases i
+00042fb0: 6e73 7465 6164 206f 6620 220a 2020 2020  nstead of ".    
+00042fc0: 2020 2020 2272 6f6f 6d20 6964 732e 2053      "room ids. S
+00042fd0: 6f6d 6520 6576 656e 2073 686f 7274 2072  ome even short r
+00042fe0: 6f6f 6d20 616c 6961 7365 732e 222c 0a20  oom aliases.",. 
+00042ff0: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+00043000: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+00043010: 2020 222d 2d72 6f6f 6d2d 6465 6661 756c    "--room-defaul
+00043020: 7422 2c0a 2020 2020 2020 2020 7265 7175  t",.        requ
+00043030: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+00043040: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
+00043050: 2020 2020 2020 6d65 7461 7661 723d 2244        metavar="D
+00043060: 4546 4155 4c54 5f52 4f4f 4d22 2c0a 2020  EFAULT_ROOM",.  
+00043070: 2020 2020 2020 6865 6c70 3d22 5370 6563        help="Spec
+00043080: 6966 7920 7468 6520 6465 6661 756c 7420  ify the default 
+00043090: 726f 6f6d 2061 7420 2d2d 6c6f 6769 6e2e  room at --login.
+000430a0: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+000430b0: 696c 733a 3a20 4f70 7469 6f6e 616c 6c79  ils:: Optionally
+000430c0: 2073 7065 6369 6679 2061 2072 6f6f 6d20   specify a room 
+000430d0: 6173 2074 6865 2022 0a20 2020 2020 2020  as the ".       
+000430e0: 2022 6465 6661 756c 7420 726f 6f6d 2066   "default room f
+000430f0: 6f72 2066 7574 7572 6520 6163 7469 6f6e  or future action
+00043100: 732e 2049 6620 6e6f 7420 7370 6563 6966  s. If not specif
+00043110: 6965 6420 666f 7220 2d2d 6c6f 6769 6e2c  ied for --login,
+00043120: 2069 7420 220a 2020 2020 2020 2020 2277   it ".        "w
+00043130: 696c 6c20 6265 2071 7565 7269 6564 2076  ill be queried v
+00043140: 6961 2074 6865 206b 6579 626f 6172 642e  ia the keyboard.
+00043150: 202d 2d6c 6f67 696e 2073 746f 7265 7320   --login stores 
+00043160: 7468 6520 7370 6563 6966 6965 6420 726f  the specified ro
+00043170: 6f6d 2022 0a20 2020 2020 2020 2022 6173  om ".        "as
+00043180: 2064 6566 6175 6c74 2072 6f6f 6d20 696e   default room in
+00043190: 2079 6f75 7220 6372 6564 656e 7469 616c   your credential
+000431a0: 7320 6669 6c65 2e20 5468 6973 206f 7074  s file. This opt
+000431b0: 696f 6e20 6973 206f 6e6c 7920 7573 6564  ion is only used
+000431c0: 2022 0a20 2020 2020 2020 2022 696e 2063   ".        "in c
+000431d0: 6f6d 6269 6e61 7469 6f6e 2077 6974 6820  ombination with 
+000431e0: 2d2d 6c6f 6769 6e2e 2041 2064 6566 6175  --login. A defau
+000431f0: 6c74 2072 6f6f 6d20 6973 206e 6565 6465  lt room is neede
+00043200: 642e 2053 7065 6369 6679 2061 2022 0a20  d. Specify a ". 
+00043210: 2020 2020 2020 2022 7661 6c69 6420 726f         "valid ro
+00043220: 6f6d 2065 6974 6865 7220 7769 7468 202d  om either with -
+00043230: 2d72 6f6f 6d2d 6465 6661 756c 7420 6f72  -room-default or
+00043240: 2070 726f 7669 6465 2069 7420 7669 6120   provide it via 
+00043250: 6b65 7962 6f61 7264 2e22 2c0a 2020 2020  keyboard.",.    
+00043260: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00043270: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00043280: 2d2d 726f 6f6d 2d63 7265 6174 6522 2c0a  --room-create",.
+00043290: 2020 2020 2020 2020 7265 7175 6972 6564          required
+000432a0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+000432b0: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+000432c0: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+000432d0: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
+000432e0: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+000432f0: 7461 7661 723d 2252 4f4f 4d5f 414c 4941  tavar="ROOM_ALIA
+00043300: 5322 2c0a 2020 2020 2020 2020 6865 6c70  S",.        help
+00043310: 3d22 4372 6561 7465 206f 6e65 206f 7220  ="Create one or 
+00043320: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2066  multiple rooms f
+00043330: 6f72 2067 6976 656e 2061 6c69 6173 2865  or given alias(e
+00043340: 7329 2e20 220a 2020 2020 2020 2020 2244  s). ".        "D
+00043350: 6574 6169 6c73 3a3a 204f 6e65 206f 7220  etails:: One or 
+00043360: 6d75 6c74 6970 6c65 2022 0a20 2020 2020  multiple ".     
+00043370: 2020 2022 726f 6f6d 2061 6c69 6173 6573     "room aliases
+00043380: 2063 616e 2062 6520 7370 6563 6966 6965   can be specifie
+00043390: 642e 2022 0a20 2020 2020 2020 2022 466f  d. ".        "Fo
+000433a0: 7220 6561 6368 2061 6c69 6173 2073 7065  r each alias spe
+000433b0: 6369 6669 6564 2061 2072 6f6f 6d20 7769  cified a room wi
+000433c0: 6c6c 2062 6520 6372 6561 7465 642e 2022  ll be created. "
+000433d0: 0a20 2020 2020 2020 2022 466f 7220 6561  .        "For ea
+000433e0: 6368 2063 7265 6174 6564 2072 6f6f 6d20  ch created room 
+000433f0: 6f6e 6520 6c69 6e65 2077 6974 6820 726f  one line with ro
+00043400: 6f6d 2069 6420 616e 6420 616c 6961 7320  om id and alias 
+00043410: 220a 2020 2020 2020 2020 2277 696c 6c20  ".        "will 
+00043420: 6265 2070 7269 6e74 6564 2074 6f20 7374  be printed to st
+00043430: 646f 7574 2e20 220a 2020 2020 2020 2020  dout. ".        
+00043440: 2249 6620 796f 7520 6172 6520 6e6f 7420  "If you are not 
+00043450: 696e 7465 7265 7374 6564 2069 6e20 616e  interested in an
+00043460: 2022 0a20 2020 2020 2020 2027 616c 6961   ".        'alia
+00043470: 732c 2070 726f 7669 6465 2061 6e20 656d  s, provide an em
+00043480: 7074 7920 7374 7269 6e67 206c 696b 6520  pty string like 
+00043490: 2222 2e20 270a 2020 2020 2020 2020 2254  "". '.        "T
+000434a0: 6865 2061 6c69 6173 2070 726f 7669 6465  he alias provide
+000434b0: 6420 6d75 7374 2062 6520 696e 2063 616e  d must be in can
+000434c0: 6f6e 6963 616c 206c 6f63 616c 2066 6f72  onical local for
+000434d0: 6d2c 2069 2e65 2e20 220a 2020 2020 2020  m, i.e. ".      
+000434e0: 2020 2269 6620 796f 7520 7761 6e74 2061    "if you want a
+000434f0: 2066 696e 616c 2066 756c 6c20 616c 6961   final full alia
+00043500: 7320 6c69 6b65 2022 0a20 2020 2020 2020  s like ".       
+00043510: 2027 2223 536f 6d65 526f 6f6d 416c 6961   '"#SomeRoomAlia
+00043520: 733a 6d61 7472 6978 2e65 7861 6d70 6c65  s:matrix.example
+00043530: 2e63 6f6d 2220 270a 2020 2020 2020 2020  .com" '.        
+00043540: 2279 6f75 206d 7573 7420 7072 6f76 6964  "you must provid
+00043550: 6520 7468 6520 7374 7269 6e67 2027 536f  e the string 'So
+00043560: 6d65 526f 6f6d 416c 6961 7327 2e20 220a  meRoomAlias'. ".
+00043570: 2020 2020 2020 2020 2254 6865 2075 7365          "The use
+00043580: 7220 6d75 7374 2062 6520 7065 726d 6974  r must be permit
+00043590: 7465 6420 746f 2063 7265 6174 6520 726f  ted to create ro
+000435a0: 6f6d 732e 2022 0a20 2020 2020 2020 2022  oms. ".        "
+000435b0: 436f 6d62 696e 6520 2d2d 726f 6f6d 2d63  Combine --room-c
+000435c0: 7265 6174 6520 7769 7468 202d 2d6e 616d  reate with --nam
+000435d0: 6520 616e 6420 2d2d 746f 7069 6320 746f  e and --topic to
+000435e0: 2061 6464 2022 0a20 2020 2020 2020 2022   add ".        "
+000435f0: 6e61 6d65 7320 616e 6420 746f 7069 6373  names and topics
+00043600: 2074 6f20 7468 6520 726f 6f6d 2873 2920   to the room(s) 
+00043610: 746f 2062 6520 6372 6561 7465 642e 2022  to be created. "
+00043620: 0a20 2020 2020 2020 2022 526f 6f6d 7320  .        "Rooms 
+00043630: 6172 6520 6279 2064 6566 6175 6c74 2063  are by default c
+00043640: 7265 6174 6564 2065 6e63 7279 7074 6564  reated encrypted
+00043650: 3b20 220a 2020 2020 2020 2020 2274 6f20  ; ".        "to 
+00043660: 6f76 6572 7772 6974 6520 7468 6174 2061  overwrite that a
+00043670: 6e64 2074 6f20 6372 6561 7465 2061 2072  nd to create a r
+00043680: 6f6f 6d20 7769 7468 2065 6e63 7279 7074  oom with encrypt
+00043690: 696f 6e20 6469 7361 626c 6564 2022 0a20  ion disabled ". 
+000436a0: 2020 2020 2020 2022 7573 6520 272d 2d70         "use '--p
+000436b0: 6c61 696e 272e 2022 0a20 2020 2020 2020  lain'. ".       
+000436c0: 2022 526f 6f6d 2069 642c 2072 6f6f 6d20   "Room id, room 
+000436d0: 616c 6961 732c 2065 6e63 7279 7074 696f  alias, encryptio
+000436e0: 6e20 616e 6420 6f74 6865 7220 6669 656c  n and other fiel
+000436f0: 6473 2022 0a20 2020 2020 2020 2022 6172  ds ".        "ar
+00043700: 6520 7072 696e 7465 6420 6173 206f 7574  e printed as out
+00043710: 7075 742c 206f 6e65 206c 696e 6520 7065  put, one line pe
+00043720: 7220 6372 6561 7465 6420 726f 6f6d 2e22  r created room."
+00043730: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+00043740: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+00043750: 2020 2020 2022 2d2d 726f 6f6d 2d64 6d2d       "--room-dm-
+00043760: 6372 6561 7465 222c 0a20 2020 2020 2020  create",.       
+00043770: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+00043780: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
+00043790: 2265 7874 656e 6422 2c0a 2020 2020 2020  "extend",.      
+000437a0: 2020 6e61 7267 733d 222b 222c 0a20 2020    nargs="+",.   
+000437b0: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
+000437c0: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+000437d0: 5553 4552 222c 0a20 2020 2020 2020 2068  USER",.        h
+000437e0: 656c 703d 2243 7265 6174 6520 6f6e 6520  elp="Create one 
+000437f0: 6f72 206d 756c 7469 706c 6520 444d 2072  or multiple DM r
+00043800: 6f6f 6d73 2077 6974 6820 7468 6520 7370  ooms with the sp
+00043810: 6563 6966 6965 6420 7573 6572 732e 2022  ecified users. "
+00043820: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+00043830: 733a 3a20 466f 7220 6561 6368 2075 7365  s:: For each use
+00043840: 7220 7370 6563 6966 6965 6420 6120 444d  r specified a DM
+00043850: 2072 6f6f 6d20 7769 6c6c 2062 6520 6372   room will be cr
+00043860: 6561 7465 6420 616e 6420 7468 6520 220a  eated and the ".
+00043870: 2020 2020 2020 2020 2275 7365 7220 696e          "user in
+00043880: 7669 7465 6420 746f 2069 742e 2046 6f72  vited to it. For
+00043890: 2065 6163 6820 6372 6561 7465 6420 726f   each created ro
+000438a0: 6f6d 206f 6e65 206c 696e 6520 7769 7468  om one line with
+000438b0: 2022 0a20 2020 2020 2020 2022 726f 6f6d   ".        "room
+000438c0: 2069 6420 616e 6420 616c 6961 7320 7769   id and alias wi
+000438d0: 6c6c 2062 6520 7072 696e 7465 6420 746f  ll be printed to
+000438e0: 2073 7464 6f75 742e 2054 6865 2075 7365   stdout. The use
+000438f0: 7220 220a 2020 2020 2020 2020 226d 7573  r ".        "mus
+00043900: 7420 6265 2070 6572 6d69 7474 6564 2074  t be permitted t
+00043910: 6f20 6372 6561 7465 2072 6f6f 6d73 2e20  o create rooms. 
+00043920: 436f 6d62 696e 6520 2d2d 726f 6f6d 2d64  Combine --room-d
+00043930: 6d2d 6372 6561 7465 2022 0a20 2020 2020  m-create ".     
+00043940: 2020 2022 7769 7468 202d 2d6e 616d 652c     "with --name,
+00043950: 202d 2d74 6f70 6963 2c20 2d2d 616c 6961   --topic, --alia
+00043960: 7320 746f 2061 6464 206e 616d 6573 2c20  s to add names, 
+00043970: 746f 7069 6373 2061 6e64 2022 0a20 2020  topics and ".   
+00043980: 2020 2020 2022 616c 6961 7365 7320 746f       "aliases to
+00043990: 2074 6865 2072 6f6f 6d28 7329 2074 6f20   the room(s) to 
+000439a0: 6265 2063 7265 6174 6564 2e20 220a 2020  be created. ".  
+000439b0: 2020 2020 2020 2244 4d20 726f 6f6d 7320        "DM rooms 
+000439c0: 6172 6520 6279 2064 6566 6175 6c74 2063  are by default c
+000439d0: 7265 6174 6564 2065 6e63 7279 7074 6564  reated encrypted
+000439e0: 3b20 220a 2020 2020 2020 2020 2274 6f20  ; ".        "to 
+000439f0: 6f76 6572 7772 6974 6520 7468 6174 2061  overwrite that a
+00043a00: 6e64 2074 6f20 6372 6561 7465 2061 2072  nd to create a r
+00043a10: 6f6f 6d20 7769 7468 2065 6e63 7279 7074  oom with encrypt
+00043a20: 696f 6e20 6469 7361 626c 6564 2022 0a20  ion disabled ". 
+00043a30: 2020 2020 2020 2022 7573 6520 272d 2d70         "use '--p
+00043a40: 6c61 696e 272e 2022 0a20 2020 2020 2020  lain'. ".       
+00043a50: 2022 526f 6f6d 2069 642c 2072 6f6f 6d20   "Room id, room 
+00043a60: 616c 6961 732c 2065 6e63 7279 7074 696f  alias, encryptio
+00043a70: 6e20 616e 6420 6f74 6865 7220 6669 656c  n and other fiel
+00043a80: 6473 2022 0a20 2020 2020 2020 2022 6172  ds ".        "ar
+00043a90: 6520 7072 696e 7465 6420 6173 206f 7574  e printed as out
+00043aa0: 7075 742c 206f 6e65 206c 696e 6520 7065  put, one line pe
+00043ab0: 7220 6372 6561 7465 6420 726f 6f6d 2e22  r created room."
+00043ac0: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+00043ad0: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+00043ae0: 2020 2020 2022 2d2d 726f 6f6d 2d6a 6f69       "--room-joi
+00043af0: 6e22 2c0a 2020 2020 2020 2020 7265 7175  n",.        requ
+00043b00: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+00043b10: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+00043b20: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+00043b30: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+00043b40: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00043b50: 2020 6d65 7461 7661 723d 2252 4f4f 4d22    metavar="ROOM"
+00043b60: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+00043b70: 4a6f 696e 206f 6e65 2072 6f6f 6d20 6f72  Join one room or
+00043b80: 206d 756c 7469 706c 6520 726f 6f6d 732e   multiple rooms.
+00043b90: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+00043ba0: 696c 733a 3a20 4f6e 6520 6f72 206d 756c  ils:: One or mul
+00043bb0: 7469 706c 6520 220a 2020 2020 2020 2020  tiple ".        
+00043bc0: 2272 6f6f 6d20 616c 6961 7365 7320 6361  "room aliases ca
+00043bd0: 6e20 6265 2073 7065 6369 6669 6564 2e20  n be specified. 
+00043be0: 5468 6520 726f 6f6d 2028 6f72 206d 756c  The room (or mul
+00043bf0: 7469 706c 6520 220a 2020 2020 2020 2020  tiple ".        
+00043c00: 226f 6e65 7329 2070 726f 7669 6465 6420  "ones) provided 
+00043c10: 696e 2074 6865 2061 7267 756d 656e 7473  in the arguments
+00043c20: 2077 696c 6c20 6265 206a 6f69 6e65 642e   will be joined.
+00043c30: 2022 0a20 2020 2020 2020 2022 5468 6520   ".        "The 
+00043c40: 7573 6572 206d 7573 7420 6861 7665 2070  user must have p
+00043c50: 6572 6d69 7373 696f 6e73 2074 6f20 6a6f  ermissions to jo
+00043c60: 696e 2074 6865 7365 2072 6f6f 6d73 2e22  in these rooms."
+00043c70: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+00043c80: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+00043c90: 2020 2020 2022 2d2d 726f 6f6d 2d6c 6561       "--room-lea
+00043ca0: 7665 222c 0a20 2020 2020 2020 2072 6571  ve",.        req
+00043cb0: 7569 7265 643d 4661 6c73 652c 0a20 2020  uired=False,.   
+00043cc0: 2020 2020 2061 6374 696f 6e3d 2265 7874       action="ext
+00043cd0: 656e 6422 2c0a 2020 2020 2020 2020 6e61  end",.        na
+00043ce0: 7267 733d 222b 222c 0a20 2020 2020 2020  rgs="+",.       
+00043cf0: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+00043d00: 2020 206d 6574 6176 6172 3d22 524f 4f4d     metavar="ROOM
+00043d10: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+00043d20: 224c 6561 7665 206f 6e65 2072 6f6f 6d20  "Leave one room 
+00043d30: 6f72 206d 756c 7469 706c 6520 726f 6f6d  or multiple room
+00043d40: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
+00043d50: 7461 696c 733a 3a20 4f6e 6520 6f72 206d  tails:: One or m
+00043d60: 756c 7469 706c 6520 220a 2020 2020 2020  ultiple ".      
+00043d70: 2020 2272 6f6f 6d20 616c 6961 7365 7320    "room aliases 
+00043d80: 6361 6e20 6265 2073 7065 6369 6669 6564  can be specified
+00043d90: 2e20 5468 6520 726f 6f6d 2028 6f72 206d  . The room (or m
+00043da0: 756c 7469 706c 6520 220a 2020 2020 2020  ultiple ".      
+00043db0: 2020 226f 6e65 7329 2070 726f 7669 6465    "ones) provide
+00043dc0: 6420 696e 2074 6865 2061 7267 756d 656e  d in the argumen
+00043dd0: 7473 2077 696c 6c20 6265 206c 6566 742e  ts will be left.
+00043de0: 2022 2c0a 2020 2020 290a 2020 2020 6170   ",.    ).    ap
+00043df0: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00043e00: 2020 2020 2020 2022 2d2d 726f 6f6d 2d66         "--room-f
+00043e10: 6f72 6765 7422 2c0a 2020 2020 2020 2020  orget",.        
+00043e20: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00043e30: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+00043e40: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
+00043e50: 206e 6172 6773 3d22 2b22 2c0a 2020 2020   nargs="+",.    
+00043e60: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
+00043e70: 2020 2020 2020 6d65 7461 7661 723d 2252        metavar="R
+00043e80: 4f4f 4d22 2c0a 2020 2020 2020 2020 6865  OOM",.        he
+00043e90: 6c70 3d22 466f 7267 6574 206f 6e65 2072  lp="Forget one r
+00043ea0: 6f6f 6d20 6f72 206d 756c 7469 706c 6520  oom or multiple 
+00043eb0: 726f 6f6d 732e 2022 0a20 2020 2020 2020  rooms. ".       
+00043ec0: 2022 4465 7461 696c 733a 3a20 4166 7465   "Details:: Afte
+00043ed0: 7220 6c65 6176 696e 6720 6120 726f 6f6d  r leaving a room
+00043ee0: 2079 6f75 2073 686f 756c 6420 286d 6f73   you should (mos
+00043ef0: 7420 6c69 6b65 6c79 2920 666f 7267 6574  t likely) forget
+00043f00: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
+00043f10: 726f 6f6d 2e20 466f 7267 6574 7469 6e67  room. Forgetting
+00043f20: 2061 2072 6f6f 6d20 7265 6d6f 7665 7320   a room removes 
+00043f30: 7468 6520 7573 6572 7327 2072 6f6f 6d20  the users' room 
+00043f40: 6869 7374 6f72 792e 2022 0a20 2020 2020  history. ".     
+00043f50: 2020 2022 4f6e 6520 6f72 206d 756c 7469     "One or multi
+00043f60: 706c 6520 220a 2020 2020 2020 2020 2272  ple ".        "r
+00043f70: 6f6f 6d20 616c 6961 7365 7320 6361 6e20  oom aliases can 
+00043f80: 6265 2073 7065 6369 6669 6564 2e20 5468  be specified. Th
+00043f90: 6520 726f 6f6d 2028 6f72 206d 756c 7469  e room (or multi
+00043fa0: 706c 6520 220a 2020 2020 2020 2020 226f  ple ".        "o
+00043fb0: 6e65 7329 2070 726f 7669 6465 6420 696e  nes) provided in
+00043fc0: 2074 6865 2061 7267 756d 656e 7473 2077   the arguments w
+00043fd0: 696c 6c20 6265 2066 6f72 676f 7474 656e  ill be forgotten
+00043fe0: 2e20 220a 2020 2020 2020 2020 2249 6620  . ".        "If 
+00043ff0: 616c 6c20 7573 6572 7320 666f 7267 6574  all users forget
+00044000: 2061 2072 6f6f 6d2c 2074 6865 2072 6f6f   a room, the roo
+00044010: 6d20 6361 6e20 6576 656e 7475 616c 6c79  m can eventually
+00044020: 2062 6520 220a 2020 2020 2020 2020 2264   be ".        "d
+00044030: 656c 6574 6564 206f 6e20 7468 6520 7365  eleted on the se
+00044040: 7276 6572 2e22 2c0a 2020 2020 290a 2020  rver.",.    ).  
+00044050: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+00044060: 7428 0a20 2020 2020 2020 2022 2d2d 726f  t(.        "--ro
+00044070: 6f6d 2d69 6e76 6974 6522 2c0a 2020 2020  om-invite",.    
+00044080: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+00044090: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+000440a0: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+000440b0: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+000440c0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+000440d0: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+000440e0: 723d 2252 4f4f 4d22 2c0a 2020 2020 2020  r="ROOM",.      
+000440f0: 2020 6865 6c70 3d22 496e 7669 7465 206f    help="Invite o
+00044100: 6e65 206f 7265 206d 6f72 6520 7573 6572  ne ore more user
+00044110: 7320 746f 206a 6f69 6e20 6f6e 6520 6f72  s to join one or
+00044120: 206d 6f72 6520 726f 6f6d 732e 2022 0a20   more rooms. ". 
+00044130: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+00044140: 3a20 5370 6563 6966 7920 7468 6520 7573  : Specify the us
+00044150: 6572 2873 2920 6173 2061 7267 756d 656e  er(s) as argumen
+00044160: 7473 2074 6f20 2d2d 7573 6572 2e20 220a  ts to --user. ".
+00044170: 2020 2020 2020 2020 2253 7065 6369 6679          "Specify
+00044180: 2074 6865 2072 6f6f 6d73 2061 7320 6172   the rooms as ar
+00044190: 6775 6d65 6e74 7320 746f 2074 6869 7320  guments to this 
+000441a0: 6f70 7469 6f6e 2c20 692e 652e 2022 0a20  option, i.e. ". 
+000441b0: 2020 2020 2020 2022 6173 2061 7267 756d         "as argum
+000441c0: 656e 7473 2074 6f20 2d2d 726f 6f6d 2d69  ents to --room-i
+000441d0: 6e76 6974 652e 2022 0a20 2020 2020 2020  nvite. ".       
+000441e0: 2022 5468 6520 7573 6572 206d 7573 7420   "The user must 
+000441f0: 6861 7665 2070 6572 6d69 7373 696f 6e73  have permissions
+00044200: 2074 6f20 696e 7669 7465 2075 7365 7273   to invite users
+00044210: 2e20 220a 2020 2020 2020 2020 2244 6f6e  . ".        "Don
+00044220: 2774 2063 6f6e 6675 7365 2074 6869 7320  't confuse this 
+00044230: 6f70 7469 6f6e 2077 6974 6820 2d2d 726f  option with --ro
+00044240: 6f6d 2d69 6e76 6974 6573 2e22 2c0a 2020  om-invites.",.  
+00044250: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+00044260: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+00044270: 2022 2d2d 726f 6f6d 2d62 616e 222c 0a20   "--room-ban",. 
+00044280: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+00044290: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
+000442a0: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
+000442b0: 2020 2020 2020 2020 6e61 7267 733d 222b          nargs="+
+000442c0: 222c 0a20 2020 2020 2020 2074 7970 653d  ",.        type=
+000442d0: 7374 722c 0a20 2020 2020 2020 206d 6574  str,.        met
+000442e0: 6176 6172 3d22 524f 4f4d 222c 0a20 2020  avar="ROOM",.   
+000442f0: 2020 2020 2068 656c 703d 2242 616e 206f       help="Ban o
+00044300: 6e65 206f 7265 206d 6f72 6520 7573 6572  ne ore more user
+00044310: 7320 6672 6f6d 206f 6e65 206f 7220 6d6f  s from one or mo
+00044320: 7265 2072 6f6f 6d73 2e20 220a 2020 2020  re rooms. ".    
+00044330: 2020 2020 2244 6574 6169 6c73 3a3a 2053      "Details:: S
+00044340: 7065 6369 6679 2074 6865 2075 7365 7228  pecify the user(
+00044350: 7329 2061 7320 6172 6775 6d65 6e74 7320  s) as arguments 
+00044360: 746f 202d 2d75 7365 722e 2022 0a20 2020  to --user. ".   
+00044370: 2020 2020 2022 5370 6563 6966 7920 7468       "Specify th
+00044380: 6520 726f 6f6d 7320 6173 2061 7267 756d  e rooms as argum
+00044390: 656e 7473 2074 6f20 7468 6973 206f 7074  ents to this opt
+000443a0: 696f 6e2c 2069 2e65 2e20 220a 2020 2020  ion, i.e. ".    
+000443b0: 2020 2020 2261 7320 6172 6775 6d65 6e74      "as argument
+000443c0: 7320 746f 202d 2d72 6f6f 6d2d 6261 6e2e  s to --room-ban.
+000443d0: 2022 0a20 2020 2020 2020 2022 5468 6520   ".        "The 
+000443e0: 7573 6572 206d 7573 7420 6861 7665 2070  user must have p
+000443f0: 6572 6d69 7373 696f 6e73 2074 6f20 6261  ermissions to ba
+00044400: 6e20 7573 6572 732e 222c 0a20 2020 2029  n users.",.    )
+00044410: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00044420: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+00044430: 2d72 6f6f 6d2d 756e 6261 6e22 2c0a 2020  -room-unban",.  
+00044440: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+00044450: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+00044460: 7469 6f6e 3d22 6578 7465 6e64 222c 0a20  tion="extend",. 
+00044470: 2020 2020 2020 206e 6172 6773 3d22 2b22         nargs="+"
+00044480: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
+00044490: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
+000444a0: 7661 723d 2252 4f4f 4d22 2c0a 2020 2020  var="ROOM",.    
+000444b0: 2020 2020 6865 6c70 3d22 556e 6261 6e20      help="Unban 
+000444c0: 6f6e 6520 6f72 6520 6d6f 7265 2075 7365  one ore more use
+000444d0: 7273 2066 726f 6d20 6f6e 6520 6f72 206d  rs from one or m
+000444e0: 6f72 6520 726f 6f6d 732e 2022 0a20 2020  ore rooms. ".   
+000444f0: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+00044500: 5370 6563 6966 7920 7468 6520 7573 6572  Specify the user
+00044510: 2873 2920 6173 2061 7267 756d 656e 7473  (s) as arguments
+00044520: 2074 6f20 2d2d 7573 6572 2e20 220a 2020   to --user. ".  
+00044530: 2020 2020 2020 2253 7065 6369 6679 2074        "Specify t
+00044540: 6865 2072 6f6f 6d73 2061 7320 6172 6775  he rooms as argu
+00044550: 6d65 6e74 7320 746f 2074 6869 7320 6f70  ments to this op
+00044560: 7469 6f6e 2c20 692e 652e 2022 0a20 2020  tion, i.e. ".   
+00044570: 2020 2020 2022 6173 2061 7267 756d 656e       "as argumen
+00044580: 7473 2074 6f20 2d2d 726f 6f6d 2d75 6e62  ts to --room-unb
+00044590: 616e 2e20 220a 2020 2020 2020 2020 2254  an. ".        "T
+000445a0: 6865 2075 7365 7220 6d75 7374 2068 6176  he user must hav
+000445b0: 6520 7065 726d 6973 7369 6f6e 7320 746f  e permissions to
+000445c0: 2075 6e62 616e 2075 7365 7273 2e22 2c0a   unban users.",.
+000445d0: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+000445e0: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+000445f0: 2020 2022 2d2d 726f 6f6d 2d6b 6963 6b22     "--room-kick"
+00044600: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+00044610: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00044620: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+00044630: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+00044640: 3d22 2b22 2c0a 2020 2020 2020 2020 7479  ="+",.        ty
+00044650: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00044660: 6d65 7461 7661 723d 2252 4f4f 4d22 2c0a  metavar="ROOM",.
+00044670: 2020 2020 2020 2020 6865 6c70 3d22 4b69          help="Ki
+00044680: 636b 206f 6e65 206f 7265 206d 6f72 6520  ck one ore more 
+00044690: 7573 6572 7320 6672 6f6d 206f 6e65 206f  users from one o
+000446a0: 7220 6d6f 7265 2072 6f6f 6d73 2e20 220a  r more rooms. ".
+000446b0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+000446c0: 3a3a 2053 7065 6369 6679 2074 6865 2075  :: Specify the u
+000446d0: 7365 7228 7329 2061 7320 6172 6775 6d65  ser(s) as argume
+000446e0: 6e74 7320 746f 202d 2d75 7365 722e 2022  nts to --user. "
+000446f0: 0a20 2020 2020 2020 2022 5370 6563 6966  .        "Specif
+00044700: 7920 7468 6520 726f 6f6d 7320 6173 2061  y the rooms as a
+00044710: 7267 756d 656e 7473 2074 6f20 7468 6973  rguments to this
+00044720: 206f 7074 696f 6e2c 2069 2e65 2e20 220a   option, i.e. ".
+00044730: 2020 2020 2020 2020 2261 7320 6172 6775          "as argu
+00044740: 6d65 6e74 7320 746f 202d 2d72 6f6f 6d2d  ments to --room-
+00044750: 6b69 636b 2e20 220a 2020 2020 2020 2020  kick. ".        
+00044760: 2254 6865 2075 7365 7220 6d75 7374 2068  "The user must h
+00044770: 6176 6520 7065 726d 6973 7369 6f6e 7320  ave permissions 
+00044780: 746f 206b 6963 6b20 7573 6572 732e 222c  to kick users.",
+00044790: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
+000447a0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
+000447b0: 2020 2020 2320 7374 6172 7469 6e67 2077      # starting w
+000447c0: 6974 6820 7665 7273 696f 6e20 322e 3139  ith version 2.19
+000447d0: 2022 2d75 2220 6861 7320 6265 656e 206d   "-u" has been m
+000447e0: 6f76 6564 2066 726f 6d0a 2020 2020 2020  oved from.      
+000447f0: 2020 2320 2d2d 646f 776e 6c6f 6164 2d6d    # --download-m
+00044800: 6564 6961 2074 6f20 2d2d 7573 6572 210a  edia to --user!.
+00044810: 2020 2020 2020 2020 222d 7522 2c0a 2020          "-u",.  
+00044820: 2020 2020 2020 222d 2d75 7365 7222 2c0a        "--user",.
+00044830: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00044840: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00044850: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+00044860: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+00044870: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
+00044880: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+00044890: 7461 7661 723d 2255 5345 5222 2c0a 2020  tavar="USER",.  
+000448a0: 2020 2020 2020 6865 6c70 3d22 5370 6563        help="Spec
+000448b0: 6966 7920 6f6e 6520 6f72 206d 756c 7469  ify one or multi
+000448c0: 706c 6520 7573 6572 732e 2022 0a20 2020  ple users. ".   
+000448d0: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+000448e0: 5468 6973 206f 7074 696f 6e20 6973 206d  This option is m
+000448f0: 6561 6e69 6e67 6675 6c20 220a 2020 2020  eaningful ".    
+00044900: 2020 2020 2269 6e20 636f 6d62 696e 6174      "in combinat
+00044910: 696f 6e20 7769 7468 2061 2920 726f 6f6d  ion with a) room
+00044920: 2061 6374 696f 6e73 206c 696b 6520 2d2d   actions like --
+00044930: 726f 6f6d 2d69 6e76 6974 652c 202d 2d72  room-invite, --r
+00044940: 6f6f 6d2d 6261 6e2c 2022 0a20 2020 2020  oom-ban, ".     
+00044950: 2020 2022 2d2d 726f 6f6d 2d75 6e62 616e     "--room-unban
+00044960: 2c20 6574 632e 2061 6e64 2062 2920 7365  , etc. and b) se
+00044970: 6e64 2061 6374 696f 6e73 206c 696b 6520  nd actions like 
+00044980: 2d6d 2c20 2d69 2c20 2d66 2c20 6574 632e  -m, -i, -f, etc.
+00044990: 2022 0a20 2020 2020 2020 2022 6329 2073   ".        "c) s
+000449a0: 6f6d 6520 6c69 7374 656e 2061 6374 696f  ome listen actio
+000449b0: 6e73 202d 2d6c 6973 7465 6e2c 2061 7320  ns --listen, as 
+000449c0: 7765 6c6c 2061 7320 6429 2061 6374 696f  well as d) actio
+000449d0: 6e73 206c 696b 6520 220a 2020 2020 2020  ns like ".      
+000449e0: 2020 222d 2d64 656c 6574 652d 6465 7669    "--delete-devi
+000449f0: 6365 2e20 220a 2020 2020 2020 2020 2249  ce. ".        "I
+00044a00: 6e20 6361 7365 206f 6620 6129 2074 6869  n case of a) thi
+00044a10: 7320 6f70 7469 6f6e 202d 2d75 7365 7220  s option --user 
+00044a20: 7370 6563 6966 6965 7320 7468 6520 7573  specifies the us
+00044a30: 6572 7320 220a 2020 2020 2020 2020 2274  ers ".        "t
+00044a40: 6f20 6265 2075 7365 6420 7769 7468 2072  o be used with r
+00044a50: 6f6f 6d20 636f 6d6d 616e 6473 2028 6c69  oom commands (li
+00044a60: 6b65 2069 6e76 6974 652c 2062 616e 2c20  ke invite, ban, 
+00044a70: 6574 632e 292e 2022 0a20 2020 2020 2020  etc.). ".       
+00044a80: 2022 496e 2063 6173 6520 6f66 2062 2920   "In case of b) 
+00044a90: 7468 6520 6f70 7469 6f6e 202d 2d75 7365  the option --use
+00044aa0: 7220 6361 6e20 6265 2075 7365 6420 6173  r can be used as
+00044ab0: 2061 6e20 616c 7465 726e 6174 6976 6520   an alternative 
+00044ac0: 220a 2020 2020 2020 2020 2274 6f20 7370  ".        "to sp
+00044ad0: 6563 6966 7969 6e67 2061 2072 6f6f 6d20  ecifying a room 
+00044ae0: 6173 2064 6573 7469 6e61 7469 6f6e 2066  as destination f
+00044af0: 6f72 2074 6578 7420 282d 6d29 2c20 696d  or text (-m), im
+00044b00: 6167 6573 2028 2d69 292c 2022 0a20 2020  ages (-i), ".   
+00044b10: 2020 2020 2022 6574 632e 2046 6f72 2073       "etc. For s
+00044b20: 656e 6420 6163 7469 6f6e 7320 272d 2d75  end actions '--u
+00044b30: 7365 7227 2069 7320 7072 6f76 6964 696e  ser' is providin
+00044b40: 6720 7468 6520 6675 6e63 7469 6f6e 616c  g the functional
+00044b50: 6974 7920 6f66 2022 0a20 2020 2020 2020  ity of ".       
+00044b60: 2022 2744 4d20 2864 6972 6563 7420 6d65   "'DM (direct me
+00044b70: 7373 6167 696e 6729 272e 2046 6f72 2063  ssaging)'. For c
+00044b80: 2920 7468 6973 206f 7074 696f 6e20 616c  ) this option al
+00044b90: 6c6f 7773 2061 6e20 616c 7465 726e 6174  lows an alternat
+00044ba0: 6976 6520 220a 2020 2020 2020 2020 2274  ive ".        "t
+00044bb0: 6f20 7370 6563 6966 7969 6e67 2061 2072  o specifying a r
+00044bc0: 6f6f 6d20 6173 2064 6573 7469 6e61 7469  oom as destinati
+00044bd0: 6f6e 2066 6f72 2073 6f6d 6520 2d2d 6c69  on for some --li
+00044be0: 7374 656e 2061 6374 696f 6e73 2e20 220a  sten actions. ".
+00044bf0: 2020 2020 2020 2020 2246 6f72 2064 2920          "For d) 
+00044c00: 7468 6973 2067 6976 6573 2074 6865 206f  this gives the o
+00044c10: 7074 696f 6e20 746f 2064 656c 6574 6520  ption to delete 
+00044c20: 7468 6520 6465 7669 6365 206f 6620 6120  the device of a 
+00044c30: 6469 6666 6572 656e 7420 220a 2020 2020  different ".    
+00044c40: 2020 2020 2275 7365 722e 2022 0a20 2020      "user. ".   
+00044c50: 2020 2020 2066 222d 2d2d 2d2d 2057 6861       f"----- Wha
+00044c60: 7420 6973 2061 2044 4d3f 207b 5052 4f47  t is a DM? {PROG
+00044c70: 5f57 4954 484f 5554 5f45 5854 7d20 7472  _WITHOUT_EXT} tr
+00044c80: 6965 7320 746f 2066 696e 6420 6120 220a  ies to find a ".
+00044c90: 2020 2020 2020 2020 2272 6f6f 6d20 7468          "room th
+00044ca0: 6174 2063 6f6e 7461 696e 7320 6f6e 6c79  at contains only
+00044cb0: 2074 6865 2073 656e 6465 7220 616e 6420   the sender and 
+00044cc0: 7468 6520 7265 6365 6976 6572 2c20 6865  the receiver, he
+00044cd0: 6e63 6520 444d 2e20 220a 2020 2020 2020  nce DM. ".      
+00044ce0: 2020 2254 6865 7365 2072 6f6f 6d73 2068    "These rooms h
+00044cf0: 6176 6520 6e6f 7468 696e 6720 7370 6563  ave nothing spec
+00044d00: 6961 6c20 6f74 6865 7220 7468 6520 6661  ial other the fa
+00044d10: 6374 2074 6861 7420 7468 6579 206f 6e6c  ct that they onl
+00044d20: 7920 6861 7665 2022 0a20 2020 2020 2020  y have ".       
+00044d30: 2022 3220 6d65 6d62 6572 7320 616e 6420   "2 members and 
+00044d40: 7468 656d 2062 6569 6e67 2074 6865 2073  them being the s
+00044d50: 656e 6465 7220 616e 6420 7265 6369 7069  ender and recipi
+00044d60: 656e 7420 7265 7370 6563 7469 7665 6c79  ent respectively
+00044d70: 2e20 220a 2020 2020 2020 2020 2249 6620  . ".        "If 
+00044d80: 7375 6368 2061 2072 6f6f 6d20 6973 2066  such a room is f
+00044d90: 6f75 6e64 2c20 7468 6520 6669 7273 7420  ound, the first 
+00044da0: 6f6e 6520 666f 756e 6420 7769 6c6c 2062  one found will b
+00044db0: 6520 7573 6564 2061 7320 220a 2020 2020  e used as ".    
+00044dc0: 2020 2020 2264 6573 7469 6e61 7469 6f6e      "destination
+00044dd0: 2e20 4966 206e 6f20 7375 6368 2072 6f6f  . If no such roo
+00044de0: 6d20 6973 2066 6f75 6e64 2c20 7468 6520  m is found, the 
+00044df0: 7365 6e64 2066 6169 6c73 2061 6e64 2074  send fails and t
+00044e00: 6865 2075 7365 7220 220a 2020 2020 2020  he user ".      
+00044e10: 2020 2273 686f 756c 6420 646f 2061 202d    "should do a -
+00044e20: 2d72 6f6f 6d2d 6372 6561 7465 2061 6e64  -room-create and
+00044e30: 202d 2d72 6f6f 6d2d 696e 7669 7465 2066   --room-invite f
+00044e40: 6972 7374 2e20 4966 206d 756c 7469 706c  irst. If multipl
+00044e50: 6520 220a 2020 2020 2020 2020 2273 7563  e ".        "suc
+00044e60: 6820 726f 6f6d 7320 6578 6973 742c 206f  h rooms exist, o
+00044e70: 6e65 206f 6620 7468 656d 2077 696c 6c20  ne of them will 
+00044e80: 6265 2075 7365 6420 2861 7262 6974 7261  be used (arbitra
+00044e90: 7269 6c79 292e 2022 0a20 2020 2020 2020  rily). ".       
+00044ea0: 2022 466f 7220 7365 6e64 696e 6720 616e   "For sending an
+00044eb0: 6420 6c69 7374 656e 696e 672c 2073 7065  d listening, spe
+00044ec0: 6369 6679 696e 6720 6120 726f 6f6d 2064  cifying a room d
+00044ed0: 6972 6563 746c 7920 6973 2061 6c77 6179  irectly is alway
+00044ee0: 7320 220a 2020 2020 2020 2020 2266 6173  s ".        "fas
+00044ef0: 7465 7220 616e 6420 6d6f 7265 2065 6666  ter and more eff
+00044f00: 6963 6965 6e74 2074 6861 6e20 7370 6563  icient than spec
+00044f10: 6966 7969 6e67 2061 2075 7365 722e 2053  ifying a user. S
+00044f20: 6f2c 2069 6620 796f 7520 6b6e 6f77 2022  o, if you know "
+00044f30: 0a20 2020 2020 2020 2022 7468 6520 726f  .        "the ro
+00044f40: 6f6d 2c20 6974 2069 7320 7072 6566 6572  om, it is prefer
+00044f50: 7265 6420 746f 2075 7365 202d 2d72 6f6f  red to use --roo
+00044f60: 6d20 696e 7374 6561 6420 6f66 202d 2d75  m instead of --u
+00044f70: 7365 722e 2022 0a20 2020 2020 2020 2022  ser. ".        "
+00044f80: 466f 7220 6229 2061 6e64 2063 2920 2d2d  For b) and c) --
+00044f90: 7573 6572 2063 616e 2062 6520 7370 6563  user can be spec
+00044fa0: 6966 6965 6420 696e 2033 2077 6179 733a  ified in 3 ways:
+00044fb0: 2031 2920 6675 6c6c 2075 7365 7220 6964   1) full user id
+00044fc0: 2022 0a20 2020 2020 2020 2022 6173 2069   ".        "as i
+00044fd0: 6e20 2740 6a6f 686e 3a65 7861 6d70 6c65  n '@john:example
+00044fe0: 2e6f 7267 272c 2032 2920 7061 7274 6961  .org', 2) partia
+00044ff0: 6c20 7573 6572 2069 6420 6173 2069 6e20  l user id as in 
+00045000: 2740 6a6f 686e 2720 7768 656e 2022 0a20  '@john' when ". 
+00045010: 2020 2020 2020 2022 7468 6520 7573 6572         "the user
+00045020: 2069 7320 6f6e 2074 6865 2073 616d 6520   is on the same 
+00045030: 686f 6d65 7365 7276 6572 2028 6578 616d  homeserver (exam
+00045040: 706c 652e 6f72 6720 7769 6c6c 2062 6520  ple.org will be 
+00045050: 220a 2020 2020 2020 2020 2261 7574 6f6d  ".        "autom
+00045060: 6174 6963 616c 6c79 2061 7070 656e 6465  atically appende
+00045070: 6429 2c20 6f72 2033 2920 6120 6469 7370  d), or 3) a disp
+00045080: 6c61 7920 6e61 6d65 2061 7320 696e 2027  lay name as in '
+00045090: 6a6f 686e 272e 2022 0a20 2020 2020 2020  john'. ".       
+000450a0: 2022 4265 2063 6172 6566 756c 2c20 7768   "Be careful, wh
+000450b0: 656e 2022 0a20 2020 2020 2020 2022 7573  en ".        "us
+000450c0: 696e 6720 6469 7370 6c61 7920 6e61 6d65  ing display name
+000450d0: 7320 6173 2074 6865 7920 6d69 6768 7420  s as they might 
+000450e0: 6e6f 7420 6265 2075 6e69 7175 652c 2061  not be unique, a
+000450f0: 6e64 2079 6f75 2063 6f75 6c64 2022 0a20  nd you could ". 
+00045100: 2020 2020 2020 2022 6265 2073 656e 6469         "be sendi
+00045110: 6e67 2074 6f20 7468 6520 7772 6f6e 6720  ng to the wrong 
+00045120: 7065 7273 6f6e 2e20 546f 2073 6565 2070  person. To see p
+00045130: 6f73 7369 626c 6520 6469 7370 6c61 7920  ossible display 
+00045140: 6e61 6d65 7320 7573 6520 220a 2020 2020  names use ".    
+00045150: 2020 2020 2274 6865 202d 2d6a 6f69 6e65      "the --joine
+00045160: 642d 6d65 6d62 6572 7320 272a 2720 6f70  d-members '*' op
+00045170: 7469 6f6e 2077 6869 6368 2077 696c 6c20  tion which will 
+00045180: 7368 6f77 2079 6f75 2074 6865 2064 6973  show you the dis
+00045190: 706c 6179 2022 0a20 2020 2020 2020 2022  play ".        "
+000451a0: 6e61 6d65 7320 696e 2074 6865 206d 6964  names in the mid
+000451b0: 646c 6520 636f 6c75 6d6e 2e22 2c0a 2020  dle column.",.  
+000451c0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+000451d0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+000451e0: 2022 2d2d 7573 6572 2d6c 6f67 696e 222c   "--user-login",
+000451f0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+00045200: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+00045210: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+00045220: 2020 2023 2040 6a6f 686e 3a65 7861 6d70     # @john:examp
+00045230: 6c65 2e63 6f6d 2061 6e64 2040 6a6f 686e  le.com and @john
+00045240: 2061 6e64 206a 6f68 6e20 6163 6365 7074   and john accept
+00045250: 6564 0a20 2020 2020 2020 206d 6574 6176  ed.        metav
+00045260: 6172 3d22 5553 4552 222c 0a20 2020 2020  ar="USER",.     
+00045270: 2020 2068 656c 703d 2253 7065 6369 6679     help="Specify
+00045280: 2075 7365 7220 666f 7220 2d2d 6c6f 6769   user for --logi
+00045290: 6e2e 2022 0a20 2020 2020 2020 2022 4465  n. ".        "De
+000452a0: 7461 696c 733a 3a20 4f70 7469 6f6e 616c  tails:: Optional
+000452b0: 2061 7267 756d 656e 7420 746f 2073 7065   argument to spe
+000452c0: 6369 6679 2074 6865 2075 7365 7220 666f  cify the user fo
+000452d0: 7220 2d2d 6c6f 6769 6e2e 2022 0a20 2020  r --login. ".   
+000452e0: 2020 2020 2022 5468 6973 2067 6976 6573       "This gives
+000452f0: 2074 6865 206f 7074 696f 6e20 746f 2073   the option to s
+00045300: 7065 6369 6679 2074 6865 2075 7365 7220  pecify the user 
+00045310: 6964 2066 6f72 206c 6f67 696e 2e20 220a  id for login. ".
+00045320: 2020 2020 2020 2020 2246 6f72 2027 2d2d          "For '--
+00045330: 6c6f 6769 6e20 7373 6f27 2074 6865 202d  login sso' the -
+00045340: 2d75 7365 722d 6c6f 6769 6e20 6973 206e  -user-login is n
+00045350: 6f74 206e 6565 6465 6420 6173 2075 7365  ot needed as use
+00045360: 7220 6964 2063 616e 2062 6520 220a 2020  r id can be ".  
+00045370: 2020 2020 2020 226f 6274 6169 6e65 6420        "obtained 
+00045380: 6672 6f6d 2073 6572 7665 7220 7669 6120  from server via 
+00045390: 5353 4f2e 2046 6f72 2027 2d2d 6c6f 6769  SSO. For '--logi
+000453a0: 6e20 7061 7373 776f 7264 272c 2069 6620  n password', if 
+000453b0: 6e6f 7420 220a 2020 2020 2020 2020 2270  not ".        "p
+000453c0: 726f 7669 6465 6420 6974 2077 696c 6c20  rovided it will 
+000453d0: 6265 2071 7565 7269 6564 2076 6961 206b  be queried via k
+000453e0: 6579 626f 6172 642e 2041 2066 756c 6c20  eyboard. A full 
+000453f0: 7573 6572 2069 6420 6c69 6b65 2022 0a20  user id like ". 
+00045400: 2020 2020 2020 2022 2740 6a6f 686e 3a65         "'@john:e
+00045410: 7861 6d70 6c65 2e63 6f6d 272c 2061 2070  xample.com', a p
+00045420: 6172 7469 616c 2075 7365 7220 6e61 6d65  artial user name
+00045430: 206c 696b 6520 2740 6a6f 686e 272c 2061   like '@john', a
+00045440: 6e64 2022 0a20 2020 2020 2020 2022 6120  nd ".        "a 
+00045450: 7368 6f72 7420 7573 6572 206e 616d 6520  short user name 
+00045460: 6c69 6b65 2027 6a6f 686e 2720 6361 6e20  like 'john' can 
+00045470: 6265 2067 6976 656e 2e20 220a 2020 2020  be given. ".    
+00045480: 2020 2020 222d 2d75 7365 722d 6c6f 6769      "--user-logi
+00045490: 6e20 6973 206f 6e6c 7920 7573 6564 2062  n is only used b
+000454a0: 7920 2d2d 6c6f 6769 6e20 616e 6420 6967  y --login and ig
+000454b0: 6e6f 7265 6420 6279 2061 6c6c 206f 7468  nored by all oth
+000454c0: 6572 2022 0a20 2020 2020 2020 2022 6163  er ".        "ac
+000454d0: 7469 6f6e 732e 222c 0a20 2020 2029 0a20  tions.",.    ). 
+000454e0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+000454f0: 6e74 280a 2020 2020 2020 2020 222d 2d6e  nt(.        "--n
+00045500: 616d 6522 2c0a 2020 2020 2020 2020 7265  ame",.        re
+00045510: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+00045520: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
+00045530: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
+00045540: 6172 6773 3d22 2b22 2c0a 2020 2020 2020  args="+",.      
+00045550: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
+00045560: 2020 2020 6d65 7461 7661 723d 2252 4f4f      metavar="ROO
+00045570: 4d5f 4e41 4d45 222c 0a20 2020 2020 2020  M_NAME",.       
+00045580: 2068 656c 703d 2253 7065 6369 6679 206f   help="Specify o
+00045590: 6e65 206f 7220 6d75 6c74 6970 6c65 2072  ne or multiple r
+000455a0: 6f6f 6d20 6e61 6d65 732e 2022 0a20 2020  oom names. ".   
+000455b0: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+000455c0: 5468 6973 206f 7074 696f 6e20 6973 206f  This option is o
+000455d0: 6e6c 7920 6d65 616e 696e 6766 756c 2022  nly meaningful "
+000455e0: 0a20 2020 2020 2020 2022 696e 2063 6f6d  .        "in com
+000455f0: 6269 6e61 7469 6f6e 2077 6974 6820 6f70  bination with op
+00045600: 7469 6f6e 202d 2d72 6f6f 6d2d 6372 6561  tion --room-crea
+00045610: 7465 2e20 220a 2020 2020 2020 2020 2254  te. ".        "T
+00045620: 6869 7320 6f70 7469 6f6e 202d 2d6e 616d  his option --nam
+00045630: 6520 7370 6563 6966 6965 7320 7468 6520  e specifies the 
+00045640: 6e61 6d65 7320 220a 2020 2020 2020 2020  names ".        
+00045650: 2274 6f20 6265 2075 7365 6420 7769 7468  "to be used with
+00045660: 2074 6865 2063 6f6d 6d61 6e64 202d 2d72   the command --r
+00045670: 6f6f 6d2d 6372 6561 7465 2e22 2c0a 2020  oom-create.",.  
+00045680: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+00045690: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+000456a0: 2022 2d2d 746f 7069 6322 2c0a 2020 2020   "--topic",.    
+000456b0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+000456c0: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+000456d0: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+000456e0: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+000456f0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00045700: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+00045710: 723d 2252 4f4f 4d5f 544f 5049 4322 2c0a  r="ROOM_TOPIC",.
+00045720: 2020 2020 2020 2020 6865 6c70 3d22 5370          help="Sp
+00045730: 6563 6966 7920 6f6e 6520 6f72 206d 756c  ecify one or mul
+00045740: 7469 706c 6520 726f 6f6d 2074 6f70 6963  tiple room topic
+00045750: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
+00045760: 7461 696c 733a 3a20 5468 6973 206f 7074  tails:: This opt
+00045770: 696f 6e20 6973 206f 6e6c 7920 6d65 616e  ion is only mean
+00045780: 696e 6766 756c 2022 0a20 2020 2020 2020  ingful ".       
+00045790: 2022 696e 2063 6f6d 6269 6e61 7469 6f6e   "in combination
+000457a0: 2077 6974 6820 6f70 7469 6f6e 202d 2d72   with option --r
+000457b0: 6f6f 6d2d 6372 6561 7465 2e20 220a 2020  oom-create. ".  
+000457c0: 2020 2020 2020 2254 6869 7320 6f70 7469        "This opti
+000457d0: 6f6e 202d 2d74 6f70 6963 2073 7065 6369  on --topic speci
+000457e0: 6669 6573 2074 6865 2074 6f70 6963 7320  fies the topics 
+000457f0: 220a 2020 2020 2020 2020 2274 6f20 6265  ".        "to be
+00045800: 2075 7365 6420 7769 7468 2074 6865 2063   used with the c
+00045810: 6f6d 6d61 6e64 202d 2d72 6f6f 6d2d 6372  ommand --room-cr
+00045820: 6561 7465 2e22 2c0a 2020 2020 290a 2020  eate.",.    ).  
+00045830: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+00045840: 7428 0a20 2020 2020 2020 2022 2d2d 616c  t(.        "--al
+00045850: 6961 7322 2c0a 2020 2020 2020 2020 7265  ias",.        re
+00045860: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+00045870: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
+00045880: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
+00045890: 6172 6773 3d22 2b22 2c0a 2020 2020 2020  args="+",.      
+000458a0: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
+000458b0: 2020 2020 6d65 7461 7661 723d 2252 4f4f      metavar="ROO
+000458c0: 4d5f 414c 4941 5322 2c0a 2020 2020 2020  M_ALIAS",.      
+000458d0: 2020 6865 6c70 3d22 5370 6563 6966 7920    help="Specify 
+000458e0: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+000458f0: 726f 6f6d 2061 6c69 6173 6573 2e20 220a  room aliases. ".
+00045900: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+00045910: 3a3a 2054 6869 7320 6f70 7469 6f6e 2069  :: This option i
+00045920: 7320 6f6e 6c79 2022 0a20 2020 2020 2020  s only ".       
+00045930: 2022 6d65 616e 696e 6766 756c 2069 6e20   "meaningful in 
+00045940: 636f 6d62 696e 6174 696f 6e20 7769 7468  combination with
+00045950: 206f 7074 696f 6e20 2d2d 726f 6f6d 2d64   option --room-d
+00045960: 6d2d 6372 6561 7465 2e20 220a 2020 2020  m-create. ".    
+00045970: 2020 2020 2254 6869 7320 6f70 7469 6f6e      "This option
+00045980: 202d 2d61 6c69 6173 2073 7065 6369 6669   --alias specifi
+00045990: 6573 2074 6865 2061 6c69 6173 6573 2074  es the aliases t
+000459a0: 6f20 6265 2075 7365 6420 220a 2020 2020  o be used ".    
+000459b0: 2020 2020 2277 6974 6820 7468 6520 636f      "with the co
+000459c0: 6d6d 616e 6420 2d2d 726f 6f6d 2d64 6d2d  mmand --room-dm-
+000459d0: 6372 6561 7465 2e22 2c0a 2020 2020 290a  create.",.    ).
+000459e0: 2020 2020 2320 616c 6c6f 7720 6d75 6c74      # allow mult
+000459f0: 6970 6c65 206d 6573 7361 6765 7320 2c20  iple messages , 
+00045a00: 652e 672e 202d 6d20 226d 3122 2022 6d32  e.g. -m "m1" "m2
+00045a10: 2220 6f72 202d 6d20 226d 3122 202d 6d20  " or -m "m1" -m 
+00045a20: 226d 3222 0a20 2020 2023 206d 6573 7361  "m2".    # messa
+00045a30: 6765 2069 7320 676f 696e 6720 746f 2062  ge is going to b
+00045a40: 6520 6120 6c69 7374 206f 6620 7374 7269  e a list of stri
+00045a50: 6e67 730a 2020 2020 2320 652e 672e 206d  ngs.    # e.g. m
+00045a60: 6573 7361 6765 3d5b 2027 6d31 272c 2027  essage=[ 'm1', '
+00045a70: 6d32 2720 5d0a 2020 2020 6170 2e61 6464  m2' ].    ap.add
+00045a80: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00045a90: 2020 2022 2d6d 222c 0a20 2020 2020 2020     "-m",.       
+00045aa0: 2022 2d2d 6d65 7373 6167 6522 2c0a 2020   "--message",.  
+00045ab0: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+00045ac0: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+00045ad0: 7469 6f6e 3d22 6578 7465 6e64 222c 0a20  tion="extend",. 
+00045ae0: 2020 2020 2020 206e 6172 6773 3d22 2b22         nargs="+"
+00045af0: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
+00045b00: 7472 2c0a 2020 2020 2020 2020 6d65 7461  tr,.        meta
+00045b10: 7661 723d 2254 4558 5422 2c0a 2020 2020  var="TEXT",.    
+00045b20: 2020 2020 6865 6c70 3d22 5365 6e64 206f      help="Send o
+00045b30: 6e65 206f 7220 6d75 6c74 6970 6c65 2074  ne or multiple t
+00045b40: 6578 7420 6d65 7373 6167 6573 2e20 220a  ext messages. ".
+00045b50: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+00045b60: 3a3a 204d 6573 7361 6765 2064 6174 6120  :: Message data 
+00045b70: 6d75 7374 206e 6f74 2062 6520 6269 6e61  must not be bina
+00045b80: 7279 2064 6174 612c 2069 7420 220a 2020  ry data, it ".  
+00045b90: 2020 2020 2020 226d 7573 7420 6265 2074        "must be t
+00045ba0: 6578 742e 2049 6620 6e6f 2027 2d6d 2720  ext. If no '-m' 
+00045bb0: 6973 2075 7365 6420 616e 6420 6e6f 206f  is used and no o
+00045bc0: 7468 6572 2063 6f6e 666c 6963 7469 6e67  ther conflicting
+00045bd0: 2022 0a20 2020 2020 2020 2022 6172 6775   ".        "argu
+00045be0: 6d65 6e74 7320 6172 6520 7072 6f76 6964  ments are provid
+00045bf0: 6564 2c20 616e 6420 696e 666f 726d 6174  ed, and informat
+00045c00: 696f 6e20 6973 2070 6970 6564 2069 6e74  ion is piped int
+00045c10: 6f20 7468 6520 7072 6f67 7261 6d2c 2022  o the program, "
+00045c20: 0a20 2020 2020 2020 2022 7468 656e 2074  .        "then t
+00045c30: 6865 2070 6970 6564 2064 6174 6120 7769  he piped data wi
+00045c40: 6c6c 2062 6520 7573 6564 2061 7320 6d65  ll be used as me
+00045c50: 7373 6167 652e 2022 0a20 2020 2020 2020  ssage. ".       
+00045c60: 2022 4669 6e61 6c6c 792c 2069 6620 7468   "Finally, if th
+00045c70: 6572 6520 6172 6520 6e6f 206f 7065 7261  ere are no opera
+00045c80: 7469 6f6e 7320 6174 2061 6c6c 2069 6e20  tions at all in 
+00045c90: 7468 6520 6172 6775 6d65 6e74 732c 2074  the arguments, t
+00045ca0: 6865 6e20 220a 2020 2020 2020 2020 2261  hen ".        "a
+00045cb0: 206d 6573 7361 6765 2077 696c 6c20 6265   message will be
+00045cc0: 2072 6561 6420 6672 6f6d 2073 7464 696e   read from stdin
+00045cd0: 2c20 692e 652e 2066 726f 6d20 7468 6520  , i.e. from the 
+00045ce0: 6b65 7962 6f61 7264 2e20 220a 2020 2020  keyboard. ".    
+00045cf0: 2020 2020 2254 6869 7320 6f70 7469 6f6e      "This option
+00045d00: 2063 616e 2062 6520 7573 6564 206d 756c   can be used mul
+00045d10: 7469 706c 6520 7469 6d65 7320 746f 2073  tiple times to s
+00045d20: 656e 6420 220a 2020 2020 2020 2020 226d  end ".        "m
+00045d30: 756c 7469 706c 6520 6d65 7373 6167 6573  ultiple messages
+00045d40: 2e20 4966 2074 6865 7265 2069 7320 6461  . If there is da
+00045d50: 7461 2070 6970 6564 2022 0a20 2020 2020  ta piped ".     
+00045d60: 2020 2022 696e 746f 2074 6869 7320 7072     "into this pr
+00045d70: 6f67 7261 6d2c 2074 6865 6e20 6669 7273  ogram, then firs
+00045d80: 7420 6461 7461 2066 726f 6d20 7468 6520  t data from the 
+00045d90: 220a 2020 2020 2020 2020 2270 6970 6520  ".        "pipe 
+00045da0: 6973 2070 7562 6c69 7368 6564 2c20 7468  is published, th
+00045db0: 656e 206d 6573 7361 6765 7320 6672 6f6d  en messages from
+00045dc0: 2074 6869 7320 220a 2020 2020 2020 2020   this ".        
+00045dd0: 226f 7074 696f 6e20 6172 6520 7075 626c  "option are publ
+00045de0: 6973 6865 642e 204d 6573 7361 6765 7320  ished. Messages 
+00045df0: 7769 6c6c 2062 6520 7365 6e74 206c 6173  will be sent las
+00045e00: 742c 2022 0a20 2020 2020 2020 2022 692e  t, ".        "i.
+00045e10: 652e 2061 6674 6572 206f 626a 6563 7473  e. after objects
+00045e20: 206c 696b 6520 696d 6167 6573 2c20 6175   like images, au
+00045e30: 6469 6f2c 2066 696c 6573 2c20 6576 656e  dio, files, even
+00045e40: 7473 2c20 6574 632e 2022 0a20 2020 2020  ts, etc. ".     
+00045e50: 2020 2022 496e 7075 7420 7069 7065 6420     "Input piped 
+00045e60: 7669 6120 7374 6469 6e20 6361 6e20 6164  via stdin can ad
+00045e70: 6469 7469 6f6e 616c 6c79 2062 6520 7370  ditionally be sp
+00045e80: 6563 6966 6965 6420 7769 7468 2074 6865  ecified with the
+00045e90: 2022 0a20 2020 2020 2020 2022 7370 6563   ".        "spec
+00045ea0: 6961 6c20 6368 6172 6163 7465 7220 272d  ial character '-
+00045eb0: 272e 2022 0a20 2020 2020 2020 2066 2249  '. ".        f"I
+00045ec0: 6620 796f 7520 7761 6e74 2074 6f20 6665  f you want to fe
+00045ed0: 6564 2061 2074 6578 7420 6d65 7373 6167  ed a text messag
+00045ee0: 6520 696e 746f 207b 5052 4f47 5f57 4954  e into {PROG_WIT
+00045ef0: 484f 5554 5f45 5854 7d20 220a 2020 2020  HOUT_EXT} ".    
+00045f00: 2020 2020 2276 6961 2061 2070 6970 652c      "via a pipe,
+00045f10: 2076 6961 2073 7464 696e 2c20 7468 656e   via stdin, then
+00045f20: 2073 7065 6369 6679 2074 6865 2073 7065   specify the spe
+00045f30: 6369 616c 2022 0a20 2020 2020 2020 2022  cial ".        "
+00045f40: 6368 6172 6163 7465 7220 272d 272e 2049  character '-'. I
+00045f50: 6620 272d 2720 6973 2073 7065 6369 6669  f '-' is specifi
+00045f60: 6564 2061 7320 6d65 7373 6167 652c 2022  ed as message, "
+00045f70: 0a20 2020 2020 2020 2022 7468 656e 2074  .        "then t
+00045f80: 6865 2070 726f 6772 616d 2077 696c 6c20  he program will 
+00045f90: 7265 6164 2074 6865 206d 6573 7361 6765  read the message
+00045fa0: 2066 726f 6d20 7374 6469 6e2e 2022 0a20   from stdin. ". 
+00045fb0: 2020 2020 2020 2022 5769 7468 2027 2d27         "With '-'
+00045fc0: 2074 6865 2077 686f 6c65 206d 6573 7361   the whole messa
+00045fd0: 6765 2c20 616c 6c20 6c69 6e65 732c 2077  ge, all lines, w
+00045fe0: 696c 6c20 6265 2063 6f6e 7369 6465 7265  ill be considere
+00045ff0: 6420 220a 2020 2020 2020 2020 2261 2073  d ".        "a s
+00046000: 696e 676c 6520 6d65 7373 6167 6520 616e  ingle message an
+00046010: 6420 7365 6e74 2061 7320 6f6e 6520 6d65  d sent as one me
+00046020: 7373 6167 652e 2022 0a20 2020 2020 2020  ssage. ".       
+00046030: 2022 4966 2079 6f75 7220 6d65 7373 6167   "If your messag
+00046040: 6520 6973 206c 6974 6572 616c 6c79 2027  e is literally '
+00046050: 2d27 2074 6865 6e20 7573 6520 275c 5c2d  -' then use '\\-
+00046060: 2720 220a 2020 2020 2020 2020 2261 7320  ' ".        "as 
+00046070: 6d65 7373 6167 6520 696e 2074 6865 2061  message in the a
+00046080: 7267 756d 656e 742e 2022 0a20 2020 2020  rgument. ".     
+00046090: 2020 2022 272d 2720 6d61 7920 6170 7065     "'-' may appe
+000460a0: 6172 2069 6e20 616e 7920 706f 7369 7469  ar in any positi
+000460b0: 6f6e 2c20 692e 652e 2027 2d6d 205c 2273  on, i.e. '-m \"s
+000460c0: 7461 7274 5c22 202d 205c 2265 6e64 5c22  tart\" - \"end\"
+000460d0: 2720 220a 2020 2020 2020 2020 2277 696c  ' ".        "wil
+000460e0: 6c20 7365 6e64 2033 206d 6573 7361 6765  l send 3 message
+000460f0: 7320 6f75 7420 6f66 2077 6869 6368 2074  s out of which t
+00046100: 6865 2073 6563 6f6e 6420 6f6e 6520 6973  he second one is
+00046110: 2072 6561 6420 6672 6f6d 2073 7464 696e   read from stdin
+00046120: 2e20 220a 2020 2020 2020 2020 2227 2d27  . ".        "'-'
+00046130: 206d 6179 2061 7070 6561 7220 6f6e 6c79   may appear only
+00046140: 206f 6e63 6520 6f76 6572 616c 6c20 696e   once overall in
+00046150: 2061 6c6c 2061 7267 756d 656e 7473 2e20   all arguments. 
+00046160: 220a 2020 2020 2020 2020 2253 696d 696c  ".        "Simil
+00046170: 6172 2074 6f20 272d 272c 2061 6e6f 7468  ar to '-', anoth
+00046180: 6572 2073 686f 7274 6375 7420 6368 6172  er shortcut char
+00046190: 6163 7465 7220 6973 2027 5f27 2e20 5468  acter is '_'. Th
+000461a0: 6520 220a 2020 2020 2020 2020 2273 7065  e ".        "spe
+000461b0: 6369 616c 2063 6861 7261 6374 6572 2027  cial character '
+000461c0: 5f27 2069 7320 7573 6564 2066 6f72 2073  _' is used for s
+000461d0: 7472 6561 6d69 6e67 2064 6174 6120 7669  treaming data vi
+000461e0: 6120 220a 2020 2020 2020 2020 2261 2070  a ".        "a p
+000461f0: 6970 6520 6f6e 2073 7464 696e 2e20 5769  ipe on stdin. Wi
+00046200: 7468 2027 5f27 2074 6865 2073 7464 696e  th '_' the stdin
+00046210: 2070 6970 6520 6973 2072 6561 6420 6c69   pipe is read li
+00046220: 6e65 2d62 792d 6c69 6e65 2022 0a20 2020  ne-by-line ".   
+00046230: 2020 2020 2022 616e 6420 6561 6368 206c       "and each l
+00046240: 696e 6520 6973 2074 7265 6174 6564 2061  ine is treated a
+00046250: 7320 6120 7365 7061 7261 7465 206d 6573  s a separate mes
+00046260: 7361 6765 2061 6e64 2073 656e 7420 7269  sage and sent ri
+00046270: 6768 7420 220a 2020 2020 2020 2020 2261  ght ".        "a
+00046280: 7761 792e 2054 6865 2070 726f 6772 616d  way. The program
+00046290: 2077 6169 7473 2066 6f72 2070 6970 6520   waits for pipe 
+000462a0: 696e 7075 7420 756e 7469 6c20 7468 6520  input until the 
+000462b0: 7069 7065 2069 7320 220a 2020 2020 2020  pipe is ".      
+000462c0: 2020 2263 6c6f 7365 642e 2045 2e67 2e20    "closed. E.g. 
+000462d0: 496d 6167 696e 6520 6120 746f 6f6c 2074  Imagine a tool t
+000462e0: 6861 7420 6765 6e65 7261 7465 7320 6f75  hat generates ou
+000462f0: 7470 7574 2073 706f 7261 6469 6361 6c6c  tput sporadicall
+00046300: 7920 220a 2020 2020 2020 2020 6622 3234  y ".        f"24
+00046310: 7837 2e20 4974 2063 616e 2062 6520 7069  x7. It can be pi
+00046320: 7065 642c 2069 2e65 2e20 7374 7265 616d  ped, i.e. stream
+00046330: 6564 2c20 696e 746f 207b 5052 4f47 5f57  ed, into {PROG_W
+00046340: 4954 484f 5554 5f45 5854 7d2c 2061 6e64  ITHOUT_EXT}, and
+00046350: 2022 0a20 2020 2020 2020 2066 227b 5052   ".        f"{PR
+00046360: 4f47 5f57 4954 484f 5554 5f45 5854 7d20  OG_WITHOUT_EXT} 
+00046370: 7374 6179 7320 6163 7469 7665 2c20 7365  stays active, se
+00046380: 6e64 696e 6720 616c 6c20 696e 7075 7420  nding all input 
+00046390: 696e 7374 616e 746c 792e 2022 0a20 2020  instantly. ".   
+000463a0: 2020 2020 2022 4966 2079 6f75 2077 616e       "If you wan
+000463b0: 7420 746f 2073 656e 6420 7468 6520 6c69  t to send the li
+000463c0: 7465 7261 6c20 6c65 7474 6572 2027 5f27  teral letter '_'
+000463d0: 2074 6865 6e20 6573 6361 7065 2069 7420   then escape it 
+000463e0: 220a 2020 2020 2020 2020 2261 6e64 2073  ".        "and s
+000463f0: 656e 6420 275c 5c5f 272e 2022 0a20 2020  end '\\_'. ".   
+00046400: 2020 2020 2022 275f 2720 6361 6e20 6265       "'_' can be
+00046410: 2075 7365 6420 6f6e 6c79 206f 6e63 652e   used only once.
+00046420: 2041 6e64 2065 6974 6865 7220 272d 2720   And either '-' 
+00046430: 6f72 2027 5f27 2063 616e 2062 6520 7573  or '_' can be us
+00046440: 6564 2e20 222c 0a20 2020 2029 0a20 2020  ed. ",.    ).   
+00046450: 2023 2061 6c6c 6f77 206d 756c 7469 706c   # allow multipl
+00046460: 6520 6d65 7373 6167 6573 202c 2065 2e67  e messages , e.g
+00046470: 2e20 2d69 2022 6931 2e6a 7067 2220 2269  . -i "i1.jpg" "i
+00046480: 322e 6769 6622 0a20 2020 2023 206f 7220  2.gif".    # or 
+00046490: 2d69 2022 6931 2e70 6e67 2220 2d69 2022  -i "i1.png" -i "
+000464a0: 6932 2e6a 7065 6722 0a20 2020 2023 2069  i2.jpeg".    # i
+000464b0: 6d61 6765 2069 7320 676f 696e 6720 746f  mage is going to
+000464c0: 2062 6520 6120 6c69 7374 206f 6620 7374   be a list of st
+000464d0: 7269 6e67 730a 2020 2020 2320 652e 672e  rings.    # e.g.
+000464e0: 2069 6d61 6765 3d5b 2027 6931 2e6a 7067   image=[ 'i1.jpg
+000464f0: 272c 2027 6932 2e70 6e67 2720 5d0a 2020  ', 'i2.png' ].  
+00046500: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+00046510: 7428 0a20 2020 2020 2020 2022 2d69 222c  t(.        "-i",
+00046520: 0a20 2020 2020 2020 2022 2d2d 696d 6167  .        "--imag
+00046530: 6522 2c0a 2020 2020 2020 2020 7265 7175  e",.        requ
+00046540: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+00046550: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+00046560: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+00046570: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+00046580: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00046590: 2020 6d65 7461 7661 723d 2249 4d41 4745    metavar="IMAGE
+000465a0: 5f46 494c 4522 2c0a 2020 2020 2020 2020  _FILE",.        
+000465b0: 6865 6c70 3d22 5365 6e64 206f 6e65 206f  help="Send one o
+000465c0: 7220 6d75 6c74 6970 6c65 2069 6d61 6765  r multiple image
+000465d0: 2066 696c 6573 2e20 220a 2020 2020 2020   files. ".      
+000465e0: 2020 2244 6574 6169 6c73 3a3a 2054 6869    "Details:: Thi
+000465f0: 7320 6f70 7469 6f6e 2063 616e 2062 6520  s option can be 
+00046600: 7573 6564 206d 756c 7469 706c 6520 7469  used multiple ti
+00046610: 6d65 7320 746f 2073 656e 6420 220a 2020  mes to send ".  
+00046620: 2020 2020 2020 226d 756c 7469 706c 6520        "multiple 
+00046630: 696d 6167 6573 2e20 4669 7273 7420 696d  images. First im
+00046640: 6167 6573 2061 7265 2073 656e 742c 2022  ages are sent, "
+00046650: 0a20 2020 2020 2020 2022 7468 656e 2074  .        "then t
+00046660: 6578 7420 6d65 7373 6167 6573 2061 7265  ext messages are
+00046670: 2073 656e 742e 2022 0a20 2020 2020 2020   sent. ".       
+00046680: 2066 2249 6620 796f 7520 7761 6e74 2074   f"If you want t
+00046690: 6f20 6665 6564 2061 6e20 696d 6167 6520  o feed an image 
+000466a0: 696e 746f 207b 5052 4f47 5f57 4954 484f  into {PROG_WITHO
+000466b0: 5554 5f45 5854 7d20 220a 2020 2020 2020  UT_EXT} ".      
+000466c0: 2020 2276 6961 2061 2070 6970 652c 2076    "via a pipe, v
+000466d0: 6961 2073 7464 696e 2c20 7468 656e 2073  ia stdin, then s
+000466e0: 7065 6369 6679 2074 6865 2073 7065 6369  pecify the speci
+000466f0: 616c 2022 0a20 2020 2020 2020 2022 6368  al ".        "ch
+00046700: 6172 6163 7465 7220 272d 272e 2049 6620  aracter '-'. If 
+00046710: 272d 2720 6973 2073 7065 6369 6669 6564  '-' is specified
+00046720: 2061 7320 696d 6167 6520 6669 6c65 206e   as image file n
+00046730: 616d 652c 2022 0a20 2020 2020 2020 2022  ame, ".        "
+00046740: 7468 656e 2074 6865 2070 726f 6772 616d  then the program
+00046750: 2077 696c 6c20 7265 6164 2074 6865 2069   will read the i
+00046760: 6d61 6765 2064 6174 6120 6672 6f6d 2073  mage data from s
+00046770: 7464 696e 2e20 220a 2020 2020 2020 2020  tdin. ".        
+00046780: 2249 6620 796f 7572 2069 6d61 6765 2066  "If your image f
+00046790: 696c 6520 6973 206c 6974 6572 616c 6c79  ile is literally
+000467a0: 206e 616d 6564 2027 2d27 2074 6865 6e20   named '-' then 
+000467b0: 7573 6520 275c 5c2d 2720 220a 2020 2020  use '\\-' ".    
+000467c0: 2020 2020 2261 7320 6669 6c65 206e 616d      "as file nam
+000467d0: 6520 696e 2074 6865 2061 7267 756d 656e  e in the argumen
+000467e0: 742e 2022 0a20 2020 2020 2020 2022 272d  t. ".        "'-
+000467f0: 2720 6d61 7920 6170 7065 6172 2069 6e20  ' may appear in 
+00046800: 616e 7920 706f 7369 7469 6f6e 2c20 692e  any position, i.
+00046810: 652e 2027 2d69 2069 6d61 6765 312e 6a70  e. '-i image1.jp
+00046820: 6720 2d20 696d 6167 6533 2e70 6e67 2720  g - image3.png' 
+00046830: 220a 2020 2020 2020 2020 2277 696c 6c20  ".        "will 
+00046840: 7365 6e64 2033 2069 6d61 6765 7320 6f75  send 3 images ou
+00046850: 7420 6f66 2077 6869 6368 2074 6865 2073  t of which the s
+00046860: 6563 6f6e 6420 6f6e 6520 6973 2072 6561  econd one is rea
+00046870: 6420 6672 6f6d 2073 7464 696e 2e20 220a  d from stdin. ".
+00046880: 2020 2020 2020 2020 2227 2d27 206d 6179          "'-' may
+00046890: 2061 7070 6561 7220 6f6e 6c79 206f 6e63   appear only onc
+000468a0: 6520 6f76 6572 616c 6c20 696e 2061 6c6c  e overall in all
+000468b0: 2061 7267 756d 656e 7473 2e20 220a 2020   arguments. ".  
+000468c0: 2020 2020 2020 2249 6620 7468 6520 6669        "If the fi
+000468d0: 6c65 2065 7869 7374 7320 616c 7265 6164  le exists alread
+000468e0: 792c 2069 7420 6973 206d 6f72 6520 6566  y, it is more ef
+000468f0: 6669 6369 656e 7420 746f 2073 7065 6369  ficient to speci
+00046900: 6679 2074 6865 2022 0a20 2020 2020 2020  fy the ".       
+00046910: 2022 6669 6c65 206e 616d 6520 7468 616e   "file name than
+00046920: 2074 6f20 7069 7065 2074 6865 2066 696c   to pipe the fil
+00046930: 6520 7468 726f 7567 6820 7374 6469 6e2e  e through stdin.
+00046940: 222c 0a20 2020 2029 0a20 2020 2023 2061  ",.    ).    # a
+00046950: 6c6c 6f77 206d 756c 7469 706c 6520 6175  llow multiple au
+00046960: 6469 6f20 6669 6c65 7320 2c20 652e 672e  dio files , e.g.
+00046970: 202d 6920 2261 312e 6d70 3322 2022 6132   -i "a1.mp3" "a2
+00046980: 2e77 6176 220a 2020 2020 2320 6f72 202d  .wav".    # or -
+00046990: 6920 2261 312e 6d70 3322 202d 6920 2261  i "a1.mp3" -i "a
+000469a0: 322e 6d34 6122 0a20 2020 2023 2061 7564  2.m4a".    # aud
+000469b0: 696f 2069 7320 676f 696e 6720 746f 2062  io is going to b
+000469c0: 6520 6120 6c69 7374 206f 6620 7374 7269  e a list of stri
+000469d0: 6e67 730a 2020 2020 2320 652e 672e 2061  ngs.    # e.g. a
+000469e0: 7564 696f 3d5b 2027 6131 2e6d 7033 272c  udio=[ 'a1.mp3',
+000469f0: 2027 6132 2e6d 3461 2720 5d0a 2020 2020   'a2.m4a' ].    
+00046a00: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+00046a10: 0a20 2020 2020 2020 2022 2d61 222c 0a20  .        "-a",. 
+00046a20: 2020 2020 2020 2022 2d2d 6175 6469 6f22         "--audio"
+00046a30: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+00046a40: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00046a50: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+00046a60: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+00046a70: 3d22 2b22 2c0a 2020 2020 2020 2020 7479  ="+",.        ty
+00046a80: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00046a90: 6d65 7461 7661 723d 2241 5544 494f 5f46  metavar="AUDIO_F
+00046aa0: 494c 4522 2c0a 2020 2020 2020 2020 6865  ILE",.        he
+00046ab0: 6c70 3d22 5365 6e64 206f 6e65 206f 7220  lp="Send one or 
+00046ac0: 6d75 6c74 6970 6c65 2061 7564 696f 2066  multiple audio f
+00046ad0: 696c 6573 2e20 220a 2020 2020 2020 2020  iles. ".        
+00046ae0: 2244 6574 6169 6c73 3a3a 2054 6869 7320  "Details:: This 
+00046af0: 6f70 7469 6f6e 2063 616e 2062 6520 7573  option can be us
+00046b00: 6564 206d 756c 7469 706c 6520 7469 6d65  ed multiple time
+00046b10: 7320 746f 2073 656e 6420 220a 2020 2020  s to send ".    
+00046b20: 2020 2020 226d 756c 7469 706c 6520 6175      "multiple au
+00046b30: 6469 6f20 6669 6c65 732e 2046 6972 7374  dio files. First
+00046b40: 2061 7564 696f 7320 6172 6520 7365 6e74   audios are sent
+00046b50: 2c20 220a 2020 2020 2020 2020 2274 6865  , ".        "the
+00046b60: 6e20 7465 7874 206d 6573 7361 6765 7320  n text messages 
+00046b70: 6172 6520 7365 6e74 2e20 220a 2020 2020  are sent. ".    
+00046b80: 2020 2020 6622 4966 2079 6f75 2077 616e      f"If you wan
+00046b90: 7420 746f 2066 6565 6420 616e 2061 7564  t to feed an aud
+00046ba0: 696f 2069 6e74 6f20 7b50 524f 475f 5749  io into {PROG_WI
+00046bb0: 5448 4f55 545f 4558 547d 2022 0a20 2020  THOUT_EXT} ".   
+00046bc0: 2020 2020 2022 7669 6120 6120 7069 7065       "via a pipe
+00046bd0: 2c20 7669 6120 7374 6469 6e2c 2074 6865  , via stdin, the
+00046be0: 6e20 7370 6563 6966 7920 7468 6520 7370  n specify the sp
+00046bf0: 6563 6961 6c20 220a 2020 2020 2020 2020  ecial ".        
+00046c00: 2263 6861 7261 6374 6572 2027 2d27 2e20  "character '-'. 
+00046c10: 5365 6520 6465 7363 7269 7074 696f 6e20  See description 
+00046c20: 6f66 2027 2d69 2720 746f 2073 6565 2068  of '-i' to see h
+00046c30: 6f77 2027 2d27 2069 7320 6861 6e64 6c65  ow '-' is handle
+00046c40: 642e 222c 0a20 2020 2029 0a20 2020 2023  d.",.    ).    #
+00046c50: 2061 6c6c 6f77 206d 756c 7469 706c 6520   allow multiple 
+00046c60: 6669 6c65 7320 2c20 652e 672e 202d 6620  files , e.g. -f 
+00046c70: 2261 312e 7064 6622 2022 6132 2e64 6f63  "a1.pdf" "a2.doc
+00046c80: 220a 2020 2020 2320 6f72 202d 6620 2261  ".    # or -f "a
+00046c90: 312e 7064 6622 202d 6620 2261 322e 646f  1.pdf" -f "a2.do
+00046ca0: 6322 0a20 2020 2023 2066 696c 6520 6973  c".    # file is
+00046cb0: 2067 6f69 6e67 2074 6f20 6265 2061 206c   going to be a l
+00046cc0: 6973 7420 6f66 2073 7472 696e 6773 0a20  ist of strings. 
+00046cd0: 2020 2023 2065 2e67 2e20 6669 6c65 3d5b     # e.g. file=[
+00046ce0: 2027 6131 2e70 6466 272c 2027 6132 2e64   'a1.pdf', 'a2.d
+00046cf0: 6f63 2720 5d0a 2020 2020 6170 2e61 6464  oc' ].    ap.add
+00046d00: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00046d10: 2020 2022 2d66 222c 0a20 2020 2020 2020     "-f",.       
+00046d20: 2022 2d2d 6669 6c65 222c 0a20 2020 2020   "--file",.     
+00046d30: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+00046d40: 652c 0a20 2020 2020 2020 2061 6374 696f  e,.        actio
+00046d50: 6e3d 2265 7874 656e 6422 2c0a 2020 2020  n="extend",.    
+00046d60: 2020 2020 6e61 7267 733d 222b 222c 0a20      nargs="+",. 
+00046d70: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+00046d80: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+00046d90: 3d22 4649 4c45 222c 0a20 2020 2020 2020  ="FILE",.       
+00046da0: 2068 656c 703d 2253 656e 6420 6f6e 6520   help="Send one 
+00046db0: 6f72 206d 756c 7469 706c 6520 6669 6c65  or multiple file
+00046dc0: 7320 2865 2e67 2e20 5044 462c 2044 4f43  s (e.g. PDF, DOC
+00046dd0: 2c20 4d50 3429 2e20 220a 2020 2020 2020  , MP4). ".      
+00046de0: 2020 2244 6574 6169 6c73 3a3a 2054 6869    "Details:: Thi
+00046df0: 7320 6f70 7469 6f6e 2063 616e 2062 6520  s option can be 
+00046e00: 7573 6564 206d 756c 7469 706c 6520 7469  used multiple ti
+00046e10: 6d65 7320 746f 2073 656e 6420 220a 2020  mes to send ".  
+00046e20: 2020 2020 2020 226d 756c 7469 706c 6520        "multiple 
+00046e30: 6669 6c65 732e 2046 6972 7374 2066 696c  files. First fil
+00046e40: 6573 2061 7265 2073 656e 742c 2022 0a20  es are sent, ". 
+00046e50: 2020 2020 2020 2022 7468 656e 2074 6578         "then tex
+00046e60: 7420 6d65 7373 6167 6573 2061 7265 2073  t messages are s
+00046e70: 656e 742e 2022 0a20 2020 2020 2020 2066  ent. ".        f
+00046e80: 2249 6620 796f 7520 7761 6e74 2074 6f20  "If you want to 
+00046e90: 6665 6564 2061 2066 696c 6520 696e 746f  feed a file into
+00046ea0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
+00046eb0: 5854 7d20 220a 2020 2020 2020 2020 2276  XT} ".        "v
+00046ec0: 6961 2061 2070 6970 652c 2076 6961 2073  ia a pipe, via s
+00046ed0: 7464 696e 2c20 7468 656e 2073 7065 6369  tdin, then speci
+00046ee0: 6679 2074 6865 2073 7065 6369 616c 2022  fy the special "
+00046ef0: 0a20 2020 2020 2020 2022 6368 6172 6163  .        "charac
+00046f00: 7465 7220 272d 272e 2053 6565 2064 6573  ter '-'. See des
+00046f10: 6372 6970 7469 6f6e 206f 6620 272d 6927  cription of '-i'
+00046f20: 2074 6f20 7365 6520 686f 7720 272d 2720   to see how '-' 
+00046f30: 6973 2068 616e 646c 6564 2e22 2c0a 2020  is handled.",.  
+00046f40: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+00046f50: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+00046f60: 2022 2d65 222c 0a20 2020 2020 2020 2022   "-e",.        "
+00046f70: 2d2d 6576 656e 7422 2c0a 2020 2020 2020  --event",.      
+00046f80: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+00046f90: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+00046fa0: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
+00046fb0: 2020 206e 6172 6773 3d22 2b22 2c0a 2020     nargs="+",.  
+00046fc0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+00046fd0: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+00046fe0: 224d 4154 5249 585f 4a53 4f4e 5f4f 424a  "MATRIX_JSON_OBJ
+00046ff0: 4543 5422 2c0a 2020 2020 2020 2020 6865  ECT",.        he
+00047000: 6c70 3d22 5365 6e64 2061 204d 6174 7269  lp="Send a Matri
+00047010: 7820 4a53 4f4e 2065 7665 6e74 2e20 220a  x JSON event. ".
+00047020: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+00047030: 3a3a 2053 656e 6420 616e 2065 7665 6e74  :: Send an event
+00047040: 2074 6861 7420 6973 2066 6f72 6d61 7474   that is formatt
+00047050: 6564 2061 7320 6120 4a53 4f4e 206f 626a  ed as a JSON obj
+00047060: 6563 7420 6173 2022 0a20 2020 2020 2020  ect as ".       
+00047070: 2022 7370 6563 6966 6965 6420 6279 2074   "specified by t
+00047080: 6865 204d 6174 7269 7820 7072 6f74 6f63  he Matrix protoc
+00047090: 6f6c 2e20 5468 6973 2061 6c6c 6f77 7320  ol. This allows 
+000470a0: 7468 6520 6164 7661 6e63 6564 2022 0a20  the advanced ". 
+000470b0: 2020 2020 2020 2022 7573 6572 2074 6f20         "user to 
+000470c0: 7365 6e64 2061 6464 6974 696f 6e61 6c20  send additional 
+000470d0: 7479 7065 7320 6f66 2065 7665 6e74 7320  types of events 
+000470e0: 7375 6368 2061 7320 7265 6163 7469 6f6e  such as reaction
+000470f0: 732c 2022 0a20 2020 2020 2020 2022 7365  s, ".        "se
+00047100: 6e64 2072 6570 6c69 6573 2074 6f20 7072  nd replies to pr
+00047110: 6576 696f 7573 2065 7665 6e74 732c 206f  evious events, o
+00047120: 7220 6564 6974 2070 7265 7669 6f75 7320  r edit previous 
+00047130: 6d65 7373 6167 6573 2e20 220a 2020 2020  messages. ".    
+00047140: 2020 2020 2253 7065 6369 6669 6361 7469      "Specificati
+00047150: 6f6e 7320 666f 7220 6576 656e 7473 2063  ons for events c
+00047160: 616e 2062 6520 666f 756e 6420 220a 2020  an be found ".  
+00047170: 2020 2020 2020 2261 7420 6874 7470 733a        "at https:
+00047180: 2f2f 7370 6563 2e6d 6174 7269 782e 6f72  //spec.matrix.or
+00047190: 672f 756e 7374 6162 6c65 2f70 726f 706f  g/unstable/propo
+000471a0: 7361 6c73 2f2e 2022 0a20 2020 2020 2020  sals/. ".       
+000471b0: 2022 5468 6973 206f 7074 696f 6e20 6361   "This option ca
+000471c0: 6e20 6265 2075 7365 6420 6d75 6c74 6970  n be used multip
+000471d0: 6c65 2074 696d 6573 2074 6f20 7365 6e64  le times to send
+000471e0: 2022 0a20 2020 2020 2020 2022 6d75 6c74   ".        "mult
+000471f0: 6970 6c65 2065 7665 6e74 732e 2046 6972  iple events. Fir
+00047200: 7374 2065 7665 6e74 7320 6172 6520 7365  st events are se
+00047210: 6e74 2c20 220a 2020 2020 2020 2020 2274  nt, ".        "t
+00047220: 6865 6e20 7465 7874 206d 6573 7361 6765  hen text message
+00047230: 7320 6172 6520 7365 6e74 2e20 220a 2020  s are sent. ".  
+00047240: 2020 2020 2020 6622 4966 2079 6f75 2077        f"If you w
+00047250: 616e 7420 746f 2066 6565 6420 616e 2065  ant to feed an e
+00047260: 7665 6e74 2069 6e74 6f20 7b50 524f 475f  vent into {PROG_
+00047270: 5749 5448 4f55 545f 4558 547d 2022 0a20  WITHOUT_EXT} ". 
+00047280: 2020 2020 2020 2022 7669 6120 6120 7069         "via a pi
+00047290: 7065 2c20 7669 6120 7374 6469 6e2c 2074  pe, via stdin, t
+000472a0: 6865 6e20 7370 6563 6966 7920 7468 6520  hen specify the 
+000472b0: 7370 6563 6961 6c20 220a 2020 2020 2020  special ".      
+000472c0: 2020 2263 6861 7261 6374 6572 2027 2d27    "character '-'
+000472d0: 2e20 5365 6520 6465 7363 7269 7074 696f  . See descriptio
+000472e0: 6e20 6f66 2027 2d69 2720 746f 2073 6565  n of '-i' to see
+000472f0: 2068 6f77 2027 2d27 2069 7320 6861 6e64   how '-' is hand
+00047300: 6c65 642e 2022 0a20 2020 2020 2020 2022  led. ".        "
+00047310: 5365 6520 7465 7374 732f 7465 7374 2d65  See tests/test-e
+00047320: 7665 6e74 2e73 6820 666f 7220 6578 616d  vent.sh for exam
+00047330: 706c 6573 2e22 2c0a 2020 2020 290a 2020  ples.",.    ).  
+00047340: 2020 2320 2d68 2061 6c72 6561 6479 2075    # -h already u
+00047350: 7365 6420 666f 7220 2d2d 6865 6c70 2c20  sed for --help, 
+00047360: 2d77 2066 6f72 2022 7765 6222 0a20 2020  -w for "web".   
+00047370: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+00047380: 280a 2020 2020 2020 2020 222d 7722 2c0a  (.        "-w",.
+00047390: 2020 2020 2020 2020 222d 2d68 746d 6c22          "--html"
+000473a0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+000473b0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+000473c0: 2020 6163 7469 6f6e 3d22 7374 6f72 655f    action="store_
+000473d0: 7472 7565 222c 0a20 2020 2020 2020 2068  true",.        h
+000473e0: 656c 703d 2753 656e 6420 6d65 7373 6167  elp='Send messag
+000473f0: 6520 6173 2066 6f72 6d61 7420 2248 544d  e as format "HTM
+00047400: 4c22 2e20 270a 2020 2020 2020 2020 2244  L". '.        "D
+00047410: 6574 6169 6c73 3a3a 2049 6620 6e6f 7420  etails:: If not 
+00047420: 7370 6563 6966 6965 642c 206d 6573 7361  specified, messa
+00047430: 6765 2077 696c 6c20 6265 2073 656e 7420  ge will be sent 
+00047440: 220a 2020 2020 2020 2020 2761 7320 666f  ".        'as fo
+00047450: 726d 6174 2022 5445 5854 222e 2045 2e67  rmat "TEXT". E.g
+00047460: 2e20 7468 6174 2061 6c6c 6f77 7320 736f  . that allows so
+00047470: 6d65 2074 6578 7420 270a 2020 2020 2020  me text '.      
+00047480: 2020 2274 6f20 6265 2062 6f6c 642c 2065    "to be bold, e
+00047490: 7463 2e20 4f6e 6c79 2061 2073 7562 7365  tc. Only a subse
+000474a0: 7420 6f66 2048 544d 4c20 7461 6773 2061  t of HTML tags a
+000474b0: 7265 2022 0a20 2020 2020 2020 2022 6163  re ".        "ac
+000474c0: 6365 7074 6564 2062 7920 4d61 7472 6978  cepted by Matrix
+000474d0: 2e22 2c0a 2020 2020 290a 2020 2020 2320  .",.    ).    # 
+000474e0: 2d6d 2061 6c72 6561 6479 2075 7365 6420  -m already used 
+000474f0: 666f 7220 2d2d 6d65 7373 6167 652c 202d  for --message, -
+00047500: 7a20 6265 6361 7573 6520 7468 6572 6520  z because there 
+00047510: 7765 7265 206e 6f20 6c65 7474 6572 7320  were no letters 
+00047520: 6c65 6674 0a20 2020 2061 702e 6164 645f  left.    ap.add_
+00047530: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+00047540: 2020 222d 7a22 2c0a 2020 2020 2020 2020    "-z",.        
+00047550: 222d 2d6d 6172 6b64 6f77 6e22 2c0a 2020  "--markdown",.  
+00047560: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+00047570: 616c 7365 2c0a 2020 2020 2020 2020 6163  alse,.        ac
+00047580: 7469 6f6e 3d22 7374 6f72 655f 7472 7565  tion="store_true
+00047590: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+000475a0: 2753 656e 6420 6d65 7373 6167 6520 6173  'Send message as
+000475b0: 2066 6f72 6d61 7420 224d 4152 4b44 4f57   format "MARKDOW
+000475c0: 4e22 2e20 270a 2020 2020 2020 2020 2244  N". '.        "D
+000475d0: 6574 6169 6c73 3a3a 2049 6620 6e6f 7420  etails:: If not 
+000475e0: 7370 6563 6966 6965 642c 206d 6573 7361  specified, messa
+000475f0: 6765 2077 696c 6c20 6265 2073 656e 7420  ge will be sent 
+00047600: 220a 2020 2020 2020 2020 2761 7320 666f  ".        'as fo
+00047610: 726d 6174 2022 5445 5854 222e 2045 2e67  rmat "TEXT". E.g
+00047620: 2e20 7468 6174 2061 6c6c 6f77 7320 7365  . that allows se
+00047630: 6e64 696e 6720 6f66 2074 6578 7420 270a  nding of text '.
+00047640: 2020 2020 2020 2020 2266 6f72 6d61 7474          "formatt
+00047650: 6564 2069 6e20 4d61 726b 446f 776e 206c  ed in MarkDown l
+00047660: 616e 6775 6167 652e 222c 0a20 2020 2029  anguage.",.    )
+00047670: 0a20 2020 2023 2020 2d63 2069 7320 616c  .    #  -c is al
+00047680: 7265 6164 7920 7573 6564 2066 6f72 202d  ready used for -
+00047690: 2d63 7265 6465 6e74 6961 6c73 2c20 2d6b  -credentials, -k
+000476a0: 2061 7320 6974 2073 6f75 6e64 7320 6c69   as it sounds li
+000476b0: 6b65 2063 0a20 2020 2061 702e 6164 645f  ke c.    ap.add_
+000476c0: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+000476d0: 2020 222d 6b22 2c0a 2020 2020 2020 2020    "-k",.        
+000476e0: 222d 2d63 6f64 6522 2c0a 2020 2020 2020  "--code",.      
+000476f0: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+00047700: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+00047710: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
+00047720: 2020 2020 2020 2068 656c 703d 2753 656e         help='Sen
+00047730: 6420 6d65 7373 6167 6520 6173 2066 6f72  d message as for
+00047740: 6d61 7420 2243 4f44 4522 2e20 270a 2020  mat "CODE". '.  
+00047750: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00047760: 2049 6620 6e6f 7420 7370 6563 6966 6965   If not specifie
+00047770: 642c 206d 6573 7361 6765 2077 696c 6c20  d, message will 
+00047780: 6265 2073 656e 7420 220a 2020 2020 2020  be sent ".      
+00047790: 2020 2761 7320 666f 726d 6174 2022 5445    'as format "TE
+000477a0: 5854 222e 2049 6620 626f 7468 202d 2d68  XT". If both --h
+000477b0: 746d 6c20 616e 6420 2d2d 636f 6465 2061  tml and --code a
+000477c0: 7265 2027 0a20 2020 2020 2020 2022 7370  re '.        "sp
+000477d0: 6563 6966 6965 6420 7468 656e 202d 2d63  ecified then --c
+000477e0: 6f64 6520 7461 6b65 7320 7072 696f 7269  ode takes priori
+000477f0: 7479 2e20 5468 6973 2069 7320 220a 2020  ty. This is ".  
+00047800: 2020 2020 2020 2275 7365 6675 6c20 666f        "useful fo
+00047810: 7220 7365 6e64 696e 6720 4153 4349 492d  r sending ASCII-
+00047820: 6172 7420 6f72 2074 6162 6265 6420 6f75  art or tabbed ou
+00047830: 7470 7574 2022 0a20 2020 2020 2020 2022  tput ".        "
+00047840: 6c69 6b65 2074 6162 6c65 7320 6173 2061  like tables as a
+00047850: 2066 6978 6564 2d73 697a 6564 2066 6f6e   fixed-sized fon
+00047860: 7420 7769 6c6c 2062 6520 7573 6564 2022  t will be used "
+00047870: 0a20 2020 2020 2020 2022 666f 7220 6469  .        "for di
+00047880: 7370 6c61 792e 222c 0a20 2020 2029 0a20  splay.",.    ). 
+00047890: 2020 2023 2020 2d6a 2066 6f72 2065 6d6f     #  -j for emo
+000478a0: 4a69 7a65 0a20 2020 2061 702e 6164 645f  Jize.    ap.add_
+000478b0: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+000478c0: 2020 222d 6a22 2c0a 2020 2020 2020 2020    "-j",.        
+000478d0: 222d 2d65 6d6f 6a69 7a65 222c 0a20 2020  "--emojize",.   
+000478e0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+000478f0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+00047900: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
+00047910: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+00047920: 5365 6e64 206d 6573 7361 6765 2061 6674  Send message aft
+00047930: 6572 2065 6d6f 6a69 7a69 6e67 2e20 220a  er emojizing. ".
+00047940: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+00047950: 3a3a 2049 6620 6e6f 7420 7370 6563 6966  :: If not specif
+00047960: 6965 642c 206d 6573 7361 6765 2077 696c  ied, message wil
+00047970: 6c20 6265 2073 656e 7420 220a 2020 2020  l be sent ".    
+00047980: 2020 2020 2761 7320 666f 726d 6174 2022      'as format "
+00047990: 5445 5854 222e 2049 6620 626f 7468 202d  TEXT". If both -
+000479a0: 2d63 6f64 6520 616e 6420 2d2d 656d 6f6a  -code and --emoj
+000479b0: 697a 6520 6172 6520 270a 2020 2020 2020  ize are '.      
+000479c0: 2020 2273 7065 6369 6669 6564 2074 6865    "specified the
+000479d0: 6e20 2d2d 636f 6465 2074 616b 6573 2070  n --code takes p
+000479e0: 7269 6f72 6974 792e 2054 6869 7320 6973  riority. This is
+000479f0: 2022 0a20 2020 2020 2020 2022 7573 6566   ".        "usef
+00047a00: 756c 2066 6f72 2073 656e 6469 6e67 2065  ul for sending e
+00047a10: 6d6f 6a69 7320 696e 2073 686f 7274 636f  mojis in shortco
+00047a20: 6465 2066 6f72 6d20 3a63 6f6c 6c69 7369  de form :collisi
+00047a30: 6f6e 3a2e 222c 0a20 2020 2029 0a0a 2020  on:.",.    )..  
+00047a40: 2020 2320 2d73 2069 7320 616c 7265 6164    # -s is alread
+00047a50: 7920 7573 6564 2066 6f72 202d 2d73 746f  y used for --sto
+00047a60: 7265 2c20 2d69 2066 6f72 2073 506c 6974  re, -i for sPlit
+00047a70: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00047a80: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+00047a90: 7022 2c0a 2020 2020 2020 2020 222d 2d73  p",.        "--s
+00047aa0: 706c 6974 222c 0a20 2020 2020 2020 2072  plit",.        r
+00047ab0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+00047ac0: 2020 2020 2020 2074 7970 653d 7374 722c         type=str,
+00047ad0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+00047ae0: 3d22 5345 5041 5241 544f 5222 2c0a 2020  ="SEPARATOR",.  
+00047af0: 2020 2020 2020 6865 6c70 3d22 5370 6c69        help="Spli
+00047b00: 7420 6d65 7373 6167 6520 7465 7874 2069  t message text i
+00047b10: 6e74 6f20 6d75 6c74 6970 6c65 204d 6174  nto multiple Mat
+00047b20: 7269 7820 6d65 7373 6167 6573 2e20 220a  rix messages. ".
+00047b30: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+00047b40: 3a3a 2049 6620 7365 742c 2073 706c 6974  :: If set, split
+00047b50: 2074 6865 206d 6573 7361 6765 2873 2920   the message(s) 
+00047b60: 696e 746f 206d 756c 7469 706c 6520 6d65  into multiple me
+00047b70: 7373 6167 6573 2022 0a20 2020 2020 2020  ssages ".       
+00047b80: 2022 7768 6572 6576 6572 2074 6865 2073   "wherever the s
+00047b90: 7472 696e 6720 7370 6563 6966 6965 6420  tring specified 
+00047ba0: 7769 7468 202d 2d73 706c 6974 206f 6363  with --split occ
+00047bb0: 7572 732e 2022 0a20 2020 2020 2020 2022  urs. ".        "
+00047bc0: 452e 672e 204f 6e65 2070 6970 6573 2061  E.g. One pipes a
+00047bd0: 2073 7472 6561 6d20 6f66 2052 5353 2061   stream of RSS a
+00047be0: 7274 6963 6c65 7320 696e 746f 2074 6865  rticles into the
+00047bf0: 2022 0a20 2020 2020 2020 2022 7072 6f67   ".        "prog
+00047c00: 7261 6d20 616e 6420 7468 6520 6172 7469  ram and the arti
+00047c10: 636c 6573 2061 7265 2073 6570 6172 6174  cles are separat
+00047c20: 6564 2062 7920 7468 7265 6520 220a 2020  ed by three ".  
+00047c30: 2020 2020 2020 226e 6577 6c69 6e65 732e        "newlines.
+00047c40: 2022 0a20 2020 2020 2020 2027 5468 656e   ".        'Then
+00047c50: 2077 6974 6820 2d2d 7370 6c69 7420 7365   with --split se
+00047c60: 7420 746f 2022 5c5c 6e5c 5c6e 5c5c 6e22  t to "\\n\\n\\n"
+00047c70: 2065 6163 6820 6172 7469 636c 6520 270a   each article '.
+00047c80: 2020 2020 2020 2020 2277 696c 6c20 6265          "will be
+00047c90: 2070 7269 6e74 6564 2069 6e20 6120 7365   printed in a se
+00047ca0: 7061 7261 7465 206d 6573 7361 6765 2e20  parate message. 
+00047cb0: 220a 2020 2020 2020 2020 2242 7920 6465  ".        "By de
+00047cc0: 6661 756c 742c 2069 2e65 2e20 6966 206e  fault, i.e. if n
+00047cd0: 6f74 2073 6574 2c20 6e6f 206d 6573 7361  ot set, no messa
+00047ce0: 6765 7320 7769 6c6c 2062 6520 7370 6c69  ges will be spli
+00047cf0: 742e 222c 0a20 2020 2029 0a20 2020 2023  t.",.    ).    #
+00047d00: 202d 6320 6973 2061 6c72 6561 6479 2075   -c is already u
+00047d10: 7365 6420 666f 7220 2d2d 6372 6564 656e  sed for --creden
+00047d20: 7469 616c 730a 2020 2020 6170 2e61 6464  tials.    ap.add
+00047d30: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00047d40: 2020 2022 2d2d 636f 6e66 6967 222c 0a20     "--config",. 
+00047d50: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+00047d60: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
+00047d70: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+00047d80: 206d 6574 6176 6172 3d22 434f 4e46 4947   metavar="CONFIG
+00047d90: 5f46 494c 4522 2c0a 2020 2020 2020 2020  _FILE",.        
+00047da0: 6865 6c70 3d22 5370 6563 6966 7920 7468  help="Specify th
+00047db0: 6520 6c6f 6361 7469 6f6e 206f 6620 6120  e location of a 
+00047dc0: 636f 6e66 6967 2066 696c 652e 2022 0a20  config file. ". 
+00047dd0: 2020 2020 2020 2022 4465 7461 696c 733a         "Details:
+00047de0: 3a20 4279 2064 6566 6175 6c74 2c20 6e6f  : By default, no
+00047df0: 2022 0a20 2020 2020 2020 2022 636f 6e66   ".        "conf
+00047e00: 6967 2066 696c 6520 6973 2075 7365 642e  ig file is used.
+00047e10: 2022 0a20 2020 2020 2020 2022 4966 2074   ".        "If t
+00047e20: 6869 7320 6f70 7469 6f6e 2069 7320 7072  his option is pr
+00047e30: 6f76 6964 6564 2c20 7468 6520 7072 6f76  ovided, the prov
+00047e40: 6964 6564 2066 696c 6520 6e61 6d65 2022  ided file name "
+00047e50: 0a20 2020 2020 2020 2022 7769 6c6c 2062  .        "will b
+00047e60: 6520 7573 6564 2074 6f20 7265 6164 2063  e used to read c
+00047e70: 6f6e 6669 6775 7261 7469 6f6e 2066 726f  onfiguration fro
+00047e80: 6d2e 204e 6f74 2069 6d70 6c65 6d65 6e74  m. Not implement
+00047e90: 6564 2e22 2c0a 2020 2020 290a 2020 2020  ed.",.    ).    
+00047ea0: 2320 2d70 2069 7320 616c 7265 6164 7920  # -p is already 
+00047eb0: 7573 6564 2066 6f72 202d 2d73 706c 6974  used for --split
+00047ec0: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00047ed0: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+00047ee0: 2d70 726f 7879 222c 0a20 2020 2020 2020  -proxy",.       
+00047ef0: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+00047f00: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+00047f10: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
+00047f20: 6172 3d22 5052 4f58 5922 2c0a 2020 2020  ar="PROXY",.    
+00047f30: 2020 2020 6865 6c70 3d22 5370 6563 6966      help="Specif
+00047f40: 7920 6120 7072 6f78 7920 666f 7220 636f  y a proxy for co
+00047f50: 6e6e 6563 7469 7669 7479 2e20 220a 2020  nnectivity. ".  
+00047f60: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00047f70: 2042 7920 6465 6661 756c 742c 2022 0a20   By default, ". 
+00047f80: 2020 2020 2020 2022 692e 652e 2069 6620         "i.e. if 
+00047f90: 7468 6973 206f 7074 696f 6e20 6973 206e  this option is n
+00047fa0: 6f74 2073 6574 2c20 6e6f 2070 726f 7879  ot set, no proxy
+00047fb0: 2069 7320 7573 6564 2e20 220a 2020 2020   is used. ".    
+00047fc0: 2020 2020 2249 6620 7468 6973 206f 7074      "If this opt
+00047fd0: 696f 6e20 6973 2075 7365 6420 6120 7072  ion is used a pr
+00047fe0: 6f78 7920 5552 4c20 6d75 7374 2062 6520  oxy URL must be 
+00047ff0: 7072 6f76 6964 6564 2e20 220a 2020 2020  provided. ".    
+00048000: 2020 2020 2254 6865 2070 726f 7669 6465      "The provide
+00048010: 6420 7072 6f78 7920 5552 4c20 220a 2020  d proxy URL ".  
+00048020: 2020 2020 2020 2277 696c 6c20 6265 2075        "will be u
+00048030: 7365 6420 666f 7220 7468 6520 4854 5450  sed for the HTTP
+00048040: 2063 6f6e 6e65 6374 696f 6e20 746f 2074   connection to t
+00048050: 6865 2073 6572 7665 722e 2022 0a20 2020  he server. ".   
+00048060: 2020 2020 2022 5468 6520 7072 6f78 7920       "The proxy 
+00048070: 7375 7070 6f72 7473 2053 4f43 4b53 3428  supports SOCKS4(
+00048080: 6129 2c20 534f 434b 5335 2c20 616e 6420  a), SOCKS5, and 
+00048090: 4854 5450 2028 7475 6e6e 656c 696e 6729  HTTP (tunneling)
+000480a0: 2e20 220a 2020 2020 2020 2020 2745 7861  . ".        'Exa
+000480b0: 6d70 6c65 7320 6f66 2076 616c 6964 2055  mples of valid U
+000480c0: 524c 7320 6172 6520 2268 7474 703a 2f2f  RLs are "http://
+000480d0: 3130 2e31 302e 3130 2e31 303a 3831 3138  10.10.10.10:8118
+000480e0: 2220 270a 2020 2020 2020 2020 276f 7220  " '.        'or 
+000480f0: 2273 6f63 6b73 353a 2f2f 7573 6572 3a70  "socks5://user:p
+00048100: 6173 7377 6f72 6440 3132 372e 302e 302e  assword@127.0.0.
+00048110: 313a 3130 3830 222e 2027 0a20 2020 2020  1:1080". '.     
+00048120: 2020 2027 5552 4c73 2077 6974 6820 2268     'URLs with "h
+00048130: 7474 7073 2220 6f72 2022 736f 636b 7334  ttps" or "socks4
+00048140: 6122 2061 7265 206e 6f74 2076 616c 6964  a" are not valid
+00048150: 2e20 4f6e 6c79 2027 0a20 2020 2020 2020  . Only '.       
+00048160: 2027 2268 7474 7022 2c20 2273 6f63 6b73   '"http", "socks
+00048170: 3422 2061 6e64 2022 736f 636b 7335 2220  4" and "socks5" 
+00048180: 6172 6520 7661 6c69 642e 272c 0a20 2020  are valid.',.   
+00048190: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+000481a0: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+000481b0: 222d 6e22 2c0a 2020 2020 2020 2020 222d  "-n",.        "-
+000481c0: 2d6e 6f74 6963 6522 2c0a 2020 2020 2020  -notice",.      
+000481d0: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+000481e0: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+000481f0: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
+00048200: 2020 2020 2020 2068 656c 703d 2253 656e         help="Sen
+00048210: 6420 6d65 7373 6167 6520 6173 206e 6f74  d message as not
+00048220: 6963 652e 2022 0a20 2020 2020 2020 2022  ice. ".        "
+00048230: 4465 7461 696c 733a 3a20 4966 206e 6f74  Details:: If not
+00048240: 2073 7065 6369 6669 6564 2c20 6d65 7373   specified, mess
+00048250: 6167 6520 7769 6c6c 2062 6520 7365 6e74  age will be sent
+00048260: 2061 7320 7465 7874 2e22 2c0a 2020 2020   as text.",.    
+00048270: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00048280: 756d 656e 7428 0a20 2020 2020 2020 2023  ument(.        #
+00048290: 206e 6f20 7369 6e67 6c65 2063 6861 7220   no single char 
+000482a0: 666c 6167 0a20 2020 2020 2020 2022 2d2d  flag.        "--
+000482b0: 656e 6372 7970 7465 6422 2c0a 2020 2020  encrypted",.    
+000482c0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+000482d0: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+000482e0: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
+000482f0: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
+00048300: 656e 6420 6d65 7373 6167 6520 656e 642d  end message end-
+00048310: 746f 2d65 6e64 2065 6e63 7279 7074 6564  to-end encrypted
+00048320: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+00048330: 6169 6c73 3a3a 2045 6e63 7279 7074 696f  ails:: Encryptio
+00048340: 6e20 6973 2061 6c77 6179 7320 7475 726e  n is always turn
+00048350: 6564 206f 6e20 616e 6420 220a 2020 2020  ed on and ".    
+00048360: 2020 2020 2277 696c 6c20 616c 7761 7973      "will always
+00048370: 2062 6520 7573 6564 2077 6865 7265 2070   be used where p
+00048380: 6f73 7369 626c 652e 2022 0a20 2020 2020  ossible. ".     
+00048390: 2020 2022 4974 2063 616e 6e6f 7420 6265     "It cannot be
+000483a0: 2074 7572 6e65 6420 6f66 662e 2054 6869   turned off. Thi
+000483b0: 7320 666c 6167 2064 6f65 7320 6e6f 7468  s flag does noth
+000483c0: 696e 6720 220a 2020 2020 2020 2020 2261  ing ".        "a
+000483d0: 7320 656e 6372 7970 7469 6f6e 2069 7320  s encryption is 
+000483e0: 7475 726e 6564 206f 6e20 7769 7468 206f  turned on with o
+000483f0: 7220 7769 7468 6f75 7420 7468 6973 2022  r without this "
+00048400: 0a20 2020 2020 2020 2022 6172 6775 6d65  .        "argume
+00048410: 6e74 2e20 5468 6973 2066 6c61 6720 6578  nt. This flag ex
+00048420: 6973 7473 206f 6e6c 7920 666f 7220 6869  ists only for hi
+00048430: 7374 6f72 6963 2072 6561 736f 6e73 2e20  storic reasons. 
+00048440: 220a 2020 2020 2020 2020 2249 6e20 736f  ".        "In so
+00048450: 6d65 2073 7065 6369 6669 6320 6361 7365  me specific case
+00048460: 2065 6e63 7279 7074 696f 6e20 220a 2020   encryption ".  
+00048470: 2020 2020 2020 2263 616e 2062 6520 6469        "can be di
+00048480: 7361 626c 6564 2c20 706c 6561 7365 2073  sabled, please s
+00048490: 6565 202d 2d70 6c61 696e 2e22 2c0a 2020  ee --plain.",.  
+000484a0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+000484b0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+000484c0: 2022 2d6c 222c 0a20 2020 2020 2020 2022   "-l",.        "
+000484d0: 2d2d 6c69 7374 656e 222c 0a20 2020 2020  --listen",.     
+000484e0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+000484f0: 652c 0a20 2020 2020 2020 2074 7970 653d  e,.        type=
+00048500: 7374 722c 0a20 2020 2020 2020 2064 6566  str,.        def
+00048510: 6175 6c74 3d4c 4953 5445 4e5f 4445 4641  ault=LISTEN_DEFA
+00048520: 554c 542c 2020 2320 7768 656e 202d 6c20  ULT,  # when -l 
+00048530: 6973 206e 6f74 2075 7365 640a 2020 2020  is not used.    
+00048540: 2020 2020 6e61 7267 733d 223f 222c 2020      nargs="?",  
+00048550: 2320 6d61 6b65 7320 7468 6520 776f 7264  # makes the word
+00048560: 206f 7074 696f 6e61 6c0a 2020 2020 2020   optional.      
+00048570: 2020 636f 6e73 743d 464f 5245 5645 522c    const=FOREVER,
+00048580: 2020 2320 7768 656e 202d 6c20 6973 2075    # when -l is u
+00048590: 7365 642c 2062 7574 2046 4f52 4556 4552  sed, but FOREVER
+000485a0: 2069 7320 6e6f 7420 6164 6465 640a 2020   is not added.  
+000485b0: 2020 2020 2020 6d65 7461 7661 723d 224e        metavar="N
+000485c0: 4556 4552 7c4f 4e43 457c 464f 5245 5645  EVER|ONCE|FOREVE
+000485d0: 527c 5441 494c 7c41 4c4c 222c 0a20 2020  R|TAIL|ALL",.   
+000485e0: 2020 2020 2068 656c 703d 2250 7269 6e74       help="Print
+000485f0: 2072 6563 6569 7665 6420 6d65 7373 6167   received messag
+00048600: 6573 2061 6e64 206c 6973 7465 6e20 746f  es and listen to
+00048610: 206d 6573 7361 6765 732e 2022 0a20 2020   messages. ".   
+00048620: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+00048630: 5468 6520 2d2d 6c69 7374 656e 206f 7074  The --listen opt
+00048640: 696f 6e20 7461 6b65 7320 6f6e 6520 6172  ion takes one ar
+00048650: 6775 6d65 6e74 2e20 5468 6572 6520 220a  gument. There ".
+00048660: 2020 2020 2020 2020 6627 6172 6520 7365          f'are se
+00048670: 7665 7261 6c20 6368 6f69 6365 733a 2022  veral choices: "
+00048680: 7b4e 4556 4552 7d22 2c20 227b 4f4e 4345  {NEVER}", "{ONCE
+00048690: 7d22 2c20 270a 2020 2020 2020 2020 6627  }", '.        f'
+000486a0: 227b 464f 5245 5645 527d 222c 2022 7b54  "{FOREVER}", "{T
+000486b0: 4149 4c7d 222c 2061 6e64 2022 7b41 4c4c  AIL}", and "{ALL
+000486c0: 7d22 2e20 270a 2020 2020 2020 2020 6627  }". '.        f'
+000486d0: 4279 2064 6566 6175 6c74 2c20 2d2d 6c69  By default, --li
+000486e0: 7374 656e 2069 7320 7365 7420 746f 2022  sten is set to "
+000486f0: 7b4e 4556 4552 7d22 2e20 2053 6f2c 2062  {NEVER}".  So, b
+00048700: 7920 270a 2020 2020 2020 2020 2264 6566  y '.        "def
+00048710: 6175 6c74 206e 6f20 6c69 7374 656e 696e  ault no listenin
+00048720: 6720 7769 6c6c 2062 6520 646f 6e65 2e20  g will be done. 
+00048730: 5365 7420 6974 2074 6f20 220a 2020 2020  Set it to ".    
+00048740: 2020 2020 6627 227b 464f 5245 5645 527d      f'"{FOREVER}
+00048750: 2220 746f 206c 6973 7465 6e20 666f 7220  " to listen for 
+00048760: 616e 6420 7072 696e 7420 696e 636f 6d69  and print incomi
+00048770: 6e67 206d 6573 7361 6765 7320 270a 2020  ng messages '.  
+00048780: 2020 2020 2020 2274 6f20 7374 646f 7574        "to stdout
+00048790: 2e20 220a 2020 2020 2020 2020 6627 222d  . ".        f'"-
+000487a0: 2d6c 6973 7465 6e20 7b46 4f52 4556 4552  -listen {FOREVER
+000487b0: 7d22 2077 696c 6c20 6c69 7374 656e 2074  }" will listen t
+000487c0: 6f20 616c 6c20 6d65 7373 6167 6573 206f  o all messages o
+000487d0: 6e20 270a 2020 2020 2020 2020 2261 6c6c  n '.        "all
+000487e0: 2072 6f6f 6d73 2066 6f72 6576 6572 2e20   rooms forever. 
+000487f0: 220a 2020 2020 2020 2020 6627 546f 2073  ".        f'To s
+00048800: 746f 7020 6c69 7374 656e 696e 6720 227b  top listening "{
+00048810: 464f 5245 5645 527d 222c 2075 7365 2043  FOREVER}", use C
+00048820: 6f6e 7472 6f6c 2d43 206f 6e20 270a 2020  ontrol-C on '.  
+00048830: 2020 2020 2020 2274 6865 206b 6579 626f        "the keybo
+00048840: 6172 6420 6f72 2073 656e 6420 6120 7369  ard or send a si
+00048850: 676e 616c 2074 6f20 7468 6520 7072 6f63  gnal to the proc
+00048860: 6573 7320 6f72 2073 6572 7669 6365 2e20  ess or service. 
+00048870: 220a 2020 2020 2020 2020 2254 6865 2050  ".        "The P
+00048880: 4944 2066 6f72 2073 6967 6e61 6c69 6e67  ID for signaling
+00048890: 2063 616e 2062 6520 666f 756e 6420 696e   can be found in
+000488a0: 2061 2050 4944 2066 696c 6520 696e 2022   a PID file in "
+000488b0: 0a20 2020 2020 2020 2066 2764 6972 6563  .        f'direc
+000488c0: 746f 7279 2022 7b50 4944 5f44 4952 5f44  tory "{PID_DIR_D
+000488d0: 4546 4155 4c54 7d22 2e20 270a 2020 2020  EFAULT}". '.    
+000488e0: 2020 2020 6627 222d 2d6c 6973 7465 6e20      f'"--listen 
+000488f0: 7b4f 4e43 457d 2220 7769 6c6c 2067 6574  {ONCE}" will get
+00048900: 2061 6c6c 2074 6865 206d 6573 7361 6765   all the message
+00048910: 7320 6672 6f6d 2027 0a20 2020 2020 2020  s from '.       
+00048920: 2022 616c 6c20 726f 6f6d 7320 7468 6174   "all rooms that
+00048930: 2061 7265 2063 7572 7265 6e74 6c79 2071   are currently q
+00048940: 7565 7565 6420 7570 2e20 536f 2c20 7769  ueued up. So, wi
+00048950: 7468 2022 0a20 2020 2020 2020 2066 2722  th ".        f'"
+00048960: 7b4f 4e43 457d 2220 7468 6520 7072 6f67  {ONCE}" the prog
+00048970: 7261 6d20 7769 6c6c 2073 7461 7274 2c20  ram will start, 
+00048980: 7072 696e 7420 7761 6974 696e 6720 270a  print waiting '.
+00048990: 2020 2020 2020 2020 226d 6573 7361 6765          "message
+000489a0: 7320 2869 6620 616e 7929 2061 6e64 2074  s (if any) and t
+000489b0: 6865 6e20 7374 6f70 2e20 5468 6520 7469  hen stop. The ti
+000489c0: 6d65 6f75 7420 666f 7220 220a 2020 2020  meout for ".    
+000489d0: 2020 2020 6627 227b 4f4e 4345 7d22 2069      f'"{ONCE}" i
+000489e0: 7320 7365 7420 746f 2031 3020 7365 636f  s set to 10 seco
+000489f0: 6e64 732e 2053 6f2c 2062 6520 7061 7469  nds. So, be pati
+00048a00: 656e 742c 2069 7420 270a 2020 2020 2020  ent, it '.      
+00048a10: 2020 226d 6967 6874 2074 616b 6520 7570    "might take up
+00048a20: 2074 6f20 7468 6174 2061 6d6f 756e 7420   to that amount 
+00048a30: 6f66 2074 696d 652e 2022 0a20 2020 2020  of time. ".     
+00048a40: 2020 2066 2722 7b54 4149 4c7d 2220 7265     f'"{TAIL}" re
+00048a50: 6164 7320 616e 6420 7072 696e 7473 2074  ads and prints t
+00048a60: 6865 206c 6173 7420 4e20 270a 2020 2020  he last N '.    
+00048a70: 2020 2020 226d 6573 7361 6765 7320 6672      "messages fr
+00048a80: 6f6d 2074 6865 2073 7065 6369 6669 6564  om the specified
+00048a90: 2072 6f6f 6d73 2c20 7468 656e 2071 7569   rooms, then qui
+00048aa0: 7473 2e20 5468 6520 220a 2020 2020 2020  ts. The ".      
+00048ab0: 2020 226e 756d 6265 7220 4e20 6361 6e20    "number N can 
+00048ac0: 6265 2073 6574 2077 6974 6820 7468 6520  be set with the 
+00048ad0: 2d2d 7461 696c 206f 7074 696f 6e2e 2057  --tail option. W
+00048ae0: 6974 6820 220a 2020 2020 2020 2020 6627  ith ".        f'
+00048af0: 227b 5441 494c 7d22 2073 6f6d 6520 6d65  "{TAIL}" some me
+00048b00: 7373 6167 6573 2072 6561 6420 6d69 6768  ssages read migh
+00048b10: 7420 6265 206f 6c64 2c20 270a 2020 2020  t be old, '.    
+00048b20: 2020 2020 2269 2e65 2e20 616c 7265 6164      "i.e. alread
+00048b30: 7920 7265 6164 2062 6566 6f72 652c 2073  y read before, s
+00048b40: 6f6d 6520 6d69 6768 7420 6265 206e 6577  ome might be new
+00048b50: 2c20 220a 2020 2020 2020 2020 2269 2e65  , ".        "i.e
+00048b60: 2e20 6e65 7665 7220 7265 6164 2062 6566  . never read bef
+00048b70: 6f72 652e 2049 7420 7072 696e 7473 2074  ore. It prints t
+00048b80: 6865 206d 6573 7361 6765 7320 616e 6420  he messages and 
+00048b90: 7468 656e 2022 0a20 2020 2020 2020 2066  then ".        f
+00048ba0: 2274 6865 2070 726f 6772 616d 2073 746f  "the program sto
+00048bb0: 7073 2e20 220a 2020 2020 2020 2020 224d  ps. ".        "M
+00048bc0: 6573 7361 6765 7320 6172 6520 736f 7274  essages are sort
+00048bd0: 6564 2c20 6c61 7374 2d66 6972 7374 2e20  ed, last-first. 
+00048be0: 220a 2020 2020 2020 2020 224c 6f6f 6b20  ".        "Look 
+00048bf0: 6174 202d 2d74 6169 6c20 6173 2074 6861  at --tail as tha
+00048c00: 7420 6f70 7469 6f6e 2069 7320 7265 6c61  t option is rela
+00048c10: 7465 6420 220a 2020 2020 2020 2020 2274  ted ".        "t
+00048c20: 6f20 2d2d 6c69 7374 656e 2074 6169 6c2e  o --listen tail.
+00048c30: 2022 0a20 2020 2020 2020 2066 2754 6865   ".        f'The
+00048c40: 206f 7074 696f 6e20 227b 414c 4c7d 2220   option "{ALL}" 
+00048c50: 6765 7473 2061 6c6c 206d 6573 7361 6765  gets all message
+00048c60: 7320 6176 6169 6c61 626c 652c 2027 0a20  s available, '. 
+00048c70: 2020 2020 2020 2022 6f6c 6420 616e 6420         "old and 
+00048c80: 6e65 772e 2022 0a20 2020 2020 2020 2066  new. ".        f
+00048c90: 2755 6e6c 696b 6520 227b 4f4e 4345 7d22  'Unlike "{ONCE}"
+00048ca0: 2061 6e64 2027 0a20 2020 2020 2020 2066   and '.        f
+00048cb0: 2722 7b46 4f52 4556 4552 7d22 2074 6861  '"{FOREVER}" tha
+00048cc0: 7420 6c69 7374 656e 2069 6e20 414c 4c20  t listen in ALL 
+00048cd0: 726f 6f6d 732c 2022 7b54 4149 4c7d 2220  rooms, "{TAIL}" 
+00048ce0: 270a 2020 2020 2020 2020 6627 616e 6420  '.        f'and 
+00048cf0: 227b 414c 4c7d 2220 6c69 7374 656e 2027  "{ALL}" listen '
+00048d00: 0a20 2020 2020 2020 2022 6f6e 6c79 2074  .        "only t
+00048d10: 6f20 7468 6520 726f 6f6d 2073 7065 6369  o the room speci
+00048d20: 6669 6564 2069 6e20 7468 6520 6372 6564  fied in the cred
+00048d30: 656e 7469 616c 7320 220a 2020 2020 2020  entials ".      
+00048d40: 2020 2266 696c 6520 6f72 2074 6865 202d    "file or the -
+00048d50: 2d72 6f6f 6d20 6f70 7469 6f6e 732e 2022  -room options. "
+00048d60: 2c0a 2020 2020 290a 2020 2020 6170 2e61  ,.    ).    ap.a
+00048d70: 6464 5f61 7267 756d 656e 7428 0a20 2020  dd_argument(.   
+00048d80: 2020 2020 2022 2d74 222c 0a20 2020 2020       "-t",.     
+00048d90: 2020 2022 2d2d 7461 696c 222c 0a20 2020     "--tail",.   
+00048da0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+00048db0: 6c73 652c 0a20 2020 2020 2020 2074 7970  lse,.        typ
+00048dc0: 653d 696e 742c 0a20 2020 2020 2020 2064  e=int,.        d
+00048dd0: 6566 6175 6c74 3d54 4149 4c5f 554e 5553  efault=TAIL_UNUS
+00048de0: 4544 5f44 4546 4155 4c54 2c20 2023 2077  ED_DEFAULT,  # w
+00048df0: 6865 6e20 2d74 2069 7320 6e6f 7420 7573  hen -t is not us
+00048e00: 6564 0a20 2020 2020 2020 206e 6172 6773  ed.        nargs
+00048e10: 3d22 3f22 2c20 2023 206d 616b 6573 2074  ="?",  # makes t
+00048e20: 6865 2077 6f72 6420 6f70 7469 6f6e 616c  he word optional
+00048e30: 0a20 2020 2020 2020 2023 2077 6865 6e20  .        # when 
+00048e40: 2d74 2069 7320 7573 6564 2c20 6275 7420  -t is used, but 
+00048e50: 6e75 6d62 6572 2069 7320 6e6f 7420 6164  number is not ad
+00048e60: 6465 640a 2020 2020 2020 2020 636f 6e73  ded.        cons
+00048e70: 743d 5441 494c 5f55 5345 445f 4445 4641  t=TAIL_USED_DEFA
+00048e80: 554c 542c 0a20 2020 2020 2020 206d 6574  ULT,.        met
+00048e90: 6176 6172 3d22 4e55 4d42 4552 222c 0a20  avar="NUMBER",. 
+00048ea0: 2020 2020 2020 2068 656c 703d 2250 7269         help="Pri
+00048eb0: 6e74 206c 6173 7420 6d65 7373 6167 6573  nt last messages
+00048ec0: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+00048ed0: 6169 6c73 3a3a 2054 6865 202d 2d74 6169  ails:: The --tai
+00048ee0: 6c20 6f70 7469 6f6e 2072 6561 6473 2061  l option reads a
+00048ef0: 6e64 2070 7269 6e74 7320 7570 2074 6f20  nd prints up to 
+00048f00: 7468 6520 6c61 7374 204e 2022 0a20 2020  the last N ".   
+00048f10: 2020 2020 2022 6d65 7373 6167 6573 2066       "messages f
+00048f20: 726f 6d20 7468 6520 7370 6563 6966 6965  rom the specifie
+00048f30: 6420 726f 6f6d 732c 2074 6865 6e20 7175  d rooms, then qu
+00048f40: 6974 732e 2022 0a20 2020 2020 2020 2022  its. ".        "
+00048f50: 4974 2074 616b 6573 206f 6e65 2022 0a20  It takes one ". 
+00048f60: 2020 2020 2020 2022 6172 6775 6d65 6e74         "argument
+00048f70: 2c20 616e 2069 6e74 6567 6572 2c20 220a  , an integer, ".
+00048f80: 2020 2020 2020 2020 2277 6869 6368 2077          "which w
+00048f90: 6520 6361 6c6c 204e 2068 6572 652e 2049  e call N here. I
+00048fa0: 6620 7468 6572 6520 6172 6520 6665 7765  f there are fewe
+00048fb0: 7220 7468 616e 204e 206d 6573 7361 6765  r than N message
+00048fc0: 7320 220a 2020 2020 2020 2020 2269 6e20  s ".        "in 
+00048fd0: 6120 726f 6f6d 2c20 6974 2072 6561 6473  a room, it reads
+00048fe0: 2061 6e64 2070 7269 6e74 7320 7570 2074   and prints up t
+00048ff0: 6f20 4e20 6d65 7373 6167 6573 2e20 220a  o N messages. ".
+00049000: 2020 2020 2020 2020 2249 7420 6765 7473          "It gets
+00049010: 2074 6865 206c 6173 7420 4e20 6d65 7373   the last N mess
+00049020: 6167 6573 2069 6e20 7265 7665 7273 6520  ages in reverse 
+00049030: 6f72 6465 722e 2022 0a20 2020 2020 2020  order. ".       
+00049040: 2022 4974 2070 7269 6e74 2074 6865 206e   "It print the n
+00049050: 6577 6573 7420 6d65 7373 6167 6520 6669  ewest message fi
+00049060: 7273 742c 2061 6e64 2074 6865 2022 0a20  rst, and the ". 
+00049070: 2020 2020 2020 2022 6f6c 6465 7374 206d         "oldest m
+00049080: 6573 7361 6765 206c 6173 742e 2022 0a20  essage last. ". 
+00049090: 2020 2020 2020 2022 4966 202d 2d6c 6973         "If --lis
+000490a0: 7465 6e2d 7365 6c66 2069 7320 6e6f 7420  ten-self is not 
+000490b0: 7365 7420 6974 2077 696c 6c20 7072 696e  set it will prin
+000490c0: 7420 6c65 7373 2074 6861 6e20 220a 2020  t less than ".  
+000490d0: 2020 2020 2020 224e 206d 6573 7361 6765        "N message
+000490e0: 7320 696e 206d 616e 7920 6361 7365 7320  s in many cases 
+000490f0: 6265 6361 7573 6520 4e20 6d65 7373 6167  because N messag
+00049100: 6573 2061 7265 2022 0a20 2020 2020 2020  es are ".       
+00049110: 2022 6f62 7461 696e 6564 2c20 6275 7420   "obtained, but 
+00049120: 736f 6d65 206f 6620 7468 656d 2061 7265  some of them are
+00049130: 2064 6973 6361 7264 6564 2062 7920 6465   discarded by de
+00049140: 6661 756c 7420 6966 2022 0a20 2020 2020  fault if ".     
+00049150: 2020 2022 7468 6579 2061 7265 2066 726f     "they are fro
+00049160: 6d20 7468 6520 7573 6572 2069 7473 656c  m the user itsel
+00049170: 662e 2022 0a20 2020 2020 2020 2022 4c6f  f. ".        "Lo
+00049180: 6f6b 2061 7420 2d2d 6c69 7374 656e 2061  ok at --listen a
+00049190: 7320 7468 6973 206f 7074 696f 6e20 6973  s this option is
+000491a0: 2072 656c 6174 6564 2074 6f20 2d2d 7461   related to --ta
+000491b0: 696c 2e22 2c0a 2020 2020 290a 2020 2020  il.",.    ).    
+000491c0: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+000491d0: 0a20 2020 2020 2020 2022 2d79 222c 0a20  .        "-y",. 
+000491e0: 2020 2020 2020 2022 2d2d 6c69 7374 656e         "--listen
+000491f0: 2d73 656c 6622 2c0a 2020 2020 2020 2020  -self",.        
+00049200: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00049210: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+00049220: 7374 6f72 655f 7472 7565 222c 0a20 2020  store_true",.   
+00049230: 2020 2020 2068 656c 703d 2250 7269 6e74       help="Print
+00049240: 2079 6f75 7220 6f77 6e20 6d65 7373 6167   your own messag
+00049250: 6573 2061 7320 7765 6c6c 2e20 220a 2020  es as well. ".  
+00049260: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00049270: 2049 6620 7365 7420 616e 6420 6c69 7374   If set and list
+00049280: 656e 696e 672c 2022 0a20 2020 2020 2020  ening, ".       
+00049290: 2022 7468 656e 2070 726f 6772 616d 2077   "then program w
+000492a0: 696c 6c20 6c69 7374 656e 2074 6f20 616e  ill listen to an
+000492b0: 6420 7072 696e 7420 616c 736f 2022 0a20  d print also ". 
+000492c0: 2020 2020 2020 2022 7468 6520 6d65 7373         "the mess
+000492d0: 6167 6573 2073 656e 7420 6279 2069 7473  ages sent by its
+000492e0: 206f 776e 2075 7365 722e 2022 0a20 2020   own user. ".   
+000492f0: 2020 2020 2022 4279 2064 6566 6175 6c74       "By default
+00049300: 206d 6573 7361 6765 7320 6672 6f6d 206f   messages from o
+00049310: 6e65 7365 6c66 2061 7265 206e 6f74 2070  neself are not p
+00049320: 7269 6e74 6564 2e22 2c0a 2020 2020 290a  rinted.",.    ).
+00049330: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+00049340: 656e 7428 0a20 2020 2020 2020 2023 206e  ent(.        # n
+00049350: 6f20 7369 6e67 6c65 2063 6861 7220 666c  o single char fl
+00049360: 6167 0a20 2020 2020 2020 2022 2d2d 7072  ag.        "--pr
+00049370: 696e 742d 6576 656e 742d 6964 222c 0a20  int-event-id",. 
+00049380: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+00049390: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
+000493a0: 6374 696f 6e3d 2273 746f 7265 5f74 7275  ction="store_tru
+000493b0: 6522 2c0a 2020 2020 2020 2020 6865 6c70  e",.        help
+000493c0: 3d22 5072 696e 7420 6576 656e 7420 6964  ="Print event id
+000493d0: 7320 6f66 2072 6563 6569 7665 6420 6d65  s of received me
+000493e0: 7373 6167 6573 2e20 220a 2020 2020 2020  ssages. ".      
+000493f0: 2020 2244 6574 6169 6c73 3a3a 2049 6620    "Details:: If 
+00049400: 7365 7420 616e 6420 6c69 7374 656e 696e  set and listenin
+00049410: 672c 2022 0a20 2020 2020 2020 2066 2274  g, ".        f"t
+00049420: 6865 6e20 277b 5052 4f47 5f57 4954 484f  hen '{PROG_WITHO
+00049430: 5554 5f45 5854 7d27 2077 696c 6c20 7072  UT_EXT}' will pr
+00049440: 696e 7420 616c 736f 2074 6865 2065 7665  int also the eve
+00049450: 6e74 2069 6420 666f 7220 220a 2020 2020  nt id for ".    
+00049460: 2020 2020 2265 6163 6820 7265 6365 6976      "each receiv
+00049470: 6564 206d 6573 7361 6765 206f 7220 6f74  ed message or ot
+00049480: 6865 7220 7265 6365 6976 6564 2065 7665  her received eve
+00049490: 6e74 2e20 4966 2073 6574 2061 6e64 2022  nt. If set and "
+000494a0: 0a20 2020 2020 2020 2066 2273 656e 6469  .        f"sendi
+000494b0: 6e67 2c20 7468 656e 2027 7b50 524f 475f  ng, then '{PROG_
+000494c0: 5749 5448 4f55 545f 4558 547d 2720 7769  WITHOUT_EXT}' wi
+000494d0: 6c6c 2070 7269 6e74 2074 6865 2065 7665  ll print the eve
+000494e0: 6e74 2069 6420 220a 2020 2020 2020 2020  nt id ".        
+000494f0: 226f 6620 7468 6520 7365 6e74 206d 6573  "of the sent mes
+00049500: 7361 6765 206f 7220 7468 6520 7365 6e74  sage or the sent
+00049510: 206f 626a 6563 7420 2861 7564 696f 2c20   object (audio, 
+00049520: 6669 6c65 2c20 6576 656e 7429 2074 6f20  file, event) to 
+00049530: 220a 2020 2020 2020 2020 2273 7464 6f75  ".        "stdou
+00049540: 742e 204f 7468 6572 2069 6e66 6f72 6d61  t. Other informa
+00049550: 7469 6f6e 206c 696b 6520 726f 6f6d 2069  tion like room i
+00049560: 6420 616e 6420 7265 6665 7265 6e63 6520  d and reference 
+00049570: 746f 2077 6861 7420 7761 7320 220a 2020  to what was ".  
+00049580: 2020 2020 2020 2273 656e 7420 7769 6c6c        "sent will
+00049590: 2062 6520 7072 696e 7465 6420 746f 6f2e   be printed too.
+000495a0: 2046 6f72 2073 656e 6469 6e67 2074 6869   For sending thi
+000495b0: 7320 6973 2075 7365 6675 6c2c 2022 0a20  s is useful, ". 
+000495c0: 2020 2020 2020 2022 6966 2061 6674 6572         "if after
+000495d0: 2073 656e 6469 6e67 2074 6865 2075 7365   sending the use
+000495e0: 7220 220a 2020 2020 2020 2020 2277 6973  r ".        "wis
+000495f0: 6865 7320 746f 2070 6572 666f 726d 2066  hes to perform f
+00049600: 7572 7468 6572 206f 7065 7261 7469 6f6e  urther operation
+00049610: 7320 6f6e 2074 6865 2073 656e 7420 6f62  s on the sent ob
+00049620: 6a65 6374 2c20 220a 2020 2020 2020 2020  ject, ".        
+00049630: 2265 2e67 2e20 7265 6461 6374 696e 672f  "e.g. redacting/
+00049640: 6465 6c65 7469 6e67 2069 7420 6166 7465  deleting it afte
+00049650: 7220 616e 2065 7870 6972 6174 696f 6e20  r an expiration 
+00049660: 7469 6d65 2c20 6574 632e 222c 0a20 2020  time, etc.",.   
+00049670: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+00049680: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+00049690: 2320 7374 6172 7469 6e67 2077 6974 6820  # starting with 
+000496a0: 7665 7273 696f 6e20 322e 3139 2022 2d75  version 2.19 "-u
+000496b0: 2220 6861 7320 6265 656e 206d 6f76 6564  " has been moved
+000496c0: 2074 6f20 2d2d 7573 6572 210a 2020 2020   to --user!.    
+000496d0: 2020 2020 222d 2d64 6f77 6e6c 6f61 642d      "--download-
+000496e0: 6d65 6469 6122 2c0a 2020 2020 2020 2020  media",.        
+000496f0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+00049700: 2020 6465 6661 756c 743d 2222 2c20 2023    default="",  #
+00049710: 2069 6620 2d2d 646f 776e 6c6f 6164 2d6d   if --download-m
+00049720: 6564 6961 2069 7320 6e6f 7420 7573 6564  edia is not used
+00049730: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
+00049740: 2273 746f 7265 222c 0a20 2020 2020 2020  "store",.       
+00049750: 206e 6172 6773 3d22 3f22 2c20 2023 206d   nargs="?",  # m
+00049760: 616b 6573 2074 6865 2077 6f72 6420 6f70  akes the word op
+00049770: 7469 6f6e 616c 0a20 2020 2020 2020 2063  tional.        c
+00049780: 6f6e 7374 3d4d 4544 4941 5f44 4952 5f44  onst=MEDIA_DIR_D
+00049790: 4546 4155 4c54 2c20 2023 2077 6865 6e20  EFAULT,  # when 
+000497a0: 6f70 7469 6f6e 2069 7320 7573 6564 2c20  option is used, 
+000497b0: 6275 7420 6e6f 2064 6972 2061 6464 6564  but no dir added
+000497c0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+000497d0: 3d22 444f 574e 4c4f 4144 5f44 4952 4543  ="DOWNLOAD_DIREC
+000497e0: 544f 5259 222c 0a20 2020 2020 2020 2068  TORY",.        h
+000497f0: 656c 703d 2244 6f77 6e6c 6f61 6420 6d65  elp="Download me
+00049800: 6469 6120 6669 6c65 7320 7768 696c 6520  dia files while 
+00049810: 6c69 7374 656e 696e 672e 2022 0a20 2020  listening. ".   
+00049820: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+00049830: 4966 2073 6574 2061 6e64 206c 6973 7465  If set and liste
+00049840: 6e69 6e67 2c20 220a 2020 2020 2020 2020  ning, ".        
+00049850: 2274 6865 6e20 7072 6f67 7261 6d20 7769  "then program wi
+00049860: 6c6c 2064 6f77 6e6c 6f61 6420 220a 2020  ll download ".  
+00049870: 2020 2020 2020 2272 6563 6569 7665 6420        "received 
+00049880: 6d65 6469 6120 6669 6c65 7320 2865 2e67  media files (e.g
+00049890: 2e20 696d 6167 652c 2061 7564 696f 2c20  . image, audio, 
+000498a0: 7669 6465 6f2c 2074 6578 742c 2050 4446  video, text, PDF
+000498b0: 2066 696c 6573 292e 2022 0a20 2020 2020   files). ".     
+000498c0: 2020 2022 6d65 6469 6120 7769 6c6c 2062     "media will b
+000498d0: 6520 646f 776e 6c6f 6164 6564 2074 6f20  e downloaded to 
+000498e0: 6c6f 6361 6c20 6469 7265 6374 6f72 792e  local directory.
+000498f0: 2022 0a20 2020 2020 2020 2022 4279 2064   ".        "By d
+00049900: 6566 6175 6c74 2c20 6d65 6469 6120 7769  efault, media wi
+00049910: 6c6c 2062 6520 646f 776e 6c6f 6164 6564  ll be downloaded
+00049920: 2074 6f20 220a 2020 2020 2020 2020 6627   to ".        f'
+00049930: 6973 2022 7b4d 4544 4941 5f44 4952 5f44  is "{MEDIA_DIR_D
+00049940: 4546 4155 4c54 7d22 2e20 270a 2020 2020  EFAULT}". '.    
+00049950: 2020 2020 2259 6f75 2063 616e 206f 7665      "You can ove
+00049960: 7277 7269 7465 2064 6566 6175 6c74 2077  rwrite default w
+00049970: 6974 6820 796f 7572 2070 7265 6665 7272  ith your preferr
+00049980: 6564 2064 6972 6563 746f 7279 2e20 220a  ed directory. ".
+00049990: 2020 2020 2020 2020 2249 6620 6d65 6469          "If medi
+000499a0: 6120 6973 2065 6e63 7279 7074 6564 2069  a is encrypted i
+000499b0: 7420 7769 6c6c 2062 6520 6465 6372 7970  t will be decryp
+000499c0: 7465 6420 616e 6420 7374 6f72 6564 2064  ted and stored d
+000499d0: 6563 7279 7074 6564 2e20 220a 2020 2020  ecrypted. ".    
+000499e0: 2020 2020 2242 7920 6465 6661 756c 7420      "By default 
+000499f0: 6d65 6469 6120 6669 6c65 7320 7769 6c6c  media files will
+00049a00: 206e 6f74 2062 6520 646f 776e 6c6f 6164   not be download
+00049a10: 6564 2e22 2c0a 2020 2020 290a 2020 2020  ed.",.    ).    
+00049a20: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+00049a30: 0a20 2020 2020 2020 2023 2022 2d6f 222c  .        # "-o",
+00049a40: 2023 2069 6e63 6f6d 7061 7469 626c 6520   # incompatible 
+00049a50: 6368 616e 6765 2044 6563 2032 3032 322c  change Dec 2022,
+00049a60: 202d 6f20 6d6f 7665 6420 746f 202d 2d6f   -o moved to --o
+00049a70: 7574 7075 740a 2020 2020 2020 2020 222d  utput.        "-
+00049a80: 2d6f 732d 6e6f 7469 6679 222c 0a20 2020  -os-notify",.   
+00049a90: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+00049aa0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+00049ab0: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
+00049ac0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+00049ad0: 4e6f 7469 6679 206d 6520 6f66 2061 7272  Notify me of arr
+00049ae0: 6976 696e 6720 6d65 7373 6167 6573 2e20  iving messages. 
+00049af0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+00049b00: 6c73 3a3a 2049 6620 7365 7420 616e 6420  ls:: If set and 
+00049b10: 6c69 7374 656e 696e 672c 2022 0a20 2020  listening, ".   
+00049b20: 2020 2020 2022 7468 656e 2070 726f 6772       "then progr
+00049b30: 616d 2077 696c 6c20 6174 7465 6d70 7420  am will attempt 
+00049b40: 746f 2076 6973 7561 6c6c 7920 6e6f 7469  to visually noti
+00049b50: 6679 206f 6620 220a 2020 2020 2020 2020  fy of ".        
+00049b60: 2261 7272 6976 696e 6720 6d65 7373 6167  "arriving messag
+00049b70: 6573 2074 6872 6f75 6768 2074 6865 206f  es through the o
+00049b80: 7065 7261 7469 6e67 2073 7973 7465 6d2e  perating system.
+00049b90: 2022 0a20 2020 2020 2020 2022 4279 2064   ".        "By d
+00049ba0: 6566 6175 6c74 2074 6865 7265 2069 7320  efault there is 
+00049bb0: 6e6f 206e 6f74 6966 6963 6174 696f 6e20  no notification 
+00049bc0: 7669 6120 4f53 2e22 2c0a 2020 2020 290a  via OS.",.    ).
+00049bd0: 2020 2020 6170 2e61 6464 5f61 7267 756d      ap.add_argum
+00049be0: 656e 7428 0a20 2020 2020 2020 2023 2072  ent(.        # r
+00049bf0: 656d 6f76 6564 2022 2d78 222c 2073 7461  emoved "-x", sta
+00049c00: 7274 696e 6720 7632 2e32 3120 2d78 2069  rting v2.21 -x i
+00049c10: 7320 6e6f 206c 6f6e 6765 7220 7375 7070  s no longer supp
+00049c20: 6f72 7465 640a 2020 2020 2020 2020 222d  orted.        "-
+00049c30: 2d73 6574 2d64 6576 6963 652d 6e61 6d65  -set-device-name
+00049c40: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+00049c50: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+00049c60: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
+00049c70: 2020 2020 2064 6566 6175 6c74 3d53 4554       default=SET
+00049c80: 5f44 4556 4943 455f 4e41 4d45 5f55 4e55  _DEVICE_NAME_UNU
+00049c90: 5345 445f 4445 4641 554c 542c 2020 2320  SED_DEFAULT,  # 
+00049ca0: 7768 656e 206f 7074 696f 6e20 6973 6e27  when option isn'
+00049cb0: 7420 7573 6564 0a20 2020 2020 2020 206d  t used.        m
+00049cc0: 6574 6176 6172 3d22 4445 5649 4345 5f4e  etavar="DEVICE_N
+00049cd0: 414d 4522 2c0a 2020 2020 2020 2020 6865  AME",.        he
+00049ce0: 6c70 3d22 5365 7420 6f72 2072 656e 616d  lp="Set or renam
+00049cf0: 6520 7468 6520 6375 7272 656e 7420 6465  e the current de
+00049d00: 7669 6365 2e20 220a 2020 2020 2020 2020  vice. ".        
+00049d10: 2244 6574 6169 6c73 3a3a 2053 6574 206f  "Details:: Set o
+00049d20: 7220 7265 6e61 6d65 2074 6865 2063 7572  r rename the cur
+00049d30: 7265 6e74 2064 6576 6963 6520 746f 2074  rent device to t
+00049d40: 6865 2022 0a20 2020 2020 2020 2022 6465  he ".        "de
+00049d50: 7669 6365 206e 616d 6520 7072 6f76 6964  vice name provid
+00049d60: 6564 2e20 220a 2020 2020 2020 2020 2253  ed. ".        "S
+00049d70: 656e 642c 206c 6973 7465 6e20 616e 6420  end, listen and 
+00049d80: 7665 7269 6679 206f 7065 7261 7469 6f6e  verify operation
+00049d90: 7320 6172 6520 616c 6c6f 7765 6420 7768  s are allowed wh
+00049da0: 656e 2022 0a20 2020 2020 2020 2022 7265  en ".        "re
+00049db0: 6e61 6d69 6e67 2074 6865 2064 6576 6963  naming the devic
+00049dc0: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
+00049dd0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+00049de0: 2020 2020 2020 2020 222d 2d73 6574 2d64          "--set-d
+00049df0: 6973 706c 6179 2d6e 616d 6522 2c0a 2020  isplay-name",.  
+00049e00: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+00049e10: 616c 7365 2c0a 2020 2020 2020 2020 7479  alse,.        ty
+00049e20: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00049e30: 6465 6661 756c 743d 5345 545f 4449 5350  default=SET_DISP
+00049e40: 4c41 595f 4e41 4d45 5f55 4e55 5345 445f  LAY_NAME_UNUSED_
+00049e50: 4445 4641 554c 542c 2020 2320 7768 656e  DEFAULT,  # when
+00049e60: 206f 7074 696f 6e20 6973 6e27 7420 7573   option isn't us
+00049e70: 6564 0a20 2020 2020 2020 206d 6574 6176  ed.        metav
+00049e80: 6172 3d22 4449 5350 4c41 595f 4e41 4d45  ar="DISPLAY_NAME
+00049e90: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+00049ea0: 2253 6574 206f 7220 7265 6e61 6d65 2074  "Set or rename t
+00049eb0: 6865 2064 6973 706c 6179 206e 616d 652e  he display name.
+00049ec0: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+00049ed0: 696c 733a 3a20 5365 7420 6f72 2072 656e  ils:: Set or ren
+00049ee0: 616d 6520 7468 6520 6469 7370 6c61 7920  ame the display 
+00049ef0: 6e61 6d65 2022 0a20 2020 2020 2020 2022  name ".        "
+00049f00: 666f 7220 7468 6520 6375 7272 656e 7420  for the current 
+00049f10: 7573 6572 2074 6f20 7468 6520 220a 2020  user to the ".  
+00049f20: 2020 2020 2020 2264 6973 706c 6179 206e        "display n
+00049f30: 616d 6520 7072 6f76 6964 6564 2e20 220a  ame provided. ".
+00049f40: 2020 2020 2020 2020 2253 656e 642c 206c          "Send, l
+00049f50: 6973 7465 6e20 616e 6420 7665 7269 6679  isten and verify
+00049f60: 206f 7065 7261 7469 6f6e 7320 6172 6520   operations are 
+00049f70: 616c 6c6f 7765 6420 7768 656e 2022 0a20  allowed when ". 
+00049f80: 2020 2020 2020 2022 7365 7474 696e 6720         "setting 
+00049f90: 7468 6520 6469 7370 6c61 7920 6e61 6d65  the display name
+00049fa0: 2e20 220a 2020 2020 2020 2020 2244 6f20  . ".        "Do 
+00049fb0: 6e6f 7420 636f 6e66 7573 6520 7468 6973  not confuse this
+00049fc0: 206f 7074 696f 6e20 7769 7468 2074 6865   option with the
+00049fd0: 206f 7074 696f 6e20 272d 2d67 6574 2d72   option '--get-r
+00049fe0: 6f6f 6d2d 696e 666f 2720 220a 2020 2020  oom-info' ".    
+00049ff0: 2020 2020 2277 6869 6368 2067 6574 7320      "which gets 
+0004a000: 7468 6520 726f 6f6d 2064 6973 706c 6179  the room display
+0004a010: 206e 616d 652c 206e 6f74 2074 6865 2075   name, not the u
+0004a020: 7365 7220 6469 7370 6c61 7920 6e61 6d65  ser display name
+0004a030: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+0004a040: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+0004a050: 2020 2020 2020 2022 2d2d 6765 742d 6469         "--get-di
+0004a060: 7370 6c61 792d 6e61 6d65 222c 0a20 2020  splay-name",.   
+0004a070: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+0004a080: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+0004a090: 696f 6e3d 2273 746f 7265 5f74 7275 6522  ion="store_true"
+0004a0a0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+0004a0b0: 4765 7420 7468 6520 6469 7370 6c61 7920  Get the display 
+0004a0c0: 6e61 6d65 206f 6620 796f 7572 7365 6c66  name of yourself
+0004a0d0: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+0004a0e0: 6169 6c73 3a3a 2047 6574 2074 6865 2064  ails:: Get the d
+0004a0f0: 6973 706c 6179 206e 616d 6520 6f66 2022  isplay name of "
+0004a100: 0a20 2020 2020 2020 2066 227b 5052 4f47  .        f"{PROG
+0004a110: 5f57 4954 484f 5554 5f45 5854 7d20 2869  _WITHOUT_EXT} (i
+0004a120: 7473 656c 6629 2c20 220a 2020 2020 2020  tself), ".      
+0004a130: 2020 226f 7220 6f66 206f 6e65 206f 7220    "or of one or 
+0004a140: 6d75 6c74 6970 6c65 2075 7365 7273 2e20  multiple users. 
+0004a150: 5370 6563 6966 7920 7573 6572 2873 2920  Specify user(s) 
+0004a160: 7769 7468 2074 6865 2022 0a20 2020 2020  with the ".     
+0004a170: 2020 2022 2d2d 7573 6572 206f 7074 696f     "--user optio
+0004a180: 6e2e 2049 6620 6e6f 2075 7365 7220 6973  n. If no user is
+0004a190: 2073 7065 6369 6669 6564 2067 6574 2074   specified get t
+0004a1a0: 6865 2064 6973 706c 6179 206e 616d 6520  he display name 
+0004a1b0: 6f66 2022 0a20 2020 2020 2020 2022 6974  of ".        "it
+0004a1c0: 7365 6c66 2e20 220a 2020 2020 2020 2020  self. ".        
+0004a1d0: 2253 656e 642c 206c 6973 7465 6e20 616e  "Send, listen an
+0004a1e0: 6420 7665 7269 6679 206f 7065 7261 7469  d verify operati
+0004a1f0: 6f6e 7320 6172 6520 616c 6c6f 7765 6420  ons are allowed 
+0004a200: 7768 656e 2022 0a20 2020 2020 2020 2022  when ".        "
+0004a210: 6765 7474 696e 6720 6469 7370 6c61 7920  getting display 
+0004a220: 6e61 6d65 2873 292e 2022 0a20 2020 2020  name(s). ".     
+0004a230: 2020 2022 446f 206e 6f74 2063 6f6e 6675     "Do not confu
+0004a240: 7365 2074 6869 7320 6f70 7469 6f6e 2077  se this option w
+0004a250: 6974 6820 7468 6520 6f70 7469 6f6e 2027  ith the option '
+0004a260: 2d2d 6765 742d 726f 6f6d 2d69 6e66 6f27  --get-room-info'
+0004a270: 2022 0a20 2020 2020 2020 2022 7768 6963   ".        "whic
+0004a280: 6820 6765 7473 2074 6865 2072 6f6f 6d20  h gets the room 
+0004a290: 6469 7370 6c61 7920 6e61 6d65 2c20 6e6f  display name, no
+0004a2a0: 7420 7468 6520 7573 6572 2064 6973 706c  t the user displ
+0004a2b0: 6179 206e 616d 652e 222c 0a20 2020 2029  ay name.",.    )
+0004a2c0: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+0004a2d0: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+0004a2e0: 2d73 6574 2d70 7265 7365 6e63 6522 2c0a  -set-presence",.
+0004a2f0: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0004a300: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0004a310: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+0004a320: 2020 2320 6465 6661 756c 7473 2074 6f20    # defaults to 
+0004a330: 4e6f 6e65 2069 6620 6e6f 7420 7573 6564  None if not used
+0004a340: 2c20 6973 2073 7472 2069 6620 7573 6564  , is str if used
+0004a350: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+0004a360: 3d22 4f4e 4c49 4e45 7c4f 4646 4c49 4e45  ="ONLINE|OFFLINE
+0004a370: 7c55 4e41 5641 494c 4142 4c45 222c 0a20  |UNAVAILABLE",. 
+0004a380: 2020 2020 2020 2068 656c 703d 2253 6574         help="Set
+0004a390: 2079 6f75 7220 7072 6573 656e 6365 2e20   your presence. 
+0004a3a0: 220a 2020 2020 2020 2020 6622 4465 7461  ".        f"Deta
+0004a3b0: 696c 733a 3a20 5365 7420 7072 6573 656e  ils:: Set presen
+0004a3c0: 6365 206f 6620 7b50 524f 475f 5749 5448  ce of {PROG_WITH
+0004a3d0: 4f55 545f 4558 547d 2074 6f20 7468 6520  OUT_EXT} to the 
+0004a3e0: 6769 7665 6e20 7661 6c75 652e 2022 0a20  given value. ". 
+0004a3f0: 2020 2020 2020 2022 4d75 7374 2062 6520         "Must be 
+0004a400: 6f6e 6520 6f66 2074 6865 7365 2076 616c  one of these val
+0004a410: 7565 733a 20e2 809c 6f6e 6c69 6e65 e280  ues: ...online..
+0004a420: 9d2c 20e2 809c 6f66 666c 696e 65e2 809d  ., ...offline...
+0004a430: 2c20 e280 9c75 6e61 7661 696c 6162 6c65  , ...unavailable
+0004a440: e280 9d2e 2022 0a20 2020 2020 2020 2022  .... ".        "
+0004a450: 4f74 6865 7277 6973 6520 616e 2065 7272  Otherwise an err
+0004a460: 6f72 2077 696c 6c20 6265 2070 726f 6475  or will be produ
+0004a470: 6365 642e 222c 0a20 2020 2029 0a20 2020  ced.",.    ).   
+0004a480: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+0004a490: 280a 2020 2020 2020 2020 222d 2d67 6574  (.        "--get
+0004a4a0: 2d70 7265 7365 6e63 6522 2c0a 2020 2020  -presence",.    
+0004a4b0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+0004a4c0: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+0004a4d0: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
+0004a4e0: 0a20 2020 2020 2020 2023 2064 6566 6175  .        # defau
+0004a4f0: 6c74 7320 746f 2046 616c 7365 2069 6620  lts to False if 
+0004a500: 6e6f 7420 7573 6564 0a20 2020 2020 2020  not used.       
+0004a510: 2068 656c 703d 2247 6574 2079 6f75 7220   help="Get your 
+0004a520: 7072 6573 656e 6365 2e20 220a 2020 2020  presence. ".    
+0004a530: 2020 2020 6622 4465 7461 696c 733a 3a20      f"Details:: 
+0004a540: 4765 7420 7072 6573 656e 6365 206f 6620  Get presence of 
+0004a550: 7b50 524f 475f 5749 5448 4f55 545f 4558  {PROG_WITHOUT_EX
+0004a560: 547d 2028 6974 7365 6c66 292c 2022 0a20  T} (itself), ". 
+0004a570: 2020 2020 2020 2022 6f72 206f 6620 6f6e         "or of on
+0004a580: 6520 6f72 206d 756c 7469 706c 6520 7573  e or multiple us
+0004a590: 6572 732e 2053 7065 6369 6679 2075 7365  ers. Specify use
+0004a5a0: 7228 7329 2077 6974 6820 7468 6520 220a  r(s) with the ".
+0004a5b0: 2020 2020 2020 2020 222d 2d75 7365 7220          "--user 
+0004a5c0: 6f70 7469 6f6e 2e20 4966 206e 6f20 7573  option. If no us
+0004a5d0: 6572 2069 7320 7370 6563 6966 6965 6420  er is specified 
+0004a5e0: 6765 7420 7468 6520 7072 6573 656e 6365  get the presence
+0004a5f0: 206f 6620 220a 2020 2020 2020 2020 2269   of ".        "i
+0004a600: 7473 656c 662e 2022 0a20 2020 2020 2020  tself. ".       
+0004a610: 2022 5365 6e64 2c20 6c69 7374 656e 2061   "Send, listen a
+0004a620: 6e64 2076 6572 6966 7920 6f70 6572 6174  nd verify operat
+0004a630: 696f 6e73 2061 7265 2061 6c6c 6f77 6564  ions are allowed
+0004a640: 2077 6865 6e20 220a 2020 2020 2020 2020   when ".        
+0004a650: 2267 6574 7469 6e67 2070 7265 7365 6e63  "getting presenc
+0004a660: 6528 7329 2e22 2c0a 2020 2020 290a 2020  e(s).",.    ).  
+0004a670: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+0004a680: 7428 0a20 2020 2020 2020 2022 2d2d 7570  t(.        "--up
+0004a690: 6c6f 6164 222c 0a20 2020 2020 2020 2072  load",.        r
+0004a6a0: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+0004a6b0: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
+0004a6c0: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
+0004a6d0: 6e61 7267 733d 222b 222c 0a20 2020 2020  nargs="+",.     
+0004a6e0: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
+0004a6f0: 2020 2020 206d 6574 6176 6172 3d22 4649       metavar="FI
+0004a700: 4c45 222c 0a20 2020 2020 2020 2068 656c  LE",.        hel
+0004a710: 703d 2255 706c 6f61 6420 6f6e 6520 6f72  p="Upload one or
+0004a720: 206d 756c 7469 706c 6520 6669 6c65 7320   multiple files 
+0004a730: 746f 2074 6865 2063 6f6e 7465 6e74 2072  to the content r
+0004a740: 6570 6f73 6974 6f72 792e 2022 0a20 2020  epository. ".   
+0004a750: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+0004a760: 220a 2020 2020 2020 2020 2254 6865 2066  ".        "The f
+0004a770: 696c 6573 2077 696c 6c20 6265 2067 6976  iles will be giv
+0004a780: 656e 2061 204d 6174 7269 7820 5552 4920  en a Matrix URI 
+0004a790: 616e 6420 220a 2020 2020 2020 2020 2273  and ".        "s
+0004a7a0: 746f 7265 6420 6f6e 2074 6865 2073 6572  tored on the ser
+0004a7b0: 7665 722e 202d 2d75 706c 6f61 6420 616c  ver. --upload al
+0004a7c0: 6c6f 7773 2074 6865 206f 7074 696f 6e61  lows the optiona
+0004a7d0: 6c20 6172 6775 6d65 6e74 2022 0a20 2020  l argument ".   
+0004a7e0: 2020 2020 2022 2d2d 706c 6169 6e20 746f       "--plain to
+0004a7f0: 2073 6b69 7020 656e 6372 7970 7469 6f6e   skip encryption
+0004a800: 2066 6f72 2075 706c 6f61 642e 2022 0a20   for upload. ". 
+0004a810: 2020 2020 2020 2022 5365 6520 7465 7374         "See test
+0004a820: 732f 7465 7374 2d75 706c 6f61 642e 7368  s/test-upload.sh
+0004a830: 2066 6f72 2061 6e20 6578 616d 706c 652e   for an example.
+0004a840: 222c 0a20 2020 2029 0a20 2020 2061 702e  ",.    ).    ap.
+0004a850: 6164 645f 6172 6775 6d65 6e74 280a 2020  add_argument(.  
+0004a860: 2020 2020 2020 222d 2d64 6f77 6e6c 6f61        "--downloa
+0004a870: 6422 2c0a 2020 2020 2020 2020 7265 7175  d",.        requ
+0004a880: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+0004a890: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+0004a8a0: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+0004a8b0: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+0004a8c0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+0004a8d0: 2020 6d65 7461 7661 723d 224d 5843 5f55    metavar="MXC_U
+0004a8e0: 5249 222c 0a20 2020 2020 2020 2068 656c  RI",.        hel
+0004a8f0: 703d 2244 6f77 6e6c 6f61 6420 6f6e 6520  p="Download one 
+0004a900: 6f72 206d 756c 7469 706c 6520 6669 6c65  or multiple file
+0004a910: 7320 6672 6f6d 2074 6865 2063 6f6e 7465  s from the conte
+0004a920: 6e74 2072 6570 6f73 6974 6f72 792e 2022  nt repository. "
+0004a930: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+0004a940: 733a 3a20 220a 2020 2020 2020 2020 2259  s:: ".        "Y
+0004a950: 6f75 206d 7573 7420 7072 6f76 6964 6520  ou must provide 
+0004a960: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+0004a970: 4d61 7472 6978 2055 5249 7320 284d 5843  Matrix URIs (MXC
+0004a980: 7329 2077 6869 6368 2061 7265 2022 0a20  s) which are ". 
+0004a990: 2020 2020 2020 2022 7374 7269 6e67 7320         "strings 
+0004a9a0: 6c69 6b65 2022 0a20 2020 2020 2020 2022  like ".        "
+0004a9b0: 7468 6973 2027 6d78 633a 2f2f 6578 616d  this 'mxc://exam
+0004a9c0: 706c 652e 636f 6d2f 536f 6d65 5374 7261  ple.com/SomeStra
+0004a9d0: 6e67 6555 7269 4b65 7927 2e20 4966 2066  ngeUriKey'. If f
+0004a9e0: 6f75 6e64 2074 6865 7920 7769 6c6c 2022  ound they will "
+0004a9f0: 0a20 2020 2020 2020 2022 6265 2064 6f77  .        "be dow
+0004aa00: 6e6c 6f61 6465 642c 2064 6563 7279 7074  nloaded, decrypt
+0004aa10: 6564 2c20 616e 6420 7374 6f72 6564 2069  ed, and stored i
+0004aa20: 6e20 6c6f 6361 6c20 6669 6c65 732e 2022  n local files. "
+0004aa30: 0a20 2020 2020 2020 2022 4966 2066 696c  .        "If fil
+0004aa40: 6520 6e61 6d65 7320 6172 6520 7370 6563  e names are spec
+0004aa50: 6966 6965 6420 7769 7468 202d 2d66 696c  ified with --fil
+0004aa60: 652d 6e61 6d65 2074 6865 2064 6f77 6e6c  e-name the downl
+0004aa70: 6f61 6473 2022 0a20 2020 2020 2020 2022  oads ".        "
+0004aa80: 7769 6c6c 2062 6520 7361 7665 6420 7769  will be saved wi
+0004aa90: 7468 2074 6865 7365 2066 696c 6520 6e61  th these file na
+0004aaa0: 6d65 732e 2049 6620 2d2d 6669 6c65 2d6e  mes. If --file-n
+0004aab0: 616d 6520 6973 206e 6f74 2022 0a20 2020  ame is not ".   
+0004aac0: 2020 2020 2022 7370 6563 6966 6965 6420       "specified 
+0004aad0: 7468 6520 6f72 6967 696e 616c 2066 696c  the original fil
+0004aae0: 6520 6e61 6d65 2066 726f 6d20 7468 6520  e name from the 
+0004aaf0: 7570 6c6f 6164 2077 696c 6c20 6265 2075  upload will be u
+0004ab00: 7365 642e 2022 0a20 2020 2020 2020 2022  sed. ".        "
+0004ab10: 4966 206e 6569 7468 6572 2073 7065 6369  If neither speci
+0004ab20: 6669 6564 206e 6f72 2061 7661 696c 6162  fied nor availab
+0004ab30: 6c65 206f 6e20 7365 7276 6572 2c20 7468  le on server, th
+0004ab40: 656e 2074 6865 2066 696c 6520 220a 2020  en the file ".  
+0004ab50: 2020 2020 2020 6622 6e61 6d65 206f 6620        f"name of 
+0004ab60: 6c61 7374 2072 6573 6f72 7420 276d 7863  last resort 'mxc
+0004ab70: 2d3c 6d78 632d 6964 3e27 2077 696c 6c20  -<mxc-id>' will 
+0004ab80: 6265 2075 7365 642e 2022 0a20 2020 2020  be used. ".     
+0004ab90: 2020 2066 2249 6620 6120 6669 6c65 206e     f"If a file n
+0004aba0: 616d 6520 696e 202d 2d66 696c 652d 6e61  ame in --file-na
+0004abb0: 6d65 2063 6f6e 7461 696e 7320 7468 6520  me contains the 
+0004abc0: 706c 6163 6568 6f6c 6465 7220 220a 2020  placeholder ".  
+0004abd0: 2020 2020 2020 6622 7b4d 5843 5f49 445f        f"{MXC_ID_
+0004abe0: 504c 4143 4548 4f4c 4445 527d 2c20 6974  PLACEHOLDER}, it
+0004abf0: 2077 696c 6c20 6265 2072 6570 6c61 6365   will be replace
+0004ac00: 6420 7769 7468 2074 6865 206d 7863 2d69  d with the mxc-i
+0004ac10: 642e 2022 0a20 2020 2020 2020 2022 4966  d. ".        "If
+0004ac20: 2061 2066 696c 6520 6e61 6d65 2069 7320   a file name is 
+0004ac30: 7370 6563 6966 6965 6420 6173 2065 6d70  specified as emp
+0004ac40: 7479 2073 7472 696e 6720 696e 202d 2d66  ty string in --f
+0004ac50: 696c 652d 6e61 6d65 2c20 7468 656e 2022  ile-name, then "
+0004ac60: 0a20 2020 2020 2020 2022 616c 736f 2074  .        "also t
+0004ac70: 6865 206e 616d 6520 276d 7863 2d3c 6d78  he name 'mxc-<mx
+0004ac80: 632d 6964 3e27 2077 696c 6c20 6265 2075  c-id>' will be u
+0004ac90: 7365 642e 2022 0a20 2020 2020 2020 2022  sed. ".        "
+0004aca0: 4279 2064 6566 6175 6c74 2c20 7468 6520  By default, the 
+0004acb0: 7570 6c6f 6164 2077 6173 2065 6e63 7279  upload was encry
+0004acc0: 7074 6564 2073 6f20 6120 6465 6372 7970  pted so a decryp
+0004acd0: 7469 6f6e 2064 6963 7469 6f6e 6172 7920  tion dictionary 
+0004ace0: 220a 2020 2020 2020 2020 226d 7573 7420  ".        "must 
+0004acf0: 6265 2070 726f 7669 6465 6420 746f 2064  be provided to d
+0004ad00: 6563 7279 7074 2074 6865 2064 6174 612e  ecrypt the data.
+0004ad10: 2053 7065 6369 6679 206f 6e65 206f 7220   Specify one or 
+0004ad20: 6d75 6c74 6970 6c65 2022 0a20 2020 2020  multiple ".     
+0004ad30: 2020 2022 6465 6372 7970 7469 6f6e 206b     "decryption k
+0004ad40: 6579 7320 220a 2020 2020 2020 2020 2277  eys ".        "w
+0004ad50: 6974 6820 2d2d 6b65 792d 6469 6374 2e20  ith --key-dict. 
+0004ad60: 4966 202d 2d6b 6579 2d64 6963 7420 6973  If --key-dict is
+0004ad70: 206e 6f74 2073 6574 2c20 6e6f 7420 6465   not set, not de
+0004ad80: 6372 7970 7469 6f6e 2069 7320 220a 2020  cryption is ".  
+0004ad90: 2020 2020 2020 2261 7474 656d 7074 6564        "attempted
+0004ada0: 3b20 616e 6420 7468 6520 6461 7461 206d  ; and the data m
+0004adb0: 6967 6874 2062 6520 7374 6f72 6564 2069  ight be stored i
+0004adc0: 6e20 656e 6372 7970 7465 6420 6661 7368  n encrypted fash
+0004add0: 696f 6e2c 2022 0a20 2020 2020 2020 2022  ion, ".        "
+0004ade0: 6f72 206d 6967 6874 2062 6520 706c 6169  or might be plai
+0004adf0: 6e2d 7465 7874 2069 6620 7468 6520 2d2d  n-text if the --
+0004ae00: 7570 6c6f 6164 2073 6b69 7070 6564 2065  upload skipped e
+0004ae10: 6e63 7279 7074 696f 6e20 7769 7468 2022  ncryption with "
+0004ae20: 0a20 2020 2020 2020 2022 2d2d 706c 6169  .        "--plai
+0004ae30: 6e2e 2022 0a20 2020 2020 2020 2022 5365  n. ".        "Se
+0004ae40: 6520 7465 7374 732f 7465 7374 2d75 706c  e tests/test-upl
+0004ae50: 6f61 642e 7368 2066 6f72 2061 6e20 6578  oad.sh for an ex
+0004ae60: 616d 706c 652e 222c 0a20 2020 2029 0a20  ample.",.    ). 
+0004ae70: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0004ae80: 6e74 280a 2020 2020 2020 2020 222d 2d64  nt(.        "--d
+0004ae90: 656c 6574 652d 6d78 6322 2c0a 2020 2020  elete-mxc",.    
+0004aea0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+0004aeb0: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+0004aec0: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+0004aed0: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+0004aee0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+0004aef0: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+0004af00: 723d 224d 5843 5f55 5249 222c 0a20 2020  r="MXC_URI",.   
+0004af10: 2020 2020 2068 656c 703d 2244 656c 6574       help="Delet
+0004af20: 6520 6f6e 6520 6f72 206d 756c 7469 706c  e one or multipl
+0004af30: 6520 6f62 6a65 6374 7320 6672 6f6d 2074  e objects from t
+0004af40: 6865 2063 6f6e 7465 6e74 2072 6570 6f73  he content repos
+0004af50: 6974 6f72 792e 2022 0a20 2020 2020 2020  itory. ".       
+0004af60: 2022 4465 7461 696c 733a 3a20 596f 7520   "Details:: You 
+0004af70: 6d75 7374 2070 726f 7669 6465 206f 6e65  must provide one
+0004af80: 206f 7220 6d75 6c74 6970 6c65 204d 6174   or multiple Mat
+0004af90: 7269 7820 5552 4973 2028 4d58 4329 2022  rix URIs (MXC) "
+0004afa0: 0a20 2020 2020 2020 2022 7768 6963 6820  .        "which 
+0004afb0: 6172 6520 7374 7269 6e67 7320 6c69 6b65  are strings like
+0004afc0: 2022 0a20 2020 2020 2020 2022 7468 6973   ".        "this
+0004afd0: 2027 6d78 633a 2f2f 6578 616d 706c 652e   'mxc://example.
+0004afe0: 636f 6d2f 536f 6d65 5374 7261 6e67 6555  com/SomeStrangeU
+0004aff0: 7269 4b65 7927 2e20 416c 7465 726e 6174  riKey'. Alternat
+0004b000: 6976 656c 792c 2079 6f75 2022 0a20 2020  ively, you ".   
+0004b010: 2020 2020 2022 6361 6e20 6a75 7374 2070       "can just p
+0004b020: 726f 7669 6465 2074 6865 204d 5843 2069  rovide the MXC i
+0004b030: 642c 2069 2e65 2e20 7468 6520 7061 7274  d, i.e. the part
+0004b040: 2061 6674 6572 2074 6865 206c 6173 7420   after the last 
+0004b050: 736c 6173 682e 2022 0a20 2020 2020 2020  slash. ".       
+0004b060: 2022 4966 2066 6f75 6e64 2074 6865 7920   "If found they 
+0004b070: 2869 2e65 2e20 7468 6520 6669 6c65 7320  (i.e. the files 
+0004b080: 7468 6579 2072 6570 7265 7365 6e74 2920  they represent) 
+0004b090: 7769 6c6c 2022 0a20 2020 2020 2020 2022  will ".        "
+0004b0a0: 6265 2064 656c 6574 6564 2066 726f 6d20  be deleted from 
+0004b0b0: 7468 6520 7365 7276 6572 2064 6174 6162  the server datab
+0004b0c0: 6173 652e 2049 6e20 6f72 6465 7220 746f  ase. In order to
+0004b0d0: 2064 656c 6574 6520 6f62 6a65 6374 7320   delete objects 
+0004b0e0: 220a 2020 2020 2020 2020 226f 6e65 206d  ".        "one m
+0004b0f0: 7573 7420 6861 7665 2073 6572 7665 7220  ust have server 
+0004b100: 6164 6d69 6e20 7065 726d 6973 7369 6f6e  admin permission
+0004b110: 732e 2048 6176 696e 6720 6f6e 6c79 2072  s. Having only r
+0004b120: 6f6f 6d20 6164 6d69 6e20 220a 2020 2020  oom admin ".    
+0004b130: 2020 2020 2270 6572 6d69 7373 696f 6e73      "permissions
+0004b140: 2069 7320 6e6f 7420 7375 6666 6963 6965   is not sufficie
+0004b150: 6e74 2061 6e64 2069 7420 7769 6c6c 2066  nt and it will f
+0004b160: 6169 6c2e 2022 0a20 2020 2020 2020 2022  ail. ".        "
+0004b170: 5265 6164 2022 0a20 2020 2020 2020 2022  Read ".        "
+0004b180: 6874 7470 733a 2f2f 6d61 7472 6978 2d6f  https://matrix-o
+0004b190: 7267 2e67 6974 6875 622e 696f 2f73 796e  rg.github.io/syn
+0004b1a0: 6170 7365 2f22 0a20 2020 2020 2020 2022  apse/".        "
+0004b1b0: 6c61 7465 7374 2f75 7361 6765 2f61 646d  latest/usage/adm
+0004b1c0: 696e 6973 7472 6174 696f 6e2f 6164 6d69  inistration/admi
+0004b1d0: 6e5f 6170 692f 2022 0a20 2020 2020 2020  n_api/ ".       
+0004b1e0: 2022 666f 7220 6c65 6172 6e69 6e67 2068   "for learning h
+0004b1f0: 6f77 2074 6f20 7365 7420 7365 7276 6572  ow to set server
+0004b200: 2061 646d 696e 2070 6572 6d69 7373 696f   admin permissio
+0004b210: 6e73 206f 6e20 7468 6520 220a 2020 2020  ns on the ".    
+0004b220: 2020 2020 2273 6572 7665 722e 2041 6c74      "server. Alt
+0004b230: 6572 6e61 7469 7665 6c79 2c20 616e 6420  ernatively, and 
+0004b240: 6f70 7469 6f6e 616c 6c79 2c20 6f6e 6520  optionally, one 
+0004b250: 6361 6e20 7370 6563 6966 7920 220a 2020  can specify ".  
+0004b260: 2020 2020 2020 2261 6e20 6163 6365 7373        "an access
+0004b270: 2074 6f6b 656e 2077 6869 6368 2068 6173   token which has
+0004b280: 2073 6572 7665 7220 6164 6d69 6e20 7065   server admin pe
+0004b290: 726d 6973 7369 6f6e 7320 7769 7468 2074  rmissions with t
+0004b2a0: 6865 2022 0a20 2020 2020 2020 2022 2d2d  he ".        "--
+0004b2b0: 6163 6365 7373 2d74 6f6b 656e 2061 7267  access-token arg
+0004b2c0: 756d 656e 742e 2022 0a20 2020 2020 2020  ument. ".       
+0004b2d0: 2022 5365 6520 7465 7374 732f 7465 7374   "See tests/test
+0004b2e0: 2d75 706c 6f61 642e 7368 2066 6f72 2061  -upload.sh for a
+0004b2f0: 6e20 6578 616d 706c 652e 222c 0a20 2020  n example.",.   
+0004b300: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+0004b310: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+0004b320: 222d 2d64 656c 6574 652d 6d78 632d 6265  "--delete-mxc-be
+0004b330: 666f 7265 222c 0a20 2020 2020 2020 2072  fore",.        r
+0004b340: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+0004b350: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
+0004b360: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
+0004b370: 6e61 7267 733d 222b 222c 0a20 2020 2020  nargs="+",.     
+0004b380: 2020 2074 7970 653d 7374 722c 0a20 2020     type=str,.   
+0004b390: 2020 2020 206d 6574 6176 6172 3d22 5449       metavar="TI
+0004b3a0: 4d45 5354 414d 5022 2c0a 2020 2020 2020  MESTAMP",.      
+0004b3b0: 2020 6865 6c70 3d22 4465 6c65 7465 206f    help="Delete o
+0004b3c0: 6c64 206f 626a 6563 7473 2066 726f 6d20  ld objects from 
+0004b3d0: 7468 6520 636f 6e74 656e 7420 7265 706f  the content repo
+0004b3e0: 7369 746f 7279 220a 2020 2020 2020 2020  sitory".        
+0004b3f0: 2244 6574 6169 6c73 3a3a 2044 656c 6574  "Details:: Delet
+0004b400: 6520 6669 6c65 7320 6672 6f6d 2074 6865  e files from the
+0004b410: 2063 6f6e 7465 6e74 2072 6570 6f73 6974   content reposit
+0004b420: 6f72 7920 220a 2020 2020 2020 2020 2274  ory ".        "t
+0004b430: 6861 7420 6172 6520 6f6c 6465 7220 7468  hat are older th
+0004b440: 616e 2061 2067 6976 656e 2074 696d 6573  an a given times
+0004b450: 7461 6d70 2e20 220a 2020 2020 2020 2020  tamp. ".        
+0004b460: 2249 7420 6973 2074 6865 2074 696d 6573  "It is the times
+0004b470: 7461 6d70 206f 6620 6c61 7374 2061 6363  tamp of last acc
+0004b480: 6573 732c 206e 6f74 2074 6865 2074 696d  ess, not the tim
+0004b490: 6573 7461 6d70 2077 6865 6e20 220a 2020  estamp when ".  
+0004b4a0: 2020 2020 2020 2274 6865 2066 696c 6520        "the file 
+0004b4b0: 7761 7320 6372 6561 7465 642e 2022 0a20  was created. ". 
+0004b4c0: 2020 2020 2020 2022 4164 6469 7469 6f6e         "Addition
+0004b4d0: 616c 6c79 2079 6f75 2063 616e 2073 7065  ally you can spe
+0004b4e0: 6369 6679 2061 2073 697a 6520 696e 2062  cify a size in b
+0004b4f0: 7974 6573 2074 6f20 696e 6469 6361 7465  ytes to indicate
+0004b500: 2022 0a20 2020 2020 2020 2022 7468 6174   ".        "that
+0004b510: 206f 6e6c 7920 6669 6c65 7320 6f6c 6465   only files olde
+0004b520: 7220 7468 616e 2074 696d 6573 7461 6d70  r than timestamp
+0004b530: 2061 6e64 206c 6172 6765 7220 7468 616e   and larger than
+0004b540: 2073 697a 6520 220a 2020 2020 2020 2020   size ".        
+0004b550: 2277 696c 6c20 6265 2064 656c 6574 6564  "will be deleted
+0004b560: 2e20 220a 2020 2020 2020 2020 2259 6f75  . ".        "You
+0004b570: 206d 7573 7420 7072 6f76 6964 6520 6120   must provide a 
+0004b580: 7469 6d65 7374 616d 7020 6f66 2074 6865  timestamp of the
+0004b590: 2066 6f6c 6c6f 7769 6e67 2066 6f72 6d61   following forma
+0004b5a0: 743a 2022 0a20 2020 2020 2020 2022 2744  t: ".        "'D
+0004b5b0: 442e 4d4d 2e59 5959 5920 4848 3a4d 4d3a  D.MM.YYYY HH:MM:
+0004b5c0: 5353 2720 6c69 6b65 2027 3230 2e30 312e  SS' like '20.01.
+0004b5d0: 3230 3232 2031 393a 3338 3a34 3227 2066  2022 19:38:42' f
+0004b5e0: 6f72 204a 616e 7561 7279 2032 302c 2022  or January 20, "
+0004b5f0: 0a20 2020 2020 2020 2022 3230 3232 2c20  .        "2022, 
+0004b600: 3770 6d20 3338 6d69 6e20 3432 7365 632e  7pm 38min 42sec.
+0004b610: 2022 0a20 2020 2020 2020 2022 4669 6c65   ".        "File
+0004b620: 7320 7468 6174 2061 7265 2073 7469 6c6c  s that are still
+0004b630: 2075 7365 6420 696e 2069 6d61 6765 2064   used in image d
+0004b640: 6174 6120 2865 2e67 2075 7365 7220 7072  ata (e.g user pr
+0004b650: 6f66 696c 652c 2022 0a20 2020 2020 2020  ofile, ".       
+0004b660: 2022 726f 6f6d 2061 7661 7461 7229 2077   "room avatar) w
+0004b670: 696c 6c20 6e6f 7420 6265 2064 656c 6574  ill not be delet
+0004b680: 6564 2066 726f 6d20 7468 6520 7365 7276  ed from the serv
+0004b690: 6572 2064 6174 6162 6173 652e 2022 0a20  er database. ". 
+0004b6a0: 2020 2020 2020 2022 496e 206f 7264 6572         "In order
+0004b6b0: 2074 6f20 6465 6c65 7465 206f 626a 6563   to delete objec
+0004b6c0: 7473 2022 0a20 2020 2020 2020 2022 6f6e  ts ".        "on
+0004b6d0: 6520 6d75 7374 2068 6176 6520 7365 7276  e must have serv
+0004b6e0: 6572 2061 646d 696e 2070 6572 6d69 7373  er admin permiss
+0004b6f0: 696f 6e73 2e20 4861 7669 6e67 206f 6e6c  ions. Having onl
+0004b700: 7920 726f 6f6d 2061 646d 696e 2022 0a20  y room admin ". 
+0004b710: 2020 2020 2020 2022 7065 726d 6973 7369         "permissi
+0004b720: 6f6e 7320 6973 206e 6f74 2073 7566 6669  ons is not suffi
+0004b730: 6369 656e 7420 616e 6420 6974 2077 696c  cient and it wil
+0004b740: 6c20 6661 696c 2e20 220a 2020 2020 2020  l fail. ".      
+0004b750: 2020 2252 6561 6420 220a 2020 2020 2020    "Read ".      
+0004b760: 2020 2268 7474 7073 3a2f 2f6d 6174 7269    "https://matri
+0004b770: 782d 6f72 672e 6769 7468 7562 2e69 6f2f  x-org.github.io/
+0004b780: 7379 6e61 7073 652f 220a 2020 2020 2020  synapse/".      
+0004b790: 2020 226c 6174 6573 742f 7573 6167 652f    "latest/usage/
+0004b7a0: 6164 6d69 6e69 7374 7261 7469 6f6e 2f61  administration/a
+0004b7b0: 646d 696e 5f61 7069 2f20 220a 2020 2020  dmin_api/ ".    
+0004b7c0: 2020 2020 2266 6f72 206c 6561 726e 696e      "for learnin
+0004b7d0: 6720 686f 7720 746f 2073 6574 2073 6572  g how to set ser
+0004b7e0: 7665 7220 6164 6d69 6e20 7065 726d 6973  ver admin permis
+0004b7f0: 7369 6f6e 7320 6f6e 2074 6865 2022 0a20  sions on the ". 
+0004b800: 2020 2020 2020 2022 7365 7276 6572 2e20         "server. 
+0004b810: 416c 7465 726e 6174 6976 656c 792c 2061  Alternatively, a
+0004b820: 6e64 206f 7074 696f 6e61 6c6c 792c 206f  nd optionally, o
+0004b830: 6e65 2063 616e 2073 7065 6369 6679 2022  ne can specify "
+0004b840: 0a20 2020 2020 2020 2022 616e 2061 6363  .        "an acc
+0004b850: 6573 7320 746f 6b65 6e20 7768 6963 6820  ess token which 
+0004b860: 6861 7320 7365 7276 6572 2061 646d 696e  has server admin
+0004b870: 2070 6572 6d69 7373 696f 6e73 2077 6974   permissions wit
+0004b880: 6820 7468 6520 220a 2020 2020 2020 2020  h the ".        
+0004b890: 222d 2d61 6363 6573 732d 746f 6b65 6e20  "--access-token 
+0004b8a0: 6172 6775 6d65 6e74 2e20 220a 2020 2020  argument. ".    
+0004b8b0: 2020 2020 2253 6565 2074 6573 7473 2f74      "See tests/t
+0004b8c0: 6573 742d 7570 6c6f 6164 2e73 6820 666f  est-upload.sh fo
+0004b8d0: 7220 616e 2065 7861 6d70 6c65 2e22 2c0a  r an example.",.
+0004b8e0: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+0004b8f0: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+0004b900: 2020 2023 206e 6f20 7369 6e67 6c65 2063     # no single c
+0004b910: 6861 7220 666c 6167 0a20 2020 2020 2020  har flag.       
+0004b920: 2022 2d2d 6a6f 696e 6564 2d72 6f6f 6d73   "--joined-rooms
+0004b930: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+0004b940: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+0004b950: 2020 2061 6374 696f 6e3d 2273 746f 7265     action="store
+0004b960: 5f74 7275 6522 2c0a 2020 2020 2020 2020  _true",.        
+0004b970: 6865 6c70 3d22 5072 696e 7420 7468 6520  help="Print the 
+0004b980: 6c69 7374 206f 6620 6a6f 696e 6564 2072  list of joined r
+0004b990: 6f6f 6d73 2e20 220a 2020 2020 2020 2020  ooms. ".        
+0004b9a0: 2244 6574 6169 6c73 3a3a 2041 6c6c 2072  "Details:: All r
+0004b9b0: 6f6f 6d73 2074 6861 7420 796f 7520 6172  ooms that you ar
+0004b9c0: 6520 6120 220a 2020 2020 2020 2020 226d  e a ".        "m
+0004b9d0: 656d 6265 7220 6f66 2077 696c 6c20 6265  ember of will be
+0004b9e0: 2070 7269 6e74 6564 2c20 6f6e 6520 726f   printed, one ro
+0004b9f0: 6f6d 2070 6572 206c 696e 652e 222c 0a20  om per line.",. 
+0004ba00: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+0004ba10: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+0004ba20: 2020 2320 6e6f 2073 696e 676c 6520 6368    # no single ch
+0004ba30: 6172 2066 6c61 670a 2020 2020 2020 2020  ar flag.        
+0004ba40: 222d 2d6a 6f69 6e65 642d 6d65 6d62 6572  "--joined-member
+0004ba50: 7322 2c0a 2020 2020 2020 2020 7265 7175  s",.        requ
+0004ba60: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+0004ba70: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+0004ba80: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+0004ba90: 6773 3d22 2b22 2c0a 2020 2020 2020 2020  gs="+",.        
+0004baa0: 7479 7065 3d73 7472 2c0a 2020 2020 2020  type=str,.      
+0004bab0: 2020 6d65 7461 7661 723d 2252 4f4f 4d22    metavar="ROOM"
+0004bac0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+0004bad0: 5072 696e 7420 7468 6520 6c69 7374 206f  Print the list o
+0004bae0: 6620 6a6f 696e 6564 206d 656d 6265 7273  f joined members
+0004baf0: 2066 6f72 206f 6e65 206f 7220 6d75 6c74   for one or mult
+0004bb00: 6970 6c65 2072 6f6f 6d73 2e20 220a 2020  iple rooms. ".  
+0004bb10: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+0004bb20: 2049 6620 796f 7520 7761 6e74 2074 6f20   If you want to 
+0004bb30: 7072 696e 7420 7468 6520 6a6f 696e 6564  print the joined
+0004bb40: 206d 656d 6265 7273 206f 6620 616c 6c20   members of all 
+0004bb50: 726f 6f6d 7320 7468 6174 2022 0a20 2020  rooms that ".   
+0004bb60: 2020 2020 2022 796f 7520 6172 6520 6d65       "you are me
+0004bb70: 6d62 6572 206f 662c 2074 6865 6e20 7573  mber of, then us
+0004bb80: 6520 7468 6520 7370 6563 6961 6c20 6368  e the special ch
+0004bb90: 6172 6163 7465 7220 272a 272e 222c 0a20  aracter '*'.",. 
+0004bba0: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+0004bbb0: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+0004bbc0: 2020 222d 2d6d 7863 2d74 6f2d 6874 7470    "--mxc-to-http
+0004bbd0: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+0004bbe0: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+0004bbf0: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
+0004bc00: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
+0004bc10: 733d 222b 222c 0a20 2020 2020 2020 2074  s="+",.        t
+0004bc20: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+0004bc30: 206d 6574 6176 6172 3d22 4d58 435f 5552   metavar="MXC_UR
+0004bc40: 4922 2c0a 2020 2020 2020 2020 6865 6c70  I",.        help
+0004bc50: 3d22 436f 6e76 6572 7420 4d58 4320 5552  ="Convert MXC UR
+0004bc60: 4973 2074 6f20 4854 5450 2055 524c 732e  Is to HTTP URLs.
+0004bc70: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+0004bc80: 696c 733a 3a20 436f 6e76 6572 7420 6f6e  ils:: Convert on
+0004bc90: 6520 6f72 206d 6f72 6520 6d61 7472 6978  e or more matrix
+0004bca0: 2063 6f6e 7465 6e74 2055 5249 7320 746f   content URIs to
+0004bcb0: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
+0004bcc0: 636f 7272 6573 706f 6e64 696e 6720 4854  corresponding HT
+0004bcd0: 5450 2055 524c 732e 2054 6865 204d 5843  TP URLs. The MXC
+0004bce0: 2055 5249 7320 220a 2020 2020 2020 2020   URIs ".        
+0004bcf0: 2274 6f20 7072 6f76 6964 6520 6c6f 6f6b  "to provide look
+0004bd00: 2073 6f6d 6574 6869 6e67 206c 696b 6520   something like 
+0004bd10: 7468 6973 2022 0a20 2020 2020 2020 2022  this ".        "
+0004bd20: 276d 7863 3a2f 2f65 7861 6d70 6c65 2e63  'mxc://example.c
+0004bd30: 6f6d 2f53 6f6d 6553 7472 616e 6765 5572  om/SomeStrangeUr
+0004bd40: 694b 6579 272e 2022 0a20 2020 2020 2020  iKey'. ".       
+0004bd50: 2022 5365 6520 7465 7374 732f 7465 7374   "See tests/test
+0004bd60: 2d75 706c 6f61 642e 7368 2066 6f72 2061  -upload.sh for a
+0004bd70: 6e20 6578 616d 706c 652e 222c 0a20 2020  n example.",.   
+0004bd80: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+0004bd90: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+0004bda0: 2320 6e6f 2073 696e 676c 6520 6368 6172  # no single char
+0004bdb0: 2066 6c61 670a 2020 2020 2020 2020 222d   flag.        "-
+0004bdc0: 2d64 6576 6963 6573 222c 0a20 2020 2020  -devices",.     
+0004bdd0: 2020 2022 2d2d 6765 742d 6465 7669 6365     "--get-device
+0004bde0: 7322 2c20 2023 2061 6c69 6173 2c20 6361  s",  # alias, ca
+0004bdf0: 7573 6520 2d2d 6465 7669 6365 6420 6973  use --deviced is
+0004be00: 2076 6572 7920 7369 6d69 6c61 7220 746f   very similar to
+0004be10: 202d 2d64 6576 6963 650a 2020 2020 2020   --device.      
+0004be20: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+0004be30: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+0004be40: 3d22 7374 6f72 655f 7472 7565 222c 0a20  ="store_true",. 
+0004be50: 2020 2020 2020 2068 656c 703d 2250 7269         help="Pri
+0004be60: 6e74 2074 6865 206c 6973 7420 6f66 2064  nt the list of d
+0004be70: 6576 6963 6573 2e20 220a 2020 2020 2020  evices. ".      
+0004be80: 2020 2244 6574 6169 6c73 3a3a 2041 6c6c    "Details:: All
+0004be90: 2064 6576 6963 6520 6f66 2074 6869 7320   device of this 
+0004bea0: 220a 2020 2020 2020 2020 2261 6363 6f75  ".        "accou
+0004beb0: 6e74 2077 696c 6c20 6265 2070 7269 6e74  nt will be print
+0004bec0: 6564 2c20 6f6e 6520 6465 7669 6365 2070  ed, one device p
+0004bed0: 6572 206c 696e 652e 222c 0a20 2020 2029  er line.",.    )
+0004bee0: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+0004bef0: 6d65 6e74 280a 2020 2020 2020 2020 2320  ment(.        # 
+0004bf00: 6e6f 2073 696e 676c 6520 6368 6172 2066  no single char f
+0004bf10: 6c61 670a 2020 2020 2020 2020 222d 2d64  lag.        "--d
+0004bf20: 6973 636f 7665 7279 2d69 6e66 6f22 2c0a  iscovery-info",.
+0004bf30: 2020 2020 2020 2020 7265 7175 6972 6564          required
+0004bf40: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0004bf50: 6163 7469 6f6e 3d22 7374 6f72 655f 7472  action="store_tr
+0004bf60: 7565 222c 0a20 2020 2020 2020 2068 656c  ue",.        hel
+0004bf70: 703d 2250 7269 6e74 2064 6973 636f 7665  p="Print discove
+0004bf80: 7279 2069 6e66 6f72 6d61 7469 6f6e 2061  ry information a
+0004bf90: 626f 7574 2063 7572 7265 6e74 2068 6f6d  bout current hom
+0004bfa0: 6573 6572 7665 722e 2022 0a20 2020 2020  eserver. ".     
+0004bfb0: 2020 2022 4465 7461 696c 733a 3a20 4e6f     "Details:: No
+0004bfc0: 7465 2074 6861 7420 6e6f 7420 616c 6c20  te that not all 
+0004bfd0: 686f 6d65 7365 7276 6572 7320 7375 7070  homeservers supp
+0004bfe0: 6f72 7420 6469 7363 6f76 6572 7920 616e  ort discovery an
+0004bff0: 6420 616e 2022 0a20 2020 2020 2020 2022  d an ".        "
+0004c000: 6572 726f 7220 6d69 6768 7420 6265 2072  error might be r
+0004c010: 6570 6f72 7465 642e 222c 0a20 2020 2029  eported.",.    )
+0004c020: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+0004c030: 6d65 6e74 280a 2020 2020 2020 2020 2320  ment(.        # 
+0004c040: 6e6f 2073 696e 676c 6520 6368 6172 2066  no single char f
+0004c050: 6c61 670a 2020 2020 2020 2020 222d 2d6c  lag.        "--l
+0004c060: 6f67 696e 2d69 6e66 6f22 2c0a 2020 2020  ogin-info",.    
+0004c070: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+0004c080: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+0004c090: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
+0004c0a0: 0a20 2020 2020 2020 2068 656c 703d 2250  .        help="P
+0004c0b0: 7269 6e74 206c 6f67 696e 206d 6574 686f  rint login metho
+0004c0c0: 6473 2073 7570 706f 7274 6564 2062 7920  ds supported by 
+0004c0d0: 7468 6520 686f 6d65 7365 7276 6572 2e20  the homeserver. 
+0004c0e0: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+0004c0f0: 6c73 3a3a 2049 7420 7072 696e 7473 206f  ls:: It prints o
+0004c100: 6e65 206c 6f67 696e 206d 6574 686f 6420  ne login method 
+0004c110: 7065 7220 6c69 6e65 2e22 2c0a 2020 2020  per line.",.    
+0004c120: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+0004c130: 756d 656e 7428 0a20 2020 2020 2020 2023  ument(.        #
+0004c140: 206e 6f20 7369 6e67 6c65 2063 6861 7220   no single char 
+0004c150: 666c 6167 0a20 2020 2020 2020 2022 2d2d  flag.        "--
+0004c160: 636f 6e74 656e 742d 7265 706f 7369 746f  content-reposito
+0004c170: 7279 2d63 6f6e 6669 6722 2c0a 2020 2020  ry-config",.    
+0004c180: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+0004c190: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+0004c1a0: 6f6e 3d22 7374 6f72 655f 7472 7565 222c  on="store_true",
+0004c1b0: 0a20 2020 2020 2020 2068 656c 703d 2250  .        help="P
+0004c1c0: 7269 6e74 2074 6865 2063 6f6e 7465 6e74  rint the content
+0004c1d0: 2072 6570 6f73 6974 6f72 7920 636f 6e66   repository conf
+0004c1e0: 6967 7572 6174 696f 6e2e 2022 0a20 2020  iguration. ".   
+0004c1f0: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+0004c200: 5468 6973 2063 7572 7265 6e74 6c79 206a  This currently j
+0004c210: 7573 7420 7072 696e 7473 2022 0a20 2020  ust prints ".   
+0004c220: 2020 2020 2022 7468 6520 7570 6c6f 6164       "the upload
+0004c230: 2073 697a 6520 6c69 6d69 7420 696e 2062   size limit in b
+0004c240: 7974 6573 2e22 2c0a 2020 2020 290a 2020  ytes.",.    ).  
+0004c250: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+0004c260: 7428 0a20 2020 2020 2020 2023 206e 6f20  t(.        # no 
+0004c270: 7369 6e67 6c65 2063 6861 7220 666c 6167  single char flag
+0004c280: 0a20 2020 2020 2020 2022 2d2d 7265 7374  .        "--rest
+0004c290: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+0004c2a0: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+0004c2b0: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
+0004c2c0: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
+0004c2d0: 733d 222b 222c 0a20 2020 2020 2020 2074  s="+",.        t
+0004c2e0: 7970 653d 7374 722c 0a20 2020 2020 2020  ype=str,.       
+0004c2f0: 206d 6574 6176 6172 3d22 5245 5354 5f4d   metavar="REST_M
+0004c300: 4554 484f 4420 4441 5441 2055 524c 222c  ETHOD DATA URL",
+0004c310: 0a20 2020 2020 2020 2068 656c 703d 2255  .        help="U
+0004c320: 7365 2074 6865 204d 6174 7269 7820 436c  se the Matrix Cl
+0004c330: 6965 6e74 2052 4553 5420 4150 492e 2022  ient REST API. "
+0004c340: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+0004c350: 733a 3a20 4d61 7472 6978 2068 6173 2073  s:: Matrix has s
+0004c360: 6576 6572 616c 2065 7874 656e 7369 7665  everal extensive
+0004c370: 2022 0a20 2020 2020 2020 2022 5245 5354   ".        "REST
+0004c380: 2041 5049 732e 2057 6974 6820 7468 6520   APIs. With the 
+0004c390: 2d2d 7265 7374 2061 7267 756d 656e 7420  --rest argument 
+0004c3a0: 796f 7520 6361 6e20 696e 766f 6b65 2061  you can invoke a
+0004c3b0: 204d 6174 7269 7820 5245 5354 2022 0a20   Matrix REST ". 
+0004c3c0: 2020 2020 2020 2022 4150 4920 6361 6c6c         "API call
+0004c3d0: 2e20 5468 6973 2061 6c6c 6f77 7320 7468  . This allows th
+0004c3e0: 6520 7573 6572 2074 6f20 646f 2070 7265  e user to do pre
+0004c3f0: 7474 7920 6d75 6368 2061 6e79 7468 696e  tty much anythin
+0004c400: 672c 2061 7420 7468 6520 220a 2020 2020  g, at the ".    
+0004c410: 2020 2020 2270 7269 6365 206f 6620 6e6f      "price of no
+0004c420: 7420 6265 696e 6720 7665 7279 2063 6f6e  t being very con
+0004c430: 7665 6e69 656e 742e 2054 6865 2041 5049  venient. The API
+0004c440: 7320 6172 6520 6465 7363 7269 6265 6420  s are described 
+0004c450: 696e 2022 0a20 2020 2020 2020 2022 6874  in ".        "ht
+0004c460: 7470 733a 2f2f 6d61 7472 6978 2e6f 7267  tps://matrix.org
+0004c470: 2f64 6f63 732f 6170 692f 2c20 220a 2020  /docs/api/, ".  
+0004c480: 2020 2020 2020 2268 7474 7073 3a2f 2f73        "https://s
+0004c490: 7065 632e 6d61 7472 6978 2e6f 7267 2f6c  pec.matrix.org/l
+0004c4a0: 6174 6573 742f 636c 6965 6e74 2d73 6572  atest/client-ser
+0004c4b0: 7665 722d 6170 692f 2c20 220a 2020 2020  ver-api/, ".    
+0004c4c0: 2020 2020 2268 7474 7073 3a2f 2f6d 6174      "https://mat
+0004c4d0: 7269 782d 6f72 672e 6769 7468 7562 2e69  rix-org.github.i
+0004c4e0: 6f2f 7379 6e61 7073 652f 6c61 7465 7374  o/synapse/latest
+0004c4f0: 2f75 7361 6765 2f61 646d 696e 6973 7472  /usage/administr
+0004c500: 6174 696f 6e2f 220a 2020 2020 2020 2020  ation/".        
+0004c510: 2261 646d 696e 5f61 7069 2f2c 2065 7463  "admin_api/, etc
+0004c520: 2e20 220a 2020 2020 2020 2020 2245 6163  . ".        "Eac
+0004c530: 6820 5245 5354 2063 616c 6c20 7265 7175  h REST call requ
+0004c540: 6972 6573 2065 7861 6374 6c79 2033 2061  ires exactly 3 a
+0004c550: 7267 756d 656e 7473 2e20 220a 2020 2020  rguments. ".    
+0004c560: 2020 2020 2253 6f2c 2074 6865 2074 6f74      "So, the tot
+0004c570: 616c 206e 756d 6265 7220 6f66 2061 7267  al number of arg
+0004c580: 756d 656e 7473 2075 7365 6420 7769 7468  uments used with
+0004c590: 202d 2d72 6573 7420 6d75 7374 2062 6520   --rest must be 
+0004c5a0: 6120 220a 2020 2020 2020 2020 226d 756c  a ".        "mul
+0004c5b0: 7469 706c 6520 6f66 2033 2e20 5468 6520  tiple of 3. The 
+0004c5c0: 6172 6775 6d65 6e74 2074 7269 706c 6573  argument triples
+0004c5d0: 2061 7265 3a20 220a 2020 2020 2020 2020   are: ".        
+0004c5e0: 2228 6129 2074 6865 206d 6574 686f 642c  "(a) the method,
+0004c5f0: 2061 2073 7472 696e 6720 6f66 2047 4554   a string of GET
+0004c600: 2c20 504f 5354 2c20 5055 542c 2044 454c  , POST, PUT, DEL
+0004c610: 4554 452c 206f 7220 4f50 5449 4f4e 532e  ETE, or OPTIONS.
+0004c620: 2022 0a20 2020 2020 2020 2022 2862 2920   ".        "(b) 
+0004c630: 6120 7374 7269 6e67 2063 6f6e 7461 696e  a string contain
+0004c640: 696e 6720 7468 6520 6461 7461 2028 6966  ing the data (if
+0004c650: 2061 6e79 2920 696e 204a 534f 4e20 666f   any) in JSON fo
+0004c660: 726d 6174 2e20 220a 2020 2020 2020 2020  rmat. ".        
+0004c670: 2228 6329 2061 2073 7472 696e 6720 636f  "(c) a string co
+0004c680: 6e74 6169 6e69 6e67 2074 6865 2055 524c  ntaining the URL
+0004c690: 2e20 416c 6c20 7374 7269 6e67 7320 6d75  . All strings mu
+0004c6a0: 7374 2062 6520 5554 462d 382e 2022 0a20  st be UTF-8. ". 
+0004c6b0: 2020 2020 2020 2022 5468 6572 6520 6172         "There ar
+0004c6c0: 6520 6120 6665 7720 706c 6163 6568 6f6c  e a few placehol
+0004c6d0: 6465 7273 2e20 5468 6579 2061 7265 3a20  ders. They are: 
+0004c6e0: 220a 2020 2020 2020 2020 225f 5f68 6f6d  ".        "__hom
+0004c6f0: 6573 6572 7665 725f 5f20 286c 696b 6520  eserver__ (like 
+0004c700: 6874 7470 733a 2f2f 6d61 7472 6978 2e65  https://matrix.e
+0004c710: 7861 6d70 6c65 2e6f 7267 292c 2022 0a20  xample.org), ". 
+0004c720: 2020 2020 2020 2022 5f5f 686f 7374 6e61         "__hostna
+0004c730: 6d65 5f5f 2028 6c69 6b65 206d 6174 7269  me__ (like matri
+0004c740: 782e 6578 616d 706c 652e 6f72 6729 2c20  x.example.org), 
+0004c750: 220a 2020 2020 2020 2020 225f 5f61 6363  ".        "__acc
+0004c760: 6573 735f 746f 6b65 6e5f 5f2c 205f 5f75  ess_token__, __u
+0004c770: 7365 725f 6964 5f5f 2028 6c69 6b65 2040  ser_id__ (like @
+0004c780: 6d63 3a6d 6174 7269 782e 6578 616d 706c  mc:matrix.exampl
+0004c790: 652e 636f 6d29 2c20 220a 2020 2020 2020  e.com), ".      
+0004c7a0: 2020 225f 5f64 6576 6963 655f 6964 5f5f    "__device_id__
+0004c7b0: 2c20 616e 6420 5f5f 726f 6f6d 5f69 645f  , and __room_id_
+0004c7c0: 5f2e 2049 6620 6120 706c 6163 6568 6f6c  _. If a placehol
+0004c7d0: 6465 7220 6973 2066 6f75 6e64 2069 7420  der is found it 
+0004c7e0: 6973 2022 0a20 2020 2020 2020 2022 7265  is ".        "re
+0004c7f0: 706c 6163 6564 2077 6974 6820 7468 6520  placed with the 
+0004c800: 7661 6c75 6520 6672 6f6d 2074 6865 206c  value from the l
+0004c810: 6f63 616c 2063 7265 6465 6e74 6961 6c73  ocal credentials
+0004c820: 2066 696c 652e 2022 0a20 2020 2020 2020   file. ".       
+0004c830: 2022 416e 2065 7861 6d70 6c65 2077 6f75   "An example wou
+0004c840: 6c64 2062 653a 2022 0a20 2020 2020 2020  ld be: ".       
+0004c850: 2022 2d2d 7265 7374 2027 4745 5427 2027   "--rest 'GET' '
+0004c860: 2720 275f 5f68 6f6d 6573 6572 7665 725f  ' '__homeserver_
+0004c870: 5f2f 5f6d 6174 7269 782f 636c 6965 6e74  _/_matrix/client
+0004c880: 2f76 6572 7369 6f6e 7327 2e20 220a 2020  /versions'. ".  
+0004c890: 2020 2020 2020 2249 6620 7468 6572 6520        "If there 
+0004c8a0: 6973 206e 6f20 6461 7461 2c20 692e 652e  is no data, i.e.
+0004c8b0: 2064 6174 6120 2862 2920 6973 2065 6d70   data (b) is emp
+0004c8c0: 7479 2c20 7468 656e 2075 7365 2027 2720  ty, then use '' 
+0004c8d0: 666f 7220 6974 2e20 220a 2020 2020 2020  for it. ".      
+0004c8e0: 2020 224f 7074 696f 6e61 6c6c 792c 202d    "Optionally, -
+0004c8f0: 2d61 6363 6573 732d 746f 6b65 6e20 6361  -access-token ca
+0004c900: 6e20 6265 2075 7365 6420 746f 206f 7665  n be used to ove
+0004c910: 7277 7269 7465 2074 6865 2022 0a20 2020  rwrite the ".   
+0004c920: 2020 2020 2022 6163 6365 7373 2074 6f6b       "access tok
+0004c930: 656e 2066 726f 6d20 6372 6564 656e 7469  en from credenti
+0004c940: 616c 7320 2869 6620 6e65 6564 6564 292e  als (if needed).
+0004c950: 2022 0a20 2020 2020 2020 2022 5365 6520   ".        "See 
+0004c960: 7465 7374 732f 7465 7374 2d72 6573 742e  tests/test-rest.
+0004c970: 7368 2066 6f72 2061 6e20 6578 616d 706c  sh for an exampl
+0004c980: 652e 222c 0a20 2020 2029 0a20 2020 2061  e.",.    ).    a
+0004c990: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+0004c9a0: 2020 2020 2020 2020 222d 2d73 6574 2d61          "--set-a
+0004c9b0: 7661 7461 7222 2c0a 2020 2020 2020 2020  vatar",.        
+0004c9c0: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+0004c9d0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+0004c9e0: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+0004c9f0: 723d 2241 5641 5441 525f 4d58 435f 5552  r="AVATAR_MXC_UR
+0004ca00: 4922 2c0a 2020 2020 2020 2020 2320 6465  I",.        # de
+0004ca10: 6661 756c 7473 2074 6f20 4e6f 6e65 2069  faults to None i
+0004ca20: 6620 6e6f 7420 7573 6564 2c20 6973 2073  f not used, is s
+0004ca30: 7472 2069 6620 7573 6564 0a20 2020 2020  tr if used.     
+0004ca40: 2020 2068 656c 703d 2253 6574 2079 6f75     help="Set you
+0004ca50: 7220 6176 6174 6172 2e20 220a 2020 2020  r avatar. ".    
+0004ca60: 2020 2020 6622 4465 7461 696c 733a 3a20      f"Details:: 
+0004ca70: 5365 7420 7468 6520 6176 6174 6172 204d  Set the avatar M
+0004ca80: 5843 2072 6573 6f75 7263 6520 7573 6564  XC resource used
+0004ca90: 2062 7920 7b50 524f 475f 5749 5448 4f55   by {PROG_WITHOU
+0004caa0: 545f 4558 547d 2e20 220a 2020 2020 2020  T_EXT}. ".      
+0004cab0: 2020 2250 726f 7669 6465 206f 6e65 204d    "Provide one M
+0004cac0: 5843 2055 5249 2074 6861 7420 6c6f 6f6b  XC URI that look
+0004cad0: 7320 6c69 6b65 2074 6869 7320 220a 2020  s like this ".  
+0004cae0: 2020 2020 2020 2227 6d78 633a 2f2f 6578        "'mxc://ex
+0004caf0: 616d 706c 652e 636f 6d2f 536f 6d65 5374  ample.com/SomeSt
+0004cb00: 7261 6e67 6555 7269 4b65 7927 2e22 2c0a  rangeUriKey'.",.
+0004cb10: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+0004cb20: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+0004cb30: 2020 2022 2d2d 6765 742d 6176 6174 6172     "--get-avatar
+0004cb40: 222c 0a20 2020 2020 2020 2072 6571 7569  ",.        requi
+0004cb50: 7265 643d 4661 6c73 652c 0a20 2020 2020  red=False,.     
+0004cb60: 2020 2061 6374 696f 6e3d 2265 7874 656e     action="exten
+0004cb70: 6422 2c0a 2020 2020 2020 2020 6e61 7267  d",.        narg
+0004cb80: 733d 222a 222c 2020 2320 4e6f 6e65 2069  s="*",  # None i
+0004cb90: 6620 6e6f 7420 7573 6564 2c20 5b5d 2069  f not used, [] i
+0004cba0: 7320 7573 6564 2077 6974 686f 7574 2065  s used without e
+0004cbb0: 7874 7261 2061 7267 730a 2020 2020 2020  xtra args.      
+0004cbc0: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
+0004cbd0: 2020 2020 6d65 7461 7661 723d 2255 5345      metavar="USE
+0004cbe0: 5222 2c0a 2020 2020 2020 2020 6865 6c70  R",.        help
+0004cbf0: 3d22 4765 7420 616e 2061 7661 7461 722e  ="Get an avatar.
+0004cc00: 2022 0a20 2020 2020 2020 2066 2244 6574   ".        f"Det
+0004cc10: 6169 6c73 3a3a 2047 6574 2074 6865 2061  ails:: Get the a
+0004cc20: 7661 7461 7220 4d58 4320 7265 736f 7572  vatar MXC resour
+0004cc30: 6365 2075 7365 6420 6279 207b 5052 4f47  ce used by {PROG
+0004cc40: 5f57 4954 484f 5554 5f45 5854 7d2c 2022  _WITHOUT_EXT}, "
+0004cc50: 0a20 2020 2020 2020 2022 6f72 206f 6e65  .        "or one
+0004cc60: 206f 7220 6d75 6c74 6970 6c65 206f 7468   or multiple oth
+0004cc70: 6572 2075 7365 7273 2e20 5370 6563 6966  er users. Specif
+0004cc80: 7920 7a65 726f 206f 7220 6d6f 7265 2075  y zero or more u
+0004cc90: 7365 7220 6964 732e 2022 0a20 2020 2020  ser ids. ".     
+0004cca0: 2020 2066 2249 6620 6e6f 2075 7365 7220     f"If no user 
+0004ccb0: 6964 2069 7320 7370 6563 6966 6965 642c  id is specified,
+0004ccc0: 2074 6865 2061 7661 7461 7220 6f66 207b   the avatar of {
+0004ccd0: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+0004cce0: 7d20 7769 6c6c 2022 0a20 2020 2020 2020  } will ".       
+0004ccf0: 2022 6265 2066 6574 6368 6564 2e20 4966   "be fetched. If
+0004cd00: 206f 6e65 206f 7220 6d6f 7265 2075 7365   one or more use
+0004cd10: 7220 6964 7320 6172 6520 6769 7665 6e2c  r ids are given,
+0004cd20: 2074 6865 2061 7661 7461 7273 206f 6620   the avatars of 
+0004cd30: 220a 2020 2020 2020 2020 2274 6865 7365  ".        "these
+0004cd40: 2075 7365 7273 2077 696c 6c20 6265 2066   users will be f
+0004cd50: 6574 6368 6564 2e20 4173 2072 6573 706f  etched. As respo
+0004cd60: 6e73 6520 626f 7468 204d 5843 2055 5249  nse both MXC URI
+0004cd70: 2061 7320 7765 6c6c 2061 7320 5552 4c20   as well as URL 
+0004cd80: 220a 2020 2020 2020 2020 2277 696c 6c20  ".        "will 
+0004cd90: 6265 2070 7269 6e74 6564 2e22 2c0a 2020  be printed.",.  
+0004cda0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+0004cdb0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+0004cdc0: 2022 2d2d 6765 742d 7072 6f66 696c 6522   "--get-profile"
+0004cdd0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+0004cde0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+0004cdf0: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+0004ce00: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+0004ce10: 3d22 2a22 2c20 2023 204e 6f6e 6520 6966  ="*",  # None if
+0004ce20: 206e 6f74 2075 7365 642c 205b 5d20 6973   not used, [] is
+0004ce30: 2075 7365 6420 7769 7468 6f75 7420 6578   used without ex
+0004ce40: 7472 6120 6172 6773 0a20 2020 2020 2020  tra args.       
+0004ce50: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+0004ce60: 2020 206d 6574 6176 6172 3d22 5553 4552     metavar="USER
+0004ce70: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+0004ce80: 2247 6574 2061 2075 7365 7220 7072 6f66  "Get a user prof
+0004ce90: 696c 652e 2022 0a20 2020 2020 2020 2066  ile. ".        f
+0004cea0: 2244 6574 6169 6c73 3a3a 2047 6574 2074  "Details:: Get t
+0004ceb0: 6865 2075 7365 7220 7072 6f66 696c 6520  he user profile 
+0004cec0: 7573 6564 2062 7920 7b50 524f 475f 5749  used by {PROG_WI
+0004ced0: 5448 4f55 545f 4558 547d 2c20 6f72 2022  THOUT_EXT}, or "
+0004cee0: 0a20 2020 2020 2020 2022 6f6e 6520 6f72  .        "one or
+0004cef0: 206d 756c 7469 706c 6520 6f74 6865 7220   multiple other 
+0004cf00: 7573 6572 732e 2053 7065 6369 6679 207a  users. Specify z
+0004cf10: 6572 6f20 6f72 206d 6f72 6520 7573 6572  ero or more user
+0004cf20: 2069 6473 2e20 220a 2020 2020 2020 2020   ids. ".        
+0004cf30: 6622 4966 206e 6f20 7573 6572 2069 6420  f"If no user id 
+0004cf40: 6973 2073 7065 6369 6669 6564 2c20 7468  is specified, th
+0004cf50: 6520 7573 6572 2070 726f 6669 6c65 206f  e user profile o
+0004cf60: 6620 7b50 524f 475f 5749 5448 4f55 545f  f {PROG_WITHOUT_
+0004cf70: 4558 547d 2022 0a20 2020 2020 2020 2022  EXT} ".        "
+0004cf80: 7769 6c6c 2062 6520 6665 7463 6865 642e  will be fetched.
+0004cf90: 2049 6620 6f6e 6520 6f72 206d 6f72 6520   If one or more 
+0004cfa0: 7573 6572 2069 6473 2061 7265 2067 6976  user ids are giv
+0004cfb0: 656e 2c20 7468 6520 7573 6572 2022 0a20  en, the user ". 
+0004cfc0: 2020 2020 2020 2022 7072 6f66 696c 6573         "profiles
+0004cfd0: 206f 6620 7468 6573 6520 7573 6572 7320   of these users 
+0004cfe0: 7769 6c6c 2062 6520 6665 7463 6865 642e  will be fetched.
+0004cff0: 2041 7320 7265 7370 6f6e 7365 2022 0a20   As response ". 
+0004d000: 2020 2020 2020 2022 6469 7370 6c61 7920         "display 
+0004d010: 6e61 6d65 2061 6e64 2061 7661 7461 7220  name and avatar 
+0004d020: 4d58 4320 5552 4920 6173 2077 656c 6c20  MXC URI as well 
+0004d030: 6173 2070 6f73 7369 626c 6520 6164 6469  as possible addi
+0004d040: 7469 6f6e 616c 2022 0a20 2020 2020 2020  tional ".       
+0004d050: 2022 7072 6f66 696c 6520 696e 666f 726d   "profile inform
+0004d060: 6174 696f 6e20 2869 6620 7072 6573 656e  ation (if presen
+0004d070: 7429 2022 0a20 2020 2020 2020 2022 7769  t) ".        "wi
+0004d080: 6c6c 2062 6520 7072 696e 7465 642e 204f  ll be printed. O
+0004d090: 6e65 206c 696e 6520 7065 7220 7573 6572  ne line per user
+0004d0a0: 2077 696c 6c20 6265 2070 7269 6e74 6564   will be printed
+0004d0b0: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+0004d0c0: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+0004d0d0: 2020 2020 2020 2022 2d2d 6765 742d 726f         "--get-ro
+0004d0e0: 6f6d 2d69 6e66 6f22 2c0a 2020 2020 2020  om-info",.      
+0004d0f0: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+0004d100: 2c0a 2020 2020 2020 2020 6163 7469 6f6e  ,.        action
+0004d110: 3d22 6578 7465 6e64 222c 0a20 2020 2020  ="extend",.     
+0004d120: 2020 206e 6172 6773 3d22 2a22 2c20 2023     nargs="*",  #
+0004d130: 204e 6f6e 6520 6966 206e 6f74 2075 7365   None if not use
+0004d140: 642c 205b 5d20 6973 2075 7365 6420 7769  d, [] is used wi
+0004d150: 7468 6f75 7420 6578 7472 6120 6172 6773  thout extra args
+0004d160: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+0004d170: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
+0004d180: 6172 3d22 524f 4f4d 222c 0a20 2020 2020  ar="ROOM",.     
+0004d190: 2020 2068 656c 703d 2247 6574 2074 6865     help="Get the
+0004d1a0: 2072 6f6f 6d20 696e 666f 726d 6174 696f   room informatio
+0004d1b0: 6e2e 2022 0a20 2020 2020 2020 2022 4465  n. ".        "De
+0004d1c0: 7461 696c 733a 3a20 4765 7420 7468 6520  tails:: Get the 
+0004d1d0: 726f 6f6d 2069 6e66 6f72 6d61 7469 6f6e  room information
+0004d1e0: 2073 7563 6820 6173 2072 6f6f 6d20 6469   such as room di
+0004d1f0: 7370 6c61 7920 6e61 6d65 2c20 220a 2020  splay name, ".  
+0004d200: 2020 2020 2020 2272 6f6f 6d20 616c 6961        "room alia
+0004d210: 732c 2072 6f6f 6d20 6372 6561 746f 722c  s, room creator,
+0004d220: 2065 7463 2e20 666f 7220 220a 2020 2020   etc. for ".    
+0004d230: 2020 2020 226f 6e65 206f 7220 6d75 6c74      "one or mult
+0004d240: 6970 6c65 2073 7065 6369 6669 6564 2072  iple specified r
+0004d250: 6f6f 6d73 2e20 5468 6520 696e 636c 7564  ooms. The includ
+0004d260: 6564 2072 6f6f 6d20 2764 6973 706c 6179  ed room 'display
+0004d270: 206e 616d 6527 2069 7320 220a 2020 2020   name' is ".    
+0004d280: 2020 2020 2261 6c73 6f20 7265 6665 7272      "also referr
+0004d290: 6564 2074 6f20 6173 2027 726f 6f6d 206e  ed to as 'room n
+0004d2a0: 616d 6527 206f 7220 696e 636f 7272 6563  ame' or incorrec
+0004d2b0: 746c 7920 6576 656e 2061 7320 726f 6f6d  tly even as room
+0004d2c0: 2074 6974 6c65 2e20 220a 2020 2020 2020   title. ".      
+0004d2d0: 2020 2249 6620 6f6e 6520 6f72 206d 6f72    "If one or mor
+0004d2e0: 6520 726f 6f6d 2061 7265 2067 6976 656e  e room are given
+0004d2f0: 2c20 7468 6520 726f 6f6d 2022 0a20 2020  , the room ".   
+0004d300: 2020 2020 2022 696e 666f 726d 6174 696f       "informatio
+0004d310: 6e73 206f 6620 7468 6573 6520 726f 6f6d  ns of these room
+0004d320: 7320 7769 6c6c 2062 6520 6665 7463 6865  s will be fetche
+0004d330: 642e 2022 0a20 2020 2020 2020 2022 4966  d. ".        "If
+0004d340: 206e 6f20 726f 6f6d 2069 7320 7370 6563   no room is spec
+0004d350: 6966 6965 642c 2074 6865 2072 6f6f 6d20  ified, the room 
+0004d360: 696e 666f 726d 6174 696f 6e20 666f 7220  information for 
+0004d370: 7468 6520 220a 2020 2020 2020 2020 6622  the ".        f"
+0004d380: 6465 6661 756c 7420 726f 6f6d 2063 6f6e  default room con
+0004d390: 6669 6775 7265 6420 666f 7220 7b50 524f  figured for {PRO
+0004d3a0: 475f 5749 5448 4f55 545f 4558 547d 2069  G_WITHOUT_EXT} i
+0004d3b0: 7320 6665 7463 6865 642e 2022 0a20 2020  s fetched. ".   
+0004d3c0: 2020 2020 2022 526f 6f6d 7320 6361 6e20       "Rooms can 
+0004d3d0: 6265 2067 6976 656e 2076 6961 2022 0a20  be given via ". 
+0004d3e0: 2020 2020 2020 2022 726f 6f6d 2069 6420         "room id 
+0004d3f0: 2865 2e67 2e20 275c 5c21 536f 6d65 526f  (e.g. '\\!SomeRo
+0004d400: 6f6d 4964 3a6d 6174 7269 782e 6578 616d  omId:matrix.exam
+0004d410: 706c 652e 636f 6d27 292c 2022 0a20 2020  ple.com'), ".   
+0004d420: 2020 2020 2022 6361 6e6f 6e69 6361 6c20       "canonical 
+0004d430: 2866 756c 6c29 2072 6f6f 6d20 616c 6961  (full) room alia
+0004d440: 7320 220a 2020 2020 2020 2020 2228 652e  s ".        "(e.
+0004d450: 672e 2027 2353 6f6d 6552 6f6f 6d41 6c69  g. '#SomeRoomAli
+0004d460: 6173 3a6d 6174 7269 782e 6578 616d 706c  as:matrix.exampl
+0004d470: 652e 636f 6d27 292c 2022 0a20 2020 2020  e.com'), ".     
+0004d480: 2020 2022 6f72 2073 686f 7274 2061 6c69     "or short ali
+0004d490: 6173 2028 652e 672e 2027 536f 6d65 526f  as (e.g. 'SomeRo
+0004d4a0: 6f6d 416c 6961 7327 206f 7220 2723 536f  omAlias' or '#So
+0004d4b0: 6d65 526f 6f6d 416c 6961 7327 292e 2022  meRoomAlias'). "
+0004d4c0: 0a20 2020 2020 2020 2022 4173 2072 6573  .        "As res
+0004d4d0: 706f 6e73 6520 220a 2020 2020 2020 2020  ponse ".        
+0004d4e0: 2272 6f6f 6d20 6964 2c20 726f 6f6d 2064  "room id, room d
+0004d4f0: 6973 706c 6179 206e 616d 652c 2072 6f6f  isplay name, roo
+0004d500: 6d20 6361 6e6f 6e69 6361 6c20 616c 6961  m canonical alia
+0004d510: 732c 2072 6f6f 6d20 746f 7069 632c 2022  s, room topic, "
+0004d520: 0a20 2020 2020 2020 2022 726f 6f6d 2063  .        "room c
+0004d530: 7265 6174 6f72 2c20 616e 6420 726f 6f6d  reator, and room
+0004d540: 2065 6e63 7279 7074 696f 6e20 220a 2020   encryption ".  
+0004d550: 2020 2020 2020 2261 7265 2070 7269 6e74        "are print
+0004d560: 6564 2e20 4f6e 6520 6c69 6e65 2070 6572  ed. One line per
+0004d570: 2072 6f6f 6d20 7769 6c6c 2062 6520 7072   room will be pr
+0004d580: 696e 7465 642e 2022 0a20 2020 2020 2020  inted. ".       
+0004d590: 2022 5369 6e63 6520 6569 7468 6572 2072   "Since either r
+0004d5a0: 6f6f 6d20 6964 206f 7220 726f 6f6d 2061  oom id or room a
+0004d5b0: 6c69 6173 2061 7265 2061 6363 6570 7465  lias are accepte
+0004d5c0: 6420 6173 2069 6e70 7574 2061 6e64 2062  d as input and b
+0004d5d0: 6f74 6820 220a 2020 2020 2020 2020 2272  oth ".        "r
+0004d5e0: 6f6f 6d20 6964 2061 6e64 2072 6f6f 6d20  oom id and room 
+0004d5f0: 616c 6961 7320 6172 6520 6769 7665 6e20  alias are given 
+0004d600: 6173 206f 7574 7075 742c 206f 6e65 2063  as output, one c
+0004d610: 616e 2068 656e 6365 2075 7365 2074 6869  an hence use thi
+0004d620: 7320 220a 2020 2020 2020 2020 226f 7074  s ".        "opt
+0004d630: 696f 6e20 746f 206d 6170 2066 726f 6d20  ion to map from 
+0004d640: 726f 6f6d 2069 6420 746f 2072 6f6f 6d20  room id to room 
+0004d650: 616c 6961 7320 220a 2020 2020 2020 2020  alias ".        
+0004d660: 2261 7320 7765 6c6c 2061 7320 7669 6365  "as well as vice
+0004d670: 2076 6572 7361 2066 726f 6d20 726f 6f6d   versa from room
+0004d680: 2061 6c69 6173 2074 6f20 726f 6f6d 2069   alias to room i
+0004d690: 642e 2022 0a20 2020 2020 2020 2022 446f  d. ".        "Do
+0004d6a0: 206e 6f74 2063 6f6e 6675 7365 2074 6869   not confuse thi
+0004d6b0: 7320 6f70 7469 6f6e 2077 6974 6820 7468  s option with th
+0004d6c0: 6520 6f70 7469 6f6e 7320 272d 2d67 6574  e options '--get
+0004d6d0: 2d64 6973 706c 6179 2d6e 616d 6527 2022  -display-name' "
+0004d6e0: 0a20 2020 2020 2020 2022 616e 6420 272d  .        "and '-
+0004d6f0: 2d73 6574 2d64 6973 706c 6179 2d6e 616d  -set-display-nam
+0004d700: 6527 2c20 7768 6963 6820 6765 742f 7365  e', which get/se
+0004d710: 7420 7468 6520 7573 6572 2064 6973 706c  t the user displ
+0004d720: 6179 206e 616d 652c 206e 6f74 2022 0a20  ay name, not ". 
+0004d730: 2020 2020 2020 2022 7468 6520 726f 6f6d         "the room
+0004d740: 2064 6973 706c 6179 206e 616d 652e 222c   display name.",
+0004d750: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
+0004d760: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
+0004d770: 2020 2020 222d 2d67 6574 2d63 6c69 656e      "--get-clien
+0004d780: 742d 696e 666f 222c 0a20 2020 2020 2020  t-info",.       
+0004d790: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+0004d7a0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
+0004d7b0: 2273 746f 7265 5f74 7275 6522 2c0a 2020  "store_true",.  
+0004d7c0: 2020 2020 2020 6865 6c70 3d22 5072 696e        help="Prin
+0004d7d0: 7420 636c 6965 6e74 2069 6e66 6f72 6d61  t client informa
+0004d7e0: 7469 6f6e 2e20 220a 2020 2020 2020 2020  tion. ".        
+0004d7f0: 2244 6574 6169 6c73 3a3a 2050 7269 6e74  "Details:: Print
+0004d800: 2069 6e66 6f72 6d61 7469 6f6e 206b 6570   information kep
+0004d810: 7420 696e 2074 6865 2063 6c69 656e 742c  t in the client,
+0004d820: 2069 2e65 2e20 220a 2020 2020 2020 2020   i.e. ".        
+0004d830: 6622 7b50 524f 475f 5749 5448 4f55 545f  f"{PROG_WITHOUT_
+0004d840: 4558 547d 2e20 220a 2020 2020 2020 2020  EXT}. ".        
+0004d850: 224f 7574 7075 7420 6973 2070 7269 6e74  "Output is print
+0004d860: 6564 2069 6e20 4a53 4f4e 2066 6f72 6d61  ed in JSON forma
+0004d870: 742e 222c 0a20 2020 2029 0a20 2020 2061  t.",.    ).    a
+0004d880: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+0004d890: 2020 2020 2020 2020 222d 2d68 6173 2d70          "--has-p
+0004d8a0: 6572 6d69 7373 696f 6e22 2c0a 2020 2020  ermission",.    
+0004d8b0: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+0004d8c0: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+0004d8d0: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+0004d8e0: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+0004d8f0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+0004d900: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+0004d910: 723d 2252 4f4f 4d20 4241 4e7c 494e 5649  r="ROOM BAN|INVI
+0004d920: 5445 7c4b 4943 4b7c 4e4f 5449 4649 4341  TE|KICK|NOTIFICA
+0004d930: 5449 4f4e 537c 5245 4441 4354 7c65 7463  TIONS|REDACT|etc
+0004d940: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+0004d950: 2249 6e71 7569 7265 2061 626f 7574 2070  "Inquire about p
+0004d960: 6572 6d69 7373 696f 6e73 2e20 220a 2020  ermissions. ".  
+0004d970: 2020 2020 2020 6622 4465 7461 696c 733a        f"Details:
+0004d980: 3a20 496e 7175 6972 6520 6966 2075 7365  : Inquire if use
+0004d990: 7220 7573 6564 2062 7920 7b50 524f 475f  r used by {PROG_
+0004d9a0: 5749 5448 4f55 545f 4558 547d 2068 6173  WITHOUT_EXT} has
+0004d9b0: 2022 0a20 2020 2020 2020 2022 7065 726d   ".        "perm
+0004d9c0: 6973 7369 6f6e 2066 6f72 206f 6e65 206f  ission for one o
+0004d9d0: 7220 6d75 6c74 6970 6c65 2061 6374 696f  r multiple actio
+0004d9e0: 6e73 2069 6e20 6f6e 6520 6f72 206d 756c  ns in one or mul
+0004d9f0: 7469 706c 6520 726f 6f6d 732e 2022 0a20  tiple rooms. ". 
+0004da00: 2020 2020 2020 2022 4561 6368 2069 6e71         "Each inq
+0004da10: 7569 7279 2072 6571 7569 7265 7320 3220  uiry requires 2 
+0004da20: 7061 7261 6d65 7465 7273 3a20 7468 6520  parameters: the 
+0004da30: 726f 6f6d 2069 6420 616e 6420 7468 6520  room id and the 
+0004da40: 7065 726d 6973 7369 6f6e 2022 0a20 2020  permission ".   
+0004da50: 2020 2020 2022 7479 7065 2e20 4f6e 6520       "type. One 
+0004da60: 6f72 206d 756c 7469 706c 6520 6f66 2074  or multiple of t
+0004da70: 6865 7365 2070 6172 616d 6574 6572 2070  hese parameter p
+0004da80: 6169 7273 206d 6179 2062 6520 7370 6563  airs may be spec
+0004da90: 6966 6965 642e 2022 0a20 2020 2020 2020  ified. ".       
+0004daa0: 2022 466f 7220 6561 6368 2070 6172 616d   "For each param
+0004dab0: 6574 6572 2070 6169 7220 7468 6572 6520  eter pair there 
+0004dac0: 7769 6c6c 2062 6520 6f6e 6520 6c69 6e65  will be one line
+0004dad0: 2070 7269 6e74 6564 2074 6f20 7374 646f   printed to stdo
+0004dae0: 7574 2e20 220a 2020 2020 2020 2020 2256  ut. ".        "V
+0004daf0: 616c 7565 7320 666f 7220 7468 6520 7065  alues for the pe
+0004db00: 726d 6973 7369 6f6e 2074 7970 6520 6172  rmission type ar
+0004db10: 6520 2762 616e 272c 2022 0a20 2020 2020  e 'ban', ".     
+0004db20: 2020 2022 2769 6e76 6974 6527 2c20 276b     "'invite', 'k
+0004db30: 6963 6b27 2c20 276e 6f74 6966 6963 6174  ick', 'notificat
+0004db40: 696f 6e73 272c 2027 7265 6461 6374 272c  ions', 'redact',
+0004db50: 2065 7463 2e20 220a 2020 2020 2020 2020   etc. ".        
+0004db60: 2253 6565 2068 7474 7073 3a2f 2f73 7065  "See https://spe
+0004db70: 632e 6d61 7472 6978 2e6f 7267 2f76 312e  c.matrix.org/v1.
+0004db80: 322f 636c 6965 6e74 2d73 6572 7665 722d  2/client-server-
+0004db90: 6170 692f 236d 726f 6f6d 706f 7765 725f  api/#mroompower_
+0004dba0: 6c65 7665 6c73 220a 2020 2020 2020 2020  levels".        
+0004dbb0: 222e 222c 0a20 2020 2020 2020 2023 2027  ".",.        # '
+0004dbc0: 6576 656e 7473 272c 2027 6576 656e 7473  events', 'events
+0004dbd0: 5f64 6566 6175 6c74 272c 2027 7374 6174  _default', 'stat
+0004dbe0: 655f 6465 6661 756c 7427 3a20 7661 6c69  e_default': vali
+0004dbf0: 6420 7065 726d 6973 7369 6f6e 2074 7970  d permission typ
+0004dc00: 6573 3f0a 2020 2020 290a 2020 2020 6170  es?.    ).    ap
+0004dc10: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+0004dc20: 2020 2020 2020 2022 2d2d 696d 706f 7274         "--import
+0004dc30: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
+0004dc40: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+0004dc50: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+0004dc60: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
+0004dc70: 206e 6172 6773 3d32 2c20 2023 2066 696c   nargs=2,  # fil
+0004dc80: 656e 616d 6520 666f 7220 696d 706f 7274  ename for import
+0004dc90: 2c20 7061 7373 7068 7261 7365 0a20 2020  , passphrase.   
+0004dca0: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
+0004dcb0: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+0004dcc0: 4649 4c45 2050 4153 5350 4852 4153 4522  FILE PASSPHRASE"
+0004dcd0: 2c0a 2020 2020 2020 2020 6865 6c70 3d22  ,.        help="
+0004dce0: 496d 706f 7274 204d 6567 6f6c 6d20 6465  Import Megolm de
+0004dcf0: 6372 7970 7469 6f6e 206b 6579 7320 6672  cryption keys fr
+0004dd00: 6f6d 2061 2066 696c 652e 2022 0a20 2020  om a file. ".   
+0004dd10: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+0004dd20: 5468 6973 2069 7320 616e 206f 7074 696f  This is an optio
+0004dd30: 6e61 6c20 6172 6775 6d65 6e74 2e20 4966  nal argument. If
+0004dd40: 2075 7365 6420 6974 206d 7573 7420 6265   used it must be
+0004dd50: 2066 6f6c 6c6f 7765 6420 220a 2020 2020   followed ".    
+0004dd60: 2020 2020 2262 7920 7477 6f20 7661 6c75      "by two valu
+0004dd70: 6573 2e20 2861 2920 6120 6669 6c65 206e  es. (a) a file n
+0004dd80: 616d 6520 6672 6f6d 2077 6869 6368 2074  ame from which t
+0004dd90: 6865 206b 6579 7320 7769 6c6c 2062 6520  he keys will be 
+0004dda0: 7265 6164 2e20 220a 2020 2020 2020 2020  read. ".        
+0004ddb0: 2228 6229 2061 2070 6173 7370 6872 6173  "(b) a passphras
+0004ddc0: 6520 7769 7468 2077 6869 6368 2074 6865  e with which the
+0004ddd0: 2066 696c 6520 6361 6e20 6265 2064 6563   file can be dec
+0004dde0: 7279 7074 6564 2077 6974 682e 2022 0a20  rypted with. ". 
+0004ddf0: 2020 2020 2020 2022 5468 6520 6b65 7973         "The keys
+0004de00: 2077 696c 6c20 6265 2061 6464 6564 2074   will be added t
+0004de10: 6f20 7468 6520 6375 7272 656e 7420 696e  o the current in
+0004de20: 7374 616e 6365 2061 7320 7765 6c6c 2061  stance as well a
+0004de30: 7320 220a 2020 2020 2020 2020 2277 7269  s ".        "wri
+0004de40: 7474 656e 2074 6f20 7468 6520 6461 7461  tten to the data
+0004de50: 6261 7365 2e20 5365 6520 616c 736f 202d  base. See also -
+0004de60: 2d65 7870 6f72 742d 6b65 7973 2e22 2c0a  -export-keys.",.
+0004de70: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+0004de80: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+0004de90: 2020 2022 2d2d 6578 706f 7274 2d6b 6579     "--export-key
+0004dea0: 7322 2c0a 2020 2020 2020 2020 7265 7175  s",.        requ
+0004deb0: 6972 6564 3d46 616c 7365 2c0a 2020 2020  ired=False,.    
+0004dec0: 2020 2020 6163 7469 6f6e 3d22 6578 7465      action="exte
+0004ded0: 6e64 222c 0a20 2020 2020 2020 206e 6172  nd",.        nar
+0004dee0: 6773 3d32 2c20 2023 2066 696c 656e 616d  gs=2,  # filenam
+0004def0: 6520 666f 7220 6578 706f 7274 2c20 7061  e for export, pa
+0004df00: 7373 7068 7261 7365 0a20 2020 2020 2020  ssphrase.       
+0004df10: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+0004df20: 2020 206d 6574 6176 6172 3d22 4649 4c45     metavar="FILE
+0004df30: 2050 4153 5350 4852 4153 4522 2c0a 2020   PASSPHRASE",.  
+0004df40: 2020 2020 2020 6865 6c70 3d22 4578 706f        help="Expo
+0004df50: 7274 2061 6c6c 2074 6865 204d 6567 6f6c  rt all the Megol
+0004df60: 6d20 6465 6372 7970 7469 6f6e 206b 6579  m decryption key
+0004df70: 7320 6f66 2074 6869 7320 6465 7669 6365  s of this device
+0004df80: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+0004df90: 6169 6c73 3a3a 2054 6869 7320 6973 2061  ails:: This is a
+0004dfa0: 6e20 6f70 7469 6f6e 616c 2061 7267 756d  n optional argum
+0004dfb0: 656e 742e 2049 6620 7573 6564 2069 7420  ent. If used it 
+0004dfc0: 6d75 7374 2062 6520 666f 6c6c 6f77 6564  must be followed
+0004dfd0: 2022 0a20 2020 2020 2020 2022 6279 2074   ".        "by t
+0004dfe0: 776f 2076 616c 7565 732e 2028 6129 2061  wo values. (a) a
+0004dff0: 2066 696c 6520 6e61 6d65 2074 6f20 7768   file name to wh
+0004e000: 6963 6820 7468 6520 6b65 7973 2077 696c  ich the keys wil
+0004e010: 6c20 6265 2077 7269 7474 656e 2074 6f2e  l be written to.
+0004e020: 2022 0a20 2020 2020 2020 2022 2862 2920   ".        "(b) 
+0004e030: 6120 7061 7373 7068 7261 7365 2077 6974  a passphrase wit
+0004e040: 6820 7768 6963 6820 7468 6520 6669 6c65  h which the file
+0004e050: 2077 696c 6c20 6265 2065 6e63 7279 7074   will be encrypt
+0004e060: 6564 2077 6974 682e 2022 0a20 2020 2020  ed with. ".     
+0004e070: 2020 2022 4e6f 7465 2074 6861 7420 7468     "Note that th
+0004e080: 6973 2064 6f65 7320 6e6f 7420 7361 7665  is does not save
+0004e090: 206f 7468 6572 2069 6e66 6f72 6d61 7469   other informati
+0004e0a0: 6f6e 2073 7563 6820 6173 2074 6865 2070  on such as the p
+0004e0b0: 7269 7661 7465 2022 0a20 2020 2020 2020  rivate ".       
+0004e0c0: 2022 6964 656e 7469 7479 206b 6579 7320   "identity keys 
+0004e0d0: 6f66 2074 6865 2064 6576 6963 652e 222c  of the device.",
+0004e0e0: 0a20 2020 2029 0a20 2020 2061 702e 6164  .    ).    ap.ad
+0004e0f0: 645f 6172 6775 6d65 6e74 280a 2020 2020  d_argument(.    
+0004e100: 2020 2020 222d 2d72 6f6f 6d2d 7365 742d      "--room-set-
+0004e110: 616c 6961 7322 2c0a 2020 2020 2020 2020  alias",.        
+0004e120: 222d 2d72 6f6f 6d2d 7075 742d 616c 6961  "--room-put-alia
+0004e130: 7322 2c20 2023 206e 616d 6520 7573 6564  s",  # name used
+0004e140: 2062 7920 6e69 6f0a 2020 2020 2020 2020   by nio.        
+0004e150: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+0004e160: 2020 2020 2020 2020 6163 7469 6f6e 3d22          action="
+0004e170: 6578 7465 6e64 222c 0a20 2020 2020 2020  extend",.       
+0004e180: 206e 6172 6773 3d22 2b22 2c0a 2020 2020   nargs="+",.    
+0004e190: 2020 2020 7479 7065 3d73 7472 2c0a 2020      type=str,.  
+0004e1a0: 2020 2020 2020 6d65 7461 7661 723d 2252        metavar="R
+0004e1b0: 4f4f 4d5f 414c 4941 5320 524f 4f4d 222c  OOM_ALIAS ROOM",
+0004e1c0: 0a20 2020 2020 2020 2068 656c 703d 2241  .        help="A
+0004e1d0: 6464 2061 6c69 6173 6573 2074 6f20 726f  dd aliases to ro
+0004e1e0: 6f6d 732e 2022 0a20 2020 2020 2020 2022  oms. ".        "
+0004e1f0: 4465 7461 696c 733a 3a20 4164 6420 616e  Details:: Add an
+0004e200: 2061 6c69 6173 2074 6f20 6120 726f 6f6d   alias to a room
+0004e210: 2c20 6f72 2061 6c69 6173 6573 2074 6f20  , or aliases to 
+0004e220: 6d75 6c74 6970 6c65 2072 6f6f 6d73 2e20  multiple rooms. 
+0004e230: 220a 2020 2020 2020 2020 2250 726f 7669  ".        "Provi
+0004e240: 6465 2070 6169 7273 206f 6620 6172 6775  de pairs of argu
+0004e250: 6d65 6e74 732e 2049 6e20 6561 6368 2070  ments. In each p
+0004e260: 6169 722c 2074 6865 2066 6972 7374 2061  air, the first a
+0004e270: 7267 756d 656e 7420 6d75 7374 2062 6520  rgument must be 
+0004e280: 220a 2020 2020 2020 2020 2274 6865 2061  ".        "the a
+0004e290: 6c69 6173 2079 6f75 2077 616e 7420 746f  lias you want to
+0004e2a0: 2061 7373 6967 6e20 746f 2074 6865 2072   assign to the r
+0004e2b0: 6f6f 6d20 6769 7665 6e20 7669 6120 726f  oom given via ro
+0004e2c0: 6f6d 2069 6420 696e 2074 6865 2022 0a20  om id in the ". 
+0004e2d0: 2020 2020 2020 2022 7365 636f 6e64 2061         "second a
+0004e2e0: 7267 756d 656e 7420 6f66 2074 6865 2070  rgument of the p
+0004e2f0: 6169 722e 2045 2e67 2e20 7468 6520 3420  air. E.g. the 4 
+0004e300: 6172 6775 6d65 6e74 7320 2761 3120 7231  arguments 'a1 r1
+0004e310: 2061 3220 7232 2720 220a 2020 2020 2020   a2 r2' ".      
+0004e320: 2020 2277 6f75 6c64 2061 7373 6967 6e20    "would assign 
+0004e330: 7468 6520 616c 6961 7320 2761 3127 2074  the alias 'a1' t
+0004e340: 6f20 726f 6f6d 2027 7231 2720 616e 6420  o room 'r1' and 
+0004e350: 7468 6520 616c 6961 7320 2761 3227 2074  the alias 'a2' t
+0004e360: 6f20 726f 6f6d 2022 0a20 2020 2020 2020  o room ".       
+0004e370: 2022 2772 3227 2e20 4966 2079 6f75 206a   "'r2'. If you j
+0004e380: 7573 7420 6861 7665 206f 6e65 2073 696e  ust have one sin
+0004e390: 676c 6520 7061 6972 2074 6865 6e20 7468  gle pair then th
+0004e3a0: 6520 7365 636f 6e64 2061 7267 756d 656e  e second argumen
+0004e3b0: 7420 6973 2022 0a20 2020 2020 2020 2022  t is ".        "
+0004e3c0: 6f70 7469 6f6e 616c 2e20 4966 206a 7573  optional. If jus
+0004e3d0: 7420 6120 7369 6e67 6c65 2076 616c 7565  t a single value
+0004e3e0: 2069 7320 6769 7665 6e20 2861 6e20 616c   is given (an al
+0004e3f0: 6961 7329 2074 6865 6e20 7468 6973 2022  ias) then this "
+0004e400: 0a20 2020 2020 2020 2022 616c 6961 7320  .        "alias 
+0004e410: 6973 2061 7373 6967 6e65 6420 746f 2074  is assigned to t
+0004e420: 6865 2064 6566 6175 6c74 2072 6f6f 6d20  he default room 
+0004e430: 6f66 2022 0a20 2020 2020 2020 2066 227b  of ".        f"{
+0004e440: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+0004e450: 7d20 2861 7320 666f 756e 6420 696e 2063  } (as found in c
+0004e460: 7265 6465 6e74 6961 6c73 2066 696c 6529  redentials file)
+0004e470: 2e20 496e 2073 686f 7274 2c20 220a 2020  . In short, ".  
+0004e480: 2020 2020 2020 2279 6f75 2063 616e 2068        "you can h
+0004e490: 6176 6520 6a75 7374 2061 2073 696e 676c  ave just a singl
+0004e4a0: 6520 6172 6775 6d65 6e74 206f 7220 616e  e argument or an
+0004e4b0: 2065 7665 6e20 6e75 6d62 6572 206f 6620   even number of 
+0004e4c0: 6172 6775 6d65 6e74 7320 220a 2020 2020  arguments ".    
+0004e4d0: 2020 2020 2266 6f72 6d69 6e67 2070 6169      "forming pai
+0004e4e0: 7273 2e20 596f 7520 6361 6e20 6861 7665  rs. You can have
+0004e4f0: 206d 756c 7469 706c 6520 726f 6f6d 2061   multiple room a
+0004e500: 6c69 6173 6573 2070 6572 2072 6f6f 6d2e  liases per room.
+0004e510: 2053 6f2c 2022 0a20 2020 2020 2020 2022   So, ".        "
+0004e520: 796f 7520 6d61 7920 6164 6420 6d75 6c74  you may add mult
+0004e530: 6970 6c65 2061 6c69 6173 6573 2074 6f20  iple aliases to 
+0004e540: 7468 6520 7361 6d65 2072 6f6f 6d2e 2022  the same room. "
+0004e550: 0a20 2020 2020 2020 2022 4120 726f 6f6d  .        "A room
+0004e560: 2061 6c69 6173 206c 6f6f 6b73 206c 696b   alias looks lik
+0004e570: 6520 7468 6973 3a20 220a 2020 2020 2020  e this: ".      
+0004e580: 2020 2227 2373 6f6d 6552 6f6f 6d41 6c69    "'#someRoomAli
+0004e590: 6173 3a6d 6174 7269 782e 6578 616d 706c  as:matrix.exampl
+0004e5a0: 652e 6f72 6727 2e20 5368 6f72 7420 616c  e.org'. Short al
+0004e5b0: 6961 7365 7320 6c69 6b65 2022 0a20 2020  iases like ".   
+0004e5c0: 2020 2020 2022 2773 6f6d 6552 6f6f 6d41       "'someRoomA
+0004e5d0: 6c69 6173 2720 6f72 2027 2373 6f6d 6552  lias' or '#someR
+0004e5e0: 6f6f 6d41 6c69 6173 2720 6172 6520 616c  oomAlias' are al
+0004e5f0: 736f 2061 6363 6570 7465 642e 2022 0a20  so accepted. ". 
+0004e600: 2020 2020 2020 2022 496e 2063 6173 6520         "In case 
+0004e610: 6f66 2061 2073 686f 7274 2061 6c69 6173  of a short alias
+0004e620: 2c20 220a 2020 2020 2020 2020 2269 7420  , ".        "it 
+0004e630: 7769 6c6c 2062 6520 6175 746f 6d61 7469  will be automati
+0004e640: 6361 6c6c 7920 7072 6566 6978 6564 2077  cally prefixed w
+0004e650: 6974 6820 2723 2720 616e 6420 7468 6520  ith '#' and the 
+0004e660: 220a 2020 2020 2020 2020 2268 6f6d 6573  ".        "homes
+0004e670: 6572 7665 7220 7769 6c6c 2062 6520 6175  erver will be au
+0004e680: 746f 6d61 7469 6361 6c6c 7920 6170 7065  tomatically appe
+0004e690: 6e64 6564 2e20 220a 2020 2020 2020 2020  nded. ".        
+0004e6a0: 2241 6464 696e 6720 7468 6520 7361 6d65  "Adding the same
+0004e6b0: 2061 6c69 6173 2022 0a20 2020 2020 2020   alias ".       
+0004e6c0: 2022 6d75 6c74 6970 6c65 2074 696d 6573   "multiple times
+0004e6d0: 2074 6f20 7468 6520 7361 6d65 2072 6f6f   to the same roo
+0004e6e0: 6d20 7265 7375 6c74 7320 696e 2061 6e20  m results in an 
+0004e6f0: 6572 726f 722e 2022 0a20 2020 2020 2020  error. ".       
+0004e700: 2022 2d2d 726f 6f6d 2d70 7574 2d61 6c69   "--room-put-ali
+0004e710: 6173 2069 7320 6571 6976 616c 656e 7420  as is eqivalent 
+0004e720: 746f 202d 2d72 6f6f 6d2d 7365 742d 616c  to --room-set-al
+0004e730: 6961 732e 222c 0a20 2020 2029 0a20 2020  ias.",.    ).   
+0004e740: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+0004e750: 280a 2020 2020 2020 2020 222d 2d72 6f6f  (.        "--roo
+0004e760: 6d2d 7265 736f 6c76 652d 616c 6961 7322  m-resolve-alias"
+0004e770: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+0004e780: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+0004e790: 2020 6163 7469 6f6e 3d22 6578 7465 6e64    action="extend
+0004e7a0: 222c 0a20 2020 2020 2020 206e 6172 6773  ",.        nargs
+0004e7b0: 3d22 2b22 2c0a 2020 2020 2020 2020 7479  ="+",.        ty
+0004e7c0: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+0004e7d0: 6d65 7461 7661 723d 2252 4f4f 4d5f 414c  metavar="ROOM_AL
+0004e7e0: 4941 5322 2c0a 2020 2020 2020 2020 6865  IAS",.        he
+0004e7f0: 6c70 3d22 5368 6f77 2072 6f6f 6d20 6964  lp="Show room id
+0004e800: 7320 636f 7272 6573 706f 6e64 696e 6720  s corresponding 
+0004e810: 746f 2072 6f6f 6d20 616c 6961 7365 732e  to room aliases.
+0004e820: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+0004e830: 696c 733a 3a20 5265 736f 6c76 6573 2061  ils:: Resolves a
+0004e840: 2072 6f6f 6d20 616c 6961 7320 746f 2074   room alias to t
+0004e850: 6865 2063 6f72 7265 7370 6f6e 6469 6e67  he corresponding
+0004e860: 2072 6f6f 6d20 6964 2c20 220a 2020 2020   room id, ".    
+0004e870: 2020 2020 226f 7220 6d75 6c74 6970 6c65      "or multiple
+0004e880: 2072 6f6f 6d20 616c 6961 7365 7320 746f   room aliases to
+0004e890: 2074 6865 6972 2063 6f72 7265 7370 6f6e   their correspon
+0004e8a0: 6469 6e67 2072 6f6f 6d20 6964 732e 2022  ding room ids. "
+0004e8b0: 0a20 2020 2020 2020 2022 5072 6f76 6964  .        "Provid
+0004e8c0: 6520 6f6e 6520 6f72 206d 756c 7469 706c  e one or multipl
+0004e8d0: 6520 726f 6f6d 2061 6c69 6173 6573 2e20  e room aliases. 
+0004e8e0: 220a 2020 2020 2020 2020 2241 2072 6f6f  ".        "A roo
+0004e8f0: 6d20 616c 6961 7320 6c6f 6f6b 7320 6c69  m alias looks li
+0004e900: 6b65 2074 6869 733a 2022 0a20 2020 2020  ke this: ".     
+0004e910: 2020 2022 2723 736f 6d65 526f 6f6d 416c     "'#someRoomAl
+0004e920: 6961 733a 6d61 7472 6978 2e65 7861 6d70  ias:matrix.examp
+0004e930: 6c65 2e6f 7267 272e 2053 686f 7274 2061  le.org'. Short a
+0004e940: 6c69 6173 6573 206c 696b 6520 220a 2020  liases like ".  
+0004e950: 2020 2020 2020 2227 736f 6d65 526f 6f6d        "'someRoom
+0004e960: 416c 6961 7327 206f 7220 2723 736f 6d65  Alias' or '#some
+0004e970: 526f 6f6d 416c 6961 7327 2061 7265 2061  RoomAlias' are a
+0004e980: 6c73 6f20 6163 6365 7074 6564 2e20 220a  lso accepted. ".
+0004e990: 2020 2020 2020 2020 2249 6e20 6361 7365          "In case
+0004e9a0: 206f 6620 6120 7368 6f72 7420 616c 6961   of a short alia
+0004e9b0: 732c 2022 0a20 2020 2020 2020 2022 6974  s, ".        "it
+0004e9c0: 2077 696c 6c20 6265 2061 7574 6f6d 6174   will be automat
+0004e9d0: 6963 616c 6c79 2070 7265 6669 7865 6420  ically prefixed 
+0004e9e0: 7769 7468 2027 2327 2061 6e64 2074 6865  with '#' and the
+0004e9f0: 2022 0a20 2020 2020 2020 2066 2268 6f6d   ".        f"hom
+0004ea00: 6573 6572 7665 7220 6672 6f6d 2074 6865  eserver from the
+0004ea10: 2064 6566 6175 6c74 2072 6f6f 6d20 6f66   default room of
+0004ea20: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
+0004ea30: 5854 7d20 2861 7320 666f 756e 6420 220a  XT} (as found ".
+0004ea40: 2020 2020 2020 2020 2269 6e20 6372 6564          "in cred
+0004ea50: 656e 7469 616c 7320 6669 6c65 2920 7769  entials file) wi
+0004ea60: 6c6c 2062 6520 6175 746f 6d61 7469 6361  ll be automatica
+0004ea70: 6c6c 7920 6170 7065 6e64 6564 2e20 220a  lly appended. ".
+0004ea80: 2020 2020 2020 2020 2252 6573 6f6c 7669          "Resolvi
+0004ea90: 6e67 2061 6e20 616c 6961 7320 7468 6174  ng an alias that
+0004eaa0: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
+0004eab0: 7265 7375 6c74 7320 696e 2061 6e20 6572  results in an er
+0004eac0: 726f 722e 2022 0a20 2020 2020 2020 2022  ror. ".        "
+0004ead0: 466f 7220 6561 6368 2072 6f6f 6d20 616c  For each room al
+0004eae0: 6961 7320 6f6e 6520 6c69 6e65 2077 696c  ias one line wil
+0004eaf0: 6c20 6265 2070 7269 6e74 6564 2074 6f20  l be printed to 
+0004eb00: 7374 646f 7574 2077 6974 6820 7468 6520  stdout with the 
+0004eb10: 220a 2020 2020 2020 2020 2272 6573 756c  ".        "resul
+0004eb20: 742e 222c 0a20 2020 2029 0a20 2020 2061  t.",.    ).    a
+0004eb30: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+0004eb40: 2020 2020 2020 2020 222d 2d72 6f6f 6d2d          "--room-
+0004eb50: 6465 6c65 7465 2d61 6c69 6173 222c 0a20  delete-alias",. 
+0004eb60: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+0004eb70: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
+0004eb80: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
+0004eb90: 2020 2020 2020 2020 6e61 7267 733d 222b          nargs="+
+0004eba0: 222c 0a20 2020 2020 2020 2074 7970 653d  ",.        type=
+0004ebb0: 7374 722c 0a20 2020 2020 2020 206d 6574  str,.        met
+0004ebc0: 6176 6172 3d22 524f 4f4d 5f41 4c49 4153  avar="ROOM_ALIAS
+0004ebd0: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+0004ebe0: 2244 656c 6574 6520 6f6e 6520 6f72 206d  "Delete one or m
+0004ebf0: 756c 7469 706c 6520 726f 6f6d 7320 616c  ultiple rooms al
+0004ec00: 6961 7365 732e 2022 0a20 2020 2020 2020  iases. ".       
+0004ec10: 2022 4465 7461 696c 733a 3a20 5072 6f76   "Details:: Prov
+0004ec20: 6964 6520 6f6e 6520 6f72 206d 756c 7469  ide one or multi
+0004ec30: 706c 6520 726f 6f6d 2061 6c69 6173 6573  ple room aliases
+0004ec40: 2e20 220a 2020 2020 2020 2020 2259 6f75  . ".        "You
+0004ec50: 2063 616e 2068 6176 6520 6d75 6c74 6970   can have multip
+0004ec60: 6c65 2072 6f6f 6d20 616c 6961 7365 7320  le room aliases 
+0004ec70: 7065 7220 726f 6f6d 2e20 536f 2c20 220a  per room. So, ".
+0004ec80: 2020 2020 2020 2020 2279 6f75 206d 6179          "you may
+0004ec90: 2064 656c 6574 6520 6d75 6c74 6970 6c65   delete multiple
+0004eca0: 2061 6c69 6173 6573 2066 726f 6d20 7468   aliases from th
+0004ecb0: 6520 7361 6d65 2072 6f6f 6d20 6f72 2066  e same room or f
+0004ecc0: 726f 6d20 6469 6666 6572 656e 7420 220a  rom different ".
+0004ecd0: 2020 2020 2020 2020 2272 6f6f 6d73 2e20          "rooms. 
+0004ece0: 220a 2020 2020 2020 2020 2241 2072 6f6f  ".        "A roo
+0004ecf0: 6d20 616c 6961 7320 6c6f 6f6b 7320 6c69  m alias looks li
+0004ed00: 6b65 2074 6869 733a 2022 0a20 2020 2020  ke this: ".     
+0004ed10: 2020 2022 2723 736f 6d65 526f 6f6d 416c     "'#someRoomAl
+0004ed20: 6961 733a 6d61 7472 6978 2e65 7861 6d70  ias:matrix.examp
+0004ed30: 6c65 2e6f 7267 272e 2053 686f 7274 2061  le.org'. Short a
+0004ed40: 6c69 6173 6573 206c 696b 6520 220a 2020  liases like ".  
+0004ed50: 2020 2020 2020 2227 736f 6d65 526f 6f6d        "'someRoom
+0004ed60: 416c 6961 7327 206f 7220 2723 736f 6d65  Alias' or '#some
+0004ed70: 526f 6f6d 416c 6961 7327 2061 7265 2061  RoomAlias' are a
+0004ed80: 6c73 6f20 6163 6365 7074 6564 2e20 220a  lso accepted. ".
+0004ed90: 2020 2020 2020 2020 2249 6e20 6361 7365          "In case
+0004eda0: 206f 6620 6120 7368 6f72 7420 616c 6961   of a short alia
+0004edb0: 732c 2022 0a20 2020 2020 2020 2022 6974  s, ".        "it
+0004edc0: 2077 696c 6c20 6265 2061 7574 6f6d 6174   will be automat
+0004edd0: 6963 616c 6c79 2070 7265 6669 7865 6420  ically prefixed 
+0004ede0: 7769 7468 2027 2327 2061 6e64 2074 6865  with '#' and the
+0004edf0: 2022 0a20 2020 2020 2020 2066 2268 6f6d   ".        f"hom
+0004ee00: 6573 6572 7665 7220 6672 6f6d 2074 6865  eserver from the
+0004ee10: 2064 6566 6175 6c74 2072 6f6f 6d20 6f66   default room of
+0004ee20: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
+0004ee30: 5854 7d20 2861 7320 666f 756e 6420 220a  XT} (as found ".
+0004ee40: 2020 2020 2020 2020 2269 6e20 6372 6564          "in cred
+0004ee50: 656e 7469 616c 7320 6669 6c65 2920 7769  entials file) wi
+0004ee60: 6c6c 2062 6520 6175 746f 6d61 7469 6361  ll be automatica
+0004ee70: 6c6c 7920 6170 7065 6e64 6564 2e20 220a  lly appended. ".
+0004ee80: 2020 2020 2020 2020 2244 656c 6574 696e          "Deletin
+0004ee90: 6720 616e 2061 6c69 6173 2074 6861 7420  g an alias that 
+0004eea0: 646f 6573 206e 6f74 2065 7869 7374 2072  does not exist r
+0004eeb0: 6573 756c 7473 2069 6e20 616e 2065 7272  esults in an err
+0004eec0: 6f72 2e22 2c0a 2020 2020 290a 2020 2020  or.",.    ).    
+0004eed0: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+0004eee0: 0a20 2020 2020 2020 2022 2d2d 6765 742d  .        "--get-
+0004eef0: 6f70 656e 6964 2d74 6f6b 656e 222c 0a20  openid-token",. 
+0004ef00: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+0004ef10: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
+0004ef20: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
+0004ef30: 2020 2020 2020 2020 6e61 7267 733d 222a          nargs="*
+0004ef40: 222c 2020 2320 4e6f 6e65 2069 6620 6e6f  ",  # None if no
+0004ef50: 7420 7573 6564 2c20 5b5d 2069 7320 7573  t used, [] is us
+0004ef60: 6564 2077 6974 686f 7574 2065 7874 7261  ed without extra
+0004ef70: 2061 7267 730a 2020 2020 2020 2020 7479   args.        ty
+0004ef80: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+0004ef90: 6d65 7461 7661 723d 2255 5345 5222 2c0a  metavar="USER",.
+0004efa0: 2020 2020 2020 2020 6865 6c70 3d22 4765          help="Ge
+0004efb0: 7420 616e 204f 7065 6e49 4420 746f 6b65  t an OpenID toke
+0004efc0: 6e2e 2022 0a20 2020 2020 2020 2066 2244  n. ".        f"D
+0004efd0: 6574 6169 6c73 3a3a 2047 6574 2061 6e20  etails:: Get an 
+0004efe0: 4f70 656e 4944 2074 6f6b 656e 2066 6f72  OpenID token for
+0004eff0: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
+0004f000: 5854 7d2c 206f 7220 666f 7220 220a 2020  XT}, or for ".  
+0004f010: 2020 2020 2020 226f 6e65 206f 7220 6d75        "one or mu
+0004f020: 6c74 6970 6c65 206f 7468 6572 2075 7365  ltiple other use
+0004f030: 7273 2e20 4974 2070 7269 6e74 7320 616e  rs. It prints an
+0004f040: 204f 7065 6e49 4420 746f 6b65 6e20 6f62   OpenID token ob
+0004f050: 6a65 6374 2022 0a20 2020 2020 2020 2022  ject ".        "
+0004f060: 7468 6174 2074 6865 2072 6571 7565 7374  that the request
+0004f070: 6572 206d 6179 2073 7570 706c 7920 746f  er may supply to
+0004f080: 2061 6e6f 7468 6572 2073 6572 7669 6365   another service
+0004f090: 2074 6f20 7665 7269 6679 2074 6865 6972   to verify their
+0004f0a0: 2022 0a20 2020 2020 2020 2022 6964 656e   ".        "iden
+0004f0b0: 7469 7479 2069 6e20 4d61 7472 6978 2e20  tity in Matrix. 
+0004f0c0: 5365 6520 6874 7470 3a2f 2f77 7777 2e6f  See http://www.o
+0004f0d0: 7065 6e69 642e 6e65 742f 2e20 220a 2020  penid.net/. ".  
+0004f0e0: 2020 2020 2020 2253 7065 6369 6679 207a        "Specify z
+0004f0f0: 6572 6f20 6f72 206d 6f72 6520 7573 6572  ero or more user
+0004f100: 2069 6473 2e20 220a 2020 2020 2020 2020   ids. ".        
+0004f110: 6622 4966 206e 6f20 7573 6572 2069 6420  f"If no user id 
+0004f120: 6973 2073 7065 6369 6669 6564 2c20 616e  is specified, an
+0004f130: 204f 7065 6e49 4420 666f 7220 7b50 524f   OpenID for {PRO
+0004f140: 475f 5749 5448 4f55 545f 4558 547d 2077  G_WITHOUT_EXT} w
+0004f150: 696c 6c20 220a 2020 2020 2020 2020 2262  ill ".        "b
+0004f160: 6520 6665 7463 6865 642e 2049 6620 6f6e  e fetched. If on
+0004f170: 6520 6f72 206d 6f72 6520 7573 6572 2069  e or more user i
+0004f180: 6473 2061 7265 2067 6976 656e 2c20 7468  ds are given, th
+0004f190: 6520 4f70 656e 4944 206f 6620 220a 2020  e OpenID of ".  
+0004f1a0: 2020 2020 2020 2274 6865 7365 2075 7365        "these use
+0004f1b0: 7273 2077 696c 6c20 6265 2066 6574 6368  rs will be fetch
+0004f1c0: 6564 2e20 4173 2072 6573 706f 6e73 6520  ed. As response 
+0004f1d0: 7468 6520 7573 6572 2069 6428 7329 2061  the user id(s) a
+0004f1e0: 6e64 2022 0a20 2020 2020 2020 2022 4f70  nd ".        "Op
+0004f1f0: 656e 4944 2873 2920 7769 6c6c 2062 6520  enID(s) will be 
+0004f200: 7072 696e 7465 642e 222c 0a20 2020 2029  printed.",.    )
+0004f210: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+0004f220: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+0004f230: 2d72 6f6f 6d2d 6765 742d 7669 7369 6269  -room-get-visibi
+0004f240: 6c69 7479 222c 0a20 2020 2020 2020 2072  lity",.        r
+0004f250: 6571 7569 7265 643d 4661 6c73 652c 0a20  equired=False,. 
+0004f260: 2020 2020 2020 2061 6374 696f 6e3d 2265         action="e
+0004f270: 7874 656e 6422 2c0a 2020 2020 2020 2020  xtend",.        
+0004f280: 6e61 7267 733d 222a 222c 2020 2320 4e6f  nargs="*",  # No
+0004f290: 6e65 2069 6620 6e6f 7420 7573 6564 2c20  ne if not used, 
+0004f2a0: 5b5d 2069 7320 7573 6564 2077 6974 686f  [] is used witho
+0004f2b0: 7574 2065 7874 7261 2061 7267 730a 2020  ut extra args.  
+0004f2c0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+0004f2d0: 2020 2020 2020 2020 6d65 7461 7661 723d          metavar=
+0004f2e0: 2252 4f4f 4d22 2c0a 2020 2020 2020 2020  "ROOM",.        
+0004f2f0: 6865 6c70 3d22 4765 7420 7468 6520 7669  help="Get the vi
+0004f300: 7369 6269 6c69 7479 206f 6620 6f6e 6520  sibility of one 
+0004f310: 6f72 206d 6f72 6520 726f 6f6d 732e 2022  or more rooms. "
+0004f320: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+0004f330: 733a 3a20 5072 6f76 6964 6520 7a65 726f  s:: Provide zero
+0004f340: 206f 7220 6d6f 7265 2072 6f6f 6d20 6964   or more room id
+0004f350: 7320 6173 2061 7267 756d 656e 7473 2e20  s as arguments. 
+0004f360: 220a 2020 2020 2020 2020 2249 6620 6e6f  ".        "If no
+0004f370: 2061 7267 756d 656e 7420 6973 2067 6976   argument is giv
+0004f380: 656e 2c20 7468 656e 2074 6865 2064 6566  en, then the def
+0004f390: 6175 6c74 2072 6f6f 6d20 6f66 2022 0a20  ault room of ". 
+0004f3a0: 2020 2020 2020 2066 227b 5052 4f47 5f57         f"{PROG_W
+0004f3b0: 4954 484f 5554 5f45 5854 7d20 2861 7320  ITHOUT_EXT} (as 
+0004f3c0: 666f 756e 6420 696e 2063 7265 6465 6e74  found in credent
+0004f3d0: 6961 6c73 2066 696c 6529 2077 696c 6c20  ials file) will 
+0004f3e0: 6265 2075 7365 642e 2022 0a20 2020 2020  be used. ".     
+0004f3f0: 2020 2022 466f 7220 6561 6368 2072 6f6f     "For each roo
+0004f400: 6d20 7468 6520 7669 7369 6269 6c69 7479  m the visibility
+0004f410: 2077 696c 6c20 6265 2070 7269 6e74 6564   will be printed
+0004f420: 2e20 4375 7272 656e 746c 792c 2074 6869  . Currently, thi
+0004f430: 7320 220a 2020 2020 2020 2020 2269 7320  s ".        "is 
+0004f440: 6569 7468 6572 2074 6865 2073 7472 696e  either the strin
+0004f450: 6720 2770 7269 7661 7465 2720 6f72 2027  g 'private' or '
+0004f460: 7075 626c 6963 272e 2022 0a20 2020 2020  public'. ".     
+0004f470: 2020 2022 4173 2072 6573 706f 6e73 6520     "As response 
+0004f480: 6f6e 6520 6c69 6e65 2070 6572 2072 6f6f  one line per roo
+0004f490: 6d20 7769 6c6c 2062 6520 7072 696e 7465  m will be printe
+0004f4a0: 6420 746f 2073 7464 6f75 742e 222c 0a20  d to stdout.",. 
+0004f4b0: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+0004f4c0: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+0004f4d0: 2020 222d 2d72 6f6f 6d2d 6765 742d 7374    "--room-get-st
+0004f4e0: 6174 6522 2c0a 2020 2020 2020 2020 7265  ate",.        re
+0004f4f0: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+0004f500: 2020 2020 2020 6163 7469 6f6e 3d22 6578        action="ex
+0004f510: 7465 6e64 222c 0a20 2020 2020 2020 206e  tend",.        n
+0004f520: 6172 6773 3d22 2a22 2c20 2023 204e 6f6e  args="*",  # Non
+0004f530: 6520 6966 206e 6f74 2075 7365 642c 205b  e if not used, [
+0004f540: 5d20 6973 2075 7365 6420 7769 7468 6f75  ] is used withou
+0004f550: 7420 6578 7472 6120 6172 6773 0a20 2020  t extra args.   
+0004f560: 2020 2020 2074 7970 653d 7374 722c 0a20       type=str,. 
+0004f570: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+0004f580: 524f 4f4d 222c 0a20 2020 2020 2020 2068  ROOM",.        h
+0004f590: 656c 703d 2247 6574 2074 6865 2073 7461  elp="Get the sta
+0004f5a0: 7465 206f 6620 6f6e 6520 6f72 206d 6f72  te of one or mor
+0004f5b0: 6520 726f 6f6d 732e 2022 0a20 2020 2020  e rooms. ".     
+0004f5c0: 2020 2022 4465 7461 696c 733a 3a50 726f     "Details::Pro
+0004f5d0: 7669 6465 207a 6572 6f20 6f72 206d 6f72  vide zero or mor
+0004f5e0: 6520 726f 6f6d 2069 6473 2061 7320 6172  e room ids as ar
+0004f5f0: 6775 6d65 6e74 732e 2022 0a20 2020 2020  guments. ".     
+0004f600: 2020 2022 4966 206e 6f20 6172 6775 6d65     "If no argume
+0004f610: 6e74 2069 7320 6769 7665 6e2c 2074 6865  nt is given, the
+0004f620: 6e20 7468 6520 6465 6661 756c 7420 726f  n the default ro
+0004f630: 6f6d 206f 6620 220a 2020 2020 2020 2020  om of ".        
+0004f640: 6622 7b50 524f 475f 5749 5448 4f55 545f  f"{PROG_WITHOUT_
+0004f650: 4558 547d 2028 6173 2066 6f75 6e64 2069  EXT} (as found i
+0004f660: 6e20 6372 6564 656e 7469 616c 7320 6669  n credentials fi
+0004f670: 6c65 2920 7769 6c6c 2062 6520 7573 6564  le) will be used
+0004f680: 2e20 220a 2020 2020 2020 2020 2246 6f72  . ".        "For
+0004f690: 2065 6163 6820 726f 6f6d 2074 6865 2073   each room the s
+0004f6a0: 7461 7465 2077 696c 6c20 6265 2070 7269  tate will be pri
+0004f6b0: 6e74 6564 2e20 5468 6520 7374 6174 6520  nted. The state 
+0004f6c0: 6973 2061 206c 6f6e 6720 220a 2020 2020  is a long ".    
+0004f6d0: 2020 2020 226c 6973 7420 6f66 2065 7665      "list of eve
+0004f6e0: 6e74 7320 696e 636c 7564 696e 6720 6576  nts including ev
+0004f6f0: 656e 7473 206c 696b 6520 276d 2e72 6f6f  ents like 'm.roo
+0004f700: 6d2e 6372 6561 7465 272c 2022 0a20 2020  m.create', ".   
+0004f710: 2020 2020 2022 276d 2e72 6f6f 6d2e 656e       "'m.room.en
+0004f720: 6372 7970 7469 6f6e 272c 2027 6d2e 726f  cryption', 'm.ro
+0004f730: 6f6d 2e67 7565 7374 5f61 6363 6573 7327  om.guest_access'
+0004f740: 2c20 220a 2020 2020 2020 2020 2227 6d2e  , ".        "'m.
+0004f750: 726f 6f6d 2e68 6973 746f 7279 5f76 6973  room.history_vis
+0004f760: 6962 696c 6974 7927 2c20 276d 2e72 6f6f  ibility', 'm.roo
+0004f770: 6d2e 6a6f 696e 5f72 756c 6573 272c 2022  m.join_rules', "
+0004f780: 0a20 2020 2020 2020 2022 276d 2e72 6f6f  .        "'m.roo
+0004f790: 6d2e 6d65 6d62 6572 272c 2027 6d2e 726f  m.member', 'm.ro
+0004f7a0: 6f6d 2e70 6f77 6572 5f6c 6576 656c 7327  om.power_levels'
+0004f7b0: 2c20 6574 632e 2022 0a20 2020 2020 2020  , etc. ".       
+0004f7c0: 2022 4173 2072 6573 706f 6e73 6520 6f6e   "As response on
+0004f7d0: 6520 6c69 6e65 2070 6572 2072 6f6f 6d20  e line per room 
+0004f7e0: 7769 6c6c 2062 6520 7072 696e 7465 6420  will be printed 
+0004f7f0: 746f 2073 7464 6f75 742e 2022 0a20 2020  to stdout. ".   
+0004f800: 2020 2020 2022 5468 6520 6c69 6e65 2063       "The line c
+0004f810: 616e 2062 6520 7665 7279 206c 6f6e 6720  an be very long 
+0004f820: 6173 2074 6865 206c 6973 7420 6f66 2065  as the list of e
+0004f830: 7665 6e74 7320 6361 6e20 6265 2076 6572  vents can be ver
+0004f840: 7920 6c61 7267 652e 2022 0a20 2020 2020  y large. ".     
+0004f850: 2020 2022 546f 2067 6574 206f 7574 7075     "To get outpu
+0004f860: 7420 696e 746f 2061 2068 756d 616e 2072  t into a human r
+0004f870: 6561 6461 626c 6520 666f 726d 2070 6970  eadable form pip
+0004f880: 6520 6f75 7470 7574 2074 6872 6f75 6768  e output through
+0004f890: 2073 6564 2022 0a20 2020 2020 2020 2022   sed ".        "
+0004f8a0: 616e 6420 6a71 2061 7320 7368 6f77 6e20  and jq as shown 
+0004f8b0: 696e 2061 6e20 6578 616d 706c 6520 696e  in an example in
+0004f8c0: 2074 6573 7473 2f74 6573 742d 7365 7467   tests/test-setg
+0004f8d0: 6574 2e73 682e 222c 0a20 2020 2029 0a20  et.sh.",.    ). 
+0004f8e0: 2020 2061 702e 6164 645f 6172 6775 6d65     ap.add_argume
+0004f8f0: 6e74 280a 2020 2020 2020 2020 222d 2d64  nt(.        "--d
+0004f900: 656c 6574 652d 6465 7669 6365 222c 0a20  elete-device",. 
+0004f910: 2020 2020 2020 2072 6571 7569 7265 643d         required=
+0004f920: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
+0004f930: 6374 696f 6e3d 2265 7874 656e 6422 2c0a  ction="extend",.
+0004f940: 2020 2020 2020 2020 6e61 7267 733d 222b          nargs="+
+0004f950: 222c 0a20 2020 2020 2020 2074 7970 653d  ",.        type=
+0004f960: 7374 722c 0a20 2020 2020 2020 206d 6574  str,.        met
+0004f970: 6176 6172 3d22 4445 5649 4345 222c 0a20  avar="DEVICE",. 
+0004f980: 2020 2020 2020 2068 656c 703d 6622 4465         help=f"De
+0004f990: 6c65 7465 206f 6e65 206f 7220 6d75 6c74  lete one or mult
+0004f9a0: 6970 6c65 2064 6576 6963 6573 2e20 220a  iple devices. ".
+0004f9b0: 2020 2020 2020 2020 2244 6574 6169 6c73          "Details
+0004f9c0: 3a3a 2042 7920 6465 6661 756c 7420 6465  :: By default de
+0004f9d0: 7669 6365 7320 6265 6c6f 6e67 696e 6720  vices belonging 
+0004f9e0: 220a 2020 2020 2020 2020 6622 746f 207b  ".        f"to {
+0004f9f0: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+0004fa00: 7d20 7769 6c6c 2062 6520 6465 6c65 7465  } will be delete
+0004fa10: 642e 2049 6620 7468 6520 6465 7669 6365  d. If the device
+0004fa20: 7320 6265 6c6f 6e67 2022 0a20 2020 2020  s belong ".     
+0004fa30: 2020 2022 746f 2061 2064 6966 6665 7265     "to a differe
+0004fa40: 6e74 2075 7365 722c 2075 7365 2074 6865  nt user, use the
+0004fa50: 202d 2d75 7365 7220 6172 6775 6d65 6e74   --user argument
+0004fa60: 2074 6f20 7370 6563 6966 7920 7468 6520   to specify the 
+0004fa70: 7573 6572 2c20 220a 2020 2020 2020 2020  user, ".        
+0004fa80: 2269 2e65 2e20 6f77 6e65 722e 204f 6e6c  "i.e. owner. Onl
+0004fa90: 7920 220a 2020 2020 2020 2020 2265 7861  y ".        "exa
+0004faa0: 6374 6c79 206f 6e65 2075 7365 7220 6361  ctly one user ca
+0004fab0: 6e20 6265 2073 7065 6369 6669 6564 2077  n be specified w
+0004fac0: 6974 6820 7468 6520 6f70 7469 6f6e 616c  ith the optional
+0004fad0: 202d 2d75 7365 7220 6172 6775 6d65 6e74   --user argument
+0004fae0: 2e20 220a 2020 2020 2020 2020 2244 6576  . ".        "Dev
+0004faf0: 6963 6520 6465 6c65 7469 6f6e 2072 6571  ice deletion req
+0004fb00: 7569 7265 7320 7468 6520 7573 6572 2070  uires the user p
+0004fb10: 6173 7377 6f72 642e 2049 7420 6d75 7374  assword. It must
+0004fb20: 2062 6520 7370 6563 6966 6965 6420 220a   be specified ".
+0004fb30: 2020 2020 2020 2020 2277 6974 6820 7468          "with th
+0004fb40: 6520 2d2d 7061 7373 776f 7264 2061 7267  e --password arg
+0004fb50: 756d 656e 742e 2049 6620 7468 6520 7365  ument. If the se
+0004fb60: 7276 6572 2075 7365 7320 6f6e 6c79 2048  rver uses only H
+0004fb70: 5454 5020 2861 6e64 2022 0a20 2020 2020  TTP (and ".     
+0004fb80: 2020 2022 6e6f 7420 4854 5450 5329 2c20     "not HTTPS), 
+0004fb90: 7468 656e 2074 6865 2070 6173 7377 6f72  then the passwor
+0004fba0: 6420 6361 6e20 6265 2076 6973 6962 6c65  d can be visible
+0004fbb0: 2074 6f20 6174 7461 636b 6572 732e 2048   to attackers. H
+0004fbc0: 656e 6365 2c20 220a 2020 2020 2020 2020  ence, ".        
+0004fbd0: 2269 6620 7468 6520 7365 7276 6572 2064  "if the server d
+0004fbe0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0004fbf0: 4854 5450 5320 7468 6973 206f 7065 7261  HTTPS this opera
+0004fc00: 7469 6f6e 2069 7320 6469 7363 6f75 7261  tion is discoura
+0004fc10: 6765 642e 222c 0a20 2020 2029 0a20 2020  ged.",.    ).   
+0004fc20: 2061 702e 6164 645f 6172 6775 6d65 6e74   ap.add_argument
+0004fc30: 280a 2020 2020 2020 2020 222d 2d72 6f6f  (.        "--roo
+0004fc40: 6d2d 7265 6461 6374 222c 0a20 2020 2020  m-redact",.     
+0004fc50: 2020 2022 2d2d 726f 6f6d 2d64 656c 6574     "--room-delet
+0004fc60: 652d 636f 6e74 656e 7422 2c0a 2020 2020  e-content",.    
+0004fc70: 2020 2020 7265 7175 6972 6564 3d46 616c      required=Fal
+0004fc80: 7365 2c0a 2020 2020 2020 2020 6163 7469  se,.        acti
+0004fc90: 6f6e 3d22 6578 7465 6e64 222c 0a20 2020  on="extend",.   
+0004fca0: 2020 2020 206e 6172 6773 3d22 2b22 2c0a       nargs="+",.
+0004fcb0: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+0004fcc0: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+0004fcd0: 723d 2252 4f4f 4d5f 4944 2045 5645 4e54  r="ROOM_ID EVENT
+0004fce0: 5f49 4420 5245 4153 4f4e 222c 0a20 2020  _ID REASON",.   
+0004fcf0: 2020 2020 2068 656c 703d 2253 7472 6970       help="Strip
+0004fd00: 2069 6e66 6f72 6d61 7469 6f6e 206f 7574   information out
+0004fd10: 206f 6620 6f6e 6520 6f72 2073 6576 6572   of one or sever
+0004fd20: 616c 2065 7665 6e74 732e 2022 0a20 2020  al events. ".   
+0004fd30: 2020 2020 2022 4465 7461 696c 733a 3a20       "Details:: 
+0004fd40: 220a 2020 2020 2020 2020 2253 7472 6970  ".        "Strip
+0004fd50: 2069 6e66 6f72 6d61 7469 6f6e 2066 726f   information fro
+0004fd60: 6d20 6576 656e 7473 2c20 652e 672e 206d  m events, e.g. m
+0004fd70: 6573 7361 6765 732e 2022 0a20 2020 2020  essages. ".     
+0004fd80: 2020 2022 5265 6461 6374 2069 7320 7573     "Redact is us
+0004fd90: 6564 2069 6e20 7468 6520 6d65 616e 696e  ed in the meanin
+0004fda0: 6720 6f66 2027 7374 7269 702c 2077 6970  g of 'strip, wip
+0004fdb0: 652c 2062 6c61 636b 2d6f 7574 272c 206e  e, black-out', n
+0004fdc0: 6f74 2022 0a20 2020 2020 2020 2022 696e  ot ".        "in
+0004fdd0: 2074 6865 206d 6561 6e69 6e67 206f 6620   the meaning of 
+0004fde0: 2765 6469 7427 2e20 5468 6973 2061 6374  'edit'. This act
+0004fdf0: 696f 6e20 7265 6d6f 7665 732c 2064 656c  ion removes, del
+0004fe00: 6574 6573 2074 6865 2063 6f6e 7465 6e74  etes the content
+0004fe10: 2022 0a20 2020 2020 2020 2022 6f66 2061   ".        "of a
+0004fe20: 6e20 6576 656e 7420 7768 696c 6520 6e6f  n event while no
+0004fe30: 7420 7265 6d6f 7669 6e67 2074 6865 2065  t removing the e
+0004fe40: 7665 6e74 2e20 596f 7520 6361 6e20 7769  vent. You can wi
+0004fe50: 7065 2074 6578 7420 6672 6f6d 2061 2022  pe text from a "
+0004fe60: 0a20 2020 2020 2020 2022 7072 6576 696f  .        "previo
+0004fe70: 7573 206d 6573 7361 6765 2c20 6574 632e  us message, etc.
+0004fe80: 2054 7970 6963 616c 204d 6174 7269 7820   Typical Matrix 
+0004fe90: 636c 6965 6e74 7320 6c69 6b65 2045 6c65  clients like Ele
+0004fea0: 6d65 6e74 2077 696c 6c20 220a 2020 2020  ment will ".    
+0004feb0: 2020 2020 2264 656c 6574 6520 6d65 7373      "delete mess
+0004fec0: 6167 6573 2c20 696d 6167 6573 2061 6e64  ages, images and
+0004fed0: 206f 7468 6572 206f 626a 6563 7473 2066   other objects f
+0004fee0: 726f 6d20 7468 6520 4755 4920 6f6e 6365  rom the GUI once
+0004fef0: 2074 6865 7920 220a 2020 2020 2020 2020   they ".        
+0004ff00: 2268 6176 6520 6265 656e 2072 6564 6163  "have been redac
+0004ff10: 7465 642e 2022 0a20 2020 2020 2020 2022  ted. ".        "
+0004ff20: 536f 2c20 2d2d 726f 6f6d 2d72 6564 6163  So, --room-redac
+0004ff30: 7420 6973 2061 2077 6179 2074 6f20 6465  t is a way to de
+0004ff40: 6c65 7465 2061 206d 6573 7361 6765 2c20  lete a message, 
+0004ff50: 696d 6167 6573 2c20 6574 632e 2022 0a20  images, etc. ". 
+0004ff60: 2020 2020 2020 2022 5468 6520 636f 6e74         "The cont
+0004ff70: 656e 7420 6973 2022 0a20 2020 2020 2020  ent is ".       
+0004ff80: 2022 7769 7065 642c 2074 6865 2047 5549   "wiped, the GUI
+0004ff90: 2064 656c 6574 6573 2074 6865 206d 6573   deletes the mes
+0004ffa0: 7361 6765 2c20 6275 7420 7468 6520 7365  sage, but the se
+0004ffb0: 7276 6572 206b 6565 7073 2074 6865 2065  rver keeps the e
+0004ffc0: 7665 6e74 2022 0a20 2020 2020 2020 2022  vent ".        "
+0004ffd0: 6869 7374 6f72 792e 204e 6f74 652c 2077  history. Note, w
+0004ffe0: 6869 6c65 2074 6869 7320 6465 6c65 7465  hile this delete
+0004fff0: 7320 6672 6f6d 2074 6865 2063 6c69 656e  s from the clien
+00050000: 7420 2847 5549 2c20 652e 672e 2022 0a20  t (GUI, e.g. ". 
+00050010: 2020 2020 2020 2022 456c 656d 656e 7429         "Element)
+00050020: 2c20 6974 2064 6f65 7320 6e6f 7420 6465  , it does not de
+00050030: 6c65 7465 2066 726f 6d20 7468 6520 6461  lete from the da
+00050040: 7461 6261 7365 206f 6e20 7468 6520 7365  tabase on the se
+00050050: 7276 6572 2e20 220a 2020 2020 2020 2020  rver. ".        
+00050060: 2253 6f2c 2074 6869 7320 6361 6c6c 2069  "So, this call i
+00050070: 7320 6e6f 7420 6120 7761 7920 746f 2063  s not a way to c
+00050080: 6c65 616e 2075 7020 7468 6520 7365 7276  lean up the serv
+00050090: 6572 2064 6174 6162 6173 652e 2022 0a20  er database. ". 
+000500a0: 2020 2020 2020 2022 4561 6368 2072 6564         "Each red
+000500b0: 6163 7420 2877 6970 652c 2073 7472 6970  act (wipe, strip
+000500c0: 2c20 6465 6c65 7465 2920 6f70 6572 6174  , delete) operat
+000500d0: 696f 6e20 7265 7175 6972 6573 2065 7861  ion requires exa
+000500e0: 6374 6c79 2033 2022 0a20 2020 2020 2020  ctly 3 ".       
+000500f0: 2022 6172 6775 6d65 6e74 732e 2022 0a20   "arguments. ". 
+00050100: 2020 2020 2020 2022 5468 6520 6172 6775         "The argu
+00050110: 6d65 6e74 2074 7269 706c 6573 2061 7265  ment triples are
+00050120: 3a20 220a 2020 2020 2020 2020 2228 6129  : ".        "(a)
+00050130: 2074 6865 2072 6f6f 6d20 6964 2e20 220a   the room id. ".
+00050140: 2020 2020 2020 2020 2228 6229 2074 6865          "(b) the
+00050150: 2069 6420 6f66 2074 6865 2065 7665 6e74   id of the event
+00050160: 2074 6f20 6265 2072 6564 6163 7465 642e   to be redacted.
+00050170: 2022 0a20 2020 2020 2020 2022 2863 2920   ".        "(c) 
+00050180: 6120 7374 7269 6e67 2063 6f6e 7461 696e  a string contain
+00050190: 696e 6720 7468 6520 7265 6173 6f6e 2066  ing the reason f
+000501a0: 6f72 2074 6865 2072 6564 6163 7469 6f6e  or the redaction
+000501b0: 2e20 5573 6520 2727 2069 6620 796f 7520  . Use '' if you 
+000501c0: 220a 2020 2020 2020 2020 2264 6f20 6e6f  ".        "do no
+000501d0: 7420 7761 6e74 2074 6f20 6769 7665 2061  t want to give a
+000501e0: 2072 6561 736f 6e2e 2022 0a20 2020 2020   reason. ".     
+000501f0: 2020 2022 536f 2c20 7468 6520 746f 7461     "So, the tota
+00050200: 6c20 6e75 6d62 6572 206f 6620 6172 6775  l number of argu
+00050210: 6d65 6e74 7320 7573 6564 2077 6974 6820  ments used with 
+00050220: 2d2d 726f 6f6d 2d72 6564 6163 7420 6d75  --room-redact mu
+00050230: 7374 2062 6520 6120 220a 2020 2020 2020  st be a ".      
+00050240: 2020 226d 756c 7469 706c 6520 6f66 2033    "multiple of 3
+00050250: 2c20 6275 7420 7765 2061 6c73 6f20 6163  , but we also ac
+00050260: 6365 7074 2032 2069 6e20 7768 6963 6820  cept 2 in which 
+00050270: 6361 7365 206f 6e6c 7920 6f6e 6520 220a  case only one ".
+00050280: 2020 2020 2020 2020 2272 6564 6163 7469          "redacti
+00050290: 6f6e 2077 696c 6c20 6265 2064 6f6e 6520  on will be done 
+000502a0: 7769 7468 6f75 7420 7370 6563 6966 7969  without specifyi
+000502b0: 6e67 2061 2072 6561 736f 6e2e 2022 0a20  ng a reason. ". 
+000502c0: 2020 2020 2020 2022 4576 656e 7420 6964         "Event id
+000502d0: 7320 7374 6172 7420 7769 7468 2074 6865  s start with the
+000502e0: 2064 6f6c 6c61 7220 7369 676e 2028 2429   dollar sign ($)
+000502f0: 2e20 4465 7065 6e64 696e 6720 6f6e 2079  . Depending on y
+00050300: 6f75 7220 7368 656c 6c2c 2022 0a20 2020  our shell, ".   
+00050310: 2020 2020 2022 796f 7520 6d69 6768 7420       "you might 
+00050320: 6861 7665 2074 6f20 6573 6361 7065 2074  have to escape t
+00050330: 6865 2027 2427 2074 6f20 275c 5c24 272e  he '$' to '\\$'.
+00050340: 202d 2d72 6f6f 6d2d 6465 6c65 7465 2d63   --room-delete-c
+00050350: 6f6e 7465 6e74 2069 7320 220a 2020 2020  ontent is ".    
+00050360: 2020 2020 2261 6e20 616c 6961 7320 666f      "an alias fo
+00050370: 7220 2d2d 726f 6f6d 2d72 6564 6163 742e  r --room-redact.
+00050380: 2054 6865 7920 6361 6e20 6265 2075 7365   They can be use
+00050390: 6420 696e 7465 7263 6861 6e67 6561 626c  d interchangeabl
+000503a0: 792e 222c 0a20 2020 2029 0a20 2020 2061  y.",.    ).    a
+000503b0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+000503c0: 2020 2020 2020 2020 2320 6e6f 2073 696e          # no sin
+000503d0: 676c 6520 6368 6172 2066 6c61 670a 2020  gle char flag.  
+000503e0: 2020 2020 2020 222d 2d77 686f 616d 6922        "--whoami"
+000503f0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+00050400: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+00050410: 2020 6163 7469 6f6e 3d22 7374 6f72 655f    action="store_
+00050420: 7472 7565 222c 0a20 2020 2020 2020 2068  true",.        h
+00050430: 656c 703d 2250 7269 6e74 2079 6f75 7220  elp="Print your 
+00050440: 7573 6572 2069 642e 2022 0a20 2020 2020  user id. ".     
+00050450: 2020 2066 2244 6574 6169 6c73 3a3a 2050     f"Details:: P
+00050460: 7269 6e74 2074 6865 2075 7365 7220 6964  rint the user id
+00050470: 2075 7365 6420 6279 207b 5052 4f47 5f57   used by {PROG_W
+00050480: 4954 484f 5554 5f45 5854 7d20 2869 7473  ITHOUT_EXT} (its
+00050490: 656c 6629 2e20 220a 2020 2020 2020 2020  elf). ".        
+000504a0: 224f 6e65 2063 616e 2067 6574 2022 0a20  "One can get ". 
+000504b0: 2020 2020 2020 2022 7468 6973 2069 6e66         "this inf
+000504c0: 6f72 6d61 7469 6f6e 2061 6c73 6f20 6279  ormation also by
+000504d0: 206c 6f6f 6b69 6e67 2061 7420 7468 6520   looking at the 
+000504e0: 6372 6564 656e 7469 616c 7320 6669 6c65  credentials file
+000504f0: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+00050500: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00050510: 2020 2020 2020 2023 206e 6f20 7369 6e67         # no sing
+00050520: 6c65 2063 6861 7220 666c 6167 0a20 2020  le char flag.   
+00050530: 2020 2020 2022 2d2d 6e6f 2d73 736c 222c       "--no-ssl",
+00050540: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+00050550: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+00050560: 2061 6374 696f 6e3d 2273 746f 7265 5f74   action="store_t
+00050570: 7275 6522 2c0a 2020 2020 2020 2020 6465  rue",.        de
+00050580: 6661 756c 743d 4e4f 5f53 534c 5f55 4e55  fault=NO_SSL_UNU
+00050590: 5345 445f 4445 4641 554c 542c 2020 2320  SED_DEFAULT,  # 
+000505a0: 7768 656e 206f 7074 696f 6e20 6973 6e27  when option isn'
+000505b0: 7420 7573 6564 0a20 2020 2020 2020 2068  t used.        h
+000505c0: 656c 703d 2253 6b69 7020 5353 4c20 7665  elp="Skip SSL ve
+000505d0: 7269 6669 6361 7469 6f6e 2e20 220a 2020  rification. ".  
+000505e0: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+000505f0: 2042 7920 6465 6661 756c 7420 2869 6620   By default (if 
+00050600: 7468 6973 206f 7074 696f 6e20 6973 206e  this option is n
+00050610: 6f74 2075 7365 6429 2022 0a20 2020 2020  ot used) ".     
+00050620: 2020 2022 7468 6520 5353 4c20 6365 7274     "the SSL cert
+00050630: 6966 6963 6174 6520 6973 2076 616c 6964  ificate is valid
+00050640: 6174 6564 2066 6f72 2074 6865 2063 6f6e  ated for the con
+00050650: 6e65 6374 696f 6e2e 2042 7574 2c20 6966  nection. But, if
+00050660: 2074 6869 7320 220a 2020 2020 2020 2020   this ".        
+00050670: 226f 7074 696f 6e20 6973 2075 7365 642c  "option is used,
+00050680: 2074 6865 6e20 7468 6520 5353 4c20 6365   then the SSL ce
+00050690: 7274 6966 6963 6174 6520 7661 6c69 6461  rtificate valida
+000506a0: 7469 6f6e 2077 696c 6c20 6265 2073 6b69  tion will be ski
+000506b0: 7070 6564 2e20 220a 2020 2020 2020 2020  pped. ".        
+000506c0: 2254 6869 7320 6973 2075 7365 6675 6c20  "This is useful 
+000506d0: 666f 7220 686f 6d65 2d73 6572 7665 7273  for home-servers
+000506e0: 2074 6861 7420 6861 7665 206e 6f20 5353   that have no SS
+000506f0: 4c20 6365 7274 6966 6963 6174 652e 2022  L certificate. "
+00050700: 0a20 2020 2020 2020 2027 4966 2075 7365  .        'If use
+00050710: 6420 746f 6765 7468 6572 2077 6974 6820  d together with 
+00050720: 7468 6520 222d 2d73 736c 2d63 6572 7469  the "--ssl-certi
+00050730: 6669 6361 7465 2220 270a 2020 2020 2020  ficate" '.      
+00050740: 2020 2270 6172 616d 6574 6572 2c20 7468    "parameter, th
+00050750: 6973 206f 7074 696f 6e20 6973 206d 6561  is option is mea
+00050760: 6e69 6e67 6c65 7373 2061 6e64 2061 6e20  ningless and an 
+00050770: 6572 726f 7220 7769 6c6c 2062 6520 7261  error will be ra
+00050780: 6973 6564 2e22 2c0a 2020 2020 290a 2020  ised.",.    ).  
+00050790: 2020 6170 2e61 6464 5f61 7267 756d 656e    ap.add_argumen
+000507a0: 7428 0a20 2020 2020 2020 2023 206e 6f20  t(.        # no 
+000507b0: 7369 6e67 6c65 2063 6861 7220 666c 6167  single char flag
+000507c0: 0a20 2020 2020 2020 2022 2d2d 7373 6c2d  .        "--ssl-
+000507d0: 6365 7274 6966 6963 6174 6522 2c0a 2020  certificate",.  
+000507e0: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+000507f0: 616c 7365 2c0a 2020 2020 2020 2020 7479  alse,.        ty
+00050800: 7065 3d73 7472 2c0a 2020 2020 2020 2020  pe=str,.        
+00050810: 6465 6661 756c 743d 5353 4c5f 4345 5254  default=SSL_CERT
+00050820: 4946 4943 4154 455f 4445 4641 554c 542c  IFICATE_DEFAULT,
+00050830: 2020 2320 7768 656e 206f 7074 696f 6e20    # when option 
+00050840: 6973 6e27 7420 7573 6564 0a20 2020 2020  isn't used.     
+00050850: 2020 206d 6574 6176 6172 3d22 5353 4c5f     metavar="SSL_
+00050860: 4345 5254 4946 4943 4154 455f 4649 4c45  CERTIFICATE_FILE
+00050870: 222c 0a20 2020 2020 2020 2068 656c 703d  ",.        help=
+00050880: 2255 7365 2079 6f75 7220 6f77 6e20 5353  "Use your own SS
+00050890: 4c20 6365 7274 6966 6963 6174 652e 2022  L certificate. "
+000508a0: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+000508b0: 733a 3a20 5573 6520 7468 6973 206f 7074  s:: Use this opt
+000508c0: 696f 6e20 746f 2075 7365 2022 0a20 2020  ion to use ".   
+000508d0: 2020 2020 2022 796f 7572 206f 776e 206c       "your own l
+000508e0: 6f63 616c 2053 534c 2063 6572 7469 6669  ocal SSL certifi
+000508f0: 6361 7465 2066 696c 652e 2022 0a20 2020  cate file. ".   
+00050900: 2020 2020 2022 5468 6973 2069 7320 616e       "This is an
+00050910: 206f 7074 696f 6e61 6c20 7061 7261 6d65   optional parame
+00050920: 7465 722e 2054 6869 7320 6973 2075 7365  ter. This is use
+00050930: 6675 6c20 666f 7220 686f 6d65 2073 6572  ful for home ser
+00050940: 7665 7273 2074 6861 7420 220a 2020 2020  vers that ".    
+00050950: 2020 2020 2268 6176 6520 7468 6569 7220      "have their 
+00050960: 6f77 6e20 220a 2020 2020 2020 2020 2253  own ".        "S
+00050970: 534c 2063 6572 7469 6669 6361 7465 2e20  SL certificate. 
+00050980: 5468 6973 2061 6c6c 6f77 7320 796f 7520  This allows you 
+00050990: 746f 2075 7365 2048 5454 5053 2f54 4c53  to use HTTPS/TLS
+000509a0: 2066 6f72 2074 6865 2063 6f6e 6e65 6374   for the connect
+000509b0: 696f 6e20 220a 2020 2020 2020 2020 2277  ion ".        "w
+000509c0: 6869 6c65 2075 7369 6e67 2079 6f75 7220  hile using your 
+000509d0: 6f77 6e20 6c6f 6361 6c20 5353 4c20 6365  own local SSL ce
+000509e0: 7274 6966 6963 6174 652e 2053 7065 6369  rtificate. Speci
+000509f0: 6679 2074 6865 2070 6174 6820 616e 6420  fy the path and 
+00050a00: 220a 2020 2020 2020 2020 2766 696c 6520  ".        'file 
+00050a10: 746f 2079 6f75 7220 5353 4c20 6365 7274  to your SSL cert
+00050a20: 6966 6963 6174 652e 2049 6620 7573 6564  ificate. If used
+00050a30: 2074 6f67 6574 6865 7220 7769 7468 2074   together with t
+00050a40: 6865 2022 2d2d 6e6f 2d73 736c 2220 270a  he "--no-ssl" '.
+00050a50: 2020 2020 2020 2020 2270 6172 616d 6574          "paramet
+00050a60: 6572 2c20 7468 6973 206f 7074 696f 6e20  er, this option 
+00050a70: 6973 206d 6561 6e69 6e67 6c65 7373 2061  is meaningless a
+00050a80: 6e64 2061 6e20 6572 726f 7220 7769 6c6c  nd an error will
+00050a90: 2062 6520 7261 6973 6564 2e22 2c0a 2020   be raised.",.  
+00050aa0: 2020 290a 2020 2020 6170 2e61 6464 5f61    ).    ap.add_a
+00050ab0: 7267 756d 656e 7428 0a20 2020 2020 2020  rgument(.       
+00050ac0: 2022 2d2d 6669 6c65 2d6e 616d 6522 2c0a   "--file-name",.
+00050ad0: 2020 2020 2020 2020 7265 7175 6972 6564          required
+00050ae0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00050af0: 6163 7469 6f6e 3d22 6578 7465 6e64 222c  action="extend",
+00050b00: 0a20 2020 2020 2020 206e 6172 6773 3d22  .        nargs="
+00050b10: 2b22 2c0a 2020 2020 2020 2020 7479 7065  +",.        type
+00050b20: 3d73 7472 2c0a 2020 2020 2020 2020 6d65  =str,.        me
+00050b30: 7461 7661 723d 2246 494c 4522 2c0a 2020  tavar="FILE",.  
+00050b40: 2020 2020 2020 6865 6c70 3d22 5370 6563        help="Spec
+00050b50: 6966 7920 6f6e 6520 6f72 206d 756c 7469  ify one or multi
+00050b60: 706c 6520 6669 6c65 206e 616d 6573 2066  ple file names f
+00050b70: 6f72 2073 6f6d 6520 6163 7469 6f6e 732e  or some actions.
+00050b80: 2022 0a20 2020 2020 2020 2022 4465 7461   ".        "Deta
+00050b90: 696c 733a 3a20 5468 6973 2069 7320 616e  ils:: This is an
+00050ba0: 206f 7074 696f 6e61 6c20 6172 6775 6d65   optional argume
+00050bb0: 6e74 2e20 5573 6520 7468 6973 206f 7074  nt. Use this opt
+00050bc0: 696f 6e20 220a 2020 2020 2020 2020 2269  ion ".        "i
+00050bd0: 6e20 636f 6d62 696e 6174 696f 6e20 7769  n combination wi
+00050be0: 7468 206f 7074 696f 6e73 206c 696b 6520  th options like 
+00050bf0: 2d2d 646f 776e 6c6f 6164 2074 6f20 7370  --download to sp
+00050c00: 6563 6966 7920 6f6e 6520 6f72 2022 0a20  ecify one or ". 
+00050c10: 2020 2020 2020 2022 6d75 6c74 6970 6c65         "multiple
+00050c20: 2066 696c 6520 6e61 6d65 732e 2022 0a20   file names. ". 
+00050c30: 2020 2020 2020 2022 4967 6e6f 7265 6420         "Ignored 
+00050c40: 6966 2075 7365 6420 6279 2069 7473 656c  if used by itsel
+00050c50: 6620 7769 7468 6f75 7420 616e 2061 7070  f without an app
+00050c60: 726f 7072 6961 7465 2063 6f72 7265 7370  ropriate corresp
+00050c70: 6f6e 6469 6e67 2022 0a20 2020 2020 2020  onding ".       
+00050c80: 2022 6163 7469 6f6e 2e22 2c0a 2020 2020   "action.",.    
+00050c90: 290a 2020 2020 6170 2e61 6464 5f61 7267  ).    ap.add_arg
+00050ca0: 756d 656e 7428 0a20 2020 2020 2020 2022  ument(.        "
+00050cb0: 2d2d 6b65 792d 6469 6374 222c 0a20 2020  --key-dict",.   
+00050cc0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+00050cd0: 6c73 652c 0a20 2020 2020 2020 2061 6374  lse,.        act
+00050ce0: 696f 6e3d 2265 7874 656e 6422 2c0a 2020  ion="extend",.  
+00050cf0: 2020 2020 2020 6e61 7267 733d 222b 222c        nargs="+",
+00050d00: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+00050d10: 722c 0a20 2020 2020 2020 206d 6574 6176  r,.        metav
+00050d20: 6172 3d22 4b45 595f 4449 4354 494f 4e41  ar="KEY_DICTIONA
+00050d30: 5259 222c 0a20 2020 2020 2020 2068 656c  RY",.        hel
+00050d40: 703d 2253 7065 6369 6679 206f 6e65 206f  p="Specify one o
+00050d50: 7220 6d75 6c74 6970 6c65 206b 6579 2064  r multiple key d
+00050d60: 6963 7469 6f6e 6172 6965 7320 666f 7220  ictionaries for 
+00050d70: 6465 6372 7970 7469 6f6e 2e20 220a 2020  decryption. ".  
+00050d80: 2020 2020 2020 2244 6574 6169 6c73 3a3a        "Details::
+00050d90: 204f 6e65 206f 7220 6d75 6c74 6970 6c65   One or multiple
+00050da0: 2064 6563 7279 7074 696f 6e20 220a 2020   decryption ".  
+00050db0: 2020 2020 2020 2264 6963 7469 6f6e 6172        "dictionar
+00050dc0: 6965 7320 6172 6520 7072 6f76 6964 6564  ies are provided
+00050dd0: 2062 7920 7468 6520 2d2d 7570 6c6f 6164   by the --upload
+00050de0: 2061 6374 696f 6e20 6173 2061 2072 6573   action as a res
+00050df0: 756c 742e 2022 0a20 2020 2020 2020 2022  ult. ".        "
+00050e00: 4120 6465 6372 7970 7469 6f6e 2064 6963  A decryption dic
+00050e10: 7469 6f6e 6172 7920 6973 2061 2073 7472  tionary is a str
+00050e20: 696e 6720 6c69 6b65 2074 6869 733a 2022  ing like this: "
+00050e30: 0a20 2020 2020 2020 2022 5c22 7b27 7627  .        "\"{'v'
+00050e40: 3a20 2776 3227 2c20 276b 6579 273a 207b  : 'v2', 'key': {
+00050e50: 276b 7479 273a 2027 6f63 7427 2c20 2761  'kty': 'oct', 'a
+00050e60: 6c67 273a 2027 4132 3536 4354 5227 2c20  lg': 'A256CTR', 
+00050e70: 2765 7874 273a 2054 7275 652c 2022 0a20  'ext': True, ". 
+00050e80: 2020 2020 2020 2022 276b 273a 2027 736f         "'k': 'so
+00050e90: 6d65 6b65 7927 2c20 276b 6579 5f6f 7073  mekey', 'key_ops
+00050ea0: 273a 205b 2765 6e63 7279 7074 272c 2027  ': ['encrypt', '
+00050eb0: 6465 6372 7970 7427 5d7d 2c20 220a 2020  decrypt']}, ".  
+00050ec0: 2020 2020 2020 2227 6976 273a 2027 736f        "'iv': 'so
+00050ed0: 6d65 6976 272c 2027 6861 7368 6573 273a  meiv', 'hashes':
+00050ee0: 207b 2773 6861 3235 3627 3a20 2773 6f6d   {'sha256': 'som
+00050ef0: 6553 4841 277d 7d5c 222e 2049 6620 796f  eSHA'}}\". If yo
+00050f00: 7520 6861 7665 2061 2022 0a20 2020 2020  u have a ".     
+00050f10: 2020 2022 6c69 7374 206f 6620 6b65 7920     "list of key 
+00050f20: 6469 6374 696f 6e61 7269 6573 2061 6e64  dictionaries and
+00050f30: 2077 616e 7420 746f 2073 6b69 7020 6f6e   want to skip on
+00050f40: 652c 2075 7365 2074 6865 2065 6d70 7479  e, use the empty
+00050f50: 2073 7472 696e 672e 222c 0a20 2020 2029   string.",.    )
+00050f60: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00050f70: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+00050f80: 2d70 6c61 696e 222c 0a20 2020 2020 2020  -plain",.       
+00050f90: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+00050fa0: 0a20 2020 2020 2020 2061 6374 696f 6e3d  .        action=
+00050fb0: 2273 746f 7265 5f74 7275 6522 2c0a 2020  "store_true",.  
+00050fc0: 2020 2020 2020 6865 6c70 3d22 4469 7361        help="Disa
+00050fd0: 626c 6520 656e 6372 7970 7469 6f6e 2066  ble encryption f
+00050fe0: 6f72 2061 2073 7065 6369 6669 6320 6163  or a specific ac
+00050ff0: 7469 6f6e 2e20 220a 2020 2020 2020 2020  tion. ".        
+00051000: 2244 6574 6169 6c73 3a3a 2042 7920 6465  "Details:: By de
+00051010: 6661 756c 742c 2022 0a20 2020 2020 2020  fault, ".       
+00051020: 2022 6576 6572 7974 6869 6e67 2069 7320   "everything is 
+00051030: 616c 7761 7973 2065 6e63 7279 7074 6564  always encrypted
+00051040: 2e20 220a 2020 2020 2020 2020 2241 6374  . ".        "Act
+00051050: 696f 6e73 2074 6861 7420 7375 7070 6f72  ions that suppor
+00051060: 7420 7468 6973 206f 7074 696f 6e20 6172  t this option ar
+00051070: 653a 202d 2d75 706c 6f61 642c 202d 2d72  e: --upload, --r
+00051080: 6f6f 6d2d 6372 6561 7465 2c20 220a 2020  oom-create, ".  
+00051090: 2020 2020 2020 2261 6e64 202d 2d72 6f6f        "and --roo
+000510a0: 6d2d 646d 2d63 7265 6174 652e 2022 0a20  m-dm-create. ". 
+000510b0: 2020 2020 2020 2022 526f 6f6d 7320 6172         "Rooms ar
+000510c0: 6520 6279 2064 6566 6175 6c74 2063 7265  e by default cre
+000510d0: 6174 6564 2065 6e63 7279 7074 6564 3b20  ated encrypted; 
+000510e0: 220a 2020 2020 2020 2020 2274 6f20 6f76  ".        "to ov
+000510f0: 6572 7772 6974 6520 7468 6174 2061 6e64  erwrite that and
+00051100: 2074 6f20 6372 6561 7465 2061 2072 6f6f   to create a roo
+00051110: 6d20 7769 7468 2065 6e63 7279 7074 696f  m with encryptio
+00051120: 6e20 6469 7361 626c 6564 2022 0a20 2020  n disabled ".   
+00051130: 2020 2020 2022 7573 6520 272d 2d70 6c61       "use '--pla
+00051140: 696e 272e 2053 6565 2074 6865 2069 6e64  in'. See the ind
+00051150: 6976 6964 7561 6c20 636f 6d6d 616e 6473  ividual commands
+00051160: 2e22 2c0a 2020 2020 290a 2020 2020 6170  .",.    ).    ap
+00051170: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00051180: 2020 2020 2020 2022 2d2d 7365 7061 7261         "--separa
+00051190: 746f 7222 2c0a 2020 2020 2020 2020 7265  tor",.        re
+000511a0: 7175 6972 6564 3d46 616c 7365 2c0a 2020  quired=False,.  
+000511b0: 2020 2020 2020 7479 7065 3d73 7472 2c0a        type=str,.
+000511c0: 2020 2020 2020 2020 6465 6661 756c 743d          default=
+000511d0: 4445 4641 554c 545f 5345 5041 5241 544f  DEFAULT_SEPARATO
+000511e0: 522c 2020 2320 6465 6661 756c 7473 2074  R,  # defaults t
+000511f0: 6f20 5345 5020 6966 206e 6f74 2075 7365  o SEP if not use
+00051200: 640a 2020 2020 2020 2020 2320 5465 7874  d.        # Text
+00051210: 2069 7320 7363 616e 6e65 6420 616e 6420   is scanned and 
+00051220: 7265 7065 6174 6564 2073 7061 6365 7320  repeated spaces 
+00051230: 6172 6520 7265 6d6f 7665 732c 2073 6f20  are removes, so 
+00051240: 2220 2020 2022 0a20 2020 2020 2020 2023  "    ".        #
+00051250: 206f 7220 7b44 4546 4155 4c54 5f53 4550   or {DEFAULT_SEP
+00051260: 4152 4154 4f52 7d20 7769 6c6c 2062 6520  ARATOR} will be 
+00051270: 7472 756e 6361 7465 6420 746f 2022 2022  truncated to " "
+00051280: 2e20 4865 6e63 6520 2234 2073 7061 6365  . Hence "4 space
+00051290: 7322 0a20 2020 2020 2020 206d 6574 6176  s".        metav
+000512a0: 6172 3d22 5345 5041 5241 544f 5222 2c0a  ar="SEPARATOR",.
+000512b0: 2020 2020 2020 2020 6865 6c70 3d22 5365          help="Se
+000512c0: 7420 6120 6375 7374 6f6d 2073 6570 6172  t a custom separ
+000512d0: 6174 6f72 2075 7365 6420 666f 7220 6365  ator used for ce
+000512e0: 7274 6169 6e20 7072 696e 7420 6f75 7473  rtain print outs
+000512f0: 2e20 220a 2020 2020 2020 2020 2244 6574  . ".        "Det
+00051300: 6169 6c73 3a3a 2042 7920 6465 6661 756c  ails:: By defaul
+00051310: 742c 2069 2e65 2e20 6966 202d 2d73 6570  t, i.e. if --sep
+00051320: 6172 6174 6f72 2069 7320 6e6f 7420 7573  arator is not us
+00051330: 6564 2c20 220a 2020 2020 2020 2020 2234  ed, ".        "4
+00051340: 2073 7061 6365 7320 6172 6520 7573 6564   spaces are used
+00051350: 2061 7320 220a 2020 2020 2020 2020 2273   as ".        "s
+00051360: 6570 6172 6174 6f72 2062 6574 7765 656e  eparator between
+00051370: 2063 6f6c 756d 6e73 2069 6e20 7072 696e   columns in prin
+00051380: 7420 7374 6174 656d 656e 7473 2e20 596f  t statements. Yo
+00051390: 7520 636f 756c 6420 7365 7420 220a 2020  u could set ".  
+000513a0: 2020 2020 2020 2269 7420 746f 2027 5c5c        "it to '\\
+000513b0: 7427 2069 6620 796f 7520 7072 6566 6572  t' if you prefer
+000513c0: 2061 2074 6162 2c20 6275 7420 7461 6273   a tab, but tabs
+000513d0: 2061 7265 2075 7375 616c 6c79 2072 6570   are usually rep
+000513e0: 6c61 6365 6420 220a 2020 2020 2020 2020  laced ".        
+000513f0: 2277 6974 6820 7370 6163 6573 2062 7920  "with spaces by 
+00051400: 7468 6520 7465 726d 696e 616c 2e20 536f  the terminal. So
+00051410: 2c20 7468 6174 206d 6967 6874 206e 6f74  , that might not
+00051420: 2067 6976 6520 796f 7520 7768 6174 2079   give you what y
+00051430: 6f75 2022 0a20 2020 2020 2020 2022 7761  ou ".        "wa
+00051440: 6e74 2e20 4d61 7962 6520 2720 7c7c 2027  nt. Maybe ' || '
+00051450: 2069 7320 616e 2061 6c74 6572 6e61 7469   is an alternati
+00051460: 7665 2063 686f 6963 652e 222c 0a20 2020  ve choice.",.   
+00051470: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+00051480: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+00051490: 222d 2d61 6363 6573 732d 746f 6b65 6e22  "--access-token"
+000514a0: 2c0a 2020 2020 2020 2020 7265 7175 6972  ,.        requir
+000514b0: 6564 3d46 616c 7365 2c0a 2020 2020 2020  ed=False,.      
+000514c0: 2020 7479 7065 3d73 7472 2c0a 2020 2020    type=str,.    
+000514d0: 2020 2020 6d65 7461 7661 723d 2241 4343      metavar="ACC
+000514e0: 4553 535f 544f 4b45 4e22 2c0a 2020 2020  ESS_TOKEN",.    
+000514f0: 2020 2020 6865 6c70 3d22 5365 7420 6120      help="Set a 
+00051500: 6375 7374 6f6d 2061 6363 6573 7320 746f  custom access to
+00051510: 6b65 6e20 666f 7220 7573 6520 6279 2063  ken for use by c
+00051520: 6572 7461 696e 2061 6374 696f 6e73 2e20  ertain actions. 
+00051530: 220a 2020 2020 2020 2020 2244 6574 6169  ".        "Detai
+00051540: 6c73 3a3a 2049 7420 6973 2061 6e20 6f70  ls:: It is an op
+00051550: 7469 6f6e 616c 2061 7267 756d 656e 742e  tional argument.
+00051560: 2022 0a20 2020 2020 2020 2022 4279 2064   ".        "By d
+00051570: 6566 6175 6c74 202d 2d61 6363 6573 732d  efault --access-
+00051580: 746f 6b65 6e20 6973 2069 676e 6f72 6564  token is ignored
+00051590: 2061 6e64 206e 6f74 2075 7365 642e 2022   and not used. "
+000515a0: 0a20 2020 2020 2020 2022 4974 2069 7320  .        "It is 
+000515b0: 7573 6564 2062 7920 7468 6520 2d2d 6465  used by the --de
+000515c0: 6c65 7465 2d6d 7863 2c20 2d2d 6465 6c65  lete-mxc, --dele
+000515d0: 7465 2d6d 7863 2d62 6566 6f72 652c 2022  te-mxc-before, "
+000515e0: 0a20 2020 2020 2020 2022 616e 6420 2d2d  .        "and --
+000515f0: 7265 7374 2061 6374 696f 6e73 2e22 2c0a  rest actions.",.
+00051600: 2020 2020 290a 2020 2020 6170 2e61 6464      ).    ap.add
+00051610: 5f61 7267 756d 656e 7428 0a20 2020 2020  _argument(.     
+00051620: 2020 2022 2d2d 7061 7373 776f 7264 222c     "--password",
+00051630: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+00051640: 643d 4661 6c73 652c 0a20 2020 2020 2020  d=False,.       
+00051650: 2074 7970 653d 7374 722c 0a20 2020 2020   type=str,.     
+00051660: 2020 206d 6574 6176 6172 3d22 5041 5353     metavar="PASS
+00051670: 574f 5244 222c 0a20 2020 2020 2020 2068  WORD",.        h
+00051680: 656c 703d 2253 7065 6369 6679 2061 2070  elp="Specify a p
+00051690: 6173 7377 6f72 6420 666f 7220 7573 6520  assword for use 
+000516a0: 6279 2063 6572 7461 696e 2061 6374 696f  by certain actio
+000516b0: 6e73 2e20 220a 2020 2020 2020 2020 2244  ns. ".        "D
+000516c0: 6574 6169 6c73 3a3a 2049 7420 6973 2061  etails:: It is a
+000516d0: 6e20 6f70 7469 6f6e 616c 2061 7267 756d  n optional argum
+000516e0: 656e 742e 2022 0a20 2020 2020 2020 2022  ent. ".        "
+000516f0: 4279 2064 6566 6175 6c74 202d 2d70 6173  By default --pas
+00051700: 7377 6f72 6420 6973 2069 676e 6f72 6564  sword is ignored
+00051710: 2061 6e64 206e 6f74 2075 7365 642e 2022   and not used. "
+00051720: 0a20 2020 2020 2020 2022 4974 2069 7320  .        "It is 
+00051730: 7573 6564 2062 7920 272d 2d6c 6f67 696e  used by '--login
+00051740: 2070 6173 7377 6f72 6427 2061 6e64 2027   password' and '
+00051750: 2d2d 6465 6c65 7465 2d64 6576 6963 6527  --delete-device'
+00051760: 2022 0a20 2020 2020 2020 2022 6163 7469   ".        "acti
+00051770: 6f6e 732e 2022 0a20 2020 2020 2020 2022  ons. ".        "
+00051780: 4966 206e 6f74 2070 726f 7669 6465 6420  If not provided 
+00051790: 666f 7220 2d2d 6c6f 6769 6e20 7468 6520  for --login the 
+000517a0: 7573 6572 2077 696c 6c20 6265 2071 7565  user will be que
+000517b0: 7269 6564 2076 6961 206b 6579 626f 6172  ried via keyboar
+000517c0: 642e 222c 0a20 2020 2029 0a20 2020 2061  d.",.    ).    a
+000517d0: 702e 6164 645f 6172 6775 6d65 6e74 280a  p.add_argument(.
+000517e0: 2020 2020 2020 2020 222d 2d68 6f6d 6573          "--homes
+000517f0: 6572 7665 7222 2c0a 2020 2020 2020 2020  erver",.        
+00051800: 7265 7175 6972 6564 3d46 616c 7365 2c0a  required=False,.
+00051810: 2020 2020 2020 2020 7479 7065 3d73 7472          type=str
+00051820: 2c0a 2020 2020 2020 2020 6d65 7461 7661  ,.        metava
+00051830: 723d 2248 4f4d 4553 4552 5645 525f 5552  r="HOMESERVER_UR
+00051840: 4c22 2c0a 2020 2020 2020 2020 6865 6c70  L",.        help
+00051850: 3d22 5370 6563 6966 7920 6120 686f 6d65  ="Specify a home
+00051860: 7365 7276 6572 2066 6f72 2075 7365 2062  server for use b
+00051870: 7920 6365 7274 6169 6e20 6163 7469 6f6e  y certain action
+00051880: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
+00051890: 7461 696c 733a 3a20 4974 2069 7320 616e  tails:: It is an
+000518a0: 206f 7074 696f 6e61 6c20 6172 6775 6d65   optional argume
+000518b0: 6e74 2e20 220a 2020 2020 2020 2020 2242  nt. ".        "B
+000518c0: 7920 6465 6661 756c 7420 2d2d 686f 6d65  y default --home
+000518d0: 7365 7276 6572 2069 7320 6967 6e6f 7265  server is ignore
+000518e0: 6420 616e 6420 6e6f 7420 7573 6564 2e20  d and not used. 
+000518f0: 220a 2020 2020 2020 2020 2249 7420 6973  ".        "It is
+00051900: 2075 7365 6420 6279 2027 2d2d 6c6f 6769   used by '--logi
+00051910: 6e27 2061 6374 696f 6e2e 2022 0a20 2020  n' action. ".   
+00051920: 2020 2020 2022 4966 206e 6f74 2070 726f       "If not pro
+00051930: 7669 6465 6420 666f 7220 2d2d 6c6f 6769  vided for --logi
+00051940: 6e20 7468 6520 7573 6572 2077 696c 6c20  n the user will 
+00051950: 6265 2071 7565 7269 6564 2076 6961 206b  be queried via k
+00051960: 6579 626f 6172 642e 222c 0a20 2020 2029  eyboard.",.    )
+00051970: 0a20 2020 2061 702e 6164 645f 6172 6775  .    ap.add_argu
+00051980: 6d65 6e74 280a 2020 2020 2020 2020 222d  ment(.        "-
+00051990: 2d64 6576 6963 6522 2c20 2023 2064 6f20  -device",  # do 
+000519a0: 6e6f 7420 636f 6e66 7573 6520 7769 7468  not confuse with
+000519b0: 202d 2d64 6576 6963 6573 0a20 2020 2020   --devices.     
+000519c0: 2020 2072 6571 7569 7265 643d 4661 6c73     required=Fals
+000519d0: 652c 0a20 2020 2020 2020 2074 7970 653d  e,.        type=
+000519e0: 7374 722c 2020 2320 6465 7669 6365 2069  str,  # device i
+000519f0: 642c 2064 6576 6963 6520 6e61 6d65 0a20  d, device name. 
+00051a00: 2020 2020 2020 206d 6574 6176 6172 3d22         metavar="
+00051a10: 4445 5649 4345 5f4e 414d 4522 2c0a 2020  DEVICE_NAME",.  
+00051a20: 2020 2020 2020 6865 6c70 3d22 5370 6563        help="Spec
+00051a30: 6966 7920 6120 6465 7669 6365 206e 616d  ify a device nam
+00051a40: 652c 2066 6f72 2075 7365 2062 7920 6365  e, for use by ce
+00051a50: 7274 6169 6e20 6163 7469 6f6e 732e 2022  rtain actions. "
+00051a60: 0a20 2020 2020 2020 2022 4465 7461 696c  .        "Detail
+00051a70: 733a 3a20 4974 2069 7320 616e 206f 7074  s:: It is an opt
+00051a80: 696f 6e61 6c20 6172 6775 6d65 6e74 2e20  ional argument. 
+00051a90: 220a 2020 2020 2020 2020 2242 7920 6465  ".        "By de
+00051aa0: 6661 756c 7420 2d2d 6465 7669 6365 2069  fault --device i
+00051ab0: 7320 6967 6e6f 7265 6420 616e 6420 6e6f  s ignored and no
+00051ac0: 7420 7573 6564 2e20 220a 2020 2020 2020  t used. ".      
+00051ad0: 2020 2249 7420 6973 2075 7365 6420 6279    "It is used by
+00051ae0: 2027 2d2d 6c6f 6769 6e27 2061 6374 696f   '--login' actio
+00051af0: 6e2e 2022 0a20 2020 2020 2020 2022 4966  n. ".        "If
+00051b00: 206e 6f74 2070 726f 7669 6465 6420 666f   not provided fo
+00051b10: 7220 2d2d 6c6f 6769 6e20 7468 6520 7573  r --login the us
+00051b20: 6572 2077 696c 6c20 6265 2071 7565 7269  er will be queri
+00051b30: 6564 2076 6961 206b 6579 626f 6172 642e  ed via keyboard.
+00051b40: 2022 0a20 2020 2020 2020 2022 4966 2079   ".        "If y
+00051b50: 6f75 2077 616e 7420 7468 6520 6465 6661  ou want the defa
+00051b60: 756c 7420 7661 6c75 6520 7370 6563 6966  ult value specif
+00051b70: 7920 2727 2e20 220a 2020 2020 2020 2020  y ''. ".        
+00051b80: 224d 756c 7469 706c 6520 6465 7669 6365  "Multiple device
+00051b90: 7320 2877 6974 6820 6469 6666 6572 656e  s (with differen
+00051ba0: 7420 6465 7669 6365 2069 6429 206d 6179  t device id) may
+00051bb0: 2068 6176 6520 7468 6520 7361 6d65 2064   have the same d
+00051bc0: 6576 6963 6520 220a 2020 2020 2020 2020  evice ".        
+00051bd0: 226e 616d 652e 2049 6e20 7368 6f72 742c  "name. In short,
+00051be0: 2074 6865 2073 616d 6520 6465 7669 6365   the same device
+00051bf0: 206e 616d 6520 6361 6e20 6265 2061 7373   name can be ass
+00051c00: 6967 6e65 6420 746f 206d 756c 7469 706c  igned to multipl
+00051c10: 6520 220a 2020 2020 2020 2020 2264 6966  e ".        "dif
+00051c20: 6665 7265 6e74 2064 6576 6963 6573 2069  ferent devices i
+00051c30: 6620 6465 7369 7265 642e 222c 0a20 2020  f desired.",.   
+00051c40: 2029 0a20 2020 2061 702e 6164 645f 6172   ).    ap.add_ar
+00051c50: 6775 6d65 6e74 280a 2020 2020 2020 2020  gument(.        
+00051c60: 222d 2d73 796e 6322 2c0a 2020 2020 2020  "--sync",.      
+00051c70: 2020 7265 7175 6972 6564 3d46 616c 7365    required=False
+00051c80: 2c0a 2020 2020 2020 2020 7479 7065 3d73  ,.        type=s
+00051c90: 7472 2c20 2023 2073 796e 6320 6d65 7468  tr,  # sync meth
+00051ca0: 6f64 3a20 6f66 662c 2066 756c 6c2c 2028  od: off, full, (
+00051cb0: 7061 7274 6961 6c29 0a20 2020 2020 2020  partial).       
+00051cc0: 206d 6574 6176 6172 3d22 4655 4c4c 7c4f   metavar="FULL|O
+00051cd0: 4646 222c 0a20 2020 2020 2020 2068 656c  FF",.        hel
+00051ce0: 703d 2243 686f 6f73 6520 7379 6e63 6872  p="Choose synchr
+00051cf0: 6f6e 697a 6174 696f 6e20 6f70 7469 6f6e  onization option
+00051d00: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
+00051d10: 7461 696c 733a 3a20 5468 6973 206f 7074  tails:: This opt
+00051d20: 696f 6e20 6465 6369 6465 7320 6f6e 2077  ion decides on w
+00051d30: 6865 7468 6572 2074 6865 2070 726f 6772  hether the progr
+00051d40: 616d 2022 0a20 2020 2020 2020 2022 7379  am ".        "sy
+00051d50: 6e63 6872 6f6e 697a 6573 2074 6865 2073  nchronizes the s
+00051d60: 7461 7465 2077 6974 6820 7468 6520 7365  tate with the se
+00051d70: 7276 6572 2062 6566 6f72 6520 6120 2773  rver before a 's
+00051d80: 656e 6427 2061 6374 696f 6e2e 2022 0a20  end' action. ". 
+00051d90: 2020 2020 2020 2066 2243 7572 7265 6e74         f"Current
+00051da0: 6c79 2074 776f 2063 686f 6963 6573 2061  ly two choices a
+00051db0: 7265 206f 6666 6572 6564 3a20 277b 5359  re offered: '{SY
+00051dc0: 4e43 5f46 554c 4c7d 2720 616e 6420 277b  NC_FULL}' and '{
+00051dd0: 5359 4e43 5f4f 4646 7d27 2e20 220a 2020  SYNC_OFF}'. ".  
+00051de0: 2020 2020 2020 2250 726f 7669 6465 206f        "Provide o
+00051df0: 6e65 206f 6620 7468 6573 6520 6368 6f69  ne of these choi
+00051e00: 6365 732e 2022 0a20 2020 2020 2020 2066  ces. ".        f
+00051e10: 2254 6865 2064 6566 6175 6c74 2069 7320  "The default is 
+00051e20: 277b 5359 4e43 5f44 4546 4155 4c54 7d27  '{SYNC_DEFAULT}'
+00051e30: 2e20 4966 2079 6f75 2077 616e 7420 746f  . If you want to
+00051e40: 2075 7365 2074 6865 2064 6566 6175 6c74   use the default
+00051e50: 2c20 220a 2020 2020 2020 2020 2274 6865  , ".        "the
+00051e60: 6e20 7468 6572 6520 6973 206e 6f20 6e65  n there is no ne
+00051e70: 6564 2074 6f20 7573 6520 7468 6973 206f  ed to use this o
+00051e80: 7074 696f 6e2e 2022 0a20 2020 2020 2020  ption. ".       
+00051e90: 2066 2249 6620 796f 7520 6861 7665 2063   f"If you have c
+00051ea0: 686f 7365 6e20 277b 5359 4e43 5f46 554c  hosen '{SYNC_FUL
+00051eb0: 4c7d 272c 2022 0a20 2020 2020 2020 2022  L}', ".        "
+00051ec0: 7468 6520 6675 6c6c 2073 7461 7465 2c20  the full state, 
+00051ed0: 616c 6c20 7374 6174 6520 6576 656e 7473  all state events
+00051ee0: 2077 696c 6c20 6265 2073 796e 6368 726f   will be synchro
+00051ef0: 6e69 7a65 6420 6265 7477 6565 6e20 220a  nized between ".
+00051f00: 2020 2020 2020 2020 2274 6869 7320 7072          "this pr
+00051f10: 6f67 7261 6d20 616e 6420 7468 6520 7365  ogram and the se
+00051f20: 7276 6572 2062 6566 6f72 6520 6120 2773  rver before a 's
+00051f30: 656e 6427 2e20 220a 2020 2020 2020 2020  end'. ".        
+00051f40: 6622 4966 2079 6f75 2068 6176 6520 6368  f"If you have ch
+00051f50: 6f73 656e 2027 7b53 594e 435f 4f46 467d  osen '{SYNC_OFF}
+00051f60: 272c 2022 0a20 2020 2020 2020 2022 7379  ', ".        "sy
+00051f70: 6e63 6872 6f6e 697a 6174 696f 6e20 7769  nchronization wi
+00051f80: 6c6c 2062 6520 736b 6970 7065 6420 656e  ll be skipped en
+00051f90: 7469 7265 6c79 2062 6566 6f72 6520 7468  tirely before th
+00051fa0: 6520 2773 656e 6427 2022 0a20 2020 2020  e 'send' ".     
+00051fb0: 2020 2022 7768 6963 6820 7769 6c6c 2069     "which will i
+00051fc0: 6d70 726f 7665 2070 6572 666f 726d 616e  mprove performan
+00051fd0: 6365 2e22 2c0a 2020 2020 290a 2020 2020  ce.",.    ).    
+00051fe0: 6170 2e61 6464 5f61 7267 756d 656e 7428  ap.add_argument(
+00051ff0: 0a20 2020 2020 2020 2022 2d6f 222c 2020  .        "-o",  
+00052000: 2320 696e 636f 6d70 6174 6962 6c65 2063  # incompatible c
+00052010: 6861 6e67 6520 4465 6320 3230 3232 2c20  hange Dec 2022, 
+00052020: 2d6f 206d 6f76 6564 2066 726f 6d20 2d2d  -o moved from --
+00052030: 6f73 2d6e 6f74 6966 790a 2020 2020 2020  os-notify.      
+00052040: 2020 222d 2d6f 7574 7075 7422 2c0a 2020    "--output",.  
+00052050: 2020 2020 2020 7265 7175 6972 6564 3d46        required=F
+00052060: 616c 7365 2c0a 2020 2020 2020 2020 7479  alse,.        ty
+00052070: 7065 3d73 7472 2c20 2023 206f 7574 7075  pe=str,  # outpu
+00052080: 7420 6d65 7468 6f64 3a20 7465 7874 2c20  t method: text, 
+00052090: 6a73 6f6e 2c20 6a73 6f6e 2d6d 6178 2c20  json, json-max, 
+000520a0: 2e2e 2e0a 2020 2020 2020 2020 6465 6661  ....        defa
+000520b0: 756c 743d 4f55 5450 5554 5f44 4546 4155  ult=OUTPUT_DEFAU
+000520c0: 4c54 2c20 2023 2077 6865 6e20 2d2d 6f75  LT,  # when --ou
+000520d0: 7470 7574 2069 7320 6e6f 7420 7573 6564  tput is not used
+000520e0: 0a20 2020 2020 2020 206d 6574 6176 6172  .        metavar
+000520f0: 3d22 5445 5854 7c4a 534f 4e7c 4a53 4f4e  ="TEXT|JSON|JSON
+00052100: 2d4d 4158 7c4a 534f 4e2d 5350 4543 222c  -MAX|JSON-SPEC",
+00052110: 0a20 2020 2020 2020 2068 656c 703d 2253  .        help="S
+00052120: 656c 6563 7420 616e 206f 7574 7075 7420  elect an output 
+00052130: 666f 726d 6174 2e20 220a 2020 2020 2020  format. ".      
+00052140: 2020 2244 6574 6169 6c73 3a3a 2054 6869    "Details:: Thi
+00052150: 7320 6f70 7469 6f6e 2064 6563 6964 6573  s option decides
+00052160: 206f 6e20 686f 7720 7468 6520 6f75 7470   on how the outp
+00052170: 7574 2069 7320 7072 6573 656e 7465 642e  ut is presented.
+00052180: 2022 0a20 2020 2020 2020 2066 2243 7572   ".        f"Cur
+00052190: 7265 6e74 6c79 206f 6666 6572 6564 2063  rently offered c
+000521a0: 686f 6963 6573 2061 7265 3a20 277b 4f55  hoices are: '{OU
+000521b0: 5450 5554 5f54 4558 547d 272c 2027 7b4f  TPUT_TEXT}', '{O
+000521c0: 5554 5055 545f 4a53 4f4e 7d27 2c20 220a  UTPUT_JSON}', ".
+000521d0: 2020 2020 2020 2020 6622 277b 4f55 5450          f"'{OUTP
+000521e0: 5554 5f4a 534f 4e5f 4d41 587d 272c 2061  UT_JSON_MAX}', a
+000521f0: 6e64 2027 7b4f 5554 5055 545f 4a53 4f4e  nd '{OUTPUT_JSON
+00052200: 5f53 5045 437d 272e 2022 0a20 2020 2020  _SPEC}'. ".     
+00052210: 2020 2022 5072 6f76 6964 6520 6f6e 6520     "Provide one 
+00052220: 6f66 2074 6865 7365 2063 686f 6963 6573  of these choices
+00052230: 2e20 220a 2020 2020 2020 2020 6622 5468  . ".        f"Th
+00052240: 6520 6465 6661 756c 7420 6973 2027 7b4f  e default is '{O
+00052250: 5554 5055 545f 4445 4641 554c 547d 272e  UTPUT_DEFAULT}'.
+00052260: 2049 6620 796f 7520 7761 6e74 2074 6f20   If you want to 
+00052270: 7573 6520 7468 6520 6465 6661 756c 742c  use the default,
+00052280: 2022 0a20 2020 2020 2020 2022 7468 656e   ".        "then
+00052290: 2074 6865 7265 2069 7320 6e6f 206e 6565   there is no nee
+000522a0: 6420 746f 2075 7365 2074 6869 7320 6f70  d to use this op
+000522b0: 7469 6f6e 2e20 220a 2020 2020 2020 2020  tion. ".        
+000522c0: 6622 4966 2079 6f75 2068 6176 6520 6368  f"If you have ch
+000522d0: 6f73 656e 2027 7b4f 5554 5055 545f 5445  osen '{OUTPUT_TE
+000522e0: 5854 7d27 2c20 220a 2020 2020 2020 2020  XT}', ".        
+000522f0: 2274 6865 206f 7574 7075 7420 7769 6c6c  "the output will
+00052300: 2062 6520 666f 726d 6174 7465 6420 7769   be formatted wi
+00052310: 7468 2074 6865 2069 6e74 656e 7469 6f6e  th the intention
+00052320: 2074 6f20 6265 2022 0a20 2020 2020 2020   to be ".       
+00052330: 2022 636f 6e73 756d 6564 2062 7920 6875   "consumed by hu
+00052340: 6d61 6e73 2c20 692e 652e 2072 6561 6461  mans, i.e. reada
+00052350: 626c 6520 7465 7874 2e20 220a 2020 2020  ble text. ".    
+00052360: 2020 2020 6622 4966 2079 6f75 2068 6176      f"If you hav
+00052370: 6520 6368 6f73 656e 2027 7b4f 5554 5055  e chosen '{OUTPU
+00052380: 545f 4a53 4f4e 7d27 2c20 220a 2020 2020  T_JSON}', ".    
+00052390: 2020 2020 2274 6865 206f 7574 7075 7420      "the output 
+000523a0: 7769 6c6c 2062 6520 666f 726d 6174 7465  will be formatte
+000523b0: 6420 6173 204a 534f 4e2e 2022 0a20 2020  d as JSON. ".   
+000523c0: 2020 2020 2022 5468 6520 636f 6e74 656e       "The conten
+000523d0: 7420 6f66 2074 6865 204a 534f 4e20 6f62  t of the JSON ob
+000523e0: 6a65 6374 206d 6174 6368 6573 2074 6865  ject matches the
+000523f0: 2064 6174 6120 7072 6f76 6964 6564 2062   data provided b
+00052400: 7920 7468 6520 220a 2020 2020 2020 2020  y the ".        
+00052410: 226d 6174 7269 782d 6e69 6f20 5344 4b2e  "matrix-nio SDK.
+00052420: 2049 6e20 736f 6d65 206f 6363 6173 696f   In some occasio
+00052430: 6e73 2074 6865 206f 7574 7075 7420 6973  ns the output is
+00052440: 2065 6e68 616e 6365 6420 220a 2020 2020   enhanced ".    
+00052450: 2020 2020 2262 7920 6861 7669 6e67 2061      "by having a
+00052460: 2066 6577 2065 7874 7261 2064 6174 6120   few extra data 
+00052470: 6974 656d 7320 6164 6465 6420 666f 7220  items added for 
+00052480: 636f 6e76 656e 6965 6e63 652e 2022 0a20  convenience. ". 
+00052490: 2020 2020 2020 2022 496e 206d 6f73 7420         "In most 
+000524a0: 6361 7365 7320 7468 6520 6f75 7470 7574  cases the output
+000524b0: 2077 696c 6c20 6265 2070 726f 6365 7373   will be process
+000524c0: 6564 2062 7920 6f74 6865 7220 7072 6f67  ed by other prog
+000524d0: 7261 6d73 2022 0a20 2020 2020 2020 2022  rams ".        "
+000524e0: 7261 7468 6572 2074 6861 6e20 7265 6164  rather than read
+000524f0: 2062 7920 6875 6d61 6e73 2e20 220a 2020   by humans. ".  
+00052500: 2020 2020 2020 6622 4f70 7469 6f6e 2027        f"Option '
+00052510: 7b4f 5554 5055 545f 4a53 4f4e 5f4d 4158  {OUTPUT_JSON_MAX
+00052520: 7d27 2069 7320 7072 6163 7469 6361 6c6c  }' is practicall
+00052530: 7920 7468 6520 7361 6d65 2061 7320 220a  y the same as ".
+00052540: 2020 2020 2020 2020 6622 277b 4f55 5450          f"'{OUTP
+00052550: 5554 5f4a 534f 4e7d 272c 2022 0a20 2020  UT_JSON}', ".   
+00052560: 2020 2020 2022 6275 7420 7965 7420 616e       "but yet an
+00052570: 6f74 6865 7220 6164 6469 7469 6f6e 616c  other additional
+00052580: 2066 6965 6c64 2069 7320 6164 6465 642e   field is added.
+00052590: 2022 0a20 2020 2020 2020 2022 5468 6520   ".        "The 
+000525a0: 6461 7461 2069 7465 6d20 2774 7261 6e73  data item 'trans
+000525b0: 706f 7274 5f72 6573 706f 6e73 6527 2077  port_response' w
+000525c0: 6869 6368 2067 6976 6573 2069 6e66 6f72  hich gives infor
+000525d0: 6d61 7469 6f6e 206f 6e20 220a 2020 2020  mation on ".    
+000525e0: 2020 2020 2268 6f77 2074 6865 2064 6174      "how the dat
+000525f0: 6120 7761 7320 6f62 7461 696e 6564 2061  a was obtained a
+00052600: 6e64 2074 7261 6e73 706f 7274 6564 2069  nd transported i
+00052610: 7320 616c 736f 2062 6569 6e67 2061 6464  s also being add
+00052620: 6564 2e20 220a 2020 2020 2020 2020 2246  ed. ".        "F
+00052630: 6f72 2027 2d2d 6c69 7374 656e 2720 6120  or '--listen' a 
+00052640: 6665 7720 6d6f 7265 2066 6965 6c64 7320  few more fields 
+00052650: 6172 6520 6164 6465 642e 2022 0a20 2020  are added. ".   
+00052660: 2020 2020 2022 496e 206d 6f73 7420 6361       "In most ca
+00052670: 7365 7320 7468 6520 6f75 7470 7574 2077  ses the output w
+00052680: 696c 6c20 6265 2070 726f 6365 7373 6564  ill be processed
+00052690: 2062 7920 6f74 6865 7220 7072 6f67 7261   by other progra
+000526a0: 6d73 2022 0a20 2020 2020 2020 2022 7261  ms ".        "ra
+000526b0: 7468 6572 2074 6861 6e20 7265 6164 2062  ther than read b
+000526c0: 7920 6875 6d61 6e73 2e20 220a 2020 2020  y humans. ".    
+000526d0: 2020 2020 6622 4f70 7469 6f6e 2027 7b4f      f"Option '{O
+000526e0: 5554 5055 545f 4a53 4f4e 5f53 5045 437d  UTPUT_JSON_SPEC}
+000526f0: 2720 6f6e 6c79 2070 7269 6e74 7320 696e  ' only prints in
+00052700: 666f 726d 6174 696f 6e20 7468 6174 2061  formation that a
+00052710: 6468 6572 6573 2022 0a20 2020 2020 2020  dheres ".       
+00052720: 2022 312d 746f 2d31 2074 6f20 7468 6520   "1-to-1 to the 
+00052730: 4d61 7472 6978 2053 7065 6369 6669 6361  Matrix Specifica
+00052740: 7469 6f6e 2e20 4375 7272 656e 746c 7920  tion. Currently 
+00052750: 6f6e 6c79 2074 6865 2065 7665 6e74 7320  only the events 
+00052760: 220a 2020 2020 2020 2020 226f 6e20 272d  ".        "on '-
+00052770: 2d6c 6973 7465 6e27 2061 6e64 2027 2d2d  -listen' and '--
+00052780: 7461 696c 2720 7072 6f76 6964 6520 6461  tail' provide da
+00052790: 7461 2065 7861 6374 6c79 2061 7320 696e  ta exactly as in
+000527a0: 2074 6865 2022 0a20 2020 2020 2020 2022   the ".        "
+000527b0: 4d61 7472 6978 2053 7065 6369 6669 6361  Matrix Specifica
+000527c0: 7469 6f6e 2e20 4966 206e 6f20 6461 7461  tion. If no data
+000527d0: 2069 7320 6176 6169 6c61 626c 6520 7468   is available th
+000527e0: 6174 2063 6f72 7265 7370 6f6e 6473 2022  at corresponds "
+000527f0: 0a20 2020 2020 2020 2022 6578 6163 746c  .        "exactl
+00052800: 7920 7769 7468 2074 6865 204d 6174 7269  y with the Matri
+00052810: 7820 5370 6563 6966 6963 6174 696f 6e2c  x Specification,
+00052820: 206e 6f20 6461 7461 2077 696c 6c20 6265   no data will be
+00052830: 2070 7269 6e74 6564 2e20 220a 2020 2020   printed. ".    
+00052840: 2020 2020 2249 6e20 7368 6f72 742c 2063      "In short, c
+00052850: 7572 7265 6e74 6c79 2027 2d2d 6a73 6f6e  urrently '--json
+00052860: 2d73 7065 6327 206f 6e6c 7920 7072 6f76  -spec' only prov
+00052870: 6964 6573 206f 7574 7075 7473 2066 6f72  ides outputs for
+00052880: 2022 0a20 2020 2020 2020 2022 272d 2d6c   ".        "'--l
+00052890: 6973 7465 6e27 2061 6e64 2027 2d2d 7461  isten' and '--ta
+000528a0: 696c 272e 2041 6c6c 206f 7468 6572 2061  il'. All other a
+000528b0: 7267 756d 656e 7473 206c 696b 6520 272d  rguments like '-
+000528c0: 2d67 6574 2d72 6f6f 6d2d 696e 666f 2720  -get-room-info' 
+000528d0: 220a 2020 2020 2020 2020 2277 696c 6c20  ".        "will 
+000528e0: 7072 696e 7420 6e6f 206f 7574 7075 742e  print no output.
+000528f0: 2022 2c0a 2020 2020 290a 2020 2020 6170   ",.    ).    ap
+00052900: 2e61 6464 5f61 7267 756d 656e 7428 0a20  .add_argument(. 
+00052910: 2020 2020 2020 2022 2d2d 726f 6f6d 2d69         "--room-i
+00052920: 6e76 6974 6573 222c 0a20 2020 2020 2020  nvites",.       
+00052930: 2072 6571 7569 7265 643d 4661 6c73 652c   required=False,
+00052940: 0a20 2020 2020 2020 2074 7970 653d 7374  .        type=st
+00052950: 722c 0a20 2020 2020 2020 2064 6566 6175  r,.        defau
+00052960: 6c74 3d49 4e56 4954 4553 5f55 4e55 5345  lt=INVITES_UNUSE
+00052970: 445f 4445 4641 554c 542c 2020 2320 7768  D_DEFAULT,  # wh
+00052980: 656e 202d 2d72 6f6f 6d2d 696e 7669 7465  en --room-invite
+00052990: 7320 6973 206e 6f74 2075 7365 640a 2020  s is not used.  
+000529a0: 2020 2020 2020 6e61 7267 733d 223f 222c        nargs="?",
+000529b0: 2020 2320 6d61 6b65 7320 7468 6520 776f    # makes the wo
+000529c0: 7264 206f 7074 696f 6e61 6c0a 2020 2020  rd optional.    
+000529d0: 2020 2020 2320 7768 656e 202d 2d72 6f6f      # when --roo
+000529e0: 6d2d 696e 7669 7465 7320 6973 2075 7365  m-invites is use
+000529f0: 642c 2062 7574 2074 6578 7420 6973 206e  d, but text is n
+00052a00: 6f74 2061 6464 6564 0a20 2020 2020 2020  ot added.       
+00052a10: 2063 6f6e 7374 3d49 4e56 4954 4553 5f55   const=INVITES_U
+00052a20: 5345 445f 4445 4641 554c 542c 0a20 2020  SED_DEFAULT,.   
+00052a30: 2020 2020 206d 6574 6176 6172 3d22 4c49       metavar="LI
+00052a40: 5354 7c4a 4f49 4e7c 4c49 5354 2b4a 4f49  ST|JOIN|LIST+JOI
+00052a50: 4e22 2c0a 2020 2020 2020 2020 6865 6c70  N",.        help
+00052a60: 3d22 4c69 7374 2072 6f6f 6d20 696e 7669  ="List room invi
+00052a70: 7461 7469 6f6e 7320 616e 642f 6f72 206a  tations and/or j
+00052a80: 6f69 6e20 696e 7669 7465 6420 726f 6f6d  oin invited room
+00052a90: 732e 2022 0a20 2020 2020 2020 2022 4465  s. ".        "De
+00052aa0: 7461 696c 733a 3a20 5468 6973 206f 7074  tails:: This opt
+00052ab0: 696f 6e20 7461 6b65 7320 7a65 726f 206f  ion takes zero o
+00052ac0: 7220 6f6e 6520 6172 6775 6d65 6e74 2e20  r one argument. 
+00052ad0: 220a 2020 2020 2020 2020 6622 4966 206e  ".        f"If n
+00052ae0: 6f20 6172 6775 6d65 6e74 2069 7320 6769  o argument is gi
+00052af0: 7665 6e2c 2027 7b49 4e56 4954 4553 5f4c  ven, '{INVITES_L
+00052b00: 4953 547d 2720 6973 2061 7373 756d 6564  IST}' is assumed
+00052b10: 2077 6869 6368 2077 696c 6c20 220a 2020   which will ".  
+00052b20: 2020 2020 2020 226c 6973 7420 616c 6c20        "list all 
+00052b30: 726f 6f6d 2069 6e76 6974 6174 696f 6e20  room invitation 
+00052b40: 6576 656e 7473 2061 7320 7468 6579 2061  events as they a
+00052b50: 7265 2072 6563 6569 7665 642e 2022 0a20  re received. ". 
+00052b60: 2020 2020 2020 2022 4c69 7374 696e 6720         "Listing 
+00052b70: 7769 6c6c 2070 7269 6e74 2074 6865 2072  will print the r
+00052b80: 6f6f 6d20 6964 2061 6e64 206f 7468 6572  oom id and other
+00052b90: 2069 6e66 6f72 6d61 7469 6f6e 2074 6f20   information to 
+00052ba0: 7374 616e 6461 7264 2022 0a20 2020 2020  standard ".     
+00052bb0: 2020 2022 6f75 7470 7574 2e20 220a 2020     "output. ".  
+00052bc0: 2020 2020 2020 6622 277b 494e 5649 5445        f"'{INVITE
+00052bd0: 535f 4a4f 494e 7d27 2077 696c 6c20 6a6f  S_JOIN}' will jo
+00052be0: 696e 2074 6865 2072 6f6f 6d28 7329 2065  in the room(s) e
+00052bf0: 6163 6820 7469 6d65 2061 2072 6f6f 6d20  ach time a room 
+00052c00: 696e 7669 7461 7469 6f6e 2022 0a20 2020  invitation ".   
+00052c10: 2020 2020 2022 6973 2072 6563 6569 7665       "is receive
+00052c20: 642e 2022 0a20 2020 2020 2020 2066 2227  d. ".        f"'
+00052c30: 7b49 4e56 4954 4553 5f4c 4953 545f 4a4f  {INVITES_LIST_JO
+00052c40: 494e 7d27 2077 696c 6c20 646f 2062 6f74  IN}' will do bot
+00052c50: 682c 206c 6973 7420 7468 6520 696e 7669  h, list the invi
+00052c60: 7461 7469 6f6e 7320 6173 2077 656c 6c20  tations as well 
+00052c70: 220a 2020 2020 2020 2020 2261 7320 6175  ".        "as au
+00052c80: 746f 6d61 7469 6361 6c6c 7920 6a6f 696e  tomatically join
+00052c90: 2074 6865 2072 6f6f 6d73 2074 6f20 7768   the rooms to wh
+00052ca0: 6963 6820 616e 2069 6e76 6974 6174 696f  ich an invitatio
+00052cb0: 6e20 7761 7320 7265 6365 6976 6564 2e20  n was received. 
+00052cc0: 220a 2020 2020 2020 2020 2227 2d2d 726f  ".        "'--ro
+00052cd0: 6f6d 2d69 6e76 6974 6573 2720 6361 6e20  om-invites' can 
+00052ce0: 6265 2063 6f6d 6269 6e65 6420 7769 7468  be combined with
+00052cf0: 2027 2d2d 6c69 7374 656e 272e 2022 0a20   '--listen'. ". 
+00052d00: 2020 2020 2020 2022 4966 2061 6e64 206f         "If and o
+00052d10: 6e6c 7920 6966 2027 2d2d 6c69 7374 656e  nly if '--listen
+00052d20: 2066 6f72 6576 6572 2720 6973 2075 7365   forever' is use
+00052d30: 642c 2077 696c 6c20 7468 6520 7072 6f67  d, will the prog
+00052d40: 7261 6d20 220a 2020 2020 2020 2020 226c  ram ".        "l
+00052d50: 6973 7465 6e20 636f 6e74 696e 756f 7573  isten continuous
+00052d60: 6c79 2066 6f72 2072 6f6f 6d20 696e 7669  ly for room invi
+00052d70: 7465 732e 2022 0a20 2020 2020 2020 2022  tes. ".        "
+00052d80: 496e 2061 6c6c 206f 7468 6572 2063 6173  In all other cas
+00052d90: 6573 2c20 7468 6520 7072 6f67 7261 6d20  es, the program 
+00052da0: 6f6e 6c79 206c 6f6f 6b73 2066 6f72 2072  only looks for r
+00052db0: 6f6f 6d20 696e 7669 7461 7469 6f6e 2022  oom invitation "
+00052dc0: 0a20 2020 2020 2020 2022 6576 656e 7473  .        "events
+00052dd0: 206f 6e63 653b 2061 6e64 2069 7420 646f   once; and it do
+00052de0: 6573 2073 6f20 6265 666f 7265 2061 6e79  es so before any
+00052df0: 2070 6f73 7369 626c 6520 6c69 7374 656e   possible listen
+00052e00: 696e 6720 746f 2022 0a20 2020 2020 2020  ing to ".       
+00052e10: 2022 6d65 7373 6167 6573 2e20 220a 2020   "messages. ".  
+00052e20: 2020 2020 2020 2257 6172 6e69 6e67 3a20        "Warning: 
+00052e30: 6576 656e 7473 2061 7265 2075 7375 616c  events are usual
+00052e40: 6c79 2064 656c 6976 6572 6564 206f 6e63  ly delivered onc
+00052e50: 652e 2053 6f2c 2069 6620 796f 7520 6c69  e. So, if you li
+00052e60: 7374 656e 2022 0a20 2020 2020 2020 2022  sten ".        "
+00052e70: 666f 7220 616e 6420 6c69 7374 2069 6e76  for and list inv
+00052e80: 6974 6573 2079 6f75 2077 696c 6c20 6765  ites you will ge
+00052e90: 7420 7468 656d 2061 6e64 206c 6973 7420  t them and list 
+00052ea0: 7468 656d 2074 6865 2066 6972 7374 2022  them the first "
+00052eb0: 0a20 2020 2020 2020 2022 7469 6d65 2079  .        "time y
+00052ec0: 6f75 2072 756e 2027 2d2d 726f 6f6d 2d69  ou run '--room-i
+00052ed0: 6e76 6974 6573 206c 6973 7427 2e20 4f6e  nvites list'. On
+00052ee0: 2074 6865 2073 6563 6f6e 6420 7275 6e20   the second run 
+00052ef0: 6f66 2022 0a20 2020 2020 2020 2022 272d  of ".        "'-
+00052f00: 2d72 6f6f 6d2d 696e 7669 7465 7320 6c69  -room-invites li
+00052f10: 7374 2720 7468 6520 6576 656e 7473 2077  st' the events w
+00052f20: 696c 6c20 6e6f 7420 6265 2072 6570 6c61  ill not be repla
+00052f30: 7965 6420 616e 6420 220a 2020 2020 2020  yed and ".      
+00052f40: 2020 226e 6f74 2062 6520 6c69 7374 6564    "not be listed
+00052f50: 2e20 220a 2020 2020 2020 2020 2248 656e  . ".        "Hen
+00052f60: 6365 2c20 6966 2079 6f75 206c 6973 7420  ce, if you list 
+00052f70: 7468 6520 696e 7669 7465 732c 2079 6f75  the invites, you
+00052f80: 206d 6967 6874 2077 616e 7420 746f 2073   might want to s
+00052f90: 746f 7265 2074 6865 206f 7574 7075 7420  tore the output 
+00052fa0: 220a 2020 2020 2020 2020 2228 726f 6f6d  ".        "(room
+00052fb0: 2069 6429 2073 6f20 7468 6174 2079 6f75   id) so that you
+00052fc0: 2063 616e 206a 6f69 6e20 7468 6520 726f   can join the ro
+00052fd0: 6f6d 206c 6174 6572 2077 6974 6820 272d  om later with '-
+00052fe0: 2d72 6f6f 6d2d 6a6f 696e 2720 220a 2020  -room-join' ".  
+00052ff0: 2020 2020 2020 2266 6f72 2065 7861 6d70        "for examp
+00053000: 6c65 2e20 220a 2020 2020 2020 2020 2244  le. ".        "D
+00053010: 6f6e 2774 2063 6f6e 6675 7365 2074 6869  on't confuse thi
+00053020: 7320 6f70 7469 6f6e 2077 6974 6820 2d2d  s option with --
+00053030: 726f 6f6d 2d69 6e76 6974 652e 222c 0a20  room-invite.",. 
+00053040: 2020 2029 0a20 2020 2061 702e 6164 645f     ).    ap.add_
+00053050: 6172 6775 6d65 6e74 280a 2020 2020 2020  argument(.      
+00053060: 2020 222d 7622 2c20 2023 2069 6e63 6f6d    "-v",  # incom
+00053070: 7061 7469 626c 6520 6368 616e 6765 2044  patible change D
+00053080: 6563 2032 3032 322c 202d 7620 6d6f 7665  ec 2022, -v move
+00053090: 6420 6865 7265 2066 726f 6d20 2d2d 7665  d here from --ve
+000530a0: 7269 6679 0a20 2020 2020 2020 2022 2d56  rify.        "-V
+000530b0: 222c 2020 2320 6578 6365 7074 696f 6e2c  ",  # exception,
+000530c0: 2061 6c6c 6f77 2061 6c73 6f20 7570 7065   allow also uppe
+000530d0: 7263 6173 6520 560a 2020 2020 2020 2020  rcase V.        
+000530e0: 222d 2d76 6572 7369 6f6e 222c 0a20 2020  "--version",.   
+000530f0: 2020 2020 2072 6571 7569 7265 643d 4661       required=Fa
+00053100: 6c73 652c 0a20 2020 2020 2020 2074 7970  lse,.        typ
+00053110: 653d 7374 722c 0a20 2020 2020 2020 2064  e=str,.        d
+00053120: 6566 6175 6c74 3d56 4552 5349 4f4e 5f55  efault=VERSION_U
+00053130: 4e55 5345 445f 4445 4641 554c 542c 2020  NUSED_DEFAULT,  
+00053140: 2320 7768 656e 202d 7420 6973 206e 6f74  # when -t is not
+00053150: 2075 7365 640a 2020 2020 2020 2020 6e61   used.        na
+00053160: 7267 733d 223f 222c 2020 2320 6d61 6b65  rgs="?",  # make
+00053170: 7320 7468 6520 776f 7264 206f 7074 696f  s the word optio
+00053180: 6e61 6c0a 2020 2020 2020 2020 2320 7768  nal.        # wh
+00053190: 656e 202d 7620 6973 2075 7365 642c 2062  en -v is used, b
+000531a0: 7574 2074 6578 7420 6973 206e 6f74 2061  ut text is not a
+000531b0: 6464 6564 0a20 2020 2020 2020 2063 6f6e  dded.        con
+000531c0: 7374 3d56 4552 5349 4f4e 5f55 5345 445f  st=VERSION_USED_
+000531d0: 4445 4641 554c 542c 0a20 2020 2020 2020  DEFAULT,.       
+000531e0: 206d 6574 6176 6172 3d22 5052 494e 547c   metavar="PRINT|
+000531f0: 4348 4543 4b22 2c0a 2020 2020 2020 2020  CHECK",.        
+00053200: 6865 6c70 3d22 5072 696e 7420 7665 7273  help="Print vers
+00053210: 696f 6e20 696e 666f 726d 6174 696f 6e20  ion information 
+00053220: 6f72 2063 6865 636b 2066 6f72 2075 7064  or check for upd
+00053230: 6174 6573 2e20 220a 2020 2020 2020 2020  ates. ".        
+00053240: 2244 6574 6169 6c73 3a3a 2054 6869 7320  "Details:: This 
+00053250: 6f70 7469 6f6e 2074 616b 6573 207a 6572  option takes zer
+00053260: 6f20 6f72 206f 6e65 2061 7267 756d 656e  o or one argumen
+00053270: 742e 2022 0a20 2020 2020 2020 2066 2249  t. ".        f"I
+00053280: 6620 6e6f 2061 7267 756d 656e 7420 6973  f no argument is
+00053290: 2067 6976 656e 2c20 277b 5052 494e 547d   given, '{PRINT}
+000532a0: 2720 6973 2061 7373 756d 6564 2077 6869  ' is assumed whi
+000532b0: 6368 2077 696c 6c20 220a 2020 2020 2020  ch will ".      
+000532c0: 2020 6622 7072 696e 7420 7468 6520 7665    f"print the ve
+000532d0: 7273 696f 6e20 6f66 2074 6865 2063 7572  rsion of the cur
+000532e0: 7265 6e74 6c79 2069 6e73 7461 6c6c 6564  rently installed
+000532f0: 2027 5052 4f47 5f57 4954 484f 5554 5f45   'PROG_WITHOUT_E
+00053300: 5854 2720 220a 2020 2020 2020 2020 6622  XT' ".        f"
+00053310: 7061 636b 6167 652e 2027 7b43 4845 434b  package. '{CHECK
+00053320: 7d27 2069 7320 7468 6520 616c 7465 726e  }' is the altern
+00053330: 6174 6976 652e 2022 0a20 2020 2020 2020  ative. ".       
+00053340: 2022 277b 4348 4543 4b7d 2720 636f 6e6e   "'{CHECK}' conn
+00053350: 6563 7473 2074 6f20 6874 7470 733a 2f2f  ects to https://
+00053360: 7079 7069 2e6f 7267 2061 6e64 2067 6574  pypi.org and get
+00053370: 7320 7468 6520 7665 7273 696f 6e20 220a  s the version ".
+00053380: 2020 2020 2020 2020 226e 756d 6265 7220          "number 
+00053390: 6f66 206c 6174 6573 7420 7374 6162 6c65  of latest stable
+000533a0: 2072 656c 6561 7365 2e20 5468 6572 6520   release. There 
+000533b0: 6973 206e 6f20 2763 616c 6c69 6e67 2068  is no 'calling h
+000533c0: 6f6d 6527 2022 0a20 2020 2020 2020 2022  ome' ".        "
+000533d0: 6f6e 2065 7665 7279 2072 756e 2c20 6f6e  on every run, on
+000533e0: 6c79 2061 2027 6368 6563 6b20 7079 7069  ly a 'check pypi
+000533f0: 2e6f 7267 2720 7570 6f6e 2072 6571 7565  .org' upon reque
+00053400: 7374 2e20 596f 7572 2022 0a20 2020 2020  st. Your ".     
+00053410: 2020 2022 7072 6976 6163 7920 6973 2070     "privacy is p
+00053420: 726f 7465 6374 6564 2e20 5468 6520 6e65  rotected. The ne
+00053430: 7720 7265 6c65 6173 6520 6973 206e 6569  w release is nei
+00053440: 7468 6572 2064 6f77 6e6c 6f61 6465 642c  ther downloaded,
+00053450: 2022 0a20 2020 2020 2020 2022 6e6f 7220   ".        "nor 
+00053460: 696e 7374 616c 6c65 642e 2049 7420 6a75  installed. It ju
+00053470: 7374 2069 6e66 6f72 6d73 2079 6f75 2e20  st informs you. 
+00053480: 220a 2020 2020 2020 2020 2241 6674 6572  ".        "After
+00053490: 2070 7269 6e74 696e 6720 7665 7273 696f   printing versio
+000534a0: 6e20 696e 666f 726d 6174 696f 6e20 7468  n information th
+000534b0: 6520 220a 2020 2020 2020 2020 2270 726f  e ".        "pro
+000534c0: 6772 616d 2077 696c 6c20 636f 6e74 696e  gram will contin
+000534d0: 7565 2074 6f20 7275 6e2e 2054 6869 7320  ue to run. This 
+000534e0: 6973 2075 7365 6675 6c20 666f 7220 6861  is useful for ha
+000534f0: 7669 6e67 2076 6572 7369 6f6e 2022 0a20  ving version ". 
+00053500: 2020 2020 2020 2022 6e75 6d62 6572 2069         "number i
+00053510: 6e20 7468 6520 6c6f 6720 6669 6c65 732e  n the log files.
+00053520: 222c 0a20 2020 2029 0a20 2020 2067 732e  ",.    ).    gs.
+00053530: 7061 203d 2061 702e 7061 7273 655f 6172  pa = ap.parse_ar
+00053540: 6773 2829 0a20 2020 2023 2077 7261 7020  gs().    # wrap 
+00053550: 616e 6420 696e 6465 6e74 3a20 6874 7470  and indent: http
+00053560: 733a 2f2f 746f 7761 7264 7364 6174 6173  s://towardsdatas
+00053570: 6369 656e 6365 2e63 6f6d 2f36 2d66 616e  cience.com/6-fan
+00053580: 6379 2d62 7569 6c74 2d69 6e2d 7465 7874  cy-built-in-text
+00053590: 2d0a 2020 2020 2320 2020 2020 2020 2020  -.    #         
+000535a0: 2020 2020 2020 2020 2077 7261 7070 696e           wrappin
+000535b0: 672d 7465 6368 6e69 7175 6573 2d69 6e2d  g-techniques-in-
+000535c0: 7079 7468 6f6e 2d61 3738 6363 3537 6332  python-a78cc57c2
+000535d0: 3536 360a 2020 2020 2320 6966 206f 7574  566.    # if out
+000535e0: 7075 7420 6973 206e 6f74 2054 5459 2c20  put is not TTY, 
+000535f0: 7468 656e 2064 6f6e 2774 2061 6464 2063  then don't add c
+00053600: 6f6c 6f72 732c 2065 2e67 2e20 7768 656e  olors, e.g. when
+00053610: 206f 7574 7075 7420 6973 2070 6970 6564   output is piped
+00053620: 0a20 2020 2069 6620 7379 732e 7374 646f  .    if sys.stdo
+00053630: 7574 2e69 7361 7474 7928 293a 0a20 2020  ut.isatty():.   
+00053640: 2020 2020 2023 2059 6f75 2772 6520 7275       # You're ru
+00053650: 6e6e 696e 6720 696e 2061 2072 6561 6c20  nning in a real 
+00053660: 7465 726d 696e 616c 0a20 2020 2020 2020  terminal.       
+00053670: 2023 2063 6f6c 6f72 730a 2020 2020 2020   # colors.      
+00053680: 2020 2320 6164 6170 7420 7769 6474 680a    # adapt width.
+00053690: 2020 2020 2020 2020 7465 726d 5f77 6964          term_wid
+000536a0: 7468 203d 206f 732e 6765 745f 7465 726d  th = os.get_term
+000536b0: 696e 616c 5f73 697a 6528 295b 305d 0a20  inal_size()[0]. 
+000536c0: 2020 2020 2020 2023 2070 7269 6e74 2822         # print("
+000536d0: 7465 726d 696e 616c 2077 6964 7468 2022  terminal width "
+000536e0: 2c20 7465 726d 5f77 6964 7468 290a 2020  , term_width).  
+000536f0: 2020 2020 2020 636f 6e20 3d20 636f 6c6f        con = colo
+00053700: 7273 2e66 672e 6772 6565 6e0a 2020 2020  rs.fg.green.    
+00053710: 2020 2020 636f 6666 203d 2063 6f6c 6f72      coff = color
+00053720: 732e 7265 7365 740a 2020 2020 2020 2020  s.reset.        
+00053730: 656f 6e20 3d20 636f 6c6f 7273 2e62 6f6c  eon = colors.bol
+00053740: 6420 2b20 636f 6e0a 2020 2020 2020 2020  d + con.        
+00053750: 656f 6666 203d 2063 6f6c 6f72 732e 7265  eoff = colors.re
+00053760: 7365 7420 2b20 636f 6e0a 2020 2020 656c  set + con.    el
+00053770: 7365 3a0a 2020 2020 2020 2020 2320 596f  se:.        # Yo
+00053780: 7527 7265 2062 6569 6e67 2070 6970 6564  u're being piped
+00053790: 206f 7220 7265 6469 7265 6374 6564 0a20   or redirected. 
+000537a0: 2020 2020 2020 2023 206e 6f20 436f 6c6f         # no Colo
+000537b0: 7273 0a20 2020 2020 2020 2023 2077 6964  rs.        # wid
+000537c0: 7468 203d 2038 300a 2020 2020 2020 2020  th = 80.        
+000537d0: 7465 726d 5f77 6964 7468 203d 2038 300a  term_width = 80.
+000537e0: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+000537f0: 226e 6f74 2069 6e20 7465 726d 696e 616c  "not in terminal
+00053800: 2c20 7573 696e 6720 6465 6661 756c 7420  , using default 
+00053810: 7465 726d 696e 616c 2077 6964 7468 2022  terminal width "
+00053820: 2c20 7465 726d 5f77 6964 7468 290a 2020  , term_width).  
+00053830: 2020 2020 2020 636f 6e20 3d20 2222 0a20        con = "". 
+00053840: 2020 2020 2020 2063 6f66 6620 3d20 2222         coff = ""
+00053850: 0a20 2020 2020 2020 2065 6f6e 203d 2022  .        eon = "
+00053860: 220a 2020 2020 2020 2020 656f 6666 203d  ".        eoff =
+00053870: 2022 220a 2020 2020 6966 2067 732e 7061   "".    if gs.pa
+00053880: 2e75 7361 6765 3a0a 2020 2020 2020 2020  .usage:.        
+00053890: 7072 696e 7428 7465 7874 7772 6170 2e66  print(textwrap.f
+000538a0: 696c 6c28 6170 2e64 6573 6372 6970 7469  ill(ap.descripti
+000538b0: 6f6e 2c20 7769 6474 683d 7465 726d 5f77  on, width=term_w
+000538c0: 6964 7468 2929 0a20 2020 2020 2020 2070  idth)).        p
+000538d0: 7269 6e74 2822 2229 0a20 2020 2020 2020  rint("").       
+000538e0: 2061 702e 7072 696e 745f 7573 6167 6528   ap.print_usage(
+000538f0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+00053900: 2222 290a 2020 2020 2020 2020 7072 696e  "").        prin
+00053910: 7428 7465 7874 7772 6170 2e66 696c 6c28  t(textwrap.fill(
+00053920: 6170 2e65 7069 6c6f 672c 2077 6964 7468  ap.epilog, width
+00053930: 3d74 6572 6d5f 7769 6474 6829 290a 2020  =term_width)).  
+00053940: 2020 2020 2020 7265 7475 726e 2030 0a20        return 0. 
+00053950: 2020 2069 6620 6773 2e70 612e 6865 6c70     if gs.pa.help
+00053960: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
+00053970: 7465 7874 7772 6170 2e66 696c 6c28 6170  textwrap.fill(ap
+00053980: 2e64 6573 6372 6970 7469 6f6e 2c20 7769  .description, wi
+00053990: 6474 683d 7465 726d 5f77 6964 7468 2929  dth=term_width))
+000539a0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+000539b0: 2229 0a20 2020 2020 2020 2070 7269 6e74  ").        print
+000539c0: 280a 2020 2020 2020 2020 2020 2020 7465  (.            te
+000539d0: 7874 7772 6170 2e66 696c 6c28 0a20 2020  xtwrap.fill(.   
+000539e0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+000539f0: 5052 4f47 5f57 4954 484f 5554 5f45 5854  PROG_WITHOUT_EXT
+00053a00: 7d20 7375 7070 6f72 7473 2074 6865 7365  } supports these
+00053a10: 2061 7267 756d 656e 7473 3a22 2c0a 2020   arguments:",.  
+00053a20: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+00053a30: 6474 683d 7465 726d 5f77 6964 7468 2c0a  dth=term_width,.
+00053a40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00053a50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00053a60: 2320 7072 696e 7428 2222 290a 2020 2020  # print("").    
+00053a70: 2020 2020 6865 6c70 5f68 656c 705f 7072      help_help_pr
+00053a80: 6520 3d20 2222 220a 3c2d 2d75 7361 6765  e = """.<--usage
+00053a90: 3e0a 5072 696e 7420 7573 6167 652e 0a3c  >.Print usage..<
+00053aa0: 2d68 3e2c 203c 2d2d 6865 6c70 3e0a 5072  -h>, <--help>.Pr
+00053ab0: 696e 7420 6865 6c70 2e0a 3c2d 2d6d 616e  int help..<--man
+00053ac0: 7561 6c3e 0a50 7269 6e74 206d 616e 7561  ual>.Print manua
+00053ad0: 6c2e 0a3c 2d2d 7265 6164 6d65 3e0a 5072  l..<--readme>.Pr
+00053ae0: 696e 7420 5245 4144 4d45 2e6d 6420 6669  int README.md fi
+00053af0: 6c65 2e0a 3c2d 643e 2c20 3c2d 2d64 6562  le..<-d>, <--deb
+00053b00: 7567 3e0a 5072 696e 7420 6465 6275 6720  ug>.Print debug 
+00053b10: 696e 666f 726d 6174 696f 6e2e 0a3c 2d2d  information..<--
+00053b20: 6c6f 672d 6c65 7665 6c3e 2044 4542 5547  log-level> DEBUG
+00053b30: 7c49 4e46 4f7c 5741 524e 494e 477c 4552  |INFO|WARNING|ER
+00053b40: 524f 527c 4352 4954 4943 414c 205b 4445  ROR|CRITICAL [DE
+00053b50: 4255 477c 494e 464f 7c57 4152 4e49 4e47  BUG|INFO|WARNING
+00053b60: 7c45 5252 4f52 7c43 5249 5449 4341 4c20  |ERROR|CRITICAL 
+00053b70: 2e2e 2e5d 0a53 6574 2074 6865 206c 6f67  ...].Set the log
+00053b80: 206c 6576 656c 2873 292e 0a3c 2d2d 7665   level(s)..<--ve
+00053b90: 7262 6f73 653e 0a53 6574 2074 6865 2076  rbose>.Set the v
+00053ba0: 6572 626f 7369 7479 206c 6576 656c 2e0a  erbosity level..
+00053bb0: 3c2d 2d6c 6f67 696e 3e20 5041 5353 574f  <--login> PASSWO
+00053bc0: 5244 7c53 534f 0a4c 6f67 696e 2074 6f20  RD|SSO.Login to 
+00053bd0: 616e 6420 6175 7468 656e 7469 6361 7465  and authenticate
+00053be0: 2077 6974 6820 7468 6520 4d61 7472 6978   with the Matrix
+00053bf0: 2068 6f6d 6573 6572 7665 722e 0a3c 2d2d   homeserver..<--
+00053c00: 7665 7269 6679 3e20 5b45 4d4f 4a49 5d0a  verify> [EMOJI].
+00053c10: 5065 7266 6f72 6d20 7665 7269 6669 6361  Perform verifica
+00053c20: 7469 6f6e 2e0a 3c2d 2d6c 6f67 6f75 743e  tion..<--logout>
+00053c30: 204d 457c 414c 4c0a 4c6f 676f 7574 2e0a   ME|ALL.Logout..
+00053c40: 3c2d 633e 2043 5245 4445 4e54 4941 4c53  <-c> CREDENTIALS
+00053c50: 5f46 494c 452c 203c 2d2d 6372 6564 656e  _FILE, <--creden
+00053c60: 7469 616c 733e 2043 5245 4445 4e54 4941  tials> CREDENTIA
+00053c70: 4c53 5f46 494c 450a 5370 6563 6966 7920  LS_FILE.Specify 
+00053c80: 6c6f 6361 7469 6f6e 206f 6620 6372 6564  location of cred
+00053c90: 656e 7469 616c 7320 6669 6c65 2e0a 3c2d  entials file..<-
+00053ca0: 733e 2053 544f 5245 5f44 4952 4543 544f  s> STORE_DIRECTO
+00053cb0: 5259 2c20 3c2d 2d73 746f 7265 3e20 5354  RY, <--store> ST
+00053cc0: 4f52 455f 4449 5245 4354 4f52 590a 5370  ORE_DIRECTORY.Sp
+00053cd0: 6563 6966 7920 6c6f 6361 7469 6f6e 206f  ecify location o
+00053ce0: 6620 7374 6f72 6520 6469 7265 6374 6f72  f store director
+00053cf0: 792e 0a3c 2d72 3e20 524f 4f4d 205b 524f  y..<-r> ROOM [RO
+00053d00: 4f4d 202e 2e2e 5d2c 203c 2d2d 726f 6f6d  OM ...], <--room
+00053d10: 3e20 524f 4f4d 205b 524f 4f4d 202e 2e2e  > ROOM [ROOM ...
+00053d20: 5d0a 5370 6563 6966 7920 6f6e 6520 6f72  ].Specify one or
+00053d30: 206d 756c 7469 706c 6520 726f 6f6d 732e   multiple rooms.
+00053d40: 0a3c 2d2d 726f 6f6d 2d64 6566 6175 6c74  .<--room-default
+00053d50: 3e20 4445 4641 554c 545f 524f 4f4d 0a53  > DEFAULT_ROOM.S
+00053d60: 7065 6369 6679 2074 6865 2064 6566 6175  pecify the defau
+00053d70: 6c74 2072 6f6f 6d20 6174 202d 2d6c 6f67  lt room at --log
+00053d80: 696e 2e0a 3c2d 2d72 6f6f 6d2d 6372 6561  in..<--room-crea
+00053d90: 7465 3e20 524f 4f4d 5f41 4c49 4153 205b  te> ROOM_ALIAS [
+00053da0: 524f 4f4d 5f41 4c49 4153 202e 2e2e 5d0a  ROOM_ALIAS ...].
+00053db0: 4372 6561 7465 206f 6e65 206f 7220 6d75  Create one or mu
+00053dc0: 6c74 6970 6c65 2072 6f6f 6d73 2066 6f72  ltiple rooms for
+00053dd0: 2067 6976 656e 2061 6c69 6173 2865 7329   given alias(es)
+00053de0: 2e0a 3c2d 2d72 6f6f 6d2d 646d 2d63 7265  ..<--room-dm-cre
+00053df0: 6174 653e 2055 5345 5220 5b55 5345 5220  ate> USER [USER 
+00053e00: 2e2e 2e5d 0a43 7265 6174 6520 6f6e 6520  ...].Create one 
+00053e10: 6f72 206d 756c 7469 706c 6520 444d 2072  or multiple DM r
+00053e20: 6f6f 6d73 2077 6974 6820 7468 6520 7370  ooms with the sp
+00053e30: 6563 6966 6965 6420 7573 6572 732e 0a3c  ecified users..<
+00053e40: 2d2d 726f 6f6d 2d6a 6f69 6e3e 2052 4f4f  --room-join> ROO
+00053e50: 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a4a 6f69  M [ROOM ...].Joi
+00053e60: 6e20 6f6e 6520 726f 6f6d 206f 7220 6d75  n one room or mu
+00053e70: 6c74 6970 6c65 2072 6f6f 6d73 2e0a 3c2d  ltiple rooms..<-
+00053e80: 2d72 6f6f 6d2d 6c65 6176 653e 2052 4f4f  -room-leave> ROO
+00053e90: 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a4c 6561  M [ROOM ...].Lea
+00053ea0: 7665 206f 6e65 2072 6f6f 6d20 6f72 206d  ve one room or m
+00053eb0: 756c 7469 706c 6520 726f 6f6d 732e 0a3c  ultiple rooms..<
+00053ec0: 2d2d 726f 6f6d 2d66 6f72 6765 743e 2052  --room-forget> R
+00053ed0: 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d 0a46  OOM [ROOM ...].F
+00053ee0: 6f72 6765 7420 6f6e 6520 726f 6f6d 206f  orget one room o
+00053ef0: 7220 6d75 6c74 6970 6c65 2072 6f6f 6d73  r multiple rooms
+00053f00: 2e0a 3c2d 2d72 6f6f 6d2d 696e 7669 7465  ..<--room-invite
+00053f10: 3e20 524f 4f4d 205b 524f 4f4d 202e 2e2e  > ROOM [ROOM ...
+00053f20: 5d0a 496e 7669 7465 206f 6e65 206f 7265  ].Invite one ore
+00053f30: 206d 6f72 6520 7573 6572 7320 746f 206a   more users to j
+00053f40: 6f69 6e20 6f6e 6520 6f72 206d 6f72 6520  oin one or more 
+00053f50: 726f 6f6d 732e 0a3c 2d2d 726f 6f6d 2d62  rooms..<--room-b
+00053f60: 616e 3e20 524f 4f4d 205b 524f 4f4d 202e  an> ROOM [ROOM .
+00053f70: 2e2e 5d0a 4261 6e20 6f6e 6520 6f72 6520  ..].Ban one ore 
+00053f80: 6d6f 7265 2075 7365 7273 2066 726f 6d20  more users from 
+00053f90: 6f6e 6520 6f72 206d 6f72 6520 726f 6f6d  one or more room
+00053fa0: 732e 0a3c 2d2d 726f 6f6d 2d75 6e62 616e  s..<--room-unban
+00053fb0: 3e20 524f 4f4d 205b 524f 4f4d 202e 2e2e  > ROOM [ROOM ...
+00053fc0: 5d0a 556e 6261 6e20 6f6e 6520 6f72 6520  ].Unban one ore 
+00053fd0: 6d6f 7265 2075 7365 7273 2066 726f 6d20  more users from 
+00053fe0: 6f6e 6520 6f72 206d 6f72 6520 726f 6f6d  one or more room
+00053ff0: 732e 0a3c 2d2d 726f 6f6d 2d6b 6963 6b3e  s..<--room-kick>
+00054000: 2052 4f4f 4d20 5b52 4f4f 4d20 2e2e 2e5d   ROOM [ROOM ...]
+00054010: 0a4b 6963 6b20 6f6e 6520 6f72 6520 6d6f  .Kick one ore mo
+00054020: 7265 2075 7365 7273 2066 726f 6d20 6f6e  re users from on
+00054030: 6520 6f72 206d 6f72 6520 726f 6f6d 732e  e or more rooms.
+00054040: 0a3c 2d75 3e20 5553 4552 205b 5553 4552  .<-u> USER [USER
+00054050: 202e 2e2e 5d2c 203c 2d2d 7573 6572 3e20   ...], <--user> 
+00054060: 5553 4552 205b 5553 4552 202e 2e2e 5d0a  USER [USER ...].
+00054070: 5370 6563 6966 7920 6f6e 6520 6f72 206d  Specify one or m
+00054080: 756c 7469 706c 6520 7573 6572 732e 0a3c  ultiple users..<
+00054090: 2d2d 7573 6572 2d6c 6f67 696e 3e20 5553  --user-login> US
+000540a0: 4552 0a53 7065 6369 6679 2075 7365 7220  ER.Specify user 
+000540b0: 666f 7220 2d2d 6c6f 6769 6e2e 0a3c 2d2d  for --login..<--
+000540c0: 6e61 6d65 3e20 524f 4f4d 5f4e 414d 4520  name> ROOM_NAME 
+000540d0: 5b52 4f4f 4d5f 4e41 4d45 202e 2e2e 5d0a  [ROOM_NAME ...].
+000540e0: 5370 6563 6966 7920 6f6e 6520 6f72 206d  Specify one or m
+000540f0: 756c 7469 706c 6520 726f 6f6d 206e 616d  ultiple room nam
+00054100: 6573 2e0a 3c2d 2d74 6f70 6963 3e20 524f  es..<--topic> RO
+00054110: 4f4d 5f54 4f50 4943 205b 524f 4f4d 5f54  OM_TOPIC [ROOM_T
+00054120: 4f50 4943 202e 2e2e 5d0a 5370 6563 6966  OPIC ...].Specif
+00054130: 7920 6f6e 6520 6f72 206d 756c 7469 706c  y one or multipl
+00054140: 6520 726f 6f6d 2074 6f70 6963 732e 0a3c  e room topics..<
+00054150: 2d2d 616c 6961 733e 2052 4f4f 4d5f 414c  --alias> ROOM_AL
+00054160: 4941 5320 5b52 4f4f 4d5f 414c 4941 5320  IAS [ROOM_ALIAS 
+00054170: 2e2e 2e5d 0a53 7065 6369 6679 206f 6e65  ...].Specify one
+00054180: 206f 7220 6d75 6c74 6970 6c65 2072 6f6f   or multiple roo
+00054190: 6d20 616c 6961 7365 732e 0a3c 2d6d 3e20  m aliases..<-m> 
+000541a0: 5445 5854 205b 5445 5854 202e 2e2e 5d2c  TEXT [TEXT ...],
+000541b0: 203c 2d2d 6d65 7373 6167 653e 2054 4558   <--message> TEX
+000541c0: 5420 5b54 4558 5420 2e2e 2e5d 0a53 656e  T [TEXT ...].Sen
+000541d0: 6420 6f6e 6520 6f72 206d 756c 7469 706c  d one or multipl
+000541e0: 6520 7465 7874 206d 6573 7361 6765 732e  e text messages.
+000541f0: 0a3c 2d69 3e20 494d 4147 455f 4649 4c45  .<-i> IMAGE_FILE
+00054200: 205b 494d 4147 455f 4649 4c45 202e 2e2e   [IMAGE_FILE ...
+00054210: 5d2c 203c 2d2d 696d 6167 653e 2049 4d41  ], <--image> IMA
+00054220: 4745 5f46 494c 4520 5b49 4d41 4745 5f46  GE_FILE [IMAGE_F
+00054230: 494c 4520 2e2e 2e5d 0a53 656e 6420 6f6e  ILE ...].Send on
+00054240: 6520 6f72 206d 756c 7469 706c 6520 696d  e or multiple im
+00054250: 6167 6520 6669 6c65 732e 0a3c 2d61 3e20  age files..<-a> 
+00054260: 4155 4449 4f5f 4649 4c45 205b 4155 4449  AUDIO_FILE [AUDI
+00054270: 4f5f 4649 4c45 202e 2e2e 5d2c 203c 2d2d  O_FILE ...], <--
+00054280: 6175 6469 6f3e 2041 5544 494f 5f46 494c  audio> AUDIO_FIL
+00054290: 4520 5b41 5544 494f 5f46 494c 4520 2e2e  E [AUDIO_FILE ..
+000542a0: 2e5d 0a53 656e 6420 6f6e 6520 6f72 206d  .].Send one or m
+000542b0: 756c 7469 706c 6520 6175 6469 6f20 6669  ultiple audio fi
+000542c0: 6c65 732e 0a3c 2d66 3e20 4649 4c45 205b  les..<-f> FILE [
+000542d0: 4649 4c45 202e 2e2e 5d2c 203c 2d2d 6669  FILE ...], <--fi
+000542e0: 6c65 3e20 4649 4c45 205b 4649 4c45 202e  le> FILE [FILE .
+000542f0: 2e2e 5d0a 5365 6e64 206f 6e65 206f 7220  ..].Send one or 
+00054300: 6d75 6c74 6970 6c65 2066 696c 6573 2028  multiple files (
+00054310: 652e 672e 2050 4446 2c20 444f 432c 204d  e.g. PDF, DOC, M
+00054320: 5034 292e 0a3c 2d65 3e20 4d41 5452 4958  P4)..<-e> MATRIX
+00054330: 5f4a 534f 4e5f 4f42 4a45 4354 205b 4d41  _JSON_OBJECT [MA
+00054340: 5452 4958 5f4a 534f 4e5f 4f42 4a45 4354  TRIX_JSON_OBJECT
+00054350: 202e 2e2e 5d2c 203c 2d2d 6576 656e 743e   ...], <--event>
+00054360: 204d 4154 5249 585f 4a53 4f4e 5f4f 424a   MATRIX_JSON_OBJ
+00054370: 4543 5420 5b4d 4154 5249 585f 4a53 4f4e  ECT [MATRIX_JSON
+00054380: 5f4f 424a 4543 5420 2e2e 2e5d 0a53 656e  _OBJECT ...].Sen
+00054390: 6420 6120 4d61 7472 6978 204a 534f 4e20  d a Matrix JSON 
+000543a0: 6576 656e 742e 0a3c 2d77 3e2c 203c 2d2d  event..<-w>, <--
+000543b0: 6874 6d6c 3e0a 5365 6e64 206d 6573 7361  html>.Send messa
+000543c0: 6765 2061 7320 666f 726d 6174 2022 4854  ge as format "HT
+000543d0: 4d4c 222e 0a3c 2d7a 3e2c 203c 2d2d 6d61  ML"..<-z>, <--ma
+000543e0: 726b 646f 776e 3e0a 5365 6e64 206d 6573  rkdown>.Send mes
+000543f0: 7361 6765 2061 7320 666f 726d 6174 2022  sage as format "
+00054400: 4d41 524b 444f 574e 222e 0a3c 2d6b 3e2c  MARKDOWN"..<-k>,
+00054410: 203c 2d2d 636f 6465 3e0a 5365 6e64 206d   <--code>.Send m
+00054420: 6573 7361 6765 2061 7320 666f 726d 6174  essage as format
+00054430: 2022 434f 4445 222e 0a3c 2d6a 3e2c 203c   "CODE"..<-j>, <
+00054440: 2d2d 656d 6f6a 697a 653e 0a53 656e 6420  --emojize>.Send 
+00054450: 6d65 7373 6167 6520 6166 7465 7220 656d  message after em
+00054460: 6f6a 697a 696e 672e 0a3c 2d70 3e20 5345  ojizing..<-p> SE
+00054470: 5041 5241 544f 522c 203c 2d2d 7370 6c69  PARATOR, <--spli
+00054480: 743e 2053 4550 4152 4154 4f52 0a53 706c  t> SEPARATOR.Spl
+00054490: 6974 206d 6573 7361 6765 2074 6578 7420  it message text 
+000544a0: 696e 746f 206d 756c 7469 706c 6520 4d61  into multiple Ma
+000544b0: 7472 6978 206d 6573 7361 6765 732e 0a3c  trix messages..<
+000544c0: 2d2d 636f 6e66 6967 3e20 434f 4e46 4947  --config> CONFIG
+000544d0: 5f46 494c 450a 5370 6563 6966 7920 7468  _FILE.Specify th
+000544e0: 6520 6c6f 6361 7469 6f6e 206f 6620 6120  e location of a 
+000544f0: 636f 6e66 6967 2066 696c 652e 0a3c 2d2d  config file..<--
+00054500: 7072 6f78 793e 2050 524f 5859 0a53 7065  proxy> PROXY.Spe
+00054510: 6369 6679 2061 2070 726f 7879 2066 6f72  cify a proxy for
+00054520: 2063 6f6e 6e65 6374 6976 6974 792e 0a3c   connectivity..<
+00054530: 2d6e 3e2c 203c 2d2d 6e6f 7469 6365 3e0a  -n>, <--notice>.
+00054540: 5365 6e64 206d 6573 7361 6765 2061 7320  Send message as 
+00054550: 6e6f 7469 6365 2e0a 3c2d 2d65 6e63 7279  notice..<--encry
+00054560: 7074 6564 3e0a 5365 6e64 206d 6573 7361  pted>.Send messa
+00054570: 6765 2065 6e64 2d74 6f2d 656e 6420 656e  ge end-to-end en
+00054580: 6372 7970 7465 642e 0a3c 2d6c 3e20 5b4e  crypted..<-l> [N
+00054590: 4556 4552 7c4f 4e43 457c 464f 5245 5645  EVER|ONCE|FOREVE
+000545a0: 527c 5441 494c 7c41 4c4c 5d2c 203c 2d2d  R|TAIL|ALL], <--
+000545b0: 6c69 7374 656e 3e20 5b4e 4556 4552 7c4f  listen> [NEVER|O
+000545c0: 4e43 457c 464f 5245 5645 527c 5441 494c  NCE|FOREVER|TAIL
+000545d0: 7c41 4c4c 5d0a 5072 696e 7420 7265 6365  |ALL].Print rece
+000545e0: 6976 6564 206d 6573 7361 6765 7320 616e  ived messages an
+000545f0: 6420 6c69 7374 656e 2074 6f20 6d65 7373  d listen to mess
+00054600: 6167 6573 2e0a 3c2d 743e 205b 4e55 4d42  ages..<-t> [NUMB
+00054610: 4552 5d2c 203c 2d2d 7461 696c 3e20 5b4e  ER], <--tail> [N
+00054620: 554d 4245 525d 0a50 7269 6e74 206c 6173  UMBER].Print las
+00054630: 7420 6d65 7373 6167 6573 2e0a 3c2d 793e  t messages..<-y>
+00054640: 2c20 3c2d 2d6c 6973 7465 6e2d 7365 6c66  , <--listen-self
+00054650: 3e0a 5072 696e 7420 796f 7572 206f 776e  >.Print your own
+00054660: 206d 6573 7361 6765 7320 6173 2077 656c   messages as wel
+00054670: 6c2e 0a3c 2d2d 7072 696e 742d 6576 656e  l..<--print-even
+00054680: 742d 6964 3e0a 5072 696e 7420 6576 656e  t-id>.Print even
+00054690: 7420 6964 7320 6f66 2072 6563 6569 7665  t ids of receive
+000546a0: 6420 6d65 7373 6167 6573 2e0a 3c2d 2d64  d messages..<--d
+000546b0: 6f77 6e6c 6f61 642d 6d65 6469 613e 205b  ownload-media> [
+000546c0: 444f 574e 4c4f 4144 5f44 4952 4543 544f  DOWNLOAD_DIRECTO
+000546d0: 5259 5d0a 446f 776e 6c6f 6164 206d 6564  RY].Download med
+000546e0: 6961 2066 696c 6573 2077 6869 6c65 206c  ia files while l
+000546f0: 6973 7465 6e69 6e67 2e0a 3c2d 2d6f 732d  istening..<--os-
+00054700: 6e6f 7469 6679 3e0a 4e6f 7469 6679 206d  notify>.Notify m
+00054710: 6520 6f66 2061 7272 6976 696e 6720 6d65  e of arriving me
+00054720: 7373 6167 6573 2e0a 3c2d 2d73 6574 2d64  ssages..<--set-d
+00054730: 6576 6963 652d 6e61 6d65 3e20 4445 5649  evice-name> DEVI
+00054740: 4345 5f4e 414d 450a 5365 7420 6f72 2072  CE_NAME.Set or r
+00054750: 656e 616d 6520 7468 6520 6375 7272 656e  ename the curren
+00054760: 7420 6465 7669 6365 2e0a 3c2d 2d73 6574  t device..<--set
+00054770: 2d64 6973 706c 6179 2d6e 616d 653e 2044  -display-name> D
+00054780: 4953 504c 4159 5f4e 414d 450a 5365 7420  ISPLAY_NAME.Set 
+00054790: 6f72 2072 656e 616d 6520 7468 6520 6469  or rename the di
+000547a0: 7370 6c61 7920 6e61 6d65 2e0a 3c2d 2d67  splay name..<--g
+000547b0: 6574 2d64 6973 706c 6179 2d6e 616d 653e  et-display-name>
+000547c0: 0a47 6574 2074 6865 2064 6973 706c 6179  .Get the display
+000547d0: 206e 616d 6520 6f66 2079 6f75 7273 656c   name of yoursel
+000547e0: 662e 0a3c 2d2d 7365 742d 7072 6573 656e  f..<--set-presen
+000547f0: 6365 3e20 4f4e 4c49 4e45 7c4f 4646 4c49  ce> ONLINE|OFFLI
+00054800: 4e45 7c55 4e41 5641 494c 4142 4c45 0a53  NE|UNAVAILABLE.S
+00054810: 6574 2079 6f75 7220 7072 6573 656e 6365  et your presence
+00054820: 2e0a 3c2d 2d67 6574 2d70 7265 7365 6e63  ..<--get-presenc
+00054830: 653e 0a47 6574 2079 6f75 7220 7072 6573  e>.Get your pres
+00054840: 656e 6365 2e0a 3c2d 2d75 706c 6f61 643e  ence..<--upload>
+00054850: 2046 494c 4520 5b46 494c 4520 2e2e 2e5d   FILE [FILE ...]
+00054860: 0a55 706c 6f61 6420 6f6e 6520 6f72 206d  .Upload one or m
+00054870: 756c 7469 706c 6520 6669 6c65 7320 746f  ultiple files to
+00054880: 2074 6865 2063 6f6e 7465 6e74 2072 6570   the content rep
+00054890: 6f73 6974 6f72 792e 0a3c 2d2d 646f 776e  ository..<--down
+000548a0: 6c6f 6164 3e20 4d58 435f 5552 4920 5b4d  load> MXC_URI [M
+000548b0: 5843 5f55 5249 202e 2e2e 5d0a 446f 776e  XC_URI ...].Down
+000548c0: 6c6f 6164 206f 6e65 206f 7220 6d75 6c74  load one or mult
+000548d0: 6970 6c65 2066 696c 6573 2066 726f 6d20  iple files from 
+000548e0: 7468 6520 636f 6e74 656e 7420 7265 706f  the content repo
+000548f0: 7369 746f 7279 2e0a 3c2d 2d64 656c 6574  sitory..<--delet
+00054900: 652d 6d78 633e 204d 5843 5f55 5249 205b  e-mxc> MXC_URI [
+00054910: 4d58 435f 5552 4920 2e2e 2e5d 0a44 656c  MXC_URI ...].Del
+00054920: 6574 6520 6f6e 6520 6f72 206d 756c 7469  ete one or multi
+00054930: 706c 6520 6f62 6a65 6374 7320 6672 6f6d  ple objects from
+00054940: 2074 6865 2063 6f6e 7465 6e74 2072 6570   the content rep
+00054950: 6f73 6974 6f72 792e 0a3c 2d2d 6465 6c65  ository..<--dele
+00054960: 7465 2d6d 7863 2d62 6566 6f72 653e 2054  te-mxc-before> T
+00054970: 494d 4553 5441 4d50 205b 5449 4d45 5354  IMESTAMP [TIMEST
+00054980: 414d 5020 2e2e 2e5d 0a44 656c 6574 6520  AMP ...].Delete 
+00054990: 6f6c 6420 6f62 6a65 6374 7320 6672 6f6d  old objects from
+000549a0: 2074 6865 2063 6f6e 7465 6e74 2072 6570   the content rep
+000549b0: 6f73 6974 6f72 790a 3c2d 2d6a 6f69 6e65  ository.<--joine
+000549c0: 642d 726f 6f6d 733e 0a50 7269 6e74 2074  d-rooms>.Print t
+000549d0: 6865 206c 6973 7420 6f66 206a 6f69 6e65  he list of joine
+000549e0: 6420 726f 6f6d 732e 0a3c 2d2d 6a6f 696e  d rooms..<--join
+000549f0: 6564 2d6d 656d 6265 7273 3e20 524f 4f4d  ed-members> ROOM
+00054a00: 205b 524f 4f4d 202e 2e2e 5d0a 5072 696e   [ROOM ...].Prin
+00054a10: 7420 7468 6520 6c69 7374 206f 6620 6a6f  t the list of jo
+00054a20: 696e 6564 206d 656d 6265 7273 2066 6f72  ined members for
+00054a30: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
+00054a40: 2072 6f6f 6d73 2e0a 3c2d 2d6d 7863 2d74   rooms..<--mxc-t
+00054a50: 6f2d 6874 7470 3e20 4d58 435f 5552 4920  o-http> MXC_URI 
+00054a60: 5b4d 5843 5f55 5249 202e 2e2e 5d0a 436f  [MXC_URI ...].Co
+00054a70: 6e76 6572 7420 4d58 4320 5552 4973 2074  nvert MXC URIs t
+00054a80: 6f20 4854 5450 2055 524c 732e 0a3c 2d2d  o HTTP URLs..<--
+00054a90: 6465 7669 6365 732c 3e20 3c2d 2d67 6574  devices,> <--get
+00054aa0: 2d64 6576 6963 6573 3e0a 5072 696e 7420  -devices>.Print 
+00054ab0: 7468 6520 6c69 7374 206f 6620 6465 7669  the list of devi
+00054ac0: 6365 732e 0a3c 2d2d 6469 7363 6f76 6572  ces..<--discover
+00054ad0: 792d 696e 666f 3e0a 5072 696e 7420 6469  y-info>.Print di
+00054ae0: 7363 6f76 6572 7920 696e 666f 726d 6174  scovery informat
+00054af0: 696f 6e20 6162 6f75 7420 6375 7272 656e  ion about curren
+00054b00: 7420 686f 6d65 7365 7276 6572 2e0a 3c2d  t homeserver..<-
+00054b10: 2d6c 6f67 696e 2d69 6e66 6f3e 0a50 7269  -login-info>.Pri
+00054b20: 6e74 206c 6f67 696e 206d 6574 686f 6473  nt login methods
+00054b30: 2073 7570 706f 7274 6564 2062 7920 7468   supported by th
+00054b40: 6520 686f 6d65 7365 7276 6572 2e0a 3c2d  e homeserver..<-
+00054b50: 2d63 6f6e 7465 6e74 2d72 6570 6f73 6974  -content-reposit
+00054b60: 6f72 792d 636f 6e66 6967 3e0a 5072 696e  ory-config>.Prin
+00054b70: 7420 7468 6520 636f 6e74 656e 7420 7265  t the content re
+00054b80: 706f 7369 746f 7279 2063 6f6e 6669 6775  pository configu
+00054b90: 7261 7469 6f6e 2e0a 3c2d 2d72 6573 743e  ration..<--rest>
+00054ba0: 2052 4553 545f 4d45 5448 4f44 2044 4154   REST_METHOD DAT
+00054bb0: 4120 5552 4c20 5b52 4553 545f 4d45 5448  A URL [REST_METH
+00054bc0: 4f44 2044 4154 4120 5552 4c20 2e2e 2e5d  OD DATA URL ...]
+00054bd0: 0a55 7365 2074 6865 204d 6174 7269 7820  .Use the Matrix 
+00054be0: 436c 6965 6e74 2052 4553 5420 4150 492e  Client REST API.
+00054bf0: 0a3c 2d2d 7365 742d 6176 6174 6172 3e20  .<--set-avatar> 
+00054c00: 4156 4154 4152 5f4d 5843 5f55 5249 0a53  AVATAR_MXC_URI.S
+00054c10: 6574 2079 6f75 7220 6176 6174 6172 2e0a  et your avatar..
+00054c20: 3c2d 2d67 6574 2d61 7661 7461 723e 205b  <--get-avatar> [
+00054c30: 5553 4552 202e 2e2e 5d0a 4765 7420 616e  USER ...].Get an
+00054c40: 2061 7661 7461 722e 0a3c 2d2d 6765 742d   avatar..<--get-
+00054c50: 7072 6f66 696c 653e 205b 5553 4552 202e  profile> [USER .
+00054c60: 2e2e 5d0a 4765 7420 6120 7573 6572 2070  ..].Get a user p
+00054c70: 726f 6669 6c65 2e0a 3c2d 2d67 6574 2d72  rofile..<--get-r
+00054c80: 6f6f 6d2d 696e 666f 3e20 5b52 4f4f 4d20  oom-info> [ROOM 
+00054c90: 2e2e 2e5d 0a47 6574 2074 6865 2072 6f6f  ...].Get the roo
+00054ca0: 6d20 696e 666f 726d 6174 696f 6e2e 0a3c  m information..<
+00054cb0: 2d2d 6765 742d 636c 6965 6e74 2d69 6e66  --get-client-inf
+00054cc0: 6f3e 0a50 7269 6e74 2063 6c69 656e 7420  o>.Print client 
+00054cd0: 696e 666f 726d 6174 696f 6e2e 0a3c 2d2d  information..<--
+00054ce0: 6861 732d 7065 726d 6973 7369 6f6e 3e20  has-permission> 
+00054cf0: 524f 4f4d 2042 414e 7c49 4e56 4954 457c  ROOM BAN|INVITE|
+00054d00: 4b49 434b 7c4e 4f54 4946 4943 4154 494f  KICK|NOTIFICATIO
+00054d10: 4e53 7c52 4544 4143 547c 6574 6320 5b52  NS|REDACT|etc [R
+00054d20: 4f4f 4d20 4241 4e7c 494e 5649 5445 7c4b  OOM BAN|INVITE|K
+00054d30: 4943 4b7c 4e4f 5449 4649 4341 5449 4f4e  ICK|NOTIFICATION
+00054d40: 537c 5245 4441 4354 7c65 7463 202e 2e2e  S|REDACT|etc ...
+00054d50: 5d0a 496e 7175 6972 6520 6162 6f75 7420  ].Inquire about 
+00054d60: 7065 726d 6973 7369 6f6e 732e 0a3c 2d2d  permissions..<--
+00054d70: 696d 706f 7274 2d6b 6579 733e 2046 494c  import-keys> FIL
+00054d80: 4520 5041 5353 5048 5241 5345 2046 494c  E PASSPHRASE FIL
+00054d90: 4520 5041 5353 5048 5241 5345 0a49 6d70  E PASSPHRASE.Imp
+00054da0: 6f72 7420 4d65 676f 6c6d 2064 6563 7279  ort Megolm decry
+00054db0: 7074 696f 6e20 6b65 7973 2066 726f 6d20  ption keys from 
+00054dc0: 6120 6669 6c65 2e0a 3c2d 2d65 7870 6f72  a file..<--expor
+00054dd0: 742d 6b65 7973 3e20 4649 4c45 2050 4153  t-keys> FILE PAS
+00054de0: 5350 4852 4153 4520 4649 4c45 2050 4153  SPHRASE FILE PAS
+00054df0: 5350 4852 4153 450a 4578 706f 7274 2061  SPHRASE.Export a
+00054e00: 6c6c 2074 6865 204d 6567 6f6c 6d20 6465  ll the Megolm de
+00054e10: 6372 7970 7469 6f6e 206b 6579 7320 6f66  cryption keys of
+00054e20: 2074 6869 7320 6465 7669 6365 2e0a 3c2d   this device..<-
+00054e30: 2d72 6f6f 6d2d 7365 742d 616c 6961 733e  -room-set-alias>
+00054e40: 2052 4f4f 4d5f 414c 4941 5320 524f 4f4d   ROOM_ALIAS ROOM
+00054e50: 205b 524f 4f4d 5f41 4c49 4153 2052 4f4f   [ROOM_ALIAS ROO
+00054e60: 4d20 2e2e 2e5d 2c20 3c2d 2d72 6f6f 6d2d  M ...], <--room-
+00054e70: 7075 742d 616c 6961 733e 2052 4f4f 4d5f  put-alias> ROOM_
+00054e80: 414c 4941 5320 524f 4f4d 205b 524f 4f4d  ALIAS ROOM [ROOM
+00054e90: 5f41 4c49 4153 2052 4f4f 4d20 2e2e 2e5d  _ALIAS ROOM ...]
+00054ea0: 0a41 6464 2061 6c69 6173 6573 2074 6f20  .Add aliases to 
+00054eb0: 726f 6f6d 732e 0a3c 2d2d 726f 6f6d 2d72  rooms..<--room-r
+00054ec0: 6573 6f6c 7665 2d61 6c69 6173 3e20 524f  esolve-alias> RO
+00054ed0: 4f4d 5f41 4c49 4153 205b 524f 4f4d 5f41  OM_ALIAS [ROOM_A
+00054ee0: 4c49 4153 202e 2e2e 5d0a 5368 6f77 2072  LIAS ...].Show r
+00054ef0: 6f6f 6d20 6964 7320 636f 7272 6573 706f  oom ids correspo
+00054f00: 6e64 696e 6720 746f 2072 6f6f 6d20 616c  nding to room al
+00054f10: 6961 7365 732e 0a3c 2d2d 726f 6f6d 2d64  iases..<--room-d
+00054f20: 656c 6574 652d 616c 6961 733e 2052 4f4f  elete-alias> ROO
+00054f30: 4d5f 414c 4941 5320 5b52 4f4f 4d5f 414c  M_ALIAS [ROOM_AL
+00054f40: 4941 5320 2e2e 2e5d 0a44 656c 6574 6520  IAS ...].Delete 
+00054f50: 6f6e 6520 6f72 206d 756c 7469 706c 6520  one or multiple 
+00054f60: 726f 6f6d 7320 616c 6961 7365 732e 0a3c  rooms aliases..<
+00054f70: 2d2d 6765 742d 6f70 656e 6964 2d74 6f6b  --get-openid-tok
+00054f80: 656e 3e20 5b55 5345 5220 2e2e 2e5d 0a47  en> [USER ...].G
+00054f90: 6574 2061 6e20 4f70 656e 4944 2074 6f6b  et an OpenID tok
+00054fa0: 656e 2e0a 3c2d 2d72 6f6f 6d2d 6765 742d  en..<--room-get-
+00054fb0: 7669 7369 6269 6c69 7479 3e20 5b52 4f4f  visibility> [ROO
+00054fc0: 4d20 2e2e 2e5d 0a47 6574 2074 6865 2076  M ...].Get the v
+00054fd0: 6973 6962 696c 6974 7920 6f66 206f 6e65  isibility of one
+00054fe0: 206f 7220 6d6f 7265 2072 6f6f 6d73 2e0a   or more rooms..
+00054ff0: 3c2d 2d72 6f6f 6d2d 6765 742d 7374 6174  <--room-get-stat
+00055000: 653e 205b 524f 4f4d 202e 2e2e 5d0a 4765  e> [ROOM ...].Ge
+00055010: 7420 7468 6520 7374 6174 6520 6f66 206f  t the state of o
+00055020: 6e65 206f 7220 6d6f 7265 2072 6f6f 6d73  ne or more rooms
+00055030: 2e0a 3c2d 2d64 656c 6574 652d 6465 7669  ..<--delete-devi
+00055040: 6365 3e20 4445 5649 4345 205b 4445 5649  ce> DEVICE [DEVI
+00055050: 4345 202e 2e2e 5d0a 4465 6c65 7465 206f  CE ...].Delete o
+00055060: 6e65 206f 7220 6d75 6c74 6970 6c65 2064  ne or multiple d
+00055070: 6576 6963 6573 2e0a 3c2d 2d72 6f6f 6d2d  evices..<--room-
+00055080: 7265 6461 6374 3e20 524f 4f4d 5f49 4420  redact> ROOM_ID 
+00055090: 4556 454e 545f 4944 2052 4541 534f 4e20  EVENT_ID REASON 
+000550a0: 5b52 4f4f 4d5f 4944 2045 5645 4e54 5f49  [ROOM_ID EVENT_I
+000550b0: 4420 5245 4153 4f4e 202e 2e2e 5d2c 203c  D REASON ...], <
+000550c0: 2d2d 726f 6f6d 2d64 656c 6574 652d 636f  --room-delete-co
+000550d0: 6e74 656e 743e 2052 4f4f 4d5f 4944 2045  ntent> ROOM_ID E
+000550e0: 5645 4e54 5f49 4420 5245 4153 4f4e 205b  VENT_ID REASON [
+000550f0: 524f 4f4d 5f49 4420 4556 454e 545f 4944  ROOM_ID EVENT_ID
+00055100: 2052 4541 534f 4e20 2e2e 2e5d 0a53 7472   REASON ...].Str
+00055110: 6970 2069 6e66 6f72 6d61 7469 6f6e 206f  ip information o
+00055120: 7574 206f 6620 6f6e 6520 6f72 2073 6576  ut of one or sev
+00055130: 6572 616c 2065 7665 6e74 732e 0a3c 2d2d  eral events..<--
+00055140: 7768 6f61 6d69 3e0a 5072 696e 7420 796f  whoami>.Print yo
+00055150: 7572 2075 7365 7220 6964 2e0a 3c2d 2d6e  ur user id..<--n
+00055160: 6f2d 7373 6c3e 0a53 6b69 7020 5353 4c20  o-ssl>.Skip SSL 
+00055170: 7665 7269 6669 6361 7469 6f6e 2e0a 3c2d  verification..<-
+00055180: 2d73 736c 2d63 6572 7469 6669 6361 7465  -ssl-certificate
+00055190: 3e20 5353 4c5f 4345 5254 4946 4943 4154  > SSL_CERTIFICAT
+000551a0: 455f 4649 4c45 0a55 7365 2079 6f75 7220  E_FILE.Use your 
+000551b0: 6f77 6e20 5353 4c20 6365 7274 6966 6963  own SSL certific
+000551c0: 6174 652e 0a3c 2d2d 6669 6c65 2d6e 616d  ate..<--file-nam
+000551d0: 653e 2046 494c 4520 5b46 494c 4520 2e2e  e> FILE [FILE ..
+000551e0: 2e5d 0a53 7065 6369 6679 206f 6e65 206f  .].Specify one o
+000551f0: 7220 6d75 6c74 6970 6c65 2066 696c 6520  r multiple file 
+00055200: 6e61 6d65 7320 666f 7220 736f 6d65 2061  names for some a
+00055210: 6374 696f 6e73 2e0a 3c2d 2d6b 6579 2d64  ctions..<--key-d
+00055220: 6963 743e 204b 4559 5f44 4943 5449 4f4e  ict> KEY_DICTION
+00055230: 4152 5920 5b4b 4559 5f44 4943 5449 4f4e  ARY [KEY_DICTION
+00055240: 4152 5920 2e2e 2e5d 0a53 7065 6369 6679  ARY ...].Specify
+00055250: 206f 6e65 206f 7220 6d75 6c74 6970 6c65   one or multiple
+00055260: 206b 6579 2064 6963 7469 6f6e 6172 6965   key dictionarie
+00055270: 7320 666f 7220 6465 6372 7970 7469 6f6e  s for decryption
+00055280: 2e0a 3c2d 2d70 6c61 696e 3e0a 4469 7361  ..<--plain>.Disa
+00055290: 626c 6520 656e 6372 7970 7469 6f6e 2066  ble encryption f
+000552a0: 6f72 2061 2073 7065 6369 6669 6320 6163  or a specific ac
+000552b0: 7469 6f6e 2e0a 3c2d 2d73 6570 6172 6174  tion..<--separat
+000552c0: 6f72 3e20 5345 5041 5241 544f 520a 5365  or> SEPARATOR.Se
+000552d0: 7420 6120 6375 7374 6f6d 2073 6570 6172  t a custom separ
+000552e0: 6174 6f72 2075 7365 6420 666f 7220 6365  ator used for ce
+000552f0: 7274 6169 6e20 7072 696e 7420 6f75 7473  rtain print outs
+00055300: 2e0a 3c2d 2d61 6363 6573 732d 746f 6b65  ..<--access-toke
+00055310: 6e3e 2041 4343 4553 535f 544f 4b45 4e0a  n> ACCESS_TOKEN.
+00055320: 5365 7420 6120 6375 7374 6f6d 2061 6363  Set a custom acc
+00055330: 6573 7320 746f 6b65 6e20 666f 7220 7573  ess token for us
+00055340: 6520 6279 2063 6572 7461 696e 2061 6374  e by certain act
+00055350: 696f 6e73 2e0a 3c2d 2d70 6173 7377 6f72  ions..<--passwor
+00055360: 643e 2050 4153 5357 4f52 440a 5370 6563  d> PASSWORD.Spec
+00055370: 6966 7920 6120 7061 7373 776f 7264 2066  ify a password f
+00055380: 6f72 2075 7365 2062 7920 6365 7274 6169  or use by certai
+00055390: 6e20 6163 7469 6f6e 732e 0a3c 2d2d 686f  n actions..<--ho
+000553a0: 6d65 7365 7276 6572 3e20 484f 4d45 5345  meserver> HOMESE
+000553b0: 5256 4552 5f55 524c 0a53 7065 6369 6679  RVER_URL.Specify
+000553c0: 2061 2068 6f6d 6573 6572 7665 7220 666f   a homeserver fo
+000553d0: 7220 7573 6520 6279 2063 6572 7461 696e  r use by certain
+000553e0: 2061 6374 696f 6e73 2e0a 3c2d 2d64 6576   actions..<--dev
+000553f0: 6963 653e 2044 4556 4943 455f 4e41 4d45  ice> DEVICE_NAME
+00055400: 0a53 7065 6369 6679 2061 2064 6576 6963  .Specify a devic
+00055410: 6520 6e61 6d65 2c20 666f 7220 7573 6520  e name, for use 
+00055420: 6279 2063 6572 7461 696e 2061 6374 696f  by certain actio
+00055430: 6e73 2e0a 3c2d 2d73 796e 633e 2046 554c  ns..<--sync> FUL
+00055440: 4c7c 4f46 460a 4368 6f6f 7365 2073 796e  L|OFF.Choose syn
+00055450: 6368 726f 6e69 7a61 7469 6f6e 206f 7074  chronization opt
+00055460: 696f 6e73 2e0a 3c2d 6f3e 2054 4558 547c  ions..<-o> TEXT|
+00055470: 4a53 4f4e 7c4a 534f 4e2d 4d41 587c 4a53  JSON|JSON-MAX|JS
+00055480: 4f4e 2d53 5045 432c 203c 2d2d 6f75 7470  ON-SPEC, <--outp
+00055490: 7574 3e20 5445 5854 7c4a 534f 4e7c 4a53  ut> TEXT|JSON|JS
+000554a0: 4f4e 2d4d 4158 7c4a 534f 4e2d 5350 4543  ON-MAX|JSON-SPEC
+000554b0: 0a53 656c 6563 7420 616e 206f 7574 7075  .Select an outpu
+000554c0: 7420 666f 726d 6174 2e0a 3c2d 2d72 6f6f  t format..<--roo
+000554d0: 6d2d 696e 7669 7465 733e 205b 4c49 5354  m-invites> [LIST
+000554e0: 7c4a 4f49 4e7c 4c49 5354 2b4a 4f49 4e5d  |JOIN|LIST+JOIN]
+000554f0: 0a4c 6973 7420 726f 6f6d 2069 6e76 6974  .List room invit
+00055500: 6174 696f 6e73 2061 6e64 2f6f 7220 6a6f  ations and/or jo
+00055510: 696e 2069 6e76 6974 6564 2072 6f6f 6d73  in invited rooms
+00055520: 2e0a 3c2d 763e 205b 5052 494e 547c 4348  ..<-v> [PRINT|CH
+00055530: 4543 4b5d 2c20 2d56 205b 5052 494e 547c  ECK], -V [PRINT|
+00055540: 4348 4543 4b5d 2c20 3c2d 2d76 6572 7369  CHECK], <--versi
+00055550: 6f6e 3e20 5b50 5249 4e54 7c43 4845 434b  on> [PRINT|CHECK
+00055560: 5d0a 5072 696e 7420 7665 7273 696f 6e20  ].Print version 
+00055570: 696e 666f 726d 6174 696f 6e20 6f72 2063  information or c
+00055580: 6865 636b 2066 6f72 2075 7064 6174 6573  heck for updates
+00055590: 2e0a 2222 222e 7265 706c 6163 6528 0a20  ..""".replace(. 
+000555a0: 2020 2020 2020 2020 2020 2022 3c22 2c20             "<", 
+000555b0: 656f 6e0a 2020 2020 2020 2020 292e 7265  eon.        ).re
+000555c0: 706c 6163 6528 0a20 2020 2020 2020 2020  place(.         
+000555d0: 2020 2022 3e22 2c20 656f 6666 0a20 2020     ">", eoff.   
+000555e0: 2020 2020 2029 0a20 2020 2020 2020 2068       ).        h
+000555f0: 6561 6465 7220 3d20 4661 6c73 6520 2023  eader = False  #
+00055600: 2066 6972 7374 206c 696e 6520 6973 206e   first line is n
+00055610: 6577 6c69 6e65 0a20 2020 2020 2020 2066  ewline.        f
+00055620: 6f72 206c 696e 6520 696e 2068 656c 705f  or line in help_
+00055630: 6865 6c70 5f70 7265 2e73 706c 6974 2822  help_pre.split("
+00055640: 5c6e 2229 3a0a 2020 2020 2020 2020 2020  \n"):.          
+00055650: 2020 6966 2068 6561 6465 723a 0a20 2020    if header:.   
+00055660: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00055670: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
+00055680: 2020 2020 2020 2020 7465 7874 7772 6170          textwrap
+00055690: 2e66 696c 6c28 636f 6e20 2b20 6c69 6e65  .fill(con + line
+000556a0: 202b 2063 6f66 662c 2077 6964 7468 3d74   + coff, width=t
+000556b0: 6572 6d5f 7769 6474 6829 2c0a 2020 2020  erm_width),.    
+000556c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000556d0: 666c 7573 683d 5472 7565 2c0a 2020 2020  flush=True,.    
+000556e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000556f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00055700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055710: 7072 696e 7428 0a20 2020 2020 2020 2020  print(.         
+00055720: 2020 2020 2020 2020 2020 2074 6578 7477             textw
+00055730: 7261 702e 696e 6465 6e74 280a 2020 2020  rap.indent(.    
+00055740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055750: 2020 2020 7465 7874 7772 6170 2e66 696c      textwrap.fil
+00055760: 6c28 6c69 6e65 2c20 7769 6474 683d 7465  l(line, width=te
+00055770: 726d 5f77 6964 7468 202d 2032 292c 2022  rm_width - 2), "
+00055780: 2020 220a 2020 2020 2020 2020 2020 2020    ".            
+00055790: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+000557a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000557b0: 6c75 7368 3d54 7275 652c 0a20 2020 2020  lush=True,.     
+000557c0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000557d0: 2020 2020 2020 2020 2020 6865 6164 6572            header
+000557e0: 203d 206e 6f74 2068 6561 6465 720a 2020   = not header.  
+000557f0: 2020 2020 2020 2320 7072 696e 7428 2222        # print(""
+00055800: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+00055810: 7465 7874 7772 6170 2e66 696c 6c28 6170  textwrap.fill(ap
+00055820: 2e65 7069 6c6f 672c 2077 6964 7468 3d74  .epilog, width=t
+00055830: 6572 6d5f 7769 6474 6829 290a 2020 2020  erm_width)).    
+00055840: 2020 2020 7265 7475 726e 2030 0a20 2020      return 0.   
+00055850: 2069 6620 6773 2e70 612e 6d61 6e75 616c   if gs.pa.manual
+00055860: 3a0a 2020 2020 2020 2020 6465 7363 7269  :.        descri
+00055870: 7074 696f 6e20 3d20 280a 2020 2020 2020  ption = (.      
+00055880: 2020 2020 2020 6622 5765 6c63 6f6d 6520        f"Welcome 
+00055890: 746f 207b 5052 4f47 5f57 4954 484f 5554  to {PROG_WITHOUT
+000558a0: 5f45 5854 7d2c 2061 204d 6174 7269 7820  _EXT}, a Matrix 
+000558b0: 434c 4920 636c 6965 6e74 2e20 e294 80e2  CLI client. ....
+000558c0: 9480 e294 8020 220a 2020 2020 2020 2020  ..... ".        
+000558d0: 2020 2020 224f 6e20 6669 7273 7420 7275      "On first ru
+000558e0: 6e20 7573 6520 2d2d 6c6f 6769 6e20 746f  n use --login to
+000558f0: 206c 6f67 2069 6e2c 2074 6f20 6175 7468   log in, to auth
+00055900: 656e 7469 6361 7465 2e20 220a 2020 2020  enticate. ".    
+00055910: 2020 2020 2020 2020 224f 6e20 7365 636f          "On seco
+00055920: 6e64 2072 756e 2077 6520 7375 6767 6573  nd run we sugges
+00055930: 7420 746f 2075 7365 202d 2d76 6572 6966  t to use --verif
+00055940: 7920 746f 2067 6574 2076 6572 6966 6965  y to get verifie
+00055950: 642e 2022 0a20 2020 2020 2020 2020 2020  d. ".           
+00055960: 2022 456d 6f6a 6920 7665 7269 6669 6361   "Emoji verifica
+00055970: 7469 6f6e 2069 7320 6275 696c 742d 696e  tion is built-in
+00055980: 2077 6869 6368 2063 616e 2062 6520 7573   which can be us
+00055990: 6564 2022 0a20 2020 2020 2020 2020 2020  ed ".           
+000559a0: 2022 746f 2076 6572 6966 7920 6465 7669   "to verify devi
+000559b0: 6365 732e 2022 0a20 2020 2020 2020 2020  ces. ".         
+000559c0: 2020 2022 4f6e 2066 7572 7468 6572 2072     "On further r
+000559d0: 756e 7320 7468 6973 2070 726f 6772 616d  uns this program
+000559e0: 2069 6d70 6c65 6d65 6e74 7320 6120 7369   implements a si
+000559f0: 6d70 6c65 204d 6174 7269 7820 434c 4920  mple Matrix CLI 
+00055a00: 220a 2020 2020 2020 2020 2020 2020 2263  ".            "c
+00055a10: 6c69 656e 7420 7468 6174 2063 616e 2073  lient that can s
+00055a20: 656e 6420 6d65 7373 6167 6573 2c20 6c69  end messages, li
+00055a30: 7374 656e 2074 6f20 6d65 7373 6167 6573  sten to messages
+00055a40: 2c20 7665 7269 6679 2022 0a20 2020 2020  , verify ".     
+00055a50: 2020 2020 2020 2022 6465 7669 6365 732c         "devices,
+00055a60: 2065 7463 2e20 4974 2063 616e 2073 656e   etc. It can sen
+00055a70: 6420 6f6e 6520 6f72 206d 756c 7469 706c  d one or multipl
+00055a80: 6520 6d65 7373 6167 6520 746f 206f 6e65  e message to one
+00055a90: 206f 7220 220a 2020 2020 2020 2020 2020   or ".          
+00055aa0: 2020 226d 756c 7469 706c 6520 4d61 7472    "multiple Matr
+00055ab0: 6978 2072 6f6f 6d73 2061 6e64 2f6f 7220  ix rooms and/or 
+00055ac0: 7573 6572 732e 2054 6865 2074 6578 7420  users. The text 
+00055ad0: 6d65 7373 6167 6573 2063 616e 2062 6520  messages can be 
+00055ae0: 220a 2020 2020 2020 2020 2020 2020 226f  ".            "o
+00055af0: 6620 7661 7269 6f75 7320 220a 2020 2020  f various ".    
+00055b00: 2020 2020 2020 2020 2766 6f72 6d61 7473          'formats
+00055b10: 2073 7563 6820 6173 2022 7465 7874 222c   such as "text",
+00055b20: 2022 6874 6d6c 222c 2022 6d61 726b 646f   "html", "markdo
+00055b30: 776e 2220 6f72 2022 636f 6465 222e 2027  wn" or "code". '
+00055b40: 0a20 2020 2020 2020 2020 2020 2022 496d  .            "Im
+00055b50: 6167 6573 2c20 6175 6469 6f2c 2061 7262  ages, audio, arb
+00055b60: 6974 7261 7279 2066 696c 6573 2c20 6f72  itrary files, or
+00055b70: 2065 7665 6e74 7320 6361 6e20 6265 2073   events can be s
+00055b80: 656e 7420 6173 2077 656c 6c2e 2022 0a20  ent as well. ". 
+00055b90: 2020 2020 2020 2020 2020 2022 466f 7220             "For 
+00055ba0: 7265 6365 6976 696e 6720 7468 6572 6520  receiving there 
+00055bb0: 6172 6520 7468 7265 6520 6d61 696e 206f  are three main o
+00055bc0: 7074 696f 6e73 3a20 6c69 7374 656e 2066  ptions: listen f
+00055bd0: 6f72 6576 6572 2c20 220a 2020 2020 2020  orever, ".      
+00055be0: 2020 2020 2020 226c 6973 7465 6e20 6f6e        "listen on
+00055bf0: 6365 2061 6e64 2071 7569 742c 2061 6e64  ce and quit, and
+00055c00: 2067 6574 2074 6865 206c 6173 7420 4e20   get the last N 
+00055c10: 6d65 7373 6167 6573 2022 0a20 2020 2020  messages ".     
+00055c20: 2020 2020 2020 2022 616e 6420 7175 6974         "and quit
+00055c30: 2e20 456e 642d 746f 2d65 6e64 2065 6e63  . End-to-end enc
+00055c40: 7279 7074 696f 6e20 6973 2065 6e61 626c  ryption is enabl
+00055c50: 6564 2062 7920 6465 6661 756c 7420 220a  ed by default ".
+00055c60: 2020 2020 2020 2020 2020 2020 2261 6e64              "and
+00055c70: 2063 616e 6e6f 7420 6265 2074 7572 6e65   cannot be turne
+00055c80: 6420 6f66 662c 2062 7574 2069 7420 6361  d off, but it ca
+00055c90: 6e20 6265 2064 6973 6162 6c65 6420 666f  n be disabled fo
+00055ca0: 7220 7370 6563 6966 6963 2022 0a20 2020  r specific ".   
+00055cb0: 2020 2020 2020 2020 2022 7573 6520 6361           "use ca
+00055cc0: 7365 732e 2020 e294 80e2 9480 e294 8020  ses.  ......... 
+00055cd0: 220a 2020 2020 2020 2020 2020 2020 2242  ".            "B
+00055ce0: 756e 646c 696e 6720 7365 7665 7261 6c20  undling several 
+00055cf0: 6163 7469 6f6e 7320 746f 6765 7468 6572  actions together
+00055d00: 2069 6e74 6f20 6120 7369 6e67 6c65 2063   into a single c
+00055d10: 616c 6c20 746f 2022 0a20 2020 2020 2020  all to ".       
+00055d20: 2020 2020 2066 227b 5052 4f47 5f57 4954       f"{PROG_WIT
+00055d30: 484f 5554 5f45 5854 7d20 6973 2066 6173  HOUT_EXT} is fas
+00055d40: 7465 7220 7468 616e 2063 616c 6c69 6e67  ter than calling
+00055d50: 207b 5052 4f47 5f57 4954 484f 5554 5f45   {PROG_WITHOUT_E
+00055d60: 5854 7d20 220a 2020 2020 2020 2020 2020  XT} ".          
+00055d70: 2020 226d 756c 7469 706c 6520 7469 6d65    "multiple time
+00055d80: 7320 7769 7468 206f 6e6c 7920 6f6e 6520  s with only one 
+00055d90: 6163 7469 6f6e 2e20 4966 2074 6865 7265  action. If there
+00055da0: 2061 7265 2062 6f74 6820 2773 6574 2720   are both 'set' 
+00055db0: 220a 2020 2020 2020 2020 2020 2020 2261  ".            "a
+00055dc0: 6e64 2027 6765 7427 2061 6374 696f 6e73  nd 'get' actions
+00055dd0: 2070 7265 7365 6e74 2069 6e20 7468 6520   present in the 
+00055de0: 6172 6775 6d65 6e74 732c 2074 6865 6e20  arguments, then 
+00055df0: 7468 6520 2773 6574 2720 220a 2020 2020  the 'set' ".    
+00055e00: 2020 2020 2020 2020 2261 6374 696f 6e73          "actions
+00055e10: 2077 696c 6c20 6265 2070 6572 666f 726d   will be perform
+00055e20: 6564 2062 6566 6f72 6520 7468 6520 2767  ed before the 'g
+00055e30: 6574 2720 6163 7469 6f6e 732e 2054 6865  et' actions. The
+00055e40: 6e20 220a 2020 2020 2020 2020 2020 2020  n ".            
+00055e50: 2273 656e 6420 6163 7469 6f6e 7320 616e  "send actions an
+00055e60: 6420 6174 2074 6865 2076 6572 7920 656e  d at the very en
+00055e70: 6420 6c69 7374 656e 2061 6374 696f 6e73  d listen actions
+00055e80: 2077 696c 6c20 6265 2022 0a20 2020 2020   will be ".     
+00055e90: 2020 2020 2020 2022 7065 7266 6f72 6d65         "performe
+00055ea0: 642e 20e2 9480 e294 80e2 9480 2022 0a20  d. ......... ". 
+00055eb0: 2020 2020 2020 2020 2020 2022 466f 7220             "For 
+00055ec0: 6576 656e 206d 6f72 6520 6578 706c 6963  even more explic
+00055ed0: 6174 696f 6e73 2061 6e64 2065 7861 6d70  ations and examp
+00055ee0: 6c65 7320 616c 736f 2072 6561 6420 7468  les also read th
+00055ef0: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+00055f00: 2264 6f63 756d 656e 7461 7469 6f6e 2070  "documentation p
+00055f10: 726f 7669 6465 6420 696e 2074 6865 206f  rovided in the o
+00055f20: 6e2d 6c69 6e65 2047 6974 6875 6220 5245  n-line Github RE
+00055f30: 4144 4d45 2e6d 6420 6669 6c65 2022 0a20  ADME.md file ". 
+00055f40: 2020 2020 2020 2020 2020 2022 6f72 2074             "or t
+00055f50: 6865 2052 4541 444d 452e 6d64 2069 6e20  he README.md in 
+00055f60: 796f 7572 206c 6f63 616c 2069 6e73 7461  your local insta
+00055f70: 6c6c 6174 696f 6e2e 2020 e294 80e2 9480  llation.  ......
+00055f80: e294 8020 220a 2020 2020 2020 2020 2020  ... ".          
+00055f90: 2020 2246 6f72 206c 6573 7320 696e 666f    "For less info
+00055fa0: 726d 6174 696f 6e20 6a75 7374 2075 7365  rmation just use
+00055fb0: 202d 2d68 656c 7020 696e 7374 6561 6420   --help instead 
+00055fc0: 6f66 202d 2d6d 616e 7561 6c2e 220a 2020  of --manual.".  
+00055fd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00055fe0: 7072 696e 7428 7465 7874 7772 6170 2e66  print(textwrap.f
+00055ff0: 696c 6c28 6465 7363 7269 7074 696f 6e2c  ill(description,
+00056000: 2077 6964 7468 3d74 6572 6d5f 7769 6474   width=term_widt
+00056010: 6829 2c20 666c 7573 683d 5472 7565 290a  h), flush=True).
+00056020: 2020 2020 2020 2020 7072 696e 7428 2222          print(""
+00056030: 290a 2020 2020 2020 2020 6170 2e70 7269  ).        ap.pri
+00056040: 6e74 5f68 656c 7028 6669 6c65 3d4e 6f6e  nt_help(file=Non
+00056050: 6529 2020 2320 6170 2e70 7269 6e74 5f75  e)  # ap.print_u
+00056060: 7361 6765 2829 2069 7320 696e 636c 7564  sage() is includ
+00056070: 6564 0a20 2020 2020 2020 2072 6574 7572  ed.        retur
+00056080: 6e20 300a 2020 2020 6966 2067 732e 7061  n 0.    if gs.pa
+00056090: 2e72 6561 646d 653a 0a20 2020 2020 2020  .readme:.       
+000560a0: 2023 2054 6f64 6f0a 2020 2020 2020 2020   # Todo.        
+000560b0: 6578 6564 6972 203d 206f 732e 7061 7468  exedir = os.path
+000560c0: 2e64 6972 6e61 6d65 286f 732e 7061 7468  .dirname(os.path
+000560d0: 2e72 6561 6c70 6174 6828 5f5f 6669 6c65  .realpath(__file
+000560e0: 5f5f 2929 0a20 2020 2020 2020 2072 6561  __)).        rea
+000560f0: 646d 6520 3d20 6578 6564 6972 202b 2022  dme = exedir + "
+00056100: 2f2e 2e2f 2220 2b20 2252 4541 444d 452e  /../" + "README.
+00056110: 6d64 220a 2020 2020 2020 2020 7265 6164  md".        read
+00056120: 6d65 5f70 7269 6d61 7279 203d 2072 6561  me_primary = rea
+00056130: 646d 650a 2020 2020 2020 2020 666f 756e  dme.        foun
+00056140: 6470 6174 6820 3d20 4e6f 6e65 0a20 2020  dpath = None.   
+00056150: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
+00056160: 6578 6973 7473 2872 6561 646d 6529 3a0a  exists(readme):.
+00056170: 2020 2020 2020 2020 2020 2020 666f 756e              foun
+00056180: 6470 6174 6820 3d20 7265 6164 6d65 0a20  dpath = readme. 
+00056190: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000561a0: 2866 2246 6f75 6e64 206c 6f63 616c 2052  (f"Found local R
+000561b0: 4541 444d 452e 6d64 2068 6572 653a 207b  EADME.md here: {
+000561c0: 7265 6164 6d65 7d22 290a 2020 2020 2020  readme}").      
+000561d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000561e0: 2020 2020 7265 6164 6d65 203d 2065 7865      readme = exe
+000561f0: 6469 7220 2b20 222f 2220 2b20 2252 4541  dir + "/" + "REA
+00056200: 444d 452e 6d64 220a 2020 2020 2020 2020  DME.md".        
+00056210: 2020 2020 6966 206f 732e 7061 7468 2e65      if os.path.e
+00056220: 7869 7374 7328 7265 6164 6d65 293a 0a20  xists(readme):. 
+00056230: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00056240: 6f75 6e64 7061 7468 203d 2072 6561 646d  oundpath = readm
+00056250: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00056260: 2020 7072 696e 7428 6622 466f 756e 6420    print(f"Found 
+00056270: 6c6f 6361 6c20 5245 4144 4d45 2e6d 6420  local README.md 
+00056280: 6865 7265 3a20 7b72 6561 646d 657d 2229  here: {readme}")
+00056290: 0a20 2020 2020 2020 2069 6620 666f 756e  .        if foun
+000562a0: 6470 6174 6820 6973 204e 6f6e 653a 0a20  dpath is None:. 
+000562b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000562c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000562d0: 2020 2253 6f72 7279 2c20 5245 4144 4d45    "Sorry, README
+000562e0: 2e6d 6420 6e6f 7420 666f 756e 6420 6c6f  .md not found lo
+000562f0: 6361 6c6c 7920 220a 2020 2020 2020 2020  cally ".        
+00056300: 2020 2020 2020 2020 6622 696e 2069 6e73          f"in ins
+00056310: 7461 6c6c 6174 696f 6e20 6469 7265 6374  tallation direct
+00056320: 6f72 7920 7b72 6561 646d 655f 7072 696d  ory {readme_prim
+00056330: 6172 797d 2e22 0a20 2020 2020 2020 2020  ary}.".         
+00056340: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00056350: 2070 7269 6e74 2866 2248 656e 6365 2064   print(f"Hence d
+00056360: 6f77 6e6c 6f61 6469 6e67 2069 7420 6672  ownloading it fr
+00056370: 6f6d 207b 5245 4144 4d45 5f46 494c 455f  om {README_FILE_
+00056380: 5241 575f 5552 4c7d 2e22 290a 2020 2020  RAW_URL}.").    
+00056390: 2020 2020 2020 2020 6e6f 7475 7365 642c          notused,
+000563a0: 2066 6f75 6e64 7061 7468 203d 2074 656d   foundpath = tem
+000563b0: 7066 696c 652e 6d6b 7374 656d 7028 290a  pfile.mkstemp().
+000563c0: 2020 2020 2020 2020 2020 2020 7572 6c6c              urll
+000563d0: 6962 2e72 6571 7565 7374 2e75 726c 7265  ib.request.urlre
+000563e0: 7472 6965 7665 2852 4541 444d 455f 4649  trieve(README_FI
+000563f0: 4c45 5f52 4157 5f55 524c 2c20 666f 756e  LE_RAW_URL, foun
+00056400: 6470 6174 6829 0a20 2020 2020 2020 2074  dpath).        t
+00056410: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00056420: 7769 7468 206f 7065 6e28 666f 756e 6470  with open(foundp
+00056430: 6174 682c 2022 722b 2229 2061 7320 663a  ath, "r+") as f:
+00056440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00056450: 2074 6578 7420 3d20 662e 7265 6164 2829   text = f.read()
+00056460: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00056470: 6e74 2866 227b 7465 7874 7d22 290a 2020  nt(f"{text}").  
+00056480: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00056490: 6570 7469 6f6e 3a20 2023 2028 4272 6f6b  eption:  # (Brok
+000564a0: 656e 5069 7065 4572 726f 722c 2049 4f45  enPipeError, IOE
+000564b0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+000564c0: 2020 2023 2070 7269 6e74 2822 4272 6f6b     # print("Brok
+000564d0: 656e 5069 7065 4572 726f 7220 6361 7567  enPipeError caug
+000564e0: 6874 222c 2066 696c 653d 7379 732e 7374  ht", file=sys.st
+000564f0: 6465 7272 290a 2020 2020 2020 2020 2020  derr).          
+00056500: 2020 7061 7373 0a20 2020 2020 2020 2072    pass.        r
+00056510: 6574 7572 6e20 300a 0a20 2020 206c 6f67  eturn 0..    log
+00056520: 6769 6e67 2e62 6173 6963 436f 6e66 6967  ging.basicConfig
+00056530: 2820 2023 2069 6e69 7469 616c 697a 6520  (  # initialize 
+00056540: 726f 6f74 206c 6f67 6765 722c 2061 206d  root logger, a m
+00056550: 7573 740a 2020 2020 2020 2020 666f 726d  ust.        form
+00056560: 6174 3d22 7b61 7363 7469 6d65 7d3a 207b  at="{asctime}: {
+00056570: 6c65 7665 6c6e 616d 653a 3e38 7d3a 207b  levelname:>8}: {
+00056580: 6e61 6d65 3a3e 3136 7d3a 207b 6d65 7373  name:>16}: {mess
+00056590: 6167 657d 222c 2073 7479 6c65 3d22 7b22  age}", style="{"
+000565a0: 0a20 2020 2029 0a20 2020 2023 2073 6574  .    ).    # set
+000565b0: 206c 6f67 206c 6576 656c 206f 6e20 726f   log level on ro
+000565c0: 6f74 0a20 2020 2069 6620 2244 4542 5547  ot.    if "DEBUG
+000565d0: 2220 696e 206f 732e 656e 7669 726f 6e3a  " in os.environ:
+000565e0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+000565f0: 2e67 6574 4c6f 6767 6572 2829 2e73 6574  .getLogger().set
+00056600: 4c65 7665 6c28 6c6f 6767 696e 672e 4445  Level(logging.DE
+00056610: 4255 4729 0a20 2020 2065 6c73 653a 0a20  BUG).    else:. 
+00056620: 2020 2020 2020 206c 6f67 6769 6e67 2e67         logging.g
+00056630: 6574 4c6f 6767 6572 2829 2e73 6574 4c65  etLogger().setLe
+00056640: 7665 6c28 6c6f 6767 696e 672e 494e 464f  vel(logging.INFO
+00056650: 290a 0a20 2020 2067 732e 6c6f 6720 3d20  )..    gs.log = 
+00056660: 6c6f 6767 696e 672e 6765 744c 6f67 6765  logging.getLogge
+00056670: 7228 5052 4f47 5f57 4954 484f 5554 5f45  r(PROG_WITHOUT_E
+00056680: 5854 290a 0a20 2020 2069 6620 6773 2e70  XT)..    if gs.p
+00056690: 612e 6c6f 675f 6c65 7665 6c3a 0a20 2020  a.log_level:.   
+000566a0: 2020 2020 2069 6e69 7469 616c 5f63 6865       initial_che
+000566b0: 636b 5f6f 665f 6c6f 675f 6172 6773 2829  ck_of_log_args()
+000566c0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+000566d0: 6773 2e70 612e 6c6f 675f 6c65 7665 6c29  gs.pa.log_level)
+000566e0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+000566f0: 2020 6966 206c 656e 2867 732e 7061 2e6c    if len(gs.pa.l
+00056700: 6f67 5f6c 6576 656c 2920 3e20 313a 0a20  og_level) > 1:. 
+00056710: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00056720: 2073 6574 206c 6f67 206c 6576 656c 2066   set log level f
+00056730: 6f72 2045 5645 5259 5448 494e 470a 2020  or EVERYTHING.  
+00056740: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00056750: 6767 696e 672e 6765 744c 6f67 6765 7228  gging.getLogger(
+00056760: 292e 7365 744c 6576 656c 2867 732e 7061  ).setLevel(gs.pa
+00056770: 2e6c 6f67 5f6c 6576 656c 5b31 5d29 0a20  .log_level[1]). 
+00056780: 2020 2020 2020 2020 2020 2023 2073 6574             # set
+00056790: 206c 6f67 206c 6576 656c 2066 6f72 206d   log level for m
+000567a0: 6174 7269 782d 636f 6d6d 616e 6465 720a  atrix-commander.
+000567b0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+000567c0: 6f67 2e73 6574 4c65 7665 6c28 6773 2e70  og.setLevel(gs.p
+000567d0: 612e 6c6f 675f 6c65 7665 6c5b 305d 290a  a.log_level[0]).
+000567e0: 2020 2020 2020 2020 2020 2020 6773 2e6c              gs.l
+000567f0: 6f67 2e64 6562 7567 280a 2020 2020 2020  og.debug(.      
+00056800: 2020 2020 2020 2020 2020 6622 4c6f 6720            f"Log 
+00056810: 6c65 7665 6c20 6973 2073 6574 2066 6f72  level is set for
+00056820: 206d 6f64 756c 6520 7b50 524f 475f 5749   module {PROG_WI
+00056830: 5448 4f55 545f 4558 547d 2e20 220a 2020  THOUT_EXT}. ".  
+00056840: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00056850: 6c6f 675f 6c65 7665 6c3d 7b67 732e 7061  log_level={gs.pa
+00056860: 2e6c 6f67 5f6c 6576 656c 5b30 5d7d 220a  .log_level[0]}".
+00056870: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00056880: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00056890: 2867 732e 7061 2e6c 6f67 5f6c 6576 656c  (gs.pa.log_level
+000568a0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+000568b0: 2020 2020 2020 2023 206f 6e6c 7920 6e6f         # only no
+000568c0: 7720 7468 6174 206c 6f63 616c 206c 6f67  w that local log
+000568d0: 206c 6576 656c 2069 7320 7365 742c 2077   level is set, w
+000568e0: 6520 6361 6e20 6c6f 6720 7072 6576 2e20  e can log prev. 
+000568f0: 696e 666f 0a20 2020 2020 2020 2020 2020  info.           
+00056900: 2020 2020 2067 732e 6c6f 672e 6465 6275       gs.log.debu
+00056910: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00056920: 2020 2020 2020 2066 224c 6f67 206c 6576         f"Log lev
+00056930: 656c 2069 7320 7365 7420 666f 7220 6d6f  el is set for mo
+00056940: 6475 6c65 7320 6265 6c6f 7720 7b50 524f  dules below {PRO
+00056950: 475f 5749 5448 4f55 545f 4558 547d 2e20  G_WITHOUT_EXT}. 
+00056960: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00056970: 2020 2020 2020 6622 6c6f 675f 6c65 7665        f"log_leve
+00056980: 6c3d 7b67 732e 7061 2e6c 6f67 5f6c 6576  l={gs.pa.log_lev
+00056990: 656c 5b31 5d7d 220a 2020 2020 2020 2020  el[1]}".        
+000569a0: 2020 2020 2020 2020 290a 2020 2020 6966          ).    if
+000569b0: 2067 732e 7061 2e64 6562 7567 203e 2030   gs.pa.debug > 0
+000569c0: 3a0a 2020 2020 2020 2020 6966 2067 732e  :.        if gs.
+000569d0: 7061 2e64 6562 7567 203e 2031 3a0a 2020  pa.debug > 1:.  
+000569e0: 2020 2020 2020 2020 2020 2320 7475 726e            # turn
+000569f0: 206f 6e20 6465 6275 6720 6c6f 6767 696e   on debug loggin
+00056a00: 6720 666f 7220 4556 4552 5954 4849 4e47  g for EVERYTHING
+00056a10: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00056a20: 6769 6e67 2e67 6574 4c6f 6767 6572 2829  ging.getLogger()
+00056a30: 2e73 6574 4c65 7665 6c28 6c6f 6767 696e  .setLevel(loggin
+00056a40: 672e 4445 4255 4729 0a20 2020 2020 2020  g.DEBUG).       
+00056a50: 2023 2074 7572 6e20 6f6e 2064 6562 7567   # turn on debug
+00056a60: 206c 6f67 6769 6e67 2066 6f72 206d 6174   logging for mat
+00056a70: 7269 782d 636f 6d6d 616e 6465 720a 2020  rix-commander.  
+00056a80: 2020 2020 2020 6773 2e6c 6f67 2e73 6574        gs.log.set
+00056a90: 4c65 7665 6c28 6c6f 6767 696e 672e 4445  Level(logging.DE
+00056aa0: 4255 4729 0a20 2020 2020 2020 2067 732e  BUG).        gs.
+00056ab0: 6c6f 672e 6465 6275 6728 6622 4465 6275  log.debug(f"Debu
+00056ac0: 6720 6973 2074 7572 6e65 6420 6f6e 2e20  g is turned on. 
+00056ad0: 6465 6275 6720 636f 756e 743d 7b67 732e  debug count={gs.
+00056ae0: 7061 2e64 6562 7567 7d22 290a 2020 2020  pa.debug}").    
+00056af0: 2020 2020 6966 2067 732e 7061 2e6c 6f67      if gs.pa.log
+00056b00: 5f6c 6576 656c 2061 6e64 206c 656e 2867  _level and len(g
+00056b10: 732e 7061 2e6c 6f67 5f6c 6576 656c 2920  s.pa.log_level) 
+00056b20: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00056b30: 2067 732e 6c6f 672e 7761 726e 696e 6728   gs.log.warning(
+00056b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00056b50: 2022 5731 3131 3a20 2220 2244 6562 7567   "W111: " "Debug
+00056b60: 206f 7074 696f 6e20 2d64 206f 7665 7277   option -d overw
+00056b70: 726f 7465 206f 7074 696f 6e20 2d2d 6c6f  rote option --lo
+00056b80: 672d 6c65 7665 6c2e 220a 2020 2020 2020  g-level.".      
+00056b90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00056ba0: 2020 2020 6773 2e77 6172 6e5f 636f 756e      gs.warn_coun
+00056bb0: 7420 2b3d 2031 0a0a 2020 2020 5345 5020  t += 1..    SEP 
+00056bc0: 3d20 6279 7465 7328 6773 2e70 612e 7365  = bytes(gs.pa.se
+00056bd0: 7061 7261 746f 722c 2022 7574 662d 3822  parator, "utf-8"
+00056be0: 292e 6465 636f 6465 2822 756e 6963 6f64  ).decode("unicod
+00056bf0: 655f 6573 6361 7065 2229 0a20 2020 2067  e_escape").    g
+00056c00: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+00056c10: 2020 2020 2066 2753 6570 6172 6174 6f72       f'Separator
+00056c20: 2069 7320 7365 7420 746f 2022 7b53 4550   is set to "{SEP
+00056c30: 7d22 206f 6620 270a 2020 2020 2020 2020  }" of '.        
+00056c40: 6622 6c65 6e67 7468 207b 6c65 6e28 5345  f"length {len(SE
+00056c50: 5029 7d2e 2045 2e67 2e20 436f 6c31 7b53  P)}. E.g. Col1{S
+00056c60: 4550 7d43 6f6c 322e 220a 2020 2020 290a  EP}Col2.".    ).
+00056c70: 2020 2020 696e 6974 6961 6c5f 6368 6563      initial_chec
+00056c80: 6b5f 6f66 5f61 7267 7328 290a 2020 2020  k_of_args().    
+00056c90: 6368 6563 6b5f 646f 776e 6c6f 6164 5f6d  check_download_m
+00056ca0: 6564 6961 5f64 6972 2829 0a20 2020 2074  edia_dir().    t
+00056cb0: 7279 3a0a 2020 2020 2020 2020 6368 6563  ry:.        chec
+00056cc0: 6b5f 6172 675f 6669 6c65 735f 7265 6164  k_arg_files_read
+00056cd0: 6162 6c65 2829 0a20 2020 2065 7863 6570  able().    excep
+00056ce0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00056cf0: 3a0a 2020 2020 2020 2020 6773 2e6c 6f67  :.        gs.log
+00056d00: 2e65 7272 6f72 2865 2920 2023 2061 6c72  .error(e)  # alr
+00056d10: 6561 6479 2068 6173 2045 7878 783a 2075  eady has Exxx: u
+00056d20: 6e69 7175 6520 6572 726f 7220 6e75 6d62  nique error numb
+00056d30: 6572 0a20 2020 2020 2020 2072 6169 7365  er.        raise
+00056d40: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+00056d50: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00056d60: 2020 2066 227b 5052 4f47 5f57 4954 484f     f"{PROG_WITHO
+00056d70: 5554 5f45 5854 7d20 666f 7263 6573 2061  UT_EXT} forces a
+00056d80: 6e20 6561 726c 7920 6162 6f72 742e 2022  n early abort. "
+00056d90: 0a20 2020 2020 2020 2020 2020 2022 546f  .            "To
+00056da0: 2061 766f 6964 2070 6172 7469 616c 2065   avoid partial e
+00056db0: 7865 6375 7469 6f6e 2c20 6e6f 2061 6374  xecution, no act
+00056dc0: 696f 6e20 6861 7320 6265 656e 2070 6572  ion has been per
+00056dd0: 666f 726d 6564 2061 7420 616c 6c2e 2022  formed at all. "
+00056de0: 0a20 2020 2020 2020 2020 2020 2022 4e6f  .            "No
+00056df0: 7468 696e 6720 6861 7320 6265 656e 2073  thing has been s
+00056e00: 656e 742e 2046 6978 2079 6f75 7220 6172  ent. Fix your ar
+00056e10: 6775 6d65 6e74 7320 616e 6420 7275 6e20  guments and run 
+00056e20: 7468 6520 636f 6d6d 616e 6420 220a 2020  the command ".  
+00056e30: 2020 2020 2020 2020 2020 2261 6761 696e            "again
+00056e40: 2e22 0a20 2020 2020 2020 2029 2066 726f  .".        ) fro
+00056e50: 6d20 4e6f 6e65 0a0a 2020 2020 6966 2067  m None..    if g
+00056e60: 732e 7061 2e76 6572 7369 6f6e 3a0a 2020  s.pa.version:.  
+00056e70: 2020 2020 2020 6966 2067 732e 7061 2e76        if gs.pa.v
+00056e80: 6572 7369 6f6e 2e6c 6f77 6572 2829 203d  ersion.lower() =
+00056e90: 3d20 5052 494e 543a 0a20 2020 2020 2020  = PRINT:.       
+00056ea0: 2020 2020 2076 6572 7369 6f6e 2829 2020       version()  
+00056eb0: 2320 636f 6e74 696e 7565 2065 7865 6375  # continue execu
+00056ec0: 7469 6f6e 0a20 2020 2020 2020 2065 6c73  tion.        els
+00056ed0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+00056ee0: 6865 636b 5f76 6572 7369 6f6e 2829 2020  heck_version()  
+00056ef0: 2320 636f 6e74 696e 7565 2065 7865 6375  # continue execu
+00056f00: 7469 6f6e 0a20 2020 2020 2020 2069 6620  tion.        if 
+00056f10: 6e6f 7420 280a 2020 2020 2020 2020 2020  not (.          
+00056f20: 2020 6773 2e73 656e 645f 6163 7469 6f6e    gs.send_action
+00056f30: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
+00056f40: 6773 2e72 6f6f 6d5f 6163 7469 6f6e 0a20  gs.room_action. 
+00056f50: 2020 2020 2020 2020 2020 206f 7220 6773             or gs
+00056f60: 2e70 612e 6c69 7374 656e 2021 3d20 4c49  .pa.listen != LI
+00056f70: 5354 454e 5f44 4546 4155 4c54 0a20 2020  STEN_DEFAULT.   
+00056f80: 2020 2020 2020 2020 206f 7220 6773 2e70           or gs.p
+00056f90: 612e 7461 696c 2021 3d20 5441 494c 5f55  a.tail != TAIL_U
+00056fa0: 4e55 5345 445f 4445 4641 554c 540a 2020  NUSED_DEFAULT.  
+00056fb0: 2020 2020 2020 2020 2020 6f72 2067 732e            or gs.
+00056fc0: 7061 2e76 6572 6966 790a 2020 2020 2020  pa.verify.      
+00056fd0: 2020 2020 2020 6f72 2067 732e 7365 7467        or gs.setg
+00056fe0: 6574 5f61 6374 696f 6e0a 2020 2020 2020  et_action.      
+00056ff0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00057000: 2067 732e 6c6f 672e 6465 6275 6728 224f   gs.log.debug("O
+00057010: 6e6c 7920 2d2d 7665 7273 696f 6e2e 2050  nly --version. P
+00057020: 7269 6e74 2061 6e64 2071 7569 742e 2229  rint and quit.")
+00057030: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00057040: 7572 6e20 2023 206a 7573 7420 7665 7273  urn  # just vers
+00057050: 696f 6e2c 2071 7569 740a 0a20 2020 2063  ion, quit..    c
+00057060: 7265 6174 655f 7069 645f 6669 6c65 2829  reate_pid_file()
+00057070: 0a0a 2020 2020 6773 2e6c 6f67 2e64 6562  ..    gs.log.deb
+00057080: 7567 2866 2750 7974 686f 6e20 7665 7273  ug(f'Python vers
+00057090: 696f 6e20 6973 2022 7b73 7973 2e76 6572  ion is "{sys.ver
+000570a0: 7369 6f6e 7d22 2729 0a20 2020 2067 732e  sion}"').    gs.
+000570b0: 6c6f 672e 6465 6275 6728 6627 5374 6469  log.debug(f'Stdi
+000570c0: 6e20 7069 7065 2069 7320 6173 7369 676e  n pipe is assign
+000570d0: 6564 2074 6f20 227b 6773 2e73 7464 696e  ed to "{gs.stdin
+000570e0: 5f75 7365 7d22 2e27 290a 2020 2020 6966  _use}".').    if
+000570f0: 2067 732e 7061 2e73 736c 5f63 6572 7469   gs.pa.ssl_certi
+00057100: 6669 6361 7465 2021 3d20 5353 4c5f 4345  ficate != SSL_CE
+00057110: 5254 4946 4943 4154 455f 4445 4641 554c  RTIFICATE_DEFAUL
+00057120: 543a 0a20 2020 2020 2020 2067 732e 6c6f  T:.        gs.lo
+00057130: 672e 6465 6275 6728 0a20 2020 2020 2020  g.debug(.       
+00057140: 2020 2020 2022 5353 4c20 7769 6c6c 2062       "SSL will b
+00057150: 6520 7573 6564 2e20 4120 6375 7374 6f6d  e used. A custom
+00057160: 2053 534c 2063 6572 7469 6669 6361 7465   SSL certificate
+00057170: 2077 6173 2070 726f 7669 6465 642e 2022   was provided. "
+00057180: 0a20 2020 2020 2020 2020 2020 2066 2743  .            f'C
+00057190: 7573 746f 6d20 6365 7274 6966 6963 6174  ustom certificat
+000571a0: 6520 6672 6f6d 2066 696c 6520 227b 6773  e from file "{gs
+000571b0: 2e70 612e 7373 6c5f 6365 7274 6966 6963  .pa.ssl_certific
+000571c0: 6174 657d 2220 7769 6c6c 2027 0a20 2020  ate}" will '.   
+000571d0: 2020 2020 2020 2020 2022 6265 2075 7365           "be use
+000571e0: 6420 666f 7220 7468 6973 2063 6f6e 6e65  d for this conne
+000571f0: 6374 696f 6e2e 220a 2020 2020 2020 2020  ction.".        
+00057200: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+00057210: 2020 2020 2020 2020 2020 2023 2074 7970             # typ
+00057220: 6520 5353 4c43 6f6e 7465 7874 0a20 2020  e SSLContext.   
+00057230: 2020 2020 2020 2020 2067 732e 7373 6c20           gs.ssl 
+00057240: 3d20 7373 6c2e 6372 6561 7465 5f64 6566  = ssl.create_def
+00057250: 6175 6c74 5f63 6f6e 7465 7874 2863 6166  ault_context(caf
+00057260: 696c 653d 6773 2e70 612e 7373 6c5f 6365  ile=gs.pa.ssl_ce
+00057270: 7274 6966 6963 6174 6529 0a20 2020 2020  rtificate).     
+00057280: 2020 2065 7863 6570 7420 4669 6c65 4e6f     except FileNo
+00057290: 7446 6f75 6e64 4572 726f 723a 0a20 2020  tFoundError:.   
+000572a0: 2020 2020 2020 2020 2067 732e 6572 725f           gs.err_
+000572b0: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+000572c0: 2020 2020 2020 2072 6169 7365 204d 6174         raise Mat
+000572d0: 7269 7843 6f6d 6d61 6e64 6572 4572 726f  rixCommanderErro
+000572e0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000572f0: 2020 2022 4532 3433 3a20 220a 2020 2020     "E243: ".    
+00057300: 2020 2020 2020 2020 2020 2020 6627 5353              f'SS
+00057310: 4c20 6365 7274 6966 6963 6174 6520 6669  L certificate fi
+00057320: 6c65 2022 7b67 732e 7061 2e73 736c 5f63  le "{gs.pa.ssl_c
+00057330: 6572 7469 6669 6361 7465 7d22 2077 6173  ertificate}" was
+00057340: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00057350: 2020 2022 6e6f 7420 666f 756e 642e 220a     "not found.".
+00057360: 2020 2020 2020 2020 2020 2020 2920 6672              ) fr
+00057370: 6f6d 204e 6f6e 650a 2020 2020 2020 2020  om None.        
+00057380: 6578 6365 7074 2050 6572 6d69 7373 696f  except Permissio
+00057390: 6e45 7272 6f72 3a0a 2020 2020 2020 2020  nError:.        
+000573a0: 2020 2020 6773 2e65 7272 5f63 6f75 6e74      gs.err_count
+000573b0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+000573c0: 2020 7261 6973 6520 4d61 7472 6978 436f    raise MatrixCo
+000573d0: 6d6d 616e 6465 7245 7272 6f72 280a 2020  mmanderError(.  
+000573e0: 2020 2020 2020 2020 2020 2020 2020 2245                "E
+000573f0: 3234 343a 2022 0a20 2020 2020 2020 2020  244: ".         
+00057400: 2020 2020 2020 2066 2753 534c 2063 6572         f'SSL cer
+00057410: 7469 6669 6361 7465 2066 696c 6520 227b  tificate file "{
+00057420: 6773 2e70 612e 7373 6c5f 6365 7274 6966  gs.pa.ssl_certif
+00057430: 6963 6174 657d 2220 646f 6573 2027 0a20  icate}" does '. 
+00057440: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00057450: 6e6f 7420 6861 7665 2072 6561 6420 7065  not have read pe
+00057460: 726d 6973 7369 6f6e 732e 220a 2020 2020  rmissions.".    
+00057470: 2020 2020 2020 2020 2920 6672 6f6d 204e          ) from N
+00057480: 6f6e 650a 2020 2020 2020 2020 6578 6365  one.        exce
+00057490: 7074 2073 736c 2e53 534c 4572 726f 723a  pt ssl.SSLError:
+000574a0: 0a20 2020 2020 2020 2020 2020 2067 732e  .            gs.
+000574b0: 6572 725f 636f 756e 7420 2b3d 2031 0a20  err_count += 1. 
+000574c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000574d0: 204d 6174 7269 7843 6f6d 6d61 6e64 6572   MatrixCommander
+000574e0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+000574f0: 2020 2020 2020 2022 4532 3435 3a20 220a         "E245: ".
+00057500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057510: 6627 5353 4c20 6365 7274 6966 6963 6174  f'SSL certificat
+00057520: 6520 6669 6c65 2022 7b67 732e 7061 2e73  e file "{gs.pa.s
+00057530: 736c 5f63 6572 7469 6669 6361 7465 7d22  sl_certificate}"
+00057540: 2068 6173 2027 0a20 2020 2020 2020 2020   has '.         
+00057550: 2020 2020 2020 2022 696e 7661 6c69 6420         "invalid 
+00057560: 636f 6e74 656e 742e 2044 6f65 7320 6e6f  content. Does no
+00057570: 7420 7365 656d 2074 6f20 6265 2061 2063  t seem to be a c
+00057580: 6572 7469 6669 6361 7465 2e22 0a20 2020  ertificate.".   
+00057590: 2020 2020 2020 2020 2029 2066 726f 6d20           ) from 
+000575a0: 4e6f 6e65 0a20 2020 2065 6c69 6620 6773  None.    elif gs
+000575b0: 2e70 612e 6e6f 5f73 736c 3a0a 2020 2020  .pa.no_ssl:.    
+000575c0: 2020 2020 6773 2e6c 6f67 2e64 6562 7567      gs.log.debug
+000575d0: 280a 2020 2020 2020 2020 2020 2020 2253  (.            "S
+000575e0: 534c 2077 696c 6c20 6265 206e 6f74 2062  SL will be not b
+000575f0: 6520 7573 6564 2e20 5468 6520 5353 4c20  e used. The SSL 
+00057600: 6365 7274 6966 6963 6174 6520 7661 6c69  certificate vali
+00057610: 6461 7469 6f6e 2022 0a20 2020 2020 2020  dation ".       
+00057620: 2020 2020 2022 7769 6c6c 2062 6520 736b       "will be sk
+00057630: 6970 7065 6420 666f 7220 7468 6973 2063  ipped for this c
+00057640: 6f6e 6e65 6374 696f 6e2e 220a 2020 2020  onnection.".    
+00057650: 2020 2020 290a 2020 2020 2020 2020 6773      ).        gs
+00057660: 2e73 736c 203d 2046 616c 7365 0a20 2020  .ssl = False.   
+00057670: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
+00057680: 732e 6c6f 672e 6465 6275 6728 0a20 2020  s.log.debug(.   
+00057690: 2020 2020 2020 2020 2022 5353 4c20 7769           "SSL wi
+000576a0: 6c6c 2062 6520 7573 6564 2e20 4465 6661  ll be used. Defa
+000576b0: 756c 7420 5353 4c20 6365 7274 6966 6963  ult SSL certific
+000576c0: 6174 6520 7661 6c69 6461 7469 6f6e 2022  ate validation "
+000576d0: 0a20 2020 2020 2020 2020 2020 2022 7769  .            "wi
+000576e0: 6c6c 2062 6520 646f 6e65 2066 6f72 2074  ll be done for t
+000576f0: 6869 7320 636f 6e6e 6563 7469 6f6e 2e22  his connection."
+00057700: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00057710: 2020 2067 732e 7373 6c20 3d20 4e6f 6e65     gs.ssl = None
+00057720: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+00057730: 2020 2061 7379 6e63 696f 2e72 756e 2861     asyncio.run(a
+00057740: 7379 6e63 5f6d 6169 6e28 2929 2020 2320  sync_main())  # 
+00057750: 646f 2065 7665 7279 7468 696e 6720 696e  do everything in
+00057760: 2074 6865 2065 7665 6e74 206c 6f6f 700a   the event loop.
+00057770: 2020 2020 2020 2020 2320 7468 6520 6e65          # the ne
+00057780: 7874 2063 616e 2062 6520 7265 6163 6865  xt can be reache
+00057790: 6420 6f6e 2073 7563 6365 7373 206f 7220  d on success or 
+000577a0: 6661 696c 7572 650a 2020 2020 2020 2020  failure.        
+000577b0: 6773 2e6c 6f67 2e64 6562 7567 2866 2254  gs.log.debug(f"T
+000577c0: 6865 2070 726f 6772 616d 207b 5052 4f47  he program {PROG
+000577d0: 5f57 4954 485f 4558 547d 206c 6566 7420  _WITH_EXT} left 
+000577e0: 7468 6520 6576 656e 7420 6c6f 6f70 2e22  the event loop."
+000577f0: 290a 2020 2020 6578 6365 7074 2054 696d  ).    except Tim
+00057800: 656f 7574 4572 726f 7220 6173 2065 3a0a  eoutError as e:.
+00057810: 2020 2020 2020 2020 6773 2e65 7272 5f63          gs.err_c
+00057820: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+00057830: 2020 7261 6973 6520 4d61 7472 6978 436f    raise MatrixCo
+00057840: 6d6d 616e 6465 7245 7272 6f72 280a 2020  mmanderError(.  
+00057850: 2020 2020 2020 2020 2020 2245 3234 373a            "E247:
+00057860: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00057870: 2254 6865 2070 726f 6772 616d 207b 5052  "The program {PR
+00057880: 4f47 5f57 4954 485f 4558 547d 2072 616e  OG_WITH_EXT} ran
+00057890: 2069 6e74 6f20 6120 7469 6d65 6f75 742e   into a timeout.
+000578a0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+000578b0: 4d6f 7374 206c 696b 656c 7920 636f 6e6e  Most likely conn
+000578c0: 6563 7469 7669 7479 2074 6f20 696e 7465  ectivity to inte
+000578d0: 726e 6574 2077 6173 206c 6f73 742e 2022  rnet was lost. "
+000578e0: 0a20 2020 2020 2020 2020 2020 2022 4966  .            "If
+000578f0: 2074 6869 7320 6861 7070 656e 7320 6672   this happens fr
+00057900: 6571 7565 6e74 6c79 2063 6f6e 7369 6465  equently conside
+00057910: 7220 7275 6e6e 696e 6720 7468 6973 2022  r running this "
+00057920: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
+00057930: 6f67 7261 6d20 6173 2061 2073 6572 7669  ogram as a servi
+00057940: 6365 2073 6f20 6974 2077 696c 6c20 7265  ce so it will re
+00057950: 7374 6172 7420 6175 746f 6d61 7469 6361  start automatica
+00057960: 6c6c 792e 2053 6f72 7279 2e22 0a20 2020  lly. Sorry.".   
+00057970: 2020 2020 2029 2066 726f 6d20 650a 2020       ) from e.  
+00057980: 2020 6578 6365 7074 204d 6174 7269 7843    except MatrixC
+00057990: 6f6d 6d61 6e64 6572 4572 726f 723a 0a20  ommanderError:. 
+000579a0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+000579b0: 2065 7863 6570 7420 4b65 7962 6f61 7264   except Keyboard
+000579c0: 496e 7465 7272 7570 743a 0a20 2020 2020  Interrupt:.     
+000579d0: 2020 2067 732e 6c6f 672e 6465 6275 6728     gs.log.debug(
+000579e0: 224b 6579 626f 6172 6420 696e 7465 7272  "Keyboard interr
+000579f0: 7570 7420 7265 6365 6976 6564 2e22 290a  upt received.").
+00057a00: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00057a10: 7469 6f6e 3a0a 2020 2020 2020 2020 6773  tion:.        gs
+00057a20: 2e65 7272 5f63 6f75 6e74 202b 3d20 310a  .err_count += 1.
+00057a30: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00057a40: 7272 6f72 2822 4532 3438 3a20 2220 6622  rror("E248: " f"
+00057a50: 5468 6520 7072 6f67 7261 6d20 7b50 524f  The program {PRO
+00057a60: 475f 5749 5448 5f45 5854 7d20 6661 696c  G_WITH_EXT} fail
+00057a70: 6564 2e20 536f 7272 792e 2229 0a20 2020  ed. Sorry.").   
+00057a80: 2020 2020 2072 6169 7365 0a20 2020 2066       raise.    f
+00057a90: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+00057aa0: 636c 6561 6e75 7028 290a 0a0a 6465 6620  cleanup()...def 
+00057ab0: 6d61 696e 2861 7267 763a 2055 6e69 6f6e  main(argv: Union
+00057ac0: 5b4e 6f6e 652c 206c 6973 745d 203d 204e  [None, list] = N
+00057ad0: 6f6e 6529 202d 3e20 696e 743a 0a20 2020  one) -> int:.   
+00057ae0: 2022 2222 5275 6e20 7468 6520 7072 6f67   """Run the prog
+00057af0: 7261 6d2e 0a0a 2020 2020 6d61 696e 2829  ram...    main()
+00057b00: 2069 7320 616e 2065 6e74 7279 2070 6f69   is an entry poi
+00057b10: 6e74 2061 6c6c 6f77 696e 6720 6f74 6865  nt allowing othe
+00057b20: 7220 5079 7468 6f6e 2070 726f 6772 616d  r Python program
+00057b30: 7320 746f 0a20 2020 2065 6173 696c 7920  s to.    easily 
+00057b40: 6361 6c6c 206d 6174 7269 782d 636f 6d6d  call matrix-comm
+00057b50: 616e 6465 722e 0a0a 2020 2020 4172 6775  ander...    Argu
+00057b60: 6d65 6e74 733a 0a20 2020 202d 2d2d 2d2d  ments:.    -----
+00057b70: 2d2d 2d2d 0a20 2020 2061 7267 7620 3a20  ----.    argv : 
+00057b80: 6c69 7374 206f 6620 6172 6775 6d65 6e74  list of argument
+00057b90: 7320 6173 2069 6e20 7379 732e 6172 6776  s as in sys.argv
+00057ba0: 3b20 6669 7273 7420 656c 656d 656e 7420  ; first element 
+00057bb0: 6973 2074 6865 0a20 2020 2020 2020 2070  is the.        p
+00057bc0: 726f 6772 616d 206e 616d 652c 2066 7572  rogram name, fur
+00057bd0: 7468 6572 2065 6c65 6d65 6e74 7320 6172  ther elements ar
+00057be0: 6520 7468 6520 6172 6775 6d65 6e74 733b  e the arguments;
+00057bf0: 2065 7665 7279 0a20 2020 2020 2020 2065   every.        e
+00057c00: 6c65 6d65 6e74 206d 7573 7420 6265 206f  lement must be o
+00057c10: 6620 7479 7065 2022 7374 7222 2e0a 2020  f type "str"..  
+00057c20: 2020 2020 2020 6172 6776 2069 7320 6f70        argv is op
+00057c30: 7469 6f6e 616c 2061 6e64 2063 616e 2062  tional and can b
+00057c40: 6520 4e6f 6e65 2e0a 2020 2020 2020 2020  e None..        
+00057c50: 4966 2061 7267 7620 6973 2073 6574 2074  If argv is set t
+00057c60: 6865 6e20 7468 6573 6520 6172 6775 6d65  hen these argume
+00057c70: 6e74 7320 7769 6c6c 2062 6520 7573 6564  nts will be used
+00057c80: 2061 7320 6172 6775 6d65 6e74 7320 666f   as arguments fo
+00057c90: 720a 2020 2020 2020 2020 6d61 7472 6978  r.        matrix
+00057ca0: 2d63 6f6d 6d61 6e64 6572 2e20 4966 2061  -commander. If a
+00057cb0: 7267 7620 6973 206e 6f74 2073 6574 2028  rgv is not set (
+00057cc0: 4e6f 6e65 206f 7220 656d 7074 7920 6c69  None or empty li
+00057cd0: 7374 292c 2074 6865 6e0a 2020 2020 2020  st), then.      
+00057ce0: 2020 7379 732e 6172 6776 2077 696c 6c20    sys.argv will 
+00057cf0: 6265 2075 7365 6420 6173 2061 7267 756d  be used as argum
+00057d00: 656e 7473 2066 6f72 206d 6174 7269 782d  ents for matrix-
+00057d10: 636f 6d6d 616e 6465 722e 0a0a 2020 2020  commander...    
+00057d20: 4578 616d 706c 6520 696e 7075 7420 6172  Example input ar
+00057d30: 6776 3a20 5b22 6d61 7472 6978 2d63 6f6d  gv: ["matrix-com
+00057d40: 6d61 6e64 6572 225d 0a20 2020 2020 2020  mander"].       
+00057d50: 205b 226d 6174 7269 782d 636f 6d6d 616e   ["matrix-comman
+00057d60: 6465 7222 2022 2d2d 7665 7273 696f 6e22  der" "--version"
+00057d70: 5d0a 2020 2020 2020 2020 5b22 6d61 7472  ].        ["matr
+00057d80: 6978 2d63 6f6d 6d61 6e64 6572 2220 222d  ix-commander" "-
+00057d90: 2d6d 6573 7361 6765 2220 2248 656c 6c6f  -message" "Hello
+00057da0: 2220 2d2d 696d 6167 6520 2270 6963 2e6a  " --image "pic.j
+00057db0: 7067 225d 0a0a 2020 2020 5265 7475 726e  pg"]..    Return
+00057dc0: 7320 696e 742e 2030 2066 6f72 2073 7563  s int. 0 for suc
+00057dd0: 6365 7373 2e20 506f 7369 7469 7665 2069  cess. Positive i
+00057de0: 6e74 6567 6572 2066 6f72 2066 6169 6c75  nteger for failu
+00057df0: 7265 2e0a 2020 2020 2020 2020 5265 7475  re..        Retu
+00057e00: 726e 7320 7468 6520 746f 7461 6c20 6e75  rns the total nu
+00057e10: 6d62 6572 206f 6620 6572 726f 7273 2065  mber of errors e
+00057e20: 6e63 6f75 6e74 6572 6564 2e0a 0a20 2020  ncountered...   
+00057e30: 2054 7269 6573 2074 6f20 6176 6f69 6420   Tries to avoid 
+00057e40: 7261 6973 696e 6720 6578 6365 7074 696f  raising exceptio
+00057e50: 6e73 2e0a 0a20 2020 2022 2222 0a20 2020  ns...    """.   
+00057e60: 2074 7279 3a0a 2020 2020 2020 2020 6d61   try:.        ma
+00057e70: 696e 5f69 6e6e 6572 2861 7267 7629 0a20  in_inner(argv). 
+00057e80: 2020 2065 7863 6570 7420 2845 7863 6570     except (Excep
+00057e90: 7469 6f6e 2c20 4d61 7472 6978 436f 6d6d  tion, MatrixComm
+00057ea0: 616e 6465 7245 7272 6f72 2c20 4d61 7472  anderError, Matr
+00057eb0: 6978 436f 6d6d 616e 6465 7257 6172 6e69  ixCommanderWarni
+00057ec0: 6e67 2920 6173 2065 3a0a 2020 2020 2020  ng) as e:.      
+00057ed0: 2020 6966 2065 206e 6f74 2069 6e20 284d    if e not in (M
+00057ee0: 6174 7269 7843 6f6d 6d61 6e64 6572 4572  atrixCommanderEr
+00057ef0: 726f 722c 204d 6174 7269 7843 6f6d 6d61  ror, MatrixComma
+00057f00: 6e64 6572 5761 726e 696e 6729 3a0a 2020  nderWarning):.  
+00057f10: 2020 2020 2020 2020 2020 6773 2e65 7272            gs.err
+00057f20: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+00057f30: 2020 2020 7462 203d 2022 220a 2020 2020      tb = "".    
+00057f40: 2020 2020 6966 2067 732e 7061 2e64 6562      if gs.pa.deb
+00057f50: 7567 203e 2030 3a0a 2020 2020 2020 2020  ug > 0:.        
+00057f60: 2020 2020 7462 203d 2066 225c 6e48 6572      tb = f"\nHer
+00057f70: 6520 6973 2074 6865 2074 7261 6365 6261  e is the traceba
+00057f80: 636b 2e5c 6e7b 7472 6163 6562 6163 6b2e  ck.\n{traceback.
+00057f90: 666f 726d 6174 5f65 7863 2829 7d22 0a20  format_exc()}". 
+00057fa0: 2020 2020 2020 2069 6620 6520 3d3d 204d         if e == M
+00057fb0: 6174 7269 7843 6f6d 6d61 6e64 6572 5761  atrixCommanderWa
+00057fc0: 726e 696e 673a 0a20 2020 2020 2020 2020  rning:.         
+00057fd0: 2020 2067 732e 6c6f 672e 7761 726e 696e     gs.log.warnin
+00057fe0: 6728 6622 7b65 7d7b 7462 7d22 290a 2020  g(f"{e}{tb}").  
+00057ff0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00058000: 2020 2020 2020 2020 6773 2e6c 6f67 2e65          gs.log.e
+00058010: 7272 6f72 2866 227b 657d 7b74 627d 2229  rror(f"{e}{tb}")
+00058020: 0a20 2020 2069 6620 6773 2e65 7272 5f63  .    if gs.err_c
+00058030: 6f75 6e74 203e 2030 206f 7220 6773 2e77  ount > 0 or gs.w
+00058040: 6172 6e5f 636f 756e 7420 3e20 303a 0a20  arn_count > 0:. 
+00058050: 2020 2020 2020 2067 732e 6c6f 672e 696e         gs.log.in
+00058060: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+00058070: 6622 7b67 732e 6572 725f 636f 756e 747d  f"{gs.err_count}
+00058080: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00058090: 2265 7272 6f72 7b27 2720 6966 2067 732e  "error{'' if gs.
+000580a0: 6572 725f 636f 756e 7420 3d3d 2031 2065  err_count == 1 e
+000580b0: 6c73 6520 2773 277d 2061 6e64 2022 0a20  lse 's'} and ". 
+000580c0: 2020 2020 2020 2020 2020 2066 227b 6773             f"{gs
+000580d0: 2e77 6172 6e5f 636f 756e 747d 2022 0a20  .warn_count} ". 
+000580e0: 2020 2020 2020 2020 2020 2066 2277 6172             f"war
+000580f0: 6e69 6e67 7b27 2720 6966 2067 732e 7761  ning{'' if gs.wa
+00058100: 726e 5f63 6f75 6e74 203d 3d20 3120 656c  rn_count == 1 el
+00058110: 7365 2027 7327 7d20 6f63 6375 7272 6564  se 's'} occurred
+00058120: 2e22 0a20 2020 2020 2020 2029 0a20 2020  .".        ).   
+00058130: 2072 6574 7572 6e20 6773 2e65 7272 5f63   return gs.err_c
+00058140: 6f75 6e74 2020 2320 3020 666f 7220 7375  ount  # 0 for su
+00058150: 6363 6573 730a 0a0a 6966 205f 5f6e 616d  ccess...if __nam
+00058160: 655f 5f20 3d3d 2022 5f5f 6d61 696e 5f5f  e__ == "__main__
+00058170: 223a 0a20 2020 2073 7973 2e65 7869 7428  ":.    sys.exit(
+00058180: 6d61 696e 2829 290a 2320 454f 460a       main()).# EOF.
```

### Comparing `matrix-commander-7.1.0/matrix_commander.egg-info/PKG-INFO` & `matrix-commander-7.2.0/matrix_commander.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: matrix-commander
-Version: 7.1.0
+Version: 7.2.0
 Summary: A simple command-line Matrix client
 Home-page: https://github.com/8go/matrix-commander
 Author: 8go
 Project-URL: Bug Tracker, https://github.com/8go/matrix-commander/issues
 Project-URL: repository, https://github.com/8go/matrix-commander
 Keywords: Matrix,chat,messaging
 Classifier: Programming Language :: Python :: 3.8
@@ -261,14 +261,15 @@
 - Joining rooms
 - Leaving rooms
 - Forgetting rooms
 - Inviting other users to rooms
 - Banning from rooms
 - Unbanning from rooms
 - Kicking from rooms
+- Accepting room invites
 - Supports renaming of device
 - Supports getting and setting display name
 - Supports getting and setting presence
 - Uploading, downloading, and deleting to/from resource depository
 - Listing your devices
 - Listing discovery info
 - Listing available login methods supported by server
@@ -708,14 +709,19 @@
     --user '@user1:example.com' --password 'user1-password'
 $ # delete a message with event id 'someEventId'
 # matrix-commander --room-redact '!someroomId1:example.com' 'someEventId'
 $ # delete 2 images from 2 rooms
 $ matrix-commander --room-redact \
     '\!someroomId1:example.com' '\$someEventId1' 'Image deleted, obsolete info'
     '\!someroomId2:example.com' '\$someEventId2' 'Image deleted, outdated'
+$ # list room invitations
+$ matrix-commander --listen once --room-invites list
+$ # accepting room invitations, automatically joining rooms to which one is 
+$ # invited to
+$ matrix-commander --listen forever --room-invites list+join
 $ # print its own user id
 $ matrix-commander --whoami
 $ # skip SSL certificate verification for a homeserver without SSL
 $ matrix-commander --no-ssl -m "also working without Let's Encrypt SSL"
 $ # use your own SSL certificate for a homeserver with SSL and local certs
 $ matrix-commander --ssl-certificate mycert.crt -m "using my own cert"
 $ # download and decrypt media files like images, audio, PDF, etc.
@@ -1894,22 +1900,33 @@
                         listen' and '--tail'. All other arguments like '--get-
                         room-info' will print no output.
   --room-invites [LIST|JOIN|LIST+JOIN]
                         List room invitations and/or join invited rooms.
                         Details:: This option takes zero or one argument. If
                         no argument is given, 'list' is assumed which will
                         list all room invitation events as they are received.
-                        'join' will join the room(s) each time a room
-                        invitation is received. 'list+join' will do both, list
-                        the invitations as well as automatically join the
-                        rooms to which an invitation was received. This option
-                        only has effect if listening once or forever! So use '
-                        --listen once' or '--listen forever' together with
-                        this option. Don't confuse this option with --room-
-                        invite.
+                        Listing will print the room id and other information
+                        to standard output. 'join' will join the room(s) each
+                        time a room invitation is received. 'list+join' will
+                        do both, list the invitations as well as automatically
+                        join the rooms to which an invitation was received. '
+                        --room-invites' can be combined with '--listen'. If
+                        and only if '--listen forever' is used, will the
+                        program listen continuously for room invites. In all
+                        other cases, the program only looks for room
+                        invitation events once; and it does so before any
+                        possible listening to messages. Warning: events are
+                        usually delivered once. So, if you listen for and list
+                        invites you will get them and list them the first time
+                        you run '--room-invites list'. On the second run of '
+                        --room-invites list' the events will not be replayed
+                        and not be listed. Hence, if you list the invites, you
+                        might want to store the output (room id) so that you
+                        can join the room later with '--room-join' for
+                        example. Don't confuse this option with --room-invite.
   -v [PRINT|CHECK], -V [PRINT|CHECK], --version [PRINT|CHECK]
                         Print version information or check for updates.
                         Details:: This option takes zero or one argument. If
                         no argument is given, 'print' is assumed which will
                         print the version of the currently installed
                         'PROG_WITHOUT_EXT' package. 'check' is the
                         alternative. '{CHECK}' connects to https://pypi.org
@@ -1917,15 +1934,15 @@
                         There is no 'calling home' on every run, only a 'check
                         pypi.org' upon request. Your privacy is protected. The
                         new release is neither downloaded, nor installed. It
                         just informs you. After printing version information
                         the program will continue to run. This is useful for
                         having version number in the log files.
 
-You are running version 7.1.0 2023-04-19. Enjoy, star on Github and contribute
+You are running version 7.2.0 2023-04-20. Enjoy, star on Github and contribute
 by submitting a Pull Request. Also have a look at matrix-commander-tui.
 ```
 
 # Autocompletion
 
 Tab completion is provided for shells (e.g. bash), courtesy of @mizlan).
```

### Comparing `matrix-commander-7.1.0/setup.cfg` & `matrix-commander-7.2.0/setup.cfg`

 * *Files 14% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [metadata]
 name = matrix-commander
-version = 7.1.0
+version = 7.2.0
 author = 8go
 description = A simple command-line Matrix client
 long_description = file: PyPi-Instructions.md, README.md
 long_description_content_type = text/markdown
 keywords = Matrix, chat, messaging
 url = https://github.com/8go/matrix-commander
 project_urls =
```

### Comparing `matrix-commander-7.1.0/tests/test-send.py` & `matrix-commander-7.2.0/tests/test-send.py`

 * *Files identical despite different names*

