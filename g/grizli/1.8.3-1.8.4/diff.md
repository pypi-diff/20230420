# Comparing `tmp/grizli-1.8.3.tar.gz` & `tmp/grizli-1.8.4.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "grizli-1.8.3.tar", last modified: Fri Mar 24 16:31:05 2023, max compression
+gzip compressed data, was "grizli-1.8.4.tar", last modified: Thu Apr 20 13:26:27 2023, max compression
```

## Comparing `grizli-1.8.3.tar` & `grizli-1.8.4.tar`

### file list

```diff
@@ -1,206 +1,206 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.851622 grizli-1.8.3/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.775621 grizli-1.8.3/.github/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.787621 grizli-1.8.3/.github/workflows/
--rw-r--r--   0 runner    (1001) docker     (123)     1536 2023-03-24 16:30:50.000000 grizli-1.8.3/.github/workflows/publish-to-pypi.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1742 2023-03-24 16:30:50.000000 grizli-1.8.3/.github/workflows/python-package-ero.yml
--rw-r--r--   0 runner    (1001) docker     (123)      926 2023-03-24 16:30:50.000000 grizli-1.8.3/.github/workflows/python-package-with-jwst.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1797 2023-03-24 16:30:50.000000 grizli-1.8.3/.github/workflows/python-package.yml
--rw-r--r--   0 runner    (1001) docker     (123)      936 2023-03-24 16:30:50.000000 grizli-1.8.3/.gitignore
--rw-r--r--   0 runner    (1001) docker     (123)      556 2023-03-24 16:30:50.000000 grizli-1.8.3/.readthedocs.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1094 2023-03-24 16:30:50.000000 grizli-1.8.3/.travis.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1089 2023-03-24 16:30:50.000000 grizli-1.8.3/CHANGES.rst
--rw-r--r--   0 runner    (1001) docker     (123)     1180 2023-03-24 16:30:50.000000 grizli-1.8.3/CITATION.cff
--rw-r--r--   0 runner    (1001) docker     (123)     1084 2023-03-24 16:30:50.000000 grizli-1.8.3/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)     6827 2023-03-24 16:31:05.851622 grizli-1.8.3/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     6095 2023-03-24 16:30:50.000000 grizli-1.8.3/README.rst
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.787621 grizli-1.8.3/docs/
--rw-r--r--   0 runner    (1001) docker     (123)     4581 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/Makefile
--rw-r--r--   0 runner    (1001) docker     (123)      111 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/README.rst
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.791622 grizli-1.8.3/docs/_static/
--rw-r--r--   0 runner    (1001) docker     (123)     4286 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_static/grizli.ico
--rw-r--r--   0 runner    (1001) docker     (123)      986 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_static/grizli_favico.png
--rw-r--r--   0 runner    (1001) docker     (123)    35735 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_static/grizli_favico_large.png
--rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_static/grizli_logo.pdf
--rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_static/grizli_logo.png
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.775621 grizli-1.8.3/docs/_templates/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.791622 grizli-1.8.3/docs/_templates/autosummary/
--rw-r--r--   0 runner    (1001) docker     (123)      250 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_templates/autosummary/base.rst
--rw-r--r--   0 runner    (1001) docker     (123)      251 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_templates/autosummary/class.rst
--rw-r--r--   0 runner    (1001) docker     (123)      252 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/_templates/autosummary/module.rst
--rw-r--r--   0 runner    (1001) docker     (123)       75 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/changelog.rst
--rw-r--r--   0 runner    (1001) docker     (123)     6794 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/conf.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.795621 grizli-1.8.3/docs/grizli/
--rw-r--r--   0 runner    (1001) docker     (123)       86 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli/basic.rst
--rw-r--r--   0 runner    (1001) docker     (123)   851247 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli/ceers-sm.field.jpg
--rw-r--r--   0 runner    (1001) docker     (123)    98779 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli/image-release-v6.md
--rw-r--r--   0 runner    (1001) docker     (123)    65882 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli/image-release-v6.rst
--rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli/index.rst
--rw-r--r--   0 runner    (1001) docker     (123)     7704 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli/install.rst
--rw-r--r--   0 runner    (1001) docker     (123)      676 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli/prep.rst
--rw-r--r--   0 runner    (1001) docker     (123)    38260 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/grizli-for-dummies.rst
--rw-r--r--   0 runner    (1001) docker     (123)     6655 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/index.rst
--rw-r--r--   0 runner    (1001) docker     (123)     4549 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/make.bat
--rw-r--r--   0 runner    (1001) docker     (123)      154 2023-03-24 16:30:50.000000 grizli-1.8.3/docs/rtd-pip-requirements
--rw-r--r--   0 runner    (1001) docker     (123)      189 2023-03-24 16:30:50.000000 grizli-1.8.3/environment.yml
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.799621 grizli-1.8.3/examples/
--rw-r--r--   0 runner    (1001) docker     (123)      257 2023-03-24 16:30:50.000000 grizli-1.8.3/examples/README.md
--rw-r--r--   0 runner    (1001) docker     (123)     6880 2023-03-24 16:30:50.000000 grizli-1.8.3/examples/demo.py
--rw-r--r--   0 runner    (1001) docker     (123)    20658 2023-03-24 16:30:50.000000 grizli-1.8.3/examples/grizli_demo_0.pdf
--rw-r--r--   0 runner    (1001) docker     (123)   100981 2023-03-24 16:30:50.000000 grizli-1.8.3/examples/grizli_demo_1.pdf
--rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-03-24 16:30:50.000000 grizli-1.8.3/examples/grizli_logo.pdf
--rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-03-24 16:30:50.000000 grizli-1.8.3/examples/grizli_logo.png
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.807622 grizli-1.8.3/grizli/
--rw-r--r--   0 runner    (1001) docker     (123)      748 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.811622 grizli-1.8.3/grizli/aws/
--rw-r--r--   0 runner    (1001) docker     (123)      137 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    46017 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/aws_drizzler.py
--rw-r--r--   0 runner    (1001) docker     (123)   131901 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/db.py
--rw-r--r--   0 runner    (1001) docker     (123)    43919 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/field_tiles.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     9609 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/fit_redshift_lambda.py
--rw-r--r--   0 runner    (1001) docker     (123)    32497 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/lambda_handler.py
--rw-r--r--   0 runner    (1001) docker     (123)    56137 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/tile_mosaic.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    75247 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/aws/visit_processor.py
--rw-r--r--   0 runner    (1001) docker     (123)    39334 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)    19411 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/combine.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.819622 grizli-1.8.3/grizli/data/
--rw-r--r--   0 runner    (1001) docker     (123)     9159 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/auto_script_defaults.yml
--rw-r--r--   0 runner    (1001) docker     (123)      107 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/db.yml
--rw-r--r--   0 runner    (1001) docker     (123)     3639 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/gaia_dr2_vizier_columns.txt
--rw-r--r--   0 runner    (1001) docker     (123)    20160 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/hst_encircled_energy.fits
--rw-r--r--   0 runner    (1001) docker     (123)    11962 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/jwst_bp_info.yml
--rw-r--r--   0 runner    (1001) docker     (123)     1167 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nircam_wisp.yml
--rw-r--r--   0 runner    (1001) docker     (123)    47343 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    39840 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    17258 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16916 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16627 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16943 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    35486 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    18003 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16764 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16962 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    16851 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    22659 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)     5043 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/photom_correction.yml
--rw-r--r--   0 runner    (1001) docker     (123)    97707 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/sep_catalog_junk.pkl
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.823622 grizli-1.8.3/grizli/data/templates/
--rw-r--r--   0 runner    (1001) docker     (123)    94256 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/FeII_VeronCetty2004.txt
--rw-r--r--   0 runner    (1001) docker     (123)      654 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/README
--rw-r--r--   0 runner    (1001) docker     (123)   221907 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/alf_SSP.dat
--rw-r--r--   0 runner    (1001) docker     (123)    48158 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/cvd12_t11_solar_Chabrier.dat
--rw-r--r--   0 runner    (1001) docker     (123)    51300 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/eazy_intermediate.dat
--rw-r--r--   0 runner    (1001) docker     (123)    44824 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/erb2010.dat
--rw-r--r--   0 runner    (1001) docker     (123)    31746 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/erb2010_continuum.dat
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.831622 grizli-1.8.3/grizli/data/templates/fsps/
--rw-r--r--   0 runner    (1001) docker     (123)      591 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3.param
--rw-r--r--   0 runner    (1001) docker     (123)    11520 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits
--rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat
--rw-r--r--   0 runner    (1001) docker     (123)      687 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param
--rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat
--rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat
--rw-r--r--   0 runner    (1001) docker     (123)   143958 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/fsps_starburst_lines.txt
--rw-r--r--   0 runner    (1001) docker     (123)    12636 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/post_starburst.dat
--rw-r--r--   0 runner    (1001) docker     (123)   557728 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/quasar_lines.txt
--rw-r--r--   0 runner    (1001) docker     (123)   382216 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/red_blue_continuum.txt
--rw-r--r--   0 runner    (1001) docker     (123)   381266 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/red_blue_continuum_noLya.txt
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.839622 grizli-1.8.3/grizli/data/templates/stars/
--rw-r--r--   0 runner    (1001) docker     (123)   173069 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/L1.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)   145419 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/L3.5.txt
--rw-r--r--   0 runner    (1001) docker     (123)    26044 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/L6.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)   159659 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/M6.5.txt
--rw-r--r--   0 runner    (1001) docker     (123)   166768 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/M8.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)    57965 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/T2.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)    55327 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/T6.0.txt
--rw-r--r--   0 runner    (1001) docker     (123)     8115 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/T7.5.txt
--rw-r--r--   0 runner    (1001) docker     (123)  3193920 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits
--rw-r--r--   0 runner    (1001) docker     (123)    83291 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/carbon_star.txt
--rw-r--r--   0 runner    (1001) docker     (123)      175 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/templates/stars/stars_settl.param
--rw-r--r--   0 runner    (1001) docker     (123)   299891 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/visit_alignment.txt
--rw-r--r--   0 runner    (1001) docker     (123)    54096 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    23739 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)     1057 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/data/wfc3ir_ee.txt
--rw-r--r--   0 runner    (1001) docker     (123)     5521 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/ds9.py
--rw-r--r--   0 runner    (1001) docker     (123)    17575 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/fake_image.py
--rw-r--r--   0 runner    (1001) docker     (123)   185637 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/fitting.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.839622 grizli-1.8.3/grizli/galfit/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/galfit/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    15242 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/galfit/deconvolve.py
--rw-r--r--   0 runner    (1001) docker     (123)    25223 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/galfit/galfit.py
--rw-r--r--   0 runner    (1001) docker     (123)     4926 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/galfit/gfutils.py
--rw-r--r--   0 runner    (1001) docker     (123)    16595 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/galfit/psf.py
--rw-r--r--   0 runner    (1001) docker     (123)    39980 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/grismconf.py
--rw-r--r--   0 runner    (1001) docker     (123)    26959 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/jwst_level1.py
--rw-r--r--   0 runner    (1001) docker     (123)    77490 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/jwst_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)   203738 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/model.py
--rw-r--r--   0 runner    (1001) docker     (123)   203978 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/multifit.py
--rw-r--r--   0 runner    (1001) docker     (123)     2872 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/nbutils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.843622 grizli-1.8.3/grizli/pipeline/
--rw-r--r--   0 runner    (1001) docker     (123)     1147 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/pipeline/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)   219388 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/pipeline/auto_script.py
--rw-r--r--   0 runner    (1001) docker     (123)     8267 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/pipeline/default_params.py
--rw-r--r--   0 runner    (1001) docker     (123)    32369 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/pipeline/photoz.py
--rw-r--r--   0 runner    (1001) docker     (123)     6729 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/pipeline/reprocess.py
--rw-r--r--   0 runner    (1001) docker     (123)     1485 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/pipeline/run_MPI.py
--rw-r--r--   0 runner    (1001) docker     (123)     8973 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/pipeline/summary.py
--rw-r--r--   0 runner    (1001) docker     (123)   248021 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/prep.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    49392 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/stack.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.843622 grizli-1.8.3/grizli/tests/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.847622 grizli-1.8.3/grizli/tests/data/
--rw-r--r--   0 runner    (1001) docker     (123)     1576 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/fit_args.npy
--rw-r--r--   0 runner    (1001) docker     (123)   812160 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/j033216m2743_00152.beams.fits
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.847622 grizli-1.8.3/grizli/tests/data/jwst-headers/
--rw-r--r--   0 runner    (1001) docker     (123)      116 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/jwst-headers/README.rst
--rw-r--r--   0 runner    (1001) docker     (123)    28024 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47863 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47877 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47996 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)    47827 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz
--rw-r--r--   0 runner    (1001) docker     (123)      546 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/jwst-headers/strip_data.py
--rw-r--r--   0 runner    (1001) docker     (123)   509760 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/niriss_jw01324001001_test.beams.fits
--rw-r--r--   0 runner    (1001) docker     (123)  1120244 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/data/wfc3-parse-test.tar.gz
--rw-r--r--   0 runner    (1001) docker     (123)     2800 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/test_autoscript.py
--rw-r--r--   0 runner    (1001) docker     (123)      832 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/test_cutils.py
--rw-r--r--   0 runner    (1001) docker     (123)     2478 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/test_fits.py
--rw-r--r--   0 runner    (1001) docker     (123)     1895 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/test_grismconf.py
--rw-r--r--   0 runner    (1001) docker     (123)     8532 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/test_jwst.py
--rw-r--r--   0 runner    (1001) docker     (123)     8525 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/tests/test_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)   297020 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.851622 grizli-1.8.3/grizli/utils_c/
--rw-r--r--   0 runner    (1001) docker     (123)      178 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/utils_c/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)   332767 2023-03-24 16:31:04.000000 grizli-1.8.3/grizli/utils_c/disperse.c
--rw-r--r--   0 runner    (1001) docker     (123)     4083 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/utils_c/disperse.pyx
--rw-r--r--   0 runner    (1001) docker     (123)   657359 2023-03-24 16:31:04.000000 grizli-1.8.3/grizli/utils_c/interp.c
--rw-r--r--   0 runner    (1001) docker     (123)    16229 2023-03-24 16:30:50.000000 grizli-1.8.3/grizli/utils_c/interp.pyx
--rw-r--r--   0 runner    (1001) docker     (123)      160 2023-03-24 16:31:05.000000 grizli-1.8.3/grizli/version.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-03-24 16:31:05.807622 grizli-1.8.3/grizli.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     6827 2023-03-24 16:31:05.000000 grizli-1.8.3/grizli.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     6377 2023-03-24 16:31:05.000000 grizli-1.8.3/grizli.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-03-24 16:31:05.000000 grizli-1.8.3/grizli.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)      417 2023-03-24 16:31:05.000000 grizli-1.8.3/grizli.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        7 2023-03-24 16:31:05.000000 grizli-1.8.3/grizli.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)      229 2023-03-24 16:30:50.000000 grizli-1.8.3/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)     1759 2023-03-24 16:31:05.855622 grizli-1.8.3/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)      841 2023-03-24 16:30:50.000000 grizli-1.8.3/setup.py
--rw-r--r--   0 runner    (1001) docker     (123)    13630 2023-03-24 16:30:50.000000 grizli-1.8.3/test_pipeline_hst.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.710019 grizli-1.8.4/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.634018 grizli-1.8.4/.github/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.646018 grizli-1.8.4/.github/workflows/
+-rw-r--r--   0 runner    (1001) docker     (123)     1536 2023-04-20 13:26:09.000000 grizli-1.8.4/.github/workflows/publish-to-pypi.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1742 2023-04-20 13:26:09.000000 grizli-1.8.4/.github/workflows/python-package-ero.yml
+-rw-r--r--   0 runner    (1001) docker     (123)      926 2023-04-20 13:26:09.000000 grizli-1.8.4/.github/workflows/python-package-with-jwst.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1797 2023-04-20 13:26:09.000000 grizli-1.8.4/.github/workflows/python-package.yml
+-rw-r--r--   0 runner    (1001) docker     (123)      936 2023-04-20 13:26:09.000000 grizli-1.8.4/.gitignore
+-rw-r--r--   0 runner    (1001) docker     (123)      556 2023-04-20 13:26:09.000000 grizli-1.8.4/.readthedocs.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1094 2023-04-20 13:26:09.000000 grizli-1.8.4/.travis.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1089 2023-04-20 13:26:09.000000 grizli-1.8.4/CHANGES.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     1180 2023-04-20 13:26:09.000000 grizli-1.8.4/CITATION.cff
+-rw-r--r--   0 runner    (1001) docker     (123)     1084 2023-04-20 13:26:09.000000 grizli-1.8.4/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     6827 2023-04-20 13:26:27.710019 grizli-1.8.4/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     6095 2023-04-20 13:26:09.000000 grizli-1.8.4/README.rst
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.646018 grizli-1.8.4/docs/
+-rw-r--r--   0 runner    (1001) docker     (123)     4581 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/Makefile
+-rw-r--r--   0 runner    (1001) docker     (123)      111 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/README.rst
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.650019 grizli-1.8.4/docs/_static/
+-rw-r--r--   0 runner    (1001) docker     (123)     4286 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_static/grizli.ico
+-rw-r--r--   0 runner    (1001) docker     (123)      986 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_static/grizli_favico.png
+-rw-r--r--   0 runner    (1001) docker     (123)    35735 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_static/grizli_favico_large.png
+-rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_static/grizli_logo.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_static/grizli_logo.png
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.638018 grizli-1.8.4/docs/_templates/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.650019 grizli-1.8.4/docs/_templates/autosummary/
+-rw-r--r--   0 runner    (1001) docker     (123)      250 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_templates/autosummary/base.rst
+-rw-r--r--   0 runner    (1001) docker     (123)      251 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_templates/autosummary/class.rst
+-rw-r--r--   0 runner    (1001) docker     (123)      252 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/_templates/autosummary/module.rst
+-rw-r--r--   0 runner    (1001) docker     (123)       75 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/changelog.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     6794 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/conf.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.654018 grizli-1.8.4/docs/grizli/
+-rw-r--r--   0 runner    (1001) docker     (123)       86 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli/basic.rst
+-rw-r--r--   0 runner    (1001) docker     (123)   851247 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli/ceers-sm.field.jpg
+-rw-r--r--   0 runner    (1001) docker     (123)    98779 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli/image-release-v6.md
+-rw-r--r--   0 runner    (1001) docker     (123)    65882 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli/image-release-v6.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli/index.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     7704 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli/install.rst
+-rw-r--r--   0 runner    (1001) docker     (123)      676 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli/prep.rst
+-rw-r--r--   0 runner    (1001) docker     (123)    38260 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/grizli-for-dummies.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     6655 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/index.rst
+-rw-r--r--   0 runner    (1001) docker     (123)     4549 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/make.bat
+-rw-r--r--   0 runner    (1001) docker     (123)      154 2023-04-20 13:26:09.000000 grizli-1.8.4/docs/rtd-pip-requirements
+-rw-r--r--   0 runner    (1001) docker     (123)      189 2023-04-20 13:26:09.000000 grizli-1.8.4/environment.yml
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.654018 grizli-1.8.4/examples/
+-rw-r--r--   0 runner    (1001) docker     (123)      257 2023-04-20 13:26:09.000000 grizli-1.8.4/examples/README.md
+-rw-r--r--   0 runner    (1001) docker     (123)     6880 2023-04-20 13:26:09.000000 grizli-1.8.4/examples/demo.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20658 2023-04-20 13:26:09.000000 grizli-1.8.4/examples/grizli_demo_0.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)   100981 2023-04-20 13:26:09.000000 grizli-1.8.4/examples/grizli_demo_1.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)   193903 2023-04-20 13:26:09.000000 grizli-1.8.4/examples/grizli_logo.pdf
+-rw-r--r--   0 runner    (1001) docker     (123)    18807 2023-04-20 13:26:09.000000 grizli-1.8.4/examples/grizli_logo.png
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.662019 grizli-1.8.4/grizli/
+-rw-r--r--   0 runner    (1001) docker     (123)      748 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.666019 grizli-1.8.4/grizli/aws/
+-rw-r--r--   0 runner    (1001) docker     (123)      137 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    46017 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/aws_drizzler.py
+-rw-r--r--   0 runner    (1001) docker     (123)   131901 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/db.py
+-rw-r--r--   0 runner    (1001) docker     (123)    44173 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/field_tiles.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     9609 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/fit_redshift_lambda.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32497 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/lambda_handler.py
+-rw-r--r--   0 runner    (1001) docker     (123)    56356 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/tile_mosaic.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    75375 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/aws/visit_processor.py
+-rw-r--r--   0 runner    (1001) docker     (123)    40400 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19411 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/combine.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.670019 grizli-1.8.4/grizli/data/
+-rw-r--r--   0 runner    (1001) docker     (123)     9269 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/auto_script_defaults.yml
+-rw-r--r--   0 runner    (1001) docker     (123)      107 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/db.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     3639 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/gaia_dr2_vizier_columns.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    20160 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/hst_encircled_energy.fits
+-rw-r--r--   0 runner    (1001) docker     (123)    11962 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/jwst_bp_info.yml
+-rw-r--r--   0 runner    (1001) docker     (123)     1167 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nircam_wisp.yml
+-rw-r--r--   0 runner    (1001) docker     (123)    47343 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    39840 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    17258 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16916 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16627 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16943 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    35486 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    18003 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16764 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16962 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    16851 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    22659 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)     5043 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/photom_correction.yml
+-rw-r--r--   0 runner    (1001) docker     (123)    97707 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/sep_catalog_junk.pkl
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.678019 grizli-1.8.4/grizli/data/templates/
+-rw-r--r--   0 runner    (1001) docker     (123)    94256 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/FeII_VeronCetty2004.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      654 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/README
+-rw-r--r--   0 runner    (1001) docker     (123)   221907 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/alf_SSP.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    48158 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/cvd12_t11_solar_Chabrier.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    51300 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/eazy_intermediate.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    44824 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/erb2010.dat
+-rw-r--r--   0 runner    (1001) docker     (123)    31746 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/erb2010_continuum.dat
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.690019 grizli-1.8.4/grizli/data/templates/fsps/
+-rw-r--r--   0 runner    (1001) docker     (123)      591 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3.param
+-rw-r--r--   0 runner    (1001) docker     (123)    11520 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits
+-rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat
+-rw-r--r--   0 runner    (1001) docker     (123)      687 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param
+-rw-r--r--   0 runner    (1001) docker     (123)   156520 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156521 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156527 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156524 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156523 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156509 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156510 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156511 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156512 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   156518 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   143958 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/fsps_starburst_lines.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    12636 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/post_starburst.dat
+-rw-r--r--   0 runner    (1001) docker     (123)   557728 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/quasar_lines.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   382216 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/red_blue_continuum.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   381266 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/red_blue_continuum_noLya.txt
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.698019 grizli-1.8.4/grizli/data/templates/stars/
+-rw-r--r--   0 runner    (1001) docker     (123)   173069 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/L1.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   145419 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/L3.5.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    26044 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/L6.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   159659 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/M6.5.txt
+-rw-r--r--   0 runner    (1001) docker     (123)   166768 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/M8.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    57965 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/T2.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    55327 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/T6.0.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     8115 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/T7.5.txt
+-rw-r--r--   0 runner    (1001) docker     (123)  3193920 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits
+-rw-r--r--   0 runner    (1001) docker     (123)    83291 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/carbon_star.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      175 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/templates/stars/stars_settl.param
+-rw-r--r--   0 runner    (1001) docker     (123)   299891 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/visit_alignment.txt
+-rw-r--r--   0 runner    (1001) docker     (123)    54096 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    23739 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)     1057 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/data/wfc3ir_ee.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     5521 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/ds9.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17575 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/fake_image.py
+-rw-r--r--   0 runner    (1001) docker     (123)   185637 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/fitting.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.698019 grizli-1.8.4/grizli/galfit/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/galfit/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15242 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/galfit/deconvolve.py
+-rw-r--r--   0 runner    (1001) docker     (123)    25223 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/galfit/galfit.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4926 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/galfit/gfutils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16595 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/galfit/psf.py
+-rw-r--r--   0 runner    (1001) docker     (123)    39980 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/grismconf.py
+-rw-r--r--   0 runner    (1001) docker     (123)    34286 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/jwst_level1.py
+-rw-r--r--   0 runner    (1001) docker     (123)    77490 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/jwst_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   203738 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/model.py
+-rw-r--r--   0 runner    (1001) docker     (123)   203978 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/multifit.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2872 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/nbutils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.702019 grizli-1.8.4/grizli/pipeline/
+-rw-r--r--   0 runner    (1001) docker     (123)     1147 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/pipeline/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)   222662 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/pipeline/auto_script.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8267 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/pipeline/default_params.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32369 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/pipeline/photoz.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6729 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/pipeline/reprocess.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1485 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/pipeline/run_MPI.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8973 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/pipeline/summary.py
+-rw-r--r--   0 runner    (1001) docker     (123)   248022 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/prep.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    49392 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/stack.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.702019 grizli-1.8.4/grizli/tests/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.706019 grizli-1.8.4/grizli/tests/data/
+-rw-r--r--   0 runner    (1001) docker     (123)     1576 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/fit_args.npy
+-rw-r--r--   0 runner    (1001) docker     (123)   812160 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/j033216m2743_00152.beams.fits
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.706019 grizli-1.8.4/grizli/tests/data/jwst-headers/
+-rw-r--r--   0 runner    (1001) docker     (123)      116 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/jwst-headers/README.rst
+-rw-r--r--   0 runner    (1001) docker     (123)    28024 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47863 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47877 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47996 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)    47827 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz
+-rw-r--r--   0 runner    (1001) docker     (123)      546 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/jwst-headers/strip_data.py
+-rw-r--r--   0 runner    (1001) docker     (123)   509760 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/niriss_jw01324001001_test.beams.fits
+-rw-r--r--   0 runner    (1001) docker     (123)  1120244 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/data/wfc3-parse-test.tar.gz
+-rw-r--r--   0 runner    (1001) docker     (123)     2800 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/test_autoscript.py
+-rw-r--r--   0 runner    (1001) docker     (123)      832 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/test_cutils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2478 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/test_fits.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1895 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/test_grismconf.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8532 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/test_jwst.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8525 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/tests/test_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   297616 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.710019 grizli-1.8.4/grizli/utils_c/
+-rw-r--r--   0 runner    (1001) docker     (123)      178 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/utils_c/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)   334421 2023-04-20 13:26:26.000000 grizli-1.8.4/grizli/utils_c/disperse.c
+-rw-r--r--   0 runner    (1001) docker     (123)     4083 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/utils_c/disperse.pyx
+-rw-r--r--   0 runner    (1001) docker     (123)   659013 2023-04-20 13:26:26.000000 grizli-1.8.4/grizli/utils_c/interp.c
+-rw-r--r--   0 runner    (1001) docker     (123)    16229 2023-04-20 13:26:09.000000 grizli-1.8.4/grizli/utils_c/interp.pyx
+-rw-r--r--   0 runner    (1001) docker     (123)      160 2023-04-20 13:26:27.000000 grizli-1.8.4/grizli/version.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-20 13:26:27.662019 grizli-1.8.4/grizli.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     6827 2023-04-20 13:26:27.000000 grizli-1.8.4/grizli.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     6377 2023-04-20 13:26:27.000000 grizli-1.8.4/grizli.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-04-20 13:26:27.000000 grizli-1.8.4/grizli.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      417 2023-04-20 13:26:27.000000 grizli-1.8.4/grizli.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        7 2023-04-20 13:26:27.000000 grizli-1.8.4/grizli.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      229 2023-04-20 13:26:09.000000 grizli-1.8.4/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)     1759 2023-04-20 13:26:27.710019 grizli-1.8.4/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)      841 2023-04-20 13:26:09.000000 grizli-1.8.4/setup.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13630 2023-04-20 13:26:09.000000 grizli-1.8.4/test_pipeline_hst.py
```

### Comparing `grizli-1.8.3/.github/workflows/publish-to-pypi.yml` & `grizli-1.8.4/.github/workflows/publish-to-pypi.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/.github/workflows/python-package-ero.yml` & `grizli-1.8.4/.github/workflows/python-package-ero.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/.github/workflows/python-package-with-jwst.yml` & `grizli-1.8.4/.github/workflows/python-package-with-jwst.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/.github/workflows/python-package.yml` & `grizli-1.8.4/.github/workflows/python-package.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/.gitignore` & `grizli-1.8.4/.gitignore`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/.readthedocs.yml` & `grizli-1.8.4/.readthedocs.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/.travis.yml` & `grizli-1.8.4/.travis.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/CHANGES.rst` & `grizli-1.8.4/CHANGES.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/CITATION.cff` & `grizli-1.8.4/CITATION.cff`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/LICENSE.txt` & `grizli-1.8.4/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/PKG-INFO` & `grizli-1.8.4/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: grizli
-Version: 1.8.3
+Version: 1.8.4
 Summary: Grism redshift and line analysis software
 Home-page: https://github.com/gbrammer/grizli
 Author: G. Brammer
 Author-email: gbrammer@gmail.com
 License: MIT
 Project-URL: Documentation, https://grizli.readthedocs.io/
 Project-URL: Source, https://github.com/gbrammer/grizli
```

### Comparing `grizli-1.8.3/README.rst` & `grizli-1.8.4/README.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/Makefile` & `grizli-1.8.4/docs/Makefile`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/_static/grizli.ico` & `grizli-1.8.4/docs/_static/grizli.ico`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/_static/grizli_favico.png` & `grizli-1.8.4/docs/_static/grizli_favico.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/_static/grizli_favico_large.png` & `grizli-1.8.4/docs/_static/grizli_favico_large.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/_static/grizli_logo.pdf` & `grizli-1.8.4/docs/_static/grizli_logo.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/_static/grizli_logo.png` & `grizli-1.8.4/docs/_static/grizli_logo.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/conf.py` & `grizli-1.8.4/docs/conf.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/grizli/ceers-sm.field.jpg` & `grizli-1.8.4/docs/grizli/ceers-sm.field.jpg`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/grizli/image-release-v6.md` & `grizli-1.8.4/docs/grizli/image-release-v6.md`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/grizli/image-release-v6.rst` & `grizli-1.8.4/docs/grizli/image-release-v6.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/grizli/index.rst` & `grizli-1.8.4/docs/grizli/index.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/grizli/install.rst` & `grizli-1.8.4/docs/grizli/install.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/grizli/prep.rst` & `grizli-1.8.4/docs/grizli/prep.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/grizli-for-dummies.rst` & `grizli-1.8.4/docs/grizli-for-dummies.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/index.rst` & `grizli-1.8.4/docs/index.rst`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/docs/make.bat` & `grizli-1.8.4/docs/make.bat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/examples/demo.py` & `grizli-1.8.4/examples/demo.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/examples/grizli_demo_0.pdf` & `grizli-1.8.4/examples/grizli_demo_0.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/examples/grizli_demo_1.pdf` & `grizli-1.8.4/examples/grizli_demo_1.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/examples/grizli_logo.pdf` & `grizli-1.8.4/examples/grizli_logo.pdf`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/examples/grizli_logo.png` & `grizli-1.8.4/examples/grizli_logo.png`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/__init__.py` & `grizli-1.8.4/grizli/__init__.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/aws/aws_drizzler.py` & `grizli-1.8.4/grizli/aws/aws_drizzler.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/aws/db.py` & `grizli-1.8.4/grizli/aws/db.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/aws/field_tiles.py` & `grizli-1.8.4/grizli/aws/field_tiles.py`

 * *Files 1% similar despite different names*

```diff
@@ -307,15 +307,15 @@
                     imsave(tile_file, img[sly, slx, :][::-1,:,:],
                        plugin='pil', format_str='png')
                 else:
                     imsave(tile_file, img[sly, slx][::-1,:],
                        plugin='pil', format_str='png')
 
 
-def make_all_tile_images(root, force=False, ref_tile=(8,8), cleanup=True, zoom_levels=[4,3,2,1], brgb_filts=['visr','visb','uv'], rgb_filts=['visr','j','h'], blue_is_opt=True, make_opt_filters=True, make_ir_filters=True, make_combinations=True, **kwargs):
+def make_all_tile_images(root, force=False, ref_tile=(8,8), cleanup=True, zoom_levels=[4,3,2,1], brgb_filts=['visr','visb','uv'], rgb_filts=['visr','j','h'], blue_is_opt=True, make_opt_filters=True, make_ir_filters=True, make_combinations=True, rgb_only=False, **kwargs):
     """
     Make tiles for map
     """
     import matplotlib.pyplot as plt
     
     from grizli.pipeline import auto_script
     
@@ -480,14 +480,17 @@
             split_tiles(root, ref_tile=ref_tile, 
                         filters=['f814w','f160w'], zoom_levels=zoom_levels,
                         optical=False, suffix='.vi', xsize=32, scl=0.8,
                         force=force, rgb_scl=[1, 1, 1], rgb_min=-0.018)
 
             plt.close('all')
     
+    if rgb_only:
+        make_ir_filters = make_opt_filters = False
+        
     ####### Single filters
     # IR
     if make_ir_filters:
         files = []
         for ir_filt in ['f098m','f105w','f110w','f125w','f140w','f160w']:
             files += glob.glob(f'{root}-{ir_filt}*sci.fits*')
         
@@ -593,15 +596,15 @@
     db.execute(f"""update combined_tiles_filters
     set status={status}, modtime={NOW}
     where tile = '{tile}' and field='{field}' and filter='{filter}'
     """)
     return status
 
 
-def process_tile(field='cos', tile='01.01', filters=TILE_FILTERS, fetch_existing=True, cleanup=True, make_catalog=False, clean_flt=True, pixfrac=0.75, make_tile_images=True, make_combinations=True, **kwargs):
+def process_tile(field='cos', tile='01.01', filters=TILE_FILTERS, fetch_existing=True, cleanup=True, make_catalog=False, clean_flt=True, pixfrac=0.75, make_tile_images=True, make_combinations=True, rgb_only=False, **kwargs):
     """
     
     Returns
     status : int
         - 2 - completed successfully
         - 4 - no images created
         - 10 - catalog requested but failed to create
@@ -637,15 +640,16 @@
                           --include "{root}*_dr?*fits.gz"
                           """.replace('\n', ' '))
         
         files = glob.glob(f'{root}*gz')
         for file in files:
             os.system(f'gunzip --force {file}')
             
-    visit_processor.cutout_mosaic(rootname=root, 
+    if not rgb_only:
+        visit_processor.cutout_mosaic(rootname=root, 
                               skip_existing=True,
                               ir_wcs=ir_wcs,
                               filters=filters, 
                               pixfrac=pixfrac,
                               kernel='square', s3output=None, 
                               gzip_output=False, clean_flt=clean_flt)
     
@@ -784,42 +788,44 @@
         with warnings.catch_warnings():
             warnings.filterwarnings("ignore", category=UserWarning)
             
             make_all_tile_images(root, force=False, ref_tile=ref_tile,
                                  rgb_filts=['h','j','visr'],
                                  brgb_filts=['visr','visb','uv'],
                                  blue_is_opt=(field not in ['j013804m2156']), 
-                                 make_combinations=make_combinations, 
+                                 make_combinations=make_combinations,
+                                 rgb_only=rgb_only,
                                  **kwargs)
     
     dirs = glob.glob(f'./{root}-tiles/*')
     dirs.sort()
     
     for d in dirs:
         target = os.path.basename(d)
         print(f'Sync {d} >> s3://grizli-v2/ClusterTiles/Map/{field}/{target}/')
     
         os.system(f'aws s3 sync {d}/ ' + 
                   f' s3://grizli-v2/ClusterTiles/Map/{field}/{target} ' + 
                   '--acl public-read --quiet')
                       
-    ### Gzip products
-    drz_files = glob.glob(f'{root}-*_dr*fits')
-    drz_files += glob.glob(f'{root}*seg.fits')
-    drz_files.sort()
-        
-    for file in drz_files:
-        cmd = f'gzip --force {file}'
-        print(cmd)
-        os.system(cmd)
-        
-    os.system(f'aws s3 sync ./ s3://grizli-v2/ClusterTiles/{field}/' + 
-              f' --exclude "*" --include "{root}*gz"' +
-              f' --include "{root}*wcs.csv"' +
-              f' --include "{root}*fp.png" --acl public-read')
+    if not rgb_only:
+        ### Gzip products
+        drz_files = glob.glob(f'{root}-*_dr*fits')
+        drz_files += glob.glob(f'{root}*seg.fits')
+        drz_files.sort()
+        
+        for file in drz_files:
+            cmd = f'gzip --force {file}'
+            print(cmd)
+            os.system(cmd)
+        
+        os.system(f'aws s3 sync ./ s3://grizli-v2/ClusterTiles/{field}/' + 
+                  f' --exclude "*" --include "{root}*gz"' +
+                  f' --include "{root}*wcs.csv"' +
+                  f' --include "{root}*fp.png" --acl public-read')
     
     db.execute(f"update combined_tiles set status=2 where tile = '{tile}' AND field = '{field}'")
     print(f'Set status=2 in `combined_tiles` for {field} {tile}')
     
     if cleanup:
         print(f'rm -rf {root}-tiles')
         os.system(f'rm -rf {root}-tiles')
```

### Comparing `grizli-1.8.3/grizli/aws/fit_redshift_lambda.py` & `grizli-1.8.4/grizli/aws/fit_redshift_lambda.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/aws/lambda_handler.py` & `grizli-1.8.4/grizli/aws/lambda_handler.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/aws/tile_mosaic.py` & `grizli-1.8.4/grizli/aws/tile_mosaic.py`

 * *Files 1% similar despite different names*

```diff
@@ -9,14 +9,16 @@
 """
 import os
 from tqdm import tqdm
 import numpy as np
 
 from . import db
 
+PIXEL_SCALE = 0.1
+
 def define_tile_grid(a=4., phase=0.6):
     """
     Define the tile grid following the PS1 tesselation algorithm from 
     T. Budavari
     https://outerspace.stsci.edu/display/PANSTARRS/PS1+Sky+tessellation+patterns#PS1Skytessellationpatterns-ProjectioncellsintheRINGS.V3tessellation
 
     Paramters
@@ -153,24 +155,24 @@
     
     rows = []
     tileid = 0
     
     for j in tqdm(range(len(dn))):
                     
         ai = 2*np.tan(tn[j]/2)*180/np.pi
-        npix = ai*3600/0.1
+        npix = ai*3600/PIXEL_SCALE
         npixr = int(npix // 512 + 1)*512
-        ai = npixr*0.1/3600
+        ai = npixr*PIXEL_SCALE/3600
         da.append(ai)
         dpix.append(npixr)
         
         ddeg = dn[j]/np.pi*180
         
         h, w = utils.make_wcsheader(ra=0, dec=ddeg, size=ai*3600, 
-                                    pixscale=0.1)
+                                    pixscale=PIXEL_SCALE)
         h['CRPIX1'] += 0.5
         h['CRPIX2'] += 0.5
         
         ras = np.linspace(0, 2*np.pi, np.maximum(mn[j]+1, 1))[:-1]
         
         # Shift to avoid straddling ra=0
         if mn[j] > 1:
@@ -647,15 +649,15 @@
     in_tile = ((tp > 0) & (tp < xTILES['npix'])).sum(axis=0) == 2
     subt = xTILES[in_tile]
     
     subt['fsubx'], subt['fsuby'] = tp[:,in_tile] / 256
     subt['subx'] = subt['fsubx'].astype(int)
     subt['suby'] = subt['fsuby'].astype(int)
     
-    ds = size/0.1/256
+    ds = size/PIXEL_SCALE/256
     subt['xmin'] = np.clip(subt['fsubx'] - ds, 0, subt['npix']).astype(int)
     subt['xmax'] = np.clip(subt['fsubx'] + ds, 0, subt['npix']).astype(int)
     subt['ymin'] = np.clip(subt['fsuby'] - ds, 0, subt['npix']).astype(int)
     subt['ymax'] = np.clip(subt['fsuby'] + ds, 0, subt['npix']).astype(int)
     
     subt['ncut'] = (subt['xmax'] - subt['xmin'] + 1)
     subt['ncut'] *= (subt['ymax'] - subt['ymin'] + 1)
@@ -743,16 +745,16 @@
     
     tabs = []
     
     for t in tix:
         
         h, w = utils.make_wcsheader(ra=tiles['crval1'][t], 
                                     dec=tiles['crval2'][t],
-                                    size=tiles['npix'][t]*0.1, 
-                                    pixscale=0.1)
+                                    size=tiles['npix'][t]*PIXEL_SCALE, 
+                                    pixscale=PIXEL_SCALE)
         
         h['CRPIX1'] += 0.5
         h['CRPIX2'] += 0.5
         h['LATPOLE'] = 0.
         
         w = pywcs.WCS(h)
         wfp = w.calc_footprint()
@@ -834,22 +836,23 @@
         
     # row = db.SQL(f"""SELECT crval1, crval2, npix
     #                    FROM mosaic_tiles
     #                   WHERE tile={tile}""")
 
     t = 0
     h, w = utils.make_wcsheader(ra=row['crval1'][t], dec=row['crval2'][t],
-                                size=row['npix'][t]*0.1, pixscale=0.1)
+                                size=row['npix'][t]*PIXEL_SCALE,
+                                pixscale=PIXEL_SCALE)
     
     h['CRPIX1'] += 0.5
     h['CRPIX2'] += 0.5
     h['LATPOLE'] = 0.
     
     wcs = pywcs.WCS(h)
-    wcs.pscale = 0.1
+    wcs.pscale = PIXEL_SCALE
     
     TILE_WCS[tile] = wcs
     
     return wcs
     
     
 def tile_subregion_wcs(tile, subx, suby):
@@ -857,15 +860,15 @@
     Compute WCS for a tile subregion
     """
     
     twcs = tile_wcs(tile)
     
     sub_wcs = twcs.slice((slice(suby*256, (suby+1)*256), 
                           slice(subx*256, (subx+1)*256)))
-    sub_wcs.pscale = 0.1
+    sub_wcs.pscale = PIXEL_SCALE
     return sub_wcs
 
 
 #
 def get_lambda_client(region_name='us-east-1'):
     """
     Get boto3 client in same region as HST public dataset
@@ -1438,15 +1441,15 @@
     from tqdm import tqdm
     import matplotlib.pyplot as plt
     from grizli import utils
     from grizli.aws import tile_mosaic, db
     
     cosd = np.cos(dec/180*np.pi)
     rc = size/3600*np.sqrt(2)
-    rtile = np.sqrt(2)*128*0.1/3600
+    rtile = np.sqrt(2)*128*PIXEL_SCALE/3600
     
     SQL = f"""SELECT tile, subx, suby, subra, subdec, filter
             FROM mosaic_tiles_exposures t, exposure_files e
             WHERE in_mosaic = 1
             AND t.expid = e.eid 
             AND ('((' || (subra - {ra})*{cosd} || 
                     ', ' || subdec - {dec} || '),
@@ -1470,17 +1473,20 @@
         return 'empty filter', None
         
     if make_figure:
         fig, ax = plt.subplots(1,1,figsize=(8,8))
         ax.scatter(res['subra'], res['subdec'], marker='x', alpha=0.)
     
     oh, ow = utils.make_wcsheader(ra=ra, dec=dec, size=size*2, 
-                                  pixscale=0.1, theta=theta)
+                                  pixscale=PIXEL_SCALE,
+                                  theta=theta)
     
     sh = utils.SRegion(ow)
+    shu = sh.union().shapely
+    
     if make_figure:
         ax.add_patch(sh.get_patch(alpha=0.2, color='r')[0])
     
     res['keep'] = False
                            
     iters = zip(res['tile'], res['subx'], res['suby'])
     
@@ -1489,15 +1495,15 @@
     
     un = utils.Unique(keys, verbose=False)        
     for k in un.values:
         unk = un[k]
         rk = res[unk][0]
         tw = tile_subregion_wcs(rk['tile'], rk['subx'], rk['suby'])
         sr = utils.SRegion(tw)
-        isect = sr.intersects(sh.union())
+        isect = sr.shapely[0].intersects(shu)
         res['keep'][unk] = isect
         
         if make_figure:
             if isect:
                 ec = 'b'
                 fc = 'b'
                 alpha=0.2
```

### Comparing `grizli-1.8.3/grizli/aws/visit_processor.py` & `grizli-1.8.4/grizli/aws/visit_processor.py`

 * *Files 1% similar despite different names*

```diff
@@ -1190,15 +1190,15 @@
     
     return fig, atab
     
 
 ALL_FILTERS = ['F410M', 'F467M', 'F547M', 'F550M', 'F621M', 'F689M', 'F763M', 'F845M', 'F200LP', 'F350LP', 'F435W', 'F438W', 'F439W', 'F450W', 'F475W', 'F475X', 'F555W', 'F569W', 'F600LP', 'F606W', 'F622W', 'F625W', 'F675W', 'F702W', 'F775W', 'F791W', 'F814W', 'F850LP', 'G800L', 'F098M', 'F127M', 'F139M', 'F153M', 'F105W', 'F110W', 'F125W', 'F140W', 'F160W', 'G102', 'G141']
 
 
-def process_visit(assoc, clean=True, sync=True, max_dt=4, combine_same_pa=False, visit_split_shift=1.2, blue_align_params=blue_align_params, ref_catalogs=['LS_DR9', 'PS1', 'DES', 'NSC', 'GAIA'], filters=None, prep_args={}, fetch_args={}, get_wcs_guess_from_table=True, master_radec='astrometry_db', align_guess=None, with_db=True, **kwargs):
+def process_visit(assoc, clean=True, sync=True, max_dt=4, combine_same_pa=False, visit_split_shift=1.2, blue_align_params=blue_align_params, ref_catalogs=['LS_DR9', 'PS1', 'DES', 'NSC', 'GAIA'], filters=None, prep_args={}, fetch_args={}, get_wcs_guess_from_table=True, master_radec='astrometry_db', align_guess=None, with_db=True, global_miri_skyflat=None, **kwargs):
     """
     Run the `grizli.pipeline.auto_script.go` pipeline on an association defined
     in the `grizli` database.
     
     Parameters
     ----------
     assoc : str
@@ -1318,14 +1318,17 @@
         kws['visit_prep_args'][k] = prep_args[k]
     
     for k in fetch_args:
         kws['fetch_files_args'][k] = fetch_args[k]
         
     kws['kill'] = 'preprocess'
     
+    if global_miri_skyflat is not None:
+        kws['global_miri_skyflat'] = global_miri_skyflat
+    
     if master_radec is not None:
         kws['preprocess_args']['master_radec'] = master_radec
     
     for fi in ['f560w','f770w','f1000w','f1130w','f1280w',
                'f1500w','f1800w','f2100w','f2550w']:
         
         if fi in assoc:
```

### Comparing `grizli-1.8.3/grizli/catalog.py` & `grizli-1.8.4/grizli/catalog.py`

 * *Files 2% similar despite different names*

```diff
@@ -434,14 +434,51 @@
         if clean_mjd:
             ok = np.isfinite(rd.ra.deg + rd.dec.deg)
             result = result[ok]
             
     return result
 
 
+def gaia_catalog_for_assoc(assoc_name='j191132p1652_hen-2-427-f335m_00007'):
+    """
+    Get GAIA catalog
+    """
+    from grizli.aws import db
+    from grizli import utils
+    
+    res = db.SQL(f"""select t_min, t_max, filter, footprint
+    from assoc_table where assoc_name = '{assoc_name}'
+    """)
+    
+    sr = utils.SRegion(res['footprint'][0])
+    for fp in res['footprint'][1:]:
+        sri = utils.SRegion(fp)
+        sr.xy.extend(sri.xy)
+        
+    un = sr.union()
+    radius =  np.sqrt(un.sky_area()[0]).value
+    
+    gaia = get_gaia_DR2_vizier(*un.centroid[0], radius=radius)
+    
+    rd = get_gaia_radec_at_time(gaia, np.mean(res['t_min']), format='mjd')
+    
+    gaia['ra_orig'] = gaia['ra']
+    gaia['ra_dec'] = gaia['dec']
+    gaia['ra'] = rd.ra.deg
+    gaia['dec'] = rd.dec.deg
+    
+    coo = np.array([gaia['ra'], gaia['dec']])
+    in_footprint = un.path[0].contains_points(coo.T)
+    gaia['in_assoc'] = in_footprint
+    gaia.meta['assocnam'] = assoc_name
+    gaia['valid'] = np.isfinite(gaia['ra'] + gaia['dec'])
+    
+    return gaia
+    
+    
 def gaia_dr2_conesearch_query(ra=165.86, dec=34.829694, radius=3., max=100000):
     """
     Generate a query string for the TAP servers
     TBD
 
     Parameters
     ----------
```

### Comparing `grizli-1.8.3/grizli/combine.py` & `grizli-1.8.4/grizli/combine.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/auto_script_defaults.yml` & `grizli-1.8.4/grizli/data/auto_script_defaults.yml`

 * *Files 2% similar despite different names*

```diff
@@ -3,14 +3,18 @@
 HOME_PATH: '$PWD'
 RAW_PATH: null
 PREP_PATH: null
 PERSIST_PATH: null
 EXTRACT_PATH: null
 CRDS_CONTEXT: null
 
+min_gaia_count: 128
+gaia_mag_limits: [16,20.5,0.05]
+global_miri_skyflat: False
+
 filters: &filters 
     [F410M, F467M, F547M, F550M, F621M, F689M, F763M, F845M, F200LP, F350LP,
      F435W, F438W, F439W, F450W, F475W, F475X, F555W, F569W, F600LP, F606W,
      F622W, F625W, F675W, F702W, F775W, F791W, F814W, F850LP, G800L, F098M,
      F127M, F139M, F153M, F105W, F110W, F125W, F140W, F160W, G102, G141, F090W, 
      F115W, F140M, F150W, F158M, F200W, F277W, F356W, F3880M, F430M, F444W, 
      F480M, GR150C, GR150R, F150W2, F322W2, F070W, F162M, F182M, F210M, F250M, 
@@ -26,14 +30,15 @@
     min_bad_expflag: 2 
     s3_sync: True
     #filters: *filters
     fetch_flt_calibs: [IDCTAB, PFLTFILE, NPOLFILE]
     s3path: null
     force_rate: True
     get_rateints: False
+    recalibrate_jwst: False
     inst_products: 
         ACS/WFC: [FLC]
         WFC3/IR: [RAW]
         WFC3/UVIS: [FLC]
         WFPC2/PC: [C0M, C1M]
         WFPC2/WFC: [C0M, C1M]
 
@@ -111,15 +116,15 @@
         bh: 256
         bw: 256
         fh: 3
         fw: 3
         pixel_scale: 0.10
         get_median: False
     run_separate_chip_sky: True
-    fix_stars: True
+    fix_stars: False
     reference_catalogs: [LS_DR9, PS1, DES, DSC, SDSS, GAIA, WISE]
     outlier_threshold: 4
     nircam_wisp_kwargs:
         niter: 3
         update: True
     oneoverf_kwargs: 
         thresholds: [5,4,3]
@@ -269,15 +274,15 @@
     split_by_grism: True
     prelim_mag_limit: 25
     refine_niter: 3
     refine_poly_order: 3
     refine_fcontam: 0.5
     refine_mag_limits: [18, 24]
     ds9: null
-    mask_mosaic_edges: True
+    mask_mosaic_edges: False
 
 refine_with_fits: False
 run_extractions: False 
 include_photometry_in_fit: False
 
 # RGB thumbnails based on spectral extractions
 make_thumbnails: False
```

### Comparing `grizli-1.8.3/grizli/data/gaia_dr2_vizier_columns.txt` & `grizli-1.8.4/grizli/data/gaia_dr2_vizier_columns.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/hst_encircled_energy.fits` & `grizli-1.8.4/grizli/data/hst_encircled_energy.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/jwst_bp_info.yml` & `grizli-1.8.4/grizli/data/jwst_bp_info.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nircam_wisp.yml` & `grizli-1.8.4/grizli/data/nircam_wisp.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz` & `grizli-1.8.4/grizli/data/nrc_badpix_230120_NRCALONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz` & `grizli-1.8.4/grizli/data/nrc_badpix_230120_NRCBLONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA1.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA2.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA3.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCA4.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCALONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB1.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB2.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB3.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCB4.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz` & `grizli-1.8.4/grizli/data/nrc_lowpix_0916_NRCBLONG.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/photom_correction.yml` & `grizli-1.8.4/grizli/data/photom_correction.yml`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/sep_catalog_junk.pkl` & `grizli-1.8.4/grizli/data/sep_catalog_junk.pkl`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/FeII_VeronCetty2004.txt` & `grizli-1.8.4/grizli/data/templates/FeII_VeronCetty2004.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/README` & `grizli-1.8.4/grizli/data/templates/README`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/alf_SSP.dat` & `grizli-1.8.4/grizli/data/templates/alf_SSP.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/cvd12_t11_solar_Chabrier.dat` & `grizli-1.8.4/grizli/data/templates/cvd12_t11_solar_Chabrier.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/eazy_intermediate.dat` & `grizli-1.8.4/grizli/data/templates/eazy_intermediate.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/erb2010.dat` & `grizli-1.8.4/grizli/data/templates/erb2010.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/erb2010_continuum.dat` & `grizli-1.8.4/grizli/data/templates/erb2010_continuum.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3.param` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3.param`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3.param.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_001.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_002.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_003.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_004.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_005.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_006.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_007.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_008.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_009.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_010.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_011.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_012.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines.param`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_001.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_002.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_003.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_004.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_005.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_006.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_007.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_008.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_009.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_010.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_011.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat` & `grizli-1.8.4/grizli/data/templates/fsps/fsps_QSF_12_v3_nolines_012.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/fsps_starburst_lines.txt` & `grizli-1.8.4/grizli/data/templates/fsps_starburst_lines.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/post_starburst.dat` & `grizli-1.8.4/grizli/data/templates/post_starburst.dat`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/quasar_lines.txt` & `grizli-1.8.4/grizli/data/templates/quasar_lines.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/red_blue_continuum.txt` & `grizli-1.8.4/grizli/data/templates/red_blue_continuum.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/red_blue_continuum_noLya.txt` & `grizli-1.8.4/grizli/data/templates/red_blue_continuum_noLya.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/L1.0.txt` & `grizli-1.8.4/grizli/data/templates/stars/L1.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/L3.5.txt` & `grizli-1.8.4/grizli/data/templates/stars/L3.5.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/L6.0.txt` & `grizli-1.8.4/grizli/data/templates/stars/L6.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/M6.5.txt` & `grizli-1.8.4/grizli/data/templates/stars/M6.5.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/M8.0.txt` & `grizli-1.8.4/grizli/data/templates/stars/M8.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/T2.0.txt` & `grizli-1.8.4/grizli/data/templates/stars/T2.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/T6.0.txt` & `grizli-1.8.4/grizli/data/templates/stars/T6.0.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/T7.5.txt` & `grizli-1.8.4/grizli/data/templates/stars/T7.5.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits` & `grizli-1.8.4/grizli/data/templates/stars/bt-settl_t400-3500_z0.0.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/templates/stars/carbon_star.txt` & `grizli-1.8.4/grizli/data/templates/stars/carbon_star.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/visit_alignment.txt` & `grizli-1.8.4/grizli/data/visit_alignment.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz` & `grizli-1.8.4/grizli/data/wfc3ir_badpix_spars200_22.03.31.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz` & `grizli-1.8.4/grizli/data/wfc3ir_dark_badpix_2019.01.12.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/data/wfc3ir_ee.txt` & `grizli-1.8.4/grizli/data/wfc3ir_ee.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/ds9.py` & `grizli-1.8.4/grizli/ds9.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/fake_image.py` & `grizli-1.8.4/grizli/fake_image.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/fitting.py` & `grizli-1.8.4/grizli/fitting.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/galfit/deconvolve.py` & `grizli-1.8.4/grizli/galfit/deconvolve.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/galfit/galfit.py` & `grizli-1.8.4/grizli/galfit/galfit.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/galfit/gfutils.py` & `grizli-1.8.4/grizli/galfit/gfutils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/galfit/psf.py` & `grizli-1.8.4/grizli/galfit/psf.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/grismconf.py` & `grizli-1.8.4/grizli/grismconf.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/jwst_level1.py` & `grizli-1.8.4/grizli/jwst_level1.py`

 * *Files 16% similar despite different names*

```diff
@@ -17,14 +17,16 @@
     HAS_SEP = True
 except ImportError:
     HAS_SEP = False
     
 import mastquery.utils
 from grizli import utils
 
+DET1PIPE = None
+
 DQ_ANY = 1
 DQ_NAN = 8
 DQ_NJUMP = 16
 DQ_HOT = 32
 DQ_RESID = 64
 DQ_ERR = 128
 DQ_FIRST_SATURATED = 256
@@ -52,14 +54,66 @@
         HOT_THRESHOLDS[f'NRC{m}{d}'] = [40000,40000]
 
 for d in [1,2,3,4]:
     for m in 'AB':
         HOT_THRESHOLDS[f'NRC{m}{d}'] = [1000,20000]
 
 
+def get_pipeline_object():
+    """
+    Initialize `jwst.pipeline.Detector1Pipeline`
+    """
+    from jwst.pipeline import Detector1Pipeline
+
+    global DET1PIPE
+    
+    if DET1PIPE is None:
+        DET1PIPE = Detector1Pipeline()
+    
+    return DET1PIPE
+
+
+def download_files(file):
+    """
+    Download uncal and rate files
+    """
+
+    if not os.path.exists(file):
+        _ = mastquery.utils.download_from_mast([file])
+    if not os.path.exists(file.replace('_uncal','_rate')):
+        _ = mastquery.utils.download_from_mast([file.replace('_uncal','_rate')])
+    
+
+def process_level1_to_dark(file, CRDS_CONTEXT='jwst_1069.pmap'):
+    """
+    Run `jwst.pipeline.Detector1Pipeline` up through `dark_current`
+    
+    https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_detector1.html
+    
+    """
+    
+    pipe = get_pipeline_object()
+    
+    download_files(file)
+    
+    if CRDS_CONTEXT:
+        os.environ["CRDS_CONTEXT"] = CRDS_CONTEXT
+        
+    grp = pipe.group_scale.process(file)
+    dqi = pipe.dq_init.process(grp)
+    sat = pipe.saturation.process(dqi)
+    bias = pipe.superbias.process(sat)
+    refpix = pipe.refpix.process(bias)
+    lin = pipe.linearity.process(refpix)
+    pers = pipe.persistence.process(lin)
+    dark = pipe.dark_current.process(pers)
+    
+    return dark
+
+
 def process_uncal_level1(file='jw01208048001_03101_00001_nrs1_uncal.fits', output_extension='_xrate', CRDS_CONTEXT='jwst_1069.pmap', jump_threshold=4, jump_ndilate=1, erode_snowballs=5, grow_snowballs=5, resid_thresh=4, hot_thresh='auto', hot_type='diff', max_njump=6, groups_for_rnoise=np.inf, flag_for_persistence=True, outlier_min_nints=3, integration_sigmas=[5,4,3], rescale_uncertainty=True, rescale_with_background=True, bkg_kwargs=BKG_KWARGS, dark=None, verbose=True, debug=None, **kwargs):
     """
     Custom ramp-fit scripts for JWST uncal images.
 
     All calculations are done with `numpy` arrays to be somewhat faster than 
     computing least-squares fits to individual pixel ramps.  One shortcut here
     is that only ramp sequences with two or fewer identified jumps are 
@@ -154,42 +208,34 @@
         grow_snowballs = kwargs['grow_snowball']
         
     utils.LOGFILE = file.split('.fits')[0] + '.log'
     utils.log_function_arguments(utils.LOGFILE, frame, 'process_uncal',
                                  ignore=['dark','debug','_LOGFILE'],
                                  )
     
-    from jwst.pipeline import Detector1Pipeline
-    
-    if CRDS_CONTEXT:
-        os.environ["CRDS_CONTEXT"] = CRDS_CONTEXT
-        
-    if not os.path.exists(file):
-        _ = mastquery.utils.download_from_mast([file])
-    if not os.path.exists(file.replace('_uncal','_rate')):
-        _ = mastquery.utils.download_from_mast([file.replace('_uncal','_rate')])
-
-    pipe = Detector1Pipeline()
+    pipe = get_pipeline_object()
     
     if debug is not None:
         if debug['file'] == file:
             print('debug: use dark from debug data')
             dark = debug['dark']
             
     if dark is None:
         # Detector1 through dark_current
         # https://jwst-pipeline.readthedocs.io/en/latest/jwst/pipeline/calwebb_detector1.html
-        grp = pipe.group_scale.process(file)
-        dqi = pipe.dq_init.process(grp)
-        sat = pipe.saturation.process(dqi)
-        bias = pipe.superbias.process(sat)
-        refpix = pipe.refpix.process(bias)
-        lin = pipe.linearity.process(refpix)
-        pers = pipe.persistence.process(lin)
-        dark = pipe.dark_current.process(pers)
+        # grp = pipe.group_scale.process(file)
+        # dqi = pipe.dq_init.process(grp)
+        # sat = pipe.saturation.process(dqi)
+        # bias = pipe.superbias.process(sat)
+        # refpix = pipe.refpix.process(bias)
+        # lin = pipe.linearity.process(refpix)
+        # pers = pipe.persistence.process(lin)
+        # dark = pipe.dark_current.process(pers)
+        
+        dark = process_level1_to_dark(file)
     
     NINTS, NGROUPS, NYPIX, NXPIX = dark.data.shape
     
     ## readnoise, gain reference files
     readnoise_filename = pipe.get_reference_file(dark, 'readnoise')
     gain_filename = pipe.get_reference_file(dark, 'gain')
     # mask_filename = pipe.get_reference_file(dark, 'mask')
@@ -280,14 +326,15 @@
     sci_list = []
     err_list = []
     dq_list = []
     slope_list = []
     slope_err_list = []
     nsamp_list = []
     rn_list = []
+    jump_list = []
     
     for integ in range(NINTS):
         msg = f'\nprocess_uncal: {file} run for int {integ+1} / {NINTS}'
         utils.log_comment(utils.LOGFILE, msg, show_date=False, verbose=verbose)
         
         ## Array copies
         dd = dark.data[integ,:,:,:] #/gain_2d
@@ -353,27 +400,31 @@
                                          index=np.unique(label)[1:])
             area = nd.sum(label > 0, labels=label, index=np.unique(label)[1:])
 
             R_label = np.sqrt(area/np.pi)
             yp, xp = np.indices((NYPIX, NXPIX))
 
             lmask = np.zeros_like(js)
+            smask = np.zeros_like(js)
 
             for (yyi, xxi), ri in zip(xy_label, R_label):
                 R = np.sqrt((xp-xxi)**2 + (yp-yyi)**2)
                 lmask |= R < grow_snowballs*np.maximum(ri, 2)
+                smask |= R < grow_snowballs/2*np.maximum(ri, 2)
     
             jump[ij,:,:] |= lmask
             
             ## Mask for saturated pixels
-            blob_sat = (groupdq[integ,ij,:,:] > 0)
-            blob_sat = nd.binary_erosion(blob_sat, iterations=2)
-            blob_sat = nd.binary_dilation(blob_sat, iterations=4)*4
+            blob_sat = (groupdq[integ,ij,:,:] > 0) | smask
+            # blob_sat = nd.binary_erosion(blob_sat, iterations=1)
+            blob_sat = nd.binary_dilation(blob_sat, iterations=2)*2
+            #blob_sat = smask*2
             
             jump_saturated |= blob_sat.astype(jump_saturated.dtype)
+            
             msg = f'process_uncal: {integ+1} snowball read {ij+1:>2} '
             msg += f' n={num_labels:>2}  '
             msg += f'nsat={int(jump_saturated.sum())//4:>6}'
             utils.log_comment(utils.LOGFILE, msg, show_date=False, 
                               verbose=verbose)
 
             if flag_for_persistence:
@@ -561,15 +612,20 @@
         slope_err_list.append(slope_err)
         
         sci_list.append(sci)
         err_list.append(err)
         dq_list.append(dq)
         nsamp_list.append(nsamp)
         rn_list.append(rn_i)
-    
+        jump_list.append(jump)
+        
+        # Set DQ=4 jump flag in groupdq
+        for ij in range(NGROUPS-1):
+            groupdq[integ,ij+1,:,:] |= (jump[ij,:,:]*4).astype(groupdq.dtype)
+            
     ## Combine iterations
     for iter in range(3):
         #print(f'iter combine {iter}')
         sci = np.array(sci_list)
         err = np.array(err_list)
         dqi = np.array(dq_list)
         ivar = 1/err**2
@@ -701,15 +757,18 @@
         
         im.writeto(file.replace('_uncal', output_extension), overwrite=True)
         
         
     debug = {'file':file,
              'sci':sci, 'err':err, 'dq':dq,
              'nsamp':nsamp, 'rn':rn_meas,
-             'times':times, 'dark':dark, 'jump':jump,
+             'times':times, 'dark':dark,
+             'jump':jump,
+             'jump_list':jump_list,
+             'groupdq':groupdq,
              'njump':njump, 'resid':resid,
              'smodel':smodel, 'slope':slope, 'ahat':ahat,
              'slope_err':slope_err,
              'raw_err':raw_err,
              'hot_plus':hot_plus,
              'slope_list':slope_list,
              'slope_err_list':slope_err_list,
@@ -723,8 +782,187 @@
         }
     
     # Reset LOGFILE
     utils.LOGFILE = _LOGFILE
     warnings.filterwarnings('default', category=RuntimeWarning)
     
     return debug
-    
+
+
+def grow_snowball_jumps(dark, jump, erode_snowballs=3, grow_snowballs=5, verbose=True, **kwargs):
+    """
+    Grow masks around large groups of pixels identified in the jump step that
+    are likely "snowballs"
+    
+    Parameters
+    ----------
+    dark : 
+    
+    jump : 
+    
+    erode_snowballs : int
+        Number of `scipy.ndimage.binary_erosion` iterations run on the jump
+        mask of each read before identifying snowballs.  This removes small
+        clumps of pixels that probably aren't big snowballs
+    
+    grow_snowballs : float
+        Once snowballs are identified as big clumps of jump pixels, compute
+        the pixel area of each smowball clump and make a circular mask with
+        radius ``grow_snowballs * np.sqrt(area/pi)``
+    
+    Returns
+    -------
+    group_dq :array-like
+        DQ mask array with dimensions ``NINT, NGROUP, NY, NX`` with the ``4``
+        bit set for identified jumps
+    
+    """
+    nint, ngroup, NYPIX, NXPIX = jump.groupdq.shape
+    
+    groupdq = (jump.groupdq*1).astype(jump.groupdq.dtype)
+    
+    jump_saturated = np.zeros((NYPIX, NXPIX), dtype=bool)
+    
+    for ii in range(nint):
+        for ig in range(1,ngroup):
+            ji = groupdq[ii,ig,:,:] & 4 > 0
+            sat = dark.groupdq[ii,ig:,:,:].max(axis=0) > 0
+            ji |= sat
+            
+            js = nd.binary_erosion(ji, iterations=erode_snowballs)
+            
+            jump_saturated |= js # | sat
+            
+            groupdq[ii,ig,:,:] |= (jump_saturated*2).astype(groupdq.dtype)
+            
+            label, num_labels = nd.label(js)
+            if num_labels > 0:
+                
+                msg = f'process_uncal: {ii+1} snowball read {ig:>2} '
+                msg += f' n={num_labels:>2}  '
+                msg += f'nsat={int(jump_saturated.sum())//4:>6}'
+                utils.log_comment(utils.LOGFILE, msg, show_date=False, 
+                                  verbose=verbose)
+                
+                xy_label = nd.center_of_mass(label, labels=label, 
+                                             index=np.unique(label)[1:])
+                area = nd.sum(label > 0, labels=label, 
+                              index=np.unique(label)[1:])
+
+                R_label = np.sqrt(area/np.pi)
+                yp, xp = np.indices((NYPIX, NXPIX))
+
+                blob = np.zeros_like(js)
+                #smask = np.zeros_like(js)
+
+                for (yyi, xxi), ri in zip(xy_label, R_label):
+                    R = np.sqrt((xp-xxi)**2 + (yp-yyi)**2)
+                    blob |= R < grow_snowballs*np.maximum(ri, 2)
+                    #smask |= R < grow_snowballs/2*np.maximum(ri, 2)
+                
+                groupdq[ii,ig,:,:] |= (blob*4).astype(groupdq.dtype)
+    
+    return groupdq
+
+
+def pipeline_level1(file, output_extension='_rate', maximum_cores='half', use_pipe_jumps=True, unset_jump_dq=True, force_uncal=True, debug=None, **kwargs):
+    """
+    Use the pipeline for the ramp fits with manual jump detections
+    
+    Parameters
+    ----------
+    file : str
+        JWST raw "uncal" filename
+    
+    output_extension : str
+        The script puts the derived ramp and uncertainty into a ``rate``-like 
+        file with filename ``file.replace('_uncal', output_extension)``.
+    
+    maximum_cores : 'none', 'quarter', 'half', 'all'
+        Number of processes for `jwst` jump and ramp pipeline steps
+    
+    unset_jump_dq : bool
+        Unset the ``DQ=4`` pixels from the final product
+    
+    force_uncal : bool
+        Require that ``file`` endswith "_uncal.fits"
+    
+    debug : dict, bool
+        Previous output
+    
+    kwargs : dict
+        Keyword arguments passed to `grizli.jwst_level1.process_uncal_level1`
+    
+    Returns
+    -------
+    debug : dict
+        Full output from `grizli.jwst_level1.process_uncal_level1`
+    
+    gain : `jwst.datamodels.ImageModel`
+        Result of the final `gain_scale` level 1 step
+    
+    """    
+    #from jwst.pipeline import Detector1Pipeline
+    frame = inspect.currentframe()
+    _LOGFILE = utils.LOGFILE
+    warnings.filterwarnings('ignore', category=RuntimeWarning)
+
+    utils.LOGFILE = file.split('.fits')[0] + '.log'
+    utils.log_function_arguments(utils.LOGFILE, frame, 'process_uncal',
+                                 ignore=['debug','_LOGFILE'],
+                                 )
+    
+    if (not file.endswith('_uncal.fits')) & (force_uncal):
+        utils.LOGFILE = _LOGFILE
+        warnings.filterwarnings('default', category=RuntimeWarning)
+        
+        raise ValueError(f'{file} does not have _uncal extension')
+        
+        
+    #pipe = Detector1Pipeline()
+    pipe = get_pipeline_object()
+    
+    dark = process_level1_to_dark(file)
+    pipe.jump.maximum_cores = maximum_cores
+    jump = pipe.jump.process(dark)
+    
+    jumpdq = grow_snowball_jumps(dark, jump, **kwargs)
+    jump.groupdq |= jumpdq
+    
+    # Unset some DQ flags    
+    orig_dq = jump.pixeldq*1
+    
+    dq = np.zeros_like(jump.pixeldq)
+    for i in range(1,20):
+        #for i in PIXELDQ_BITS[dark.meta.instrument.detector]:
+        if i in [15,]:
+            continue
+            
+        dqi = 2**i & jump.pixeldq
+        dq |= dqi
+        
+    jump.pixeldq = dq
+    
+    # Run Ramp_fit
+    pipe.ramp_fit.maximum_cores = maximum_cores
+    myramp = pipe.ramp_fit.process(jump)
+    
+    # Run Gain
+    gain = pipe.gain_scale.process(myramp[0])
+    
+    bad = ~np.isfinite(gain.data + gain.err)
+    bad |= dq > 0
+    #bad |= (gain.dq & 1) == 1
+    gain.dq[bad] |= 1
+    gain.data[bad] = 0.
+    gain.err[bad] = 0
+    
+    if unset_jump_dq:
+        gain.dq -= (gain.dq & 4)
+        
+    gain.write(file.replace('_uncal', output_extension),
+               overwrite=True)
+    
+    utils.LOGFILE = _LOGFILE
+    warnings.filterwarnings('default', category=RuntimeWarning)
+    
+    return debug, gain
```

### Comparing `grizli-1.8.3/grizli/jwst_utils.py` & `grizli-1.8.4/grizli/jwst_utils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/model.py` & `grizli-1.8.4/grizli/model.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/multifit.py` & `grizli-1.8.4/grizli/multifit.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/nbutils.py` & `grizli-1.8.4/grizli/nbutils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/pipeline/__init__.py` & `grizli-1.8.4/grizli/pipeline/__init__.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/pipeline/auto_script.py` & `grizli-1.8.4/grizli/pipeline/auto_script.py`

 * *Files 1% similar despite different names*

```diff
@@ -12,14 +12,16 @@
 import yaml
 
 import numpy as np
 import astropy.io.fits as pyfits
 import astropy.wcs as pywcs
 
 from .. import prep, utils
+from .. import catalog as grizli_catalog
+
 from .default_params import UV_N_FILTERS, UV_M_FILTERS, UV_W_FILTERS
 from .default_params import OPT_N_FILTERS, OPT_M_FILTERS, OPT_W_FILTERS
 from .default_params import IR_N_FILTERS, IR_M_FILTERS, IR_W_FILTERS
 from .default_params import ALL_IMAGING_FILTERS, VALID_FILTERS
 from .default_params import UV_GRISMS, OPT_GRISMS, IR_GRISMS, GRIS_REF_FILTERS
 
 from .default_params import get_yml_parameters, write_params_to_yml
@@ -251,21 +253,24 @@
 
 def go(root='j010311+131615', 
        HOME_PATH='$PWD',
        RAW_PATH=None, PREP_PATH=None, PERSIST_PATH=None, EXTRACT_PATH=None,
        CRDS_CONTEXT=None,
        filters=args['filters'],
        fetch_files_args=args['fetch_files_args'],
+       global_miri_skyflat=False,
        inspect_ramps=False,
        is_dash=False, run_prepare_dash=True,
        run_parse_visits=True,
        is_parallel_field=False,
        parse_visits_args=args['parse_visits_args'],
        manual_alignment=False,
        manual_alignment_args=args['manual_alignment_args'],
+       min_gaia_count=128,
+       gaia_mag_limits=[16,20.5,0.05],
        preprocess_args=args['preprocess_args'],
        visit_prep_args=args['visit_prep_args'],
        persistence_args=args['persistence_args'],
        redo_persistence_mask=False,
        run_fine_alignment=True,
        fine_backup=True,
        fine_alignment_args=args['fine_alignment_args'],
@@ -380,26 +385,79 @@
     
     if CRDS_CONTEXT is not None:
         utils.log_comment(utils.LOGFILE,
                           f"# export CRDS_CONTEXT='{CRDS_CONTEXT}'",
                           show_date=True)
                           
         os.environ['CRDS_CONTEXT'] = CRDS_CONTEXT
+    
+    # Working directory
+    os.chdir(PATHS['home'])
+    
+    ######################
+    # Preliminary gaia catalog
+    # Get gaia catalog
+    try:
+        gaia = grizli_catalog.gaia_catalog_for_assoc(assoc_name=root)
+        msg = f"{root} : found {gaia['valid'].sum()} GAIA sources"
+        utils.log_comment(utils.LOGFILE, msg, show_date=False,
+                          verbose=True)
+        gaia.write(f'{root}.gaia.fits', overwrite=True)
+        prep.table_to_radec(gaia[gaia['valid']], f'{root}.gaia.radec')
+        prep.table_to_regions(gaia[gaia['valid']], f'{root}.gaia.reg')
+        
+        if gaia['valid'].sum() > min_gaia_count:
+            preprocess_args['master_radec'] = os.path.join(PATHS['home'],
+                                                  f'{root}.gaia.radec')
+            
+            preprocess_args['align_mag_limits'] = gaia_mag_limits
+            
+            msg = f"{root} : Use {root}.gaia.radec as master_radec"
+            msg += f"\n{root} : Set align_mag_limits={gaia_mag_limits}"
+            utils.log_comment(utils.LOGFILE, msg, show_date=False,
+                              verbose=True)
         
+    except:
+        utils.log_exception(utils.LOGFILE, traceback)
+        pass
+    
     ######################
     # Download data
-    os.chdir(PATHS['home'])
     if fetch_files_args is not None:
         fetch_files_args['reprocess_clean_darks'] &= (not is_dash)
         auto_script.fetch_files(field_root=root, HOME_PATH=HOME_PATH,
                                 paths=PATHS, 
                                 filters=filters, **fetch_files_args)
     else:
         os.chdir(PATHS['prep'])
+    
+    if global_miri_skyflat:
+        os.chdir(PATHS['raw'])
+        files = glob.glob('*mirimage*rate.fits')
 
+        if len(files) > 0:
+            files.sort()
+            
+            msg = f"{root} : global_miri_skyflat N={len(files)}"
+            utils.log_comment(utils.LOGFILE, msg, show_date=False,
+                              verbose=True)
+            
+            os.chdir(PATHS['prep'])
+            for file in files:
+                prep.fresh_flt_file(file, use_skyflats=False)
+            
+            prep.make_visit_average_flat({'product':root,
+                                          'files':files},
+                                          dilate=1, apply=False)
+            
+            visit_prep_args['miri_skyflat'] = False
+            visit_prep_args['use_skyflats'] = False
+            visit_prep_args['miri_skyfile'] = os.path.join(PATHS['prep'],
+                                                      f'{root}_skyflat.fits')
+            
     if is_dash & run_prepare_dash:
         from wfc3dash import process_raw
         os.chdir(PATHS['raw'])
         process_raw.run_all()
 
     files = glob.glob(os.path.join(PATHS['raw'], '*_fl*fits'))
     files += glob.glob(os.path.join(PATHS['raw'], '*_c[01]m.fits'))
@@ -886,15 +944,15 @@
             os.system(f'chmod ugoa+rwx {dir}')
         else:
             print(f'directory {dir} exists')
             
     return paths
 
 
-def fetch_files(field_root='j142724+334246', HOME_PATH='$PWD', paths={}, inst_products={'WFPC2/WFC': ['C0M', 'C1M'], 'WFPC2/PC': ['C0M', 'C1M'], 'ACS/WFC': ['FLC'], 'WFC3/IR': ['RAW'], 'WFC3/UVIS': ['FLC']}, remove_bad=True, reprocess_parallel=False, reprocess_clean_darks=True, s3_sync=False, fetch_flt_calibs=['IDCTAB', 'PFLTFILE', 'NPOLFILE'], filters=VALID_FILTERS, min_bad_expflag=2, fetch_only=False, force_rate=True, get_rateints=False, s3path=None):
+def fetch_files(field_root='j142724+334246', HOME_PATH='$PWD', paths={}, inst_products={'WFPC2/WFC': ['C0M', 'C1M'], 'WFPC2/PC': ['C0M', 'C1M'], 'ACS/WFC': ['FLC'], 'WFC3/IR': ['RAW'], 'WFC3/UVIS': ['FLC']}, remove_bad=True, reprocess_parallel=False, reprocess_clean_darks=True, s3_sync=False, fetch_flt_calibs=['IDCTAB', 'PFLTFILE', 'NPOLFILE'], filters=VALID_FILTERS, min_bad_expflag=2, fetch_only=False, force_rate=True, get_rateints=False, recalibrate_jwst=False, s3path=None):
     """
     Fully automatic script
     """
     import os
     import glob
 
     try:
@@ -902,15 +960,15 @@
         frame = inspect.currentframe()
         utils.log_function_arguments(utils.LOGFILE, frame,
                                      'auto_script.fetch_files')
     except:
         from grizli import utils
     
     try:
-        from .. import jwst_utils
+        from .. import jwst_utils, jwst_level1
     except ImportError:
         jwst_utils = None
         
     try:
         try:
             from mastquery import query, fetch
             import mastquery.utils
@@ -1034,22 +1092,42 @@
                     os.system(f'aws s3 cp s3://grizli-v2/JwstDummy/{_file} .')
                 
                 if os.path.exists(_file) & _file.startswith('jw'):
                     jw_files.append(_file)
                 
         else:
             ## Download from MAST API when data available
-            mastquery.utils.LOGFILE = utils.LOGFILE   
-            _resp = mastquery.utils.download_from_mast(tab[jw],
-                                          force_rate=force_rate,
-                                          rate_ints=get_rateints)
-            
-            for i, _file in enumerate(_resp):
-                if os.path.exists(_file) & _file.startswith('jw'):
-                    jw_files.append(_file)
+            if recalibrate_jwst:
+                
+                for file in tab[jw]['dataURL']:
+                    if os.path.exists(os.path.basename(file)):
+                        jw_files.append(os.path.basename(file))
+                        continue
+                        
+                    uncal = file.replace('_rate','_uncal')
+                    uncal = uncal.replace('_cal.fits','_uncal.fits')
+                    uncal = os.path.basename(uncal)
+                    
+                    _ = jwst_level1.pipeline_level1(uncal,
+                                                    output_extension='_rate')
+                    
+                    if os.path.exists(uncal):
+                        os.remove(uncal)
+                        
+                    jw_files.append(uncal.replace('_uncal.fits','_rate.fits'))
+                    
+            else:
+                mastquery.utils.LOGFILE = utils.LOGFILE
+                _resp = mastquery.utils.download_from_mast(tab[jw],
+                                              force_rate=force_rate,
+                                              rate_ints=get_rateints)
+            
+                for i, _file in enumerate(_resp):
+                    if os.path.exists(_file) & _file.startswith('jw'):
+                        jw_files.append(_file)
 
         tab = tab[~jw]
     
     # Initialize grism files
     for _file in jw_files:
         _test = os.path.exists(_file) & (jwst_utils is not None)
         _jwst_grism = ('_nis_rate' in _file)
@@ -2986,15 +3064,15 @@
             for i in range(1, len(grp_objects)):
                 grp.extend(grp_objects[i])
                 del(grp_objects[i])
 
         return [grp]
 
 
-def grism_prep(field_root='j142724+334246', PREP_PATH='../Prep', EXTRACT_PATH='../Extractions', ds9=None, refine_niter=3, gris_ref_filters=GRIS_REF_FILTERS, force_ref=None, files=None, split_by_grism=True, refine_poly_order=1, refine_fcontam=0.5, cpu_count=0, mask_mosaic_edges=True, prelim_mag_limit=25, refine_mag_limits=[18, 24], init_coeffs=[1.1, -0.5], grisms_to_process=None, pad=(64, 256), model_kwargs={'compute_size': True}, sep_background_kwargs=None, subtract_median_filter=False, median_filter_size=71, median_filter_central=10, second_pass_filtering=False, box_filter_sn=3, box_filter_width=3):
+def grism_prep(field_root='j142724+334246', PREP_PATH='../Prep', EXTRACT_PATH='../Extractions', ds9=None, refine_niter=3, gris_ref_filters=GRIS_REF_FILTERS, force_ref=None, files=None, split_by_grism=True, refine_poly_order=1, refine_fcontam=0.5, cpu_count=0, mask_mosaic_edges=False, prelim_mag_limit=25, refine_mag_limits=[18, 24], init_coeffs=[1.1, -0.5], grisms_to_process=None, pad=(64, 256), model_kwargs={'compute_size': True}, sep_background_kwargs=None, subtract_median_filter=False, median_filter_size=71, median_filter_central=10, second_pass_filtering=False, box_filter_sn=3, box_filter_width=3):
     """
     Contamination model for grism exposures
     """
     import glob
     import os
     import numpy as np
     import scipy.stats
@@ -3067,15 +3145,14 @@
                     msg += f'Couldn\'t find file {fp_file}'
                     msg += 'for mask_mosaic_edges'
                     utils.log_comment(utils.LOGFILE, msg, verbose=True)
             except:
                 utils.log_exception(utils.LOGFILE, traceback)
                 pass
         
-        
         # Sep background
         if sep_background_kwargs is not None:
             grp.subtract_sep_background(**sep_background_kwargs)
             
         elif not subtract_median_filter:
             ################
             # Remove constant modal background
@@ -4967,15 +5044,15 @@
 IMSAVE_QUALITY = 95
 
 # Good options for asinh norm_kwargs 
 ASINH_NORM =  {'stretch': 'asinh',
                'min_cut': -0.02, 'max_cut': 1.0, 
                'clip':True, 'asinh_a':0.03}
 
-def field_rgb(root='j010514+021532', xsize=8, output_dpi=None, HOME_PATH='./', show_ir=True, pl=1, pf=1, scl=1, scale_ab=None, rgb_scl=[1, 1, 1], ds9=None, force_ir=False, filters=None, add_labels=True, output_format='jpg', rgb_min=-0.01, xyslice=None, pure_sort=False, verbose=True, force_rgb=None, suffix='.field', mask_empty=False, tick_interval=60, timestamp=False, mw_ebv=0, use_background=False, tickparams=TICKPARAMS, fill_black=False, ref_spectrum=None, gzext='', full_dimensions=False, use_imsave=True, invert=False, get_rgb_array=False, get_images=False, norm_kwargs=None):
+def field_rgb(root='j010514+021532', xsize=8, output_dpi=None, HOME_PATH='./', show_ir=True, pl=1, pf=1, scl=1, scale_ab=None, rgb_scl=[1, 1, 1], ds9=None, force_ir=False, filters=None, add_labels=True, output_format='jpg', rgb_min=-0.01, xyslice=None, pure_sort=False, verbose=True, force_rgb=None, suffix='.field', mask_empty=False, tick_interval=60, timestamp=False, mw_ebv=0, use_background=False, tickparams=TICKPARAMS, fill_black=False, ref_spectrum=None, gzext='', full_dimensions=False, use_imsave=False, invert=False, get_rgb_array=False, get_images=False, norm_kwargs=None):
     """
     RGB image of the field mosaics
     
     Parameters
     ----------
     
     root : str
@@ -5347,19 +5424,21 @@
         plt.ioff()
         dpi = int(nx/xsize)
         xsize = nx/dpi
     
     elif (output_dpi is not None):
         xsize = nx/output_dpi
         dpi = output_dpi
-    
+    else:
+        dpi = output_dpi
+        
     dim = [xsize, xsize/nx*ny]
     
     if not use_imsave:
-        fig, ax = plt.subplots(1,1,figsize=dim, dpi=dpi)
+        fig, ax = plt.subplots(1,1, figsize=dim, dpi=dpi)
 
         ax.imshow(image, origin='lower', extent=(-nx/2, nx/2, -ny/2, ny/2))
 
         ax.set_xticklabels([])
         ax.set_yticklabels([])
 
         ax.xaxis.set_major_locator(minor)
```

### Comparing `grizli-1.8.3/grizli/pipeline/default_params.py` & `grizli-1.8.4/grizli/pipeline/default_params.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/pipeline/photoz.py` & `grizli-1.8.4/grizli/pipeline/photoz.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/pipeline/reprocess.py` & `grizli-1.8.4/grizli/pipeline/reprocess.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/pipeline/run_MPI.py` & `grizli-1.8.4/grizli/pipeline/run_MPI.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/pipeline/summary.py` & `grizli-1.8.4/grizli/pipeline/summary.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/prep.py` & `grizli-1.8.4/grizli/prep.py`

 * *Files 0% similar despite different names*

```diff
@@ -3968,15 +3968,15 @@
                                catalog_mask_pad=0.05,
                                match_catalog_density=None,
                                column_average=True,
                                sky_iter=10,
                                run_tweak_align=True,
                                tweak_fit_order=-1,
                                skip_direct=False,
-                               fix_stars=True,
+                               fix_stars=False,
                                tweak_max_dist=100.,
                                tweak_n_min=10,
                                tweak_threshold=1.5,
                                tweak_ref_exp=0,
                                align_simple=True,
                                single_image_CRs=True,
                                skymethod='localmin',
```

### Comparing `grizli-1.8.3/grizli/stack.py` & `grizli-1.8.4/grizli/stack.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/fit_args.npy` & `grizli-1.8.4/grizli/tests/data/fit_args.npy`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/j033216m2743_00152.beams.fits` & `grizli-1.8.4/grizli/tests/data/j033216m2743_00152.beams.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz` & `grizli-1.8.4/grizli/tests/data/jwst-headers/det_image_seq1_MIRIMAGE_F560Wexp1_cal.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz` & `grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca1_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz` & `grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca2_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz` & `grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01101_00001_nrca5_uncal_dispersed_GRISMR_crossing_F356W_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz` & `grizli-1.8.4/grizli/tests/data/jwst-headers/jw42424001001_01105_00002_nrca5_rate.fits.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/jwst-headers/strip_data.py` & `grizli-1.8.4/grizli/tests/data/jwst-headers/strip_data.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/niriss_jw01324001001_test.beams.fits` & `grizli-1.8.4/grizli/tests/data/niriss_jw01324001001_test.beams.fits`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/data/wfc3-parse-test.tar.gz` & `grizli-1.8.4/grizli/tests/data/wfc3-parse-test.tar.gz`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/test_autoscript.py` & `grizli-1.8.4/grizli/tests/test_autoscript.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/test_cutils.py` & `grizli-1.8.4/grizli/tests/test_cutils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/test_fits.py` & `grizli-1.8.4/grizli/tests/test_fits.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/test_grismconf.py` & `grizli-1.8.4/grizli/tests/test_grismconf.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/test_jwst.py` & `grizli-1.8.4/grizli/tests/test_jwst.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/tests/test_utils.py` & `grizli-1.8.4/grizli/tests/test_utils.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/utils.py` & `grizli-1.8.4/grizli/utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -384,18181 +384,18218 @@
 000017f0: 5d0a 2020 2020 0a20 2020 2066 6f72 2063  ].    .    for c
 00001800: 2069 6e20 636f 6c75 6d6e 735b 323a 5d3a   in columns[2:]:
 00001810: 0a20 2020 2020 2020 2069 6620 6320 6e6f  .        if c no
 00001820: 7420 696e 2074 7261 6e73 6c61 7465 3a0a  t in translate:.
 00001830: 2020 2020 2020 2020 2020 2020 7472 616e              tran
 00001840: 736c 6174 655b 635d 203d 2027 7878 7878  slate[c] = 'xxxx
 00001850: 7878 7878 7878 7878 7878 270a 2020 2020  xxxxxxxxxx'.    
-00001860: 2020 2020 2020 2020 0a20 2020 2066 6f72          .    for
-00001870: 2069 2069 6e20 7261 6e67 6528 4e29 3a0a   i in range(N):.
-00001880: 2020 2020 2020 2020 6c69 6e65 203d 205b          line = [
-00001890: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-000018a0: 2866 696c 6573 5b69 5d29 2e73 706c 6974  (files[i]).split
-000018b0: 2827 2e67 7a27 295b 305d 5d0a 2020 2020  ('.gz')[0]].    
-000018c0: 2020 2020 6966 2066 696c 6573 5b69 5d2e      if files[i].
-000018d0: 656e 6473 7769 7468 2827 2e67 7a27 293a  endswith('.gz'):
-000018e0: 0a20 2020 2020 2020 2020 2020 2069 6d20  .            im 
-000018f0: 3d20 7079 6669 7473 2e6f 7065 6e28 6669  = pyfits.open(fi
-00001900: 6c65 735b 695d 290a 2020 2020 2020 2020  les[i]).        
-00001910: 2020 2020 6820 3d20 696d 5b30 5d2e 6865      h = im[0].he
-00001920: 6164 6572 2e63 6f70 7928 290a 2020 2020  ader.copy().    
-00001930: 2020 2020 2020 2020 696d 2e63 6c6f 7365          im.close
-00001940: 2829 0a20 2020 2020 2020 2065 6c73 653a  ().        else:
-00001950: 0a20 2020 2020 2020 2020 2020 2068 203d  .            h =
-00001960: 2070 7966 6974 732e 4865 6164 6572 2829   pyfits.Header()
-00001970: 2e66 726f 6d66 696c 6528 6669 6c65 735b  .fromfile(files[
-00001980: 695d 290a 2020 2020 2020 2020 0a20 2020  i]).        .   
-00001990: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
-000019a0: 6261 7365 6e61 6d65 2866 696c 6573 5b69  basename(files[i
-000019b0: 5d29 2e73 7461 7274 7377 6974 6828 276a  ]).startswith('j
-000019c0: 7730 2729 3a0a 2020 2020 2020 2020 2020  w0'):.          
-000019d0: 2020 7769 7468 2070 7966 6974 732e 6f70    with pyfits.op
-000019e0: 656e 2866 696c 6573 5b69 5d29 2061 7320  en(files[i]) as 
-000019f0: 5f69 6d3a 0a20 2020 2020 2020 2020 2020  _im:.           
-00001a00: 2020 2020 2068 3120 3d20 5f69 6d5b 2753       h1 = _im['S
-00001a10: 4349 275d 2e68 6561 6465 720a 2020 2020  CI'].header.    
-00001a20: 2020 2020 2020 2020 2020 2020 6966 2027              if '
-00001a30: 5041 5f56 3327 2069 6e20 6831 3a0a 2020  PA_V3' in h1:.  
-00001a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001a50: 2020 685b 2750 415f 5633 275d 203d 2068    h['PA_V3'] = h
-00001a60: 315b 2750 415f 5633 275d 0a20 2020 2020  1['PA_V3'].     
-00001a70: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00001a80: 6669 6c74 203d 2070 6172 7365 5f66 696c  filt = parse_fil
-00001a90: 7465 725f 6672 6f6d 5f68 6561 6465 7228  ter_from_header(
-00001aa0: 682c 206a 7773 745f 6465 7465 6374 6f72  h, jwst_detector
-00001ab0: 3d6a 7773 745f 6465 7465 6374 6f72 290a  =jwst_detector).
-00001ac0: 2020 2020 2020 2020 6c69 6e65 2e61 7070          line.app
-00001ad0: 656e 6428 6669 6c74 290a 2020 2020 2020  end(filt).      
-00001ae0: 2020 6861 735f 636f 6c75 6d6e 7320 3d20    has_columns = 
-00001af0: 5b27 4649 4c45 272c 2027 4649 4c54 4552  ['FILE', 'FILTER
-00001b00: 275d 0a0a 2020 2020 2020 2020 666f 7220  ']..        for 
-00001b10: 6b65 7920 696e 2063 6f6c 756d 6e73 5b32  key in columns[2
-00001b20: 3a5d 3a0a 2020 2020 2020 2020 2020 2020  :]:.            
-00001b30: 6861 735f 636f 6c75 6d6e 732e 6170 7065  has_columns.appe
-00001b40: 6e64 286b 6579 290a 2020 2020 2020 2020  nd(key).        
-00001b50: 2020 2020 6966 206b 6579 2069 6e20 683a      if key in h:
-00001b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001b70: 206c 696e 652e 6170 7065 6e64 2868 5b6b   line.append(h[k
-00001b80: 6579 5d29 0a20 2020 2020 2020 2020 2020  ey]).           
-00001b90: 2065 6c69 6620 7472 616e 736c 6174 655b   elif translate[
-00001ba0: 6b65 795d 2069 6e20 683a 0a20 2020 2020  key] in h:.     
-00001bb0: 2020 2020 2020 2020 2020 206c 696e 652e             line.
-00001bc0: 6170 7065 6e64 2868 5b74 7261 6e73 6c61  append(h[transla
-00001bd0: 7465 5b6b 6579 5d5d 290a 2020 2020 2020  te[key]]).      
-00001be0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00001bf0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00001c00: 6579 2069 6e20 6465 6661 756c 7473 3a0a  ey in defaults:.
-00001c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c20: 2020 2020 6c69 6e65 2e61 7070 656e 6428      line.append(
-00001c30: 6465 6661 756c 7473 5b6b 6579 5d29 0a20  defaults[key]). 
-00001c40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00001c50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00001c60: 2020 2020 2020 2020 206c 696e 652e 6170           line.ap
-00001c70: 7065 6e64 286e 702e 6e61 6e29 0a20 2020  pend(np.nan).   
-00001c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c90: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00001ca0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-00001cb0: 2020 2020 6461 7461 2e61 7070 656e 6428      data.append(
-00001cc0: 6c69 6e65 290a 0a20 2020 2074 6162 203d  line)..    tab =
-00001cd0: 2054 6162 6c65 2872 6f77 733d 6461 7461   Table(rows=data
-00001ce0: 2c20 6e61 6d65 733d 6861 735f 636f 6c75  , names=has_colu
-00001cf0: 6d6e 7329 0a20 2020 200a 2020 2020 6966  mns).    .    if
-00001d00: 2027 5441 5247 4e41 4d45 2720 696e 2074   'TARGNAME' in t
-00001d10: 6162 2e63 6f6c 6e61 6d65 733a 0a20 2020  ab.colnames:.   
-00001d20: 2020 2020 206d 6973 7320 3d20 7461 625b       miss = tab[
-00001d30: 2754 4152 474e 414d 4527 5d20 3d3d 2027  'TARGNAME'] == '
-00001d40: 270a 2020 2020 2020 2020 7461 7267 7320  '.        targs 
-00001d50: 3d20 5b74 2e72 6570 6c61 6365 2827 2027  = [t.replace(' '
-00001d60: 2c20 272d 2729 2066 6f72 2074 2069 6e20  , '-') for t in 
-00001d70: 7461 625b 2754 4152 474e 414d 4527 5d5d  tab['TARGNAME']]
-00001d80: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00001d90: 2020 6966 206d 6973 732e 7375 6d28 2920    if miss.sum() 
-00001da0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00001db0: 2066 6f72 2069 2069 6e20 6e70 2e77 6865   for i in np.whe
-00001dc0: 7265 286d 6973 7329 5b30 5d3a 0a20 2020  re(miss)[0]:.   
-00001dd0: 2020 2020 2020 2020 2020 2020 2074 6172               tar
-00001de0: 6773 5b69 5d20 3d20 2769 6e64 6566 270a  gs[i] = 'indef'.
-00001df0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00001e00: 2074 6162 5b27 5441 5247 4e41 4d45 275d   tab['TARGNAME']
-00001e10: 203d 2074 6172 6773 0a20 2020 2020 2020   = targs.       
-00001e20: 2020 2020 200a 2020 2020 7265 7475 726e       .    return
-00001e30: 2074 6162 0a0a 0a64 6566 2072 6164 6563   tab...def radec
-00001e40: 5f74 6f5f 7461 7267 6e61 6d65 2872 613d  _to_targname(ra=
-00001e50: 302c 2064 6563 3d30 2c20 726f 756e 645f  0, dec=0, round_
-00001e60: 6172 6373 6563 3d28 342c 2036 3029 2c20  arcsec=(4, 60), 
-00001e70: 7072 6563 6973 696f 6e3d 322c 2074 6172  precision=2, tar
-00001e80: 6773 7472 3d27 6a7b 7261 687d 7b72 616d  gstr='j{rah}{ram
-00001e90: 7d7b 7261 737d 7b73 6967 6e7d 7b64 6564  }{ras}{sign}{ded
-00001ea0: 7d7b 6465 6d7d 272c 2068 6561 6465 723d  }{dem}', header=
-00001eb0: 4e6f 6e65 293a 0a20 2020 2022 2222 5475  None):.    """Tu
-00001ec0: 726e 2064 6563 696d 616c 2064 6567 7265  rn decimal degre
-00001ed0: 6520 636f 6f72 6469 6e61 7465 7320 696e  e coordinates in
-00001ee0: 746f 2061 2073 7472 696e 6720 7769 7468  to a string with
-00001ef0: 2072 6f75 6e64 696e 672e 0a0a 2020 2020   rounding...    
-00001f00: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00001f10: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7261  ---------.    ra
-00001f20: 2c20 6465 6320 3a20 666c 6f61 740a 2020  , dec : float.  
-00001f30: 2020 2020 2020 536b 7920 636f 6f72 6469        Sky coordi
-00001f40: 6e61 7465 7320 696e 2064 6563 696d 616c  nates in decimal
-00001f50: 2064 6567 7265 6573 0a0a 2020 2020 726f   degrees..    ro
-00001f60: 756e 645f 6172 6373 6563 203a 2028 7363  und_arcsec : (sc
-00001f70: 616c 6172 2c20 7363 616c 6172 290a 2020  alar, scalar).  
-00001f80: 2020 2020 2020 526f 756e 6420 7468 6520        Round the 
-00001f90: 636f 6f72 6469 6e61 7465 7320 746f 206e  coordinates to n
-00001fa0: 6561 7265 7374 2076 616c 7565 206f 6620  earest value of 
-00001fb0: 6072 6f75 6e64 602c 2069 6e20 6172 6373  `round`, in arcs
-00001fc0: 6563 6f6e 6473 2e0a 0a20 2020 2070 7265  econds...    pre
-00001fd0: 6369 7369 6f6e 203a 2069 6e74 0a20 2020  cision : int.   
-00001fe0: 2020 2020 2053 7562 2d61 7263 7365 636f       Sub-arcseco
-00001ff0: 6e64 2070 7265 6369 7369 6f6e 2c20 696e  nd precision, in
-00002000: 2060 7e61 7374 726f 7079 2e63 6f6f 7264   `~astropy.coord
-00002010: 696e 6174 6573 2e53 6b79 436f 6f72 642e  inates.SkyCoord.
-00002020: 746f 5f73 7472 696e 6760 2e0a 0a20 2020  to_string`...   
-00002030: 2074 6172 6773 7472 203a 2073 7472 696e   targstr : strin
-00002040: 670a 2020 2020 2020 2020 4275 696c 6420  g.        Build 
-00002050: 6074 6172 676e 616d 6560 2077 6974 6820  `targname` with 
-00002060: 7468 6973 2070 6172 656e 7420 7374 7269  this parent stri
-00002070: 6e67 2e20 2041 7267 756d 656e 7473 0a20  ng.  Arguments. 
-00002080: 2020 2020 2020 2060 7261 682c 2072 616d         `rah, ram
-00002090: 2c20 7261 732c 2072 6173 732c 2073 6967  , ras, rass, sig
-000020a0: 6e2c 2064 6564 2c20 6465 6d2c 2064 6573  n, ded, dem, des
-000020b0: 2c20 6465 7373 6020 6172 6520 636f 6d70  , dess` are comp
-000020c0: 7574 6564 2066 726f 6d20 7468 650a 2020  uted from the.  
-000020d0: 2020 2020 2020 2872 6f75 6e64 6564 2920        (rounded) 
-000020e0: 7461 7267 6574 2063 6f6f 7264 696e 6174  target coordinat
-000020f0: 6573 2028 6072 6160 2c20 6064 6563 6029  es (`ra`, `dec`)
-00002100: 2061 6e64 2070 6173 7365 6420 746f 0a20   and passed to. 
-00002110: 2020 2020 2020 2060 7461 7267 7374 722e         `targstr.
-00002120: 666f 726d 6174 602e 0a0a 2020 2020 6865  format`...    he
-00002130: 6164 6572 203a 2060 7e61 7374 726f 7079  ader : `~astropy
-00002140: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
-00002150: 2c20 4e6f 6e65 0a20 2020 2020 2020 2054  , None.        T
-00002160: 7279 2074 6f20 6765 7420 6072 6160 2c20  ry to get `ra`, 
-00002170: 6064 6563 6020 6672 6f6d 2068 6561 6465  `dec` from heade
-00002180: 7220 6b65 7977 6f72 6473 2c20 6669 7273  r keywords, firs
-00002190: 7420 6043 5256 414c 6020 616e 6420 7468  t `CRVAL` and th
-000021a0: 656e 0a20 2020 2020 2020 2060 5241 5f54  en.        `RA_T
-000021b0: 4152 4760 2c20 6044 4543 5f54 4152 4760  ARG`, `DEC_TARG`
-000021c0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
-000021d0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2074     -------.    t
-000021e0: 6172 676e 616d 6520 3a20 7374 720a 2020  argname : str.  
-000021f0: 2020 2020 2020 5461 7267 6574 2073 7472        Target str
-00002200: 696e 672c 2073 6565 2074 6865 2065 7861  ing, see the exa
-00002210: 6d70 6c65 2061 626f 7665 2e0a 2020 2020  mple above..    
-00002220: 0a20 2020 2045 7861 6d70 6c65 730a 2020  .    Examples.  
-00002230: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 200a    --------.    .
-00002240: 2020 2020 3e3e 3e20 2320 5465 7374 2064      >>> # Test d
-00002250: 6563 3a20 2d31 3064 3130 6d31 302e 3130  ec: -10d10m10.10
-00002260: 730a 2020 2020 3e3e 3e20 6465 6320 3d20  s.    >>> dec = 
-00002270: 2d31 302e 202d 2031 302e 2f36 302e 202d  -10. - 10./60. -
-00002280: 2031 302e 312f 3336 3030 0a20 2020 203e   10.1/3600.    >
-00002290: 3e3e 2023 2054 6573 7420 7261 3a20 3032  >> # Test ra: 02
-000022a0: 6830 326d 3032 2e32 3073 0a20 2020 203e  h02m02.20s.    >
-000022b0: 3e3e 2063 6f73 6420 3d20 6e70 2e63 6f73  >> cosd = np.cos
-000022c0: 2864 6563 2f31 3830 2a6e 702e 7069 290a  (dec/180*np.pi).
-000022d0: 2020 2020 3e3e 3e20 7261 203d 2032 2a31      >>> ra = 2*1
-000022e0: 3520 2b20 322e 2f36 302a 3135 202b 2032  5 + 2./60*15 + 2
-000022f0: 2e32 2f33 3630 302e 2a31 350a 2020 2020  .2/3600.*15.    
-00002300: 3e3e 3e20 2320 526f 756e 6420 746f 206e  >>> # Round to n
-00002310: 6561 7265 7374 2061 7263 6d69 6e0a 2020  earest arcmin.  
-00002320: 2020 3e3e 3e20 6672 6f6d 2067 7269 7a6c    >>> from grizl
-00002330: 692e 7574 696c 7320 696d 706f 7274 2072  i.utils import r
-00002340: 6164 6563 5f74 6f5f 7461 7267 6e61 6d65  adec_to_targname
-00002350: 0a20 2020 203e 3e3e 2070 7269 6e74 2872  .    >>> print(r
-00002360: 6164 6563 5f74 6f5f 7461 7267 6e61 6d65  adec_to_targname
-00002370: 2872 613d 7261 2c20 6465 633d 6465 632c  (ra=ra, dec=dec,
-00002380: 2072 6f75 6e64 5f61 7263 7365 633d 2834   round_arcsec=(4
-00002390: 2c36 3029 2c0a 2020 2020 2020 2020 2020  ,60),.          
-000023a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023b0: 2074 6172 6773 7472 3d27 6a7b 7261 687d   targstr='j{rah}
-000023c0: 7b72 616d 7d7b 7261 737d 7b73 6967 6e7d  {ram}{ras}{sign}
-000023d0: 7b64 6564 7d7b 6465 6d7d 2729 290a 2020  {ded}{dem}')).  
-000023e0: 2020 6a30 3230 3230 346d 3130 3130 2023    j020204m1010 #
-000023f0: 2028 726f 756e 6465 6420 746f 2034 2061   (rounded to 4 a
-00002400: 7263 7365 6320 696e 2052 4129 0a20 2020  rcsec in RA).   
-00002410: 203e 3e3e 2023 2046 756c 6c20 7072 6563   >>> # Full prec
-00002420: 6973 696f 6e0a 2020 2020 3e3e 3e20 7461  ision.    >>> ta
-00002430: 7267 7374 7220 3d20 276a 7b72 6168 7d7b  rgstr = 'j{rah}{
-00002440: 7261 6d7d 7b72 6173 7d2e 7b72 6173 737d  ram}{ras}.{rass}
-00002450: 7b73 6967 6e7d 7b64 6564 7d7b 6465 6d7d  {sign}{ded}{dem}
-00002460: 7b64 6573 7d2e 7b64 6573 737d 270a 2020  {des}.{dess}'.  
-00002470: 2020 3e3e 3e20 7072 696e 7428 7261 6465    >>> print(rade
-00002480: 635f 746f 5f74 6172 676e 616d 6528 7261  c_to_targname(ra
-00002490: 2c20 6465 632c 726f 756e 645f 6172 6373  , dec,round_arcs
-000024a0: 6563 3d28 302e 3030 3031 2c20 302e 3030  ec=(0.0001, 0.00
-000024b0: 3031 292c 0a20 2020 2020 2020 2020 2020  01),.           
-000024c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000024d0: 2020 2020 2070 7265 6369 7369 6f6e 3d33       precision=3
-000024e0: 2c20 7461 7267 7374 723d 7461 7267 7374  , targstr=targst
-000024f0: 7229 290a 2020 2020 6a30 3230 3230 322e  r)).    j020202.
-00002500: 3230 306d 3130 3130 3130 2e31 3030 0a20  200m101010.100. 
-00002510: 2020 200a 2020 2020 2222 220a 2020 2020     .    """.    
-00002520: 696d 706f 7274 2061 7374 726f 7079 2e63  import astropy.c
-00002530: 6f6f 7264 696e 6174 6573 0a20 2020 2069  oordinates.    i
-00002540: 6d70 6f72 7420 6173 7472 6f70 792e 756e  mport astropy.un
-00002550: 6974 7320 6173 2075 0a0a 2020 2020 696d  its as u..    im
-00002560: 706f 7274 2072 650a 2020 2020 696d 706f  port re.    impo
-00002570: 7274 206e 756d 7079 2061 7320 6e70 0a0a  rt numpy as np..
-00002580: 2020 2020 6966 2068 6561 6465 7220 6973      if header is
-00002590: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000025a0: 2020 2069 6620 2743 5256 414c 3127 2069     if 'CRVAL1' i
-000025b0: 6e20 6865 6164 6572 3a0a 2020 2020 2020  n header:.      
-000025c0: 2020 2020 2020 7261 2c20 6465 6320 3d20        ra, dec = 
-000025d0: 6865 6164 6572 5b27 4352 5641 4c31 275d  header['CRVAL1']
-000025e0: 2c20 6865 6164 6572 5b27 4352 5641 4c32  , header['CRVAL2
-000025f0: 275d 0a20 2020 2020 2020 2065 6c73 653a  '].        else:
-00002600: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00002610: 2752 415f 5441 5247 2720 696e 2068 6561  'RA_TARG' in hea
-00002620: 6465 723a 0a20 2020 2020 2020 2020 2020  der:.           
-00002630: 2020 2020 2072 612c 2064 6563 203d 2068       ra, dec = h
-00002640: 6561 6465 725b 2752 415f 5441 5247 275d  eader['RA_TARG']
-00002650: 2c20 6865 6164 6572 5b27 4445 435f 5441  , header['DEC_TA
-00002660: 5247 275d 0a0a 2020 2020 636f 7364 203d  RG']..    cosd =
-00002670: 206e 702e 636f 7328 6465 632f 3138 302a   np.cos(dec/180*
-00002680: 6e70 2e70 6929 0a20 2020 2073 636c 203d  np.pi).    scl =
-00002690: 206e 702e 6172 7261 7928 726f 756e 645f   np.array(round_
-000026a0: 6172 6373 6563 292f 3336 3030 2a6e 702e  arcsec)/3600*np.
-000026b0: 6172 7261 7928 5b33 3630 2f32 342c 2031  array([360/24, 1
-000026c0: 5d29 0a0a 2020 2020 6465 635f 7363 6c20  ])..    dec_scl 
-000026d0: 3d20 696e 7428 6e70 2e72 6f75 6e64 2864  = int(np.round(d
-000026e0: 6563 2f73 636c 5b31 5d29 292a 7363 6c5b  ec/scl[1]))*scl[
-000026f0: 315d 0a20 2020 2072 615f 7363 6c20 3d20  1].    ra_scl = 
-00002700: 696e 7428 6e70 2e72 6f75 6e64 2872 612f  int(np.round(ra/
-00002710: 7363 6c5b 305d 2929 2a73 636c 5b30 5d0a  scl[0]))*scl[0].
-00002720: 0a20 2020 2063 6f6f 203d 2061 7374 726f  .    coo = astro
-00002730: 7079 2e63 6f6f 7264 696e 6174 6573 2e53  py.coordinates.S
-00002740: 6b79 436f 6f72 6428 7261 3d72 615f 7363  kyCoord(ra=ra_sc
-00002750: 6c2a 752e 6465 672c 2064 6563 3d64 6563  l*u.deg, dec=dec
-00002760: 5f73 636c 2a75 2e64 6567 2c20 0a20 2020  _scl*u.deg, .   
-00002770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002790: 2020 2020 6672 616d 653d 2769 6372 7327      frame='icrs'
-000027a0: 290a 0a20 2020 2063 7374 7220 3d20 7265  )..    cstr = re
-000027b0: 2e73 706c 6974 2827 5b68 6d73 642e 5d27  .split('[hmsd.]'
-000027c0: 2c20 636f 6f2e 746f 5f73 7472 696e 6728  , coo.to_string(
-000027d0: 2768 6d73 646d 7327 2c20 7072 6563 6973  'hmsdms', precis
-000027e0: 696f 6e3d 7072 6563 6973 696f 6e29 290a  ion=precision)).
-000027f0: 2020 2020 2320 7461 7267 6e61 6d65 203d      # targname =
-00002800: 2028 276a 7b30 7d7b 317d 272e 666f 726d   ('j{0}{1}'.form
-00002810: 6174 2827 272e 6a6f 696e 2863 7374 725b  at(''.join(cstr[
-00002820: 303a 335d 292c 2027 272e 6a6f 696e 2863  0:3]), ''.join(c
-00002830: 7374 725b 343a 375d 2929 290a 2020 2020  str[4:7]))).    
-00002840: 2320 7461 7267 6e61 6d65 203d 2074 6172  # targname = tar
-00002850: 676e 616d 652e 7265 706c 6163 6528 2720  gname.replace(' 
-00002860: 272c 2027 2729 2e72 6570 6c61 6365 2827  ', '').replace('
-00002870: 2b27 2c27 7027 292e 7265 706c 6163 6528  +','p').replace(
-00002880: 272d 272c 276d 2729 0a0a 2020 2020 7261  '-','m')..    ra
-00002890: 682c 2072 616d 2c20 7261 732c 2072 6173  h, ram, ras, ras
-000028a0: 7320 3d20 6373 7472 5b30 3a34 5d0a 2020  s = cstr[0:4].  
-000028b0: 2020 6465 642c 2064 656d 2c20 6465 732c    ded, dem, des,
-000028c0: 2064 6573 7320 3d20 6373 7472 5b34 3a38   dess = cstr[4:8
-000028d0: 5d0a 2020 2020 7369 676e 203d 2027 7027  ].    sign = 'p'
-000028e0: 2069 6620 6465 645b 315d 203d 3d20 272b   if ded[1] == '+
-000028f0: 2720 656c 7365 2027 6d27 0a0a 2020 2020  ' else 'm'..    
-00002900: 7461 7267 6e61 6d65 203d 2074 6172 6773  targname = targs
-00002910: 7472 2e66 6f72 6d61 7428 7261 683d 7261  tr.format(rah=ra
-00002920: 682c 2072 616d 3d72 616d 2c20 7261 733d  h, ram=ram, ras=
-00002930: 7261 732c 2072 6173 733d 7261 7373 2c0a  ras, rass=rass,.
-00002940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002950: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00002960: 643d 6465 645b 323a 5d2c 2064 656d 3d64  d=ded[2:], dem=d
-00002970: 656d 2c20 6465 733d 6465 732c 2064 6573  em, des=des, des
-00002980: 733d 6465 7373 2c0a 2020 2020 2020 2020  s=dess,.        
-00002990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029a0: 2020 2020 2020 7369 676e 3d73 6967 6e29        sign=sign)
-000029b0: 0a0a 2020 2020 7265 7475 726e 2074 6172  ..    return tar
-000029c0: 676e 616d 650a 0a0a 6465 6620 626c 6f74  gname...def blot
-000029d0: 5f6e 6561 7265 7374 5f65 7861 6374 2869  _nearest_exact(i
-000029e0: 6e5f 6461 7461 2c20 696e 5f77 6373 2c20  n_data, in_wcs, 
-000029f0: 6f75 745f 7763 732c 2076 6572 626f 7365  out_wcs, verbose
-00002a00: 3d54 7275 652c 2073 7465 7073 697a 653d  =True, stepsize=
-00002a10: 2d31 2c0a 2020 2020 2020 2020 2020 2020  -1,.            
-00002a20: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
-00002a30: 5f62 795f 7069 7865 6c5f 6172 6561 3d46  _by_pixel_area=F
-00002a40: 616c 7365 2c20 7763 735f 6d61 736b 3d54  alse, wcs_mask=T
-00002a50: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00002a60: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-00002a70: 5f76 616c 7565 3d30 293a 0a20 2020 2022  _value=0):.    "
-00002a80: 2222 0a20 2020 204f 776e 2062 6c6f 7420  "".    Own blot 
-00002a90: 6675 6e63 7469 6f6e 2066 6f72 2062 6c6f  function for blo
-00002aa0: 7474 696e 6720 6578 6163 7420 7069 7865  tting exact pixe
-00002ab0: 6c73 2077 6974 686f 7574 2072 6573 6361  ls without resca
-00002ac0: 6c69 6e67 2066 6f72 2069 6e70 7574 0a20  ling for input. 
-00002ad0: 2020 2061 6e64 206f 7574 7075 7420 7069     and output pi
-00002ae0: 7865 6c20 7369 7a65 0a0a 2020 2020 7465  xel size..    te
-00002af0: 7374 0a0a 2020 2020 5061 7261 6d65 7465  st..    Paramete
-00002b00: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00002b10: 2d0a 2020 2020 696e 5f64 6174 6120 3a20  -.    in_data : 
-00002b20: 607e 6e75 6d70 792e 6e64 6172 7261 7960  `~numpy.ndarray`
-00002b30: 0a20 2020 2020 2020 2049 6e70 7574 2064  .        Input d
-00002b40: 6174 6120 746f 2062 6c6f 742e 0a0a 2020  ata to blot...  
-00002b50: 2020 696e 5f77 6373 203a 2060 7e61 7374    in_wcs : `~ast
-00002b60: 726f 7079 2e77 6373 2e57 4353 600a 2020  ropy.wcs.WCS`.  
-00002b70: 2020 2020 2020 496e 7075 7420 5743 532e        Input WCS.
-00002b80: 2020 4d75 7374 2068 6176 6520 5f6e 6178    Must have _nax
-00002b90: 6973 312c 205f 6e61 7869 7332 206f 7220  is1, _naxis2 or 
-00002ba0: 7069 7865 6c5f 7368 6170 6520 6174 7472  pixel_shape attr
-00002bb0: 6962 7574 6573 2e0a 0a20 2020 206f 7574  ibutes...    out
-00002bc0: 5f77 6373 203a 2060 7e61 7374 726f 7079  _wcs : `~astropy
-00002bd0: 2e77 6373 2e57 4353 600a 2020 2020 2020  .wcs.WCS`.      
-00002be0: 2020 4f75 7470 7574 2057 4353 2e20 204d    Output WCS.  M
-00002bf0: 7573 7420 6861 7665 205f 6e61 7869 7331  ust have _naxis1
-00002c00: 2c20 5f6e 6178 6973 3220 6f72 2070 6978  , _naxis2 or pix
-00002c10: 656c 5f73 6861 7065 2061 7474 7269 6275  el_shape attribu
-00002c20: 7465 732e 0a0a 2020 2020 7363 616c 655f  tes...    scale_
-00002c30: 6279 5f70 6978 656c 5f61 7265 6120 3a20  by_pixel_area : 
-00002c40: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
-00002c50: 5472 7565 2c20 7468 656e 2073 6361 6c65  True, then scale
-00002c60: 2074 6865 206f 7574 7075 7420 696d 6167   the output imag
-00002c70: 6520 6279 2074 6865 2073 7175 6172 6520  e by the square 
-00002c80: 6f66 2074 6865 2069 6d61 6765 2070 6978  of the image pix
-00002c90: 656c 0a20 2020 2020 2020 2073 6361 6c65  el.        scale
-00002ca0: 7320 286f 7574 2a2a 322f 696e 2a2a 3229  s (out**2/in**2)
-00002cb0: 2c20 692e 652e 2c20 7468 6520 7069 7865  , i.e., the pixe
-00002cc0: 6c20 6172 6561 732e 0a0a 2020 2020 7763  l areas...    wc
-00002cd0: 735f 6d61 736b 203a 2062 6f6f 6c0a 2020  s_mask : bool.  
-00002ce0: 2020 2020 2020 5573 6520 6661 7374 2057        Use fast W
-00002cf0: 4353 206d 6173 6b69 6e67 2e20 2049 6620  CS masking.  If 
-00002d00: 4661 6c73 652c 2075 7365 2060 6072 6567  False, use ``reg
-00002d10: 696f 6e73 6060 2e0a 0a20 2020 2066 696c  ions``...    fil
-00002d20: 6c5f 7661 6c75 6520 3a20 696e 742f 666c  l_value : int/fl
-00002d30: 6f61 740a 2020 2020 2020 2020 5661 6c75  oat.        Valu
-00002d40: 6520 696e 2060 6f75 745f 6461 7461 6020  e in `out_data` 
-00002d50: 6e6f 7420 636f 7665 7265 6420 6279 2060  not covered by `
-00002d60: 696e 5f64 6174 6160 2e0a 0a20 2020 2052  in_data`...    R
-00002d70: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-00002d80: 2d2d 0a20 2020 206f 7574 5f64 6174 6120  --.    out_data 
-00002d90: 3a20 607e 6e75 6d70 792e 6e64 6172 7261  : `~numpy.ndarra
-00002da0: 7960 0a20 2020 2020 2020 2042 6c6f 7474  y`.        Blott
-00002db0: 6564 2064 6174 612e 0a0a 2020 2020 2222  ed data...    ""
-00002dc0: 220a 2020 2020 6672 6f6d 2072 6567 696f  ".    from regio
-00002dd0: 6e73 2069 6d70 6f72 7420 5265 6769 6f6e  ns import Region
-00002de0: 730a 2020 2020 6672 6f6d 2073 6861 7065  s.    from shape
-00002df0: 6c79 2e67 656f 6d65 7472 7920 696d 706f  ly.geometry impo
-00002e00: 7274 2050 6f6c 7967 6f6e 0a20 2020 2069  rt Polygon.    i
-00002e10: 6d70 6f72 7420 7363 6970 792e 6e64 696d  mport scipy.ndim
-00002e20: 6167 6520 6173 206e 640a 2020 2020 6672  age as nd.    fr
-00002e30: 6f6d 2064 7269 7a7a 6c65 7061 6320 696d  om drizzlepac im
-00002e40: 706f 7274 2063 6472 697a 0a0a 2020 2020  port cdriz..    
-00002e50: 7472 793a 0a20 2020 2020 2020 2066 726f  try:.        fro
-00002e60: 6d20 2e75 7469 6c73 5f63 2e69 6e74 6572  m .utils_c.inter
-00002e70: 7020 696d 706f 7274 2070 6978 656c 5f6d  p import pixel_m
-00002e80: 6170 5f63 0a20 2020 2065 7863 6570 743a  ap_c.    except:
-00002e90: 0a20 2020 2020 2020 2066 726f 6d20 6772  .        from gr
-00002ea0: 697a 6c69 2e75 7469 6c73 5f63 2e69 6e74  izli.utils_c.int
-00002eb0: 6572 7020 696d 706f 7274 2070 6978 656c  erp import pixel
-00002ec0: 5f6d 6170 5f63 0a20 2020 200a 2020 2020  _map_c.    .    
-00002ed0: 2320 5368 6170 6573 2c20 696e 206e 756d  # Shapes, in num
-00002ee0: 7079 2061 7272 6179 2063 6f6e 7665 6e74  py array convent
-00002ef0: 696f 6e20 2879 2c20 7829 0a20 2020 2069  ion (y, x).    i
-00002f00: 6620 6861 7361 7474 7228 696e 5f77 6373  f hasattr(in_wcs
-00002f10: 2c20 2770 6978 656c 5f73 6861 7065 2729  , 'pixel_shape')
-00002f20: 3a0a 2020 2020 2020 2020 696e 5f73 6820  :.        in_sh 
-00002f30: 3d20 696e 5f77 6373 2e70 6978 656c 5f73  = in_wcs.pixel_s
-00002f40: 6861 7065 5b3a 3a2d 315d 0a20 2020 2065  hape[::-1].    e
-00002f50: 6c69 6620 6861 7361 7474 7228 696e 5f77  lif hasattr(in_w
-00002f60: 6373 2c20 2761 7272 6179 5f73 6861 7065  cs, 'array_shape
-00002f70: 2729 3a0a 2020 2020 2020 2020 696e 5f73  '):.        in_s
-00002f80: 6820 3d20 696e 5f77 6373 2e61 7272 6179  h = in_wcs.array
-00002f90: 5f73 6861 7065 0a20 2020 2065 6c73 653a  _shape.    else:
-00002fa0: 0a20 2020 2020 2020 2069 6e5f 7368 203d  .        in_sh =
-00002fb0: 2028 696e 5f77 6373 2e5f 6e61 7869 7332   (in_wcs._naxis2
-00002fc0: 2c20 696e 5f77 6373 2e5f 6e61 7869 7331  , in_wcs._naxis1
-00002fd0: 290a 0a20 2020 2069 6620 6861 7361 7474  )..    if hasatt
-00002fe0: 7228 6f75 745f 7763 732c 2027 7069 7865  r(out_wcs, 'pixe
-00002ff0: 6c5f 7368 6170 6527 293a 0a20 2020 2020  l_shape'):.     
-00003000: 2020 206f 7574 5f73 6820 3d20 6f75 745f     out_sh = out_
-00003010: 7763 732e 7069 7865 6c5f 7368 6170 655b  wcs.pixel_shape[
-00003020: 3a3a 2d31 5d0a 2020 2020 656c 6966 2068  ::-1].    elif h
-00003030: 6173 6174 7472 286f 7574 5f77 6373 2c20  asattr(out_wcs, 
-00003040: 2761 7272 6179 5f73 6861 7065 2729 3a0a  'array_shape'):.
-00003050: 2020 2020 2020 2020 6f75 745f 7368 203d          out_sh =
-00003060: 206f 7574 5f77 6373 2e61 7272 6179 5f73   out_wcs.array_s
-00003070: 6861 7065 0a20 2020 2065 6c73 653a 0a20  hape.    else:. 
-00003080: 2020 2020 2020 206f 7574 5f73 6820 3d20         out_sh = 
-00003090: 286f 7574 5f77 6373 2e5f 6e61 7869 7332  (out_wcs._naxis2
-000030a0: 2c20 6f75 745f 7763 732e 5f6e 6178 6973  , out_wcs._naxis
-000030b0: 3129 0a0a 2020 2020 696e 5f70 7820 3d20  1)..    in_px = 
-000030c0: 696e 5f77 6373 2e63 616c 635f 666f 6f74  in_wcs.calc_foot
-000030d0: 7072 696e 7428 290a 2020 2020 696e 5f70  print().    in_p
-000030e0: 6f6c 7920 3d20 506f 6c79 676f 6e28 696e  oly = Polygon(in
-000030f0: 5f70 7829 2e62 7566 6665 7228 352e 2f33  _px).buffer(5./3
-00003100: 3630 302e 290a 0a20 2020 206f 7574 5f70  600.)..    out_p
-00003110: 7820 3d20 6f75 745f 7763 732e 6361 6c63  x = out_wcs.calc
-00003120: 5f66 6f6f 7470 7269 6e74 2829 0a20 2020  _footprint().   
-00003130: 206f 7574 5f70 6f6c 7920 3d20 506f 6c79   out_poly = Poly
-00003140: 676f 6e28 6f75 745f 7078 292e 6275 6666  gon(out_px).buff
-00003150: 6572 2835 2e2f 3336 3030 290a 0a20 2020  er(5./3600)..   
-00003160: 206f 6c61 7020 3d20 696e 5f70 6f6c 792e   olap = in_poly.
-00003170: 696e 7465 7273 6563 7469 6f6e 286f 7574  intersection(out
-00003180: 5f70 6f6c 7929 0a20 2020 2069 6620 6f6c  _poly).    if ol
-00003190: 6170 2e61 7265 6120 3d3d 2030 3a0a 2020  ap.area == 0:.  
-000031a0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-000031b0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-000031c0: 696e 7428 274e 6f20 6f76 6572 6c61 7027  int('No overlap'
-000031d0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000031e0: 206e 702e 7a65 726f 7328 6f75 745f 7368   np.zeros(out_sh
-000031f0: 290a 0a20 2020 2023 2052 6567 696f 6e20  )..    # Region 
-00003200: 6d61 736b 2066 6f72 2073 7065 6564 7570  mask for speedup
-00003210: 0a20 2020 2069 6620 6e70 2e69 7363 6c6f  .    if np.isclo
-00003220: 7365 286f 6c61 702e 6172 6561 2c20 6f75  se(olap.area, ou
-00003230: 745f 706f 6c79 2e61 7265 612c 2030 2e30  t_poly.area, 0.0
-00003240: 3129 3a0a 2020 2020 2020 2020 6d61 736b  1):.        mask
-00003250: 203d 206e 702e 6f6e 6573 286f 7574 5f73   = np.ones(out_s
-00003260: 682c 2064 7479 7065 3d62 6f6f 6c29 0a20  h, dtype=bool). 
-00003270: 2020 2065 6c69 6620 7763 735f 6d61 736b     elif wcs_mask
-00003280: 3a0a 2020 2020 2020 2020 2320 5573 6520  :.        # Use 
-00003290: 7763 7320 2f20 5061 7468 0a20 2020 2020  wcs / Path.     
-000032a0: 2020 2066 726f 6d20 6d61 7470 6c6f 746c     from matplotl
-000032b0: 6962 2e70 6174 6820 696d 706f 7274 2050  ib.path import P
-000032c0: 6174 680a 2020 2020 2020 2020 6f75 745f  ath.        out_
-000032d0: 7879 203d 206f 7574 5f77 6373 2e61 6c6c  xy = out_wcs.all
-000032e0: 5f77 6f72 6c64 3270 6978 286e 702e 6172  _world2pix(np.ar
-000032f0: 7261 7928 696e 5f70 6f6c 792e 6578 7465  ray(in_poly.exte
-00003300: 7269 6f72 2e78 7929 2e54 2c20 3029 2d30  rior.xy).T, 0)-0
-00003310: 2e35 0a20 2020 2020 2020 206f 7574 5f78  .5.        out_x
-00003320: 795f 7061 7468 203d 2050 6174 6828 6f75  y_path = Path(ou
-00003330: 745f 7879 290a 2020 2020 2020 2020 7970  t_xy).        yp
-00003340: 2c20 7870 203d 206e 702e 696e 6469 6365  , xp = np.indice
-00003350: 7328 6f75 745f 7368 290a 2020 2020 2020  s(out_sh).      
-00003360: 2020 7074 7320 3d20 6e70 2e61 7272 6179    pts = np.array
-00003370: 285b 7870 2e66 6c61 7474 656e 2829 2c20  ([xp.flatten(), 
-00003380: 7970 2e66 6c61 7474 656e 2829 5d29 2e54  yp.flatten()]).T
-00003390: 0a20 2020 2020 2020 206d 6173 6b20 3d20  .        mask = 
-000033a0: 6f75 745f 7879 5f70 6174 682e 636f 6e74  out_xy_path.cont
-000033b0: 6169 6e73 5f70 6f69 6e74 7328 7074 7329  ains_points(pts)
-000033c0: 2e72 6573 6861 7065 286f 7574 5f73 6829  .reshape(out_sh)
-000033d0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-000033e0: 2020 206f 6c61 705f 706f 6c79 203d 206e     olap_poly = n
-000033f0: 702e 6172 7261 7928 6f6c 6170 2e65 7874  p.array(olap.ext
-00003400: 6572 696f 722e 7879 290a 2020 2020 2020  erior.xy).      
-00003410: 2020 706f 6c79 5f72 6567 203d 2022 666b    poly_reg = "fk
-00003420: 355c 6e70 6f6c 7967 6f6e 2822 2b27 2c27  5\npolygon("+','
-00003430: 2e6a 6f69 6e28 5b27 7b30 7d27 2e66 6f72  .join(['{0}'.for
-00003440: 6d61 7428 7020 2b20 3129 2066 6f72 2070  mat(p + 1) for p
-00003450: 2069 6e20 6f6c 6170 5f70 6f6c 792e 542e   in olap_poly.T.
-00003460: 666c 6174 7465 6e28 295d 292b 2729 5c6e  flatten()])+')\n
-00003470: 270a 2020 2020 2020 2020 7265 6720 3d20  '.        reg = 
-00003480: 5265 6769 6f6e 732e 7061 7273 6528 706f  Regions.parse(po
-00003490: 6c79 5f72 6567 2c20 666f 726d 6174 3d27  ly_reg, format='
-000034a0: 6473 3927 295b 305d 0a20 2020 2020 2020  ds9')[0].       
-000034b0: 206d 6173 6b20 3d20 7265 672e 746f 5f6d   mask = reg.to_m
-000034c0: 6173 6b28 292e 746f 5f69 6d61 6765 2873  ask().to_image(s
-000034d0: 6861 7065 3d6f 7574 5f73 6829 0a0a 2020  hape=out_sh)..  
-000034e0: 2020 2379 702c 2078 7020 3d20 6e70 2e69    #yp, xp = np.i
-000034f0: 6e64 6963 6573 2869 6e5f 6461 7461 2e73  ndices(in_data.s
-00003500: 6861 7065 290a 2020 2020 2378 692c 2079  hape).    #xi, y
-00003510: 6920 3d20 7870 5b6d 6173 6b5d 2c20 7970  i = xp[mask], yp
-00003520: 5b6d 6173 6b5d 0a20 2020 2079 6f2c 2078  [mask].    yo, x
-00003530: 6f20 3d20 6e70 2e77 6865 7265 286d 6173  o = np.where(mas
-00003540: 6b20 3e20 3029 0a0a 2020 2020 6966 2073  k > 0)..    if s
-00003550: 7465 7073 697a 6520 3c3d 2031 3a0a 2020  tepsize <= 1:.  
-00003560: 2020 2020 2020 7264 203d 206f 7574 5f77        rd = out_w
-00003570: 6373 2e61 6c6c 5f70 6978 3277 6f72 6c64  cs.all_pix2world
-00003580: 2878 6f2c 2079 6f2c 2030 290a 2020 2020  (xo, yo, 0).    
-00003590: 2020 2020 7866 2c20 7966 203d 2069 6e5f      xf, yf = in_
-000035a0: 7763 732e 616c 6c5f 776f 726c 6432 7069  wcs.all_world2pi
-000035b0: 7828 7264 5b30 5d2c 2072 645b 315d 2c20  x(rd[0], rd[1], 
-000035c0: 3029 0a20 2020 2065 6c73 653a 0a20 2020  0).    else:.   
-000035d0: 2020 2020 2023 2053 6565 6d73 2062 6163       # Seems bac
-000035e0: 6b77 6172 6473 2061 6e64 2064 6f65 736e  kwards and doesn
-000035f0: 2774 2071 7569 7465 2061 6772 6565 2077  't quite agree w
-00003600: 6974 6820 6162 6f76 650a 2020 2020 2020  ith above.      
-00003610: 2020 626c 6f74 5f77 6373 203d 206f 7574    blot_wcs = out
-00003620: 5f77 6373 0a20 2020 2020 2020 2073 6f75  _wcs.        sou
-00003630: 7263 655f 7763 7320 3d20 696e 5f77 6373  rce_wcs = in_wcs
-00003640: 0a0a 2020 2020 2020 2020 6966 2068 6173  ..        if has
-00003650: 6174 7472 2862 6c6f 745f 7763 732c 2027  attr(blot_wcs, '
-00003660: 7069 7865 6c5f 7368 6170 6527 293a 0a20  pixel_shape'):. 
-00003670: 2020 2020 2020 2020 2020 206e 782c 206e             nx, n
-00003680: 7920 3d20 626c 6f74 5f77 6373 2e70 6978  y = blot_wcs.pix
-00003690: 656c 5f73 6861 7065 0a20 2020 2020 2020  el_shape.       
-000036a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000036b0: 2020 206e 782c 206e 7920 3d20 696e 7428     nx, ny = int(
-000036c0: 626c 6f74 5f77 6373 2e5f 6e61 7869 7331  blot_wcs._naxis1
-000036d0: 292c 2069 6e74 2862 6c6f 745f 7763 732e  ), int(blot_wcs.
-000036e0: 5f6e 6178 6973 3229 0a0a 2020 2020 2020  _naxis2)..      
-000036f0: 2020 6d61 7070 696e 6720 3d20 6364 7269    mapping = cdri
-00003700: 7a2e 4465 6661 756c 7457 4353 4d61 7070  z.DefaultWCSMapp
-00003710: 696e 6728 626c 6f74 5f77 6373 2c20 736f  ing(blot_wcs, so
-00003720: 7572 6365 5f77 6373 2c20 6e78 2c20 6e79  urce_wcs, nx, ny
-00003730: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003750: 2020 2020 2020 2020 2020 2020 7374 6570              step
-00003760: 7369 7a65 290a 2020 2020 2020 2020 7866  size).        xf
-00003770: 2c20 7966 203d 206d 6170 7069 6e67 2878  , yf = mapping(x
-00003780: 6f2c 2079 6f29 0a0a 2020 2020 7869 2c20  o, yo)..    xi, 
-00003790: 7969 203d 206e 702e 6361 7374 5b69 6e74  yi = np.cast[int
-000037a0: 5d28 6e70 2e72 6f75 6e64 2878 6629 292c  ](np.round(xf)),
-000037b0: 206e 702e 6361 7374 5b69 6e74 5d28 6e70   np.cast[int](np
-000037c0: 2e72 6f75 6e64 2879 6629 290a 0a20 2020  .round(yf))..   
-000037d0: 206d 3220 3d20 2878 6920 3e3d 2030 2920   m2 = (xi >= 0) 
-000037e0: 2620 2879 6920 3e3d 2030 2920 2620 2878  & (yi >= 0) & (x
-000037f0: 6920 3c20 696e 5f73 685b 315d 2920 2620  i < in_sh[1]) & 
-00003800: 2879 6920 3c20 696e 5f73 685b 305d 290a  (yi < in_sh[0]).
-00003810: 2020 2020 7869 2c20 7969 2c20 7866 2c20      xi, yi, xf, 
-00003820: 7966 2c20 786f 2c20 796f 203d 2078 695b  yf, xo, yo = xi[
-00003830: 6d32 5d2c 2079 695b 6d32 5d2c 2078 665b  m2], yi[m2], xf[
-00003840: 6d32 5d2c 2079 665b 6d32 5d2c 2078 6f5b  m2], yf[m2], xo[
-00003850: 6d32 5d2c 2079 6f5b 6d32 5d0a 0a20 2020  m2], yo[m2]..   
-00003860: 206f 7574 5f64 6174 6120 3d20 6e70 2e6f   out_data = np.o
-00003870: 6e65 7328 6f75 745f 7368 2c20 6474 7970  nes(out_sh, dtyp
-00003880: 653d 6e70 2e66 6c6f 6174 3634 292a 6669  e=np.float64)*fi
-00003890: 6c6c 5f76 616c 7565 0a20 2020 2073 7461  ll_value.    sta
-000038a0: 7475 7320 3d20 7069 7865 6c5f 6d61 705f  tus = pixel_map_
-000038b0: 6328 6e70 2e63 6173 745b 6e70 2e66 6c6f  c(np.cast[np.flo
-000038c0: 6174 3634 5d28 696e 5f64 6174 6129 2c20  at64](in_data), 
-000038d0: 7869 2c20 7969 2c20 6f75 745f 6461 7461  xi, yi, out_data
-000038e0: 2c20 786f 2c20 796f 290a 0a20 2020 2023  , xo, yo)..    #
-000038f0: 2046 696c 6c20 656d 7074 790a 2020 2020   Fill empty.    
-00003900: 6675 6e63 203d 206e 642e 6d61 7869 6d75  func = nd.maximu
-00003910: 6d5f 6669 6c74 6572 0a20 2020 2066 696c  m_filter.    fil
-00003920: 6c20 3d20 6f75 745f 6461 7461 203d 3d20  l = out_data == 
-00003930: 300a 2020 2020 6669 6c74 6572 6564 203d  0.    filtered =
-00003940: 2066 756e 6328 6f75 745f 6461 7461 2c20   func(out_data, 
-00003950: 7369 7a65 3d35 290a 2020 2020 6f75 745f  size=5).    out_
-00003960: 6461 7461 5b66 696c 6c5d 203d 2066 696c  data[fill] = fil
-00003970: 7465 7265 645b 6669 6c6c 5d0a 0a20 2020  tered[fill]..   
-00003980: 2069 6620 7363 616c 655f 6279 5f70 6978   if scale_by_pix
-00003990: 656c 5f61 7265 613a 0a20 2020 2020 2020  el_area:.       
-000039a0: 2069 6e5f 7363 616c 6520 3d20 6765 745f   in_scale = get_
-000039b0: 7763 735f 7073 6361 6c65 2869 6e5f 7763  wcs_pscale(in_wc
-000039c0: 7329 0a20 2020 2020 2020 206f 7574 5f73  s).        out_s
-000039d0: 6361 6c65 203d 2067 6574 5f77 6373 5f70  cale = get_wcs_p
-000039e0: 7363 616c 6528 6f75 745f 7763 7329 0a20  scale(out_wcs). 
-000039f0: 2020 2020 2020 206f 7574 5f64 6174 6120         out_data 
-00003a00: 2a3d 206f 7574 5f73 6361 6c65 2a2a 322f  *= out_scale**2/
-00003a10: 696e 5f73 6361 6c65 2a2a 320a 0a20 2020  in_scale**2..   
-00003a20: 2072 6574 7572 6e20 6f75 745f 6461 7461   return out_data
-00003a30: 2e61 7374 7970 6528 696e 5f64 6174 612e  .astype(in_data.
-00003a40: 6474 7970 6529 0a0a 0a64 6566 205f 736c  dtype)...def _sl
-00003a50: 6963 655f 6e64 6669 6c74 6572 2864 6174  ice_ndfilter(dat
-00003a60: 612c 2066 696c 7465 725f 6675 6e63 2c20  a, filter_func, 
-00003a70: 736c 6963 6573 2c20 6172 6773 2c20 7369  slices, args, si
-00003a80: 7a65 2c20 666f 6f74 7072 696e 742c 206b  ze, footprint, k
-00003a90: 7761 7267 7329 3a0a 2020 2020 2222 220a  wargs):.    """.
-00003aa0: 2020 2020 4865 6c70 6572 2066 756e 6374      Helper funct
-00003ab0: 696f 6e20 7061 7373 696e 6720 696d 6167  ion passing imag
-00003ac0: 6520 736c 6963 6573 2074 6f20 6073 6369  e slices to `sci
-00003ad0: 7079 2e6e 6469 6d61 6765 6020 6669 6c74  py.ndimage` filt
-00003ae0: 6572 7320 7468 6174 2069 730a 2020 2020  ers that is.    
-00003af0: 7069 636b 6c65 6162 6c65 2066 6f72 2074  pickleable for t
-00003b00: 6872 6561 6469 6e67 2077 6974 6820 606d  hreading with `m
-00003b10: 756c 7469 7072 6f63 6573 7369 6e67 600a  ultiprocessing`.
-00003b20: 2020 2020 0a20 2020 2050 6172 616d 6574      .    Paramet
-00003b30: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00003b40: 2d2d 0a20 2020 2064 6174 612c 2066 696c  --.    data, fil
-00003b50: 7465 725f 6675 6e63 2c20 6172 6773 2c20  ter_func, args, 
-00003b60: 7369 7a65 2c20 666f 6f74 7072 696e 7420  size, footprint 
-00003b70: 3a20 0a20 2020 2020 2020 2053 6565 2060  : .        See `
-00003b80: 6d75 6c74 6970 726f 6365 7373 696e 675f  multiprocessing_
-00003b90: 6e64 6669 6c74 6572 600a 2020 2020 0a20  ndfilter`.    . 
-00003ba0: 2020 2073 6c69 6365 7320 3a20 2873 6c69     slices : (sli
-00003bb0: 6365 2c20 736c 6963 652c 2073 6c69 6365  ce, slice, slice
-00003bc0: 2c20 736c 6963 6529 0a20 2020 2020 2020  , slice).       
-00003bd0: 2041 7272 6179 2073 6c69 6365 7320 666f   Array slices fo
-00003be0: 7220 696e 7365 7274 2061 2063 7574 6f75  r insert a cutou
-00003bf0: 7420 6261 636b 2069 6e74 6f20 6120 6c61  t back into a la
-00003c00: 7267 6572 2070 6172 656e 7420 6172 7261  rger parent arra
-00003c10: 790a 2020 2020 2020 2020 0a20 2020 2052  y.        .    R
-00003c20: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-00003c30: 2d2d 0a20 2020 2066 696c 7465 7265 6420  --.    filtered 
-00003c40: 3a20 6172 7261 792d 6c69 6b65 0a20 2020  : array-like.   
-00003c50: 2020 2020 2046 696c 7465 7265 6420 6461       Filtered da
-00003c60: 7461 0a20 2020 200a 2020 2020 736c 6963  ta.    .    slic
-00003c70: 6573 203a 2074 7570 6c65 0a20 2020 2020  es : tuple.     
-00003c80: 2020 2060 736c 6963 6573 6020 6173 2069     `slices` as i
-00003c90: 6e70 7574 0a20 2020 2020 2020 200a 2020  nput.        .  
-00003ca0: 2020 2222 220a 2020 2020 6669 6c74 6572    """.    filter
-00003cb0: 6564 203d 2066 696c 7465 725f 6675 6e63  ed = filter_func
-00003cc0: 2864 6174 612c 202a 6172 6773 2c20 0a20  (data, *args, . 
-00003cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ce0: 2020 2020 2020 2020 2020 7369 7a65 3d73            size=s
-00003cf0: 697a 652c 2066 6f6f 7470 7269 6e74 3d66  ize, footprint=f
-00003d00: 6f6f 7470 7269 6e74 2c0a 2020 2020 2020  ootprint,.      
-00003d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d20: 2020 2020 202a 2a6b 7761 7267 7329 0a20       **kwargs). 
-00003d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d40: 2020 2020 2020 2020 2020 0a20 2020 2072            .    r
-00003d50: 6574 7572 6e20 6669 6c74 6572 6564 2c20  eturn filtered, 
-00003d60: 736c 6963 6573 0a0a 0a64 6566 206d 756c  slices...def mul
-00003d70: 7469 7072 6f63 6573 7369 6e67 5f6e 6466  tiprocessing_ndf
-00003d80: 696c 7465 7228 6461 7461 2c20 6669 6c74  ilter(data, filt
-00003d90: 6572 5f66 756e 632c 2066 696c 7465 725f  er_func, filter_
-00003da0: 6172 6773 3d28 292c 2073 697a 653d 4e6f  args=(), size=No
-00003db0: 6e65 2c20 666f 6f74 7072 696e 743d 4e6f  ne, footprint=No
-00003dc0: 6e65 2c20 6375 746f 7574 5f73 697a 653d  ne, cutout_size=
-00003dd0: 3235 362c 206e 5f70 726f 633d 342c 2074  256, n_proc=4, t
-00003de0: 696d 656f 7574 3d39 302c 206d 6173 6b3d  imeout=90, mask=
-00003df0: 4e6f 6e65 2c20 7665 7262 6f73 653d 5472  None, verbose=Tr
-00003e00: 7565 2c20 2a2a 6b77 6172 6773 293a 0a20  ue, **kwargs):. 
-00003e10: 2020 2022 2222 0a20 2020 2043 7574 2075     """.    Cut u
-00003e20: 7020 6120 6c61 7267 6520 6172 7261 7920  p a large array 
-00003e30: 616e 6420 7365 6e64 2073 6c69 6365 7320  and send slices 
-00003e40: 746f 2060 7363 6970 792e 6e64 696d 6167  to `scipy.ndimag
-00003e50: 6560 2066 696c 7465 7273 0a20 2020 200a  e` filters.    .
-00003e60: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00003e70: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00003e80: 2020 0a20 2020 2064 6174 6120 3a20 6172    .    data : ar
-00003e90: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
-00003ea0: 204d 6169 6e20 696d 6167 6520 6172 7261   Main image arra
-00003eb0: 790a 2020 2020 2020 2020 0a20 2020 2066  y.        .    f
-00003ec0: 696c 7465 725f 6675 6e63 203a 2066 756e  ilter_func : fun
-00003ed0: 6374 696f 6e0a 2020 2020 2020 2020 4669  ction.        Fi
-00003ee0: 6c74 6572 696e 6720 6675 6e63 7469 6f6e  ltering function
-00003ef0: 2c20 652e 672e 2c20 6073 6369 7079 2e6e  , e.g., `scipy.n
-00003f00: 6469 6d61 6765 2e6d 6564 6961 6e5f 6669  dimage.median_fi
-00003f10: 6c74 6572 600a 2020 2020 0a20 2020 2066  lter`.    .    f
-00003f20: 696c 7465 725f 6172 6773 203a 2074 7570  ilter_args : tup
-00003f30: 6c65 0a20 2020 2020 2020 2041 7267 756d  le.        Argum
-00003f40: 656e 7473 2074 6f20 7061 7373 2074 6f20  ents to pass to 
-00003f50: 6066 696c 7465 725f 6675 6e63 600a 2020  `filter_func`.  
-00003f60: 2020 0a20 2020 2073 697a 652c 2066 6f6f    .    size, foo
-00003f70: 7470 7269 6e74 203a 2069 6e74 2c20 6172  tprint : int, ar
-00003f80: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
-00003f90: 2046 696c 7465 7220 7369 7a65 206f 7220   Filter size or 
-00003fa0: 666f 6f74 7072 696e 742c 2073 6565 2c20  footprint, see, 
-00003fb0: 652e 672e 2c20 6073 6369 7079 2e6e 6469  e.g., `scipy.ndi
-00003fc0: 6d61 6765 2e6d 6564 6961 6e5f 6669 6c74  mage.median_filt
-00003fd0: 6572 600a 2020 2020 0a20 2020 2063 7574  er`.    .    cut
-00003fe0: 6f75 745f 7369 7a65 203a 2069 6e74 0a20  out_size : int. 
-00003ff0: 2020 2020 2020 2053 697a 6520 6f66 2073         Size of s
-00004000: 7562 696d 6167 6520 6375 746f 7574 730a  ubimage cutouts.
-00004010: 2020 2020 0a20 2020 206e 5f70 726f 6320      .    n_proc 
-00004020: 3a20 696e 740a 2020 2020 2020 2020 4e75  : int.        Nu
-00004030: 6d62 6572 206f 6620 606d 756c 7469 7072  mber of `multipr
-00004040: 6f63 6573 7369 6e67 6020 7072 6f63 6573  ocessing` proces
-00004050: 7365 7320 746f 2075 7365 0a20 2020 200a  ses to use.    .
-00004060: 2020 2020 7469 6d65 6f75 7420 3a20 666c      timeout : fl
-00004070: 6f61 740a 2020 2020 2020 2020 606d 756c  oat.        `mul
-00004080: 7469 7072 6f63 6573 7369 6e67 6020 7469  tiprocessing` ti
-00004090: 6d65 6f75 7420 2873 6563 6f6e 6473 290a  meout (seconds).
-000040a0: 2020 2020 0a20 2020 206d 6173 6b20 3a20      .    mask : 
-000040b0: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
-000040c0: 2020 2041 7272 6179 206d 756c 7469 706c     Array multipl
-000040d0: 6965 6420 746f 2060 6461 7461 6020 7468  ied to `data` th
-000040e0: 6174 2063 616e 207a 6572 6f2d 6f75 7420  at can zero-out 
-000040f0: 7265 6769 6f6e 7320 746f 2069 676e 6f72  regions to ignor
-00004100: 650a 2020 2020 0a20 2020 2076 6572 626f  e.    .    verbo
-00004110: 7365 203a 2062 6f6f 6c0a 2020 2020 2020  se : bool.      
-00004120: 2020 5072 696e 7420 7374 6174 7573 206d    Print status m
-00004130: 6573 7361 6765 730a 2020 2020 2020 2020  essages.        
-00004140: 0a20 2020 206b 7761 7267 7320 3a20 6469  .    kwargs : di
-00004150: 6374 0a20 2020 2020 2020 204b 6579 776f  ct.        Keywo
-00004160: 7264 2061 7267 756d 656e 7473 2070 6173  rd arguments pas
-00004170: 7365 6420 7468 726f 7567 6820 746f 2060  sed through to `
-00004180: 6669 6c74 6572 5f66 756e 6360 0a20 2020  filter_func`.   
-00004190: 2020 2020 200a 2020 2020 5265 7475 726e       .    Return
-000041a0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-000041b0: 2020 6669 6c74 6572 6564 203a 2061 7272    filtered : arr
-000041c0: 6179 2d6c 696b 650a 2020 2020 2020 2020  ay-like.        
-000041d0: 4669 6c74 6572 6564 2076 6572 7369 6f6e  Filtered version
-000041e0: 206f 6620 6064 6174 6160 0a20 2020 200a   of `data`.    .
-000041f0: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
-00004200: 202d 2d2d 2d2d 2d2d 2d0a 0a20 2020 2020   --------..     
-00004210: 2020 203e 3e3e 2069 6d70 6f72 7420 7469     >>> import ti
-00004220: 6d65 0a20 2020 2020 2020 203e 3e3e 2069  me.        >>> i
-00004230: 6d70 6f72 7420 6e75 6d70 7920 6173 206e  mport numpy as n
-00004240: 700a 2020 2020 2020 2020 3e3e 3e20 696d  p.        >>> im
-00004250: 706f 7274 2073 6369 7079 2e6e 6469 6d61  port scipy.ndima
-00004260: 6765 2061 7320 6e64 0a20 2020 2020 2020  ge as nd.       
-00004270: 203e 3e3e 2066 726f 6d20 6772 697a 6c69   >>> from grizli
-00004280: 2e75 7469 6c73 2069 6d70 6f72 7420 6d75  .utils import mu
-00004290: 6c74 6970 726f 6365 7373 696e 675f 6e64  ltiprocessing_nd
-000042a0: 6669 6c74 6572 0a20 2020 2020 2020 203e  filter.        >
-000042b0: 3e3e 2072 6e64 203d 206e 702e 7261 6e64  >> rnd = np.rand
-000042c0: 6f6d 2e6e 6f72 6d61 6c28 7369 7a65 3d28  om.normal(size=(
-000042d0: 3531 322c 3531 3229 290a 2020 2020 2020  512,512)).      
-000042e0: 2020 3e3e 3e20 7430 203d 2074 696d 652e    >>> t0 = time.
-000042f0: 7469 6d65 2829 0a20 2020 2020 2020 203e  time().        >
-00004300: 3e3e 2066 5f73 6572 6961 6c20 3d20 6e64  >> f_serial = nd
-00004310: 2e6d 6564 6961 6e5f 6669 6c74 6572 2872  .median_filter(r
-00004320: 6e64 2c20 7369 7a65 3d31 3029 0a20 2020  nd, size=10).   
-00004330: 2020 2020 203e 3e3e 2074 3120 3d20 7469       >>> t1 = ti
-00004340: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
-00004350: 2020 3e3e 3e20 665f 6d70 203d 206d 756c    >>> f_mp = mul
-00004360: 7469 7072 6f63 6573 7369 6e67 5f6e 6466  tiprocessing_ndf
-00004370: 696c 7465 7228 726e 642c 206e 642e 6d65  ilter(rnd, nd.me
-00004380: 6469 616e 5f66 696c 7465 722c 2073 697a  dian_filter, siz
-00004390: 653d 3130 2c0a 2020 2020 2020 2020 3e3e  e=10,.        >>
-000043a0: 3e20 2020 2020 2020 2020 2020 2020 2020  >               
-000043b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043c0: 2020 6375 746f 7574 5f73 697a 653d 3235    cutout_size=25
-000043d0: 362c 206e 5f70 726f 633d 3429 0a20 2020  6, n_proc=4).   
-000043e0: 2020 2020 203e 3e3e 2074 3220 3d20 7469       >>> t2 = ti
-000043f0: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
-00004400: 2020 3e3e 3e20 6e70 2e61 6c6c 636c 6f73    >>> np.allclos
-00004410: 6528 665f 7365 7269 616c 2c20 665f 6d70  e(f_serial, f_mp
-00004420: 290a 2020 2020 2020 2020 5472 7565 0a20  ).        True. 
-00004430: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
-00004440: 2866 2720 2073 6572 6961 6c3a 207b 2874  (f'  serial: {(t
-00004450: 312d 7430 292a 3130 3030 3a2e 3166 7d20  1-t0)*1000:.1f} 
-00004460: 6d73 2729 0a20 2020 2020 2020 203e 3e3e  ms').        >>>
-00004470: 2070 7269 6e74 2866 2770 6172 616c 6c65   print(f'paralle
-00004480: 6c3a 207b 2874 322d 7431 292a 3130 3030  l: {(t2-t1)*1000
-00004490: 3a2e 3166 7d20 6d73 2729 0a20 2020 2020  :.1f} ms').     
-000044a0: 2020 2020 2073 6572 6961 6c3a 2035 3733       serial: 573
-000044b0: 2e39 206d 730a 2020 2020 2020 2020 7061  .9 ms.        pa
-000044c0: 7261 6c6c 656c 3a20 3231 342e 3820 6d73  rallel: 214.8 ms
-000044d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000044e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044f0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-00004500: 2020 2222 220a 2020 2020 0a20 2020 2069    """.    .    i
-00004510: 6d70 6f72 7420 6d75 6c74 6970 726f 6365  mport multiproce
-00004520: 7373 696e 6720 6173 206d 700a 2020 2020  ssing as mp.    
-00004530: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-00004540: 2020 6672 6f6d 2074 7164 6d20 696d 706f    from tqdm impo
-00004550: 7274 2074 7164 6d0a 2020 2020 6578 6365  rt tqdm.    exce
-00004560: 7074 2049 6d70 6f72 7445 7272 6f72 3a0a  pt ImportError:.
-00004570: 2020 2020 2020 2020 7665 7262 6f73 6520          verbose 
-00004580: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00004590: 0a20 2020 2073 6820 3d20 6461 7461 2e73  .    sh = data.s
-000045a0: 6861 7065 0a20 2020 200a 2020 2020 6d73  hape.    .    ms
-000045b0: 6720 3d20 4e6f 6e65 0a20 2020 200a 2020  g = None.    .  
-000045c0: 2020 6966 2063 7574 6f75 745f 7369 7a65    if cutout_size
-000045d0: 203e 206e 702e 6d61 7828 7368 293a 0a20   > np.max(sh):. 
-000045e0: 2020 2020 2020 206d 7367 203d 2066 2763         msg = f'c
-000045f0: 7574 6f75 745f 7369 7a65 3d7b 6375 746f  utout_size={cuto
-00004600: 7574 5f73 697a 657d 2067 7265 6174 6572  ut_size} greater
-00004610: 2074 6861 6e20 696d 6167 6520 6469 6d65   than image dime
-00004620: 6e73 696f 6e73 2c20 7275 6e20 270a 2020  nsions, run '.  
-00004630: 2020 2020 2020 6d73 6720 2b3d 2066 2760        msg += f'`
-00004640: 7b66 696c 7465 725f 6675 6e63 7d60 2064  {filter_func}` d
-00004650: 6972 6563 746c 7927 0a20 2020 2065 6c69  irectly'.    eli
-00004660: 6620 6e5f 7072 6f63 203d 3d20 303a 0a20  f n_proc == 0:. 
-00004670: 2020 2020 2020 206d 7367 203d 2066 276e         msg = f'n
-00004680: 5f70 726f 6320 3d20 302c 2072 756e 2069  _proc = 0, run i
-00004690: 6e20 6120 7369 6e67 6c65 2063 6f6d 6d61  n a single comma
-000046a0: 6e64 270a 2020 2020 0a20 2020 2069 6620  nd'.    .    if 
-000046b0: 6d73 6720 6973 206e 6f74 204e 6f6e 653a  msg is not None:
-000046c0: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-000046d0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-000046e0: 2070 7269 6e74 286d 7367 290a 2020 2020   print(msg).    
-000046f0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00004700: 2066 696c 7465 7265 6420 3d20 6669 6c74   filtered = filt
-00004710: 6572 5f66 756e 6328 6461 7461 2c20 2a66  er_func(data, *f
-00004720: 696c 7465 725f 6172 6773 2c20 0a20 2020  ilter_args, .   
-00004730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004740: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-00004750: 3d73 697a 652c 2066 6f6f 7470 7269 6e74  =size, footprint
-00004760: 3d66 6f6f 7470 7269 6e74 290a 2020 2020  =footprint).    
-00004770: 2020 2020 7265 7475 726e 2066 696c 7465      return filte
-00004780: 7265 640a 2020 2020 0a20 2020 2023 2047  red.    .    # G
-00004790: 7269 6420 7369 7a65 0a20 2020 206e 7820  rid size.    nx 
-000047a0: 3d20 6461 7461 2e73 6861 7065 5b31 5d2f  = data.shape[1]/
-000047b0: 2f63 7574 6f75 745f 7369 7a65 2b31 0a20  /cutout_size+1. 
-000047c0: 2020 206e 7920 3d20 6461 7461 2e73 6861     ny = data.sha
-000047d0: 7065 5b30 5d2f 2f63 7574 6f75 745f 7369  pe[0]//cutout_si
-000047e0: 7a65 2b31 0a0a 2020 2020 2320 5061 6464  ze+1..    # Padd
-000047f0: 696e 670a 2020 2020 6966 2066 6f6f 7470  ing.    if footp
-00004800: 7269 6e74 2069 7320 6e6f 7420 4e6f 6e65  rint is not None
-00004810: 3a0a 2020 2020 2020 2020 6670 7368 203d  :.        fpsh =
-00004820: 2066 6f6f 7470 7269 6e74 2e73 6861 7065   footprint.shape
-00004830: 0a20 2020 2020 2020 2070 6164 203d 206e  .        pad = n
-00004840: 702e 6d61 7828 6670 7368 290a 2020 2020  p.max(fpsh).    
-00004850: 656c 6966 2073 697a 6520 6973 206e 6f74  elif size is not
-00004860: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
-00004870: 6164 203d 2073 697a 650a 2020 2020 656c  ad = size.    el
-00004880: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
-00004890: 6520 5661 6c75 6545 7272 6f72 2827 4569  e ValueError('Ei
-000048a0: 7468 6572 2073 697a 6520 6f72 2066 6f6f  ther size or foo
-000048b0: 7470 7269 6e74 206d 7573 7420 6265 2073  tprint must be s
-000048c0: 7065 6369 6669 6564 2729 0a20 2020 2020  pecified').     
-000048d0: 2020 200a 2020 2020 6966 206e 5f70 726f     .    if n_pro
-000048e0: 6320 3c20 303a 0a20 2020 2020 2020 206e  c < 0:.        n
-000048f0: 5f70 726f 6320 3d20 6d70 2e63 7075 5f63  _proc = mp.cpu_c
-00004900: 6f75 6e74 2829 0a0a 2020 2020 6e5f 7072  ount()..    n_pr
-00004910: 6f63 203d 206e 702e 6d69 6e69 6d75 6d28  oc = np.minimum(
-00004920: 6e5f 7072 6f63 2c20 6d70 2e63 7075 5f63  n_proc, mp.cpu_c
-00004930: 6f75 6e74 2829 290a 0a20 2020 2070 6f6f  ount())..    poo
-00004940: 6c20 3d20 6d70 2e50 6f6f 6c28 7072 6f63  l = mp.Pool(proc
-00004950: 6573 7365 733d 6e5f 7072 6f63 290a 2020  esses=n_proc).  
-00004960: 2020 6a6f 6273 203d 205b 5d0a 2020 2020    jobs = [].    
-00004970: 0a20 2020 2069 6620 6d61 736b 2069 7320  .    if mask is 
-00004980: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00004990: 2020 6461 7461 5f6d 6173 6b20 3d20 6461    data_mask = da
-000049a0: 7461 2a6d 6173 6b0a 2020 2020 656c 7365  ta*mask.    else
-000049b0: 3a0a 2020 2020 2020 2020 6461 7461 5f6d  :.        data_m
-000049c0: 6173 6b20 3d20 6461 7461 0a20 2020 2020  ask = data.     
-000049d0: 2020 200a 2020 2020 2320 4d61 6b65 2069     .    # Make i
-000049e0: 6d61 6765 2073 6c69 6365 730a 2020 2020  mage slices.    
-000049f0: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
-00004a00: 7829 3a0a 2020 2020 2020 2020 786d 6920  x):.        xmi 
-00004a10: 3d20 6e70 2e6d 6178 696d 756d 2830 2c20  = np.maximum(0, 
-00004a20: 692a 6375 746f 7574 5f73 697a 652d 7061  i*cutout_size-pa
-00004a30: 6429 0a20 2020 2020 2020 2078 6d61 203d  d).        xma =
-00004a40: 206e 702e 6d69 6e69 6d75 6d28 7368 5b31   np.minimum(sh[1
-00004a50: 5d2c 2028 692b 3129 2a63 7574 6f75 745f  ], (i+1)*cutout_
-00004a60: 7369 7a65 2b70 6164 290a 2020 2020 2020  size+pad).      
-00004a70: 2020 0a20 2020 2020 2020 2023 7072 696e    .        #prin
-00004a80: 7428 692c 2078 6d69 2c20 786d 6129 0a20  t(i, xmi, xma). 
-00004a90: 2020 2020 2020 2069 6620 6920 3d3d 2030         if i == 0
-00004aa0: 3a0a 2020 2020 2020 2020 2020 2020 736c  :.            sl
-00004ab0: 7820 3d20 736c 6963 6528 302c 2063 7574  x = slice(0, cut
-00004ac0: 6f75 745f 7369 7a65 290a 2020 2020 2020  out_size).      
-00004ad0: 2020 2020 2020 7830 203d 2030 0a20 2020        x0 = 0.   
-00004ae0: 2020 2020 2065 6c69 6620 6920 3c20 6e78       elif i < nx
-00004af0: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
-00004b00: 736c 7820 3d20 736c 6963 6528 7061 642c  slx = slice(pad,
-00004b10: 2063 7574 6f75 745f 7369 7a65 202b 2070   cutout_size + p
-00004b20: 6164 290a 2020 2020 2020 2020 2020 2020  ad).            
-00004b30: 7830 203d 2069 2a63 7574 6f75 745f 7369  x0 = i*cutout_si
-00004b40: 7a65 0a20 2020 2020 2020 2065 6c73 653a  ze.        else:
-00004b50: 0a20 2020 2020 2020 2020 2020 2073 6c78  .            slx
-00004b60: 203d 2073 6c69 6365 2870 6164 2c20 6375   = slice(pad, cu
-00004b70: 746f 7574 5f73 697a 6520 2b20 3129 0a20  tout_size + 1). 
-00004b80: 2020 2020 2020 2020 2020 2078 3020 3d20             x0 = 
-00004b90: 786d 692b 7061 640a 0a20 2020 2020 2020  xmi+pad..       
-00004ba0: 206e 7873 203d 2073 6c78 2e73 746f 7020   nxs = slx.stop 
-00004bb0: 2d20 736c 782e 7374 6172 740a 2020 2020  - slx.start.    
-00004bc0: 2020 2020 6f73 6c78 203d 2073 6c69 6365      oslx = slice
-00004bd0: 2878 302c 2078 302b 6e78 7329 0a20 2020  (x0, x0+nxs).   
-00004be0: 2020 2020 200a 2020 2020 2020 2020 666f       .        fo
-00004bf0: 7220 6a20 696e 2072 616e 6765 286e 7929  r j in range(ny)
-00004c00: 3a0a 2020 2020 2020 2020 2020 2020 796d  :.            ym
-00004c10: 6920 3d20 6e70 2e6d 6178 696d 756d 2830  i = np.maximum(0
-00004c20: 2c20 6a2a 6375 746f 7574 5f73 697a 6520  , j*cutout_size 
-00004c30: 2d20 7061 6429 0a20 2020 2020 2020 2020  - pad).         
-00004c40: 2020 2079 6d61 203d 206e 702e 6d69 6e69     yma = np.mini
-00004c50: 6d75 6d28 7368 5b30 5d2c 2028 6a2b 3129  mum(sh[0], (j+1)
-00004c60: 2a63 7574 6f75 745f 7369 7a65 202b 2070  *cutout_size + p
-00004c70: 6164 290a 2020 2020 2020 2020 2020 2020  ad).            
-00004c80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00004c90: 6a20 3d3d 2030 3a0a 2020 2020 2020 2020  j == 0:.        
-00004ca0: 2020 2020 2020 2020 736c 7920 3d20 736c          sly = sl
-00004cb0: 6963 6528 302c 2063 7574 6f75 745f 7369  ice(0, cutout_si
-00004cc0: 7a65 290a 2020 2020 2020 2020 2020 2020  ze).            
-00004cd0: 2020 2020 7930 203d 2030 0a20 2020 2020      y0 = 0.     
-00004ce0: 2020 2020 2020 2065 6c69 6620 6a20 3c20         elif j < 
-00004cf0: 6e79 2d31 3a0a 2020 2020 2020 2020 2020  ny-1:.          
-00004d00: 2020 2020 2020 736c 7920 3d20 736c 6963        sly = slic
-00004d10: 6528 7061 642c 2063 7574 6f75 745f 7369  e(pad, cutout_si
-00004d20: 7a65 202b 2070 6164 290a 2020 2020 2020  ze + pad).      
-00004d30: 2020 2020 2020 2020 2020 7930 203d 206a            y0 = j
-00004d40: 2a63 7574 6f75 745f 7369 7a65 0a20 2020  *cutout_size.   
-00004d50: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00004d60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00004d70: 6c79 203d 2073 6c69 6365 2870 6164 2c20  ly = slice(pad, 
-00004d80: 6375 746f 7574 5f73 697a 6520 2b20 3129  cutout_size + 1)
-00004d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004da0: 2079 3020 3d20 796d 692b 7061 640a 2020   y0 = ymi+pad.  
-00004db0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00004dc0: 2020 2020 2020 206e 7973 203d 2073 6c79         nys = sly
-00004dd0: 2e73 746f 7020 2d20 736c 792e 7374 6172  .stop - sly.star
-00004de0: 740a 2020 2020 2020 2020 2020 2020 6f73  t.            os
-00004df0: 6c79 203d 2073 6c69 6365 2879 302c 2079  ly = slice(y0, y
-00004e00: 302b 6e79 7329 0a20 2020 2020 2020 200a  0+nys).        .
-00004e10: 2020 2020 2020 2020 2020 2020 6375 7420              cut 
-00004e20: 3d20 6461 7461 5f6d 6173 6b5b 796d 693a  = data_mask[ymi:
-00004e30: 796d 612c 2078 6d69 3a78 6d61 5d0a 2020  yma, xmi:xma].  
-00004e40: 2020 2020 2020 2020 2020 6966 2063 7574            if cut
-00004e50: 2e6d 6178 2829 203d 3d20 303a 0a20 2020  .max() == 0:.   
-00004e60: 2020 2020 2020 2020 2020 2020 2023 7072               #pr
-00004e70: 696e 7428 6627 536b 6970 207b 786d 697d  int(f'Skip {xmi}
-00004e80: 207b 786d 617d 207b 796d 697d 207b 796d   {xma} {ymi} {ym
-00004e90: 617d 2729 0a20 2020 2020 2020 2020 2020  a}').           
-00004ea0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-00004eb0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00004ec0: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
-00004ed0: 6520 6a6f 6273 2066 6f72 2066 696c 7465  e jobs for filte
-00004ee0: 7269 6e67 2074 6865 2069 6d61 6765 2073  ring the image s
-00004ef0: 6c69 6365 730a 2020 2020 2020 2020 2020  lices.          
-00004f00: 2020 736c 6963 6573 203d 2028 6f73 6c79    slices = (osly
-00004f10: 2c20 6f73 6c78 2c20 736c 792c 2073 6c78  , oslx, sly, slx
-00004f20: 290a 2020 2020 2020 2020 2020 2020 5f61  ).            _a
-00004f30: 7267 7320 3d20 2863 7574 2c20 6669 6c74  rgs = (cut, filt
-00004f40: 6572 5f66 756e 632c 2073 6c69 6365 732c  er_func, slices,
-00004f50: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00004f60: 2020 2020 2020 2066 696c 7465 725f 6172         filter_ar
-00004f70: 6773 2c20 7369 7a65 2c20 666f 6f74 7072  gs, size, footpr
-00004f80: 696e 742c 206b 7761 7267 7329 0a20 2020  int, kwargs).   
-00004f90: 2020 2020 2020 2020 206a 6f62 732e 6170           jobs.ap
-00004fa0: 7065 6e64 2870 6f6f 6c2e 6170 706c 795f  pend(pool.apply_
-00004fb0: 6173 796e 6328 5f73 6c69 6365 5f6e 6466  async(_slice_ndf
-00004fc0: 696c 7465 722c 205f 6172 6773 2929 0a20  ilter, _args)). 
-00004fd0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00004fe0: 2320 436f 6c6c 6563 7420 7265 7375 6c74  # Collect result
-00004ff0: 730a 2020 2020 706f 6f6c 2e63 6c6f 7365  s.    pool.close
-00005000: 2829 0a0a 2020 2020 6669 6c74 6572 6564  ()..    filtered
-00005010: 203d 206e 702e 7a65 726f 735f 6c69 6b65   = np.zeros_like
-00005020: 2864 6174 6129 0a20 2020 200a 2020 2020  (data).    .    
-00005030: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00005040: 2020 2020 5f69 7465 7220 3d20 7471 646d      _iter = tqdm
-00005050: 286a 6f62 7329 0a20 2020 2065 6c73 653a  (jobs).    else:
-00005060: 0a20 2020 2020 2020 205f 6974 6572 203d  .        _iter =
-00005070: 206a 6f62 730a 2020 2020 2020 2020 0a20   jobs.        . 
-00005080: 2020 2066 6f72 2072 6573 2069 6e20 5f69     for res in _i
-00005090: 7465 723a 0a20 2020 2020 2020 2066 696c  ter:.        fil
-000050a0: 7465 7265 645f 692c 2073 6c69 6365 7320  tered_i, slices 
-000050b0: 3d20 7265 732e 6765 7428 7469 6d65 6f75  = res.get(timeou
-000050c0: 743d 7469 6d65 6f75 7429 0a20 2020 2020  t=timeout).     
-000050d0: 2020 2066 696c 7465 7265 645b 736c 6963     filtered[slic
-000050e0: 6573 5b3a 325d 5d20 2b3d 2066 696c 7465  es[:2]] += filte
-000050f0: 7265 645f 695b 736c 6963 6573 5b32 3a5d  red_i[slices[2:]
-00005100: 5d0a 0a20 2020 2072 6574 7572 6e20 6669  ]..    return fi
-00005110: 6c74 6572 6564 0a0a 6465 6620 7061 7273  ltered..def pars
-00005120: 655f 666c 745f 6669 6c65 7328 6669 6c65  e_flt_files(file
-00005130: 733d 5b5d 2c20 696e 666f 3d4e 6f6e 652c  s=[], info=None,
-00005140: 2075 6e69 7175 656e 616d 653d 4661 6c73   uniquename=Fals
-00005150: 652c 2075 7365 5f76 6973 6974 3d46 616c  e, use_visit=Fal
-00005160: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00005170: 2020 2020 2020 2020 6765 745f 666f 6f74          get_foot
-00005180: 7072 696e 743d 4661 6c73 652c 0a20 2020  print=False,.   
-00005190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051a0: 2074 7261 6e73 6c61 7465 3d7b 2741 4547   translate={'AEG
-000051b0: 4953 2d27 3a20 2761 6567 6973 2d27 2c0a  IS-': 'aegis-',.
-000051c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051e0: 2027 434f 534d 4f53 2d27 3a20 2763 6f73   'COSMOS-': 'cos
-000051f0: 6d6f 732d 272c 0a20 2020 2020 2020 2020  mos-',.         
-00005200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005210: 2020 2020 2020 2020 2747 4e47 5249 534d          'GNGRISM
-00005220: 273a 2027 676f 6f64 736e 2d27 2c0a 2020  ': 'goodsn-',.  
-00005230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005240: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00005250: 474f 4f44 532d 534f 5554 482d 273a 2027  GOODS-SOUTH-': '
-00005260: 676f 6f64 7373 2d27 2c0a 2020 2020 2020  goodss-',.      
-00005270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005280: 2020 2020 2020 2020 2020 2027 5544 532d             'UDS-
-00005290: 273a 2027 7564 732d 277d 2c0a 2020 2020  ': 'uds-'},.    
-000052a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000052b0: 7669 7369 745f 7370 6c69 745f 7368 6966  visit_split_shif
-000052c0: 743d 312e 352c 206d 6178 5f64 743d 3165  t=1.5, max_dt=1e
-000052d0: 392c 200a 2020 2020 2020 2020 2020 2020  9, .            
-000052e0: 2020 2020 2020 2020 7061 7468 3d27 2e2e          path='..
-000052f0: 2f52 4157 2729 3a0a 2020 2020 2222 2252  /RAW'):.    """R
-00005300: 6561 6420 6865 6164 6572 2069 6e66 6f72  ead header infor
-00005310: 6d61 7469 6f6e 2066 726f 6d20 6120 6c69  mation from a li
-00005320: 7374 206f 6620 6578 706f 7375 7265 7320  st of exposures 
-00005330: 616e 6420 7061 7273 6520 6f75 7420 6772  and parse out gr
-00005340: 6f75 7073 2062 6173 6564 206f 6e20 6669  oups based on fi
-00005350: 6c74 6572 2f74 6172 6765 742f 6f72 6965  lter/target/orie
-00005360: 6e74 6174 696f 6e2e 0a0a 2020 2020 5061  ntation...    Pa
-00005370: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00005380: 2d2d 2d2d 2d2d 2d0a 2020 2020 6669 6c65  -------.    file
-00005390: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
-000053a0: 204c 6973 7420 6f66 2065 7870 6f73 7572   List of exposur
-000053b0: 6520 6669 6c65 6e61 6d65 732e 2020 4966  e filenames.  If
-000053c0: 206e 6f74 2073 7065 6369 6669 6564 2c20   not specified, 
-000053d0: 7769 6c6c 2075 7365 2060 602a 666c 742e  will use ``*flt.
-000053e0: 6669 7473 6060 2e0a 0a20 2020 2069 6e66  fits``...    inf
-000053f0: 6f20 3a20 4e6f 6e65 206f 7220 607e 6173  o : None or `~as
-00005400: 7472 6f70 792e 7461 626c 652e 5461 626c  tropy.table.Tabl
-00005410: 6560 0a20 2020 2020 2020 204f 7574 7075  e`.        Outpu
-00005420: 7420 6672 6f6d 2060 7e67 7269 7a6c 692e  t from `~grizli.
-00005430: 7574 696c 732e 6765 745f 666c 745f 696e  utils.get_flt_in
-00005440: 666f 602e 0a20 2020 2020 2020 200a 2020  fo`..        .  
-00005450: 2020 756e 6971 7565 6e61 6d65 203a 2062    uniquename : b
-00005460: 6f6f 6c0a 2020 2020 2020 2020 4966 2054  ool.        If T
-00005470: 7275 652c 2074 6865 6e20 7370 6c69 7420  rue, then split 
-00005480: 6576 6572 7974 6869 6e67 2062 7920 7072  everything by pr
-00005490: 6f67 7261 6d20 4944 2061 6e64 2076 6973  ogram ID and vis
-000054a0: 6974 206e 616d 652e 2020 4966 0a20 2020  it name.  If.   
-000054b0: 2020 2020 2046 616c 7365 2c20 7468 656e       False, then
-000054c0: 206a 7573 7420 6772 6f75 7020 6279 2074   just group by t
-000054d0: 6172 676e 616d 652f 6669 6c74 6572 2f70  argname/filter/p
-000054e0: 615f 7633 2e0a 0a20 2020 2075 7365 5f76  a_v3...    use_v
-000054f0: 6973 6974 203a 2062 6f6f 6c0a 2020 2020  isit : bool.    
-00005500: 2020 2020 466f 7220 7061 7261 6c6c 656c      For parallel
-00005510: 206f 6273 6572 7661 7469 6f6e 7320 7769   observations wi
-00005520: 7468 2060 6074 6172 676e 616d 653d 2741  th ``targname='A
-00005530: 4e59 2760 602c 2075 7365 2074 6865 2066  NY'``, use the f
-00005540: 696c 656e 616d 650a 2020 2020 2020 2020  ilename.        
-00005550: 7570 2074 6f20 7468 6520 7669 7369 7420  up to the visit 
-00005560: 4944 2061 7320 7468 6520 7461 7267 6574  ID as the target
-00005570: 206e 616d 652e 2020 466f 7220 6578 616d   name.  For exam
-00005580: 706c 653a 0a0a 2020 2020 2020 2020 2020  ple:..          
-00005590: 2020 3e3e 3e20 666c 6320 3d20 276a 6268    >>> flc = 'jbh
-000055a0: 6a36 3464 3871 5f66 6c63 2e66 6974 7327  j64d8q_flc.fits'
-000055b0: 0a20 2020 2020 2020 2020 2020 203e 3e3e  .            >>>
-000055c0: 2076 6973 6974 5f74 6172 676e 616d 6520   visit_targname 
-000055d0: 3d20 666c 635b 3a36 5d0a 2020 2020 2020  = flc[:6].      
-000055e0: 2020 2020 2020 3e3e 3e20 7072 696e 7428        >>> print(
-000055f0: 7669 7369 745f 7461 7267 6e61 6d65 290a  visit_targname).
-00005600: 2020 2020 2020 2020 2020 2020 6a62 686a              jbhj
-00005610: 3634 0a0a 2020 2020 2020 2020 4966 2046  64..        If F
-00005620: 616c 7365 2c20 6765 6e65 7261 7465 2061  alse, generate a
-00005630: 2074 6172 676e 616d 6520 666f 7220 7061   targname for pa
-00005640: 7261 6c6c 656c 206f 6273 6572 7661 7469  rallel observati
-00005650: 6f6e 7320 6261 7365 6420 6f6e 2074 6865  ons based on the
-00005660: 0a20 2020 2020 2020 2070 6f69 6e74 696e  .        pointin
-00005670: 6720 636f 6f72 6469 6e61 7465 7320 7573  g coordinates us
-00005680: 696e 6720 6072 6164 6563 5f74 6f5f 7461  ing `radec_to_ta
-00005690: 7267 6e61 6d65 602e 2020 5573 6520 7468  rgname`.  Use th
-000056a0: 6973 206b 6579 776f 7264 0a20 2020 2020  is keyword.     
-000056b0: 2020 2066 6f72 2064 6974 6865 7265 6420     for dithered 
-000056c0: 7061 7261 6c6c 656c 7320 6c69 6b65 2033  parallels like 3
-000056d0: 442d 4853 5420 2f20 474c 4153 5320 6275  D-HST / GLASS bu
-000056e0: 7420 7365 7420 746f 2046 616c 7365 2066  t set to False f
-000056f0: 6f72 0a20 2020 2020 2020 2075 6e64 6974  or.        undit
-00005700: 6865 7265 6420 7061 7261 6c6c 656c 7320  hered parallels 
-00005710: 6c69 6b65 2057 4953 502e 2020 5368 6f75  like WISP.  Shou
-00005720: 6c64 2061 6c73 6f20 6765 6e65 7261 6c6c  ld also generall
-00005730: 7920 6265 2075 7365 6420 7769 7468 0a20  y be used with. 
-00005740: 2020 2020 2020 2060 6075 6e69 7175 656e         ``uniquen
-00005750: 616d 653d 4661 6c73 6560 6020 6f74 6865  ame=False`` othe
-00005760: 7277 6973 6520 6765 6e65 7261 7465 7320  rwise generates 
-00005770: 6e61 6d65 7320 7468 6174 2061 7265 2061  names that are a
-00005780: 2062 6974 200a 2020 2020 2020 2020 7265   bit .        re
-00005790: 6475 6e64 616e 743a 0a0a 2020 2020 2020  dundant:..      
-000057a0: 2020 2020 2020 2b2d 2d2d 2d2d 2d2d 2d2d        +---------
-000057b0: 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d  -----+----------
-000057c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000057d0: 2d2b 0a20 2020 2020 2020 2020 2020 207c  -+.            |
-000057e0: 2060 756e 6971 7565 6e61 6d65 6020 7c20   `uniquename` | 
-000057f0: 4f75 7470 7574 2054 6172 676e 616d 6520  Output Targname 
-00005800: 2020 2020 2020 2020 2020 7c0a 2020 2020            |.    
-00005810: 2020 2020 2020 2020 2b3d 3d3d 3d3d 3d3d          +=======
-00005820: 3d3d 3d3d 3d3d 3d2b 3d3d 3d3d 3d3d 3d3d  =======+========
-00005830: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005840: 3d3d 3d2b 0a20 2020 2020 2020 2020 2020  ===+.           
-00005850: 207c 2020 2020 2054 7275 6520 2020 2020   |     True     
-00005860: 7c20 6a62 686a 3435 2d62 686a 2d34 352d  | jbhj45-bhj-45-
-00005870: 3138 302e 302d 4638 3134 5720 7c0a 2020  180.0-F814W |.  
-00005880: 2020 2020 2020 2020 2020 2b2d 2d2d 2d2d            +-----
-00005890: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
-000058a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000058b0: 2d2d 2d2d 2d2b 0a20 2020 2020 2020 2020  -----+.         
-000058c0: 2020 207c 2020 2020 2046 616c 7365 2020     |     False  
-000058d0: 2020 7c20 6a62 686a 3435 2d31 3830 2e30    | jbhj45-180.0
-000058e0: 2d46 3831 3457 2020 2020 2020 2020 7c0a  -F814W        |.
-000058f0: 2020 2020 2020 2020 2020 2020 2b2d 2d2d              +---
-00005900: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d  -----------+----
-00005910: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00005920: 2d2d 2d2d 2d2d 2d2b 0a0a 2020 2020 7472  -------+..    tr
-00005930: 616e 736c 6174 6520 3a20 6469 6374 0a20  anslate : dict. 
-00005940: 2020 2020 2020 2054 7261 6e73 6c61 7469         Translati
-00005950: 6f6e 2064 6963 7469 6f6e 6172 7920 746f  on dictionary to
-00005960: 206d 6f64 6966 7920 5441 5247 4e41 4d45   modify TARGNAME
-00005970: 206b 6579 776f 7264 7320 746f 2073 6f6d   keywords to som
-00005980: 6520 6f74 6865 720a 2020 2020 2020 2020  e other.        
-00005990: 7661 6c75 652e 2020 5573 6564 206c 696b  value.  Used lik
-000059a0: 653a 0a0a 2020 2020 2020 2020 2020 2020  e:..            
-000059b0: 3e3e 3e20 7461 7267 6e61 6d65 203d 2027  >>> targname = '
-000059c0: 474f 4f44 532d 534f 5554 482d 3130 270a  GOODS-SOUTH-10'.
-000059d0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-000059e0: 7472 616e 736c 6174 6520 3d20 7b27 474f  translate = {'GO
-000059f0: 4f44 532d 534f 5554 482d 273a 2027 676f  ODS-SOUTH-': 'go
-00005a00: 6f64 7373 2d27 7d0a 2020 2020 2020 2020  odss-'}.        
-00005a10: 2020 2020 3e3e 3e20 666f 7220 6b20 696e      >>> for k in
-00005a20: 2074 7261 6e73 6c61 7465 3a0a 2020 2020   translate:.    
-00005a30: 2020 2020 2020 2020 3e3e 3e20 2020 2020          >>>     
-00005a40: 7461 7267 6e61 6d65 203d 2074 6172 676e  targname = targn
-00005a50: 616d 652e 7265 706c 6163 6528 6b2c 2074  ame.replace(k, t
-00005a60: 7261 6e73 6c61 7465 5b6b 5d29 0a20 2020  ranslate[k]).   
-00005a70: 2020 2020 2020 2020 203e 3e3e 2070 7269           >>> pri
-00005a80: 6e74 2874 6172 676e 616d 6529 0a20 2020  nt(targname).   
-00005a90: 2020 2020 2020 2020 2067 6f6f 6473 732d           goodss-
-00005aa0: 3130 0a20 2020 200a 2020 2020 7669 7369  10.    .    visi
-00005ab0: 745f 7370 6c69 745f 7368 6966 7420 3a20  t_split_shift : 
-00005ac0: 666c 6f61 740a 2020 2020 2020 2020 5365  float.        Se
-00005ad0: 7061 7261 7469 6f6e 2069 6e20 6060 6172  paration in ``ar
-00005ae0: 636d 696e 6060 2062 6579 6f6e 6420 7768  cmin`` beyond wh
-00005af0: 6963 6820 6578 706f 7375 7265 7320 696e  ich exposures in
-00005b00: 2061 2067 726f 7570 2061 7265 2073 706c   a group are spl
-00005b10: 6974 200a 2020 2020 2020 2020 696e 746f  it .        into
-00005b20: 2073 6570 6172 6174 6520 7669 7369 7473   separate visits
-00005b30: 2e0a 2020 2020 0a20 2020 2070 6174 6820  ..    .    path 
-00005b40: 3a20 7374 720a 2020 2020 2020 2020 5041  : str.        PA
-00005b50: 5448 2074 6f20 7365 6172 6368 2066 6f72  TH to search for
-00005b60: 2060 666c 7460 2066 696c 6573 2069 6620   `flt` files if 
-00005b70: 6060 696e 666f 6060 206e 6f74 2070 726f  ``info`` not pro
-00005b80: 7669 6465 640a 2020 2020 0a20 2020 2052  vided.    .    R
-00005b90: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-00005ba0: 2d2d 0a20 2020 206f 7574 7075 745f 6c69  --.    output_li
-00005bb0: 7374 203a 2064 6963 740a 2020 2020 2020  st : dict.      
-00005bc0: 2020 4469 6374 696f 6e61 7279 2073 706c    Dictionary spl
-00005bd0: 6974 2062 7920 7461 7267 6574 2f66 696c  it by target/fil
-00005be0: 7465 722f 7061 5f76 332e 204b 6579 7320  ter/pa_v3. Keys 
-00005bf0: 6172 6520 6465 7269 7665 6420 7669 7369  are derived visi
-00005c00: 740a 2020 2020 2020 2020 7072 6f64 7563  t.        produc
-00005c10: 7420 6e61 6d65 7320 616e 6420 7661 6c75  t names and valu
-00005c20: 6573 2061 7265 206c 6973 7473 206f 6620  es are lists of 
-00005c30: 6578 706f 7375 7265 2066 696c 656e 616d  exposure filenam
-00005c40: 6573 2063 6f72 7265 7370 6f6e 6469 6e67  es corresponding
-00005c50: 0a20 2020 2020 2020 2074 6f20 7468 6174  .        to that
-00005c60: 2073 6574 2e20 4b65 7973 2061 7265 2067   set. Keys are g
-00005c70: 656e 6572 6174 6564 2077 6974 6820 7468  enerated with th
-00005c80: 6520 666f 726d 6174 7320 6c69 6b65 3a0a  e formats like:.
-00005c90: 0a20 2020 2020 2020 2020 2020 203e 3e3e  .            >>>
-00005ca0: 2074 6172 676e 616d 6520 3d20 276d 6163   targname = 'mac
-00005cb0: 7331 3134 392b 3232 3233 270a 2020 2020  s1149+2223'.    
-00005cc0: 2020 2020 2020 2020 3e3e 3e20 7061 5f76          >>> pa_v
-00005cd0: 3320 3d20 3332 2e30 0a20 2020 2020 2020  3 = 32.0.       
-00005ce0: 2020 2020 203e 3e3e 2066 696c 7465 7220       >>> filter 
-00005cf0: 3d20 2766 3134 3077 270a 2020 2020 2020  = 'f140w'.      
-00005d00: 2020 2020 2020 3e3e 3e20 666c 745f 6669        >>> flt_fi
-00005d10: 6c65 6e61 6d65 203d 2027 6963 6135 3231  lename = 'ica521
-00005d20: 6e61 715f 666c 742e 6669 7473 270a 2020  naq_flt.fits'.  
-00005d30: 2020 2020 2020 2020 2020 3e3e 3e20 7072            >>> pr
-00005d40: 6f70 7374 7220 3d20 666c 745f 6669 6c65  opstr = flt_file
-00005d50: 6e61 6d65 5b31 3a34 5d0a 2020 2020 2020  name[1:4].      
-00005d60: 2020 2020 2020 3e3e 3e20 7669 7369 7420        >>> visit 
-00005d70: 3d20 666c 745f 6669 6c65 6e61 6d65 5b34  = flt_filename[4
-00005d80: 3a36 5d0a 2020 2020 2020 2020 2020 2020  :6].            
-00005d90: 3e3e 3e20 2320 756e 6971 7565 6e61 6d65  >>> # uniquename
-00005da0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00005db0: 2020 2020 203e 3e3e 2070 7269 6e74 2827       >>> print('
-00005dc0: 7b30 7d2d 7b31 3a30 352e 3166 7d2d 7b32  {0}-{1:05.1f}-{2
-00005dd0: 7d27 2e66 6f72 6d61 7428 7461 7267 6e61  }'.format(targna
-00005de0: 6d65 2c20 7061 5f76 332c 2066 696c 7465  me, pa_v3, filte
-00005df0: 7229 290a 2020 2020 2020 2020 2020 2020  r)).            
-00005e00: 6d61 6373 3131 3439 2e36 2b32 3232 332d  macs1149.6+2223-
-00005e10: 3033 322e 302d 6631 3430 770a 2020 2020  032.0-f140w.    
-00005e20: 2020 2020 2020 2020 3e3e 3e20 2320 756e          >>> # un
-00005e30: 6971 7565 6e61 6d65 203d 2054 7275 650a  iquename = True.
-00005e40: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-00005e50: 7072 696e 7428 277b 307d 2d7b 313a 3373  print('{0}-{1:3s
-00005e60: 7d2d 7b32 3a32 737d 2d7b 333a 3035 2e31  }-{2:2s}-{3:05.1
-00005e70: 667d 2d7b 343a 737d 272e 666f 726d 6174  f}-{4:s}'.format
-00005e80: 2874 6172 676e 616d 652c 2070 726f 7073  (targname, props
-00005e90: 7472 2c20 7669 7369 742c 2070 615f 7633  tr, visit, pa_v3
-00005ea0: 2c20 6669 6c74 6572 2929 0a20 2020 2020  , filter)).     
-00005eb0: 2020 2020 2020 206d 6163 7331 3134 392e         macs1149.
-00005ec0: 362b 3232 3233 2d63 6135 2d32 312d 3033  6+2223-ca5-21-03
-00005ed0: 322e 302d 6631 3430 770a 0a20 2020 2066  2.0-f140w..    f
-00005ee0: 696c 7465 725f 6c69 7374 203a 2064 6963  ilter_list : dic
-00005ef0: 740a 2020 2020 2020 2020 4e65 7374 6564  t.        Nested
-00005f00: 2064 6963 7469 6f6e 6172 7920 7370 6c69   dictionary spli
-00005f10: 7420 6279 2066 696c 7465 7220 616e 6420  t by filter and 
-00005f20: 7468 656e 2050 415f 5633 2e20 2054 6869  then PA_V3.  Thi
-00005f30: 7320 7368 6f75 6c64 6e27 740a 2020 2020  s shouldn't.    
-00005f40: 2020 2020 6265 2075 7365 6420 6966 2065      be used if e
-00005f50: 7870 6f73 7572 6573 2066 726f 6d20 636f  xposures from co
-00005f60: 6d70 6c65 7465 6c79 2064 6973 6a6f 696e  mpletely disjoin
-00005f70: 7420 706f 696e 7469 6e67 7320 6172 6520  t pointings are 
-00005f80: 7374 6f72 6564 0a20 2020 2020 2020 2069  stored.        i
-00005f90: 6e20 7468 6520 7361 6d65 2077 6f72 6b69  n the same worki
-00005fa0: 6e67 2064 6972 6563 746f 7279 2e0a 2020  ng directory..  
-00005fb0: 2020 2222 220a 0a20 2020 2069 6620 696e    """..    if in
-00005fc0: 666f 2069 7320 4e6f 6e65 3a0a 2020 2020  fo is None:.    
-00005fd0: 2020 2020 6966 206e 6f74 2066 696c 6573      if not files
-00005fe0: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-00005ff0: 6c65 7320 3d20 676c 6f62 2e67 6c6f 6228  les = glob.glob(
-00006000: 6f73 2e70 6174 682e 6a6f 696e 2870 6174  os.path.join(pat
-00006010: 6829 2c20 272a 666c 742e 6669 7473 2729  h), '*flt.fits')
-00006020: 0a0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
-00006030: 2866 696c 6573 2920 3d3d 2030 3a0a 2020  (files) == 0:.  
-00006040: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00006050: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-00006060: 696e 666f 203d 2067 6574 5f66 6c74 5f69  info = get_flt_i
-00006070: 6e66 6f28 6669 6c65 7329 0a20 2020 2065  nfo(files).    e
-00006080: 6c73 653a 0a20 2020 2020 2020 2069 6e66  lse:.        inf
-00006090: 6f20 3d20 696e 666f 2e63 6f70 7928 290a  o = info.copy().
-000060a0: 0a20 2020 2066 6f72 2063 2069 6e20 696e  .    for c in in
-000060b0: 666f 2e63 6f6c 6e61 6d65 733a 0a20 2020  fo.colnames:.   
-000060c0: 2020 2020 2069 6620 6e6f 7420 632e 6973       if not c.is
-000060d0: 6c6f 7765 7228 293a 0a20 2020 2020 2020  lower():.       
-000060e0: 2020 2020 2069 6e66 6f2e 7265 6e61 6d65       info.rename
-000060f0: 5f63 6f6c 756d 6e28 632c 2063 2e6c 6f77  _column(c, c.low
-00006100: 6572 2829 290a 0a20 2020 2069 6620 2765  er())..    if 'e
-00006110: 7870 7374 6172 7427 206e 6f74 2069 6e20  xpstart' not in 
-00006120: 696e 666f 2e63 6f6c 6e61 6d65 733a 0a20  info.colnames:. 
-00006130: 2020 2020 2020 2069 6e66 6f5b 2765 7870         info['exp
-00006140: 7374 6172 7427 5d20 3d20 696e 666f 5b27  start'] = info['
-00006150: 6578 7074 696d 6527 5d2a 302e 0a0a 2020  exptime']*0...  
-00006160: 2020 736f 203d 206e 702e 6172 6773 6f72    so = np.argsor
-00006170: 7428 696e 666f 5b27 6578 7073 7461 7274  t(info['expstart
-00006180: 275d 290a 2020 2020 696e 666f 203d 2069  ']).    info = i
-00006190: 6e66 6f5b 736f 5d0a 0a20 2020 2023 7061  nfo[so]..    #pa
-000061a0: 5f76 3320 3d20 6e70 2e72 6f75 6e64 2869  _v3 = np.round(i
-000061b0: 6e66 6f5b 2770 615f 7633 275d 2a31 3029  nfo['pa_v3']*10)
-000061c0: 2f31 3020 2520 3336 302e 0a20 2020 2070  /10 % 360..    p
-000061d0: 615f 7633 203d 206e 702e 726f 756e 6428  a_v3 = np.round(
-000061e0: 6e70 2e72 6f75 6e64 2869 6e66 6f5b 2770  np.round(info['p
-000061f0: 615f 7633 275d 2c20 6465 6369 6d61 6c73  a_v3'], decimals
-00006200: 3d31 2929 2025 2033 3630 2e0a 0a20 2020  =1)) % 360...   
-00006210: 2074 6172 6765 745f 6c69 7374 203d 205b   target_list = [
-00006220: 5d0a 2020 2020 666f 7220 6920 696e 2072  ].    for i in r
-00006230: 616e 6765 286c 656e 2869 6e66 6f29 293a  ange(len(info)):
-00006240: 0a20 2020 2020 2020 2023 2052 6570 6c61  .        # Repla
-00006250: 6365 2041 4e59 2074 6172 6765 7473 2077  ce ANY targets w
-00006260: 6974 6820 4a52 6852 6d52 732d 4464 446d  ith JRhRmRs-DdDm
-00006270: 4473 0a20 2020 2020 2020 2069 6620 696e  Ds.        if in
-00006280: 666f 5b27 7461 7267 6e61 6d65 275d 5b69  fo['targname'][i
-00006290: 5d20 3d3d 2027 414e 5927 3a0a 2020 2020  ] == 'ANY':.    
-000062a0: 2020 2020 2020 2020 6966 2075 7365 5f76          if use_v
-000062b0: 6973 6974 3a0a 2020 2020 2020 2020 2020  isit:.          
-000062c0: 2020 2020 2020 6e65 775f 7461 7267 6e61        new_targna
-000062d0: 6d65 203d 2069 6e66 6f5b 2766 696c 6527  me = info['file'
-000062e0: 5d5b 695d 5b3a 365d 0a20 2020 2020 2020  ][i][:6].       
-000062f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00006300: 2020 2020 2020 2020 2020 206e 6577 5f74             new_t
-00006310: 6172 676e 616d 6520 3d20 2770 6172 2d27  argname = 'par-'
-00006320: 2b72 6164 6563 5f74 6f5f 7461 7267 6e61  +radec_to_targna
-00006330: 6d65 2872 613d 696e 666f 5b27 7261 5f74  me(ra=info['ra_t
-00006340: 6172 6727 5d5b 695d 2c0a 2020 2020 2020  arg'][i],.      
-00006350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006370: 2020 2020 2020 2064 6563 3d69 6e66 6f5b         dec=info[
-00006380: 2764 6563 5f74 6172 6727 5d5b 695d 290a  'dec_targ'][i]).
-00006390: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
-000063a0: 6765 745f 6c69 7374 2e61 7070 656e 6428  get_list.append(
-000063b0: 6e65 775f 7461 7267 6e61 6d65 2e6c 6f77  new_targname.low
-000063c0: 6572 2829 290a 2020 2020 2020 2020 656c  er()).        el
-000063d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000063e0: 7461 7267 6574 5f6c 6973 742e 6170 7065  target_list.appe
-000063f0: 6e64 2869 6e66 6f5b 2774 6172 676e 616d  nd(info['targnam
-00006400: 6527 5d5b 695d 290a 0a20 2020 2074 6172  e'][i])..    tar
-00006410: 6765 745f 6c69 7374 203d 206e 702e 6172  get_list = np.ar
-00006420: 7261 7928 7461 7267 6574 5f6c 6973 7429  ray(target_list)
-00006430: 0a20 2020 200a 2020 2020 5f70 726f 675f  .    .    _prog_
-00006440: 6964 7320 3d20 5b5d 0a20 2020 2076 6973  ids = [].    vis
-00006450: 6974 7320 3d20 5b5d 0a20 2020 200a 2020  its = [].    .  
-00006460: 2020 666f 7220 6669 6c65 2069 6e20 696e    for file in in
-00006470: 666f 5b27 6669 6c65 275d 3a0a 2020 2020  fo['file']:.    
-00006480: 2020 2020 6266 696c 6520 3d20 6f73 2e70      bfile = os.p
-00006490: 6174 682e 6261 7365 6e61 6d65 2866 696c  ath.basename(fil
-000064a0: 6529 0a20 2020 2020 2020 2069 6620 6266  e).        if bf
-000064b0: 696c 652e 7374 6172 7473 7769 7468 2827  ile.startswith('
-000064c0: 6a77 2729 3a0a 2020 2020 2020 2020 2020  jw'):.          
-000064d0: 2020 5f70 726f 675f 6964 732e 6170 7065    _prog_ids.appe
-000064e0: 6e64 2862 6669 6c65 5b32 3a37 5d29 0a20  nd(bfile[2:7]). 
-000064f0: 2020 2020 2020 2020 2020 2076 6973 6974             visit
-00006500: 732e 6170 7065 6e64 2862 6669 6c65 5b37  s.append(bfile[7
-00006510: 3a31 305d 290a 2020 2020 2020 2020 656c  :10]).        el
-00006520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006530: 5f70 726f 675f 6964 732e 6170 7065 6e64  _prog_ids.append
-00006540: 2862 6669 6c65 5b31 3a34 5d29 0a20 2020  (bfile[1:4]).   
-00006550: 2020 2020 2020 2020 2076 6973 6974 732e           visits.
-00006560: 6170 7065 6e64 2862 6669 6c65 5b34 3a36  append(bfile[4:6
-00006570: 5d29 0a20 2020 200a 2020 2020 7669 7369  ]).    .    visi
-00006580: 7473 203d 206e 702e 6172 7261 7928 7669  ts = np.array(vi
-00006590: 7369 7473 290a 2020 2020 0a20 2020 2069  sits).    .    i
-000065a0: 6e66 6f5b 2770 726f 6749 4473 275d 203d  nfo['progIDs'] =
-000065b0: 205f 7072 6f67 5f69 6473 0a0a 2020 2020   _prog_ids..    
-000065c0: 7072 6f67 4944 7320 3d20 6e70 2e75 6e69  progIDs = np.uni
-000065d0: 7175 6528 696e 666f 5b27 7072 6f67 4944  que(info['progID
-000065e0: 7327 5d29 0a20 2020 2064 6174 6573 203d  s']).    dates =
-000065f0: 206e 702e 6172 7261 7928 5b27 272e 6a6f   np.array([''.jo
-00006600: 696e 2864 6174 652e 7370 6c69 7428 272d  in(date.split('-
-00006610: 2729 5b31 3a5d 290a 2020 2020 2020 2020  ')[1:]).        
-00006620: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00006630: 7220 6461 7465 2069 6e20 696e 666f 5b27  r date in info['
-00006640: 6461 7465 2d6f 6273 275d 5d29 0a0a 2020  date-obs']])..  
-00006650: 2020 7461 7267 6574 7320 3d20 6e70 2e75    targets = np.u
-00006660: 6e69 7175 6528 7461 7267 6574 5f6c 6973  nique(target_lis
-00006670: 7429 0a0a 2020 2020 6f75 7470 7574 5f6c  t)..    output_l
-00006680: 6973 7420 3d20 5b5d 2020 2320 4f72 6465  ist = []  # Orde
-00006690: 7265 6444 6963 7428 290a 2020 2020 6669  redDict().    fi
-000066a0: 6c74 6572 5f6c 6973 7420 3d20 4f72 6465  lter_list = Orde
-000066b0: 7265 6444 6963 7428 290a 0a20 2020 2066  redDict()..    f
-000066c0: 6f72 2066 696c 7465 7220 696e 206e 702e  or filter in np.
-000066d0: 756e 6971 7565 2869 6e66 6f5b 2766 696c  unique(info['fil
-000066e0: 7465 7227 5d29 3a0a 2020 2020 2020 2020  ter']):.        
-000066f0: 6669 6c74 6572 5f6c 6973 745b 6669 6c74  filter_list[filt
-00006700: 6572 5d20 3d20 4f72 6465 7265 6444 6963  er] = OrderedDic
-00006710: 7428 290a 2020 2020 2020 2020 616e 676c  t().        angl
-00006720: 6573 203d 206e 702e 756e 6971 7565 2870  es = np.unique(p
-00006730: 615f 7633 5b28 696e 666f 5b27 6669 6c74  a_v3[(info['filt
-00006740: 6572 275d 203d 3d20 6669 6c74 6572 295d  er'] == filter)]
-00006750: 290a 2020 2020 2020 2020 666f 7220 616e  ).        for an
-00006760: 676c 6520 696e 2061 6e67 6c65 733a 0a20  gle in angles:. 
-00006770: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-00006780: 725f 6c69 7374 5b66 696c 7465 725d 5b61  r_list[filter][a
-00006790: 6e67 6c65 5d20 3d20 5b5d 0a0a 2020 2020  ngle] = []..    
-000067a0: 666f 7220 7461 7267 6574 2069 6e20 7461  for target in ta
-000067b0: 7267 6574 733a 0a20 2020 2020 2020 2023  rgets:.        #
-000067c0: 2033 442d 4853 5420 7461 7267 6e61 6d65   3D-HST targname
-000067d0: 2074 7261 6e73 6c61 7469 6f6e 730a 2020   translations.  
-000067e0: 2020 2020 2020 7461 7267 6574 5f75 7365        target_use
-000067f0: 203d 2074 6172 6765 740a 2020 2020 2020   = target.      
-00006800: 2020 666f 7220 6b65 7920 696e 2074 7261    for key in tra
-00006810: 6e73 6c61 7465 2e6b 6579 7328 293a 0a20  nslate.keys():. 
-00006820: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-00006830: 745f 7573 6520 3d20 7461 7267 6574 5f75  t_use = target_u
-00006840: 7365 2e72 6570 6c61 6365 286b 6579 2c20  se.replace(key, 
-00006850: 7472 616e 736c 6174 655b 6b65 795d 290a  translate[key]).
-00006860: 0a20 2020 2020 2020 2023 2070 6164 2069  .        # pad i
-00006870: 203c 2031 3020 7769 7468 207a 6572 6f0a   < 10 with zero.
-00006880: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00006890: 696e 2074 7261 6e73 6c61 7465 2e6b 6579  in translate.key
-000068a0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-000068b0: 2069 6620 7472 616e 736c 6174 655b 6b65   if translate[ke
-000068c0: 795d 2069 6e20 7461 7267 6574 5f75 7365  y] in target_use
-000068d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000068e0: 2020 7370 6c20 3d20 7461 7267 6574 5f75    spl = target_u
-000068f0: 7365 2e73 706c 6974 2827 2d27 290a 2020  se.split('-').  
-00006900: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00006910: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00006920: 2020 2020 2020 2069 6620 2869 6e74 2873         if (int(s
-00006930: 706c 5b2d 315d 2920 3c20 3130 2920 2620  pl[-1]) < 10) & 
-00006940: 286c 656e 2873 706c 5b2d 315d 2920 3d3d  (len(spl[-1]) ==
-00006950: 2031 293a 0a20 2020 2020 2020 2020 2020   1):.           
-00006960: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-00006970: 5b2d 315d 203d 2027 7b30 3a30 3264 7d27  [-1] = '{0:02d}'
-00006980: 2e66 6f72 6d61 7428 696e 7428 7370 6c5b  .format(int(spl[
-00006990: 2d31 5d29 290a 2020 2020 2020 2020 2020  -1])).          
-000069a0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-000069b0: 7267 6574 5f75 7365 203d 2027 2d27 2e6a  rget_use = '-'.j
-000069c0: 6f69 6e28 7370 6c29 0a20 2020 2020 2020  oin(spl).       
-000069d0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-000069e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000069f0: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
-00006a00: 2020 2066 6f72 2066 696c 7465 7220 696e     for filter in
-00006a10: 206e 702e 756e 6971 7565 2869 6e66 6f5b   np.unique(info[
-00006a20: 2766 696c 7465 7227 5d5b 2874 6172 6765  'filter'][(targe
-00006a30: 745f 6c69 7374 203d 3d20 7461 7267 6574  t_list == target
-00006a40: 295d 293a 0a20 2020 2020 2020 2020 2020  )]):.           
-00006a50: 2061 6e67 6c65 7320 3d20 6e70 2e75 6e69   angles = np.uni
-00006a60: 7175 6528 7061 5f76 335b 2869 6e66 6f5b  que(pa_v3[(info[
-00006a70: 2766 696c 7465 7227 5d20 3d3d 2066 696c  'filter'] == fil
-00006a80: 7465 7229 2026 0a20 2020 2020 2020 2020  ter) &.         
-00006a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006aa0: 2020 2020 2020 2028 7461 7267 6574 5f6c         (target_l
-00006ab0: 6973 7420 3d3d 2074 6172 6765 7429 5d29  ist == target)])
-00006ac0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00006ad0: 2061 6e67 6c65 2069 6e20 616e 676c 6573   angle in angles
-00006ae0: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
-00006af0: 2020 2065 7870 6f73 7572 655f 6c69 7374     exposure_list
-00006b00: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00006b10: 2020 2020 2020 6578 706f 7375 7265 5f73        exposure_s
-00006b20: 7461 7274 203d 205b 5d0a 2020 2020 2020  tart = [].      
-00006b30: 2020 2020 2020 2020 2020 7072 6f64 7563            produc
-00006b40: 7420 3d20 277b 307d 2d7b 313a 3035 2e31  t = '{0}-{1:05.1
-00006b50: 667d 2d7b 327d 272e 666f 726d 6174 2874  f}-{2}'.format(t
-00006b60: 6172 6765 745f 7573 652c 2061 6e67 6c65  arget_use, angle
-00006b70: 2c20 6669 6c74 6572 290a 2020 2020 2020  , filter).      
-00006b80: 2020 2020 2020 2020 2020 7669 7369 745f            visit_
-00006b90: 6d61 7463 6820 3d20 6e70 2e75 6e69 7175  match = np.uniqu
-00006ba0: 6528 7669 7369 7473 5b28 7461 7267 6574  e(visits[(target
-00006bb0: 5f6c 6973 7420 3d3d 2074 6172 6765 7429  _list == target)
-00006bc0: 2026 0a20 2020 2020 2020 2020 2020 2020   &.             
-00006bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bf0: 2020 2869 6e66 6f5b 2766 696c 7465 7227    (info['filter'
-00006c00: 5d20 3d3d 2066 696c 7465 7229 5d29 0a0a  ] == filter)])..
-00006c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c20: 7468 6973 5f70 726f 6773 203d 205b 5d0a  this_progs = [].
-00006c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c40: 7468 6973 5f76 6973 6974 7320 3d20 5b5d  this_visits = []
-00006c50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006c60: 2020 666f 7220 7669 7369 7420 696e 2076    for visit in v
-00006c70: 6973 6974 5f6d 6174 6368 3a0a 2020 2020  isit_match:.    
-00006c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c90: 6978 203d 2028 7669 7369 7473 203d 3d20  ix = (visits == 
-00006ca0: 7669 7369 7429 2026 2028 7461 7267 6574  visit) & (target
-00006cb0: 5f6c 6973 7420 3d3d 2074 6172 6765 7429  _list == target)
+00001860: 0a20 2020 2074 6172 6770 726f 7020 3d20  .    targprop = 
+00001870: 5b5d 0a20 2020 200a 2020 2020 666f 7220  [].    .    for 
+00001880: 6920 696e 2072 616e 6765 284e 293a 0a20  i in range(N):. 
+00001890: 2020 2020 2020 206c 696e 6520 3d20 5b6f         line = [o
+000018a0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+000018b0: 6669 6c65 735b 695d 292e 7370 6c69 7428  files[i]).split(
+000018c0: 272e 677a 2729 5b30 5d5d 0a20 2020 2020  '.gz')[0]].     
+000018d0: 2020 2069 6620 6669 6c65 735b 695d 2e65     if files[i].e
+000018e0: 6e64 7377 6974 6828 272e 677a 2729 3a0a  ndswith('.gz'):.
+000018f0: 2020 2020 2020 2020 2020 2020 696d 203d              im =
+00001900: 2070 7966 6974 732e 6f70 656e 2866 696c   pyfits.open(fil
+00001910: 6573 5b69 5d29 0a20 2020 2020 2020 2020  es[i]).         
+00001920: 2020 2068 203d 2069 6d5b 305d 2e68 6561     h = im[0].hea
+00001930: 6465 722e 636f 7079 2829 0a20 2020 2020  der.copy().     
+00001940: 2020 2020 2020 2069 6d2e 636c 6f73 6528         im.close(
+00001950: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00001960: 2020 2020 2020 2020 2020 2020 6820 3d20              h = 
+00001970: 7079 6669 7473 2e48 6561 6465 7228 292e  pyfits.Header().
+00001980: 6672 6f6d 6669 6c65 2866 696c 6573 5b69  fromfile(files[i
+00001990: 5d29 0a20 2020 2020 2020 200a 2020 2020  ]).        .    
+000019a0: 2020 2020 6966 206f 732e 7061 7468 2e62      if os.path.b
+000019b0: 6173 656e 616d 6528 6669 6c65 735b 695d  asename(files[i]
+000019c0: 292e 7374 6172 7473 7769 7468 2827 6a77  ).startswith('jw
+000019d0: 3027 293a 0a20 2020 2020 2020 2020 2020  0'):.           
+000019e0: 2077 6974 6820 7079 6669 7473 2e6f 7065   with pyfits.ope
+000019f0: 6e28 6669 6c65 735b 695d 2920 6173 205f  n(files[i]) as _
+00001a00: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
+00001a10: 2020 2020 6831 203d 205f 696d 5b27 5343      h1 = _im['SC
+00001a20: 4927 5d2e 6865 6164 6572 0a20 2020 2020  I'].header.     
+00001a30: 2020 2020 2020 2020 2020 2069 6620 2750             if 'P
+00001a40: 415f 5633 2720 696e 2068 313a 0a20 2020  A_V3' in h1:.   
+00001a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001a60: 2068 5b27 5041 5f56 3327 5d20 3d20 6831   h['PA_V3'] = h1
+00001a70: 5b27 5041 5f56 3327 5d0a 2020 2020 2020  ['PA_V3'].      
+00001a80: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00001a90: 2020 2020 2020 2020 2020 2069 6620 2754             if 'T
+00001aa0: 4152 4750 524f 5027 2069 6e20 683a 0a20  ARGPROP' in h:. 
+00001ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ac0: 2020 2074 6172 6770 726f 702e 6170 7065     targprop.appe
+00001ad0: 6e64 2868 5b27 5441 5247 5052 4f50 275d  nd(h['TARGPROP']
+00001ae0: 2e6c 6f77 6572 2829 290a 2020 2020 2020  .lower()).      
+00001af0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00001b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b10: 2020 2020 7461 7267 7072 6f70 2e61 7070      targprop.app
+00001b20: 656e 6428 2769 6e64 6566 2729 0a20 2020  end('indef').   
+00001b30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00001b40: 2020 2020 2020 2074 6172 6770 726f 702e         targprop.
+00001b50: 6170 7065 6e64 2827 696e 6465 6627 290a  append('indef').
+00001b60: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00001b70: 2066 696c 7420 3d20 7061 7273 655f 6669   filt = parse_fi
+00001b80: 6c74 6572 5f66 726f 6d5f 6865 6164 6572  lter_from_header
+00001b90: 2868 2c20 6a77 7374 5f64 6574 6563 746f  (h, jwst_detecto
+00001ba0: 723d 6a77 7374 5f64 6574 6563 746f 7229  r=jwst_detector)
+00001bb0: 0a20 2020 2020 2020 206c 696e 652e 6170  .        line.ap
+00001bc0: 7065 6e64 2866 696c 7429 0a20 2020 2020  pend(filt).     
+00001bd0: 2020 2068 6173 5f63 6f6c 756d 6e73 203d     has_columns =
+00001be0: 205b 2746 494c 4527 2c20 2746 494c 5445   ['FILE', 'FILTE
+00001bf0: 5227 5d0a 0a20 2020 2020 2020 2066 6f72  R']..        for
+00001c00: 206b 6579 2069 6e20 636f 6c75 6d6e 735b   key in columns[
+00001c10: 323a 5d3a 0a20 2020 2020 2020 2020 2020  2:]:.           
+00001c20: 2068 6173 5f63 6f6c 756d 6e73 2e61 7070   has_columns.app
+00001c30: 656e 6428 6b65 7929 0a20 2020 2020 2020  end(key).       
+00001c40: 2020 2020 2069 6620 6b65 7920 696e 2068       if key in h
+00001c50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001c60: 2020 6c69 6e65 2e61 7070 656e 6428 685b    line.append(h[
+00001c70: 6b65 795d 290a 2020 2020 2020 2020 2020  key]).          
+00001c80: 2020 656c 6966 2074 7261 6e73 6c61 7465    elif translate
+00001c90: 5b6b 6579 5d20 696e 2068 3a0a 2020 2020  [key] in h:.    
+00001ca0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00001cb0: 2e61 7070 656e 6428 685b 7472 616e 736c  .append(h[transl
+00001cc0: 6174 655b 6b65 795d 5d29 0a20 2020 2020  ate[key]]).     
+00001cd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00001ce0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00001cf0: 6b65 7920 696e 2064 6566 6175 6c74 733a  key in defaults:
+00001d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001d10: 2020 2020 206c 696e 652e 6170 7065 6e64       line.append
+00001d20: 2864 6566 6175 6c74 735b 6b65 795d 290a  (defaults[key]).
+00001d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00001d50: 2020 2020 2020 2020 2020 6c69 6e65 2e61            line.a
+00001d60: 7070 656e 6428 6e70 2e6e 616e 290a 2020  ppend(np.nan).  
+00001d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d80: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+00001d90: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+00001da0: 2020 2020 2064 6174 612e 6170 7065 6e64       data.append
+00001db0: 286c 696e 6529 0a0a 2020 2020 7461 6220  (line)..    tab 
+00001dc0: 3d20 5461 626c 6528 726f 7773 3d64 6174  = Table(rows=dat
+00001dd0: 612c 206e 616d 6573 3d68 6173 5f63 6f6c  a, names=has_col
+00001de0: 756d 6e73 290a 2020 2020 0a20 2020 2069  umns).    .    i
+00001df0: 6620 2754 4152 474e 414d 4527 2069 6e20  f 'TARGNAME' in 
+00001e00: 7461 622e 636f 6c6e 616d 6573 3a0a 2020  tab.colnames:.  
+00001e10: 2020 2020 2020 6d69 7373 203d 2074 6162        miss = tab
+00001e20: 5b27 5441 5247 4e41 4d45 275d 203d 3d20  ['TARGNAME'] == 
+00001e30: 2727 0a20 2020 2020 2020 2074 6172 6773  ''.        targs
+00001e40: 203d 205b 742e 7265 706c 6163 6528 2720   = [t.replace(' 
+00001e50: 272c 2027 2d27 2920 666f 7220 7420 696e  ', '-') for t in
+00001e60: 2074 6162 5b27 5441 5247 4e41 4d45 275d   tab['TARGNAME']
+00001e70: 5d0a 2020 2020 2020 2020 0a20 2020 2020  ].        .     
+00001e80: 2020 2069 6620 6d69 7373 2e73 756d 2829     if miss.sum()
+00001e90: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00001ea0: 2020 666f 7220 6920 696e 206e 702e 7768    for i in np.wh
+00001eb0: 6572 6528 6d69 7373 295b 305d 3a0a 2020  ere(miss)[0]:.  
+00001ec0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00001ed0: 7267 735b 695d 203d 2074 6172 6770 726f  rgs[i] = targpro
+00001ee0: 705b 695d 2023 2769 6e64 6566 270a 2020  p[i] #'indef'.  
+00001ef0: 2020 2020 2020 0a20 2020 2020 2020 2074        .        t
+00001f00: 6162 5b27 5441 5247 4e41 4d45 275d 203d  ab['TARGNAME'] =
+00001f10: 2074 6172 6773 0a20 2020 2020 2020 2020   targs.         
+00001f20: 2020 200a 2020 2020 7265 7475 726e 2074     .    return t
+00001f30: 6162 0a0a 0a64 6566 2072 6164 6563 5f74  ab...def radec_t
+00001f40: 6f5f 7461 7267 6e61 6d65 2872 613d 302c  o_targname(ra=0,
+00001f50: 2064 6563 3d30 2c20 726f 756e 645f 6172   dec=0, round_ar
+00001f60: 6373 6563 3d28 342c 2036 3029 2c20 7072  csec=(4, 60), pr
+00001f70: 6563 6973 696f 6e3d 322c 2074 6172 6773  ecision=2, targs
+00001f80: 7472 3d27 6a7b 7261 687d 7b72 616d 7d7b  tr='j{rah}{ram}{
+00001f90: 7261 737d 7b73 6967 6e7d 7b64 6564 7d7b  ras}{sign}{ded}{
+00001fa0: 6465 6d7d 272c 2068 6561 6465 723d 4e6f  dem}', header=No
+00001fb0: 6e65 293a 0a20 2020 2022 2222 5475 726e  ne):.    """Turn
+00001fc0: 2064 6563 696d 616c 2064 6567 7265 6520   decimal degree 
+00001fd0: 636f 6f72 6469 6e61 7465 7320 696e 746f  coordinates into
+00001fe0: 2061 2073 7472 696e 6720 7769 7468 2072   a string with r
+00001ff0: 6f75 6e64 696e 672e 0a0a 2020 2020 5061  ounding...    Pa
+00002000: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00002010: 2d2d 2d2d 2d2d 2d0a 2020 2020 7261 2c20  -------.    ra, 
+00002020: 6465 6320 3a20 666c 6f61 740a 2020 2020  dec : float.    
+00002030: 2020 2020 536b 7920 636f 6f72 6469 6e61      Sky coordina
+00002040: 7465 7320 696e 2064 6563 696d 616c 2064  tes in decimal d
+00002050: 6567 7265 6573 0a0a 2020 2020 726f 756e  egrees..    roun
+00002060: 645f 6172 6373 6563 203a 2028 7363 616c  d_arcsec : (scal
+00002070: 6172 2c20 7363 616c 6172 290a 2020 2020  ar, scalar).    
+00002080: 2020 2020 526f 756e 6420 7468 6520 636f      Round the co
+00002090: 6f72 6469 6e61 7465 7320 746f 206e 6561  ordinates to nea
+000020a0: 7265 7374 2076 616c 7565 206f 6620 6072  rest value of `r
+000020b0: 6f75 6e64 602c 2069 6e20 6172 6373 6563  ound`, in arcsec
+000020c0: 6f6e 6473 2e0a 0a20 2020 2070 7265 6369  onds...    preci
+000020d0: 7369 6f6e 203a 2069 6e74 0a20 2020 2020  sion : int.     
+000020e0: 2020 2053 7562 2d61 7263 7365 636f 6e64     Sub-arcsecond
+000020f0: 2070 7265 6369 7369 6f6e 2c20 696e 2060   precision, in `
+00002100: 7e61 7374 726f 7079 2e63 6f6f 7264 696e  ~astropy.coordin
+00002110: 6174 6573 2e53 6b79 436f 6f72 642e 746f  ates.SkyCoord.to
+00002120: 5f73 7472 696e 6760 2e0a 0a20 2020 2074  _string`...    t
+00002130: 6172 6773 7472 203a 2073 7472 696e 670a  argstr : string.
+00002140: 2020 2020 2020 2020 4275 696c 6420 6074          Build `t
+00002150: 6172 676e 616d 6560 2077 6974 6820 7468  argname` with th
+00002160: 6973 2070 6172 656e 7420 7374 7269 6e67  is parent string
+00002170: 2e20 2041 7267 756d 656e 7473 0a20 2020  .  Arguments.   
+00002180: 2020 2020 2060 7261 682c 2072 616d 2c20       `rah, ram, 
+00002190: 7261 732c 2072 6173 732c 2073 6967 6e2c  ras, rass, sign,
+000021a0: 2064 6564 2c20 6465 6d2c 2064 6573 2c20   ded, dem, des, 
+000021b0: 6465 7373 6020 6172 6520 636f 6d70 7574  dess` are comput
+000021c0: 6564 2066 726f 6d20 7468 650a 2020 2020  ed from the.    
+000021d0: 2020 2020 2872 6f75 6e64 6564 2920 7461      (rounded) ta
+000021e0: 7267 6574 2063 6f6f 7264 696e 6174 6573  rget coordinates
+000021f0: 2028 6072 6160 2c20 6064 6563 6029 2061   (`ra`, `dec`) a
+00002200: 6e64 2070 6173 7365 6420 746f 0a20 2020  nd passed to.   
+00002210: 2020 2020 2060 7461 7267 7374 722e 666f       `targstr.fo
+00002220: 726d 6174 602e 0a0a 2020 2020 6865 6164  rmat`...    head
+00002230: 6572 203a 2060 7e61 7374 726f 7079 2e69  er : `~astropy.i
+00002240: 6f2e 6669 7473 2e48 6561 6465 7260 2c20  o.fits.Header`, 
+00002250: 4e6f 6e65 0a20 2020 2020 2020 2054 7279  None.        Try
+00002260: 2074 6f20 6765 7420 6072 6160 2c20 6064   to get `ra`, `d
+00002270: 6563 6020 6672 6f6d 2068 6561 6465 7220  ec` from header 
+00002280: 6b65 7977 6f72 6473 2c20 6669 7273 7420  keywords, first 
+00002290: 6043 5256 414c 6020 616e 6420 7468 656e  `CRVAL` and then
+000022a0: 0a20 2020 2020 2020 2060 5241 5f54 4152  .        `RA_TAR
+000022b0: 4760 2c20 6044 4543 5f54 4152 4760 2e0a  G`, `DEC_TARG`..
+000022c0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+000022d0: 202d 2d2d 2d2d 2d2d 0a20 2020 2074 6172   -------.    tar
+000022e0: 676e 616d 6520 3a20 7374 720a 2020 2020  gname : str.    
+000022f0: 2020 2020 5461 7267 6574 2073 7472 696e      Target strin
+00002300: 672c 2073 6565 2074 6865 2065 7861 6d70  g, see the examp
+00002310: 6c65 2061 626f 7665 2e0a 2020 2020 0a20  le above..    . 
+00002320: 2020 2045 7861 6d70 6c65 730a 2020 2020     Examples.    
+00002330: 2d2d 2d2d 2d2d 2d2d 0a20 2020 200a 2020  --------.    .  
+00002340: 2020 3e3e 3e20 2320 5465 7374 2064 6563    >>> # Test dec
+00002350: 3a20 2d31 3064 3130 6d31 302e 3130 730a  : -10d10m10.10s.
+00002360: 2020 2020 3e3e 3e20 6465 6320 3d20 2d31      >>> dec = -1
+00002370: 302e 202d 2031 302e 2f36 302e 202d 2031  0. - 10./60. - 1
+00002380: 302e 312f 3336 3030 0a20 2020 203e 3e3e  0.1/3600.    >>>
+00002390: 2023 2054 6573 7420 7261 3a20 3032 6830   # Test ra: 02h0
+000023a0: 326d 3032 2e32 3073 0a20 2020 203e 3e3e  2m02.20s.    >>>
+000023b0: 2063 6f73 6420 3d20 6e70 2e63 6f73 2864   cosd = np.cos(d
+000023c0: 6563 2f31 3830 2a6e 702e 7069 290a 2020  ec/180*np.pi).  
+000023d0: 2020 3e3e 3e20 7261 203d 2032 2a31 3520    >>> ra = 2*15 
+000023e0: 2b20 322e 2f36 302a 3135 202b 2032 2e32  + 2./60*15 + 2.2
+000023f0: 2f33 3630 302e 2a31 350a 2020 2020 3e3e  /3600.*15.    >>
+00002400: 3e20 2320 526f 756e 6420 746f 206e 6561  > # Round to nea
+00002410: 7265 7374 2061 7263 6d69 6e0a 2020 2020  rest arcmin.    
+00002420: 3e3e 3e20 6672 6f6d 2067 7269 7a6c 692e  >>> from grizli.
+00002430: 7574 696c 7320 696d 706f 7274 2072 6164  utils import rad
+00002440: 6563 5f74 6f5f 7461 7267 6e61 6d65 0a20  ec_to_targname. 
+00002450: 2020 203e 3e3e 2070 7269 6e74 2872 6164     >>> print(rad
+00002460: 6563 5f74 6f5f 7461 7267 6e61 6d65 2872  ec_to_targname(r
+00002470: 613d 7261 2c20 6465 633d 6465 632c 2072  a=ra, dec=dec, r
+00002480: 6f75 6e64 5f61 7263 7365 633d 2834 2c36  ound_arcsec=(4,6
+00002490: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
+000024a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000024b0: 6172 6773 7472 3d27 6a7b 7261 687d 7b72  argstr='j{rah}{r
+000024c0: 616d 7d7b 7261 737d 7b73 6967 6e7d 7b64  am}{ras}{sign}{d
+000024d0: 6564 7d7b 6465 6d7d 2729 290a 2020 2020  ed}{dem}')).    
+000024e0: 6a30 3230 3230 346d 3130 3130 2023 2028  j020204m1010 # (
+000024f0: 726f 756e 6465 6420 746f 2034 2061 7263  rounded to 4 arc
+00002500: 7365 6320 696e 2052 4129 0a20 2020 203e  sec in RA).    >
+00002510: 3e3e 2023 2046 756c 6c20 7072 6563 6973  >> # Full precis
+00002520: 696f 6e0a 2020 2020 3e3e 3e20 7461 7267  ion.    >>> targ
+00002530: 7374 7220 3d20 276a 7b72 6168 7d7b 7261  str = 'j{rah}{ra
+00002540: 6d7d 7b72 6173 7d2e 7b72 6173 737d 7b73  m}{ras}.{rass}{s
+00002550: 6967 6e7d 7b64 6564 7d7b 6465 6d7d 7b64  ign}{ded}{dem}{d
+00002560: 6573 7d2e 7b64 6573 737d 270a 2020 2020  es}.{dess}'.    
+00002570: 3e3e 3e20 7072 696e 7428 7261 6465 635f  >>> print(radec_
+00002580: 746f 5f74 6172 676e 616d 6528 7261 2c20  to_targname(ra, 
+00002590: 6465 632c 726f 756e 645f 6172 6373 6563  dec,round_arcsec
+000025a0: 3d28 302e 3030 3031 2c20 302e 3030 3031  =(0.0001, 0.0001
+000025b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000025c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025d0: 2020 2070 7265 6369 7369 6f6e 3d33 2c20     precision=3, 
+000025e0: 7461 7267 7374 723d 7461 7267 7374 7229  targstr=targstr)
+000025f0: 290a 2020 2020 6a30 3230 3230 322e 3230  ).    j020202.20
+00002600: 306d 3130 3130 3130 2e31 3030 0a20 2020  0m101010.100.   
+00002610: 200a 2020 2020 2222 220a 2020 2020 696d   .    """.    im
+00002620: 706f 7274 2061 7374 726f 7079 2e63 6f6f  port astropy.coo
+00002630: 7264 696e 6174 6573 0a20 2020 2069 6d70  rdinates.    imp
+00002640: 6f72 7420 6173 7472 6f70 792e 756e 6974  ort astropy.unit
+00002650: 7320 6173 2075 0a0a 2020 2020 696d 706f  s as u..    impo
+00002660: 7274 2072 650a 2020 2020 696d 706f 7274  rt re.    import
+00002670: 206e 756d 7079 2061 7320 6e70 0a0a 2020   numpy as np..  
+00002680: 2020 6966 2068 6561 6465 7220 6973 206e    if header is n
+00002690: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000026a0: 2069 6620 2743 5256 414c 3127 2069 6e20   if 'CRVAL1' in 
+000026b0: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
+000026c0: 2020 2020 7261 2c20 6465 6320 3d20 6865      ra, dec = he
+000026d0: 6164 6572 5b27 4352 5641 4c31 275d 2c20  ader['CRVAL1'], 
+000026e0: 6865 6164 6572 5b27 4352 5641 4c32 275d  header['CRVAL2']
+000026f0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00002700: 2020 2020 2020 2020 2020 2069 6620 2752             if 'R
+00002710: 415f 5441 5247 2720 696e 2068 6561 6465  A_TARG' in heade
+00002720: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00002730: 2020 2072 612c 2064 6563 203d 2068 6561     ra, dec = hea
+00002740: 6465 725b 2752 415f 5441 5247 275d 2c20  der['RA_TARG'], 
+00002750: 6865 6164 6572 5b27 4445 435f 5441 5247  header['DEC_TARG
+00002760: 275d 0a0a 2020 2020 636f 7364 203d 206e  ']..    cosd = n
+00002770: 702e 636f 7328 6465 632f 3138 302a 6e70  p.cos(dec/180*np
+00002780: 2e70 6929 0a20 2020 2073 636c 203d 206e  .pi).    scl = n
+00002790: 702e 6172 7261 7928 726f 756e 645f 6172  p.array(round_ar
+000027a0: 6373 6563 292f 3336 3030 2a6e 702e 6172  csec)/3600*np.ar
+000027b0: 7261 7928 5b33 3630 2f32 342c 2031 5d29  ray([360/24, 1])
+000027c0: 0a0a 2020 2020 6465 635f 7363 6c20 3d20  ..    dec_scl = 
+000027d0: 696e 7428 6e70 2e72 6f75 6e64 2864 6563  int(np.round(dec
+000027e0: 2f73 636c 5b31 5d29 292a 7363 6c5b 315d  /scl[1]))*scl[1]
+000027f0: 0a20 2020 2072 615f 7363 6c20 3d20 696e  .    ra_scl = in
+00002800: 7428 6e70 2e72 6f75 6e64 2872 612f 7363  t(np.round(ra/sc
+00002810: 6c5b 305d 2929 2a73 636c 5b30 5d0a 0a20  l[0]))*scl[0].. 
+00002820: 2020 2063 6f6f 203d 2061 7374 726f 7079     coo = astropy
+00002830: 2e63 6f6f 7264 696e 6174 6573 2e53 6b79  .coordinates.Sky
+00002840: 436f 6f72 6428 7261 3d72 615f 7363 6c2a  Coord(ra=ra_scl*
+00002850: 752e 6465 672c 2064 6563 3d64 6563 5f73  u.deg, dec=dec_s
+00002860: 636c 2a75 2e64 6567 2c20 0a20 2020 2020  cl*u.deg, .     
+00002870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002890: 2020 6672 616d 653d 2769 6372 7327 290a    frame='icrs').
+000028a0: 0a20 2020 2063 7374 7220 3d20 7265 2e73  .    cstr = re.s
+000028b0: 706c 6974 2827 5b68 6d73 642e 5d27 2c20  plit('[hmsd.]', 
+000028c0: 636f 6f2e 746f 5f73 7472 696e 6728 2768  coo.to_string('h
+000028d0: 6d73 646d 7327 2c20 7072 6563 6973 696f  msdms', precisio
+000028e0: 6e3d 7072 6563 6973 696f 6e29 290a 2020  n=precision)).  
+000028f0: 2020 2320 7461 7267 6e61 6d65 203d 2028    # targname = (
+00002900: 276a 7b30 7d7b 317d 272e 666f 726d 6174  'j{0}{1}'.format
+00002910: 2827 272e 6a6f 696e 2863 7374 725b 303a  (''.join(cstr[0:
+00002920: 335d 292c 2027 272e 6a6f 696e 2863 7374  3]), ''.join(cst
+00002930: 725b 343a 375d 2929 290a 2020 2020 2320  r[4:7]))).    # 
+00002940: 7461 7267 6e61 6d65 203d 2074 6172 676e  targname = targn
+00002950: 616d 652e 7265 706c 6163 6528 2720 272c  ame.replace(' ',
+00002960: 2027 2729 2e72 6570 6c61 6365 2827 2b27   '').replace('+'
+00002970: 2c27 7027 292e 7265 706c 6163 6528 272d  ,'p').replace('-
+00002980: 272c 276d 2729 0a0a 2020 2020 7261 682c  ','m')..    rah,
+00002990: 2072 616d 2c20 7261 732c 2072 6173 7320   ram, ras, rass 
+000029a0: 3d20 6373 7472 5b30 3a34 5d0a 2020 2020  = cstr[0:4].    
+000029b0: 6465 642c 2064 656d 2c20 6465 732c 2064  ded, dem, des, d
+000029c0: 6573 7320 3d20 6373 7472 5b34 3a38 5d0a  ess = cstr[4:8].
+000029d0: 2020 2020 7369 676e 203d 2027 7027 2069      sign = 'p' i
+000029e0: 6620 6465 645b 315d 203d 3d20 272b 2720  f ded[1] == '+' 
+000029f0: 656c 7365 2027 6d27 0a0a 2020 2020 7461  else 'm'..    ta
+00002a00: 7267 6e61 6d65 203d 2074 6172 6773 7472  rgname = targstr
+00002a10: 2e66 6f72 6d61 7428 7261 683d 7261 682c  .format(rah=rah,
+00002a20: 2072 616d 3d72 616d 2c20 7261 733d 7261   ram=ram, ras=ra
+00002a30: 732c 2072 6173 733d 7261 7373 2c0a 2020  s, rass=rass,.  
+00002a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002a50: 2020 2020 2020 2020 2020 2020 6465 643d              ded=
+00002a60: 6465 645b 323a 5d2c 2064 656d 3d64 656d  ded[2:], dem=dem
+00002a70: 2c20 6465 733d 6465 732c 2064 6573 733d  , des=des, dess=
+00002a80: 6465 7373 2c0a 2020 2020 2020 2020 2020  dess,.          
+00002a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002aa0: 2020 2020 7369 676e 3d73 6967 6e29 0a0a      sign=sign)..
+00002ab0: 2020 2020 7265 7475 726e 2074 6172 676e      return targn
+00002ac0: 616d 650a 0a0a 6465 6620 626c 6f74 5f6e  ame...def blot_n
+00002ad0: 6561 7265 7374 5f65 7861 6374 2869 6e5f  earest_exact(in_
+00002ae0: 6461 7461 2c20 696e 5f77 6373 2c20 6f75  data, in_wcs, ou
+00002af0: 745f 7763 732c 2076 6572 626f 7365 3d54  t_wcs, verbose=T
+00002b00: 7275 652c 2073 7465 7073 697a 653d 2d31  rue, stepsize=-1
+00002b10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002b20: 2020 2020 2020 2020 2073 6361 6c65 5f62           scale_b
+00002b30: 795f 7069 7865 6c5f 6172 6561 3d46 616c  y_pixel_area=Fal
+00002b40: 7365 2c20 7763 735f 6d61 736b 3d54 7275  se, wcs_mask=Tru
+00002b50: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00002b60: 2020 2020 2020 2020 2020 6669 6c6c 5f76            fill_v
+00002b70: 616c 7565 3d30 293a 0a20 2020 2022 2222  alue=0):.    """
+00002b80: 0a20 2020 204f 776e 2062 6c6f 7420 6675  .    Own blot fu
+00002b90: 6e63 7469 6f6e 2066 6f72 2062 6c6f 7474  nction for blott
+00002ba0: 696e 6720 6578 6163 7420 7069 7865 6c73  ing exact pixels
+00002bb0: 2077 6974 686f 7574 2072 6573 6361 6c69   without rescali
+00002bc0: 6e67 2066 6f72 2069 6e70 7574 0a20 2020  ng for input.   
+00002bd0: 2061 6e64 206f 7574 7075 7420 7069 7865   and output pixe
+00002be0: 6c20 7369 7a65 0a0a 2020 2020 7465 7374  l size..    test
+00002bf0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00002c00: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00002c10: 2020 2020 696e 5f64 6174 6120 3a20 607e      in_data : `~
+00002c20: 6e75 6d70 792e 6e64 6172 7261 7960 0a20  numpy.ndarray`. 
+00002c30: 2020 2020 2020 2049 6e70 7574 2064 6174         Input dat
+00002c40: 6120 746f 2062 6c6f 742e 0a0a 2020 2020  a to blot...    
+00002c50: 696e 5f77 6373 203a 2060 7e61 7374 726f  in_wcs : `~astro
+00002c60: 7079 2e77 6373 2e57 4353 600a 2020 2020  py.wcs.WCS`.    
+00002c70: 2020 2020 496e 7075 7420 5743 532e 2020      Input WCS.  
+00002c80: 4d75 7374 2068 6176 6520 5f6e 6178 6973  Must have _naxis
+00002c90: 312c 205f 6e61 7869 7332 206f 7220 7069  1, _naxis2 or pi
+00002ca0: 7865 6c5f 7368 6170 6520 6174 7472 6962  xel_shape attrib
+00002cb0: 7574 6573 2e0a 0a20 2020 206f 7574 5f77  utes...    out_w
+00002cc0: 6373 203a 2060 7e61 7374 726f 7079 2e77  cs : `~astropy.w
+00002cd0: 6373 2e57 4353 600a 2020 2020 2020 2020  cs.WCS`.        
+00002ce0: 4f75 7470 7574 2057 4353 2e20 204d 7573  Output WCS.  Mus
+00002cf0: 7420 6861 7665 205f 6e61 7869 7331 2c20  t have _naxis1, 
+00002d00: 5f6e 6178 6973 3220 6f72 2070 6978 656c  _naxis2 or pixel
+00002d10: 5f73 6861 7065 2061 7474 7269 6275 7465  _shape attribute
+00002d20: 732e 0a0a 2020 2020 7363 616c 655f 6279  s...    scale_by
+00002d30: 5f70 6978 656c 5f61 7265 6120 3a20 626f  _pixel_area : bo
+00002d40: 6f6c 0a20 2020 2020 2020 2049 6620 5472  ol.        If Tr
+00002d50: 7565 2c20 7468 656e 2073 6361 6c65 2074  ue, then scale t
+00002d60: 6865 206f 7574 7075 7420 696d 6167 6520  he output image 
+00002d70: 6279 2074 6865 2073 7175 6172 6520 6f66  by the square of
+00002d80: 2074 6865 2069 6d61 6765 2070 6978 656c   the image pixel
+00002d90: 0a20 2020 2020 2020 2073 6361 6c65 7320  .        scales 
+00002da0: 286f 7574 2a2a 322f 696e 2a2a 3229 2c20  (out**2/in**2), 
+00002db0: 692e 652e 2c20 7468 6520 7069 7865 6c20  i.e., the pixel 
+00002dc0: 6172 6561 732e 0a0a 2020 2020 7763 735f  areas...    wcs_
+00002dd0: 6d61 736b 203a 2062 6f6f 6c0a 2020 2020  mask : bool.    
+00002de0: 2020 2020 5573 6520 6661 7374 2057 4353      Use fast WCS
+00002df0: 206d 6173 6b69 6e67 2e20 2049 6620 4661   masking.  If Fa
+00002e00: 6c73 652c 2075 7365 2060 6072 6567 696f  lse, use ``regio
+00002e10: 6e73 6060 2e0a 0a20 2020 2066 696c 6c5f  ns``...    fill_
+00002e20: 7661 6c75 6520 3a20 696e 742f 666c 6f61  value : int/floa
+00002e30: 740a 2020 2020 2020 2020 5661 6c75 6520  t.        Value 
+00002e40: 696e 2060 6f75 745f 6461 7461 6020 6e6f  in `out_data` no
+00002e50: 7420 636f 7665 7265 6420 6279 2060 696e  t covered by `in
+00002e60: 5f64 6174 6160 2e0a 0a20 2020 2052 6574  _data`...    Ret
+00002e70: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00002e80: 0a20 2020 206f 7574 5f64 6174 6120 3a20  .    out_data : 
+00002e90: 607e 6e75 6d70 792e 6e64 6172 7261 7960  `~numpy.ndarray`
+00002ea0: 0a20 2020 2020 2020 2042 6c6f 7474 6564  .        Blotted
+00002eb0: 2064 6174 612e 0a0a 2020 2020 2222 220a   data...    """.
+00002ec0: 2020 2020 6672 6f6d 2072 6567 696f 6e73      from regions
+00002ed0: 2069 6d70 6f72 7420 5265 6769 6f6e 730a   import Regions.
+00002ee0: 2020 2020 6672 6f6d 2073 6861 7065 6c79      from shapely
+00002ef0: 2e67 656f 6d65 7472 7920 696d 706f 7274  .geometry import
+00002f00: 2050 6f6c 7967 6f6e 0a20 2020 2069 6d70   Polygon.    imp
+00002f10: 6f72 7420 7363 6970 792e 6e64 696d 6167  ort scipy.ndimag
+00002f20: 6520 6173 206e 640a 2020 2020 6672 6f6d  e as nd.    from
+00002f30: 2064 7269 7a7a 6c65 7061 6320 696d 706f   drizzlepac impo
+00002f40: 7274 2063 6472 697a 0a0a 2020 2020 7472  rt cdriz..    tr
+00002f50: 793a 0a20 2020 2020 2020 2066 726f 6d20  y:.        from 
+00002f60: 2e75 7469 6c73 5f63 2e69 6e74 6572 7020  .utils_c.interp 
+00002f70: 696d 706f 7274 2070 6978 656c 5f6d 6170  import pixel_map
+00002f80: 5f63 0a20 2020 2065 7863 6570 743a 0a20  _c.    except:. 
+00002f90: 2020 2020 2020 2066 726f 6d20 6772 697a         from griz
+00002fa0: 6c69 2e75 7469 6c73 5f63 2e69 6e74 6572  li.utils_c.inter
+00002fb0: 7020 696d 706f 7274 2070 6978 656c 5f6d  p import pixel_m
+00002fc0: 6170 5f63 0a20 2020 200a 2020 2020 2320  ap_c.    .    # 
+00002fd0: 5368 6170 6573 2c20 696e 206e 756d 7079  Shapes, in numpy
+00002fe0: 2061 7272 6179 2063 6f6e 7665 6e74 696f   array conventio
+00002ff0: 6e20 2879 2c20 7829 0a20 2020 2069 6620  n (y, x).    if 
+00003000: 6861 7361 7474 7228 696e 5f77 6373 2c20  hasattr(in_wcs, 
+00003010: 2770 6978 656c 5f73 6861 7065 2729 3a0a  'pixel_shape'):.
+00003020: 2020 2020 2020 2020 696e 5f73 6820 3d20          in_sh = 
+00003030: 696e 5f77 6373 2e70 6978 656c 5f73 6861  in_wcs.pixel_sha
+00003040: 7065 5b3a 3a2d 315d 0a20 2020 2065 6c69  pe[::-1].    eli
+00003050: 6620 6861 7361 7474 7228 696e 5f77 6373  f hasattr(in_wcs
+00003060: 2c20 2761 7272 6179 5f73 6861 7065 2729  , 'array_shape')
+00003070: 3a0a 2020 2020 2020 2020 696e 5f73 6820  :.        in_sh 
+00003080: 3d20 696e 5f77 6373 2e61 7272 6179 5f73  = in_wcs.array_s
+00003090: 6861 7065 0a20 2020 2065 6c73 653a 0a20  hape.    else:. 
+000030a0: 2020 2020 2020 2069 6e5f 7368 203d 2028         in_sh = (
+000030b0: 696e 5f77 6373 2e5f 6e61 7869 7332 2c20  in_wcs._naxis2, 
+000030c0: 696e 5f77 6373 2e5f 6e61 7869 7331 290a  in_wcs._naxis1).
+000030d0: 0a20 2020 2069 6620 6861 7361 7474 7228  .    if hasattr(
+000030e0: 6f75 745f 7763 732c 2027 7069 7865 6c5f  out_wcs, 'pixel_
+000030f0: 7368 6170 6527 293a 0a20 2020 2020 2020  shape'):.       
+00003100: 206f 7574 5f73 6820 3d20 6f75 745f 7763   out_sh = out_wc
+00003110: 732e 7069 7865 6c5f 7368 6170 655b 3a3a  s.pixel_shape[::
+00003120: 2d31 5d0a 2020 2020 656c 6966 2068 6173  -1].    elif has
+00003130: 6174 7472 286f 7574 5f77 6373 2c20 2761  attr(out_wcs, 'a
+00003140: 7272 6179 5f73 6861 7065 2729 3a0a 2020  rray_shape'):.  
+00003150: 2020 2020 2020 6f75 745f 7368 203d 206f        out_sh = o
+00003160: 7574 5f77 6373 2e61 7272 6179 5f73 6861  ut_wcs.array_sha
+00003170: 7065 0a20 2020 2065 6c73 653a 0a20 2020  pe.    else:.   
+00003180: 2020 2020 206f 7574 5f73 6820 3d20 286f       out_sh = (o
+00003190: 7574 5f77 6373 2e5f 6e61 7869 7332 2c20  ut_wcs._naxis2, 
+000031a0: 6f75 745f 7763 732e 5f6e 6178 6973 3129  out_wcs._naxis1)
+000031b0: 0a0a 2020 2020 696e 5f70 7820 3d20 696e  ..    in_px = in
+000031c0: 5f77 6373 2e63 616c 635f 666f 6f74 7072  _wcs.calc_footpr
+000031d0: 696e 7428 290a 2020 2020 696e 5f70 6f6c  int().    in_pol
+000031e0: 7920 3d20 506f 6c79 676f 6e28 696e 5f70  y = Polygon(in_p
+000031f0: 7829 2e62 7566 6665 7228 352e 2f33 3630  x).buffer(5./360
+00003200: 302e 290a 0a20 2020 206f 7574 5f70 7820  0.)..    out_px 
+00003210: 3d20 6f75 745f 7763 732e 6361 6c63 5f66  = out_wcs.calc_f
+00003220: 6f6f 7470 7269 6e74 2829 0a20 2020 206f  ootprint().    o
+00003230: 7574 5f70 6f6c 7920 3d20 506f 6c79 676f  ut_poly = Polygo
+00003240: 6e28 6f75 745f 7078 292e 6275 6666 6572  n(out_px).buffer
+00003250: 2835 2e2f 3336 3030 290a 0a20 2020 206f  (5./3600)..    o
+00003260: 6c61 7020 3d20 696e 5f70 6f6c 792e 696e  lap = in_poly.in
+00003270: 7465 7273 6563 7469 6f6e 286f 7574 5f70  tersection(out_p
+00003280: 6f6c 7929 0a20 2020 2069 6620 6f6c 6170  oly).    if olap
+00003290: 2e61 7265 6120 3d3d 2030 3a0a 2020 2020  .area == 0:.    
+000032a0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+000032b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000032c0: 7428 274e 6f20 6f76 6572 6c61 7027 290a  t('No overlap').
+000032d0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+000032e0: 702e 7a65 726f 7328 6f75 745f 7368 290a  p.zeros(out_sh).
+000032f0: 0a20 2020 2023 2052 6567 696f 6e20 6d61  .    # Region ma
+00003300: 736b 2066 6f72 2073 7065 6564 7570 0a20  sk for speedup. 
+00003310: 2020 2069 6620 6e70 2e69 7363 6c6f 7365     if np.isclose
+00003320: 286f 6c61 702e 6172 6561 2c20 6f75 745f  (olap.area, out_
+00003330: 706f 6c79 2e61 7265 612c 2030 2e30 3129  poly.area, 0.01)
+00003340: 3a0a 2020 2020 2020 2020 6d61 736b 203d  :.        mask =
+00003350: 206e 702e 6f6e 6573 286f 7574 5f73 682c   np.ones(out_sh,
+00003360: 2064 7479 7065 3d62 6f6f 6c29 0a20 2020   dtype=bool).   
+00003370: 2065 6c69 6620 7763 735f 6d61 736b 3a0a   elif wcs_mask:.
+00003380: 2020 2020 2020 2020 2320 5573 6520 7763          # Use wc
+00003390: 7320 2f20 5061 7468 0a20 2020 2020 2020  s / Path.       
+000033a0: 2066 726f 6d20 6d61 7470 6c6f 746c 6962   from matplotlib
+000033b0: 2e70 6174 6820 696d 706f 7274 2050 6174  .path import Pat
+000033c0: 680a 2020 2020 2020 2020 6f75 745f 7879  h.        out_xy
+000033d0: 203d 206f 7574 5f77 6373 2e61 6c6c 5f77   = out_wcs.all_w
+000033e0: 6f72 6c64 3270 6978 286e 702e 6172 7261  orld2pix(np.arra
+000033f0: 7928 696e 5f70 6f6c 792e 6578 7465 7269  y(in_poly.exteri
+00003400: 6f72 2e78 7929 2e54 2c20 3029 2d30 2e35  or.xy).T, 0)-0.5
+00003410: 0a20 2020 2020 2020 206f 7574 5f78 795f  .        out_xy_
+00003420: 7061 7468 203d 2050 6174 6828 6f75 745f  path = Path(out_
+00003430: 7879 290a 2020 2020 2020 2020 7970 2c20  xy).        yp, 
+00003440: 7870 203d 206e 702e 696e 6469 6365 7328  xp = np.indices(
+00003450: 6f75 745f 7368 290a 2020 2020 2020 2020  out_sh).        
+00003460: 7074 7320 3d20 6e70 2e61 7272 6179 285b  pts = np.array([
+00003470: 7870 2e66 6c61 7474 656e 2829 2c20 7970  xp.flatten(), yp
+00003480: 2e66 6c61 7474 656e 2829 5d29 2e54 0a20  .flatten()]).T. 
+00003490: 2020 2020 2020 206d 6173 6b20 3d20 6f75         mask = ou
+000034a0: 745f 7879 5f70 6174 682e 636f 6e74 6169  t_xy_path.contai
+000034b0: 6e73 5f70 6f69 6e74 7328 7074 7329 2e72  ns_points(pts).r
+000034c0: 6573 6861 7065 286f 7574 5f73 6829 0a20  eshape(out_sh). 
+000034d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000034e0: 206f 6c61 705f 706f 6c79 203d 206e 702e   olap_poly = np.
+000034f0: 6172 7261 7928 6f6c 6170 2e65 7874 6572  array(olap.exter
+00003500: 696f 722e 7879 290a 2020 2020 2020 2020  ior.xy).        
+00003510: 706f 6c79 5f72 6567 203d 2022 666b 355c  poly_reg = "fk5\
+00003520: 6e70 6f6c 7967 6f6e 2822 2b27 2c27 2e6a  npolygon("+','.j
+00003530: 6f69 6e28 5b27 7b30 7d27 2e66 6f72 6d61  oin(['{0}'.forma
+00003540: 7428 7020 2b20 3129 2066 6f72 2070 2069  t(p + 1) for p i
+00003550: 6e20 6f6c 6170 5f70 6f6c 792e 542e 666c  n olap_poly.T.fl
+00003560: 6174 7465 6e28 295d 292b 2729 5c6e 270a  atten()])+')\n'.
+00003570: 2020 2020 2020 2020 7265 6720 3d20 5265          reg = Re
+00003580: 6769 6f6e 732e 7061 7273 6528 706f 6c79  gions.parse(poly
+00003590: 5f72 6567 2c20 666f 726d 6174 3d27 6473  _reg, format='ds
+000035a0: 3927 295b 305d 0a20 2020 2020 2020 206d  9')[0].        m
+000035b0: 6173 6b20 3d20 7265 672e 746f 5f6d 6173  ask = reg.to_mas
+000035c0: 6b28 292e 746f 5f69 6d61 6765 2873 6861  k().to_image(sha
+000035d0: 7065 3d6f 7574 5f73 6829 0a0a 2020 2020  pe=out_sh)..    
+000035e0: 2379 702c 2078 7020 3d20 6e70 2e69 6e64  #yp, xp = np.ind
+000035f0: 6963 6573 2869 6e5f 6461 7461 2e73 6861  ices(in_data.sha
+00003600: 7065 290a 2020 2020 2378 692c 2079 6920  pe).    #xi, yi 
+00003610: 3d20 7870 5b6d 6173 6b5d 2c20 7970 5b6d  = xp[mask], yp[m
+00003620: 6173 6b5d 0a20 2020 2079 6f2c 2078 6f20  ask].    yo, xo 
+00003630: 3d20 6e70 2e77 6865 7265 286d 6173 6b20  = np.where(mask 
+00003640: 3e20 3029 0a0a 2020 2020 6966 2073 7465  > 0)..    if ste
+00003650: 7073 697a 6520 3c3d 2031 3a0a 2020 2020  psize <= 1:.    
+00003660: 2020 2020 7264 203d 206f 7574 5f77 6373      rd = out_wcs
+00003670: 2e61 6c6c 5f70 6978 3277 6f72 6c64 2878  .all_pix2world(x
+00003680: 6f2c 2079 6f2c 2030 290a 2020 2020 2020  o, yo, 0).      
+00003690: 2020 7866 2c20 7966 203d 2069 6e5f 7763    xf, yf = in_wc
+000036a0: 732e 616c 6c5f 776f 726c 6432 7069 7828  s.all_world2pix(
+000036b0: 7264 5b30 5d2c 2072 645b 315d 2c20 3029  rd[0], rd[1], 0)
+000036c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000036d0: 2020 2023 2053 6565 6d73 2062 6163 6b77     # Seems backw
+000036e0: 6172 6473 2061 6e64 2064 6f65 736e 2774  ards and doesn't
+000036f0: 2071 7569 7465 2061 6772 6565 2077 6974   quite agree wit
+00003700: 6820 6162 6f76 650a 2020 2020 2020 2020  h above.        
+00003710: 626c 6f74 5f77 6373 203d 206f 7574 5f77  blot_wcs = out_w
+00003720: 6373 0a20 2020 2020 2020 2073 6f75 7263  cs.        sourc
+00003730: 655f 7763 7320 3d20 696e 5f77 6373 0a0a  e_wcs = in_wcs..
+00003740: 2020 2020 2020 2020 6966 2068 6173 6174          if hasat
+00003750: 7472 2862 6c6f 745f 7763 732c 2027 7069  tr(blot_wcs, 'pi
+00003760: 7865 6c5f 7368 6170 6527 293a 0a20 2020  xel_shape'):.   
+00003770: 2020 2020 2020 2020 206e 782c 206e 7920           nx, ny 
+00003780: 3d20 626c 6f74 5f77 6373 2e70 6978 656c  = blot_wcs.pixel
+00003790: 5f73 6861 7065 0a20 2020 2020 2020 2065  _shape.        e
+000037a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000037b0: 206e 782c 206e 7920 3d20 696e 7428 626c   nx, ny = int(bl
+000037c0: 6f74 5f77 6373 2e5f 6e61 7869 7331 292c  ot_wcs._naxis1),
+000037d0: 2069 6e74 2862 6c6f 745f 7763 732e 5f6e   int(blot_wcs._n
+000037e0: 6178 6973 3229 0a0a 2020 2020 2020 2020  axis2)..        
+000037f0: 6d61 7070 696e 6720 3d20 6364 7269 7a2e  mapping = cdriz.
+00003800: 4465 6661 756c 7457 4353 4d61 7070 696e  DefaultWCSMappin
+00003810: 6728 626c 6f74 5f77 6373 2c20 736f 7572  g(blot_wcs, sour
+00003820: 6365 5f77 6373 2c20 6e78 2c20 6e79 2c0a  ce_wcs, nx, ny,.
+00003830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003850: 2020 2020 2020 2020 2020 7374 6570 7369            stepsi
+00003860: 7a65 290a 2020 2020 2020 2020 7866 2c20  ze).        xf, 
+00003870: 7966 203d 206d 6170 7069 6e67 2878 6f2c  yf = mapping(xo,
+00003880: 2079 6f29 0a0a 2020 2020 7869 2c20 7969   yo)..    xi, yi
+00003890: 203d 206e 702e 6361 7374 5b69 6e74 5d28   = np.cast[int](
+000038a0: 6e70 2e72 6f75 6e64 2878 6629 292c 206e  np.round(xf)), n
+000038b0: 702e 6361 7374 5b69 6e74 5d28 6e70 2e72  p.cast[int](np.r
+000038c0: 6f75 6e64 2879 6629 290a 0a20 2020 206d  ound(yf))..    m
+000038d0: 3220 3d20 2878 6920 3e3d 2030 2920 2620  2 = (xi >= 0) & 
+000038e0: 2879 6920 3e3d 2030 2920 2620 2878 6920  (yi >= 0) & (xi 
+000038f0: 3c20 696e 5f73 685b 315d 2920 2620 2879  < in_sh[1]) & (y
+00003900: 6920 3c20 696e 5f73 685b 305d 290a 2020  i < in_sh[0]).  
+00003910: 2020 7869 2c20 7969 2c20 7866 2c20 7966    xi, yi, xf, yf
+00003920: 2c20 786f 2c20 796f 203d 2078 695b 6d32  , xo, yo = xi[m2
+00003930: 5d2c 2079 695b 6d32 5d2c 2078 665b 6d32  ], yi[m2], xf[m2
+00003940: 5d2c 2079 665b 6d32 5d2c 2078 6f5b 6d32  ], yf[m2], xo[m2
+00003950: 5d2c 2079 6f5b 6d32 5d0a 0a20 2020 206f  ], yo[m2]..    o
+00003960: 7574 5f64 6174 6120 3d20 6e70 2e6f 6e65  ut_data = np.one
+00003970: 7328 6f75 745f 7368 2c20 6474 7970 653d  s(out_sh, dtype=
+00003980: 6e70 2e66 6c6f 6174 3634 292a 6669 6c6c  np.float64)*fill
+00003990: 5f76 616c 7565 0a20 2020 2073 7461 7475  _value.    statu
+000039a0: 7320 3d20 7069 7865 6c5f 6d61 705f 6328  s = pixel_map_c(
+000039b0: 6e70 2e63 6173 745b 6e70 2e66 6c6f 6174  np.cast[np.float
+000039c0: 3634 5d28 696e 5f64 6174 6129 2c20 7869  64](in_data), xi
+000039d0: 2c20 7969 2c20 6f75 745f 6461 7461 2c20  , yi, out_data, 
+000039e0: 786f 2c20 796f 290a 0a20 2020 2023 2046  xo, yo)..    # F
+000039f0: 696c 6c20 656d 7074 790a 2020 2020 6675  ill empty.    fu
+00003a00: 6e63 203d 206e 642e 6d61 7869 6d75 6d5f  nc = nd.maximum_
+00003a10: 6669 6c74 6572 0a20 2020 2066 696c 6c20  filter.    fill 
+00003a20: 3d20 6f75 745f 6461 7461 203d 3d20 300a  = out_data == 0.
+00003a30: 2020 2020 6669 6c74 6572 6564 203d 2066      filtered = f
+00003a40: 756e 6328 6f75 745f 6461 7461 2c20 7369  unc(out_data, si
+00003a50: 7a65 3d35 290a 2020 2020 6f75 745f 6461  ze=5).    out_da
+00003a60: 7461 5b66 696c 6c5d 203d 2066 696c 7465  ta[fill] = filte
+00003a70: 7265 645b 6669 6c6c 5d0a 0a20 2020 2069  red[fill]..    i
+00003a80: 6620 7363 616c 655f 6279 5f70 6978 656c  f scale_by_pixel
+00003a90: 5f61 7265 613a 0a20 2020 2020 2020 2069  _area:.        i
+00003aa0: 6e5f 7363 616c 6520 3d20 6765 745f 7763  n_scale = get_wc
+00003ab0: 735f 7073 6361 6c65 2869 6e5f 7763 7329  s_pscale(in_wcs)
+00003ac0: 0a20 2020 2020 2020 206f 7574 5f73 6361  .        out_sca
+00003ad0: 6c65 203d 2067 6574 5f77 6373 5f70 7363  le = get_wcs_psc
+00003ae0: 616c 6528 6f75 745f 7763 7329 0a20 2020  ale(out_wcs).   
+00003af0: 2020 2020 206f 7574 5f64 6174 6120 2a3d       out_data *=
+00003b00: 206f 7574 5f73 6361 6c65 2a2a 322f 696e   out_scale**2/in
+00003b10: 5f73 6361 6c65 2a2a 320a 0a20 2020 2072  _scale**2..    r
+00003b20: 6574 7572 6e20 6f75 745f 6461 7461 2e61  eturn out_data.a
+00003b30: 7374 7970 6528 696e 5f64 6174 612e 6474  stype(in_data.dt
+00003b40: 7970 6529 0a0a 0a64 6566 205f 736c 6963  ype)...def _slic
+00003b50: 655f 6e64 6669 6c74 6572 2864 6174 612c  e_ndfilter(data,
+00003b60: 2066 696c 7465 725f 6675 6e63 2c20 736c   filter_func, sl
+00003b70: 6963 6573 2c20 6172 6773 2c20 7369 7a65  ices, args, size
+00003b80: 2c20 666f 6f74 7072 696e 742c 206b 7761  , footprint, kwa
+00003b90: 7267 7329 3a0a 2020 2020 2222 220a 2020  rgs):.    """.  
+00003ba0: 2020 4865 6c70 6572 2066 756e 6374 696f    Helper functio
+00003bb0: 6e20 7061 7373 696e 6720 696d 6167 6520  n passing image 
+00003bc0: 736c 6963 6573 2074 6f20 6073 6369 7079  slices to `scipy
+00003bd0: 2e6e 6469 6d61 6765 6020 6669 6c74 6572  .ndimage` filter
+00003be0: 7320 7468 6174 2069 730a 2020 2020 7069  s that is.    pi
+00003bf0: 636b 6c65 6162 6c65 2066 6f72 2074 6872  ckleable for thr
+00003c00: 6561 6469 6e67 2077 6974 6820 606d 756c  eading with `mul
+00003c10: 7469 7072 6f63 6573 7369 6e67 600a 2020  tiprocessing`.  
+00003c20: 2020 0a20 2020 2050 6172 616d 6574 6572    .    Parameter
+00003c30: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00003c40: 0a20 2020 2064 6174 612c 2066 696c 7465  .    data, filte
+00003c50: 725f 6675 6e63 2c20 6172 6773 2c20 7369  r_func, args, si
+00003c60: 7a65 2c20 666f 6f74 7072 696e 7420 3a20  ze, footprint : 
+00003c70: 0a20 2020 2020 2020 2053 6565 2060 6d75  .        See `mu
+00003c80: 6c74 6970 726f 6365 7373 696e 675f 6e64  ltiprocessing_nd
+00003c90: 6669 6c74 6572 600a 2020 2020 0a20 2020  filter`.    .   
+00003ca0: 2073 6c69 6365 7320 3a20 2873 6c69 6365   slices : (slice
+00003cb0: 2c20 736c 6963 652c 2073 6c69 6365 2c20  , slice, slice, 
+00003cc0: 736c 6963 6529 0a20 2020 2020 2020 2041  slice).        A
+00003cd0: 7272 6179 2073 6c69 6365 7320 666f 7220  rray slices for 
+00003ce0: 696e 7365 7274 2061 2063 7574 6f75 7420  insert a cutout 
+00003cf0: 6261 636b 2069 6e74 6f20 6120 6c61 7267  back into a larg
+00003d00: 6572 2070 6172 656e 7420 6172 7261 790a  er parent array.
+00003d10: 2020 2020 2020 2020 0a20 2020 2052 6574          .    Ret
+00003d20: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00003d30: 0a20 2020 2066 696c 7465 7265 6420 3a20  .    filtered : 
+00003d40: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
+00003d50: 2020 2046 696c 7465 7265 6420 6461 7461     Filtered data
+00003d60: 0a20 2020 200a 2020 2020 736c 6963 6573  .    .    slices
+00003d70: 203a 2074 7570 6c65 0a20 2020 2020 2020   : tuple.       
+00003d80: 2060 736c 6963 6573 6020 6173 2069 6e70   `slices` as inp
+00003d90: 7574 0a20 2020 2020 2020 200a 2020 2020  ut.        .    
+00003da0: 2222 220a 2020 2020 6669 6c74 6572 6564  """.    filtered
+00003db0: 203d 2066 696c 7465 725f 6675 6e63 2864   = filter_func(d
+00003dc0: 6174 612c 202a 6172 6773 2c20 0a20 2020  ata, *args, .   
+00003dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003de0: 2020 2020 2020 2020 7369 7a65 3d73 697a          size=siz
+00003df0: 652c 2066 6f6f 7470 7269 6e74 3d66 6f6f  e, footprint=foo
+00003e00: 7470 7269 6e74 2c0a 2020 2020 2020 2020  tprint,.        
+00003e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e20: 2020 202a 2a6b 7761 7267 7329 0a20 2020     **kwargs).   
+00003e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e40: 2020 2020 2020 2020 0a20 2020 2072 6574          .    ret
+00003e50: 7572 6e20 6669 6c74 6572 6564 2c20 736c  urn filtered, sl
+00003e60: 6963 6573 0a0a 0a64 6566 206d 756c 7469  ices...def multi
+00003e70: 7072 6f63 6573 7369 6e67 5f6e 6466 696c  processing_ndfil
+00003e80: 7465 7228 6461 7461 2c20 6669 6c74 6572  ter(data, filter
+00003e90: 5f66 756e 632c 2066 696c 7465 725f 6172  _func, filter_ar
+00003ea0: 6773 3d28 292c 2073 697a 653d 4e6f 6e65  gs=(), size=None
+00003eb0: 2c20 666f 6f74 7072 696e 743d 4e6f 6e65  , footprint=None
+00003ec0: 2c20 6375 746f 7574 5f73 697a 653d 3235  , cutout_size=25
+00003ed0: 362c 206e 5f70 726f 633d 342c 2074 696d  6, n_proc=4, tim
+00003ee0: 656f 7574 3d39 302c 206d 6173 6b3d 4e6f  eout=90, mask=No
+00003ef0: 6e65 2c20 7665 7262 6f73 653d 5472 7565  ne, verbose=True
+00003f00: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00003f10: 2022 2222 0a20 2020 2043 7574 2075 7020   """.    Cut up 
+00003f20: 6120 6c61 7267 6520 6172 7261 7920 616e  a large array an
+00003f30: 6420 7365 6e64 2073 6c69 6365 7320 746f  d send slices to
+00003f40: 2060 7363 6970 792e 6e64 696d 6167 6560   `scipy.ndimage`
+00003f50: 2066 696c 7465 7273 0a20 2020 200a 2020   filters.    .  
+00003f60: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00003f70: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00003f80: 0a20 2020 2064 6174 6120 3a20 6172 7261  .    data : arra
+00003f90: 792d 6c69 6b65 0a20 2020 2020 2020 204d  y-like.        M
+00003fa0: 6169 6e20 696d 6167 6520 6172 7261 790a  ain image array.
+00003fb0: 2020 2020 2020 2020 0a20 2020 2066 696c          .    fil
+00003fc0: 7465 725f 6675 6e63 203a 2066 756e 6374  ter_func : funct
+00003fd0: 696f 6e0a 2020 2020 2020 2020 4669 6c74  ion.        Filt
+00003fe0: 6572 696e 6720 6675 6e63 7469 6f6e 2c20  ering function, 
+00003ff0: 652e 672e 2c20 6073 6369 7079 2e6e 6469  e.g., `scipy.ndi
+00004000: 6d61 6765 2e6d 6564 6961 6e5f 6669 6c74  mage.median_filt
+00004010: 6572 600a 2020 2020 0a20 2020 2066 696c  er`.    .    fil
+00004020: 7465 725f 6172 6773 203a 2074 7570 6c65  ter_args : tuple
+00004030: 0a20 2020 2020 2020 2041 7267 756d 656e  .        Argumen
+00004040: 7473 2074 6f20 7061 7373 2074 6f20 6066  ts to pass to `f
+00004050: 696c 7465 725f 6675 6e63 600a 2020 2020  ilter_func`.    
+00004060: 0a20 2020 2073 697a 652c 2066 6f6f 7470  .    size, footp
+00004070: 7269 6e74 203a 2069 6e74 2c20 6172 7261  rint : int, arra
+00004080: 792d 6c69 6b65 0a20 2020 2020 2020 2046  y-like.        F
+00004090: 696c 7465 7220 7369 7a65 206f 7220 666f  ilter size or fo
+000040a0: 6f74 7072 696e 742c 2073 6565 2c20 652e  otprint, see, e.
+000040b0: 672e 2c20 6073 6369 7079 2e6e 6469 6d61  g., `scipy.ndima
+000040c0: 6765 2e6d 6564 6961 6e5f 6669 6c74 6572  ge.median_filter
+000040d0: 600a 2020 2020 0a20 2020 2063 7574 6f75  `.    .    cutou
+000040e0: 745f 7369 7a65 203a 2069 6e74 0a20 2020  t_size : int.   
+000040f0: 2020 2020 2053 697a 6520 6f66 2073 7562       Size of sub
+00004100: 696d 6167 6520 6375 746f 7574 730a 2020  image cutouts.  
+00004110: 2020 0a20 2020 206e 5f70 726f 6320 3a20    .    n_proc : 
+00004120: 696e 740a 2020 2020 2020 2020 4e75 6d62  int.        Numb
+00004130: 6572 206f 6620 606d 756c 7469 7072 6f63  er of `multiproc
+00004140: 6573 7369 6e67 6020 7072 6f63 6573 7365  essing` processe
+00004150: 7320 746f 2075 7365 0a20 2020 200a 2020  s to use.    .  
+00004160: 2020 7469 6d65 6f75 7420 3a20 666c 6f61    timeout : floa
+00004170: 740a 2020 2020 2020 2020 606d 756c 7469  t.        `multi
+00004180: 7072 6f63 6573 7369 6e67 6020 7469 6d65  processing` time
+00004190: 6f75 7420 2873 6563 6f6e 6473 290a 2020  out (seconds).  
+000041a0: 2020 0a20 2020 206d 6173 6b20 3a20 6172    .    mask : ar
+000041b0: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
+000041c0: 2041 7272 6179 206d 756c 7469 706c 6965   Array multiplie
+000041d0: 6420 746f 2060 6461 7461 6020 7468 6174  d to `data` that
+000041e0: 2063 616e 207a 6572 6f2d 6f75 7420 7265   can zero-out re
+000041f0: 6769 6f6e 7320 746f 2069 676e 6f72 650a  gions to ignore.
+00004200: 2020 2020 0a20 2020 2076 6572 626f 7365      .    verbose
+00004210: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+00004220: 5072 696e 7420 7374 6174 7573 206d 6573  Print status mes
+00004230: 7361 6765 730a 2020 2020 2020 2020 0a20  sages.        . 
+00004240: 2020 206b 7761 7267 7320 3a20 6469 6374     kwargs : dict
+00004250: 0a20 2020 2020 2020 204b 6579 776f 7264  .        Keyword
+00004260: 2061 7267 756d 656e 7473 2070 6173 7365   arguments passe
+00004270: 6420 7468 726f 7567 6820 746f 2060 6669  d through to `fi
+00004280: 6c74 6572 5f66 756e 6360 0a20 2020 2020  lter_func`.     
+00004290: 2020 200a 2020 2020 5265 7475 726e 730a     .    Returns.
+000042a0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+000042b0: 6669 6c74 6572 6564 203a 2061 7272 6179  filtered : array
+000042c0: 2d6c 696b 650a 2020 2020 2020 2020 4669  -like.        Fi
+000042d0: 6c74 6572 6564 2076 6572 7369 6f6e 206f  ltered version o
+000042e0: 6620 6064 6174 6160 0a20 2020 200a 2020  f `data`.    .  
+000042f0: 2020 4578 616d 706c 6573 0a20 2020 202d    Examples.    -
+00004300: 2d2d 2d2d 2d2d 2d0a 0a20 2020 2020 2020  -------..       
+00004310: 203e 3e3e 2069 6d70 6f72 7420 7469 6d65   >>> import time
+00004320: 0a20 2020 2020 2020 203e 3e3e 2069 6d70  .        >>> imp
+00004330: 6f72 7420 6e75 6d70 7920 6173 206e 700a  ort numpy as np.
+00004340: 2020 2020 2020 2020 3e3e 3e20 696d 706f          >>> impo
+00004350: 7274 2073 6369 7079 2e6e 6469 6d61 6765  rt scipy.ndimage
+00004360: 2061 7320 6e64 0a20 2020 2020 2020 203e   as nd.        >
+00004370: 3e3e 2066 726f 6d20 6772 697a 6c69 2e75  >> from grizli.u
+00004380: 7469 6c73 2069 6d70 6f72 7420 6d75 6c74  tils import mult
+00004390: 6970 726f 6365 7373 696e 675f 6e64 6669  iprocessing_ndfi
+000043a0: 6c74 6572 0a20 2020 2020 2020 203e 3e3e  lter.        >>>
+000043b0: 2072 6e64 203d 206e 702e 7261 6e64 6f6d   rnd = np.random
+000043c0: 2e6e 6f72 6d61 6c28 7369 7a65 3d28 3531  .normal(size=(51
+000043d0: 322c 3531 3229 290a 2020 2020 2020 2020  2,512)).        
+000043e0: 3e3e 3e20 7430 203d 2074 696d 652e 7469  >>> t0 = time.ti
+000043f0: 6d65 2829 0a20 2020 2020 2020 203e 3e3e  me().        >>>
+00004400: 2066 5f73 6572 6961 6c20 3d20 6e64 2e6d   f_serial = nd.m
+00004410: 6564 6961 6e5f 6669 6c74 6572 2872 6e64  edian_filter(rnd
+00004420: 2c20 7369 7a65 3d31 3029 0a20 2020 2020  , size=10).     
+00004430: 2020 203e 3e3e 2074 3120 3d20 7469 6d65     >>> t1 = time
+00004440: 2e74 696d 6528 290a 2020 2020 2020 2020  .time().        
+00004450: 3e3e 3e20 665f 6d70 203d 206d 756c 7469  >>> f_mp = multi
+00004460: 7072 6f63 6573 7369 6e67 5f6e 6466 696c  processing_ndfil
+00004470: 7465 7228 726e 642c 206e 642e 6d65 6469  ter(rnd, nd.medi
+00004480: 616e 5f66 696c 7465 722c 2073 697a 653d  an_filter, size=
+00004490: 3130 2c0a 2020 2020 2020 2020 3e3e 3e20  10,.        >>> 
+000044a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044c0: 6375 746f 7574 5f73 697a 653d 3235 362c  cutout_size=256,
+000044d0: 206e 5f70 726f 633d 3429 0a20 2020 2020   n_proc=4).     
+000044e0: 2020 203e 3e3e 2074 3220 3d20 7469 6d65     >>> t2 = time
+000044f0: 2e74 696d 6528 290a 2020 2020 2020 2020  .time().        
+00004500: 3e3e 3e20 6e70 2e61 6c6c 636c 6f73 6528  >>> np.allclose(
+00004510: 665f 7365 7269 616c 2c20 665f 6d70 290a  f_serial, f_mp).
+00004520: 2020 2020 2020 2020 5472 7565 0a20 2020          True.   
+00004530: 2020 2020 203e 3e3e 2070 7269 6e74 2866       >>> print(f
+00004540: 2720 2073 6572 6961 6c3a 207b 2874 312d  '  serial: {(t1-
+00004550: 7430 292a 3130 3030 3a2e 3166 7d20 6d73  t0)*1000:.1f} ms
+00004560: 2729 0a20 2020 2020 2020 203e 3e3e 2070  ').        >>> p
+00004570: 7269 6e74 2866 2770 6172 616c 6c65 6c3a  rint(f'parallel:
+00004580: 207b 2874 322d 7431 292a 3130 3030 3a2e   {(t2-t1)*1000:.
+00004590: 3166 7d20 6d73 2729 0a20 2020 2020 2020  1f} ms').       
+000045a0: 2020 2073 6572 6961 6c3a 2035 3733 2e39     serial: 573.9
+000045b0: 206d 730a 2020 2020 2020 2020 7061 7261   ms.        para
+000045c0: 6c6c 656c 3a20 3231 342e 3820 6d73 0a20  llel: 214.8 ms. 
+000045d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045f0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00004600: 2222 220a 2020 2020 0a20 2020 2069 6d70  """.    .    imp
+00004610: 6f72 7420 6d75 6c74 6970 726f 6365 7373  ort multiprocess
+00004620: 696e 6720 6173 206d 700a 2020 2020 0a20  ing as mp.    . 
+00004630: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00004640: 6672 6f6d 2074 7164 6d20 696d 706f 7274  from tqdm import
+00004650: 2074 7164 6d0a 2020 2020 6578 6365 7074   tqdm.    except
+00004660: 2049 6d70 6f72 7445 7272 6f72 3a0a 2020   ImportError:.  
+00004670: 2020 2020 2020 7665 7262 6f73 6520 3d20        verbose = 
+00004680: 4661 6c73 650a 2020 2020 2020 2020 0a20  False.        . 
+00004690: 2020 2073 6820 3d20 6461 7461 2e73 6861     sh = data.sha
+000046a0: 7065 0a20 2020 200a 2020 2020 6d73 6720  pe.    .    msg 
+000046b0: 3d20 4e6f 6e65 0a20 2020 200a 2020 2020  = None.    .    
+000046c0: 6966 2063 7574 6f75 745f 7369 7a65 203e  if cutout_size >
+000046d0: 206e 702e 6d61 7828 7368 293a 0a20 2020   np.max(sh):.   
+000046e0: 2020 2020 206d 7367 203d 2066 2763 7574       msg = f'cut
+000046f0: 6f75 745f 7369 7a65 3d7b 6375 746f 7574  out_size={cutout
+00004700: 5f73 697a 657d 2067 7265 6174 6572 2074  _size} greater t
+00004710: 6861 6e20 696d 6167 6520 6469 6d65 6e73  han image dimens
+00004720: 696f 6e73 2c20 7275 6e20 270a 2020 2020  ions, run '.    
+00004730: 2020 2020 6d73 6720 2b3d 2066 2760 7b66      msg += f'`{f
+00004740: 696c 7465 725f 6675 6e63 7d60 2064 6972  ilter_func}` dir
+00004750: 6563 746c 7927 0a20 2020 2065 6c69 6620  ectly'.    elif 
+00004760: 6e5f 7072 6f63 203d 3d20 303a 0a20 2020  n_proc == 0:.   
+00004770: 2020 2020 206d 7367 203d 2066 276e 5f70       msg = f'n_p
+00004780: 726f 6320 3d20 302c 2072 756e 2069 6e20  roc = 0, run in 
+00004790: 6120 7369 6e67 6c65 2063 6f6d 6d61 6e64  a single command
+000047a0: 270a 2020 2020 0a20 2020 2069 6620 6d73  '.    .    if ms
+000047b0: 6720 6973 206e 6f74 204e 6f6e 653a 0a20  g is not None:. 
+000047c0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+000047d0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+000047e0: 7269 6e74 286d 7367 290a 2020 2020 2020  rint(msg).      
+000047f0: 2020 2020 2020 0a20 2020 2020 2020 2066        .        f
+00004800: 696c 7465 7265 6420 3d20 6669 6c74 6572  iltered = filter
+00004810: 5f66 756e 6328 6461 7461 2c20 2a66 696c  _func(data, *fil
+00004820: 7465 725f 6172 6773 2c20 0a20 2020 2020  ter_args, .     
+00004830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004840: 2020 2020 2020 2020 2020 7369 7a65 3d73            size=s
+00004850: 697a 652c 2066 6f6f 7470 7269 6e74 3d66  ize, footprint=f
+00004860: 6f6f 7470 7269 6e74 290a 2020 2020 2020  ootprint).      
+00004870: 2020 7265 7475 726e 2066 696c 7465 7265    return filtere
+00004880: 640a 2020 2020 0a20 2020 2023 2047 7269  d.    .    # Gri
+00004890: 6420 7369 7a65 0a20 2020 206e 7820 3d20  d size.    nx = 
+000048a0: 6461 7461 2e73 6861 7065 5b31 5d2f 2f63  data.shape[1]//c
+000048b0: 7574 6f75 745f 7369 7a65 2b31 0a20 2020  utout_size+1.   
+000048c0: 206e 7920 3d20 6461 7461 2e73 6861 7065   ny = data.shape
+000048d0: 5b30 5d2f 2f63 7574 6f75 745f 7369 7a65  [0]//cutout_size
+000048e0: 2b31 0a0a 2020 2020 2320 5061 6464 696e  +1..    # Paddin
+000048f0: 670a 2020 2020 6966 2066 6f6f 7470 7269  g.    if footpri
+00004900: 6e74 2069 7320 6e6f 7420 4e6f 6e65 3a0a  nt is not None:.
+00004910: 2020 2020 2020 2020 6670 7368 203d 2066          fpsh = f
+00004920: 6f6f 7470 7269 6e74 2e73 6861 7065 0a20  ootprint.shape. 
+00004930: 2020 2020 2020 2070 6164 203d 206e 702e         pad = np.
+00004940: 6d61 7828 6670 7368 290a 2020 2020 656c  max(fpsh).    el
+00004950: 6966 2073 697a 6520 6973 206e 6f74 204e  if size is not N
+00004960: 6f6e 653a 0a20 2020 2020 2020 2070 6164  one:.        pad
+00004970: 203d 2073 697a 650a 2020 2020 656c 7365   = size.    else
+00004980: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00004990: 5661 6c75 6545 7272 6f72 2827 4569 7468  ValueError('Eith
+000049a0: 6572 2073 697a 6520 6f72 2066 6f6f 7470  er size or footp
+000049b0: 7269 6e74 206d 7573 7420 6265 2073 7065  rint must be spe
+000049c0: 6369 6669 6564 2729 0a20 2020 2020 2020  cified').       
+000049d0: 200a 2020 2020 6966 206e 5f70 726f 6320   .    if n_proc 
+000049e0: 3c20 303a 0a20 2020 2020 2020 206e 5f70  < 0:.        n_p
+000049f0: 726f 6320 3d20 6d70 2e63 7075 5f63 6f75  roc = mp.cpu_cou
+00004a00: 6e74 2829 0a0a 2020 2020 6e5f 7072 6f63  nt()..    n_proc
+00004a10: 203d 206e 702e 6d69 6e69 6d75 6d28 6e5f   = np.minimum(n_
+00004a20: 7072 6f63 2c20 6d70 2e63 7075 5f63 6f75  proc, mp.cpu_cou
+00004a30: 6e74 2829 290a 0a20 2020 2070 6f6f 6c20  nt())..    pool 
+00004a40: 3d20 6d70 2e50 6f6f 6c28 7072 6f63 6573  = mp.Pool(proces
+00004a50: 7365 733d 6e5f 7072 6f63 290a 2020 2020  ses=n_proc).    
+00004a60: 6a6f 6273 203d 205b 5d0a 2020 2020 0a20  jobs = [].    . 
+00004a70: 2020 2069 6620 6d61 736b 2069 7320 6e6f     if mask is no
+00004a80: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00004a90: 6461 7461 5f6d 6173 6b20 3d20 6461 7461  data_mask = data
+00004aa0: 2a6d 6173 6b0a 2020 2020 656c 7365 3a0a  *mask.    else:.
+00004ab0: 2020 2020 2020 2020 6461 7461 5f6d 6173          data_mas
+00004ac0: 6b20 3d20 6461 7461 0a20 2020 2020 2020  k = data.       
+00004ad0: 200a 2020 2020 2320 4d61 6b65 2069 6d61   .    # Make ima
+00004ae0: 6765 2073 6c69 6365 730a 2020 2020 666f  ge slices.    fo
+00004af0: 7220 6920 696e 2072 616e 6765 286e 7829  r i in range(nx)
+00004b00: 3a0a 2020 2020 2020 2020 786d 6920 3d20  :.        xmi = 
+00004b10: 6e70 2e6d 6178 696d 756d 2830 2c20 692a  np.maximum(0, i*
+00004b20: 6375 746f 7574 5f73 697a 652d 7061 6429  cutout_size-pad)
+00004b30: 0a20 2020 2020 2020 2078 6d61 203d 206e  .        xma = n
+00004b40: 702e 6d69 6e69 6d75 6d28 7368 5b31 5d2c  p.minimum(sh[1],
+00004b50: 2028 692b 3129 2a63 7574 6f75 745f 7369   (i+1)*cutout_si
+00004b60: 7a65 2b70 6164 290a 2020 2020 2020 2020  ze+pad).        
+00004b70: 0a20 2020 2020 2020 2023 7072 696e 7428  .        #print(
+00004b80: 692c 2078 6d69 2c20 786d 6129 0a20 2020  i, xmi, xma).   
+00004b90: 2020 2020 2069 6620 6920 3d3d 2030 3a0a       if i == 0:.
+00004ba0: 2020 2020 2020 2020 2020 2020 736c 7820              slx 
+00004bb0: 3d20 736c 6963 6528 302c 2063 7574 6f75  = slice(0, cutou
+00004bc0: 745f 7369 7a65 290a 2020 2020 2020 2020  t_size).        
+00004bd0: 2020 2020 7830 203d 2030 0a20 2020 2020      x0 = 0.     
+00004be0: 2020 2065 6c69 6620 6920 3c20 6e78 2d31     elif i < nx-1
+00004bf0: 3a0a 2020 2020 2020 2020 2020 2020 736c  :.            sl
+00004c00: 7820 3d20 736c 6963 6528 7061 642c 2063  x = slice(pad, c
+00004c10: 7574 6f75 745f 7369 7a65 202b 2070 6164  utout_size + pad
+00004c20: 290a 2020 2020 2020 2020 2020 2020 7830  ).            x0
+00004c30: 203d 2069 2a63 7574 6f75 745f 7369 7a65   = i*cutout_size
+00004c40: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00004c50: 2020 2020 2020 2020 2020 2073 6c78 203d             slx =
+00004c60: 2073 6c69 6365 2870 6164 2c20 6375 746f   slice(pad, cuto
+00004c70: 7574 5f73 697a 6520 2b20 3129 0a20 2020  ut_size + 1).   
+00004c80: 2020 2020 2020 2020 2078 3020 3d20 786d           x0 = xm
+00004c90: 692b 7061 640a 0a20 2020 2020 2020 206e  i+pad..        n
+00004ca0: 7873 203d 2073 6c78 2e73 746f 7020 2d20  xs = slx.stop - 
+00004cb0: 736c 782e 7374 6172 740a 2020 2020 2020  slx.start.      
+00004cc0: 2020 6f73 6c78 203d 2073 6c69 6365 2878    oslx = slice(x
+00004cd0: 302c 2078 302b 6e78 7329 0a20 2020 2020  0, x0+nxs).     
+00004ce0: 2020 200a 2020 2020 2020 2020 666f 7220     .        for 
+00004cf0: 6a20 696e 2072 616e 6765 286e 7929 3a0a  j in range(ny):.
+00004d00: 2020 2020 2020 2020 2020 2020 796d 6920              ymi 
+00004d10: 3d20 6e70 2e6d 6178 696d 756d 2830 2c20  = np.maximum(0, 
+00004d20: 6a2a 6375 746f 7574 5f73 697a 6520 2d20  j*cutout_size - 
+00004d30: 7061 6429 0a20 2020 2020 2020 2020 2020  pad).           
+00004d40: 2079 6d61 203d 206e 702e 6d69 6e69 6d75   yma = np.minimu
+00004d50: 6d28 7368 5b30 5d2c 2028 6a2b 3129 2a63  m(sh[0], (j+1)*c
+00004d60: 7574 6f75 745f 7369 7a65 202b 2070 6164  utout_size + pad
+00004d70: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
+00004d80: 2020 2020 2020 2020 2020 2069 6620 6a20             if j 
+00004d90: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00004da0: 2020 2020 2020 736c 7920 3d20 736c 6963        sly = slic
+00004db0: 6528 302c 2063 7574 6f75 745f 7369 7a65  e(0, cutout_size
+00004dc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00004dd0: 2020 7930 203d 2030 0a20 2020 2020 2020    y0 = 0.       
+00004de0: 2020 2020 2065 6c69 6620 6a20 3c20 6e79       elif j < ny
+00004df0: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
+00004e00: 2020 2020 736c 7920 3d20 736c 6963 6528      sly = slice(
+00004e10: 7061 642c 2063 7574 6f75 745f 7369 7a65  pad, cutout_size
+00004e20: 202b 2070 6164 290a 2020 2020 2020 2020   + pad).        
+00004e30: 2020 2020 2020 2020 7930 203d 206a 2a63          y0 = j*c
+00004e40: 7574 6f75 745f 7369 7a65 0a20 2020 2020  utout_size.     
+00004e50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00004e60: 2020 2020 2020 2020 2020 2020 2073 6c79               sly
+00004e70: 203d 2073 6c69 6365 2870 6164 2c20 6375   = slice(pad, cu
+00004e80: 746f 7574 5f73 697a 6520 2b20 3129 0a20  tout_size + 1). 
+00004e90: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00004ea0: 3020 3d20 796d 692b 7061 640a 2020 2020  0 = ymi+pad.    
+00004eb0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00004ec0: 2020 2020 206e 7973 203d 2073 6c79 2e73       nys = sly.s
+00004ed0: 746f 7020 2d20 736c 792e 7374 6172 740a  top - sly.start.
+00004ee0: 2020 2020 2020 2020 2020 2020 6f73 6c79              osly
+00004ef0: 203d 2073 6c69 6365 2879 302c 2079 302b   = slice(y0, y0+
+00004f00: 6e79 7329 0a20 2020 2020 2020 200a 2020  nys).        .  
+00004f10: 2020 2020 2020 2020 2020 6375 7420 3d20            cut = 
+00004f20: 6461 7461 5f6d 6173 6b5b 796d 693a 796d  data_mask[ymi:ym
+00004f30: 612c 2078 6d69 3a78 6d61 5d0a 2020 2020  a, xmi:xma].    
+00004f40: 2020 2020 2020 2020 6966 2063 7574 2e6d          if cut.m
+00004f50: 6178 2829 203d 3d20 303a 0a20 2020 2020  ax() == 0:.     
+00004f60: 2020 2020 2020 2020 2020 2023 7072 696e             #prin
+00004f70: 7428 6627 536b 6970 207b 786d 697d 207b  t(f'Skip {xmi} {
+00004f80: 786d 617d 207b 796d 697d 207b 796d 617d  xma} {ymi} {yma}
+00004f90: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00004fa0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00004fb0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00004fc0: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
+00004fd0: 6a6f 6273 2066 6f72 2066 696c 7465 7269  jobs for filteri
+00004fe0: 6e67 2074 6865 2069 6d61 6765 2073 6c69  ng the image sli
+00004ff0: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+00005000: 736c 6963 6573 203d 2028 6f73 6c79 2c20  slices = (osly, 
+00005010: 6f73 6c78 2c20 736c 792c 2073 6c78 290a  oslx, sly, slx).
+00005020: 2020 2020 2020 2020 2020 2020 5f61 7267              _arg
+00005030: 7320 3d20 2863 7574 2c20 6669 6c74 6572  s = (cut, filter
+00005040: 5f66 756e 632c 2073 6c69 6365 732c 200a  _func, slices, .
+00005050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005060: 2020 2020 2066 696c 7465 725f 6172 6773       filter_args
+00005070: 2c20 7369 7a65 2c20 666f 6f74 7072 696e  , size, footprin
+00005080: 742c 206b 7761 7267 7329 0a20 2020 2020  t, kwargs).     
+00005090: 2020 2020 2020 206a 6f62 732e 6170 7065         jobs.appe
+000050a0: 6e64 2870 6f6f 6c2e 6170 706c 795f 6173  nd(pool.apply_as
+000050b0: 796e 6328 5f73 6c69 6365 5f6e 6466 696c  ync(_slice_ndfil
+000050c0: 7465 722c 205f 6172 6773 2929 0a20 2020  ter, _args)).   
+000050d0: 2020 2020 2020 2020 200a 2020 2020 2320           .    # 
+000050e0: 436f 6c6c 6563 7420 7265 7375 6c74 730a  Collect results.
+000050f0: 2020 2020 706f 6f6c 2e63 6c6f 7365 2829      pool.close()
+00005100: 0a0a 2020 2020 6669 6c74 6572 6564 203d  ..    filtered =
+00005110: 206e 702e 7a65 726f 735f 6c69 6b65 2864   np.zeros_like(d
+00005120: 6174 6129 0a20 2020 200a 2020 2020 6966  ata).    .    if
+00005130: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00005140: 2020 5f69 7465 7220 3d20 7471 646d 286a    _iter = tqdm(j
+00005150: 6f62 7329 0a20 2020 2065 6c73 653a 0a20  obs).    else:. 
+00005160: 2020 2020 2020 205f 6974 6572 203d 206a         _iter = j
+00005170: 6f62 730a 2020 2020 2020 2020 0a20 2020  obs.        .   
+00005180: 2066 6f72 2072 6573 2069 6e20 5f69 7465   for res in _ite
+00005190: 723a 0a20 2020 2020 2020 2066 696c 7465  r:.        filte
+000051a0: 7265 645f 692c 2073 6c69 6365 7320 3d20  red_i, slices = 
+000051b0: 7265 732e 6765 7428 7469 6d65 6f75 743d  res.get(timeout=
+000051c0: 7469 6d65 6f75 7429 0a20 2020 2020 2020  timeout).       
+000051d0: 2066 696c 7465 7265 645b 736c 6963 6573   filtered[slices
+000051e0: 5b3a 325d 5d20 2b3d 2066 696c 7465 7265  [:2]] += filtere
+000051f0: 645f 695b 736c 6963 6573 5b32 3a5d 5d0a  d_i[slices[2:]].
+00005200: 0a20 2020 2072 6574 7572 6e20 6669 6c74  .    return filt
+00005210: 6572 6564 0a0a 6465 6620 7061 7273 655f  ered..def parse_
+00005220: 666c 745f 6669 6c65 7328 6669 6c65 733d  flt_files(files=
+00005230: 5b5d 2c20 696e 666f 3d4e 6f6e 652c 2075  [], info=None, u
+00005240: 6e69 7175 656e 616d 653d 4661 6c73 652c  niquename=False,
+00005250: 2075 7365 5f76 6973 6974 3d46 616c 7365   use_visit=False
+00005260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00005270: 2020 2020 2020 6765 745f 666f 6f74 7072        get_footpr
+00005280: 696e 743d 4661 6c73 652c 0a20 2020 2020  int=False,.     
+00005290: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000052a0: 7261 6e73 6c61 7465 3d7b 2741 4547 4953  ranslate={'AEGIS
+000052b0: 2d27 3a20 2761 6567 6973 2d27 2c0a 2020  -': 'aegis-',.  
+000052c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000052e0: 434f 534d 4f53 2d27 3a20 2763 6f73 6d6f  COSMOS-': 'cosmo
+000052f0: 732d 272c 0a20 2020 2020 2020 2020 2020  s-',.           
+00005300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005310: 2020 2020 2020 2747 4e47 5249 534d 273a        'GNGRISM':
+00005320: 2027 676f 6f64 736e 2d27 2c0a 2020 2020   'goodsn-',.    
+00005330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005340: 2020 2020 2020 2020 2020 2020 2027 474f               'GO
+00005350: 4f44 532d 534f 5554 482d 273a 2027 676f  ODS-SOUTH-': 'go
+00005360: 6f64 7373 2d27 2c0a 2020 2020 2020 2020  odss-',.        
+00005370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005380: 2020 2020 2020 2020 2027 5544 532d 273a           'UDS-':
+00005390: 2027 7564 732d 277d 2c0a 2020 2020 2020   'uds-'},.      
+000053a0: 2020 2020 2020 2020 2020 2020 2020 7669                vi
+000053b0: 7369 745f 7370 6c69 745f 7368 6966 743d  sit_split_shift=
+000053c0: 312e 352c 206d 6178 5f64 743d 3165 392c  1.5, max_dt=1e9,
+000053d0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+000053e0: 2020 2020 2020 7061 7468 3d27 2e2e 2f52        path='../R
+000053f0: 4157 2729 3a0a 2020 2020 2222 2252 6561  AW'):.    """Rea
+00005400: 6420 6865 6164 6572 2069 6e66 6f72 6d61  d header informa
+00005410: 7469 6f6e 2066 726f 6d20 6120 6c69 7374  tion from a list
+00005420: 206f 6620 6578 706f 7375 7265 7320 616e   of exposures an
+00005430: 6420 7061 7273 6520 6f75 7420 6772 6f75  d parse out grou
+00005440: 7073 2062 6173 6564 206f 6e20 6669 6c74  ps based on filt
+00005450: 6572 2f74 6172 6765 742f 6f72 6965 6e74  er/target/orient
+00005460: 6174 696f 6e2e 0a0a 2020 2020 5061 7261  ation...    Para
+00005470: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00005480: 2d2d 2d2d 2d0a 2020 2020 6669 6c65 7320  -----.    files 
+00005490: 3a20 6c69 7374 0a20 2020 2020 2020 204c  : list.        L
+000054a0: 6973 7420 6f66 2065 7870 6f73 7572 6520  ist of exposure 
+000054b0: 6669 6c65 6e61 6d65 732e 2020 4966 206e  filenames.  If n
+000054c0: 6f74 2073 7065 6369 6669 6564 2c20 7769  ot specified, wi
+000054d0: 6c6c 2075 7365 2060 602a 666c 742e 6669  ll use ``*flt.fi
+000054e0: 7473 6060 2e0a 0a20 2020 2069 6e66 6f20  ts``...    info 
+000054f0: 3a20 4e6f 6e65 206f 7220 607e 6173 7472  : None or `~astr
+00005500: 6f70 792e 7461 626c 652e 5461 626c 6560  opy.table.Table`
+00005510: 0a20 2020 2020 2020 204f 7574 7075 7420  .        Output 
+00005520: 6672 6f6d 2060 7e67 7269 7a6c 692e 7574  from `~grizli.ut
+00005530: 696c 732e 6765 745f 666c 745f 696e 666f  ils.get_flt_info
+00005540: 602e 0a20 2020 2020 2020 200a 2020 2020  `..        .    
+00005550: 756e 6971 7565 6e61 6d65 203a 2062 6f6f  uniquename : boo
+00005560: 6c0a 2020 2020 2020 2020 4966 2054 7275  l.        If Tru
+00005570: 652c 2074 6865 6e20 7370 6c69 7420 6576  e, then split ev
+00005580: 6572 7974 6869 6e67 2062 7920 7072 6f67  erything by prog
+00005590: 7261 6d20 4944 2061 6e64 2076 6973 6974  ram ID and visit
+000055a0: 206e 616d 652e 2020 4966 0a20 2020 2020   name.  If.     
+000055b0: 2020 2046 616c 7365 2c20 7468 656e 206a     False, then j
+000055c0: 7573 7420 6772 6f75 7020 6279 2074 6172  ust group by tar
+000055d0: 676e 616d 652f 6669 6c74 6572 2f70 615f  gname/filter/pa_
+000055e0: 7633 2e0a 0a20 2020 2075 7365 5f76 6973  v3...    use_vis
+000055f0: 6974 203a 2062 6f6f 6c0a 2020 2020 2020  it : bool.      
+00005600: 2020 466f 7220 7061 7261 6c6c 656c 206f    For parallel o
+00005610: 6273 6572 7661 7469 6f6e 7320 7769 7468  bservations with
+00005620: 2060 6074 6172 676e 616d 653d 2741 4e59   ``targname='ANY
+00005630: 2760 602c 2075 7365 2074 6865 2066 696c  '``, use the fil
+00005640: 656e 616d 650a 2020 2020 2020 2020 7570  ename.        up
+00005650: 2074 6f20 7468 6520 7669 7369 7420 4944   to the visit ID
+00005660: 2061 7320 7468 6520 7461 7267 6574 206e   as the target n
+00005670: 616d 652e 2020 466f 7220 6578 616d 706c  ame.  For exampl
+00005680: 653a 0a0a 2020 2020 2020 2020 2020 2020  e:..            
+00005690: 3e3e 3e20 666c 6320 3d20 276a 6268 6a36  >>> flc = 'jbhj6
+000056a0: 3464 3871 5f66 6c63 2e66 6974 7327 0a20  4d8q_flc.fits'. 
+000056b0: 2020 2020 2020 2020 2020 203e 3e3e 2076             >>> v
+000056c0: 6973 6974 5f74 6172 676e 616d 6520 3d20  isit_targname = 
+000056d0: 666c 635b 3a36 5d0a 2020 2020 2020 2020  flc[:6].        
+000056e0: 2020 2020 3e3e 3e20 7072 696e 7428 7669      >>> print(vi
+000056f0: 7369 745f 7461 7267 6e61 6d65 290a 2020  sit_targname).  
+00005700: 2020 2020 2020 2020 2020 6a62 686a 3634            jbhj64
+00005710: 0a0a 2020 2020 2020 2020 4966 2046 616c  ..        If Fal
+00005720: 7365 2c20 6765 6e65 7261 7465 2061 2074  se, generate a t
+00005730: 6172 676e 616d 6520 666f 7220 7061 7261  argname for para
+00005740: 6c6c 656c 206f 6273 6572 7661 7469 6f6e  llel observation
+00005750: 7320 6261 7365 6420 6f6e 2074 6865 0a20  s based on the. 
+00005760: 2020 2020 2020 2070 6f69 6e74 696e 6720         pointing 
+00005770: 636f 6f72 6469 6e61 7465 7320 7573 696e  coordinates usin
+00005780: 6720 6072 6164 6563 5f74 6f5f 7461 7267  g `radec_to_targ
+00005790: 6e61 6d65 602e 2020 5573 6520 7468 6973  name`.  Use this
+000057a0: 206b 6579 776f 7264 0a20 2020 2020 2020   keyword.       
+000057b0: 2066 6f72 2064 6974 6865 7265 6420 7061   for dithered pa
+000057c0: 7261 6c6c 656c 7320 6c69 6b65 2033 442d  rallels like 3D-
+000057d0: 4853 5420 2f20 474c 4153 5320 6275 7420  HST / GLASS but 
+000057e0: 7365 7420 746f 2046 616c 7365 2066 6f72  set to False for
+000057f0: 0a20 2020 2020 2020 2075 6e64 6974 6865  .        undithe
+00005800: 7265 6420 7061 7261 6c6c 656c 7320 6c69  red parallels li
+00005810: 6b65 2057 4953 502e 2020 5368 6f75 6c64  ke WISP.  Should
+00005820: 2061 6c73 6f20 6765 6e65 7261 6c6c 7920   also generally 
+00005830: 6265 2075 7365 6420 7769 7468 0a20 2020  be used with.   
+00005840: 2020 2020 2060 6075 6e69 7175 656e 616d       ``uniquenam
+00005850: 653d 4661 6c73 6560 6020 6f74 6865 7277  e=False`` otherw
+00005860: 6973 6520 6765 6e65 7261 7465 7320 6e61  ise generates na
+00005870: 6d65 7320 7468 6174 2061 7265 2061 2062  mes that are a b
+00005880: 6974 200a 2020 2020 2020 2020 7265 6475  it .        redu
+00005890: 6e64 616e 743a 0a0a 2020 2020 2020 2020  ndant:..        
+000058a0: 2020 2020 2b2d 2d2d 2d2d 2d2d 2d2d 2d2d      +-----------
+000058b0: 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ---+------------
+000058c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2b  ---------------+
+000058d0: 0a20 2020 2020 2020 2020 2020 207c 2060  .            | `
+000058e0: 756e 6971 7565 6e61 6d65 6020 7c20 4f75  uniquename` | Ou
+000058f0: 7470 7574 2054 6172 676e 616d 6520 2020  tput Targname   
+00005900: 2020 2020 2020 2020 7c0a 2020 2020 2020          |.      
+00005910: 2020 2020 2020 2b3d 3d3d 3d3d 3d3d 3d3d        +=========
+00005920: 3d3d 3d3d 3d2b 3d3d 3d3d 3d3d 3d3d 3d3d  =====+==========
+00005930: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005940: 3d2b 0a20 2020 2020 2020 2020 2020 207c  =+.            |
+00005950: 2020 2020 2054 7275 6520 2020 2020 7c20       True     | 
+00005960: 6a62 686a 3435 2d62 686a 2d34 352d 3138  jbhj45-bhj-45-18
+00005970: 302e 302d 4638 3134 5720 7c0a 2020 2020  0.0-F814W |.    
+00005980: 2020 2020 2020 2020 2b2d 2d2d 2d2d 2d2d          +-------
+00005990: 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d 2d2d  -------+--------
+000059a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000059b0: 2d2d 2d2b 0a20 2020 2020 2020 2020 2020  ---+.           
+000059c0: 207c 2020 2020 2046 616c 7365 2020 2020   |     False    
+000059d0: 7c20 6a62 686a 3435 2d31 3830 2e30 2d46  | jbhj45-180.0-F
+000059e0: 3831 3457 2020 2020 2020 2020 7c0a 2020  814W        |.  
+000059f0: 2020 2020 2020 2020 2020 2b2d 2d2d 2d2d            +-----
+00005a00: 2d2d 2d2d 2d2d 2d2d 2d2b 2d2d 2d2d 2d2d  ---------+------
+00005a10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00005a20: 2d2d 2d2d 2d2b 0a0a 2020 2020 7472 616e  -----+..    tran
+00005a30: 736c 6174 6520 3a20 6469 6374 0a20 2020  slate : dict.   
+00005a40: 2020 2020 2054 7261 6e73 6c61 7469 6f6e       Translation
+00005a50: 2064 6963 7469 6f6e 6172 7920 746f 206d   dictionary to m
+00005a60: 6f64 6966 7920 5441 5247 4e41 4d45 206b  odify TARGNAME k
+00005a70: 6579 776f 7264 7320 746f 2073 6f6d 6520  eywords to some 
+00005a80: 6f74 6865 720a 2020 2020 2020 2020 7661  other.        va
+00005a90: 6c75 652e 2020 5573 6564 206c 696b 653a  lue.  Used like:
+00005aa0: 0a0a 2020 2020 2020 2020 2020 2020 3e3e  ..            >>
+00005ab0: 3e20 7461 7267 6e61 6d65 203d 2027 474f  > targname = 'GO
+00005ac0: 4f44 532d 534f 5554 482d 3130 270a 2020  ODS-SOUTH-10'.  
+00005ad0: 2020 2020 2020 2020 2020 3e3e 3e20 7472            >>> tr
+00005ae0: 616e 736c 6174 6520 3d20 7b27 474f 4f44  anslate = {'GOOD
+00005af0: 532d 534f 5554 482d 273a 2027 676f 6f64  S-SOUTH-': 'good
+00005b00: 7373 2d27 7d0a 2020 2020 2020 2020 2020  ss-'}.          
+00005b10: 2020 3e3e 3e20 666f 7220 6b20 696e 2074    >>> for k in t
+00005b20: 7261 6e73 6c61 7465 3a0a 2020 2020 2020  ranslate:.      
+00005b30: 2020 2020 2020 3e3e 3e20 2020 2020 7461        >>>     ta
+00005b40: 7267 6e61 6d65 203d 2074 6172 676e 616d  rgname = targnam
+00005b50: 652e 7265 706c 6163 6528 6b2c 2074 7261  e.replace(k, tra
+00005b60: 6e73 6c61 7465 5b6b 5d29 0a20 2020 2020  nslate[k]).     
+00005b70: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+00005b80: 2874 6172 676e 616d 6529 0a20 2020 2020  (targname).     
+00005b90: 2020 2020 2020 2067 6f6f 6473 732d 3130         goodss-10
+00005ba0: 0a20 2020 200a 2020 2020 7669 7369 745f  .    .    visit_
+00005bb0: 7370 6c69 745f 7368 6966 7420 3a20 666c  split_shift : fl
+00005bc0: 6f61 740a 2020 2020 2020 2020 5365 7061  oat.        Sepa
+00005bd0: 7261 7469 6f6e 2069 6e20 6060 6172 636d  ration in ``arcm
+00005be0: 696e 6060 2062 6579 6f6e 6420 7768 6963  in`` beyond whic
+00005bf0: 6820 6578 706f 7375 7265 7320 696e 2061  h exposures in a
+00005c00: 2067 726f 7570 2061 7265 2073 706c 6974   group are split
+00005c10: 200a 2020 2020 2020 2020 696e 746f 2073   .        into s
+00005c20: 6570 6172 6174 6520 7669 7369 7473 2e0a  eparate visits..
+00005c30: 2020 2020 0a20 2020 2070 6174 6820 3a20      .    path : 
+00005c40: 7374 720a 2020 2020 2020 2020 5041 5448  str.        PATH
+00005c50: 2074 6f20 7365 6172 6368 2066 6f72 2060   to search for `
+00005c60: 666c 7460 2066 696c 6573 2069 6620 6060  flt` files if ``
+00005c70: 696e 666f 6060 206e 6f74 2070 726f 7669  info`` not provi
+00005c80: 6465 640a 2020 2020 0a20 2020 2052 6574  ded.    .    Ret
+00005c90: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00005ca0: 0a20 2020 206f 7574 7075 745f 6c69 7374  .    output_list
+00005cb0: 203a 2064 6963 740a 2020 2020 2020 2020   : dict.        
+00005cc0: 4469 6374 696f 6e61 7279 2073 706c 6974  Dictionary split
+00005cd0: 2062 7920 7461 7267 6574 2f66 696c 7465   by target/filte
+00005ce0: 722f 7061 5f76 332e 204b 6579 7320 6172  r/pa_v3. Keys ar
+00005cf0: 6520 6465 7269 7665 6420 7669 7369 740a  e derived visit.
+00005d00: 2020 2020 2020 2020 7072 6f64 7563 7420          product 
+00005d10: 6e61 6d65 7320 616e 6420 7661 6c75 6573  names and values
+00005d20: 2061 7265 206c 6973 7473 206f 6620 6578   are lists of ex
+00005d30: 706f 7375 7265 2066 696c 656e 616d 6573  posure filenames
+00005d40: 2063 6f72 7265 7370 6f6e 6469 6e67 0a20   corresponding. 
+00005d50: 2020 2020 2020 2074 6f20 7468 6174 2073         to that s
+00005d60: 6574 2e20 4b65 7973 2061 7265 2067 656e  et. Keys are gen
+00005d70: 6572 6174 6564 2077 6974 6820 7468 6520  erated with the 
+00005d80: 666f 726d 6174 7320 6c69 6b65 3a0a 0a20  formats like:.. 
+00005d90: 2020 2020 2020 2020 2020 203e 3e3e 2074             >>> t
+00005da0: 6172 676e 616d 6520 3d20 276d 6163 7331  argname = 'macs1
+00005db0: 3134 392b 3232 3233 270a 2020 2020 2020  149+2223'.      
+00005dc0: 2020 2020 2020 3e3e 3e20 7061 5f76 3320        >>> pa_v3 
+00005dd0: 3d20 3332 2e30 0a20 2020 2020 2020 2020  = 32.0.         
+00005de0: 2020 203e 3e3e 2066 696c 7465 7220 3d20     >>> filter = 
+00005df0: 2766 3134 3077 270a 2020 2020 2020 2020  'f140w'.        
+00005e00: 2020 2020 3e3e 3e20 666c 745f 6669 6c65      >>> flt_file
+00005e10: 6e61 6d65 203d 2027 6963 6135 3231 6e61  name = 'ica521na
+00005e20: 715f 666c 742e 6669 7473 270a 2020 2020  q_flt.fits'.    
+00005e30: 2020 2020 2020 2020 3e3e 3e20 7072 6f70          >>> prop
+00005e40: 7374 7220 3d20 666c 745f 6669 6c65 6e61  str = flt_filena
+00005e50: 6d65 5b31 3a34 5d0a 2020 2020 2020 2020  me[1:4].        
+00005e60: 2020 2020 3e3e 3e20 7669 7369 7420 3d20      >>> visit = 
+00005e70: 666c 745f 6669 6c65 6e61 6d65 5b34 3a36  flt_filename[4:6
+00005e80: 5d0a 2020 2020 2020 2020 2020 2020 3e3e  ].            >>
+00005e90: 3e20 2320 756e 6971 7565 6e61 6d65 203d  > # uniquename =
+00005ea0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+00005eb0: 2020 203e 3e3e 2070 7269 6e74 2827 7b30     >>> print('{0
+00005ec0: 7d2d 7b31 3a30 352e 3166 7d2d 7b32 7d27  }-{1:05.1f}-{2}'
+00005ed0: 2e66 6f72 6d61 7428 7461 7267 6e61 6d65  .format(targname
+00005ee0: 2c20 7061 5f76 332c 2066 696c 7465 7229  , pa_v3, filter)
+00005ef0: 290a 2020 2020 2020 2020 2020 2020 6d61  ).            ma
+00005f00: 6373 3131 3439 2e36 2b32 3232 332d 3033  cs1149.6+2223-03
+00005f10: 322e 302d 6631 3430 770a 2020 2020 2020  2.0-f140w.      
+00005f20: 2020 2020 2020 3e3e 3e20 2320 756e 6971        >>> # uniq
+00005f30: 7565 6e61 6d65 203d 2054 7275 650a 2020  uename = True.  
+00005f40: 2020 2020 2020 2020 2020 3e3e 3e20 7072            >>> pr
+00005f50: 696e 7428 277b 307d 2d7b 313a 3373 7d2d  int('{0}-{1:3s}-
+00005f60: 7b32 3a32 737d 2d7b 333a 3035 2e31 667d  {2:2s}-{3:05.1f}
+00005f70: 2d7b 343a 737d 272e 666f 726d 6174 2874  -{4:s}'.format(t
+00005f80: 6172 676e 616d 652c 2070 726f 7073 7472  argname, propstr
+00005f90: 2c20 7669 7369 742c 2070 615f 7633 2c20  , visit, pa_v3, 
+00005fa0: 6669 6c74 6572 2929 0a20 2020 2020 2020  filter)).       
+00005fb0: 2020 2020 206d 6163 7331 3134 392e 362b       macs1149.6+
+00005fc0: 3232 3233 2d63 6135 2d32 312d 3033 322e  2223-ca5-21-032.
+00005fd0: 302d 6631 3430 770a 0a20 2020 2066 696c  0-f140w..    fil
+00005fe0: 7465 725f 6c69 7374 203a 2064 6963 740a  ter_list : dict.
+00005ff0: 2020 2020 2020 2020 4e65 7374 6564 2064          Nested d
+00006000: 6963 7469 6f6e 6172 7920 7370 6c69 7420  ictionary split 
+00006010: 6279 2066 696c 7465 7220 616e 6420 7468  by filter and th
+00006020: 656e 2050 415f 5633 2e20 2054 6869 7320  en PA_V3.  This 
+00006030: 7368 6f75 6c64 6e27 740a 2020 2020 2020  shouldn't.      
+00006040: 2020 6265 2075 7365 6420 6966 2065 7870    be used if exp
+00006050: 6f73 7572 6573 2066 726f 6d20 636f 6d70  osures from comp
+00006060: 6c65 7465 6c79 2064 6973 6a6f 696e 7420  letely disjoint 
+00006070: 706f 696e 7469 6e67 7320 6172 6520 7374  pointings are st
+00006080: 6f72 6564 0a20 2020 2020 2020 2069 6e20  ored.        in 
+00006090: 7468 6520 7361 6d65 2077 6f72 6b69 6e67  the same working
+000060a0: 2064 6972 6563 746f 7279 2e0a 2020 2020   directory..    
+000060b0: 2222 220a 0a20 2020 2069 6620 696e 666f  """..    if info
+000060c0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000060d0: 2020 6966 206e 6f74 2066 696c 6573 3a0a    if not files:.
+000060e0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+000060f0: 7320 3d20 676c 6f62 2e67 6c6f 6228 6f73  s = glob.glob(os
+00006100: 2e70 6174 682e 6a6f 696e 2870 6174 6829  .path.join(path)
+00006110: 2c20 272a 666c 742e 6669 7473 2729 0a0a  , '*flt.fits')..
+00006120: 2020 2020 2020 2020 6966 206c 656e 2866          if len(f
+00006130: 696c 6573 2920 3d3d 2030 3a0a 2020 2020  iles) == 0:.    
+00006140: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00006150: 616c 7365 0a0a 2020 2020 2020 2020 696e  alse..        in
+00006160: 666f 203d 2067 6574 5f66 6c74 5f69 6e66  fo = get_flt_inf
+00006170: 6f28 6669 6c65 7329 0a20 2020 2065 6c73  o(files).    els
+00006180: 653a 0a20 2020 2020 2020 2069 6e66 6f20  e:.        info 
+00006190: 3d20 696e 666f 2e63 6f70 7928 290a 0a20  = info.copy().. 
+000061a0: 2020 2066 6f72 2063 2069 6e20 696e 666f     for c in info
+000061b0: 2e63 6f6c 6e61 6d65 733a 0a20 2020 2020  .colnames:.     
+000061c0: 2020 2069 6620 6e6f 7420 632e 6973 6c6f     if not c.islo
+000061d0: 7765 7228 293a 0a20 2020 2020 2020 2020  wer():.         
+000061e0: 2020 2069 6e66 6f2e 7265 6e61 6d65 5f63     info.rename_c
+000061f0: 6f6c 756d 6e28 632c 2063 2e6c 6f77 6572  olumn(c, c.lower
+00006200: 2829 290a 0a20 2020 2069 6620 2765 7870  ())..    if 'exp
+00006210: 7374 6172 7427 206e 6f74 2069 6e20 696e  start' not in in
+00006220: 666f 2e63 6f6c 6e61 6d65 733a 0a20 2020  fo.colnames:.   
+00006230: 2020 2020 2069 6e66 6f5b 2765 7870 7374       info['expst
+00006240: 6172 7427 5d20 3d20 696e 666f 5b27 6578  art'] = info['ex
+00006250: 7074 696d 6527 5d2a 302e 0a0a 2020 2020  ptime']*0...    
+00006260: 736f 203d 206e 702e 6172 6773 6f72 7428  so = np.argsort(
+00006270: 696e 666f 5b27 6578 7073 7461 7274 275d  info['expstart']
+00006280: 290a 2020 2020 696e 666f 203d 2069 6e66  ).    info = inf
+00006290: 6f5b 736f 5d0a 0a20 2020 2023 7061 5f76  o[so]..    #pa_v
+000062a0: 3320 3d20 6e70 2e72 6f75 6e64 2869 6e66  3 = np.round(inf
+000062b0: 6f5b 2770 615f 7633 275d 2a31 3029 2f31  o['pa_v3']*10)/1
+000062c0: 3020 2520 3336 302e 0a20 2020 2070 615f  0 % 360..    pa_
+000062d0: 7633 203d 206e 702e 726f 756e 6428 6e70  v3 = np.round(np
+000062e0: 2e72 6f75 6e64 2869 6e66 6f5b 2770 615f  .round(info['pa_
+000062f0: 7633 275d 2c20 6465 6369 6d61 6c73 3d31  v3'], decimals=1
+00006300: 2929 2025 2033 3630 2e0a 0a20 2020 2074  )) % 360...    t
+00006310: 6172 6765 745f 6c69 7374 203d 205b 5d0a  arget_list = [].
+00006320: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+00006330: 6765 286c 656e 2869 6e66 6f29 293a 0a20  ge(len(info)):. 
+00006340: 2020 2020 2020 2023 2052 6570 6c61 6365         # Replace
+00006350: 2041 4e59 2074 6172 6765 7473 2077 6974   ANY targets wit
+00006360: 6820 4a52 6852 6d52 732d 4464 446d 4473  h JRhRmRs-DdDmDs
+00006370: 0a20 2020 2020 2020 2069 6620 696e 666f  .        if info
+00006380: 5b27 7461 7267 6e61 6d65 275d 5b69 5d20  ['targname'][i] 
+00006390: 3d3d 2027 414e 5927 3a0a 2020 2020 2020  == 'ANY':.      
+000063a0: 2020 2020 2020 6966 2075 7365 5f76 6973        if use_vis
+000063b0: 6974 3a0a 2020 2020 2020 2020 2020 2020  it:.            
+000063c0: 2020 2020 6e65 775f 7461 7267 6e61 6d65      new_targname
+000063d0: 203d 2069 6e66 6f5b 2766 696c 6527 5d5b   = info['file'][
+000063e0: 695d 5b3a 365d 0a20 2020 2020 2020 2020  i][:6].         
+000063f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006400: 2020 2020 2020 2020 206e 6577 5f74 6172           new_tar
+00006410: 676e 616d 6520 3d20 2770 6172 2d27 2b72  gname = 'par-'+r
+00006420: 6164 6563 5f74 6f5f 7461 7267 6e61 6d65  adec_to_targname
+00006430: 2872 613d 696e 666f 5b27 7261 5f74 6172  (ra=info['ra_tar
+00006440: 6727 5d5b 695d 2c0a 2020 2020 2020 2020  g'][i],.        
+00006450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006470: 2020 2020 2064 6563 3d69 6e66 6f5b 2764       dec=info['d
+00006480: 6563 5f74 6172 6727 5d5b 695d 290a 0a20  ec_targ'][i]).. 
+00006490: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+000064a0: 745f 6c69 7374 2e61 7070 656e 6428 6e65  t_list.append(ne
+000064b0: 775f 7461 7267 6e61 6d65 2e6c 6f77 6572  w_targname.lower
+000064c0: 2829 290a 2020 2020 2020 2020 656c 7365  ()).        else
+000064d0: 3a0a 2020 2020 2020 2020 2020 2020 7461  :.            ta
+000064e0: 7267 6574 5f6c 6973 742e 6170 7065 6e64  rget_list.append
+000064f0: 2869 6e66 6f5b 2774 6172 676e 616d 6527  (info['targname'
+00006500: 5d5b 695d 290a 0a20 2020 2074 6172 6765  ][i])..    targe
+00006510: 745f 6c69 7374 203d 206e 702e 6172 7261  t_list = np.arra
+00006520: 7928 7461 7267 6574 5f6c 6973 7429 0a20  y(target_list). 
+00006530: 2020 200a 2020 2020 5f70 726f 675f 6964     .    _prog_id
+00006540: 7320 3d20 5b5d 0a20 2020 2076 6973 6974  s = [].    visit
+00006550: 7320 3d20 5b5d 0a20 2020 200a 2020 2020  s = [].    .    
+00006560: 666f 7220 6669 6c65 2069 6e20 696e 666f  for file in info
+00006570: 5b27 6669 6c65 275d 3a0a 2020 2020 2020  ['file']:.      
+00006580: 2020 6266 696c 6520 3d20 6f73 2e70 6174    bfile = os.pat
+00006590: 682e 6261 7365 6e61 6d65 2866 696c 6529  h.basename(file)
+000065a0: 0a20 2020 2020 2020 2069 6620 6266 696c  .        if bfil
+000065b0: 652e 7374 6172 7473 7769 7468 2827 6a77  e.startswith('jw
+000065c0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+000065d0: 5f70 726f 675f 6964 732e 6170 7065 6e64  _prog_ids.append
+000065e0: 2862 6669 6c65 5b32 3a37 5d29 0a20 2020  (bfile[2:7]).   
+000065f0: 2020 2020 2020 2020 2076 6973 6974 732e           visits.
+00006600: 6170 7065 6e64 2862 6669 6c65 5b37 3a31  append(bfile[7:1
+00006610: 305d 290a 2020 2020 2020 2020 656c 7365  0]).        else
+00006620: 3a0a 2020 2020 2020 2020 2020 2020 5f70  :.            _p
+00006630: 726f 675f 6964 732e 6170 7065 6e64 2862  rog_ids.append(b
+00006640: 6669 6c65 5b31 3a34 5d29 0a20 2020 2020  file[1:4]).     
+00006650: 2020 2020 2020 2076 6973 6974 732e 6170         visits.ap
+00006660: 7065 6e64 2862 6669 6c65 5b34 3a36 5d29  pend(bfile[4:6])
+00006670: 0a20 2020 200a 2020 2020 7669 7369 7473  .    .    visits
+00006680: 203d 206e 702e 6172 7261 7928 7669 7369   = np.array(visi
+00006690: 7473 290a 2020 2020 0a20 2020 2069 6e66  ts).    .    inf
+000066a0: 6f5b 2770 726f 6749 4473 275d 203d 205f  o['progIDs'] = _
+000066b0: 7072 6f67 5f69 6473 0a0a 2020 2020 7072  prog_ids..    pr
+000066c0: 6f67 4944 7320 3d20 6e70 2e75 6e69 7175  ogIDs = np.uniqu
+000066d0: 6528 696e 666f 5b27 7072 6f67 4944 7327  e(info['progIDs'
+000066e0: 5d29 0a20 2020 2064 6174 6573 203d 206e  ]).    dates = n
+000066f0: 702e 6172 7261 7928 5b27 272e 6a6f 696e  p.array([''.join
+00006700: 2864 6174 652e 7370 6c69 7428 272d 2729  (date.split('-')
+00006710: 5b31 3a5d 290a 2020 2020 2020 2020 2020  [1:]).          
+00006720: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00006730: 6461 7465 2069 6e20 696e 666f 5b27 6461  date in info['da
+00006740: 7465 2d6f 6273 275d 5d29 0a0a 2020 2020  te-obs']])..    
+00006750: 7461 7267 6574 7320 3d20 6e70 2e75 6e69  targets = np.uni
+00006760: 7175 6528 7461 7267 6574 5f6c 6973 7429  que(target_list)
+00006770: 0a0a 2020 2020 6f75 7470 7574 5f6c 6973  ..    output_lis
+00006780: 7420 3d20 5b5d 2020 2320 4f72 6465 7265  t = []  # Ordere
+00006790: 6444 6963 7428 290a 2020 2020 6669 6c74  dDict().    filt
+000067a0: 6572 5f6c 6973 7420 3d20 4f72 6465 7265  er_list = Ordere
+000067b0: 6444 6963 7428 290a 0a20 2020 2066 6f72  dDict()..    for
+000067c0: 2066 696c 7465 7220 696e 206e 702e 756e   filter in np.un
+000067d0: 6971 7565 2869 6e66 6f5b 2766 696c 7465  ique(info['filte
+000067e0: 7227 5d29 3a0a 2020 2020 2020 2020 6669  r']):.        fi
+000067f0: 6c74 6572 5f6c 6973 745b 6669 6c74 6572  lter_list[filter
+00006800: 5d20 3d20 4f72 6465 7265 6444 6963 7428  ] = OrderedDict(
+00006810: 290a 2020 2020 2020 2020 616e 676c 6573  ).        angles
+00006820: 203d 206e 702e 756e 6971 7565 2870 615f   = np.unique(pa_
+00006830: 7633 5b28 696e 666f 5b27 6669 6c74 6572  v3[(info['filter
+00006840: 275d 203d 3d20 6669 6c74 6572 295d 290a  '] == filter)]).
+00006850: 2020 2020 2020 2020 666f 7220 616e 676c          for angl
+00006860: 6520 696e 2061 6e67 6c65 733a 0a20 2020  e in angles:.   
+00006870: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
+00006880: 6c69 7374 5b66 696c 7465 725d 5b61 6e67  list[filter][ang
+00006890: 6c65 5d20 3d20 5b5d 0a0a 2020 2020 666f  le] = []..    fo
+000068a0: 7220 7461 7267 6574 2069 6e20 7461 7267  r target in targ
+000068b0: 6574 733a 0a20 2020 2020 2020 2023 2033  ets:.        # 3
+000068c0: 442d 4853 5420 7461 7267 6e61 6d65 2074  D-HST targname t
+000068d0: 7261 6e73 6c61 7469 6f6e 730a 2020 2020  ranslations.    
+000068e0: 2020 2020 7461 7267 6574 5f75 7365 203d      target_use =
+000068f0: 2074 6172 6765 740a 2020 2020 2020 2020   target.        
+00006900: 666f 7220 6b65 7920 696e 2074 7261 6e73  for key in trans
+00006910: 6c61 7465 2e6b 6579 7328 293a 0a20 2020  late.keys():.   
+00006920: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+00006930: 7573 6520 3d20 7461 7267 6574 5f75 7365  use = target_use
+00006940: 2e72 6570 6c61 6365 286b 6579 2c20 7472  .replace(key, tr
+00006950: 616e 736c 6174 655b 6b65 795d 290a 0a20  anslate[key]).. 
+00006960: 2020 2020 2020 2023 2070 6164 2069 203c         # pad i <
+00006970: 2031 3020 7769 7468 207a 6572 6f0a 2020   10 with zero.  
+00006980: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00006990: 2074 7261 6e73 6c61 7465 2e6b 6579 7328   translate.keys(
+000069a0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+000069b0: 6620 7472 616e 736c 6174 655b 6b65 795d  f translate[key]
+000069c0: 2069 6e20 7461 7267 6574 5f75 7365 3a0a   in target_use:.
+000069d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000069e0: 7370 6c20 3d20 7461 7267 6574 5f75 7365  spl = target_use
+000069f0: 2e73 706c 6974 2827 2d27 290a 2020 2020  .split('-').    
+00006a00: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00006a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006a20: 2020 2020 2069 6620 2869 6e74 2873 706c       if (int(spl
+00006a30: 5b2d 315d 2920 3c20 3130 2920 2620 286c  [-1]) < 10) & (l
+00006a40: 656e 2873 706c 5b2d 315d 2920 3d3d 2031  en(spl[-1]) == 1
+00006a50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00006a60: 2020 2020 2020 2020 2020 2073 706c 5b2d             spl[-
+00006a70: 315d 203d 2027 7b30 3a30 3264 7d27 2e66  1] = '{0:02d}'.f
+00006a80: 6f72 6d61 7428 696e 7428 7370 6c5b 2d31  ormat(int(spl[-1
+00006a90: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+00006aa0: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00006ab0: 6574 5f75 7365 203d 2027 2d27 2e6a 6f69  et_use = '-'.joi
+00006ac0: 6e28 7370 6c29 0a20 2020 2020 2020 2020  n(spl).         
+00006ad0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+00006ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006af0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
+00006b00: 2066 6f72 2066 696c 7465 7220 696e 206e   for filter in n
+00006b10: 702e 756e 6971 7565 2869 6e66 6f5b 2766  p.unique(info['f
+00006b20: 696c 7465 7227 5d5b 2874 6172 6765 745f  ilter'][(target_
+00006b30: 6c69 7374 203d 3d20 7461 7267 6574 295d  list == target)]
+00006b40: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+00006b50: 6e67 6c65 7320 3d20 6e70 2e75 6e69 7175  ngles = np.uniqu
+00006b60: 6528 7061 5f76 335b 2869 6e66 6f5b 2766  e(pa_v3[(info['f
+00006b70: 696c 7465 7227 5d20 3d3d 2066 696c 7465  ilter'] == filte
+00006b80: 7229 2026 0a20 2020 2020 2020 2020 2020  r) &.           
+00006b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ba0: 2020 2020 2028 7461 7267 6574 5f6c 6973       (target_lis
+00006bb0: 7420 3d3d 2074 6172 6765 7429 5d29 0a20  t == target)]). 
+00006bc0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+00006bd0: 6e67 6c65 2069 6e20 616e 676c 6573 3a0a  ngle in angles:.
+00006be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006bf0: 2065 7870 6f73 7572 655f 6c69 7374 203d   exposure_list =
+00006c00: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00006c10: 2020 2020 6578 706f 7375 7265 5f73 7461      exposure_sta
+00006c20: 7274 203d 205b 5d0a 2020 2020 2020 2020  rt = [].        
+00006c30: 2020 2020 2020 2020 7072 6f64 7563 7420          product 
+00006c40: 3d20 277b 307d 2d7b 313a 3035 2e31 667d  = '{0}-{1:05.1f}
+00006c50: 2d7b 327d 272e 666f 726d 6174 2874 6172  -{2}'.format(tar
+00006c60: 6765 745f 7573 652c 2061 6e67 6c65 2c20  get_use, angle, 
+00006c70: 6669 6c74 6572 290a 2020 2020 2020 2020  filter).        
+00006c80: 2020 2020 2020 2020 7669 7369 745f 6d61          visit_ma
+00006c90: 7463 6820 3d20 6e70 2e75 6e69 7175 6528  tch = np.unique(
+00006ca0: 7669 7369 7473 5b28 7461 7267 6574 5f6c  visits[(target_l
+00006cb0: 6973 7420 3d3d 2074 6172 6765 7429 2026  ist == target) &
 00006cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006cd0: 2020 2020 2069 7820 263d 2028 696e 666f       ix &= (info
-00006ce0: 5b27 6669 6c74 6572 275d 203d 3d20 6669  ['filter'] == fi
-00006cf0: 6c74 6572 290a 2020 2020 2020 2020 2020  lter).          
-00006d00: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00006d10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006d20: 2074 6869 735f 7072 6f67 732e 6170 7065   this_progs.appe
-00006d30: 6e64 2869 6e66 6f5b 2770 726f 6749 4473  nd(info['progIDs
-00006d40: 275d 5b69 785d 5b30 5d29 0a20 2020 2020  '][ix][0]).     
-00006d50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006d60: 2070 7269 6e74 2076 6973 6974 2c20 6978   print visit, ix
-00006d70: 2e73 756d 2829 2c20 6e70 2e75 6e69 7175  .sum(), np.uniqu
-00006d80: 6528 696e 666f 5b27 7072 6f67 4944 7327  e(info['progIDs'
-00006d90: 5d5b 6978 5d29 0a20 2020 2020 2020 2020  ][ix]).         
-00006da0: 2020 2020 2020 2020 2020 206e 6577 5f70             new_p
-00006db0: 726f 6773 203d 206c 6973 7428 6e70 2e75  rogs = list(np.u
-00006dc0: 6e69 7175 6528 696e 666f 5b27 7072 6f67  nique(info['prog
-00006dd0: 4944 7327 5d5b 6978 5d29 290a 2020 2020  IDs'][ix])).    
-00006de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006df0: 7468 6973 5f76 6973 6974 732e 6578 7465  this_visits.exte
-00006e00: 6e64 285b 7669 7369 745d 2a6c 656e 286e  nd([visit]*len(n
-00006e10: 6577 5f70 726f 6773 2929 0a20 2020 2020  ew_progs)).     
-00006e20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00006e30: 6869 735f 7072 6f67 732e 6578 7465 6e64  his_progs.extend
-00006e40: 286e 6577 5f70 726f 6773 290a 0a20 2020  (new_progs)..   
-00006e50: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00006e60: 2076 6973 6974 2c20 7072 6f67 2069 6e20   visit, prog in 
-00006e70: 7a69 7028 7468 6973 5f76 6973 6974 732c  zip(this_visits,
-00006e80: 2074 6869 735f 7072 6f67 7329 3a0a 2020   this_progs):.  
-00006e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ea0: 2020 7669 7369 745f 6c69 7374 203d 205b    visit_list = [
-00006eb0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00006ec0: 2020 2020 2020 7669 7369 745f 7374 6172        visit_star
-00006ed0: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
-00006ee0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00006ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f00: 5f76 7374 7220 3d20 277b 307d 2d7b 317d  _vstr = '{0}-{1}
-00006f10: 2d7b 327d 2d7b 333a 3035 2e31 667d 2d7b  -{2}-{3:05.1f}-{
-00006f20: 347d 270a 2020 2020 2020 2020 2020 2020  4}'.            
-00006f30: 2020 2020 2020 2020 7669 7369 745f 7072          visit_pr
-00006f40: 6f64 7563 7420 3d20 5f76 7374 722e 666f  oduct = _vstr.fo
-00006f50: 726d 6174 2874 6172 6765 745f 7573 652c  rmat(target_use,
-00006f60: 2070 726f 672c 2076 6973 6974 2c20 0a20   prog, visit, . 
-00006f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006cf0: 2869 6e66 6f5b 2766 696c 7465 7227 5d20  (info['filter'] 
+00006d00: 3d3d 2066 696c 7465 7229 5d29 0a0a 2020  == filter)])..  
+00006d10: 2020 2020 2020 2020 2020 2020 2020 7468                th
+00006d20: 6973 5f70 726f 6773 203d 205b 5d0a 2020  is_progs = [].  
+00006d30: 2020 2020 2020 2020 2020 2020 2020 7468                th
+00006d40: 6973 5f76 6973 6974 7320 3d20 5b5d 0a0a  is_visits = []..
+00006d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d60: 666f 7220 7669 7369 7420 696e 2076 6973  for visit in vis
+00006d70: 6974 5f6d 6174 6368 3a0a 2020 2020 2020  it_match:.      
+00006d80: 2020 2020 2020 2020 2020 2020 2020 6978                ix
+00006d90: 203d 2028 7669 7369 7473 203d 3d20 7669   = (visits == vi
+00006da0: 7369 7429 2026 2028 7461 7267 6574 5f6c  sit) & (target_l
+00006db0: 6973 7420 3d3d 2074 6172 6765 7429 0a20  ist == target). 
+00006dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006dd0: 2020 2069 7820 263d 2028 696e 666f 5b27     ix &= (info['
+00006de0: 6669 6c74 6572 275d 203d 3d20 6669 6c74  filter'] == filt
+00006df0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00006e00: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00006e10: 2020 2020 2020 2020 2020 2020 2023 2074               # t
+00006e20: 6869 735f 7072 6f67 732e 6170 7065 6e64  his_progs.append
+00006e30: 2869 6e66 6f5b 2770 726f 6749 4473 275d  (info['progIDs']
+00006e40: 5b69 785d 5b30 5d29 0a20 2020 2020 2020  [ix][0]).       
+00006e50: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+00006e60: 7269 6e74 2076 6973 6974 2c20 6978 2e73  rint visit, ix.s
+00006e70: 756d 2829 2c20 6e70 2e75 6e69 7175 6528  um(), np.unique(
+00006e80: 696e 666f 5b27 7072 6f67 4944 7327 5d5b  info['progIDs'][
+00006e90: 6978 5d29 0a20 2020 2020 2020 2020 2020  ix]).           
+00006ea0: 2020 2020 2020 2020 206e 6577 5f70 726f           new_pro
+00006eb0: 6773 203d 206c 6973 7428 6e70 2e75 6e69  gs = list(np.uni
+00006ec0: 7175 6528 696e 666f 5b27 7072 6f67 4944  que(info['progID
+00006ed0: 7327 5d5b 6978 5d29 290a 2020 2020 2020  s'][ix])).      
+00006ee0: 2020 2020 2020 2020 2020 2020 2020 7468                th
+00006ef0: 6973 5f76 6973 6974 732e 6578 7465 6e64  is_visits.extend
+00006f00: 285b 7669 7369 745d 2a6c 656e 286e 6577  ([visit]*len(new
+00006f10: 5f70 726f 6773 2929 0a20 2020 2020 2020  _progs)).       
+00006f20: 2020 2020 2020 2020 2020 2020 2074 6869               thi
+00006f30: 735f 7072 6f67 732e 6578 7465 6e64 286e  s_progs.extend(n
+00006f40: 6577 5f70 726f 6773 290a 0a20 2020 2020  ew_progs)..     
+00006f50: 2020 2020 2020 2020 2020 2066 6f72 2076             for v
+00006f60: 6973 6974 2c20 7072 6f67 2069 6e20 7a69  isit, prog in zi
+00006f70: 7028 7468 6973 5f76 6973 6974 732c 2074  p(this_visits, t
+00006f80: 6869 735f 7072 6f67 7329 3a0a 2020 2020  his_progs):.    
 00006f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fa0: 616e 676c 652c 2066 696c 7465 7229 0a0a  angle, filter)..
+00006fa0: 7669 7369 745f 6c69 7374 203d 205b 5d0a  visit_list = [].
 00006fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fc0: 2020 2020 7573 6520 3d20 2874 6172 6765      use = (targe
-00006fd0: 745f 6c69 7374 203d 3d20 7461 7267 6574  t_list == target
-00006fe0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006ff0: 2020 2020 2020 7573 6520 263d 2028 696e        use &= (in
-00007000: 666f 5b27 6669 6c74 6572 275d 203d 3d20  fo['filter'] == 
-00007010: 6669 6c74 6572 290a 2020 2020 2020 2020  filter).        
-00007020: 2020 2020 2020 2020 2020 2020 7573 6520              use 
-00007030: 263d 2028 7669 7369 7473 203d 3d20 7669  &= (visits == vi
-00007040: 7369 7429 0a20 2020 2020 2020 2020 2020  sit).           
-00007050: 2020 2020 2020 2020 2075 7365 2026 3d20           use &= 
-00007060: 2870 615f 7633 203d 3d20 616e 676c 6529  (pa_v3 == angle)
-00007070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007080: 2020 2020 2075 7365 2026 3d20 2869 6e66       use &= (inf
-00007090: 6f5b 2770 726f 6749 4473 275d 203d 3d20  o['progIDs'] == 
-000070a0: 7072 6f67 290a 2020 2020 2020 2020 2020  prog).          
-000070b0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-000070c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000070d0: 6620 7573 652e 7375 6d28 2920 3d3d 2030  f use.sum() == 0
-000070e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000070f0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00007100: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-00007110: 2020 2020 2020 2020 666f 7220 7473 7461          for tsta
-00007120: 7274 2c20 6669 6c65 2069 6e20 7a69 7028  rt, file in zip(
-00007130: 696e 666f 5b27 6578 7073 7461 7274 275d  info['expstart']
-00007140: 5b75 7365 5d2c 0a20 2020 2020 2020 2020  [use],.         
-00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007170: 2020 2069 6e66 6f5b 2766 696c 6527 5d5b     info['file'][
-00007180: 7573 655d 293a 0a0a 2020 2020 2020 2020  use]):..        
-00007190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000071a0: 6620 3d20 6669 6c65 2e73 706c 6974 2827  f = file.split('
-000071b0: 2e67 7a27 295b 305d 0a20 2020 2020 2020  .gz')[0].       
-000071c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000071d0: 2069 6620 6620 6e6f 7420 696e 2065 7870   if f not in exp
-000071e0: 6f73 7572 655f 6c69 7374 3a0a 2020 2020  osure_list:.    
-000071f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007200: 2020 2020 2020 2020 7669 7369 745f 6c69          visit_li
-00007210: 7374 2e61 7070 656e 6428 7374 7228 6629  st.append(str(f)
-00007220: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007230: 2020 2020 2020 2020 2020 2020 2020 7669                vi
-00007240: 7369 745f 7374 6172 742e 6170 7065 6e64  sit_start.append
-00007250: 2874 7374 6172 7429 0a0a 2020 2020 2020  (tstart)..      
-00007260: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00007270: 706f 7375 7265 5f6c 6973 7420 3d20 6e70  posure_list = np
-00007280: 2e61 7070 656e 6428 6578 706f 7375 7265  .append(exposure
-00007290: 5f6c 6973 742c 2076 6973 6974 5f6c 6973  _list, visit_lis
-000072a0: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-000072b0: 2020 2020 2020 2065 7870 6f73 7572 655f         exposure_
-000072c0: 7374 6172 742e 6578 7465 6e64 2876 6973  start.extend(vis
-000072d0: 6974 5f73 7461 7274 290a 0a20 2020 2020  it_start)..     
-000072e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000072f0: 696c 7465 725f 6c69 7374 5b66 696c 7465  ilter_list[filte
-00007300: 725d 5b61 6e67 6c65 5d2e 6578 7465 6e64  r][angle].extend
-00007310: 2876 6973 6974 5f6c 6973 7429 0a0a 2020  (visit_list)..  
+00006fc0: 2020 2020 7669 7369 745f 7374 6172 7420      visit_start 
+00006fd0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00006fe0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00006ff0: 2020 2020 2020 2020 2020 2020 2020 5f76                _v
+00007000: 7374 7220 3d20 277b 307d 2d7b 317d 2d7b  str = '{0}-{1}-{
+00007010: 327d 2d7b 333a 3035 2e31 667d 2d7b 347d  2}-{3:05.1f}-{4}
+00007020: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00007030: 2020 2020 2020 7669 7369 745f 7072 6f64        visit_prod
+00007040: 7563 7420 3d20 5f76 7374 722e 666f 726d  uct = _vstr.form
+00007050: 6174 2874 6172 6765 745f 7573 652c 2070  at(target_use, p
+00007060: 726f 672c 2076 6973 6974 2c20 0a20 2020  rog, visit, .   
+00007070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007090: 2020 2020 2020 2020 2020 2020 2020 616e                an
+000070a0: 676c 652c 2066 696c 7465 7229 0a0a 2020  gle, filter)..  
+000070b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070c0: 2020 7573 6520 3d20 2874 6172 6765 745f    use = (target_
+000070d0: 6c69 7374 203d 3d20 7461 7267 6574 290a  list == target).
+000070e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070f0: 2020 2020 7573 6520 263d 2028 696e 666f      use &= (info
+00007100: 5b27 6669 6c74 6572 275d 203d 3d20 6669  ['filter'] == fi
+00007110: 6c74 6572 290a 2020 2020 2020 2020 2020  lter).          
+00007120: 2020 2020 2020 2020 2020 7573 6520 263d            use &=
+00007130: 2028 7669 7369 7473 203d 3d20 7669 7369   (visits == visi
+00007140: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00007150: 2020 2020 2020 2075 7365 2026 3d20 2870         use &= (p
+00007160: 615f 7633 203d 3d20 616e 676c 6529 0a20  a_v3 == angle). 
+00007170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007180: 2020 2075 7365 2026 3d20 2869 6e66 6f5b     use &= (info[
+00007190: 2770 726f 6749 4473 275d 203d 3d20 7072  'progIDs'] == pr
+000071a0: 6f67 290a 2020 2020 2020 2020 2020 2020  og).            
+000071b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000071c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000071d0: 7573 652e 7375 6d28 2920 3d3d 2030 3a0a  use.sum() == 0:.
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00007200: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00007210: 2020 2020 2020 666f 7220 7473 7461 7274        for tstart
+00007220: 2c20 6669 6c65 2069 6e20 7a69 7028 696e  , file in zip(in
+00007230: 666f 5b27 6578 7073 7461 7274 275d 5b75  fo['expstart'][u
+00007240: 7365 5d2c 0a20 2020 2020 2020 2020 2020  se],.           
+00007250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007270: 2069 6e66 6f5b 2766 696c 6527 5d5b 7573   info['file'][us
+00007280: 655d 293a 0a0a 2020 2020 2020 2020 2020  e]):..          
+00007290: 2020 2020 2020 2020 2020 2020 2020 6620                f 
+000072a0: 3d20 6669 6c65 2e73 706c 6974 2827 2e67  = file.split('.g
+000072b0: 7a27 295b 305d 0a20 2020 2020 2020 2020  z')[0].         
+000072c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000072d0: 6620 6620 6e6f 7420 696e 2065 7870 6f73  f f not in expos
+000072e0: 7572 655f 6c69 7374 3a0a 2020 2020 2020  ure_list:.      
+000072f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007300: 2020 2020 2020 7669 7369 745f 6c69 7374        visit_list
+00007310: 2e61 7070 656e 6428 7374 7228 6629 290a  .append(str(f)).
 00007320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007330: 2020 6966 2075 6e69 7175 656e 616d 653a    if uniquename:
-00007340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007350: 2020 2020 2020 2020 2070 7269 6e74 2876           print(v
-00007360: 6973 6974 5f70 726f 6475 6374 2c20 6c65  isit_product, le
-00007370: 6e28 7669 7369 745f 6c69 7374 2929 0a20  n(visit_list)). 
-00007380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007390: 2020 2020 2020 2073 6f20 3d20 6e70 2e61         so = np.a
-000073a0: 7267 736f 7274 2876 6973 6974 5f73 7461  rgsort(visit_sta
-000073b0: 7274 290a 2020 2020 2020 2020 2020 2020  rt).            
-000073c0: 2020 2020 2020 2020 2020 2020 6578 706f              expo
-000073d0: 7375 7265 5f6c 6973 7420 3d20 6e70 2e61  sure_list = np.a
-000073e0: 7272 6179 2876 6973 6974 5f6c 6973 7429  rray(visit_list)
-000073f0: 5b73 6f5d 0a20 2020 2020 2020 2020 2020  [so].           
-00007400: 2020 2020 2020 2020 2020 2020 2023 6f75               #ou
-00007410: 7470 7574 5f6c 6973 745b 7669 7369 745f  tput_list[visit_
-00007420: 7072 6f64 7563 742e 6c6f 7765 7228 295d  product.lower()]
-00007430: 203d 2076 6973 6974 5f6c 6973 740a 0a20   = visit_list.. 
+00007330: 2020 2020 2020 2020 2020 2020 7669 7369              visi
+00007340: 745f 7374 6172 742e 6170 7065 6e64 2874  t_start.append(t
+00007350: 7374 6172 7429 0a0a 2020 2020 2020 2020  start)..        
+00007360: 2020 2020 2020 2020 2020 2020 6578 706f              expo
+00007370: 7375 7265 5f6c 6973 7420 3d20 6e70 2e61  sure_list = np.a
+00007380: 7070 656e 6428 6578 706f 7375 7265 5f6c  ppend(exposure_l
+00007390: 6973 742c 2076 6973 6974 5f6c 6973 7429  ist, visit_list)
+000073a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000073b0: 2020 2020 2065 7870 6f73 7572 655f 7374       exposure_st
+000073c0: 6172 742e 6578 7465 6e64 2876 6973 6974  art.extend(visit
+000073d0: 5f73 7461 7274 290a 0a20 2020 2020 2020  _start)..       
+000073e0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+000073f0: 7465 725f 6c69 7374 5b66 696c 7465 725d  ter_list[filter]
+00007400: 5b61 6e67 6c65 5d2e 6578 7465 6e64 2876  [angle].extend(v
+00007410: 6973 6974 5f6c 6973 7429 0a0a 2020 2020  isit_list)..    
+00007420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007430: 6966 2075 6e69 7175 656e 616d 653a 0a20  if uniquename:. 
 00007440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007450: 2020 2020 2020 2064 203d 204f 7264 6572         d = Order
-00007460: 6564 4469 6374 2870 726f 6475 6374 3d73  edDict(product=s
-00007470: 7472 2876 6973 6974 5f70 726f 6475 6374  tr(visit_product
-00007480: 2e6c 6f77 6572 2829 292c 0a20 2020 2020  .lower()),.     
-00007490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000074a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000074b0: 2020 2066 696c 6573 3d6c 6973 7428 6e70     files=list(np
-000074c0: 2e61 7272 6179 2876 6973 6974 5f6c 6973  .array(visit_lis
-000074d0: 7429 5b73 6f5d 2929 0a20 2020 2020 2020  t)[so])).       
-000074e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000074f0: 206f 7574 7075 745f 6c69 7374 2e61 7070   output_list.app
-00007500: 656e 6428 6429 0a0a 2020 2020 2020 2020  end(d)..        
-00007510: 2020 2020 2020 2020 6966 206e 6f74 2075          if not u
-00007520: 6e69 7175 656e 616d 653a 0a20 2020 2020  niquename:.     
-00007530: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00007540: 7269 6e74 2870 726f 6475 6374 2c20 6c65  rint(product, le
-00007550: 6e28 6578 706f 7375 7265 5f6c 6973 7429  n(exposure_list)
-00007560: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007570: 2020 2020 2020 736f 203d 206e 702e 6172        so = np.ar
-00007580: 6773 6f72 7428 6578 706f 7375 7265 5f73  gsort(exposure_s
-00007590: 7461 7274 290a 2020 2020 2020 2020 2020  tart).          
-000075a0: 2020 2020 2020 2020 2020 6578 706f 7375            exposu
-000075b0: 7265 5f6c 6973 7420 3d20 6e70 2e61 7272  re_list = np.arr
-000075c0: 6179 2865 7870 6f73 7572 655f 6c69 7374  ay(exposure_list
-000075d0: 295b 736f 5d0a 2020 2020 2020 2020 2020  )[so].          
-000075e0: 2020 2020 2020 2020 2020 236f 7574 7075            #outpu
-000075f0: 745f 6c69 7374 5b70 726f 6475 6374 2e6c  t_list[product.l
-00007600: 6f77 6572 2829 5d20 3d20 6578 706f 7375  ower()] = exposu
-00007610: 7265 5f6c 6973 740a 2020 2020 2020 2020  re_list.        
-00007620: 2020 2020 2020 2020 2020 2020 6420 3d20              d = 
-00007630: 4f72 6465 7265 6444 6963 7428 7072 6f64  OrderedDict(prod
-00007640: 7563 743d 7374 7228 7072 6f64 7563 742e  uct=str(product.
-00007650: 6c6f 7765 7228 2929 2c0a 2020 2020 2020  lower()),.      
+00007450: 2020 2020 2020 2070 7269 6e74 2876 6973         print(vis
+00007460: 6974 5f70 726f 6475 6374 2c20 6c65 6e28  it_product, len(
+00007470: 7669 7369 745f 6c69 7374 2929 0a20 2020  visit_list)).   
+00007480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007490: 2020 2020 2073 6f20 3d20 6e70 2e61 7267       so = np.arg
+000074a0: 736f 7274 2876 6973 6974 5f73 7461 7274  sort(visit_start
+000074b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000074c0: 2020 2020 2020 2020 2020 6578 706f 7375            exposu
+000074d0: 7265 5f6c 6973 7420 3d20 6e70 2e61 7272  re_list = np.arr
+000074e0: 6179 2876 6973 6974 5f6c 6973 7429 5b73  ay(visit_list)[s
+000074f0: 6f5d 0a20 2020 2020 2020 2020 2020 2020  o].             
+00007500: 2020 2020 2020 2020 2020 2023 6f75 7470             #outp
+00007510: 7574 5f6c 6973 745b 7669 7369 745f 7072  ut_list[visit_pr
+00007520: 6f64 7563 742e 6c6f 7765 7228 295d 203d  oduct.lower()] =
+00007530: 2076 6973 6974 5f6c 6973 740a 0a20 2020   visit_list..   
+00007540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007550: 2020 2020 2064 203d 204f 7264 6572 6564       d = Ordered
+00007560: 4469 6374 2870 726f 6475 6374 3d73 7472  Dict(product=str
+00007570: 2876 6973 6974 5f70 726f 6475 6374 2e6c  (visit_product.l
+00007580: 6f77 6572 2829 292c 0a20 2020 2020 2020  ower()),.       
+00007590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075b0: 2066 696c 6573 3d6c 6973 7428 6e70 2e61   files=list(np.a
+000075c0: 7272 6179 2876 6973 6974 5f6c 6973 7429  rray(visit_list)
+000075d0: 5b73 6f5d 2929 0a20 2020 2020 2020 2020  [so])).         
+000075e0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000075f0: 7574 7075 745f 6c69 7374 2e61 7070 656e  utput_list.appen
+00007600: 6428 6429 0a0a 2020 2020 2020 2020 2020  d(d)..          
+00007610: 2020 2020 2020 6966 206e 6f74 2075 6e69        if not uni
+00007620: 7175 656e 616d 653a 0a20 2020 2020 2020  quename:.       
+00007630: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00007640: 6e74 2870 726f 6475 6374 2c20 6c65 6e28  nt(product, len(
+00007650: 6578 706f 7375 7265 5f6c 6973 7429 290a  exposure_list)).
 00007660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007670: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00007680: 6c65 733d 6c69 7374 286e 702e 6172 7261  les=list(np.arra
-00007690: 7928 6578 706f 7375 7265 5f6c 6973 7429  y(exposure_list)
-000076a0: 5b73 6f5d 2929 0a20 2020 2020 2020 2020  [so])).         
-000076b0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-000076c0: 745f 6c69 7374 2e61 7070 656e 6428 6429  t_list.append(d)
-000076d0: 0a0a 2020 2020 2320 5370 6c69 7420 6c61  ..    # Split la
-000076e0: 7267 6520 7368 6966 7473 0a20 2020 2069  rge shifts.    i
-000076f0: 6620 7669 7369 745f 7370 6c69 745f 7368  f visit_split_sh
-00007700: 6966 7420 3e20 303a 0a20 2020 2020 2020  ift > 0:.       
-00007710: 2073 706c 6974 5f6c 6973 7420 3d20 5b5d   split_list = []
-00007720: 0a20 2020 2020 2020 2066 6f72 206f 2069  .        for o i
-00007730: 6e20 6f75 7470 7574 5f6c 6973 743a 0a20  n output_list:. 
-00007740: 2020 2020 2020 2020 2020 205f 7370 6c20             _spl 
-00007750: 3d20 7370 6c69 745f 7669 7369 7428 6f2c  = split_visit(o,
-00007760: 2070 6174 683d 7061 7468 2c20 0a20 2020   path=path, .   
-00007770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007780: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-00007790: 6474 3d6d 6178 5f64 742c 0a20 2020 2020  dt=max_dt,.     
-000077a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077b0: 2020 2020 2020 2020 2020 7669 7369 745f            visit_
-000077c0: 7370 6c69 745f 7368 6966 743d 7669 7369  split_shift=visi
-000077d0: 745f 7370 6c69 745f 7368 6966 7429 0a20  t_split_shift). 
-000077e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077f0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00007800: 2020 2020 2020 2020 2020 2073 706c 6974             split
-00007810: 5f6c 6973 742e 6578 7465 6e64 285f 7370  _list.extend(_sp
-00007820: 6c29 0a0a 2020 2020 2020 2020 6f75 7470  l)..        outp
-00007830: 7574 5f6c 6973 7420 3d20 7370 6c69 745f  ut_list = split_
-00007840: 6c69 7374 0a0a 2020 2020 2320 4765 7420  list..    # Get 
-00007850: 7669 7369 7420 666f 6f74 7072 696e 7420  visit footprint 
-00007860: 6672 6f6d 2046 4c54 2057 4353 0a20 2020  from FLT WCS.   
-00007870: 2069 6620 6765 745f 666f 6f74 7072 696e   if get_footprin
-00007880: 743a 0a20 2020 2020 2020 2066 726f 6d20  t:.        from 
-00007890: 7368 6170 656c 792e 6765 6f6d 6574 7279  shapely.geometry
-000078a0: 2069 6d70 6f72 7420 506f 6c79 676f 6e0a   import Polygon.
-000078b0: 0a20 2020 2020 2020 204e 203d 206c 656e  .        N = len
-000078c0: 286f 7574 7075 745f 6c69 7374 290a 2020  (output_list).  
-000078d0: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-000078e0: 616e 6765 284e 293a 0a20 2020 2020 2020  ange(N):.       
-000078f0: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-00007900: 6e67 6528 6c65 6e28 6f75 7470 7574 5f6c  nge(len(output_l
-00007910: 6973 745b 695d 5b27 6669 6c65 7327 5d29  ist[i]['files'])
-00007920: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00007930: 2020 2066 6c74 5f66 696c 6520 3d20 6f75     flt_file = ou
-00007940: 7470 7574 5f6c 6973 745b 695d 5b27 6669  tput_list[i]['fi
-00007950: 6c65 7327 5d5b 6a5d 0a20 2020 2020 2020  les'][j].       
-00007960: 2020 2020 2020 2020 2069 6620 286e 6f74           if (not
-00007970: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-00007980: 666c 745f 6669 6c65 2929 3a0a 2020 2020  flt_file)):.    
-00007990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079a0: 666f 7220 677a 6578 7420 696e 205b 2727  for gzext in [''
-000079b0: 2c20 272e 677a 275d 3a0a 2020 2020 2020  , '.gz']:.      
-000079c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079d0: 2020 5f66 6c74 5f66 696c 6520 3d20 6f73    _flt_file = os
-000079e0: 2e70 6174 682e 6a6f 696e 2870 6174 682c  .path.join(path,
-000079f0: 2066 6c74 5f66 696c 6520 2b20 677a 6578   flt_file + gzex
-00007a00: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00007a10: 2020 2020 2020 2020 2020 2069 6620 6f73             if os
-00007a20: 2e70 6174 682e 6578 6973 7473 285f 666c  .path.exists(_fl
-00007a30: 745f 6669 6c65 293a 0a20 2020 2020 2020  t_file):.       
-00007a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a50: 2020 2020 2066 6c74 5f66 696c 6520 3d20       flt_file = 
-00007a60: 5f66 6c74 5f66 696c 650a 2020 2020 2020  _flt_file.      
-00007a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a80: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00007a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007ab0: 2066 6c74 5f6a 203d 2070 7966 6974 732e   flt_j = pyfits.
-00007ac0: 6f70 656e 2866 6c74 5f66 696c 6529 0a20  open(flt_file). 
-00007ad0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00007ae0: 203d 2066 6c74 5f6a 5b30 5d2e 6865 6164   = flt_j[0].head
-00007af0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-00007b00: 2020 205f 6578 7420 3d20 300a 2020 2020     _ext = 0.    
-00007b10: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00007b20: 685b 2749 4e53 5452 554d 4527 5d20 3d3d  h['INSTRUME'] ==
-00007b30: 2027 5746 4333 2729 3a0a 2020 2020 2020   'WFC3'):.      
-00007b40: 2020 2020 2020 2020 2020 2020 2020 5f65                _e
-00007b50: 7874 203d 2031 0a20 2020 2020 2020 2020  xt = 1.         
-00007b60: 2020 2020 2020 2020 2020 2069 6620 2868             if (h
-00007b70: 5b27 4445 5445 4354 4f52 275d 203d 3d20  ['DETECTOR'] == 
-00007b80: 2749 5227 293a 0a20 2020 2020 2020 2020  'IR'):.         
-00007b90: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00007ba0: 6373 5f6a 203d 2070 7977 6373 2e57 4353  cs_j = pywcs.WCS
-00007bb0: 2866 6c74 5f6a 5b27 5343 4927 2c20 315d  (flt_j['SCI', 1]
-00007bc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007bd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00007be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007bf0: 2020 2020 7763 735f 6a20 3d20 7079 7763      wcs_j = pywc
-00007c00: 732e 5743 5328 666c 745f 6a5b 2753 4349  s.WCS(flt_j['SCI
-00007c10: 272c 2031 5d2c 2066 6f62 6a3d 666c 745f  ', 1], fobj=flt_
-00007c20: 6a29 0a20 2020 2020 2020 2020 2020 2020  j).             
-00007c30: 2020 2065 6c69 6620 2868 5b27 494e 5354     elif (h['INST
-00007c40: 5255 4d45 275d 203d 3d20 2757 4650 4332  RUME'] == 'WFPC2
-00007c50: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00007c60: 2020 2020 2020 2020 5f65 7874 203d 2031          _ext = 1
-00007c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007c80: 2020 2020 2077 6373 5f6a 203d 2070 7977       wcs_j = pyw
-00007c90: 6373 2e57 4353 2866 6c74 5f6a 5b27 5343  cs.WCS(flt_j['SC
-00007ca0: 4927 2c20 315d 290a 2020 2020 2020 2020  I', 1]).        
-00007cb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00007670: 2020 2020 736f 203d 206e 702e 6172 6773      so = np.args
+00007680: 6f72 7428 6578 706f 7375 7265 5f73 7461  ort(exposure_sta
+00007690: 7274 290a 2020 2020 2020 2020 2020 2020  rt).            
+000076a0: 2020 2020 2020 2020 6578 706f 7375 7265          exposure
+000076b0: 5f6c 6973 7420 3d20 6e70 2e61 7272 6179  _list = np.array
+000076c0: 2865 7870 6f73 7572 655f 6c69 7374 295b  (exposure_list)[
+000076d0: 736f 5d0a 2020 2020 2020 2020 2020 2020  so].            
+000076e0: 2020 2020 2020 2020 236f 7574 7075 745f          #output_
+000076f0: 6c69 7374 5b70 726f 6475 6374 2e6c 6f77  list[product.low
+00007700: 6572 2829 5d20 3d20 6578 706f 7375 7265  er()] = exposure
+00007710: 5f6c 6973 740a 2020 2020 2020 2020 2020  _list.          
+00007720: 2020 2020 2020 2020 2020 6420 3d20 4f72            d = Or
+00007730: 6465 7265 6444 6963 7428 7072 6f64 7563  deredDict(produc
+00007740: 743d 7374 7228 7072 6f64 7563 742e 6c6f  t=str(product.lo
+00007750: 7765 7228 2929 2c0a 2020 2020 2020 2020  wer()),.        
+00007760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007770: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00007780: 733d 6c69 7374 286e 702e 6172 7261 7928  s=list(np.array(
+00007790: 6578 706f 7375 7265 5f6c 6973 7429 5b73  exposure_list)[s
+000077a0: 6f5d 2929 0a20 2020 2020 2020 2020 2020  o])).           
+000077b0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+000077c0: 6c69 7374 2e61 7070 656e 6428 6429 0a0a  list.append(d)..
+000077d0: 2020 2020 2320 5370 6c69 7420 6c61 7267      # Split larg
+000077e0: 6520 7368 6966 7473 0a20 2020 2069 6620  e shifts.    if 
+000077f0: 7669 7369 745f 7370 6c69 745f 7368 6966  visit_split_shif
+00007800: 7420 3e20 303a 0a20 2020 2020 2020 2073  t > 0:.        s
+00007810: 706c 6974 5f6c 6973 7420 3d20 5b5d 0a20  plit_list = []. 
+00007820: 2020 2020 2020 2066 6f72 206f 2069 6e20         for o in 
+00007830: 6f75 7470 7574 5f6c 6973 743a 0a20 2020  output_list:.   
+00007840: 2020 2020 2020 2020 205f 7370 6c20 3d20           _spl = 
+00007850: 7370 6c69 745f 7669 7369 7428 6f2c 2070  split_visit(o, p
+00007860: 6174 683d 7061 7468 2c20 0a20 2020 2020  ath=path, .     
+00007870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007880: 2020 2020 2020 2020 2020 6d61 785f 6474            max_dt
+00007890: 3d6d 6178 5f64 742c 0a20 2020 2020 2020  =max_dt,.       
+000078a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078b0: 2020 2020 2020 2020 7669 7369 745f 7370          visit_sp
+000078c0: 6c69 745f 7368 6966 743d 7669 7369 745f  lit_shift=visit_
+000078d0: 7370 6c69 745f 7368 6966 7429 0a20 2020  split_shift).   
+000078e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078f0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00007900: 2020 2020 2020 2020 2073 706c 6974 5f6c           split_l
+00007910: 6973 742e 6578 7465 6e64 285f 7370 6c29  ist.extend(_spl)
+00007920: 0a0a 2020 2020 2020 2020 6f75 7470 7574  ..        output
+00007930: 5f6c 6973 7420 3d20 7370 6c69 745f 6c69  _list = split_li
+00007940: 7374 0a0a 2020 2020 2320 4765 7420 7669  st..    # Get vi
+00007950: 7369 7420 666f 6f74 7072 696e 7420 6672  sit footprint fr
+00007960: 6f6d 2046 4c54 2057 4353 0a20 2020 2069  om FLT WCS.    i
+00007970: 6620 6765 745f 666f 6f74 7072 696e 743a  f get_footprint:
+00007980: 0a20 2020 2020 2020 2066 726f 6d20 7368  .        from sh
+00007990: 6170 656c 792e 6765 6f6d 6574 7279 2069  apely.geometry i
+000079a0: 6d70 6f72 7420 506f 6c79 676f 6e0a 0a20  mport Polygon.. 
+000079b0: 2020 2020 2020 204e 203d 206c 656e 286f         N = len(o
+000079c0: 7574 7075 745f 6c69 7374 290a 2020 2020  utput_list).    
+000079d0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+000079e0: 6765 284e 293a 0a20 2020 2020 2020 2020  ge(N):.         
+000079f0: 2020 2066 6f72 206a 2069 6e20 7261 6e67     for j in rang
+00007a00: 6528 6c65 6e28 6f75 7470 7574 5f6c 6973  e(len(output_lis
+00007a10: 745b 695d 5b27 6669 6c65 7327 5d29 293a  t[i]['files'])):
+00007a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007a30: 2066 6c74 5f66 696c 6520 3d20 6f75 7470   flt_file = outp
+00007a40: 7574 5f6c 6973 745b 695d 5b27 6669 6c65  ut_list[i]['file
+00007a50: 7327 5d5b 6a5d 0a20 2020 2020 2020 2020  s'][j].         
+00007a60: 2020 2020 2020 2069 6620 286e 6f74 206f         if (not o
+00007a70: 732e 7061 7468 2e65 7869 7374 7328 666c  s.path.exists(fl
+00007a80: 745f 6669 6c65 2929 3a0a 2020 2020 2020  t_file)):.      
+00007a90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00007aa0: 7220 677a 6578 7420 696e 205b 2727 2c20  r gzext in ['', 
+00007ab0: 272e 677a 275d 3a0a 2020 2020 2020 2020  '.gz']:.        
+00007ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ad0: 5f66 6c74 5f66 696c 6520 3d20 6f73 2e70  _flt_file = os.p
+00007ae0: 6174 682e 6a6f 696e 2870 6174 682c 2066  ath.join(path, f
+00007af0: 6c74 5f66 696c 6520 2b20 677a 6578 7429  lt_file + gzext)
+00007b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007b10: 2020 2020 2020 2020 2069 6620 6f73 2e70           if os.p
+00007b20: 6174 682e 6578 6973 7473 285f 666c 745f  ath.exists(_flt_
+00007b30: 6669 6c65 293a 0a20 2020 2020 2020 2020  file):.         
+00007b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b50: 2020 2066 6c74 5f66 696c 6520 3d20 5f66     flt_file = _f
+00007b60: 6c74 5f66 696c 650a 2020 2020 2020 2020  lt_file.        
+00007b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b80: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00007b90: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00007ba0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007bb0: 6c74 5f6a 203d 2070 7966 6974 732e 6f70  lt_j = pyfits.op
+00007bc0: 656e 2866 6c74 5f66 696c 6529 0a20 2020  en(flt_file).   
+00007bd0: 2020 2020 2020 2020 2020 2020 2068 203d               h =
+00007be0: 2066 6c74 5f6a 5b30 5d2e 6865 6164 6572   flt_j[0].header
+00007bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007c00: 205f 6578 7420 3d20 300a 2020 2020 2020   _ext = 0.      
+00007c10: 2020 2020 2020 2020 2020 6966 2028 685b            if (h[
+00007c20: 2749 4e53 5452 554d 4527 5d20 3d3d 2027  'INSTRUME'] == '
+00007c30: 5746 4333 2729 3a0a 2020 2020 2020 2020  WFC3'):.        
+00007c40: 2020 2020 2020 2020 2020 2020 5f65 7874              _ext
+00007c50: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
+00007c60: 2020 2020 2020 2020 2069 6620 2868 5b27           if (h['
+00007c70: 4445 5445 4354 4f52 275d 203d 3d20 2749  DETECTOR'] == 'I
+00007c80: 5227 293a 0a20 2020 2020 2020 2020 2020  R'):.           
+00007c90: 2020 2020 2020 2020 2020 2020 2077 6373               wcs
+00007ca0: 5f6a 203d 2070 7977 6373 2e57 4353 2866  _j = pywcs.WCS(f
+00007cb0: 6c74 5f6a 5b27 5343 4927 2c20 315d 290a  lt_j['SCI', 1]).
 00007cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007cd0: 2020 5f65 7874 203d 2031 0a20 2020 2020    _ext = 1.     
-00007ce0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00007cf0: 6373 5f6a 203d 2070 7977 6373 2e57 4353  cs_j = pywcs.WCS
-00007d00: 2866 6c74 5f6a 5b27 5343 4927 2c20 315d  (flt_j['SCI', 1]
-00007d10: 2c20 666f 626a 3d66 6c74 5f6a 290a 2020  , fobj=flt_j).  
-00007d20: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00007d30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00007d40: 6620 2828 7763 735f 6a2e 7069 7865 6c5f  f ((wcs_j.pixel_
-00007d50: 7368 6170 6520 6973 204e 6f6e 6529 2026  shape is None) &
-00007d60: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00007d70: 2020 2020 2020 2827 4e50 4958 3127 2069        ('NPIX1' i
-00007d80: 6e20 666c 745f 6a5b 2753 4349 272c 315d  n flt_j['SCI',1]
-00007d90: 2e68 6561 6465 7229 293a 0a20 2020 2020  .header)):.     
-00007da0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00007db0: 6820 3d20 666c 745f 6a5b 2753 4349 272c  h = flt_j['SCI',
-00007dc0: 315d 2e68 6561 6465 720a 2020 2020 2020  1].header.      
-00007dd0: 2020 2020 2020 2020 2020 2020 2020 7763                wc
-00007de0: 735f 6a2e 7069 7865 6c5f 7368 6170 6520  s_j.pixel_shape 
-00007df0: 3d20 285f 685b 274e 5049 5831 275d 2c20  = (_h['NPIX1'], 
-00007e00: 5f68 5b27 4e50 4958 3227 5d29 0a20 2020  _h['NPIX2']).   
-00007e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e20: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00007e30: 2020 6670 5f6a 203d 2050 6f6c 7967 6f6e    fp_j = Polygon
-00007e40: 2877 6373 5f6a 2e63 616c 635f 666f 6f74  (wcs_j.calc_foot
-00007e50: 7072 696e 7428 2929 0a20 2020 2020 2020  print()).       
-00007e60: 2020 2020 2020 2020 2069 6620 6a20 3d3d           if j ==
-00007e70: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00007e80: 2020 2020 2020 2020 6670 5f69 203d 2066          fp_i = f
-00007e90: 705f 6a2e 6275 6666 6572 2831 2e2f 3336  p_j.buffer(1./36
-00007ea0: 3030 290a 2020 2020 2020 2020 2020 2020  00).            
-00007eb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00007ec0: 2020 2020 2020 2020 2020 2020 2020 6670                fp
-00007ed0: 5f69 203d 2066 705f 692e 756e 696f 6e28  _i = fp_i.union(
-00007ee0: 6670 5f6a 2e62 7566 6665 7228 312e 2f33  fp_j.buffer(1./3
-00007ef0: 3630 3029 290a 2020 2020 2020 2020 2020  600)).          
-00007f00: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-00007f10: 2020 2020 2020 2066 6c74 5f6a 2e63 6c6f         flt_j.clo
-00007f20: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
-00007f30: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00007f40: 2020 6f75 7470 7574 5f6c 6973 745b 695d    output_list[i]
-00007f50: 5b27 666f 6f74 7072 696e 7427 5d20 3d20  ['footprint'] = 
-00007f60: 6670 5f69 0a0a 2020 2020 7265 7475 726e  fp_i..    return
-00007f70: 206f 7574 7075 745f 6c69 7374 2c20 6669   output_list, fi
-00007f80: 6c74 6572 5f6c 6973 740a 0a0a 6465 6620  lter_list...def 
-00007f90: 7370 6c69 745f 7669 7369 7428 7669 7369  split_visit(visi
-00007fa0: 742c 2076 6973 6974 5f73 706c 6974 5f73  t, visit_split_s
-00007fb0: 6869 6674 3d31 2e35 2c20 6d61 785f 6474  hift=1.5, max_dt
-00007fc0: 3d36 2e2f 3234 2c20 7061 7468 3d27 2e2e  =6./24, path='..
-00007fd0: 2f52 4157 2729 3a0a 2020 2020 2222 220a  /RAW'):.    """.
-00007fe0: 2020 2020 4368 6563 6b20 6966 2066 696c      Check if fil
-00007ff0: 6573 2069 6e20 6120 7669 7369 7420 6861  es in a visit ha
-00008000: 7665 206c 6172 6765 2073 6869 6674 7320  ve large shifts 
-00008010: 616e 6420 7370 6c69 7420 7468 656d 206f  and split them o
-00008020: 7468 6572 7769 7365 0a0a 2020 2020 7669  therwise..    vi
-00008030: 7369 7420 3a20 7669 7369 7420 6469 6374  sit : visit dict
-00008040: 696f 6e61 7279 0a0a 2020 2020 7669 7369  ionary..    visi
-00008050: 745f 7370 6c69 745f 7368 6966 7420 3a20  t_split_shift : 
-00008060: 7370 6c69 7420 6966 2073 6869 6674 7320  split if shifts 
-00008070: 6c61 7267 6572 2074 6861 6e20 6076 6973  larger than `vis
-00008080: 6974 5f73 706c 6974 5f73 6869 6674 6020  it_split_shift` 
-00008090: 6172 636d 696e 0a20 2020 2022 2222 0a20  arcmin.    """. 
-000080a0: 2020 200a 2020 2020 696d 7320 3d20 5b5d     .    ims = []
-000080b0: 0a20 2020 2066 6f72 2066 696c 6520 696e  .    for file in
-000080c0: 2076 6973 6974 5b27 6669 6c65 7327 5d3a   visit['files']:
-000080d0: 0a20 2020 2020 2020 2066 6f72 2067 7a65  .        for gze
-000080e0: 7874 2069 6e20 5b27 272c 2027 2e67 7a27  xt in ['', '.gz'
-000080f0: 5d3a 0a20 2020 2020 2020 2020 2020 205f  ]:.            _
-00008100: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
-00008110: 6f69 6e28 7061 7468 2c20 6669 6c65 2920  oin(path, file) 
-00008120: 2b20 677a 6578 740a 2020 2020 2020 2020  + gzext.        
-00008130: 2020 2020 6966 206f 732e 7061 7468 2e65      if os.path.e
-00008140: 7869 7374 7328 5f66 696c 6529 3a0a 2020  xists(_file):.  
-00008150: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00008160: 732e 6170 7065 6e64 2870 7966 6974 732e  s.append(pyfits.
-00008170: 6f70 656e 285f 6669 6c65 2929 0a20 2020  open(_file)).   
-00008180: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-00008190: 616b 0a20 2020 200a 2020 2020 2369 6d73  ak.    .    #ims
-000081a0: 203d 205b 7079 6669 7473 2e6f 7065 6e28   = [pyfits.open(
-000081b0: 6f73 2e70 6174 682e 6a6f 696e 2870 6174  os.path.join(pat
-000081c0: 682c 2066 696c 6529 2920 666f 7220 6669  h, file)) for fi
-000081d0: 6c65 2069 6e20 7669 7369 745b 2766 696c  le in visit['fil
-000081e0: 6573 275d 5d0a 2020 2020 6372 7661 6c31  es']].    crval1
-000081f0: 203d 206e 702e 6172 7261 7928 5b69 6d5b   = np.array([im[
-00008200: 315d 2e68 6561 6465 725b 2743 5256 414c  1].header['CRVAL
-00008210: 3127 5d20 666f 7220 696d 2069 6e20 696d  1'] for im in im
-00008220: 735d 290a 2020 2020 6372 7661 6c32 203d  s]).    crval2 =
-00008230: 206e 702e 6172 7261 7928 5b69 6d5b 315d   np.array([im[1]
-00008240: 2e68 6561 6465 725b 2743 5256 414c 3227  .header['CRVAL2'
-00008250: 5d20 666f 7220 696d 2069 6e20 696d 735d  ] for im in ims]
-00008260: 290a 2020 2020 6578 7073 7461 7274 203d  ).    expstart =
-00008270: 206e 702e 6172 7261 7928 5b69 6d5b 305d   np.array([im[0]
-00008280: 2e68 6561 6465 725b 2745 5850 5354 4152  .header['EXPSTAR
-00008290: 5427 5d20 666f 7220 696d 2069 6e20 696d  T'] for im in im
-000082a0: 735d 290a 2020 2020 6474 203d 206e 702e  s]).    dt = np.
-000082b0: 6361 7374 5b69 6e74 5d28 2865 7870 7374  cast[int]((expst
-000082c0: 6172 742d 6578 7073 7461 7274 5b30 5d29  art-expstart[0])
-000082d0: 2f6d 6178 5f64 7429 0a20 2020 200a 2020  /max_dt).    .  
-000082e0: 2020 666f 7220 696d 2069 6e20 696d 733a    for im in ims:
-000082f0: 0a20 2020 2020 2020 2069 6d2e 636c 6f73  .        im.clos
-00008300: 6528 290a 2020 2020 2020 2020 0a20 2020  e().        .   
-00008310: 2064 7820 3d20 2863 7276 616c 3120 2d20   dx = (crval1 - 
-00008320: 6372 7661 6c31 5b30 5d29 2a36 302a 6e70  crval1[0])*60*np
-00008330: 2e63 6f73 2863 7276 616c 325b 305d 2f31  .cos(crval2[0]/1
-00008340: 3830 2a6e 702e 7069 290a 2020 2020 6479  80*np.pi).    dy
-00008350: 203d 2028 6372 7661 6c32 202d 2063 7276   = (crval2 - crv
-00008360: 616c 325b 305d 292a 3630 0a0a 2020 2020  al2[0])*60..    
-00008370: 6478 6920 3d20 6e70 2e63 6173 745b 696e  dxi = np.cast[in
-00008380: 745d 286e 702e 726f 756e 6428 6478 2f76  t](np.round(dx/v
-00008390: 6973 6974 5f73 706c 6974 5f73 6869 6674  isit_split_shift
-000083a0: 2929 0a20 2020 2064 7969 203d 206e 702e  )).    dyi = np.
-000083b0: 6361 7374 5b69 6e74 5d28 6e70 2e72 6f75  cast[int](np.rou
-000083c0: 6e64 2864 792f 7669 7369 745f 7370 6c69  nd(dy/visit_spli
-000083d0: 745f 7368 6966 7429 290a 2020 2020 6b65  t_shift)).    ke
-000083e0: 7973 203d 2064 7869 2a31 3030 2b64 7969  ys = dxi*100+dyi
-000083f0: 2b31 3030 302a 6474 0a0a 2020 2020 756e  +1000*dt..    un
-00008400: 203d 206e 702e 756e 6971 7565 286b 6579   = np.unique(key
-00008410: 7329 0a20 2020 2069 6620 6c65 6e28 756e  s).    if len(un
-00008420: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00008430: 7265 7475 726e 205b 7669 7369 745d 0a20  return [visit]. 
-00008440: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00008450: 2073 706c 203d 2076 6973 6974 5b27 7072   spl = visit['pr
-00008460: 6f64 7563 7427 5d2e 7370 6c69 7428 272d  oduct'].split('-
-00008470: 2729 0a20 2020 2020 2020 2069 734a 5753  ').        isJWS
-00008480: 5420 3d20 7370 6c5b 2d31 5d2e 6c6f 7765  T = spl[-1].lowe
-00008490: 7228 292e 7374 6172 7473 7769 7468 2827  r().startswith('
-000084a0: 636c 6561 7227 290a 2020 2020 2020 2020  clear').        
-000084b0: 6973 4a57 5354 207c 3d20 7370 6c5b 2d31  isJWST |= spl[-1
-000084c0: 5d2e 6c6f 7765 7228 2920 696e 205b 2767  ].lower() in ['g
-000084d0: 7231 3530 7227 2c27 6772 3135 3063 272c  r150r','gr150c',
-000084e0: 2767 7269 736d 7227 2c27 6772 6973 6d63  'grismr','grismc
-000084f0: 275d 0a20 2020 2020 2020 2069 6620 6973  '].        if is
-00008500: 4a57 5354 3a0a 2020 2020 2020 2020 2020  JWST:.          
-00008510: 2020 7370 6c2e 696e 7365 7274 282d 322c    spl.insert(-2,
-00008520: 2027 2729 0a20 2020 2020 2020 2065 6c73   '').        els
-00008530: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00008540: 706c 2e69 6e73 6572 7428 2d31 2c20 2727  pl.insert(-1, ''
-00008550: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-00008560: 2020 2020 2020 2076 6973 6974 7320 3d20         visits = 
-00008570: 5b5d 0a20 2020 2020 2020 2066 6f72 2069  [].        for i
-00008580: 2069 6e20 7261 6e67 6528 6c65 6e28 756e   in range(len(un
-00008590: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000085a0: 6978 203d 206b 6579 7320 3d3d 2075 6e5b  ix = keys == un[
-000085b0: 695d 0a20 2020 2020 2020 2020 2020 2069  i].            i
-000085c0: 6620 6973 4a57 5354 3a0a 2020 2020 2020  f isJWST:.      
-000085d0: 2020 2020 2020 2020 2020 7370 6c5b 2d33            spl[-3
-000085e0: 5d20 3d20 2761 6263 6465 6667 6869 6a6b  ] = 'abcdefghijk
-000085f0: 6c6d 6e6f 7071 7273 7576 7778 797a 275b  lmnopqrsuvwxyz'[
-00008600: 695d 0a20 2020 2020 2020 2020 2020 2065  i].            e
-00008610: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00008620: 2020 2020 2073 706c 5b2d 325d 203d 2027       spl[-2] = '
-00008630: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00008640: 7172 7375 7677 7879 7a27 5b69 5d0a 2020  qrsuvwxyz'[i].  
-00008650: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00008660: 2020 2020 2020 2020 2020 206e 6577 5f76             new_v
-00008670: 6973 6974 203d 207b 2766 696c 6573 273a  isit = {'files':
-00008680: 206c 6973 7428 6e70 2e61 7272 6179 2876   list(np.array(v
-00008690: 6973 6974 5b27 6669 6c65 7327 5d29 5b69  isit['files'])[i
-000086a0: 785d 292c 0a20 2020 2020 2020 2020 2020  x]),.           
-000086b0: 2020 2020 2020 2020 2020 2020 2020 2770                'p
-000086c0: 726f 6475 6374 273a 2027 2d27 2e6a 6f69  roduct': '-'.joi
-000086d0: 6e28 7370 6c29 7d0a 0a20 2020 2020 2020  n(spl)}..       
-000086e0: 2020 2020 2069 6620 2766 6f6f 7470 7269       if 'footpri
-000086f0: 6e74 7327 2069 6e20 7669 7369 743a 0a20  nts' in visit:. 
-00008700: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00008710: 6577 5f76 6973 6974 5b27 666f 6f74 7072  ew_visit['footpr
-00008720: 696e 7473 275d 203d 206c 6973 7428 6e70  ints'] = list(np
-00008730: 2e61 7272 6179 2876 6973 6974 5b27 666f  .array(visit['fo
-00008740: 6f74 7072 696e 7473 275d 295b 6978 5d29  otprints'])[ix])
-00008750: 0a0a 2020 2020 2020 2020 2020 2020 7669  ..            vi
-00008760: 7369 7473 2e61 7070 656e 6428 6e65 775f  sits.append(new_
-00008770: 7669 7369 7429 0a0a 2020 2020 7265 7475  visit)..    retu
-00008780: 726e 2076 6973 6974 730a 0a0a 6465 6620  rn visits...def 
-00008790: 6765 745f 7669 7369 745f 666f 6f74 7072  get_visit_footpr
-000087a0: 696e 7473 2876 6973 6974 7329 3a0a 2020  ints(visits):.  
-000087b0: 2020 2222 220a 2020 2020 4164 6420 607e    """.    Add `~
-000087c0: 7368 6170 656c 792e 6765 6f6d 6574 7279  shapely.geometry
-000087d0: 2e50 6f6c 7967 6f6e 6020 2766 6f6f 7470  .Polygon` 'footp
-000087e0: 7269 6e74 2720 6174 7472 6962 7574 6573  rint' attributes
-000087f0: 2074 6f20 7669 7369 7420 6469 6374 2e0a   to visit dict..
-00008800: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-00008810: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00008820: 2020 2076 6973 6974 7320 3a20 6c69 7374     visits : list
-00008830: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
-00008840: 2076 6973 6974 2064 6963 7469 6f6e 6172   visit dictionar
-00008850: 6965 732e 0a0a 2020 2020 2222 220a 0a20  ies...    """.. 
-00008860: 2020 2069 6d70 6f72 7420 6f73 0a0a 2020     import os..  
-00008870: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
-00008880: 2e69 6f2e 6669 7473 2061 7320 7079 6669  .io.fits as pyfi
-00008890: 7473 0a20 2020 2069 6d70 6f72 7420 6173  ts.    import as
-000088a0: 7472 6f70 792e 7763 7320 6173 2070 7977  tropy.wcs as pyw
-000088b0: 6373 0a0a 2020 2020 6672 6f6d 2073 6861  cs..    from sha
-000088c0: 7065 6c79 2e67 656f 6d65 7472 7920 696d  pely.geometry im
-000088d0: 706f 7274 2050 6f6c 7967 6f6e 0a0a 2020  port Polygon..  
-000088e0: 2020 4e20 3d20 6c65 6e28 7669 7369 7473    N = len(visits
-000088f0: 290a 2020 2020 666f 7220 6920 696e 2072  ).    for i in r
-00008900: 616e 6765 284e 293a 0a20 2020 2020 2020  ange(N):.       
-00008910: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
-00008920: 6c65 6e28 7669 7369 7473 5b69 5d5b 2766  len(visits[i]['f
-00008930: 696c 6573 275d 2929 3a0a 2020 2020 2020  iles'])):.      
-00008940: 2020 2020 2020 666c 745f 6669 6c65 203d        flt_file =
-00008950: 2076 6973 6974 735b 695d 5b27 6669 6c65   visits[i]['file
-00008960: 7327 5d5b 6a5d 0a20 2020 2020 2020 2020  s'][j].         
-00008970: 2020 2069 6620 286e 6f74 206f 732e 7061     if (not os.pa
-00008980: 7468 2e65 7869 7374 7328 666c 745f 6669  th.exists(flt_fi
-00008990: 6c65 2929 2026 206f 732e 7061 7468 2e65  le)) & os.path.e
-000089a0: 7869 7374 7328 272e 2e2f 5241 572f 272b  xists('../RAW/'+
-000089b0: 666c 745f 6669 6c65 293a 0a20 2020 2020  flt_file):.     
-000089c0: 2020 2020 2020 2020 2020 2066 6c74 5f66             flt_f
-000089d0: 696c 6520 3d20 272e 2e2f 5241 572f 272b  ile = '../RAW/'+
-000089e0: 666c 745f 6669 6c65 0a0a 2020 2020 2020  flt_file..      
-000089f0: 2020 2020 2020 666c 745f 6a20 3d20 7079        flt_j = py
-00008a00: 6669 7473 2e6f 7065 6e28 666c 745f 6669  fits.open(flt_fi
-00008a10: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
-00008a20: 6820 3d20 666c 745f 6a5b 305d 2e68 6561  h = flt_j[0].hea
-00008a30: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
-00008a40: 6966 2028 685b 2749 4e53 5452 554d 4527  if (h['INSTRUME'
-00008a50: 5d20 3d3d 2027 5746 4333 2729 2026 2028  ] == 'WFC3') & (
-00008a60: 685b 2744 4554 4543 544f 5227 5d20 3d3d  h['DETECTOR'] ==
-00008a70: 2027 4952 2729 3a0a 2020 2020 2020 2020   'IR'):.        
-00008a80: 2020 2020 2020 2020 7763 735f 6a20 3d20          wcs_j = 
-00008a90: 7079 7763 732e 5743 5328 666c 745f 6a5b  pywcs.WCS(flt_j[
-00008aa0: 2753 4349 272c 2031 5d29 0a20 2020 2020  'SCI', 1]).     
-00008ab0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00008ac0: 2020 2020 2020 2020 2020 2020 2077 6373               wcs
-00008ad0: 5f6a 203d 2070 7977 6373 2e57 4353 2866  _j = pywcs.WCS(f
-00008ae0: 6c74 5f6a 5b27 5343 4927 2c20 315d 2c20  lt_j['SCI', 1], 
-00008af0: 666f 626a 3d66 6c74 5f6a 290a 0a20 2020  fobj=flt_j)..   
-00008b00: 2020 2020 2020 2020 2066 705f 6a20 3d20           fp_j = 
-00008b10: 506f 6c79 676f 6e28 7763 735f 6a2e 6361  Polygon(wcs_j.ca
-00008b20: 6c63 5f66 6f6f 7470 7269 6e74 2829 290a  lc_footprint()).
-00008b30: 2020 2020 2020 2020 2020 2020 6966 206a              if j
-00008b40: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00008b50: 2020 2020 2020 2066 705f 6920 3d20 6670         fp_i = fp
-00008b60: 5f6a 0a20 2020 2020 2020 2020 2020 2065  _j.            e
-00008b70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00008b80: 2020 2020 2066 705f 6920 3d20 6670 5f69       fp_i = fp_i
-00008b90: 2e75 6e69 6f6e 2866 705f 6a29 0a20 2020  .union(fp_j).   
-00008ba0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00008bb0: 2020 2020 2020 666c 745f 6a2e 636c 6f73        flt_j.clos
-00008bc0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00008bd0: 0a20 2020 2020 2020 2076 6973 6974 735b  .        visits[
-00008be0: 695d 5b27 666f 6f74 7072 696e 7427 5d20  i]['footprint'] 
-00008bf0: 3d20 6670 5f69 0a0a 2020 2020 7265 7475  = fp_i..    retu
-00008c00: 726e 2076 6973 6974 730a 0a0a 6465 6620  rn visits...def 
-00008c10: 7061 7273 655f 7669 7369 745f 6f76 6572  parse_visit_over
-00008c20: 6c61 7073 2876 6973 6974 732c 2062 7566  laps(visits, buf
-00008c30: 6665 723d 3135 2e29 3a0a 2020 2020 2222  fer=15.):.    ""
-00008c40: 2246 696e 6420 6f76 6572 6c61 7070 696e  "Find overlappin
-00008c50: 6720 7669 7369 7473 2f66 696c 7465 7273  g visits/filters
-00008c60: 2074 6f20 6d61 6b65 2063 6f6d 6269 6e65   to make combine
-00008c70: 6420 6d6f 7361 6963 730a 0a20 2020 2050  d mosaics..    P
-00008c80: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00008c90: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2076 6973  --------.    vis
-00008ca0: 6974 7320 3a20 6c69 7374 0a20 2020 2020  its : list.     
-00008cb0: 2020 204f 7574 7075 7420 6c69 7374 206f     Output list o
-00008cc0: 6620 7669 7369 7420 696e 666f 726d 6174  f visit informat
-00008cd0: 696f 6e20 6672 6f6d 2060 7e67 7269 7a6c  ion from `~grizl
-00008ce0: 692e 7574 696c 732e 7061 7273 655f 666c  i.utils.parse_fl
-00008cf0: 745f 6669 6c65 7360 2e0a 2020 2020 2020  t_files`..      
-00008d00: 2020 5468 6520 7363 7269 7074 206c 6f6f    The script loo
-00008d10: 6b73 2066 6f72 2066 696c 6573 206c 696b  ks for files lik
-00008d20: 6520 6076 6973 6974 735b 695d 5b27 7072  e `visits[i]['pr
-00008d30: 6f64 7563 7427 5d2b 275f 6472 3f5f 7363  oduct']+'_dr?_sc
-00008d40: 692e 6669 7473 2760 0a20 2020 2020 2020  i.fits'`.       
-00008d50: 2074 6f20 636f 6d70 7574 6520 7468 6520   to compute the 
-00008d60: 5743 5320 666f 6f74 7072 696e 7420 6f66  WCS footprint of
-00008d70: 2061 2076 6973 6974 2e20 2054 6865 7365   a visit.  These
-00008d80: 2061 7265 2070 726f 6475 6365 642c 2065   are produced, e
-00008d90: 2e67 2e2c 2062 790a 2020 2020 2020 2020  .g., by.        
-00008da0: 607e 6772 697a 6c69 2e70 7265 702e 7072  `~grizli.prep.pr
-00008db0: 6f63 6573 735f 6469 7265 6374 5f67 7269  ocess_direct_gri
-00008dc0: 736d 5f76 6973 6974 602e 0a0a 2020 2020  sm_visit`...    
-00008dd0: 6275 6666 6572 203a 2066 6c6f 6174 0a20  buffer : float. 
-00008de0: 2020 2020 2020 2042 7566 6665 722c 2069         Buffer, i
-00008df0: 6e20 607e 6173 7472 6f70 792e 756e 6974  n `~astropy.unit
-00008e00: 732e 6172 6373 6563 602c 2074 6f20 6164  s.arcsec`, to ad
-00008e10: 6420 6172 6f75 6e64 2076 6973 6974 2066  d around visit f
-00008e20: 6f6f 7470 7269 6e74 7320 746f 0a20 2020  ootprints to.   
-00008e30: 2020 2020 206c 6f6f 6b20 666f 7220 6f76       look for ov
-00008e40: 6572 6c61 7073 2e0a 0a20 2020 2052 6574  erlaps...    Ret
-00008e50: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-00008e60: 0a20 2020 2065 7870 6f73 7572 655f 6772  .    exposure_gr
-00008e70: 6f75 7073 203a 206c 6973 740a 2020 2020  oups : list.    
-00008e80: 2020 2020 4c69 7374 206f 6620 6f76 6572      List of over
-00008e90: 6c61 7070 696e 6720 7669 7369 7473 2c20  lapping visits, 
-00008ea0: 7769 7468 2073 696d 696c 6172 2066 6f72  with similar for
-00008eb0: 6d61 7420 6173 2069 6e70 7574 2060 7669  mat as input `vi
-00008ec0: 7369 7473 602e 0a0a 2020 2020 2222 220a  sits`...    """.
-00008ed0: 2020 2020 696d 706f 7274 2063 6f70 790a      import copy.
-00008ee0: 2020 2020 6672 6f6d 2073 6861 7065 6c79      from shapely
-00008ef0: 2e67 656f 6d65 7472 7920 696d 706f 7274  .geometry import
-00008f00: 2050 6f6c 7967 6f6e 0a0a 2020 2020 4e20   Polygon..    N 
-00008f10: 3d20 6c65 6e28 7669 7369 7473 290a 0a20  = len(visits).. 
-00008f20: 2020 2065 7870 6f73 7572 655f 6772 6f75     exposure_grou
-00008f30: 7073 203d 205b 5d0a 2020 2020 7573 6564  ps = [].    used
-00008f40: 203d 206e 702e 6172 616e 6765 286c 656e   = np.arange(len
-00008f50: 2876 6973 6974 7329 2920 3c20 300a 0a20  (visits)) < 0.. 
-00008f60: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00008f70: 6528 4e29 3a0a 2020 2020 2020 2020 665f  e(N):.        f_
-00008f80: 6920 3d20 7669 7369 7473 5b69 5d5b 2770  i = visits[i]['p
-00008f90: 726f 6475 6374 275d 2e73 706c 6974 2827  roduct'].split('
-00008fa0: 2d27 295b 2d31 5d0a 2020 2020 2020 2020  -')[-1].        
-00008fb0: 6966 2075 7365 645b 695d 3a0a 2020 2020  if used[i]:.    
-00008fc0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00008fd0: 0a0a 2020 2020 2020 2020 6966 2027 666f  ..        if 'fo
-00008fe0: 6f74 7072 696e 7427 2069 6e20 7669 7369  otprint' in visi
-00008ff0: 7473 5b69 5d3a 0a20 2020 2020 2020 2020  ts[i]:.         
-00009000: 2020 2066 705f 6920 3d20 7669 7369 7473     fp_i = visits
-00009010: 5b69 5d5b 2766 6f6f 7470 7269 6e74 275d  [i]['footprint']
-00009020: 2e62 7566 6665 7228 6275 6666 6572 2f33  .buffer(buffer/3
-00009030: 3630 302e 290a 2020 2020 2020 2020 656c  600.).        el
-00009040: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009050: 5f70 726f 6475 6374 7320 3d20 7669 7369  _products = visi
-00009060: 7473 5b69 5d5b 2770 726f 6475 6374 275d  ts[i]['product']
-00009070: 2b27 5f64 723f 5f73 6369 2e66 6974 7327  +'_dr?_sci.fits'
-00009080: 0a20 2020 2020 2020 2020 2020 2069 6d5f  .            im_
-00009090: 6920 3d20 7079 6669 7473 2e6f 7065 6e28  i = pyfits.open(
-000090a0: 676c 6f62 2e67 6c6f 6228 5f70 726f 6475  glob.glob(_produ
-000090b0: 6374 7329 5b30 5d29 0a20 2020 2020 2020  cts)[0]).       
-000090c0: 2020 2020 2077 6373 5f69 203d 2070 7977       wcs_i = pyw
-000090d0: 6373 2e57 4353 2869 6d5f 695b 305d 290a  cs.WCS(im_i[0]).
-000090e0: 2020 2020 2020 2020 2020 2020 6670 5f69              fp_i
-000090f0: 203d 2050 6f6c 7967 6f6e 2877 6373 5f69   = Polygon(wcs_i
-00009100: 2e63 616c 635f 666f 6f74 7072 696e 7428  .calc_footprint(
-00009110: 2929 2e62 7566 6665 7228 6275 6666 6572  )).buffer(buffer
-00009120: 2f33 3630 302e 290a 2020 2020 2020 2020  /3600.).        
-00009130: 2020 2020 696d 5f69 2e63 6c6f 7365 2829      im_i.close()
-00009140: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-00009150: 2020 2020 2020 6578 706f 7375 7265 5f67        exposure_g
-00009160: 726f 7570 732e 6170 7065 6e64 2863 6f70  roups.append(cop
-00009170: 792e 6465 6570 636f 7079 2876 6973 6974  y.deepcopy(visit
-00009180: 735b 695d 2929 0a0a 2020 2020 2020 2020  s[i]))..        
-00009190: 666f 7220 6a20 696e 2072 616e 6765 2869  for j in range(i
-000091a0: 2b31 2c20 4e29 3a0a 2020 2020 2020 2020  +1, N):.        
-000091b0: 2020 2020 665f 6a20 3d20 7669 7369 7473      f_j = visits
-000091c0: 5b6a 5d5b 2770 726f 6475 6374 275d 2e73  [j]['product'].s
-000091d0: 706c 6974 2827 2d27 295b 2d31 5d0a 2020  plit('-')[-1].  
-000091e0: 2020 2020 2020 2020 2020 6966 2028 665f            if (f_
-000091f0: 6a20 213d 2066 5f69 2920 7c20 2875 7365  j != f_i) | (use
-00009200: 645b 6a5d 293a 0a20 2020 2020 2020 2020  d[j]):.         
-00009210: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00009220: 0a20 2020 2020 2020 2020 2020 2023 0a20  .            #. 
-00009230: 2020 2020 2020 2020 2020 2069 6620 2766             if 'f
-00009240: 6f6f 7470 7269 6e74 2720 696e 2076 6973  ootprint' in vis
-00009250: 6974 735b 6a5d 3a0a 2020 2020 2020 2020  its[j]:.        
-00009260: 2020 2020 2020 2020 6670 5f6a 203d 2076          fp_j = v
-00009270: 6973 6974 735b 6a5d 5b27 666f 6f74 7072  isits[j]['footpr
-00009280: 696e 7427 5d2e 6275 6666 6572 2862 7566  int'].buffer(buf
-00009290: 6665 722f 3336 3030 2e29 0a20 2020 2020  fer/3600.).     
-000092a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000092b0: 2020 2020 2020 2020 2020 2020 205f 7072               _pr
-000092c0: 6f64 7563 7473 203d 2076 6973 6974 735b  oducts = visits[
-000092d0: 6a5d 5b27 7072 6f64 7563 7427 5d2b 275f  j]['product']+'_
-000092e0: 6472 3f5f 7363 692e 6669 7473 270a 2020  dr?_sci.fits'.  
-000092f0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00009300: 5f6a 203d 2070 7966 6974 732e 6f70 656e  _j = pyfits.open
-00009310: 2867 6c6f 622e 676c 6f62 285f 7072 6f64  (glob.glob(_prod
-00009320: 7563 7473 295b 305d 290a 2020 2020 2020  ucts)[0]).      
-00009330: 2020 2020 2020 2020 2020 7763 735f 6a20            wcs_j 
-00009340: 3d20 7079 7763 732e 5743 5328 696d 5f6a  = pywcs.WCS(im_j
-00009350: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
-00009360: 2020 2020 2066 705f 6a20 3d20 506f 6c79       fp_j = Poly
-00009370: 676f 6e28 7763 735f 6a2e 6361 6c63 5f66  gon(wcs_j.calc_f
-00009380: 6f6f 7470 7269 6e74 2829 292e 6275 6666  ootprint()).buff
-00009390: 6572 2862 7566 6665 722f 3336 3030 2e29  er(buffer/3600.)
-000093a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000093b0: 2069 6d5f 6a2e 636c 6f73 6528 290a 2020   im_j.close().  
-000093c0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-000093d0: 2020 2020 2020 206f 6c61 7020 3d20 6670         olap = fp
-000093e0: 5f69 2e69 6e74 6572 7365 6374 696f 6e28  _i.intersection(
-000093f0: 6670 5f6a 290a 2020 2020 2020 2020 2020  fp_j).          
-00009400: 2020 6966 206f 6c61 702e 6172 6561 203e    if olap.area >
-00009410: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00009420: 2020 2020 7573 6564 5b6a 5d20 3d20 5472      used[j] = Tr
-00009430: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00009440: 2020 2066 705f 6920 3d20 6670 5f69 2e75     fp_i = fp_i.u
-00009450: 6e69 6f6e 2866 705f 6a29 0a20 2020 2020  nion(fp_j).     
-00009460: 2020 2020 2020 2020 2020 2065 7870 6f73             expos
-00009470: 7572 655f 6772 6f75 7073 5b2d 315d 5b27  ure_groups[-1]['
-00009480: 666f 6f74 7072 696e 7427 5d20 3d20 6670  footprint'] = fp
-00009490: 5f69 0a20 2020 2020 2020 2020 2020 2020  _i.             
-000094a0: 2020 2065 7870 6f73 7572 655f 6772 6f75     exposure_grou
-000094b0: 7073 5b2d 315d 5b27 6669 6c65 7327 5d2e  ps[-1]['files'].
-000094c0: 6578 7465 6e64 2876 6973 6974 735b 6a5d  extend(visits[j]
-000094d0: 5b27 6669 6c65 7327 5d29 0a0a 2020 2020  ['files'])..    
-000094e0: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
-000094f0: 656e 2865 7870 6f73 7572 655f 6772 6f75  en(exposure_grou
-00009500: 7073 2929 3a0a 2020 2020 2020 2020 666c  ps)):.        fl
-00009510: 745f 6920 3d20 7079 6669 7473 2e6f 7065  t_i = pyfits.ope
-00009520: 6e28 6578 706f 7375 7265 5f67 726f 7570  n(exposure_group
-00009530: 735b 695d 5b27 6669 6c65 7327 5d5b 305d  s[i]['files'][0]
-00009540: 290a 2020 2020 2020 2020 7072 6f64 7563  ).        produc
-00009550: 7420 3d20 666c 745f 695b 305d 2e68 6561  t = flt_i[0].hea
-00009560: 6465 725b 2754 4152 474e 414d 4527 5d2e  der['TARGNAME'].
-00009570: 6c6f 7765 7228 290a 2020 2020 2020 2020  lower().        
-00009580: 6966 2070 726f 6475 6374 203d 3d20 2761  if product == 'a
-00009590: 6e79 273a 0a20 2020 2020 2020 2020 2020  ny':.           
-000095a0: 2070 726f 6475 6374 203d 2027 7061 722d   product = 'par-
-000095b0: 272b 7261 6465 635f 746f 5f74 6172 676e  '+radec_to_targn
-000095c0: 616d 6528 6865 6164 6572 3d66 6c74 5f69  ame(header=flt_i
-000095d0: 5b27 5343 4927 2c20 315d 2e68 6561 6465  ['SCI', 1].heade
-000095e0: 7229 0a0a 2020 2020 2020 2020 665f 6920  r)..        f_i 
-000095f0: 3d20 6578 706f 7375 7265 5f67 726f 7570  = exposure_group
-00009600: 735b 695d 5b27 7072 6f64 7563 7427 5d2e  s[i]['product'].
-00009610: 7370 6c69 7428 272d 2729 5b2d 315d 0a20  split('-')[-1]. 
-00009620: 2020 2020 2020 2070 726f 6475 6374 202b         product +
-00009630: 3d20 272d 272b 665f 690a 2020 2020 2020  = '-'+f_i.      
-00009640: 2020 6578 706f 7375 7265 5f67 726f 7570    exposure_group
-00009650: 735b 695d 5b27 7072 6f64 7563 7427 5d20  s[i]['product'] 
-00009660: 3d20 7072 6f64 7563 740a 2020 2020 2020  = product.      
-00009670: 2020 666c 745f 692e 636c 6f73 6528 290a    flt_i.close().
-00009680: 2020 2020 2020 2020 0a20 2020 2072 6574          .    ret
-00009690: 7572 6e20 6578 706f 7375 7265 5f67 726f  urn exposure_gro
-000096a0: 7570 730a 0a0a 4449 5245 4354 5f4f 5244  ups...DIRECT_ORD
-000096b0: 4552 203d 207b 2747 3130 3227 3a20 5b27  ER = {'G102': ['
-000096c0: 4631 3035 5727 2c20 2746 3131 3057 272c  F105W', 'F110W',
-000096d0: 2027 4630 3938 4d27 2c20 2746 3132 3557   'F098M', 'F125W
-000096e0: 272c 2027 4631 3430 5727 2c20 2746 3136  ', 'F140W', 'F16
-000096f0: 3057 272c 2027 4631 3237 4d27 2c20 2746  0W', 'F127M', 'F
-00009700: 3133 394d 272c 2027 4631 3533 4d27 2c20  139M', 'F153M', 
-00009710: 2746 3133 324e 272c 2027 4631 3330 4e27  'F132N', 'F130N'
-00009720: 2c20 2746 3132 384e 272c 2027 4631 3236  , 'F128N', 'F126
-00009730: 4e27 2c20 2746 3136 344e 272c 2027 4631  N', 'F164N', 'F1
-00009740: 3637 4e27 5d2c 0a20 2020 2020 2020 2020  67N'],.         
-00009750: 2020 2020 2020 2027 4731 3431 273a 205b         'G141': [
-00009760: 2746 3134 3057 272c 2027 4631 3630 5727  'F140W', 'F160W'
-00009770: 2c20 2746 3132 3557 272c 2027 4631 3035  , 'F125W', 'F105
-00009780: 5727 2c20 2746 3131 3057 272c 2027 4630  W', 'F110W', 'F0
-00009790: 3938 4d27 2c20 2746 3132 374d 272c 2027  98M', 'F127M', '
-000097a0: 4631 3339 4d27 2c20 2746 3135 334d 272c  F139M', 'F153M',
-000097b0: 2027 4631 3332 4e27 2c20 2746 3133 304e   'F132N', 'F130N
-000097c0: 272c 2027 4631 3238 4e27 2c20 2746 3132  ', 'F128N', 'F12
-000097d0: 364e 272c 2027 4631 3634 4e27 2c20 2746  6N', 'F164N', 'F
-000097e0: 3136 374e 275d 2c0a 2020 2020 2020 2020  167N'],.        
-000097f0: 2020 2020 2020 2020 2747 3830 304c 273a          'G800L':
-00009800: 205b 2746 3831 3457 272c 2027 4636 3036   ['F814W', 'F606
-00009810: 5727 2c20 2746 3835 304c 5027 2c20 2746  W', 'F850LP', 'F
-00009820: 3737 3557 272c 2027 4634 3335 5727 2c20  775W', 'F435W', 
-00009830: 2746 3130 3557 272c 2027 4631 3130 5727  'F105W', 'F110W'
-00009840: 2c20 2746 3039 384d 272c 2027 4631 3235  , 'F098M', 'F125
-00009850: 5727 2c20 2746 3134 3057 272c 2027 4631  W', 'F140W', 'F1
-00009860: 3630 5727 2c20 2746 3132 374d 272c 2027  60W', 'F127M', '
-00009870: 4631 3339 4d27 2c20 2746 3135 334d 272c  F139M', 'F153M',
-00009880: 2027 4631 3332 4e27 2c20 2746 3133 304e   'F132N', 'F130N
-00009890: 272c 2027 4631 3238 4e27 2c20 2746 3132  ', 'F128N', 'F12
-000098a0: 364e 272c 2027 4631 3634 4e27 2c20 2746  6N', 'F164N', 'F
-000098b0: 3136 374e 275d 2c0a 2020 2020 2020 2020  167N'],.        
-000098c0: 2020 2020 2020 2020 2747 5231 3530 4327          'GR150C'
-000098d0: 3a20 5b27 4631 3135 5727 2c20 2746 3135  : ['F115W', 'F15
-000098e0: 3057 272c 2027 4632 3030 5727 5d2c 200a  0W', 'F200W'], .
-000098f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009900: 2747 5231 3530 5227 3a20 5b27 4631 3135  'GR150R': ['F115
-00009910: 5727 2c20 2746 3135 3057 272c 2027 4632  W', 'F150W', 'F2
-00009920: 3030 5727 5d7d 0a0a 0a64 6566 2070 6172  00W']}...def par
-00009930: 7365 5f67 7269 736d 5f61 7373 6f63 6961  se_grism_associa
-00009940: 7469 6f6e 7328 6578 706f 7375 7265 5f67  tions(exposure_g
-00009950: 726f 7570 732c 2069 6e66 6f2c 0a20 2020  roups, info,.   
-00009960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009970: 2020 2020 2020 2020 2020 6265 7374 5f64            best_d
-00009980: 6972 6563 743d 4449 5245 4354 5f4f 5244  irect=DIRECT_ORD
-00009990: 4552 2c0a 2020 2020 2020 2020 2020 2020  ER,.            
-000099a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099b0: 2067 6574 5f6d 6178 5f6f 7665 726c 6170   get_max_overlap
-000099c0: 3d54 7275 6529 3a0a 2020 2020 2222 2247  =True):.    """G
-000099d0: 6574 2061 7373 6f63 6961 7465 6420 6c69  et associated li
-000099e0: 7374 7320 6f66 2067 7269 736d 2061 6e64  sts of grism and
-000099f0: 2064 6972 6563 7420 6578 706f 7375 7265   direct exposure
-00009a00: 730a 0a20 2020 2050 6172 616d 6574 6572  s..    Parameter
-00009a10: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00009a20: 0a20 2020 2065 7870 6f73 7572 655f 6772  .    exposure_gr
-00009a30: 7570 7320 3a20 6c69 7374 0a20 2020 2020  ups : list.     
-00009a40: 2020 204f 7574 7075 7420 6c69 7374 206f     Output list o
-00009a50: 6620 6f76 6572 6c61 7070 696e 6720 7669  f overlapping vi
-00009a60: 7369 7473 2066 726f 6d0a 2020 2020 2020  sits from.      
-00009a70: 2020 607e 6772 697a 6c69 2e75 7469 6c73    `~grizli.utils
-00009a80: 2e70 6172 7365 5f76 6973 6974 5f6f 7665  .parse_visit_ove
-00009a90: 726c 6170 7360 2e0a 0a20 2020 2062 6573  rlaps`...    bes
-00009aa0: 745f 6469 7265 6374 203a 2064 6963 740a  t_direct : dict.
-00009ab0: 2020 2020 2020 2020 4469 6374 696f 6e61          Dictiona
-00009ac0: 7279 206f 6620 7468 6520 7072 6566 6572  ry of the prefer
-00009ad0: 7265 6420 6469 7265 6374 2069 6d61 6769  red direct imagi
-00009ae0: 6e67 2066 696c 7465 7273 2074 6f20 7573  ng filters to us
-00009af0: 6520 7769 7468 2061 0a20 2020 2020 2020  e with a.       
-00009b00: 2070 6172 7469 6375 6c61 7220 6772 6973   particular gris
-00009b10: 6d2e 0a0a 2020 2020 5265 7475 726e 730a  m...    Returns.
-00009b20: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00009b30: 6772 6973 6d5f 6772 6f75 7073 203a 206c  grism_groups : l
-00009b40: 6973 740a 2020 2020 2020 2020 4c69 7374  ist.        List
-00009b50: 206f 6620 6469 6374 696f 6e61 7269 6573   of dictionaries
-00009b60: 2077 6974 6820 6173 736f 6369 6174 6564   with associated
-00009b70: 2027 6469 7265 6374 2720 616e 6420 2767   'direct' and 'g
-00009b80: 7269 736d 2720 656e 7472 6965 732e 0a0a  rism' entries...
-00009b90: 2020 2020 2222 220a 2020 2020 4e20 3d20      """.    N = 
-00009ba0: 6c65 6e28 6578 706f 7375 7265 5f67 726f  len(exposure_gro
-00009bb0: 7570 7329 0a0a 2020 2020 6772 6973 6d5f  ups)..    grism_
-00009bc0: 6772 6f75 7073 203d 205b 5d0a 2020 2020  groups = [].    
-00009bd0: 666f 7220 6920 696e 2072 616e 6765 284e  for i in range(N
-00009be0: 293a 0a20 2020 2020 2020 205f 6573 7069  ):.        _espi
-00009bf0: 203d 2065 7870 6f73 7572 655f 6772 6f75   = exposure_grou
-00009c00: 7073 5b69 5d5b 2770 726f 6475 6374 275d  ps[i]['product']
-00009c10: 2e73 706c 6974 2827 2d27 290a 2020 2020  .split('-').    
-00009c20: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-00009c30: 5f65 7370 695b 2d32 5d5b 305d 2069 6e20  _espi[-2][0] in 
-00009c40: 2766 6727 3a0a 2020 2020 2020 2020 2020  'fg':.          
-00009c50: 2020 7075 7069 6c5f 6920 3d20 5f65 7370    pupil_i = _esp
-00009c60: 695b 2d32 5d0a 2020 2020 2020 2020 2020  i[-2].          
-00009c70: 2020 665f 6920 3d20 5f65 7370 695b 2d31    f_i = _espi[-1
-00009c80: 5d0a 2020 2020 2020 2020 2020 2020 726f  ].            ro
-00009c90: 6f74 5f69 203d 2027 2d27 2e6a 6f69 6e28  ot_i = '-'.join(
-00009ca0: 5f65 7370 695b 3a2d 325d 290a 2020 2020  _espi[:-2]).    
-00009cb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00009cc0: 2020 2020 2020 7075 7069 6c5f 6920 3d20        pupil_i = 
-00009cd0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00009ce0: 2066 5f69 203d 205f 6573 7069 5b2d 315d   f_i = _espi[-1]
-00009cf0: 0a20 2020 2020 2020 2020 2020 2072 6f6f  .            roo
-00009d00: 745f 6920 3d20 272d 272e 6a6f 696e 285f  t_i = '-'.join(_
-00009d10: 6573 7069 5b3a 2d31 5d29 0a20 2020 2020  espi[:-1]).     
-00009d20: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00009d30: 6966 2066 5f69 2e73 7461 7274 7377 6974  if f_i.startswit
-00009d40: 6828 2767 2729 3a0a 2020 2020 2020 2020  h('g'):.        
-00009d50: 2020 2020 6772 6f75 7020 3d20 4f72 6465      group = Orde
-00009d60: 7265 6444 6963 7428 6772 6973 6d3d 6578  redDict(grism=ex
-00009d70: 706f 7375 7265 5f67 726f 7570 735b 695d  posure_groups[i]
-00009d80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009da0: 2020 6469 7265 6374 3d4e 6f6e 6529 0a20    direct=None). 
-00009db0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00009dc0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00009dd0: 650a 2020 2020 2020 2020 0a20 2020 2020  e.        .     
-00009de0: 2020 2066 705f 6920 3d20 6578 706f 7375     fp_i = exposu
-00009df0: 7265 5f67 726f 7570 735b 695d 5b27 666f  re_groups[i]['fo
-00009e00: 6f74 7072 696e 7427 5d0a 2020 2020 2020  otprint'].      
-00009e10: 2020 6f6c 6170 5f69 203d 2030 2e0a 2020    olap_i = 0..  
-00009e20: 2020 2020 2020 645f 6920 3d20 665f 690a        d_i = f_i.
-00009e30: 2020 2020 2020 2020 645f 6964 7820 3d20          d_idx = 
-00009e40: 3130 0a20 2020 2020 2020 2066 6f72 206a  10.        for j
-00009e50: 2069 6e20 7261 6e67 6528 4e29 3a0a 2020   in range(N):.  
-00009e60: 2020 2020 2020 2020 2020 5f65 7370 6a20            _espj 
-00009e70: 3d20 6578 706f 7375 7265 5f67 726f 7570  = exposure_group
-00009e80: 735b 6a5d 5b27 7072 6f64 7563 7427 5d2e  s[j]['product'].
-00009e90: 7370 6c69 7428 272d 2729 0a20 2020 2020  split('-').     
-00009ea0: 2020 2020 2020 2069 6620 5f65 7370 6a5b         if _espj[
-00009eb0: 2d32 5d5b 305d 2069 6e20 2766 6727 3a0a  -2][0] in 'fg':.
-00009ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ed0: 7075 7069 6c5f 6a20 3d20 5f65 7370 6a5b  pupil_j = _espj[
-00009ee0: 2d32 5d0a 2020 2020 2020 2020 2020 2020  -2].            
-00009ef0: 2020 2020 665f 6a20 3d20 5f65 7370 6a5b      f_j = _espj[
-00009f00: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
-00009f10: 2020 2020 726f 6f74 5f6a 203d 2027 2d27      root_j = '-'
-00009f20: 2e6a 6f69 6e28 5f65 7370 6a5b 3a2d 325d  .join(_espj[:-2]
-00009f30: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00009f40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009f50: 2020 2020 665f 6a20 3d20 5f65 7370 6a5b      f_j = _espj[
-00009f60: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
-00009f70: 2020 2020 726f 6f74 5f6a 203d 2027 2d27      root_j = '-'
-00009f80: 2e6a 6f69 6e28 5f65 7370 6a5b 3a2d 315d  .join(_espj[:-1]
-00009f90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009fa0: 2020 7075 7069 6c5f 6a20 3d20 4e6f 6e65    pupil_j = None
-00009fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009fc0: 200a 2020 2020 2020 2020 2020 2020 6966   .            if
-00009fd0: 2066 5f6a 2e73 7461 7274 7377 6974 6828   f_j.startswith(
-00009fe0: 2767 2729 3a0a 2020 2020 2020 2020 2020  'g'):.          
-00009ff0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0000a000: 2020 2020 2020 2020 2020 2020 6670 5f6a              fp_j
-0000a010: 203d 2065 7870 6f73 7572 655f 6772 6f75   = exposure_grou
-0000a020: 7073 5b6a 5d5b 2766 6f6f 7470 7269 6e74  ps[j]['footprint
-0000a030: 275d 0a20 2020 2020 2020 2020 2020 206f  '].            o
-0000a040: 6c61 7020 3d20 6670 5f69 2e69 6e74 6572  lap = fp_i.inter
-0000a050: 7365 6374 696f 6e28 6670 5f6a 290a 0a20  section(fp_j).. 
-0000a060: 2020 2020 2020 2020 2020 2069 6620 2872             if (r
-0000a070: 6f6f 745f 6a20 3d3d 2072 6f6f 745f 6929  oot_j == root_i)
-0000a080: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
-0000a090: 2020 2069 6620 7075 7069 6c5f 6920 6973     if pupil_i is
-0000a0a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000a0c0: 6620 7075 7069 6c5f 6a20 3d3d 2070 7570  f pupil_j == pup
-0000a0d0: 696c 5f69 3a0a 2020 2020 2020 2020 2020  il_i:.          
-0000a0e0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-0000a0f0: 6f75 705b 2764 6972 6563 7427 5d20 3d20  oup['direct'] = 
-0000a100: 6578 706f 7375 7265 5f67 726f 7570 735b  exposure_groups[
-0000a110: 6a5d 0a20 2020 2020 2020 2020 2020 2020  j].             
-0000a120: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a140: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-0000a150: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000a160: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000a170: 2020 2020 2020 2020 6966 2066 5f6a 2e75          if f_j.u
-0000a180: 7070 6572 2829 206e 6f74 2069 6e20 6265  pper() not in be
-0000a190: 7374 5f64 6972 6563 745b 665f 692e 7570  st_direct[f_i.up
-0000a1a0: 7065 7228 295d 3a0a 2020 2020 2020 2020  per()]:.        
-0000a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1c0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-0000a1d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000a1e0: 6265 7374 5f64 6972 6563 745b 665f 692e  best_direct[f_i.
-0000a1f0: 7570 7065 7228 295d 2e69 6e64 6578 2866  upper()].index(f
-0000a200: 5f6a 2e75 7070 6572 2829 2920 3c20 645f  _j.upper()) < d_
-0000a210: 6964 783a 0a20 2020 2020 2020 2020 2020  idx:.           
-0000a220: 2020 2020 2020 2020 2020 2020 2064 5f69               d_i
-0000a230: 6478 203d 2062 6573 745f 6469 7265 6374  dx = best_direct
-0000a240: 5b66 5f69 2e75 7070 6572 2829 5d2e 696e  [f_i.upper()].in
-0000a250: 6465 7828 665f 6a2e 7570 7065 7228 2929  dex(f_j.upper())
-0000a260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a270: 2020 2020 2020 2020 2067 726f 7570 5b27           group['
-0000a280: 6469 7265 6374 275d 203d 2065 7870 6f73  direct'] = expos
-0000a290: 7572 655f 6772 6f75 7073 5b6a 5d0a 2020  ure_groups[j].  
-0000a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2b0: 2020 2020 2020 6f6c 6170 5f69 203d 206f        olap_i = o
-0000a2c0: 6c61 702e 6172 6561 0a20 2020 2020 2020  lap.area.       
-0000a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2e0: 2064 5f69 203d 2066 5f6a 0a0a 2020 2020   d_i = f_j..    
-0000a2f0: 2020 2020 6772 6973 6d5f 6772 6f75 7073      grism_groups
-0000a300: 2e61 7070 656e 6428 6772 6f75 7029 0a0a  .append(group)..
-0000a310: 2020 2020 7265 7475 726e 2067 7269 736d      return grism
-0000a320: 5f67 726f 7570 730a 0a0a 6465 6620 6765  _groups...def ge
-0000a330: 745f 6873 745f 6669 6c74 6572 2868 6561  t_hst_filter(hea
-0000a340: 6465 722c 202a 2a6b 7761 7267 7329 3a0a  der, **kwargs):.
-0000a350: 2020 2020 2222 220a 2020 2020 4465 7072      """.    Depr
-0000a360: 6563 6174 6564 3a20 7573 6520 6067 7269  ecated: use `gri
-0000a370: 7a6c 692e 7574 696c 732e 7061 7273 655f  zli.utils.parse_
-0000a380: 6669 6c74 6572 5f66 726f 6d5f 6865 6164  filter_from_head
-0000a390: 6572 600a 2020 2020 2222 220a 2020 2020  er`.    """.    
-0000a3a0: 0a20 2020 2072 6573 756c 7420 3d20 7061  .    result = pa
-0000a3b0: 7273 655f 6669 6c74 6572 5f66 726f 6d5f  rse_filter_from_
-0000a3c0: 6865 6164 6572 2868 6561 6465 722c 202a  header(header, *
-0000a3d0: 2a6b 7761 7267 7329 0a20 2020 2072 6574  *kwargs).    ret
-0000a3e0: 7572 6e20 7265 7375 6c74 0a0a 0a64 6566  urn result...def
-0000a3f0: 2070 6172 7365 5f66 696c 7465 725f 6672   parse_filter_fr
-0000a400: 6f6d 5f68 6561 6465 7228 6865 6164 6572  om_header(header
-0000a410: 2c20 6669 6c74 6572 5f6f 6e6c 793d 4661  , filter_only=Fa
-0000a420: 6c73 652c 206a 7773 745f 6465 7465 6374  lse, jwst_detect
-0000a430: 6f72 3d46 616c 7365 2c20 2a2a 6b77 6172  or=False, **kwar
-0000a440: 6773 293a 0a20 2020 2022 2222 4765 7420  gs):.    """Get 
-0000a450: 7369 6d70 6c65 2066 696c 7465 7220 6e61  simple filter na
-0000a460: 6d65 206f 7574 206f 6620 616e 2048 5354  me out of an HST
-0000a470: 2f4a 5753 5420 696d 6167 6520 6865 6164  /JWST image head
-0000a480: 6572 2e0a 0a20 2020 2041 4353 2068 6173  er...    ACS has
-0000a490: 2074 776f 206b 6579 776f 7264 7320 666f   two keywords fo
-0000a4a0: 7220 7468 6520 7477 6f20 6669 6c74 6572  r the two filter
-0000a4b0: 2077 6865 656c 732c 2073 6f20 6a75 7374   wheels, so just
-0000a4c0: 2072 6574 7572 6e20 7468 650a 2020 2020   return the.    
-0000a4d0: 6e6f 6e2d 434c 4541 5220 6669 6c74 6572  non-CLEAR filter
-0000a4e0: 2e20 466f 7220 6578 616d 706c 652c 0a0a  . For example,..
-0000a4f0: 2020 2020 2020 2020 3e3e 3e20 6820 3d20          >>> h = 
-0000a500: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
-0000a510: 4865 6164 6572 2829 0a20 2020 2020 2020  Header().       
-0000a520: 203e 3e3e 2068 5b27 494e 5354 5255 4d45   >>> h['INSTRUME
-0000a530: 275d 203d 2027 4143 5327 0a20 2020 2020  '] = 'ACS'.     
-0000a540: 2020 203e 3e3e 2068 5b27 4649 4c54 4552     >>> h['FILTER
-0000a550: 3127 5d20 3d20 2743 4c45 4152 314c 270a  1'] = 'CLEAR1L'.
-0000a560: 2020 2020 2020 2020 3e3e 3e20 685b 2746          >>> h['F
-0000a570: 494c 5445 5232 275d 203d 2027 4638 3134  ILTER2'] = 'F814
-0000a580: 5727 0a20 2020 2020 2020 203e 3e3e 2066  W'.        >>> f
-0000a590: 726f 6d20 6772 697a 6c69 2e75 7469 6c73  rom grizli.utils
-0000a5a0: 2069 6d70 6f72 7420 7061 7273 655f 6669   import parse_fi
-0000a5b0: 6c74 6572 5f66 726f 6d5f 6865 6164 6572  lter_from_header
-0000a5c0: 0a20 2020 2020 2020 203e 3e3e 2070 7269  .        >>> pri
-0000a5d0: 6e74 2870 6172 7365 5f66 696c 7465 725f  nt(parse_filter_
-0000a5e0: 6672 6f6d 5f68 6561 6465 7228 6829 290a  from_header(h)).
-0000a5f0: 2020 2020 2020 2020 4638 3134 570a 2020          F814W.  
-0000a600: 2020 2020 2020 3e3e 3e20 685b 2746 494c        >>> h['FIL
-0000a610: 5445 5231 275d 203d 2027 4738 3030 4c27  TER1'] = 'G800L'
-0000a620: 0a20 2020 2020 2020 203e 3e3e 2068 5b27  .        >>> h['
-0000a630: 4649 4c54 4552 3227 5d20 3d20 2743 4c45  FILTER2'] = 'CLE
-0000a640: 4152 324c 270a 2020 2020 2020 2020 3e3e  AR2L'.        >>
-0000a650: 3e20 7072 696e 7428 7061 7273 655f 6669  > print(parse_fi
-0000a660: 6c74 6572 5f66 726f 6d5f 6865 6164 6572  lter_from_header
-0000a670: 2868 2929 0a20 2020 2020 2020 2047 3830  (h)).        G80
-0000a680: 304c 0a20 2020 2020 2020 2020 2020 200a  0L.            .
-0000a690: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0000a6a0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0000a6b0: 2020 6865 6164 6572 203a 2060 7e61 7374    header : `~ast
-0000a6c0: 726f 7079 2e69 6f2e 6669 7473 2e48 6561  ropy.io.fits.Hea
-0000a6d0: 6465 7260 0a20 2020 2020 2020 2049 6d61  der`.        Ima
-0000a6e0: 6765 2068 6561 6465 7220 7769 7468 2046  ge header with F
-0000a6f0: 494c 5445 5220 6f72 2046 494c 5445 5231  ILTER or FILTER1
-0000a700: 2c46 494c 5445 5232 2c2e 2e2e 2c46 494c  ,FILTER2,...,FIL
-0000a710: 5445 524e 206b 6579 776f 7264 730a 2020  TERN keywords.  
-0000a720: 2020 0a20 2020 2066 696c 7465 725f 6f6e    .    filter_on
-0000a730: 6c79 203a 2062 6f6f 6c0a 2020 2020 2020  ly : bool.      
-0000a740: 2020 4966 2074 7275 652c 2064 6f6e 2774    If true, don't
-0000a750: 2064 6f20 616e 7920 7370 6563 6961 6c20   do any special 
-0000a760: 6861 6e64 6c69 6e67 2077 6974 6820 4a57  handling with JW
-0000a770: 5354 2062 7574 206a 7573 7420 7265 7475  ST but just retu
-0000a780: 726e 2074 6865 0a20 2020 2020 2020 2060  rn the.        `
-0000a790: 6046 494c 5445 5260 6020 6b65 7977 6f72  `FILTER`` keywor
-0000a7a0: 6420 6974 7365 6c66 2e20 4f74 6865 7277  d itself. Otherw
-0000a7b0: 6973 652c 2066 6f72 204a 5753 542f 4e49  ise, for JWST/NI
-0000a7c0: 5249 5353 2c20 7265 7475 726e 200a 2020  RISS, return .  
-0000a7d0: 2020 2020 2020 6060 7b50 5550 494c 7d2d        ``{PUPIL}-
-0000a7e0: 7b46 494c 5445 527d 6060 2061 6e64 2066  {FILTER}`` and f
-0000a7f0: 6f72 204a 5753 542f 4e49 5243 414d 2c20  or JWST/NIRCAM, 
-0000a800: 7265 7475 726e 2060 607b 4649 4c54 4552  return ``{FILTER
-0000a810: 7d2d 7b50 5550 494c 7d60 600a 2020 2020  }-{PUPIL}``.    
-0000a820: 2020 2020 0a20 2020 206a 7773 745f 6465      .    jwst_de
-0000a830: 7465 6374 6f72 203a 2062 6f6f 6c0a 2020  tector : bool.  
-0000a840: 2020 2020 2020 4966 2054 7275 652c 2070        If True, p
-0000a850: 7265 7065 6e64 2060 6044 4554 4543 544f  repend ``DETECTO
-0000a860: 5260 6020 746f 206f 7574 7075 7420 666f  R`` to output fo
-0000a870: 7220 4a57 5354 204e 4952 4361 6d20 616e  r JWST NIRCam an
-0000a880: 6420 4e49 5249 5353 0a20 2020 2020 2020  d NIRISS.       
-0000a890: 2074 6f20 6469 7374 696e 6775 6973 6820   to distinguish 
-0000a8a0: 4e49 5243 616d 2064 6574 6563 746f 7273  NIRCam detectors
-0000a8b0: 2061 6e64 2066 696c 7465 7220 6e61 6d65   and filter name
-0000a8c0: 7320 636f 6d6d 6f6e 2062 6574 7765 656e  s common between
-0000a8d0: 200a 2020 2020 2020 2020 7468 6573 6520   .        these 
-0000a8e0: 696e 7374 7275 6d65 6e74 732e 0a20 2020  instruments..   
-0000a8f0: 2020 2020 200a 2020 2020 5265 7475 726e       .    Return
-0000a900: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0000a910: 2020 6669 6c74 6572 203a 2073 7472 0a0a    filter : str..
-0000a920: 2020 2020 2222 220a 2020 2020 0a20 2020      """.    .   
-0000a930: 2069 6620 2749 4e53 5452 554d 4527 206e   if 'INSTRUME' n
-0000a940: 6f74 2069 6e20 6865 6164 6572 3a0a 2020  ot in header:.  
-0000a950: 2020 2020 2020 696e 7374 7275 6d65 203d        instrume =
-0000a960: 2027 4e2f 4127 0a20 2020 2065 6c73 653a   'N/A'.    else:
-0000a970: 0a20 2020 2020 2020 2069 6e73 7472 756d  .        instrum
-0000a980: 6520 3d20 6865 6164 6572 5b27 494e 5354  e = header['INST
-0000a990: 5255 4d45 275d 0a20 2020 2020 2020 200a  RUME'].        .
-0000a9a0: 2020 2020 6966 2069 6e73 7472 756d 652e      if instrume.
-0000a9b0: 7374 7269 7028 2920 3d3d 2027 4143 5327  strip() == 'ACS'
-0000a9c0: 3a0a 2020 2020 2020 2020 666f 7220 6920  :.        for i 
-0000a9d0: 696e 205b 312c 2032 5d3a 0a20 2020 2020  in [1, 2]:.     
-0000a9e0: 2020 2020 2020 2066 696c 7465 725f 6920         filter_i 
-0000a9f0: 3d20 6865 6164 6572 5b27 4649 4c54 4552  = header['FILTER
-0000aa00: 7b30 3a64 7d27 2e66 6f72 6d61 7428 6929  {0:d}'.format(i)
-0000aa10: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-0000aa20: 2027 434c 4541 5227 2069 6e20 6669 6c74   'CLEAR' in filt
-0000aa30: 6572 5f69 3a0a 2020 2020 2020 2020 2020  er_i:.          
-0000aa40: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-0000aa50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000aa60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aa70: 2066 696c 7465 7220 3d20 6669 6c74 6572   filter = filter
-0000aa80: 5f69 0a0a 2020 2020 656c 6966 2069 6e73  _i..    elif ins
-0000aa90: 7472 756d 6520 3d3d 2027 5746 5043 3227  trume == 'WFPC2'
-0000aaa0: 3a0a 2020 2020 2020 2020 6669 6c74 6572  :.        filter
-0000aab0: 203d 2068 6561 6465 725b 2746 494c 544e   = header['FILTN
-0000aac0: 414d 3127 5d0a 2020 2020 2020 2020 0a20  AM1'].        . 
-0000aad0: 2020 2065 6c69 6620 696e 7374 7275 6d65     elif instrume
-0000aae0: 203d 3d20 274e 4952 4953 5327 3a0a 2020   == 'NIRISS':.  
-0000aaf0: 2020 2020 2020 6966 2066 696c 7465 725f        if filter_
-0000ab00: 6f6e 6c79 3a0a 2020 2020 2020 2020 2020  only:.          
-0000ab10: 2020 6669 6c74 6572 203d 2068 6561 6465    filter = heade
-0000ab20: 725b 2746 494c 5445 5227 5d0a 2020 2020  r['FILTER'].    
-0000ab30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000ab40: 2020 2020 2020 6669 6c74 6572 203d 2027        filter = '
-0000ab50: 7b30 7d2d 7b31 7d27 2e66 6f72 6d61 7428  {0}-{1}'.format(
-0000ab60: 6865 6164 6572 5b27 5055 5049 4c27 5d2c  header['PUPIL'],
-0000ab70: 2068 6561 6465 725b 2746 494c 5445 5227   header['FILTER'
-0000ab80: 5d29 0a20 2020 2020 2020 200a 2020 2020  ]).        .    
-0000ab90: 2020 2020 6966 206a 7773 745f 6465 7465      if jwst_dete
-0000aba0: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
-0000abb0: 2020 6669 6c74 6572 203d 2027 7b30 7d2d    filter = '{0}-
-0000abc0: 7b31 7d27 2e66 6f72 6d61 7428 6865 6164  {1}'.format(head
-0000abd0: 6572 5b27 4445 5445 4354 4f52 275d 2c20  er['DETECTOR'], 
-0000abe0: 6669 6c74 6572 290a 2020 2020 2020 2020  filter).        
-0000abf0: 2020 2020 0a20 2020 2065 6c69 6620 696e      .    elif in
-0000ac00: 7374 7275 6d65 203d 3d20 274e 4952 4341  strume == 'NIRCA
-0000ac10: 4d27 3a0a 2020 2020 2020 2020 6966 2066  M':.        if f
-0000ac20: 696c 7465 725f 6f6e 6c79 3a0a 2020 2020  ilter_only:.    
-0000ac30: 2020 2020 2020 2020 6669 6c74 6572 203d          filter =
-0000ac40: 2068 6561 6465 725b 2746 494c 5445 5227   header['FILTER'
-0000ac50: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-0000ac60: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
-0000ac70: 6572 203d 2027 7b30 7d2d 7b31 7d27 2e66  er = '{0}-{1}'.f
-0000ac80: 6f72 6d61 7428 6865 6164 6572 5b27 4649  ormat(header['FI
-0000ac90: 4c54 4552 275d 2c20 6865 6164 6572 5b27  LTER'], header['
-0000aca0: 5055 5049 4c27 5d29 0a20 2020 2020 2020  PUPIL']).       
-0000acb0: 2069 6620 6a77 7374 5f64 6574 6563 746f   if jwst_detecto
-0000acc0: 723a 0a20 2020 2020 2020 2020 2020 2066  r:.            f
-0000acd0: 696c 7465 7220 3d20 277b 307d 2d7b 317d  ilter = '{0}-{1}
-0000ace0: 272e 666f 726d 6174 2868 6561 6465 725b  '.format(header[
-0000acf0: 2744 4554 4543 544f 5227 5d2c 2066 696c  'DETECTOR'], fil
-0000ad00: 7465 7229 0a20 2020 2020 2020 2020 2020  ter).           
-0000ad10: 2066 696c 7465 7220 3d20 6669 6c74 6572   filter = filter
-0000ad20: 2e72 6570 6c61 6365 2827 4c4f 4e47 272c  .replace('LONG',
-0000ad30: 2735 2729 0a20 2020 2020 2020 2020 2020  '5').           
-0000ad40: 200a 2020 2020 656c 6966 2027 4649 4c54   .    elif 'FILT
-0000ad50: 4552 2720 696e 2068 6561 6465 723a 0a20  ER' in header:. 
-0000ad60: 2020 2020 2020 2066 696c 7465 7220 3d20         filter = 
-0000ad70: 6865 6164 6572 5b27 4649 4c54 4552 275d  header['FILTER']
-0000ad80: 0a20 2020 2020 2020 200a 2020 2020 656c  .        .    el
-0000ad90: 7365 3a0a 2020 2020 2020 2020 6d73 6720  se:.        msg 
-0000ada0: 3d20 2746 6169 6c65 6420 746f 2070 6172  = 'Failed to par
-0000adb0: 7365 2046 494c 5445 5220 6b65 7977 6f72  se FILTER keywor
-0000adc0: 6420 666f 7220 494e 5354 5255 4d45 6e74  d for INSTRUMEnt
-0000add0: 207b 307d 270a 2020 2020 2020 2020 7261   {0}'.        ra
-0000ade0: 6973 6520 4b65 7945 7272 6f72 286d 7367  ise KeyError(msg
-0000adf0: 2e66 6f72 6d61 7428 696e 7374 7275 6d65  .format(instrume
-0000ae00: 2929 0a0a 2020 2020 7265 7475 726e 2066  ))..    return f
-0000ae10: 696c 7465 722e 7570 7065 7228 290a 0a0a  ilter.upper()...
-0000ae20: 4545 5f52 4144 4949 203d 205b 302e 312c  EE_RADII = [0.1,
-0000ae30: 2030 2e31 352c 2030 2e32 2c20 302e 3235   0.15, 0.2, 0.25
-0000ae40: 2c20 302e 332c 2030 2e34 2c20 302e 352c  , 0.3, 0.4, 0.5,
-0000ae50: 2030 2e38 2c20 312e 2c20 312e 352c 2032   0.8, 1., 1.5, 2
-0000ae60: 2e5d 0a0a 6465 6620 6765 745f 6669 6c74  .]..def get_filt
-0000ae70: 6572 5f6f 6273 6d6f 6465 2866 696c 7465  er_obsmode(filte
-0000ae80: 723d 2766 3136 3077 272c 2061 6373 5f63  r='f160w', acs_c
-0000ae90: 6869 703d 2777 6663 3127 2c20 7576 6973  hip='wfc1', uvis
-0000aea0: 5f63 6869 703d 2775 7669 7332 272c 2061  _chip='uvis2', a
-0000aeb0: 7065 723d 6e70 2e69 6e66 2c20 6361 7365  per=np.inf, case
-0000aec0: 3d73 7472 2e6c 6f77 6572 293a 0a20 2020  =str.lower):.   
-0000aed0: 2022 2222 0a20 2020 2044 6572 6976 6520   """.    Derive 
-0000aee0: 607e 7079 7379 6e70 686f 7460 206f 6273  `~pysynphot` obs
-0000aef0: 6d6f 6465 206b 6579 776f 7264 2066 726f  mode keyword fro
-0000af00: 6d20 6120 6669 6c74 6572 206e 616d 652c  m a filter name,
-0000af10: 2077 6865 7265 2055 5649 5320 6669 6c74   where UVIS filt
-0000af20: 6572 730a 2020 2020 656e 6420 696e 2027  ers.    end in '
-0000af30: 7527 0a20 2020 2022 2222 0a20 2020 2069  u'.    """.    i
-0000af40: 6620 6669 6c74 6572 2e6c 6f77 6572 2829  f filter.lower()
-0000af50: 5b3a 325d 2069 6e20 5b27 6630 272c 2027  [:2] in ['f0', '
-0000af60: 6631 272c 2027 6731 275d 3a0a 2020 2020  f1', 'g1']:.    
-0000af70: 2020 2020 696e 7374 203d 2027 7766 6333      inst = 'wfc3
-0000af80: 2c69 7227 0a20 2020 2065 6c73 653a 0a20  ,ir'.    else:. 
-0000af90: 2020 2020 2020 2069 6620 6669 6c74 6572         if filter
-0000afa0: 2e6c 6f77 6572 2829 2e65 6e64 7377 6974  .lower().endswit
-0000afb0: 6828 2775 2729 3a0a 2020 2020 2020 2020  h('u'):.        
-0000afc0: 2020 2020 696e 7374 203d 2066 2777 6663      inst = f'wfc
-0000afd0: 332c 7b75 7669 735f 6368 6970 7d27 0a20  3,{uvis_chip}'. 
-0000afe0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000aff0: 2020 2020 2020 2020 2069 6e73 7420 3d20           inst = 
-0000b000: 6627 6163 732c 7b61 6373 5f63 6869 707d  f'acs,{acs_chip}
-0000b010: 270a 2020 2020 2020 2020 0a20 2020 206f  '.        .    o
-0000b020: 6273 6d6f 6465 203d 2069 6e73 7420 2b20  bsmode = inst + 
-0000b030: 272c 2720 2b20 6669 6c74 6572 2e73 7472  ',' + filter.str
-0000b040: 6970 2827 7527 292e 6c6f 7765 7228 290a  ip('u').lower().
-0000b050: 2020 2020 6966 206e 702e 6973 6669 6e69      if np.isfini
-0000b060: 7465 2861 7065 7229 3a0a 2020 2020 2020  te(aper):.      
-0000b070: 2020 6f62 736d 6f64 6520 2b3d 2066 272c    obsmode += f',
-0000b080: 6170 6572 237b 6170 6572 3a34 2e32 667d  aper#{aper:4.2f}
-0000b090: 270a 2020 2020 2020 2020 0a20 2020 2072  '.        .    r
-0000b0a0: 6574 7572 6e20 6361 7365 286f 6273 6d6f  eturn case(obsmo
-0000b0b0: 6465 290a 2020 2020 0a64 6566 2074 6162  de).    .def tab
-0000b0c0: 756c 6174 655f 656e 6369 7263 6c65 645f  ulate_encircled_
-0000b0d0: 656e 6572 6779 2861 7065 725f 7261 6469  energy(aper_radi
-0000b0e0: 693d 4545 5f52 4144 4949 2c20 6e6f 726d  i=EE_RADII, norm
-0000b0f0: 5f72 6164 6975 733d 342e 3029 3a0a 0a20  _radius=4.0):.. 
-0000b100: 2020 2069 6d70 6f72 7420 7079 7379 6e70     import pysynp
-0000b110: 686f 7420 6173 2053 0a0a 2020 2020 6672  hot as S..    fr
-0000b120: 6f6d 202e 7069 7065 6c69 6e65 2069 6d70  om .pipeline imp
-0000b130: 6f72 7420 6465 6661 756c 745f 7061 7261  ort default_para
-0000b140: 6d73 0a0a 2020 2020 2320 4465 6661 756c  ms..    # Defaul
-0000b150: 7420 7370 6563 7472 756d 0a20 2020 2073  t spectrum.    s
-0000b160: 7020 3d20 532e 466c 6174 5370 6563 7472  p = S.FlatSpectr
-0000b170: 756d 2832 352c 2066 6c75 7875 6e69 7473  um(25, fluxunits
-0000b180: 3d27 4142 4d61 6727 290a 0a20 2020 2074  ='ABMag')..    t
-0000b190: 6162 203d 2047 5461 626c 6528 290a 2020  ab = GTable().  
-0000b1a0: 2020 7461 625b 2772 6164 6975 7327 5d20    tab['radius'] 
-0000b1b0: 3d20 6170 6572 5f72 6164 6969 2a75 2e61  = aper_radii*u.a
-0000b1c0: 7263 7365 630a 2020 2020 7461 622e 6d65  rcsec.    tab.me
-0000b1d0: 7461 5b27 524e 4f52 4d27 5d20 3d20 6e6f  ta['RNORM'] = no
-0000b1e0: 726d 5f72 6164 6975 732c 2027 4e6f 726d  rm_radius, 'Norm
-0000b1f0: 616c 697a 6174 696f 6e20 7261 6469 7573  alization radius
-0000b200: 2c20 6172 6373 6563 270a 0a20 2020 2023  , arcsec'..    #
-0000b210: 2049 520a 2020 2020 666f 7220 6620 696e   IR.    for f in
-0000b220: 2064 6566 6175 6c74 5f70 6172 616d 732e   default_params.
-0000b230: 4952 5f4d 5f46 494c 5445 5253 2b64 6566  IR_M_FILTERS+def
-0000b240: 6175 6c74 5f70 6172 616d 732e 4952 5f57  ault_params.IR_W
-0000b250: 5f46 494c 5445 5253 3a0a 2020 2020 2020  _FILTERS:.      
-0000b260: 2020 6f62 736d 6f64 6520 3d20 2777 6663    obsmode = 'wfc
-0000b270: 332c 6972 2c27 2b66 2e6c 6f77 6572 2829  3,ir,'+f.lower()
-0000b280: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-0000b290: 2020 7072 696e 7428 6f62 736d 6f64 6529    print(obsmode)
-0000b2a0: 0a20 2020 2020 2020 2074 6162 5b6f 6273  .        tab[obs
-0000b2b0: 6d6f 6465 5d20 3d20 7379 6e70 686f 745f  mode] = synphot_
-0000b2c0: 656e 6369 7263 6c65 645f 656e 6572 6779  encircled_energy
-0000b2d0: 286f 6273 6d6f 6465 3d6f 6273 6d6f 6465  (obsmode=obsmode
-0000b2e0: 2c20 7370 3d73 702c 2061 7065 725f 7261  , sp=sp, aper_ra
-0000b2f0: 6469 693d 6170 6572 5f72 6164 6969 2c20  dii=aper_radii, 
-0000b300: 6e6f 726d 5f72 6164 6975 733d 6e6f 726d  norm_radius=norm
-0000b310: 5f72 6164 6975 7329 0a20 2020 2020 2020  _radius).       
-0000b320: 2074 6162 2e6d 6574 615b 275a 505f 7b30   tab.meta['ZP_{0
-0000b330: 7d27 2e66 6f72 6d61 7428 6f62 736d 6f64  }'.format(obsmod
-0000b340: 6529 5d20 3d20 7379 6e70 686f 745f 7a65  e)] = synphot_ze
-0000b350: 726f 706f 696e 7428 6f62 736d 6f64 653d  ropoint(obsmode=
-0000b360: 6f62 736d 6f64 652c 2072 6164 6975 733d  obsmode, radius=
-0000b370: 6e6f 726d 5f72 6164 6975 7329 0a0a 2020  norm_radius)..  
-0000b380: 2020 2320 4f70 7469 6361 6c2e 2020 5772    # Optical.  Wr
-0000b390: 6170 2069 6e20 7472 792f 6578 6365 7074  ap in try/except
-0000b3a0: 2074 6f20 6361 7463 6820 6d69 7373 696e   to catch missin
-0000b3b0: 6720 6669 6c74 6572 730a 2020 2020 666f  g filters.    fo
-0000b3c0: 7220 696e 7374 2069 6e20 5b27 6163 732c  r inst in ['acs,
-0000b3d0: 7766 6331 2c27 2c20 2777 6663 332c 7576  wfc1,', 'wfc3,uv
-0000b3e0: 6973 322c 275d 3a0a 2020 2020 2020 2020  is2,']:.        
-0000b3f0: 666f 7220 6620 696e 2028 6465 6661 756c  for f in (defaul
-0000b400: 745f 7061 7261 6d73 2e4f 5054 5f4d 5f46  t_params.OPT_M_F
-0000b410: 494c 5445 5253 202b 200a 2020 2020 2020  ILTERS + .      
-0000b420: 2020 2020 2020 2020 2020 2020 6465 6661              defa
-0000b430: 756c 745f 7061 7261 6d73 2e4f 5054 5f57  ult_params.OPT_W
-0000b440: 5f46 494c 5445 5253 202b 200a 2020 2020  _FILTERS + .    
-0000b450: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0000b460: 6661 756c 745f 7061 7261 6d73 2e55 565f  fault_params.UV_
-0000b470: 4d5f 4649 4c54 4552 5320 2b20 0a20 2020  M_FILTERS + .   
-0000b480: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000b490: 6566 6175 6c74 5f70 6172 616d 732e 5556  efault_params.UV
-0000b4a0: 5f57 5f46 494c 5445 5253 293a 0a0a 2020  _W_FILTERS):..  
-0000b4b0: 2020 2020 2020 2020 2020 6f62 736d 6f64            obsmod
-0000b4c0: 6520 3d20 696e 7374 2b66 2e6c 6f77 6572  e = inst+f.lower
-0000b4d0: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-0000b4e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000b4f0: 2020 2020 2074 6162 5b6f 6273 6d6f 6465       tab[obsmode
-0000b500: 5d20 3d20 7379 6e70 686f 745f 656e 6369  ] = synphot_enci
-0000b510: 7263 6c65 645f 656e 6572 6779 286f 6273  rcled_energy(obs
-0000b520: 6d6f 6465 3d6f 6273 6d6f 6465 2c20 7370  mode=obsmode, sp
-0000b530: 3d73 702c 2061 7065 725f 7261 6469 693d  =sp, aper_radii=
-0000b540: 6170 6572 5f72 6164 6969 2c20 6e6f 726d  aper_radii, norm
-0000b550: 5f72 6164 6975 733d 6e6f 726d 5f72 6164  _radius=norm_rad
-0000b560: 6975 7329 0a20 2020 2020 2020 2020 2020  ius).           
-0000b570: 2020 2020 2070 7269 6e74 286f 6273 6d6f       print(obsmo
-0000b580: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
-0000b590: 2020 2020 7461 622e 6d65 7461 5b27 5a50      tab.meta['ZP
-0000b5a0: 5f7b 307d 272e 666f 726d 6174 286f 6273  _{0}'.format(obs
-0000b5b0: 6d6f 6465 295d 203d 2073 796e 7068 6f74  mode)] = synphot
-0000b5c0: 5f7a 6572 6f70 6f69 6e74 286f 6273 6d6f  _zeropoint(obsmo
-0000b5d0: 6465 3d6f 6273 6d6f 6465 2c20 7261 6469  de=obsmode, radi
-0000b5e0: 7573 3d6e 6f72 6d5f 7261 6469 7573 290a  us=norm_radius).
-0000b5f0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000b600: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0000b610: 2020 2020 2320 4661 696c 6564 2062 6563      # Failed bec
-0000b620: 6175 7365 206f 6273 6d6f 6465 206e 6f74  ause obsmode not
-0000b630: 2061 7661 696c 6162 6c65 2069 6e20 7379   available in sy
-0000b640: 6e70 686f 740a 2020 2020 2020 2020 2020  nphot.          
-0000b650: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0000b660: 2020 2020 7461 622e 6d65 7461 5b27 5053      tab.meta['PS
-0000b670: 594e 5645 5227 5d20 3d20 532e 5f5f 7665  YNVER'] = S.__ve
-0000b680: 7273 696f 6e5f 5f2c 2027 5079 7379 6e70  rsion__, 'Pysynp
-0000b690: 686f 7420 7665 7273 696f 6e27 0a0a 2020  hot version'..  
-0000b6a0: 2020 7461 622e 7772 6974 6528 2768 7374    tab.write('hst
-0000b6b0: 5f65 6e63 6972 636c 6564 5f65 6e65 7267  _encircled_energ
-0000b6c0: 792e 6669 7473 272c 206f 7665 7277 7269  y.fits', overwri
-0000b6d0: 7465 3d54 7275 6529 0a0a 0a64 6566 2073  te=True)...def s
-0000b6e0: 796e 7068 6f74 5f7a 6572 6f70 6f69 6e74  ynphot_zeropoint
-0000b6f0: 286f 6273 6d6f 6465 3d27 7766 6333 2c69  (obsmode='wfc3,i
-0000b700: 722c 6631 3630 7727 2c20 7261 6469 7573  r,f160w', radius
-0000b710: 3d34 2e30 293a 0a20 2020 2022 2222 0a20  =4.0):.    """. 
-0000b720: 2020 2043 6f6d 7075 7465 2073 796e 7068     Compute synph
-0000b730: 6f74 2066 6f72 2061 2073 7065 6369 6669  ot for a specifi
-0000b740: 6320 6170 6572 7475 7265 0a20 2020 2022  c aperture.    "
-0000b750: 2222 0a20 2020 2069 6d70 6f72 7420 7079  "".    import py
-0000b760: 7379 6e70 686f 7420 6173 2053 0a20 2020  synphot as S.   
-0000b770: 2073 7020 3d20 532e 466c 6174 5370 6563   sp = S.FlatSpec
-0000b780: 7472 756d 2832 352c 2066 6c75 7875 6e69  trum(25, fluxuni
-0000b790: 7473 3d27 4142 4d61 6727 290a 2020 2020  ts='ABMag').    
-0000b7a0: 0a20 2020 2069 6620 6e70 2e69 7366 696e  .    if np.isfin
-0000b7b0: 6974 6528 7261 6469 7573 293a 0a20 2020  ite(radius):.   
-0000b7c0: 2020 2020 2062 7020 3d20 532e 4f62 7342       bp = S.ObsB
-0000b7d0: 616e 6470 6173 7328 6f62 736d 6f64 652b  andpass(obsmode+
-0000b7e0: 272c 6170 6572 237b 303a 2e32 667d 272e  ',aper#{0:.2f}'.
-0000b7f0: 666f 726d 6174 2872 6164 6975 7329 290a  format(radius)).
-0000b800: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000b810: 2020 6270 203d 2053 2e4f 6273 4261 6e64    bp = S.ObsBand
-0000b820: 7061 7373 286f 6273 6d6f 6465 290a 0a20  pass(obsmode).. 
-0000b830: 2020 2023 2062 7020 3d20 532e 4f62 7342     # bp = S.ObsB
-0000b840: 616e 6470 6173 7328 6f62 736d 6f64 652b  andpass(obsmode+
-0000b850: 272c 6170 6572 237b 303a 2e32 667d 272e  ',aper#{0:.2f}'.
-0000b860: 666f 726d 6174 2872 6164 6975 7329 290a  format(radius)).
-0000b870: 2020 2020 6f62 7320 3d20 532e 4f62 7365      obs = S.Obse
-0000b880: 7276 6174 696f 6e28 7370 2c20 6270 290a  rvation(sp, bp).
-0000b890: 2020 2020 5a50 203d 2032 3520 2b20 322e      ZP = 25 + 2.
-0000b8a0: 352a 6e70 2e6c 6f67 3130 286f 6273 2e63  5*np.log10(obs.c
-0000b8b0: 6f75 6e74 7261 7465 2829 290a 2020 2020  ountrate()).    
-0000b8c0: 7265 7475 726e 205a 500a 0a0a 6465 6620  return ZP...def 
-0000b8d0: 7379 6e70 686f 745f 656e 6369 7263 6c65  synphot_encircle
-0000b8e0: 645f 656e 6572 6779 286f 6273 6d6f 6465  d_energy(obsmode
-0000b8f0: 3d27 7766 6333 2c69 722c 6631 3630 7727  ='wfc3,ir,f160w'
-0000b900: 2c20 7370 3d27 6465 6661 756c 7427 2c20  , sp='default', 
-0000b910: 6170 6572 5f72 6164 6969 3d45 455f 5241  aper_radii=EE_RA
-0000b920: 4449 492c 206e 6f72 6d5f 7261 6469 7573  DII, norm_radius
-0000b930: 3d34 2e30 293a 0a20 2020 2022 2222 0a20  =4.0):.    """. 
-0000b940: 2020 2043 6f6d 7075 7465 2065 6e63 6972     Compute encir
-0000b950: 636c 6564 2065 6e65 7267 7920 6375 7276  cled energy curv
-0000b960: 6573 2077 6974 6820 7079 7379 6e70 686f  es with pysynpho
-0000b970: 740a 2020 2020 2222 220a 2020 2020 696d  t.    """.    im
-0000b980: 706f 7274 2070 7973 796e 7068 6f74 2061  port pysynphot a
-0000b990: 7320 530a 0a20 2020 2069 6620 7370 203d  s S..    if sp =
-0000b9a0: 3d20 2764 6566 6175 6c74 273a 0a20 2020  = 'default':.   
-0000b9b0: 2020 2020 2073 7020 3d20 532e 466c 6174       sp = S.Flat
-0000b9c0: 5370 6563 7472 756d 2832 352c 2066 6c75  Spectrum(25, flu
-0000b9d0: 7875 6e69 7473 3d27 4142 4d61 6727 290a  xunits='ABMag').
-0000b9e0: 0a20 2020 2023 204e 6f72 6d61 6c69 7a61  .    # Normaliza
-0000b9f0: 7469 6f6e 0a20 2020 2069 6620 6e70 2e69  tion.    if np.i
-0000ba00: 7366 696e 6974 6528 6e6f 726d 5f72 6164  sfinite(norm_rad
-0000ba10: 6975 7329 3a0a 2020 2020 2020 2020 6270  ius):.        bp
-0000ba20: 203d 2053 2e4f 6273 4261 6e64 7061 7373   = S.ObsBandpass
-0000ba30: 286f 6273 6d6f 6465 2b27 2c61 7065 7223  (obsmode+',aper#
-0000ba40: 7b30 3a2e 3266 7d27 2e66 6f72 6d61 7428  {0:.2f}'.format(
-0000ba50: 6e6f 726d 5f72 6164 6975 7329 290a 2020  norm_radius)).  
-0000ba60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000ba70: 6270 203d 2053 2e4f 6273 4261 6e64 7061  bp = S.ObsBandpa
-0000ba80: 7373 286f 6273 6d6f 6465 290a 0a20 2020  ss(obsmode)..   
-0000ba90: 206f 6273 203d 2053 2e4f 6273 6572 7661   obs = S.Observa
-0000baa0: 7469 6f6e 2873 702c 2062 7029 0a20 2020  tion(sp, bp).   
-0000bab0: 206e 6f72 6d5f 636f 756e 7473 203d 206f   norm_counts = o
-0000bac0: 6273 2e63 6f75 6e74 7261 7465 2829 0a0a  bs.countrate()..
-0000bad0: 2020 2020 636f 756e 7473 203d 206e 702e      counts = np.
-0000bae0: 6f6e 6573 5f6c 696b 6528 6170 6572 5f72  ones_like(aper_r
-0000baf0: 6164 6969 290a 2020 2020 666f 7220 692c  adii).    for i,
-0000bb00: 2072 5f61 7065 7220 696e 2065 6e75 6d65   r_aper in enume
-0000bb10: 7261 7465 2861 7065 725f 7261 6469 6929  rate(aper_radii)
-0000bb20: 3a0a 2020 2020 2020 2020 2370 7269 6e74  :.        #print
-0000bb30: 286f 6273 6d6f 6465 2c20 725f 6170 6572  (obsmode, r_aper
-0000bb40: 290a 2020 2020 2020 2020 6270 203d 2053  ).        bp = S
-0000bb50: 2e4f 6273 4261 6e64 7061 7373 286f 6273  .ObsBandpass(obs
-0000bb60: 6d6f 6465 2b27 2c61 7065 7223 7b30 3a2e  mode+',aper#{0:.
-0000bb70: 3266 7d27 2e66 6f72 6d61 7428 725f 6170  2f}'.format(r_ap
-0000bb80: 6572 2929 0a20 2020 2020 2020 206f 6273  er)).        obs
-0000bb90: 203d 2053 2e4f 6273 6572 7661 7469 6f6e   = S.Observation
-0000bba0: 2873 702c 2062 7029 0a20 2020 2020 2020  (sp, bp).       
-0000bbb0: 2063 6f75 6e74 735b 695d 203d 206f 6273   counts[i] = obs
+00007cd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00007ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cf0: 2020 7763 735f 6a20 3d20 7079 7763 732e    wcs_j = pywcs.
+00007d00: 5743 5328 666c 745f 6a5b 2753 4349 272c  WCS(flt_j['SCI',
+00007d10: 2031 5d2c 2066 6f62 6a3d 666c 745f 6a29   1], fobj=flt_j)
+00007d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007d30: 2065 6c69 6620 2868 5b27 494e 5354 5255   elif (h['INSTRU
+00007d40: 4d45 275d 203d 3d20 2757 4650 4332 2729  ME'] == 'WFPC2')
+00007d50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007d60: 2020 2020 2020 5f65 7874 203d 2031 0a20        _ext = 1. 
+00007d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d80: 2020 2077 6373 5f6a 203d 2070 7977 6373     wcs_j = pywcs
+00007d90: 2e57 4353 2866 6c74 5f6a 5b27 5343 4927  .WCS(flt_j['SCI'
+00007da0: 2c20 315d 290a 2020 2020 2020 2020 2020  , 1]).          
+00007db0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00007dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007dd0: 5f65 7874 203d 2031 0a20 2020 2020 2020  _ext = 1.       
+00007de0: 2020 2020 2020 2020 2020 2020 2077 6373               wcs
+00007df0: 5f6a 203d 2070 7977 6373 2e57 4353 2866  _j = pywcs.WCS(f
+00007e00: 6c74 5f6a 5b27 5343 4927 2c20 315d 2c20  lt_j['SCI', 1], 
+00007e10: 666f 626a 3d66 6c74 5f6a 290a 2020 2020  fobj=flt_j).    
+00007e20: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00007e30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00007e40: 2828 7763 735f 6a2e 7069 7865 6c5f 7368  ((wcs_j.pixel_sh
+00007e50: 6170 6520 6973 204e 6f6e 6529 2026 200a  ape is None) & .
+00007e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e70: 2020 2020 2827 4e50 4958 3127 2069 6e20      ('NPIX1' in 
+00007e80: 666c 745f 6a5b 2753 4349 272c 315d 2e68  flt_j['SCI',1].h
+00007e90: 6561 6465 7229 293a 0a20 2020 2020 2020  eader)):.       
+00007ea0: 2020 2020 2020 2020 2020 2020 205f 6820               _h 
+00007eb0: 3d20 666c 745f 6a5b 2753 4349 272c 315d  = flt_j['SCI',1]
+00007ec0: 2e68 6561 6465 720a 2020 2020 2020 2020  .header.        
+00007ed0: 2020 2020 2020 2020 2020 2020 7763 735f              wcs_
+00007ee0: 6a2e 7069 7865 6c5f 7368 6170 6520 3d20  j.pixel_shape = 
+00007ef0: 285f 685b 274e 5049 5831 275d 2c20 5f68  (_h['NPIX1'], _h
+00007f00: 5b27 4e50 4958 3227 5d29 0a20 2020 2020  ['NPIX2']).     
+00007f10: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00007f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f30: 6670 5f6a 203d 2050 6f6c 7967 6f6e 2877  fp_j = Polygon(w
+00007f40: 6373 5f6a 2e63 616c 635f 666f 6f74 7072  cs_j.calc_footpr
+00007f50: 696e 7428 2929 0a20 2020 2020 2020 2020  int()).         
+00007f60: 2020 2020 2020 2069 6620 6a20 3d3d 2030         if j == 0
+00007f70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007f80: 2020 2020 2020 6670 5f69 203d 2066 705f        fp_i = fp_
+00007f90: 6a2e 6275 6666 6572 2831 2e2f 3336 3030  j.buffer(1./3600
+00007fa0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00007fb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00007fc0: 2020 2020 2020 2020 2020 2020 6670 5f69              fp_i
+00007fd0: 203d 2066 705f 692e 756e 696f 6e28 6670   = fp_i.union(fp
+00007fe0: 5f6a 2e62 7566 6665 7228 312e 2f33 3630  _j.buffer(1./360
+00007ff0: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
+00008000: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00008010: 2020 2020 2066 6c74 5f6a 2e63 6c6f 7365       flt_j.close
+00008020: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00008030: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00008040: 6f75 7470 7574 5f6c 6973 745b 695d 5b27  output_list[i]['
+00008050: 666f 6f74 7072 696e 7427 5d20 3d20 6670  footprint'] = fp
+00008060: 5f69 0a0a 2020 2020 7265 7475 726e 206f  _i..    return o
+00008070: 7574 7075 745f 6c69 7374 2c20 6669 6c74  utput_list, filt
+00008080: 6572 5f6c 6973 740a 0a0a 6465 6620 7370  er_list...def sp
+00008090: 6c69 745f 7669 7369 7428 7669 7369 742c  lit_visit(visit,
+000080a0: 2076 6973 6974 5f73 706c 6974 5f73 6869   visit_split_shi
+000080b0: 6674 3d31 2e35 2c20 6d61 785f 6474 3d36  ft=1.5, max_dt=6
+000080c0: 2e2f 3234 2c20 7061 7468 3d27 2e2e 2f52  ./24, path='../R
+000080d0: 4157 2729 3a0a 2020 2020 2222 220a 2020  AW'):.    """.  
+000080e0: 2020 4368 6563 6b20 6966 2066 696c 6573    Check if files
+000080f0: 2069 6e20 6120 7669 7369 7420 6861 7665   in a visit have
+00008100: 206c 6172 6765 2073 6869 6674 7320 616e   large shifts an
+00008110: 6420 7370 6c69 7420 7468 656d 206f 7468  d split them oth
+00008120: 6572 7769 7365 0a0a 2020 2020 7669 7369  erwise..    visi
+00008130: 7420 3a20 7669 7369 7420 6469 6374 696f  t : visit dictio
+00008140: 6e61 7279 0a0a 2020 2020 7669 7369 745f  nary..    visit_
+00008150: 7370 6c69 745f 7368 6966 7420 3a20 7370  split_shift : sp
+00008160: 6c69 7420 6966 2073 6869 6674 7320 6c61  lit if shifts la
+00008170: 7267 6572 2074 6861 6e20 6076 6973 6974  rger than `visit
+00008180: 5f73 706c 6974 5f73 6869 6674 6020 6172  _split_shift` ar
+00008190: 636d 696e 0a20 2020 2022 2222 0a20 2020  cmin.    """.   
+000081a0: 200a 2020 2020 696d 7320 3d20 5b5d 0a20   .    ims = []. 
+000081b0: 2020 2066 6f72 2066 696c 6520 696e 2076     for file in v
+000081c0: 6973 6974 5b27 6669 6c65 7327 5d3a 0a20  isit['files']:. 
+000081d0: 2020 2020 2020 2066 6f72 2067 7a65 7874         for gzext
+000081e0: 2069 6e20 5b27 272c 2027 2e67 7a27 5d3a   in ['', '.gz']:
+000081f0: 0a20 2020 2020 2020 2020 2020 205f 6669  .            _fi
+00008200: 6c65 203d 206f 732e 7061 7468 2e6a 6f69  le = os.path.joi
+00008210: 6e28 7061 7468 2c20 6669 6c65 2920 2b20  n(path, file) + 
+00008220: 677a 6578 740a 2020 2020 2020 2020 2020  gzext.          
+00008230: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
+00008240: 7374 7328 5f66 696c 6529 3a0a 2020 2020  sts(_file):.    
+00008250: 2020 2020 2020 2020 2020 2020 696d 732e              ims.
+00008260: 6170 7065 6e64 2870 7966 6974 732e 6f70  append(pyfits.op
+00008270: 656e 285f 6669 6c65 2929 0a20 2020 2020  en(_file)).     
+00008280: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00008290: 0a20 2020 200a 2020 2020 2369 6d73 203d  .    .    #ims =
+000082a0: 205b 7079 6669 7473 2e6f 7065 6e28 6f73   [pyfits.open(os
+000082b0: 2e70 6174 682e 6a6f 696e 2870 6174 682c  .path.join(path,
+000082c0: 2066 696c 6529 2920 666f 7220 6669 6c65   file)) for file
+000082d0: 2069 6e20 7669 7369 745b 2766 696c 6573   in visit['files
+000082e0: 275d 5d0a 2020 2020 6372 7661 6c31 203d  ']].    crval1 =
+000082f0: 206e 702e 6172 7261 7928 5b69 6d5b 315d   np.array([im[1]
+00008300: 2e68 6561 6465 725b 2743 5256 414c 3127  .header['CRVAL1'
+00008310: 5d20 666f 7220 696d 2069 6e20 696d 735d  ] for im in ims]
+00008320: 290a 2020 2020 6372 7661 6c32 203d 206e  ).    crval2 = n
+00008330: 702e 6172 7261 7928 5b69 6d5b 315d 2e68  p.array([im[1].h
+00008340: 6561 6465 725b 2743 5256 414c 3227 5d20  eader['CRVAL2'] 
+00008350: 666f 7220 696d 2069 6e20 696d 735d 290a  for im in ims]).
+00008360: 2020 2020 6578 7073 7461 7274 203d 206e      expstart = n
+00008370: 702e 6172 7261 7928 5b69 6d5b 305d 2e68  p.array([im[0].h
+00008380: 6561 6465 725b 2745 5850 5354 4152 5427  eader['EXPSTART'
+00008390: 5d20 666f 7220 696d 2069 6e20 696d 735d  ] for im in ims]
+000083a0: 290a 2020 2020 6474 203d 206e 702e 6361  ).    dt = np.ca
+000083b0: 7374 5b69 6e74 5d28 2865 7870 7374 6172  st[int]((expstar
+000083c0: 742d 6578 7073 7461 7274 5b30 5d29 2f6d  t-expstart[0])/m
+000083d0: 6178 5f64 7429 0a20 2020 200a 2020 2020  ax_dt).    .    
+000083e0: 666f 7220 696d 2069 6e20 696d 733a 0a20  for im in ims:. 
+000083f0: 2020 2020 2020 2069 6d2e 636c 6f73 6528         im.close(
+00008400: 290a 2020 2020 2020 2020 0a20 2020 2064  ).        .    d
+00008410: 7820 3d20 2863 7276 616c 3120 2d20 6372  x = (crval1 - cr
+00008420: 7661 6c31 5b30 5d29 2a36 302a 6e70 2e63  val1[0])*60*np.c
+00008430: 6f73 2863 7276 616c 325b 305d 2f31 3830  os(crval2[0]/180
+00008440: 2a6e 702e 7069 290a 2020 2020 6479 203d  *np.pi).    dy =
+00008450: 2028 6372 7661 6c32 202d 2063 7276 616c   (crval2 - crval
+00008460: 325b 305d 292a 3630 0a0a 2020 2020 6478  2[0])*60..    dx
+00008470: 6920 3d20 6e70 2e63 6173 745b 696e 745d  i = np.cast[int]
+00008480: 286e 702e 726f 756e 6428 6478 2f76 6973  (np.round(dx/vis
+00008490: 6974 5f73 706c 6974 5f73 6869 6674 2929  it_split_shift))
+000084a0: 0a20 2020 2064 7969 203d 206e 702e 6361  .    dyi = np.ca
+000084b0: 7374 5b69 6e74 5d28 6e70 2e72 6f75 6e64  st[int](np.round
+000084c0: 2864 792f 7669 7369 745f 7370 6c69 745f  (dy/visit_split_
+000084d0: 7368 6966 7429 290a 2020 2020 6b65 7973  shift)).    keys
+000084e0: 203d 2064 7869 2a31 3030 2b64 7969 2b31   = dxi*100+dyi+1
+000084f0: 3030 302a 6474 0a0a 2020 2020 756e 203d  000*dt..    un =
+00008500: 206e 702e 756e 6971 7565 286b 6579 7329   np.unique(keys)
+00008510: 0a20 2020 2069 6620 6c65 6e28 756e 2920  .    if len(un) 
+00008520: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
+00008530: 7475 726e 205b 7669 7369 745d 0a20 2020  turn [visit].   
+00008540: 2065 6c73 653a 0a20 2020 2020 2020 2073   else:.        s
+00008550: 706c 203d 2076 6973 6974 5b27 7072 6f64  pl = visit['prod
+00008560: 7563 7427 5d2e 7370 6c69 7428 272d 2729  uct'].split('-')
+00008570: 0a20 2020 2020 2020 2069 734a 5753 5420  .        isJWST 
+00008580: 3d20 7370 6c5b 2d31 5d2e 6c6f 7765 7228  = spl[-1].lower(
+00008590: 292e 7374 6172 7473 7769 7468 2827 636c  ).startswith('cl
+000085a0: 6561 7227 290a 2020 2020 2020 2020 6973  ear').        is
+000085b0: 4a57 5354 207c 3d20 7370 6c5b 2d31 5d2e  JWST |= spl[-1].
+000085c0: 6c6f 7765 7228 2920 696e 205b 2767 7231  lower() in ['gr1
+000085d0: 3530 7227 2c27 6772 3135 3063 272c 2767  50r','gr150c','g
+000085e0: 7269 736d 7227 2c27 6772 6973 6d63 275d  rismr','grismc']
+000085f0: 0a20 2020 2020 2020 2069 6620 6973 4a57  .        if isJW
+00008600: 5354 3a0a 2020 2020 2020 2020 2020 2020  ST:.            
+00008610: 7370 6c2e 696e 7365 7274 282d 322c 2027  spl.insert(-2, '
+00008620: 2729 0a20 2020 2020 2020 2065 6c73 653a  ').        else:
+00008630: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
+00008640: 2e69 6e73 6572 7428 2d31 2c20 2727 290a  .insert(-1, '').
+00008650: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00008660: 2020 2020 2076 6973 6974 7320 3d20 5b5d       visits = []
+00008670: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+00008680: 6e20 7261 6e67 6528 6c65 6e28 756e 2929  n range(len(un))
+00008690: 3a0a 2020 2020 2020 2020 2020 2020 6978  :.            ix
+000086a0: 203d 206b 6579 7320 3d3d 2075 6e5b 695d   = keys == un[i]
+000086b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000086c0: 6973 4a57 5354 3a0a 2020 2020 2020 2020  isJWST:.        
+000086d0: 2020 2020 2020 2020 7370 6c5b 2d33 5d20          spl[-3] 
+000086e0: 3d20 2761 6263 6465 6667 6869 6a6b 6c6d  = 'abcdefghijklm
+000086f0: 6e6f 7071 7273 7576 7778 797a 275b 695d  nopqrsuvwxyz'[i]
+00008700: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00008710: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00008720: 2020 2073 706c 5b2d 325d 203d 2027 6162     spl[-2] = 'ab
+00008730: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+00008740: 7375 7677 7879 7a27 5b69 5d0a 2020 2020  suvwxyz'[i].    
+00008750: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00008760: 2020 2020 2020 2020 206e 6577 5f76 6973           new_vis
+00008770: 6974 203d 207b 2766 696c 6573 273a 206c  it = {'files': l
+00008780: 6973 7428 6e70 2e61 7272 6179 2876 6973  ist(np.array(vis
+00008790: 6974 5b27 6669 6c65 7327 5d29 5b69 785d  it['files'])[ix]
+000087a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000087b0: 2020 2020 2020 2020 2020 2020 2770 726f              'pro
+000087c0: 6475 6374 273a 2027 2d27 2e6a 6f69 6e28  duct': '-'.join(
+000087d0: 7370 6c29 7d0a 0a20 2020 2020 2020 2020  spl)}..         
+000087e0: 2020 2069 6620 2766 6f6f 7470 7269 6e74     if 'footprint
+000087f0: 7327 2069 6e20 7669 7369 743a 0a20 2020  s' in visit:.   
+00008800: 2020 2020 2020 2020 2020 2020 206e 6577               new
+00008810: 5f76 6973 6974 5b27 666f 6f74 7072 696e  _visit['footprin
+00008820: 7473 275d 203d 206c 6973 7428 6e70 2e61  ts'] = list(np.a
+00008830: 7272 6179 2876 6973 6974 5b27 666f 6f74  rray(visit['foot
+00008840: 7072 696e 7473 275d 295b 6978 5d29 0a0a  prints'])[ix])..
+00008850: 2020 2020 2020 2020 2020 2020 7669 7369              visi
+00008860: 7473 2e61 7070 656e 6428 6e65 775f 7669  ts.append(new_vi
+00008870: 7369 7429 0a0a 2020 2020 7265 7475 726e  sit)..    return
+00008880: 2076 6973 6974 730a 0a0a 6465 6620 6765   visits...def ge
+00008890: 745f 7669 7369 745f 666f 6f74 7072 696e  t_visit_footprin
+000088a0: 7473 2876 6973 6974 7329 3a0a 2020 2020  ts(visits):.    
+000088b0: 2222 220a 2020 2020 4164 6420 607e 7368  """.    Add `~sh
+000088c0: 6170 656c 792e 6765 6f6d 6574 7279 2e50  apely.geometry.P
+000088d0: 6f6c 7967 6f6e 6020 2766 6f6f 7470 7269  olygon` 'footpri
+000088e0: 6e74 2720 6174 7472 6962 7574 6573 2074  nt' attributes t
+000088f0: 6f20 7669 7369 7420 6469 6374 2e0a 0a20  o visit dict... 
+00008900: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00008910: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00008920: 2076 6973 6974 7320 3a20 6c69 7374 0a20   visits : list. 
+00008930: 2020 2020 2020 204c 6973 7420 6f66 2076         List of v
+00008940: 6973 6974 2064 6963 7469 6f6e 6172 6965  isit dictionarie
+00008950: 732e 0a0a 2020 2020 2222 220a 0a20 2020  s...    """..   
+00008960: 2069 6d70 6f72 7420 6f73 0a0a 2020 2020   import os..    
+00008970: 696d 706f 7274 2061 7374 726f 7079 2e69  import astropy.i
+00008980: 6f2e 6669 7473 2061 7320 7079 6669 7473  o.fits as pyfits
+00008990: 0a20 2020 2069 6d70 6f72 7420 6173 7472  .    import astr
+000089a0: 6f70 792e 7763 7320 6173 2070 7977 6373  opy.wcs as pywcs
+000089b0: 0a0a 2020 2020 6672 6f6d 2073 6861 7065  ..    from shape
+000089c0: 6c79 2e67 656f 6d65 7472 7920 696d 706f  ly.geometry impo
+000089d0: 7274 2050 6f6c 7967 6f6e 0a0a 2020 2020  rt Polygon..    
+000089e0: 4e20 3d20 6c65 6e28 7669 7369 7473 290a  N = len(visits).
+000089f0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+00008a00: 6765 284e 293a 0a20 2020 2020 2020 2066  ge(N):.        f
+00008a10: 6f72 206a 2069 6e20 7261 6e67 6528 6c65  or j in range(le
+00008a20: 6e28 7669 7369 7473 5b69 5d5b 2766 696c  n(visits[i]['fil
+00008a30: 6573 275d 2929 3a0a 2020 2020 2020 2020  es'])):.        
+00008a40: 2020 2020 666c 745f 6669 6c65 203d 2076      flt_file = v
+00008a50: 6973 6974 735b 695d 5b27 6669 6c65 7327  isits[i]['files'
+00008a60: 5d5b 6a5d 0a20 2020 2020 2020 2020 2020  ][j].           
+00008a70: 2069 6620 286e 6f74 206f 732e 7061 7468   if (not os.path
+00008a80: 2e65 7869 7374 7328 666c 745f 6669 6c65  .exists(flt_file
+00008a90: 2929 2026 206f 732e 7061 7468 2e65 7869  )) & os.path.exi
+00008aa0: 7374 7328 272e 2e2f 5241 572f 272b 666c  sts('../RAW/'+fl
+00008ab0: 745f 6669 6c65 293a 0a20 2020 2020 2020  t_file):.       
+00008ac0: 2020 2020 2020 2020 2066 6c74 5f66 696c           flt_fil
+00008ad0: 6520 3d20 272e 2e2f 5241 572f 272b 666c  e = '../RAW/'+fl
+00008ae0: 745f 6669 6c65 0a0a 2020 2020 2020 2020  t_file..        
+00008af0: 2020 2020 666c 745f 6a20 3d20 7079 6669      flt_j = pyfi
+00008b00: 7473 2e6f 7065 6e28 666c 745f 6669 6c65  ts.open(flt_file
+00008b10: 290a 2020 2020 2020 2020 2020 2020 6820  ).            h 
+00008b20: 3d20 666c 745f 6a5b 305d 2e68 6561 6465  = flt_j[0].heade
+00008b30: 720a 2020 2020 2020 2020 2020 2020 6966  r.            if
+00008b40: 2028 685b 2749 4e53 5452 554d 4527 5d20   (h['INSTRUME'] 
+00008b50: 3d3d 2027 5746 4333 2729 2026 2028 685b  == 'WFC3') & (h[
+00008b60: 2744 4554 4543 544f 5227 5d20 3d3d 2027  'DETECTOR'] == '
+00008b70: 4952 2729 3a0a 2020 2020 2020 2020 2020  IR'):.          
+00008b80: 2020 2020 2020 7763 735f 6a20 3d20 7079        wcs_j = py
+00008b90: 7763 732e 5743 5328 666c 745f 6a5b 2753  wcs.WCS(flt_j['S
+00008ba0: 4349 272c 2031 5d29 0a20 2020 2020 2020  CI', 1]).       
+00008bb0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00008bc0: 2020 2020 2020 2020 2020 2077 6373 5f6a             wcs_j
+00008bd0: 203d 2070 7977 6373 2e57 4353 2866 6c74   = pywcs.WCS(flt
+00008be0: 5f6a 5b27 5343 4927 2c20 315d 2c20 666f  _j['SCI', 1], fo
+00008bf0: 626a 3d66 6c74 5f6a 290a 0a20 2020 2020  bj=flt_j)..     
+00008c00: 2020 2020 2020 2066 705f 6a20 3d20 506f         fp_j = Po
+00008c10: 6c79 676f 6e28 7763 735f 6a2e 6361 6c63  lygon(wcs_j.calc
+00008c20: 5f66 6f6f 7470 7269 6e74 2829 290a 2020  _footprint()).  
+00008c30: 2020 2020 2020 2020 2020 6966 206a 203d            if j =
+00008c40: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00008c50: 2020 2020 2066 705f 6920 3d20 6670 5f6a       fp_i = fp_j
+00008c60: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00008c70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00008c80: 2020 2066 705f 6920 3d20 6670 5f69 2e75     fp_i = fp_i.u
+00008c90: 6e69 6f6e 2866 705f 6a29 0a20 2020 2020  nion(fp_j).     
+00008ca0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00008cb0: 2020 2020 666c 745f 6a2e 636c 6f73 6528      flt_j.close(
+00008cc0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
+00008cd0: 2020 2020 2020 2076 6973 6974 735b 695d         visits[i]
+00008ce0: 5b27 666f 6f74 7072 696e 7427 5d20 3d20  ['footprint'] = 
+00008cf0: 6670 5f69 0a0a 2020 2020 7265 7475 726e  fp_i..    return
+00008d00: 2076 6973 6974 730a 0a0a 6465 6620 7061   visits...def pa
+00008d10: 7273 655f 7669 7369 745f 6f76 6572 6c61  rse_visit_overla
+00008d20: 7073 2876 6973 6974 732c 2062 7566 6665  ps(visits, buffe
+00008d30: 723d 3135 2e29 3a0a 2020 2020 2222 2246  r=15.):.    """F
+00008d40: 696e 6420 6f76 6572 6c61 7070 696e 6720  ind overlapping 
+00008d50: 7669 7369 7473 2f66 696c 7465 7273 2074  visits/filters t
+00008d60: 6f20 6d61 6b65 2063 6f6d 6269 6e65 6420  o make combined 
+00008d70: 6d6f 7361 6963 730a 0a20 2020 2050 6172  mosaics..    Par
+00008d80: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00008d90: 2d2d 2d2d 2d2d 0a20 2020 2076 6973 6974  ------.    visit
+00008da0: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
+00008db0: 204f 7574 7075 7420 6c69 7374 206f 6620   Output list of 
+00008dc0: 7669 7369 7420 696e 666f 726d 6174 696f  visit informatio
+00008dd0: 6e20 6672 6f6d 2060 7e67 7269 7a6c 692e  n from `~grizli.
+00008de0: 7574 696c 732e 7061 7273 655f 666c 745f  utils.parse_flt_
+00008df0: 6669 6c65 7360 2e0a 2020 2020 2020 2020  files`..        
+00008e00: 5468 6520 7363 7269 7074 206c 6f6f 6b73  The script looks
+00008e10: 2066 6f72 2066 696c 6573 206c 696b 6520   for files like 
+00008e20: 6076 6973 6974 735b 695d 5b27 7072 6f64  `visits[i]['prod
+00008e30: 7563 7427 5d2b 275f 6472 3f5f 7363 692e  uct']+'_dr?_sci.
+00008e40: 6669 7473 2760 0a20 2020 2020 2020 2074  fits'`.        t
+00008e50: 6f20 636f 6d70 7574 6520 7468 6520 5743  o compute the WC
+00008e60: 5320 666f 6f74 7072 696e 7420 6f66 2061  S footprint of a
+00008e70: 2076 6973 6974 2e20 2054 6865 7365 2061   visit.  These a
+00008e80: 7265 2070 726f 6475 6365 642c 2065 2e67  re produced, e.g
+00008e90: 2e2c 2062 790a 2020 2020 2020 2020 607e  ., by.        `~
+00008ea0: 6772 697a 6c69 2e70 7265 702e 7072 6f63  grizli.prep.proc
+00008eb0: 6573 735f 6469 7265 6374 5f67 7269 736d  ess_direct_grism
+00008ec0: 5f76 6973 6974 602e 0a0a 2020 2020 6275  _visit`...    bu
+00008ed0: 6666 6572 203a 2066 6c6f 6174 0a20 2020  ffer : float.   
+00008ee0: 2020 2020 2042 7566 6665 722c 2069 6e20       Buffer, in 
+00008ef0: 607e 6173 7472 6f70 792e 756e 6974 732e  `~astropy.units.
+00008f00: 6172 6373 6563 602c 2074 6f20 6164 6420  arcsec`, to add 
+00008f10: 6172 6f75 6e64 2076 6973 6974 2066 6f6f  around visit foo
+00008f20: 7470 7269 6e74 7320 746f 0a20 2020 2020  tprints to.     
+00008f30: 2020 206c 6f6f 6b20 666f 7220 6f76 6572     look for over
+00008f40: 6c61 7073 2e0a 0a20 2020 2052 6574 7572  laps...    Retur
+00008f50: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00008f60: 2020 2065 7870 6f73 7572 655f 6772 6f75     exposure_grou
+00008f70: 7073 203a 206c 6973 740a 2020 2020 2020  ps : list.      
+00008f80: 2020 4c69 7374 206f 6620 6f76 6572 6c61    List of overla
+00008f90: 7070 696e 6720 7669 7369 7473 2c20 7769  pping visits, wi
+00008fa0: 7468 2073 696d 696c 6172 2066 6f72 6d61  th similar forma
+00008fb0: 7420 6173 2069 6e70 7574 2060 7669 7369  t as input `visi
+00008fc0: 7473 602e 0a0a 2020 2020 2222 220a 2020  ts`...    """.  
+00008fd0: 2020 696d 706f 7274 2063 6f70 790a 2020    import copy.  
+00008fe0: 2020 6672 6f6d 2073 6861 7065 6c79 2e67    from shapely.g
+00008ff0: 656f 6d65 7472 7920 696d 706f 7274 2050  eometry import P
+00009000: 6f6c 7967 6f6e 0a0a 2020 2020 4e20 3d20  olygon..    N = 
+00009010: 6c65 6e28 7669 7369 7473 290a 0a20 2020  len(visits)..   
+00009020: 2065 7870 6f73 7572 655f 6772 6f75 7073   exposure_groups
+00009030: 203d 205b 5d0a 2020 2020 7573 6564 203d   = [].    used =
+00009040: 206e 702e 6172 616e 6765 286c 656e 2876   np.arange(len(v
+00009050: 6973 6974 7329 2920 3c20 300a 0a20 2020  isits)) < 0..   
+00009060: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00009070: 4e29 3a0a 2020 2020 2020 2020 665f 6920  N):.        f_i 
+00009080: 3d20 7669 7369 7473 5b69 5d5b 2770 726f  = visits[i]['pro
+00009090: 6475 6374 275d 2e73 706c 6974 2827 2d27  duct'].split('-'
+000090a0: 295b 2d31 5d0a 2020 2020 2020 2020 6966  )[-1].        if
+000090b0: 2075 7365 645b 695d 3a0a 2020 2020 2020   used[i]:.      
+000090c0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
+000090d0: 2020 2020 2020 2020 6966 2027 666f 6f74          if 'foot
+000090e0: 7072 696e 7427 2069 6e20 7669 7369 7473  print' in visits
+000090f0: 5b69 5d3a 0a20 2020 2020 2020 2020 2020  [i]:.           
+00009100: 2066 705f 6920 3d20 7669 7369 7473 5b69   fp_i = visits[i
+00009110: 5d5b 2766 6f6f 7470 7269 6e74 275d 2e62  ]['footprint'].b
+00009120: 7566 6665 7228 6275 6666 6572 2f33 3630  uffer(buffer/360
+00009130: 302e 290a 2020 2020 2020 2020 656c 7365  0.).        else
+00009140: 3a0a 2020 2020 2020 2020 2020 2020 5f70  :.            _p
+00009150: 726f 6475 6374 7320 3d20 7669 7369 7473  roducts = visits
+00009160: 5b69 5d5b 2770 726f 6475 6374 275d 2b27  [i]['product']+'
+00009170: 5f64 723f 5f73 6369 2e66 6974 7327 0a20  _dr?_sci.fits'. 
+00009180: 2020 2020 2020 2020 2020 2069 6d5f 6920             im_i 
+00009190: 3d20 7079 6669 7473 2e6f 7065 6e28 676c  = pyfits.open(gl
+000091a0: 6f62 2e67 6c6f 6228 5f70 726f 6475 6374  ob.glob(_product
+000091b0: 7329 5b30 5d29 0a20 2020 2020 2020 2020  s)[0]).         
+000091c0: 2020 2077 6373 5f69 203d 2070 7977 6373     wcs_i = pywcs
+000091d0: 2e57 4353 2869 6d5f 695b 305d 290a 2020  .WCS(im_i[0]).  
+000091e0: 2020 2020 2020 2020 2020 6670 5f69 203d            fp_i =
+000091f0: 2050 6f6c 7967 6f6e 2877 6373 5f69 2e63   Polygon(wcs_i.c
+00009200: 616c 635f 666f 6f74 7072 696e 7428 2929  alc_footprint())
+00009210: 2e62 7566 6665 7228 6275 6666 6572 2f33  .buffer(buffer/3
+00009220: 3630 302e 290a 2020 2020 2020 2020 2020  600.).          
+00009230: 2020 696d 5f69 2e63 6c6f 7365 2829 0a20    im_i.close(). 
+00009240: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00009250: 2020 2020 6578 706f 7375 7265 5f67 726f      exposure_gro
+00009260: 7570 732e 6170 7065 6e64 2863 6f70 792e  ups.append(copy.
+00009270: 6465 6570 636f 7079 2876 6973 6974 735b  deepcopy(visits[
+00009280: 695d 2929 0a0a 2020 2020 2020 2020 666f  i]))..        fo
+00009290: 7220 6a20 696e 2072 616e 6765 2869 2b31  r j in range(i+1
+000092a0: 2c20 4e29 3a0a 2020 2020 2020 2020 2020  , N):.          
+000092b0: 2020 665f 6a20 3d20 7669 7369 7473 5b6a    f_j = visits[j
+000092c0: 5d5b 2770 726f 6475 6374 275d 2e73 706c  ]['product'].spl
+000092d0: 6974 2827 2d27 295b 2d31 5d0a 2020 2020  it('-')[-1].    
+000092e0: 2020 2020 2020 2020 6966 2028 665f 6a20          if (f_j 
+000092f0: 213d 2066 5f69 2920 7c20 2875 7365 645b  != f_i) | (used[
+00009300: 6a5d 293a 0a20 2020 2020 2020 2020 2020  j]):.           
+00009310: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+00009320: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+00009330: 2020 2020 2020 2020 2069 6620 2766 6f6f           if 'foo
+00009340: 7470 7269 6e74 2720 696e 2076 6973 6974  tprint' in visit
+00009350: 735b 6a5d 3a0a 2020 2020 2020 2020 2020  s[j]:.          
+00009360: 2020 2020 2020 6670 5f6a 203d 2076 6973        fp_j = vis
+00009370: 6974 735b 6a5d 5b27 666f 6f74 7072 696e  its[j]['footprin
+00009380: 7427 5d2e 6275 6666 6572 2862 7566 6665  t'].buffer(buffe
+00009390: 722f 3336 3030 2e29 0a20 2020 2020 2020  r/3600.).       
+000093a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000093b0: 2020 2020 2020 2020 2020 205f 7072 6f64             _prod
+000093c0: 7563 7473 203d 2076 6973 6974 735b 6a5d  ucts = visits[j]
+000093d0: 5b27 7072 6f64 7563 7427 5d2b 275f 6472  ['product']+'_dr
+000093e0: 3f5f 7363 692e 6669 7473 270a 2020 2020  ?_sci.fits'.    
+000093f0: 2020 2020 2020 2020 2020 2020 696d 5f6a              im_j
+00009400: 203d 2070 7966 6974 732e 6f70 656e 2867   = pyfits.open(g
+00009410: 6c6f 622e 676c 6f62 285f 7072 6f64 7563  lob.glob(_produc
+00009420: 7473 295b 305d 290a 2020 2020 2020 2020  ts)[0]).        
+00009430: 2020 2020 2020 2020 7763 735f 6a20 3d20          wcs_j = 
+00009440: 7079 7763 732e 5743 5328 696d 5f6a 5b30  pywcs.WCS(im_j[0
+00009450: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00009460: 2020 2066 705f 6a20 3d20 506f 6c79 676f     fp_j = Polygo
+00009470: 6e28 7763 735f 6a2e 6361 6c63 5f66 6f6f  n(wcs_j.calc_foo
+00009480: 7470 7269 6e74 2829 292e 6275 6666 6572  tprint()).buffer
+00009490: 2862 7566 6665 722f 3336 3030 2e29 0a20  (buffer/3600.). 
+000094a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000094b0: 6d5f 6a2e 636c 6f73 6528 290a 2020 2020  m_j.close().    
+000094c0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000094d0: 2020 2020 206f 6c61 7020 3d20 6670 5f69       olap = fp_i
+000094e0: 2e69 6e74 6572 7365 6374 696f 6e28 6670  .intersection(fp
+000094f0: 5f6a 290a 2020 2020 2020 2020 2020 2020  _j).            
+00009500: 6966 206f 6c61 702e 6172 6561 203e 2030  if olap.area > 0
+00009510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009520: 2020 7573 6564 5b6a 5d20 3d20 5472 7565    used[j] = True
+00009530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009540: 2066 705f 6920 3d20 6670 5f69 2e75 6e69   fp_i = fp_i.uni
+00009550: 6f6e 2866 705f 6a29 0a20 2020 2020 2020  on(fp_j).       
+00009560: 2020 2020 2020 2020 2065 7870 6f73 7572           exposur
+00009570: 655f 6772 6f75 7073 5b2d 315d 5b27 666f  e_groups[-1]['fo
+00009580: 6f74 7072 696e 7427 5d20 3d20 6670 5f69  otprint'] = fp_i
+00009590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000095a0: 2065 7870 6f73 7572 655f 6772 6f75 7073   exposure_groups
+000095b0: 5b2d 315d 5b27 6669 6c65 7327 5d2e 6578  [-1]['files'].ex
+000095c0: 7465 6e64 2876 6973 6974 735b 6a5d 5b27  tend(visits[j]['
+000095d0: 6669 6c65 7327 5d29 0a0a 2020 2020 666f  files'])..    fo
+000095e0: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+000095f0: 2865 7870 6f73 7572 655f 6772 6f75 7073  (exposure_groups
+00009600: 2929 3a0a 2020 2020 2020 2020 666c 745f  )):.        flt_
+00009610: 6920 3d20 7079 6669 7473 2e6f 7065 6e28  i = pyfits.open(
+00009620: 6578 706f 7375 7265 5f67 726f 7570 735b  exposure_groups[
+00009630: 695d 5b27 6669 6c65 7327 5d5b 305d 290a  i]['files'][0]).
+00009640: 2020 2020 2020 2020 7072 6f64 7563 7420          product 
+00009650: 3d20 666c 745f 695b 305d 2e68 6561 6465  = flt_i[0].heade
+00009660: 725b 2754 4152 474e 414d 4527 5d2e 6c6f  r['TARGNAME'].lo
+00009670: 7765 7228 290a 2020 2020 2020 2020 6966  wer().        if
+00009680: 2070 726f 6475 6374 203d 3d20 2761 6e79   product == 'any
+00009690: 273a 0a20 2020 2020 2020 2020 2020 2070  ':.            p
+000096a0: 726f 6475 6374 203d 2027 7061 722d 272b  roduct = 'par-'+
+000096b0: 7261 6465 635f 746f 5f74 6172 676e 616d  radec_to_targnam
+000096c0: 6528 6865 6164 6572 3d66 6c74 5f69 5b27  e(header=flt_i['
+000096d0: 5343 4927 2c20 315d 2e68 6561 6465 7229  SCI', 1].header)
+000096e0: 0a0a 2020 2020 2020 2020 665f 6920 3d20  ..        f_i = 
+000096f0: 6578 706f 7375 7265 5f67 726f 7570 735b  exposure_groups[
+00009700: 695d 5b27 7072 6f64 7563 7427 5d2e 7370  i]['product'].sp
+00009710: 6c69 7428 272d 2729 5b2d 315d 0a20 2020  lit('-')[-1].   
+00009720: 2020 2020 2070 726f 6475 6374 202b 3d20       product += 
+00009730: 272d 272b 665f 690a 2020 2020 2020 2020  '-'+f_i.        
+00009740: 6578 706f 7375 7265 5f67 726f 7570 735b  exposure_groups[
+00009750: 695d 5b27 7072 6f64 7563 7427 5d20 3d20  i]['product'] = 
+00009760: 7072 6f64 7563 740a 2020 2020 2020 2020  product.        
+00009770: 666c 745f 692e 636c 6f73 6528 290a 2020  flt_i.close().  
+00009780: 2020 2020 2020 0a20 2020 2072 6574 7572        .    retur
+00009790: 6e20 6578 706f 7375 7265 5f67 726f 7570  n exposure_group
+000097a0: 730a 0a0a 4449 5245 4354 5f4f 5244 4552  s...DIRECT_ORDER
+000097b0: 203d 207b 2747 3130 3227 3a20 5b27 4631   = {'G102': ['F1
+000097c0: 3035 5727 2c20 2746 3131 3057 272c 2027  05W', 'F110W', '
+000097d0: 4630 3938 4d27 2c20 2746 3132 3557 272c  F098M', 'F125W',
+000097e0: 2027 4631 3430 5727 2c20 2746 3136 3057   'F140W', 'F160W
+000097f0: 272c 2027 4631 3237 4d27 2c20 2746 3133  ', 'F127M', 'F13
+00009800: 394d 272c 2027 4631 3533 4d27 2c20 2746  9M', 'F153M', 'F
+00009810: 3133 324e 272c 2027 4631 3330 4e27 2c20  132N', 'F130N', 
+00009820: 2746 3132 384e 272c 2027 4631 3236 4e27  'F128N', 'F126N'
+00009830: 2c20 2746 3136 344e 272c 2027 4631 3637  , 'F164N', 'F167
+00009840: 4e27 5d2c 0a20 2020 2020 2020 2020 2020  N'],.           
+00009850: 2020 2020 2027 4731 3431 273a 205b 2746       'G141': ['F
+00009860: 3134 3057 272c 2027 4631 3630 5727 2c20  140W', 'F160W', 
+00009870: 2746 3132 3557 272c 2027 4631 3035 5727  'F125W', 'F105W'
+00009880: 2c20 2746 3131 3057 272c 2027 4630 3938  , 'F110W', 'F098
+00009890: 4d27 2c20 2746 3132 374d 272c 2027 4631  M', 'F127M', 'F1
+000098a0: 3339 4d27 2c20 2746 3135 334d 272c 2027  39M', 'F153M', '
+000098b0: 4631 3332 4e27 2c20 2746 3133 304e 272c  F132N', 'F130N',
+000098c0: 2027 4631 3238 4e27 2c20 2746 3132 364e   'F128N', 'F126N
+000098d0: 272c 2027 4631 3634 4e27 2c20 2746 3136  ', 'F164N', 'F16
+000098e0: 374e 275d 2c0a 2020 2020 2020 2020 2020  7N'],.          
+000098f0: 2020 2020 2020 2747 3830 304c 273a 205b        'G800L': [
+00009900: 2746 3831 3457 272c 2027 4636 3036 5727  'F814W', 'F606W'
+00009910: 2c20 2746 3835 304c 5027 2c20 2746 3737  , 'F850LP', 'F77
+00009920: 3557 272c 2027 4634 3335 5727 2c20 2746  5W', 'F435W', 'F
+00009930: 3130 3557 272c 2027 4631 3130 5727 2c20  105W', 'F110W', 
+00009940: 2746 3039 384d 272c 2027 4631 3235 5727  'F098M', 'F125W'
+00009950: 2c20 2746 3134 3057 272c 2027 4631 3630  , 'F140W', 'F160
+00009960: 5727 2c20 2746 3132 374d 272c 2027 4631  W', 'F127M', 'F1
+00009970: 3339 4d27 2c20 2746 3135 334d 272c 2027  39M', 'F153M', '
+00009980: 4631 3332 4e27 2c20 2746 3133 304e 272c  F132N', 'F130N',
+00009990: 2027 4631 3238 4e27 2c20 2746 3132 364e   'F128N', 'F126N
+000099a0: 272c 2027 4631 3634 4e27 2c20 2746 3136  ', 'F164N', 'F16
+000099b0: 374e 275d 2c0a 2020 2020 2020 2020 2020  7N'],.          
+000099c0: 2020 2020 2020 2747 5231 3530 4327 3a20        'GR150C': 
+000099d0: 5b27 4631 3135 5727 2c20 2746 3135 3057  ['F115W', 'F150W
+000099e0: 272c 2027 4632 3030 5727 5d2c 200a 2020  ', 'F200W'], .  
+000099f0: 2020 2020 2020 2020 2020 2020 2020 2747                'G
+00009a00: 5231 3530 5227 3a20 5b27 4631 3135 5727  R150R': ['F115W'
+00009a10: 2c20 2746 3135 3057 272c 2027 4632 3030  , 'F150W', 'F200
+00009a20: 5727 5d7d 0a0a 0a64 6566 2070 6172 7365  W']}...def parse
+00009a30: 5f67 7269 736d 5f61 7373 6f63 6961 7469  _grism_associati
+00009a40: 6f6e 7328 6578 706f 7375 7265 5f67 726f  ons(exposure_gro
+00009a50: 7570 732c 2069 6e66 6f2c 0a20 2020 2020  ups, info,.     
+00009a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a70: 2020 2020 2020 2020 6265 7374 5f64 6972          best_dir
+00009a80: 6563 743d 4449 5245 4354 5f4f 5244 4552  ect=DIRECT_ORDER
+00009a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009aa0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00009ab0: 6574 5f6d 6178 5f6f 7665 726c 6170 3d54  et_max_overlap=T
+00009ac0: 7275 6529 3a0a 2020 2020 2222 2247 6574  rue):.    """Get
+00009ad0: 2061 7373 6f63 6961 7465 6420 6c69 7374   associated list
+00009ae0: 7320 6f66 2067 7269 736d 2061 6e64 2064  s of grism and d
+00009af0: 6972 6563 7420 6578 706f 7375 7265 730a  irect exposures.
+00009b00: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00009b10: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00009b20: 2020 2065 7870 6f73 7572 655f 6772 7570     exposure_grup
+00009b30: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
+00009b40: 204f 7574 7075 7420 6c69 7374 206f 6620   Output list of 
+00009b50: 6f76 6572 6c61 7070 696e 6720 7669 7369  overlapping visi
+00009b60: 7473 2066 726f 6d0a 2020 2020 2020 2020  ts from.        
+00009b70: 607e 6772 697a 6c69 2e75 7469 6c73 2e70  `~grizli.utils.p
+00009b80: 6172 7365 5f76 6973 6974 5f6f 7665 726c  arse_visit_overl
+00009b90: 6170 7360 2e0a 0a20 2020 2062 6573 745f  aps`...    best_
+00009ba0: 6469 7265 6374 203a 2064 6963 740a 2020  direct : dict.  
+00009bb0: 2020 2020 2020 4469 6374 696f 6e61 7279        Dictionary
+00009bc0: 206f 6620 7468 6520 7072 6566 6572 7265   of the preferre
+00009bd0: 6420 6469 7265 6374 2069 6d61 6769 6e67  d direct imaging
+00009be0: 2066 696c 7465 7273 2074 6f20 7573 6520   filters to use 
+00009bf0: 7769 7468 2061 0a20 2020 2020 2020 2070  with a.        p
+00009c00: 6172 7469 6375 6c61 7220 6772 6973 6d2e  articular grism.
+00009c10: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00009c20: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6772    -------.    gr
+00009c30: 6973 6d5f 6772 6f75 7073 203a 206c 6973  ism_groups : lis
+00009c40: 740a 2020 2020 2020 2020 4c69 7374 206f  t.        List o
+00009c50: 6620 6469 6374 696f 6e61 7269 6573 2077  f dictionaries w
+00009c60: 6974 6820 6173 736f 6369 6174 6564 2027  ith associated '
+00009c70: 6469 7265 6374 2720 616e 6420 2767 7269  direct' and 'gri
+00009c80: 736d 2720 656e 7472 6965 732e 0a0a 2020  sm' entries...  
+00009c90: 2020 2222 220a 2020 2020 4e20 3d20 6c65    """.    N = le
+00009ca0: 6e28 6578 706f 7375 7265 5f67 726f 7570  n(exposure_group
+00009cb0: 7329 0a0a 2020 2020 6772 6973 6d5f 6772  s)..    grism_gr
+00009cc0: 6f75 7073 203d 205b 5d0a 2020 2020 666f  oups = [].    fo
+00009cd0: 7220 6920 696e 2072 616e 6765 284e 293a  r i in range(N):
+00009ce0: 0a20 2020 2020 2020 205f 6573 7069 203d  .        _espi =
+00009cf0: 2065 7870 6f73 7572 655f 6772 6f75 7073   exposure_groups
+00009d00: 5b69 5d5b 2770 726f 6475 6374 275d 2e73  [i]['product'].s
+00009d10: 706c 6974 2827 2d27 290a 2020 2020 2020  plit('-').      
+00009d20: 2020 0a20 2020 2020 2020 2069 6620 5f65    .        if _e
+00009d30: 7370 695b 2d32 5d5b 305d 2069 6e20 2766  spi[-2][0] in 'f
+00009d40: 6727 3a0a 2020 2020 2020 2020 2020 2020  g':.            
+00009d50: 7075 7069 6c5f 6920 3d20 5f65 7370 695b  pupil_i = _espi[
+00009d60: 2d32 5d0a 2020 2020 2020 2020 2020 2020  -2].            
+00009d70: 665f 6920 3d20 5f65 7370 695b 2d31 5d0a  f_i = _espi[-1].
+00009d80: 2020 2020 2020 2020 2020 2020 726f 6f74              root
+00009d90: 5f69 203d 2027 2d27 2e6a 6f69 6e28 5f65  _i = '-'.join(_e
+00009da0: 7370 695b 3a2d 325d 290a 2020 2020 2020  spi[:-2]).      
+00009db0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00009dc0: 2020 2020 7075 7069 6c5f 6920 3d20 4e6f      pupil_i = No
+00009dd0: 6e65 0a20 2020 2020 2020 2020 2020 2066  ne.            f
+00009de0: 5f69 203d 205f 6573 7069 5b2d 315d 0a20  _i = _espi[-1]. 
+00009df0: 2020 2020 2020 2020 2020 2072 6f6f 745f             root_
+00009e00: 6920 3d20 272d 272e 6a6f 696e 285f 6573  i = '-'.join(_es
+00009e10: 7069 5b3a 2d31 5d29 0a20 2020 2020 2020  pi[:-1]).       
+00009e20: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00009e30: 2066 5f69 2e73 7461 7274 7377 6974 6828   f_i.startswith(
+00009e40: 2767 2729 3a0a 2020 2020 2020 2020 2020  'g'):.          
+00009e50: 2020 6772 6f75 7020 3d20 4f72 6465 7265    group = Ordere
+00009e60: 6444 6963 7428 6772 6973 6d3d 6578 706f  dDict(grism=expo
+00009e70: 7375 7265 5f67 726f 7570 735b 695d 2c0a  sure_groups[i],.
+00009e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ea0: 6469 7265 6374 3d4e 6f6e 6529 0a20 2020  direct=None).   
+00009eb0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00009ec0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00009ed0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00009ee0: 2066 705f 6920 3d20 6578 706f 7375 7265   fp_i = exposure
+00009ef0: 5f67 726f 7570 735b 695d 5b27 666f 6f74  _groups[i]['foot
+00009f00: 7072 696e 7427 5d0a 2020 2020 2020 2020  print'].        
+00009f10: 6f6c 6170 5f69 203d 2030 2e0a 2020 2020  olap_i = 0..    
+00009f20: 2020 2020 645f 6920 3d20 665f 690a 2020      d_i = f_i.  
+00009f30: 2020 2020 2020 645f 6964 7820 3d20 3130        d_idx = 10
+00009f40: 0a20 2020 2020 2020 2066 6f72 206a 2069  .        for j i
+00009f50: 6e20 7261 6e67 6528 4e29 3a0a 2020 2020  n range(N):.    
+00009f60: 2020 2020 2020 2020 5f65 7370 6a20 3d20          _espj = 
+00009f70: 6578 706f 7375 7265 5f67 726f 7570 735b  exposure_groups[
+00009f80: 6a5d 5b27 7072 6f64 7563 7427 5d2e 7370  j]['product'].sp
+00009f90: 6c69 7428 272d 2729 0a20 2020 2020 2020  lit('-').       
+00009fa0: 2020 2020 2069 6620 5f65 7370 6a5b 2d32       if _espj[-2
+00009fb0: 5d5b 305d 2069 6e20 2766 6727 3a0a 2020  ][0] in 'fg':.  
+00009fc0: 2020 2020 2020 2020 2020 2020 2020 7075                pu
+00009fd0: 7069 6c5f 6a20 3d20 5f65 7370 6a5b 2d32  pil_j = _espj[-2
+00009fe0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00009ff0: 2020 665f 6a20 3d20 5f65 7370 6a5b 2d31    f_j = _espj[-1
+0000a000: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000a010: 2020 726f 6f74 5f6a 203d 2027 2d27 2e6a    root_j = '-'.j
+0000a020: 6f69 6e28 5f65 7370 6a5b 3a2d 325d 290a  oin(_espj[:-2]).
+0000a030: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000a040: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a050: 2020 665f 6a20 3d20 5f65 7370 6a5b 2d31    f_j = _espj[-1
+0000a060: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000a070: 2020 726f 6f74 5f6a 203d 2027 2d27 2e6a    root_j = '-'.j
+0000a080: 6f69 6e28 5f65 7370 6a5b 3a2d 315d 290a  oin(_espj[:-1]).
+0000a090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0a0: 7075 7069 6c5f 6a20 3d20 4e6f 6e65 0a20  pupil_j = None. 
+0000a0b0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+0000a0c0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+0000a0d0: 5f6a 2e73 7461 7274 7377 6974 6828 2767  _j.startswith('g
+0000a0e0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+0000a0f0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0000a100: 2020 2020 2020 2020 2020 6670 5f6a 203d            fp_j =
+0000a110: 2065 7870 6f73 7572 655f 6772 6f75 7073   exposure_groups
+0000a120: 5b6a 5d5b 2766 6f6f 7470 7269 6e74 275d  [j]['footprint']
+0000a130: 0a20 2020 2020 2020 2020 2020 206f 6c61  .            ola
+0000a140: 7020 3d20 6670 5f69 2e69 6e74 6572 7365  p = fp_i.interse
+0000a150: 6374 696f 6e28 6670 5f6a 290a 0a20 2020  ction(fp_j)..   
+0000a160: 2020 2020 2020 2020 2069 6620 2872 6f6f           if (roo
+0000a170: 745f 6a20 3d3d 2072 6f6f 745f 6929 3a0a  t_j == root_i):.
+0000a180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a190: 2069 6620 7075 7069 6c5f 6920 6973 206e   if pupil_i is n
+0000a1a0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000a1b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000a1c0: 7075 7069 6c5f 6a20 3d3d 2070 7570 696c  pupil_j == pupil
+0000a1d0: 5f69 3a0a 2020 2020 2020 2020 2020 2020  _i:.            
+0000a1e0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0000a1f0: 705b 2764 6972 6563 7427 5d20 3d20 6578  p['direct'] = ex
+0000a200: 706f 7375 7265 5f67 726f 7570 735b 6a5d  posure_groups[j]
+0000a210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a220: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a240: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0000a250: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000a260: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a270: 2020 2020 2020 6966 2066 5f6a 2e75 7070        if f_j.upp
+0000a280: 6572 2829 206e 6f74 2069 6e20 6265 7374  er() not in best
+0000a290: 5f64 6972 6563 745b 665f 692e 7570 7065  _direct[f_i.uppe
+0000a2a0: 7228 295d 3a0a 2020 2020 2020 2020 2020  r()]:.          
+0000a2b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000a2c0: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+0000a2d0: 2020 2020 2020 2020 2020 2069 6620 6265             if be
+0000a2e0: 7374 5f64 6972 6563 745b 665f 692e 7570  st_direct[f_i.up
+0000a2f0: 7065 7228 295d 2e69 6e64 6578 2866 5f6a  per()].index(f_j
+0000a300: 2e75 7070 6572 2829 2920 3c20 645f 6964  .upper()) < d_id
+0000a310: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
+0000a320: 2020 2020 2020 2020 2020 2064 5f69 6478             d_idx
+0000a330: 203d 2062 6573 745f 6469 7265 6374 5b66   = best_direct[f
+0000a340: 5f69 2e75 7070 6572 2829 5d2e 696e 6465  _i.upper()].inde
+0000a350: 7828 665f 6a2e 7570 7065 7228 2929 0a20  x(f_j.upper()). 
+0000a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a370: 2020 2020 2020 2067 726f 7570 5b27 6469         group['di
+0000a380: 7265 6374 275d 203d 2065 7870 6f73 7572  rect'] = exposur
+0000a390: 655f 6772 6f75 7073 5b6a 5d0a 2020 2020  e_groups[j].    
+0000a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3b0: 2020 2020 6f6c 6170 5f69 203d 206f 6c61      olap_i = ola
+0000a3c0: 702e 6172 6561 0a20 2020 2020 2020 2020  p.area.         
+0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000a3e0: 5f69 203d 2066 5f6a 0a0a 2020 2020 2020  _i = f_j..      
+0000a3f0: 2020 6772 6973 6d5f 6772 6f75 7073 2e61    grism_groups.a
+0000a400: 7070 656e 6428 6772 6f75 7029 0a0a 2020  ppend(group)..  
+0000a410: 2020 7265 7475 726e 2067 7269 736d 5f67    return grism_g
+0000a420: 726f 7570 730a 0a0a 6465 6620 6765 745f  roups...def get_
+0000a430: 6873 745f 6669 6c74 6572 2868 6561 6465  hst_filter(heade
+0000a440: 722c 202a 2a6b 7761 7267 7329 3a0a 2020  r, **kwargs):.  
+0000a450: 2020 2222 220a 2020 2020 4465 7072 6563    """.    Deprec
+0000a460: 6174 6564 3a20 7573 6520 6067 7269 7a6c  ated: use `grizl
+0000a470: 692e 7574 696c 732e 7061 7273 655f 6669  i.utils.parse_fi
+0000a480: 6c74 6572 5f66 726f 6d5f 6865 6164 6572  lter_from_header
+0000a490: 600a 2020 2020 2222 220a 2020 2020 0a20  `.    """.    . 
+0000a4a0: 2020 2072 6573 756c 7420 3d20 7061 7273     result = pars
+0000a4b0: 655f 6669 6c74 6572 5f66 726f 6d5f 6865  e_filter_from_he
+0000a4c0: 6164 6572 2868 6561 6465 722c 202a 2a6b  ader(header, **k
+0000a4d0: 7761 7267 7329 0a20 2020 2072 6574 7572  wargs).    retur
+0000a4e0: 6e20 7265 7375 6c74 0a0a 0a64 6566 2070  n result...def p
+0000a4f0: 6172 7365 5f66 696c 7465 725f 6672 6f6d  arse_filter_from
+0000a500: 5f68 6561 6465 7228 6865 6164 6572 2c20  _header(header, 
+0000a510: 6669 6c74 6572 5f6f 6e6c 793d 4661 6c73  filter_only=Fals
+0000a520: 652c 206a 7773 745f 6465 7465 6374 6f72  e, jwst_detector
+0000a530: 3d46 616c 7365 2c20 2a2a 6b77 6172 6773  =False, **kwargs
+0000a540: 293a 0a20 2020 2022 2222 4765 7420 7369  ):.    """Get si
+0000a550: 6d70 6c65 2066 696c 7465 7220 6e61 6d65  mple filter name
+0000a560: 206f 7574 206f 6620 616e 2048 5354 2f4a   out of an HST/J
+0000a570: 5753 5420 696d 6167 6520 6865 6164 6572  WST image header
+0000a580: 2e0a 0a20 2020 2041 4353 2068 6173 2074  ...    ACS has t
+0000a590: 776f 206b 6579 776f 7264 7320 666f 7220  wo keywords for 
+0000a5a0: 7468 6520 7477 6f20 6669 6c74 6572 2077  the two filter w
+0000a5b0: 6865 656c 732c 2073 6f20 6a75 7374 2072  heels, so just r
+0000a5c0: 6574 7572 6e20 7468 650a 2020 2020 6e6f  eturn the.    no
+0000a5d0: 6e2d 434c 4541 5220 6669 6c74 6572 2e20  n-CLEAR filter. 
+0000a5e0: 466f 7220 6578 616d 706c 652c 0a0a 2020  For example,..  
+0000a5f0: 2020 2020 2020 3e3e 3e20 6820 3d20 6173        >>> h = as
+0000a600: 7472 6f70 792e 696f 2e66 6974 732e 4865  tropy.io.fits.He
+0000a610: 6164 6572 2829 0a20 2020 2020 2020 203e  ader().        >
+0000a620: 3e3e 2068 5b27 494e 5354 5255 4d45 275d  >> h['INSTRUME']
+0000a630: 203d 2027 4143 5327 0a20 2020 2020 2020   = 'ACS'.       
+0000a640: 203e 3e3e 2068 5b27 4649 4c54 4552 3127   >>> h['FILTER1'
+0000a650: 5d20 3d20 2743 4c45 4152 314c 270a 2020  ] = 'CLEAR1L'.  
+0000a660: 2020 2020 2020 3e3e 3e20 685b 2746 494c        >>> h['FIL
+0000a670: 5445 5232 275d 203d 2027 4638 3134 5727  TER2'] = 'F814W'
+0000a680: 0a20 2020 2020 2020 203e 3e3e 2066 726f  .        >>> fro
+0000a690: 6d20 6772 697a 6c69 2e75 7469 6c73 2069  m grizli.utils i
+0000a6a0: 6d70 6f72 7420 7061 7273 655f 6669 6c74  mport parse_filt
+0000a6b0: 6572 5f66 726f 6d5f 6865 6164 6572 0a20  er_from_header. 
+0000a6c0: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+0000a6d0: 2870 6172 7365 5f66 696c 7465 725f 6672  (parse_filter_fr
+0000a6e0: 6f6d 5f68 6561 6465 7228 6829 290a 2020  om_header(h)).  
+0000a6f0: 2020 2020 2020 4638 3134 570a 2020 2020        F814W.    
+0000a700: 2020 2020 3e3e 3e20 685b 2746 494c 5445      >>> h['FILTE
+0000a710: 5231 275d 203d 2027 4738 3030 4c27 0a20  R1'] = 'G800L'. 
+0000a720: 2020 2020 2020 203e 3e3e 2068 5b27 4649         >>> h['FI
+0000a730: 4c54 4552 3227 5d20 3d20 2743 4c45 4152  LTER2'] = 'CLEAR
+0000a740: 324c 270a 2020 2020 2020 2020 3e3e 3e20  2L'.        >>> 
+0000a750: 7072 696e 7428 7061 7273 655f 6669 6c74  print(parse_filt
+0000a760: 6572 5f66 726f 6d5f 6865 6164 6572 2868  er_from_header(h
+0000a770: 2929 0a20 2020 2020 2020 2047 3830 304c  )).        G800L
+0000a780: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+0000a790: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0000a7a0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0000a7b0: 6865 6164 6572 203a 2060 7e61 7374 726f  header : `~astro
+0000a7c0: 7079 2e69 6f2e 6669 7473 2e48 6561 6465  py.io.fits.Heade
+0000a7d0: 7260 0a20 2020 2020 2020 2049 6d61 6765  r`.        Image
+0000a7e0: 2068 6561 6465 7220 7769 7468 2046 494c   header with FIL
+0000a7f0: 5445 5220 6f72 2046 494c 5445 5231 2c46  TER or FILTER1,F
+0000a800: 494c 5445 5232 2c2e 2e2e 2c46 494c 5445  ILTER2,...,FILTE
+0000a810: 524e 206b 6579 776f 7264 730a 2020 2020  RN keywords.    
+0000a820: 0a20 2020 2066 696c 7465 725f 6f6e 6c79  .    filter_only
+0000a830: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+0000a840: 4966 2074 7275 652c 2064 6f6e 2774 2064  If true, don't d
+0000a850: 6f20 616e 7920 7370 6563 6961 6c20 6861  o any special ha
+0000a860: 6e64 6c69 6e67 2077 6974 6820 4a57 5354  ndling with JWST
+0000a870: 2062 7574 206a 7573 7420 7265 7475 726e   but just return
+0000a880: 2074 6865 0a20 2020 2020 2020 2060 6046   the.        ``F
+0000a890: 494c 5445 5260 6020 6b65 7977 6f72 6420  ILTER`` keyword 
+0000a8a0: 6974 7365 6c66 2e20 4f74 6865 7277 6973  itself. Otherwis
+0000a8b0: 652c 2066 6f72 204a 5753 542f 4e49 5249  e, for JWST/NIRI
+0000a8c0: 5353 2c20 7265 7475 726e 200a 2020 2020  SS, return .    
+0000a8d0: 2020 2020 6060 7b50 5550 494c 7d2d 7b46      ``{PUPIL}-{F
+0000a8e0: 494c 5445 527d 6060 2061 6e64 2066 6f72  ILTER}`` and for
+0000a8f0: 204a 5753 542f 4e49 5243 414d 2c20 7265   JWST/NIRCAM, re
+0000a900: 7475 726e 2060 607b 4649 4c54 4552 7d2d  turn ``{FILTER}-
+0000a910: 7b50 5550 494c 7d60 600a 2020 2020 2020  {PUPIL}``.      
+0000a920: 2020 0a20 2020 206a 7773 745f 6465 7465    .    jwst_dete
+0000a930: 6374 6f72 203a 2062 6f6f 6c0a 2020 2020  ctor : bool.    
+0000a940: 2020 2020 4966 2054 7275 652c 2070 7265      If True, pre
+0000a950: 7065 6e64 2060 6044 4554 4543 544f 5260  pend ``DETECTOR`
+0000a960: 6020 746f 206f 7574 7075 7420 666f 7220  ` to output for 
+0000a970: 4a57 5354 204e 4952 4361 6d20 616e 6420  JWST NIRCam and 
+0000a980: 4e49 5249 5353 0a20 2020 2020 2020 2074  NIRISS.        t
+0000a990: 6f20 6469 7374 696e 6775 6973 6820 4e49  o distinguish NI
+0000a9a0: 5243 616d 2064 6574 6563 746f 7273 2061  RCam detectors a
+0000a9b0: 6e64 2066 696c 7465 7220 6e61 6d65 7320  nd filter names 
+0000a9c0: 636f 6d6d 6f6e 2062 6574 7765 656e 200a  common between .
+0000a9d0: 2020 2020 2020 2020 7468 6573 6520 696e          these in
+0000a9e0: 7374 7275 6d65 6e74 732e 0a20 2020 2020  struments..     
+0000a9f0: 2020 200a 2020 2020 5265 7475 726e 730a     .    Returns.
+0000aa00: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0000aa10: 6669 6c74 6572 203a 2073 7472 0a0a 2020  filter : str..  
+0000aa20: 2020 2222 220a 2020 2020 0a20 2020 2069    """.    .    i
+0000aa30: 6620 2749 4e53 5452 554d 4527 206e 6f74  f 'INSTRUME' not
+0000aa40: 2069 6e20 6865 6164 6572 3a0a 2020 2020   in header:.    
+0000aa50: 2020 2020 696e 7374 7275 6d65 203d 2027      instrume = '
+0000aa60: 4e2f 4127 0a20 2020 2065 6c73 653a 0a20  N/A'.    else:. 
+0000aa70: 2020 2020 2020 2069 6e73 7472 756d 6520         instrume 
+0000aa80: 3d20 6865 6164 6572 5b27 494e 5354 5255  = header['INSTRU
+0000aa90: 4d45 275d 0a20 2020 2020 2020 200a 2020  ME'].        .  
+0000aaa0: 2020 6966 2069 6e73 7472 756d 652e 7374    if instrume.st
+0000aab0: 7269 7028 2920 3d3d 2027 4143 5327 3a0a  rip() == 'ACS':.
+0000aac0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000aad0: 205b 312c 2032 5d3a 0a20 2020 2020 2020   [1, 2]:.       
+0000aae0: 2020 2020 2066 696c 7465 725f 6920 3d20       filter_i = 
+0000aaf0: 6865 6164 6572 5b27 4649 4c54 4552 7b30  header['FILTER{0
+0000ab00: 3a64 7d27 2e66 6f72 6d61 7428 6929 5d0a  :d}'.format(i)].
+0000ab10: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+0000ab20: 434c 4541 5227 2069 6e20 6669 6c74 6572  CLEAR' in filter
+0000ab30: 5f69 3a0a 2020 2020 2020 2020 2020 2020  _i:.            
+0000ab40: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+0000ab50: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000ab60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ab70: 696c 7465 7220 3d20 6669 6c74 6572 5f69  ilter = filter_i
+0000ab80: 0a0a 2020 2020 656c 6966 2069 6e73 7472  ..    elif instr
+0000ab90: 756d 6520 3d3d 2027 5746 5043 3227 3a0a  ume == 'WFPC2':.
+0000aba0: 2020 2020 2020 2020 6669 6c74 6572 203d          filter =
+0000abb0: 2068 6561 6465 725b 2746 494c 544e 414d   header['FILTNAM
+0000abc0: 3127 5d0a 2020 2020 2020 2020 0a20 2020  1'].        .   
+0000abd0: 2065 6c69 6620 696e 7374 7275 6d65 203d   elif instrume =
+0000abe0: 3d20 274e 4952 4953 5327 3a0a 2020 2020  = 'NIRISS':.    
+0000abf0: 2020 2020 6966 2066 696c 7465 725f 6f6e      if filter_on
+0000ac00: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+0000ac10: 6669 6c74 6572 203d 2068 6561 6465 725b  filter = header[
+0000ac20: 2746 494c 5445 5227 5d0a 2020 2020 2020  'FILTER'].      
+0000ac30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000ac40: 2020 2020 6669 6c74 6572 203d 2027 7b30      filter = '{0
+0000ac50: 7d2d 7b31 7d27 2e66 6f72 6d61 7428 6865  }-{1}'.format(he
+0000ac60: 6164 6572 5b27 5055 5049 4c27 5d2c 2068  ader['PUPIL'], h
+0000ac70: 6561 6465 725b 2746 494c 5445 5227 5d29  eader['FILTER'])
+0000ac80: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+0000ac90: 2020 6966 206a 7773 745f 6465 7465 6374    if jwst_detect
+0000aca0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0000acb0: 6669 6c74 6572 203d 2027 7b30 7d2d 7b31  filter = '{0}-{1
+0000acc0: 7d27 2e66 6f72 6d61 7428 6865 6164 6572  }'.format(header
+0000acd0: 5b27 4445 5445 4354 4f52 275d 2c20 6669  ['DETECTOR'], fi
+0000ace0: 6c74 6572 290a 2020 2020 2020 2020 2020  lter).          
+0000acf0: 2020 0a20 2020 2065 6c69 6620 696e 7374    .    elif inst
+0000ad00: 7275 6d65 203d 3d20 274e 4952 4341 4d27  rume == 'NIRCAM'
+0000ad10: 3a0a 2020 2020 2020 2020 6966 2066 696c  :.        if fil
+0000ad20: 7465 725f 6f6e 6c79 3a0a 2020 2020 2020  ter_only:.      
+0000ad30: 2020 2020 2020 6669 6c74 6572 203d 2068        filter = h
+0000ad40: 6561 6465 725b 2746 494c 5445 5227 5d0a  eader['FILTER'].
+0000ad50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000ad60: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
+0000ad70: 203d 2027 7b30 7d2d 7b31 7d27 2e66 6f72   = '{0}-{1}'.for
+0000ad80: 6d61 7428 6865 6164 6572 5b27 4649 4c54  mat(header['FILT
+0000ad90: 4552 275d 2c20 6865 6164 6572 5b27 5055  ER'], header['PU
+0000ada0: 5049 4c27 5d29 0a20 2020 2020 2020 2069  PIL']).        i
+0000adb0: 6620 6a77 7374 5f64 6574 6563 746f 723a  f jwst_detector:
+0000adc0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0000add0: 7465 7220 3d20 277b 307d 2d7b 317d 272e  ter = '{0}-{1}'.
+0000ade0: 666f 726d 6174 2868 6561 6465 725b 2744  format(header['D
+0000adf0: 4554 4543 544f 5227 5d2c 2066 696c 7465  ETECTOR'], filte
+0000ae00: 7229 0a20 2020 2020 2020 2020 2020 2066  r).            f
+0000ae10: 696c 7465 7220 3d20 6669 6c74 6572 2e72  ilter = filter.r
+0000ae20: 6570 6c61 6365 2827 4c4f 4e47 272c 2735  eplace('LONG','5
+0000ae30: 2729 0a20 2020 2020 2020 2020 2020 200a  ').            .
+0000ae40: 2020 2020 656c 6966 2027 4649 4c54 4552      elif 'FILTER
+0000ae50: 2720 696e 2068 6561 6465 723a 0a20 2020  ' in header:.   
+0000ae60: 2020 2020 2066 696c 7465 7220 3d20 6865       filter = he
+0000ae70: 6164 6572 5b27 4649 4c54 4552 275d 0a20  ader['FILTER']. 
+0000ae80: 2020 2020 2020 200a 2020 2020 656c 7365         .    else
+0000ae90: 3a0a 2020 2020 2020 2020 6d73 6720 3d20  :.        msg = 
+0000aea0: 2746 6169 6c65 6420 746f 2070 6172 7365  'Failed to parse
+0000aeb0: 2046 494c 5445 5220 6b65 7977 6f72 6420   FILTER keyword 
+0000aec0: 666f 7220 494e 5354 5255 4d45 6e74 207b  for INSTRUMEnt {
+0000aed0: 307d 270a 2020 2020 2020 2020 7261 6973  0}'.        rais
+0000aee0: 6520 4b65 7945 7272 6f72 286d 7367 2e66  e KeyError(msg.f
+0000aef0: 6f72 6d61 7428 696e 7374 7275 6d65 2929  ormat(instrume))
+0000af00: 0a0a 2020 2020 7265 7475 726e 2066 696c  ..    return fil
+0000af10: 7465 722e 7570 7065 7228 290a 0a0a 4545  ter.upper()...EE
+0000af20: 5f52 4144 4949 203d 205b 302e 312c 2030  _RADII = [0.1, 0
+0000af30: 2e31 352c 2030 2e32 2c20 302e 3235 2c20  .15, 0.2, 0.25, 
+0000af40: 302e 332c 2030 2e34 2c20 302e 352c 2030  0.3, 0.4, 0.5, 0
+0000af50: 2e38 2c20 312e 2c20 312e 352c 2032 2e5d  .8, 1., 1.5, 2.]
+0000af60: 0a0a 6465 6620 6765 745f 6669 6c74 6572  ..def get_filter
+0000af70: 5f6f 6273 6d6f 6465 2866 696c 7465 723d  _obsmode(filter=
+0000af80: 2766 3136 3077 272c 2061 6373 5f63 6869  'f160w', acs_chi
+0000af90: 703d 2777 6663 3127 2c20 7576 6973 5f63  p='wfc1', uvis_c
+0000afa0: 6869 703d 2775 7669 7332 272c 2061 7065  hip='uvis2', ape
+0000afb0: 723d 6e70 2e69 6e66 2c20 6361 7365 3d73  r=np.inf, case=s
+0000afc0: 7472 2e6c 6f77 6572 293a 0a20 2020 2022  tr.lower):.    "
+0000afd0: 2222 0a20 2020 2044 6572 6976 6520 607e  "".    Derive `~
+0000afe0: 7079 7379 6e70 686f 7460 206f 6273 6d6f  pysynphot` obsmo
+0000aff0: 6465 206b 6579 776f 7264 2066 726f 6d20  de keyword from 
+0000b000: 6120 6669 6c74 6572 206e 616d 652c 2077  a filter name, w
+0000b010: 6865 7265 2055 5649 5320 6669 6c74 6572  here UVIS filter
+0000b020: 730a 2020 2020 656e 6420 696e 2027 7527  s.    end in 'u'
+0000b030: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+0000b040: 6669 6c74 6572 2e6c 6f77 6572 2829 5b3a  filter.lower()[:
+0000b050: 325d 2069 6e20 5b27 6630 272c 2027 6631  2] in ['f0', 'f1
+0000b060: 272c 2027 6731 275d 3a0a 2020 2020 2020  ', 'g1']:.      
+0000b070: 2020 696e 7374 203d 2027 7766 6333 2c69    inst = 'wfc3,i
+0000b080: 7227 0a20 2020 2065 6c73 653a 0a20 2020  r'.    else:.   
+0000b090: 2020 2020 2069 6620 6669 6c74 6572 2e6c       if filter.l
+0000b0a0: 6f77 6572 2829 2e65 6e64 7377 6974 6828  ower().endswith(
+0000b0b0: 2775 2729 3a0a 2020 2020 2020 2020 2020  'u'):.          
+0000b0c0: 2020 696e 7374 203d 2066 2777 6663 332c    inst = f'wfc3,
+0000b0d0: 7b75 7669 735f 6368 6970 7d27 0a20 2020  {uvis_chip}'.   
+0000b0e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000b0f0: 2020 2020 2020 2069 6e73 7420 3d20 6627         inst = f'
+0000b100: 6163 732c 7b61 6373 5f63 6869 707d 270a  acs,{acs_chip}'.
+0000b110: 2020 2020 2020 2020 0a20 2020 206f 6273          .    obs
+0000b120: 6d6f 6465 203d 2069 6e73 7420 2b20 272c  mode = inst + ',
+0000b130: 2720 2b20 6669 6c74 6572 2e73 7472 6970  ' + filter.strip
+0000b140: 2827 7527 292e 6c6f 7765 7228 290a 2020  ('u').lower().  
+0000b150: 2020 6966 206e 702e 6973 6669 6e69 7465    if np.isfinite
+0000b160: 2861 7065 7229 3a0a 2020 2020 2020 2020  (aper):.        
+0000b170: 6f62 736d 6f64 6520 2b3d 2066 272c 6170  obsmode += f',ap
+0000b180: 6572 237b 6170 6572 3a34 2e32 667d 270a  er#{aper:4.2f}'.
+0000b190: 2020 2020 2020 2020 0a20 2020 2072 6574          .    ret
+0000b1a0: 7572 6e20 6361 7365 286f 6273 6d6f 6465  urn case(obsmode
+0000b1b0: 290a 2020 2020 0a64 6566 2074 6162 756c  ).    .def tabul
+0000b1c0: 6174 655f 656e 6369 7263 6c65 645f 656e  ate_encircled_en
+0000b1d0: 6572 6779 2861 7065 725f 7261 6469 693d  ergy(aper_radii=
+0000b1e0: 4545 5f52 4144 4949 2c20 6e6f 726d 5f72  EE_RADII, norm_r
+0000b1f0: 6164 6975 733d 342e 3029 3a0a 0a20 2020  adius=4.0):..   
+0000b200: 2069 6d70 6f72 7420 7079 7379 6e70 686f   import pysynpho
+0000b210: 7420 6173 2053 0a0a 2020 2020 6672 6f6d  t as S..    from
+0000b220: 202e 7069 7065 6c69 6e65 2069 6d70 6f72   .pipeline impor
+0000b230: 7420 6465 6661 756c 745f 7061 7261 6d73  t default_params
+0000b240: 0a0a 2020 2020 2320 4465 6661 756c 7420  ..    # Default 
+0000b250: 7370 6563 7472 756d 0a20 2020 2073 7020  spectrum.    sp 
+0000b260: 3d20 532e 466c 6174 5370 6563 7472 756d  = S.FlatSpectrum
+0000b270: 2832 352c 2066 6c75 7875 6e69 7473 3d27  (25, fluxunits='
+0000b280: 4142 4d61 6727 290a 0a20 2020 2074 6162  ABMag')..    tab
+0000b290: 203d 2047 5461 626c 6528 290a 2020 2020   = GTable().    
+0000b2a0: 7461 625b 2772 6164 6975 7327 5d20 3d20  tab['radius'] = 
+0000b2b0: 6170 6572 5f72 6164 6969 2a75 2e61 7263  aper_radii*u.arc
+0000b2c0: 7365 630a 2020 2020 7461 622e 6d65 7461  sec.    tab.meta
+0000b2d0: 5b27 524e 4f52 4d27 5d20 3d20 6e6f 726d  ['RNORM'] = norm
+0000b2e0: 5f72 6164 6975 732c 2027 4e6f 726d 616c  _radius, 'Normal
+0000b2f0: 697a 6174 696f 6e20 7261 6469 7573 2c20  ization radius, 
+0000b300: 6172 6373 6563 270a 0a20 2020 2023 2049  arcsec'..    # I
+0000b310: 520a 2020 2020 666f 7220 6620 696e 2064  R.    for f in d
+0000b320: 6566 6175 6c74 5f70 6172 616d 732e 4952  efault_params.IR
+0000b330: 5f4d 5f46 494c 5445 5253 2b64 6566 6175  _M_FILTERS+defau
+0000b340: 6c74 5f70 6172 616d 732e 4952 5f57 5f46  lt_params.IR_W_F
+0000b350: 494c 5445 5253 3a0a 2020 2020 2020 2020  ILTERS:.        
+0000b360: 6f62 736d 6f64 6520 3d20 2777 6663 332c  obsmode = 'wfc3,
+0000b370: 6972 2c27 2b66 2e6c 6f77 6572 2829 0a20  ir,'+f.lower(). 
+0000b380: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0000b390: 7072 696e 7428 6f62 736d 6f64 6529 0a20  print(obsmode). 
+0000b3a0: 2020 2020 2020 2074 6162 5b6f 6273 6d6f         tab[obsmo
+0000b3b0: 6465 5d20 3d20 7379 6e70 686f 745f 656e  de] = synphot_en
+0000b3c0: 6369 7263 6c65 645f 656e 6572 6779 286f  circled_energy(o
+0000b3d0: 6273 6d6f 6465 3d6f 6273 6d6f 6465 2c20  bsmode=obsmode, 
+0000b3e0: 7370 3d73 702c 2061 7065 725f 7261 6469  sp=sp, aper_radi
+0000b3f0: 693d 6170 6572 5f72 6164 6969 2c20 6e6f  i=aper_radii, no
+0000b400: 726d 5f72 6164 6975 733d 6e6f 726d 5f72  rm_radius=norm_r
+0000b410: 6164 6975 7329 0a20 2020 2020 2020 2074  adius).        t
+0000b420: 6162 2e6d 6574 615b 275a 505f 7b30 7d27  ab.meta['ZP_{0}'
+0000b430: 2e66 6f72 6d61 7428 6f62 736d 6f64 6529  .format(obsmode)
+0000b440: 5d20 3d20 7379 6e70 686f 745f 7a65 726f  ] = synphot_zero
+0000b450: 706f 696e 7428 6f62 736d 6f64 653d 6f62  point(obsmode=ob
+0000b460: 736d 6f64 652c 2072 6164 6975 733d 6e6f  smode, radius=no
+0000b470: 726d 5f72 6164 6975 7329 0a0a 2020 2020  rm_radius)..    
+0000b480: 2320 4f70 7469 6361 6c2e 2020 5772 6170  # Optical.  Wrap
+0000b490: 2069 6e20 7472 792f 6578 6365 7074 2074   in try/except t
+0000b4a0: 6f20 6361 7463 6820 6d69 7373 696e 6720  o catch missing 
+0000b4b0: 6669 6c74 6572 730a 2020 2020 666f 7220  filters.    for 
+0000b4c0: 696e 7374 2069 6e20 5b27 6163 732c 7766  inst in ['acs,wf
+0000b4d0: 6331 2c27 2c20 2777 6663 332c 7576 6973  c1,', 'wfc3,uvis
+0000b4e0: 322c 275d 3a0a 2020 2020 2020 2020 666f  2,']:.        fo
+0000b4f0: 7220 6620 696e 2028 6465 6661 756c 745f  r f in (default_
+0000b500: 7061 7261 6d73 2e4f 5054 5f4d 5f46 494c  params.OPT_M_FIL
+0000b510: 5445 5253 202b 200a 2020 2020 2020 2020  TERS + .        
+0000b520: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
+0000b530: 745f 7061 7261 6d73 2e4f 5054 5f57 5f46  t_params.OPT_W_F
+0000b540: 494c 5445 5253 202b 200a 2020 2020 2020  ILTERS + .      
+0000b550: 2020 2020 2020 2020 2020 2020 6465 6661              defa
+0000b560: 756c 745f 7061 7261 6d73 2e55 565f 4d5f  ult_params.UV_M_
+0000b570: 4649 4c54 4552 5320 2b20 0a20 2020 2020  FILTERS + .     
+0000b580: 2020 2020 2020 2020 2020 2020 2064 6566               def
+0000b590: 6175 6c74 5f70 6172 616d 732e 5556 5f57  ault_params.UV_W
+0000b5a0: 5f46 494c 5445 5253 293a 0a0a 2020 2020  _FILTERS):..    
+0000b5b0: 2020 2020 2020 2020 6f62 736d 6f64 6520          obsmode 
+0000b5c0: 3d20 696e 7374 2b66 2e6c 6f77 6572 2829  = inst+f.lower()
+0000b5d0: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
+0000b5e0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000b5f0: 2020 2074 6162 5b6f 6273 6d6f 6465 5d20     tab[obsmode] 
+0000b600: 3d20 7379 6e70 686f 745f 656e 6369 7263  = synphot_encirc
+0000b610: 6c65 645f 656e 6572 6779 286f 6273 6d6f  led_energy(obsmo
+0000b620: 6465 3d6f 6273 6d6f 6465 2c20 7370 3d73  de=obsmode, sp=s
+0000b630: 702c 2061 7065 725f 7261 6469 693d 6170  p, aper_radii=ap
+0000b640: 6572 5f72 6164 6969 2c20 6e6f 726d 5f72  er_radii, norm_r
+0000b650: 6164 6975 733d 6e6f 726d 5f72 6164 6975  adius=norm_radiu
+0000b660: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0000b670: 2020 2070 7269 6e74 286f 6273 6d6f 6465     print(obsmode
+0000b680: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000b690: 2020 7461 622e 6d65 7461 5b27 5a50 5f7b    tab.meta['ZP_{
+0000b6a0: 307d 272e 666f 726d 6174 286f 6273 6d6f  0}'.format(obsmo
+0000b6b0: 6465 295d 203d 2073 796e 7068 6f74 5f7a  de)] = synphot_z
+0000b6c0: 6572 6f70 6f69 6e74 286f 6273 6d6f 6465  eropoint(obsmode
+0000b6d0: 3d6f 6273 6d6f 6465 2c20 7261 6469 7573  =obsmode, radius
+0000b6e0: 3d6e 6f72 6d5f 7261 6469 7573 290a 2020  =norm_radius).  
+0000b6f0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000b700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b710: 2020 2320 4661 696c 6564 2062 6563 6175    # Failed becau
+0000b720: 7365 206f 6273 6d6f 6465 206e 6f74 2061  se obsmode not a
+0000b730: 7661 696c 6162 6c65 2069 6e20 7379 6e70  vailable in synp
+0000b740: 686f 740a 2020 2020 2020 2020 2020 2020  hot.            
+0000b750: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0000b760: 2020 7461 622e 6d65 7461 5b27 5053 594e    tab.meta['PSYN
+0000b770: 5645 5227 5d20 3d20 532e 5f5f 7665 7273  VER'] = S.__vers
+0000b780: 696f 6e5f 5f2c 2027 5079 7379 6e70 686f  ion__, 'Pysynpho
+0000b790: 7420 7665 7273 696f 6e27 0a0a 2020 2020  t version'..    
+0000b7a0: 7461 622e 7772 6974 6528 2768 7374 5f65  tab.write('hst_e
+0000b7b0: 6e63 6972 636c 6564 5f65 6e65 7267 792e  ncircled_energy.
+0000b7c0: 6669 7473 272c 206f 7665 7277 7269 7465  fits', overwrite
+0000b7d0: 3d54 7275 6529 0a0a 0a64 6566 2073 796e  =True)...def syn
+0000b7e0: 7068 6f74 5f7a 6572 6f70 6f69 6e74 286f  phot_zeropoint(o
+0000b7f0: 6273 6d6f 6465 3d27 7766 6333 2c69 722c  bsmode='wfc3,ir,
+0000b800: 6631 3630 7727 2c20 7261 6469 7573 3d34  f160w', radius=4
+0000b810: 2e30 293a 0a20 2020 2022 2222 0a20 2020  .0):.    """.   
+0000b820: 2043 6f6d 7075 7465 2073 796e 7068 6f74   Compute synphot
+0000b830: 2066 6f72 2061 2073 7065 6369 6669 6320   for a specific 
+0000b840: 6170 6572 7475 7265 0a20 2020 2022 2222  aperture.    """
+0000b850: 0a20 2020 2069 6d70 6f72 7420 7079 7379  .    import pysy
+0000b860: 6e70 686f 7420 6173 2053 0a20 2020 2073  nphot as S.    s
+0000b870: 7020 3d20 532e 466c 6174 5370 6563 7472  p = S.FlatSpectr
+0000b880: 756d 2832 352c 2066 6c75 7875 6e69 7473  um(25, fluxunits
+0000b890: 3d27 4142 4d61 6727 290a 2020 2020 0a20  ='ABMag').    . 
+0000b8a0: 2020 2069 6620 6e70 2e69 7366 696e 6974     if np.isfinit
+0000b8b0: 6528 7261 6469 7573 293a 0a20 2020 2020  e(radius):.     
+0000b8c0: 2020 2062 7020 3d20 532e 4f62 7342 616e     bp = S.ObsBan
+0000b8d0: 6470 6173 7328 6f62 736d 6f64 652b 272c  dpass(obsmode+',
+0000b8e0: 6170 6572 237b 303a 2e32 667d 272e 666f  aper#{0:.2f}'.fo
+0000b8f0: 726d 6174 2872 6164 6975 7329 290a 2020  rmat(radius)).  
+0000b900: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000b910: 6270 203d 2053 2e4f 6273 4261 6e64 7061  bp = S.ObsBandpa
+0000b920: 7373 286f 6273 6d6f 6465 290a 0a20 2020  ss(obsmode)..   
+0000b930: 2023 2062 7020 3d20 532e 4f62 7342 616e   # bp = S.ObsBan
+0000b940: 6470 6173 7328 6f62 736d 6f64 652b 272c  dpass(obsmode+',
+0000b950: 6170 6572 237b 303a 2e32 667d 272e 666f  aper#{0:.2f}'.fo
+0000b960: 726d 6174 2872 6164 6975 7329 290a 2020  rmat(radius)).  
+0000b970: 2020 6f62 7320 3d20 532e 4f62 7365 7276    obs = S.Observ
+0000b980: 6174 696f 6e28 7370 2c20 6270 290a 2020  ation(sp, bp).  
+0000b990: 2020 5a50 203d 2032 3520 2b20 322e 352a    ZP = 25 + 2.5*
+0000b9a0: 6e70 2e6c 6f67 3130 286f 6273 2e63 6f75  np.log10(obs.cou
+0000b9b0: 6e74 7261 7465 2829 290a 2020 2020 7265  ntrate()).    re
+0000b9c0: 7475 726e 205a 500a 0a0a 6465 6620 7379  turn ZP...def sy
+0000b9d0: 6e70 686f 745f 656e 6369 7263 6c65 645f  nphot_encircled_
+0000b9e0: 656e 6572 6779 286f 6273 6d6f 6465 3d27  energy(obsmode='
+0000b9f0: 7766 6333 2c69 722c 6631 3630 7727 2c20  wfc3,ir,f160w', 
+0000ba00: 7370 3d27 6465 6661 756c 7427 2c20 6170  sp='default', ap
+0000ba10: 6572 5f72 6164 6969 3d45 455f 5241 4449  er_radii=EE_RADI
+0000ba20: 492c 206e 6f72 6d5f 7261 6469 7573 3d34  I, norm_radius=4
+0000ba30: 2e30 293a 0a20 2020 2022 2222 0a20 2020  .0):.    """.   
+0000ba40: 2043 6f6d 7075 7465 2065 6e63 6972 636c   Compute encircl
+0000ba50: 6564 2065 6e65 7267 7920 6375 7276 6573  ed energy curves
+0000ba60: 2077 6974 6820 7079 7379 6e70 686f 740a   with pysynphot.
+0000ba70: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
+0000ba80: 7274 2070 7973 796e 7068 6f74 2061 7320  rt pysynphot as 
+0000ba90: 530a 0a20 2020 2069 6620 7370 203d 3d20  S..    if sp == 
+0000baa0: 2764 6566 6175 6c74 273a 0a20 2020 2020  'default':.     
+0000bab0: 2020 2073 7020 3d20 532e 466c 6174 5370     sp = S.FlatSp
+0000bac0: 6563 7472 756d 2832 352c 2066 6c75 7875  ectrum(25, fluxu
+0000bad0: 6e69 7473 3d27 4142 4d61 6727 290a 0a20  nits='ABMag').. 
+0000bae0: 2020 2023 204e 6f72 6d61 6c69 7a61 7469     # Normalizati
+0000baf0: 6f6e 0a20 2020 2069 6620 6e70 2e69 7366  on.    if np.isf
+0000bb00: 696e 6974 6528 6e6f 726d 5f72 6164 6975  inite(norm_radiu
+0000bb10: 7329 3a0a 2020 2020 2020 2020 6270 203d  s):.        bp =
+0000bb20: 2053 2e4f 6273 4261 6e64 7061 7373 286f   S.ObsBandpass(o
+0000bb30: 6273 6d6f 6465 2b27 2c61 7065 7223 7b30  bsmode+',aper#{0
+0000bb40: 3a2e 3266 7d27 2e66 6f72 6d61 7428 6e6f  :.2f}'.format(no
+0000bb50: 726d 5f72 6164 6975 7329 290a 2020 2020  rm_radius)).    
+0000bb60: 656c 7365 3a0a 2020 2020 2020 2020 6270  else:.        bp
+0000bb70: 203d 2053 2e4f 6273 4261 6e64 7061 7373   = S.ObsBandpass
+0000bb80: 286f 6273 6d6f 6465 290a 0a20 2020 206f  (obsmode)..    o
+0000bb90: 6273 203d 2053 2e4f 6273 6572 7661 7469  bs = S.Observati
+0000bba0: 6f6e 2873 702c 2062 7029 0a20 2020 206e  on(sp, bp).    n
+0000bbb0: 6f72 6d5f 636f 756e 7473 203d 206f 6273  orm_counts = obs
 0000bbc0: 2e63 6f75 6e74 7261 7465 2829 0a0a 2020  .countrate()..  
-0000bbd0: 2020 7265 7475 726e 2063 6f75 6e74 7320    return counts 
-0000bbe0: 2f20 6e6f 726d 5f63 6f75 6e74 730a 0a0a  / norm_counts...
-0000bbf0: 6465 6620 7068 6f74 666e 755f 6672 6f6d  def photfnu_from
-0000bc00: 5f70 686f 7466 6c61 6d28 7068 6f74 666c  _photflam(photfl
-0000bc10: 616d 2c20 7068 6f74 706c 616d 293a 0a20  am, photplam):. 
-0000bc20: 2020 2022 2222 0a20 2020 2043 6f6d 7075     """.    Compu
-0000bc30: 7465 2050 484f 5446 4e55 2066 726f 6d20  te PHOTFNU from 
-0000bc40: 5048 4f54 464c 414d 2b50 484f 5450 4c41  PHOTFLAM+PHOTPLA
-0000bc50: 4d2c 2065 2e67 2e2c 2066 6f72 2041 4353  M, e.g., for ACS
-0000bc60: 2f57 4643 0a20 2020 2022 2222 0a20 2020  /WFC.    """.   
-0000bc70: 205a 5020 3d20 2d32 2e35 2a6e 702e 6c6f   ZP = -2.5*np.lo
-0000bc80: 6731 3028 7068 6f74 666c 616d 2920 2d20  g10(photflam) - 
-0000bc90: 3231 2e31 3020 2d20 352a 6e70 2e6c 6f67  21.10 - 5*np.log
-0000bca0: 3130 2870 686f 7470 6c61 6d29 202b 2031  10(photplam) + 1
-0000bcb0: 382e 3639 3231 0a20 2020 2070 686f 7466  8.6921.    photf
-0000bcc0: 6e75 203d 2031 302a 2a28 2d30 2e34 2a28  nu = 10**(-0.4*(
-0000bcd0: 5a50 2d32 332e 3929 292a 312e 652d 360a  ZP-23.9))*1.e-6.
-0000bce0: 2020 2020 7265 7475 726e 2070 686f 7466      return photf
-0000bcf0: 6e75 0a0a 0a64 6566 2063 616c 635f 6865  nu...def calc_he
-0000bd00: 6164 6572 5f7a 6572 6f70 6f69 6e74 2869  ader_zeropoint(i
-0000bd10: 6d2c 2065 7874 3d30 293a 0a20 2020 2022  m, ext=0):.    "
-0000bd20: 2222 0a20 2020 2044 6574 6572 6d69 6e65  "".    Determine
-0000bd30: 2041 4220 7a65 726f 706f 696e 7420 6672   AB zeropoint fr
-0000bd40: 6f6d 2069 6d61 6765 2068 6561 6465 720a  om image header.
-0000bd50: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-0000bd60: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-0000bd70: 2020 2069 6d20 3a20 607e 6173 7472 6f70     im : `~astrop
-0000bd80: 792e 696f 2e66 6974 732e 4844 554c 6973  y.io.fits.HDULis
-0000bd90: 7460 206f 720a 2020 2020 2020 2020 496d  t` or.        Im
-0000bda0: 6167 6520 6f62 6a65 6374 206f 7220 6865  age object or he
-0000bdb0: 6164 6572 2e0a 0a20 2020 2052 6574 7572  ader...    Retur
-0000bdc0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0000bdd0: 2020 205a 5020 3a20 666c 6f61 740a 2020     ZP : float.  
-0000bde0: 2020 2020 2020 4142 207a 6572 6f70 6f69        AB zeropoi
-0000bdf0: 6e74 0a0a 2020 2020 2222 220a 2020 2020  nt..    """.    
-0000be00: 6672 6f6d 202e 2069 6d70 6f72 7420 6d6f  from . import mo
-0000be10: 6465 6c0a 0a20 2020 2073 6361 6c65 5f65  del..    scale_e
-0000be20: 7870 7469 6d65 203d 2031 2e0a 0a20 2020  xptime = 1...   
-0000be30: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
-0000be40: 6d2c 2070 7966 6974 732e 4865 6164 6572  m, pyfits.Header
-0000be50: 293a 0a20 2020 2020 2020 2068 6561 6465  ):.        heade
-0000be60: 7220 3d20 696d 0a20 2020 2065 6c73 653a  r = im.    else:
-0000be70: 0a20 2020 2020 2020 2069 6620 275f 6472  .        if '_dr
-0000be80: 2720 696e 2069 6d2e 6669 6c65 6e61 6d65  ' in im.filename
-0000be90: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000bea0: 6578 7420 3d20 300a 2020 2020 2020 2020  ext = 0.        
-0000beb0: 656c 6966 2027 5f66 6c27 2069 6e20 696d  elif '_fl' in im
-0000bec0: 2e66 696c 656e 616d 6528 293a 0a20 2020  .filename():.   
-0000bed0: 2020 2020 2020 2020 2069 6620 2744 4554           if 'DET
-0000bee0: 4543 544f 5227 2069 6e20 696d 5b30 5d2e  ECTOR' in im[0].
-0000bef0: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
-0000bf00: 2020 2020 2020 2020 6966 2069 6d5b 305d          if im[0]
-0000bf10: 2e68 6561 6465 725b 2744 4554 4543 544f  .header['DETECTO
-0000bf20: 5227 5d20 3d3d 2027 4952 273a 0a20 2020  R'] == 'IR':.   
-0000bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf40: 2065 7874 203d 2030 0a20 2020 2020 2020   ext = 0.       
-0000bf50: 2020 2020 2020 2020 2020 2020 2062 756e               bun
-0000bf60: 6974 203d 2069 6d5b 315d 2e68 6561 6465  it = im[1].heade
-0000bf70: 725b 2742 554e 4954 275d 0a20 2020 2020  r['BUNIT'].     
-0000bf80: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000bf90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bfa0: 2020 2020 2023 2041 4353 202f 2055 5649       # ACS / UVI
-0000bfb0: 530a 2020 2020 2020 2020 2020 2020 2020  S.              
-0000bfc0: 2020 2020 2020 6966 2065 7874 203d 3d20        if ext == 
-0000bfd0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0000bfe0: 2020 2020 2020 2020 2020 2065 7874 203d             ext =
-0000bff0: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
-0000c000: 2020 2020 2020 2020 6275 6e69 7420 3d20          bunit = 
-0000c010: 696d 5b31 5d2e 6865 6164 6572 5b27 4255  im[1].header['BU
-0000c020: 4e49 5427 5d0a 0a20 2020 2020 2020 2020  NIT']..         
-0000c030: 2020 2020 2020 2069 6620 6275 6e69 7420         if bunit 
-0000c040: 3d3d 2027 454c 4543 5452 4f4e 5327 3a0a  == 'ELECTRONS':.
-0000c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c060: 2020 2020 7363 616c 655f 6578 7074 696d      scale_exptim
-0000c070: 6520 3d20 696d 5b30 5d2e 6865 6164 6572  e = im[0].header
-0000c080: 5b27 4558 5054 494d 4527 5d0a 0a20 2020  ['EXPTIME']..   
-0000c090: 2020 2020 2068 6561 6465 7220 3d20 696d       header = im
-0000c0a0: 5b65 7874 5d2e 6865 6164 6572 0a0a 2020  [ext].header..  
-0000c0b0: 2020 7472 793a 0a20 2020 2020 2020 2066    try:.        f
-0000c0c0: 6920 3d20 7061 7273 655f 6669 6c74 6572  i = parse_filter
-0000c0d0: 5f66 726f 6d5f 6865 6164 6572 2869 6d5b  _from_header(im[
-0000c0e0: 305d 2e68 6561 6465 7229 2e75 7070 6572  0].header).upper
-0000c0f0: 2829 0a20 2020 2065 7863 6570 743a 0a20  ().    except:. 
-0000c100: 2020 2020 2020 2066 6920 3d20 4e6f 6e65         fi = None
-0000c110: 0a0a 2020 2020 2320 4765 7420 4142 207a  ..    # Get AB z
-0000c120: 6572 6f70 6f69 6e74 0a20 2020 2069 6620  eropoint.    if 
-0000c130: 2741 505a 5027 2069 6e20 6865 6164 6572  'APZP' in header
-0000c140: 3a0a 2020 2020 2020 2020 5a50 203d 2068  :.        ZP = h
-0000c150: 6561 6465 725b 2741 425a 5027 5d0a 2020  eader['ABZP'].  
-0000c160: 2020 0a20 2020 2065 6c69 6620 2750 484f    .    elif 'PHO
-0000c170: 5446 4e55 2720 696e 2068 6561 6465 723a  TFNU' in header:
-0000c180: 0a20 2020 2020 2020 205a 5020 3d20 2d32  .        ZP = -2
-0000c190: 2e35 2a6e 702e 6c6f 6731 3028 6865 6164  .5*np.log10(head
-0000c1a0: 6572 5b27 5048 4f54 464e 5527 5d29 2b38  er['PHOTFNU'])+8
-0000c1b0: 2e39 300a 2020 2020 2020 2020 5a50 202b  .90.        ZP +
-0000c1c0: 3d20 322e 352a 6e70 2e6c 6f67 3130 2873  = 2.5*np.log10(s
-0000c1d0: 6361 6c65 5f65 7870 7469 6d65 290a 2020  cale_exptime).  
-0000c1e0: 2020 2020 2020 0a20 2020 2065 6c69 6620        .    elif 
-0000c1f0: 2750 484f 5446 4c41 4d27 2069 6e20 6865  'PHOTFLAM' in he
-0000c200: 6164 6572 3a0a 2020 2020 2020 2020 5a50  ader:.        ZP
-0000c210: 203d 2028 2d32 2e35 2a6e 702e 6c6f 6731   = (-2.5*np.log1
-0000c220: 3028 6865 6164 6572 5b27 5048 4f54 464c  0(header['PHOTFL
-0000c230: 414d 275d 2920 2d20 3231 2e31 3020 2d0a  AM']) - 21.10 -.
-0000c240: 2020 2020 2020 2020 2020 2020 2020 352a                5*
-0000c250: 6e70 2e6c 6f67 3130 2868 6561 6465 725b  np.log10(header[
-0000c260: 2750 484f 5450 4c41 4d27 5d29 202b 2031  'PHOTPLAM']) + 1
-0000c270: 382e 3639 3231 290a 0a20 2020 2020 2020  8.6921)..       
-0000c280: 205a 5020 2b3d 2032 2e35 2a6e 702e 6c6f   ZP += 2.5*np.lo
-0000c290: 6731 3028 7363 616c 655f 6578 7074 696d  g10(scale_exptim
-0000c2a0: 6529 0a20 2020 200a 2020 2020 656c 6966  e).    .    elif
-0000c2b0: 2028 6669 2069 7320 6e6f 7420 4e6f 6e65   (fi is not None
-0000c2c0: 293a 0a20 2020 2020 2020 2069 6620 6669  ):.        if fi
-0000c2d0: 2069 6e20 6d6f 6465 6c2e 7068 6f74 666c   in model.photfl
-0000c2e0: 616d 5f6c 6973 743a 0a20 2020 2020 2020  am_list:.       
-0000c2f0: 2020 2020 205a 5020 3d20 282d 322e 352a       ZP = (-2.5*
-0000c300: 6e70 2e6c 6f67 3130 286d 6f64 656c 2e70  np.log10(model.p
-0000c310: 686f 7466 6c61 6d5f 6c69 7374 5b66 695d  hotflam_list[fi]
-0000c320: 2920 2d20 3231 2e31 3020 2d0a 2020 2020  ) - 21.10 -.    
-0000c330: 2020 2020 2020 2020 2020 2020 2020 352a                5*
-0000c340: 6e70 2e6c 6f67 3130 286d 6f64 656c 2e70  np.log10(model.p
-0000c350: 686f 7470 6c61 6d5f 6c69 7374 5b66 695d  hotplam_list[fi]
-0000c360: 2920 2b20 3138 2e36 3932 3129 0a20 2020  ) + 18.6921).   
-0000c370: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000c380: 2020 2020 2020 2070 7269 6e74 2827 436f         print('Co
-0000c390: 756c 646e 5c27 7420 6669 6e64 2050 484f  uldn\'t find PHO
-0000c3a0: 5446 4e55 206f 7220 5048 4f54 504c 414d  TFNU or PHOTPLAM
-0000c3b0: 2f50 484f 5446 4c41 4d20 6b65 7977 6f72  /PHOTFLAM keywor
-0000c3c0: 6473 2c20 7573 6520 5a50 3d32 3527 290a  ds, use ZP=25').
-0000c3d0: 2020 2020 2020 2020 2020 2020 5a50 203d              ZP =
-0000c3e0: 2032 350a 2020 2020 656c 7365 3a0a 2020   25.    else:.  
-0000c3f0: 2020 2020 2020 7072 696e 7428 2743 6f75        print('Cou
-0000c400: 6c64 6e5c 2774 2066 696e 6420 4649 4c54  ldn\'t find FILT
-0000c410: 4552 2c20 5048 4f54 464e 5520 6f72 2050  ER, PHOTFNU or P
-0000c420: 484f 5450 4c41 4d2f 5048 4f54 464c 414d  HOTPLAM/PHOTFLAM
-0000c430: 206b 6579 776f 7264 732c 2075 7365 205a   keywords, use Z
-0000c440: 503d 3235 2729 0a20 2020 2020 2020 205a  P=25').        Z
-0000c450: 5020 3d20 3235 0a0a 2020 2020 2320 4966  P = 25..    # If
-0000c460: 207a 6572 6f70 6f69 6e74 2069 6e66 696e   zeropoint infin
-0000c470: 6974 6520 2865 2e67 2e2c 2050 484f 5446  ite (e.g., PHOTF
-0000c480: 4c41 4d20 3d20 3029 2c20 7468 656e 2063  LAM = 0), then c
-0000c490: 616c 6375 6c61 7465 2066 726f 6d20 7379  alculate from sy
-0000c4a0: 6e70 686f 740a 2020 2020 6966 206e 6f74  nphot.    if not
-0000c4b0: 206e 702e 6973 6669 6e69 7465 285a 5029   np.isfinite(ZP)
-0000c4c0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-0000c4d0: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
-0000c4e0: 7420 7079 7379 6e70 686f 7420 6173 2053  t pysynphot as S
-0000c4f0: 0a20 2020 2020 2020 2020 2020 2062 7020  .            bp 
-0000c500: 3d20 532e 4f62 7342 616e 6470 6173 7328  = S.ObsBandpass(
-0000c510: 696d 5b30 5d2e 6865 6164 6572 5b27 5048  im[0].header['PH
-0000c520: 4f54 4d4f 4445 275d 2e72 6570 6c61 6365  OTMODE'].replace
-0000c530: 2827 2027 2c20 272c 2729 290a 2020 2020  (' ', ',')).    
-0000c540: 2020 2020 2020 2020 7370 6563 203d 2053          spec = S
-0000c550: 2e46 6c61 7453 7065 6374 7275 6d28 302c  .FlatSpectrum(0,
-0000c560: 2066 6c75 7875 6e69 7473 3d27 4142 4d61   fluxunits='ABMa
-0000c570: 6727 290a 2020 2020 2020 2020 2020 2020  g').            
-0000c580: 6f62 7320 3d20 532e 4f62 7365 7276 6174  obs = S.Observat
-0000c590: 696f 6e28 7370 6563 2c20 6270 290a 2020  ion(spec, bp).  
-0000c5a0: 2020 2020 2020 2020 2020 5a50 203d 2032            ZP = 2
-0000c5b0: 2e35 2a6e 702e 6c6f 6731 3028 6f62 732e  .5*np.log10(obs.
-0000c5c0: 636f 756e 7472 6174 6528 2929 0a20 2020  countrate()).   
-0000c5d0: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-0000c5e0: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
-0000c5f0: 2020 2072 6574 7572 6e20 5a50 0a0a 0a44     return ZP...D
-0000c600: 4546 4155 4c54 5f50 5249 4d41 5259 5f4b  EFAULT_PRIMARY_K
-0000c610: 4559 5320 3d20 5b27 4649 4c45 4e41 4d45  EYS = ['FILENAME
-0000c620: 272c 2027 494e 5354 5255 4d45 272c 2027  ', 'INSTRUME', '
-0000c630: 494e 5354 5255 4d45 272c 2027 4445 5445  INSTRUME', 'DETE
-0000c640: 4354 4f52 272c 2027 4649 4c54 4552 272c  CTOR', 'FILTER',
-0000c650: 2027 4649 4c54 4552 3127 2c20 2746 494c   'FILTER1', 'FIL
-0000c660: 5445 5232 272c 2027 4558 5053 5441 5254  TER2', 'EXPSTART
-0000c670: 272c 2027 4441 5445 2d4f 4253 272c 2027  ', 'DATE-OBS', '
-0000c680: 4558 5054 494d 4527 2c20 2749 4443 5441  EXPTIME', 'IDCTA
-0000c690: 4227 2c20 274e 504f 4c46 494c 4527 2c20  B', 'NPOLFILE', 
-0000c6a0: 2744 3249 4d46 494c 4527 2c20 2750 415f  'D2IMFILE', 'PA_
-0000c6b0: 5633 272c 2027 4647 534c 4f43 4b27 2c20  V3', 'FGSLOCK', 
-0000c6c0: 2747 5952 4f4d 4f44 4527 2c20 2750 524f  'GYROMODE', 'PRO
-0000c6d0: 504f 5349 4427 5d0a 0a23 2046 6f72 2067  POSID']..# For g
-0000c6e0: 7269 736d 0a44 4546 4155 4c54 5f45 5854  rism.DEFAULT_EXT
-0000c6f0: 5f4b 4559 5320 3d20 5b27 4558 544e 414d  _KEYS = ['EXTNAM
-0000c700: 4527 2c20 2745 5854 5645 5227 2c20 274d  E', 'EXTVER', 'M
-0000c710: 4452 495a 534b 5927 2c20 2743 5250 4958  DRIZSKY', 'CRPIX
-0000c720: 3127 2c20 2743 5250 4958 3227 2c20 2743  1', 'CRPIX2', 'C
-0000c730: 5256 414c 3127 2c20 2743 5256 414c 3227  RVAL1', 'CRVAL2'
-0000c740: 2c20 2743 4431 5f31 272c 2027 4344 315f  , 'CD1_1', 'CD1_
-0000c750: 3227 2c20 2743 4432 5f31 272c 2027 4344  2', 'CD2_1', 'CD
-0000c760: 325f 3227 2c20 2750 4331 5f31 272c 2027  2_2', 'PC1_1', '
-0000c770: 5043 315f 3227 2c20 2750 4332 5f31 272c  PC1_2', 'PC2_1',
-0000c780: 2027 5043 325f 3227 2c20 2743 4445 4c54   'PC2_2', 'CDELT
-0000c790: 3127 2c20 2743 4445 4c54 3227 2c20 2743  1', 'CDELT2', 'C
-0000c7a0: 554e 4954 3127 2c20 2743 554e 4954 3227  UNIT1', 'CUNIT2'
-0000c7b0: 2c20 2743 5459 5045 3127 2c20 2743 5459  , 'CTYPE1', 'CTY
-0000c7c0: 5045 3227 2c20 2752 4144 4553 5953 272c  PE2', 'RADESYS',
-0000c7d0: 2027 4c4f 4e50 4f4c 4527 2c20 274c 4154   'LONPOLE', 'LAT
-0000c7e0: 504f 4c45 272c 2027 4944 4354 4142 272c  POLE', 'IDCTAB',
-0000c7f0: 2027 4432 494d 4558 5427 2c20 2757 4353   'D2IMEXT', 'WCS
-0000c800: 4e41 4d45 272c 2027 5048 4f54 4d4f 4445  NAME', 'PHOTMODE
-0000c810: 272c 2027 4f52 4945 4e54 4154 272c 2027  ', 'ORIENTAT', '
-0000c820: 4343 4443 4849 5027 5d0a 0a0a 6465 6620  CCDCHIP']...def 
-0000c830: 666c 745f 746f 5f64 6963 7428 666f 626a  flt_to_dict(fobj
-0000c840: 2c20 7072 696d 6172 795f 6b65 7973 3d44  , primary_keys=D
-0000c850: 4546 4155 4c54 5f50 5249 4d41 5259 5f4b  EFAULT_PRIMARY_K
-0000c860: 4559 532c 2065 7874 656e 7369 6f6e 733d  EYS, extensions=
-0000c870: 5b28 2753 4349 272c 2069 2b31 2920 666f  [('SCI', i+1) fo
-0000c880: 7220 6920 696e 2072 616e 6765 2832 295d  r i in range(2)]
-0000c890: 2c20 6578 745f 6b65 7973 3d44 4546 4155  , ext_keys=DEFAU
-0000c8a0: 4c54 5f45 5854 5f4b 4559 5329 3a0a 2020  LT_EXT_KEYS):.  
-0000c8b0: 2020 2222 220a 2020 2020 5061 7273 6520    """.    Parse 
-0000c8c0: 6261 7369 6320 656c 656d 656e 7473 2066  basic elements f
-0000c8d0: 726f 6d20 6120 464c 542f 464c 4320 6865  rom a FLT/FLC he
-0000c8e0: 6164 6572 2074 6f20 6120 6469 6374 696f  ader to a dictio
-0000c8f0: 6e61 7279 0a0a 2020 2020 5442 440a 0a20  nary..    TBD.. 
-0000c900: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0000c910: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0000c920: 2066 6f62 6a20 3a20 607e 6173 7472 6f70   fobj : `~astrop
-0000c930: 792e 696f 2e66 6974 732e 4844 554c 6973  y.io.fits.HDULis
-0000c940: 7460 0a20 2020 2020 2020 2046 4954 5320  t`.        FITS 
-0000c950: 6f62 6a65 6374 0a0a 2020 2020 7072 696d  object..    prim
-0000c960: 6172 795f 6b65 7973 203a 206c 6973 740a  ary_keys : list.
-0000c970: 2020 2020 2020 2020 4b65 7977 6f72 6473          Keywords
-0000c980: 2074 6f20 6578 7472 6163 7420 6672 6f6d   to extract from
-0000c990: 2074 6865 2070 7269 6d61 7279 2065 7874   the primary ext
-0000c9a0: 656e 7369 6f6e 2028 3029 2e0a 0a20 2020  ension (0)...   
-0000c9b0: 2065 7874 656e 7369 6f6e 7320 3a20 6c69   extensions : li
-0000c9c0: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
-0000c9d0: 6f66 2061 6464 6974 696f 6e61 6c20 6578  of additional ex
-0000c9e0: 7465 6e73 696f 6e20 6e61 6d65 7320 2f20  tension names / 
-0000c9f0: 696e 6469 6365 732e 0a0a 2020 2020 6578  indices...    ex
-0000ca00: 745f 6b65 7973 203a 206c 6973 740a 2020  t_keys : list.  
-0000ca10: 2020 2020 2020 4b65 7977 6f72 6473 2074        Keywords t
-0000ca20: 6f20 6578 7472 6163 7420 6672 6f6d 2074  o extract from t
-0000ca30: 6865 2065 7874 656e 7369 6f6e 2068 6561  he extension hea
-0000ca40: 6465 7273 2e0a 0a20 2020 2052 6574 7572  ders...    Retur
-0000ca50: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0000ca60: 2020 2066 6c74 5f64 6963 7420 3a20 6469     flt_dict : di
-0000ca70: 6374 0a0a 2020 2020 2222 220a 2020 2020  ct..    """.    
-0000ca80: 696d 706f 7274 2061 7374 726f 7079 2e74  import astropy.t
-0000ca90: 696d 650a 0a20 2020 2066 6c74 5f64 6963  ime..    flt_dic
-0000caa0: 7420 3d20 4f72 6465 7265 6444 6963 7428  t = OrderedDict(
-0000cab0: 290a 2020 2020 666c 745f 6469 6374 5b27  ).    flt_dict['
-0000cac0: 7469 6d65 7374 616d 7027 5d20 3d20 6173  timestamp'] = as
-0000cad0: 7472 6f70 792e 7469 6d65 2e54 696d 652e  tropy.time.Time.
-0000cae0: 6e6f 7728 292e 6973 6f0a 2020 2020 6830  now().iso.    h0
-0000caf0: 203d 2066 6f62 6a5b 305d 2e68 6561 6465   = fobj[0].heade
-0000cb00: 720a 0a20 2020 2023 2050 7269 6d61 7279  r..    # Primary
-0000cb10: 206b 6579 776f 7264 730a 2020 2020 666f   keywords.    fo
-0000cb20: 7220 6b20 696e 2070 7269 6d61 7279 5f6b  r k in primary_k
-0000cb30: 6579 733a 0a20 2020 2020 2020 2069 6620  eys:.        if 
-0000cb40: 6b20 696e 2068 303a 0a20 2020 2020 2020  k in h0:.       
-0000cb50: 2020 2020 2066 6c74 5f64 6963 745b 6b5d       flt_dict[k]
-0000cb60: 203d 2068 305b 6b5d 0a0a 2020 2020 2320   = h0[k]..    # 
-0000cb70: 4772 6973 6d20 6b65 7973 0a20 2020 2066  Grism keys.    f
-0000cb80: 6f72 206b 2069 6e20 6830 3a0a 2020 2020  or k in h0:.    
-0000cb90: 2020 2020 6966 206b 2e73 7461 7274 7377      if k.startsw
-0000cba0: 6974 6828 2747 534b 5927 293a 0a20 2020  ith('GSKY'):.   
-0000cbb0: 2020 2020 2020 2020 2066 6c74 5f64 6963           flt_dic
-0000cbc0: 745b 6b5d 203d 2068 305b 6b5d 0a0a 2020  t[k] = h0[k]..  
-0000cbd0: 2020 2320 5743 532c 2065 7463 2e20 6b65    # WCS, etc. ke
-0000cbe0: 7977 6f72 6473 2066 726f 6d20 5343 4920  ywords from SCI 
-0000cbf0: 6578 7465 6e73 696f 6e73 0a20 2020 2066  extensions.    f
-0000cc00: 6c74 5f64 6963 745b 2765 7874 656e 7369  lt_dict['extensi
-0000cc10: 6f6e 7327 5d20 3d20 4f72 6465 7265 6444  ons'] = OrderedD
-0000cc20: 6963 7428 290a 2020 2020 636f 756e 7420  ict().    count 
-0000cc30: 3d20 300a 2020 2020 666f 7220 6578 7420  = 0.    for ext 
-0000cc40: 696e 2065 7874 656e 7369 6f6e 733a 0a20  in extensions:. 
-0000cc50: 2020 2020 2020 2069 6620 6578 7420 696e         if ext in
-0000cc60: 2066 6f62 6a3a 0a20 2020 2020 2020 2020   fobj:.         
-0000cc70: 2020 2064 5f69 203d 204f 7264 6572 6564     d_i = Ordered
-0000cc80: 4469 6374 2829 0a20 2020 2020 2020 2020  Dict().         
-0000cc90: 2020 2068 5f69 203d 2066 6f62 6a5b 6578     h_i = fobj[ex
-0000cca0: 745d 2e68 6561 6465 720a 2020 2020 2020  t].header.      
-0000ccb0: 2020 2020 2020 666f 7220 6b20 696e 2065        for k in e
-0000ccc0: 7874 5f6b 6579 733a 0a20 2020 2020 2020  xt_keys:.       
-0000ccd0: 2020 2020 2020 2020 2069 6620 6b20 696e           if k in
-0000cce0: 2068 5f69 3a0a 2020 2020 2020 2020 2020   h_i:.          
-0000ccf0: 2020 2020 2020 2020 2020 645f 695b 6b5d            d_i[k]
-0000cd00: 203d 2068 5f69 5b6b 5d0a 0a20 2020 2020   = h_i[k]..     
-0000cd10: 2020 2020 2020 2023 2047 7269 736d 206b         # Grism k
-0000cd20: 6579 730a 2020 2020 2020 2020 2020 2020  eys.            
-0000cd30: 666f 7220 6b20 696e 2068 5f69 3a0a 2020  for k in h_i:.  
-0000cd40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000cd50: 206b 2e73 7461 7274 7377 6974 6828 2747   k.startswith('G
-0000cd60: 534b 5927 293a 0a20 2020 2020 2020 2020  SKY'):.         
-0000cd70: 2020 2020 2020 2020 2020 2064 5f69 5b6b             d_i[k
-0000cd80: 5d20 3d20 685f 695b 6b5d 0a0a 2020 2020  ] = h_i[k]..    
-0000cd90: 2020 2020 2020 2020 636f 756e 7420 2b3d          count +=
-0000cda0: 2031 0a20 2020 2020 2020 2020 2020 2066   1.            f
-0000cdb0: 6c74 5f64 6963 745b 2765 7874 656e 7369  lt_dict['extensi
-0000cdc0: 6f6e 7327 5d5b 636f 756e 745d 203d 2064  ons'][count] = d
-0000cdd0: 5f69 0a0a 2020 2020 7265 7475 726e 2066  _i..    return f
-0000cde0: 6c74 5f64 6963 740a 0a0a 6465 6620 6765  lt_dict...def ge
-0000cdf0: 745f 7365 745f 6269 7473 2876 616c 7565  t_set_bits(value
-0000ce00: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
-0000ce10: 6f6d 7075 7465 2077 6869 6368 2062 696e  ompute which bin
-0000ce20: 6172 7920 6269 7473 2061 7265 2073 6574  ary bits are set
-0000ce30: 2066 6f72 2061 6e20 696e 7465 6765 720a   for an integer.
-0000ce40: 2020 2020 2222 220a 0a20 2020 2069 6620      """..    if 
-0000ce50: 6861 7361 7474 7228 7661 6c75 652c 2027  hasattr(value, '
-0000ce60: 5f5f 6974 6572 5f5f 2729 3a0a 2020 2020  __iter__'):.    
-0000ce70: 2020 2020 7661 6c75 6573 203d 2076 616c      values = val
-0000ce80: 7565 0a20 2020 2020 2020 2073 696e 676c  ue.        singl
-0000ce90: 6520 3d20 4661 6c73 650a 2020 2020 656c  e = False.    el
-0000cea0: 7365 3a0a 2020 2020 2020 2020 7661 6c75  se:.        valu
-0000ceb0: 6573 203d 205b 7661 6c75 655d 0a20 2020  es = [value].   
-0000cec0: 2020 2020 2073 696e 676c 6520 3d20 5472       single = Tr
-0000ced0: 7565 0a0a 2020 2020 7265 7375 6c74 203d  ue..    result =
-0000cee0: 205b 5d0a 0a20 2020 2066 6f72 2076 2069   []..    for v i
-0000cef0: 6e20 7661 6c75 6573 3a0a 2020 2020 2020  n values:.      
-0000cf00: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000cf10: 2020 2062 6974 7374 7220 3d20 6e70 2e62     bitstr = np.b
-0000cf20: 696e 6172 795f 7265 7072 2876 295b 3a3a  inary_repr(v)[::
-0000cf30: 2d31 5d0a 2020 2020 2020 2020 6578 6365  -1].        exce
-0000cf40: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0000cf50: 7265 7375 6c74 2e61 7070 656e 6428 5b5d  result.append([]
-0000cf60: 290a 0a20 2020 2020 2020 206e 7365 7420  )..        nset 
-0000cf70: 3d20 6269 7473 7472 2e63 6f75 6e74 2827  = bitstr.count('
-0000cf80: 3127 290a 2020 2020 2020 2020 7365 7462  1').        setb
-0000cf90: 6974 7320 3d20 5b5d 0a0a 2020 2020 2020  its = []..      
-0000cfa0: 2020 6a20 3d20 2d31 0a20 2020 2020 2020    j = -1.       
-0000cfb0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0000cfc0: 6e73 6574 293a 0a20 2020 2020 2020 2020  nset):.         
-0000cfd0: 2020 206a 203d 2062 6974 7374 722e 696e     j = bitstr.in
-0000cfe0: 6465 7828 2731 272c 206a 2b31 290a 2020  dex('1', j+1).  
-0000cff0: 2020 2020 2020 2020 2020 7365 7462 6974            setbit
-0000d000: 732e 6170 7065 6e64 286a 290a 0a20 2020  s.append(j)..   
-0000d010: 2020 2020 2072 6573 756c 742e 6170 7065       result.appe
-0000d020: 6e64 2873 6574 6269 7473 290a 0a20 2020  nd(setbits)..   
-0000d030: 2069 6620 7369 6e67 6c65 3a0a 2020 2020   if single:.    
-0000d040: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0000d050: 745b 305d 0a20 2020 2065 6c73 653a 0a20  t[0].    else:. 
-0000d060: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0000d070: 7375 6c74 0a0a 0a64 6566 2075 6e73 6574  sult...def unset
-0000d080: 5f64 715f 6269 7473 2876 616c 7565 2c20  _dq_bits(value, 
-0000d090: 6f6b 6269 7473 3d33 322b 3634 2b35 3132  okbits=32+64+512
-0000d0a0: 2c20 7665 7262 6f73 653d 4661 6c73 6529  , verbose=False)
-0000d0b0: 3a0a 2020 2020 2222 220a 2020 2020 556e  :.    """.    Un
-0000d0c0: 7365 7420 6269 7420 666c 6167 7320 6672  set bit flags fr
-0000d0d0: 6f6d 2061 2044 5120 6172 7261 790a 0a20  om a DQ array.. 
-0000d0e0: 2020 2046 6f72 2057 4643 332f 4952 2c20     For WFC3/IR, 
-0000d0f0: 7468 6520 666f 6c6c 6f77 696e 6720 4451  the following DQ
-0000d100: 2062 6974 7320 6361 6e20 7573 7561 6c6c   bits can usuall
-0000d110: 7920 6265 2075 6e73 6574 3a0a 0a20 2020  y be unset:..   
-0000d120: 2033 322c 2036 343a 2074 6865 7365 2070   32, 64: these p
-0000d130: 6978 656c 7320 7573 7561 6c6c 7920 7365  ixels usually se
-0000d140: 656d 204f 4b0a 2020 2020 2020 2035 3132  em OK.       512
-0000d150: 3a20 626c 6f62 7320 6e6f 7420 7265 6c65  : blobs not rele
-0000d160: 7661 6e74 2066 6f72 2067 7269 736d 2065  vant for grism e
-0000d170: 7870 6f73 7572 6573 0a0a 2020 2020 5061  xposures..    Pa
-0000d180: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0000d190: 2d2d 2d2d 2d2d 2d0a 2020 2020 7661 6c75  -------.    valu
-0000d1a0: 6520 3a20 696e 742c 2060 7e6e 756d 7079  e : int, `~numpy
-0000d1b0: 2e6e 6461 7272 6179 600a 2020 2020 2020  .ndarray`.      
-0000d1c0: 2020 496e 7075 7420 4451 2076 616c 7565    Input DQ value
-0000d1d0: 0a0a 2020 2020 6f6b 6269 7473 203a 2069  ..    okbits : i
-0000d1e0: 6e74 0a20 2020 2020 2020 2042 6974 7320  nt.        Bits 
-0000d1f0: 746f 2075 6e73 6574 0a0a 2020 2020 7665  to unset..    ve
-0000d200: 7262 6f73 6520 3a20 626f 6f6c 0a20 2020  rbose : bool.   
-0000d210: 2020 2020 2050 7269 6e74 2073 6f6d 6520       Print some 
-0000d220: 696e 666f 726d 6174 696f 6e0a 0a20 2020  information..   
-0000d230: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-0000d240: 2d2d 2d2d 0a20 2020 206e 6577 5f76 616c  ----.    new_val
-0000d250: 7565 203a 2069 6e74 2c20 607e 6e75 6d70  ue : int, `~nump
-0000d260: 792e 6e64 6172 7261 7960 0a0a 2020 2020  y.ndarray`..    
-0000d270: 2222 220a 2020 2020 6269 6e5f 6269 7473  """.    bin_bits
-0000d280: 203d 206e 702e 6269 6e61 7279 5f72 6570   = np.binary_rep
-0000d290: 7228 6f6b 6269 7473 290a 2020 2020 6e20  r(okbits).    n 
-0000d2a0: 3d20 6c65 6e28 6269 6e5f 6269 7473 290a  = len(bin_bits).
-0000d2b0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0000d2c0: 6765 286e 293a 0a20 2020 2020 2020 2069  ge(n):.        i
-0000d2d0: 6620 6269 6e5f 6269 7473 5b2d 2869 2b31  f bin_bits[-(i+1
-0000d2e0: 295d 203d 3d20 2731 273a 0a20 2020 2020  )] == '1':.     
-0000d2f0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-0000d300: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000d310: 2020 2070 7269 6e74 2832 2a2a 6929 0a0a     print(2**i)..
-0000d320: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-0000d330: 6520 2d3d 2028 7661 6c75 6520 2620 322a  e -= (value & 2*
-0000d340: 2a69 290a 0a20 2020 2072 6574 7572 6e20  *i)..    return 
-0000d350: 7661 6c75 650a 0a0a 6465 6620 6465 7465  value...def dete
-0000d360: 6374 5f77 6974 685f 7068 6f74 7574 696c  ct_with_photutil
-0000d370: 7328 7363 692c 2065 7272 3d4e 6f6e 652c  s(sci, err=None,
-0000d380: 2064 713d 4e6f 6e65 2c20 7365 673d 4e6f   dq=None, seg=No
-0000d390: 6e65 2c20 6465 7465 6374 5f74 6872 6573  ne, detect_thres
-0000d3a0: 683d 322e 2c0a 2020 2020 2020 2020 2020  h=2.,.          
-0000d3b0: 2020 2020 2020 2020 2020 2020 2020 6e70                np
-0000d3c0: 6978 656c 733d 382c 2067 726f 775f 7365  ixels=8, grow_se
-0000d3d0: 673d 352c 2067 6175 7373 5f66 7768 6d3d  g=5, gauss_fwhm=
-0000d3e0: 322e 2c20 6773 697a 653d 332c 0a20 2020  2., gsize=3,.   
-0000d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d400: 2020 2020 2077 6373 3d4e 6f6e 652c 2073       wcs=None, s
-0000d410: 6176 655f 6465 7465 6374 696f 6e3d 4661  ave_detection=Fa
-0000d420: 6c73 652c 2072 6f6f 743d 276d 7963 6174  lse, root='mycat
-0000d430: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0000d440: 2020 2020 2020 2020 2020 2062 6163 6b67             backg
-0000d450: 726f 756e 643d 4e6f 6e65 2c20 6761 696e  round=None, gain
-0000d460: 3d4e 6f6e 652c 2041 425f 7a65 726f 706f  =None, AB_zeropo
-0000d470: 696e 743d 302e 2c0a 2020 2020 2020 2020  int=0.,.        
-0000d480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d490: 7265 6e61 6d65 5f63 6f6c 756d 6e73 3d7b  rename_columns={
-0000d4a0: 2778 6365 6e74 726f 6964 273a 2027 785f  'xcentroid': 'x_
-0000d4b0: 666c 7427 2c0a 2020 2020 2020 2020 2020  flt',.          
-0000d4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4e0: 2779 6365 6e74 726f 6964 273a 2027 795f  'ycentroid': 'y_
-0000d4f0: 666c 7427 2c0a 2020 2020 2020 2020 2020  flt',.          
-0000d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d520: 2772 615f 6963 7273 5f63 656e 7472 6f69  'ra_icrs_centroi
-0000d530: 6427 3a20 2772 6127 2c0a 2020 2020 2020  d': 'ra',.      
-0000d540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d560: 2020 2020 2764 6563 5f69 6372 735f 6365      'dec_icrs_ce
-0000d570: 6e74 726f 6964 273a 2027 6465 6327 7d2c  ntroid': 'dec'},
-0000d580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d590: 2020 2020 2020 2020 206f 7665 7277 7269           overwri
-0000d5a0: 7465 3d54 7275 652c 2076 6572 626f 7365  te=True, verbose
-0000d5b0: 3d54 7275 6529 3a0a 2020 2020 2222 220a  =True):.    """.
-0000d5c0: 2020 2020 5573 6520 607e 7068 6f74 7574      Use `~photut
-0000d5d0: 696c 7360 2074 6f20 6465 7465 6374 206f  ils` to detect o
-0000d5e0: 626a 6563 7473 2061 6e64 206d 616b 6520  bjects and make 
-0000d5f0: 7365 676d 656e 7461 7469 6f6e 206d 6170  segmentation map
-0000d600: 0a20 2020 200a 2020 2020 2e2e 206e 6f74  .    .    .. not
-0000d610: 653a 3a20 0a20 2020 2020 2020 2044 6570  e:: .        Dep
-0000d620: 7265 6361 7465 6420 696e 2066 6176 6f72  recated in favor
-0000d630: 206f 6620 7365 7020 6361 7461 6c6f 6773   of sep catalogs
-0000d640: 2069 6e20 607e 6772 697a 6c69 2e70 7265   in `~grizli.pre
-0000d650: 7060 2e0a 2020 2020 0a20 2020 2050 6172  p`..    .    Par
-0000d660: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-0000d670: 2d2d 2d2d 2d2d 0a20 2020 2073 6369 203a  ------.    sci :
-0000d680: 2060 7e6e 756d 7079 2e6e 6461 7272 6179   `~numpy.ndarray
-0000d690: 600a 2020 2020 2020 2020 5442 440a 0a20  `.        TBD.. 
-0000d6a0: 2020 2065 7272 2c20 6471 2c20 7365 6720     err, dq, seg 
-0000d6b0: 3a20 5442 440a 0a20 2020 2064 6574 6563  : TBD..    detec
-0000d6c0: 745f 7468 7265 7368 203a 2066 6c6f 6174  t_thresh : float
-0000d6d0: 0a20 2020 2020 2020 2044 6574 6563 7469  .        Detecti
-0000d6e0: 6f6e 2074 6872 6573 686f 6c64 2c20 696e  on threshold, in
-0000d6f0: 203a 6d61 7468 3a60 5c73 6967 6d61 600a   :math:`\sigma`.
-0000d700: 0a20 2020 2067 726f 775f 7365 6720 3a20  .    grow_seg : 
-0000d710: 696e 740a 2020 2020 2020 2020 4e75 6d62  int.        Numb
-0000d720: 6572 206f 6620 7069 7865 6c73 2074 6f20  er of pixels to 
-0000d730: 6772 6f77 2061 726f 756e 6420 7468 6520  grow around the 
-0000d740: 7065 7269 6d65 7465 7220 6f66 2064 6574  perimeter of det
-0000d750: 6563 7465 6420 6f62 6a65 6374 730a 2020  ected objects.  
-0000d760: 2020 2020 2020 7769 7468 6120 206d 6178        witha  max
-0000d770: 696d 756d 2066 696c 7465 720a 0a20 2020  imum filter..   
-0000d780: 2067 6175 7373 5f66 7768 6d20 3a20 666c   gauss_fwhm : fl
-0000d790: 6f61 740a 2020 2020 2020 2020 4657 484d  oat.        FWHM
-0000d7a0: 206f 6620 4761 7573 7369 616e 2063 6f6e   of Gaussian con
-0000d7b0: 766f 6c75 7469 6f6e 206b 6572 6e65 6c20  volution kernel 
-0000d7c0: 7468 6174 2073 6d6f 6f74 6865 7320 7468  that smoothes th
-0000d7d0: 6520 6465 7465 6374 696f 6e0a 2020 2020  e detection.    
-0000d7e0: 2020 2020 696d 6167 652e 0a0a 2020 2020      image...    
-0000d7f0: 7665 7262 6f73 6520 3a20 626f 6f6c 0a20  verbose : bool. 
-0000d800: 2020 2020 2020 2050 7269 6e74 206c 6f67         Print log
-0000d810: 6769 6e67 2069 6e66 6f72 6d61 7469 6f6e  ging information
-0000d820: 2074 6f20 7468 6520 7465 726d 696e 616c   to the terminal
-0000d830: 0a0a 2020 2020 7361 7665 5f64 6574 6563  ..    save_detec
-0000d840: 7469 6f6e 203a 2062 6f6f 6c0a 2020 2020  tion : bool.    
-0000d850: 2020 2020 5361 7665 2074 6865 2064 6574      Save the det
-0000d860: 6563 7469 6f6e 2069 6d61 6765 7320 616e  ection images an
-0000d870: 6420 6361 7461 6c6f 6773 0a0a 2020 2020  d catalogs..    
-0000d880: 7763 7320 3a20 607e 6173 7472 6f70 792e  wcs : `~astropy.
-0000d890: 7763 732e 5743 5360 0a20 2020 2020 2020  wcs.WCS`.       
-0000d8a0: 2057 4353 206f 626a 6563 7420 7061 7373   WCS object pass
-0000d8b0: 6564 2074 6f20 6070 686f 7475 7469 6c73  ed to `photutils
-0000d8c0: 2e73 6f75 7263 655f 7072 6f70 6572 7469  .source_properti
-0000d8d0: 6573 6020 7573 6564 2074 6f20 636f 6d70  es` used to comp
-0000d8e0: 7574 650a 2020 2020 2020 2020 736b 7920  ute.        sky 
-0000d8f0: 636f 6f72 6469 6e61 7465 7320 6f66 2064  coordinates of d
-0000d900: 6574 6563 7465 6420 6f62 6a65 6374 732e  etected objects.
-0000d910: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-0000d920: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6361    -------.    ca
-0000d930: 7461 6c6f 6720 3a20 607e 6173 7472 6f70  talog : `~astrop
-0000d940: 792e 7461 626c 652e 5461 626c 6560 0a20  y.table.Table`. 
-0000d950: 2020 2020 2020 204f 626a 6563 7420 6361         Object ca
-0000d960: 7461 6c6f 6720 7769 7468 2074 6865 2064  talog with the d
-0000d970: 6566 6175 6c74 2070 6172 616d 6574 6572  efault parameter
-0000d980: 732e 0a20 2020 2022 2222 0a20 2020 2069  s..    """.    i
-0000d990: 6d70 6f72 7420 7363 6970 792e 6e64 696d  mport scipy.ndim
-0000d9a0: 6167 6520 6173 206e 640a 0a20 2020 2066  age as nd..    f
-0000d9b0: 726f 6d20 7068 6f74 7574 696c 7320 696d  rom photutils im
-0000d9c0: 706f 7274 2064 6574 6563 745f 7468 7265  port detect_thre
-0000d9d0: 7368 6f6c 642c 2064 6574 6563 745f 736f  shold, detect_so
-0000d9e0: 7572 6365 732c 2053 6567 6d65 6e74 6174  urces, Segmentat
-0000d9f0: 696f 6e49 6d61 6765 0a20 2020 2066 726f  ionImage.    fro
-0000da00: 6d20 7068 6f74 7574 696c 7320 696d 706f  m photutils impo
-0000da10: 7274 2073 6f75 7263 655f 7072 6f70 6572  rt source_proper
-0000da20: 7469 6573 0a0a 2020 2020 696d 706f 7274  ties..    import
-0000da30: 2061 7374 726f 7079 2e69 6f2e 6669 7473   astropy.io.fits
-0000da40: 2061 7320 7079 6669 7473 0a20 2020 2066   as pyfits.    f
-0000da50: 726f 6d20 6173 7472 6f70 792e 7461 626c  rom astropy.tabl
-0000da60: 6520 696d 706f 7274 2043 6f6c 756d 6e0a  e import Column.
-0000da70: 0a20 2020 2066 726f 6d20 6173 7472 6f70  .    from astrop
-0000da80: 792e 7374 6174 7320 696d 706f 7274 2073  y.stats import s
-0000da90: 6967 6d61 5f63 6c69 7070 6564 5f73 7461  igma_clipped_sta
-0000daa0: 7473 2c20 6761 7573 7369 616e 5f66 7768  ts, gaussian_fwh
-0000dab0: 6d5f 746f 5f73 6967 6d61 0a20 2020 2066  m_to_sigma.    f
-0000dac0: 726f 6d20 6173 7472 6f70 792e 636f 6e76  rom astropy.conv
-0000dad0: 6f6c 7574 696f 6e20 696d 706f 7274 2047  olution import G
-0000dae0: 6175 7373 6961 6e32 444b 6572 6e65 6c0a  aussian2DKernel.
-0000daf0: 0a20 2020 2023 2044 5120 6d61 736b 730a  .    # DQ masks.
-0000db00: 2020 2020 6d61 736b 203d 2028 7363 6920      mask = (sci 
-0000db10: 3d3d 2030 290a 2020 2020 6966 2064 7120  == 0).    if dq 
-0000db20: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000db30: 2020 2020 206d 6173 6b20 7c3d 2064 7120       mask |= dq 
-0000db40: 3e20 300a 0a20 2020 2023 2044 6574 6563  > 0..    # Detec
-0000db50: 7469 6f6e 2074 6872 6573 686f 6c64 0a20  tion threshold. 
-0000db60: 2020 2069 6620 6572 7220 6973 204e 6f6e     if err is Non
-0000db70: 653a 0a20 2020 2020 2020 2074 6872 6573  e:.        thres
-0000db80: 686f 6c64 203d 2064 6574 6563 745f 7468  hold = detect_th
-0000db90: 7265 7368 6f6c 6428 7363 692c 2073 6e72  reshold(sci, snr
-0000dba0: 3d64 6574 6563 745f 7468 7265 7368 2c20  =detect_thresh, 
-0000dbb0: 6d61 736b 3d6d 6173 6b29 0a20 2020 2065  mask=mask).    e
-0000dbc0: 6c73 653a 0a20 2020 2020 2020 2074 6872  lse:.        thr
-0000dbd0: 6573 686f 6c64 203d 2028 6465 7465 6374  eshold = (detect
-0000dbe0: 5f74 6872 6573 6820 2a20 6572 7229 2a28  _thresh * err)*(
-0000dbf0: 7e6d 6173 6b29 0a20 2020 2020 2020 2074  ~mask).        t
-0000dc00: 6872 6573 686f 6c64 5b6d 6173 6b5d 203d  hreshold[mask] =
-0000dc10: 206e 702e 6d65 6469 616e 2874 6872 6573   np.median(thres
-0000dc20: 686f 6c64 5b7e 6d61 736b 5d29 0a0a 2020  hold[~mask])..  
-0000dc30: 2020 6966 2073 6567 2069 7320 4e6f 6e65    if seg is None
-0000dc40: 3a0a 2020 2020 2020 2020 2320 5275 6e20  :.        # Run 
-0000dc50: 7468 6520 736f 7572 6365 2064 6574 6563  the source detec
-0000dc60: 7469 6f6e 2061 6e64 2063 7265 6174 6520  tion and create 
-0000dc70: 7468 6520 7365 676d 656e 7461 7469 6f6e  the segmentation
-0000dc80: 2069 6d61 6765 0a0a 2020 2020 2020 2020   image..        
-0000dc90: 2320 4761 7573 7369 616e 206b 6572 6e65  # Gaussian kerne
-0000dca0: 6c0a 2020 2020 2020 2020 7369 676d 6120  l.        sigma 
-0000dcb0: 3d20 6761 7573 735f 6677 686d 202a 2067  = gauss_fwhm * g
-0000dcc0: 6175 7373 6961 6e5f 6677 686d 5f74 6f5f  aussian_fwhm_to_
-0000dcd0: 7369 676d 6120 2020 2023 2046 5748 4d20  sigma    # FWHM 
-0000dce0: 3d20 322e 0a20 2020 2020 2020 206b 6572  = 2..        ker
-0000dcf0: 6e65 6c20 3d20 4761 7573 7369 616e 3244  nel = Gaussian2D
-0000dd00: 4b65 726e 656c 2873 6967 6d61 2c20 785f  Kernel(sigma, x_
-0000dd10: 7369 7a65 3d67 7369 7a65 2c20 795f 7369  size=gsize, y_si
-0000dd20: 7a65 3d67 7369 7a65 290a 2020 2020 2020  ze=gsize).      
-0000dd30: 2020 6b65 726e 656c 2e6e 6f72 6d61 6c69    kernel.normali
-0000dd40: 7a65 2829 0a0a 2020 2020 2020 2020 6966  ze()..        if
-0000dd50: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0000dd60: 2020 2020 2020 7072 696e 7428 277b 307d        print('{0}
-0000dd70: 3a20 7068 6f74 7574 696c 732e 6465 7465  : photutils.dete
-0000dd80: 6374 5f73 6f75 7263 6573 2028 6465 7465  ct_sources (dete
-0000dd90: 6374 5f74 6872 6573 683d 7b31 3a2e 3166  ct_thresh={1:.1f
-0000dda0: 7d2c 2067 726f 775f 7365 673d 7b32 3a64  }, grow_seg={2:d
-0000ddb0: 7d2c 2067 6175 7373 5f66 7768 6d3d 7b33  }, gauss_fwhm={3
-0000ddc0: 3a2e 3166 7d2c 205a 503d 7b34 3a2e 3166  :.1f}, ZP={4:.1f
-0000ddd0: 7d29 272e 666f 726d 6174 2872 6f6f 742c  })'.format(root,
-0000dde0: 2064 6574 6563 745f 7468 7265 7368 2c20   detect_thresh, 
-0000ddf0: 6772 6f77 5f73 6567 2c20 6761 7573 735f  grow_seg, gauss_
-0000de00: 6677 686d 2c20 4142 5f7a 6572 6f70 6f69  fwhm, AB_zeropoi
-0000de10: 6e74 2929 0a0a 2020 2020 2020 2020 2320  nt))..        # 
-0000de20: 4465 7465 6374 2073 6f75 7263 6573 0a20  Detect sources. 
-0000de30: 2020 2020 2020 2073 6567 6d20 3d20 6465         segm = de
-0000de40: 7465 6374 5f73 6f75 7263 6573 2873 6369  tect_sources(sci
-0000de50: 2a28 7e6d 6173 6b29 2c20 7468 7265 7368  *(~mask), thresh
-0000de60: 6f6c 642c 206e 7069 7865 6c73 3d6e 7069  old, npixels=npi
-0000de70: 7865 6c73 2c0a 2020 2020 2020 2020 2020  xels,.          
-0000de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de90: 2020 2020 6669 6c74 6572 5f6b 6572 6e65      filter_kerne
-0000dea0: 6c3d 6b65 726e 656c 290a 0a20 2020 2020  l=kernel)..     
-0000deb0: 2020 2067 726f 7720 3d20 6e64 2e6d 6178     grow = nd.max
-0000dec0: 696d 756d 5f66 696c 7465 7228 7365 676d  imum_filter(segm
-0000ded0: 2e64 6174 612c 2067 726f 775f 7365 6729  .data, grow_seg)
-0000dee0: 0a20 2020 2020 2020 2073 6567 203d 206e  .        seg = n
-0000def0: 702e 6361 7374 5b6e 702e 666c 6f61 7433  p.cast[np.float3
-0000df00: 325d 2867 726f 7729 0a20 2020 2065 6c73  2](grow).    els
-0000df10: 653a 0a20 2020 2020 2020 2023 2055 7365  e:.        # Use
-0000df20: 2074 6865 2073 7570 706c 6965 6420 7365   the supplied se
-0000df30: 676d 656e 7461 7469 6f6e 2069 6d61 6765  gmentation image
-0000df40: 0a20 2020 2020 2020 2073 6567 6d20 3d20  .        segm = 
-0000df50: 5365 676d 656e 7461 7469 6f6e 496d 6167  SegmentationImag
-0000df60: 6528 7365 6729 0a0a 2020 2020 2320 536f  e(seg)..    # So
-0000df70: 7572 6365 2070 726f 7065 7274 6965 7320  urce properties 
-0000df80: 6361 7461 6c6f 670a 2020 2020 6966 2076  catalog.    if v
-0000df90: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0000dfa0: 7072 696e 7428 277b 307d 3a20 7068 6f74  print('{0}: phot
-0000dfb0: 7574 696c 732e 736f 7572 6365 5f70 726f  utils.source_pro
-0000dfc0: 7065 7274 6965 7327 2e66 6f72 6d61 7428  perties'.format(
-0000dfd0: 726f 6f74 2929 0a0a 2020 2020 7072 6f70  root))..    prop
-0000dfe0: 7320 3d20 736f 7572 6365 5f70 726f 7065  s = source_prope
-0000dff0: 7274 6965 7328 7363 692c 2073 6567 6d2c  rties(sci, segm,
-0000e000: 2065 7272 6f72 3d74 6872 6573 686f 6c64   error=threshold
-0000e010: 2f64 6574 6563 745f 7468 7265 7368 2c0a  /detect_thresh,.
-0000e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e030: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0000e040: 736b 3d6d 6173 6b2c 2062 6163 6b67 726f  sk=mask, backgro
-0000e050: 756e 643d 6261 636b 6772 6f75 6e64 2c20  und=background, 
-0000e060: 7763 733d 7763 7329 0a0a 2020 2020 6361  wcs=wcs)..    ca
-0000e070: 7461 6c6f 6720 3d20 7072 6f70 732e 746f  talog = props.to
-0000e080: 5f74 6162 6c65 2829 0a0a 2020 2020 2320  _table()..    # 
-0000e090: 4d61 6720 636f 6c75 6d6e 730a 2020 2020  Mag columns.    
-0000e0a0: 6d61 6720 3d20 4142 5f7a 6572 6f70 6f69  mag = AB_zeropoi
-0000e0b0: 6e74 202d 2032 2e35 2a6e 702e 6c6f 6731  nt - 2.5*np.log1
-0000e0c0: 3028 6361 7461 6c6f 675b 2773 6f75 7263  0(catalog['sourc
-0000e0d0: 655f 7375 6d27 5d29 0a20 2020 206d 6167  e_sum']).    mag
-0000e0e0: 2e5f 6e61 6d65 203d 2027 6d61 6727 0a20  ._name = 'mag'. 
-0000e0f0: 2020 2063 6174 616c 6f67 2e61 6464 5f63     catalog.add_c
-0000e100: 6f6c 756d 6e28 6d61 6729 0a0a 2020 2020  olumn(mag)..    
-0000e110: 7472 793a 0a20 2020 2020 2020 206c 6f67  try:.        log
-0000e120: 7363 616c 6520 3d20 322e 352f 6e70 2e6c  scale = 2.5/np.l
-0000e130: 6f67 2831 3029 0a20 2020 2020 2020 206d  og(10).        m
-0000e140: 6167 5f65 7272 203d 206c 6f67 7363 616c  ag_err = logscal
-0000e150: 652a 6361 7461 6c6f 675b 2773 6f75 7263  e*catalog['sourc
-0000e160: 655f 7375 6d5f 6572 7227 5d2f 6361 7461  e_sum_err']/cata
-0000e170: 6c6f 675b 2773 6f75 7263 655f 7375 6d27  log['source_sum'
-0000e180: 5d0a 2020 2020 6578 6365 7074 3a0a 2020  ].    except:.  
-0000e190: 2020 2020 2020 6d61 675f 6572 7220 3d20        mag_err = 
-0000e1a0: 6e70 2e7a 6572 6f73 5f6c 696b 6528 6d61  np.zeros_like(ma
-0000e1b0: 6729 2d39 390a 0a20 2020 206d 6167 5f65  g)-99..    mag_e
-0000e1c0: 7272 2e5f 6e61 6d65 203d 2027 6d61 675f  rr._name = 'mag_
-0000e1d0: 6572 7227 0a20 2020 2063 6174 616c 6f67  err'.    catalog
-0000e1e0: 2e61 6464 5f63 6f6c 756d 6e28 6d61 675f  .add_column(mag_
-0000e1f0: 6572 7229 0a0a 2020 2020 2320 5265 6e61  err)..    # Rena
-0000e200: 6d65 2073 6f6d 6520 6361 7461 6c6f 6720  me some catalog 
-0000e210: 636f 6c75 6d6e 730a 2020 2020 666f 7220  columns.    for 
-0000e220: 6b65 7920 696e 2072 656e 616d 655f 636f  key in rename_co
-0000e230: 6c75 6d6e 732e 6b65 7973 2829 3a0a 2020  lumns.keys():.  
-0000e240: 2020 2020 2020 6966 206b 6579 206e 6f74        if key not
-0000e250: 2069 6e20 6361 7461 6c6f 672e 636f 6c6e   in catalog.coln
-0000e260: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
-0000e270: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-0000e280: 2020 2020 6361 7461 6c6f 672e 7265 6e61      catalog.rena
-0000e290: 6d65 5f63 6f6c 756d 6e28 6b65 792c 2072  me_column(key, r
-0000e2a0: 656e 616d 655f 636f 6c75 6d6e 735b 6b65  ename_columns[ke
-0000e2b0: 795d 290a 2020 2020 2020 2020 6966 2076  y]).        if v
-0000e2c0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0000e2d0: 2020 2020 7072 696e 7428 2752 656e 616d      print('Renam
-0000e2e0: 6520 636f 6c75 6d6e 3a20 7b30 7d20 2d3e  e column: {0} ->
-0000e2f0: 207b 317d 272e 666f 726d 6174 286b 6579   {1}'.format(key
-0000e300: 2c20 7265 6e61 6d65 5f63 6f6c 756d 6e73  , rename_columns
-0000e310: 5b6b 6579 5d29 290a 0a20 2020 2023 2044  [key]))..    # D
-0000e320: 6f6e 6521 0a20 2020 2069 6620 7665 7262  one!.    if verb
-0000e330: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
-0000e340: 6e74 284e 4f5f 4e45 574c 494e 4520 2b20  nt(NO_NEWLINE + 
-0000e350: 2827 7b30 7d3a 2070 686f 7475 7469 6c73  ('{0}: photutils
-0000e360: 2e73 6f75 7263 655f 7072 6f70 6572 7469  .source_properti
-0000e370: 6573 202d 207b 313a 647d 206f 626a 6563  es - {1:d} objec
-0000e380: 7473 272e 666f 726d 6174 2872 6f6f 742c  ts'.format(root,
-0000e390: 206c 656e 2863 6174 616c 6f67 2929 2929   len(catalog))))
-0000e3a0: 0a0a 2020 2020 2320 5361 7665 206f 7574  ..    # Save out
-0000e3b0: 7075 7473 3f0a 2020 2020 6966 2073 6176  puts?.    if sav
-0000e3c0: 655f 6465 7465 6374 696f 6e3a 0a20 2020  e_detection:.   
-0000e3d0: 2020 2020 2073 6567 5f66 696c 6520 3d20       seg_file = 
-0000e3e0: 726f 6f74 202b 2027 2e64 6574 6563 745f  root + '.detect_
-0000e3f0: 7365 672e 6669 7473 270a 2020 2020 2020  seg.fits'.      
-0000e400: 2020 7365 675f 6361 7420 3d20 726f 6f74    seg_cat = root
-0000e410: 202b 2027 2e64 6574 6563 742e 6361 7427   + '.detect.cat'
-0000e420: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-0000e430: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0000e440: 2070 7269 6e74 2827 7b30 7d3a 2073 6176   print('{0}: sav
-0000e450: 6520 7b31 7d2c 207b 327d 272e 666f 726d  e {1}, {2}'.form
-0000e460: 6174 2872 6f6f 742c 2073 6567 5f66 696c  at(root, seg_fil
-0000e470: 652c 2073 6567 5f63 6174 2929 0a0a 2020  e, seg_cat))..  
-0000e480: 2020 2020 2020 6966 2077 6373 2069 7320        if wcs is 
-0000e490: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000e4a0: 2020 2020 2020 6865 6164 6572 203d 2077        header = w
-0000e4b0: 6373 2e74 6f5f 6865 6164 6572 2872 656c  cs.to_header(rel
-0000e4c0: 6178 3d54 7275 6529 0a20 2020 2020 2020  ax=True).       
-0000e4d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000e4e0: 2020 2068 6561 6465 7220 3d20 4e6f 6e65     header = None
-0000e4f0: 0a0a 2020 2020 2020 2020 7079 6669 7473  ..        pyfits
-0000e500: 2e77 7269 7465 746f 2873 6567 5f66 696c  .writeto(seg_fil
-0000e510: 652c 2064 6174 613d 7365 672c 2068 6561  e, data=seg, hea
-0000e520: 6465 723d 6865 6164 6572 2c20 6f76 6572  der=header, over
-0000e530: 7772 6974 653d 6f76 6572 7772 6974 6529  write=overwrite)
-0000e540: 0a0a 2020 2020 2020 2020 6966 206f 732e  ..        if os.
-0000e550: 7061 7468 2e65 7869 7374 7328 7365 675f  path.exists(seg_
-0000e560: 6361 7429 2026 206f 7665 7277 7269 7465  cat) & overwrite
-0000e570: 3a0a 2020 2020 2020 2020 2020 2020 6f73  :.            os
-0000e580: 2e72 656d 6f76 6528 7365 675f 6361 7429  .remove(seg_cat)
-0000e590: 0a0a 2020 2020 2020 2020 6361 7461 6c6f  ..        catalo
-0000e5a0: 672e 7772 6974 6528 7365 675f 6361 742c  g.write(seg_cat,
-0000e5b0: 2066 6f72 6d61 743d 2761 7363 6969 2e63   format='ascii.c
-0000e5c0: 6f6d 6d65 6e74 6564 5f68 6561 6465 7227  ommented_header'
-0000e5d0: 290a 0a20 2020 2072 6574 7572 6e20 6361  )..    return ca
-0000e5e0: 7461 6c6f 672c 2073 6567 0a0a 0a64 6566  talog, seg...def
-0000e5f0: 2073 6166 655f 696e 7665 7274 2861 7272   safe_invert(arr
-0000e600: 293a 0a20 2020 2022 2222 0a20 2020 2076  ):.    """.    v
-0000e610: 6572 7369 6f6e 2d73 6166 6520 6d61 7472  ersion-safe matr
-0000e620: 6978 2069 6e76 6572 7369 6f6e 2075 7369  ix inversion usi
-0000e630: 6e67 206e 702e 6c69 6e61 6c67 206f 7220  ng np.linalg or 
-0000e640: 6e70 2e6d 6174 7269 782e 490a 2020 2020  np.matrix.I.    
-0000e650: 2222 220a 2020 2020 7472 793a 0a20 2020  """.    try:.   
-0000e660: 2020 2020 2066 726f 6d20 6e75 6d70 792e       from numpy.
-0000e670: 6c69 6e61 6c67 2069 6d70 6f72 7420 696e  linalg import in
-0000e680: 760a 2020 2020 2020 2020 5f69 6e76 203d  v.        _inv =
-0000e690: 2069 6e76 2861 7272 290a 2020 2020 6578   inv(arr).    ex
-0000e6a0: 6365 7074 3a0a 2020 2020 2020 2020 5f69  cept:.        _i
-0000e6b0: 6e76 203d 206e 702e 6d61 7472 6978 2861  nv = np.matrix(a
-0000e6c0: 7272 292e 492e 410a 2020 2020 0a20 2020  rr).I.A.    .   
-0000e6d0: 2072 6574 7572 6e20 5f69 6e76 0a20 2020   return _inv.   
-0000e6e0: 200a 0a64 6566 206e 6d61 6428 6461 7461   ..def nmad(data
-0000e6f0: 293a 0a20 2020 2022 2222 4e6f 726d 616c  ):.    """Normal
-0000e700: 697a 6564 204e 4d41 443d 312e 3438 3236  ized NMAD=1.4826
-0000e710: 3032 3220 2a20 607e 2e61 7374 726f 7079  022 * `~.astropy
-0000e720: 2e73 7461 7473 2e6d 6564 6961 6e5f 6162  .stats.median_ab
-0000e730: 736f 6c75 7465 5f64 6576 6961 7469 6f6e  solute_deviation
-0000e740: 600a 0a20 2020 2022 2222 0a20 2020 2069  `..    """.    i
-0000e750: 6d70 6f72 7420 6173 7472 6f70 792e 7374  mport astropy.st
-0000e760: 6174 730a 2020 2020 7265 7475 726e 2031  ats.    return 1
-0000e770: 2e34 3832 3630 3232 2a61 7374 726f 7079  .4826022*astropy
-0000e780: 2e73 7461 7473 2e6d 6564 6961 6e5f 6162  .stats.median_ab
-0000e790: 736f 6c75 7465 5f64 6576 6961 7469 6f6e  solute_deviation
-0000e7a0: 2864 6174 6129 0a0a 0a64 6566 2067 6574  (data)...def get
-0000e7b0: 5f6c 696e 655f 7761 7665 6c65 6e67 7468  _line_wavelength
-0000e7c0: 7328 293a 0a20 2020 2022 2222 4765 7420  s():.    """Get 
-0000e7d0: 6120 6469 6374 696f 6e61 7279 206f 6620  a dictionary of 
-0000e7e0: 636f 6d6d 6f6e 2065 6d69 7373 696f 6e20  common emission 
-0000e7f0: 6c69 6e65 2077 6176 656c 656e 6774 6873  line wavelengths
-0000e800: 2061 6e64 206c 696e 6520 7261 7469 6f73   and line ratios
-0000e810: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-0000e820: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6c69    -------.    li
-0000e830: 6e65 5f77 6176 656c 656e 6774 6873 2c20  ne_wavelengths, 
-0000e840: 6c69 6e65 5f72 6174 696f 7320 3a20 6469  line_ratios : di
-0000e850: 6374 0a20 2020 2020 2020 204b 6579 7320  ct.        Keys 
-0000e860: 6172 6520 636f 6d6d 6f6e 2074 6f20 626f  are common to bo
-0000e870: 7468 2064 6963 7469 6f6e 6172 6965 7320  th dictionaries 
-0000e880: 616e 6420 6172 6520 7369 6d70 6c65 206e  and are simple n
-0000e890: 616d 6573 2066 6f72 206c 696e 6573 0a20  ames for lines. 
-0000e8a0: 2020 2020 2020 2061 6e64 206c 696e 6520         and line 
-0000e8b0: 636f 6d70 6c65 7865 732e 2020 5661 6c75  complexes.  Valu
-0000e8c0: 6573 2061 7265 206c 6973 7473 206f 6620  es are lists of 
-0000e8d0: 6c69 6e65 2077 6176 656c 656e 6774 6873  line wavelengths
-0000e8e0: 2061 6e64 206c 696e 650a 2020 2020 2020   and line.      
-0000e8f0: 2020 7261 7469 6f73 2e0a 0a20 2020 2020    ratios...     
-0000e900: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
-0000e910: 6772 697a 6c69 2e75 7469 6c73 2069 6d70  grizli.utils imp
-0000e920: 6f72 7420 6765 745f 6c69 6e65 5f77 6176  ort get_line_wav
-0000e930: 656c 656e 6774 6873 0a20 2020 2020 2020  elengths.       
-0000e940: 2020 2020 203e 3e3e 206c 696e 655f 7761       >>> line_wa
-0000e950: 7665 6c65 6e67 7468 732c 206c 696e 655f  velengths, line_
-0000e960: 7261 7469 6f73 203d 2067 6574 5f6c 696e  ratios = get_lin
-0000e970: 655f 7761 7665 6c65 6e67 7468 7328 290a  e_wavelengths().
-0000e980: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-0000e990: 7072 696e 7428 6c69 6e65 5f77 6176 656c  print(line_wavel
-0000e9a0: 656e 6774 6873 5b27 4861 275d 2c20 6c69  engths['Ha'], li
-0000e9b0: 6e65 5f72 6174 696f 735b 2748 6127 5d29  ne_ratios['Ha'])
-0000e9c0: 0a20 2020 2020 2020 2020 2020 205b 3635  .            [65
-0000e9d0: 3634 2e36 315d 205b 312e 305d 0a20 2020  64.61] [1.0].   
-0000e9e0: 2020 2020 2020 2020 203e 3e3e 2070 7269           >>> pri
-0000e9f0: 6e74 286c 696e 655f 7761 7665 6c65 6e67  nt(line_waveleng
-0000ea00: 7468 735b 274f 4949 4927 5d2c 206c 696e  ths['OIII'], lin
-0000ea10: 655f 7261 7469 6f73 5b27 4f49 4949 275d  e_ratios['OIII']
-0000ea20: 290a 2020 2020 2020 2020 2020 2020 5b35  ).            [5
-0000ea30: 3030 382e 3234 2c20 3439 3630 2e32 3935  008.24, 4960.295
-0000ea40: 5d20 5b32 2e39 382c 2031 5d0a 0a20 2020  ] [2.98, 1]..   
-0000ea50: 2020 2020 2049 6e63 6c75 6465 7320 736f       Includes so
-0000ea60: 6d65 2061 6464 6974 696f 6e61 6c20 636f  me additional co
-0000ea70: 6d62 696e 6564 206c 696e 6520 636f 6d70  mbined line comp
-0000ea80: 6c65 7865 7320 7573 6566 756c 2066 6f72  lexes useful for
-0000ea90: 2072 6564 7368 6966 740a 2020 2020 2020   redshift.      
-0000eaa0: 2020 6669 7473 3a0a 0a20 2020 2020 2020    fits:..       
-0000eab0: 2020 2020 203e 3e3e 2066 726f 6d20 6772       >>> from gr
-0000eac0: 697a 6c69 2e75 7469 6c73 2069 6d70 6f72  izli.utils impor
-0000ead0: 7420 6765 745f 6c69 6e65 5f77 6176 656c  t get_line_wavel
-0000eae0: 656e 6774 6873 0a20 2020 2020 2020 2020  engths.         
-0000eaf0: 2020 203e 3e3e 206c 696e 655f 7761 7665     >>> line_wave
-0000eb00: 6c65 6e67 7468 732c 206c 696e 655f 7261  lengths, line_ra
-0000eb10: 7469 6f73 203d 2067 6574 5f6c 696e 655f  tios = get_line_
-0000eb20: 7761 7665 6c65 6e67 7468 7328 290a 2020  wavelengths().  
-0000eb30: 2020 2020 2020 2020 2020 3e3e 3e20 6b65            >>> ke
-0000eb40: 7920 3d20 2748 612b 5349 492b 5349 4949  y = 'Ha+SII+SIII
-0000eb50: 2b48 6527 0a20 2020 2020 2020 2020 2020  +He'.           
-0000eb60: 203e 3e3e 2070 7269 6e74 286c 696e 655f   >>> print(line_
-0000eb70: 7761 7665 6c65 6e67 7468 735b 6b65 795d  wavelengths[key]
-0000eb80: 2c20 275c 5c6e 272c 206c 696e 655f 7261  , '\\n', line_ra
-0000eb90: 7469 6f73 5b6b 6579 5d29 0a20 2020 2020  tios[key]).     
-0000eba0: 2020 2020 2020 205b 3635 3634 2e36 312c         [6564.61,
-0000ebb0: 2036 3731 382e 3239 2c20 3637 3332 2e36   6718.29, 6732.6
-0000ebc0: 372c 2039 3036 382e 362c 2039 3533 302e  7, 9068.6, 9530.
-0000ebd0: 362c 2031 3038 3330 2e30 5d0a 2020 2020  6, 10830.0].    
-0000ebe0: 2020 2020 2020 2020 5b31 2e30 2c20 302e          [1.0, 0.
-0000ebf0: 312c 2030 2e31 2c20 302e 3035 2c20 302e  1, 0.1, 0.05, 0.
-0000ec00: 3132 322c 2030 2e30 345d 0a0a 2020 2020  122, 0.04]..    
-0000ec10: 2222 220a 2020 2020 6c69 6e65 5f77 6176  """.    line_wav
-0000ec20: 656c 656e 6774 6873 203d 204f 7264 6572  elengths = Order
-0000ec30: 6564 4469 6374 2829 0a20 2020 206c 696e  edDict().    lin
-0000ec40: 655f 7261 7469 6f73 203d 204f 7264 6572  e_ratios = Order
-0000ec50: 6564 4469 6374 2829 0a0a 2020 2020 2320  edDict()..    # 
-0000ec60: 5061 7363 6865 6e3a 2068 7474 7073 3a2f  Paschen: https:/
-0000ec70: 2f77 7777 2e67 656d 696e 692e 6564 752f  /www.gemini.edu/
-0000ec80: 7363 696f 7073 2f69 6e73 7472 756d 656e  sciops/instrumen
-0000ec90: 7473 2f6e 6561 7269 722d 7265 736f 7572  ts/nearir-resour
-0000eca0: 6365 732f 6173 7472 6f6e 6f6d 6963 616c  ces/astronomical
-0000ecb0: 2d6c 696e 6573 2f68 2d6c 696e 6573 0a20  -lines/h-lines. 
-0000ecc0: 2020 200a 2020 2020 2320 5268 203d 2030     .    # Rh = 0
-0000ecd0: 2e30 3031 3039 3637 3735 370a 2020 2020  .0010967757.    
-0000ece0: 2320 6b20 3d20 5268 202a 2028 312f 6e30  # k = Rh * (1/n0
-0000ecf0: 2a2a 3220 2d20 312f 6e2a 2a32 290a 2020  **2 - 1/n**2).  
-0000ed00: 2020 2320 7761 7665 203d 2031 2e2f 6b20    # wave = 1./k 
-0000ed10: 2320 416e 6773 7472 6f6d 730a 2020 2020  # Angstroms.    
-0000ed20: 0a20 2020 2023 2050 6675 6e64 206e 303d  .    # Pfund n0=
-0000ed30: 350a 2020 2020 6c69 6e65 5f77 6176 656c  5.    line_wavel
-0000ed40: 656e 6774 6873 5b27 5066 4127 5d20 3d20  engths['PfA'] = 
-0000ed50: 5b37 3435 3938 2e38 5d0a 2020 2020 6c69  [74598.8].    li
-0000ed60: 6e65 5f72 6174 696f 735b 2750 6641 275d  ne_ratios['PfA']
-0000ed70: 203d 205b 312e 5d0a 2020 2020 6c69 6e65   = [1.].    line
-0000ed80: 5f77 6176 656c 656e 6774 6873 5b27 5066  _wavelengths['Pf
-0000ed90: 4227 5d20 3d20 5b34 3635 3337 2e39 5d0a  B'] = [46537.9].
-0000eda0: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
-0000edb0: 2750 6642 275d 203d 205b 312e 5d0a 2020  'PfB'] = [1.].  
-0000edc0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
-0000edd0: 6873 5b27 5066 4727 5d20 3d20 5b33 3734  hs['PfG'] = [374
-0000ede0: 3035 2e37 5d0a 2020 2020 6c69 6e65 5f72  05.7].    line_r
-0000edf0: 6174 696f 735b 2750 6647 275d 203d 205b  atios['PfG'] = [
-0000ee00: 312e 5d0a 2020 2020 6c69 6e65 5f77 6176  1.].    line_wav
-0000ee10: 656c 656e 6774 6873 5b27 5066 4427 5d20  elengths['PfD'] 
-0000ee20: 3d20 5b33 3239 3730 2e30 5d0a 2020 2020  = [32970.0].    
-0000ee30: 6c69 6e65 5f72 6174 696f 735b 2750 6644  line_ratios['PfD
-0000ee40: 275d 203d 205b 312e 5d0a 2020 2020 6c69  '] = [1.].    li
-0000ee50: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-0000ee60: 5066 4527 5d20 3d20 5b33 3033 3932 2e31  PfE'] = [30392.1
-0000ee70: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
-0000ee80: 735b 2750 6645 275d 203d 205b 312e 5d0a  s['PfE'] = [1.].
-0000ee90: 2020 2020 0a20 2020 2023 2042 7261 636b      .    # Brack
-0000eea0: 6574 7420 6e30 3d34 0a20 2020 206c 696e  ett n0=4.    lin
-0000eeb0: 655f 7761 7665 6c65 6e67 7468 735b 2742  e_wavelengths['B
-0000eec0: 7241 275d 203d 205b 3430 3532 322e 385d  rA'] = [40522.8]
-0000eed0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
-0000eee0: 5b27 4272 4127 5d20 3d20 5b31 2e5d 0a20  ['BrA'] = [1.]. 
-0000eef0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-0000ef00: 7468 735b 2742 7242 275d 203d 205b 3236  ths['BrB'] = [26
-0000ef10: 3235 382e 385d 0a20 2020 206c 696e 655f  258.8].    line_
-0000ef20: 7261 7469 6f73 5b27 4272 4227 5d20 3d20  ratios['BrB'] = 
-0000ef30: 5b31 2e5d 0a20 2020 206c 696e 655f 7761  [1.].    line_wa
-0000ef40: 7665 6c65 6e67 7468 735b 2742 7247 275d  velengths['BrG']
-0000ef50: 203d 205b 3231 3636 312e 335d 0a20 2020   = [21661.3].   
-0000ef60: 206c 696e 655f 7261 7469 6f73 5b27 4272   line_ratios['Br
-0000ef70: 4727 5d20 3d20 5b31 2e5d 0a20 2020 206c  G'] = [1.].    l
-0000ef80: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-0000ef90: 2742 7244 275d 203d 205b 3139 3435 312e  'BrD'] = [19451.
-0000efa0: 305d 0a20 2020 206c 696e 655f 7261 7469  0].    line_rati
-0000efb0: 6f73 5b27 4272 4427 5d20 3d20 5b31 2e5d  os['BrD'] = [1.]
-0000efc0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-0000efd0: 6e67 7468 735b 2742 7245 275d 203d 205b  ngths['BrE'] = [
-0000efe0: 3138 3137 392e 325d 0a20 2020 206c 696e  18179.2].    lin
-0000eff0: 655f 7261 7469 6f73 5b27 4272 4527 5d20  e_ratios['BrE'] 
-0000f000: 3d20 5b31 2e5d 0a20 2020 200a 2020 2020  = [1.].    .    
-0000f010: 2320 5061 7363 6865 6e20 6e30 3d33 0a20  # Paschen n0=3. 
-0000f020: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-0000f030: 7468 735b 2750 6141 275d 203d 205b 3138  ths['PaA'] = [18
-0000f040: 3735 362e 335d 0a20 2020 206c 696e 655f  756.3].    line_
-0000f050: 7261 7469 6f73 5b27 5061 4127 5d20 3d20  ratios['PaA'] = 
-0000f060: 5b31 2e5d 0a20 2020 206c 696e 655f 7761  [1.].    line_wa
-0000f070: 7665 6c65 6e67 7468 735b 2750 6142 275d  velengths['PaB']
-0000f080: 203d 205b 3132 3832 312e 375d 0a20 2020   = [12821.7].   
-0000f090: 206c 696e 655f 7261 7469 6f73 5b27 5061   line_ratios['Pa
-0000f0a0: 4227 5d20 3d20 5b31 2e5d 0a20 2020 206c  B'] = [1.].    l
-0000f0b0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-0000f0c0: 2750 6147 275d 203d 205b 3130 3934 312e  'PaG'] = [10941.
-0000f0d0: 325d 0a20 2020 206c 696e 655f 7261 7469  2].    line_rati
-0000f0e0: 6f73 5b27 5061 4727 5d20 3d20 5b31 2e5d  os['PaG'] = [1.]
-0000f0f0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-0000f100: 6e67 7468 735b 2750 6144 275d 203d 205b  ngths['PaD'] = [
-0000f110: 3130 3035 322e 325d 0a20 2020 206c 696e  10052.2].    lin
-0000f120: 655f 7261 7469 6f73 5b27 5061 4427 5d20  e_ratios['PaD'] 
-0000f130: 3d20 5b31 2e5d 0a20 2020 206c 696e 655f  = [1.].    line_
-0000f140: 7761 7665 6c65 6e67 7468 735b 2750 6138  wavelengths['Pa8
-0000f150: 275d 203d 205b 3935 3438 2e36 355d 0a20  '] = [9548.65]. 
-0000f160: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
-0000f170: 5061 3827 5d20 3d20 5b31 2e5d 0a20 2020  Pa8'] = [1.].   
-0000f180: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-0000f190: 735b 2750 6139 275d 203d 205b 3932 3331  s['Pa9'] = [9231
-0000f1a0: 2e36 305d 0a20 2020 206c 696e 655f 7261  .60].    line_ra
-0000f1b0: 7469 6f73 5b27 5061 3927 5d20 3d20 5b31  tios['Pa9'] = [1
-0000f1c0: 2e5d 0a20 2020 206c 696e 655f 7761 7665  .].    line_wave
-0000f1d0: 6c65 6e67 7468 735b 2750 6131 3027 5d20  lengths['Pa10'] 
-0000f1e0: 3d20 5b39 3031 372e 3434 5d0a 2020 2020  = [9017.44].    
-0000f1f0: 6c69 6e65 5f72 6174 696f 735b 2750 6131  line_ratios['Pa1
-0000f200: 3027 5d20 3d20 5b31 2e5d 0a20 2020 200a  0'] = [1.].    .
-0000f210: 2020 2020 2320 4261 6c6d 6572 206e 303d      # Balmer n0=
-0000f220: 320a 2020 2020 6c69 6e65 5f77 6176 656c  2.    line_wavel
-0000f230: 656e 6774 6873 5b27 4861 275d 203d 205b  engths['Ha'] = [
-0000f240: 3635 3634 2e36 3937 5d0a 2020 2020 6c69  6564.697].    li
-0000f250: 6e65 5f72 6174 696f 735b 2748 6127 5d20  ne_ratios['Ha'] 
-0000f260: 3d20 5b31 2e5d 0a20 2020 206c 696e 655f  = [1.].    line_
-0000f270: 7761 7665 6c65 6e67 7468 735b 2748 6227  wavelengths['Hb'
-0000f280: 5d20 3d20 5b34 3836 322e 3733 385d 0a20  ] = [4862.738]. 
-0000f290: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
-0000f2a0: 4862 275d 203d 205b 312e 5d0a 2020 2020  Hb'] = [1.].    
-0000f2b0: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-0000f2c0: 5b27 4867 275d 203d 205b 3433 3431 2e37  ['Hg'] = [4341.7
-0000f2d0: 3331 5d0a 2020 2020 6c69 6e65 5f72 6174  31].    line_rat
-0000f2e0: 696f 735b 2748 6727 5d20 3d20 5b31 2e5d  ios['Hg'] = [1.]
-0000f2f0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-0000f300: 6e67 7468 735b 2748 6427 5d20 3d20 5b34  ngths['Hd'] = [4
-0000f310: 3130 322e 3933 365d 0a20 2020 206c 696e  102.936].    lin
-0000f320: 655f 7261 7469 6f73 5b27 4864 275d 203d  e_ratios['Hd'] =
-0000f330: 205b 312e 5d0a 0a20 2020 206c 696e 655f   [1.]..    line_
-0000f340: 7761 7665 6c65 6e67 7468 735b 2748 3727  wavelengths['H7'
-0000f350: 5d20 3d20 5b33 3937 312e 3233 365d 0a20  ] = [3971.236]. 
-0000f360: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
-0000f370: 4837 275d 203d 205b 312e 5d0a 2020 2020  H7'] = [1.].    
-0000f380: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-0000f390: 5b27 4838 275d 203d 205b 3338 3930 2e31  ['H8'] = [3890.1
-0000f3a0: 3931 5d0a 2020 2020 6c69 6e65 5f72 6174  91].    line_rat
-0000f3b0: 696f 735b 2748 3827 5d20 3d20 5b31 2e5d  ios['H8'] = [1.]
-0000f3c0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-0000f3d0: 6e67 7468 735b 2748 3927 5d20 3d20 5b33  ngths['H9'] = [3
-0000f3e0: 3833 362e 3531 315d 0a20 2020 206c 696e  836.511].    lin
-0000f3f0: 655f 7261 7469 6f73 5b27 4839 275d 203d  e_ratios['H9'] =
-0000f400: 205b 312e 5d0a 2020 2020 6c69 6e65 5f77   [1.].    line_w
-0000f410: 6176 656c 656e 6774 6873 5b27 4831 3027  avelengths['H10'
-0000f420: 5d20 3d20 5b33 3739 392e 3031 345d 0a20  ] = [3799.014]. 
-0000f430: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
-0000f440: 4831 3027 5d20 3d20 5b31 2e5d 0a20 2020  H10'] = [1.].   
-0000f450: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-0000f460: 735b 2748 3131 275d 203d 205b 3337 3731  s['H11'] = [3771
-0000f470: 2e37 3339 5d0a 2020 2020 6c69 6e65 5f72  .739].    line_r
-0000f480: 6174 696f 735b 2748 3131 275d 203d 205b  atios['H11'] = [
-0000f490: 312e 5d0a 2020 2020 6c69 6e65 5f77 6176  1.].    line_wav
-0000f4a0: 656c 656e 6774 6873 5b27 4831 3227 5d20  elengths['H12'] 
-0000f4b0: 3d20 5b33 3735 312e 3235 355d 0a20 2020  = [3751.255].   
-0000f4c0: 206c 696e 655f 7261 7469 6f73 5b27 4831   line_ratios['H1
-0000f4d0: 3227 5d20 3d20 5b31 2e5d 0a0a 2020 2020  2'] = [1.]..    
-0000f4e0: 2320 4772 6f76 6573 2065 7420 616c 2e20  # Groves et al. 
-0000f4f0: 3230 3131 2c20 5461 626c 6520 310a 2020  2011, Table 1.  
-0000f500: 2020 2320 4f73 7465 7262 726f 636b 2074    # Osterbrock t
-0000f510: 6162 6c65 2034 2e34 2066 6f72 2048 3720  able 4.4 for H7 
-0000f520: 746f 2048 3130 0a20 2020 2023 206c 696e  to H10.    # lin
-0000f530: 655f 7761 7665 6c65 6e67 7468 735b 2742  e_wavelengths['B
-0000f540: 616c 6d65 7220 3130 6b4b 275d 203d 205b  almer 10kK'] = [
-0000f550: 3635 3634 2e36 312c 2034 3836 322e 3638  6564.61, 4862.68
-0000f560: 2c20 3433 3431 2e36 382c 2034 3130 312e  , 4341.68, 4101.
-0000f570: 3733 5d0a 2020 2020 2320 6c69 6e65 5f72  73].    # line_r
-0000f580: 6174 696f 735b 2742 616c 6d65 7220 3130  atios['Balmer 10
-0000f590: 6b4b 275d 203d 205b 322e 3836 2c20 312e  kK'] = [2.86, 1.
-0000f5a0: 302c 2030 2e34 3638 2c20 302e 3235 395d  0, 0.468, 0.259]
-0000f5b0: 0a0a 2020 2020 6c69 6e65 5f77 6176 656c  ..    line_wavel
-0000f5c0: 656e 6774 6873 5b27 4261 6c6d 6572 2031  engths['Balmer 1
-0000f5d0: 306b 4b27 5d20 3d20 5b36 3536 342e 3631  0kK'] = [6564.61
-0000f5e0: 2c20 3438 3632 2e36 382c 2034 3334 312e  , 4862.68, 4341.
-0000f5f0: 3638 2c20 3431 3031 2e37 332c 2033 3937  68, 4101.73, 397
-0000f600: 312e 3139 382c 2033 3839 302e 3136 362c  1.198, 3890.166,
-0000f610: 2033 3833 362e 3438 352c 2033 3739 382e   3836.485, 3798.
-0000f620: 3938 375d 0a20 2020 206c 696e 655f 7261  987].    line_ra
-0000f630: 7469 6f73 5b27 4261 6c6d 6572 2031 306b  tios['Balmer 10k
-0000f640: 4b27 5d20 3d20 5b32 2e38 362c 2031 2e30  K'] = [2.86, 1.0
-0000f650: 2c20 302e 3436 382c 2030 2e32 3539 2c20  , 0.468, 0.259, 
-0000f660: 302e 3135 392c 2030 2e31 3035 2c20 302e  0.159, 0.105, 0.
-0000f670: 3037 3331 2c20 302e 3035 3330 5d0a 0a20  0731, 0.0530].. 
-0000f680: 2020 2023 2050 6173 6368 656e 2066 726f     # Paschen fro
-0000f690: 6d20 4f73 7465 7262 726f 636b 2c20 652e  m Osterbrock, e.
-0000f6a0: 672e 2c20 5061 2d62 6574 6120 7265 6c61  g., Pa-beta rela
-0000f6b0: 7469 7665 2074 6f20 482d 6761 6d6d 610a  tive to H-gamma.
-0000f6c0: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-0000f6d0: 6774 6873 5b27 4261 6c6d 6572 2031 306b  gths['Balmer 10k
-0000f6e0: 4b27 5d20 2b3d 206c 696e 655f 7761 7665  K'] += line_wave
-0000f6f0: 6c65 6e67 7468 735b 2750 6141 275d 202b  lengths['PaA'] +
-0000f700: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-0000f710: 735b 2750 6142 275d 202b 206c 696e 655f  s['PaB'] + line_
-0000f720: 7761 7665 6c65 6e67 7468 735b 2750 6147  wavelengths['PaG
-0000f730: 275d 202b 206c 696e 655f 7761 7665 6c65  '] + line_wavele
-0000f740: 6e67 7468 735b 2750 6144 275d 0a20 2020  ngths['PaD'].   
-0000f750: 206c 696e 655f 7261 7469 6f73 5b27 4261   line_ratios['Ba
-0000f760: 6c6d 6572 2031 306b 4b27 5d20 2b3d 205b  lmer 10kK'] += [
-0000f770: 302e 3334 3820 2a20 6c69 6e65 5f72 6174  0.348 * line_rat
-0000f780: 696f 735b 2742 616c 6d65 7220 3130 6b4b  ios['Balmer 10kK
-0000f790: 275d 5b69 5d20 666f 7220 6920 696e 205b  '][i] for i in [
-0000f7a0: 312c 2032 2c20 332c 2034 5d5d 0a0a 2020  1, 2, 3, 4]]..  
-0000f7b0: 2020 2320 4f73 7465 7262 726f 636b 2074    # Osterbrock t
-0000f7c0: 6162 6c65 2034 2e34 2066 6f72 2048 3720  able 4.4 for H7 
-0000f7d0: 746f 2048 3130 0a20 2020 206c 696e 655f  to H10.    line_
-0000f7e0: 7761 7665 6c65 6e67 7468 735b 2742 616c  wavelengths['Bal
-0000f7f0: 6d65 7220 3130 6b4b 202b 204d 6749 4927  mer 10kK + MgII'
-0000f800: 5d20 3d20 6c69 6e65 5f77 6176 656c 656e  ] = line_wavelen
-0000f810: 6774 6873 5b27 4261 6c6d 6572 2031 306b  gths['Balmer 10k
-0000f820: 4b27 5d20 2b20 5b32 3739 392e 3131 375d  K'] + [2799.117]
-0000f830: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
-0000f840: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
-0000f850: 4d67 4949 275d 203d 206c 696e 655f 7261  MgII'] = line_ra
-0000f860: 7469 6f73 5b27 4261 6c6d 6572 2031 306b  tios['Balmer 10k
-0000f870: 4b27 5d20 2b20 5b33 2e5d 0a0a 2020 2020  K'] + [3.]..    
-0000f880: 2320 2320 5061 7363 6865 6e20 6672 6f6d  # # Paschen from
-0000f890: 204f 7374 6572 6272 6f63 6b2c 2065 2e67   Osterbrock, e.g
-0000f8a0: 2e2c 2050 612d 6265 7461 2072 656c 6174  ., Pa-beta relat
-0000f8b0: 6976 6520 746f 2048 2d67 616d 6d61 0a20  ive to H-gamma. 
-0000f8c0: 2020 2023 206c 696e 655f 7761 7665 6c65     # line_wavele
-0000f8d0: 6e67 7468 735b 2742 616c 6d65 7220 3130  ngths['Balmer 10
-0000f8e0: 6b4b 202b 204d 6749 4927 5d20 2b3d 206c  kK + MgII'] += l
-0000f8f0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-0000f900: 2750 6141 275d 202b 206c 696e 655f 7761  'PaA'] + line_wa
-0000f910: 7665 6c65 6e67 7468 735b 2750 6142 275d  velengths['PaB']
-0000f920: 202b 206c 696e 655f 7761 7665 6c65 6e67   + line_waveleng
-0000f930: 7468 735b 2750 6147 275d 0a20 2020 2023  ths['PaG'].    #
-0000f940: 206c 696e 655f 7261 7469 6f73 5b27 4261   line_ratios['Ba
-0000f950: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
-0000f960: 275d 202b 3d20 5b30 2e33 3438 202a 206c  '] += [0.348 * l
-0000f970: 696e 655f 7261 7469 6f73 5b27 4261 6c6d  ine_ratios['Balm
-0000f980: 6572 2031 306b 4b20 2b20 4d67 4949 275d  er 10kK + MgII']
-0000f990: 5b69 5d20 666f 7220 6920 696e 205b 312c  [i] for i in [1,
-0000f9a0: 322c 335d 5d0a 0a20 2020 2023 2057 6974  2,3]]..    # Wit
-0000f9b0: 6820 5061 7363 6865 6e20 6c69 6e65 7320  h Paschen lines 
-0000f9c0: 2620 4865 2031 3038 3330 2066 726f 6d20  & He 10830 from 
-0000f9d0: 476c 696b 6d61 6e20 3230 3036 0a20 2020  Glikman 2006.   
-0000f9e0: 2023 2068 7474 7073 3a2f 2f69 6f70 7363   # https://iopsc
-0000f9f0: 6965 6e63 652e 696f 702e 6f72 672f 6172  ience.iop.org/ar
-0000fa00: 7469 636c 652f 3130 2e31 3038 362f 3530  ticle/10.1086/50
-0000fa10: 3030 3938 2f70 6466 0a20 2020 2023 6c69  0098/pdf.    #li
-0000fa20: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-0000fa30: 4261 6c6d 6572 2031 306b 4b20 2b20 4d67  Balmer 10kK + Mg
-0000fa40: 4949 275d 203d 205b 3635 3634 2e36 312c  II'] = [6564.61,
-0000fa50: 2034 3836 322e 3638 2c20 3433 3431 2e36   4862.68, 4341.6
-0000fa60: 382c 2034 3130 312e 3733 2c20 3339 3731  8, 4101.73, 3971
-0000fa70: 2e31 3938 2c20 3237 3939 2e31 3137 2c20  .198, 2799.117, 
-0000fa80: 3132 3832 312e 362c 2031 3039 3431 2e31  12821.6, 10941.1
-0000fa90: 5d0a 2020 2020 236c 696e 655f 7261 7469  ].    #line_rati
-0000faa0: 6f73 5b27 4261 6c6d 6572 2031 306b 4b20  os['Balmer 10kK 
-0000fab0: 2b20 4d67 4949 275d 203d 205b 322e 3836  + MgII'] = [2.86
-0000fac0: 2c20 312e 302c 2030 2e34 3638 2c20 302e  , 1.0, 0.468, 0.
-0000fad0: 3235 392c 2030 2e31 362c 2033 2e2c 2032  259, 0.16, 3., 2
-0000fae0: 2e38 362a 342e 382f 3130 302c 2032 2e38  .86*4.8/100, 2.8
-0000faf0: 362a 312e 3935 2f31 3030 5d0a 0a20 2020  6*1.95/100]..   
-0000fb00: 2023 2052 6564 6465 6e20 7769 7468 2043   # Redden with C
-0000fb10: 616c 7a65 7474 6930 300a 2020 2020 6966  alzetti00.    if
-0000fb20: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
-0000fb30: 6672 6f6d 2065 7874 696e 6374 696f 6e20  from extinction 
-0000fb40: 696d 706f 7274 2063 616c 7a65 7474 6930  import calzetti0
-0000fb50: 300a 2020 2020 2020 2020 4176 203d 2031  0.        Av = 1
-0000fb60: 2e30 0a20 2020 2020 2020 2052 7620 3d20  .0.        Rv = 
-0000fb70: 332e 310a 0a20 2020 2020 2020 2077 6176  3.1..        wav
-0000fb80: 6573 203d 206c 696e 655f 7761 7665 6c65  es = line_wavele
-0000fb90: 6e67 7468 735b 2742 616c 6d65 7220 3130  ngths['Balmer 10
-0000fba0: 6b4b 202b 204d 6749 4927 5d0a 2020 2020  kK + MgII'].    
-0000fbb0: 2020 2020 7261 7469 6f73 203d 206c 696e      ratios = lin
-0000fbc0: 655f 7261 7469 6f73 5b27 4261 6c6d 6572  e_ratios['Balmer
-0000fbd0: 2031 306b 4b20 2b20 4d67 4949 275d 0a0a   10kK + MgII']..
-0000fbe0: 2020 2020 2020 2020 666f 7220 4176 2069          for Av i
-0000fbf0: 6e20 5b30 2e35 2c20 312e 302c 2032 2e30  n [0.5, 1.0, 2.0
-0000fc00: 5d3a 0a20 2020 2020 2020 2020 2020 206d  ]:.            m
-0000fc10: 7265 6420 3d20 6361 6c7a 6574 7469 3030  red = calzetti00
-0000fc20: 286e 702e 6172 7261 7928 7761 7665 7329  (np.array(waves)
-0000fc30: 2c20 4176 2c20 5276 290a 2020 2020 2020  , Av, Rv).      
-0000fc40: 2020 2020 2020 6672 6564 203d 2031 302a        fred = 10*
-0000fc50: 2a28 2d30 2e34 2a6d 7265 6429 0a0a 2020  *(-0.4*mred)..  
-0000fc60: 2020 2020 2020 2020 2020 6b65 7920 3d20            key = 
-0000fc70: 2742 616c 6d65 7220 3130 6b4b 202b 204d  'Balmer 10kK + M
-0000fc80: 6749 4920 4176 3d7b 303a 2e31 667d 272e  gII Av={0:.1f}'.
-0000fc90: 666f 726d 6174 2841 7629 0a20 2020 2020  format(Av).     
-0000fca0: 2020 2020 2020 206c 696e 655f 7761 7665         line_wave
-0000fcb0: 6c65 6e67 7468 735b 6b65 795d 203d 205b  lengths[key] = [
-0000fcc0: 7720 666f 7220 7720 696e 2077 6176 6573  w for w in waves
-0000fcd0: 5d0a 2020 2020 2020 2020 2020 2020 6c69  ].            li
-0000fce0: 6e65 5f72 6174 696f 735b 6b65 795d 203d  ne_ratios[key] =
-0000fcf0: 205b 7261 7469 6f73 5b69 5d2a 6672 6564   [ratios[i]*fred
-0000fd00: 5b69 5d20 666f 7220 6920 696e 2072 616e  [i] for i in ran
-0000fd10: 6765 286c 656e 2877 6176 6573 2929 5d0a  ge(len(waves))].
-0000fd20: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-0000fd30: 6e67 7468 735b 2742 616c 6d65 7220 3130  ngths['Balmer 10
-0000fd40: 6b4b 202b 204d 6749 4920 4176 3d30 2e35  kK + MgII Av=0.5
-0000fd50: 275d 203d 205b 3635 3634 2e36 312c 2034  '] = [6564.61, 4
-0000fd60: 3836 322e 3638 2c20 3433 3431 2e36 382c  862.68, 4341.68,
-0000fd70: 2034 3130 312e 3733 2c20 3339 3731 2e31   4101.73, 3971.1
-0000fd80: 3938 2c20 3237 3939 2e31 3137 2c20 3132  98, 2799.117, 12
-0000fd90: 3832 312e 362c 2031 3039 3431 2e31 5d0a  821.6, 10941.1].
-0000fda0: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
-0000fdb0: 2742 616c 6d65 7220 3130 6b4b 202b 204d  'Balmer 10kK + M
-0000fdc0: 6749 4920 4176 3d30 2e35 275d 203d 205b  gII Av=0.5'] = [
-0000fdd0: 322e 3030 3938 3131 3933 3837 3938 3531  2.00981193879851
-0000fde0: 352c 2030 2e35 3831 3735 3636 3634 3135  5, 0.58175666415
-0000fdf0: 3231 3435 392c 2030 2e32 3531 3736 3937  21459, 0.2517697
-0000fe00: 3038 3234 3536 3639 3133 2c20 302e 3133  0824566913, 0.13
-0000fe10: 3338 3430 3933 3639 3636 3539 3032 2c20  38409369665902, 
-0000fe20: 302e 3038 3037 3932 3039 3838 3037 3439  0.08079209880749
-0000fe30: 3938 342c 2031 2e31 3733 3932 3937 3833  984, 1.173929783
-0000fe40: 3936 3930 3331 372c 2030 2e31 3330 3932  9690317, 0.13092
-0000fe50: 3535 3339 3930 3531 3331 3738 2c20 302e  553990513178, 0.
-0000fe60: 3035 3033 3338 3636 3132 3734 3737 3635  0503386612747765
-0000fe70: 315d 0a0a 2020 2020 6c69 6e65 5f77 6176  1]..    line_wav
-0000fe80: 656c 656e 6774 6873 5b27 4261 6c6d 6572  elengths['Balmer
-0000fe90: 2031 306b 4b20 2b20 4d67 4949 2041 763d   10kK + MgII Av=
-0000fea0: 312e 3027 5d20 3d20 5b36 3536 342e 3631  1.0'] = [6564.61
-0000feb0: 2c20 3438 3632 2e36 382c 2034 3334 312e  , 4862.68, 4341.
-0000fec0: 3638 2c20 3431 3031 2e37 332c 2033 3937  68, 4101.73, 397
-0000fed0: 312e 3139 382c 2032 3739 392e 3131 372c  1.198, 2799.117,
-0000fee0: 2031 3238 3231 2e36 2c20 3130 3934 312e   12821.6, 10941.
-0000fef0: 315d 0a20 2020 206c 696e 655f 7261 7469  1].    line_rati
-0000ff00: 6f73 5b27 4261 6c6d 6572 2031 306b 4b20  os['Balmer 10kK 
-0000ff10: 2b20 4d67 4949 2041 763d 312e 3027 5d20  + MgII Av=1.0'] 
-0000ff20: 3d20 5b31 2e34 3132 3335 3830 3532 3231  = [1.41235805221
-0000ff30: 3537 3530 342c 2030 2e33 3338 3434 3038  57504, 0.3384408
-0000ff40: 3136 3238 3534 3332 3636 2c20 302e 3133  1628543266, 0.13
-0000ff50: 3534 3434 3431 3435 3038 3738 3036 372c  544441450878067,
-0000ff60: 2030 2e30 3639 3136 3336 3932 3639 3533   0.0691636926953
-0000ff70: 3436 362c 2030 2e30 3430 3739 3630 3230  466, 0.040796020
-0000ff80: 3138 3537 3535 3131 2c20 302e 3435 3933  18575511, 0.4593
-0000ff90: 3730 3337 3932 3239 3835 3931 2c20 302e  703792298591, 0.
-0000ffa0: 3132 3438 3635 3231 3730 3730 3538 3735  1248652170705875
-0000ffb0: 312c 2030 2e30 3435 3433 3632 3730 3733  1, 0.04543627073
-0000ffc0: 3538 3230 3034 355d 0a0a 2020 2020 6c69  5820045]..    li
-0000ffd0: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-0000ffe0: 4261 6c6d 6572 2031 306b 4b20 2b20 4d67  Balmer 10kK + Mg
-0000fff0: 4949 2041 763d 322e 3027 5d20 3d20 5b36  II Av=2.0'] = [6
-00010000: 3536 342e 3631 2c20 3438 3632 2e36 382c  564.61, 4862.68,
-00010010: 2034 3334 312e 3638 2c20 3431 3031 2e37   4341.68, 4101.7
-00010020: 332c 2033 3937 312e 3139 382c 2032 3739  3, 3971.198, 279
-00010030: 392e 3131 372c 2031 3238 3231 2e36 2c20  9.117, 12821.6, 
-00010040: 3130 3934 312e 315d 0a20 2020 206c 696e  10941.1].    lin
-00010050: 655f 7261 7469 6f73 5b27 4261 6c6d 6572  e_ratios['Balmer
-00010060: 2031 306b 4b20 2b20 4d67 4949 2041 763d   10kK + MgII Av=
-00010070: 322e 3027 5d20 3d20 5b30 2e36 3937 3436  2.0'] = [0.69746
-00010080: 3638 3736 3830 3337 3330 322c 2030 2e31  68768037302, 0.1
-00010090: 3134 3534 3231 3836 3132 3739 3439 3939  1454218612794999
-000100a0: 2c20 302e 3033 3931 3939 3132 3236 3935  , 0.039199122695
-000100b0: 3738 3238 392c 2030 2e30 3138 3436 3935  78289, 0.0184695
-000100c0: 3631 3334 3037 3538 3037 332c 2030 2e30  61340758073, 0.0
-000100d0: 3130 3430 3139 3730 3339 3337 3238 3336  1040197039372836
-000100e0: 322c 2030 2e30 3730 3334 3033 3831 3737  2, 0.07034038177
-000100f0: 3132 3631 352c 2030 2e31 3133 3537 3331  12615, 0.1135731
-00010100: 3532 3932 3839 3430 3434 2c20 302e 3033  5292894044, 0.03
-00010110: 3730 3137 3239 3738 3031 3330 3432 325d  701729780130422]
-00010120: 0a20 2020 200a 2020 2020 2323 2323 2323  .    .    ######
-00010130: 2323 2323 230a 2020 2020 0a20 2020 2023  #####.    .    #
-00010140: 2052 6564 6465 6e65 6420 7769 7468 204b   Reddened with K
-00010150: 7269 656b 2026 2043 6f6e 726f 7920 6475  riek & Conroy du
-00010160: 7374 2c20 7461 755f 563d 302e 350a 2020  st, tau_V=0.5.  
-00010170: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
-00010180: 6873 5b27 4261 6c6d 6572 2031 306b 4b20  hs['Balmer 10kK 
-00010190: 7430 2e35 275d 203d 205b 3635 3634 2e36  t0.5'] = [6564.6
-000101a0: 312c 2034 3836 322e 3638 2c20 3433 3431  1, 4862.68, 4341
-000101b0: 2e36 382c 2034 3130 312e 3733 5d0a 2020  .68, 4101.73].  
-000101c0: 2020 6c69 6e65 5f72 6174 696f 735b 2742    line_ratios['B
-000101d0: 616c 6d65 7220 3130 6b4b 2074 302e 3527  almer 10kK t0.5'
-000101e0: 5d20 3d20 5b32 2e38 362a 302e 3638 2c20  ] = [2.86*0.68, 
-000101f0: 312e 302a 302e 3535 2c20 302e 3436 382a  1.0*0.55, 0.468*
-00010200: 302e 3531 2c20 302e 3235 392a 302e 3438  0.51, 0.259*0.48
-00010210: 5d0a 0a20 2020 2023 2052 6564 6465 6e65  ]..    # Reddene
-00010220: 6420 7769 7468 204b 7269 656b 2026 2043  d with Kriek & C
-00010230: 6f6e 726f 7920 6475 7374 2c20 7461 755f  onroy dust, tau_
-00010240: 563d 310a 2020 2020 6c69 6e65 5f77 6176  V=1.    line_wav
-00010250: 656c 656e 6774 6873 5b27 4261 6c6d 6572  elengths['Balmer
-00010260: 2031 306b 4b20 7431 275d 203d 205b 3635   10kK t1'] = [65
-00010270: 3634 2e36 312c 2034 3836 322e 3638 2c20  64.61, 4862.68, 
-00010280: 3433 3431 2e36 382c 2034 3130 312e 3733  4341.68, 4101.73
-00010290: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
-000102a0: 735b 2742 616c 6d65 7220 3130 6b4b 2074  s['Balmer 10kK t
-000102b0: 3127 5d20 3d20 5b32 2e38 362a 302e 3436  1'] = [2.86*0.46
-000102c0: 2c20 312e 302a 302e 3331 2c20 302e 3436  , 1.0*0.31, 0.46
-000102d0: 382a 302e 3235 362c 2030 2e32 3539 2a30  8*0.256, 0.259*0
-000102e0: 2e32 3332 5d0a 0a20 2020 206c 696e 655f  .232]..    line_
-000102f0: 7761 7665 6c65 6e67 7468 735b 274f 4949  wavelengths['OII
-00010300: 492d 3433 3633 275d 203d 205b 3433 3634  I-4363'] = [4364
-00010310: 2e34 3336 5d0a 2020 2020 6c69 6e65 5f72  .436].    line_r
-00010320: 6174 696f 735b 274f 4949 492d 3433 3633  atios['OIII-4363
-00010330: 275d 203d 205b 312e 5d0a 2020 2020 6c69  '] = [1.].    li
-00010340: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-00010350: 4f49 4949 275d 203d 205b 3530 3038 2e32  OIII'] = [5008.2
-00010360: 3430 2c20 3439 3630 2e32 3935 5d0a 2020  40, 4960.295].  
-00010370: 2020 6c69 6e65 5f72 6174 696f 735b 274f    line_ratios['O
-00010380: 4949 4927 5d20 3d20 5b32 2e39 382c 2031  III'] = [2.98, 1
-00010390: 5d0a 0a20 2020 2023 2053 706c 6974 2064  ]..    # Split d
-000103a0: 6f75 626c 6574 2c20 6966 206e 6565 6465  oublet, if neede
-000103b0: 640a 2020 2020 6c69 6e65 5f77 6176 656c  d.    line_wavel
-000103c0: 656e 6774 6873 5b27 4f49 4949 2d34 3935  engths['OIII-495
-000103d0: 3927 5d20 3d20 5b34 3936 302e 3239 355d  9'] = [4960.295]
-000103e0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
-000103f0: 5b27 4f49 4949 2d34 3935 3927 5d20 3d20  ['OIII-4959'] = 
-00010400: 5b31 5d0a 2020 2020 6c69 6e65 5f77 6176  [1].    line_wav
-00010410: 656c 656e 6774 6873 5b27 4f49 4949 2d35  elengths['OIII-5
-00010420: 3030 3727 5d20 3d20 5b35 3030 382e 3234  007'] = [5008.24
-00010430: 305d 0a20 2020 206c 696e 655f 7261 7469  0].    line_rati
-00010440: 6f73 5b27 4f49 4949 2d35 3030 3727 5d20  os['OIII-5007'] 
-00010450: 3d20 5b31 5d0a 0a20 2020 206c 696e 655f  = [1]..    line_
-00010460: 7761 7665 6c65 6e67 7468 735b 274f 4949  wavelengths['OII
-00010470: 275d 203d 205b 3337 3237 2e30 3932 2c20  '] = [3727.092, 
-00010480: 3337 3239 2e38 3735 5d0a 2020 2020 6c69  3729.875].    li
-00010490: 6e65 5f72 6174 696f 735b 274f 4949 275d  ne_ratios['OII']
-000104a0: 203d 205b 312c 2031 2e5d 0a0a 2020 2020   = [1, 1.]..    
-000104b0: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-000104c0: 5b27 4f49 2d36 3330 3227 5d20 3d20 5b36  ['OI-6302'] = [6
-000104d0: 3330 322e 3034 362c 2036 3336 352e 3533  302.046, 6365.53
-000104e0: 355d 0a20 2020 206c 696e 655f 7261 7469  5].    line_rati
-000104f0: 6f73 5b27 4f49 2d36 3330 3227 5d20 3d20  os['OI-6302'] = 
-00010500: 5b31 2c20 302e 3333 5d0a 2020 2020 6c69  [1, 0.33].    li
-00010510: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-00010520: 4f49 2d35 3537 3827 5d20 3d20 5b35 3537  OI-5578'] = [557
-00010530: 382e 3839 5d0a 2020 2020 6c69 6e65 5f72  8.89].    line_r
-00010540: 6174 696f 735b 274f 492d 3535 3738 275d  atios['OI-5578']
-00010550: 203d 205b 315d 0a0a 2020 2020 2320 4175   = [1]..    # Au
-00010560: 726f 7261 6c20 4f49 490a 2020 2020 2320  roral OII.    # 
-00010570: 6c69 6e65 7320 726f 7567 686c 7920 7461  lines roughly ta
-00010580: 6b65 6e20 6672 6f6d 2068 7474 7073 3a2f  ken from https:/
-00010590: 2f61 7278 6976 2e6f 7267 2f70 6466 2f31  /arxiv.org/pdf/1
-000105a0: 3631 302e 3036 3933 392e 7064 660a 2020  610.06939.pdf.  
-000105b0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
-000105c0: 6873 5b27 4f49 492d 3733 3235 275d 203d  hs['OII-7325'] =
-000105d0: 205b 3733 3232 2e30 2c20 3733 3332 2e5d   [7322.0, 7332.]
+0000bbd0: 2020 636f 756e 7473 203d 206e 702e 6f6e    counts = np.on
+0000bbe0: 6573 5f6c 696b 6528 6170 6572 5f72 6164  es_like(aper_rad
+0000bbf0: 6969 290a 2020 2020 666f 7220 692c 2072  ii).    for i, r
+0000bc00: 5f61 7065 7220 696e 2065 6e75 6d65 7261  _aper in enumera
+0000bc10: 7465 2861 7065 725f 7261 6469 6929 3a0a  te(aper_radii):.
+0000bc20: 2020 2020 2020 2020 2370 7269 6e74 286f          #print(o
+0000bc30: 6273 6d6f 6465 2c20 725f 6170 6572 290a  bsmode, r_aper).
+0000bc40: 2020 2020 2020 2020 6270 203d 2053 2e4f          bp = S.O
+0000bc50: 6273 4261 6e64 7061 7373 286f 6273 6d6f  bsBandpass(obsmo
+0000bc60: 6465 2b27 2c61 7065 7223 7b30 3a2e 3266  de+',aper#{0:.2f
+0000bc70: 7d27 2e66 6f72 6d61 7428 725f 6170 6572  }'.format(r_aper
+0000bc80: 2929 0a20 2020 2020 2020 206f 6273 203d  )).        obs =
+0000bc90: 2053 2e4f 6273 6572 7661 7469 6f6e 2873   S.Observation(s
+0000bca0: 702c 2062 7029 0a20 2020 2020 2020 2063  p, bp).        c
+0000bcb0: 6f75 6e74 735b 695d 203d 206f 6273 2e63  ounts[i] = obs.c
+0000bcc0: 6f75 6e74 7261 7465 2829 0a0a 2020 2020  ountrate()..    
+0000bcd0: 7265 7475 726e 2063 6f75 6e74 7320 2f20  return counts / 
+0000bce0: 6e6f 726d 5f63 6f75 6e74 730a 0a0a 6465  norm_counts...de
+0000bcf0: 6620 7068 6f74 666e 755f 6672 6f6d 5f70  f photfnu_from_p
+0000bd00: 686f 7466 6c61 6d28 7068 6f74 666c 616d  hotflam(photflam
+0000bd10: 2c20 7068 6f74 706c 616d 293a 0a20 2020  , photplam):.   
+0000bd20: 2022 2222 0a20 2020 2043 6f6d 7075 7465   """.    Compute
+0000bd30: 2050 484f 5446 4e55 2066 726f 6d20 5048   PHOTFNU from PH
+0000bd40: 4f54 464c 414d 2b50 484f 5450 4c41 4d2c  OTFLAM+PHOTPLAM,
+0000bd50: 2065 2e67 2e2c 2066 6f72 2041 4353 2f57   e.g., for ACS/W
+0000bd60: 4643 0a20 2020 2022 2222 0a20 2020 205a  FC.    """.    Z
+0000bd70: 5020 3d20 2d32 2e35 2a6e 702e 6c6f 6731  P = -2.5*np.log1
+0000bd80: 3028 7068 6f74 666c 616d 2920 2d20 3231  0(photflam) - 21
+0000bd90: 2e31 3020 2d20 352a 6e70 2e6c 6f67 3130  .10 - 5*np.log10
+0000bda0: 2870 686f 7470 6c61 6d29 202b 2031 382e  (photplam) + 18.
+0000bdb0: 3639 3231 0a20 2020 2070 686f 7466 6e75  6921.    photfnu
+0000bdc0: 203d 2031 302a 2a28 2d30 2e34 2a28 5a50   = 10**(-0.4*(ZP
+0000bdd0: 2d32 332e 3929 292a 312e 652d 360a 2020  -23.9))*1.e-6.  
+0000bde0: 2020 7265 7475 726e 2070 686f 7466 6e75    return photfnu
+0000bdf0: 0a0a 0a64 6566 2063 616c 635f 6865 6164  ...def calc_head
+0000be00: 6572 5f7a 6572 6f70 6f69 6e74 2869 6d2c  er_zeropoint(im,
+0000be10: 2065 7874 3d30 293a 0a20 2020 2022 2222   ext=0):.    """
+0000be20: 0a20 2020 2044 6574 6572 6d69 6e65 2041  .    Determine A
+0000be30: 4220 7a65 726f 706f 696e 7420 6672 6f6d  B zeropoint from
+0000be40: 2069 6d61 6765 2068 6561 6465 720a 0a20   image header.. 
+0000be50: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+0000be60: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+0000be70: 2069 6d20 3a20 607e 6173 7472 6f70 792e   im : `~astropy.
+0000be80: 696f 2e66 6974 732e 4844 554c 6973 7460  io.fits.HDUList`
+0000be90: 206f 720a 2020 2020 2020 2020 496d 6167   or.        Imag
+0000bea0: 6520 6f62 6a65 6374 206f 7220 6865 6164  e object or head
+0000beb0: 6572 2e0a 0a20 2020 2052 6574 7572 6e73  er...    Returns
+0000bec0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+0000bed0: 205a 5020 3a20 666c 6f61 740a 2020 2020   ZP : float.    
+0000bee0: 2020 2020 4142 207a 6572 6f70 6f69 6e74      AB zeropoint
+0000bef0: 0a0a 2020 2020 2222 220a 2020 2020 6672  ..    """.    fr
+0000bf00: 6f6d 202e 2069 6d70 6f72 7420 6d6f 6465  om . import mode
+0000bf10: 6c0a 0a20 2020 2073 6361 6c65 5f65 7870  l..    scale_exp
+0000bf20: 7469 6d65 203d 2031 2e0a 0a20 2020 2069  time = 1...    i
+0000bf30: 6620 6973 696e 7374 616e 6365 2869 6d2c  f isinstance(im,
+0000bf40: 2070 7966 6974 732e 4865 6164 6572 293a   pyfits.Header):
+0000bf50: 0a20 2020 2020 2020 2068 6561 6465 7220  .        header 
+0000bf60: 3d20 696d 0a20 2020 2065 6c73 653a 0a20  = im.    else:. 
+0000bf70: 2020 2020 2020 2069 6620 275f 6472 2720         if '_dr' 
+0000bf80: 696e 2069 6d2e 6669 6c65 6e61 6d65 2829  in im.filename()
+0000bf90: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
+0000bfa0: 7420 3d20 300a 2020 2020 2020 2020 656c  t = 0.        el
+0000bfb0: 6966 2027 5f66 6c27 2069 6e20 696d 2e66  if '_fl' in im.f
+0000bfc0: 696c 656e 616d 6528 293a 0a20 2020 2020  ilename():.     
+0000bfd0: 2020 2020 2020 2069 6620 2744 4554 4543         if 'DETEC
+0000bfe0: 544f 5227 2069 6e20 696d 5b30 5d2e 6865  TOR' in im[0].he
+0000bff0: 6164 6572 3a0a 2020 2020 2020 2020 2020  ader:.          
+0000c000: 2020 2020 2020 6966 2069 6d5b 305d 2e68        if im[0].h
+0000c010: 6561 6465 725b 2744 4554 4543 544f 5227  eader['DETECTOR'
+0000c020: 5d20 3d3d 2027 4952 273a 0a20 2020 2020  ] == 'IR':.     
+0000c030: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000c040: 7874 203d 2030 0a20 2020 2020 2020 2020  xt = 0.         
+0000c050: 2020 2020 2020 2020 2020 2062 756e 6974             bunit
+0000c060: 203d 2069 6d5b 315d 2e68 6561 6465 725b   = im[1].header[
+0000c070: 2742 554e 4954 275d 0a20 2020 2020 2020  'BUNIT'].       
+0000c080: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0a0: 2020 2023 2041 4353 202f 2055 5649 530a     # ACS / UVIS.
+0000c0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0c0: 2020 2020 6966 2065 7874 203d 3d20 303a      if ext == 0:
+0000c0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c0e0: 2020 2020 2020 2020 2065 7874 203d 2031           ext = 1
+0000c0f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000c100: 2020 2020 2020 6275 6e69 7420 3d20 696d        bunit = im
+0000c110: 5b31 5d2e 6865 6164 6572 5b27 4255 4e49  [1].header['BUNI
+0000c120: 5427 5d0a 0a20 2020 2020 2020 2020 2020  T']..           
+0000c130: 2020 2020 2069 6620 6275 6e69 7420 3d3d       if bunit ==
+0000c140: 2027 454c 4543 5452 4f4e 5327 3a0a 2020   'ELECTRONS':.  
+0000c150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c160: 2020 7363 616c 655f 6578 7074 696d 6520    scale_exptime 
+0000c170: 3d20 696d 5b30 5d2e 6865 6164 6572 5b27  = im[0].header['
+0000c180: 4558 5054 494d 4527 5d0a 0a20 2020 2020  EXPTIME']..     
+0000c190: 2020 2068 6561 6465 7220 3d20 696d 5b65     header = im[e
+0000c1a0: 7874 5d2e 6865 6164 6572 0a0a 2020 2020  xt].header..    
+0000c1b0: 7472 793a 0a20 2020 2020 2020 2066 6920  try:.        fi 
+0000c1c0: 3d20 7061 7273 655f 6669 6c74 6572 5f66  = parse_filter_f
+0000c1d0: 726f 6d5f 6865 6164 6572 2869 6d5b 305d  rom_header(im[0]
+0000c1e0: 2e68 6561 6465 7229 2e75 7070 6572 2829  .header).upper()
+0000c1f0: 0a20 2020 2065 7863 6570 743a 0a20 2020  .    except:.   
+0000c200: 2020 2020 2066 6920 3d20 4e6f 6e65 0a0a       fi = None..
+0000c210: 2020 2020 2320 4765 7420 4142 207a 6572      # Get AB zer
+0000c220: 6f70 6f69 6e74 0a20 2020 2069 6620 2741  opoint.    if 'A
+0000c230: 505a 5027 2069 6e20 6865 6164 6572 3a0a  PZP' in header:.
+0000c240: 2020 2020 2020 2020 5a50 203d 2068 6561          ZP = hea
+0000c250: 6465 725b 2741 425a 5027 5d0a 2020 2020  der['ABZP'].    
+0000c260: 0a20 2020 2065 6c69 6620 2750 484f 5446  .    elif 'PHOTF
+0000c270: 4e55 2720 696e 2068 6561 6465 723a 0a20  NU' in header:. 
+0000c280: 2020 2020 2020 205a 5020 3d20 2d32 2e35         ZP = -2.5
+0000c290: 2a6e 702e 6c6f 6731 3028 6865 6164 6572  *np.log10(header
+0000c2a0: 5b27 5048 4f54 464e 5527 5d29 2b38 2e39  ['PHOTFNU'])+8.9
+0000c2b0: 300a 2020 2020 2020 2020 5a50 202b 3d20  0.        ZP += 
+0000c2c0: 322e 352a 6e70 2e6c 6f67 3130 2873 6361  2.5*np.log10(sca
+0000c2d0: 6c65 5f65 7870 7469 6d65 290a 2020 2020  le_exptime).    
+0000c2e0: 2020 2020 0a20 2020 2065 6c69 6620 2750      .    elif 'P
+0000c2f0: 484f 5446 4c41 4d27 2069 6e20 6865 6164  HOTFLAM' in head
+0000c300: 6572 3a0a 2020 2020 2020 2020 5a50 203d  er:.        ZP =
+0000c310: 2028 2d32 2e35 2a6e 702e 6c6f 6731 3028   (-2.5*np.log10(
+0000c320: 6865 6164 6572 5b27 5048 4f54 464c 414d  header['PHOTFLAM
+0000c330: 275d 2920 2d20 3231 2e31 3020 2d0a 2020  ']) - 21.10 -.  
+0000c340: 2020 2020 2020 2020 2020 2020 352a 6e70              5*np
+0000c350: 2e6c 6f67 3130 2868 6561 6465 725b 2750  .log10(header['P
+0000c360: 484f 5450 4c41 4d27 5d29 202b 2031 382e  HOTPLAM']) + 18.
+0000c370: 3639 3231 290a 0a20 2020 2020 2020 205a  6921)..        Z
+0000c380: 5020 2b3d 2032 2e35 2a6e 702e 6c6f 6731  P += 2.5*np.log1
+0000c390: 3028 7363 616c 655f 6578 7074 696d 6529  0(scale_exptime)
+0000c3a0: 0a20 2020 200a 2020 2020 656c 6966 2028  .    .    elif (
+0000c3b0: 6669 2069 7320 6e6f 7420 4e6f 6e65 293a  fi is not None):
+0000c3c0: 0a20 2020 2020 2020 2069 6620 6669 2069  .        if fi i
+0000c3d0: 6e20 6d6f 6465 6c2e 7068 6f74 666c 616d  n model.photflam
+0000c3e0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
+0000c3f0: 2020 205a 5020 3d20 282d 322e 352a 6e70     ZP = (-2.5*np
+0000c400: 2e6c 6f67 3130 286d 6f64 656c 2e70 686f  .log10(model.pho
+0000c410: 7466 6c61 6d5f 6c69 7374 5b66 695d 2920  tflam_list[fi]) 
+0000c420: 2d20 3231 2e31 3020 2d0a 2020 2020 2020  - 21.10 -.      
+0000c430: 2020 2020 2020 2020 2020 2020 352a 6e70              5*np
+0000c440: 2e6c 6f67 3130 286d 6f64 656c 2e70 686f  .log10(model.pho
+0000c450: 7470 6c61 6d5f 6c69 7374 5b66 695d 2920  tplam_list[fi]) 
+0000c460: 2b20 3138 2e36 3932 3129 0a20 2020 2020  + 18.6921).     
+0000c470: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000c480: 2020 2020 2070 7269 6e74 2827 436f 756c       print('Coul
+0000c490: 646e 5c27 7420 6669 6e64 2050 484f 5446  dn\'t find PHOTF
+0000c4a0: 4e55 206f 7220 5048 4f54 504c 414d 2f50  NU or PHOTPLAM/P
+0000c4b0: 484f 5446 4c41 4d20 6b65 7977 6f72 6473  HOTFLAM keywords
+0000c4c0: 2c20 7573 6520 5a50 3d32 3527 290a 2020  , use ZP=25').  
+0000c4d0: 2020 2020 2020 2020 2020 5a50 203d 2032            ZP = 2
+0000c4e0: 350a 2020 2020 656c 7365 3a0a 2020 2020  5.    else:.    
+0000c4f0: 2020 2020 7072 696e 7428 2743 6f75 6c64      print('Could
+0000c500: 6e5c 2774 2066 696e 6420 4649 4c54 4552  n\'t find FILTER
+0000c510: 2c20 5048 4f54 464e 5520 6f72 2050 484f  , PHOTFNU or PHO
+0000c520: 5450 4c41 4d2f 5048 4f54 464c 414d 206b  TPLAM/PHOTFLAM k
+0000c530: 6579 776f 7264 732c 2075 7365 205a 503d  eywords, use ZP=
+0000c540: 3235 2729 0a20 2020 2020 2020 205a 5020  25').        ZP 
+0000c550: 3d20 3235 0a0a 2020 2020 2320 4966 207a  = 25..    # If z
+0000c560: 6572 6f70 6f69 6e74 2069 6e66 696e 6974  eropoint infinit
+0000c570: 6520 2865 2e67 2e2c 2050 484f 5446 4c41  e (e.g., PHOTFLA
+0000c580: 4d20 3d20 3029 2c20 7468 656e 2063 616c  M = 0), then cal
+0000c590: 6375 6c61 7465 2066 726f 6d20 7379 6e70  culate from synp
+0000c5a0: 686f 740a 2020 2020 6966 206e 6f74 206e  hot.    if not n
+0000c5b0: 702e 6973 6669 6e69 7465 285a 5029 3a0a  p.isfinite(ZP):.
+0000c5c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000c5d0: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
+0000c5e0: 7079 7379 6e70 686f 7420 6173 2053 0a20  pysynphot as S. 
+0000c5f0: 2020 2020 2020 2020 2020 2062 7020 3d20             bp = 
+0000c600: 532e 4f62 7342 616e 6470 6173 7328 696d  S.ObsBandpass(im
+0000c610: 5b30 5d2e 6865 6164 6572 5b27 5048 4f54  [0].header['PHOT
+0000c620: 4d4f 4445 275d 2e72 6570 6c61 6365 2827  MODE'].replace('
+0000c630: 2027 2c20 272c 2729 290a 2020 2020 2020   ', ',')).      
+0000c640: 2020 2020 2020 7370 6563 203d 2053 2e46        spec = S.F
+0000c650: 6c61 7453 7065 6374 7275 6d28 302c 2066  latSpectrum(0, f
+0000c660: 6c75 7875 6e69 7473 3d27 4142 4d61 6727  luxunits='ABMag'
+0000c670: 290a 2020 2020 2020 2020 2020 2020 6f62  ).            ob
+0000c680: 7320 3d20 532e 4f62 7365 7276 6174 696f  s = S.Observatio
+0000c690: 6e28 7370 6563 2c20 6270 290a 2020 2020  n(spec, bp).    
+0000c6a0: 2020 2020 2020 2020 5a50 203d 2032 2e35          ZP = 2.5
+0000c6b0: 2a6e 702e 6c6f 6731 3028 6f62 732e 636f  *np.log10(obs.co
+0000c6c0: 756e 7472 6174 6528 2929 0a20 2020 2020  untrate()).     
+0000c6d0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+0000c6e0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0000c6f0: 2072 6574 7572 6e20 5a50 0a0a 0a44 4546   return ZP...DEF
+0000c700: 4155 4c54 5f50 5249 4d41 5259 5f4b 4559  AULT_PRIMARY_KEY
+0000c710: 5320 3d20 5b27 4649 4c45 4e41 4d45 272c  S = ['FILENAME',
+0000c720: 2027 494e 5354 5255 4d45 272c 2027 494e   'INSTRUME', 'IN
+0000c730: 5354 5255 4d45 272c 2027 4445 5445 4354  STRUME', 'DETECT
+0000c740: 4f52 272c 2027 4649 4c54 4552 272c 2027  OR', 'FILTER', '
+0000c750: 4649 4c54 4552 3127 2c20 2746 494c 5445  FILTER1', 'FILTE
+0000c760: 5232 272c 2027 4558 5053 5441 5254 272c  R2', 'EXPSTART',
+0000c770: 2027 4441 5445 2d4f 4253 272c 2027 4558   'DATE-OBS', 'EX
+0000c780: 5054 494d 4527 2c20 2749 4443 5441 4227  PTIME', 'IDCTAB'
+0000c790: 2c20 274e 504f 4c46 494c 4527 2c20 2744  , 'NPOLFILE', 'D
+0000c7a0: 3249 4d46 494c 4527 2c20 2750 415f 5633  2IMFILE', 'PA_V3
+0000c7b0: 272c 2027 4647 534c 4f43 4b27 2c20 2747  ', 'FGSLOCK', 'G
+0000c7c0: 5952 4f4d 4f44 4527 2c20 2750 524f 504f  YROMODE', 'PROPO
+0000c7d0: 5349 4427 5d0a 0a23 2046 6f72 2067 7269  SID']..# For gri
+0000c7e0: 736d 0a44 4546 4155 4c54 5f45 5854 5f4b  sm.DEFAULT_EXT_K
+0000c7f0: 4559 5320 3d20 5b27 4558 544e 414d 4527  EYS = ['EXTNAME'
+0000c800: 2c20 2745 5854 5645 5227 2c20 274d 4452  , 'EXTVER', 'MDR
+0000c810: 495a 534b 5927 2c20 2743 5250 4958 3127  IZSKY', 'CRPIX1'
+0000c820: 2c20 2743 5250 4958 3227 2c20 2743 5256  , 'CRPIX2', 'CRV
+0000c830: 414c 3127 2c20 2743 5256 414c 3227 2c20  AL1', 'CRVAL2', 
+0000c840: 2743 4431 5f31 272c 2027 4344 315f 3227  'CD1_1', 'CD1_2'
+0000c850: 2c20 2743 4432 5f31 272c 2027 4344 325f  , 'CD2_1', 'CD2_
+0000c860: 3227 2c20 2750 4331 5f31 272c 2027 5043  2', 'PC1_1', 'PC
+0000c870: 315f 3227 2c20 2750 4332 5f31 272c 2027  1_2', 'PC2_1', '
+0000c880: 5043 325f 3227 2c20 2743 4445 4c54 3127  PC2_2', 'CDELT1'
+0000c890: 2c20 2743 4445 4c54 3227 2c20 2743 554e  , 'CDELT2', 'CUN
+0000c8a0: 4954 3127 2c20 2743 554e 4954 3227 2c20  IT1', 'CUNIT2', 
+0000c8b0: 2743 5459 5045 3127 2c20 2743 5459 5045  'CTYPE1', 'CTYPE
+0000c8c0: 3227 2c20 2752 4144 4553 5953 272c 2027  2', 'RADESYS', '
+0000c8d0: 4c4f 4e50 4f4c 4527 2c20 274c 4154 504f  LONPOLE', 'LATPO
+0000c8e0: 4c45 272c 2027 4944 4354 4142 272c 2027  LE', 'IDCTAB', '
+0000c8f0: 4432 494d 4558 5427 2c20 2757 4353 4e41  D2IMEXT', 'WCSNA
+0000c900: 4d45 272c 2027 5048 4f54 4d4f 4445 272c  ME', 'PHOTMODE',
+0000c910: 2027 4f52 4945 4e54 4154 272c 2027 4343   'ORIENTAT', 'CC
+0000c920: 4443 4849 5027 5d0a 0a0a 6465 6620 666c  DCHIP']...def fl
+0000c930: 745f 746f 5f64 6963 7428 666f 626a 2c20  t_to_dict(fobj, 
+0000c940: 7072 696d 6172 795f 6b65 7973 3d44 4546  primary_keys=DEF
+0000c950: 4155 4c54 5f50 5249 4d41 5259 5f4b 4559  AULT_PRIMARY_KEY
+0000c960: 532c 2065 7874 656e 7369 6f6e 733d 5b28  S, extensions=[(
+0000c970: 2753 4349 272c 2069 2b31 2920 666f 7220  'SCI', i+1) for 
+0000c980: 6920 696e 2072 616e 6765 2832 295d 2c20  i in range(2)], 
+0000c990: 6578 745f 6b65 7973 3d44 4546 4155 4c54  ext_keys=DEFAULT
+0000c9a0: 5f45 5854 5f4b 4559 5329 3a0a 2020 2020  _EXT_KEYS):.    
+0000c9b0: 2222 220a 2020 2020 5061 7273 6520 6261  """.    Parse ba
+0000c9c0: 7369 6320 656c 656d 656e 7473 2066 726f  sic elements fro
+0000c9d0: 6d20 6120 464c 542f 464c 4320 6865 6164  m a FLT/FLC head
+0000c9e0: 6572 2074 6f20 6120 6469 6374 696f 6e61  er to a dictiona
+0000c9f0: 7279 0a0a 2020 2020 5442 440a 0a20 2020  ry..    TBD..   
+0000ca00: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0000ca10: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2066  ----------.    f
+0000ca20: 6f62 6a20 3a20 607e 6173 7472 6f70 792e  obj : `~astropy.
+0000ca30: 696f 2e66 6974 732e 4844 554c 6973 7460  io.fits.HDUList`
+0000ca40: 0a20 2020 2020 2020 2046 4954 5320 6f62  .        FITS ob
+0000ca50: 6a65 6374 0a0a 2020 2020 7072 696d 6172  ject..    primar
+0000ca60: 795f 6b65 7973 203a 206c 6973 740a 2020  y_keys : list.  
+0000ca70: 2020 2020 2020 4b65 7977 6f72 6473 2074        Keywords t
+0000ca80: 6f20 6578 7472 6163 7420 6672 6f6d 2074  o extract from t
+0000ca90: 6865 2070 7269 6d61 7279 2065 7874 656e  he primary exten
+0000caa0: 7369 6f6e 2028 3029 2e0a 0a20 2020 2065  sion (0)...    e
+0000cab0: 7874 656e 7369 6f6e 7320 3a20 6c69 7374  xtensions : list
+0000cac0: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
+0000cad0: 2061 6464 6974 696f 6e61 6c20 6578 7465   additional exte
+0000cae0: 6e73 696f 6e20 6e61 6d65 7320 2f20 696e  nsion names / in
+0000caf0: 6469 6365 732e 0a0a 2020 2020 6578 745f  dices...    ext_
+0000cb00: 6b65 7973 203a 206c 6973 740a 2020 2020  keys : list.    
+0000cb10: 2020 2020 4b65 7977 6f72 6473 2074 6f20      Keywords to 
+0000cb20: 6578 7472 6163 7420 6672 6f6d 2074 6865  extract from the
+0000cb30: 2065 7874 656e 7369 6f6e 2068 6561 6465   extension heade
+0000cb40: 7273 2e0a 0a20 2020 2052 6574 7572 6e73  rs...    Returns
+0000cb50: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+0000cb60: 2066 6c74 5f64 6963 7420 3a20 6469 6374   flt_dict : dict
+0000cb70: 0a0a 2020 2020 2222 220a 2020 2020 696d  ..    """.    im
+0000cb80: 706f 7274 2061 7374 726f 7079 2e74 696d  port astropy.tim
+0000cb90: 650a 0a20 2020 2066 6c74 5f64 6963 7420  e..    flt_dict 
+0000cba0: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
+0000cbb0: 2020 2020 666c 745f 6469 6374 5b27 7469      flt_dict['ti
+0000cbc0: 6d65 7374 616d 7027 5d20 3d20 6173 7472  mestamp'] = astr
+0000cbd0: 6f70 792e 7469 6d65 2e54 696d 652e 6e6f  opy.time.Time.no
+0000cbe0: 7728 292e 6973 6f0a 2020 2020 6830 203d  w().iso.    h0 =
+0000cbf0: 2066 6f62 6a5b 305d 2e68 6561 6465 720a   fobj[0].header.
+0000cc00: 0a20 2020 2023 2050 7269 6d61 7279 206b  .    # Primary k
+0000cc10: 6579 776f 7264 730a 2020 2020 666f 7220  eywords.    for 
+0000cc20: 6b20 696e 2070 7269 6d61 7279 5f6b 6579  k in primary_key
+0000cc30: 733a 0a20 2020 2020 2020 2069 6620 6b20  s:.        if k 
+0000cc40: 696e 2068 303a 0a20 2020 2020 2020 2020  in h0:.         
+0000cc50: 2020 2066 6c74 5f64 6963 745b 6b5d 203d     flt_dict[k] =
+0000cc60: 2068 305b 6b5d 0a0a 2020 2020 2320 4772   h0[k]..    # Gr
+0000cc70: 6973 6d20 6b65 7973 0a20 2020 2066 6f72  ism keys.    for
+0000cc80: 206b 2069 6e20 6830 3a0a 2020 2020 2020   k in h0:.      
+0000cc90: 2020 6966 206b 2e73 7461 7274 7377 6974    if k.startswit
+0000cca0: 6828 2747 534b 5927 293a 0a20 2020 2020  h('GSKY'):.     
+0000ccb0: 2020 2020 2020 2066 6c74 5f64 6963 745b         flt_dict[
+0000ccc0: 6b5d 203d 2068 305b 6b5d 0a0a 2020 2020  k] = h0[k]..    
+0000ccd0: 2320 5743 532c 2065 7463 2e20 6b65 7977  # WCS, etc. keyw
+0000cce0: 6f72 6473 2066 726f 6d20 5343 4920 6578  ords from SCI ex
+0000ccf0: 7465 6e73 696f 6e73 0a20 2020 2066 6c74  tensions.    flt
+0000cd00: 5f64 6963 745b 2765 7874 656e 7369 6f6e  _dict['extension
+0000cd10: 7327 5d20 3d20 4f72 6465 7265 6444 6963  s'] = OrderedDic
+0000cd20: 7428 290a 2020 2020 636f 756e 7420 3d20  t().    count = 
+0000cd30: 300a 2020 2020 666f 7220 6578 7420 696e  0.    for ext in
+0000cd40: 2065 7874 656e 7369 6f6e 733a 0a20 2020   extensions:.   
+0000cd50: 2020 2020 2069 6620 6578 7420 696e 2066       if ext in f
+0000cd60: 6f62 6a3a 0a20 2020 2020 2020 2020 2020  obj:.           
+0000cd70: 2064 5f69 203d 204f 7264 6572 6564 4469   d_i = OrderedDi
+0000cd80: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+0000cd90: 2068 5f69 203d 2066 6f62 6a5b 6578 745d   h_i = fobj[ext]
+0000cda0: 2e68 6561 6465 720a 2020 2020 2020 2020  .header.        
+0000cdb0: 2020 2020 666f 7220 6b20 696e 2065 7874      for k in ext
+0000cdc0: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
+0000cdd0: 2020 2020 2020 2069 6620 6b20 696e 2068         if k in h
+0000cde0: 5f69 3a0a 2020 2020 2020 2020 2020 2020  _i:.            
+0000cdf0: 2020 2020 2020 2020 645f 695b 6b5d 203d          d_i[k] =
+0000ce00: 2068 5f69 5b6b 5d0a 0a20 2020 2020 2020   h_i[k]..       
+0000ce10: 2020 2020 2023 2047 7269 736d 206b 6579       # Grism key
+0000ce20: 730a 2020 2020 2020 2020 2020 2020 666f  s.            fo
+0000ce30: 7220 6b20 696e 2068 5f69 3a0a 2020 2020  r k in h_i:.    
+0000ce40: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+0000ce50: 2e73 7461 7274 7377 6974 6828 2747 534b  .startswith('GSK
+0000ce60: 5927 293a 0a20 2020 2020 2020 2020 2020  Y'):.           
+0000ce70: 2020 2020 2020 2020 2064 5f69 5b6b 5d20           d_i[k] 
+0000ce80: 3d20 685f 695b 6b5d 0a0a 2020 2020 2020  = h_i[k]..      
+0000ce90: 2020 2020 2020 636f 756e 7420 2b3d 2031        count += 1
+0000cea0: 0a20 2020 2020 2020 2020 2020 2066 6c74  .            flt
+0000ceb0: 5f64 6963 745b 2765 7874 656e 7369 6f6e  _dict['extension
+0000cec0: 7327 5d5b 636f 756e 745d 203d 2064 5f69  s'][count] = d_i
+0000ced0: 0a0a 2020 2020 7265 7475 726e 2066 6c74  ..    return flt
+0000cee0: 5f64 6963 740a 0a0a 6465 6620 6765 745f  _dict...def get_
+0000cef0: 7365 745f 6269 7473 2876 616c 7565 293a  set_bits(value):
+0000cf00: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
+0000cf10: 7075 7465 2077 6869 6368 2062 696e 6172  pute which binar
+0000cf20: 7920 6269 7473 2061 7265 2073 6574 2066  y bits are set f
+0000cf30: 6f72 2061 6e20 696e 7465 6765 720a 2020  or an integer.  
+0000cf40: 2020 2222 220a 0a20 2020 2069 6620 6861    """..    if ha
+0000cf50: 7361 7474 7228 7661 6c75 652c 2027 5f5f  sattr(value, '__
+0000cf60: 6974 6572 5f5f 2729 3a0a 2020 2020 2020  iter__'):.      
+0000cf70: 2020 7661 6c75 6573 203d 2076 616c 7565    values = value
+0000cf80: 0a20 2020 2020 2020 2073 696e 676c 6520  .        single 
+0000cf90: 3d20 4661 6c73 650a 2020 2020 656c 7365  = False.    else
+0000cfa0: 3a0a 2020 2020 2020 2020 7661 6c75 6573  :.        values
+0000cfb0: 203d 205b 7661 6c75 655d 0a20 2020 2020   = [value].     
+0000cfc0: 2020 2073 696e 676c 6520 3d20 5472 7565     single = True
+0000cfd0: 0a0a 2020 2020 7265 7375 6c74 203d 205b  ..    result = [
+0000cfe0: 5d0a 0a20 2020 2066 6f72 2076 2069 6e20  ]..    for v in 
+0000cff0: 7661 6c75 6573 3a0a 2020 2020 2020 2020  values:.        
+0000d000: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000d010: 2062 6974 7374 7220 3d20 6e70 2e62 696e   bitstr = np.bin
+0000d020: 6172 795f 7265 7072 2876 295b 3a3a 2d31  ary_repr(v)[::-1
+0000d030: 5d0a 2020 2020 2020 2020 6578 6365 7074  ].        except
+0000d040: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000d050: 7375 6c74 2e61 7070 656e 6428 5b5d 290a  sult.append([]).
+0000d060: 0a20 2020 2020 2020 206e 7365 7420 3d20  .        nset = 
+0000d070: 6269 7473 7472 2e63 6f75 6e74 2827 3127  bitstr.count('1'
+0000d080: 290a 2020 2020 2020 2020 7365 7462 6974  ).        setbit
+0000d090: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
+0000d0a0: 6a20 3d20 2d31 0a20 2020 2020 2020 2066  j = -1.        f
+0000d0b0: 6f72 2069 2069 6e20 7261 6e67 6528 6e73  or i in range(ns
+0000d0c0: 6574 293a 0a20 2020 2020 2020 2020 2020  et):.           
+0000d0d0: 206a 203d 2062 6974 7374 722e 696e 6465   j = bitstr.inde
+0000d0e0: 7828 2731 272c 206a 2b31 290a 2020 2020  x('1', j+1).    
+0000d0f0: 2020 2020 2020 2020 7365 7462 6974 732e          setbits.
+0000d100: 6170 7065 6e64 286a 290a 0a20 2020 2020  append(j)..     
+0000d110: 2020 2072 6573 756c 742e 6170 7065 6e64     result.append
+0000d120: 2873 6574 6269 7473 290a 0a20 2020 2069  (setbits)..    i
+0000d130: 6620 7369 6e67 6c65 3a0a 2020 2020 2020  f single:.      
+0000d140: 2020 7265 7475 726e 2072 6573 756c 745b    return result[
+0000d150: 305d 0a20 2020 2065 6c73 653a 0a20 2020  0].    else:.   
+0000d160: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+0000d170: 6c74 0a0a 0a64 6566 2075 6e73 6574 5f64  lt...def unset_d
+0000d180: 715f 6269 7473 2876 616c 7565 2c20 6f6b  q_bits(value, ok
+0000d190: 6269 7473 3d33 322b 3634 2b35 3132 2c20  bits=32+64+512, 
+0000d1a0: 7665 7262 6f73 653d 4661 6c73 6529 3a0a  verbose=False):.
+0000d1b0: 2020 2020 2222 220a 2020 2020 556e 7365      """.    Unse
+0000d1c0: 7420 6269 7420 666c 6167 7320 6672 6f6d  t bit flags from
+0000d1d0: 2061 2044 5120 6172 7261 790a 0a20 2020   a DQ array..   
+0000d1e0: 2046 6f72 2057 4643 332f 4952 2c20 7468   For WFC3/IR, th
+0000d1f0: 6520 666f 6c6c 6f77 696e 6720 4451 2062  e following DQ b
+0000d200: 6974 7320 6361 6e20 7573 7561 6c6c 7920  its can usually 
+0000d210: 6265 2075 6e73 6574 3a0a 0a20 2020 2033  be unset:..    3
+0000d220: 322c 2036 343a 2074 6865 7365 2070 6978  2, 64: these pix
+0000d230: 656c 7320 7573 7561 6c6c 7920 7365 656d  els usually seem
+0000d240: 204f 4b0a 2020 2020 2020 2035 3132 3a20   OK.       512: 
+0000d250: 626c 6f62 7320 6e6f 7420 7265 6c65 7661  blobs not releva
+0000d260: 6e74 2066 6f72 2067 7269 736d 2065 7870  nt for grism exp
+0000d270: 6f73 7572 6573 0a0a 2020 2020 5061 7261  osures..    Para
+0000d280: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+0000d290: 2d2d 2d2d 2d0a 2020 2020 7661 6c75 6520  -----.    value 
+0000d2a0: 3a20 696e 742c 2060 7e6e 756d 7079 2e6e  : int, `~numpy.n
+0000d2b0: 6461 7272 6179 600a 2020 2020 2020 2020  darray`.        
+0000d2c0: 496e 7075 7420 4451 2076 616c 7565 0a0a  Input DQ value..
+0000d2d0: 2020 2020 6f6b 6269 7473 203a 2069 6e74      okbits : int
+0000d2e0: 0a20 2020 2020 2020 2042 6974 7320 746f  .        Bits to
+0000d2f0: 2075 6e73 6574 0a0a 2020 2020 7665 7262   unset..    verb
+0000d300: 6f73 6520 3a20 626f 6f6c 0a20 2020 2020  ose : bool.     
+0000d310: 2020 2050 7269 6e74 2073 6f6d 6520 696e     Print some in
+0000d320: 666f 726d 6174 696f 6e0a 0a20 2020 2052  formation..    R
+0000d330: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+0000d340: 2d2d 0a20 2020 206e 6577 5f76 616c 7565  --.    new_value
+0000d350: 203a 2069 6e74 2c20 607e 6e75 6d70 792e   : int, `~numpy.
+0000d360: 6e64 6172 7261 7960 0a0a 2020 2020 2222  ndarray`..    ""
+0000d370: 220a 2020 2020 6269 6e5f 6269 7473 203d  ".    bin_bits =
+0000d380: 206e 702e 6269 6e61 7279 5f72 6570 7228   np.binary_repr(
+0000d390: 6f6b 6269 7473 290a 2020 2020 6e20 3d20  okbits).    n = 
+0000d3a0: 6c65 6e28 6269 6e5f 6269 7473 290a 2020  len(bin_bits).  
+0000d3b0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0000d3c0: 286e 293a 0a20 2020 2020 2020 2069 6620  (n):.        if 
+0000d3d0: 6269 6e5f 6269 7473 5b2d 2869 2b31 295d  bin_bits[-(i+1)]
+0000d3e0: 203d 3d20 2731 273a 0a20 2020 2020 2020   == '1':.       
+0000d3f0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+0000d400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d410: 2070 7269 6e74 2832 2a2a 6929 0a0a 2020   print(2**i)..  
+0000d420: 2020 2020 2020 2020 2020 7661 6c75 6520            value 
+0000d430: 2d3d 2028 7661 6c75 6520 2620 322a 2a69  -= (value & 2**i
+0000d440: 290a 0a20 2020 2072 6574 7572 6e20 7661  )..    return va
+0000d450: 6c75 650a 0a0a 6465 6620 6465 7465 6374  lue...def detect
+0000d460: 5f77 6974 685f 7068 6f74 7574 696c 7328  _with_photutils(
+0000d470: 7363 692c 2065 7272 3d4e 6f6e 652c 2064  sci, err=None, d
+0000d480: 713d 4e6f 6e65 2c20 7365 673d 4e6f 6e65  q=None, seg=None
+0000d490: 2c20 6465 7465 6374 5f74 6872 6573 683d  , detect_thresh=
+0000d4a0: 322e 2c0a 2020 2020 2020 2020 2020 2020  2.,.            
+0000d4b0: 2020 2020 2020 2020 2020 2020 6e70 6978              npix
+0000d4c0: 656c 733d 382c 2067 726f 775f 7365 673d  els=8, grow_seg=
+0000d4d0: 352c 2067 6175 7373 5f66 7768 6d3d 322e  5, gauss_fwhm=2.
+0000d4e0: 2c20 6773 697a 653d 332c 0a20 2020 2020  , gsize=3,.     
+0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d500: 2020 2077 6373 3d4e 6f6e 652c 2073 6176     wcs=None, sav
+0000d510: 655f 6465 7465 6374 696f 6e3d 4661 6c73  e_detection=Fals
+0000d520: 652c 2072 6f6f 743d 276d 7963 6174 272c  e, root='mycat',
+0000d530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d540: 2020 2020 2020 2020 2062 6163 6b67 726f           backgro
+0000d550: 756e 643d 4e6f 6e65 2c20 6761 696e 3d4e  und=None, gain=N
+0000d560: 6f6e 652c 2041 425f 7a65 726f 706f 696e  one, AB_zeropoin
+0000d570: 743d 302e 2c0a 2020 2020 2020 2020 2020  t=0.,.          
+0000d580: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000d590: 6e61 6d65 5f63 6f6c 756d 6e73 3d7b 2778  name_columns={'x
+0000d5a0: 6365 6e74 726f 6964 273a 2027 785f 666c  centroid': 'x_fl
+0000d5b0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+0000d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d5d0: 2020 2020 2020 2020 2020 2020 2020 2779                'y
+0000d5e0: 6365 6e74 726f 6964 273a 2027 795f 666c  centroid': 'y_fl
+0000d5f0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
+0000d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d610: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+0000d620: 615f 6963 7273 5f63 656e 7472 6f69 6427  a_icrs_centroid'
+0000d630: 3a20 2772 6127 2c0a 2020 2020 2020 2020  : 'ra',.        
+0000d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d660: 2020 2764 6563 5f69 6372 735f 6365 6e74    'dec_icrs_cent
+0000d670: 726f 6964 273a 2027 6465 6327 7d2c 0a20  roid': 'dec'},. 
+0000d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d690: 2020 2020 2020 206f 7665 7277 7269 7465         overwrite
+0000d6a0: 3d54 7275 652c 2076 6572 626f 7365 3d54  =True, verbose=T
+0000d6b0: 7275 6529 3a0a 2020 2020 2222 220a 2020  rue):.    """.  
+0000d6c0: 2020 5573 6520 607e 7068 6f74 7574 696c    Use `~photutil
+0000d6d0: 7360 2074 6f20 6465 7465 6374 206f 626a  s` to detect obj
+0000d6e0: 6563 7473 2061 6e64 206d 616b 6520 7365  ects and make se
+0000d6f0: 676d 656e 7461 7469 6f6e 206d 6170 0a20  gmentation map. 
+0000d700: 2020 200a 2020 2020 2e2e 206e 6f74 653a     .    .. note:
+0000d710: 3a20 0a20 2020 2020 2020 2044 6570 7265  : .        Depre
+0000d720: 6361 7465 6420 696e 2066 6176 6f72 206f  cated in favor o
+0000d730: 6620 7365 7020 6361 7461 6c6f 6773 2069  f sep catalogs i
+0000d740: 6e20 607e 6772 697a 6c69 2e70 7265 7060  n `~grizli.prep`
+0000d750: 2e0a 2020 2020 0a20 2020 2050 6172 616d  ..    .    Param
+0000d760: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+0000d770: 2d2d 2d2d 0a20 2020 2073 6369 203a 2060  ----.    sci : `
+0000d780: 7e6e 756d 7079 2e6e 6461 7272 6179 600a  ~numpy.ndarray`.
+0000d790: 2020 2020 2020 2020 5442 440a 0a20 2020          TBD..   
+0000d7a0: 2065 7272 2c20 6471 2c20 7365 6720 3a20   err, dq, seg : 
+0000d7b0: 5442 440a 0a20 2020 2064 6574 6563 745f  TBD..    detect_
+0000d7c0: 7468 7265 7368 203a 2066 6c6f 6174 0a20  thresh : float. 
+0000d7d0: 2020 2020 2020 2044 6574 6563 7469 6f6e         Detection
+0000d7e0: 2074 6872 6573 686f 6c64 2c20 696e 203a   threshold, in :
+0000d7f0: 6d61 7468 3a60 5c73 6967 6d61 600a 0a20  math:`\sigma`.. 
+0000d800: 2020 2067 726f 775f 7365 6720 3a20 696e     grow_seg : in
+0000d810: 740a 2020 2020 2020 2020 4e75 6d62 6572  t.        Number
+0000d820: 206f 6620 7069 7865 6c73 2074 6f20 6772   of pixels to gr
+0000d830: 6f77 2061 726f 756e 6420 7468 6520 7065  ow around the pe
+0000d840: 7269 6d65 7465 7220 6f66 2064 6574 6563  rimeter of detec
+0000d850: 7465 6420 6f62 6a65 6374 730a 2020 2020  ted objects.    
+0000d860: 2020 2020 7769 7468 6120 206d 6178 696d      witha  maxim
+0000d870: 756d 2066 696c 7465 720a 0a20 2020 2067  um filter..    g
+0000d880: 6175 7373 5f66 7768 6d20 3a20 666c 6f61  auss_fwhm : floa
+0000d890: 740a 2020 2020 2020 2020 4657 484d 206f  t.        FWHM o
+0000d8a0: 6620 4761 7573 7369 616e 2063 6f6e 766f  f Gaussian convo
+0000d8b0: 6c75 7469 6f6e 206b 6572 6e65 6c20 7468  lution kernel th
+0000d8c0: 6174 2073 6d6f 6f74 6865 7320 7468 6520  at smoothes the 
+0000d8d0: 6465 7465 6374 696f 6e0a 2020 2020 2020  detection.      
+0000d8e0: 2020 696d 6167 652e 0a0a 2020 2020 7665    image...    ve
+0000d8f0: 7262 6f73 6520 3a20 626f 6f6c 0a20 2020  rbose : bool.   
+0000d900: 2020 2020 2050 7269 6e74 206c 6f67 6769       Print loggi
+0000d910: 6e67 2069 6e66 6f72 6d61 7469 6f6e 2074  ng information t
+0000d920: 6f20 7468 6520 7465 726d 696e 616c 0a0a  o the terminal..
+0000d930: 2020 2020 7361 7665 5f64 6574 6563 7469      save_detecti
+0000d940: 6f6e 203a 2062 6f6f 6c0a 2020 2020 2020  on : bool.      
+0000d950: 2020 5361 7665 2074 6865 2064 6574 6563    Save the detec
+0000d960: 7469 6f6e 2069 6d61 6765 7320 616e 6420  tion images and 
+0000d970: 6361 7461 6c6f 6773 0a0a 2020 2020 7763  catalogs..    wc
+0000d980: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
+0000d990: 732e 5743 5360 0a20 2020 2020 2020 2057  s.WCS`.        W
+0000d9a0: 4353 206f 626a 6563 7420 7061 7373 6564  CS object passed
+0000d9b0: 2074 6f20 6070 686f 7475 7469 6c73 2e73   to `photutils.s
+0000d9c0: 6f75 7263 655f 7072 6f70 6572 7469 6573  ource_properties
+0000d9d0: 6020 7573 6564 2074 6f20 636f 6d70 7574  ` used to comput
+0000d9e0: 650a 2020 2020 2020 2020 736b 7920 636f  e.        sky co
+0000d9f0: 6f72 6469 6e61 7465 7320 6f66 2064 6574  ordinates of det
+0000da00: 6563 7465 6420 6f62 6a65 6374 732e 0a0a  ected objects...
+0000da10: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+0000da20: 2d2d 2d2d 2d2d 2d0a 2020 2020 6361 7461  -------.    cata
+0000da30: 6c6f 6720 3a20 607e 6173 7472 6f70 792e  log : `~astropy.
+0000da40: 7461 626c 652e 5461 626c 6560 0a20 2020  table.Table`.   
+0000da50: 2020 2020 204f 626a 6563 7420 6361 7461       Object cata
+0000da60: 6c6f 6720 7769 7468 2074 6865 2064 6566  log with the def
+0000da70: 6175 6c74 2070 6172 616d 6574 6572 732e  ault parameters.
+0000da80: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+0000da90: 6f72 7420 7363 6970 792e 6e64 696d 6167  ort scipy.ndimag
+0000daa0: 6520 6173 206e 640a 0a20 2020 2066 726f  e as nd..    fro
+0000dab0: 6d20 7068 6f74 7574 696c 7320 696d 706f  m photutils impo
+0000dac0: 7274 2064 6574 6563 745f 7468 7265 7368  rt detect_thresh
+0000dad0: 6f6c 642c 2064 6574 6563 745f 736f 7572  old, detect_sour
+0000dae0: 6365 732c 2053 6567 6d65 6e74 6174 696f  ces, Segmentatio
+0000daf0: 6e49 6d61 6765 0a20 2020 2066 726f 6d20  nImage.    from 
+0000db00: 7068 6f74 7574 696c 7320 696d 706f 7274  photutils import
+0000db10: 2073 6f75 7263 655f 7072 6f70 6572 7469   source_properti
+0000db20: 6573 0a0a 2020 2020 696d 706f 7274 2061  es..    import a
+0000db30: 7374 726f 7079 2e69 6f2e 6669 7473 2061  stropy.io.fits a
+0000db40: 7320 7079 6669 7473 0a20 2020 2066 726f  s pyfits.    fro
+0000db50: 6d20 6173 7472 6f70 792e 7461 626c 6520  m astropy.table 
+0000db60: 696d 706f 7274 2043 6f6c 756d 6e0a 0a20  import Column.. 
+0000db70: 2020 2066 726f 6d20 6173 7472 6f70 792e     from astropy.
+0000db80: 7374 6174 7320 696d 706f 7274 2073 6967  stats import sig
+0000db90: 6d61 5f63 6c69 7070 6564 5f73 7461 7473  ma_clipped_stats
+0000dba0: 2c20 6761 7573 7369 616e 5f66 7768 6d5f  , gaussian_fwhm_
+0000dbb0: 746f 5f73 6967 6d61 0a20 2020 2066 726f  to_sigma.    fro
+0000dbc0: 6d20 6173 7472 6f70 792e 636f 6e76 6f6c  m astropy.convol
+0000dbd0: 7574 696f 6e20 696d 706f 7274 2047 6175  ution import Gau
+0000dbe0: 7373 6961 6e32 444b 6572 6e65 6c0a 0a20  ssian2DKernel.. 
+0000dbf0: 2020 2023 2044 5120 6d61 736b 730a 2020     # DQ masks.  
+0000dc00: 2020 6d61 736b 203d 2028 7363 6920 3d3d    mask = (sci ==
+0000dc10: 2030 290a 2020 2020 6966 2064 7120 6973   0).    if dq is
+0000dc20: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000dc30: 2020 206d 6173 6b20 7c3d 2064 7120 3e20     mask |= dq > 
+0000dc40: 300a 0a20 2020 2023 2044 6574 6563 7469  0..    # Detecti
+0000dc50: 6f6e 2074 6872 6573 686f 6c64 0a20 2020  on threshold.   
+0000dc60: 2069 6620 6572 7220 6973 204e 6f6e 653a   if err is None:
+0000dc70: 0a20 2020 2020 2020 2074 6872 6573 686f  .        thresho
+0000dc80: 6c64 203d 2064 6574 6563 745f 7468 7265  ld = detect_thre
+0000dc90: 7368 6f6c 6428 7363 692c 2073 6e72 3d64  shold(sci, snr=d
+0000dca0: 6574 6563 745f 7468 7265 7368 2c20 6d61  etect_thresh, ma
+0000dcb0: 736b 3d6d 6173 6b29 0a20 2020 2065 6c73  sk=mask).    els
+0000dcc0: 653a 0a20 2020 2020 2020 2074 6872 6573  e:.        thres
+0000dcd0: 686f 6c64 203d 2028 6465 7465 6374 5f74  hold = (detect_t
+0000dce0: 6872 6573 6820 2a20 6572 7229 2a28 7e6d  hresh * err)*(~m
+0000dcf0: 6173 6b29 0a20 2020 2020 2020 2074 6872  ask).        thr
+0000dd00: 6573 686f 6c64 5b6d 6173 6b5d 203d 206e  eshold[mask] = n
+0000dd10: 702e 6d65 6469 616e 2874 6872 6573 686f  p.median(thresho
+0000dd20: 6c64 5b7e 6d61 736b 5d29 0a0a 2020 2020  ld[~mask])..    
+0000dd30: 6966 2073 6567 2069 7320 4e6f 6e65 3a0a  if seg is None:.
+0000dd40: 2020 2020 2020 2020 2320 5275 6e20 7468          # Run th
+0000dd50: 6520 736f 7572 6365 2064 6574 6563 7469  e source detecti
+0000dd60: 6f6e 2061 6e64 2063 7265 6174 6520 7468  on and create th
+0000dd70: 6520 7365 676d 656e 7461 7469 6f6e 2069  e segmentation i
+0000dd80: 6d61 6765 0a0a 2020 2020 2020 2020 2320  mage..        # 
+0000dd90: 4761 7573 7369 616e 206b 6572 6e65 6c0a  Gaussian kernel.
+0000dda0: 2020 2020 2020 2020 7369 676d 6120 3d20          sigma = 
+0000ddb0: 6761 7573 735f 6677 686d 202a 2067 6175  gauss_fwhm * gau
+0000ddc0: 7373 6961 6e5f 6677 686d 5f74 6f5f 7369  ssian_fwhm_to_si
+0000ddd0: 676d 6120 2020 2023 2046 5748 4d20 3d20  gma    # FWHM = 
+0000dde0: 322e 0a20 2020 2020 2020 206b 6572 6e65  2..        kerne
+0000ddf0: 6c20 3d20 4761 7573 7369 616e 3244 4b65  l = Gaussian2DKe
+0000de00: 726e 656c 2873 6967 6d61 2c20 785f 7369  rnel(sigma, x_si
+0000de10: 7a65 3d67 7369 7a65 2c20 795f 7369 7a65  ze=gsize, y_size
+0000de20: 3d67 7369 7a65 290a 2020 2020 2020 2020  =gsize).        
+0000de30: 6b65 726e 656c 2e6e 6f72 6d61 6c69 7a65  kernel.normalize
+0000de40: 2829 0a0a 2020 2020 2020 2020 6966 2076  ()..        if v
+0000de50: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0000de60: 2020 2020 7072 696e 7428 277b 307d 3a20      print('{0}: 
+0000de70: 7068 6f74 7574 696c 732e 6465 7465 6374  photutils.detect
+0000de80: 5f73 6f75 7263 6573 2028 6465 7465 6374  _sources (detect
+0000de90: 5f74 6872 6573 683d 7b31 3a2e 3166 7d2c  _thresh={1:.1f},
+0000dea0: 2067 726f 775f 7365 673d 7b32 3a64 7d2c   grow_seg={2:d},
+0000deb0: 2067 6175 7373 5f66 7768 6d3d 7b33 3a2e   gauss_fwhm={3:.
+0000dec0: 3166 7d2c 205a 503d 7b34 3a2e 3166 7d29  1f}, ZP={4:.1f})
+0000ded0: 272e 666f 726d 6174 2872 6f6f 742c 2064  '.format(root, d
+0000dee0: 6574 6563 745f 7468 7265 7368 2c20 6772  etect_thresh, gr
+0000def0: 6f77 5f73 6567 2c20 6761 7573 735f 6677  ow_seg, gauss_fw
+0000df00: 686d 2c20 4142 5f7a 6572 6f70 6f69 6e74  hm, AB_zeropoint
+0000df10: 2929 0a0a 2020 2020 2020 2020 2320 4465  ))..        # De
+0000df20: 7465 6374 2073 6f75 7263 6573 0a20 2020  tect sources.   
+0000df30: 2020 2020 2073 6567 6d20 3d20 6465 7465       segm = dete
+0000df40: 6374 5f73 6f75 7263 6573 2873 6369 2a28  ct_sources(sci*(
+0000df50: 7e6d 6173 6b29 2c20 7468 7265 7368 6f6c  ~mask), threshol
+0000df60: 642c 206e 7069 7865 6c73 3d6e 7069 7865  d, npixels=npixe
+0000df70: 6c73 2c0a 2020 2020 2020 2020 2020 2020  ls,.            
+0000df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df90: 2020 6669 6c74 6572 5f6b 6572 6e65 6c3d    filter_kernel=
+0000dfa0: 6b65 726e 656c 290a 0a20 2020 2020 2020  kernel)..       
+0000dfb0: 2067 726f 7720 3d20 6e64 2e6d 6178 696d   grow = nd.maxim
+0000dfc0: 756d 5f66 696c 7465 7228 7365 676d 2e64  um_filter(segm.d
+0000dfd0: 6174 612c 2067 726f 775f 7365 6729 0a20  ata, grow_seg). 
+0000dfe0: 2020 2020 2020 2073 6567 203d 206e 702e         seg = np.
+0000dff0: 6361 7374 5b6e 702e 666c 6f61 7433 325d  cast[np.float32]
+0000e000: 2867 726f 7729 0a20 2020 2065 6c73 653a  (grow).    else:
+0000e010: 0a20 2020 2020 2020 2023 2055 7365 2074  .        # Use t
+0000e020: 6865 2073 7570 706c 6965 6420 7365 676d  he supplied segm
+0000e030: 656e 7461 7469 6f6e 2069 6d61 6765 0a20  entation image. 
+0000e040: 2020 2020 2020 2073 6567 6d20 3d20 5365         segm = Se
+0000e050: 676d 656e 7461 7469 6f6e 496d 6167 6528  gmentationImage(
+0000e060: 7365 6729 0a0a 2020 2020 2320 536f 7572  seg)..    # Sour
+0000e070: 6365 2070 726f 7065 7274 6965 7320 6361  ce properties ca
+0000e080: 7461 6c6f 670a 2020 2020 6966 2076 6572  talog.    if ver
+0000e090: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
+0000e0a0: 696e 7428 277b 307d 3a20 7068 6f74 7574  int('{0}: photut
+0000e0b0: 696c 732e 736f 7572 6365 5f70 726f 7065  ils.source_prope
+0000e0c0: 7274 6965 7327 2e66 6f72 6d61 7428 726f  rties'.format(ro
+0000e0d0: 6f74 2929 0a0a 2020 2020 7072 6f70 7320  ot))..    props 
+0000e0e0: 3d20 736f 7572 6365 5f70 726f 7065 7274  = source_propert
+0000e0f0: 6965 7328 7363 692c 2073 6567 6d2c 2065  ies(sci, segm, e
+0000e100: 7272 6f72 3d74 6872 6573 686f 6c64 2f64  rror=threshold/d
+0000e110: 6574 6563 745f 7468 7265 7368 2c0a 2020  etect_thresh,.  
+0000e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e130: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+0000e140: 3d6d 6173 6b2c 2062 6163 6b67 726f 756e  =mask, backgroun
+0000e150: 643d 6261 636b 6772 6f75 6e64 2c20 7763  d=background, wc
+0000e160: 733d 7763 7329 0a0a 2020 2020 6361 7461  s=wcs)..    cata
+0000e170: 6c6f 6720 3d20 7072 6f70 732e 746f 5f74  log = props.to_t
+0000e180: 6162 6c65 2829 0a0a 2020 2020 2320 4d61  able()..    # Ma
+0000e190: 6720 636f 6c75 6d6e 730a 2020 2020 6d61  g columns.    ma
+0000e1a0: 6720 3d20 4142 5f7a 6572 6f70 6f69 6e74  g = AB_zeropoint
+0000e1b0: 202d 2032 2e35 2a6e 702e 6c6f 6731 3028   - 2.5*np.log10(
+0000e1c0: 6361 7461 6c6f 675b 2773 6f75 7263 655f  catalog['source_
+0000e1d0: 7375 6d27 5d29 0a20 2020 206d 6167 2e5f  sum']).    mag._
+0000e1e0: 6e61 6d65 203d 2027 6d61 6727 0a20 2020  name = 'mag'.   
+0000e1f0: 2063 6174 616c 6f67 2e61 6464 5f63 6f6c   catalog.add_col
+0000e200: 756d 6e28 6d61 6729 0a0a 2020 2020 7472  umn(mag)..    tr
+0000e210: 793a 0a20 2020 2020 2020 206c 6f67 7363  y:.        logsc
+0000e220: 616c 6520 3d20 322e 352f 6e70 2e6c 6f67  ale = 2.5/np.log
+0000e230: 2831 3029 0a20 2020 2020 2020 206d 6167  (10).        mag
+0000e240: 5f65 7272 203d 206c 6f67 7363 616c 652a  _err = logscale*
+0000e250: 6361 7461 6c6f 675b 2773 6f75 7263 655f  catalog['source_
+0000e260: 7375 6d5f 6572 7227 5d2f 6361 7461 6c6f  sum_err']/catalo
+0000e270: 675b 2773 6f75 7263 655f 7375 6d27 5d0a  g['source_sum'].
+0000e280: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+0000e290: 2020 2020 6d61 675f 6572 7220 3d20 6e70      mag_err = np
+0000e2a0: 2e7a 6572 6f73 5f6c 696b 6528 6d61 6729  .zeros_like(mag)
+0000e2b0: 2d39 390a 0a20 2020 206d 6167 5f65 7272  -99..    mag_err
+0000e2c0: 2e5f 6e61 6d65 203d 2027 6d61 675f 6572  ._name = 'mag_er
+0000e2d0: 7227 0a20 2020 2063 6174 616c 6f67 2e61  r'.    catalog.a
+0000e2e0: 6464 5f63 6f6c 756d 6e28 6d61 675f 6572  dd_column(mag_er
+0000e2f0: 7229 0a0a 2020 2020 2320 5265 6e61 6d65  r)..    # Rename
+0000e300: 2073 6f6d 6520 6361 7461 6c6f 6720 636f   some catalog co
+0000e310: 6c75 6d6e 730a 2020 2020 666f 7220 6b65  lumns.    for ke
+0000e320: 7920 696e 2072 656e 616d 655f 636f 6c75  y in rename_colu
+0000e330: 6d6e 732e 6b65 7973 2829 3a0a 2020 2020  mns.keys():.    
+0000e340: 2020 2020 6966 206b 6579 206e 6f74 2069      if key not i
+0000e350: 6e20 6361 7461 6c6f 672e 636f 6c6e 616d  n catalog.colnam
+0000e360: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0000e370: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+0000e380: 2020 6361 7461 6c6f 672e 7265 6e61 6d65    catalog.rename
+0000e390: 5f63 6f6c 756d 6e28 6b65 792c 2072 656e  _column(key, ren
+0000e3a0: 616d 655f 636f 6c75 6d6e 735b 6b65 795d  ame_columns[key]
+0000e3b0: 290a 2020 2020 2020 2020 6966 2076 6572  ).        if ver
+0000e3c0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0000e3d0: 2020 7072 696e 7428 2752 656e 616d 6520    print('Rename 
+0000e3e0: 636f 6c75 6d6e 3a20 7b30 7d20 2d3e 207b  column: {0} -> {
+0000e3f0: 317d 272e 666f 726d 6174 286b 6579 2c20  1}'.format(key, 
+0000e400: 7265 6e61 6d65 5f63 6f6c 756d 6e73 5b6b  rename_columns[k
+0000e410: 6579 5d29 290a 0a20 2020 2023 2044 6f6e  ey]))..    # Don
+0000e420: 6521 0a20 2020 2069 6620 7665 7262 6f73  e!.    if verbos
+0000e430: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
+0000e440: 284e 4f5f 4e45 574c 494e 4520 2b20 2827  (NO_NEWLINE + ('
+0000e450: 7b30 7d3a 2070 686f 7475 7469 6c73 2e73  {0}: photutils.s
+0000e460: 6f75 7263 655f 7072 6f70 6572 7469 6573  ource_properties
+0000e470: 202d 207b 313a 647d 206f 626a 6563 7473   - {1:d} objects
+0000e480: 272e 666f 726d 6174 2872 6f6f 742c 206c  '.format(root, l
+0000e490: 656e 2863 6174 616c 6f67 2929 2929 0a0a  en(catalog))))..
+0000e4a0: 2020 2020 2320 5361 7665 206f 7574 7075      # Save outpu
+0000e4b0: 7473 3f0a 2020 2020 6966 2073 6176 655f  ts?.    if save_
+0000e4c0: 6465 7465 6374 696f 6e3a 0a20 2020 2020  detection:.     
+0000e4d0: 2020 2073 6567 5f66 696c 6520 3d20 726f     seg_file = ro
+0000e4e0: 6f74 202b 2027 2e64 6574 6563 745f 7365  ot + '.detect_se
+0000e4f0: 672e 6669 7473 270a 2020 2020 2020 2020  g.fits'.        
+0000e500: 7365 675f 6361 7420 3d20 726f 6f74 202b  seg_cat = root +
+0000e510: 2027 2e64 6574 6563 742e 6361 7427 0a20   '.detect.cat'. 
+0000e520: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0000e530: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0000e540: 7269 6e74 2827 7b30 7d3a 2073 6176 6520  rint('{0}: save 
+0000e550: 7b31 7d2c 207b 327d 272e 666f 726d 6174  {1}, {2}'.format
+0000e560: 2872 6f6f 742c 2073 6567 5f66 696c 652c  (root, seg_file,
+0000e570: 2073 6567 5f63 6174 2929 0a0a 2020 2020   seg_cat))..    
+0000e580: 2020 2020 6966 2077 6373 2069 7320 6e6f      if wcs is no
+0000e590: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000e5a0: 2020 2020 6865 6164 6572 203d 2077 6373      header = wcs
+0000e5b0: 2e74 6f5f 6865 6164 6572 2872 656c 6178  .to_header(relax
+0000e5c0: 3d54 7275 6529 0a20 2020 2020 2020 2065  =True).        e
+0000e5d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000e5e0: 2068 6561 6465 7220 3d20 4e6f 6e65 0a0a   header = None..
+0000e5f0: 2020 2020 2020 2020 7079 6669 7473 2e77          pyfits.w
+0000e600: 7269 7465 746f 2873 6567 5f66 696c 652c  riteto(seg_file,
+0000e610: 2064 6174 613d 7365 672c 2068 6561 6465   data=seg, heade
+0000e620: 723d 6865 6164 6572 2c20 6f76 6572 7772  r=header, overwr
+0000e630: 6974 653d 6f76 6572 7772 6974 6529 0a0a  ite=overwrite)..
+0000e640: 2020 2020 2020 2020 6966 206f 732e 7061          if os.pa
+0000e650: 7468 2e65 7869 7374 7328 7365 675f 6361  th.exists(seg_ca
+0000e660: 7429 2026 206f 7665 7277 7269 7465 3a0a  t) & overwrite:.
+0000e670: 2020 2020 2020 2020 2020 2020 6f73 2e72              os.r
+0000e680: 656d 6f76 6528 7365 675f 6361 7429 0a0a  emove(seg_cat)..
+0000e690: 2020 2020 2020 2020 6361 7461 6c6f 672e          catalog.
+0000e6a0: 7772 6974 6528 7365 675f 6361 742c 2066  write(seg_cat, f
+0000e6b0: 6f72 6d61 743d 2761 7363 6969 2e63 6f6d  ormat='ascii.com
+0000e6c0: 6d65 6e74 6564 5f68 6561 6465 7227 290a  mented_header').
+0000e6d0: 0a20 2020 2072 6574 7572 6e20 6361 7461  .    return cata
+0000e6e0: 6c6f 672c 2073 6567 0a0a 0a64 6566 2073  log, seg...def s
+0000e6f0: 6166 655f 696e 7665 7274 2861 7272 293a  afe_invert(arr):
+0000e700: 0a20 2020 2022 2222 0a20 2020 2076 6572  .    """.    ver
+0000e710: 7369 6f6e 2d73 6166 6520 6d61 7472 6978  sion-safe matrix
+0000e720: 2069 6e76 6572 7369 6f6e 2075 7369 6e67   inversion using
+0000e730: 206e 702e 6c69 6e61 6c67 206f 7220 6e70   np.linalg or np
+0000e740: 2e6d 6174 7269 782e 490a 2020 2020 2222  .matrix.I.    ""
+0000e750: 220a 2020 2020 7472 793a 0a20 2020 2020  ".    try:.     
+0000e760: 2020 2066 726f 6d20 6e75 6d70 792e 6c69     from numpy.li
+0000e770: 6e61 6c67 2069 6d70 6f72 7420 696e 760a  nalg import inv.
+0000e780: 2020 2020 2020 2020 5f69 6e76 203d 2069          _inv = i
+0000e790: 6e76 2861 7272 290a 2020 2020 6578 6365  nv(arr).    exce
+0000e7a0: 7074 3a0a 2020 2020 2020 2020 5f69 6e76  pt:.        _inv
+0000e7b0: 203d 206e 702e 6d61 7472 6978 2861 7272   = np.matrix(arr
+0000e7c0: 292e 492e 410a 2020 2020 0a20 2020 2072  ).I.A.    .    r
+0000e7d0: 6574 7572 6e20 5f69 6e76 0a20 2020 200a  eturn _inv.    .
+0000e7e0: 0a64 6566 206e 6d61 6428 6461 7461 293a  .def nmad(data):
+0000e7f0: 0a20 2020 2022 2222 4e6f 726d 616c 697a  .    """Normaliz
+0000e800: 6564 204e 4d41 443d 312e 3438 3236 3032  ed NMAD=1.482602
+0000e810: 3220 2a20 607e 2e61 7374 726f 7079 2e73  2 * `~.astropy.s
+0000e820: 7461 7473 2e6d 6564 6961 6e5f 6162 736f  tats.median_abso
+0000e830: 6c75 7465 5f64 6576 6961 7469 6f6e 600a  lute_deviation`.
+0000e840: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+0000e850: 6f72 7420 6173 7472 6f70 792e 7374 6174  ort astropy.stat
+0000e860: 730a 2020 2020 7265 7475 726e 2031 2e34  s.    return 1.4
+0000e870: 3832 3630 3232 2a61 7374 726f 7079 2e73  826022*astropy.s
+0000e880: 7461 7473 2e6d 6564 6961 6e5f 6162 736f  tats.median_abso
+0000e890: 6c75 7465 5f64 6576 6961 7469 6f6e 2864  lute_deviation(d
+0000e8a0: 6174 6129 0a0a 0a64 6566 2067 6574 5f6c  ata)...def get_l
+0000e8b0: 696e 655f 7761 7665 6c65 6e67 7468 7328  ine_wavelengths(
+0000e8c0: 293a 0a20 2020 2022 2222 4765 7420 6120  ):.    """Get a 
+0000e8d0: 6469 6374 696f 6e61 7279 206f 6620 636f  dictionary of co
+0000e8e0: 6d6d 6f6e 2065 6d69 7373 696f 6e20 6c69  mmon emission li
+0000e8f0: 6e65 2077 6176 656c 656e 6774 6873 2061  ne wavelengths a
+0000e900: 6e64 206c 696e 6520 7261 7469 6f73 0a0a  nd line ratios..
+0000e910: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+0000e920: 2d2d 2d2d 2d2d 2d0a 2020 2020 6c69 6e65  -------.    line
+0000e930: 5f77 6176 656c 656e 6774 6873 2c20 6c69  _wavelengths, li
+0000e940: 6e65 5f72 6174 696f 7320 3a20 6469 6374  ne_ratios : dict
+0000e950: 0a20 2020 2020 2020 204b 6579 7320 6172  .        Keys ar
+0000e960: 6520 636f 6d6d 6f6e 2074 6f20 626f 7468  e common to both
+0000e970: 2064 6963 7469 6f6e 6172 6965 7320 616e   dictionaries an
+0000e980: 6420 6172 6520 7369 6d70 6c65 206e 616d  d are simple nam
+0000e990: 6573 2066 6f72 206c 696e 6573 0a20 2020  es for lines.   
+0000e9a0: 2020 2020 2061 6e64 206c 696e 6520 636f       and line co
+0000e9b0: 6d70 6c65 7865 732e 2020 5661 6c75 6573  mplexes.  Values
+0000e9c0: 2061 7265 206c 6973 7473 206f 6620 6c69   are lists of li
+0000e9d0: 6e65 2077 6176 656c 656e 6774 6873 2061  ne wavelengths a
+0000e9e0: 6e64 206c 696e 650a 2020 2020 2020 2020  nd line.        
+0000e9f0: 7261 7469 6f73 2e0a 0a20 2020 2020 2020  ratios...       
+0000ea00: 2020 2020 203e 3e3e 2066 726f 6d20 6772       >>> from gr
+0000ea10: 697a 6c69 2e75 7469 6c73 2069 6d70 6f72  izli.utils impor
+0000ea20: 7420 6765 745f 6c69 6e65 5f77 6176 656c  t get_line_wavel
+0000ea30: 656e 6774 6873 0a20 2020 2020 2020 2020  engths.         
+0000ea40: 2020 203e 3e3e 206c 696e 655f 7761 7665     >>> line_wave
+0000ea50: 6c65 6e67 7468 732c 206c 696e 655f 7261  lengths, line_ra
+0000ea60: 7469 6f73 203d 2067 6574 5f6c 696e 655f  tios = get_line_
+0000ea70: 7761 7665 6c65 6e67 7468 7328 290a 2020  wavelengths().  
+0000ea80: 2020 2020 2020 2020 2020 3e3e 3e20 7072            >>> pr
+0000ea90: 696e 7428 6c69 6e65 5f77 6176 656c 656e  int(line_wavelen
+0000eaa0: 6774 6873 5b27 4861 275d 2c20 6c69 6e65  gths['Ha'], line
+0000eab0: 5f72 6174 696f 735b 2748 6127 5d29 0a20  _ratios['Ha']). 
+0000eac0: 2020 2020 2020 2020 2020 205b 3635 3634             [6564
+0000ead0: 2e36 315d 205b 312e 305d 0a20 2020 2020  .61] [1.0].     
+0000eae0: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+0000eaf0: 286c 696e 655f 7761 7665 6c65 6e67 7468  (line_wavelength
+0000eb00: 735b 274f 4949 4927 5d2c 206c 696e 655f  s['OIII'], line_
+0000eb10: 7261 7469 6f73 5b27 4f49 4949 275d 290a  ratios['OIII']).
+0000eb20: 2020 2020 2020 2020 2020 2020 5b35 3030              [500
+0000eb30: 382e 3234 2c20 3439 3630 2e32 3935 5d20  8.24, 4960.295] 
+0000eb40: 5b32 2e39 382c 2031 5d0a 0a20 2020 2020  [2.98, 1]..     
+0000eb50: 2020 2049 6e63 6c75 6465 7320 736f 6d65     Includes some
+0000eb60: 2061 6464 6974 696f 6e61 6c20 636f 6d62   additional comb
+0000eb70: 696e 6564 206c 696e 6520 636f 6d70 6c65  ined line comple
+0000eb80: 7865 7320 7573 6566 756c 2066 6f72 2072  xes useful for r
+0000eb90: 6564 7368 6966 740a 2020 2020 2020 2020  edshift.        
+0000eba0: 6669 7473 3a0a 0a20 2020 2020 2020 2020  fits:..         
+0000ebb0: 2020 203e 3e3e 2066 726f 6d20 6772 697a     >>> from griz
+0000ebc0: 6c69 2e75 7469 6c73 2069 6d70 6f72 7420  li.utils import 
+0000ebd0: 6765 745f 6c69 6e65 5f77 6176 656c 656e  get_line_wavelen
+0000ebe0: 6774 6873 0a20 2020 2020 2020 2020 2020  gths.           
+0000ebf0: 203e 3e3e 206c 696e 655f 7761 7665 6c65   >>> line_wavele
+0000ec00: 6e67 7468 732c 206c 696e 655f 7261 7469  ngths, line_rati
+0000ec10: 6f73 203d 2067 6574 5f6c 696e 655f 7761  os = get_line_wa
+0000ec20: 7665 6c65 6e67 7468 7328 290a 2020 2020  velengths().    
+0000ec30: 2020 2020 2020 2020 3e3e 3e20 6b65 7920          >>> key 
+0000ec40: 3d20 2748 612b 5349 492b 5349 4949 2b48  = 'Ha+SII+SIII+H
+0000ec50: 6527 0a20 2020 2020 2020 2020 2020 203e  e'.            >
+0000ec60: 3e3e 2070 7269 6e74 286c 696e 655f 7761  >> print(line_wa
+0000ec70: 7665 6c65 6e67 7468 735b 6b65 795d 2c20  velengths[key], 
+0000ec80: 275c 5c6e 272c 206c 696e 655f 7261 7469  '\\n', line_rati
+0000ec90: 6f73 5b6b 6579 5d29 0a20 2020 2020 2020  os[key]).       
+0000eca0: 2020 2020 205b 3635 3634 2e36 312c 2036       [6564.61, 6
+0000ecb0: 3731 382e 3239 2c20 3637 3332 2e36 372c  718.29, 6732.67,
+0000ecc0: 2039 3036 382e 362c 2039 3533 302e 362c   9068.6, 9530.6,
+0000ecd0: 2031 3038 3330 2e30 5d0a 2020 2020 2020   10830.0].      
+0000ece0: 2020 2020 2020 5b31 2e30 2c20 302e 312c        [1.0, 0.1,
+0000ecf0: 2030 2e31 2c20 302e 3035 2c20 302e 3132   0.1, 0.05, 0.12
+0000ed00: 322c 2030 2e30 345d 0a0a 2020 2020 2222  2, 0.04]..    ""
+0000ed10: 220a 2020 2020 6c69 6e65 5f77 6176 656c  ".    line_wavel
+0000ed20: 656e 6774 6873 203d 204f 7264 6572 6564  engths = Ordered
+0000ed30: 4469 6374 2829 0a20 2020 206c 696e 655f  Dict().    line_
+0000ed40: 7261 7469 6f73 203d 204f 7264 6572 6564  ratios = Ordered
+0000ed50: 4469 6374 2829 0a0a 2020 2020 2320 5061  Dict()..    # Pa
+0000ed60: 7363 6865 6e3a 2068 7474 7073 3a2f 2f77  schen: https://w
+0000ed70: 7777 2e67 656d 696e 692e 6564 752f 7363  ww.gemini.edu/sc
+0000ed80: 696f 7073 2f69 6e73 7472 756d 656e 7473  iops/instruments
+0000ed90: 2f6e 6561 7269 722d 7265 736f 7572 6365  /nearir-resource
+0000eda0: 732f 6173 7472 6f6e 6f6d 6963 616c 2d6c  s/astronomical-l
+0000edb0: 696e 6573 2f68 2d6c 696e 6573 0a20 2020  ines/h-lines.   
+0000edc0: 200a 2020 2020 2320 5268 203d 2030 2e30   .    # Rh = 0.0
+0000edd0: 3031 3039 3637 3735 370a 2020 2020 2320  010967757.    # 
+0000ede0: 6b20 3d20 5268 202a 2028 312f 6e30 2a2a  k = Rh * (1/n0**
+0000edf0: 3220 2d20 312f 6e2a 2a32 290a 2020 2020  2 - 1/n**2).    
+0000ee00: 2320 7761 7665 203d 2031 2e2f 6b20 2320  # wave = 1./k # 
+0000ee10: 416e 6773 7472 6f6d 730a 2020 2020 0a20  Angstroms.    . 
+0000ee20: 2020 2023 2050 6675 6e64 206e 303d 350a     # Pfund n0=5.
+0000ee30: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
+0000ee40: 6774 6873 5b27 5066 4127 5d20 3d20 5b37  gths['PfA'] = [7
+0000ee50: 3435 3938 2e38 5d0a 2020 2020 6c69 6e65  4598.8].    line
+0000ee60: 5f72 6174 696f 735b 2750 6641 275d 203d  _ratios['PfA'] =
+0000ee70: 205b 312e 5d0a 2020 2020 6c69 6e65 5f77   [1.].    line_w
+0000ee80: 6176 656c 656e 6774 6873 5b27 5066 4227  avelengths['PfB'
+0000ee90: 5d20 3d20 5b34 3635 3337 2e39 5d0a 2020  ] = [46537.9].  
+0000eea0: 2020 6c69 6e65 5f72 6174 696f 735b 2750    line_ratios['P
+0000eeb0: 6642 275d 203d 205b 312e 5d0a 2020 2020  fB'] = [1.].    
+0000eec0: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+0000eed0: 5b27 5066 4727 5d20 3d20 5b33 3734 3035  ['PfG'] = [37405
+0000eee0: 2e37 5d0a 2020 2020 6c69 6e65 5f72 6174  .7].    line_rat
+0000eef0: 696f 735b 2750 6647 275d 203d 205b 312e  ios['PfG'] = [1.
+0000ef00: 5d0a 2020 2020 6c69 6e65 5f77 6176 656c  ].    line_wavel
+0000ef10: 656e 6774 6873 5b27 5066 4427 5d20 3d20  engths['PfD'] = 
+0000ef20: 5b33 3239 3730 2e30 5d0a 2020 2020 6c69  [32970.0].    li
+0000ef30: 6e65 5f72 6174 696f 735b 2750 6644 275d  ne_ratios['PfD']
+0000ef40: 203d 205b 312e 5d0a 2020 2020 6c69 6e65   = [1.].    line
+0000ef50: 5f77 6176 656c 656e 6774 6873 5b27 5066  _wavelengths['Pf
+0000ef60: 4527 5d20 3d20 5b33 3033 3932 2e31 5d0a  E'] = [30392.1].
+0000ef70: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+0000ef80: 2750 6645 275d 203d 205b 312e 5d0a 2020  'PfE'] = [1.].  
+0000ef90: 2020 0a20 2020 2023 2042 7261 636b 6574    .    # Bracket
+0000efa0: 7420 6e30 3d34 0a20 2020 206c 696e 655f  t n0=4.    line_
+0000efb0: 7761 7665 6c65 6e67 7468 735b 2742 7241  wavelengths['BrA
+0000efc0: 275d 203d 205b 3430 3532 322e 385d 0a20  '] = [40522.8]. 
+0000efd0: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+0000efe0: 4272 4127 5d20 3d20 5b31 2e5d 0a20 2020  BrA'] = [1.].   
+0000eff0: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
+0000f000: 735b 2742 7242 275d 203d 205b 3236 3235  s['BrB'] = [2625
+0000f010: 382e 385d 0a20 2020 206c 696e 655f 7261  8.8].    line_ra
+0000f020: 7469 6f73 5b27 4272 4227 5d20 3d20 5b31  tios['BrB'] = [1
+0000f030: 2e5d 0a20 2020 206c 696e 655f 7761 7665  .].    line_wave
+0000f040: 6c65 6e67 7468 735b 2742 7247 275d 203d  lengths['BrG'] =
+0000f050: 205b 3231 3636 312e 335d 0a20 2020 206c   [21661.3].    l
+0000f060: 696e 655f 7261 7469 6f73 5b27 4272 4727  ine_ratios['BrG'
+0000f070: 5d20 3d20 5b31 2e5d 0a20 2020 206c 696e  ] = [1.].    lin
+0000f080: 655f 7761 7665 6c65 6e67 7468 735b 2742  e_wavelengths['B
+0000f090: 7244 275d 203d 205b 3139 3435 312e 305d  rD'] = [19451.0]
+0000f0a0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+0000f0b0: 5b27 4272 4427 5d20 3d20 5b31 2e5d 0a20  ['BrD'] = [1.]. 
+0000f0c0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+0000f0d0: 7468 735b 2742 7245 275d 203d 205b 3138  ths['BrE'] = [18
+0000f0e0: 3137 392e 325d 0a20 2020 206c 696e 655f  179.2].    line_
+0000f0f0: 7261 7469 6f73 5b27 4272 4527 5d20 3d20  ratios['BrE'] = 
+0000f100: 5b31 2e5d 0a20 2020 200a 2020 2020 2320  [1.].    .    # 
+0000f110: 5061 7363 6865 6e20 6e30 3d33 0a20 2020  Paschen n0=3.   
+0000f120: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
+0000f130: 735b 2750 6141 275d 203d 205b 3138 3735  s['PaA'] = [1875
+0000f140: 362e 335d 0a20 2020 206c 696e 655f 7261  6.3].    line_ra
+0000f150: 7469 6f73 5b27 5061 4127 5d20 3d20 5b31  tios['PaA'] = [1
+0000f160: 2e5d 0a20 2020 206c 696e 655f 7761 7665  .].    line_wave
+0000f170: 6c65 6e67 7468 735b 2750 6142 275d 203d  lengths['PaB'] =
+0000f180: 205b 3132 3832 312e 375d 0a20 2020 206c   [12821.7].    l
+0000f190: 696e 655f 7261 7469 6f73 5b27 5061 4227  ine_ratios['PaB'
+0000f1a0: 5d20 3d20 5b31 2e5d 0a20 2020 206c 696e  ] = [1.].    lin
+0000f1b0: 655f 7761 7665 6c65 6e67 7468 735b 2750  e_wavelengths['P
+0000f1c0: 6147 275d 203d 205b 3130 3934 312e 325d  aG'] = [10941.2]
+0000f1d0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+0000f1e0: 5b27 5061 4727 5d20 3d20 5b31 2e5d 0a20  ['PaG'] = [1.]. 
+0000f1f0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+0000f200: 7468 735b 2750 6144 275d 203d 205b 3130  ths['PaD'] = [10
+0000f210: 3035 322e 325d 0a20 2020 206c 696e 655f  052.2].    line_
+0000f220: 7261 7469 6f73 5b27 5061 4427 5d20 3d20  ratios['PaD'] = 
+0000f230: 5b31 2e5d 0a20 2020 206c 696e 655f 7761  [1.].    line_wa
+0000f240: 7665 6c65 6e67 7468 735b 2750 6138 275d  velengths['Pa8']
+0000f250: 203d 205b 3935 3438 2e36 355d 0a20 2020   = [9548.65].   
+0000f260: 206c 696e 655f 7261 7469 6f73 5b27 5061   line_ratios['Pa
+0000f270: 3827 5d20 3d20 5b31 2e5d 0a20 2020 206c  8'] = [1.].    l
+0000f280: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+0000f290: 2750 6139 275d 203d 205b 3932 3331 2e36  'Pa9'] = [9231.6
+0000f2a0: 305d 0a20 2020 206c 696e 655f 7261 7469  0].    line_rati
+0000f2b0: 6f73 5b27 5061 3927 5d20 3d20 5b31 2e5d  os['Pa9'] = [1.]
+0000f2c0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+0000f2d0: 6e67 7468 735b 2750 6131 3027 5d20 3d20  ngths['Pa10'] = 
+0000f2e0: 5b39 3031 372e 3434 5d0a 2020 2020 6c69  [9017.44].    li
+0000f2f0: 6e65 5f72 6174 696f 735b 2750 6131 3027  ne_ratios['Pa10'
+0000f300: 5d20 3d20 5b31 2e5d 0a20 2020 200a 2020  ] = [1.].    .  
+0000f310: 2020 2320 4261 6c6d 6572 206e 303d 320a    # Balmer n0=2.
+0000f320: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
+0000f330: 6774 6873 5b27 4861 275d 203d 205b 3635  gths['Ha'] = [65
+0000f340: 3634 2e36 3937 5d0a 2020 2020 6c69 6e65  64.697].    line
+0000f350: 5f72 6174 696f 735b 2748 6127 5d20 3d20  _ratios['Ha'] = 
+0000f360: 5b31 2e5d 0a20 2020 206c 696e 655f 7761  [1.].    line_wa
+0000f370: 7665 6c65 6e67 7468 735b 2748 6227 5d20  velengths['Hb'] 
+0000f380: 3d20 5b34 3836 322e 3733 385d 0a20 2020  = [4862.738].   
+0000f390: 206c 696e 655f 7261 7469 6f73 5b27 4862   line_ratios['Hb
+0000f3a0: 275d 203d 205b 312e 5d0a 2020 2020 6c69  '] = [1.].    li
+0000f3b0: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
+0000f3c0: 4867 275d 203d 205b 3433 3431 2e37 3331  Hg'] = [4341.731
+0000f3d0: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
+0000f3e0: 735b 2748 6727 5d20 3d20 5b31 2e5d 0a20  s['Hg'] = [1.]. 
+0000f3f0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+0000f400: 7468 735b 2748 6427 5d20 3d20 5b34 3130  ths['Hd'] = [410
+0000f410: 322e 3933 365d 0a20 2020 206c 696e 655f  2.936].    line_
+0000f420: 7261 7469 6f73 5b27 4864 275d 203d 205b  ratios['Hd'] = [
+0000f430: 312e 5d0a 0a20 2020 206c 696e 655f 7761  1.]..    line_wa
+0000f440: 7665 6c65 6e67 7468 735b 2748 3727 5d20  velengths['H7'] 
+0000f450: 3d20 5b33 3937 312e 3233 365d 0a20 2020  = [3971.236].   
+0000f460: 206c 696e 655f 7261 7469 6f73 5b27 4837   line_ratios['H7
+0000f470: 275d 203d 205b 312e 5d0a 2020 2020 6c69  '] = [1.].    li
+0000f480: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
+0000f490: 4838 275d 203d 205b 3338 3930 2e31 3931  H8'] = [3890.191
+0000f4a0: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
+0000f4b0: 735b 2748 3827 5d20 3d20 5b31 2e5d 0a20  s['H8'] = [1.]. 
+0000f4c0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+0000f4d0: 7468 735b 2748 3927 5d20 3d20 5b33 3833  ths['H9'] = [383
+0000f4e0: 362e 3531 315d 0a20 2020 206c 696e 655f  6.511].    line_
+0000f4f0: 7261 7469 6f73 5b27 4839 275d 203d 205b  ratios['H9'] = [
+0000f500: 312e 5d0a 2020 2020 6c69 6e65 5f77 6176  1.].    line_wav
+0000f510: 656c 656e 6774 6873 5b27 4831 3027 5d20  elengths['H10'] 
+0000f520: 3d20 5b33 3739 392e 3031 345d 0a20 2020  = [3799.014].   
+0000f530: 206c 696e 655f 7261 7469 6f73 5b27 4831   line_ratios['H1
+0000f540: 3027 5d20 3d20 5b31 2e5d 0a20 2020 206c  0'] = [1.].    l
+0000f550: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+0000f560: 2748 3131 275d 203d 205b 3337 3731 2e37  'H11'] = [3771.7
+0000f570: 3339 5d0a 2020 2020 6c69 6e65 5f72 6174  39].    line_rat
+0000f580: 696f 735b 2748 3131 275d 203d 205b 312e  ios['H11'] = [1.
+0000f590: 5d0a 2020 2020 6c69 6e65 5f77 6176 656c  ].    line_wavel
+0000f5a0: 656e 6774 6873 5b27 4831 3227 5d20 3d20  engths['H12'] = 
+0000f5b0: 5b33 3735 312e 3235 355d 0a20 2020 206c  [3751.255].    l
+0000f5c0: 696e 655f 7261 7469 6f73 5b27 4831 3227  ine_ratios['H12'
+0000f5d0: 5d20 3d20 5b31 2e5d 0a0a 2020 2020 2320  ] = [1.]..    # 
+0000f5e0: 4772 6f76 6573 2065 7420 616c 2e20 3230  Groves et al. 20
+0000f5f0: 3131 2c20 5461 626c 6520 310a 2020 2020  11, Table 1.    
+0000f600: 2320 4f73 7465 7262 726f 636b 2074 6162  # Osterbrock tab
+0000f610: 6c65 2034 2e34 2066 6f72 2048 3720 746f  le 4.4 for H7 to
+0000f620: 2048 3130 0a20 2020 2023 206c 696e 655f   H10.    # line_
+0000f630: 7761 7665 6c65 6e67 7468 735b 2742 616c  wavelengths['Bal
+0000f640: 6d65 7220 3130 6b4b 275d 203d 205b 3635  mer 10kK'] = [65
+0000f650: 3634 2e36 312c 2034 3836 322e 3638 2c20  64.61, 4862.68, 
+0000f660: 3433 3431 2e36 382c 2034 3130 312e 3733  4341.68, 4101.73
+0000f670: 5d0a 2020 2020 2320 6c69 6e65 5f72 6174  ].    # line_rat
+0000f680: 696f 735b 2742 616c 6d65 7220 3130 6b4b  ios['Balmer 10kK
+0000f690: 275d 203d 205b 322e 3836 2c20 312e 302c  '] = [2.86, 1.0,
+0000f6a0: 2030 2e34 3638 2c20 302e 3235 395d 0a0a   0.468, 0.259]..
+0000f6b0: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
+0000f6c0: 6774 6873 5b27 4261 6c6d 6572 2031 306b  gths['Balmer 10k
+0000f6d0: 4b27 5d20 3d20 5b36 3536 342e 3631 2c20  K'] = [6564.61, 
+0000f6e0: 3438 3632 2e36 382c 2034 3334 312e 3638  4862.68, 4341.68
+0000f6f0: 2c20 3431 3031 2e37 332c 2033 3937 312e  , 4101.73, 3971.
+0000f700: 3139 382c 2033 3839 302e 3136 362c 2033  198, 3890.166, 3
+0000f710: 3833 362e 3438 352c 2033 3739 382e 3938  836.485, 3798.98
+0000f720: 375d 0a20 2020 206c 696e 655f 7261 7469  7].    line_rati
+0000f730: 6f73 5b27 4261 6c6d 6572 2031 306b 4b27  os['Balmer 10kK'
+0000f740: 5d20 3d20 5b32 2e38 362c 2031 2e30 2c20  ] = [2.86, 1.0, 
+0000f750: 302e 3436 382c 2030 2e32 3539 2c20 302e  0.468, 0.259, 0.
+0000f760: 3135 392c 2030 2e31 3035 2c20 302e 3037  159, 0.105, 0.07
+0000f770: 3331 2c20 302e 3035 3330 5d0a 0a20 2020  31, 0.0530]..   
+0000f780: 2023 2050 6173 6368 656e 2066 726f 6d20   # Paschen from 
+0000f790: 4f73 7465 7262 726f 636b 2c20 652e 672e  Osterbrock, e.g.
+0000f7a0: 2c20 5061 2d62 6574 6120 7265 6c61 7469  , Pa-beta relati
+0000f7b0: 7665 2074 6f20 482d 6761 6d6d 610a 2020  ve to H-gamma.  
+0000f7c0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+0000f7d0: 6873 5b27 4261 6c6d 6572 2031 306b 4b27  hs['Balmer 10kK'
+0000f7e0: 5d20 2b3d 206c 696e 655f 7761 7665 6c65  ] += line_wavele
+0000f7f0: 6e67 7468 735b 2750 6141 275d 202b 206c  ngths['PaA'] + l
+0000f800: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+0000f810: 2750 6142 275d 202b 206c 696e 655f 7761  'PaB'] + line_wa
+0000f820: 7665 6c65 6e67 7468 735b 2750 6147 275d  velengths['PaG']
+0000f830: 202b 206c 696e 655f 7761 7665 6c65 6e67   + line_waveleng
+0000f840: 7468 735b 2750 6144 275d 0a20 2020 206c  ths['PaD'].    l
+0000f850: 696e 655f 7261 7469 6f73 5b27 4261 6c6d  ine_ratios['Balm
+0000f860: 6572 2031 306b 4b27 5d20 2b3d 205b 302e  er 10kK'] += [0.
+0000f870: 3334 3820 2a20 6c69 6e65 5f72 6174 696f  348 * line_ratio
+0000f880: 735b 2742 616c 6d65 7220 3130 6b4b 275d  s['Balmer 10kK']
+0000f890: 5b69 5d20 666f 7220 6920 696e 205b 312c  [i] for i in [1,
+0000f8a0: 2032 2c20 332c 2034 5d5d 0a0a 2020 2020   2, 3, 4]]..    
+0000f8b0: 2320 4f73 7465 7262 726f 636b 2074 6162  # Osterbrock tab
+0000f8c0: 6c65 2034 2e34 2066 6f72 2048 3720 746f  le 4.4 for H7 to
+0000f8d0: 2048 3130 0a20 2020 206c 696e 655f 7761   H10.    line_wa
+0000f8e0: 7665 6c65 6e67 7468 735b 2742 616c 6d65  velengths['Balme
+0000f8f0: 7220 3130 6b4b 202b 204d 6749 4927 5d20  r 10kK + MgII'] 
+0000f900: 3d20 6c69 6e65 5f77 6176 656c 656e 6774  = line_wavelengt
+0000f910: 6873 5b27 4261 6c6d 6572 2031 306b 4b27  hs['Balmer 10kK'
+0000f920: 5d20 2b20 5b32 3739 392e 3131 375d 0a20  ] + [2799.117]. 
+0000f930: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+0000f940: 4261 6c6d 6572 2031 306b 4b20 2b20 4d67  Balmer 10kK + Mg
+0000f950: 4949 275d 203d 206c 696e 655f 7261 7469  II'] = line_rati
+0000f960: 6f73 5b27 4261 6c6d 6572 2031 306b 4b27  os['Balmer 10kK'
+0000f970: 5d20 2b20 5b33 2e5d 0a0a 2020 2020 2320  ] + [3.]..    # 
+0000f980: 2320 5061 7363 6865 6e20 6672 6f6d 204f  # Paschen from O
+0000f990: 7374 6572 6272 6f63 6b2c 2065 2e67 2e2c  sterbrock, e.g.,
+0000f9a0: 2050 612d 6265 7461 2072 656c 6174 6976   Pa-beta relativ
+0000f9b0: 6520 746f 2048 2d67 616d 6d61 0a20 2020  e to H-gamma.   
+0000f9c0: 2023 206c 696e 655f 7761 7665 6c65 6e67   # line_waveleng
+0000f9d0: 7468 735b 2742 616c 6d65 7220 3130 6b4b  ths['Balmer 10kK
+0000f9e0: 202b 204d 6749 4927 5d20 2b3d 206c 696e   + MgII'] += lin
+0000f9f0: 655f 7761 7665 6c65 6e67 7468 735b 2750  e_wavelengths['P
+0000fa00: 6141 275d 202b 206c 696e 655f 7761 7665  aA'] + line_wave
+0000fa10: 6c65 6e67 7468 735b 2750 6142 275d 202b  lengths['PaB'] +
+0000fa20: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
+0000fa30: 735b 2750 6147 275d 0a20 2020 2023 206c  s['PaG'].    # l
+0000fa40: 696e 655f 7261 7469 6f73 5b27 4261 6c6d  ine_ratios['Balm
+0000fa50: 6572 2031 306b 4b20 2b20 4d67 4949 275d  er 10kK + MgII']
+0000fa60: 202b 3d20 5b30 2e33 3438 202a 206c 696e   += [0.348 * lin
+0000fa70: 655f 7261 7469 6f73 5b27 4261 6c6d 6572  e_ratios['Balmer
+0000fa80: 2031 306b 4b20 2b20 4d67 4949 275d 5b69   10kK + MgII'][i
+0000fa90: 5d20 666f 7220 6920 696e 205b 312c 322c  ] for i in [1,2,
+0000faa0: 335d 5d0a 0a20 2020 2023 2057 6974 6820  3]]..    # With 
+0000fab0: 5061 7363 6865 6e20 6c69 6e65 7320 2620  Paschen lines & 
+0000fac0: 4865 2031 3038 3330 2066 726f 6d20 476c  He 10830 from Gl
+0000fad0: 696b 6d61 6e20 3230 3036 0a20 2020 2023  ikman 2006.    #
+0000fae0: 2068 7474 7073 3a2f 2f69 6f70 7363 6965   https://iopscie
+0000faf0: 6e63 652e 696f 702e 6f72 672f 6172 7469  nce.iop.org/arti
+0000fb00: 636c 652f 3130 2e31 3038 362f 3530 3030  cle/10.1086/5000
+0000fb10: 3938 2f70 6466 0a20 2020 2023 6c69 6e65  98/pdf.    #line
+0000fb20: 5f77 6176 656c 656e 6774 6873 5b27 4261  _wavelengths['Ba
+0000fb30: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
+0000fb40: 275d 203d 205b 3635 3634 2e36 312c 2034  '] = [6564.61, 4
+0000fb50: 3836 322e 3638 2c20 3433 3431 2e36 382c  862.68, 4341.68,
+0000fb60: 2034 3130 312e 3733 2c20 3339 3731 2e31   4101.73, 3971.1
+0000fb70: 3938 2c20 3237 3939 2e31 3137 2c20 3132  98, 2799.117, 12
+0000fb80: 3832 312e 362c 2031 3039 3431 2e31 5d0a  821.6, 10941.1].
+0000fb90: 2020 2020 236c 696e 655f 7261 7469 6f73      #line_ratios
+0000fba0: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
+0000fbb0: 4d67 4949 275d 203d 205b 322e 3836 2c20  MgII'] = [2.86, 
+0000fbc0: 312e 302c 2030 2e34 3638 2c20 302e 3235  1.0, 0.468, 0.25
+0000fbd0: 392c 2030 2e31 362c 2033 2e2c 2032 2e38  9, 0.16, 3., 2.8
+0000fbe0: 362a 342e 382f 3130 302c 2032 2e38 362a  6*4.8/100, 2.86*
+0000fbf0: 312e 3935 2f31 3030 5d0a 0a20 2020 2023  1.95/100]..    #
+0000fc00: 2052 6564 6465 6e20 7769 7468 2043 616c   Redden with Cal
+0000fc10: 7a65 7474 6930 300a 2020 2020 6966 2046  zetti00.    if F
+0000fc20: 616c 7365 3a0a 2020 2020 2020 2020 6672  alse:.        fr
+0000fc30: 6f6d 2065 7874 696e 6374 696f 6e20 696d  om extinction im
+0000fc40: 706f 7274 2063 616c 7a65 7474 6930 300a  port calzetti00.
+0000fc50: 2020 2020 2020 2020 4176 203d 2031 2e30          Av = 1.0
+0000fc60: 0a20 2020 2020 2020 2052 7620 3d20 332e  .        Rv = 3.
+0000fc70: 310a 0a20 2020 2020 2020 2077 6176 6573  1..        waves
+0000fc80: 203d 206c 696e 655f 7761 7665 6c65 6e67   = line_waveleng
+0000fc90: 7468 735b 2742 616c 6d65 7220 3130 6b4b  ths['Balmer 10kK
+0000fca0: 202b 204d 6749 4927 5d0a 2020 2020 2020   + MgII'].      
+0000fcb0: 2020 7261 7469 6f73 203d 206c 696e 655f    ratios = line_
+0000fcc0: 7261 7469 6f73 5b27 4261 6c6d 6572 2031  ratios['Balmer 1
+0000fcd0: 306b 4b20 2b20 4d67 4949 275d 0a0a 2020  0kK + MgII']..  
+0000fce0: 2020 2020 2020 666f 7220 4176 2069 6e20        for Av in 
+0000fcf0: 5b30 2e35 2c20 312e 302c 2032 2e30 5d3a  [0.5, 1.0, 2.0]:
+0000fd00: 0a20 2020 2020 2020 2020 2020 206d 7265  .            mre
+0000fd10: 6420 3d20 6361 6c7a 6574 7469 3030 286e  d = calzetti00(n
+0000fd20: 702e 6172 7261 7928 7761 7665 7329 2c20  p.array(waves), 
+0000fd30: 4176 2c20 5276 290a 2020 2020 2020 2020  Av, Rv).        
+0000fd40: 2020 2020 6672 6564 203d 2031 302a 2a28      fred = 10**(
+0000fd50: 2d30 2e34 2a6d 7265 6429 0a0a 2020 2020  -0.4*mred)..    
+0000fd60: 2020 2020 2020 2020 6b65 7920 3d20 2742          key = 'B
+0000fd70: 616c 6d65 7220 3130 6b4b 202b 204d 6749  almer 10kK + MgI
+0000fd80: 4920 4176 3d7b 303a 2e31 667d 272e 666f  I Av={0:.1f}'.fo
+0000fd90: 726d 6174 2841 7629 0a20 2020 2020 2020  rmat(Av).       
+0000fda0: 2020 2020 206c 696e 655f 7761 7665 6c65       line_wavele
+0000fdb0: 6e67 7468 735b 6b65 795d 203d 205b 7720  ngths[key] = [w 
+0000fdc0: 666f 7220 7720 696e 2077 6176 6573 5d0a  for w in waves].
+0000fdd0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+0000fde0: 5f72 6174 696f 735b 6b65 795d 203d 205b  _ratios[key] = [
+0000fdf0: 7261 7469 6f73 5b69 5d2a 6672 6564 5b69  ratios[i]*fred[i
+0000fe00: 5d20 666f 7220 6920 696e 2072 616e 6765  ] for i in range
+0000fe10: 286c 656e 2877 6176 6573 2929 5d0a 0a20  (len(waves))].. 
+0000fe20: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+0000fe30: 7468 735b 2742 616c 6d65 7220 3130 6b4b  ths['Balmer 10kK
+0000fe40: 202b 204d 6749 4920 4176 3d30 2e35 275d   + MgII Av=0.5']
+0000fe50: 203d 205b 3635 3634 2e36 312c 2034 3836   = [6564.61, 486
+0000fe60: 322e 3638 2c20 3433 3431 2e36 382c 2034  2.68, 4341.68, 4
+0000fe70: 3130 312e 3733 2c20 3339 3731 2e31 3938  101.73, 3971.198
+0000fe80: 2c20 3237 3939 2e31 3137 2c20 3132 3832  , 2799.117, 1282
+0000fe90: 312e 362c 2031 3039 3431 2e31 5d0a 2020  1.6, 10941.1].  
+0000fea0: 2020 6c69 6e65 5f72 6174 696f 735b 2742    line_ratios['B
+0000feb0: 616c 6d65 7220 3130 6b4b 202b 204d 6749  almer 10kK + MgI
+0000fec0: 4920 4176 3d30 2e35 275d 203d 205b 322e  I Av=0.5'] = [2.
+0000fed0: 3030 3938 3131 3933 3837 3938 3531 352c  009811938798515,
+0000fee0: 2030 2e35 3831 3735 3636 3634 3135 3231   0.5817566641521
+0000fef0: 3435 392c 2030 2e32 3531 3736 3937 3038  459, 0.251769708
+0000ff00: 3234 3536 3639 3133 2c20 302e 3133 3338  24566913, 0.1338
+0000ff10: 3430 3933 3639 3636 3539 3032 2c20 302e  409369665902, 0.
+0000ff20: 3038 3037 3932 3039 3838 3037 3439 3938  0807920988074998
+0000ff30: 342c 2031 2e31 3733 3932 3937 3833 3936  4, 1.17392978396
+0000ff40: 3930 3331 372c 2030 2e31 3330 3932 3535  90317, 0.1309255
+0000ff50: 3339 3930 3531 3331 3738 2c20 302e 3035  3990513178, 0.05
+0000ff60: 3033 3338 3636 3132 3734 3737 3635 315d  033866127477651]
+0000ff70: 0a0a 2020 2020 6c69 6e65 5f77 6176 656c  ..    line_wavel
+0000ff80: 656e 6774 6873 5b27 4261 6c6d 6572 2031  engths['Balmer 1
+0000ff90: 306b 4b20 2b20 4d67 4949 2041 763d 312e  0kK + MgII Av=1.
+0000ffa0: 3027 5d20 3d20 5b36 3536 342e 3631 2c20  0'] = [6564.61, 
+0000ffb0: 3438 3632 2e36 382c 2034 3334 312e 3638  4862.68, 4341.68
+0000ffc0: 2c20 3431 3031 2e37 332c 2033 3937 312e  , 4101.73, 3971.
+0000ffd0: 3139 382c 2032 3739 392e 3131 372c 2031  198, 2799.117, 1
+0000ffe0: 3238 3231 2e36 2c20 3130 3934 312e 315d  2821.6, 10941.1]
+0000fff0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+00010000: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
+00010010: 4d67 4949 2041 763d 312e 3027 5d20 3d20  MgII Av=1.0'] = 
+00010020: 5b31 2e34 3132 3335 3830 3532 3231 3537  [1.4123580522157
+00010030: 3530 342c 2030 2e33 3338 3434 3038 3136  504, 0.338440816
+00010040: 3238 3534 3332 3636 2c20 302e 3133 3534  28543266, 0.1354
+00010050: 3434 3431 3435 3038 3738 3036 372c 2030  4441450878067, 0
+00010060: 2e30 3639 3136 3336 3932 3639 3533 3436  .069163692695346
+00010070: 362c 2030 2e30 3430 3739 3630 3230 3138  6, 0.04079602018
+00010080: 3537 3535 3131 2c20 302e 3435 3933 3730  575511, 0.459370
+00010090: 3337 3932 3239 3835 3931 2c20 302e 3132  3792298591, 0.12
+000100a0: 3438 3635 3231 3730 3730 3538 3735 312c  486521707058751,
+000100b0: 2030 2e30 3435 3433 3632 3730 3733 3538   0.0454362707358
+000100c0: 3230 3034 355d 0a0a 2020 2020 6c69 6e65  20045]..    line
+000100d0: 5f77 6176 656c 656e 6774 6873 5b27 4261  _wavelengths['Ba
+000100e0: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
+000100f0: 2041 763d 322e 3027 5d20 3d20 5b36 3536   Av=2.0'] = [656
+00010100: 342e 3631 2c20 3438 3632 2e36 382c 2034  4.61, 4862.68, 4
+00010110: 3334 312e 3638 2c20 3431 3031 2e37 332c  341.68, 4101.73,
+00010120: 2033 3937 312e 3139 382c 2032 3739 392e   3971.198, 2799.
+00010130: 3131 372c 2031 3238 3231 2e36 2c20 3130  117, 12821.6, 10
+00010140: 3934 312e 315d 0a20 2020 206c 696e 655f  941.1].    line_
+00010150: 7261 7469 6f73 5b27 4261 6c6d 6572 2031  ratios['Balmer 1
+00010160: 306b 4b20 2b20 4d67 4949 2041 763d 322e  0kK + MgII Av=2.
+00010170: 3027 5d20 3d20 5b30 2e36 3937 3436 3638  0'] = [0.6974668
+00010180: 3736 3830 3337 3330 322c 2030 2e31 3134  768037302, 0.114
+00010190: 3534 3231 3836 3132 3739 3439 3939 2c20  54218612794999, 
+000101a0: 302e 3033 3931 3939 3132 3236 3935 3738  0.03919912269578
+000101b0: 3238 392c 2030 2e30 3138 3436 3935 3631  289, 0.018469561
+000101c0: 3334 3037 3538 3037 332c 2030 2e30 3130  340758073, 0.010
+000101d0: 3430 3139 3730 3339 3337 3238 3336 322c  401970393728362,
+000101e0: 2030 2e30 3730 3334 3033 3831 3737 3132   0.0703403817712
+000101f0: 3631 352c 2030 2e31 3133 3537 3331 3532  615, 0.113573152
+00010200: 3932 3839 3430 3434 2c20 302e 3033 3730  92894044, 0.0370
+00010210: 3137 3239 3738 3031 3330 3432 325d 0a20  1729780130422]. 
+00010220: 2020 200a 2020 2020 2323 2323 2323 2323     .    ########
+00010230: 2323 230a 2020 2020 0a20 2020 2023 2052  ###.    .    # R
+00010240: 6564 6465 6e65 6420 7769 7468 204b 7269  eddened with Kri
+00010250: 656b 2026 2043 6f6e 726f 7920 6475 7374  ek & Conroy dust
+00010260: 2c20 7461 755f 563d 302e 350a 2020 2020  , tau_V=0.5.    
+00010270: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+00010280: 5b27 4261 6c6d 6572 2031 306b 4b20 7430  ['Balmer 10kK t0
+00010290: 2e35 275d 203d 205b 3635 3634 2e36 312c  .5'] = [6564.61,
+000102a0: 2034 3836 322e 3638 2c20 3433 3431 2e36   4862.68, 4341.6
+000102b0: 382c 2034 3130 312e 3733 5d0a 2020 2020  8, 4101.73].    
+000102c0: 6c69 6e65 5f72 6174 696f 735b 2742 616c  line_ratios['Bal
+000102d0: 6d65 7220 3130 6b4b 2074 302e 3527 5d20  mer 10kK t0.5'] 
+000102e0: 3d20 5b32 2e38 362a 302e 3638 2c20 312e  = [2.86*0.68, 1.
+000102f0: 302a 302e 3535 2c20 302e 3436 382a 302e  0*0.55, 0.468*0.
+00010300: 3531 2c20 302e 3235 392a 302e 3438 5d0a  51, 0.259*0.48].
+00010310: 0a20 2020 2023 2052 6564 6465 6e65 6420  .    # Reddened 
+00010320: 7769 7468 204b 7269 656b 2026 2043 6f6e  with Kriek & Con
+00010330: 726f 7920 6475 7374 2c20 7461 755f 563d  roy dust, tau_V=
+00010340: 310a 2020 2020 6c69 6e65 5f77 6176 656c  1.    line_wavel
+00010350: 656e 6774 6873 5b27 4261 6c6d 6572 2031  engths['Balmer 1
+00010360: 306b 4b20 7431 275d 203d 205b 3635 3634  0kK t1'] = [6564
+00010370: 2e36 312c 2034 3836 322e 3638 2c20 3433  .61, 4862.68, 43
+00010380: 3431 2e36 382c 2034 3130 312e 3733 5d0a  41.68, 4101.73].
+00010390: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+000103a0: 2742 616c 6d65 7220 3130 6b4b 2074 3127  'Balmer 10kK t1'
+000103b0: 5d20 3d20 5b32 2e38 362a 302e 3436 2c20  ] = [2.86*0.46, 
+000103c0: 312e 302a 302e 3331 2c20 302e 3436 382a  1.0*0.31, 0.468*
+000103d0: 302e 3235 362c 2030 2e32 3539 2a30 2e32  0.256, 0.259*0.2
+000103e0: 3332 5d0a 0a20 2020 206c 696e 655f 7761  32]..    line_wa
+000103f0: 7665 6c65 6e67 7468 735b 274f 4949 492d  velengths['OIII-
+00010400: 3433 3633 275d 203d 205b 3433 3634 2e34  4363'] = [4364.4
+00010410: 3336 5d0a 2020 2020 6c69 6e65 5f72 6174  36].    line_rat
+00010420: 696f 735b 274f 4949 492d 3433 3633 275d  ios['OIII-4363']
+00010430: 203d 205b 312e 5d0a 2020 2020 6c69 6e65   = [1.].    line
+00010440: 5f77 6176 656c 656e 6774 6873 5b27 4f49  _wavelengths['OI
+00010450: 4949 275d 203d 205b 3530 3038 2e32 3430  II'] = [5008.240
+00010460: 2c20 3439 3630 2e32 3935 5d0a 2020 2020  , 4960.295].    
+00010470: 6c69 6e65 5f72 6174 696f 735b 274f 4949  line_ratios['OII
+00010480: 4927 5d20 3d20 5b32 2e39 382c 2031 5d0a  I'] = [2.98, 1].
+00010490: 0a20 2020 2023 2053 706c 6974 2064 6f75  .    # Split dou
+000104a0: 626c 6574 2c20 6966 206e 6565 6465 640a  blet, if needed.
+000104b0: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
+000104c0: 6774 6873 5b27 4f49 4949 2d34 3935 3927  gths['OIII-4959'
+000104d0: 5d20 3d20 5b34 3936 302e 3239 355d 0a20  ] = [4960.295]. 
+000104e0: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+000104f0: 4f49 4949 2d34 3935 3927 5d20 3d20 5b31  OIII-4959'] = [1
+00010500: 5d0a 2020 2020 6c69 6e65 5f77 6176 656c  ].    line_wavel
+00010510: 656e 6774 6873 5b27 4f49 4949 2d35 3030  engths['OIII-500
+00010520: 3727 5d20 3d20 5b35 3030 382e 3234 305d  7'] = [5008.240]
+00010530: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+00010540: 5b27 4f49 4949 2d35 3030 3727 5d20 3d20  ['OIII-5007'] = 
+00010550: 5b31 5d0a 0a20 2020 206c 696e 655f 7761  [1]..    line_wa
+00010560: 7665 6c65 6e67 7468 735b 274f 4949 275d  velengths['OII']
+00010570: 203d 205b 3337 3237 2e30 3932 2c20 3337   = [3727.092, 37
+00010580: 3239 2e38 3735 5d0a 2020 2020 6c69 6e65  29.875].    line
+00010590: 5f72 6174 696f 735b 274f 4949 275d 203d  _ratios['OII'] =
+000105a0: 205b 312c 2031 2e5d 0a0a 2020 2020 6c69   [1, 1.]..    li
+000105b0: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
+000105c0: 4f49 2d36 3330 3227 5d20 3d20 5b36 3330  OI-6302'] = [630
+000105d0: 322e 3034 362c 2036 3336 352e 3533 355d  2.046, 6365.535]
 000105e0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
-000105f0: 5b27 4f49 492d 3733 3235 275d 203d 205b  ['OII-7325'] = [
-00010600: 312e 322c 2031 2e5d 0a0a 2020 2020 2320  1.2, 1.]..    # 
-00010610: 5765 616b 2041 7220 4949 4920 696e 2053  Weak Ar III in S
-00010620: 4620 6761 6c61 7869 6573 0a20 2020 206c  F galaxies.    l
-00010630: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-00010640: 2741 7249 4949 2d37 3133 3827 5d20 3d20  'ArIII-7138'] = 
-00010650: 5b37 3133 372e 3737 5d0a 2020 2020 6c69  [7137.77].    li
-00010660: 6e65 5f72 6174 696f 735b 2741 7249 4949  ne_ratios['ArIII
-00010670: 2d37 3133 3827 5d20 3d20 5b31 2e5d 0a0a  -7138'] = [1.]..
-00010680: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00010690: 6774 6873 5b27 4e65 4949 492d 3338 3637  gths['NeIII-3867
-000106a0: 275d 203d 205b 3338 3639 2e38 375d 0a20  '] = [3869.87]. 
-000106b0: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
-000106c0: 4e65 4949 492d 3338 3637 275d 203d 205b  NeIII-3867'] = [
-000106d0: 312e 5d0a 2020 2020 6c69 6e65 5f77 6176  1.].    line_wav
-000106e0: 656c 656e 6774 6873 5b27 4e65 4949 492d  elengths['NeIII-
-000106f0: 3339 3638 275d 203d 205b 3339 3638 2e35  3968'] = [3968.5
-00010700: 395d 0a20 2020 206c 696e 655f 7261 7469  9].    line_rati
-00010710: 6f73 5b27 4e65 4949 492d 3339 3638 275d  os['NeIII-3968']
-00010720: 203d 205b 312e 5d0a 2020 2020 6c69 6e65   = [1.].    line
-00010730: 5f77 6176 656c 656e 6774 6873 5b27 4e65  _wavelengths['Ne
-00010740: 562d 3333 3436 275d 203d 205b 3333 3433  V-3346'] = [3343
-00010750: 2e35 5d0a 2020 2020 6c69 6e65 5f72 6174  .5].    line_rat
-00010760: 696f 735b 274e 6556 2d33 3334 3627 5d20  ios['NeV-3346'] 
-00010770: 3d20 5b31 2e5d 0a20 2020 206c 696e 655f  = [1.].    line_
-00010780: 7761 7665 6c65 6e67 7468 735b 274e 6556  wavelengths['NeV
-00010790: 492d 3334 3236 275d 203d 205b 3334 3236  I-3426'] = [3426
-000107a0: 2e38 355d 0a20 2020 206c 696e 655f 7261  .85].    line_ra
-000107b0: 7469 6f73 5b27 4e65 5649 2d33 3432 3627  tios['NeVI-3426'
-000107c0: 5d20 3d20 5b31 2e5d 0a0a 2020 2020 6c69  ] = [1.]..    li
-000107d0: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-000107e0: 5349 4949 275d 203d 205b 3930 3731 2e31  SIII'] = [9071.1
-000107f0: 2c20 3935 3333 2e32 5d5b 3a3a 2d31 5d0a  , 9533.2][::-1].
-00010800: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
-00010810: 2753 4949 4927 5d20 3d20 5b31 2c20 322e  'SIII'] = [1, 2.
-00010820: 3434 5d5b 3a3a 2d31 5d0a 0a20 2020 2023  44][::-1]..    #
-00010830: 2053 706c 6974 2064 6f75 626c 6574 2c20   Split doublet, 
-00010840: 6966 206e 6565 6465 640a 2020 2020 6c69  if needed.    li
-00010850: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-00010860: 5349 4949 2d39 3036 3827 5d20 3d20 5b39  SIII-9068'] = [9
-00010870: 3037 312e 315d 0a20 2020 206c 696e 655f  071.1].    line_
-00010880: 7261 7469 6f73 5b27 5349 4949 2d39 3036  ratios['SIII-906
-00010890: 3827 5d20 3d20 5b31 5d0a 2020 2020 6c69  8'] = [1].    li
-000108a0: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-000108b0: 5349 4949 2d39 3533 3127 5d20 3d20 5b39  SIII-9531'] = [9
-000108c0: 3533 332e 325d 0a20 2020 206c 696e 655f  533.2].    line_
-000108d0: 7261 7469 6f73 5b27 5349 4949 2d39 3533  ratios['SIII-953
-000108e0: 3127 5d20 3d20 5b31 5d0a 0a20 2020 206c  1'] = [1]..    l
-000108f0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-00010900: 2753 4949 275d 203d 205b 3637 3138 2e32  'SII'] = [6718.2
-00010910: 392c 2036 3733 322e 3637 5d0a 2020 2020  9, 6732.67].    
-00010920: 6c69 6e65 5f72 6174 696f 735b 2753 4949  line_ratios['SII
-00010930: 275d 203d 205b 312e 2c20 312e 5d0a 0a20  '] = [1., 1.].. 
-00010940: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-00010950: 7468 735b 2753 4949 2d36 3731 3727 5d20  ths['SII-6717'] 
-00010960: 3d20 5b36 3731 382e 3239 5d0a 2020 2020  = [6718.29].    
-00010970: 6c69 6e65 5f72 6174 696f 735b 2753 4949  line_ratios['SII
-00010980: 2d36 3731 3727 5d20 3d20 5b31 2e5d 0a20  -6717'] = [1.]. 
-00010990: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-000109a0: 7468 735b 2753 4949 2d36 3733 3127 5d20  ths['SII-6731'] 
-000109b0: 3d20 5b36 3733 322e 3637 5d0a 2020 2020  = [6732.67].    
-000109c0: 6c69 6e65 5f72 6174 696f 735b 2753 4949  line_ratios['SII
-000109d0: 2d36 3733 3127 5d20 3d20 5b31 2e5d 0a0a  -6731'] = [1.]..
-000109e0: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-000109f0: 6774 6873 5b27 5349 492d 3430 3735 275d  gths['SII-4075']
-00010a00: 203d 205b 3430 3639 2e37 352c 2034 3037   = [4069.75, 407
-00010a10: 372e 355d 0a20 2020 206c 696e 655f 7261  7.5].    line_ra
-00010a20: 7469 6f73 5b27 5349 492d 3430 3735 275d  tios['SII-4075']
-00010a30: 203d 205b 312e 2c20 312e 5d0a 2020 2020   = [1., 1.].    
-00010a40: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-00010a50: 5b27 5349 492d 3430 3730 275d 203d 205b  ['SII-4070'] = [
-00010a60: 3430 3639 2e37 355d 0a20 2020 206c 696e  4069.75].    lin
-00010a70: 655f 7261 7469 6f73 5b27 5349 492d 3430  e_ratios['SII-40
-00010a80: 3735 275d 203d 205b 312e 5d0a 2020 2020  75'] = [1.].    
-00010a90: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-00010aa0: 5b27 5349 492d 3430 3738 275d 203d 205b  ['SII-4078'] = [
-00010ab0: 3430 3737 2e35 5d0a 2020 2020 6c69 6e65  4077.5].    line
-00010ac0: 5f72 6174 696f 735b 2753 4949 2d34 3037  _ratios['SII-407
-00010ad0: 3827 5d20 3d20 5b31 2e5d 0a0a 2020 2020  8'] = [1.]..    
-00010ae0: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-00010af0: 5b27 4865 4949 2d34 3638 3727 5d20 3d20  ['HeII-4687'] = 
-00010b00: 5b34 3638 372e 355d 0a20 2020 206c 696e  [4687.5].    lin
-00010b10: 655f 7261 7469 6f73 5b27 4865 4949 2d34  e_ratios['HeII-4
-00010b20: 3638 3727 5d20 3d20 5b31 2e5d 0a20 2020  687'] = [1.].   
-00010b30: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00010b40: 735b 2748 6549 492d 3534 3132 275d 203d  s['HeII-5412'] =
-00010b50: 205b 3534 3132 2e35 5d0a 2020 2020 6c69   [5412.5].    li
-00010b60: 6e65 5f72 6174 696f 735b 2748 6549 492d  ne_ratios['HeII-
-00010b70: 3534 3132 275d 203d 205b 312e 5d0a 2020  5412'] = [1.].  
-00010b80: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
-00010b90: 6873 5b27 4865 492d 3538 3737 275d 203d  hs['HeI-5877'] =
-00010ba0: 205b 3538 3737 2e32 3439 5d0a 2020 2020   [5877.249].    
-00010bb0: 6c69 6e65 5f72 6174 696f 735b 2748 6549  line_ratios['HeI
-00010bc0: 2d35 3837 3727 5d20 3d20 5b31 2e5d 0a20  -5877'] = [1.]. 
-00010bd0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-00010be0: 7468 735b 2748 6549 2d33 3838 3927 5d20  ths['HeI-3889'] 
-00010bf0: 3d20 5b33 3838 392e 3735 5d0a 2020 2020  = [3889.75].    
-00010c00: 6c69 6e65 5f72 6174 696f 735b 2748 6549  line_ratios['HeI
-00010c10: 2d33 3838 3927 5d20 3d20 5b31 2e5d 0a20  -3889'] = [1.]. 
-00010c20: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-00010c30: 7468 735b 2748 6549 2d31 3038 3327 5d20  ths['HeI-1083'] 
-00010c40: 3d20 5b31 3038 3332 2e30 3537 2c20 3130  = [10832.057, 10
-00010c50: 3833 332e 3330 365d 0a20 2020 206c 696e  833.306].    lin
-00010c60: 655f 7261 7469 6f73 5b27 4865 492d 3130  e_ratios['HeI-10
-00010c70: 3833 275d 203d 205b 312e 2c20 312e 5d0a  83'] = [1., 1.].
-00010c80: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00010c90: 6774 6873 5b27 4865 492d 3636 3738 275d  gths['HeI-6678']
-00010ca0: 203d 205b 3636 3738 2e31 305d 0a20 2020   = [6678.10].   
-00010cb0: 206c 696e 655f 7261 7469 6f73 5b27 4865   line_ratios['He
-00010cc0: 492d 3636 3738 275d 203d 205b 312e 5d0a  I-6678'] = [1.].
-00010cd0: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00010ce0: 6774 6873 5b27 4865 492d 3730 3635 275d  gths['HeI-7065']
-00010cf0: 203d 205b 3730 3637 2e31 5d0a 2020 2020   = [7067.1].    
-00010d00: 6c69 6e65 5f72 6174 696f 735b 2748 6549  line_ratios['HeI
-00010d10: 2d37 3036 3527 5d20 3d20 5b31 2e5d 0a20  -7065'] = [1.]. 
-00010d20: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-00010d30: 7468 735b 2748 6549 2d38 3434 3627 5d20  ths['HeI-8446'] 
-00010d40: 3d20 5b38 3434 362e 375d 0a20 2020 206c  = [8446.7].    l
-00010d50: 696e 655f 7261 7469 6f73 5b27 4865 492d  ine_ratios['HeI-
-00010d60: 3834 3436 275d 203d 205b 312e 5d0a 0a20  8446'] = [1.].. 
-00010d70: 2020 2023 204f 7374 6572 6272 6f63 6b20     # Osterbrock 
-00010d80: 5461 626c 6520 342e 350a 2020 2020 2320  Table 4.5.    # 
-00010d90: 2d3e 204e 3d34 0a20 2020 206c 696e 655f  -> N=4.    line_
-00010da0: 7761 7665 6c65 6e67 7468 735b 2748 6549  wavelengths['HeI
-00010db0: 2d73 6572 6965 7327 5d20 3d20 5b34 3437  -series'] = [447
-00010dc0: 322e 372c 2035 3837 372e 322c 2034 3032  2.7, 5877.2, 402
-00010dd0: 372e 332c 2033 3832 302e 372c 2037 3036  7.3, 3820.7, 706
-00010de0: 372e 312c 2031 3038 3333 2e32 2c20 3338  7.1, 10833.2, 38
-00010df0: 3839 2e37 2c20 3331 3838 2e37 5d0a 2020  89.7, 3188.7].  
-00010e00: 2020 6c69 6e65 5f72 6174 696f 735b 2748    line_ratios['H
-00010e10: 6549 2d73 6572 6965 7327 5d20 3d20 5b31  eI-series'] = [1
-00010e20: 2e2c 2032 2e37 352c 2030 2e34 3734 2c20  ., 2.75, 0.474, 
-00010e30: 302e 3236 342c 2030 2e33 3330 2c20 342e  0.264, 0.330, 4.
-00010e40: 3432 2c20 322e 3236 2c20 302e 3931 365d  42, 2.26, 0.916]
-00010e50: 0a0a 2020 2020 6c69 6e65 5f77 6176 656c  ..    line_wavel
-00010e60: 656e 6774 6873 5b27 4d67 4949 275d 203d  engths['MgII'] =
-00010e70: 205b 3237 3939 2e31 3137 5d0a 2020 2020   [2799.117].    
-00010e80: 6c69 6e65 5f72 6174 696f 735b 274d 6749  line_ratios['MgI
-00010e90: 4927 5d20 3d20 5b31 2e5d 0a0a 2020 2020  I'] = [1.]..    
-00010ea0: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-00010eb0: 5b27 4349 562d 3135 3439 275d 203d 205b  ['CIV-1549'] = [
-00010ec0: 3135 3439 2e34 3830 5d0a 2020 2020 6c69  1549.480].    li
-00010ed0: 6e65 5f72 6174 696f 735b 2743 4956 2d31  ne_ratios['CIV-1
-00010ee0: 3534 3927 5d20 3d20 5b31 2e5d 0a20 2020  549'] = [1.].   
-00010ef0: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00010f00: 735b 2743 4949 492d 3139 3036 275d 203d  s['CIII-1906'] =
-00010f10: 205b 3139 3036 2e36 3833 5d0a 2020 2020   [1906.683].    
-00010f20: 6c69 6e65 5f72 6174 696f 735b 2743 4949  line_ratios['CII
-00010f30: 492d 3139 3036 275d 203d 205b 312e 5d0a  I-1906'] = [1.].
-00010f40: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00010f50: 6774 6873 5b27 4349 4949 2d31 3930 3827  gths['CIII-1908'
-00010f60: 5d20 3d20 5b31 3930 382e 3733 345d 0a20  ] = [1908.734]. 
-00010f70: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
-00010f80: 4349 4949 2d31 3930 3827 5d20 3d20 5b31  CIII-1908'] = [1
-00010f90: 2e5d 0a20 2020 206c 696e 655f 7761 7665  .].    line_wave
-00010fa0: 6c65 6e67 7468 735b 274f 4949 492d 3136  lengths['OIII-16
-00010fb0: 3633 275d 203d 205b 3136 3635 2e38 355d  63'] = [1665.85]
-00010fc0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
-00010fd0: 5b27 4f49 4949 2d31 3636 3327 5d20 3d20  ['OIII-1663'] = 
-00010fe0: 5b31 2e5d 0a20 2020 206c 696e 655f 7761  [1.].    line_wa
-00010ff0: 7665 6c65 6e67 7468 735b 2748 6549 492d  velengths['HeII-
-00011000: 3136 3430 275d 203d 205b 3136 3430 2e34  1640'] = [1640.4
-00011010: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
-00011020: 735b 2748 6549 492d 3136 3430 275d 203d  s['HeII-1640'] =
-00011030: 205b 312e 5d0a 0a20 2020 206c 696e 655f   [1.]..    line_
-00011040: 7761 7665 6c65 6e67 7468 735b 2753 6949  wavelengths['SiI
-00011050: 562b 4f49 562d 3133 3938 275d 203d 205b  V+OIV-1398'] = [
-00011060: 3133 3938 2e5d 0a20 2020 206c 696e 655f  1398.].    line_
-00011070: 7261 7469 6f73 5b27 5369 4956 2b4f 4956  ratios['SiIV+OIV
-00011080: 2d31 3339 3827 5d20 3d20 5b31 2e5d 0a0a  -1398'] = [1.]..
-00011090: 2020 2020 2320 5765 616b 206c 696e 6520      # Weak line 
-000110a0: 696e 204c 4547 412d 4320 7370 6563 7472  in LEGA-C spectr
-000110b0: 610a 2020 2020 6c69 6e65 5f77 6176 656c  a.    line_wavel
-000110c0: 656e 6774 6873 5b27 4e49 2d35 3139 3927  engths['NI-5199'
-000110d0: 5d20 3d20 5b35 3139 392e 342c 2035 3230  ] = [5199.4, 520
-000110e0: 312e 3736 5d0a 2020 2020 6c69 6e65 5f72  1.76].    line_r
-000110f0: 6174 696f 735b 274e 492d 3531 3939 275d  atios['NI-5199']
-00011100: 203d 205b 312e 2c20 312e 5d0a 0a20 2020   = [1., 1.]..   
-00011110: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00011120: 735b 274e 4949 275d 203d 205b 3635 3439  s['NII'] = [6549
-00011130: 2e38 362c 2036 3538 352e 3237 5d5b 3a3a  .86, 6585.27][::
-00011140: 2d31 5d0a 2020 2020 6c69 6e65 5f72 6174  -1].    line_rat
-00011150: 696f 735b 274e 4949 275d 203d 205b 312e  ios['NII'] = [1.
-00011160: 302c 2033 2e30 5d5b 3a3a 2d31 5d0a 0a20  0, 3.0][::-1].. 
-00011170: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-00011180: 7468 735b 274e 4949 2d36 3534 3927 5d20  ths['NII-6549'] 
-00011190: 3d20 5b36 3534 392e 3836 5d0a 2020 2020  = [6549.86].    
-000111a0: 6c69 6e65 5f72 6174 696f 735b 274e 4949  line_ratios['NII
-000111b0: 2d36 3534 3927 5d20 3d20 5b31 2e5d 0a20  -6549'] = [1.]. 
-000111c0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-000111d0: 7468 735b 274e 4949 2d36 3538 3427 5d20  ths['NII-6584'] 
-000111e0: 3d20 5b36 3538 352e 3237 5d0a 2020 2020  = [6585.27].    
-000111f0: 6c69 6e65 5f72 6174 696f 735b 274e 4949  line_ratios['NII
-00011200: 2d36 3538 3427 5d20 3d20 5b31 2e5d 0a0a  -6584'] = [1.]..
-00011210: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00011220: 6774 6873 5b27 4e49 4949 2d31 3735 3027  gths['NIII-1750'
-00011230: 5d20 3d20 5b31 3735 302e 5d0a 2020 2020  ] = [1750.].    
-00011240: 6c69 6e65 5f72 6174 696f 735b 274e 4949  line_ratios['NII
-00011250: 492d 3137 3530 275d 203d 205b 312e 5d0a  I-1750'] = [1.].
-00011260: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00011270: 6774 6873 5b27 4e49 562d 3134 3837 275d  gths['NIV-1487']
-00011280: 203d 205b 3134 3837 2e5d 0a20 2020 206c   = [1487.].    l
-00011290: 696e 655f 7261 7469 6f73 5b27 4e49 562d  ine_ratios['NIV-
-000112a0: 3134 3837 275d 203d 205b 312e 5d0a 2020  1487'] = [1.].  
-000112b0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
-000112c0: 6873 5b27 4e56 2d31 3234 3027 5d20 3d20  hs['NV-1240'] = 
-000112d0: 5b31 3234 302e 3831 5d0a 2020 2020 6c69  [1240.81].    li
-000112e0: 6e65 5f72 6174 696f 735b 274e 562d 3132  ne_ratios['NV-12
-000112f0: 3430 275d 203d 205b 312e 5d0a 0a20 2020  40'] = [1.]..   
-00011300: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00011310: 735b 274c 7961 275d 203d 205b 3132 3135  s['Lya'] = [1215
-00011320: 2e34 5d0a 2020 2020 6c69 6e65 5f72 6174  .4].    line_rat
-00011330: 696f 735b 274c 7961 275d 203d 205b 312e  ios['Lya'] = [1.
-00011340: 5d0a 0a20 2020 206c 696e 655f 7761 7665  ]..    line_wave
-00011350: 6c65 6e67 7468 735b 2751 534f 2d55 562d  lengths['QSO-UV-
-00011360: 6c69 6e65 7327 5d20 3d20 5b6c 696e 655f  lines'] = [line_
-00011370: 7761 7665 6c65 6e67 7468 735b 6b5d 5b30  wavelengths[k][0
-00011380: 5d20 666f 7220 6b20 696e 205b 274c 7961  ] for k in ['Lya
-00011390: 272c 2027 4349 562d 3135 3439 272c 2027  ', 'CIV-1549', '
-000113a0: 4349 4949 2d31 3930 3627 2c20 2743 4949  CIII-1906', 'CII
-000113b0: 492d 3139 3038 272c 2027 4f49 4949 2d31  I-1908', 'OIII-1
-000113c0: 3636 3327 2c20 2748 6549 492d 3136 3430  663', 'HeII-1640
-000113d0: 272c 2027 5369 4956 2b4f 4956 2d31 3339  ', 'SiIV+OIV-139
-000113e0: 3827 2c20 274e 562d 3132 3430 272c 2027  8', 'NV-1240', '
-000113f0: 4e49 4949 2d31 3735 3027 5d5d 0a20 2020  NIII-1750']].   
-00011400: 206c 696e 655f 7261 7469 6f73 5b27 5153   line_ratios['QS
-00011410: 4f2d 5556 2d6c 696e 6573 275d 203d 205b  O-UV-lines'] = [
-00011420: 312e 2c20 302e 352c 2030 2e31 2c20 302e  1., 0.5, 0.1, 0.
-00011430: 312c 2030 2e30 3038 2c20 302e 3039 2c20  1, 0.008, 0.09, 
-00011440: 302e 312c 2030 2e33 2c20 302e 3035 5d0a  0.1, 0.3, 0.05].
-00011450: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-00011460: 6e67 7468 735b 2751 534f 2d4e 6172 726f  ngths['QSO-Narro
-00011470: 772d 6c69 6e65 7327 5d20 3d20 5b6c 696e  w-lines'] = [lin
-00011480: 655f 7761 7665 6c65 6e67 7468 735b 6b5d  e_wavelengths[k]
-00011490: 5b30 5d20 666f 7220 6b20 696e 205b 274f  [0] for k in ['O
-000114a0: 4949 272c 2027 4f49 4949 2d35 3030 3727  II', 'OIII-5007'
-000114b0: 2c20 274f 4949 492d 3439 3539 272c 2027  , 'OIII-4959', '
-000114c0: 5349 492d 3637 3137 272c 2027 5349 492d  SII-6717', 'SII-
-000114d0: 3637 3331 272c 2027 4f49 2d36 3330 3227  6731', 'OI-6302'
-000114e0: 2c20 274e 6549 4949 2d33 3836 3727 2c20  , 'NeIII-3867', 
-000114f0: 274e 6556 492d 3334 3236 272c 2027 4e65  'NeVI-3426', 'Ne
-00011500: 562d 3333 3436 275d 5d0a 2020 2020 6c69  V-3346']].    li
-00011510: 6e65 5f72 6174 696f 735b 2751 534f 2d4e  ne_ratios['QSO-N
-00011520: 6172 726f 772d 6c69 6e65 7327 5d20 3d20  arrow-lines'] = 
-00011530: 5b30 2e32 2c20 312e 362c 2031 2e36 2f32  [0.2, 1.6, 1.6/2
-00011540: 2e39 382c 2030 2e31 2c20 302e 312c 2030  .98, 0.1, 0.1, 0
-00011550: 2e30 312c 2030 2e35 2c20 302e 322c 2030  .01, 0.5, 0.2, 0
-00011560: 2e30 325d 0a0a 2020 2020 2320 7265 6464  .02]..    # redd
-00011570: 6572 206c 696e 6573 0a20 2020 206c 696e  er lines.    lin
-00011580: 655f 7761 7665 6c65 6e67 7468 735b 2751  e_wavelengths['Q
-00011590: 534f 2d4e 6172 726f 772d 6c69 6e65 7327  SO-Narrow-lines'
-000115a0: 5d20 2b3d 206c 696e 655f 7761 7665 6c65  ] += line_wavele
-000115b0: 6e67 7468 735b 2753 4949 4927 5d0a 2020  ngths['SIII'].  
-000115c0: 2020 6c69 6e65 5f72 6174 696f 735b 2751    line_ratios['Q
-000115d0: 534f 2d4e 6172 726f 772d 6c69 6e65 7327  SO-Narrow-lines'
-000115e0: 5d20 2b3d 205b 6c72 2a30 2e30 3520 666f  ] += [lr*0.05 fo
-000115f0: 7220 6c72 2069 6e20 6c69 6e65 5f72 6174  r lr in line_rat
-00011600: 696f 735b 2753 4949 4927 5d5d 0a20 2020  ios['SIII']].   
-00011610: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00011620: 735b 2751 534f 2d4e 6172 726f 772d 6c69  s['QSO-Narrow-li
-00011630: 6e65 7327 5d20 2b3d 206c 696e 655f 7761  nes'] += line_wa
-00011640: 7665 6c65 6e67 7468 735b 2748 6549 2d31  velengths['HeI-1
-00011650: 3038 3327 5d0a 2020 2020 6c69 6e65 5f72  083'].    line_r
-00011660: 6174 696f 735b 2751 534f 2d4e 6172 726f  atios['QSO-Narro
-00011670: 772d 6c69 6e65 7327 5d20 2b3d 205b 302e  w-lines'] += [0.
-00011680: 325d 0a0a 2020 2020 6c69 6e65 5f77 6176  2]..    line_wav
-00011690: 656c 656e 6774 6873 5b27 4c79 612b 4349  elengths['Lya+CI
-000116a0: 5627 5d20 3d20 5b31 3231 352e 342c 2031  V'] = [1215.4, 1
-000116b0: 3534 392e 3439 5d0a 2020 2020 6c69 6e65  549.49].    line
-000116c0: 5f72 6174 696f 735b 274c 7961 2b43 4956  _ratios['Lya+CIV
-000116d0: 275d 203d 205b 312e 2c20 302e 315d 0a0a  '] = [1., 0.1]..
-000116e0: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-000116f0: 6774 6873 5b27 4761 6c2d 5556 2d6c 696e  gths['Gal-UV-lin
-00011700: 6573 275d 203d 205b 6c69 6e65 5f77 6176  es'] = [line_wav
-00011710: 656c 656e 6774 6873 5b6b 5d5b 305d 2066  elengths[k][0] f
-00011720: 6f72 206b 2069 6e20 5b27 4c79 6127 2c20  or k in ['Lya', 
-00011730: 2743 4956 2d31 3534 3927 2c20 2743 4949  'CIV-1549', 'CII
-00011740: 492d 3139 3036 272c 2027 4349 4949 2d31  I-1906', 'CIII-1
-00011750: 3930 3827 2c20 274f 4949 492d 3136 3633  908', 'OIII-1663
-00011760: 272c 2027 4865 4949 2d31 3634 3027 2c20  ', 'HeII-1640', 
-00011770: 2753 6949 562b 4f49 562d 3133 3938 272c  'SiIV+OIV-1398',
-00011780: 2027 4e56 2d31 3234 3027 2c20 274e 4949   'NV-1240', 'NII
-00011790: 492d 3137 3530 272c 2027 4d67 4949 275d  I-1750', 'MgII']
-000117a0: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
-000117b0: 735b 2747 616c 2d55 562d 6c69 6e65 7327  s['Gal-UV-lines'
-000117c0: 5d20 3d20 5b31 2e2c 2030 2e31 352c 2030  ] = [1., 0.15, 0
-000117d0: 2e31 2c20 302e 312c 2030 2e30 3038 2c20  .1, 0.1, 0.008, 
-000117e0: 302e 3039 2c20 302e 312c 2030 2e30 352c  0.09, 0.1, 0.05,
-000117f0: 2030 2e30 352c 2030 2e31 5d0a 0a20 2020   0.05, 0.1]..   
-00011800: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00011810: 735b 2748 612b 5349 4927 5d20 3d20 5b36  s['Ha+SII'] = [6
-00011820: 3536 342e 3631 2c20 3637 3138 2e32 392c  564.61, 6718.29,
-00011830: 2036 3733 322e 3637 5d0a 2020 2020 6c69   6732.67].    li
-00011840: 6e65 5f72 6174 696f 735b 2748 612b 5349  ne_ratios['Ha+SI
-00011850: 4927 5d20 3d20 5b31 2e2c 2031 2e2f 3130  I'] = [1., 1./10
-00011860: 2c20 312e 2f31 305d 0a0a 2020 2020 6c69  , 1./10]..    li
-00011870: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-00011880: 4861 2b53 4949 2b53 4949 492b 4865 275d  Ha+SII+SIII+He']
-00011890: 203d 205b 3635 3634 2e36 312c 2036 3731   = [6564.61, 671
-000118a0: 382e 3239 2c20 3637 3332 2e36 372c 2039  8.29, 6732.67, 9
-000118b0: 3036 382e 362c 2039 3533 302e 362c 2031  068.6, 9530.6, 1
-000118c0: 3038 3330 2e5d 0a20 2020 206c 696e 655f  0830.].    line_
-000118d0: 7261 7469 6f73 5b27 4861 2b53 4949 2b53  ratios['Ha+SII+S
-000118e0: 4949 492b 4865 275d 203d 205b 312e 2c20  III+He'] = [1., 
-000118f0: 312e 2f31 302c 2031 2e2f 3130 2c20 312e  1./10, 1./10, 1.
-00011900: 2f32 302c 2032 2e34 342f 3230 2c20 312e  /20, 2.44/20, 1.
-00011910: 2f32 352e 5d0a 0a20 2020 206c 696e 655f  /25.]..    line_
-00011920: 7761 7665 6c65 6e67 7468 735b 2748 612b  wavelengths['Ha+
-00011930: 4e49 492b 5349 492b 5349 4949 2b48 6527  NII+SII+SIII+He'
-00011940: 5d20 3d20 5b36 3536 342e 3631 2c20 3635  ] = [6564.61, 65
-00011950: 3439 2e38 362c 2036 3538 352e 3237 2c20  49.86, 6585.27, 
-00011960: 3637 3138 2e32 392c 2036 3733 322e 3637  6718.29, 6732.67
-00011970: 2c20 3930 3638 2e36 2c20 3935 3330 2e36  , 9068.6, 9530.6
-00011980: 2c20 3130 3833 302e 5d0a 2020 2020 6c69  , 10830.].    li
-00011990: 6e65 5f72 6174 696f 735b 2748 612b 4e49  ne_ratios['Ha+NI
-000119a0: 492b 5349 492b 5349 4949 2b48 6527 5d20  I+SII+SIII+He'] 
-000119b0: 3d20 5b31 2e2c 2031 2e2f 2834 2e2a 3429  = [1., 1./(4.*4)
-000119c0: 2c20 332e 2f28 342a 3429 2c20 312e 2f31  , 3./(4*4), 1./1
-000119d0: 302c 2031 2e2f 3130 2c20 312e 2f32 302c  0, 1./10, 1./20,
-000119e0: 2032 2e34 342f 3230 2c20 312e 2f32 352e   2.44/20, 1./25.
-000119f0: 5d0a 0a20 2020 206c 696e 655f 7761 7665  ]..    line_wave
-00011a00: 6c65 6e67 7468 735b 2748 612b 4e49 492b  lengths['Ha+NII+
-00011a10: 5349 492b 5349 4949 2b48 652b 5061 4227  SII+SIII+He+PaB'
-00011a20: 5d20 3d20 5b36 3536 342e 3631 2c20 3635  ] = [6564.61, 65
-00011a30: 3439 2e38 362c 2036 3538 352e 3237 2c20  49.86, 6585.27, 
-00011a40: 3637 3138 2e32 392c 2036 3733 322e 3637  6718.29, 6732.67
-00011a50: 2c20 3930 3638 2e36 2c20 3935 3330 2e36  , 9068.6, 9530.6
-00011a60: 2c20 3130 3833 302e 2c20 3132 3832 315d  , 10830., 12821]
-00011a70: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
-00011a80: 5b27 4861 2b4e 4949 2b53 4949 2b53 4949  ['Ha+NII+SII+SII
-00011a90: 492b 4865 2b50 6142 275d 203d 205b 312e  I+He+PaB'] = [1.
-00011aa0: 2c20 312e 2f28 342e 2a34 292c 2033 2e2f  , 1./(4.*4), 3./
-00011ab0: 2834 2a34 292c 2031 2e2f 3130 2c20 312e  (4*4), 1./10, 1.
-00011ac0: 2f31 302c 2031 2e2f 3230 2c20 322e 3434  /10, 1./20, 2.44
-00011ad0: 2f32 302c 2031 2e2f 3235 2e2c 2031 2e2f  /20, 1./25., 1./
-00011ae0: 3130 5d0a 0a20 2020 206c 696e 655f 7761  10]..    line_wa
-00011af0: 7665 6c65 6e67 7468 735b 2748 612b 4e49  velengths['Ha+NI
-00011b00: 492b 5349 492b 5349 4949 2b48 652b 5061  I+SII+SIII+He+Pa
-00011b10: 422b 5061 4727 5d20 3d20 5b36 3536 342e  B+PaG'] = [6564.
-00011b20: 3631 2c20 3635 3439 2e38 362c 2036 3538  61, 6549.86, 658
-00011b30: 352e 3237 2c20 3637 3138 2e32 392c 2036  5.27, 6718.29, 6
-00011b40: 3733 322e 3637 2c20 3930 3638 2e36 2c20  732.67, 9068.6, 
-00011b50: 3935 3330 2e36 2c20 3130 3833 302e 2c20  9530.6, 10830., 
-00011b60: 3132 3832 312c 2031 3039 3431 2e31 5d0a  12821, 10941.1].
-00011b70: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+000105f0: 5b27 4f49 2d36 3330 3227 5d20 3d20 5b31  ['OI-6302'] = [1
+00010600: 2c20 302e 3333 5d0a 2020 2020 6c69 6e65  , 0.33].    line
+00010610: 5f77 6176 656c 656e 6774 6873 5b27 4f49  _wavelengths['OI
+00010620: 2d35 3537 3827 5d20 3d20 5b35 3537 382e  -5578'] = [5578.
+00010630: 3839 5d0a 2020 2020 6c69 6e65 5f72 6174  89].    line_rat
+00010640: 696f 735b 274f 492d 3535 3738 275d 203d  ios['OI-5578'] =
+00010650: 205b 315d 0a0a 2020 2020 2320 4175 726f   [1]..    # Auro
+00010660: 7261 6c20 4f49 490a 2020 2020 2320 6c69  ral OII.    # li
+00010670: 6e65 7320 726f 7567 686c 7920 7461 6b65  nes roughly take
+00010680: 6e20 6672 6f6d 2068 7474 7073 3a2f 2f61  n from https://a
+00010690: 7278 6976 2e6f 7267 2f70 6466 2f31 3631  rxiv.org/pdf/161
+000106a0: 302e 3036 3933 392e 7064 660a 2020 2020  0.06939.pdf.    
+000106b0: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+000106c0: 5b27 4f49 492d 3733 3235 275d 203d 205b  ['OII-7325'] = [
+000106d0: 3733 3231 2e39 2c20 3733 3332 2e32 315d  7321.9, 7332.21]
+000106e0: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+000106f0: 5b27 4f49 492d 3733 3235 275d 203d 205b  ['OII-7325'] = [
+00010700: 312e 322c 2031 2e5d 0a0a 2020 2020 6c69  1.2, 1.]..    li
+00010710: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
+00010720: 4f49 492d 3733 3233 275d 203d 205b 3733  OII-7323'] = [73
+00010730: 3231 2e39 5d0a 2020 2020 6c69 6e65 5f72  21.9].    line_r
+00010740: 6174 696f 735b 274f 4949 2d37 3332 3327  atios['OII-7323'
+00010750: 5d20 3d20 5b31 2e5d 0a20 2020 206c 696e  ] = [1.].    lin
+00010760: 655f 7761 7665 6c65 6e67 7468 735b 274f  e_wavelengths['O
+00010770: 4949 2d37 3333 3227 5d20 3d20 5b37 3333  II-7332'] = [733
+00010780: 322e 3231 5d0a 2020 2020 6c69 6e65 5f72  2.21].    line_r
+00010790: 6174 696f 735b 274f 4949 2d37 3333 3227  atios['OII-7332'
+000107a0: 5d20 3d20 5b31 2e5d 0a0a 2020 2020 2320  ] = [1.]..    # 
+000107b0: 5765 616b 2041 7220 4949 4920 696e 2053  Weak Ar III in S
+000107c0: 4620 6761 6c61 7869 6573 0a20 2020 206c  F galaxies.    l
+000107d0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+000107e0: 2741 7249 4949 2d37 3133 3827 5d20 3d20  'ArIII-7138'] = 
+000107f0: 5b37 3133 372e 3737 5d0a 2020 2020 6c69  [7137.77].    li
+00010800: 6e65 5f72 6174 696f 735b 2741 7249 4949  ne_ratios['ArIII
+00010810: 2d37 3133 3827 5d20 3d20 5b31 2e5d 0a20  -7138'] = [1.]. 
+00010820: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+00010830: 7468 735b 2741 7249 4949 2d37 3735 3327  ths['ArIII-7753'
+00010840: 5d20 3d20 5b37 3735 332e 3139 5d0a 2020  ] = [7753.19].  
+00010850: 2020 6c69 6e65 5f72 6174 696f 735b 2741    line_ratios['A
+00010860: 7249 4949 2d37 3735 3327 5d20 3d20 5b31  rIII-7753'] = [1
+00010870: 2e5d 0a0a 2020 2020 6c69 6e65 5f77 6176  .]..    line_wav
+00010880: 656c 656e 6774 6873 5b27 4e65 4949 492d  elengths['NeIII-
+00010890: 3338 3637 275d 203d 205b 3338 3639 2e38  3867'] = [3869.8
+000108a0: 375d 0a20 2020 206c 696e 655f 7261 7469  7].    line_rati
+000108b0: 6f73 5b27 4e65 4949 492d 3338 3637 275d  os['NeIII-3867']
+000108c0: 203d 205b 312e 5d0a 2020 2020 6c69 6e65   = [1.].    line
+000108d0: 5f77 6176 656c 656e 6774 6873 5b27 4e65  _wavelengths['Ne
+000108e0: 4949 492d 3339 3638 275d 203d 205b 3339  III-3968'] = [39
+000108f0: 3638 2e35 395d 0a20 2020 206c 696e 655f  68.59].    line_
+00010900: 7261 7469 6f73 5b27 4e65 4949 492d 3339  ratios['NeIII-39
+00010910: 3638 275d 203d 205b 312e 5d0a 2020 2020  68'] = [1.].    
+00010920: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+00010930: 5b27 4e65 562d 3333 3436 275d 203d 205b  ['NeV-3346'] = [
+00010940: 3333 3433 2e35 5d0a 2020 2020 6c69 6e65  3343.5].    line
+00010950: 5f72 6174 696f 735b 274e 6556 2d33 3334  _ratios['NeV-334
+00010960: 3627 5d20 3d20 5b31 2e5d 0a20 2020 206c  6'] = [1.].    l
+00010970: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+00010980: 274e 6556 492d 3334 3236 275d 203d 205b  'NeVI-3426'] = [
+00010990: 3334 3236 2e38 355d 0a20 2020 206c 696e  3426.85].    lin
+000109a0: 655f 7261 7469 6f73 5b27 4e65 5649 2d33  e_ratios['NeVI-3
+000109b0: 3432 3627 5d20 3d20 5b31 2e5d 0a0a 2020  426'] = [1.]..  
+000109c0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+000109d0: 6873 5b27 5349 4949 275d 203d 205b 3930  hs['SIII'] = [90
+000109e0: 3731 2e31 2c20 3935 3333 2e32 5d5b 3a3a  71.1, 9533.2][::
+000109f0: 2d31 5d0a 2020 2020 6c69 6e65 5f72 6174  -1].    line_rat
+00010a00: 696f 735b 2753 4949 4927 5d20 3d20 5b31  ios['SIII'] = [1
+00010a10: 2c20 322e 3434 5d5b 3a3a 2d31 5d0a 0a20  , 2.44][::-1].. 
+00010a20: 2020 2023 2053 706c 6974 2064 6f75 626c     # Split doubl
+00010a30: 6574 2c20 6966 206e 6565 6465 640a 2020  et, if needed.  
+00010a40: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+00010a50: 6873 5b27 5349 4949 2d39 3036 3827 5d20  hs['SIII-9068'] 
+00010a60: 3d20 5b39 3037 312e 315d 0a20 2020 206c  = [9071.1].    l
+00010a70: 696e 655f 7261 7469 6f73 5b27 5349 4949  ine_ratios['SIII
+00010a80: 2d39 3036 3827 5d20 3d20 5b31 5d0a 2020  -9068'] = [1].  
+00010a90: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+00010aa0: 6873 5b27 5349 4949 2d39 3533 3127 5d20  hs['SIII-9531'] 
+00010ab0: 3d20 5b39 3533 332e 325d 0a20 2020 206c  = [9533.2].    l
+00010ac0: 696e 655f 7261 7469 6f73 5b27 5349 4949  ine_ratios['SIII
+00010ad0: 2d39 3533 3127 5d20 3d20 5b31 5d0a 2020  -9531'] = [1].  
+00010ae0: 2020 0a20 2020 206c 696e 655f 7761 7665    .    line_wave
+00010af0: 6c65 6e67 7468 735b 2753 4949 492d 3633  lengths['SIII-63
+00010b00: 3134 275d 203d 205b 3633 3133 2e38 315d  14'] = [6313.81]
+00010b10: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+00010b20: 5b27 5349 4949 2d36 3331 3427 5d20 3d20  ['SIII-6314'] = 
+00010b30: 5b31 2e5d 0a20 2020 200a 2020 2020 6c69  [1.].    .    li
+00010b40: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
+00010b50: 5349 4927 5d20 3d20 5b36 3731 382e 3239  SII'] = [6718.29
+00010b60: 2c20 3637 3332 2e36 375d 0a20 2020 206c  , 6732.67].    l
+00010b70: 696e 655f 7261 7469 6f73 5b27 5349 4927  ine_ratios['SII'
+00010b80: 5d20 3d20 5b31 2e2c 2031 2e5d 0a0a 2020  ] = [1., 1.]..  
+00010b90: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+00010ba0: 6873 5b27 5349 492d 3637 3137 275d 203d  hs['SII-6717'] =
+00010bb0: 205b 3637 3138 2e32 395d 0a20 2020 206c   [6718.29].    l
+00010bc0: 696e 655f 7261 7469 6f73 5b27 5349 492d  ine_ratios['SII-
+00010bd0: 3637 3137 275d 203d 205b 312e 5d0a 2020  6717'] = [1.].  
+00010be0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+00010bf0: 6873 5b27 5349 492d 3637 3331 275d 203d  hs['SII-6731'] =
+00010c00: 205b 3637 3332 2e36 375d 0a20 2020 206c   [6732.67].    l
+00010c10: 696e 655f 7261 7469 6f73 5b27 5349 492d  ine_ratios['SII-
+00010c20: 3637 3331 275d 203d 205b 312e 5d0a 0a20  6731'] = [1.].. 
+00010c30: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+00010c40: 7468 735b 2753 4949 2d34 3037 3527 5d20  ths['SII-4075'] 
+00010c50: 3d20 5b34 3036 392e 3735 2c20 3430 3737  = [4069.75, 4077
+00010c60: 2e35 5d0a 2020 2020 6c69 6e65 5f72 6174  .5].    line_rat
+00010c70: 696f 735b 2753 4949 2d34 3037 3527 5d20  ios['SII-4075'] 
+00010c80: 3d20 5b31 2e2c 2031 2e5d 0a20 2020 206c  = [1., 1.].    l
+00010c90: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+00010ca0: 2753 4949 2d34 3037 3027 5d20 3d20 5b34  'SII-4070'] = [4
+00010cb0: 3036 392e 3735 5d0a 2020 2020 6c69 6e65  069.75].    line
+00010cc0: 5f72 6174 696f 735b 2753 4949 2d34 3037  _ratios['SII-407
+00010cd0: 3527 5d20 3d20 5b31 2e5d 0a20 2020 206c  5'] = [1.].    l
+00010ce0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+00010cf0: 2753 4949 2d34 3037 3827 5d20 3d20 5b34  'SII-4078'] = [4
+00010d00: 3037 372e 355d 0a20 2020 206c 696e 655f  077.5].    line_
+00010d10: 7261 7469 6f73 5b27 5349 492d 3430 3738  ratios['SII-4078
+00010d20: 275d 203d 205b 312e 5d0a 2020 2020 0a20  '] = [1.].    . 
+00010d30: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+00010d40: 7468 735b 2748 6549 492d 3436 3837 275d  ths['HeII-4687']
+00010d50: 203d 205b 3436 3837 2e35 5d0a 2020 2020   = [4687.5].    
+00010d60: 6c69 6e65 5f72 6174 696f 735b 2748 6549  line_ratios['HeI
+00010d70: 492d 3436 3837 275d 203d 205b 312e 5d0a  I-4687'] = [1.].
+00010d80: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
+00010d90: 6774 6873 5b27 4865 4949 2d35 3431 3227  gths['HeII-5412'
+00010da0: 5d20 3d20 5b35 3431 322e 355d 0a20 2020  ] = [5412.5].   
+00010db0: 206c 696e 655f 7261 7469 6f73 5b27 4865   line_ratios['He
+00010dc0: 4949 2d35 3431 3227 5d20 3d20 5b31 2e5d  II-5412'] = [1.]
+00010dd0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00010de0: 6e67 7468 735b 2748 6549 2d35 3837 3727  ngths['HeI-5877'
+00010df0: 5d20 3d20 5b35 3837 372e 3234 395d 0a20  ] = [5877.249]. 
+00010e00: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+00010e10: 4865 492d 3538 3737 275d 203d 205b 312e  HeI-5877'] = [1.
+00010e20: 5d0a 2020 2020 6c69 6e65 5f77 6176 656c  ].    line_wavel
+00010e30: 656e 6774 6873 5b27 4865 492d 3338 3839  engths['HeI-3889
+00010e40: 275d 203d 205b 3338 3839 2e37 355d 0a20  '] = [3889.75]. 
+00010e50: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+00010e60: 4865 492d 3338 3839 275d 203d 205b 312e  HeI-3889'] = [1.
+00010e70: 5d0a 2020 2020 6c69 6e65 5f77 6176 656c  ].    line_wavel
+00010e80: 656e 6774 6873 5b27 4865 492d 3130 3833  engths['HeI-1083
+00010e90: 275d 203d 205b 3130 3833 322e 3035 372c  '] = [10832.057,
+00010ea0: 2031 3038 3333 2e33 3036 5d0a 2020 2020   10833.306].    
+00010eb0: 6c69 6e65 5f72 6174 696f 735b 2748 6549  line_ratios['HeI
+00010ec0: 2d31 3038 3327 5d20 3d20 5b31 2e2c 2031  -1083'] = [1., 1
+00010ed0: 2e5d 0a20 2020 206c 696e 655f 7761 7665  .].    line_wave
+00010ee0: 6c65 6e67 7468 735b 2748 6549 2d36 3638  lengths['HeI-668
+00010ef0: 3027 5d20 3d20 5b36 3637 392e 3939 355d  0'] = [6679.995]
+00010f00: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+00010f10: 5b27 4865 492d 3636 3830 275d 203d 205b  ['HeI-6680'] = [
+00010f20: 312e 5d0a 2020 2020 6c69 6e65 5f77 6176  1.].    line_wav
+00010f30: 656c 656e 6774 6873 5b27 4865 492d 3730  elengths['HeI-70
+00010f40: 3635 275d 203d 205b 3730 3637 2e31 5d0a  65'] = [7067.1].
+00010f50: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+00010f60: 2748 6549 2d37 3036 3527 5d20 3d20 5b31  'HeI-7065'] = [1
+00010f70: 2e5d 0a20 2020 206c 696e 655f 7761 7665  .].    line_wave
+00010f80: 6c65 6e67 7468 735b 2748 6549 2d38 3434  lengths['HeI-844
+00010f90: 3627 5d20 3d20 5b38 3434 362e 375d 0a20  6'] = [8446.7]. 
+00010fa0: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+00010fb0: 4865 492d 3834 3436 275d 203d 205b 312e  HeI-8446'] = [1.
+00010fc0: 5d0a 0a20 2020 2023 204f 7374 6572 6272  ]..    # Osterbr
+00010fd0: 6f63 6b20 5461 626c 6520 342e 350a 2020  ock Table 4.5.  
+00010fe0: 2020 2320 2d3e 204e 3d34 0a20 2020 206c    # -> N=4.    l
+00010ff0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+00011000: 2748 6549 2d73 6572 6965 7327 5d20 3d20  'HeI-series'] = 
+00011010: 5b34 3437 322e 372c 2035 3837 372e 322c  [4472.7, 5877.2,
+00011020: 2034 3032 372e 332c 2033 3832 302e 372c   4027.3, 3820.7,
+00011030: 2037 3036 372e 312c 2031 3038 3333 2e32   7067.1, 10833.2
+00011040: 2c20 3338 3839 2e37 2c20 3331 3838 2e37  , 3889.7, 3188.7
+00011050: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
+00011060: 735b 2748 6549 2d73 6572 6965 7327 5d20  s['HeI-series'] 
+00011070: 3d20 5b31 2e2c 2032 2e37 352c 2030 2e34  = [1., 2.75, 0.4
+00011080: 3734 2c20 302e 3236 342c 2030 2e33 3330  74, 0.264, 0.330
+00011090: 2c20 342e 3432 2c20 322e 3236 2c20 302e  , 4.42, 2.26, 0.
+000110a0: 3931 365d 0a0a 2020 2020 6c69 6e65 5f77  916]..    line_w
+000110b0: 6176 656c 656e 6774 6873 5b27 4d67 4949  avelengths['MgII
+000110c0: 275d 203d 205b 3237 3939 2e31 3137 5d0a  '] = [2799.117].
+000110d0: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+000110e0: 274d 6749 4927 5d20 3d20 5b31 2e5d 0a0a  'MgII'] = [1.]..
+000110f0: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
+00011100: 6774 6873 5b27 4349 562d 3135 3439 275d  gths['CIV-1549']
+00011110: 203d 205b 3135 3439 2e34 3830 5d0a 2020   = [1549.480].  
+00011120: 2020 6c69 6e65 5f72 6174 696f 735b 2743    line_ratios['C
+00011130: 4956 2d31 3534 3927 5d20 3d20 5b31 2e5d  IV-1549'] = [1.]
+00011140: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00011150: 6e67 7468 735b 2743 4949 492d 3139 3036  ngths['CIII-1906
+00011160: 275d 203d 205b 3139 3036 2e36 3833 5d0a  '] = [1906.683].
+00011170: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+00011180: 2743 4949 492d 3139 3036 275d 203d 205b  'CIII-1906'] = [
+00011190: 312e 5d0a 2020 2020 6c69 6e65 5f77 6176  1.].    line_wav
+000111a0: 656c 656e 6774 6873 5b27 4349 4949 2d31  elengths['CIII-1
+000111b0: 3930 3827 5d20 3d20 5b31 3930 382e 3733  908'] = [1908.73
+000111c0: 345d 0a20 2020 206c 696e 655f 7261 7469  4].    line_rati
+000111d0: 6f73 5b27 4349 4949 2d31 3930 3827 5d20  os['CIII-1908'] 
+000111e0: 3d20 5b31 2e5d 0a20 2020 206c 696e 655f  = [1.].    line_
+000111f0: 7761 7665 6c65 6e67 7468 735b 274f 4949  wavelengths['OII
+00011200: 492d 3136 3633 275d 203d 205b 3136 3635  I-1663'] = [1665
+00011210: 2e38 355d 0a20 2020 206c 696e 655f 7261  .85].    line_ra
+00011220: 7469 6f73 5b27 4f49 4949 2d31 3636 3327  tios['OIII-1663'
+00011230: 5d20 3d20 5b31 2e5d 0a20 2020 206c 696e  ] = [1.].    lin
+00011240: 655f 7761 7665 6c65 6e67 7468 735b 2748  e_wavelengths['H
+00011250: 6549 492d 3136 3430 275d 203d 205b 3136  eII-1640'] = [16
+00011260: 3430 2e34 5d0a 2020 2020 6c69 6e65 5f72  40.4].    line_r
+00011270: 6174 696f 735b 2748 6549 492d 3136 3430  atios['HeII-1640
+00011280: 275d 203d 205b 312e 5d0a 0a20 2020 206c  '] = [1.]..    l
+00011290: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+000112a0: 2753 6949 562b 4f49 562d 3133 3938 275d  'SiIV+OIV-1398']
+000112b0: 203d 205b 3133 3938 2e5d 0a20 2020 206c   = [1398.].    l
+000112c0: 696e 655f 7261 7469 6f73 5b27 5369 4956  ine_ratios['SiIV
+000112d0: 2b4f 4956 2d31 3339 3827 5d20 3d20 5b31  +OIV-1398'] = [1
+000112e0: 2e5d 0a0a 2020 2020 2320 5765 616b 206c  .]..    # Weak l
+000112f0: 696e 6520 696e 204c 4547 412d 4320 7370  ine in LEGA-C sp
+00011300: 6563 7472 610a 2020 2020 6c69 6e65 5f77  ectra.    line_w
+00011310: 6176 656c 656e 6774 6873 5b27 4e49 2d35  avelengths['NI-5
+00011320: 3139 3927 5d20 3d20 5b35 3139 392e 342c  199'] = [5199.4,
+00011330: 2035 3230 312e 3736 5d0a 2020 2020 6c69   5201.76].    li
+00011340: 6e65 5f72 6174 696f 735b 274e 492d 3531  ne_ratios['NI-51
+00011350: 3939 275d 203d 205b 312e 2c20 312e 5d0a  99'] = [1., 1.].
+00011360: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00011370: 6e67 7468 735b 274e 4949 275d 203d 205b  ngths['NII'] = [
+00011380: 3635 3439 2e38 362c 2036 3538 352e 3237  6549.86, 6585.27
+00011390: 5d5b 3a3a 2d31 5d0a 2020 2020 6c69 6e65  ][::-1].    line
+000113a0: 5f72 6174 696f 735b 274e 4949 275d 203d  _ratios['NII'] =
+000113b0: 205b 312e 302c 2033 2e30 5d5b 3a3a 2d31   [1.0, 3.0][::-1
+000113c0: 5d0a 0a20 2020 206c 696e 655f 7761 7665  ]..    line_wave
+000113d0: 6c65 6e67 7468 735b 274e 4949 2d36 3534  lengths['NII-654
+000113e0: 3927 5d20 3d20 5b36 3534 392e 3836 5d0a  9'] = [6549.86].
+000113f0: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+00011400: 274e 4949 2d36 3534 3927 5d20 3d20 5b31  'NII-6549'] = [1
+00011410: 2e5d 0a20 2020 206c 696e 655f 7761 7665  .].    line_wave
+00011420: 6c65 6e67 7468 735b 274e 4949 2d36 3538  lengths['NII-658
+00011430: 3427 5d20 3d20 5b36 3538 352e 3237 5d0a  4'] = [6585.27].
+00011440: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+00011450: 274e 4949 2d36 3538 3427 5d20 3d20 5b31  'NII-6584'] = [1
+00011460: 2e5d 0a0a 2020 2020 6c69 6e65 5f77 6176  .]..    line_wav
+00011470: 656c 656e 6774 6873 5b27 4e49 4949 2d31  elengths['NIII-1
+00011480: 3735 3027 5d20 3d20 5b31 3735 302e 5d0a  750'] = [1750.].
+00011490: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+000114a0: 274e 4949 492d 3137 3530 275d 203d 205b  'NIII-1750'] = [
+000114b0: 312e 5d0a 2020 2020 6c69 6e65 5f77 6176  1.].    line_wav
+000114c0: 656c 656e 6774 6873 5b27 4e49 562d 3134  elengths['NIV-14
+000114d0: 3837 275d 203d 205b 3134 3837 2e5d 0a20  87'] = [1487.]. 
+000114e0: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+000114f0: 4e49 562d 3134 3837 275d 203d 205b 312e  NIV-1487'] = [1.
+00011500: 5d0a 2020 2020 6c69 6e65 5f77 6176 656c  ].    line_wavel
+00011510: 656e 6774 6873 5b27 4e56 2d31 3234 3027  engths['NV-1240'
+00011520: 5d20 3d20 5b31 3234 302e 3831 5d0a 2020  ] = [1240.81].  
+00011530: 2020 6c69 6e65 5f72 6174 696f 735b 274e    line_ratios['N
+00011540: 562d 3132 3430 275d 203d 205b 312e 5d0a  V-1240'] = [1.].
+00011550: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00011560: 6e67 7468 735b 274c 7961 275d 203d 205b  ngths['Lya'] = [
+00011570: 3132 3135 2e34 5d0a 2020 2020 6c69 6e65  1215.4].    line
+00011580: 5f72 6174 696f 735b 274c 7961 275d 203d  _ratios['Lya'] =
+00011590: 205b 312e 5d0a 0a20 2020 206c 696e 655f   [1.]..    line_
+000115a0: 7761 7665 6c65 6e67 7468 735b 2751 534f  wavelengths['QSO
+000115b0: 2d55 562d 6c69 6e65 7327 5d20 3d20 5b6c  -UV-lines'] = [l
+000115c0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+000115d0: 6b5d 5b30 5d20 666f 7220 6b20 696e 205b  k][0] for k in [
+000115e0: 274c 7961 272c 2027 4349 562d 3135 3439  'Lya', 'CIV-1549
+000115f0: 272c 2027 4349 4949 2d31 3930 3627 2c20  ', 'CIII-1906', 
+00011600: 2743 4949 492d 3139 3038 272c 2027 4f49  'CIII-1908', 'OI
+00011610: 4949 2d31 3636 3327 2c20 2748 6549 492d  II-1663', 'HeII-
+00011620: 3136 3430 272c 2027 5369 4956 2b4f 4956  1640', 'SiIV+OIV
+00011630: 2d31 3339 3827 2c20 274e 562d 3132 3430  -1398', 'NV-1240
+00011640: 272c 2027 4e49 4949 2d31 3735 3027 5d5d  ', 'NIII-1750']]
+00011650: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+00011660: 5b27 5153 4f2d 5556 2d6c 696e 6573 275d  ['QSO-UV-lines']
+00011670: 203d 205b 312e 2c20 302e 352c 2030 2e31   = [1., 0.5, 0.1
+00011680: 2c20 302e 312c 2030 2e30 3038 2c20 302e  , 0.1, 0.008, 0.
+00011690: 3039 2c20 302e 312c 2030 2e33 2c20 302e  09, 0.1, 0.3, 0.
+000116a0: 3035 5d0a 0a20 2020 206c 696e 655f 7761  05]..    line_wa
+000116b0: 7665 6c65 6e67 7468 735b 2751 534f 2d4e  velengths['QSO-N
+000116c0: 6172 726f 772d 6c69 6e65 7327 5d20 3d20  arrow-lines'] = 
+000116d0: 5b6c 696e 655f 7761 7665 6c65 6e67 7468  [line_wavelength
+000116e0: 735b 6b5d 5b30 5d20 666f 7220 6b20 696e  s[k][0] for k in
+000116f0: 205b 274f 4949 272c 2027 4f49 4949 2d35   ['OII', 'OIII-5
+00011700: 3030 3727 2c20 274f 4949 492d 3439 3539  007', 'OIII-4959
+00011710: 272c 2027 5349 492d 3637 3137 272c 2027  ', 'SII-6717', '
+00011720: 5349 492d 3637 3331 272c 2027 4f49 2d36  SII-6731', 'OI-6
+00011730: 3330 3227 2c20 274e 6549 4949 2d33 3836  302', 'NeIII-386
+00011740: 3727 2c20 274e 6556 492d 3334 3236 272c  7', 'NeVI-3426',
+00011750: 2027 4e65 562d 3333 3436 275d 5d0a 2020   'NeV-3346']].  
+00011760: 2020 6c69 6e65 5f72 6174 696f 735b 2751    line_ratios['Q
+00011770: 534f 2d4e 6172 726f 772d 6c69 6e65 7327  SO-Narrow-lines'
+00011780: 5d20 3d20 5b30 2e32 2c20 312e 362c 2031  ] = [0.2, 1.6, 1
+00011790: 2e36 2f32 2e39 382c 2030 2e31 2c20 302e  .6/2.98, 0.1, 0.
+000117a0: 312c 2030 2e30 312c 2030 2e35 2c20 302e  1, 0.01, 0.5, 0.
+000117b0: 322c 2030 2e30 325d 0a0a 2020 2020 2320  2, 0.02]..    # 
+000117c0: 7265 6464 6572 206c 696e 6573 0a20 2020  redder lines.   
+000117d0: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
+000117e0: 735b 2751 534f 2d4e 6172 726f 772d 6c69  s['QSO-Narrow-li
+000117f0: 6e65 7327 5d20 2b3d 206c 696e 655f 7761  nes'] += line_wa
+00011800: 7665 6c65 6e67 7468 735b 2753 4949 4927  velengths['SIII'
+00011810: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
+00011820: 735b 2751 534f 2d4e 6172 726f 772d 6c69  s['QSO-Narrow-li
+00011830: 6e65 7327 5d20 2b3d 205b 6c72 2a30 2e30  nes'] += [lr*0.0
+00011840: 3520 666f 7220 6c72 2069 6e20 6c69 6e65  5 for lr in line
+00011850: 5f72 6174 696f 735b 2753 4949 4927 5d5d  _ratios['SIII']]
+00011860: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00011870: 6e67 7468 735b 2751 534f 2d4e 6172 726f  ngths['QSO-Narro
+00011880: 772d 6c69 6e65 7327 5d20 2b3d 206c 696e  w-lines'] += lin
+00011890: 655f 7761 7665 6c65 6e67 7468 735b 2748  e_wavelengths['H
+000118a0: 6549 2d31 3038 3327 5d0a 2020 2020 6c69  eI-1083'].    li
+000118b0: 6e65 5f72 6174 696f 735b 2751 534f 2d4e  ne_ratios['QSO-N
+000118c0: 6172 726f 772d 6c69 6e65 7327 5d20 2b3d  arrow-lines'] +=
+000118d0: 205b 302e 325d 0a0a 2020 2020 6c69 6e65   [0.2]..    line
+000118e0: 5f77 6176 656c 656e 6774 6873 5b27 4c79  _wavelengths['Ly
+000118f0: 612b 4349 5627 5d20 3d20 5b31 3231 352e  a+CIV'] = [1215.
+00011900: 342c 2031 3534 392e 3439 5d0a 2020 2020  4, 1549.49].    
+00011910: 6c69 6e65 5f72 6174 696f 735b 274c 7961  line_ratios['Lya
+00011920: 2b43 4956 275d 203d 205b 312e 2c20 302e  +CIV'] = [1., 0.
+00011930: 315d 0a0a 2020 2020 6c69 6e65 5f77 6176  1]..    line_wav
+00011940: 656c 656e 6774 6873 5b27 4761 6c2d 5556  elengths['Gal-UV
+00011950: 2d6c 696e 6573 275d 203d 205b 6c69 6e65  -lines'] = [line
+00011960: 5f77 6176 656c 656e 6774 6873 5b6b 5d5b  _wavelengths[k][
+00011970: 305d 2066 6f72 206b 2069 6e20 5b27 4c79  0] for k in ['Ly
+00011980: 6127 2c20 2743 4956 2d31 3534 3927 2c20  a', 'CIV-1549', 
+00011990: 2743 4949 492d 3139 3036 272c 2027 4349  'CIII-1906', 'CI
+000119a0: 4949 2d31 3930 3827 2c20 274f 4949 492d  II-1908', 'OIII-
+000119b0: 3136 3633 272c 2027 4865 4949 2d31 3634  1663', 'HeII-164
+000119c0: 3027 2c20 2753 6949 562b 4f49 562d 3133  0', 'SiIV+OIV-13
+000119d0: 3938 272c 2027 4e56 2d31 3234 3027 2c20  98', 'NV-1240', 
+000119e0: 274e 4949 492d 3137 3530 272c 2027 4d67  'NIII-1750', 'Mg
+000119f0: 4949 275d 5d0a 2020 2020 6c69 6e65 5f72  II']].    line_r
+00011a00: 6174 696f 735b 2747 616c 2d55 562d 6c69  atios['Gal-UV-li
+00011a10: 6e65 7327 5d20 3d20 5b31 2e2c 2030 2e31  nes'] = [1., 0.1
+00011a20: 352c 2030 2e31 2c20 302e 312c 2030 2e30  5, 0.1, 0.1, 0.0
+00011a30: 3038 2c20 302e 3039 2c20 302e 312c 2030  08, 0.09, 0.1, 0
+00011a40: 2e30 352c 2030 2e30 352c 2030 2e31 5d0a  .05, 0.05, 0.1].
+00011a50: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00011a60: 6e67 7468 735b 2748 612b 5349 4927 5d20  ngths['Ha+SII'] 
+00011a70: 3d20 5b36 3536 342e 3631 2c20 3637 3138  = [6564.61, 6718
+00011a80: 2e32 392c 2036 3733 322e 3637 5d0a 2020  .29, 6732.67].  
+00011a90: 2020 6c69 6e65 5f72 6174 696f 735b 2748    line_ratios['H
+00011aa0: 612b 5349 4927 5d20 3d20 5b31 2e2c 2031  a+SII'] = [1., 1
+00011ab0: 2e2f 3130 2c20 312e 2f31 305d 0a0a 2020  ./10, 1./10]..  
+00011ac0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+00011ad0: 6873 5b27 4861 2b53 4949 2b53 4949 492b  hs['Ha+SII+SIII+
+00011ae0: 4865 275d 203d 205b 3635 3634 2e36 312c  He'] = [6564.61,
+00011af0: 2036 3731 382e 3239 2c20 3637 3332 2e36   6718.29, 6732.6
+00011b00: 372c 2039 3036 382e 362c 2039 3533 302e  7, 9068.6, 9530.
+00011b10: 362c 2031 3038 3330 2e5d 0a20 2020 206c  6, 10830.].    l
+00011b20: 696e 655f 7261 7469 6f73 5b27 4861 2b53  ine_ratios['Ha+S
+00011b30: 4949 2b53 4949 492b 4865 275d 203d 205b  II+SIII+He'] = [
+00011b40: 312e 2c20 312e 2f31 302c 2031 2e2f 3130  1., 1./10, 1./10
+00011b50: 2c20 312e 2f32 302c 2032 2e34 342f 3230  , 1./20, 2.44/20
+00011b60: 2c20 312e 2f32 352e 5d0a 0a20 2020 206c  , 1./25.]..    l
+00011b70: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
 00011b80: 2748 612b 4e49 492b 5349 492b 5349 4949  'Ha+NII+SII+SIII
-00011b90: 2b48 652b 5061 422b 5061 4727 5d20 3d20  +He+PaB+PaG'] = 
-00011ba0: 5b31 2e2c 2031 2e2f 2834 2e2a 3429 2c20  [1., 1./(4.*4), 
-00011bb0: 332e 2f28 342a 3429 2c20 312e 2f31 302c  3./(4*4), 1./10,
-00011bc0: 2031 2e2f 3130 2c20 312e 2f32 302c 2032   1./10, 1./20, 2
-00011bd0: 2e34 342f 3230 2c20 312e 2f32 352e 2c20  .44/20, 1./25., 
-00011be0: 312e 2f31 302c 2031 2e2f 3130 2f32 2e38  1./10, 1./10/2.8
-00011bf0: 365d 0a0a 2020 2020 6c69 6e65 5f77 6176  6]..    line_wav
-00011c00: 656c 656e 6774 6873 5b27 4861 2b4e 4949  elengths['Ha+NII
-00011c10: 275d 203d 205b 3635 3634 2e36 312c 2036  '] = [6564.61, 6
-00011c20: 3534 392e 3836 2c20 3635 3835 2e32 375d  549.86, 6585.27]
-00011c30: 0a20 2020 206e 3268 6120 3d20 312e 2f33  .    n2ha = 1./3
-00011c40: 2020 2320 6c6f 6720 4e49 492f 4861 207e    # log NII/Ha ~
-00011c50: 202d 302e 362c 204b 6577 6c65 7920 3230   -0.6, Kewley 20
-00011c60: 3133 0a20 2020 206c 696e 655f 7261 7469  13.    line_rati
-00011c70: 6f73 5b27 4861 2b4e 4949 275d 203d 205b  os['Ha+NII'] = [
-00011c80: 312e 2c20 312e 2f34 2e2a 6e32 6861 2c20  1., 1./4.*n2ha, 
-00011c90: 332e 2f34 2e2a 6e32 6861 5d0a 0a20 2020  3./4.*n2ha]..   
-00011ca0: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00011cb0: 735b 274f 4949 492b 4862 275d 203d 205b  s['OIII+Hb'] = [
-00011cc0: 3530 3038 2e32 3430 2c20 3439 3630 2e32  5008.240, 4960.2
-00011cd0: 3935 2c20 3438 3632 2e36 385d 0a20 2020  95, 4862.68].   
-00011ce0: 206c 696e 655f 7261 7469 6f73 5b27 4f49   line_ratios['OI
-00011cf0: 4949 2b48 6227 5d20 3d20 5b32 2e39 382c  II+Hb'] = [2.98,
-00011d00: 2031 2c20 332e 3938 2f36 2e5d 0a0a 2020   1, 3.98/6.]..  
-00011d10: 2020 2320 496e 636c 7564 6520 6d6f 7265    # Include more
-00011d20: 2062 616c 6d65 7220 6c69 6e65 730a 2020   balmer lines.  
-00011d30: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
-00011d40: 6873 5b27 4f49 4949 2b48 622b 4867 2b48  hs['OIII+Hb+Hg+H
-00011d50: 6427 5d20 3d20 6c69 6e65 5f77 6176 656c  d'] = line_wavel
-00011d60: 656e 6774 6873 5b27 4f49 4949 275d 202b  engths['OIII'] +
-00011d70: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00011d80: 735b 2742 616c 6d65 7220 3130 6b4b 275d  s['Balmer 10kK']
-00011d90: 5b31 3a5d 0a20 2020 206c 696e 655f 7261  [1:].    line_ra
-00011da0: 7469 6f73 5b27 4f49 4949 2b48 622b 4867  tios['OIII+Hb+Hg
-00011db0: 2b48 6427 5d20 3d20 6c69 6e65 5f72 6174  +Hd'] = line_rat
-00011dc0: 696f 735b 274f 4949 4927 5d20 2b20 6c69  ios['OIII'] + li
-00011dd0: 6e65 5f72 6174 696f 735b 2742 616c 6d65  ne_ratios['Balme
-00011de0: 7220 3130 6b4b 275d 5b31 3a5d 0a20 2020  r 10kK'][1:].   
-00011df0: 2023 206f 3368 6220 3d20 312e 2f36 0a20   # o3hb = 1./6. 
-00011e00: 2020 2023 2066 6f72 2069 2069 6e20 7261     # for i in ra
-00011e10: 6e67 6528 322c 206c 656e 286c 696e 655f  nge(2, len(line_
-00011e20: 7261 7469 6f73 5b27 4261 6c6d 6572 2031  ratios['Balmer 1
-00011e30: 306b 4b27 5d29 2d31 293a 0a20 2020 2023  0kK'])-1):.    #
-00011e40: 2020 2020 2020 2020 206c 696e 655f 7261           line_ra
-00011e50: 7469 6f73 5b27 4f49 4949 2b48 622b 4867  tios['OIII+Hb+Hg
-00011e60: 2b48 6427 5d5b 695d 202a 3d20 332e 3938  +Hd'][i] *= 3.98
-00011e70: 2a6f 3368 620a 2020 2020 2320 436f 6d70  *o3hb.    # Comp
-00011e80: 7574 6520 6173 204f 332f 4862 0a20 2020  ute as O3/Hb.   
-00011e90: 206f 3368 6220 3d20 360a 2020 2020 666f   o3hb = 6.    fo
-00011ea0: 7220 6920 696e 2072 616e 6765 2832 293a  r i in range(2):
-00011eb0: 0a20 2020 2020 2020 206c 696e 655f 7261  .        line_ra
-00011ec0: 7469 6f73 5b27 4f49 4949 2b48 622b 4867  tios['OIII+Hb+Hg
-00011ed0: 2b48 6427 5d5b 695d 202a 3d20 312e 2f33  +Hd'][i] *= 1./3
-00011ee0: 2e39 382a 6f33 6862 0a0a 2020 2020 6c69  .98*o3hb..    li
-00011ef0: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-00011f00: 4f49 4949 2b48 622b 4861 275d 203d 205b  OIII+Hb+Ha'] = [
-00011f10: 3530 3038 2e32 3430 2c20 3439 3630 2e32  5008.240, 4960.2
-00011f20: 3935 2c20 3438 3632 2e36 382c 2036 3536  95, 4862.68, 656
-00011f30: 342e 3631 5d0a 2020 2020 6c69 6e65 5f72  4.61].    line_r
-00011f40: 6174 696f 735b 274f 4949 492b 4862 2b48  atios['OIII+Hb+H
-00011f50: 6127 5d20 3d20 5b32 2e39 382c 2031 2c20  a'] = [2.98, 1, 
-00011f60: 332e 3938 2f31 302e 2c20 332e 3938 2f31  3.98/10., 3.98/1
-00011f70: 302e 2a32 2e38 365d 0a0a 2020 2020 6c69  0.*2.86]..    li
-00011f80: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-00011f90: 4f49 4949 2b48 622b 4861 2b53 4949 275d  OIII+Hb+Ha+SII']
-00011fa0: 203d 205b 3530 3038 2e32 3430 2c20 3439   = [5008.240, 49
-00011fb0: 3630 2e32 3935 2c20 3438 3632 2e36 382c  60.295, 4862.68,
-00011fc0: 2036 3536 342e 3631 2c20 3637 3138 2e32   6564.61, 6718.2
-00011fd0: 392c 2036 3733 322e 3637 5d0a 2020 2020  9, 6732.67].    
-00011fe0: 6c69 6e65 5f72 6174 696f 735b 274f 4949  line_ratios['OII
-00011ff0: 492b 4862 2b48 612b 5349 4927 5d20 3d20  I+Hb+Ha+SII'] = 
-00012000: 5b32 2e39 382c 2031 2c20 332e 3938 2f31  [2.98, 1, 3.98/1
-00012010: 302e 2c20 332e 3938 2f31 302e 2a32 2e38  0., 3.98/10.*2.8
-00012020: 362a 342c 2033 2e39 382f 3130 2e2a 322e  6*4, 3.98/10.*2.
-00012030: 3836 2f31 302e 2a34 2c20 332e 3938 2f31  86/10.*4, 3.98/1
-00012040: 302e 2a32 2e38 362f 3130 2e2a 345d 0a0a  0.*2.86/10.*4]..
-00012050: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00012060: 6774 6873 5b27 4f49 4949 2b4f 4949 275d  gths['OIII+OII']
-00012070: 203d 205b 3530 3038 2e32 3430 2c20 3439   = [5008.240, 49
-00012080: 3630 2e32 3935 2c20 3337 3239 2e38 3735  60.295, 3729.875
-00012090: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
-000120a0: 735b 274f 4949 492b 4f49 4927 5d20 3d20  s['OIII+OII'] = 
-000120b0: 5b32 2e39 382c 2031 2c20 332e 3938 2f34  [2.98, 1, 3.98/4
-000120c0: 2e5d 0a0a 2020 2020 6c69 6e65 5f77 6176  .]..    line_wav
-000120d0: 656c 656e 6774 6873 5b27 4f49 492b 4e65  elengths['OII+Ne
-000120e0: 275d 203d 205b 3337 3239 2e38 3735 2c20  '] = [3729.875, 
-000120f0: 3338 3639 5d0a 2020 2020 6c69 6e65 5f72  3869].    line_r
-00012100: 6174 696f 735b 274f 4949 2b4e 6527 5d20  atios['OII+Ne'] 
-00012110: 3d20 5b31 2c20 312e 2f35 5d0a 0a20 2020  = [1, 1./5]..   
-00012120: 2023 2047 726f 7570 7320 6f66 2061 6c6c   # Groups of all
-00012130: 206c 696e 6573 0a20 2020 206c 696e 655f   lines.    line_
-00012140: 7761 7665 6c65 6e67 7468 735b 2766 756c  wavelengths['ful
-00012150: 6c27 5d20 3d20 5b77 2066 6f72 2077 2069  l'] = [w for w i
-00012160: 6e20 6c69 6e65 5f77 6176 656c 656e 6774  n line_wavelengt
-00012170: 6873 5b27 4261 6c6d 6572 2031 306b 4b27  hs['Balmer 10kK'
-00012180: 5d5d 0a20 2020 206c 696e 655f 7261 7469  ]].    line_rati
-00012190: 6f73 5b27 6675 6c6c 275d 203d 205b 7720  os['full'] = [w 
-000121a0: 666f 7220 7720 696e 206c 696e 655f 7261  for w in line_ra
-000121b0: 7469 6f73 5b27 4261 6c6d 6572 2031 306b  tios['Balmer 10k
-000121c0: 4b27 5d5d 0a0a 2020 2020 6c69 6e65 5f77  K']]..    line_w
-000121d0: 6176 656c 656e 6774 6873 5b27 6675 6c6c  avelengths['full
-000121e0: 275d 202b 3d20 6c69 6e65 5f77 6176 656c  '] += line_wavel
-000121f0: 656e 6774 6873 5b27 4e49 4927 5d0a 2020  engths['NII'].  
-00012200: 2020 6c69 6e65 5f72 6174 696f 735b 2766    line_ratios['f
-00012210: 756c 6c27 5d20 2b3d 205b 312e 2f35 2f33  ull'] += [1./5/3
-00012220: 2e2a 6c69 6e65 5f72 6174 696f 735b 2742  .*line_ratios['B
-00012230: 616c 6d65 7220 3130 6b4b 275d 5b31 5d2a  almer 10kK'][1]*
-00012240: 7220 666f 7220 7220 696e 206c 696e 655f  r for r in line_
-00012250: 7261 7469 6f73 5b27 4e49 4927 5d5d 0a0a  ratios['NII']]..
-00012260: 2020 2020 6c69 6e65 5f77 6176 656c 656e      line_wavelen
-00012270: 6774 6873 5b27 6675 6c6c 275d 202b 3d20  gths['full'] += 
-00012280: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-00012290: 5b27 5349 4927 5d0a 2020 2020 6c69 6e65  ['SII'].    line
-000122a0: 5f72 6174 696f 735b 2766 756c 6c27 5d20  _ratios['full'] 
-000122b0: 2b3d 205b 312e 2f33 2e38 2f32 2a6c 696e  += [1./3.8/2*lin
-000122c0: 655f 7261 7469 6f73 5b27 4261 6c6d 6572  e_ratios['Balmer
-000122d0: 2031 306b 4b27 5d5b 315d 2a72 2066 6f72   10kK'][1]*r for
-000122e0: 2072 2069 6e20 6c69 6e65 5f72 6174 696f   r in line_ratio
-000122f0: 735b 2753 4949 275d 5d0a 0a20 2020 2023  s['SII']]..    #
-00012300: 204c 696e 6573 2066 726f 6d20 4861 6765   Lines from Hage
-00012310: 6c65 2032 3030 362c 206c 6f77 2d5a 2048  le 2006, low-Z H
-00012320: 4949 2067 616c 6178 6965 730a 2020 2020  II galaxies.    
-00012330: 2320 5344 5353 204a 3030 3231 3031 2e30  # SDSS J002101.0
-00012340: 332b 3030 3532 3438 2e31 0a20 2020 206c  3+005248.1.    l
-00012350: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-00012360: 2766 756c 6c27 5d20 2b3d 206c 696e 655f  'full'] += line_
-00012370: 7761 7665 6c65 6e67 7468 735b 2753 4949  wavelengths['SII
-00012380: 4927 5d0a 2020 2020 6c69 6e65 5f72 6174  I'].    line_rat
-00012390: 696f 735b 2766 756c 6c27 5d20 2b3d 205b  ios['full'] += [
-000123a0: 3430 312e 2f31 3030 302f 322e 3434 2a6c  401./1000/2.44*l
-000123b0: 696e 655f 7261 7469 6f73 5b27 4261 6c6d  ine_ratios['Balm
-000123c0: 6572 2031 306b 4b27 5d5b 315d 2a72 2066  er 10kK'][1]*r f
-000123d0: 6f72 2072 2069 6e20 6c69 6e65 5f72 6174  or r in line_rat
-000123e0: 696f 735b 2753 4949 4927 5d5d 0a0a 2020  ios['SIII']]..  
-000123f0: 2020 2320 4865 490a 2020 2020 6c69 6e65    # HeI.    line
-00012400: 5f77 6176 656c 656e 6774 6873 5b27 6675  _wavelengths['fu
-00012410: 6c6c 275d 202b 3d20 6c69 6e65 5f77 6176  ll'] += line_wav
-00012420: 656c 656e 6774 6873 5b27 4865 492d 7365  elengths['HeI-se
-00012430: 7269 6573 275d 0a20 2020 2068 6535 3837  ries'].    he587
-00012440: 375f 6862 203d 2031 3237 2e2f 3130 3030  7_hb = 127./1000
-00012450: 2f6c 696e 655f 7261 7469 6f73 5b27 4865  /line_ratios['He
-00012460: 492d 7365 7269 6573 275d 5b31 5d0a 2020  I-series'][1].  
-00012470: 2020 6c69 6e65 5f72 6174 696f 735b 2766    line_ratios['f
-00012480: 756c 6c27 5d20 2b3d 205b 6865 3538 3737  ull'] += [he5877
-00012490: 5f68 622a 7220 666f 7220 7220 696e 206c  _hb*r for r in l
-000124a0: 696e 655f 7261 7469 6f73 5b27 4865 492d  ine_ratios['HeI-
-000124b0: 7365 7269 6573 275d 5d0a 0a20 2020 2023  series']]..    #
-000124c0: 204e 6549 4949 0a20 2020 206c 696e 655f   NeIII.    line_
-000124d0: 7761 7665 6c65 6e67 7468 735b 2766 756c  wavelengths['ful
-000124e0: 6c27 5d20 2b3d 206c 696e 655f 7761 7665  l'] += line_wave
-000124f0: 6c65 6e67 7468 735b 274e 6549 4949 2d33  lengths['NeIII-3
-00012500: 3836 3727 5d0a 2020 2020 6c69 6e65 5f72  867'].    line_r
-00012510: 6174 696f 735b 2766 756c 6c27 5d20 2b3d  atios['full'] +=
-00012520: 205b 3338 382e 2f31 3030 3020 666f 7220   [388./1000 for 
-00012530: 7220 696e 206c 696e 655f 7261 7469 6f73  r in line_ratios
-00012540: 5b27 4e65 4949 492d 3338 3637 275d 5d0a  ['NeIII-3867']].
-00012550: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-00012560: 6e67 7468 735b 2766 756c 6c27 5d20 2b3d  ngths['full'] +=
-00012570: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00012580: 735b 274e 6549 4949 2d33 3936 3827 5d0a  s['NeIII-3968'].
-00012590: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
-000125a0: 2766 756c 6c27 5d20 2b3d 205b 3239 302e  'full'] += [290.
-000125b0: 2f31 3030 3020 666f 7220 7220 696e 206c  /1000 for r in l
-000125c0: 696e 655f 7261 7469 6f73 5b27 4e65 4949  ine_ratios['NeII
-000125d0: 492d 3339 3638 275d 5d0a 0a20 2020 2023  I-3968']]..    #
-000125e0: 2041 6464 2055 5620 6c69 6e65 733a 204d   Add UV lines: M
-000125f0: 6749 492f 4862 203d 2033 0a20 2020 206c  gII/Hb = 3.    l
-00012600: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-00012610: 2766 756c 6c27 5d20 2b3d 206c 696e 655f  'full'] += line_
-00012620: 7761 7665 6c65 6e67 7468 735b 2747 616c  wavelengths['Gal
-00012630: 2d55 562d 6c69 6e65 7327 5d0a 2020 2020  -UV-lines'].    
-00012640: 6c69 6e65 5f72 6174 696f 735b 2766 756c  line_ratios['ful
-00012650: 6c27 5d20 2b3d 205b 722a 332f 6c69 6e65  l'] += [r*3/line
-00012660: 5f72 6174 696f 735b 2747 616c 2d55 562d  _ratios['Gal-UV-
-00012670: 6c69 6e65 7327 5d5b 2d31 5d20 666f 7220  lines'][-1] for 
-00012680: 7220 696e 206c 696e 655f 7261 7469 6f73  r in line_ratios
-00012690: 5b27 4761 6c2d 5556 2d6c 696e 6573 275d  ['Gal-UV-lines']
-000126a0: 5d0a 0a20 2020 2023 2048 6967 6820 4f33  ]..    # High O3
-000126b0: 3220 2d20 6c6f 7720 6d65 7461 6c6c 6963  2 - low metallic
-000126c0: 6974 790a 2020 2020 6f33 322c 2072 3233  ity.    o32, r23
-000126d0: 203d 2034 2c20 380a 2020 2020 6f33 5f68   = 4, 8.    o3_h
-000126e0: 6220 3d20 7232 332f 2831 2b31 2f6f 3332  b = r23/(1+1/o32
-000126f0: 290a 0a20 2020 206c 696e 655f 7761 7665  )..    line_wave
-00012700: 6c65 6e67 7468 735b 2768 6967 684f 3332  lengths['highO32
-00012710: 275d 203d 205b 7720 666f 7220 7720 696e  '] = [w for w in
-00012720: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00012730: 735b 2766 756c 6c27 5d5d 0a20 2020 206c  s['full']].    l
-00012740: 696e 655f 7261 7469 6f73 5b27 6869 6768  ine_ratios['high
-00012750: 4f33 3227 5d20 3d20 5b72 2066 6f72 2072  O32'] = [r for r
-00012760: 2069 6e20 6c69 6e65 5f72 6174 696f 735b   in line_ratios[
-00012770: 2766 756c 6c27 5d5d 0a0a 2020 2020 6c69  'full']]..    li
-00012780: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
-00012790: 6869 6768 4f33 3227 5d20 2b3d 206c 696e  highO32'] += lin
-000127a0: 655f 7761 7665 6c65 6e67 7468 735b 274f  e_wavelengths['O
-000127b0: 4949 4927 5d0a 2020 2020 6c69 6e65 5f72  III'].    line_r
-000127c0: 6174 696f 735b 2768 6967 684f 3332 275d  atios['highO32']
-000127d0: 202b 3d20 5b72 2a6f 335f 6862 2f33 2e39   += [r*o3_hb/3.9
-000127e0: 3820 666f 7220 7220 696e 206c 696e 655f  8 for r in line_
-000127f0: 7261 7469 6f73 5b27 4f49 4949 275d 5d0a  ratios['OIII']].
-00012800: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-00012810: 6e67 7468 735b 2768 6967 684f 3332 275d  ngths['highO32']
-00012820: 202b 3d20 6c69 6e65 5f77 6176 656c 656e   += line_wavelen
-00012830: 6774 6873 5b27 4f49 4927 5d0a 2020 2020  gths['OII'].    
-00012840: 6c69 6e65 5f72 6174 696f 735b 2768 6967  line_ratios['hig
-00012850: 684f 3332 275d 202b 3d20 5b72 2a6f 335f  hO32'] += [r*o3_
-00012860: 6862 2f32 2f6f 3332 2066 6f72 2072 2069  hb/2/o32 for r i
-00012870: 6e20 6c69 6e65 5f72 6174 696f 735b 274f  n line_ratios['O
-00012880: 4949 275d 5d0a 0a20 2020 2023 204c 6f77  II']]..    # Low
-00012890: 204f 3332 202d 206c 6f77 206d 6574 616c   O32 - low metal
-000128a0: 6c69 6369 7479 0a20 2020 206f 3332 2c20  licity.    o32, 
-000128b0: 7232 3320 3d20 302e 332c 2034 0a20 2020  r23 = 0.3, 4.   
-000128c0: 206f 335f 6862 203d 2072 3233 2f28 312b   o3_hb = r23/(1+
-000128d0: 312f 6f33 3229 0a0a 2020 2020 6c69 6e65  1/o32)..    line
-000128e0: 5f77 6176 656c 656e 6774 6873 5b27 6c6f  _wavelengths['lo
-000128f0: 774f 3332 275d 203d 205b 7720 666f 7220  wO32'] = [w for 
-00012900: 7720 696e 206c 696e 655f 7761 7665 6c65  w in line_wavele
-00012910: 6e67 7468 735b 2766 756c 6c27 5d5d 0a20  ngths['full']]. 
-00012920: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
-00012930: 6c6f 774f 3332 275d 203d 205b 7220 666f  lowO32'] = [r fo
-00012940: 7220 7220 696e 206c 696e 655f 7261 7469  r r in line_rati
-00012950: 6f73 5b27 6675 6c6c 275d 5d0a 0a20 2020  os['full']]..   
-00012960: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00012970: 735b 276c 6f77 4f33 3227 5d20 2b3d 206c  s['lowO32'] += l
-00012980: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
-00012990: 274f 4949 4927 5d0a 2020 2020 6c69 6e65  'OIII'].    line
-000129a0: 5f72 6174 696f 735b 276c 6f77 4f33 3227  _ratios['lowO32'
-000129b0: 5d20 2b3d 205b 722a 6f33 5f68 622f 332e  ] += [r*o3_hb/3.
-000129c0: 3938 2066 6f72 2072 2069 6e20 6c69 6e65  98 for r in line
-000129d0: 5f72 6174 696f 735b 274f 4949 4927 5d5d  _ratios['OIII']]
-000129e0: 0a0a 2020 2020 6c69 6e65 5f77 6176 656c  ..    line_wavel
-000129f0: 656e 6774 6873 5b27 6c6f 774f 3332 275d  engths['lowO32']
-00012a00: 202b 3d20 6c69 6e65 5f77 6176 656c 656e   += line_wavelen
-00012a10: 6774 6873 5b27 4f49 4927 5d0a 2020 2020  gths['OII'].    
-00012a20: 6c69 6e65 5f72 6174 696f 735b 276c 6f77  line_ratios['low
-00012a30: 4f33 3227 5d20 2b3d 205b 722a 6f33 5f68  O32'] += [r*o3_h
-00012a40: 622f 322f 6f33 3220 666f 7220 7220 696e  b/2/o32 for r in
-00012a50: 206c 696e 655f 7261 7469 6f73 5b27 4f49   line_ratios['OI
-00012a60: 4927 5d5d 0a0a 2020 2020 7265 7475 726e  I']]..    return
-00012a70: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
-00012a80: 732c 206c 696e 655f 7261 7469 6f73 0a0a  s, line_ratios..
-00012a90: 0a64 6566 2065 6d69 7373 696f 6e5f 6c69  .def emission_li
-00012aa0: 6e65 5f74 656d 706c 6174 6573 2829 3a0a  ne_templates():.
-00012ab0: 2020 2020 2222 220a 2020 2020 5465 7374      """.    Test
-00012ac0: 696e 6720 4653 5053 206c 696e 6520 7465  ing FSPS line te
-00012ad0: 6d70 6c61 7465 730a 2020 2020 2222 220a  mplates.    """.
-00012ae0: 2020 2020 696d 706f 7274 206e 756d 7079      import numpy
-00012af0: 2061 7320 6e70 0a20 2020 2069 6d70 6f72   as np.    impor
-00012b00: 7420 6d61 7470 6c6f 746c 6962 2e70 7970  t matplotlib.pyp
-00012b10: 6c6f 7420 6173 2070 6c74 0a20 2020 2066  lot as plt.    f
-00012b20: 726f 6d20 6772 697a 6c69 2069 6d70 6f72  rom grizli impor
-00012b30: 7420 7574 696c 730a 2020 2020 696d 706f  t utils.    impo
-00012b40: 7274 2066 7370 730a 2020 2020 7370 203d  rt fsps.    sp =
-00012b50: 2066 7370 732e 5374 656c 6c61 7250 6f70   fsps.StellarPop
-00012b60: 756c 6174 696f 6e28 696d 665f 7479 7065  ulation(imf_type
-00012b70: 3d31 2c20 7a63 6f6e 7469 6e75 6f75 733d  =1, zcontinuous=
-00012b80: 3129 0a0a 2020 2020 7370 5f70 6172 616d  1)..    sp_param
-00012b90: 7320 3d20 7b7d 0a0a 2020 2020 7370 5f70  s = {}..    sp_p
-00012ba0: 6172 616d 735b 2773 7461 7262 7572 7374  arams['starburst
-00012bb0: 275d 203d 207b 2773 6668 273a 2034 2c20  '] = {'sfh': 4, 
-00012bc0: 2774 6175 273a 2030 2e33 2c20 2774 6167  'tau': 0.3, 'tag
-00012bd0: 6527 3a20 302e 312c 0a20 2020 2020 2020  e': 0.1,.       
-00012be0: 2020 2027 6c6f 677a 736f 6c27 3a20 2d31     'logzsol': -1
-00012bf0: 2c20 2767 6173 5f6c 6f67 7a27 3a20 2d31  , 'gas_logz': -1
-00012c00: 2c0a 2020 2020 2020 2020 2020 2767 6173  ,.          'gas
-00012c10: 5f6c 6f67 7527 3a20 2d32 2e35 7d0a 0a20  _logu': -2.5}.. 
-00012c20: 2020 2073 705f 7061 7261 6d73 5b27 6d61     sp_params['ma
-00012c30: 7475 7265 275d 203d 207b 2773 6668 273a  ture'] = {'sfh':
-00012c40: 2034 2c20 2774 6175 273a 2030 2e32 2c20   4, 'tau': 0.2, 
-00012c50: 2774 6167 6527 3a20 302e 392c 0a20 2020  'tage': 0.9,.   
-00012c60: 2020 2020 2027 6c6f 677a 736f 6c27 3a20       'logzsol': 
-00012c70: 2d30 2e32 2c20 2767 6173 5f6c 6f67 7a27  -0.2, 'gas_logz'
-00012c80: 3a20 2d30 2e32 2c0a 2020 2020 2020 2020  : -0.2,.        
-00012c90: 2767 6173 5f6c 6f67 7527 3a20 2d32 2e35  'gas_logu': -2.5
-00012ca0: 7d0a 0a20 2020 206c 696e 655f 7465 6d70  }..    line_temp
-00012cb0: 6c61 7465 7320 3d20 7b7d 0a0a 2020 2020  lates = {}..    
-00012cc0: 666f 7220 7420 696e 2073 705f 7061 7261  for t in sp_para
-00012cd0: 6d73 3a0a 2020 2020 2020 2020 7073 6574  ms:.        pset
-00012ce0: 203d 2073 705f 7061 7261 6d73 5b74 5d0a   = sp_params[t].
-00012cf0: 2020 2020 2020 2020 6865 6164 6572 203d          header =
-00012d00: 2027 7761 7665 2066 6c75 785c 6e5c 6e27   'wave flux\n\n'
-00012d10: 0a20 2020 2020 2020 2066 6f72 2070 2069  .        for p i
-00012d20: 6e20 7073 6574 3a0a 2020 2020 2020 2020  n pset:.        
-00012d30: 2020 2020 6865 6164 6572 202b 3d20 277b      header += '{
-00012d40: 307d 203d 207b 317d 5c6e 272e 666f 726d  0} = {1}\n'.form
-00012d50: 6174 2870 2c20 7073 6574 5b70 5d29 0a20  at(p, pset[p]). 
-00012d60: 2020 2020 2020 2020 2020 2069 6620 7020             if p 
-00012d70: 3d3d 2027 7461 6765 273a 0a20 2020 2020  == 'tage':.     
-00012d80: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00012d90: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-00012da0: 2070 7269 6e74 2870 2c20 7073 6574 5b70   print(p, pset[p
-00012db0: 5d29 0a20 2020 2020 2020 2020 2020 2073  ]).            s
-00012dc0: 702e 7061 7261 6d73 5b70 5d20 3d20 7073  p.params[p] = ps
-00012dd0: 6574 5b70 5d0a 0a20 2020 2020 2020 2073  et[p]..        s
-00012de0: 7065 6320 3d20 7b7d 0a20 2020 2020 2020  pec = {}.       
-00012df0: 2066 6f72 206e 6562 2069 6e20 5b54 7275   for neb in [Tru
-00012e00: 652c 2046 616c 7365 5d3a 0a20 2020 2020  e, False]:.     
-00012e10: 2020 2020 2020 2073 702e 7061 7261 6d73         sp.params
-00012e20: 5b27 6164 645f 6e65 625f 656d 6973 7369  ['add_neb_emissi
-00012e30: 6f6e 275d 203d 206e 6562 0a20 2020 2020  on'] = neb.     
-00012e40: 2020 2020 2020 2073 702e 7061 7261 6d73         sp.params
-00012e50: 5b27 6164 645f 6e65 625f 636f 6e74 696e  ['add_neb_contin
-00012e60: 7575 6d27 5d20 3d20 6e65 620a 2020 2020  uum'] = neb.    
-00012e70: 2020 2020 2020 2020 7761 7665 2c20 7370          wave, sp
-00012e80: 6563 5b6e 6562 5d20 3d20 7370 2e67 6574  ec[neb] = sp.get
-00012e90: 5f73 7065 6374 7275 6d28 7461 6765 3d70  _spectrum(tage=p
-00012ea0: 7365 745b 2774 6167 6527 5d2c 2070 6572  set['tage'], per
-00012eb0: 6161 3d54 7275 6529 0a20 2020 2020 2020  aa=True).       
-00012ec0: 2020 2020 2023 706c 742e 706c 6f74 2877       #plt.plot(w
-00012ed0: 6176 652c 2073 7065 635b 6e65 625d 2c20  ave, spec[neb], 
-00012ee0: 616c 7068 613d 302e 3529 0a0a 2020 2020  alpha=0.5)..    
-00012ef0: 2020 2020 6e65 625f 6f6e 6c79 203d 2073      neb_only = s
-00012f00: 7065 635b 5472 7565 5d20 2d20 7370 6563  pec[True] - spec
-00012f10: 5b46 616c 7365 5d0a 2020 2020 2020 2020  [False].        
-00012f20: 6e65 625f 6f6e 6c79 203d 206e 6562 5f6f  neb_only = neb_o
-00012f30: 6e6c 7920 2f20 6e65 625f 6f6e 6c79 2e6d  nly / neb_only.m
-00012f40: 6178 2829 0a20 2020 2020 2020 206e 6562  ax().        neb
-00012f50: 5f6f 6e6c 7920 3d20 7370 6563 5b54 7275  _only = spec[Tru
-00012f60: 655d 202f 2073 7065 635b 5472 7565 5d2e  e] / spec[True].
-00012f70: 6d61 7828 290a 0a20 2020 2020 2020 2070  max()..        p
-00012f80: 6c74 2e70 6c6f 7428 7761 7665 2c20 6e65  lt.plot(wave, ne
-00012f90: 625f 6f6e 6c79 2c20 6c61 6265 6c3d 742c  b_only, label=t,
-00012fa0: 2061 6c70 6861 3d30 2e35 290a 0a20 2020   alpha=0.5)..   
-00012fb0: 2020 2020 206e 6562 5f6f 6e6c 795b 6e65       neb_only[ne
-00012fc0: 625f 6f6e 6c79 203c 2031 2e65 2d34 5d20  b_only < 1.e-4] 
-00012fd0: 3d20 300a 0a20 2020 2020 2020 206e 702e  = 0..        np.
-00012fe0: 7361 7665 7478 7428 2766 7370 735f 7b30  savetxt('fsps_{0
-00012ff0: 7d5f 6c69 6e65 732e 7478 7427 2e66 6f72  }_lines.txt'.for
-00013000: 6d61 7428 7429 2c20 6e70 2e61 7272 6179  mat(t), np.array
-00013010: 285b 7761 7665 2c20 6e65 625f 6f6e 6c79  ([wave, neb_only
-00013020: 5d29 2e54 2c20 666d 743d 2725 2e35 6527  ]).T, fmt='%.5e'
-00013030: 2c20 6865 6164 6572 3d68 6561 6465 7229  , header=header)
-00013040: 0a0a 2020 2020 2020 2020 6c69 6e65 5f74  ..        line_t
-00013050: 656d 706c 6174 6573 5b74 5d20 3d20 7574  emplates[t] = ut
-00013060: 696c 732e 5370 6563 7472 756d 5465 6d70  ils.SpectrumTemp
-00013070: 6c61 7465 2877 6176 653d 7761 7665 2c20  late(wave=wave, 
-00013080: 666c 7578 3d6e 6562 5f6f 6e6c 792c 206e  flux=neb_only, n
-00013090: 616d 653d 2766 7370 735f 7b30 7d5f 6c69  ame='fsps_{0}_li
-000130a0: 6e65 7327 2e66 6f72 6d61 7428 7429 290a  nes'.format(t)).
-000130b0: 0a0a 6465 6620 7061 6833 3328 7761 7665  ..def pah33(wave
-000130c0: 5f67 7269 6429 3a0a 2020 2020 2222 220a  _grid):.    """.
-000130d0: 2020 2020 5365 7420 6f66 2033 2e33 2075      Set of 3.3 u
-000130e0: 6d20 5041 4820 6c69 6e65 7320 6672 6f6d  m PAH lines from
-000130f0: 204c 6920 6574 2061 6c2e 2032 3032 300a   Li et al. 2020.
-00013100: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
-00013110: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00013120: 2070 6168 5f74 656d 706c 6174 6573 203a   pah_templates :
-00013130: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
-00013140: 7374 206f 6620 607e 6772 697a 6c69 2e75  st of `~grizli.u
-00013150: 7469 6c73 2e53 7065 6374 7275 6d54 656d  tils.SpectrumTem
-00013160: 706c 6174 6560 2074 656d 706c 6174 6573  plate` templates
-00013170: 2066 6f72 2074 6872 6565 2063 6f6d 706f   for three compo
-00013180: 6e65 6e74 730a 2020 2020 2020 2020 6172  nents.        ar
-00013190: 6f75 6e64 2033 2e33 2075 6d0a 2020 2020  ound 3.3 um.    
-000131a0: 0a20 2020 2022 2222 0a20 2020 2070 6168  .    """.    pah
-000131b0: 5f74 656d 706c 6174 6573 203d 207b 7d0a  _templates = {}.
-000131c0: 2020 2020 666f 7220 6c63 2c20 6c77 2069      for lc, lw i
-000131d0: 6e20 7a69 7028 5b33 2e32 392c 2033 2e34  n zip([3.29, 3.4
-000131e0: 302c 2033 2e34 375d 2c20 5b30 2e30 3433  0, 3.47], [0.043
-000131f0: 2c20 302e 3033 312c 2030 2e31 3030 5d29  , 0.031, 0.100])
-00013200: 3a0a 2020 2020 2020 2020 7469 203d 2070  :.        ti = p
-00013210: 6168 5f6c 696e 655f 7465 6d70 6c61 7465  ah_line_template
-00013220: 2877 6176 655f 6772 6964 2c20 6365 6e74  (wave_grid, cent
-00013230: 6572 5f75 6d3d 6c63 2c20 6677 686d 3d6c  er_um=lc, fwhm=l
-00013240: 7729 0a20 2020 2020 2020 2070 6168 5f74  w).        pah_t
-00013250: 656d 706c 6174 6573 5b74 692e 6e61 6d65  emplates[ti.name
-00013260: 5d20 3d20 7469 0a20 2020 200a 2020 2020  ] = ti.    .    
-00013270: 7265 7475 726e 2070 6168 5f74 656d 706c  return pah_templ
-00013280: 6174 6573 0a0a 0a64 6566 2070 6168 5f6c  ates...def pah_l
-00013290: 696e 655f 7465 6d70 6c61 7465 2877 6176  ine_template(wav
-000132a0: 655f 6772 6964 2c20 6365 6e74 6572 5f75  e_grid, center_u
-000132b0: 6d3d 332e 3239 2c20 6677 686d 3d30 2e30  m=3.29, fwhm=0.0
-000132c0: 3433 293a 0a20 2020 2022 2222 0a20 2020  43):.    """.   
-000132d0: 204d 616b 6520 6120 7465 6d70 6c61 7465   Make a template
-000132e0: 2066 6f72 2061 2062 726f 6164 2050 4148   for a broad PAH
-000132f0: 206c 696e 6520 7769 7468 2061 2044 7275   line with a Dru
-00013300: 6465 2070 726f 6669 6c65 0a20 2020 200a  de profile.    .
-00013310: 2020 2020 4465 6661 756c 7420 7061 7261      Default para
-00013320: 6d65 7465 7273 2069 6e20 4c61 6920 6574  meters in Lai et
-00013330: 2061 6c2e 2032 3032 300a 2020 2020 6874   al. 2020.    ht
-00013340: 7470 733a 2f2f 696f 7073 6369 656e 6365  tps://iopscience
-00013350: 2e69 6f70 2e6f 7267 2f61 7274 6963 6c65  .iop.org/article
-00013360: 2f31 302e 3338 3437 2f31 3533 382d 3433  /10.3847/1538-43
-00013370: 3537 2f61 6263 3030 322f 7064 660a 2020  57/abc002/pdf.  
-00013380: 2020 6672 6f6d 2054 6f6b 756e 6167 6120    from Tokunaga 
-00013390: 6574 2061 6c2e 2031 3939 310a 2020 2020  et al. 1991.    
-000133a0: 0a20 2020 2044 7275 6465 2065 7175 6174  .    Drude equat
-000133b0: 696f 6e20 616e 6420 6e6f 726d 616c 697a  ion and normaliz
-000133c0: 6174 696f 6e20 6672 6f6d 2059 616d 6164  ation from Yamad
-000133d0: 6120 6574 2061 6c2e 2032 3031 330a 2020  a et al. 2013.  
-000133e0: 2020 0a20 2020 2050 6172 616d 6574 6572    .    Parameter
-000133f0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00013400: 0a20 2020 2077 6176 655f 6772 6964 203a  .    wave_grid :
-00013410: 2061 7272 6179 2d6c 696b 650a 2020 2020   array-like.    
-00013420: 2020 2020 5761 7665 6c65 6e67 7468 2067      Wavelength g
-00013430: 7269 6420 696e 2061 6e67 7374 726f 6d73  rid in angstroms
-00013440: 0a20 2020 200a 2020 2020 6365 6e74 6572  .    .    center
-00013450: 5f75 6d20 3a20 666c 6f61 740a 2020 2020  _um : float.    
-00013460: 2020 2020 4365 6e74 7261 6c20 7761 7665      Central wave
-00013470: 6c65 6e67 7468 2069 6e20 6d69 6372 6f6e  length in micron
-00013480: 730a 2020 2020 0a20 2020 2066 7768 6d20  s.    .    fwhm 
-00013490: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-000134a0: 4472 7564 6520 7072 6f66 696c 6520 4657  Drude profile FW
-000134b0: 484d 2069 6e20 6d69 6372 6f6e 730a 2020  HM in microns.  
-000134c0: 2020 0a20 2020 2052 6574 7572 6e73 0a20    .    Returns. 
-000134d0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2070     -------.    p
-000134e0: 6168 5f74 656d 706c 203a 2060 7e67 7269  ah_templ : `~gri
-000134f0: 7a6c 692e 7574 696c 732e 5370 6563 7472  zli.utils.Spectr
-00013500: 756d 5465 6d70 6c61 7465 600a 2020 2020  umTemplate`.    
-00013510: 2020 2020 5465 6d70 6c61 7465 2077 6974      Template wit
-00013520: 6820 7468 6520 5041 4820 6665 6174 7572  h the PAH featur
-00013530: 650a 2020 2020 0a20 2020 2022 2222 0a20  e.    .    """. 
-00013540: 2020 2062 7220 3d20 312e 0a20 2020 2067     br = 1..    g
-00013550: 616d 6d61 5f77 6964 7468 203d 2066 7768  amma_width = fwh
-00013560: 6d2f 6365 6e74 6572 5f75 6d0a 2020 2020  m/center_um.    
-00013570: 4976 203d 2062 722a 6761 6d6d 615f 7769  Iv = br*gamma_wi
-00013580: 6474 682a 2a32 0a20 2020 2049 7620 2f3d  dth**2.    Iv /=
-00013590: 2028 2877 6176 655f 6772 6964 2f31 2e65   ((wave_grid/1.e
-000135a0: 342f 6365 6e74 6572 5f75 6d20 2d20 6365  4/center_um - ce
-000135b0: 6e74 6572 5f75 6d2a 312e 6534 2f77 6176  nter_um*1.e4/wav
-000135c0: 655f 6772 6964 292a 2a32 0a20 2020 2020  e_grid)**2.     
-000135d0: 2020 2020 2020 2b20 6761 6d6d 615f 7769        + gamma_wi
-000135e0: 6474 682a 2a32 290a 0a20 2020 2049 6e6f  dth**2)..    Ino
-000135f0: 726d 203d 206e 702e 7069 2a32 2e39 3965  rm = np.pi*2.99e
-00013600: 3134 2f32 2e2a 6272 2a67 616d 6d61 5f77  14/2.*br*gamma_w
-00013610: 6964 7468 2f63 656e 7465 725f 756d 0a20  idth/center_um. 
-00013620: 2020 2049 7620 2a3d 2031 202f 2049 6e6f     Iv *= 1 / Ino
-00013630: 726d 0a20 2020 200a 2020 2020 2320 466c  rm.    .    # Fl
-00013640: 616d 6264 610a 2020 2020 496c 616d 203d  ambda.    Ilam =
-00013650: 2049 7620 2a20 322e 3939 6531 3820 2f20   Iv * 2.99e18 / 
-00013660: 2877 6176 655f 6772 6964 292a 2a32 0a20  (wave_grid)**2. 
-00013670: 2020 200a 2020 2020 7061 685f 7465 6d70     .    pah_temp
-00013680: 6c20 3d20 5370 6563 7472 756d 5465 6d70  l = SpectrumTemp
-00013690: 6c61 7465 2877 6176 653d 7761 7665 5f67  late(wave=wave_g
-000136a0: 7269 642c 0a20 2020 2020 2020 2020 2020  rid,.           
-000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136c0: 2020 2020 2020 666c 7578 3d49 6c61 6d2c        flux=Ilam,
-000136d0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-000136e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136f0: 2020 206e 616d 653d 6627 6c69 6e65 2050     name=f'line P
-00013700: 4148 2d7b 6365 6e74 6572 5f75 6d3a 2e32  AH-{center_um:.2
-00013710: 667d 2729 0a20 2020 2072 6574 7572 6e20  f}').    return 
-00013720: 7061 685f 7465 6d70 6c0a 0a0a 636c 6173  pah_templ...clas
-00013730: 7320 5370 6563 7472 756d 5465 6d70 6c61  s SpectrumTempla
-00013740: 7465 286f 626a 6563 7429 3a0a 2020 2020  te(object):.    
-00013750: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00013760: 662c 2077 6176 653d 4e6f 6e65 2c20 666c  f, wave=None, fl
-00013770: 7578 3d4e 6f6e 652c 2063 656e 7472 616c  ux=None, central
-00013780: 5f77 6176 653d 4e6f 6e65 2c20 6677 686d  _wave=None, fwhm
-00013790: 3d4e 6f6e 652c 2076 656c 6f63 6974 793d  =None, velocity=
-000137a0: 4661 6c73 652c 2066 6c75 7875 6e69 7473  False, fluxunits
-000137b0: 3d46 4c41 4d42 4441 5f43 4753 2c20 7761  =FLAMBDA_CGS, wa
-000137c0: 7665 756e 6974 733d 752e 616e 6773 7472  veunits=u.angstr
-000137d0: 6f6d 2c20 6e61 6d65 3d27 7465 6d70 6c61  om, name='templa
-000137e0: 7465 272c 206c 6f72 656e 747a 3d46 616c  te', lorentz=Fal
-000137f0: 7365 2c20 6572 723d 4e6f 6e65 293a 0a20  se, err=None):. 
-00013800: 2020 2020 2020 2022 2222 436f 6e74 6169         """Contai
-00013810: 6e65 7220 666f 7220 7465 6d70 6c61 7465  ner for template
-00013820: 2073 7065 6374 7261 2e0a 0a20 2020 2020   spectra...     
-00013830: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00013840: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-00013850: 0a20 2020 2020 2020 2077 6176 6520 3a20  .        wave : 
-00013860: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
-00013870: 2020 2020 2020 2057 6176 656c 656e 6774         Wavelengt
-00013880: 680a 2020 2020 2020 2020 2020 2020 496e  h.            In
-00013890: 2060 6173 7472 6f70 792e 756e 6974 732e   `astropy.units.
-000138a0: 416e 6773 7472 6f6d 602e 0a0a 2020 2020  Angstrom`...    
-000138b0: 2020 2020 666c 7578 203a 2066 6c6f 6174      flux : float
-000138c0: 2061 7272 6179 2d6c 696b 650a 2020 2020   array-like.    
-000138d0: 2020 2020 2020 2020 4966 2066 6c6f 6174          If float
-000138e0: 2c20 7468 656e 2074 6865 2069 6e74 6567  , then the integ
-000138f0: 7261 7465 6420 666c 7578 206f 6620 6120  rated flux of a 
-00013900: 4761 7573 7369 616e 206c 696e 652e 2020  Gaussian line.  
-00013910: 4966 0a20 2020 2020 2020 2020 2020 2061  If.            a
-00013920: 7272 6179 2c20 7468 656e 2066 2d6c 616d  rray, then f-lam
-00013930: 6264 6120 666c 7578 2064 656e 7369 7479  bda flux density
-00013940: 2e0a 0a20 2020 2020 2020 2063 656e 7472  ...        centr
-00013950: 616c 5f77 6176 652c 2066 7768 6d20 3a20  al_wave, fwhm : 
-00013960: 666c 6f61 740a 2020 2020 2020 2020 2020  float.          
-00013970: 2020 496e 6974 6961 6c69 7a65 2074 6865    Initialize the
-00013980: 2074 656d 706c 6174 6520 7769 7468 2061   template with a
-00013990: 2047 6175 7373 6961 6e20 6174 2074 6869   Gaussian at thi
-000139a0: 7320 7761 7665 6c65 6e67 7468 2028 696e  s wavelength (in
-000139b0: 0a20 2020 2020 2020 2020 2020 2060 6173  .            `as
-000139c0: 7472 6f70 792e 756e 6974 732e 416e 6773  tropy.units.Angs
-000139d0: 7472 6f6d 602e 2920 7468 6174 2068 6173  trom`.) that has
-000139e0: 2061 6e20 696e 7465 6772 6174 6564 2066   an integrated f
-000139f0: 6c75 7820 6f66 2060 666c 7578 600a 2020  lux of `flux`.  
-00013a00: 2020 2020 2020 2020 2020 616e 6420 6066            and `f
-00013a10: 7768 6d60 2069 6e20 6061 7374 726f 7079  whm` in `astropy
-00013a20: 2e75 6e69 7473 2e41 6e67 7374 726f 6d60  .units.Angstrom`
-00013a30: 206f 7220 606b 6d2f 7360 2066 6f72 0a20   or `km/s` for. 
-00013a40: 2020 2020 2020 2020 2020 2060 7665 6c6f             `velo
-00013a50: 6369 7479 3d54 7275 6560 2e0a 0a20 2020  city=True`...   
-00013a60: 2020 2020 2076 656c 6f63 6974 7920 3a20       velocity : 
-00013a70: 626f 6f6c 0a20 2020 2020 2020 2020 2020  bool.           
-00013a80: 2060 6677 686d 6020 6973 2061 2076 656c   `fwhm` is a vel
-00013a90: 6f63 6974 7920 696e 2060 6b6d 2f73 602e  ocity in `km/s`.
-00013aa0: 0a0a 2020 2020 2020 2020 4174 7472 6962  ..        Attrib
-00013ab0: 7574 6573 0a20 2020 2020 2020 202d 2d2d  utes.        ---
-00013ac0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00013ad0: 7761 7665 2c20 666c 7578 203a 2061 7272  wave, flux : arr
-00013ae0: 6179 2d6c 696b 650a 2020 2020 2020 2020  ay-like.        
-00013af0: 2020 2020 5061 7373 6564 2066 726f 6d20      Passed from 
-00013b00: 7468 6520 696e 7075 7420 7061 7261 6d65  the input parame
-00013b10: 7465 7273 206f 7220 6765 6e65 7261 7465  ters or generate
-00013b20: 642f 6d6f 6469 6669 6564 206c 6174 6572  d/modified later
-00013b30: 2e0a 0a20 2020 2020 2020 204d 6574 686f  ...        Metho
-00013b40: 6473 0a20 2020 2020 2020 202d 2d2d 2d2d  ds.        -----
-00013b50: 2d2d 0a20 2020 2020 2020 205f 5f61 6464  --.        __add
-00013b60: 5f5f 2c20 5f5f 6d75 6c5f 5f20 3a20 4164  __, __mul__ : Ad
-00013b70: 6469 7469 6f6e 2061 6e64 206d 756c 7469  dition and multi
-00013b80: 706c 6963 6174 696f 6e20 6f66 2074 656d  plication of tem
-00013b90: 706c 6174 6573 2e0a 0a20 2020 2020 2020  plates...       
-00013ba0: 2045 7861 6d70 6c65 730a 2020 2020 2020   Examples.      
-00013bb0: 2020 2d2d 2d2d 2d2d 2d2d 0a0a 2020 2020    --------..    
-00013bc0: 2020 2020 2020 2020 2e2e 2070 6c6f 743a          .. plot:
-00013bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013be0: 2020 3a69 6e63 6c75 6465 2d73 6f75 7263    :include-sourc
-00013bf0: 653a 0a0a 2020 2020 2020 2020 2020 2020  e:..            
-00013c00: 2020 2020 696d 706f 7274 206d 6174 706c      import matpl
-00013c10: 6f74 6c69 622e 7079 706c 6f74 2061 7320  otlib.pyplot as 
-00013c20: 706c 740a 2020 2020 2020 2020 2020 2020  plt.            
-00013c30: 2020 2020 6672 6f6d 2067 7269 7a6c 692e      from grizli.
-00013c40: 7574 696c 7320 696d 706f 7274 2053 7065  utils import Spe
-00013c50: 6374 7275 6d54 656d 706c 6174 650a 0a20  ctrumTemplate.. 
-00013c60: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00013c70: 6120 3d20 5370 6563 7472 756d 5465 6d70  a = SpectrumTemp
-00013c80: 6c61 7465 2863 656e 7472 616c 5f77 6176  late(central_wav
-00013c90: 653d 3635 3633 2e2c 2066 7768 6d3d 3130  e=6563., fwhm=10
-00013ca0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00013cb0: 2020 706c 742e 706c 6f74 2868 612e 7761    plt.plot(ha.wa
-00013cc0: 7665 2c20 6861 2e66 6c75 7829 0a0a 2020  ve, ha.flux)..  
-00013cd0: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00013ce0: 5f7a 203d 2068 612e 7a73 6361 6c65 2830  _z = ha.zscale(0
-00013cf0: 2e31 290a 2020 2020 2020 2020 2020 2020  .1).            
-00013d00: 2020 2020 706c 742e 706c 6f74 2868 615f      plt.plot(ha_
-00013d10: 7a2e 7761 7665 2c20 6861 5f7a 2e66 6c75  z.wave, ha_z.flu
-00013d20: 782c 206c 6162 656c 3d27 7a3d 302e 3127  x, label='z=0.1'
-00013d30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00013d40: 2020 2070 6c74 2e6c 6567 656e 6428 290a     plt.legend().
-00013d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d60: 706c 742e 786c 6162 656c 2872 2724 5c6c  plt.xlabel(r'$\l
-00013d70: 616d 6264 6124 2729 0a20 2020 2020 2020  ambda$').       
-00013d80: 2020 2020 2020 2020 2070 6c74 2e78 6c69           plt.xli
-00013d90: 6d28 3630 3030 2c20 3735 3030 290a 2020  m(6000, 7500).  
-00013da0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00013db0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00013dc0: 6c74 2e73 686f 7728 290a 0a20 2020 2020  lt.show()..     
-00013dd0: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-00013de0: 656c 662e 7761 7665 203d 2077 6176 650a  elf.wave = wave.
-00013df0: 2020 2020 2020 2020 6966 2077 6176 6520          if wave 
-00013e00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00013e10: 2020 2020 2020 2020 2073 656c 662e 7761           self.wa
-00013e20: 7665 203d 206e 702e 6361 7374 5b6e 702e  ve = np.cast[np.
-00013e30: 666c 6f61 7436 345d 2877 6176 6529 0a0a  float64](wave)..
-00013e40: 2020 2020 2020 2020 7365 6c66 2e66 6c75          self.flu
-00013e50: 7820 3d20 666c 7578 0a20 2020 2020 2020  x = flux.       
-00013e60: 2069 6620 666c 7578 2069 7320 6e6f 7420   if flux is not 
-00013e70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00013e80: 2020 7365 6c66 2e66 6c75 7820 3d20 6e70    self.flux = np
-00013e90: 2e63 6173 745b 6e70 2e66 6c6f 6174 3634  .cast[np.float64
-00013ea0: 5d28 666c 7578 290a 0a20 2020 2020 2020  ](flux)..       
-00013eb0: 2069 6620 6572 7220 6973 206e 6f74 204e   if err is not N
-00013ec0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00013ed0: 2073 656c 662e 6572 7220 3d20 6e70 2e63   self.err = np.c
-00013ee0: 6173 745b 6e70 2e66 6c6f 6174 3634 5d28  ast[np.float64](
-00013ef0: 6572 7229 0a20 2020 2020 2020 2065 6c73  err).        els
-00013f00: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00013f10: 656c 662e 6572 7220 3d20 4e6f 6e65 0a0a  elf.err = None..
-00013f20: 2020 2020 2020 2020 7365 6c66 2e66 7768          self.fwh
-00013f30: 6d20 3d20 4e6f 6e65 0a20 2020 2020 2020  m = None.       
-00013f40: 2073 656c 662e 7665 6c6f 6369 7479 203d   self.velocity =
-00013f50: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
-00013f60: 656c 662e 666c 7578 756e 6974 7320 3d20  elf.fluxunits = 
-00013f70: 666c 7578 756e 6974 730a 2020 2020 2020  fluxunits.      
-00013f80: 2020 7365 6c66 2e77 6176 6575 6e69 7473    self.waveunits
-00013f90: 203d 2077 6176 6575 6e69 7473 0a20 2020   = waveunits.   
-00013fa0: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
-00013fb0: 206e 616d 650a 0a20 2020 2020 2020 2069   name..        i
-00013fc0: 6620 2863 656e 7472 616c 5f77 6176 6520  f (central_wave 
-00013fd0: 6973 206e 6f74 204e 6f6e 6529 2026 2028  is not None) & (
-00013fe0: 6677 686d 2069 7320 6e6f 7420 4e6f 6e65  fwhm is not None
-00013ff0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00014000: 656c 662e 6677 686d 203d 2066 7768 6d0a  elf.fwhm = fwhm.
-00014010: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00014020: 2e76 656c 6f63 6974 7920 3d20 7665 6c6f  .velocity = velo
-00014030: 6369 7479 0a0a 2020 2020 2020 2020 2020  city..          
-00014040: 2020 7365 6c66 2e77 6176 652c 2073 656c    self.wave, sel
-00014050: 662e 666c 7578 203d 2073 656c 662e 6d61  f.flux = self.ma
-00014060: 6b65 5f67 6175 7373 6961 6e28 6365 6e74  ke_gaussian(cent
-00014070: 7261 6c5f 7761 7665 2c20 6677 686d 2c0a  ral_wave, fwhm,.
-00014080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140b0: 2020 2020 2020 7761 7665 5f67 7269 643d        wave_grid=
-000140c0: 7761 7665 2c0a 2020 2020 2020 2020 2020  wave,.          
-000140d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140f0: 2020 2020 2020 2020 2020 2020 7665 6c6f              velo
-00014100: 6369 7479 3d76 656c 6f63 6974 792c 0a20  city=velocity,. 
-00014110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014140: 2020 2020 206d 6178 5f73 6967 6d61 3d35       max_sigma=5
-00014150: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00014160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014180: 2020 2020 2020 2020 206c 6f72 656e 747a           lorentz
-00014190: 3d6c 6f72 656e 747a 290a 0a20 2020 2020  =lorentz)..     
-000141a0: 2020 2073 656c 662e 666e 755f 756e 6974     self.fnu_unit
-000141b0: 7320 3d20 464e 555f 4347 530a 2020 2020  s = FNU_CGS.    
-000141c0: 2020 2020 7365 6c66 2e74 6f5f 666e 7528      self.to_fnu(
-000141d0: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
-000141e0: 7468 6f64 0a20 2020 2064 6566 206d 616b  thod.    def mak
-000141f0: 655f 6761 7573 7369 616e 2863 656e 7472  e_gaussian(centr
-00014200: 616c 5f77 6176 652c 2066 7768 6d2c 206d  al_wave, fwhm, m
-00014210: 6178 5f73 6967 6d61 3d35 2c20 7374 6570  ax_sigma=5, step
-00014220: 3d30 2e31 2c0a 2020 2020 2020 2020 2020  =0.1,.          
-00014230: 2020 2020 2020 2020 2020 2020 7761 7665              wave
-00014240: 5f67 7269 643d 4e6f 6e65 2c20 7665 6c6f  _grid=None, velo
-00014250: 6369 7479 3d46 616c 7365 2c20 636c 6970  city=False, clip
-00014260: 3d31 2e65 2d36 2c0a 2020 2020 2020 2020  =1.e-6,.        
-00014270: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00014280: 7265 6e74 7a3d 4661 6c73 6529 3a0a 2020  rentz=False):.  
-00014290: 2020 2020 2020 2222 224d 616b 6520 4761        """Make Ga
-000142a0: 7573 7369 616e 2074 656d 706c 6174 650a  ussian template.
-000142b0: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-000142c0: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-000142d0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2063  ------.        c
-000142e0: 656e 7472 616c 5f77 6176 652c 2066 7768  entral_wave, fwh
-000142f0: 6d20 3a20 4e6f 6e65 206f 7220 666c 6f61  m : None or floa
-00014300: 7420 6f72 2061 7272 6179 2d6c 696b 650a  t or array-like.
-00014310: 2020 2020 2020 2020 2020 2020 4365 6e74              Cent
-00014320: 7261 6c20 7761 7665 6c65 6e67 7468 2061  ral wavelength a
-00014330: 6e64 2046 5748 4d20 6f66 2074 6865 2064  nd FWHM of the d
-00014340: 6573 6972 6564 2047 6175 7373 6961 6e0a  esired Gaussian.
-00014350: 0a20 2020 2020 2020 2076 656c 6f63 6974  .        velocit
-00014360: 7920 3a20 626f 6f6c 0a20 2020 2020 2020  y : bool.       
-00014370: 2020 2020 2060 6677 686d 6020 6973 2061       `fwhm` is a
-00014380: 2076 656c 6f63 6974 792e 0a0a 2020 2020   velocity...    
-00014390: 2020 2020 6d61 785f 7369 676d 612c 2073      max_sigma, s
-000143a0: 7465 7020 3a20 666c 6f61 740a 2020 2020  tep : float.    
-000143b0: 2020 2020 2020 2020 4765 6e65 7261 7465          Generate
-000143c0: 6420 7761 7665 6c65 6e67 7468 2061 7272  d wavelength arr
-000143d0: 6179 2069 730a 0a20 2020 2020 2020 2020  ay is..         
-000143e0: 2020 2020 2020 203e 3e3e 2072 6d73 203d         >>> rms =
-000143f0: 2066 7768 6d2f 322e 3335 0a20 2020 2020   fwhm/2.35.     
-00014400: 2020 2020 2020 2020 2020 203e 3e3e 2078             >>> x
-00014410: 6761 7573 7320 3d20 6e70 2e61 7261 6e67  gauss = np.arang
-00014420: 6528 2d6d 6178 5f73 6967 6d61 2c20 6d61  e(-max_sigma, ma
-00014430: 785f 7369 676d 612c 2073 7465 7029 2a72  x_sigma, step)*r
-00014440: 6d73 2b63 656e 7472 616c 5f77 6176 650a  ms+central_wave.
-00014450: 0a20 2020 2020 2020 2063 6c69 7020 3a20  .        clip : 
-00014460: 666c 6f61 740a 2020 2020 2020 2020 2020  float.          
-00014470: 2020 436c 6970 2076 616c 7565 7320 7768    Clip values wh
-00014480: 6572 6520 7468 6520 7661 6c75 6520 6f66  ere the value of
-00014490: 2074 6865 2067 6175 7373 6961 6e20 6675   the gaussian fu
-000144a0: 6e63 7469 6f6e 2069 7320 6c65 7373 2074  nction is less t
-000144b0: 6861 6e0a 2020 2020 2020 2020 2020 2020  han.            
-000144c0: 6063 6c69 7060 2074 696d 6573 2069 7473  `clip` times its
-000144d0: 206d 6178 696d 756d 2028 692e 652e 2c20   maximum (i.e., 
-000144e0: 6031 2f73 7172 7428 322a 7069 2a73 6967  `1/sqrt(2*pi*sig
-000144f0: 6d61 2a2a 3229 6029 2e0a 0a20 2020 2020  ma**2)`)...     
-00014500: 2020 206c 6f72 656e 747a 203a 2062 6f6f     lorentz : boo
-00014510: 6c0a 2020 2020 2020 2020 2020 2020 4d61  l.            Ma
-00014520: 6b65 2061 204c 6f72 656e 747a 6961 6e20  ke a Lorentzian 
-00014530: 6c69 6e65 2069 6e73 7465 6164 206f 6620  line instead of 
-00014540: 6120 4761 7573 7369 616e 2e0a 0a20 2020  a Gaussian...   
-00014550: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
-00014560: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
-00014570: 2020 2020 2077 6176 652c 2066 6c75 7820       wave, flux 
-00014580: 3a20 6172 7261 792d 6c69 6b65 0a20 2020  : array-like.   
-00014590: 2020 2020 2020 2020 2057 6176 656c 656e           Wavelen
-000145a0: 6774 6820 616e 6420 666c 7578 206f 6620  gth and flux of 
-000145b0: 6120 4761 7573 7369 616e 206c 696e 650a  a Gaussian line.
-000145c0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000145d0: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
-000145e0: 7079 2e63 6f6e 7374 616e 7473 2061 7320  py.constants as 
-000145f0: 636f 6e73 740a 2020 2020 2020 2020 6672  const.        fr
-00014600: 6f6d 2061 7374 726f 7079 2e6d 6f64 656c  om astropy.model
-00014610: 696e 672e 6d6f 6465 6c73 2069 6d70 6f72  ing.models impor
-00014620: 7420 4c6f 7265 6e74 7a31 440a 0a20 2020  t Lorentz1D..   
-00014630: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
-00014640: 6677 686d 2c20 2775 6e69 7427 293a 0a20  fwhm, 'unit'):. 
-00014650: 2020 2020 2020 2020 2020 2072 6d73 203d             rms =
-00014660: 2066 7768 6d2e 7661 6c75 652f 322e 3335   fwhm.value/2.35
-00014670: 0a20 2020 2020 2020 2020 2020 2076 656c  .            vel
-00014680: 6f63 6974 7920 3d20 752e 7068 7973 6963  ocity = u.physic
-00014690: 616c 2e67 6574 5f70 6879 7369 6361 6c5f  al.get_physical_
-000146a0: 7479 7065 2866 7768 6d2e 756e 6974 2920  type(fwhm.unit) 
-000146b0: 3d3d 2027 7370 6565 6427 0a20 2020 2020  == 'speed'.     
-000146c0: 2020 2020 2020 2069 6620 7665 6c6f 6369         if veloci
-000146d0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-000146e0: 2020 2020 726d 7320 3d20 6365 6e74 7261      rms = centra
-000146f0: 6c5f 7761 7665 2a28 6677 686d 2f63 6f6e  l_wave*(fwhm/con
-00014700: 7374 2e63 2e74 6f28 4b4d 5329 292e 7661  st.c.to(KMS)).va
-00014710: 6c75 652f 322e 3335 0a20 2020 2020 2020  lue/2.35.       
-00014720: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014730: 2020 2020 2020 2020 2020 2072 6d73 203d             rms =
-00014740: 2066 7768 6d2e 7661 6c75 652f 322e 3335   fwhm.value/2.35
-00014750: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00014760: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-00014770: 6c6f 6369 7479 3a0a 2020 2020 2020 2020  locity:.        
-00014780: 2020 2020 2020 2020 726d 7320 3d20 6365          rms = ce
-00014790: 6e74 7261 6c5f 7761 7665 2a28 6677 686d  ntral_wave*(fwhm
-000147a0: 2f63 6f6e 7374 2e63 2e74 6f28 4b4d 5329  /const.c.to(KMS)
-000147b0: 2e76 616c 7565 292f 322e 3335 0a20 2020  .value)/2.35.   
-000147c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000147d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000147e0: 6d73 203d 2066 7768 6d2f 322e 3335 0a0a  ms = fwhm/2.35..
-000147f0: 2020 2020 2020 2020 6966 2077 6176 655f          if wave_
-00014800: 6772 6964 2069 7320 4e6f 6e65 3a0a 2020  grid is None:.  
-00014810: 2020 2020 2020 2020 2020 2370 7269 6e74            #print
-00014820: 2827 7878 7820 6c69 6e65 272c 2063 656e  ('xxx line', cen
-00014830: 7472 616c 5f77 6176 652c 206d 6178 5f73  tral_wave, max_s
-00014840: 6967 6d61 2c20 726d 7329 0a0a 2020 2020  igma, rms)..    
-00014850: 2020 2020 2020 2020 7761 7665 5f67 7269          wave_gri
-00014860: 6420 3d20 6e70 2e61 7261 6e67 6528 2d6d  d = np.arange(-m
-00014870: 6178 5f73 6967 6d61 2c20 6d61 785f 7369  ax_sigma, max_si
-00014880: 676d 612c 2073 7465 7029 2a72 6d73 0a20  gma, step)*rms. 
-00014890: 2020 2020 2020 2020 2020 2077 6176 655f             wave_
-000148a0: 6772 6964 202b 3d20 6365 6e74 7261 6c5f  grid += central_
-000148b0: 7761 7665 0a20 2020 2020 2020 2020 2020  wave.           
-000148c0: 2077 6176 655f 6772 6964 203d 206e 702e   wave_grid = np.
-000148d0: 6873 7461 636b 285b 3931 2e2c 2077 6176  hstack([91., wav
-000148e0: 655f 6772 6964 2c20 312e 6538 5d29 0a0a  e_grid, 1.e8])..
-000148f0: 2020 2020 2020 2020 6966 206c 6f72 656e          if loren
-00014900: 747a 3a0a 2020 2020 2020 2020 2020 2020  tz:.            
-00014910: 6966 2076 656c 6f63 6974 793a 0a20 2020  if velocity:.   
-00014920: 2020 2020 2020 2020 2020 2020 2075 7365               use
-00014930: 5f66 7768 6d20 3d20 6365 6e74 7261 6c5f  _fwhm = central_
-00014940: 7761 7665 2a28 6677 686d 2f63 6f6e 7374  wave*(fwhm/const
-00014950: 2e63 2e74 6f28 4b4d 5329 2e76 616c 7565  .c.to(KMS).value
-00014960: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00014970: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00014980: 2020 2020 7573 655f 6677 686d 203d 2066      use_fwhm = f
-00014990: 7768 6d0a 0a20 2020 2020 2020 2020 2020  whm..           
-000149a0: 206c 6d6f 6465 6c20 3d20 4c6f 7265 6e74   lmodel = Lorent
-000149b0: 7a31 4428 616d 706c 6974 7564 653d 312c  z1D(amplitude=1,
-000149c0: 2078 5f30 3d63 656e 7472 616c 5f77 6176   x_0=central_wav
-000149d0: 652c 2066 7768 6d3d 7573 655f 6677 686d  e, fwhm=use_fwhm
-000149e0: 290a 2020 2020 2020 2020 2020 2020 6c69  ).            li
-000149f0: 6e65 203d 206c 6d6f 6465 6c28 7761 7665  ne = lmodel(wave
-00014a00: 5f67 7269 6429 0a20 2020 2020 2020 2020  _grid).         
-00014a10: 2020 206c 696e 655b 303a 325d 203d 2030     line[0:2] = 0
-00014a20: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00014a30: 655b 2d32 3a5d 203d 2030 0a20 2020 2020  e[-2:] = 0.     
-00014a40: 2020 2020 2020 206c 696e 6520 2f3d 206e         line /= n
-00014a50: 702e 7472 6170 7a28 6c69 6e65 2c20 7761  p.trapz(line, wa
-00014a60: 7665 5f67 7269 6429 0a20 2020 2020 2020  ve_grid).       
-00014a70: 2020 2020 2070 6561 6b20 3d20 6c69 6e65       peak = line
-00014a80: 2e6d 6178 2829 0a20 2020 2020 2020 2065  .max().        e
-00014a90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00014aa0: 2023 2047 6175 7373 6961 6e0a 2020 2020   # Gaussian.    
-00014ab0: 2020 2020 2020 2020 6c69 6e65 203d 206e          line = n
-00014ac0: 702e 6578 7028 2d28 7761 7665 5f67 7269  p.exp(-(wave_gri
-00014ad0: 642d 6365 6e74 7261 6c5f 7761 7665 292a  d-central_wave)*
-00014ae0: 2a32 2f32 2f72 6d73 2a2a 3229 0a20 2020  *2/2/rms**2).   
-00014af0: 2020 2020 2020 2020 2070 6561 6b20 3d20           peak = 
-00014b00: 6e70 2e73 7172 7428 322a 6e70 2e70 692a  np.sqrt(2*np.pi*
-00014b10: 726d 732a 2a32 290a 2020 2020 2020 2020  rms**2).        
-00014b20: 2020 2020 6c69 6e65 202a 3d20 312e 2f70      line *= 1./p
-00014b30: 6561 6b20 2023 206e 702e 7371 7274 2832  eak  # np.sqrt(2
-00014b40: 2a6e 702e 7069 2a72 6d73 2a2a 3229 0a0a  *np.pi*rms**2)..
-00014b50: 2020 2020 2020 2020 6c69 6e65 5b6c 696e          line[lin
-00014b60: 6520 3c20 312e 2f70 6561 6b2a 636c 6970  e < 1./peak*clip
-00014b70: 5d20 3d20 300a 0a20 2020 2020 2020 2072  ] = 0..        r
-00014b80: 6574 7572 6e20 7761 7665 5f67 7269 642c  eturn wave_grid,
-00014b90: 206c 696e 650a 0a20 2020 2020 2020 2023   line..        #
-00014ba0: 7365 6c66 2e77 6176 6520 3d20 7867 6175  self.wave = xgau
-00014bb0: 7373 0a20 2020 2020 2020 2023 7365 6c66  ss.        #self
-00014bc0: 2e66 6c75 7820 3d20 6761 7573 7369 616e  .flux = gaussian
-00014bd0: 0a0a 2020 2020 6465 6620 7a73 6361 6c65  ..    def zscale
-00014be0: 2873 656c 662c 207a 2c20 7363 616c 6172  (self, z, scalar
-00014bf0: 3d31 2c20 6170 706c 795f 6967 6d3d 5472  =1, apply_igm=Tr
-00014c00: 7565 293a 0a20 2020 2020 2020 2022 2222  ue):.        """
-00014c10: 5265 6473 6869 6674 2074 6865 2074 656d  Redshift the tem
-00014c20: 706c 6174 6520 616e 6420 6d75 6c74 6970  plate and multip
-00014c30: 6c79 2062 7920 6120 7363 616c 6172 2e0a  ly by a scalar..
-00014c40: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-00014c50: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-00014c60: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 207a  ------.        z
-00014c70: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
-00014c80: 2020 2020 2052 6564 7368 6966 7420 746f       Redshift to
-00014c90: 2075 7365 2e0a 0a20 2020 2020 2020 2073   use...        s
-00014ca0: 6361 6c61 7220 3a20 666c 6f61 740a 2020  calar : float.  
-00014cb0: 2020 2020 2020 2020 2020 4d75 6c74 6970            Multip
-00014cc0: 6c69 6361 7469 7665 2066 6163 746f 722e  licative factor.
-00014cd0: 2020 4164 6469 7469 6f6e 616c 2066 6163    Additional fac
-00014ce0: 746f 7220 6f66 2031 2e2f 2831 2b7a 2920  tor of 1./(1+z) 
-00014cf0: 6973 2069 6d70 6c69 6369 742e 0a0a 2020  is implicit...  
-00014d00: 2020 2020 2020 5265 7475 726e 730a 2020        Returns.  
-00014d10: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
-00014d20: 2020 2020 2020 6e65 775f 7370 6563 7472        new_spectr
-00014d30: 756d 203a 2060 7e67 7269 7a6c 692e 7574  um : `~grizli.ut
-00014d40: 696c 732e 5370 6563 7472 756d 5465 6d70  ils.SpectrumTemp
-00014d50: 6c61 7465 600a 2020 2020 2020 2020 2020  late`.          
-00014d60: 2020 5265 6473 6869 6674 6564 2061 6e64    Redshifted and
-00014d70: 2073 6361 6c65 6420 7370 6563 7472 756d   scaled spectrum
-00014d80: 2e0a 0a20 2020 2020 2020 2022 2222 0a20  ...        """. 
-00014d90: 2020 2020 2020 2069 6620 6170 706c 795f         if apply_
-00014da0: 6967 6d3a 0a20 2020 2020 2020 2020 2020  igm:.           
-00014db0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00014dc0: 2020 2020 2020 696d 706f 7274 2065 617a        import eaz
-00014dd0: 792e 6967 6d0a 2020 2020 2020 2020 2020  y.igm.          
-00014de0: 2020 2020 2020 6967 6d20 3d20 6561 7a79        igm = eazy
-00014df0: 2e69 676d 2e49 6e6f 7565 3134 2829 0a20  .igm.Inoue14(). 
-00014e00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014e10: 676d 7a20 3d20 6967 6d2e 6675 6c6c 5f49  gmz = igm.full_I
-00014e20: 474d 287a 2c20 7365 6c66 2e77 6176 652a  GM(z, self.wave*
-00014e30: 2831 2b7a 2929 0a20 2020 2020 2020 2020  (1+z)).         
-00014e40: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00014e50: 2020 2020 2020 2020 2020 2069 676d 7a20             igmz 
-00014e60: 3d20 312e 0a20 2020 2020 2020 2065 6c73  = 1..        els
-00014e70: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-00014e80: 676d 7a20 3d20 312e 0a0a 2020 2020 2020  gmz = 1...      
-00014e90: 2020 7265 7475 726e 2053 7065 6374 7275    return Spectru
-00014ea0: 6d54 656d 706c 6174 6528 7761 7665 3d73  mTemplate(wave=s
-00014eb0: 656c 662e 7761 7665 2a28 312b 7a29 2c0a  elf.wave*(1+z),.
-00014ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ee0: 666c 7578 3d73 656c 662e 666c 7578 2a73  flux=self.flux*s
-00014ef0: 6361 6c61 722f 2831 2b7a 292a 6967 6d7a  calar/(1+z)*igmz
-00014f00: 290a 0a0a 2020 2020 6465 6620 5f5f 6164  )...    def __ad
-00014f10: 645f 5f28 7365 6c66 2c20 7370 6563 7472  d__(self, spectr
-00014f20: 756d 293a 0a20 2020 2020 2020 2022 2222  um):.        """
-00014f30: 4164 6420 7477 6f20 7465 6d70 6c61 7465  Add two template
-00014f40: 7320 746f 6765 7468 6572 0a0a 2020 2020  s together..    
-00014f50: 2020 2020 5468 6520 6e65 7720 7761 7665      The new wave
-00014f60: 6c65 6e67 7468 2061 7272 6179 2069 7320  length array is 
-00014f70: 7468 6520 756e 696f 6e20 6f66 2062 6f74  the union of bot
-00014f80: 6820 696e 7075 7420 7370 6563 7472 6120  h input spectra 
-00014f90: 616e 6420 6561 6368 0a20 2020 2020 2020  and each.       
-00014fa0: 2069 6e70 7574 2073 7065 6374 7275 6d20   input spectrum 
-00014fb0: 6973 206c 696e 6561 726c 7920 696e 7465  is linearly inte
-00014fc0: 7270 6f6c 6174 6564 2074 6f20 7468 6520  rpolated to the 
-00014fd0: 6669 6e61 6c20 6772 6964 2e0a 0a20 2020  final grid...   
-00014fe0: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
-00014ff0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00015000: 2d2d 0a20 2020 2020 2020 2073 7065 6374  --.        spect
-00015010: 7275 6d20 3a20 607e 6772 697a 6c69 2e75  rum : `~grizli.u
-00015020: 7469 6c73 2e53 7065 6374 7275 6d54 656d  tils.SpectrumTem
-00015030: 706c 6174 6560 0a0a 2020 2020 2020 2020  plate`..        
-00015040: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-00015050: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00015060: 6e65 775f 7370 6563 7472 756d 203a 2060  new_spectrum : `
-00015070: 7e67 7269 7a6c 692e 7574 696c 732e 5370  ~grizli.utils.Sp
-00015080: 6563 7472 756d 5465 6d70 6c61 7465 600a  ectrumTemplate`.
-00015090: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000150a0: 2020 2020 6e65 775f 7761 7665 203d 206e      new_wave = n
-000150b0: 702e 756e 6971 7565 286e 702e 6170 7065  p.unique(np.appe
-000150c0: 6e64 2873 656c 662e 7761 7665 2c20 7370  nd(self.wave, sp
-000150d0: 6563 7472 756d 2e77 6176 6529 290a 2020  ectrum.wave)).  
-000150e0: 2020 2020 2020 6e65 775f 7761 7665 2e73        new_wave.s
-000150f0: 6f72 7428 290a 0a20 2020 2020 2020 206e  ort()..        n
-00015100: 6577 5f66 6c75 7820 3d20 6e70 2e69 6e74  ew_flux = np.int
-00015110: 6572 7028 6e65 775f 7761 7665 2c20 7365  erp(new_wave, se
-00015120: 6c66 2e77 6176 652c 2073 656c 662e 666c  lf.wave, self.fl
-00015130: 7578 290a 2020 2020 2020 2020 6e65 775f  ux).        new_
-00015140: 666c 7578 202b 3d20 6e70 2e69 6e74 6572  flux += np.inter
-00015150: 7028 6e65 775f 7761 7665 2c20 7370 6563  p(new_wave, spec
-00015160: 7472 756d 2e77 6176 652c 2073 7065 6374  trum.wave, spect
-00015170: 7275 6d2e 666c 7578 290a 2020 2020 2020  rum.flux).      
-00015180: 2020 6f75 7420 3d20 5370 6563 7472 756d    out = Spectrum
-00015190: 5465 6d70 6c61 7465 2877 6176 653d 6e65  Template(wave=ne
-000151a0: 775f 7761 7665 2c20 666c 7578 3d6e 6577  w_wave, flux=new
-000151b0: 5f66 6c75 7829 0a20 2020 2020 2020 206f  _flux).        o
-000151c0: 7574 2e66 7768 6d20 3d20 7370 6563 7472  ut.fwhm = spectr
-000151d0: 756d 2e66 7768 6d0a 2020 2020 2020 2020  um.fwhm.        
-000151e0: 7265 7475 726e 206f 7574 0a0a 0a20 2020  return out...   
-000151f0: 2064 6566 205f 5f6d 756c 5f5f 2873 656c   def __mul__(sel
-00015200: 662c 2073 6361 6c61 7229 3a0a 2020 2020  f, scalar):.    
-00015210: 2020 2020 2222 224d 756c 7469 706c 7920      """Multiply 
-00015220: 7370 6563 7472 756d 2062 7920 6120 7363  spectrum by a sc
-00015230: 616c 6172 2076 616c 7565 0a0a 2020 2020  alar value..    
-00015240: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00015250: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-00015260: 2d0a 2020 2020 2020 2020 7363 616c 6172  -.        scalar
-00015270: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
-00015280: 2020 2020 2046 6163 746f 7220 746f 206d       Factor to m
-00015290: 756c 7469 7079 2074 6f20 6073 656c 662e  ultipy to `self.
-000152a0: 666c 7578 602e 0a0a 2020 2020 2020 2020  flux`...        
-000152b0: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-000152c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-000152d0: 6e65 775f 7370 6563 7472 756d 203a 2060  new_spectrum : `
-000152e0: 7e67 7269 7a6c 692e 7574 696c 732e 5370  ~grizli.utils.Sp
-000152f0: 6563 7472 756d 5465 6d70 6c61 7465 600a  ectrumTemplate`.
-00015300: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00015310: 2020 2020 6f75 7420 3d20 5370 6563 7472      out = Spectr
-00015320: 756d 5465 6d70 6c61 7465 2877 6176 653d  umTemplate(wave=
-00015330: 7365 6c66 2e77 6176 652c 2066 6c75 783d  self.wave, flux=
-00015340: 7365 6c66 2e66 6c75 782a 7363 616c 6172  self.flux*scalar
-00015350: 290a 2020 2020 2020 2020 6f75 742e 6677  ).        out.fw
-00015360: 686d 203d 2073 656c 662e 6677 686d 0a20  hm = self.fwhm. 
-00015370: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-00015380: 740a 0a0a 2020 2020 6465 6620 746f 5f66  t...    def to_f
-00015390: 6e75 2873 656c 662c 2066 6e75 5f75 6e69  nu(self, fnu_uni
-000153a0: 7473 3d46 4e55 5f43 4753 293a 0a20 2020  ts=FNU_CGS):.   
-000153b0: 2020 2020 2022 2222 4d61 6b65 2066 6e75       """Make fnu
-000153c0: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
-000153d0: 7465 6d70 6c61 7465 2e0a 0a20 2020 2020  template...     
-000153e0: 2020 2053 6574 7320 7468 6520 6066 6c75     Sets the `flu
-000153f0: 785f 666e 7560 2061 7474 7269 6275 7465  x_fnu` attribute
-00015400: 2c20 6173 7375 6d69 6e67 2074 6861 7420  , assuming that 
-00015410: 7468 6520 7761 7665 6c65 6e67 7468 2069  the wavelength i
-00015420: 7320 6769 7665 6e0a 2020 2020 2020 2020  s given.        
-00015430: 696e 2041 6e67 7374 726f 6d20 616e 6420  in Angstrom and 
-00015440: 7468 6520 666c 7578 2069 7320 6769 7665  the flux is give
-00015450: 6e20 696e 2066 6c61 6d62 6461 3a0a 0a20  n in flambda:.. 
-00015460: 2020 2020 2020 2020 2020 203e 3e3e 2066             >>> f
-00015470: 6c75 785f 666e 7520 3d20 7365 6c66 2e66  lux_fnu = self.f
-00015480: 6c75 7820 2a20 7365 6c66 2e77 6176 652a  lux * self.wave*
-00015490: 2a32 202f 2033 2e65 3138 0a0a 2020 2020  *2 / 3.e18..    
-000154a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000154b0: 2369 6d70 6f72 7420 6173 7472 6f70 792e  #import astropy.
-000154c0: 636f 6e73 7461 6e74 7320 6173 2063 6f6e  constants as con
-000154d0: 7374 0a20 2020 2020 2020 2023 666c 7578  st.        #flux
-000154e0: 5f66 6e75 203d 2073 656c 662e 666c 7578  _fnu = self.flux
-000154f0: 202a 2073 656c 662e 7761 7665 2a2a 3220   * self.wave**2 
-00015500: 2f20 332e 6531 380a 2020 2020 2020 2020  / 3.e18.        
-00015510: 2320 666c 7578 5f66 6e75 203d 2028 7365  # flux_fnu = (se
-00015520: 6c66 2e66 6c75 782a 7365 6c66 2e66 6c75  lf.flux*self.flu
-00015530: 7875 6e69 7473 2a28 7365 6c66 2e77 6176  xunits*(self.wav
-00015540: 652a 7365 6c66 2e77 6176 6575 6e69 7473  e*self.waveunits
-00015550: 292a 2a32 2f63 6f6e 7374 2e63 292e 746f  )**2/const.c).to
-00015560: 2846 4e55 5f43 4753 2920 232c 0a0a 2020  (FNU_CGS) #,..  
-00015570: 2020 2020 2020 6966 2028 2846 4e55 5f43        if ((FNU_C
-00015580: 4753 2e5f 5f73 7472 5f5f 2829 203d 3d20  GS.__str__() == 
-00015590: 2765 7267 202f 2028 636d 3220 487a 2073  'erg / (cm2 Hz s
-000155a0: 2927 2920 260a 2020 2020 2020 2020 2020  )') &.          
-000155b0: 2020 2028 7365 6c66 2e66 6c75 7875 6e69     (self.fluxuni
-000155c0: 7473 2e5f 5f73 7472 5f5f 2829 203d 3d20  ts.__str__() == 
-000155d0: 2765 7267 202f 2028 416e 6773 7472 6f6d  'erg / (Angstrom
-000155e0: 2063 6d32 2073 2927 2929 3a0a 2020 2020   cm2 s)')):.    
-000155f0: 2020 2020 2020 2020 2320 4661 7374 6572          # Faster
-00015600: 0a20 2020 2020 2020 2020 2020 2066 6c75  .            flu
-00015610: 785f 666e 7520 3d20 7365 6c66 2e66 6c75  x_fnu = self.flu
-00015620: 782a 7365 6c66 2e77 6176 652a 2a32 2f32  x*self.wave**2/2
-00015630: 2e39 3937 3932 3435 3865 3138 2a66 6e75  .99792458e18*fnu
-00015640: 5f75 6e69 7473 0a20 2020 2020 2020 2020  _units.         
-00015650: 2020 2069 6620 7365 6c66 2e65 7272 2069     if self.err i
-00015660: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00015670: 2020 2020 2020 2020 2020 2020 6572 725f              err_
-00015680: 666e 7520 3d20 7365 6c66 2e65 7272 2a73  fnu = self.err*s
-00015690: 656c 662e 7761 7665 2a2a 322f 322e 3939  elf.wave**2/2.99
-000156a0: 3739 3234 3538 6531 382a 666e 755f 756e  792458e18*fnu_un
-000156b0: 6974 730a 2020 2020 2020 2020 656c 7365  its.        else
-000156c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000156d0: 5573 6520 6173 7472 6f70 7920 636f 6e76  Use astropy conv
-000156e0: 6572 7369 6f6e 0a20 2020 2020 2020 2020  ersion.         
-000156f0: 2020 2066 6c75 785f 666e 7520 3d20 2873     flux_fnu = (s
-00015700: 656c 662e 666c 7578 2a73 656c 662e 666c  elf.flux*self.fl
-00015710: 7578 756e 6974 7329 2e74 6f28 666e 755f  uxunits).to(fnu_
-00015720: 756e 6974 732c 2065 7175 6976 616c 656e  units, equivalen
-00015730: 6369 6573 3d75 2e73 7065 6374 7261 6c5f  cies=u.spectral_
-00015740: 6465 6e73 6974 7928 7365 6c66 2e77 6176  density(self.wav
-00015750: 652a 7365 6c66 2e77 6176 6575 6e69 7473  e*self.waveunits
-00015760: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-00015770: 6620 7365 6c66 2e65 7272 2069 7320 6e6f  f self.err is no
-00015780: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00015790: 2020 2020 2020 2020 6572 725f 666e 7520          err_fnu 
-000157a0: 3d20 2873 656c 662e 6572 722a 7365 6c66  = (self.err*self
-000157b0: 2e66 6c75 7875 6e69 7473 292e 746f 2866  .fluxunits).to(f
-000157c0: 6e75 5f75 6e69 7473 2c20 6571 7569 7661  nu_units, equiva
-000157d0: 6c65 6e63 6965 733d 752e 7370 6563 7472  lencies=u.spectr
-000157e0: 616c 5f64 656e 7369 7479 2873 656c 662e  al_density(self.
-000157f0: 7761 7665 2a73 656c 662e 7761 7665 756e  wave*self.waveun
-00015800: 6974 7329 290a 0a20 2020 2020 2020 2073  its))..        s
-00015810: 656c 662e 666e 755f 756e 6974 7320 3d20  elf.fnu_units = 
-00015820: 666e 755f 756e 6974 730a 2020 2020 2020  fnu_units.      
-00015830: 2020 7365 6c66 2e66 6c75 785f 666e 7520    self.flux_fnu 
-00015840: 3d20 666c 7578 5f66 6e75 2e76 616c 7565  = flux_fnu.value
-00015850: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00015860: 2e65 7272 2069 7320 6e6f 7420 4e6f 6e65  .err is not None
-00015870: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00015880: 6c66 2e65 7272 5f66 6e75 203d 2065 7272  lf.err_fnu = err
-00015890: 5f66 6e75 2e76 616c 7565 0a20 2020 2020  _fnu.value.     
-000158a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000158b0: 2020 2020 2073 656c 662e 6572 725f 666e       self.err_fn
-000158c0: 7520 3d20 4e6f 6e65 0a0a 0a20 2020 2064  u = None...    d
-000158d0: 6566 2069 6e74 6567 7261 7465 5f66 696c  ef integrate_fil
-000158e0: 7465 7228 7365 6c66 2c20 6669 6c74 6572  ter(self, filter
-000158f0: 2c20 6162 6d61 673d 4661 6c73 652c 2075  , abmag=False, u
-00015900: 7365 5f77 6176 653d 2766 696c 7465 7227  se_wave='filter'
-00015910: 293a 0a20 2020 2020 2020 2022 2222 496e  ):.        """In
-00015920: 7465 6772 6174 6520 7468 6520 7465 6d70  tegrate the temp
-00015930: 6c61 7465 2074 6872 6f75 6768 2061 6e20  late through an 
-00015940: 607e 6561 7a79 2e46 696c 7465 7244 6566  `~eazy.FilterDef
-00015950: 696e 6974 696f 6e60 2066 696c 7465 720a  inition` filter.
-00015960: 2020 2020 2020 2020 6f62 6a65 6374 2e0a          object..
-00015970: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-00015980: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-00015990: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2066  ------.        f
-000159a0: 696c 7465 7220 3a20 607e 7079 7379 6e70  ilter : `~pysynp
-000159b0: 686f 742e 4f62 7342 616e 6470 6173 7360  hot.ObsBandpass`
-000159c0: 0a20 2020 2020 2020 2020 2020 204f 7220  .            Or 
-000159d0: 616e 7920 6f62 6a65 6374 2074 6861 7420  any object that 
-000159e0: 6861 7320 6077 6176 6560 2061 6e64 2060  has `wave` and `
-000159f0: 7468 726f 7567 6870 7574 6020 6174 7472  throughput` attr
-00015a00: 6962 7574 6573 2c20 7769 7468 0a20 2020  ibutes, with.   
-00015a10: 2020 2020 2020 2020 2074 6865 2066 6f72           the for
-00015a20: 6d65 7220 696e 2074 6865 2073 616d 6520  mer in the same 
-00015a30: 756e 6974 7320 6173 2074 6865 2069 6e70  units as the inp
-00015a40: 7574 2073 7065 6374 7275 6d2e 0a0a 2020  ut spectrum...  
-00015a50: 2020 2020 2020 6162 6d61 6720 3a20 626f        abmag : bo
-00015a60: 6f6c 0a20 2020 2020 2020 2020 2020 2052  ol.            R
-00015a70: 6574 7572 6e20 4142 206d 6167 6e69 7475  eturn AB magnitu
-00015a80: 6465 2072 6174 6865 7220 7468 616e 2066  de rather than f
-00015a90: 6e75 2066 6c75 780a 0a20 2020 2020 2020  nu flux..       
-00015aa0: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
-00015ab0: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
-00015ac0: 2074 656d 705f 666c 7578 203a 2066 6c6f   temp_flux : flo
-00015ad0: 6174 0a0a 2020 2020 2020 2020 4578 616d  at..        Exam
-00015ae0: 706c 6573 0a20 2020 2020 2020 202d 2d2d  ples.        ---
-00015af0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436f  -----.        Co
-00015b00: 6d70 7574 6520 7468 6520 5746 4333 2f49  mpute the WFC3/I
-00015b10: 5220 4631 3430 5720 4142 206d 6167 6e69  R F140W AB magni
-00015b20: 7475 6465 206f 6620 6120 7075 7265 2065  tude of a pure e
-00015b30: 6d69 7373 696f 6e20 6c69 6e65 2061 7420  mission line at 
-00015b40: 7468 650a 2020 2020 2020 2020 352d 7369  the.        5-si
-00015b50: 676d 6120 3344 2d48 5354 206c 696e 6520  gma 3D-HST line 
-00015b60: 6465 7465 6374 696f 6e20 6c69 6d69 7420  detection limit 
-00015b70: 2835 652d 3137 2065 7267 2f73 2f63 6d32  (5e-17 erg/s/cm2
-00015b80: 293a 0a0a 2020 2020 2020 2020 3e3e 3e20  ):..        >>> 
-00015b90: 696d 706f 7274 206e 756d 7079 2061 7320  import numpy as 
-00015ba0: 6e70 0a20 2020 2020 2020 203e 3e3e 2066  np.        >>> f
-00015bb0: 726f 6d20 6772 697a 6c69 2e75 7469 6c73  rom grizli.utils
-00015bc0: 2069 6d70 6f72 7420 5370 6563 7472 756d   import Spectrum
-00015bd0: 5465 6d70 6c61 7465 0a20 2020 2020 2020  Template.       
-00015be0: 203e 3e3e 2066 726f 6d20 6561 7a79 2e66   >>> from eazy.f
-00015bf0: 696c 7465 7273 2069 6d70 6f72 7420 4669  ilters import Fi
-00015c00: 6c74 6572 4465 6669 6e69 7469 6f6e 0a20  lterDefinition. 
-00015c10: 2020 2020 2020 203e 3e3e 2069 6d70 6f72         >>> impor
-00015c20: 7420 7079 7379 6e70 686f 7420 6173 2053  t pysynphot as S
-00015c30: 0a20 2020 2020 2020 203e 3e3e 206c 696e  .        >>> lin
-00015c40: 6520 3d20 5370 6563 7472 756d 5465 6d70  e = SpectrumTemp
-00015c50: 6c61 7465 2863 656e 7472 616c 5f77 6176  late(central_wav
-00015c60: 653d 312e 3465 342c 2066 7768 6d3d 3135  e=1.4e4, fwhm=15
-00015c70: 302e 2c0a 2020 2020 2020 2020 2020 2020  0.,.            
-00015c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c90: 2020 2020 2020 2020 7665 6c6f 6369 7479          velocity
-00015ca0: 3d54 7275 6529 2a35 2e65 2d31 370a 2020  =True)*5.e-17.  
-00015cb0: 2020 2020 2020 3e3e 3e20 6669 6c74 6572        >>> filter
-00015cc0: 203d 2046 696c 7465 7244 6566 696e 6974   = FilterDefinit
-00015cd0: 696f 6e28 6270 3d53 2e4f 6273 4261 6e64  ion(bp=S.ObsBand
-00015ce0: 7061 7373 2827 7766 6333 2c69 722c 6631  pass('wfc3,ir,f1
-00015cf0: 3430 7727 2929 0a20 2020 2020 2020 203e  40w')).        >
-00015d00: 3e3e 2066 6e75 203d 206c 696e 652e 696e  >> fnu = line.in
-00015d10: 7465 6772 6174 655f 6669 6c74 6572 2866  tegrate_filter(f
-00015d20: 696c 7465 7229 0a20 2020 2020 2020 203e  ilter).        >
-00015d30: 3e3e 2070 7269 6e74 2827 4142 206d 6167  >> print('AB mag
-00015d40: 203d 207b 303a 2e33 667d 272e 666f 726d   = {0:.3f}'.form
-00015d50: 6174 282d 322e 352a 6e70 2e6c 6f67 3130  at(-2.5*np.log10
-00015d60: 2866 6e75 292d 3438 2e36 2929 0a20 2020  (fnu)-48.6)).   
-00015d70: 2020 2020 2041 4220 6d61 6720 3d20 3236       AB mag = 26
-00015d80: 2e36 3139 0a0a 2020 2020 2020 2020 2222  .619..        ""
-00015d90: 220a 2020 2020 2020 2020 494e 5445 4752  ".        INTEGR
-00015da0: 4154 4f52 203d 206e 702e 7472 6170 7a0a  ATOR = np.trapz.
-00015db0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00015dc0: 2020 2020 2020 2020 2020 2369 6d70 6f72            #impor
-00015dd0: 7420 6772 697a 6c69 2e75 7469 6c73 5f63  t grizli.utils_c
-00015de0: 0a20 2020 2020 2020 2020 2020 2023 696e  .            #in
-00015df0: 7465 7270 203d 2067 7269 7a6c 692e 7574  terp = grizli.ut
-00015e00: 696c 735f 632e 696e 7465 7270 2e69 6e74  ils_c.interp.int
-00015e10: 6572 705f 636f 6e73 6572 7665 5f63 0a20  erp_conserve_c. 
-00015e20: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
-00015e30: 2e75 7469 6c73 5f63 2e69 6e74 6572 7020  .utils_c.interp 
-00015e40: 696d 706f 7274 2069 6e74 6572 705f 636f  import interp_co
-00015e50: 6e73 6572 7665 5f63 0a20 2020 2020 2020  nserve_c.       
-00015e60: 2020 2020 2069 6e74 6572 7020 3d20 696e       interp = in
-00015e70: 7465 7270 5f63 6f6e 7365 7276 655f 630a  terp_conserve_c.
-00015e80: 2020 2020 2020 2020 6578 6365 7074 2049          except I
-00015e90: 6d70 6f72 7445 7272 6f72 3a0a 2020 2020  mportError:.    
-00015ea0: 2020 2020 2020 2020 696e 7465 7270 203d          interp =
-00015eb0: 206e 702e 696e 7465 7270 0a0a 2020 2020   np.interp..    
-00015ec0: 2020 2020 2377 7a20 3d20 7365 6c66 2e77      #wz = self.w
-00015ed0: 6176 652a 2831 2b7a 290a 2020 2020 2020  ave*(1+z).      
-00015ee0: 2020 6e6f 6e7a 6572 6f20 3d20 6669 6c74    nonzero = filt
-00015ef0: 6572 2e74 6872 6f75 6768 7075 7420 3e20  er.throughput > 
-00015f00: 300a 2020 2020 2020 2020 6966 2028 6669  0.        if (fi
-00015f10: 6c74 6572 2e77 6176 655b 6e6f 6e7a 6572  lter.wave[nonzer
-00015f20: 6f5d 2e6d 696e 2829 203e 2073 656c 662e  o].min() > self.
-00015f30: 7761 7665 2e6d 6178 2829 2920 7c20 2866  wave.max()) | (f
-00015f40: 696c 7465 722e 7761 7665 5b6e 6f6e 7a65  ilter.wave[nonze
-00015f50: 726f 5d2e 6d61 7828 2920 3c20 7365 6c66  ro].max() < self
-00015f60: 2e77 6176 652e 6d69 6e28 2929 207c 2028  .wave.min()) | (
-00015f70: 6669 6c74 6572 2e77 6176 655b 6e6f 6e7a  filter.wave[nonz
-00015f80: 6572 6f5d 2e6d 696e 2829 203c 2073 656c  ero].min() < sel
-00015f90: 662e 7761 7665 2e6d 696e 2829 293a 0a20  f.wave.min()):. 
-00015fa0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00015fb0: 6c66 2e65 7272 2069 7320 4e6f 6e65 3a0a  lf.err is None:.
-00015fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fd0: 7265 7475 726e 2030 2e0a 2020 2020 2020  return 0..      
-00015fe0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015ff0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00016000: 726e 2030 2e2c 2030 2e0a 0a20 2020 2020  rn 0., 0...     
-00016010: 2020 2069 6620 7573 655f 7761 7665 203d     if use_wave =
-00016020: 3d20 2766 696c 7465 7227 3a0a 2020 2020  = 'filter':.    
-00016030: 2020 2020 2020 2020 2320 496e 7465 7270          # Interp
-00016040: 6f6c 6174 6520 746f 2066 696c 7465 7220  olate to filter 
-00016050: 7761 7665 6c65 6e67 7468 730a 2020 2020  wavelengths.    
-00016060: 2020 2020 2020 2020 696e 7465 6772 6174          integrat
-00016070: 655f 7761 7665 203d 2066 696c 7465 722e  e_wave = filter.
-00016080: 7761 7665 0a0a 2020 2020 2020 2020 2020  wave..          
-00016090: 2020 696e 7465 6772 6174 655f 7465 6d70    integrate_temp
-000160a0: 6c20 3d20 696e 7465 7270 2866 696c 7465  l = interp(filte
-000160b0: 722e 7761 7665 2e61 7374 7970 6528 6e70  r.wave.astype(np
-000160c0: 2e66 6c6f 6174 3634 292c 200a 2020 2020  .float64), .    
-000160d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160f0: 7365 6c66 2e77 6176 652c 2073 656c 662e  self.wave, self.
-00016100: 666c 7578 5f66 6e75 2c20 6c65 6674 3d30  flux_fnu, left=0
-00016110: 2c20 7269 6768 743d 3029 0a0a 2020 2020  , right=0)..    
-00016120: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00016130: 6572 7220 6973 206e 6f74 204e 6f6e 653a  err is not None:
-00016140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016150: 2074 656d 706c 5f69 7661 7220 3d20 312e   templ_ivar = 1.
-00016160: 2f69 6e74 6572 7028 6669 6c74 6572 2e77  /interp(filter.w
-00016170: 6176 652e 6173 7479 7065 286e 702e 666c  ave.astype(np.fl
-00016180: 6f61 7436 3429 2c0a 2020 2020 2020 2020  oat64),.        
-00016190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000161b0: 656c 662e 7761 7665 2c20 7365 6c66 2e65  elf.wave, self.e
-000161c0: 7272 5f66 6e75 292a 2a32 0a0a 2020 2020  rr_fnu)**2..    
-000161d0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-000161e0: 6c5f 6976 6172 5b7e 6e70 2e69 7366 696e  l_ivar[~np.isfin
-000161f0: 6974 6528 7465 6d70 6c5f 6976 6172 295d  ite(templ_ivar)]
-00016200: 203d 2030 0a0a 2020 2020 2020 2020 2020   = 0..          
-00016210: 2020 2020 2020 696e 7465 6772 6174 655f        integrate_
-00016220: 7765 6967 6874 203d 2066 696c 7465 722e  weight = filter.
-00016230: 7468 726f 7567 6870 7574 2f66 696c 7465  throughput/filte
-00016240: 722e 7761 7665 2a74 656d 706c 5f69 7661  r.wave*templ_iva
-00016250: 722f 6669 6c74 6572 2e6e 6f72 6d0a 2020  r/filter.norm.  
-00016260: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00016270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016280: 696e 7465 6772 6174 655f 7765 6967 6874  integrate_weight
-00016290: 203d 2066 696c 7465 722e 7468 726f 7567   = filter.throug
-000162a0: 6870 7574 2f66 696c 7465 722e 7761 7665  hput/filter.wave
-000162b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000162c0: 2020 2020 2020 2020 2020 2023 2049 6e74             # Int
-000162d0: 6572 706f 6c61 7465 2074 6f20 7370 6563  erpolate to spec
-000162e0: 7472 756d 2077 6176 656c 656e 6774 6873  trum wavelengths
-000162f0: 0a20 2020 2020 2020 2020 2020 2069 6e74  .            int
-00016300: 6567 7261 7465 5f77 6176 6520 3d20 7365  egrate_wave = se
-00016310: 6c66 2e77 6176 650a 2020 2020 2020 2020  lf.wave.        
-00016320: 2020 2020 696e 7465 6772 6174 655f 7465      integrate_te
-00016330: 6d70 6c20 3d20 7365 6c66 2e66 6c75 785f  mpl = self.flux_
-00016340: 666e 750a 0a20 2020 2020 2020 2020 2020  fnu..           
-00016350: 2023 2074 6573 7420 3d20 6e6f 6e7a 6572   # test = nonzer
-00016360: 6f0a 2020 2020 2020 2020 2020 2020 7465  o.            te
-00016370: 7374 203d 206e 702e 6973 6669 6e69 7465  st = np.isfinite
-00016380: 2866 696c 7465 722e 7468 726f 7567 6870  (filter.throughp
-00016390: 7574 290a 2020 2020 2020 2020 2020 2020  ut).            
-000163a0: 696e 7465 7270 5f74 6872 7520 3d20 696e  interp_thru = in
-000163b0: 7465 7270 2869 6e74 6567 7261 7465 5f77  terp(integrate_w
-000163c0: 6176 652c 2066 696c 7465 722e 7761 7665  ave, filter.wave
-000163d0: 5b74 6573 745d 2c0a 2020 2020 2020 2020  [test],.        
+00011b90: 2b48 6527 5d20 3d20 5b36 3536 342e 3631  +He'] = [6564.61
+00011ba0: 2c20 3635 3439 2e38 362c 2036 3538 352e  , 6549.86, 6585.
+00011bb0: 3237 2c20 3637 3138 2e32 392c 2036 3733  27, 6718.29, 673
+00011bc0: 322e 3637 2c20 3930 3638 2e36 2c20 3935  2.67, 9068.6, 95
+00011bd0: 3330 2e36 2c20 3130 3833 302e 5d0a 2020  30.6, 10830.].  
+00011be0: 2020 6c69 6e65 5f72 6174 696f 735b 2748    line_ratios['H
+00011bf0: 612b 4e49 492b 5349 492b 5349 4949 2b48  a+NII+SII+SIII+H
+00011c00: 6527 5d20 3d20 5b31 2e2c 2031 2e2f 2834  e'] = [1., 1./(4
+00011c10: 2e2a 3429 2c20 332e 2f28 342a 3429 2c20  .*4), 3./(4*4), 
+00011c20: 312e 2f31 302c 2031 2e2f 3130 2c20 312e  1./10, 1./10, 1.
+00011c30: 2f32 302c 2032 2e34 342f 3230 2c20 312e  /20, 2.44/20, 1.
+00011c40: 2f32 352e 5d0a 0a20 2020 206c 696e 655f  /25.]..    line_
+00011c50: 7761 7665 6c65 6e67 7468 735b 2748 612b  wavelengths['Ha+
+00011c60: 4e49 492b 5349 492b 5349 4949 2b48 652b  NII+SII+SIII+He+
+00011c70: 5061 4227 5d20 3d20 5b36 3536 342e 3631  PaB'] = [6564.61
+00011c80: 2c20 3635 3439 2e38 362c 2036 3538 352e  , 6549.86, 6585.
+00011c90: 3237 2c20 3637 3138 2e32 392c 2036 3733  27, 6718.29, 673
+00011ca0: 322e 3637 2c20 3930 3638 2e36 2c20 3935  2.67, 9068.6, 95
+00011cb0: 3330 2e36 2c20 3130 3833 302e 2c20 3132  30.6, 10830., 12
+00011cc0: 3832 315d 0a20 2020 206c 696e 655f 7261  821].    line_ra
+00011cd0: 7469 6f73 5b27 4861 2b4e 4949 2b53 4949  tios['Ha+NII+SII
+00011ce0: 2b53 4949 492b 4865 2b50 6142 275d 203d  +SIII+He+PaB'] =
+00011cf0: 205b 312e 2c20 312e 2f28 342e 2a34 292c   [1., 1./(4.*4),
+00011d00: 2033 2e2f 2834 2a34 292c 2031 2e2f 3130   3./(4*4), 1./10
+00011d10: 2c20 312e 2f31 302c 2031 2e2f 3230 2c20  , 1./10, 1./20, 
+00011d20: 322e 3434 2f32 302c 2031 2e2f 3235 2e2c  2.44/20, 1./25.,
+00011d30: 2031 2e2f 3130 5d0a 0a20 2020 206c 696e   1./10]..    lin
+00011d40: 655f 7761 7665 6c65 6e67 7468 735b 2748  e_wavelengths['H
+00011d50: 612b 4e49 492b 5349 492b 5349 4949 2b48  a+NII+SII+SIII+H
+00011d60: 652b 5061 422b 5061 4727 5d20 3d20 5b36  e+PaB+PaG'] = [6
+00011d70: 3536 342e 3631 2c20 3635 3439 2e38 362c  564.61, 6549.86,
+00011d80: 2036 3538 352e 3237 2c20 3637 3138 2e32   6585.27, 6718.2
+00011d90: 392c 2036 3733 322e 3637 2c20 3930 3638  9, 6732.67, 9068
+00011da0: 2e36 2c20 3935 3330 2e36 2c20 3130 3833  .6, 9530.6, 1083
+00011db0: 302e 2c20 3132 3832 312c 2031 3039 3431  0., 12821, 10941
+00011dc0: 2e31 5d0a 2020 2020 6c69 6e65 5f72 6174  .1].    line_rat
+00011dd0: 696f 735b 2748 612b 4e49 492b 5349 492b  ios['Ha+NII+SII+
+00011de0: 5349 4949 2b48 652b 5061 422b 5061 4727  SIII+He+PaB+PaG'
+00011df0: 5d20 3d20 5b31 2e2c 2031 2e2f 2834 2e2a  ] = [1., 1./(4.*
+00011e00: 3429 2c20 332e 2f28 342a 3429 2c20 312e  4), 3./(4*4), 1.
+00011e10: 2f31 302c 2031 2e2f 3130 2c20 312e 2f32  /10, 1./10, 1./2
+00011e20: 302c 2032 2e34 342f 3230 2c20 312e 2f32  0, 2.44/20, 1./2
+00011e30: 352e 2c20 312e 2f31 302c 2031 2e2f 3130  5., 1./10, 1./10
+00011e40: 2f32 2e38 365d 0a0a 2020 2020 6c69 6e65  /2.86]..    line
+00011e50: 5f77 6176 656c 656e 6774 6873 5b27 4861  _wavelengths['Ha
+00011e60: 2b4e 4949 275d 203d 205b 3635 3634 2e36  +NII'] = [6564.6
+00011e70: 312c 2036 3534 392e 3836 2c20 3635 3835  1, 6549.86, 6585
+00011e80: 2e32 375d 0a20 2020 206e 3268 6120 3d20  .27].    n2ha = 
+00011e90: 312e 2f33 2020 2320 6c6f 6720 4e49 492f  1./3  # log NII/
+00011ea0: 4861 207e 202d 302e 362c 204b 6577 6c65  Ha ~ -0.6, Kewle
+00011eb0: 7920 3230 3133 0a20 2020 206c 696e 655f  y 2013.    line_
+00011ec0: 7261 7469 6f73 5b27 4861 2b4e 4949 275d  ratios['Ha+NII']
+00011ed0: 203d 205b 312e 2c20 312e 2f34 2e2a 6e32   = [1., 1./4.*n2
+00011ee0: 6861 2c20 332e 2f34 2e2a 6e32 6861 5d0a  ha, 3./4.*n2ha].
+00011ef0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00011f00: 6e67 7468 735b 274f 4949 492b 4862 275d  ngths['OIII+Hb']
+00011f10: 203d 205b 3530 3038 2e32 3430 2c20 3439   = [5008.240, 49
+00011f20: 3630 2e32 3935 2c20 3438 3632 2e36 385d  60.295, 4862.68]
+00011f30: 0a20 2020 206c 696e 655f 7261 7469 6f73  .    line_ratios
+00011f40: 5b27 4f49 4949 2b48 6227 5d20 3d20 5b32  ['OIII+Hb'] = [2
+00011f50: 2e39 382c 2031 2c20 332e 3938 2f36 2e5d  .98, 1, 3.98/6.]
+00011f60: 0a0a 2020 2020 2320 496e 636c 7564 6520  ..    # Include 
+00011f70: 6d6f 7265 2062 616c 6d65 7220 6c69 6e65  more balmer line
+00011f80: 730a 2020 2020 6c69 6e65 5f77 6176 656c  s.    line_wavel
+00011f90: 656e 6774 6873 5b27 4f49 4949 2b48 622b  engths['OIII+Hb+
+00011fa0: 4867 2b48 6427 5d20 3d20 6c69 6e65 5f77  Hg+Hd'] = line_w
+00011fb0: 6176 656c 656e 6774 6873 5b27 4f49 4949  avelengths['OIII
+00011fc0: 275d 202b 206c 696e 655f 7761 7665 6c65  '] + line_wavele
+00011fd0: 6e67 7468 735b 2742 616c 6d65 7220 3130  ngths['Balmer 10
+00011fe0: 6b4b 275d 5b31 3a5d 0a20 2020 206c 696e  kK'][1:].    lin
+00011ff0: 655f 7261 7469 6f73 5b27 4f49 4949 2b48  e_ratios['OIII+H
+00012000: 622b 4867 2b48 6427 5d20 3d20 6c69 6e65  b+Hg+Hd'] = line
+00012010: 5f72 6174 696f 735b 274f 4949 4927 5d20  _ratios['OIII'] 
+00012020: 2b20 6c69 6e65 5f72 6174 696f 735b 2742  + line_ratios['B
+00012030: 616c 6d65 7220 3130 6b4b 275d 5b31 3a5d  almer 10kK'][1:]
+00012040: 0a20 2020 2023 206f 3368 6220 3d20 312e  .    # o3hb = 1.
+00012050: 2f36 0a20 2020 2023 2066 6f72 2069 2069  /6.    # for i i
+00012060: 6e20 7261 6e67 6528 322c 206c 656e 286c  n range(2, len(l
+00012070: 696e 655f 7261 7469 6f73 5b27 4261 6c6d  ine_ratios['Balm
+00012080: 6572 2031 306b 4b27 5d29 2d31 293a 0a20  er 10kK'])-1):. 
+00012090: 2020 2023 2020 2020 2020 2020 206c 696e     #         lin
+000120a0: 655f 7261 7469 6f73 5b27 4f49 4949 2b48  e_ratios['OIII+H
+000120b0: 622b 4867 2b48 6427 5d5b 695d 202a 3d20  b+Hg+Hd'][i] *= 
+000120c0: 332e 3938 2a6f 3368 620a 2020 2020 2320  3.98*o3hb.    # 
+000120d0: 436f 6d70 7574 6520 6173 204f 332f 4862  Compute as O3/Hb
+000120e0: 0a20 2020 206f 3368 6220 3d20 360a 2020  .    o3hb = 6.  
+000120f0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00012100: 2832 293a 0a20 2020 2020 2020 206c 696e  (2):.        lin
+00012110: 655f 7261 7469 6f73 5b27 4f49 4949 2b48  e_ratios['OIII+H
+00012120: 622b 4867 2b48 6427 5d5b 695d 202a 3d20  b+Hg+Hd'][i] *= 
+00012130: 312e 2f33 2e39 382a 6f33 6862 0a0a 2020  1./3.98*o3hb..  
+00012140: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+00012150: 6873 5b27 4f49 4949 2b48 622b 4861 275d  hs['OIII+Hb+Ha']
+00012160: 203d 205b 3530 3038 2e32 3430 2c20 3439   = [5008.240, 49
+00012170: 3630 2e32 3935 2c20 3438 3632 2e36 382c  60.295, 4862.68,
+00012180: 2036 3536 342e 3631 5d0a 2020 2020 6c69   6564.61].    li
+00012190: 6e65 5f72 6174 696f 735b 274f 4949 492b  ne_ratios['OIII+
+000121a0: 4862 2b48 6127 5d20 3d20 5b32 2e39 382c  Hb+Ha'] = [2.98,
+000121b0: 2031 2c20 332e 3938 2f31 302e 2c20 332e   1, 3.98/10., 3.
+000121c0: 3938 2f31 302e 2a32 2e38 365d 0a0a 2020  98/10.*2.86]..  
+000121d0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+000121e0: 6873 5b27 4f49 4949 2b48 622b 4861 2b53  hs['OIII+Hb+Ha+S
+000121f0: 4949 275d 203d 205b 3530 3038 2e32 3430  II'] = [5008.240
+00012200: 2c20 3439 3630 2e32 3935 2c20 3438 3632  , 4960.295, 4862
+00012210: 2e36 382c 2036 3536 342e 3631 2c20 3637  .68, 6564.61, 67
+00012220: 3138 2e32 392c 2036 3733 322e 3637 5d0a  18.29, 6732.67].
+00012230: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+00012240: 274f 4949 492b 4862 2b48 612b 5349 4927  'OIII+Hb+Ha+SII'
+00012250: 5d20 3d20 5b32 2e39 382c 2031 2c20 332e  ] = [2.98, 1, 3.
+00012260: 3938 2f31 302e 2c20 332e 3938 2f31 302e  98/10., 3.98/10.
+00012270: 2a32 2e38 362a 342c 2033 2e39 382f 3130  *2.86*4, 3.98/10
+00012280: 2e2a 322e 3836 2f31 302e 2a34 2c20 332e  .*2.86/10.*4, 3.
+00012290: 3938 2f31 302e 2a32 2e38 362f 3130 2e2a  98/10.*2.86/10.*
+000122a0: 345d 0a0a 2020 2020 6c69 6e65 5f77 6176  4]..    line_wav
+000122b0: 656c 656e 6774 6873 5b27 4f49 4949 2b4f  elengths['OIII+O
+000122c0: 4949 275d 203d 205b 3530 3038 2e32 3430  II'] = [5008.240
+000122d0: 2c20 3439 3630 2e32 3935 2c20 3337 3239  , 4960.295, 3729
+000122e0: 2e38 3735 5d0a 2020 2020 6c69 6e65 5f72  .875].    line_r
+000122f0: 6174 696f 735b 274f 4949 492b 4f49 4927  atios['OIII+OII'
+00012300: 5d20 3d20 5b32 2e39 382c 2031 2c20 332e  ] = [2.98, 1, 3.
+00012310: 3938 2f34 2e5d 0a0a 2020 2020 6c69 6e65  98/4.]..    line
+00012320: 5f77 6176 656c 656e 6774 6873 5b27 4f49  _wavelengths['OI
+00012330: 492b 4e65 275d 203d 205b 3337 3239 2e38  I+Ne'] = [3729.8
+00012340: 3735 2c20 3338 3639 5d0a 2020 2020 6c69  75, 3869].    li
+00012350: 6e65 5f72 6174 696f 735b 274f 4949 2b4e  ne_ratios['OII+N
+00012360: 6527 5d20 3d20 5b31 2c20 312e 2f35 5d0a  e'] = [1, 1./5].
+00012370: 0a20 2020 2023 2047 726f 7570 7320 6f66  .    # Groups of
+00012380: 2061 6c6c 206c 696e 6573 0a20 2020 206c   all lines.    l
+00012390: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+000123a0: 2766 756c 6c27 5d20 3d20 5b77 2066 6f72  'full'] = [w for
+000123b0: 2077 2069 6e20 6c69 6e65 5f77 6176 656c   w in line_wavel
+000123c0: 656e 6774 6873 5b27 4261 6c6d 6572 2031  engths['Balmer 1
+000123d0: 306b 4b27 5d5d 0a20 2020 206c 696e 655f  0kK']].    line_
+000123e0: 7261 7469 6f73 5b27 6675 6c6c 275d 203d  ratios['full'] =
+000123f0: 205b 7720 666f 7220 7720 696e 206c 696e   [w for w in lin
+00012400: 655f 7261 7469 6f73 5b27 4261 6c6d 6572  e_ratios['Balmer
+00012410: 2031 306b 4b27 5d5d 0a0a 2020 2020 6c69   10kK']]..    li
+00012420: 6e65 5f77 6176 656c 656e 6774 6873 5b27  ne_wavelengths['
+00012430: 6675 6c6c 275d 202b 3d20 6c69 6e65 5f77  full'] += line_w
+00012440: 6176 656c 656e 6774 6873 5b27 4e49 4927  avelengths['NII'
+00012450: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
+00012460: 735b 2766 756c 6c27 5d20 2b3d 205b 312e  s['full'] += [1.
+00012470: 2f35 2f33 2e2a 6c69 6e65 5f72 6174 696f  /5/3.*line_ratio
+00012480: 735b 2742 616c 6d65 7220 3130 6b4b 275d  s['Balmer 10kK']
+00012490: 5b31 5d2a 7220 666f 7220 7220 696e 206c  [1]*r for r in l
+000124a0: 696e 655f 7261 7469 6f73 5b27 4e49 4927  ine_ratios['NII'
+000124b0: 5d5d 0a0a 2020 2020 6c69 6e65 5f77 6176  ]]..    line_wav
+000124c0: 656c 656e 6774 6873 5b27 6675 6c6c 275d  elengths['full']
+000124d0: 202b 3d20 6c69 6e65 5f77 6176 656c 656e   += line_wavelen
+000124e0: 6774 6873 5b27 5349 4927 5d0a 2020 2020  gths['SII'].    
+000124f0: 6c69 6e65 5f72 6174 696f 735b 2766 756c  line_ratios['ful
+00012500: 6c27 5d20 2b3d 205b 312e 2f33 2e38 2f32  l'] += [1./3.8/2
+00012510: 2a6c 696e 655f 7261 7469 6f73 5b27 4261  *line_ratios['Ba
+00012520: 6c6d 6572 2031 306b 4b27 5d5b 315d 2a72  lmer 10kK'][1]*r
+00012530: 2066 6f72 2072 2069 6e20 6c69 6e65 5f72   for r in line_r
+00012540: 6174 696f 735b 2753 4949 275d 5d0a 0a20  atios['SII']].. 
+00012550: 2020 2023 204c 696e 6573 2066 726f 6d20     # Lines from 
+00012560: 4861 6765 6c65 2032 3030 362c 206c 6f77  Hagele 2006, low
+00012570: 2d5a 2048 4949 2067 616c 6178 6965 730a  -Z HII galaxies.
+00012580: 2020 2020 2320 5344 5353 204a 3030 3231      # SDSS J0021
+00012590: 3031 2e30 332b 3030 3532 3438 2e31 0a20  01.03+005248.1. 
+000125a0: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+000125b0: 7468 735b 2766 756c 6c27 5d20 2b3d 206c  ths['full'] += l
+000125c0: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+000125d0: 2753 4949 4927 5d0a 2020 2020 6c69 6e65  'SIII'].    line
+000125e0: 5f72 6174 696f 735b 2766 756c 6c27 5d20  _ratios['full'] 
+000125f0: 2b3d 205b 3430 312e 2f31 3030 302f 322e  += [401./1000/2.
+00012600: 3434 2a6c 696e 655f 7261 7469 6f73 5b27  44*line_ratios['
+00012610: 4261 6c6d 6572 2031 306b 4b27 5d5b 315d  Balmer 10kK'][1]
+00012620: 2a72 2066 6f72 2072 2069 6e20 6c69 6e65  *r for r in line
+00012630: 5f72 6174 696f 735b 2753 4949 4927 5d5d  _ratios['SIII']]
+00012640: 0a0a 2020 2020 2320 4865 490a 2020 2020  ..    # HeI.    
+00012650: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+00012660: 5b27 6675 6c6c 275d 202b 3d20 6c69 6e65  ['full'] += line
+00012670: 5f77 6176 656c 656e 6774 6873 5b27 4865  _wavelengths['He
+00012680: 492d 7365 7269 6573 275d 0a20 2020 2068  I-series'].    h
+00012690: 6535 3837 375f 6862 203d 2031 3237 2e2f  e5877_hb = 127./
+000126a0: 3130 3030 2f6c 696e 655f 7261 7469 6f73  1000/line_ratios
+000126b0: 5b27 4865 492d 7365 7269 6573 275d 5b31  ['HeI-series'][1
+000126c0: 5d0a 2020 2020 6c69 6e65 5f72 6174 696f  ].    line_ratio
+000126d0: 735b 2766 756c 6c27 5d20 2b3d 205b 6865  s['full'] += [he
+000126e0: 3538 3737 5f68 622a 7220 666f 7220 7220  5877_hb*r for r 
+000126f0: 696e 206c 696e 655f 7261 7469 6f73 5b27  in line_ratios['
+00012700: 4865 492d 7365 7269 6573 275d 5d0a 0a20  HeI-series']].. 
+00012710: 2020 2023 204e 6549 4949 0a20 2020 206c     # NeIII.    l
+00012720: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+00012730: 2766 756c 6c27 5d20 2b3d 206c 696e 655f  'full'] += line_
+00012740: 7761 7665 6c65 6e67 7468 735b 274e 6549  wavelengths['NeI
+00012750: 4949 2d33 3836 3727 5d0a 2020 2020 6c69  II-3867'].    li
+00012760: 6e65 5f72 6174 696f 735b 2766 756c 6c27  ne_ratios['full'
+00012770: 5d20 2b3d 205b 3338 382e 2f31 3030 3020  ] += [388./1000 
+00012780: 666f 7220 7220 696e 206c 696e 655f 7261  for r in line_ra
+00012790: 7469 6f73 5b27 4e65 4949 492d 3338 3637  tios['NeIII-3867
+000127a0: 275d 5d0a 0a20 2020 206c 696e 655f 7761  ']]..    line_wa
+000127b0: 7665 6c65 6e67 7468 735b 2766 756c 6c27  velengths['full'
+000127c0: 5d20 2b3d 206c 696e 655f 7761 7665 6c65  ] += line_wavele
+000127d0: 6e67 7468 735b 274e 6549 4949 2d33 3936  ngths['NeIII-396
+000127e0: 3827 5d0a 2020 2020 6c69 6e65 5f72 6174  8'].    line_rat
+000127f0: 696f 735b 2766 756c 6c27 5d20 2b3d 205b  ios['full'] += [
+00012800: 3239 302e 2f31 3030 3020 666f 7220 7220  290./1000 for r 
+00012810: 696e 206c 696e 655f 7261 7469 6f73 5b27  in line_ratios['
+00012820: 4e65 4949 492d 3339 3638 275d 5d0a 0a20  NeIII-3968']].. 
+00012830: 2020 2023 2041 6464 2055 5620 6c69 6e65     # Add UV line
+00012840: 733a 204d 6749 492f 4862 203d 2033 0a20  s: MgII/Hb = 3. 
+00012850: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
+00012860: 7468 735b 2766 756c 6c27 5d20 2b3d 206c  ths['full'] += l
+00012870: 696e 655f 7761 7665 6c65 6e67 7468 735b  ine_wavelengths[
+00012880: 2747 616c 2d55 562d 6c69 6e65 7327 5d0a  'Gal-UV-lines'].
+00012890: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+000128a0: 2766 756c 6c27 5d20 2b3d 205b 722a 332f  'full'] += [r*3/
+000128b0: 6c69 6e65 5f72 6174 696f 735b 2747 616c  line_ratios['Gal
+000128c0: 2d55 562d 6c69 6e65 7327 5d5b 2d31 5d20  -UV-lines'][-1] 
+000128d0: 666f 7220 7220 696e 206c 696e 655f 7261  for r in line_ra
+000128e0: 7469 6f73 5b27 4761 6c2d 5556 2d6c 696e  tios['Gal-UV-lin
+000128f0: 6573 275d 5d0a 0a20 2020 2023 2048 6967  es']]..    # Hig
+00012900: 6820 4f33 3220 2d20 6c6f 7720 6d65 7461  h O32 - low meta
+00012910: 6c6c 6963 6974 790a 2020 2020 6f33 322c  llicity.    o32,
+00012920: 2072 3233 203d 2034 2c20 380a 2020 2020   r23 = 4, 8.    
+00012930: 6f33 5f68 6220 3d20 7232 332f 2831 2b31  o3_hb = r23/(1+1
+00012940: 2f6f 3332 290a 0a20 2020 206c 696e 655f  /o32)..    line_
+00012950: 7761 7665 6c65 6e67 7468 735b 2768 6967  wavelengths['hig
+00012960: 684f 3332 275d 203d 205b 7720 666f 7220  hO32'] = [w for 
+00012970: 7720 696e 206c 696e 655f 7761 7665 6c65  w in line_wavele
+00012980: 6e67 7468 735b 2766 756c 6c27 5d5d 0a20  ngths['full']]. 
+00012990: 2020 206c 696e 655f 7261 7469 6f73 5b27     line_ratios['
+000129a0: 6869 6768 4f33 3227 5d20 3d20 5b72 2066  highO32'] = [r f
+000129b0: 6f72 2072 2069 6e20 6c69 6e65 5f72 6174  or r in line_rat
+000129c0: 696f 735b 2766 756c 6c27 5d5d 0a0a 2020  ios['full']]..  
+000129d0: 2020 6c69 6e65 5f77 6176 656c 656e 6774    line_wavelengt
+000129e0: 6873 5b27 6869 6768 4f33 3227 5d20 2b3d  hs['highO32'] +=
+000129f0: 206c 696e 655f 7761 7665 6c65 6e67 7468   line_wavelength
+00012a00: 735b 274f 4949 4927 5d0a 2020 2020 6c69  s['OIII'].    li
+00012a10: 6e65 5f72 6174 696f 735b 2768 6967 684f  ne_ratios['highO
+00012a20: 3332 275d 202b 3d20 5b72 2a6f 335f 6862  32'] += [r*o3_hb
+00012a30: 2f33 2e39 3820 666f 7220 7220 696e 206c  /3.98 for r in l
+00012a40: 696e 655f 7261 7469 6f73 5b27 4f49 4949  ine_ratios['OIII
+00012a50: 275d 5d0a 0a20 2020 206c 696e 655f 7761  ']]..    line_wa
+00012a60: 7665 6c65 6e67 7468 735b 2768 6967 684f  velengths['highO
+00012a70: 3332 275d 202b 3d20 6c69 6e65 5f77 6176  32'] += line_wav
+00012a80: 656c 656e 6774 6873 5b27 4f49 4927 5d0a  elengths['OII'].
+00012a90: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+00012aa0: 2768 6967 684f 3332 275d 202b 3d20 5b72  'highO32'] += [r
+00012ab0: 2a6f 335f 6862 2f32 2f6f 3332 2066 6f72  *o3_hb/2/o32 for
+00012ac0: 2072 2069 6e20 6c69 6e65 5f72 6174 696f   r in line_ratio
+00012ad0: 735b 274f 4949 275d 5d0a 0a20 2020 2023  s['OII']]..    #
+00012ae0: 204c 6f77 204f 3332 202d 206c 6f77 206d   Low O32 - low m
+00012af0: 6574 616c 6c69 6369 7479 0a20 2020 206f  etallicity.    o
+00012b00: 3332 2c20 7232 3320 3d20 302e 332c 2034  32, r23 = 0.3, 4
+00012b10: 0a20 2020 206f 335f 6862 203d 2072 3233  .    o3_hb = r23
+00012b20: 2f28 312b 312f 6f33 3229 0a0a 2020 2020  /(1+1/o32)..    
+00012b30: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
+00012b40: 5b27 6c6f 774f 3332 275d 203d 205b 7720  ['lowO32'] = [w 
+00012b50: 666f 7220 7720 696e 206c 696e 655f 7761  for w in line_wa
+00012b60: 7665 6c65 6e67 7468 735b 2766 756c 6c27  velengths['full'
+00012b70: 5d5d 0a20 2020 206c 696e 655f 7261 7469  ]].    line_rati
+00012b80: 6f73 5b27 6c6f 774f 3332 275d 203d 205b  os['lowO32'] = [
+00012b90: 7220 666f 7220 7220 696e 206c 696e 655f  r for r in line_
+00012ba0: 7261 7469 6f73 5b27 6675 6c6c 275d 5d0a  ratios['full']].
+00012bb0: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
+00012bc0: 6e67 7468 735b 276c 6f77 4f33 3227 5d20  ngths['lowO32'] 
+00012bd0: 2b3d 206c 696e 655f 7761 7665 6c65 6e67  += line_waveleng
+00012be0: 7468 735b 274f 4949 4927 5d0a 2020 2020  ths['OIII'].    
+00012bf0: 6c69 6e65 5f72 6174 696f 735b 276c 6f77  line_ratios['low
+00012c00: 4f33 3227 5d20 2b3d 205b 722a 6f33 5f68  O32'] += [r*o3_h
+00012c10: 622f 332e 3938 2066 6f72 2072 2069 6e20  b/3.98 for r in 
+00012c20: 6c69 6e65 5f72 6174 696f 735b 274f 4949  line_ratios['OII
+00012c30: 4927 5d5d 0a0a 2020 2020 6c69 6e65 5f77  I']]..    line_w
+00012c40: 6176 656c 656e 6774 6873 5b27 6c6f 774f  avelengths['lowO
+00012c50: 3332 275d 202b 3d20 6c69 6e65 5f77 6176  32'] += line_wav
+00012c60: 656c 656e 6774 6873 5b27 4f49 4927 5d0a  elengths['OII'].
+00012c70: 2020 2020 6c69 6e65 5f72 6174 696f 735b      line_ratios[
+00012c80: 276c 6f77 4f33 3227 5d20 2b3d 205b 722a  'lowO32'] += [r*
+00012c90: 6f33 5f68 622f 322f 6f33 3220 666f 7220  o3_hb/2/o32 for 
+00012ca0: 7220 696e 206c 696e 655f 7261 7469 6f73  r in line_ratios
+00012cb0: 5b27 4f49 4927 5d5d 0a0a 2020 2020 7265  ['OII']]..    re
+00012cc0: 7475 726e 206c 696e 655f 7761 7665 6c65  turn line_wavele
+00012cd0: 6e67 7468 732c 206c 696e 655f 7261 7469  ngths, line_rati
+00012ce0: 6f73 0a0a 0a64 6566 2065 6d69 7373 696f  os...def emissio
+00012cf0: 6e5f 6c69 6e65 5f74 656d 706c 6174 6573  n_line_templates
+00012d00: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
+00012d10: 5465 7374 696e 6720 4653 5053 206c 696e  Testing FSPS lin
+00012d20: 6520 7465 6d70 6c61 7465 730a 2020 2020  e templates.    
+00012d30: 2222 220a 2020 2020 696d 706f 7274 206e  """.    import n
+00012d40: 756d 7079 2061 7320 6e70 0a20 2020 2069  umpy as np.    i
+00012d50: 6d70 6f72 7420 6d61 7470 6c6f 746c 6962  mport matplotlib
+00012d60: 2e70 7970 6c6f 7420 6173 2070 6c74 0a20  .pyplot as plt. 
+00012d70: 2020 2066 726f 6d20 6772 697a 6c69 2069     from grizli i
+00012d80: 6d70 6f72 7420 7574 696c 730a 2020 2020  mport utils.    
+00012d90: 696d 706f 7274 2066 7370 730a 2020 2020  import fsps.    
+00012da0: 7370 203d 2066 7370 732e 5374 656c 6c61  sp = fsps.Stella
+00012db0: 7250 6f70 756c 6174 696f 6e28 696d 665f  rPopulation(imf_
+00012dc0: 7479 7065 3d31 2c20 7a63 6f6e 7469 6e75  type=1, zcontinu
+00012dd0: 6f75 733d 3129 0a0a 2020 2020 7370 5f70  ous=1)..    sp_p
+00012de0: 6172 616d 7320 3d20 7b7d 0a0a 2020 2020  arams = {}..    
+00012df0: 7370 5f70 6172 616d 735b 2773 7461 7262  sp_params['starb
+00012e00: 7572 7374 275d 203d 207b 2773 6668 273a  urst'] = {'sfh':
+00012e10: 2034 2c20 2774 6175 273a 2030 2e33 2c20   4, 'tau': 0.3, 
+00012e20: 2774 6167 6527 3a20 302e 312c 0a20 2020  'tage': 0.1,.   
+00012e30: 2020 2020 2020 2027 6c6f 677a 736f 6c27         'logzsol'
+00012e40: 3a20 2d31 2c20 2767 6173 5f6c 6f67 7a27  : -1, 'gas_logz'
+00012e50: 3a20 2d31 2c0a 2020 2020 2020 2020 2020  : -1,.          
+00012e60: 2767 6173 5f6c 6f67 7527 3a20 2d32 2e35  'gas_logu': -2.5
+00012e70: 7d0a 0a20 2020 2073 705f 7061 7261 6d73  }..    sp_params
+00012e80: 5b27 6d61 7475 7265 275d 203d 207b 2773  ['mature'] = {'s
+00012e90: 6668 273a 2034 2c20 2774 6175 273a 2030  fh': 4, 'tau': 0
+00012ea0: 2e32 2c20 2774 6167 6527 3a20 302e 392c  .2, 'tage': 0.9,
+00012eb0: 0a20 2020 2020 2020 2027 6c6f 677a 736f  .        'logzso
+00012ec0: 6c27 3a20 2d30 2e32 2c20 2767 6173 5f6c  l': -0.2, 'gas_l
+00012ed0: 6f67 7a27 3a20 2d30 2e32 2c0a 2020 2020  ogz': -0.2,.    
+00012ee0: 2020 2020 2767 6173 5f6c 6f67 7527 3a20      'gas_logu': 
+00012ef0: 2d32 2e35 7d0a 0a20 2020 206c 696e 655f  -2.5}..    line_
+00012f00: 7465 6d70 6c61 7465 7320 3d20 7b7d 0a0a  templates = {}..
+00012f10: 2020 2020 666f 7220 7420 696e 2073 705f      for t in sp_
+00012f20: 7061 7261 6d73 3a0a 2020 2020 2020 2020  params:.        
+00012f30: 7073 6574 203d 2073 705f 7061 7261 6d73  pset = sp_params
+00012f40: 5b74 5d0a 2020 2020 2020 2020 6865 6164  [t].        head
+00012f50: 6572 203d 2027 7761 7665 2066 6c75 785c  er = 'wave flux\
+00012f60: 6e5c 6e27 0a20 2020 2020 2020 2066 6f72  n\n'.        for
+00012f70: 2070 2069 6e20 7073 6574 3a0a 2020 2020   p in pset:.    
+00012f80: 2020 2020 2020 2020 6865 6164 6572 202b          header +
+00012f90: 3d20 277b 307d 203d 207b 317d 5c6e 272e  = '{0} = {1}\n'.
+00012fa0: 666f 726d 6174 2870 2c20 7073 6574 5b70  format(p, pset[p
+00012fb0: 5d29 0a20 2020 2020 2020 2020 2020 2069  ]).            i
+00012fc0: 6620 7020 3d3d 2027 7461 6765 273a 0a20  f p == 'tage':. 
+00012fd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00012fe0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+00012ff0: 2020 2020 2070 7269 6e74 2870 2c20 7073       print(p, ps
+00013000: 6574 5b70 5d29 0a20 2020 2020 2020 2020  et[p]).         
+00013010: 2020 2073 702e 7061 7261 6d73 5b70 5d20     sp.params[p] 
+00013020: 3d20 7073 6574 5b70 5d0a 0a20 2020 2020  = pset[p]..     
+00013030: 2020 2073 7065 6320 3d20 7b7d 0a20 2020     spec = {}.   
+00013040: 2020 2020 2066 6f72 206e 6562 2069 6e20       for neb in 
+00013050: 5b54 7275 652c 2046 616c 7365 5d3a 0a20  [True, False]:. 
+00013060: 2020 2020 2020 2020 2020 2073 702e 7061             sp.pa
+00013070: 7261 6d73 5b27 6164 645f 6e65 625f 656d  rams['add_neb_em
+00013080: 6973 7369 6f6e 275d 203d 206e 6562 0a20  ission'] = neb. 
+00013090: 2020 2020 2020 2020 2020 2073 702e 7061             sp.pa
+000130a0: 7261 6d73 5b27 6164 645f 6e65 625f 636f  rams['add_neb_co
+000130b0: 6e74 696e 7575 6d27 5d20 3d20 6e65 620a  ntinuum'] = neb.
+000130c0: 2020 2020 2020 2020 2020 2020 7761 7665              wave
+000130d0: 2c20 7370 6563 5b6e 6562 5d20 3d20 7370  , spec[neb] = sp
+000130e0: 2e67 6574 5f73 7065 6374 7275 6d28 7461  .get_spectrum(ta
+000130f0: 6765 3d70 7365 745b 2774 6167 6527 5d2c  ge=pset['tage'],
+00013100: 2070 6572 6161 3d54 7275 6529 0a20 2020   peraa=True).   
+00013110: 2020 2020 2020 2020 2023 706c 742e 706c           #plt.pl
+00013120: 6f74 2877 6176 652c 2073 7065 635b 6e65  ot(wave, spec[ne
+00013130: 625d 2c20 616c 7068 613d 302e 3529 0a0a  b], alpha=0.5)..
+00013140: 2020 2020 2020 2020 6e65 625f 6f6e 6c79          neb_only
+00013150: 203d 2073 7065 635b 5472 7565 5d20 2d20   = spec[True] - 
+00013160: 7370 6563 5b46 616c 7365 5d0a 2020 2020  spec[False].    
+00013170: 2020 2020 6e65 625f 6f6e 6c79 203d 206e      neb_only = n
+00013180: 6562 5f6f 6e6c 7920 2f20 6e65 625f 6f6e  eb_only / neb_on
+00013190: 6c79 2e6d 6178 2829 0a20 2020 2020 2020  ly.max().       
+000131a0: 206e 6562 5f6f 6e6c 7920 3d20 7370 6563   neb_only = spec
+000131b0: 5b54 7275 655d 202f 2073 7065 635b 5472  [True] / spec[Tr
+000131c0: 7565 5d2e 6d61 7828 290a 0a20 2020 2020  ue].max()..     
+000131d0: 2020 2070 6c74 2e70 6c6f 7428 7761 7665     plt.plot(wave
+000131e0: 2c20 6e65 625f 6f6e 6c79 2c20 6c61 6265  , neb_only, labe
+000131f0: 6c3d 742c 2061 6c70 6861 3d30 2e35 290a  l=t, alpha=0.5).
+00013200: 0a20 2020 2020 2020 206e 6562 5f6f 6e6c  .        neb_onl
+00013210: 795b 6e65 625f 6f6e 6c79 203c 2031 2e65  y[neb_only < 1.e
+00013220: 2d34 5d20 3d20 300a 0a20 2020 2020 2020  -4] = 0..       
+00013230: 206e 702e 7361 7665 7478 7428 2766 7370   np.savetxt('fsp
+00013240: 735f 7b30 7d5f 6c69 6e65 732e 7478 7427  s_{0}_lines.txt'
+00013250: 2e66 6f72 6d61 7428 7429 2c20 6e70 2e61  .format(t), np.a
+00013260: 7272 6179 285b 7761 7665 2c20 6e65 625f  rray([wave, neb_
+00013270: 6f6e 6c79 5d29 2e54 2c20 666d 743d 2725  only]).T, fmt='%
+00013280: 2e35 6527 2c20 6865 6164 6572 3d68 6561  .5e', header=hea
+00013290: 6465 7229 0a0a 2020 2020 2020 2020 6c69  der)..        li
+000132a0: 6e65 5f74 656d 706c 6174 6573 5b74 5d20  ne_templates[t] 
+000132b0: 3d20 7574 696c 732e 5370 6563 7472 756d  = utils.Spectrum
+000132c0: 5465 6d70 6c61 7465 2877 6176 653d 7761  Template(wave=wa
+000132d0: 7665 2c20 666c 7578 3d6e 6562 5f6f 6e6c  ve, flux=neb_onl
+000132e0: 792c 206e 616d 653d 2766 7370 735f 7b30  y, name='fsps_{0
+000132f0: 7d5f 6c69 6e65 7327 2e66 6f72 6d61 7428  }_lines'.format(
+00013300: 7429 290a 0a0a 6465 6620 7061 6833 3328  t))...def pah33(
+00013310: 7761 7665 5f67 7269 6429 3a0a 2020 2020  wave_grid):.    
+00013320: 2222 220a 2020 2020 5365 7420 6f66 2033  """.    Set of 3
+00013330: 2e33 2075 6d20 5041 4820 6c69 6e65 7320  .3 um PAH lines 
+00013340: 6672 6f6d 204c 6920 6574 2061 6c2e 2032  from Li et al. 2
+00013350: 3032 300a 2020 2020 0a20 2020 2052 6574  020.    .    Ret
+00013360: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+00013370: 0a20 2020 2070 6168 5f74 656d 706c 6174  .    pah_templat
+00013380: 6573 203a 206c 6973 740a 2020 2020 2020  es : list.      
+00013390: 2020 4c69 7374 206f 6620 607e 6772 697a    List of `~griz
+000133a0: 6c69 2e75 7469 6c73 2e53 7065 6374 7275  li.utils.Spectru
+000133b0: 6d54 656d 706c 6174 6560 2074 656d 706c  mTemplate` templ
+000133c0: 6174 6573 2066 6f72 2074 6872 6565 2063  ates for three c
+000133d0: 6f6d 706f 6e65 6e74 730a 2020 2020 2020  omponents.      
+000133e0: 2020 6172 6f75 6e64 2033 2e33 2075 6d0a    around 3.3 um.
+000133f0: 2020 2020 0a20 2020 2022 2222 0a20 2020      .    """.   
+00013400: 2070 6168 5f74 656d 706c 6174 6573 203d   pah_templates =
+00013410: 207b 7d0a 2020 2020 666f 7220 6c63 2c20   {}.    for lc, 
+00013420: 6c77 2069 6e20 7a69 7028 5b33 2e32 392c  lw in zip([3.29,
+00013430: 2033 2e34 302c 2033 2e34 375d 2c20 5b30   3.40, 3.47], [0
+00013440: 2e30 3433 2c20 302e 3033 312c 2030 2e31  .043, 0.031, 0.1
+00013450: 3030 5d29 3a0a 2020 2020 2020 2020 7469  00]):.        ti
+00013460: 203d 2070 6168 5f6c 696e 655f 7465 6d70   = pah_line_temp
+00013470: 6c61 7465 2877 6176 655f 6772 6964 2c20  late(wave_grid, 
+00013480: 6365 6e74 6572 5f75 6d3d 6c63 2c20 6677  center_um=lc, fw
+00013490: 686d 3d6c 7729 0a20 2020 2020 2020 2070  hm=lw).        p
+000134a0: 6168 5f74 656d 706c 6174 6573 5b74 692e  ah_templates[ti.
+000134b0: 6e61 6d65 5d20 3d20 7469 0a20 2020 200a  name] = ti.    .
+000134c0: 2020 2020 7265 7475 726e 2070 6168 5f74      return pah_t
+000134d0: 656d 706c 6174 6573 0a0a 0a64 6566 2070  emplates...def p
+000134e0: 6168 5f6c 696e 655f 7465 6d70 6c61 7465  ah_line_template
+000134f0: 2877 6176 655f 6772 6964 2c20 6365 6e74  (wave_grid, cent
+00013500: 6572 5f75 6d3d 332e 3239 2c20 6677 686d  er_um=3.29, fwhm
+00013510: 3d30 2e30 3433 293a 0a20 2020 2022 2222  =0.043):.    """
+00013520: 0a20 2020 204d 616b 6520 6120 7465 6d70  .    Make a temp
+00013530: 6c61 7465 2066 6f72 2061 2062 726f 6164  late for a broad
+00013540: 2050 4148 206c 696e 6520 7769 7468 2061   PAH line with a
+00013550: 2044 7275 6465 2070 726f 6669 6c65 0a20   Drude profile. 
+00013560: 2020 200a 2020 2020 4465 6661 756c 7420     .    Default 
+00013570: 7061 7261 6d65 7465 7273 2069 6e20 4c61  parameters in La
+00013580: 6920 6574 2061 6c2e 2032 3032 300a 2020  i et al. 2020.  
+00013590: 2020 6874 7470 733a 2f2f 696f 7073 6369    https://iopsci
+000135a0: 656e 6365 2e69 6f70 2e6f 7267 2f61 7274  ence.iop.org/art
+000135b0: 6963 6c65 2f31 302e 3338 3437 2f31 3533  icle/10.3847/153
+000135c0: 382d 3433 3537 2f61 6263 3030 322f 7064  8-4357/abc002/pd
+000135d0: 660a 2020 2020 6672 6f6d 2054 6f6b 756e  f.    from Tokun
+000135e0: 6167 6120 6574 2061 6c2e 2031 3939 310a  aga et al. 1991.
+000135f0: 2020 2020 0a20 2020 2044 7275 6465 2065      .    Drude e
+00013600: 7175 6174 696f 6e20 616e 6420 6e6f 726d  quation and norm
+00013610: 616c 697a 6174 696f 6e20 6672 6f6d 2059  alization from Y
+00013620: 616d 6164 6120 6574 2061 6c2e 2032 3031  amada et al. 201
+00013630: 330a 2020 2020 0a20 2020 2050 6172 616d  3.    .    Param
+00013640: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00013650: 2d2d 2d2d 0a20 2020 2077 6176 655f 6772  ----.    wave_gr
+00013660: 6964 203a 2061 7272 6179 2d6c 696b 650a  id : array-like.
+00013670: 2020 2020 2020 2020 5761 7665 6c65 6e67          Waveleng
+00013680: 7468 2067 7269 6420 696e 2061 6e67 7374  th grid in angst
+00013690: 726f 6d73 0a20 2020 200a 2020 2020 6365  roms.    .    ce
+000136a0: 6e74 6572 5f75 6d20 3a20 666c 6f61 740a  nter_um : float.
+000136b0: 2020 2020 2020 2020 4365 6e74 7261 6c20          Central 
+000136c0: 7761 7665 6c65 6e67 7468 2069 6e20 6d69  wavelength in mi
+000136d0: 6372 6f6e 730a 2020 2020 0a20 2020 2066  crons.    .    f
+000136e0: 7768 6d20 3a20 666c 6f61 740a 2020 2020  whm : float.    
+000136f0: 2020 2020 4472 7564 6520 7072 6f66 696c      Drude profil
+00013700: 6520 4657 484d 2069 6e20 6d69 6372 6f6e  e FWHM in micron
+00013710: 730a 2020 2020 0a20 2020 2052 6574 7572  s.    .    Retur
+00013720: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00013730: 2020 2070 6168 5f74 656d 706c 203a 2060     pah_templ : `
+00013740: 7e67 7269 7a6c 692e 7574 696c 732e 5370  ~grizli.utils.Sp
+00013750: 6563 7472 756d 5465 6d70 6c61 7465 600a  ectrumTemplate`.
+00013760: 2020 2020 2020 2020 5465 6d70 6c61 7465          Template
+00013770: 2077 6974 6820 7468 6520 5041 4820 6665   with the PAH fe
+00013780: 6174 7572 650a 2020 2020 0a20 2020 2022  ature.    .    "
+00013790: 2222 0a20 2020 2062 7220 3d20 312e 0a20  "".    br = 1.. 
+000137a0: 2020 2067 616d 6d61 5f77 6964 7468 203d     gamma_width =
+000137b0: 2066 7768 6d2f 6365 6e74 6572 5f75 6d0a   fwhm/center_um.
+000137c0: 2020 2020 4976 203d 2062 722a 6761 6d6d      Iv = br*gamm
+000137d0: 615f 7769 6474 682a 2a32 0a20 2020 2049  a_width**2.    I
+000137e0: 7620 2f3d 2028 2877 6176 655f 6772 6964  v /= ((wave_grid
+000137f0: 2f31 2e65 342f 6365 6e74 6572 5f75 6d20  /1.e4/center_um 
+00013800: 2d20 6365 6e74 6572 5f75 6d2a 312e 6534  - center_um*1.e4
+00013810: 2f77 6176 655f 6772 6964 292a 2a32 0a20  /wave_grid)**2. 
+00013820: 2020 2020 2020 2020 2020 2b20 6761 6d6d            + gamm
+00013830: 615f 7769 6474 682a 2a32 290a 0a20 2020  a_width**2)..   
+00013840: 2049 6e6f 726d 203d 206e 702e 7069 2a32   Inorm = np.pi*2
+00013850: 2e39 3965 3134 2f32 2e2a 6272 2a67 616d  .99e14/2.*br*gam
+00013860: 6d61 5f77 6964 7468 2f63 656e 7465 725f  ma_width/center_
+00013870: 756d 0a20 2020 2049 7620 2a3d 2031 202f  um.    Iv *= 1 /
+00013880: 2049 6e6f 726d 0a20 2020 200a 2020 2020   Inorm.    .    
+00013890: 2320 466c 616d 6264 610a 2020 2020 496c  # Flambda.    Il
+000138a0: 616d 203d 2049 7620 2a20 322e 3939 6531  am = Iv * 2.99e1
+000138b0: 3820 2f20 2877 6176 655f 6772 6964 292a  8 / (wave_grid)*
+000138c0: 2a32 0a20 2020 200a 2020 2020 7061 685f  *2.    .    pah_
+000138d0: 7465 6d70 6c20 3d20 5370 6563 7472 756d  templ = Spectrum
+000138e0: 5465 6d70 6c61 7465 2877 6176 653d 7761  Template(wave=wa
+000138f0: 7665 5f67 7269 642c 0a20 2020 2020 2020  ve_grid,.       
+00013900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013910: 2020 2020 2020 2020 2020 666c 7578 3d49            flux=I
+00013920: 6c61 6d2c 200a 2020 2020 2020 2020 2020  lam, .          
+00013930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013940: 2020 2020 2020 206e 616d 653d 6627 6c69         name=f'li
+00013950: 6e65 2050 4148 2d7b 6365 6e74 6572 5f75  ne PAH-{center_u
+00013960: 6d3a 2e32 667d 2729 0a20 2020 2072 6574  m:.2f}').    ret
+00013970: 7572 6e20 7061 685f 7465 6d70 6c0a 0a0a  urn pah_templ...
+00013980: 636c 6173 7320 5370 6563 7472 756d 5465  class SpectrumTe
+00013990: 6d70 6c61 7465 286f 626a 6563 7429 3a0a  mplate(object):.
+000139a0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+000139b0: 2873 656c 662c 2077 6176 653d 4e6f 6e65  (self, wave=None
+000139c0: 2c20 666c 7578 3d4e 6f6e 652c 2063 656e  , flux=None, cen
+000139d0: 7472 616c 5f77 6176 653d 4e6f 6e65 2c20  tral_wave=None, 
+000139e0: 6677 686d 3d4e 6f6e 652c 2076 656c 6f63  fwhm=None, veloc
+000139f0: 6974 793d 4661 6c73 652c 2066 6c75 7875  ity=False, fluxu
+00013a00: 6e69 7473 3d46 4c41 4d42 4441 5f43 4753  nits=FLAMBDA_CGS
+00013a10: 2c20 7761 7665 756e 6974 733d 752e 616e  , waveunits=u.an
+00013a20: 6773 7472 6f6d 2c20 6e61 6d65 3d27 7465  gstrom, name='te
+00013a30: 6d70 6c61 7465 272c 206c 6f72 656e 747a  mplate', lorentz
+00013a40: 3d46 616c 7365 2c20 6572 723d 4e6f 6e65  =False, err=None
+00013a50: 293a 0a20 2020 2020 2020 2022 2222 436f  ):.        """Co
+00013a60: 6e74 6169 6e65 7220 666f 7220 7465 6d70  ntainer for temp
+00013a70: 6c61 7465 2073 7065 6374 7261 2e0a 0a20  late spectra... 
+00013a80: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+00013a90: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00013aa0: 2d2d 2d2d 0a20 2020 2020 2020 2077 6176  ----.        wav
+00013ab0: 6520 3a20 6172 7261 792d 6c69 6b65 0a20  e : array-like. 
+00013ac0: 2020 2020 2020 2020 2020 2057 6176 656c             Wavel
+00013ad0: 656e 6774 680a 2020 2020 2020 2020 2020  ength.          
+00013ae0: 2020 496e 2060 6173 7472 6f70 792e 756e    In `astropy.un
+00013af0: 6974 732e 416e 6773 7472 6f6d 602e 0a0a  its.Angstrom`...
+00013b00: 2020 2020 2020 2020 666c 7578 203a 2066          flux : f
+00013b10: 6c6f 6174 2061 7272 6179 2d6c 696b 650a  loat array-like.
+00013b20: 2020 2020 2020 2020 2020 2020 4966 2066              If f
+00013b30: 6c6f 6174 2c20 7468 656e 2074 6865 2069  loat, then the i
+00013b40: 6e74 6567 7261 7465 6420 666c 7578 206f  ntegrated flux o
+00013b50: 6620 6120 4761 7573 7369 616e 206c 696e  f a Gaussian lin
+00013b60: 652e 2020 4966 0a20 2020 2020 2020 2020  e.  If.         
+00013b70: 2020 2061 7272 6179 2c20 7468 656e 2066     array, then f
+00013b80: 2d6c 616d 6264 6120 666c 7578 2064 656e  -lambda flux den
+00013b90: 7369 7479 2e0a 0a20 2020 2020 2020 2063  sity...        c
+00013ba0: 656e 7472 616c 5f77 6176 652c 2066 7768  entral_wave, fwh
+00013bb0: 6d20 3a20 666c 6f61 740a 2020 2020 2020  m : float.      
+00013bc0: 2020 2020 2020 496e 6974 6961 6c69 7a65        Initialize
+00013bd0: 2074 6865 2074 656d 706c 6174 6520 7769   the template wi
+00013be0: 7468 2061 2047 6175 7373 6961 6e20 6174  th a Gaussian at
+00013bf0: 2074 6869 7320 7761 7665 6c65 6e67 7468   this wavelength
+00013c00: 2028 696e 0a20 2020 2020 2020 2020 2020   (in.           
+00013c10: 2060 6173 7472 6f70 792e 756e 6974 732e   `astropy.units.
+00013c20: 416e 6773 7472 6f6d 602e 2920 7468 6174  Angstrom`.) that
+00013c30: 2068 6173 2061 6e20 696e 7465 6772 6174   has an integrat
+00013c40: 6564 2066 6c75 7820 6f66 2060 666c 7578  ed flux of `flux
+00013c50: 600a 2020 2020 2020 2020 2020 2020 616e  `.            an
+00013c60: 6420 6066 7768 6d60 2069 6e20 6061 7374  d `fwhm` in `ast
+00013c70: 726f 7079 2e75 6e69 7473 2e41 6e67 7374  ropy.units.Angst
+00013c80: 726f 6d60 206f 7220 606b 6d2f 7360 2066  rom` or `km/s` f
+00013c90: 6f72 0a20 2020 2020 2020 2020 2020 2060  or.            `
+00013ca0: 7665 6c6f 6369 7479 3d54 7275 6560 2e0a  velocity=True`..
+00013cb0: 0a20 2020 2020 2020 2076 656c 6f63 6974  .        velocit
+00013cc0: 7920 3a20 626f 6f6c 0a20 2020 2020 2020  y : bool.       
+00013cd0: 2020 2020 2060 6677 686d 6020 6973 2061       `fwhm` is a
+00013ce0: 2076 656c 6f63 6974 7920 696e 2060 6b6d   velocity in `km
+00013cf0: 2f73 602e 0a0a 2020 2020 2020 2020 4174  /s`...        At
+00013d00: 7472 6962 7574 6573 0a20 2020 2020 2020  tributes.       
+00013d10: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00013d20: 2020 2020 7761 7665 2c20 666c 7578 203a      wave, flux :
+00013d30: 2061 7272 6179 2d6c 696b 650a 2020 2020   array-like.    
+00013d40: 2020 2020 2020 2020 5061 7373 6564 2066          Passed f
+00013d50: 726f 6d20 7468 6520 696e 7075 7420 7061  rom the input pa
+00013d60: 7261 6d65 7465 7273 206f 7220 6765 6e65  rameters or gene
+00013d70: 7261 7465 642f 6d6f 6469 6669 6564 206c  rated/modified l
+00013d80: 6174 6572 2e0a 0a20 2020 2020 2020 204d  ater...        M
+00013d90: 6574 686f 6473 0a20 2020 2020 2020 202d  ethods.        -
+00013da0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 205f  ------.        _
+00013db0: 5f61 6464 5f5f 2c20 5f5f 6d75 6c5f 5f20  _add__, __mul__ 
+00013dc0: 3a20 4164 6469 7469 6f6e 2061 6e64 206d  : Addition and m
+00013dd0: 756c 7469 706c 6963 6174 696f 6e20 6f66  ultiplication of
+00013de0: 2074 656d 706c 6174 6573 2e0a 0a20 2020   templates...   
+00013df0: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
+00013e00: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a0a        --------..
+00013e10: 2020 2020 2020 2020 2020 2020 2e2e 2070              .. p
+00013e20: 6c6f 743a 3a0a 2020 2020 2020 2020 2020  lot::.          
+00013e30: 2020 2020 2020 3a69 6e63 6c75 6465 2d73        :include-s
+00013e40: 6f75 7263 653a 0a0a 2020 2020 2020 2020  ource:..        
+00013e50: 2020 2020 2020 2020 696d 706f 7274 206d          import m
+00013e60: 6174 706c 6f74 6c69 622e 7079 706c 6f74  atplotlib.pyplot
+00013e70: 2061 7320 706c 740a 2020 2020 2020 2020   as plt.        
+00013e80: 2020 2020 2020 2020 6672 6f6d 2067 7269          from gri
+00013e90: 7a6c 692e 7574 696c 7320 696d 706f 7274  zli.utils import
+00013ea0: 2053 7065 6374 7275 6d54 656d 706c 6174   SpectrumTemplat
+00013eb0: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+00013ec0: 2020 2068 6120 3d20 5370 6563 7472 756d     ha = Spectrum
+00013ed0: 5465 6d70 6c61 7465 2863 656e 7472 616c  Template(central
+00013ee0: 5f77 6176 653d 3635 3633 2e2c 2066 7768  _wave=6563., fwh
+00013ef0: 6d3d 3130 290a 2020 2020 2020 2020 2020  m=10).          
+00013f00: 2020 2020 2020 706c 742e 706c 6f74 2868        plt.plot(h
+00013f10: 612e 7761 7665 2c20 6861 2e66 6c75 7829  a.wave, ha.flux)
+00013f20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00013f30: 2020 6861 5f7a 203d 2068 612e 7a73 6361    ha_z = ha.zsca
+00013f40: 6c65 2830 2e31 290a 2020 2020 2020 2020  le(0.1).        
+00013f50: 2020 2020 2020 2020 706c 742e 706c 6f74          plt.plot
+00013f60: 2868 615f 7a2e 7761 7665 2c20 6861 5f7a  (ha_z.wave, ha_z
+00013f70: 2e66 6c75 782c 206c 6162 656c 3d27 7a3d  .flux, label='z=
+00013f80: 302e 3127 290a 0a20 2020 2020 2020 2020  0.1')..         
+00013f90: 2020 2020 2020 2070 6c74 2e6c 6567 656e         plt.legen
+00013fa0: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
+00013fb0: 2020 2020 706c 742e 786c 6162 656c 2872      plt.xlabel(r
+00013fc0: 2724 5c6c 616d 6264 6124 2729 0a20 2020  '$\lambda$').   
+00013fd0: 2020 2020 2020 2020 2020 2020 2070 6c74               plt
+00013fe0: 2e78 6c69 6d28 3630 3030 2c20 3735 3030  .xlim(6000, 7500
+00013ff0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014000: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+00014010: 2020 2070 6c74 2e73 686f 7728 290a 0a20     plt.show().. 
+00014020: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00014030: 2020 2073 656c 662e 7761 7665 203d 2077     self.wave = w
+00014040: 6176 650a 2020 2020 2020 2020 6966 2077  ave.        if w
+00014050: 6176 6520 6973 206e 6f74 204e 6f6e 653a  ave is not None:
+00014060: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00014070: 662e 7761 7665 203d 206e 702e 6361 7374  f.wave = np.cast
+00014080: 5b6e 702e 666c 6f61 7436 345d 2877 6176  [np.float64](wav
+00014090: 6529 0a0a 2020 2020 2020 2020 7365 6c66  e)..        self
+000140a0: 2e66 6c75 7820 3d20 666c 7578 0a20 2020  .flux = flux.   
+000140b0: 2020 2020 2069 6620 666c 7578 2069 7320       if flux is 
+000140c0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000140d0: 2020 2020 2020 7365 6c66 2e66 6c75 7820        self.flux 
+000140e0: 3d20 6e70 2e63 6173 745b 6e70 2e66 6c6f  = np.cast[np.flo
+000140f0: 6174 3634 5d28 666c 7578 290a 0a20 2020  at64](flux)..   
+00014100: 2020 2020 2069 6620 6572 7220 6973 206e       if err is n
+00014110: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00014120: 2020 2020 2073 656c 662e 6572 7220 3d20       self.err = 
+00014130: 6e70 2e63 6173 745b 6e70 2e66 6c6f 6174  np.cast[np.float
+00014140: 3634 5d28 6572 7229 0a20 2020 2020 2020  64](err).       
+00014150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014160: 2020 2073 656c 662e 6572 7220 3d20 4e6f     self.err = No
+00014170: 6e65 0a0a 2020 2020 2020 2020 7365 6c66  ne..        self
+00014180: 2e66 7768 6d20 3d20 4e6f 6e65 0a20 2020  .fwhm = None.   
+00014190: 2020 2020 2073 656c 662e 7665 6c6f 6369       self.veloci
+000141a0: 7479 203d 204e 6f6e 650a 0a20 2020 2020  ty = None..     
+000141b0: 2020 2073 656c 662e 666c 7578 756e 6974     self.fluxunit
+000141c0: 7320 3d20 666c 7578 756e 6974 730a 2020  s = fluxunits.  
+000141d0: 2020 2020 2020 7365 6c66 2e77 6176 6575        self.waveu
+000141e0: 6e69 7473 203d 2077 6176 6575 6e69 7473  nits = waveunits
+000141f0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
+00014200: 6d65 203d 206e 616d 650a 0a20 2020 2020  me = name..     
+00014210: 2020 2069 6620 2863 656e 7472 616c 5f77     if (central_w
+00014220: 6176 6520 6973 206e 6f74 204e 6f6e 6529  ave is not None)
+00014230: 2026 2028 6677 686d 2069 7320 6e6f 7420   & (fwhm is not 
+00014240: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
+00014250: 2020 2073 656c 662e 6677 686d 203d 2066     self.fwhm = f
+00014260: 7768 6d0a 2020 2020 2020 2020 2020 2020  whm.            
+00014270: 7365 6c66 2e76 656c 6f63 6974 7920 3d20  self.velocity = 
+00014280: 7665 6c6f 6369 7479 0a0a 2020 2020 2020  velocity..      
+00014290: 2020 2020 2020 7365 6c66 2e77 6176 652c        self.wave,
+000142a0: 2073 656c 662e 666c 7578 203d 2073 656c   self.flux = sel
+000142b0: 662e 6d61 6b65 5f67 6175 7373 6961 6e28  f.make_gaussian(
+000142c0: 6365 6e74 7261 6c5f 7761 7665 2c20 6677  central_wave, fw
+000142d0: 686d 2c0a 2020 2020 2020 2020 2020 2020  hm,.            
+000142e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014300: 2020 2020 2020 2020 2020 7761 7665 5f67            wave_g
+00014310: 7269 643d 7761 7665 2c0a 2020 2020 2020  rid=wave,.      
+00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014350: 7665 6c6f 6369 7479 3d76 656c 6f63 6974  velocity=velocit
+00014360: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00014370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014390: 2020 2020 2020 2020 206d 6178 5f73 6967           max_sig
+000143a0: 6d61 3d35 302c 0a20 2020 2020 2020 2020  ma=50,.         
+000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143d0: 2020 2020 2020 2020 2020 2020 206c 6f72               lor
+000143e0: 656e 747a 3d6c 6f72 656e 747a 290a 0a20  entz=lorentz).. 
+000143f0: 2020 2020 2020 2073 656c 662e 666e 755f         self.fnu_
+00014400: 756e 6974 7320 3d20 464e 555f 4347 530a  units = FNU_CGS.
+00014410: 2020 2020 2020 2020 7365 6c66 2e74 6f5f          self.to_
+00014420: 666e 7528 290a 0a20 2020 2040 7374 6174  fnu()..    @stat
+00014430: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+00014440: 206d 616b 655f 6761 7573 7369 616e 2863   make_gaussian(c
+00014450: 656e 7472 616c 5f77 6176 652c 2066 7768  entral_wave, fwh
+00014460: 6d2c 206d 6178 5f73 6967 6d61 3d35 2c20  m, max_sigma=5, 
+00014470: 7374 6570 3d30 2e31 2c0a 2020 2020 2020  step=0.1,.      
+00014480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014490: 7761 7665 5f67 7269 643d 4e6f 6e65 2c20  wave_grid=None, 
+000144a0: 7665 6c6f 6369 7479 3d46 616c 7365 2c20  velocity=False, 
+000144b0: 636c 6970 3d31 2e65 2d36 2c0a 2020 2020  clip=1.e-6,.    
+000144c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144d0: 2020 6c6f 7265 6e74 7a3d 4661 6c73 6529    lorentz=False)
+000144e0: 3a0a 2020 2020 2020 2020 2222 224d 616b  :.        """Mak
+000144f0: 6520 4761 7573 7369 616e 2074 656d 706c  e Gaussian templ
+00014500: 6174 650a 0a20 2020 2020 2020 2050 6172  ate..        Par
+00014510: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00014520: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+00014530: 2020 2063 656e 7472 616c 5f77 6176 652c     central_wave,
+00014540: 2066 7768 6d20 3a20 4e6f 6e65 206f 7220   fwhm : None or 
+00014550: 666c 6f61 7420 6f72 2061 7272 6179 2d6c  float or array-l
+00014560: 696b 650a 2020 2020 2020 2020 2020 2020  ike.            
+00014570: 4365 6e74 7261 6c20 7761 7665 6c65 6e67  Central waveleng
+00014580: 7468 2061 6e64 2046 5748 4d20 6f66 2074  th and FWHM of t
+00014590: 6865 2064 6573 6972 6564 2047 6175 7373  he desired Gauss
+000145a0: 6961 6e0a 0a20 2020 2020 2020 2076 656c  ian..        vel
+000145b0: 6f63 6974 7920 3a20 626f 6f6c 0a20 2020  ocity : bool.   
+000145c0: 2020 2020 2020 2020 2060 6677 686d 6020           `fwhm` 
+000145d0: 6973 2061 2076 656c 6f63 6974 792e 0a0a  is a velocity...
+000145e0: 2020 2020 2020 2020 6d61 785f 7369 676d          max_sigm
+000145f0: 612c 2073 7465 7020 3a20 666c 6f61 740a  a, step : float.
+00014600: 2020 2020 2020 2020 2020 2020 4765 6e65              Gene
+00014610: 7261 7465 6420 7761 7665 6c65 6e67 7468  rated wavelength
+00014620: 2061 7272 6179 2069 730a 0a20 2020 2020   array is..     
+00014630: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
+00014640: 6d73 203d 2066 7768 6d2f 322e 3335 0a20  ms = fwhm/2.35. 
+00014650: 2020 2020 2020 2020 2020 2020 2020 203e                 >
+00014660: 3e3e 2078 6761 7573 7320 3d20 6e70 2e61  >> xgauss = np.a
+00014670: 7261 6e67 6528 2d6d 6178 5f73 6967 6d61  range(-max_sigma
+00014680: 2c20 6d61 785f 7369 676d 612c 2073 7465  , max_sigma, ste
+00014690: 7029 2a72 6d73 2b63 656e 7472 616c 5f77  p)*rms+central_w
+000146a0: 6176 650a 0a20 2020 2020 2020 2063 6c69  ave..        cli
+000146b0: 7020 3a20 666c 6f61 740a 2020 2020 2020  p : float.      
+000146c0: 2020 2020 2020 436c 6970 2076 616c 7565        Clip value
+000146d0: 7320 7768 6572 6520 7468 6520 7661 6c75  s where the valu
+000146e0: 6520 6f66 2074 6865 2067 6175 7373 6961  e of the gaussia
+000146f0: 6e20 6675 6e63 7469 6f6e 2069 7320 6c65  n function is le
+00014700: 7373 2074 6861 6e0a 2020 2020 2020 2020  ss than.        
+00014710: 2020 2020 6063 6c69 7060 2074 696d 6573      `clip` times
+00014720: 2069 7473 206d 6178 696d 756d 2028 692e   its maximum (i.
+00014730: 652e 2c20 6031 2f73 7172 7428 322a 7069  e., `1/sqrt(2*pi
+00014740: 2a73 6967 6d61 2a2a 3229 6029 2e0a 0a20  *sigma**2)`)... 
+00014750: 2020 2020 2020 206c 6f72 656e 747a 203a         lorentz :
+00014760: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
+00014770: 2020 4d61 6b65 2061 204c 6f72 656e 747a    Make a Lorentz
+00014780: 6961 6e20 6c69 6e65 2069 6e73 7465 6164  ian line instead
+00014790: 206f 6620 6120 4761 7573 7369 616e 2e0a   of a Gaussian..
+000147a0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+000147b0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+000147c0: 0a20 2020 2020 2020 2077 6176 652c 2066  .        wave, f
+000147d0: 6c75 7820 3a20 6172 7261 792d 6c69 6b65  lux : array-like
+000147e0: 0a20 2020 2020 2020 2020 2020 2057 6176  .            Wav
+000147f0: 656c 656e 6774 6820 616e 6420 666c 7578  elength and flux
+00014800: 206f 6620 6120 4761 7573 7369 616e 206c   of a Gaussian l
+00014810: 696e 650a 2020 2020 2020 2020 2222 220a  ine.        """.
+00014820: 2020 2020 2020 2020 696d 706f 7274 2061          import a
+00014830: 7374 726f 7079 2e63 6f6e 7374 616e 7473  stropy.constants
+00014840: 2061 7320 636f 6e73 740a 2020 2020 2020   as const.      
+00014850: 2020 6672 6f6d 2061 7374 726f 7079 2e6d    from astropy.m
+00014860: 6f64 656c 696e 672e 6d6f 6465 6c73 2069  odeling.models i
+00014870: 6d70 6f72 7420 4c6f 7265 6e74 7a31 440a  mport Lorentz1D.
+00014880: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
+00014890: 7474 7228 6677 686d 2c20 2775 6e69 7427  ttr(fwhm, 'unit'
+000148a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000148b0: 6d73 203d 2066 7768 6d2e 7661 6c75 652f  ms = fwhm.value/
+000148c0: 322e 3335 0a20 2020 2020 2020 2020 2020  2.35.           
+000148d0: 2076 656c 6f63 6974 7920 3d20 752e 7068   velocity = u.ph
+000148e0: 7973 6963 616c 2e67 6574 5f70 6879 7369  ysical.get_physi
+000148f0: 6361 6c5f 7479 7065 2866 7768 6d2e 756e  cal_type(fwhm.un
+00014900: 6974 2920 3d3d 2027 7370 6565 6427 0a20  it) == 'speed'. 
+00014910: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+00014920: 6c6f 6369 7479 3a0a 2020 2020 2020 2020  locity:.        
+00014930: 2020 2020 2020 2020 726d 7320 3d20 6365          rms = ce
+00014940: 6e74 7261 6c5f 7761 7665 2a28 6677 686d  ntral_wave*(fwhm
+00014950: 2f63 6f6e 7374 2e63 2e74 6f28 4b4d 5329  /const.c.to(KMS)
+00014960: 292e 7661 6c75 652f 322e 3335 0a20 2020  ).value/2.35.   
+00014970: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00014980: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00014990: 6d73 203d 2066 7768 6d2e 7661 6c75 652f  ms = fwhm.value/
+000149a0: 322e 3335 0a20 2020 2020 2020 2065 6c73  2.35.        els
+000149b0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+000149c0: 6620 7665 6c6f 6369 7479 3a0a 2020 2020  f velocity:.    
+000149d0: 2020 2020 2020 2020 2020 2020 726d 7320              rms 
+000149e0: 3d20 6365 6e74 7261 6c5f 7761 7665 2a28  = central_wave*(
+000149f0: 6677 686d 2f63 6f6e 7374 2e63 2e74 6f28  fwhm/const.c.to(
+00014a00: 4b4d 5329 2e76 616c 7565 292f 322e 3335  KMS).value)/2.35
+00014a10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00014a20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00014a30: 2020 2072 6d73 203d 2066 7768 6d2f 322e     rms = fwhm/2.
+00014a40: 3335 0a0a 2020 2020 2020 2020 6966 2077  35..        if w
+00014a50: 6176 655f 6772 6964 2069 7320 4e6f 6e65  ave_grid is None
+00014a60: 3a0a 2020 2020 2020 2020 2020 2020 2370  :.            #p
+00014a70: 7269 6e74 2827 7878 7820 6c69 6e65 272c  rint('xxx line',
+00014a80: 2063 656e 7472 616c 5f77 6176 652c 206d   central_wave, m
+00014a90: 6178 5f73 6967 6d61 2c20 726d 7329 0a0a  ax_sigma, rms)..
+00014aa0: 2020 2020 2020 2020 2020 2020 7761 7665              wave
+00014ab0: 5f67 7269 6420 3d20 6e70 2e61 7261 6e67  _grid = np.arang
+00014ac0: 6528 2d6d 6178 5f73 6967 6d61 2c20 6d61  e(-max_sigma, ma
+00014ad0: 785f 7369 676d 612c 2073 7465 7029 2a72  x_sigma, step)*r
+00014ae0: 6d73 0a20 2020 2020 2020 2020 2020 2077  ms.            w
+00014af0: 6176 655f 6772 6964 202b 3d20 6365 6e74  ave_grid += cent
+00014b00: 7261 6c5f 7761 7665 0a20 2020 2020 2020  ral_wave.       
+00014b10: 2020 2020 2077 6176 655f 6772 6964 203d       wave_grid =
+00014b20: 206e 702e 6873 7461 636b 285b 3931 2e2c   np.hstack([91.,
+00014b30: 2077 6176 655f 6772 6964 2c20 312e 6538   wave_grid, 1.e8
+00014b40: 5d29 0a0a 2020 2020 2020 2020 6966 206c  ])..        if l
+00014b50: 6f72 656e 747a 3a0a 2020 2020 2020 2020  orentz:.        
+00014b60: 2020 2020 6966 2076 656c 6f63 6974 793a      if velocity:
+00014b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014b80: 2075 7365 5f66 7768 6d20 3d20 6365 6e74   use_fwhm = cent
+00014b90: 7261 6c5f 7761 7665 2a28 6677 686d 2f63  ral_wave*(fwhm/c
+00014ba0: 6f6e 7374 2e63 2e74 6f28 4b4d 5329 2e76  onst.c.to(KMS).v
+00014bb0: 616c 7565 290a 2020 2020 2020 2020 2020  alue).          
+00014bc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00014bd0: 2020 2020 2020 2020 7573 655f 6677 686d          use_fwhm
+00014be0: 203d 2066 7768 6d0a 0a20 2020 2020 2020   = fwhm..       
+00014bf0: 2020 2020 206c 6d6f 6465 6c20 3d20 4c6f       lmodel = Lo
+00014c00: 7265 6e74 7a31 4428 616d 706c 6974 7564  rentz1D(amplitud
+00014c10: 653d 312c 2078 5f30 3d63 656e 7472 616c  e=1, x_0=central
+00014c20: 5f77 6176 652c 2066 7768 6d3d 7573 655f  _wave, fwhm=use_
+00014c30: 6677 686d 290a 2020 2020 2020 2020 2020  fwhm).          
+00014c40: 2020 6c69 6e65 203d 206c 6d6f 6465 6c28    line = lmodel(
+00014c50: 7761 7665 5f67 7269 6429 0a20 2020 2020  wave_grid).     
+00014c60: 2020 2020 2020 206c 696e 655b 303a 325d         line[0:2]
+00014c70: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+00014c80: 206c 696e 655b 2d32 3a5d 203d 2030 0a20   line[-2:] = 0. 
+00014c90: 2020 2020 2020 2020 2020 206c 696e 6520             line 
+00014ca0: 2f3d 206e 702e 7472 6170 7a28 6c69 6e65  /= np.trapz(line
+00014cb0: 2c20 7761 7665 5f67 7269 6429 0a20 2020  , wave_grid).   
+00014cc0: 2020 2020 2020 2020 2070 6561 6b20 3d20           peak = 
+00014cd0: 6c69 6e65 2e6d 6178 2829 0a20 2020 2020  line.max().     
+00014ce0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00014cf0: 2020 2020 2023 2047 6175 7373 6961 6e0a       # Gaussian.
+00014d00: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00014d10: 203d 206e 702e 6578 7028 2d28 7761 7665   = np.exp(-(wave
+00014d20: 5f67 7269 642d 6365 6e74 7261 6c5f 7761  _grid-central_wa
+00014d30: 7665 292a 2a32 2f32 2f72 6d73 2a2a 3229  ve)**2/2/rms**2)
+00014d40: 0a20 2020 2020 2020 2020 2020 2070 6561  .            pea
+00014d50: 6b20 3d20 6e70 2e73 7172 7428 322a 6e70  k = np.sqrt(2*np
+00014d60: 2e70 692a 726d 732a 2a32 290a 2020 2020  .pi*rms**2).    
+00014d70: 2020 2020 2020 2020 6c69 6e65 202a 3d20          line *= 
+00014d80: 312e 2f70 6561 6b20 2023 206e 702e 7371  1./peak  # np.sq
+00014d90: 7274 2832 2a6e 702e 7069 2a72 6d73 2a2a  rt(2*np.pi*rms**
+00014da0: 3229 0a0a 2020 2020 2020 2020 6c69 6e65  2)..        line
+00014db0: 5b6c 696e 6520 3c20 312e 2f70 6561 6b2a  [line < 1./peak*
+00014dc0: 636c 6970 5d20 3d20 300a 0a20 2020 2020  clip] = 0..     
+00014dd0: 2020 2072 6574 7572 6e20 7761 7665 5f67     return wave_g
+00014de0: 7269 642c 206c 696e 650a 0a20 2020 2020  rid, line..     
+00014df0: 2020 2023 7365 6c66 2e77 6176 6520 3d20     #self.wave = 
+00014e00: 7867 6175 7373 0a20 2020 2020 2020 2023  xgauss.        #
+00014e10: 7365 6c66 2e66 6c75 7820 3d20 6761 7573  self.flux = gaus
+00014e20: 7369 616e 0a0a 2020 2020 6465 6620 7a73  sian..    def zs
+00014e30: 6361 6c65 2873 656c 662c 207a 2c20 7363  cale(self, z, sc
+00014e40: 616c 6172 3d31 2c20 6170 706c 795f 6967  alar=1, apply_ig
+00014e50: 6d3d 5472 7565 293a 0a20 2020 2020 2020  m=True):.       
+00014e60: 2022 2222 5265 6473 6869 6674 2074 6865   """Redshift the
+00014e70: 2074 656d 706c 6174 6520 616e 6420 6d75   template and mu
+00014e80: 6c74 6970 6c79 2062 7920 6120 7363 616c  ltiply by a scal
+00014e90: 6172 2e0a 0a20 2020 2020 2020 2050 6172  ar...        Par
+00014ea0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00014eb0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+00014ec0: 2020 207a 203a 2066 6c6f 6174 0a20 2020     z : float.   
+00014ed0: 2020 2020 2020 2020 2052 6564 7368 6966           Redshif
+00014ee0: 7420 746f 2075 7365 2e0a 0a20 2020 2020  t to use...     
+00014ef0: 2020 2073 6361 6c61 7220 3a20 666c 6f61     scalar : floa
+00014f00: 740a 2020 2020 2020 2020 2020 2020 4d75  t.            Mu
+00014f10: 6c74 6970 6c69 6361 7469 7665 2066 6163  ltiplicative fac
+00014f20: 746f 722e 2020 4164 6469 7469 6f6e 616c  tor.  Additional
+00014f30: 2066 6163 746f 7220 6f66 2031 2e2f 2831   factor of 1./(1
+00014f40: 2b7a 2920 6973 2069 6d70 6c69 6369 742e  +z) is implicit.
+00014f50: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00014f60: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00014f70: 2d0a 2020 2020 2020 2020 6e65 775f 7370  -.        new_sp
+00014f80: 6563 7472 756d 203a 2060 7e67 7269 7a6c  ectrum : `~grizl
+00014f90: 692e 7574 696c 732e 5370 6563 7472 756d  i.utils.Spectrum
+00014fa0: 5465 6d70 6c61 7465 600a 2020 2020 2020  Template`.      
+00014fb0: 2020 2020 2020 5265 6473 6869 6674 6564        Redshifted
+00014fc0: 2061 6e64 2073 6361 6c65 6420 7370 6563   and scaled spec
+00014fd0: 7472 756d 2e0a 0a20 2020 2020 2020 2022  trum...        "
+00014fe0: 2222 0a20 2020 2020 2020 2069 6620 6170  "".        if ap
+00014ff0: 706c 795f 6967 6d3a 0a20 2020 2020 2020  ply_igm:.       
+00015000: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00015010: 2020 2020 2020 2020 2020 696d 706f 7274            import
+00015020: 2065 617a 792e 6967 6d0a 2020 2020 2020   eazy.igm.      
+00015030: 2020 2020 2020 2020 2020 6967 6d20 3d20            igm = 
+00015040: 6561 7a79 2e69 676d 2e49 6e6f 7565 3134  eazy.igm.Inoue14
+00015050: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00015060: 2020 2069 676d 7a20 3d20 6967 6d2e 6675     igmz = igm.fu
+00015070: 6c6c 5f49 474d 287a 2c20 7365 6c66 2e77  ll_IGM(z, self.w
+00015080: 6176 652a 2831 2b7a 2929 0a20 2020 2020  ave*(1+z)).     
+00015090: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+000150a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000150b0: 676d 7a20 3d20 312e 0a20 2020 2020 2020  gmz = 1..       
+000150c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000150d0: 2020 2069 676d 7a20 3d20 312e 0a0a 2020     igmz = 1...  
+000150e0: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
+000150f0: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
+00015100: 7665 3d73 656c 662e 7761 7665 2a28 312b  ve=self.wave*(1+
+00015110: 7a29 2c0a 2020 2020 2020 2020 2020 2020  z),.            
+00015120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015130: 2020 2020 666c 7578 3d73 656c 662e 666c      flux=self.fl
+00015140: 7578 2a73 6361 6c61 722f 2831 2b7a 292a  ux*scalar/(1+z)*
+00015150: 6967 6d7a 290a 0a0a 2020 2020 6465 6620  igmz)...    def 
+00015160: 5f5f 6164 645f 5f28 7365 6c66 2c20 7370  __add__(self, sp
+00015170: 6563 7472 756d 293a 0a20 2020 2020 2020  ectrum):.       
+00015180: 2022 2222 4164 6420 7477 6f20 7465 6d70   """Add two temp
+00015190: 6c61 7465 7320 746f 6765 7468 6572 0a0a  lates together..
+000151a0: 2020 2020 2020 2020 5468 6520 6e65 7720          The new 
+000151b0: 7761 7665 6c65 6e67 7468 2061 7272 6179  wavelength array
+000151c0: 2069 7320 7468 6520 756e 696f 6e20 6f66   is the union of
+000151d0: 2062 6f74 6820 696e 7075 7420 7370 6563   both input spec
+000151e0: 7472 6120 616e 6420 6561 6368 0a20 2020  tra and each.   
+000151f0: 2020 2020 2069 6e70 7574 2073 7065 6374       input spect
+00015200: 7275 6d20 6973 206c 696e 6561 726c 7920  rum is linearly 
+00015210: 696e 7465 7270 6f6c 6174 6564 2074 6f20  interpolated to 
+00015220: 7468 6520 6669 6e61 6c20 6772 6964 2e0a  the final grid..
+00015230: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00015240: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+00015250: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2073  ------.        s
+00015260: 7065 6374 7275 6d20 3a20 607e 6772 697a  pectrum : `~griz
+00015270: 6c69 2e75 7469 6c73 2e53 7065 6374 7275  li.utils.Spectru
+00015280: 6d54 656d 706c 6174 6560 0a0a 2020 2020  mTemplate`..    
+00015290: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+000152a0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+000152b0: 2020 2020 6e65 775f 7370 6563 7472 756d      new_spectrum
+000152c0: 203a 2060 7e67 7269 7a6c 692e 7574 696c   : `~grizli.util
+000152d0: 732e 5370 6563 7472 756d 5465 6d70 6c61  s.SpectrumTempla
+000152e0: 7465 600a 2020 2020 2020 2020 2222 220a  te`.        """.
+000152f0: 2020 2020 2020 2020 6e65 775f 7761 7665          new_wave
+00015300: 203d 206e 702e 756e 6971 7565 286e 702e   = np.unique(np.
+00015310: 6170 7065 6e64 2873 656c 662e 7761 7665  append(self.wave
+00015320: 2c20 7370 6563 7472 756d 2e77 6176 6529  , spectrum.wave)
+00015330: 290a 2020 2020 2020 2020 6e65 775f 7761  ).        new_wa
+00015340: 7665 2e73 6f72 7428 290a 0a20 2020 2020  ve.sort()..     
+00015350: 2020 206e 6577 5f66 6c75 7820 3d20 6e70     new_flux = np
+00015360: 2e69 6e74 6572 7028 6e65 775f 7761 7665  .interp(new_wave
+00015370: 2c20 7365 6c66 2e77 6176 652c 2073 656c  , self.wave, sel
+00015380: 662e 666c 7578 290a 2020 2020 2020 2020  f.flux).        
+00015390: 6e65 775f 666c 7578 202b 3d20 6e70 2e69  new_flux += np.i
+000153a0: 6e74 6572 7028 6e65 775f 7761 7665 2c20  nterp(new_wave, 
+000153b0: 7370 6563 7472 756d 2e77 6176 652c 2073  spectrum.wave, s
+000153c0: 7065 6374 7275 6d2e 666c 7578 290a 2020  pectrum.flux).  
+000153d0: 2020 2020 2020 6f75 7420 3d20 5370 6563        out = Spec
+000153e0: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
+000153f0: 653d 6e65 775f 7761 7665 2c20 666c 7578  e=new_wave, flux
+00015400: 3d6e 6577 5f66 6c75 7829 0a20 2020 2020  =new_flux).     
+00015410: 2020 206f 7574 2e66 7768 6d20 3d20 7370     out.fwhm = sp
+00015420: 6563 7472 756d 2e66 7768 6d0a 2020 2020  ectrum.fwhm.    
+00015430: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
+00015440: 0a20 2020 2064 6566 205f 5f6d 756c 5f5f  .    def __mul__
+00015450: 2873 656c 662c 2073 6361 6c61 7229 3a0a  (self, scalar):.
+00015460: 2020 2020 2020 2020 2222 224d 756c 7469          """Multi
+00015470: 706c 7920 7370 6563 7472 756d 2062 7920  ply spectrum by 
+00015480: 6120 7363 616c 6172 2076 616c 7565 0a0a  a scalar value..
+00015490: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+000154a0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+000154b0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 7363  -----.        sc
+000154c0: 616c 6172 203a 2066 6c6f 6174 0a20 2020  alar : float.   
+000154d0: 2020 2020 2020 2020 2046 6163 746f 7220           Factor 
+000154e0: 746f 206d 756c 7469 7079 2074 6f20 6073  to multipy to `s
+000154f0: 656c 662e 666c 7578 602e 0a0a 2020 2020  elf.flux`...    
+00015500: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00015510: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00015520: 2020 2020 6e65 775f 7370 6563 7472 756d      new_spectrum
+00015530: 203a 2060 7e67 7269 7a6c 692e 7574 696c   : `~grizli.util
+00015540: 732e 5370 6563 7472 756d 5465 6d70 6c61  s.SpectrumTempla
+00015550: 7465 600a 2020 2020 2020 2020 2222 220a  te`.        """.
+00015560: 2020 2020 2020 2020 6f75 7420 3d20 5370          out = Sp
+00015570: 6563 7472 756d 5465 6d70 6c61 7465 2877  ectrumTemplate(w
+00015580: 6176 653d 7365 6c66 2e77 6176 652c 2066  ave=self.wave, f
+00015590: 6c75 783d 7365 6c66 2e66 6c75 782a 7363  lux=self.flux*sc
+000155a0: 616c 6172 290a 2020 2020 2020 2020 6f75  alar).        ou
+000155b0: 742e 6677 686d 203d 2073 656c 662e 6677  t.fwhm = self.fw
+000155c0: 686d 0a20 2020 2020 2020 2072 6574 7572  hm.        retur
+000155d0: 6e20 6f75 740a 0a0a 2020 2020 6465 6620  n out...    def 
+000155e0: 746f 5f66 6e75 2873 656c 662c 2066 6e75  to_fnu(self, fnu
+000155f0: 5f75 6e69 7473 3d46 4e55 5f43 4753 293a  _units=FNU_CGS):
+00015600: 0a20 2020 2020 2020 2022 2222 4d61 6b65  .        """Make
+00015610: 2066 6e75 2076 6572 7369 6f6e 206f 6620   fnu version of 
+00015620: 7468 6520 7465 6d70 6c61 7465 2e0a 0a20  the template... 
+00015630: 2020 2020 2020 2053 6574 7320 7468 6520         Sets the 
+00015640: 6066 6c75 785f 666e 7560 2061 7474 7269  `flux_fnu` attri
+00015650: 6275 7465 2c20 6173 7375 6d69 6e67 2074  bute, assuming t
+00015660: 6861 7420 7468 6520 7761 7665 6c65 6e67  hat the waveleng
+00015670: 7468 2069 7320 6769 7665 6e0a 2020 2020  th is given.    
+00015680: 2020 2020 696e 2041 6e67 7374 726f 6d20      in Angstrom 
+00015690: 616e 6420 7468 6520 666c 7578 2069 7320  and the flux is 
+000156a0: 6769 7665 6e20 696e 2066 6c61 6d62 6461  given in flambda
+000156b0: 3a0a 0a20 2020 2020 2020 2020 2020 203e  :..            >
+000156c0: 3e3e 2066 6c75 785f 666e 7520 3d20 7365  >> flux_fnu = se
+000156d0: 6c66 2e66 6c75 7820 2a20 7365 6c66 2e77  lf.flux * self.w
+000156e0: 6176 652a 2a32 202f 2033 2e65 3138 0a0a  ave**2 / 3.e18..
+000156f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00015700: 2020 2020 2369 6d70 6f72 7420 6173 7472      #import astr
+00015710: 6f70 792e 636f 6e73 7461 6e74 7320 6173  opy.constants as
+00015720: 2063 6f6e 7374 0a20 2020 2020 2020 2023   const.        #
+00015730: 666c 7578 5f66 6e75 203d 2073 656c 662e  flux_fnu = self.
+00015740: 666c 7578 202a 2073 656c 662e 7761 7665  flux * self.wave
+00015750: 2a2a 3220 2f20 332e 6531 380a 2020 2020  **2 / 3.e18.    
+00015760: 2020 2020 2320 666c 7578 5f66 6e75 203d      # flux_fnu =
+00015770: 2028 7365 6c66 2e66 6c75 782a 7365 6c66   (self.flux*self
+00015780: 2e66 6c75 7875 6e69 7473 2a28 7365 6c66  .fluxunits*(self
+00015790: 2e77 6176 652a 7365 6c66 2e77 6176 6575  .wave*self.waveu
+000157a0: 6e69 7473 292a 2a32 2f63 6f6e 7374 2e63  nits)**2/const.c
+000157b0: 292e 746f 2846 4e55 5f43 4753 2920 232c  ).to(FNU_CGS) #,
+000157c0: 0a0a 2020 2020 2020 2020 6966 2028 2846  ..        if ((F
+000157d0: 4e55 5f43 4753 2e5f 5f73 7472 5f5f 2829  NU_CGS.__str__()
+000157e0: 203d 3d20 2765 7267 202f 2028 636d 3220   == 'erg / (cm2 
+000157f0: 487a 2073 2927 2920 260a 2020 2020 2020  Hz s)') &.      
+00015800: 2020 2020 2020 2028 7365 6c66 2e66 6c75         (self.flu
+00015810: 7875 6e69 7473 2e5f 5f73 7472 5f5f 2829  xunits.__str__()
+00015820: 203d 3d20 2765 7267 202f 2028 416e 6773   == 'erg / (Angs
+00015830: 7472 6f6d 2063 6d32 2073 2927 2929 3a0a  trom cm2 s)')):.
+00015840: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
+00015850: 7374 6572 0a20 2020 2020 2020 2020 2020  ster.           
+00015860: 2066 6c75 785f 666e 7520 3d20 7365 6c66   flux_fnu = self
+00015870: 2e66 6c75 782a 7365 6c66 2e77 6176 652a  .flux*self.wave*
+00015880: 2a32 2f32 2e39 3937 3932 3435 3865 3138  *2/2.99792458e18
+00015890: 2a66 6e75 5f75 6e69 7473 0a20 2020 2020  *fnu_units.     
+000158a0: 2020 2020 2020 2069 6620 7365 6c66 2e65         if self.e
+000158b0: 7272 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rr is not None:.
+000158c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158d0: 6572 725f 666e 7520 3d20 7365 6c66 2e65  err_fnu = self.e
+000158e0: 7272 2a73 656c 662e 7761 7665 2a2a 322f  rr*self.wave**2/
+000158f0: 322e 3939 3739 3234 3538 6531 382a 666e  2.99792458e18*fn
+00015900: 755f 756e 6974 730a 2020 2020 2020 2020  u_units.        
+00015910: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015920: 2020 2320 5573 6520 6173 7472 6f70 7920    # Use astropy 
+00015930: 636f 6e76 6572 7369 6f6e 0a20 2020 2020  conversion.     
+00015940: 2020 2020 2020 2066 6c75 785f 666e 7520         flux_fnu 
+00015950: 3d20 2873 656c 662e 666c 7578 2a73 656c  = (self.flux*sel
+00015960: 662e 666c 7578 756e 6974 7329 2e74 6f28  f.fluxunits).to(
+00015970: 666e 755f 756e 6974 732c 2065 7175 6976  fnu_units, equiv
+00015980: 616c 656e 6369 6573 3d75 2e73 7065 6374  alencies=u.spect
+00015990: 7261 6c5f 6465 6e73 6974 7928 7365 6c66  ral_density(self
+000159a0: 2e77 6176 652a 7365 6c66 2e77 6176 6575  .wave*self.waveu
+000159b0: 6e69 7473 2929 0a20 2020 2020 2020 2020  nits)).         
+000159c0: 2020 2069 6620 7365 6c66 2e65 7272 2069     if self.err i
+000159d0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000159e0: 2020 2020 2020 2020 2020 2020 6572 725f              err_
+000159f0: 666e 7520 3d20 2873 656c 662e 6572 722a  fnu = (self.err*
+00015a00: 7365 6c66 2e66 6c75 7875 6e69 7473 292e  self.fluxunits).
+00015a10: 746f 2866 6e75 5f75 6e69 7473 2c20 6571  to(fnu_units, eq
+00015a20: 7569 7661 6c65 6e63 6965 733d 752e 7370  uivalencies=u.sp
+00015a30: 6563 7472 616c 5f64 656e 7369 7479 2873  ectral_density(s
+00015a40: 656c 662e 7761 7665 2a73 656c 662e 7761  elf.wave*self.wa
+00015a50: 7665 756e 6974 7329 290a 0a20 2020 2020  veunits))..     
+00015a60: 2020 2073 656c 662e 666e 755f 756e 6974     self.fnu_unit
+00015a70: 7320 3d20 666e 755f 756e 6974 730a 2020  s = fnu_units.  
+00015a80: 2020 2020 2020 7365 6c66 2e66 6c75 785f        self.flux_
+00015a90: 666e 7520 3d20 666c 7578 5f66 6e75 2e76  fnu = flux_fnu.v
+00015aa0: 616c 7565 0a20 2020 2020 2020 2069 6620  alue.        if 
+00015ab0: 7365 6c66 2e65 7272 2069 7320 6e6f 7420  self.err is not 
+00015ac0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00015ad0: 2020 7365 6c66 2e65 7272 5f66 6e75 203d    self.err_fnu =
+00015ae0: 2065 7272 5f66 6e75 2e76 616c 7565 0a20   err_fnu.value. 
+00015af0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00015b00: 2020 2020 2020 2020 2073 656c 662e 6572           self.er
+00015b10: 725f 666e 7520 3d20 4e6f 6e65 0a0a 0a20  r_fnu = None... 
+00015b20: 2020 2064 6566 2069 6e74 6567 7261 7465     def integrate
+00015b30: 5f66 696c 7465 7228 7365 6c66 2c20 6669  _filter(self, fi
+00015b40: 6c74 6572 2c20 6162 6d61 673d 4661 6c73  lter, abmag=Fals
+00015b50: 652c 2075 7365 5f77 6176 653d 2766 696c  e, use_wave='fil
+00015b60: 7465 7227 293a 0a20 2020 2020 2020 2022  ter'):.        "
+00015b70: 2222 496e 7465 6772 6174 6520 7468 6520  ""Integrate the 
+00015b80: 7465 6d70 6c61 7465 2074 6872 6f75 6768  template through
+00015b90: 2061 6e20 607e 6561 7a79 2e46 696c 7465   an `~eazy.Filte
+00015ba0: 7244 6566 696e 6974 696f 6e60 2066 696c  rDefinition` fil
+00015bb0: 7465 720a 2020 2020 2020 2020 6f62 6a65  ter.        obje
+00015bc0: 6374 2e0a 0a20 2020 2020 2020 2050 6172  ct...        Par
+00015bd0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00015be0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+00015bf0: 2020 2066 696c 7465 7220 3a20 607e 7079     filter : `~py
+00015c00: 7379 6e70 686f 742e 4f62 7342 616e 6470  synphot.ObsBandp
+00015c10: 6173 7360 0a20 2020 2020 2020 2020 2020  ass`.           
+00015c20: 204f 7220 616e 7920 6f62 6a65 6374 2074   Or any object t
+00015c30: 6861 7420 6861 7320 6077 6176 6560 2061  hat has `wave` a
+00015c40: 6e64 2060 7468 726f 7567 6870 7574 6020  nd `throughput` 
+00015c50: 6174 7472 6962 7574 6573 2c20 7769 7468  attributes, with
+00015c60: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+00015c70: 2066 6f72 6d65 7220 696e 2074 6865 2073   former in the s
+00015c80: 616d 6520 756e 6974 7320 6173 2074 6865  ame units as the
+00015c90: 2069 6e70 7574 2073 7065 6374 7275 6d2e   input spectrum.
+00015ca0: 0a0a 2020 2020 2020 2020 6162 6d61 6720  ..        abmag 
+00015cb0: 3a20 626f 6f6c 0a20 2020 2020 2020 2020  : bool.         
+00015cc0: 2020 2052 6574 7572 6e20 4142 206d 6167     Return AB mag
+00015cd0: 6e69 7475 6465 2072 6174 6865 7220 7468  nitude rather th
+00015ce0: 616e 2066 6e75 2066 6c75 780a 0a20 2020  an fnu flux..   
+00015cf0: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
+00015d00: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
+00015d10: 2020 2020 2074 656d 705f 666c 7578 203a       temp_flux :
+00015d20: 2066 6c6f 6174 0a0a 2020 2020 2020 2020   float..        
+00015d30: 4578 616d 706c 6573 0a20 2020 2020 2020  Examples.       
+00015d40: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+00015d50: 2020 436f 6d70 7574 6520 7468 6520 5746    Compute the WF
+00015d60: 4333 2f49 5220 4631 3430 5720 4142 206d  C3/IR F140W AB m
+00015d70: 6167 6e69 7475 6465 206f 6620 6120 7075  agnitude of a pu
+00015d80: 7265 2065 6d69 7373 696f 6e20 6c69 6e65  re emission line
+00015d90: 2061 7420 7468 650a 2020 2020 2020 2020   at the.        
+00015da0: 352d 7369 676d 6120 3344 2d48 5354 206c  5-sigma 3D-HST l
+00015db0: 696e 6520 6465 7465 6374 696f 6e20 6c69  ine detection li
+00015dc0: 6d69 7420 2835 652d 3137 2065 7267 2f73  mit (5e-17 erg/s
+00015dd0: 2f63 6d32 293a 0a0a 2020 2020 2020 2020  /cm2):..        
+00015de0: 3e3e 3e20 696d 706f 7274 206e 756d 7079  >>> import numpy
+00015df0: 2061 7320 6e70 0a20 2020 2020 2020 203e   as np.        >
+00015e00: 3e3e 2066 726f 6d20 6772 697a 6c69 2e75  >> from grizli.u
+00015e10: 7469 6c73 2069 6d70 6f72 7420 5370 6563  tils import Spec
+00015e20: 7472 756d 5465 6d70 6c61 7465 0a20 2020  trumTemplate.   
+00015e30: 2020 2020 203e 3e3e 2066 726f 6d20 6561       >>> from ea
+00015e40: 7a79 2e66 696c 7465 7273 2069 6d70 6f72  zy.filters impor
+00015e50: 7420 4669 6c74 6572 4465 6669 6e69 7469  t FilterDefiniti
+00015e60: 6f6e 0a20 2020 2020 2020 203e 3e3e 2069  on.        >>> i
+00015e70: 6d70 6f72 7420 7079 7379 6e70 686f 7420  mport pysynphot 
+00015e80: 6173 2053 0a20 2020 2020 2020 203e 3e3e  as S.        >>>
+00015e90: 206c 696e 6520 3d20 5370 6563 7472 756d   line = Spectrum
+00015ea0: 5465 6d70 6c61 7465 2863 656e 7472 616c  Template(central
+00015eb0: 5f77 6176 653d 312e 3465 342c 2066 7768  _wave=1.4e4, fwh
+00015ec0: 6d3d 3135 302e 2c0a 2020 2020 2020 2020  m=150.,.        
+00015ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ee0: 2020 2020 2020 2020 2020 2020 7665 6c6f              velo
+00015ef0: 6369 7479 3d54 7275 6529 2a35 2e65 2d31  city=True)*5.e-1
+00015f00: 370a 2020 2020 2020 2020 3e3e 3e20 6669  7.        >>> fi
+00015f10: 6c74 6572 203d 2046 696c 7465 7244 6566  lter = FilterDef
+00015f20: 696e 6974 696f 6e28 6270 3d53 2e4f 6273  inition(bp=S.Obs
+00015f30: 4261 6e64 7061 7373 2827 7766 6333 2c69  Bandpass('wfc3,i
+00015f40: 722c 6631 3430 7727 2929 0a20 2020 2020  r,f140w')).     
+00015f50: 2020 203e 3e3e 2066 6e75 203d 206c 696e     >>> fnu = lin
+00015f60: 652e 696e 7465 6772 6174 655f 6669 6c74  e.integrate_filt
+00015f70: 6572 2866 696c 7465 7229 0a20 2020 2020  er(filter).     
+00015f80: 2020 203e 3e3e 2070 7269 6e74 2827 4142     >>> print('AB
+00015f90: 206d 6167 203d 207b 303a 2e33 667d 272e   mag = {0:.3f}'.
+00015fa0: 666f 726d 6174 282d 322e 352a 6e70 2e6c  format(-2.5*np.l
+00015fb0: 6f67 3130 2866 6e75 292d 3438 2e36 2929  og10(fnu)-48.6))
+00015fc0: 0a20 2020 2020 2020 2041 4220 6d61 6720  .        AB mag 
+00015fd0: 3d20 3236 2e36 3139 0a0a 2020 2020 2020  = 26.619..      
+00015fe0: 2020 2222 220a 2020 2020 2020 2020 494e    """.        IN
+00015ff0: 5445 4752 4154 4f52 203d 206e 702e 7472  TEGRATOR = np.tr
+00016000: 6170 7a0a 0a20 2020 2020 2020 2074 7279  apz..        try
+00016010: 3a0a 2020 2020 2020 2020 2020 2020 2369  :.            #i
+00016020: 6d70 6f72 7420 6772 697a 6c69 2e75 7469  mport grizli.uti
+00016030: 6c73 5f63 0a20 2020 2020 2020 2020 2020  ls_c.           
+00016040: 2023 696e 7465 7270 203d 2067 7269 7a6c   #interp = grizl
+00016050: 692e 7574 696c 735f 632e 696e 7465 7270  i.utils_c.interp
+00016060: 2e69 6e74 6572 705f 636f 6e73 6572 7665  .interp_conserve
+00016070: 5f63 0a20 2020 2020 2020 2020 2020 2066  _c.            f
+00016080: 726f 6d20 2e75 7469 6c73 5f63 2e69 6e74  rom .utils_c.int
+00016090: 6572 7020 696d 706f 7274 2069 6e74 6572  erp import inter
+000160a0: 705f 636f 6e73 6572 7665 5f63 0a20 2020  p_conserve_c.   
+000160b0: 2020 2020 2020 2020 2069 6e74 6572 7020           interp 
+000160c0: 3d20 696e 7465 7270 5f63 6f6e 7365 7276  = interp_conserv
+000160d0: 655f 630a 2020 2020 2020 2020 6578 6365  e_c.        exce
+000160e0: 7074 2049 6d70 6f72 7445 7272 6f72 3a0a  pt ImportError:.
+000160f0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00016100: 7270 203d 206e 702e 696e 7465 7270 0a0a  rp = np.interp..
+00016110: 2020 2020 2020 2020 2377 7a20 3d20 7365          #wz = se
+00016120: 6c66 2e77 6176 652a 2831 2b7a 290a 2020  lf.wave*(1+z).  
+00016130: 2020 2020 2020 6e6f 6e7a 6572 6f20 3d20        nonzero = 
+00016140: 6669 6c74 6572 2e74 6872 6f75 6768 7075  filter.throughpu
+00016150: 7420 3e20 300a 2020 2020 2020 2020 6966  t > 0.        if
+00016160: 2028 6669 6c74 6572 2e77 6176 655b 6e6f   (filter.wave[no
+00016170: 6e7a 6572 6f5d 2e6d 696e 2829 203e 2073  nzero].min() > s
+00016180: 656c 662e 7761 7665 2e6d 6178 2829 2920  elf.wave.max()) 
+00016190: 7c20 2866 696c 7465 722e 7761 7665 5b6e  | (filter.wave[n
+000161a0: 6f6e 7a65 726f 5d2e 6d61 7828 2920 3c20  onzero].max() < 
+000161b0: 7365 6c66 2e77 6176 652e 6d69 6e28 2929  self.wave.min())
+000161c0: 207c 2028 6669 6c74 6572 2e77 6176 655b   | (filter.wave[
+000161d0: 6e6f 6e7a 6572 6f5d 2e6d 696e 2829 203c  nonzero].min() <
+000161e0: 2073 656c 662e 7761 7665 2e6d 696e 2829   self.wave.min()
+000161f0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00016200: 6620 7365 6c66 2e65 7272 2069 7320 4e6f  f self.err is No
+00016210: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00016220: 2020 2020 7265 7475 726e 2030 2e0a 2020      return 0..  
+00016230: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00016240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016250: 7265 7475 726e 2030 2e2c 2030 2e0a 0a20  return 0., 0... 
+00016260: 2020 2020 2020 2069 6620 7573 655f 7761         if use_wa
+00016270: 7665 203d 3d20 2766 696c 7465 7227 3a0a  ve == 'filter':.
+00016280: 2020 2020 2020 2020 2020 2020 2320 496e              # In
+00016290: 7465 7270 6f6c 6174 6520 746f 2066 696c  terpolate to fil
+000162a0: 7465 7220 7761 7665 6c65 6e67 7468 730a  ter wavelengths.
+000162b0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+000162c0: 6772 6174 655f 7761 7665 203d 2066 696c  grate_wave = fil
+000162d0: 7465 722e 7761 7665 0a0a 2020 2020 2020  ter.wave..      
+000162e0: 2020 2020 2020 696e 7465 6772 6174 655f        integrate_
+000162f0: 7465 6d70 6c20 3d20 696e 7465 7270 2866  templ = interp(f
+00016300: 696c 7465 722e 7761 7665 2e61 7374 7970  ilter.wave.astyp
+00016310: 6528 6e70 2e66 6c6f 6174 3634 292c 200a  e(np.float64), .
+00016320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016340: 2020 2020 7365 6c66 2e77 6176 652c 2073      self.wave, s
+00016350: 656c 662e 666c 7578 5f66 6e75 2c20 6c65  elf.flux_fnu, le
+00016360: 6674 3d30 2c20 7269 6768 743d 3029 0a0a  ft=0, right=0)..
+00016370: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00016380: 656c 662e 6572 7220 6973 206e 6f74 204e  elf.err is not N
+00016390: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000163a0: 2020 2020 2074 656d 706c 5f69 7661 7220       templ_ivar 
+000163b0: 3d20 312e 2f69 6e74 6572 7028 6669 6c74  = 1./interp(filt
+000163c0: 6572 2e77 6176 652e 6173 7479 7065 286e  er.wave.astype(n
+000163d0: 702e 666c 6f61 7436 3429 2c0a 2020 2020  p.float64),.    
 000163e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163f0: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
-00016400: 2e74 6872 6f75 6768 7075 745b 7465 7374  .throughput[test
-00016410: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016400: 2020 2073 656c 662e 7761 7665 2c20 7365     self.wave, se
+00016410: 6c66 2e65 7272 5f66 6e75 292a 2a32 0a0a  lf.err_fnu)**2..
 00016420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016430: 2020 2020 206c 6566 743d 302c 2072 6967       left=0, rig
-00016440: 6874 3d30 290a 0a20 2020 2020 2020 2020  ht=0)..         
-00016450: 2020 2069 6620 7365 6c66 2e65 7272 2069     if self.err i
-00016460: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00016470: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-00016480: 6c5f 6976 6172 203d 2031 2f73 656c 662e  l_ivar = 1/self.
-00016490: 6572 725f 666e 752a 2a32 0a20 2020 2020  err_fnu**2.     
-000164a0: 2020 2020 2020 2020 2020 2074 656d 706c             templ
-000164b0: 5f69 7661 725b 7e6e 702e 6973 6669 6e69  _ivar[~np.isfini
-000164c0: 7465 2874 656d 706c 5f69 7661 7229 5d20  te(templ_ivar)] 
-000164d0: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
-000164e0: 2020 2020 2069 6e74 6567 7261 7465 5f77       integrate_w
-000164f0: 6569 6768 7420 3d20 696e 7465 7270 5f74  eight = interp_t
-00016500: 6872 752f 696e 7465 6772 6174 655f 7761  hru/integrate_wa
-00016510: 7665 2a74 656d 706c 5f69 7661 722f 6669  ve*templ_ivar/fi
-00016520: 6c74 6572 2e6e 6f72 6d0a 2020 2020 2020  lter.norm.      
-00016530: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00016540: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00016550: 6772 6174 655f 7765 6967 6874 203d 2069  grate_weight = i
-00016560: 6e74 6572 705f 7468 7275 2f69 6e74 6567  nterp_thru/integ
-00016570: 7261 7465 5f77 6176 6520 2023 202f 7465  rate_wave  # /te
-00016580: 6d70 6c5f 6572 722a 2a32 0a0a 2020 2020  mpl_err**2..    
-00016590: 2020 2020 6966 2068 6173 6174 7472 2866      if hasattr(f
-000165a0: 696c 7465 722c 2027 6e6f 726d 2729 2026  ilter, 'norm') &
-000165b0: 2028 7365 6c66 2e65 7272 2069 7320 4e6f   (self.err is No
-000165c0: 6e65 293a 0a20 2020 2020 2020 2020 2020  ne):.           
-000165d0: 2066 696c 7465 725f 6e6f 726d 203d 2066   filter_norm = f
-000165e0: 696c 7465 722e 6e6f 726d 0a20 2020 2020  ilter.norm.     
-000165f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00016600: 2020 2020 2023 2065 2e67 2e2c 2070 7973       # e.g., pys
-00016610: 796e 7068 6f74 2062 616e 6470 6173 730a  ynphot bandpass.
-00016620: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
-00016630: 6572 5f6e 6f72 6d20 3d20 494e 5445 4752  er_norm = INTEGR
-00016640: 4154 4f52 2869 6e74 6567 7261 7465 5f77  ATOR(integrate_w
-00016650: 6569 6768 742c 2069 6e74 6567 7261 7465  eight, integrate
-00016660: 5f77 6176 6529 0a0a 2020 2020 2020 2020  _wave)..        
-00016670: 2320 665f 6e75 2f6c 616d 2064 6c61 6d20  # f_nu/lam dlam 
-00016680: 3d3d 2066 5f6e 7520 6420 286c 6e20 6e75  == f_nu d (ln nu
-00016690: 290a 2020 2020 2020 2020 7465 6d70 5f66  ).        temp_f
-000166a0: 6c75 7820 3d20 494e 5445 4752 4154 4f52  lux = INTEGRATOR
-000166b0: 2869 6e74 6567 7261 7465 5f74 656d 706c  (integrate_templ
-000166c0: 2a69 6e74 6567 7261 7465 5f77 6569 6768  *integrate_weigh
-000166d0: 742c 2069 6e74 6567 7261 7465 5f77 6176  t, integrate_wav
-000166e0: 6529 202f 2066 696c 7465 725f 6e6f 726d  e) / filter_norm
-000166f0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00016700: 662e 6572 7220 6973 206e 6f74 204e 6f6e  f.err is not Non
-00016710: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00016720: 656d 705f 6572 7220 3d20 312f 6e70 2e73  emp_err = 1/np.s
-00016730: 7172 7428 6669 6c74 6572 5f6e 6f72 6d29  qrt(filter_norm)
-00016740: 0a0a 2020 2020 2020 2020 6966 2061 626d  ..        if abm
-00016750: 6167 3a0a 2020 2020 2020 2020 2020 2020  ag:.            
-00016760: 7465 6d70 5f6d 6167 203d 202d 322e 352a  temp_mag = -2.5*
-00016770: 6e70 2e6c 6f67 3130 2874 656d 705f 666c  np.log10(temp_fl
-00016780: 7578 292d 3438 2e36 0a20 2020 2020 2020  ux)-48.6.       
-00016790: 2020 2020 2072 6574 7572 6e20 7465 6d70       return temp
-000167a0: 5f6d 6167 0a20 2020 2020 2020 2065 6c73  _mag.        els
-000167b0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-000167c0: 6620 7365 6c66 2e65 7272 2069 7320 6e6f  f self.err is no
-000167d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000167e0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-000167f0: 656d 705f 666c 7578 2c20 7465 6d70 5f65  emp_flux, temp_e
-00016800: 7272 0a20 2020 2020 2020 2020 2020 2065  rr.            e
-00016810: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00016820: 2020 2020 2072 6574 7572 6e20 7465 6d70       return temp
-00016830: 5f66 6c75 780a 0a0a 6465 6620 6c6f 6164  _flux...def load
-00016840: 5f74 656d 706c 6174 6573 2866 7768 6d3d  _templates(fwhm=
-00016850: 3430 302c 206c 696e 655f 636f 6d70 6c65  400, line_comple
-00016860: 7865 733d 5472 7565 2c20 7374 6172 733d  xes=True, stars=
-00016870: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-00016880: 2020 2020 2020 2020 2020 6675 6c6c 5f6c            full_l
-00016890: 696e 655f 6c69 7374 3d44 4546 4155 4c54  ine_list=DEFAULT
-000168a0: 5f4c 494e 455f 4c49 5354 2c20 636f 6e74  _LINE_LIST, cont
-000168b0: 696e 7575 6d5f 6c69 7374 3d4e 6f6e 652c  inuum_list=None,
-000168c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000168d0: 2020 2020 6673 7073 5f74 656d 706c 6174      fsps_templat
-000168e0: 6573 3d46 616c 7365 2c20 616c 665f 7465  es=False, alf_te
-000168f0: 6d70 6c61 7465 3d46 616c 7365 2c20 6c6f  mplate=False, lo
-00016900: 7265 6e74 7a3d 4661 6c73 6529 3a0a 2020  rentz=False):.  
-00016910: 2020 2222 2247 656e 6572 6174 6520 6120    """Generate a 
-00016920: 6c69 7374 206f 6620 7465 6d70 6c61 7465  list of template
-00016930: 7320 666f 7220 6669 7474 696e 6720 746f  s for fitting to
-00016940: 2074 6865 2067 7269 736d 2073 7065 6374   the grism spect
-00016950: 7261 0a0a 2020 2020 5468 6520 6469 6666  ra..    The diff
-00016960: 6572 656e 7420 7365 7473 206f 6620 636f  erent sets of co
-00016970: 6e74 696e 7575 6d20 7465 6d70 6c61 7465  ntinuum template
-00016980: 7320 6172 6520 7374 6f72 6564 2069 6e0a  s are stored in.
-00016990: 0a20 2020 2020 2020 203e 3e3e 2074 656d  .        >>> tem
-000169a0: 705f 6469 7220 3d20 6f73 2e70 6174 682e  p_dir = os.path.
-000169b0: 6a6f 696e 2847 5249 5a4c 495f 5041 5448  join(GRIZLI_PATH
-000169c0: 2c20 2774 656d 706c 6174 6573 2729 0a0a  , 'templates')..
-000169d0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-000169e0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-000169f0: 2020 6677 686d 203a 2066 6c6f 6174 0a20    fwhm : float. 
-00016a00: 2020 2020 2020 2046 5748 4d20 6f66 2061         FWHM of a
-00016a10: 2047 6175 7373 6961 6e2c 2069 6e20 6b6d   Gaussian, in km
-00016a20: 2f73 2c20 7468 6174 2069 7320 636f 6e76  /s, that is conv
-00016a30: 6f6c 7665 6420 7769 7468 2074 6865 2065  olved with the e
-00016a40: 6d69 7373 696f 6e0a 2020 2020 2020 2020  mission.        
-00016a50: 6c69 6e65 2074 656d 706c 6174 6573 2e20  line templates. 
-00016a60: 2049 6620 746f 6f20 6e61 7272 6f77 2c20   If too narrow, 
-00016a70: 7468 656e 2063 616e 2073 6565 2070 6978  then can see pix
-00016a80: 656c 2065 6666 6563 7473 2069 6e20 7468  el effects in th
-00016a90: 650a 2020 2020 2020 2020 6669 7473 2061  e.        fits a
-00016aa0: 7320 6120 6675 6e63 7469 6f6e 206f 6620  s a function of 
-00016ab0: 7265 6473 6869 6674 2e0a 0a20 2020 206c  redshift...    l
-00016ac0: 696e 655f 636f 6d70 6c65 7865 7320 3a20  ine_complexes : 
-00016ad0: 626f 6f6c 0a20 2020 2020 2020 2047 656e  bool.        Gen
-00016ae0: 6572 6174 6520 6c69 6e65 2063 6f6d 706c  erate line compl
-00016af0: 6578 2074 656d 706c 6174 6573 2077 6974  ex templates wit
-00016b00: 6820 6669 7865 6420 666c 7578 2072 6174  h fixed flux rat
-00016b10: 696f 7320 7261 7468 6572 2074 6861 6e0a  ios rather than.
-00016b20: 2020 2020 2020 2020 696e 6469 7669 6475          individu
-00016b30: 616c 206c 696e 6573 2e20 5468 6973 2069  al lines. This i
-00016b40: 7320 7573 6566 756c 2066 6f72 2074 6865  s useful for the
-00016b50: 2072 6564 7368 6966 7420 6669 7473 2077   redshift fits w
-00016b60: 6865 7265 2074 6865 7265 0a20 2020 2020  here there.     
-00016b70: 2020 2077 6f75 6c64 2062 6520 7265 6473     would be reds
-00016b80: 6869 6674 2064 6567 656e 6572 6163 6965  hift degeneracie
-00016b90: 7320 6966 2074 6865 206c 696e 6520 666c  s if the line fl
-00016ba0: 7578 6573 2066 6f72 2069 6e64 6976 6964  uxes for individ
-00016bb0: 7561 6c0a 2020 2020 2020 2020 6c69 6e65  ual.        line
-00016bc0: 7320 7765 7265 2061 6c6c 6f77 6564 2074  s were allowed t
-00016bd0: 6f20 7661 7279 2063 6f6d 706c 6574 656c  o vary completel
-00016be0: 7920 6672 6565 6c79 2e20 5365 6520 7468  y freely. See th
-00016bf0: 6520 6c69 7374 206f 660a 2020 2020 2020  e list of.      
-00016c00: 2020 6176 6169 6c61 626c 6520 6c69 6e65    available line
-00016c10: 7320 616e 6420 6c69 6e65 2067 726f 7570  s and line group
-00016c20: 7320 696e 0a20 2020 2020 2020 2060 7e67  s in.        `~g
-00016c30: 7269 7a6c 692e 7574 696c 732e 6765 745f  rizli.utils.get_
-00016c40: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-00016c50: 602e 2043 7572 7265 6e74 6c79 2c0a 2020  `. Currently,.  
-00016c60: 2020 2020 2020 606c 696e 655f 636f 6d70        `line_comp
-00016c70: 6c65 7865 733d 5472 7565 6020 6765 6e65  lexes=True` gene
-00016c80: 7261 7465 7320 7468 6520 666f 6c6c 6f77  rates the follow
-00016c90: 696e 6720 6772 6f75 7073 3a0a 0a20 2020  ing groups:..   
-00016ca0: 2020 2020 2020 2020 2048 612b 4e49 492b           Ha+NII+
-00016cb0: 5349 492b 5349 4949 2b48 650a 2020 2020  SII+SIII+He.    
-00016cc0: 2020 2020 2020 2020 4f49 4949 2b48 620a          OIII+Hb.
-00016cd0: 2020 2020 2020 2020 2020 2020 4f49 492b              OII+
-00016ce0: 4e65 0a0a 2020 2020 7374 6172 7320 3a20  Ne..    stars : 
-00016cf0: 626f 6f6c 0a20 2020 2020 2020 2047 6574  bool.        Get
-00016d00: 2073 7465 6c6c 6172 2074 656d 706c 6174   stellar templat
-00016d10: 6573 2072 6174 6865 7220 7468 616e 2067  es rather than g
-00016d20: 616c 6178 6965 7320 2b20 6c69 6e65 730a  alaxies + lines.
-00016d30: 0a20 2020 2066 756c 6c5f 6c69 6e65 5f6c  .    full_line_l
-00016d40: 6973 7420 3a20 4e6f 6e65 206f 7220 6c69  ist : None or li
-00016d50: 7374 0a20 2020 2020 2020 2046 756c 6c20  st.        Full 
-00016d60: 7365 7420 6f66 206c 696e 6573 2074 6f20  set of lines to 
-00016d70: 7472 792e 2020 5468 6520 6465 6661 756c  try.  The defaul
-00016d80: 7420 6973 2073 6574 2069 6e20 7468 6520  t is set in the 
-00016d90: 676c 6f62 616c 2076 6172 6961 626c 650a  global variable.
-00016da0: 2020 2020 2020 2020 607e 6772 697a 6c69          `~grizli
-00016db0: 2e75 7469 6c73 2e44 4546 4155 4c54 5f4c  .utils.DEFAULT_L
-00016dc0: 494e 455f 4c49 5354 602e 0a0a 2020 2020  INE_LIST`...    
-00016dd0: 2020 2020 5468 6520 6675 6c6c 206c 6973      The full lis
-00016de0: 7420 6f66 2069 6d70 6c65 6d65 6e74 6564  t of implemented
-00016df0: 206c 696e 6573 2069 7320 696e 2060 7e67   lines is in `~g
-00016e00: 7269 7a6c 692e 7574 696c 732e 6765 745f  rizli.utils.get_
-00016e10: 6c69 6e65 5f77 6176 656c 656e 6774 6873  line_wavelengths
-00016e20: 602e 0a0a 2020 2020 636f 6e74 696e 7575  `...    continuu
-00016e30: 6d5f 6c69 7374 203a 204e 6f6e 6520 6f72  m_list : None or
-00016e40: 206c 6973 740a 2020 2020 2020 2020 4f76   list.        Ov
-00016e50: 6572 7269 6465 2074 6865 2064 6566 6175  erride the defau
-00016e60: 6c74 2063 6f6e 7469 6e75 756d 2074 656d  lt continuum tem
-00016e70: 706c 6174 6573 2069 6620 4e6f 6e65 2e0a  plates if None..
-00016e80: 0a20 2020 2066 7370 735f 7465 6d70 6c61  .    fsps_templa
-00016e90: 7465 7320 3a20 626f 6f6c 0a20 2020 2020  tes : bool.     
-00016ea0: 2020 2049 6620 5472 7565 2c20 6765 7420     If True, get 
-00016eb0: 7468 6520 4653 5053 204e 4d46 2074 656d  the FSPS NMF tem
-00016ec0: 706c 6174 6573 2e0a 0a20 2020 2052 6574  plates...    Ret
-00016ed0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-00016ee0: 0a20 2020 2074 656d 705f 6c69 7374 203a  .    temp_list :
-00016ef0: 2064 6963 7469 6f6e 6172 7920 6f66 2060   dictionary of `
-00016f00: 7e67 7269 7a6c 692e 7574 696c 732e 5370  ~grizli.utils.Sp
-00016f10: 6563 7472 756d 5465 6d70 6c61 7465 6020  ectrumTemplate` 
-00016f20: 6f62 6a65 6374 730a 2020 2020 2020 2020  objects.        
-00016f30: 4f75 7470 7574 2074 656d 706c 6174 6520  Output template 
-00016f40: 6c69 7374 0a0a 2020 2020 2222 220a 0a20  list..    """.. 
-00016f50: 2020 2069 6620 7374 6172 733a 0a20 2020     if stars:.   
-00016f60: 2020 2020 2023 2074 656d 706c 6174 6573       # templates
-00016f70: 203d 2067 6c6f 622e 676c 6f62 2827 2573   = glob.glob('%s
-00016f80: 2f74 656d 706c 6174 6573 2f50 6963 6b6c  /templates/Pickl
-00016f90: 6573 5f73 7461 7273 2f65 7874 2f2a 6461  es_stars/ext/*da
-00016fa0: 7427 2025 2847 5249 5a4c 495f 5041 5448  t' %(GRIZLI_PATH
-00016fb0: 2929 0a20 2020 2020 2020 2023 2074 656d  )).        # tem
-00016fc0: 706c 6174 6573 203d 205b 5d0a 2020 2020  plates = [].    
-00016fd0: 2020 2020 2320 666f 7220 7420 696e 2027      # for t in '
-00016fe0: 6f62 6166 676b 6d72 7727 3a0a 2020 2020  obafgkmrw':.    
-00016ff0: 2020 2020 2320 2020 2020 7465 6d70 6c61      #     templa
-00017000: 7465 732e 6578 7465 6e64 2820 676c 6f62  tes.extend( glob
-00017010: 2e67 6c6f 6228 2725 732f 7465 6d70 6c61  .glob('%s/templa
-00017020: 7465 732f 5069 636b 6c65 735f 7374 6172  tes/Pickles_star
-00017030: 732f 6578 742f 756b 2573 2a64 6174 2720  s/ext/uk%s*dat' 
-00017040: 2528 6f73 2e67 6574 656e 7628 2754 4852  %(os.getenv('THR
-00017050: 4545 4448 5354 2729 2c20 7429 2929 0a20  EEDHST'), t))). 
-00017060: 2020 2020 2020 2023 2074 656d 706c 6174         # templat
-00017070: 6573 2e65 7874 656e 6428 676c 6f62 2e67  es.extend(glob.g
-00017080: 6c6f 6228 2725 732f 7465 6d70 6c61 7465  lob('%s/template
-00017090: 732f 5350 4558 2f73 7065 782d 7072 6973  s/SPEX/spex-pris
-000170a0: 6d2d 4d2a 7478 7427 2025 286f 732e 6765  m-M*txt' %(os.ge
-000170b0: 7465 6e76 2827 5448 5245 4544 4853 5427  tenv('THREEDHST'
-000170c0: 2929 2929 0a20 2020 2020 2020 2023 2074  )))).        # t
-000170d0: 656d 706c 6174 6573 2e65 7874 656e 6428  emplates.extend(
-000170e0: 676c 6f62 2e67 6c6f 6228 2725 732f 7465  glob.glob('%s/te
-000170f0: 6d70 6c61 7465 732f 5350 4558 2f73 7065  mplates/SPEX/spe
-00017100: 782d 7072 6973 6d2d 5b4c 545d 2a74 7874  x-prism-[LT]*txt
-00017110: 2720 2528 6f73 2e67 6574 656e 7628 2754  ' %(os.getenv('T
-00017120: 4852 4545 4448 5354 2729 2929 290a 2020  HREEDHST')))).  
-00017130: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-00017140: 2320 2374 656d 706c 6174 6573 203d 2067  # #templates = g
-00017150: 6c6f 622e 676c 6f62 2827 2f55 7365 7273  lob.glob('/Users
-00017160: 2f62 7261 6d6d 6572 2f44 6f77 6e6c 6f61  /brammer/Downloa
-00017170: 6473 2f74 656d 706c 6174 6573 2f73 7065  ds/templates/spe
-00017180: 782a 7478 7427 290a 2020 2020 2020 2020  x*txt').        
-00017190: 2320 7465 6d70 6c61 7465 7320 3d20 676c  # templates = gl
-000171a0: 6f62 2e67 6c6f 6228 2762 7067 732f 2a61  ob.glob('bpgs/*a
-000171b0: 7363 6969 2729 0a20 2020 2020 2020 2023  scii').        #
-000171c0: 2069 6e66 6f20 3d20 6361 7449 4f2e 5461   info = catIO.Ta
-000171d0: 626c 6528 2762 7067 732f 6270 6773 2e69  ble('bpgs/bpgs.i
-000171e0: 6e66 6f27 290a 2020 2020 2020 2020 2320  nfo').        # 
-000171f0: 7479 7065 203d 206e 702e 6172 7261 7928  type = np.array(
-00017200: 5b74 5b3a 325d 2066 6f72 2074 2069 6e20  [t[:2] for t in 
-00017210: 696e 666f 5b27 7479 7065 275d 5d29 0a20  info['type']]). 
-00017220: 2020 2020 2020 2023 2074 656d 706c 6174         # templat
-00017230: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-00017240: 2320 666f 7220 7420 696e 2027 4f42 4146  # for t in 'OBAF
-00017250: 474b 4d27 3a0a 2020 2020 2020 2020 2320  GKM':.        # 
-00017260: 2020 2020 7465 7374 203d 2074 7970 6520      test = type 
-00017270: 3d3d 2027 2d25 7327 2025 2874 290a 2020  == '-%s' %(t).  
-00017280: 2020 2020 2020 2320 2020 2020 736f 203d        #     so =
-00017290: 206e 702e 6172 6773 6f72 7428 696e 666f   np.argsort(info
-000172a0: 5b27 7479 7065 275d 5b74 6573 745d 290a  ['type'][test]).
-000172b0: 2020 2020 2020 2020 2320 2020 2020 7465          #     te
-000172c0: 6d70 6c61 7465 732e 6578 7465 6e64 2869  mplates.extend(i
-000172d0: 6e66 6f5b 2766 696c 6527 5d5b 7465 7374  nfo['file'][test
-000172e0: 5d5b 736f 5d29 0a20 2020 2020 2020 2023  ][so]).        #
-000172f0: 0a20 2020 2020 2020 2023 2074 656d 705f  .        # temp_
-00017300: 6c69 7374 203d 204f 7264 6572 6564 4469  list = OrderedDi
-00017310: 6374 2829 0a20 2020 2020 2020 2023 2066  ct().        # f
-00017320: 6f72 2074 656d 7020 696e 2074 656d 706c  or temp in templ
-00017330: 6174 6573 3a0a 2020 2020 2020 2020 2320  ates:.        # 
-00017340: 2020 2020 2364 6174 6120 3d20 6e70 2e6c      #data = np.l
-00017350: 6f61 6474 7874 2827 6270 6773 2f27 2b74  oadtxt('bpgs/'+t
-00017360: 656d 702c 2075 6e70 6163 6b3d 5472 7565  emp, unpack=True
-00017370: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-00017380: 6461 7461 203d 206e 702e 6c6f 6164 7478  data = np.loadtx
-00017390: 7428 7465 6d70 2c20 756e 7061 636b 3d54  t(temp, unpack=T
-000173a0: 7275 6529 0a20 2020 2020 2020 2023 2020  rue).        #  
-000173b0: 2020 2023 6461 7461 5b30 5d20 2a3d 2031     #data[0] *= 1
-000173c0: 2e65 3420 2320 7370 6578 0a20 2020 2020  .e4 # spex.     
-000173d0: 2020 2023 2020 2020 2073 636c 203d 206e     #     scl = n
-000173e0: 702e 696e 7465 7270 2835 3530 302e 2c20  p.interp(5500., 
-000173f0: 6461 7461 5b30 5d2c 2064 6174 615b 315d  data[0], data[1]
-00017400: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-00017410: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
-00017420: 6173 656e 616d 6528 7465 6d70 290a 2020  asename(temp).  
-00017430: 2020 2020 2020 2320 2020 2020 2369 7820        #     #ix 
-00017440: 3d20 696e 666f 5b27 6669 6c65 275d 203d  = info['file'] =
-00017450: 3d20 7465 6d70 0a20 2020 2020 2020 2023  = temp.        #
-00017460: 2020 2020 2023 6e61 6d65 3d27 2535 7320       #name='%5s 
-00017470: 2573 2720 2528 696e 666f 5b27 7479 7065  %s' %(info['type
-00017480: 275d 5b69 785d 5b30 5d5b 313a 5d2c 2074  '][ix][0][1:], t
-00017490: 656d 702e 7370 6c69 7428 272e 6173 2729  emp.split('.as')
-000174a0: 5b30 5d29 0a20 2020 2020 2020 2023 2020  [0]).        #  
-000174b0: 2020 2070 7269 6e74 286e 616d 6529 0a20     print(name). 
-000174c0: 2020 2020 2020 2023 2020 2020 2074 656d         #     tem
-000174d0: 705f 6c69 7374 5b6e 616d 655d 203d 2075  p_list[name] = u
-000174e0: 7469 6c73 2e53 7065 6374 7275 6d54 656d  tils.SpectrumTem
-000174f0: 706c 6174 6528 7761 7665 3d64 6174 615b  plate(wave=data[
-00017500: 305d 2c0a 2020 2020 2020 2020 2320 2020  0],.        #   
-00017510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017530: 2020 2020 2020 2020 2020 2066 6c75 783d             flux=
-00017540: 6461 7461 5b31 5d2f 7363 6c29 0a0a 2020  data[1]/scl)..  
-00017550: 2020 2020 2020 2320 6e70 2e73 6176 6528        # np.save(
-00017560: 2773 7461 7273 5f62 7067 732e 6e70 7927  'stars_bpgs.npy'
-00017570: 2c20 5b74 656d 705f 6c69 7374 5d29 0a0a  , [temp_list])..
-00017580: 2020 2020 2020 2020 2320 7461 6c6c 203d          # tall =
-00017590: 206e 702e 6c6f 6164 286f 732e 7061 7468   np.load(os.path
-000175a0: 2e6a 6f69 6e28 4752 495a 4c49 5f50 4154  .join(GRIZLI_PAT
-000175b0: 482c 0a20 2020 2020 2020 2023 2020 2020  H,.        #    
-000175c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175d0: 2020 2020 2020 2020 2020 2020 2020 2774                't
-000175e0: 656d 706c 6174 6573 2f73 7461 7273 2e6e  emplates/stars.n
-000175f0: 7079 2729 295b 305d 0a20 2020 2020 2020  py'))[0].       
-00017600: 2023 0a20 2020 2020 2020 2023 2072 6574   #.        # ret
-00017610: 7572 6e20 7461 6c6c 0a20 2020 2020 2020  urn tall.       
-00017620: 2023 0a20 2020 2020 2020 2023 2074 656d   #.        # tem
-00017630: 705f 6c69 7374 203d 204f 7264 6572 6564  p_list = Ordered
-00017640: 4469 6374 2829 0a20 2020 2020 2020 2023  Dict().        #
-00017650: 2066 6f72 206b 2069 6e20 7461 6c6c 3a0a   for k in tall:.
-00017660: 2020 2020 2020 2020 2320 2020 2020 6966          #     if
-00017670: 206b 2e73 7461 7274 7377 6974 6828 2775   k.startswith('u
-00017680: 6b27 293a 0a20 2020 2020 2020 2023 2020  k'):.        #  
-00017690: 2020 2020 2020 2074 656d 705f 6c69 7374         temp_list
-000176a0: 5b6b 5d20 3d20 7461 6c6c 5b6b 5d0a 2020  [k] = tall[k].  
-000176b0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-000176c0: 2320 7265 7475 726e 2074 656d 705f 6c69  # return temp_li
-000176d0: 7374 0a20 2020 2020 2020 2023 0a20 2020  st.        #.   
-000176e0: 2020 2020 2023 2066 6f72 2074 2069 6e20       # for t in 
-000176f0: 274d 4c54 273a 0a20 2020 2020 2020 2023  'MLT':.        #
-00017700: 2020 2020 2066 6f72 206b 2069 6e20 7461       for k in ta
-00017710: 6c6c 3a0a 2020 2020 2020 2020 2320 2020  ll:.        #   
-00017720: 2020 2020 2020 6966 206b 2e73 7461 7274        if k.start
-00017730: 7377 6974 6828 2773 7065 782d 7072 6973  swith('spex-pris
-00017740: 6d2d 272b 7429 3a0a 2020 2020 2020 2020  m-'+t):.        
-00017750: 2320 2020 2020 2020 2020 2020 2020 7465  #             te
-00017760: 6d70 5f6c 6973 745b 6b5d 203d 2074 616c  mp_list[k] = tal
-00017770: 6c5b 6b5d 0a20 2020 2020 2020 2023 0a20  l[k].        #. 
-00017780: 2020 2020 2020 2023 2072 6574 7572 6e20         # return 
-00017790: 7465 6d70 5f6c 6973 740a 0a20 2020 2020  temp_list..     
-000177a0: 2020 2023 2072 6574 7572 6e20 7465 6d70     # return temp
-000177b0: 5f6c 6973 740a 2020 2020 2020 2020 7465  _list.        te
-000177c0: 6d70 6c61 7465 7320 3d20 5b27 4d36 2e35  mplates = ['M6.5
-000177d0: 2e74 7874 272c 2027 4d38 2e30 2e74 7874  .txt', 'M8.0.txt
-000177e0: 272c 2027 4c31 2e30 2e74 7874 272c 2027  ', 'L1.0.txt', '
-000177f0: 4c33 2e35 2e74 7874 272c 2027 4c36 2e30  L3.5.txt', 'L6.0
-00017800: 2e74 7874 272c 2027 5432 2e30 2e74 7874  .txt', 'T2.0.txt
-00017810: 272c 2027 5436 2e30 2e74 7874 272c 2027  ', 'T6.0.txt', '
-00017820: 5437 2e35 2e74 7874 275d 0a20 2020 2020  T7.5.txt'].     
-00017830: 2020 2074 656d 706c 6174 6573 203d 205b     templates = [
-00017840: 2773 7461 7273 2f27 2b74 2066 6f72 2074  'stars/'+t for t
-00017850: 2069 6e20 7465 6d70 6c61 7465 735d 0a20   in templates]. 
-00017860: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00017870: 2023 2049 6e74 6572 6d65 6469 6174 6520   # Intermediate 
-00017880: 616e 6420 7665 7279 206f 6c64 0a20 2020  and very old.   
-00017890: 2020 2020 2023 2074 656d 706c 6174 6573       # templates
-000178a0: 203d 205b 2774 656d 706c 6174 6573 2f45   = ['templates/E
-000178b0: 415a 595f 7631 2e30 5f6c 696e 6573 2f65  AZY_v1.0_lines/e
-000178c0: 617a 795f 7631 2e30 5f73 6564 335f 6e6f  azy_v1.0_sed3_no
-000178d0: 6c69 6e65 732e 6461 7427 2c0a 2020 2020  lines.dat',.    
-000178e0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-000178f0: 2020 2027 7465 6d70 6c61 7465 732f 6376     'templates/cv
-00017900: 6431 325f 7431 315f 736f 6c61 725f 4368  d12_t11_solar_Ch
-00017910: 6162 7269 6572 2e65 7874 656e 642e 736b  abrier.extend.sk
-00017920: 6970 3130 2e64 6174 275d 0a20 2020 2020  ip10.dat'].     
-00017930: 2020 2074 656d 706c 6174 6573 203d 205b     templates = [
-00017940: 2765 617a 795f 696e 7465 726d 6564 6961  'eazy_intermedia
-00017950: 7465 2e64 6174 272c 0a20 2020 2020 2020  te.dat',.       
-00017960: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-00017970: 7664 3132 5f74 3131 5f73 6f6c 6172 5f43  vd12_t11_solar_C
-00017980: 6861 6272 6965 722e 6461 7427 5d0a 0a20  habrier.dat'].. 
-00017990: 2020 2020 2020 2023 2050 6f73 7420 7374         # Post st
-000179a0: 6172 6275 7273 740a 2020 2020 2020 2020  arburst.        
-000179b0: 2320 7465 6d70 6c61 7465 732e 6170 7065  # templates.appe
-000179c0: 6e64 2827 7465 6d70 6c61 7465 732f 556c  nd('templates/Ul
-000179d0: 7472 6156 4953 5441 2f65 617a 795f 7631  traVISTA/eazy_v1
-000179e0: 2e31 5f73 6564 392e 6461 7427 290a 2020  .1_sed9.dat').  
-000179f0: 2020 2020 2020 7465 6d70 6c61 7465 732e        templates.
-00017a00: 6170 7065 6e64 2827 706f 7374 5f73 7461  append('post_sta
-00017a10: 7262 7572 7374 2e64 6174 2729 0a0a 2020  rburst.dat')..  
-00017a20: 2020 2020 2020 2320 5665 7279 2062 6c75        # Very blu
-00017a30: 6520 636f 6e74 696e 7575 6d0a 2020 2020  e continuum.    
-00017a40: 2020 2020 2320 7465 6d70 6c61 7465 732e      # templates.
-00017a50: 6170 7065 6e64 2827 7465 6d70 6c61 7465  append('template
-00017a60: 732f 596f 756e 6753 422f 6572 6232 3031  s/YoungSB/erb201
-00017a70: 305f 636f 6e74 696e 7575 6d2e 6461 7427  0_continuum.dat'
-00017a80: 290a 2020 2020 2020 2020 7465 6d70 6c61  ).        templa
-00017a90: 7465 732e 6170 7065 6e64 2827 6572 6232  tes.append('erb2
-00017aa0: 3031 305f 636f 6e74 696e 7575 6d2e 6461  010_continuum.da
-00017ab0: 7427 290a 0a20 2020 2020 2020 2023 2054  t')..        # T
-00017ac0: 6573 7420 6e65 7720 7465 6d70 6c61 7465  est new template
-00017ad0: 730a 2020 2020 2020 2020 2320 7465 6d70  s.        # temp
-00017ae0: 6c61 7465 7320 3d20 5b27 7465 6d70 6c61  lates = ['templa
-00017af0: 7465 732f 6572 6232 3031 305f 636f 6e74  tes/erb2010_cont
-00017b00: 696e 7575 6d2e 6461 7427 2c0a 2020 2020  inuum.dat',.    
-00017b10: 2020 2020 2320 2774 656d 706c 6174 6573      # 'templates
-00017b20: 2f66 7370 732f 7477 6561 6b5f 6673 7073  /fsps/tweak_fsps
-00017b30: 5f74 656d 705f 6b63 3133 5f31 325f 3030  _temp_kc13_12_00
-00017b40: 362e 6461 7427 2c0a 2020 2020 2020 2020  6.dat',.        
-00017b50: 2320 2774 656d 706c 6174 6573 2f66 7370  # 'templates/fsp
-00017b60: 732f 7477 6561 6b5f 6673 7073 5f74 656d  s/tweak_fsps_tem
-00017b70: 705f 6b63 3133 5f31 325f 3030 382e 6461  p_kc13_12_008.da
-00017b80: 7427 5d0a 0a20 2020 2020 2020 2069 6620  t']..        if 
-00017b90: 6673 7073 5f74 656d 706c 6174 6573 3a0a  fsps_templates:.
-00017ba0: 2020 2020 2020 2020 2020 2020 2374 656d              #tem
-00017bb0: 706c 6174 6573 203d 205b 2774 656d 706c  plates = ['templ
-00017bc0: 6174 6573 2f66 7370 732f 7477 6561 6b5f  ates/fsps/tweak_
-00017bd0: 6673 7073 5f74 656d 705f 6b63 3133 5f31  fsps_temp_kc13_1
-00017be0: 325f 307b 303a 3032 647d 2e64 6174 272e  2_0{0:02d}.dat'.
-00017bf0: 666f 726d 6174 2869 2b31 2920 666f 7220  format(i+1) for 
-00017c00: 6920 696e 2072 616e 6765 2831 3229 5d0a  i in range(12)].
-00017c10: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-00017c20: 6c61 7465 7320 3d20 5b27 6673 7073 2f66  lates = ['fsps/f
-00017c30: 7370 735f 5153 465f 3132 5f76 335f 6e6f  sps_QSF_12_v3_no
-00017c40: 6c69 6e65 735f 307b 303a 3032 647d 2e64  lines_0{0:02d}.d
-00017c50: 6174 272e 666f 726d 6174 2869 2b31 2920  at'.format(i+1) 
-00017c60: 666f 7220 6920 696e 2072 616e 6765 2831  for i in range(1
-00017c70: 3229 5d0a 2020 2020 2020 2020 2020 2020  2)].            
-00017c80: 2374 656d 706c 6174 6573 203d 205b 2766  #templates = ['f
-00017c90: 7370 732f 6673 7073 5f51 5346 5f37 5f76  sps/fsps_QSF_7_v
-00017ca0: 335f 6e6f 6c69 6e65 735f 307b 303a 3032  3_nolines_0{0:02
-00017cb0: 647d 2e64 6174 272e 666f 726d 6174 2869  d}.dat'.format(i
-00017cc0: 2b31 2920 666f 7220 6920 696e 2072 616e  +1) for i in ran
-00017cd0: 6765 2837 295d 0a0a 2020 2020 2020 2020  ge(7)]..        
-00017ce0: 6966 2061 6c66 5f74 656d 706c 6174 653a  if alf_template:
-00017cf0: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
-00017d00: 706c 6174 6573 2e61 7070 656e 6428 2761  plates.append('a
-00017d10: 6c66 5f53 5350 2e64 6174 2729 0a0a 2020  lf_SSP.dat')..  
-00017d20: 2020 2020 2020 6966 2063 6f6e 7469 6e75        if continu
-00017d30: 756d 5f6c 6973 7420 6973 206e 6f74 204e  um_list is not N
-00017d40: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00017d50: 2074 656d 706c 6174 6573 203d 2063 6f6e   templates = con
-00017d60: 7469 6e75 756d 5f6c 6973 740a 0a20 2020  tinuum_list..   
-00017d70: 2074 656d 705f 6c69 7374 203d 204f 7264   temp_list = Ord
-00017d80: 6572 6564 4469 6374 2829 0a20 2020 2066  eredDict().    f
-00017d90: 6f72 2074 656d 7020 696e 2074 656d 706c  or temp in templ
-00017da0: 6174 6573 3a0a 2020 2020 2020 2020 6461  ates:.        da
-00017db0: 7461 203d 206e 702e 6c6f 6164 7478 7428  ta = np.loadtxt(
-00017dc0: 6f73 2e70 6174 682e 6a6f 696e 2847 5249  os.path.join(GRI
-00017dd0: 5a4c 495f 5041 5448 2c20 2774 656d 706c  ZLI_PATH, 'templ
-00017de0: 6174 6573 272c 2074 656d 7029 2c20 756e  ates', temp), un
-00017df0: 7061 636b 3d54 7275 6529 0a20 2020 2020  pack=True).     
-00017e00: 2020 2023 7363 6c20 3d20 6e70 2e69 6e74     #scl = np.int
-00017e10: 6572 7028 3535 3030 2e2c 2064 6174 615b  erp(5500., data[
-00017e20: 305d 2c20 6461 7461 5b31 5d29 0a20 2020  0], data[1]).   
-00017e30: 2020 2020 2073 636c 203d 2031 2e0a 2020       scl = 1..  
-00017e40: 2020 2020 2020 6e61 6d65 203d 2074 656d        name = tem
-00017e50: 7020 2023 206f 732e 7061 7468 2e62 6173  p  # os.path.bas
-00017e60: 656e 616d 6528 7465 6d70 290a 2020 2020  ename(temp).    
-00017e70: 2020 2020 7465 6d70 5f6c 6973 745b 6e61      temp_list[na
-00017e80: 6d65 5d20 3d20 5370 6563 7472 756d 5465  me] = SpectrumTe
-00017e90: 6d70 6c61 7465 2877 6176 653d 6461 7461  mplate(wave=data
-00017ea0: 5b30 5d2c 2066 6c75 783d 6461 7461 5b31  [0], flux=data[1
-00017eb0: 5d2f 7363 6c2c 0a20 2020 2020 2020 2020  ]/scl,.         
-00017ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ee0: 2020 6e61 6d65 3d6e 616d 6529 0a0a 2020    name=name)..  
-00017ef0: 2020 2020 2020 7465 6d70 5f6c 6973 745b        temp_list[
-00017f00: 6e61 6d65 5d2e 6e61 6d65 203d 206e 616d  name].name = nam
-00017f10: 650a 0a20 2020 2069 6620 7374 6172 733a  e..    if stars:
-00017f20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00017f30: 7465 6d70 5f6c 6973 740a 0a20 2020 2023  temp_list..    #
-00017f40: 2045 6d69 7373 696f 6e20 6c69 6e65 733a   Emission lines:
-00017f50: 0a20 2020 206c 696e 655f 7761 7665 6c65  .    line_wavele
-00017f60: 6e67 7468 732c 206c 696e 655f 7261 7469  ngths, line_rati
-00017f70: 6f73 203d 2067 6574 5f6c 696e 655f 7761  os = get_line_wa
-00017f80: 7665 6c65 6e67 7468 7328 290a 0a20 2020  velengths()..   
-00017f90: 2069 6620 6c69 6e65 5f63 6f6d 706c 6578   if line_complex
-00017fa0: 6573 3a0a 2020 2020 2020 2020 236c 696e  es:.        #lin
-00017fb0: 655f 6c69 7374 203d 205b 2748 612b 5349  e_list = ['Ha+SI
-00017fc0: 4927 2c20 274f 4949 492b 4862 2b48 6127  I', 'OIII+Hb+Ha'
-00017fd0: 2c20 274f 4949 275d 0a20 2020 2020 2020  , 'OII'].       
-00017fe0: 2023 6c69 6e65 5f6c 6973 7420 3d20 5b27   #line_list = ['
-00017ff0: 4861 2b53 4949 272c 2027 4f49 4949 2b48  Ha+SII', 'OIII+H
-00018000: 6227 2c20 274f 4949 275d 0a20 2020 2020  b', 'OII'].     
-00018010: 2020 2023 6c69 6e65 5f6c 6973 7420 3d20     #line_list = 
-00018020: 5b27 4861 2b4e 4949 2b53 4949 2b53 4949  ['Ha+NII+SII+SII
-00018030: 492b 4865 2b50 6142 272c 2027 4f49 4949  I+He+PaB', 'OIII
-00018040: 2b48 6227 2c20 274f 4949 2b4e 6527 2c20  +Hb', 'OII+Ne', 
-00018050: 274c 7961 2b43 4956 275d 0a20 2020 2020  'Lya+CIV'].     
-00018060: 2020 2023 6c69 6e65 5f6c 6973 7420 3d20     #line_list = 
-00018070: 5b27 4861 2b4e 4949 2b53 4949 2b53 4949  ['Ha+NII+SII+SII
-00018080: 492b 4865 2b50 6142 272c 2027 4f49 4949  I+He+PaB', 'OIII
-00018090: 2b48 622b 4867 2b48 6427 2c20 274f 4949  +Hb+Hg+Hd', 'OII
-000180a0: 2b4e 6527 2c20 274c 7961 2b43 4956 275d  +Ne', 'Lya+CIV']
-000180b0: 0a20 2020 2020 2020 206c 696e 655f 6c69  .        line_li
-000180c0: 7374 203d 205b 2748 612b 4e49 492b 5349  st = ['Ha+NII+SI
-000180d0: 492b 5349 4949 2b48 652b 5061 4227 2c20  I+SIII+He+PaB', 
-000180e0: 274f 4949 492b 4862 2b48 672b 4864 272c  'OIII+Hb+Hg+Hd',
-000180f0: 2027 4f49 492b 4e65 272c 2027 4761 6c2d   'OII+Ne', 'Gal-
-00018100: 5556 2d6c 696e 6573 275d 0a0a 2020 2020  UV-lines']..    
-00018110: 656c 7365 3a0a 2020 2020 2020 2020 6966  else:.        if
-00018120: 2066 756c 6c5f 6c69 6e65 5f6c 6973 7420   full_line_list 
-00018130: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00018140: 2020 2020 206c 696e 655f 6c69 7374 203d       line_list =
-00018150: 2044 4546 4155 4c54 5f4c 494e 455f 4c49   DEFAULT_LINE_LI
-00018160: 5354 0a20 2020 2020 2020 2065 6c73 653a  ST.        else:
-00018170: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00018180: 655f 6c69 7374 203d 2066 756c 6c5f 6c69  e_list = full_li
-00018190: 6e65 5f6c 6973 740a 0a20 2020 2020 2020  ne_list..       
-000181a0: 2023 6c69 6e65 5f6c 6973 7420 3d20 5b27   #line_list = ['
-000181b0: 4861 272c 2027 5349 4927 5d0a 0a20 2020  Ha', 'SII']..   
-000181c0: 2023 2055 7365 2046 5350 5320 6772 6964   # Use FSPS grid
-000181d0: 2066 6f72 206c 696e 6573 0a20 2020 2077   for lines.    w
-000181e0: 6176 655f 6772 6964 203d 204e 6f6e 650a  ave_grid = None.
-000181f0: 2020 2020 2320 6966 2066 7370 735f 7465      # if fsps_te
-00018200: 6d70 6c61 7465 733a 0a20 2020 2023 2020  mplates:.    #  
-00018210: 2020 2077 6176 655f 6772 6964 203d 2064     wave_grid = d
-00018220: 6174 615b 305d 0a20 2020 2023 2065 6c73  ata[0].    # els
-00018230: 653a 0a20 2020 2023 2020 2020 2077 6176  e:.    #     wav
-00018240: 655f 6772 6964 203d 204e 6f6e 650a 0a20  e_grid = None.. 
-00018250: 2020 2066 6f72 206c 6920 696e 206c 696e     for li in lin
-00018260: 655f 6c69 7374 3a0a 2020 2020 2020 2020  e_list:.        
-00018270: 7363 6c20 3d20 6c69 6e65 5f72 6174 696f  scl = line_ratio
-00018280: 735b 6c69 5d2f 6e70 2e73 756d 286c 696e  s[li]/np.sum(lin
-00018290: 655f 7261 7469 6f73 5b6c 695d 290a 2020  e_ratios[li]).  
-000182a0: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-000182b0: 616e 6765 286c 656e 2873 636c 2929 3a0a  ange(len(scl)):.
-000182c0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000182d0: 274f 3332 2720 696e 206c 6929 2026 2028  'O32' in li) & (
-000182e0: 6e70 2e61 6273 286c 696e 655f 7761 7665  np.abs(line_wave
-000182f0: 6c65 6e67 7468 735b 6c69 5d5b 695d 2d32  lengths[li][i]-2
-00018300: 3739 3929 203c 2032 293a 0a20 2020 2020  799) < 2):.     
-00018310: 2020 2020 2020 2020 2020 2066 7768 6d5f             fwhm_
-00018320: 6920 3d20 3235 3030 0a20 2020 2020 2020  i = 2500.       
-00018330: 2020 2020 2020 2020 206c 6f72 656e 747a           lorentz
-00018340: 5f69 203d 2054 7275 650a 2020 2020 2020  _i = True.      
-00018350: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00018360: 2020 2020 2020 2020 2020 2020 6677 686d              fwhm
-00018370: 5f69 203d 2066 7768 6d0a 2020 2020 2020  _i = fwhm.      
-00018380: 2020 2020 2020 2020 2020 6c6f 7265 6e74            lorent
-00018390: 7a5f 6920 3d20 6c6f 7265 6e74 7a0a 0a20  z_i = lorentz.. 
-000183a0: 2020 2020 2020 2020 2020 206c 696e 655f             line_
-000183b0: 6920 3d20 5370 6563 7472 756d 5465 6d70  i = SpectrumTemp
-000183c0: 6c61 7465 2877 6176 653d 7761 7665 5f67  late(wave=wave_g
-000183d0: 7269 642c 0a20 2020 2020 2020 2020 2020  rid,.           
-000183e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183f0: 2020 2020 2020 2020 2020 2063 656e 7472             centr
-00018400: 616c 5f77 6176 653d 6c69 6e65 5f77 6176  al_wave=line_wav
-00018410: 656c 656e 6774 6873 5b6c 695d 5b69 5d2c  elengths[li][i],
-00018420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018440: 2020 2020 2020 2066 6c75 783d 4e6f 6e65         flux=None
-00018450: 2c20 6677 686d 3d66 7768 6d5f 692c 2076  , fwhm=fwhm_i, v
-00018460: 656c 6f63 6974 793d 5472 7565 2c0a 2020  elocity=True,.  
-00018470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018490: 2020 2020 6c6f 7265 6e74 7a3d 6c6f 7265      lorentz=lore
-000184a0: 6e74 7a5f 6929 0a0a 2020 2020 2020 2020  ntz_i)..        
-000184b0: 2020 2020 6966 2069 203d 3d20 303a 0a20      if i == 0:. 
-000184c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000184d0: 696e 655f 7465 6d70 203d 206c 696e 655f  ine_temp = line_
-000184e0: 692a 7363 6c5b 695d 0a20 2020 2020 2020  i*scl[i].       
-000184f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00018500: 2020 2020 2020 2020 2020 206c 696e 655f             line_
-00018510: 7465 6d70 203d 206c 696e 655f 7465 6d70  temp = line_temp
-00018520: 202b 206c 696e 655f 692a 7363 6c5b 695d   + line_i*scl[i]
-00018530: 0a0a 2020 2020 2020 2020 6e61 6d65 203d  ..        name =
-00018540: 2027 6c69 6e65 207b 307d 272e 666f 726d   'line {0}'.form
-00018550: 6174 286c 6929 0a20 2020 2020 2020 206c  at(li).        l
-00018560: 696e 655f 7465 6d70 2e6e 616d 6520 3d20  ine_temp.name = 
-00018570: 6e61 6d65 0a20 2020 2020 2020 2074 656d  name.        tem
-00018580: 705f 6c69 7374 5b6e 616d 655d 203d 206c  p_list[name] = l
-00018590: 696e 655f 7465 6d70 0a0a 2020 2020 7265  ine_temp..    re
-000185a0: 7475 726e 2074 656d 705f 6c69 7374 0a0a  turn temp_list..
-000185b0: 0a64 6566 206c 6f61 645f 6265 7461 5f74  .def load_beta_t
-000185c0: 656d 706c 6174 6573 2877 6176 653d 6e70  emplates(wave=np
-000185d0: 2e61 7261 6e67 6528 3430 302c 2032 2e35  .arange(400, 2.5
-000185e0: 6534 292c 2062 6574 6173 3d5b 2d32 2c20  e4), betas=[-2, 
-000185f0: 2d31 2c20 305d 293a 0a20 2020 2022 2222  -1, 0]):.    """
-00018600: 0a20 2020 2053 7465 702d 6675 6e63 7469  .    Step-functi
-00018610: 6f6e 2074 656d 706c 6174 6573 2077 6974  on templates wit
-00018620: 6820 665f 6c61 6d62 6461 207e 2028 7761  h f_lambda ~ (wa
-00018630: 7665 2f31 3231 362e 292a 2a62 6574 610a  ve/1216.)**beta.
-00018640: 2020 2020 2222 220a 2020 2020 636f 6e74      """.    cont
-00018650: 5f77 6176 6520 3d20 6e70 2e61 7261 6e67  _wave = np.arang
-00018660: 6528 3430 302c 2032 2e35 6534 290a 2020  e(400, 2.5e4).  
-00018670: 2020 7430 203d 207b 7d0a 2020 2020 666f    t0 = {}.    fo
-00018680: 7220 6265 7461 2069 6e20 6265 7461 733a  r beta in betas:
-00018690: 0a20 2020 2020 2020 206b 6579 203d 2027  .        key = '
-000186a0: 6265 7461 207b 307d 272e 666f 726d 6174  beta {0}'.format
-000186b0: 2862 6574 6129 0a20 2020 2020 2020 2074  (beta).        t
-000186c0: 305b 6b65 795d 203d 2053 7065 6374 7275  0[key] = Spectru
-000186d0: 6d54 656d 706c 6174 6528 7761 7665 3d63  mTemplate(wave=c
-000186e0: 6f6e 745f 7761 7665 2c20 666c 7578 3d28  ont_wave, flux=(
-000186f0: 636f 6e74 5f77 6176 652f 3132 3136 2e29  cont_wave/1216.)
-00018700: 2a2a 6265 7461 290a 2020 2020 7265 7475  **beta).    retu
-00018710: 726e 2074 300a 0a0a 6465 6620 6c6f 6164  rn t0...def load
-00018720: 5f71 7561 7361 725f 7465 6d70 6c61 7465  _quasar_template
-00018730: 7328 6272 6f61 645f 6677 686d 3d32 3530  s(broad_fwhm=250
-00018740: 302c 206e 6172 726f 775f 6677 686d 3d31  0, narrow_fwhm=1
-00018750: 3230 302c 2062 726f 6164 5f6c 696e 6573  200, broad_lines
-00018760: 3d5b 2748 6549 2d35 3837 3727 2c20 274d  =['HeI-5877', 'M
-00018770: 6749 4927 2c20 274c 7961 272c 2027 4349  gII', 'Lya', 'CI
-00018780: 562d 3135 3439 272c 2027 4349 4949 2d31  V-1549', 'CIII-1
-00018790: 3930 3627 2c20 2743 4949 492d 3139 3038  906', 'CIII-1908
-000187a0: 272c 2027 4f49 4949 2d31 3636 3327 2c20  ', 'OIII-1663', 
-000187b0: 2748 6549 492d 3136 3430 272c 2027 5369  'HeII-1640', 'Si
-000187c0: 4956 2b4f 4956 2d31 3339 3827 2c20 274e  IV+OIV-1398', 'N
-000187d0: 4956 2d31 3438 3727 2c20 274e 562d 3132  IV-1487', 'NV-12
-000187e0: 3430 272c 2027 5061 4227 2c20 2750 6147  40', 'PaB', 'PaG
-000187f0: 275d 2c20 6e61 7272 6f77 5f6c 696e 6573  '], narrow_lines
-00018800: 3d5b 274e 4949 492d 3137 3530 272c 2027  =['NIII-1750', '
-00018810: 4f49 4927 2c20 274f 4949 4927 2c20 2753  OII', 'OIII', 'S
-00018820: 4949 272c 2027 4f49 2d36 3330 3227 2c20  II', 'OI-6302', 
-00018830: 274f 4949 492d 3433 3633 272c 2027 4e65  'OIII-4363', 'Ne
-00018840: 4949 492d 3338 3637 272c 2027 4e65 5649  III-3867', 'NeVI
-00018850: 2d33 3432 3627 2c20 274e 6556 2d33 3334  -3426', 'NeV-334
-00018860: 3627 2c20 274f 4949 2d37 3332 3527 2c20  6', 'OII-7325', 
-00018870: 2741 7249 4949 2d37 3133 3827 2c20 2753  'ArIII-7138', 'S
-00018880: 4949 4927 2c20 2748 6549 2d31 3038 3327  III', 'HeI-1083'
-00018890: 5d2c 2069 6e63 6c75 6465 5f66 6569 693d  ], include_feii=
-000188a0: 5472 7565 2c20 736c 6f70 6573 3d5b 2d32  True, slopes=[-2
-000188b0: 2e38 2c20 302c 2032 2e38 5d2c 2075 765f  .8, 0, 2.8], uv_
-000188c0: 6c69 6e65 5f63 6f6d 706c 6578 3d54 7275  line_complex=Tru
-000188d0: 652c 2066 6978 6564 5f6e 6172 726f 775f  e, fixed_narrow_
-000188e0: 6c69 6e65 733d 4661 6c73 652c 2074 315f  lines=False, t1_
-000188f0: 6f6e 6c79 3d46 616c 7365 2c20 6e73 706c  only=False, nspl
-00018900: 696e 653d 3133 2c20 5273 706c 696e 653d  ine=13, Rspline=
-00018910: 3330 2c20 6265 7461 733d 4e6f 6e65 2c20  30, betas=None, 
-00018920: 696e 636c 7564 655f 7265 6464 656e 6564  include_reddened
-00018930: 5f62 616c 6d65 725f 6c69 6e65 733d 4661  _balmer_lines=Fa
-00018940: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
-00018950: 2020 4d61 6b65 2074 656d 706c 6174 6573    Make templates
-00018960: 2073 7569 7461 626c 6520 666f 7220 6669   suitable for fi
-00018970: 7474 696e 6720 6272 6f61 642d 6c69 6e65  tting broad-line
-00018980: 2071 7561 7361 7273 0a20 2020 2022 2222   quasars.    """
-00018990: 0a0a 2020 2020 6672 6f6d 2063 6f6c 6c65  ..    from colle
-000189a0: 6374 696f 6e73 2069 6d70 6f72 7420 4f72  ctions import Or
-000189b0: 6465 7265 6444 6963 740a 2020 2020 696d  deredDict.    im
-000189c0: 706f 7274 2073 6369 7079 2e6e 6469 6d61  port scipy.ndima
-000189d0: 6765 2061 7320 6e64 0a0a 2020 2020 7430  ge as nd..    t0
-000189e0: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
-000189f0: 0a20 2020 2074 3120 3d20 4f72 6465 7265  .    t1 = Ordere
-00018a00: 6444 6963 7428 290a 0a20 2020 2062 726f  dDict()..    bro
-00018a10: 6164 3120 3d20 6c6f 6164 5f74 656d 706c  ad1 = load_templ
-00018a20: 6174 6573 2866 7768 6d3d 6272 6f61 645f  ates(fwhm=broad_
-00018a30: 6677 686d 2c20 6c69 6e65 5f63 6f6d 706c  fwhm, line_compl
-00018a40: 6578 6573 3d46 616c 7365 2c20 7374 6172  exes=False, star
-00018a50: 733d 4661 6c73 652c 2066 756c 6c5f 6c69  s=False, full_li
-00018a60: 6e65 5f6c 6973 743d 5b27 4861 272c 2027  ne_list=['Ha', '
-00018a70: 4862 272c 2027 4867 272c 2027 4864 272c  Hb', 'Hg', 'Hd',
-00018a80: 2027 4837 272c 2027 4838 272c 2027 4839   'H7', 'H8', 'H9
-00018a90: 272c 2027 4831 3027 5d20 2b20 6272 6f61  ', 'H10'] + broa
-00018aa0: 645f 6c69 6e65 732c 2063 6f6e 7469 6e75  d_lines, continu
-00018ab0: 756d 5f6c 6973 743d 5b5d 2c20 6673 7073  um_list=[], fsps
-00018ac0: 5f74 656d 706c 6174 6573 3d46 616c 7365  _templates=False
-00018ad0: 2c20 616c 665f 7465 6d70 6c61 7465 3d46  , alf_template=F
-00018ae0: 616c 7365 2c20 6c6f 7265 6e74 7a3d 5472  alse, lorentz=Tr
-00018af0: 7565 290a 0a20 2020 206e 6172 726f 7731  ue)..    narrow1
-00018b00: 203d 206c 6f61 645f 7465 6d70 6c61 7465   = load_template
-00018b10: 7328 6677 686d 3d34 3030 2c20 6c69 6e65  s(fwhm=400, line
-00018b20: 5f63 6f6d 706c 6578 6573 3d46 616c 7365  _complexes=False
-00018b30: 2c20 7374 6172 733d 4661 6c73 652c 2066  , stars=False, f
-00018b40: 756c 6c5f 6c69 6e65 5f6c 6973 743d 6e61  ull_line_list=na
-00018b50: 7272 6f77 5f6c 696e 6573 2c20 636f 6e74  rrow_lines, cont
-00018b60: 696e 7575 6d5f 6c69 7374 3d5b 5d2c 2066  inuum_list=[], f
-00018b70: 7370 735f 7465 6d70 6c61 7465 733d 4661  sps_templates=Fa
-00018b80: 6c73 652c 2061 6c66 5f74 656d 706c 6174  lse, alf_templat
-00018b90: 653d 4661 6c73 6529 0a0a 2020 2020 6966  e=False)..    if
-00018ba0: 2066 6978 6564 5f6e 6172 726f 775f 6c69   fixed_narrow_li
-00018bb0: 6e65 733a 0a20 2020 2020 2020 2069 6620  nes:.        if 
-00018bc0: 7431 5f6f 6e6c 793a 0a20 2020 2020 2020  t1_only:.       
-00018bd0: 2020 2020 206e 6172 726f 7730 203d 206e       narrow0 = n
-00018be0: 6172 726f 7731 0a20 2020 2020 2020 2065  arrow1.        e
-00018bf0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018c00: 206e 6172 726f 7730 203d 206c 6f61 645f   narrow0 = load_
-00018c10: 7465 6d70 6c61 7465 7328 6677 686d 3d6e  templates(fwhm=n
-00018c20: 6172 726f 775f 6677 686d 2c20 6c69 6e65  arrow_fwhm, line
-00018c30: 5f63 6f6d 706c 6578 6573 3d46 616c 7365  _complexes=False
-00018c40: 2c20 7374 6172 733d 4661 6c73 652c 2066  , stars=False, f
-00018c50: 756c 6c5f 6c69 6e65 5f6c 6973 743d 5b27  ull_line_list=['
-00018c60: 5153 4f2d 4e61 7272 6f77 2d6c 696e 6573  QSO-Narrow-lines
-00018c70: 275d 2c20 636f 6e74 696e 7575 6d5f 6c69  '], continuum_li
-00018c80: 7374 3d5b 5d2c 2066 7370 735f 7465 6d70  st=[], fsps_temp
-00018c90: 6c61 7465 733d 4661 6c73 652c 2061 6c66  lates=False, alf
-00018ca0: 5f74 656d 706c 6174 653d 4661 6c73 6529  _template=False)
-00018cb0: 0a0a 2020 2020 656c 7365 3a0a 2020 2020  ..    else:.    
-00018cc0: 2020 2020 6e61 7272 6f77 3020 3d20 6c6f      narrow0 = lo
-00018cd0: 6164 5f74 656d 706c 6174 6573 2866 7768  ad_templates(fwh
-00018ce0: 6d3d 6e61 7272 6f77 5f66 7768 6d2c 206c  m=narrow_fwhm, l
-00018cf0: 696e 655f 636f 6d70 6c65 7865 733d 4661  ine_complexes=Fa
-00018d00: 6c73 652c 2073 7461 7273 3d46 616c 7365  lse, stars=False
-00018d10: 2c20 6675 6c6c 5f6c 696e 655f 6c69 7374  , full_line_list
-00018d20: 3d6e 6172 726f 775f 6c69 6e65 732c 2063  =narrow_lines, c
-00018d30: 6f6e 7469 6e75 756d 5f6c 6973 743d 5b5d  ontinuum_list=[]
-00018d40: 2c20 6673 7073 5f74 656d 706c 6174 6573  , fsps_templates
-00018d50: 3d46 616c 7365 2c20 616c 665f 7465 6d70  =False, alf_temp
-00018d60: 6c61 7465 3d46 616c 7365 290a 0a20 2020  late=False)..   
-00018d70: 2069 6620 7431 5f6f 6e6c 793a 0a20 2020   if t1_only:.   
-00018d80: 2020 2020 2062 726f 6164 3020 3d20 6272       broad0 = br
-00018d90: 6f61 6431 0a20 2020 2065 6c73 653a 0a20  oad1.    else:. 
-00018da0: 2020 2020 2020 2069 6620 7576 5f6c 696e         if uv_lin
-00018db0: 655f 636f 6d70 6c65 783a 0a20 2020 2020  e_complex:.     
-00018dc0: 2020 2020 2020 2066 756c 6c5f 6c69 6e65         full_line
-00018dd0: 5f6c 6973 7420 3d20 5b27 4261 6c6d 6572  _list = ['Balmer
-00018de0: 2031 306b 4b20 2b20 4d67 4949 2041 763d   10kK + MgII Av=
-00018df0: 302e 3527 2c20 2751 534f 2d55 562d 6c69  0.5', 'QSO-UV-li
-00018e00: 6e65 7327 5d0a 2020 2020 2020 2020 2020  nes'].          
-00018e10: 2020 2362 726f 6164 3020 3d20 6c6f 6164    #broad0 = load
-00018e20: 5f74 656d 706c 6174 6573 2866 7768 6d3d  _templates(fwhm=
-00018e30: 6272 6f61 645f 6677 686d 2c20 6c69 6e65  broad_fwhm, line
-00018e40: 5f63 6f6d 706c 6578 6573 3d46 616c 7365  _complexes=False
-00018e50: 2c20 7374 6172 733d 4661 6c73 652c 2066  , stars=False, f
-00018e60: 756c 6c5f 6c69 6e65 5f6c 6973 743d 5b27  ull_line_list=['
-00018e70: 4261 6c6d 6572 2031 306b 4b20 2b20 4d67  Balmer 10kK + Mg
-00018e80: 4949 272c 2027 5153 4f2d 5556 2d6c 696e  II', 'QSO-UV-lin
-00018e90: 6573 275d 2c20 636f 6e74 696e 7575 6d5f  es'], continuum_
-00018ea0: 6c69 7374 3d5b 5d2c 2066 7370 735f 7465  list=[], fsps_te
-00018eb0: 6d70 6c61 7465 733d 4661 6c73 652c 2061  mplates=False, a
-00018ec0: 6c66 5f74 656d 706c 6174 653d 4661 6c73  lf_template=Fals
-00018ed0: 652c 206c 6f72 656e 747a 3d54 7275 6529  e, lorentz=True)
-00018ee0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00018ef0: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
-00018f00: 6c69 6e65 5f6c 6973 7420 3d20 5b27 4261  line_list = ['Ba
-00018f10: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
-00018f20: 2041 763d 302e 3527 5d0a 2020 2020 2020   Av=0.5'].      
-00018f30: 2020 2020 2020 2362 726f 6164 3020 3d20        #broad0 = 
-00018f40: 6c6f 6164 5f74 656d 706c 6174 6573 2866  load_templates(f
-00018f50: 7768 6d3d 6272 6f61 645f 6677 686d 2c20  whm=broad_fwhm, 
-00018f60: 6c69 6e65 5f63 6f6d 706c 6578 6573 3d46  line_complexes=F
-00018f70: 616c 7365 2c20 7374 6172 733d 4661 6c73  alse, stars=Fals
-00018f80: 652c 2066 756c 6c5f 6c69 6e65 5f6c 6973  e, full_line_lis
-00018f90: 743d 5b27 4261 6c6d 6572 2031 306b 4b27  t=['Balmer 10kK'
-00018fa0: 5d20 2b20 6272 6f61 645f 6c69 6e65 732c  ] + broad_lines,
-00018fb0: 2063 6f6e 7469 6e75 756d 5f6c 6973 743d   continuum_list=
-00018fc0: 5b5d 2c20 6673 7073 5f74 656d 706c 6174  [], fsps_templat
-00018fd0: 6573 3d46 616c 7365 2c20 616c 665f 7465  es=False, alf_te
-00018fe0: 6d70 6c61 7465 3d46 616c 7365 2c20 6c6f  mplate=False, lo
-00018ff0: 7265 6e74 7a3d 5472 7565 290a 0a20 2020  rentz=True)..   
-00019000: 2020 2020 2069 6620 696e 636c 7564 655f       if include_
-00019010: 7265 6464 656e 6564 5f62 616c 6d65 725f  reddened_balmer_
-00019020: 6c69 6e65 733a 0a20 2020 2020 2020 2020  lines:.         
-00019030: 2020 206c 696e 655f 7761 7665 6c65 6e67     line_waveleng
-00019040: 7468 732c 206c 696e 655f 7261 7469 6f73  ths, line_ratios
-00019050: 203d 2067 6574 5f6c 696e 655f 7761 7665   = get_line_wave
-00019060: 6c65 6e67 7468 7328 290a 2020 2020 2020  lengths().      
-00019070: 2020 2020 2020 6966 2027 4261 6c6d 6572        if 'Balmer
-00019080: 2031 306b 4b20 2b20 4d67 4949 2041 763d   10kK + MgII Av=
-00019090: 312e 3027 2069 6e20 6c69 6e65 5f77 6176  1.0' in line_wav
-000190a0: 656c 656e 6774 6873 3a0a 2020 2020 2020  elengths:.      
-000190b0: 2020 2020 2020 2020 2020 6675 6c6c 5f6c            full_l
-000190c0: 696e 655f 6c69 7374 202b 3d20 5b27 4261  ine_list += ['Ba
-000190d0: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
-000190e0: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-000190f0: 2020 2066 756c 6c5f 6c69 6e65 5f6c 6973     full_line_lis
-00019100: 7420 2b3d 205b 2742 616c 6d65 7220 3130  t += ['Balmer 10
-00019110: 6b4b 202b 204d 6749 4920 4176 3d31 2e30  kK + MgII Av=1.0
-00019120: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-00019130: 2020 2066 756c 6c5f 6c69 6e65 5f6c 6973     full_line_lis
-00019140: 7420 2b3d 205b 2742 616c 6d65 7220 3130  t += ['Balmer 10
-00019150: 6b4b 202b 204d 6749 4920 4176 3d32 2e30  kK + MgII Av=2.0
-00019160: 275d 0a0a 2020 2020 2020 2020 6272 6f61  ']..        broa
-00019170: 6430 203d 206c 6f61 645f 7465 6d70 6c61  d0 = load_templa
-00019180: 7465 7328 6677 686d 3d62 726f 6164 5f66  tes(fwhm=broad_f
-00019190: 7768 6d2c 206c 696e 655f 636f 6d70 6c65  whm, line_comple
-000191a0: 7865 733d 4661 6c73 652c 2073 7461 7273  xes=False, stars
-000191b0: 3d46 616c 7365 2c20 6675 6c6c 5f6c 696e  =False, full_lin
-000191c0: 655f 6c69 7374 3d66 756c 6c5f 6c69 6e65  e_list=full_line
-000191d0: 5f6c 6973 742c 2063 6f6e 7469 6e75 756d  _list, continuum
-000191e0: 5f6c 6973 743d 5b5d 2c20 6673 7073 5f74  _list=[], fsps_t
-000191f0: 656d 706c 6174 6573 3d46 616c 7365 2c20  emplates=False, 
-00019200: 616c 665f 7465 6d70 6c61 7465 3d46 616c  alf_template=Fal
-00019210: 7365 2c20 6c6f 7265 6e74 7a3d 5472 7565  se, lorentz=True
-00019220: 290a 0a20 2020 2020 2020 2066 6f72 206b  )..        for k
-00019230: 2069 6e20 6272 6f61 6430 3a0a 2020 2020   in broad0:.    
-00019240: 2020 2020 2020 2020 7430 5b6b 5d20 3d20          t0[k] = 
-00019250: 6272 6f61 6430 5b6b 5d0a 0a20 2020 2066  broad0[k]..    f
-00019260: 6f72 206b 2069 6e20 6272 6f61 6431 3a0a  or k in broad1:.
-00019270: 2020 2020 2020 2020 7431 5b6b 5d20 3d20          t1[k] = 
-00019280: 6272 6f61 6431 5b6b 5d0a 0a20 2020 2066  broad1[k]..    f
-00019290: 6f72 206b 2069 6e20 6e61 7272 6f77 303a  or k in narrow0:
-000192a0: 0a20 2020 2020 2020 2074 305b 6b5d 203d  .        t0[k] =
-000192b0: 206e 6172 726f 7730 5b6b 5d0a 0a20 2020   narrow0[k]..   
-000192c0: 2066 6f72 206b 2069 6e20 6e61 7272 6f77   for k in narrow
-000192d0: 313a 0a20 2020 2020 2020 2074 315b 6b5d  1:.        t1[k]
-000192e0: 203d 206e 6172 726f 7731 5b6b 5d0a 0a20   = narrow1[k].. 
-000192f0: 2020 2023 2046 6520 4949 0a20 2020 2069     # Fe II.    i
-00019300: 6620 696e 636c 7564 655f 6665 6969 3a0a  f include_feii:.
-00019310: 2020 2020 2020 2020 6665 6969 5f77 6176          feii_wav
-00019320: 652c 2066 6569 695f 666c 7578 203d 206e  e, feii_flux = n
-00019330: 702e 6c6f 6164 7478 7428 6f73 2e70 6174  p.loadtxt(os.pat
-00019340: 682e 6469 726e 616d 6528 5f5f 6669 6c65  h.dirname(__file
-00019350: 5f5f 2920 2b20 272f 6461 7461 2f74 656d  __) + '/data/tem
-00019360: 706c 6174 6573 2f46 6549 495f 5665 726f  plates/FeII_Vero
-00019370: 6e43 6574 7479 3230 3034 2e74 7874 272c  nCetty2004.txt',
-00019380: 2075 6e70 6163 6b3d 5472 7565 290a 0a20   unpack=True).. 
-00019390: 2020 2020 2020 2023 2073 6d6f 6f74 6869         # smoothi
-000193a0: 6e67 2c20 696e 2075 6e69 7473 206f 6620  ng, in units of 
-000193b0: 696e 7075 7420 7665 6c6f 6369 7479 2072  input velocity r
-000193c0: 6573 6f6c 7574 696f 6e0a 2020 2020 2020  esolution.      
-000193d0: 2020 6665 6969 5f6b 6572 6e20 3d20 6272    feii_kern = br
-000193e0: 6f61 645f 6677 686d 2f32 2e33 3534 382f  oad_fwhm/2.3548/
-000193f0: 3735 2e0a 2020 2020 2020 2020 6665 6969  75..        feii
-00019400: 5f73 6d20 3d20 6e64 2e67 6175 7373 6961  _sm = nd.gaussia
-00019410: 6e5f 6669 6c74 6572 2866 6569 695f 666c  n_filter(feii_fl
-00019420: 7578 2c20 6665 6969 5f6b 6572 6e29 0a20  ux, feii_kern). 
-00019430: 2020 2020 2020 2074 305b 2746 6549 492d         t0['FeII-
-00019440: 5643 3230 3034 275d 203d 2074 315b 2746  VC2004'] = t1['F
-00019450: 6549 492d 5643 3230 3034 275d 203d 2053  eII-VC2004'] = S
-00019460: 7065 6374 7275 6d54 656d 706c 6174 6528  pectrumTemplate(
-00019470: 7761 7665 3d66 6569 695f 7761 7665 2c20  wave=feii_wave, 
-00019480: 666c 7578 3d66 6569 695f 736d 2c20 6e61  flux=feii_sm, na
-00019490: 6d65 3d27 4665 4949 2d56 4332 3030 3427  me='FeII-VC2004'
-000194a0: 290a 0a20 2020 2023 204c 696e 6561 7220  )..    # Linear 
-000194b0: 636f 6e74 696e 7561 0a20 2020 2023 2063  continua.    # c
-000194c0: 6f6e 745f 7761 7665 203d 206e 702e 6172  ont_wave = np.ar
-000194d0: 616e 6765 2834 3030 2c20 322e 3565 3429  ange(400, 2.5e4)
-000194e0: 0a20 2020 2023 2066 6f72 2073 6c6f 7065  .    # for slope
-000194f0: 2069 6e20 736c 6f70 6573 3a0a 2020 2020   in slopes:.    
-00019500: 2320 2020 2020 6b65 7920 3d20 2773 6c6f  #     key = 'slo
-00019510: 7065 207b 307d 272e 666f 726d 6174 2873  pe {0}'.format(s
-00019520: 6c6f 7065 290a 2020 2020 2320 2020 2020  lope).    #     
-00019530: 7430 5b6b 6579 5d20 3d20 7431 5b6b 6579  t0[key] = t1[key
-00019540: 5d20 3d20 5370 6563 7472 756d 5465 6d70  ] = SpectrumTemp
-00019550: 6c61 7465 2877 6176 653d 636f 6e74 5f77  late(wave=cont_w
-00019560: 6176 652c 2066 6c75 783d 2863 6f6e 745f  ave, flux=(cont_
-00019570: 7761 7665 2f36 3536 332e 292a 2a73 6c6f  wave/6563.)**slo
-00019580: 7065 290a 0a20 2020 2069 6620 5273 706c  pe)..    if Rspl
-00019590: 696e 6520 6973 206e 6f74 204e 6f6e 653a  ine is not None:
-000195a0: 0a20 2020 2020 2020 2077 7370 6c69 6e65  .        wspline
-000195b0: 203d 206e 702e 6172 616e 6765 2834 3230   = np.arange(420
-000195c0: 302c 2032 2e35 6534 2c20 3130 290a 2020  0, 2.5e4, 10).  
-000195d0: 2020 2020 2020 6466 5f73 706c 203d 206c        df_spl = l
-000195e0: 6f67 5f7a 6772 6964 287a 723d 5b77 7370  og_zgrid(zr=[wsp
-000195f0: 6c69 6e65 5b30 5d2c 2077 7370 6c69 6e65  line[0], wspline
-00019600: 5b2d 315d 5d2c 2064 7a3d 312e 2f52 7370  [-1]], dz=1./Rsp
-00019610: 6c69 6e65 290a 2020 2020 2020 2020 6273  line).        bs
-00019620: 706c 696e 6573 203d 2062 7370 6c69 6e65  plines = bspline
-00019630: 5f74 656d 706c 6174 6573 2877 7370 6c69  _templates(wspli
-00019640: 6e65 2c20 6466 3d6c 656e 2864 665f 7370  ne, df=len(df_sp
-00019650: 6c29 2b32 2c20 6c6f 673d 5472 7565 2c0a  l)+2, log=True,.
-00019660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019680: 2020 2020 2063 6c69 703d 302e 3030 3031       clip=0.0001
-00019690: 290a 0a20 2020 2020 2020 2066 6f72 206b  )..        for k
-000196a0: 6579 2069 6e20 6273 706c 696e 6573 3a0a  ey in bsplines:.
-000196b0: 2020 2020 2020 2020 2020 2020 7430 5b6b              t0[k
-000196c0: 6579 5d20 3d20 7431 5b6b 6579 5d20 3d20  ey] = t1[key] = 
-000196d0: 6273 706c 696e 6573 5b6b 6579 5d0a 0a20  bsplines[key].. 
-000196e0: 2020 2065 6c69 6620 6e73 706c 696e 6520     elif nspline 
-000196f0: 3e20 303a 0a20 2020 2020 2020 2023 2053  > 0:.        # S
-00019700: 706c 696e 6520 636f 6e74 696e 7561 0a20  pline continua. 
-00019710: 2020 2020 2020 2063 6f6e 745f 7761 7665         cont_wave
-00019720: 203d 206e 702e 6172 616e 6765 2835 3030   = np.arange(500
-00019730: 302c 2032 2e34 6534 290a 2020 2020 2020  0, 2.4e4).      
-00019740: 2020 6273 706c 696e 6573 203d 2062 7370    bsplines = bsp
-00019750: 6c69 6e65 5f74 656d 706c 6174 6573 2863  line_templates(c
-00019760: 6f6e 745f 7761 7665 2c20 6466 3d6e 7370  ont_wave, df=nsp
-00019770: 6c69 6e65 2c20 6c6f 673d 5472 7565 290a  line, log=True).
-00019780: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00019790: 696e 2062 7370 6c69 6e65 733a 0a20 2020  in bsplines:.   
-000197a0: 2020 2020 2020 2020 2074 305b 6b65 795d           t0[key]
-000197b0: 203d 2074 315b 6b65 795d 203d 2062 7370   = t1[key] = bsp
-000197c0: 6c69 6e65 735b 6b65 795d 0a0a 2020 2020  lines[key]..    
-000197d0: 656c 6966 2062 6574 6173 2069 7320 6e6f  elif betas is no
-000197e0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000197f0: 6274 656d 7020 3d20 6c6f 6164 5f62 6574  btemp = load_bet
-00019800: 615f 7465 6d70 6c61 7465 7328 7761 7665  a_templates(wave
-00019810: 3d6e 702e 6172 616e 6765 2834 3030 2c20  =np.arange(400, 
-00019820: 322e 3565 3429 2c20 6265 7461 733d 6265  2.5e4), betas=be
-00019830: 7461 7329 0a20 2020 2020 2020 2066 6f72  tas).        for
-00019840: 206b 6579 2069 6e20 6274 656d 703a 0a20   key in btemp:. 
-00019850: 2020 2020 2020 2020 2020 2074 305b 6b65             t0[ke
-00019860: 795d 203d 2074 315b 6b65 795d 203d 2062  y] = t1[key] = b
-00019870: 7465 6d70 5b6b 6579 5d0a 0a20 2020 2065  temp[key]..    e
-00019880: 6c73 653a 0a20 2020 2020 2020 2023 204f  lse:.        # O
-00019890: 6273 6572 7665 6420 6672 616d 6520 7374  bserved frame st
-000198a0: 6570 730a 2020 2020 2020 2020 6f6e 6564  eps.        oned
-000198b0: 5220 3d20 2d6e 7370 6c69 6e65 0a20 2020  R = -nspline.   
-000198c0: 2020 2020 2077 6c69 6d20 3d20 5b35 3030       wlim = [500
-000198d0: 302c 2031 3830 3030 2e30 5d0a 2020 2020  0, 18000.0].    
-000198e0: 2020 2020 6269 6e5f 7374 6570 732c 2073      bin_steps, s
-000198f0: 7465 705f 7465 6d70 6c20 3d20 7374 6570  tep_templ = step
-00019900: 5f74 656d 706c 6174 6573 2877 6c69 6d3d  _templates(wlim=
-00019910: 776c 696d 2c20 523d 6f6e 6564 522c 0a20  wlim, R=onedR,. 
-00019920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019940: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-00019950: 756e 643d 3130 290a 2020 2020 2020 2020  und=10).        
-00019960: 666f 7220 6b65 7920 696e 2073 7465 705f  for key in step_
-00019970: 7465 6d70 6c3a 0a20 2020 2020 2020 2020  templ:.         
-00019980: 2020 2074 305b 6b65 795d 203d 2074 315b     t0[key] = t1[
-00019990: 6b65 795d 203d 2073 7465 705f 7465 6d70  key] = step_temp
-000199a0: 6c5b 6b65 795d 0a0a 2020 2020 2320 7430  l[key]..    # t0
-000199b0: 5b27 626c 7565 275d 203d 2074 315b 2762  ['blue'] = t1['b
-000199c0: 6c75 6527 5d20 3d20 5370 6563 7472 756d  lue'] = Spectrum
-000199d0: 5465 6d70 6c61 7465 2877 6176 653d 636f  Template(wave=co
-000199e0: 6e74 5f77 6176 652c 2066 6c75 783d 2863  nt_wave, flux=(c
-000199f0: 6f6e 745f 7761 7665 2f36 3536 332e 292a  ont_wave/6563.)*
-00019a00: 2a2d 322e 3829 0a20 2020 2023 2074 305b  *-2.8).    # t0[
-00019a10: 276d 6964 275d 203d 2074 315b 276d 6964  'mid'] = t1['mid
-00019a20: 275d 203d 2053 7065 6374 7275 6d54 656d  '] = SpectrumTem
-00019a30: 706c 6174 6528 7761 7665 3d63 6f6e 745f  plate(wave=cont_
-00019a40: 7761 7665 2c20 666c 7578 3d28 636f 6e74  wave, flux=(cont
-00019a50: 5f77 6176 652f 3635 3633 2e29 2a2a 3029  _wave/6563.)**0)
-00019a60: 0a20 2020 2023 2074 305b 2772 6564 275d  .    # t0['red']
-00019a70: 203d 2074 315b 276d 6964 275d 203d 2053   = t1['mid'] = S
-00019a80: 7065 6374 7275 6d54 656d 706c 6174 6528  pectrumTemplate(
-00019a90: 7761 7665 3d63 6f6e 745f 7761 7665 2c20  wave=cont_wave, 
-00019aa0: 666c 7578 3d28 636f 6e74 5f77 6176 652f  flux=(cont_wave/
-00019ab0: 3635 3633 2e29 2a2a 322e 3829 0a0a 2020  6563.)**2.8)..  
-00019ac0: 2020 7265 7475 726e 2074 302c 2074 310a    return t0, t1.
-00019ad0: 0a0a 5048 4f45 4e49 585f 4c4f 4747 5f46  ..PHOENIX_LOGG_F
-00019ae0: 554c 4c20 3d20 5b33 2e30 2c20 332e 352c  ULL = [3.0, 3.5,
-00019af0: 2034 2e30 2c20 342e 352c 2035 2e30 2c20   4.0, 4.5, 5.0, 
-00019b00: 352e 355d 0a50 484f 454e 4958 5f4c 4f47  5.5].PHOENIX_LOG
-00019b10: 4720 3d20 5b34 2e30 2c20 342e 352c 2035  G = [4.0, 4.5, 5
-00019b20: 2e30 2c20 352e 355d 0a0a 5048 4f45 4e49  .0, 5.5]..PHOENI
-00019b30: 585f 5445 4646 5f46 554c 4c20 3d20 5b34  X_TEFF_FULL = [4
-00019b40: 3030 2e30 2c20 3432 302e 302c 2034 3530  00.0, 420.0, 450
-00019b50: 2e30 2c20 3530 302e 302c 2035 3530 2e30  .0, 500.0, 550.0
-00019b60: 2c20 3630 302e 302c 2036 3530 2e30 2c20  , 600.0, 650.0, 
-00019b70: 3730 302e 302c 2037 3530 2e30 2c20 3830  700.0, 750.0, 80
-00019b80: 302e 302c 2038 3530 2e30 2c20 3930 302e  0.0, 850.0, 900.
-00019b90: 302c 2039 3530 2e30 2c20 3130 3030 2e30  0, 950.0, 1000.0
-00019ba0: 2c20 3130 3530 2e30 2c20 3131 3030 2e30  , 1050.0, 1100.0
-00019bb0: 2c20 3131 3530 2e30 2c20 3132 3030 2e30  , 1150.0, 1200.0
-00019bc0: 2c20 3132 3530 2e30 2c20 3133 3030 2e30  , 1250.0, 1300.0
-00019bd0: 2c20 3133 3530 2e30 2c20 3134 3030 2e30  , 1350.0, 1400.0
-00019be0: 2c20 3134 3530 2e30 2c20 3135 3030 2e30  , 1450.0, 1500.0
-00019bf0: 2c20 3135 3530 2e30 2c20 3136 3030 2e30  , 1550.0, 1600.0
-00019c00: 2c20 3136 3530 2e30 2c20 3137 3030 2e30  , 1650.0, 1700.0
-00019c10: 2c20 3137 3530 2e30 2c20 3138 3030 2e30  , 1750.0, 1800.0
-00019c20: 2c20 3138 3530 2e30 2c20 3139 3030 2e30  , 1850.0, 1900.0
-00019c30: 2c20 3139 3530 2e30 2c20 3230 3030 2e30  , 1950.0, 2000.0
-00019c40: 2c20 3231 3030 2e30 2c20 3232 3030 2e30  , 2100.0, 2200.0
-00019c50: 2c20 3233 3030 2e30 2c20 3234 3030 2e30  , 2300.0, 2400.0
-00019c60: 2c20 3235 3030 2e30 2c20 3236 3030 2e30  , 2500.0, 2600.0
-00019c70: 2c20 3237 3030 2e30 2c20 3238 3030 2e30  , 2700.0, 2800.0
-00019c80: 2c20 3239 3030 2e30 2c20 3330 3030 2e30  , 2900.0, 3000.0
-00019c90: 2c20 3331 3030 2e30 2c20 3332 3030 2e30  , 3100.0, 3200.0
-00019ca0: 2c20 3333 3030 2e30 2c20 3334 3030 2e30  , 3300.0, 3400.0
-00019cb0: 2c20 3335 3030 2e30 2c20 3336 3030 2e30  , 3500.0, 3600.0
-00019cc0: 2c20 3337 3030 2e30 2c20 3338 3030 2e30  , 3700.0, 3800.0
-00019cd0: 2c20 3339 3030 2e30 2c20 3430 3030 2e30  , 3900.0, 4000.0
-00019ce0: 2c20 3431 3030 2e30 2c20 3432 3030 2e30  , 4100.0, 4200.0
-00019cf0: 2c20 3433 3030 2e30 2c20 3434 3030 2e30  , 4300.0, 4400.0
-00019d00: 2c20 3435 3030 2e30 2c20 3436 3030 2e30  , 4500.0, 4600.0
-00019d10: 2c20 3437 3030 2e30 2c20 3438 3030 2e30  , 4700.0, 4800.0
-00019d20: 2c20 3439 3030 2e30 2c20 3530 3030 2e30  , 4900.0, 5000.0
-00019d30: 5d0a 0a50 484f 454e 4958 5f54 4546 4620  ]..PHOENIX_TEFF 
-00019d40: 3d20 5b34 3030 2e2c 2020 3432 302e 2c20  = [400.,  420., 
-00019d50: 3435 302e 2c20 3530 302e 2c20 2035 3530  450., 500.,  550
-00019d60: 2e2c 2036 3030 2e2c 2020 3635 302e 2c20  ., 600.,  650., 
-00019d70: 3730 302e 2c20 2037 3530 2e2c 0a20 2020  700.,  750.,.   
-00019d80: 2020 2020 3830 302e 2c20 2038 3530 2e2c      800.,  850.,
-00019d90: 2039 3030 2e2c 2039 3530 2e2c 2031 3030   900., 950., 100
-00019da0: 302e 2c20 3130 3530 2e2c 2031 3130 302e  0., 1050., 1100.
-00019db0: 2c20 3131 3530 2e2c 2031 3230 302e 2c0a  , 1150., 1200.,.
-00019dc0: 2020 2020 2020 2031 3330 302e 2c20 3134         1300., 14
-00019dd0: 3030 2e2c 2031 3530 302e 2c20 3136 3030  00., 1500., 1600
-00019de0: 2e2c 2031 3730 302e 2c20 3138 3030 2e2c  ., 1700., 1800.,
-00019df0: 2031 3930 302e 2c20 3230 3030 2e2c 2032   1900., 2000., 2
-00019e00: 3130 302e 2c0a 2020 2020 2020 2032 3230  100.,.       220
-00019e10: 302e 2c20 3233 3030 2e2c 2032 3430 302e  0., 2300., 2400.
-00019e20: 2c20 3235 3030 2e2c 2032 3630 302e 2c20  , 2500., 2600., 
-00019e30: 3237 3030 2e2c 2032 3830 302e 2c20 3239  2700., 2800., 29
-00019e40: 3030 2e2c 2033 3030 302e 2c0a 2020 2020  00., 3000.,.    
-00019e50: 2020 2033 3130 302e 2c20 3332 3030 2e2c     3100., 3200.,
-00019e60: 2033 3330 302e 2c20 3334 3030 2e2c 2033   3300., 3400., 3
-00019e70: 3530 302e 2c20 3336 3030 2e2c 2033 3730  500., 3600., 370
-00019e80: 302e 2c20 3338 3030 2e2c 2033 3930 302e  0., 3800., 3900.
-00019e90: 2c20 3430 3030 2e2c 0a20 2020 2020 2020  , 4000.,.       
-00019ea0: 3432 3030 2e2c 2034 3430 302e 2c20 3436  4200., 4400., 46
-00019eb0: 3030 2e2c 2034 3830 302e 2c20 3530 3030  00., 4800., 5000
-00019ec0: 2e2c 2035 3530 302e 2c20 3535 3030 2c20  ., 5500., 5500, 
-00019ed0: 3630 3030 2e2c 2036 3530 302e 2c20 3730  6000., 6500., 70
-00019ee0: 3030 2e5d 0a0a 5048 4f45 4e49 585f 5a4d  00.]..PHOENIX_ZM
-00019ef0: 4554 5f46 554c 4c20 3d20 5b2d 322e 352c  ET_FULL = [-2.5,
-00019f00: 202d 322e 302c 202d 312e 352c 202d 312e   -2.0, -1.5, -1.
-00019f10: 302c 202d 302e 352c 202d 302e 2c20 302e  0, -0.5, -0., 0.
-00019f20: 355d 0a50 484f 454e 4958 5f5a 4d45 5420  5].PHOENIX_ZMET 
-00019f30: 3d20 5b2d 312e 302c 202d 302e 352c 202d  = [-1.0, -0.5, -
-00019f40: 302e 5d0a 0a0a 6465 6620 6c6f 6164 5f70  0.]...def load_p
-00019f50: 686f 656e 6978 5f73 7461 7273 286c 6f67  hoenix_stars(log
-00019f60: 675f 6c69 7374 3d50 484f 454e 4958 5f4c  g_list=PHOENIX_L
-00019f70: 4f47 472c 2074 6566 665f 6c69 7374 3d50  OGG, teff_list=P
-00019f80: 484f 454e 4958 5f54 4546 462c 207a 6d65  HOENIX_TEFF, zme
-00019f90: 745f 6c69 7374 3d50 484f 454e 4958 5f5a  t_list=PHOENIX_Z
-00019fa0: 4d45 542c 2061 6464 5f63 6172 626f 6e5f  MET, add_carbon_
-00019fb0: 7374 6172 3d54 7275 652c 2066 696c 653d  star=True, file=
-00019fc0: 2762 742d 7365 7474 6c5f 7434 3030 2d37  'bt-settl_t400-7
-00019fd0: 3030 305f 6734 2e35 2e66 6974 7327 293a  000_g4.5.fits'):
-00019fe0: 0a20 2020 2022 2222 0a20 2020 204c 6f61  .    """.    Loa
-00019ff0: 6420 5068 6f65 6e69 7820 7374 656c 6c61  d Phoenix stella
-0001a000: 7220 7465 6d70 6c61 7465 730a 2020 2020  r templates.    
-0001a010: 2222 220a 2020 2020 6672 6f6d 2063 6f6c  """.    from col
-0001a020: 6c65 6374 696f 6e73 2069 6d70 6f72 7420  lections import 
-0001a030: 4f72 6465 7265 6444 6963 740a 2020 2020  OrderedDict.    
-0001a040: 7472 793a 0a20 2020 2020 2020 2066 726f  try:.        fro
-0001a050: 6d20 7572 6c6c 6962 2e72 6571 7565 7374  m urllib.request
-0001a060: 2069 6d70 6f72 7420 7572 6c72 6574 7269   import urlretri
-0001a070: 6576 650a 2020 2020 6578 6365 7074 3a0a  eve.    except:.
-0001a080: 2020 2020 2020 2020 6672 6f6d 2075 726c          from url
-0001a090: 6c69 6220 696d 706f 7274 2075 726c 7265  lib import urlre
-0001a0a0: 7472 6965 7665 0a0a 2020 2020 2320 6669  trieve..    # fi
-0001a0b0: 6c65 3d27 6274 2d73 6574 746c 5f74 3430  le='bt-settl_t40
-0001a0c0: 302d 3530 3030 5f67 342e 352e 6669 7473  0-5000_g4.5.fits
-0001a0d0: 270a 2020 2020 2320 6669 6c65 3d27 6274  '.    # file='bt
-0001a0e0: 2d73 6574 746c 5f74 3430 302d 3335 3030  -settl_t400-3500
-0001a0f0: 5f7a 302e 302e 6669 7473 270a 0a20 2020  _z0.0.fits'..   
-0001a100: 2074 7279 3a0a 2020 2020 2020 2020 6864   try:.        hd
-0001a110: 7520 3d20 7079 6669 7473 2e6f 7065 6e28  u = pyfits.open(
-0001a120: 6f73 2e70 6174 682e 6a6f 696e 2847 5249  os.path.join(GRI
-0001a130: 5a4c 495f 5041 5448 2c20 2774 656d 706c  ZLI_PATH, 'templ
-0001a140: 6174 6573 2f73 7461 7273 2f27 2c20 6669  ates/stars/', fi
-0001a150: 6c65 2929 0a20 2020 2065 7863 6570 743a  le)).    except:
-0001a160: 0a20 2020 2020 2020 2023 7572 6c20 3d20  .        #url = 
-0001a170: 2768 7474 7073 3a2f 2f73 332e 616d 617a  'https://s3.amaz
-0001a180: 6f6e 6177 732e 636f 6d2f 6772 697a 6c69  onaws.com/grizli
-0001a190: 2f43 4f4e 4627 0a20 2020 2020 2020 2023  /CONF'.        #
-0001a1a0: 7572 6c20 3d20 2768 7474 7073 3a2f 2f65  url = 'https://e
-0001a1b0: 7264 612e 6b75 2e64 6b2f 7667 7269 642f  rda.ku.dk/vgrid/
-0001a1c0: 4761 6272 6965 6c25 3230 4272 616d 6d65  Gabriel%20Bramme
-0001a1d0: 722f 434f 4e46 270a 2020 2020 2020 2020  r/CONF'.        
-0001a1e0: 7572 6c20 3d20 2827 6874 7470 733a 2f2f  url = ('https://
-0001a1f0: 7261 772e 6769 7468 7562 7573 6572 636f  raw.githubuserco
-0001a200: 6e74 656e 742e 636f 6d2f 6762 7261 6d6d  ntent.com/gbramm
-0001a210: 6572 2f27 202b 0a20 2020 2020 2020 2020  er/' +.         
-0001a220: 2020 2020 2020 2767 7269 7a6c 692d 636f        'grizli-co
-0001a230: 6e66 6967 2f6d 6173 7465 7227 290a 0a20  nfig/master').. 
-0001a240: 2020 2020 2020 2070 7269 6e74 2827 4665         print('Fe
-0001a250: 7463 6820 7b30 7d2f 7b31 7d27 2e66 6f72  tch {0}/{1}'.for
-0001a260: 6d61 7428 7572 6c2c 2066 696c 6529 290a  mat(url, file)).
-0001a270: 0a20 2020 2020 2020 2023 6f73 2e73 7973  .        #os.sys
-0001a280: 7465 6d28 2777 6765 7420 2d4f 202f 746d  tem('wget -O /tm
-0001a290: 702f 7b31 7d20 7b30 7d2f 7b31 7d27 2e66  p/{1} {0}/{1}'.f
-0001a2a0: 6f72 6d61 7428 7572 6c2c 2066 696c 6529  ormat(url, file)
-0001a2b0: 290a 2020 2020 2020 2020 7265 7320 3d20  ).        res = 
-0001a2c0: 7572 6c72 6574 7269 6576 6528 277b 307d  urlretrieve('{0}
-0001a2d0: 2f7b 317d 272e 666f 726d 6174 2875 726c  /{1}'.format(url
-0001a2e0: 2c20 6669 6c65 292c 0a20 2020 2020 2020  , file),.       
-0001a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a300: 2020 2066 696c 656e 616d 653d 6f73 2e70     filename=os.p
-0001a310: 6174 682e 6a6f 696e 2827 2f74 6d70 272c  ath.join('/tmp',
-0001a320: 2066 696c 6529 290a 0a20 2020 2020 2020   file))..       
-0001a330: 2068 6475 203d 2070 7966 6974 732e 6f70   hdu = pyfits.op
-0001a340: 656e 286f 732e 7061 7468 2e6a 6f69 6e28  en(os.path.join(
-0001a350: 272f 746d 702f 272c 2066 696c 6529 290a  '/tmp/', file)).
-0001a360: 0a20 2020 2074 6162 203d 2047 5461 626c  .    tab = GTabl
-0001a370: 652e 6772 6561 6428 6864 755b 315d 290a  e.gread(hdu[1]).
-0001a380: 2020 2020 6864 752e 636c 6f73 6528 290a      hdu.close().
-0001a390: 2020 2020 0a20 2020 2074 7374 6172 7320      .    tstars 
-0001a3a0: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
-0001a3b0: 2020 2020 4e20 3d20 7461 625b 2766 6c75      N = tab['flu
-0001a3c0: 7827 5d2e 7368 6170 655b 315d 0a20 2020  x'].shape[1].   
-0001a3d0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0001a3e0: 4e29 3a0a 2020 2020 2020 2020 7465 6666  N):.        teff
-0001a3f0: 203d 2074 6162 2e6d 6574 615b 2754 4546   = tab.meta['TEF
-0001a400: 467b 303a 3033 647d 272e 666f 726d 6174  F{0:03d}'.format
-0001a410: 2869 295d 0a20 2020 2020 2020 206c 6f67  (i)].        log
-0001a420: 6720 3d20 7461 622e 6d65 7461 5b27 4c4f  g = tab.meta['LO
-0001a430: 4747 7b30 3a30 3364 7d27 2e66 6f72 6d61  GG{0:03d}'.forma
-0001a440: 7428 6929 5d0a 2020 2020 2020 2020 7472  t(i)].        tr
-0001a450: 793a 0a20 2020 2020 2020 2020 2020 206d  y:.            m
-0001a460: 6574 203d 2074 6162 2e6d 6574 615b 275a  et = tab.meta['Z
-0001a470: 4d45 547b 303a 3033 647d 272e 666f 726d  MET{0:03d}'.form
-0001a480: 6174 2869 295d 0a20 2020 2020 2020 2065  at(i)].        e
-0001a490: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-0001a4a0: 2020 206d 6574 203d 2030 2e0a 0a20 2020     met = 0...   
-0001a4b0: 2020 2020 2069 6620 286c 6f67 6720 6e6f       if (logg no
-0001a4c0: 7420 696e 206c 6f67 675f 6c69 7374 2920  t in logg_list) 
-0001a4d0: 7c20 2874 6566 6620 6e6f 7420 696e 2074  | (teff not in t
-0001a4e0: 6566 665f 6c69 7374 2920 7c20 286d 6574  eff_list) | (met
-0001a4f0: 206e 6f74 2069 6e20 7a6d 6574 5f6c 6973   not in zmet_lis
-0001a500: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0001a510: 2370 7269 6e74 2827 536b 6970 207b 307d  #print('Skip {0}
-0001a520: 207b 317d 272e 666f 726d 6174 286c 6f67   {1}'.format(log
-0001a530: 672c 2074 6566 6629 290a 2020 2020 2020  g, teff)).      
-0001a540: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0001a550: 2020 2020 2020 2020 6c61 6265 6c20 3d20          label = 
-0001a560: 2762 742d 7365 7474 6c5f 747b 303a 3035  'bt-settl_t{0:05
-0001a570: 2e30 667d 5f67 7b31 3a33 2e31 667d 5f6d  .0f}_g{1:3.1f}_m
-0001a580: 7b32 3a2e 3166 7d27 2e66 6f72 6d61 7428  {2:.1f}'.format(
-0001a590: 7465 6666 2c20 6c6f 6767 2c20 6d65 7429  teff, logg, met)
-0001a5a0: 0a0a 2020 2020 2020 2020 7473 7461 7273  ..        tstars
-0001a5b0: 5b6c 6162 656c 5d20 3d20 5370 6563 7472  [label] = Spectr
-0001a5c0: 756d 5465 6d70 6c61 7465 2877 6176 653d  umTemplate(wave=
-0001a5d0: 7461 625b 2777 6176 6527 5d2c 0a20 2020  tab['wave'],.   
-0001a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a600: 2020 2020 2020 666c 7578 3d74 6162 5b27        flux=tab['
-0001a610: 666c 7578 275d 5b3a 2c20 695d 2c20 6e61  flux'][:, i], na
-0001a620: 6d65 3d6c 6162 656c 290a 0a20 2020 2069  me=label)..    i
-0001a630: 6620 6164 645f 6361 7262 6f6e 5f73 7461  f add_carbon_sta
-0001a640: 723a 0a20 2020 2020 2020 2063 6669 6c65  r:.        cfile
-0001a650: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0001a660: 4752 495a 4c49 5f50 4154 482c 2027 7465  GRIZLI_PATH, 'te
-0001a670: 6d70 6c61 7465 732f 7374 6172 732f 6361  mplates/stars/ca
-0001a680: 7262 6f6e 5f73 7461 722e 7478 7427 290a  rbon_star.txt').
-0001a690: 2020 2020 2020 2020 7370 203d 2072 6561          sp = rea
-0001a6a0: 645f 6361 7461 6c6f 6728 6366 696c 6529  d_catalog(cfile)
-0001a6b0: 0a20 2020 2020 2020 2069 6620 6164 645f  .        if add_
-0001a6c0: 6361 7262 6f6e 5f73 7461 7220 3e20 313a  carbon_star > 1:
-0001a6d0: 0a20 2020 2020 2020 2020 2020 2069 6d70  .            imp
-0001a6e0: 6f72 7420 7363 6970 792e 6e64 696d 6167  ort scipy.ndimag
-0001a6f0: 6520 6173 206e 640a 2020 2020 2020 2020  e as nd.        
-0001a700: 2020 2020 6366 6c75 7820 3d20 6e64 2e67      cflux = nd.g
-0001a710: 6175 7373 6961 6e5f 6669 6c74 6572 2873  aussian_filter(s
-0001a720: 705b 2766 6c75 7827 5d2c 2061 6464 5f63  p['flux'], add_c
-0001a730: 6172 626f 6e5f 7374 6172 290a 2020 2020  arbon_star).    
-0001a740: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001a750: 2020 2020 2020 6366 6c75 7820 3d20 7370        cflux = sp
-0001a760: 5b27 666c 7578 275d 0a0a 2020 2020 2020  ['flux']..      
-0001a770: 2020 7473 7461 7273 5b27 6274 2d73 6574    tstars['bt-set
-0001a780: 746c 5f74 3035 3030 305f 6730 2e30 5f6d  tl_t05000_g0.0_m
-0001a790: 302e 3027 5d20 3d20 5370 6563 7472 756d  0.0'] = Spectrum
-0001a7a0: 5465 6d70 6c61 7465 2877 6176 653d 7370  Template(wave=sp
-0001a7b0: 5b27 7761 7665 275d 2c20 666c 7578 3d63  ['wave'], flux=c
-0001a7c0: 666c 7578 2c20 6e61 6d65 3d27 6361 7262  flux, name='carb
-0001a7d0: 6f6e 2d6c 616e 636f 6e32 3030 3227 290a  on-lancon2002').
-0001a7e0: 0a20 2020 2072 6574 7572 6e20 7473 7461  .    return tsta
-0001a7f0: 7273 0a0a 0a64 6566 206c 6f61 645f 7364  rs...def load_sd
-0001a800: 7373 5f70 6361 5f74 656d 706c 6174 6573  ss_pca_templates
-0001a810: 2866 696c 653d 2773 7045 6967 656e 5153  (file='spEigenQS
-0001a820: 4f2d 3535 3733 322e 6669 7473 272c 2073  O-55732.fits', s
-0001a830: 6d6f 6f74 683d 3330 3030 293a 0a20 2020  mooth=3000):.   
-0001a840: 2022 2222 0a20 2020 204c 6f61 6420 5344   """.    Load SD
-0001a850: 5353 2065 6967 656e 2074 656d 706c 6174  SS eigen templat
-0001a860: 6573 0a20 2020 2022 2222 0a20 2020 2066  es.    """.    f
-0001a870: 726f 6d20 636f 6c6c 6563 7469 6f6e 7320  rom collections 
-0001a880: 696d 706f 7274 204f 7264 6572 6564 4469  import OrderedDi
-0001a890: 6374 0a20 2020 2069 6d70 6f72 7420 7363  ct.    import sc
-0001a8a0: 6970 792e 6e64 696d 6167 6520 6173 206e  ipy.ndimage as n
-0001a8b0: 640a 0a20 2020 2069 6d20 3d20 7079 6669  d..    im = pyfi
-0001a8c0: 7473 2e6f 7065 6e28 6f73 2e70 6174 682e  ts.open(os.path.
-0001a8d0: 6a6f 696e 2847 5249 5a4c 495f 5041 5448  join(GRIZLI_PATH
-0001a8e0: 2c20 2774 656d 706c 6174 6573 272c 2066  , 'templates', f
-0001a8f0: 696c 6529 290a 2020 2020 6820 3d20 696d  ile)).    h = im
-0001a900: 5b30 5d2e 6865 6164 6572 0a20 2020 206c  [0].header.    l
-0001a910: 6f67 5f77 6176 6520 3d20 6e70 2e61 7261  og_wave = np.ara
-0001a920: 6e67 6528 685b 274e 4158 4953 3127 5d29  nge(h['NAXIS1'])
-0001a930: 2a68 5b27 434f 4546 4631 275d 2b68 5b27  *h['COEFF1']+h['
-0001a940: 434f 4546 4630 275d 0a20 2020 2077 6176  COEFF0'].    wav
-0001a950: 6520 3d20 3130 2a2a 6c6f 675f 7761 7665  e = 10**log_wave
-0001a960: 0a0a 2020 2020 6e61 6d65 203d 2066 696c  ..    name = fil
-0001a970: 652e 7370 6c69 7428 272e 6669 7473 2729  e.split('.fits')
-0001a980: 5b30 5d0a 0a20 2020 2069 6620 736d 6f6f  [0]..    if smoo
-0001a990: 7468 203e 2030 3a0a 2020 2020 2020 2020  th > 0:.        
-0001a9a0: 6476 5f69 6e20 3d20 685b 2743 4f45 4646  dv_in = h['COEFF
-0001a9b0: 3127 5d2a 332e 6535 0a20 2020 2020 2020  1']*3.e5.       
-0001a9c0: 206e 203d 2073 6d6f 6f74 6820 2f20 6476   n = smooth / dv
-0001a9d0: 5f69 6e0a 2020 2020 2020 2020 6461 7461  _in.        data
-0001a9e0: 203d 206e 642e 6761 7573 7369 616e 5f66   = nd.gaussian_f
-0001a9f0: 696c 7465 7231 6428 696d 5b30 5d2e 6461  ilter1d(im[0].da
-0001aa00: 7461 2c20 6e2c 2061 7869 733d 3129 2e61  ta, n, axis=1).a
-0001aa10: 7374 7970 6528 6e70 2e66 6c6f 6174 3634  stype(np.float64
-0001aa20: 290a 2020 2020 2020 2020 736b 6970 203d  ).        skip =
-0001aa30: 2069 6e74 286e 2f32 2e35 290a 2020 2020   int(n/2.5).    
-0001aa40: 2020 2020 7761 7665 203d 2077 6176 655b      wave = wave[
-0001aa50: 3a3a 736b 6970 5d0a 2020 2020 2020 2020  ::skip].        
-0001aa60: 6461 7461 203d 2064 6174 615b 3a2c 203a  data = data[:, :
-0001aa70: 3a73 6b69 705d 0a20 2020 2065 6c73 653a  :skip].    else:
-0001aa80: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
-0001aa90: 696d 5b30 5d2e 6461 7461 2e61 7374 7970  im[0].data.astyp
-0001aaa0: 6528 6e70 2e66 6c6f 6174 3634 290a 0a20  e(np.float64).. 
-0001aab0: 2020 204e 203d 2068 5b27 4e41 5849 5332     N = h['NAXIS2
-0001aac0: 275d 0a20 2020 2074 656d 705f 6c69 7374  '].    temp_list
-0001aad0: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
-0001aae0: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
-0001aaf0: 6e67 6528 4e29 3a0a 2020 2020 2020 2020  nge(N):.        
-0001ab00: 7465 6d70 5f6c 6973 745b 277b 307d 207b  temp_list['{0} {
-0001ab10: 317d 272e 666f 726d 6174 286e 616d 652c  1}'.format(name,
-0001ab20: 2069 2b31 295d 203d 2053 7065 6374 7275   i+1)] = Spectru
-0001ab30: 6d54 656d 706c 6174 6528 7761 7665 3d77  mTemplate(wave=w
-0001ab40: 6176 652c 2066 6c75 783d 6461 7461 5b69  ave, flux=data[i
-0001ab50: 2c20 3a5d 290a 2020 2020 0a20 2020 2069  , :]).    .    i
-0001ab60: 6d2e 636c 6f73 6528 290a 2020 2020 0a20  m.close().    . 
-0001ab70: 2020 2072 6574 7572 6e20 7465 6d70 5f6c     return temp_l
-0001ab80: 6973 740a 0a0a 6465 6620 6368 6562 5f74  ist...def cheb_t
-0001ab90: 656d 706c 6174 6573 2877 6176 652c 206f  emplates(wave, o
-0001aba0: 7264 6572 3d36 2c20 6765 745f 6d61 7472  rder=6, get_matr
-0001abb0: 6978 3d46 616c 7365 2c20 6c6f 673d 4661  ix=False, log=Fa
-0001abc0: 6c73 652c 2063 6c69 703d 312e 652d 342c  lse, clip=1.e-4,
-0001abd0: 206d 696e 6d61 783d 4e6f 6e65 293a 0a20   minmax=None):. 
-0001abe0: 2020 2022 2222 0a20 2020 2043 6865 6279     """.    Cheby
-0001abf0: 7368 6576 2070 6f6c 796e 6f6d 6961 6c20  shev polynomial 
-0001ac00: 6261 7369 7320 6675 6e63 7469 6f6e 730a  basis functions.
-0001ac10: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
-0001ac20: 206e 756d 7079 2e70 6f6c 796e 6f6d 6961   numpy.polynomia
-0001ac30: 6c2e 6368 6562 7973 6865 7620 696d 706f  l.chebyshev impo
-0001ac40: 7274 2063 6865 6276 616c 2c20 6368 6562  rt chebval, cheb
-0001ac50: 7661 6e64 6572 0a0a 2020 2020 6966 206d  vander..    if m
-0001ac60: 696e 6d61 7820 6973 204e 6f6e 653a 0a20  inmax is None:. 
-0001ac70: 2020 2020 2020 206d 6920 3d20 7761 7665         mi = wave
-0001ac80: 2e6d 696e 2829 0a20 2020 2020 2020 206d  .min().        m
-0001ac90: 6120 3d20 7761 7665 2e6d 6178 2829 0a20  a = wave.max(). 
-0001aca0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001acb0: 206d 692c 206d 6120 3d20 6e70 2e73 7175   mi, ma = np.squ
-0001acc0: 6565 7a65 286d 696e 6d61 7829 2a31 2e0a  eeze(minmax)*1..
-0001acd0: 0a20 2020 2069 6620 6c6f 673a 0a20 2020  .    if log:.   
-0001ace0: 2020 2020 2078 6920 3d20 6e70 2e6c 6f67       xi = np.log
-0001acf0: 2877 6176 6529 0a20 2020 2020 2020 206d  (wave).        m
-0001ad00: 6920 3d20 6e70 2e6c 6f67 286d 6929 0a20  i = np.log(mi). 
-0001ad10: 2020 2020 2020 206d 6120 3d20 6e70 2e6c         ma = np.l
-0001ad20: 6f67 286d 6129 0a20 2020 2065 6c73 653a  og(ma).    else:
-0001ad30: 0a20 2020 2020 2020 2078 6920 3d20 7761  .        xi = wa
-0001ad40: 7665 2a31 0a20 2020 200a 2020 2020 7820  ve*1.    .    x 
-0001ad50: 3d20 2878 692d 6d69 292a 322f 286d 612d  = (xi-mi)*2/(ma-
-0001ad60: 6d69 292d 310a 0a20 2020 206e 5f62 6173  mi)-1..    n_bas
-0001ad70: 6573 203d 206f 7264 6572 2b31 0a20 2020  es = order+1.   
-0001ad80: 200a 2020 2020 6261 7369 7320 3d20 6368   .    basis = ch
-0001ad90: 6562 7661 6e64 6572 2878 2c20 6f72 6465  ebvander(x, orde
-0001ada0: 7229 0a20 2020 2023 2062 6173 6973 203d  r).    # basis =
-0001adb0: 206e 702e 656d 7074 7928 2878 2e73 6861   np.empty((x.sha
-0001adc0: 7065 5b30 5d2c 206e 5f62 6173 6573 292c  pe[0], n_bases),
-0001add0: 2064 7479 7065 3d66 6c6f 6174 290a 2020   dtype=float).  
-0001ade0: 2020 2320 0a20 2020 2023 2078 7220 3d20    # .    # xr = 
-0001adf0: 6e70 2e61 7261 6e67 6528 6e5f 6261 7365  np.arange(n_base
-0001ae00: 7329 0a20 2020 2023 2066 6f72 2069 2069  s).    # for i i
-0001ae10: 6e20 7261 6e67 6528 6e5f 6261 7365 7329  n range(n_bases)
-0001ae20: 3a0a 2020 2020 2320 2020 2020 5f63 203d  :.    #     _c =
-0001ae30: 2028 7872 203d 3d20 6929 2a31 0a20 2020   (xr == i)*1.   
-0001ae40: 2023 2020 2020 2023 7072 696e 7428 5f63   #     #print(_c
-0001ae50: 2c20 7872 2c20 6929 0a20 2020 2023 2020  , xr, i).    #  
-0001ae60: 2020 2062 6173 6973 5b3a 2c69 5d20 3d20     basis[:,i] = 
-0001ae70: 6368 6562 7661 6c28 782c 205f 6329 0a20  chebval(x, _c). 
-0001ae80: 2020 2020 2020 200a 2020 2020 2366 6f72         .    #for
-0001ae90: 2069 2069 6e20 7261 6e67 6528 6e5f 6261   i in range(n_ba
-0001aea0: 7365 7329 3a0a 2020 2020 6f75 745f 6f66  ses):.    out_of
-0001aeb0: 5f72 616e 6765 203d 2028 7869 203c 206d  _range = (xi < m
-0001aec0: 6929 207c 2028 7869 203e 206d 6129 0a20  i) | (xi > ma). 
-0001aed0: 2020 2062 6173 6973 5b6f 7574 5f6f 665f     basis[out_of_
-0001aee0: 7261 6e67 652c 3a5d 203d 2030 0a0a 2020  range,:] = 0..  
-0001aef0: 2020 6966 2067 6574 5f6d 6174 7269 783a    if get_matrix:
-0001af00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001af10: 6261 7369 730a 0a20 2020 2074 656d 7020  basis..    temp 
-0001af20: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
-0001af30: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0001af40: 6765 286e 5f62 6173 6573 293a 0a20 2020  ge(n_bases):.   
-0001af50: 2020 2020 206b 6579 203d 2066 2763 6865       key = f'che
-0001af60: 6220 6f7b 697d 270a 2020 2020 2020 2020  b o{i}'.        
-0001af70: 7465 6d70 5b6b 6579 5d20 3d20 5370 6563  temp[key] = Spec
-0001af80: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
-0001af90: 652c 2062 6173 6973 5b3a 2c69 5d29 0a20  e, basis[:,i]). 
-0001afa0: 2020 2020 2020 2074 656d 705b 6b65 795d         temp[key]
-0001afb0: 2e6e 616d 6520 3d20 6b65 790a 0a20 2020  .name = key..   
-0001afc0: 2072 6574 7572 6e20 7465 6d70 0a20 2020   return temp.   
-0001afd0: 200a 6465 6620 6273 706c 696e 655f 7465   .def bspline_te
-0001afe0: 6d70 6c61 7465 7328 7761 7665 2c20 6465  mplates(wave, de
-0001aff0: 6772 6565 3d33 2c20 6466 3d36 2c20 6765  gree=3, df=6, ge
-0001b000: 745f 6d61 7472 6978 3d46 616c 7365 2c20  t_matrix=False, 
-0001b010: 6c6f 673d 4661 6c73 652c 2063 6c69 703d  log=False, clip=
-0001b020: 312e 652d 342c 206d 696e 6d61 783d 4e6f  1.e-4, minmax=No
-0001b030: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
-0001b040: 2042 2d73 706c 696e 6520 6261 7369 7320   B-spline basis 
-0001b050: 6675 6e63 7469 6f6e 732c 206d 6f64 656c  functions, model
-0001b060: 6564 2061 6674 6572 2060 7e70 6174 7379  ed after `~patsy
-0001b070: 2e73 706c 696e 6573 600a 2020 2020 2222  .splines`.    ""
-0001b080: 220a 2020 2020 6672 6f6d 2073 6369 7079  ".    from scipy
-0001b090: 2e69 6e74 6572 706f 6c61 7465 2069 6d70  .interpolate imp
-0001b0a0: 6f72 7420 7370 6c65 760a 0a20 2020 206f  ort splev..    o
-0001b0b0: 7264 6572 203d 2064 6567 7265 652b 310a  rder = degree+1.
-0001b0c0: 2020 2020 6e5f 696e 6e65 725f 6b6e 6f74      n_inner_knot
-0001b0d0: 7320 3d20 6466 202d 206f 7264 6572 0a20  s = df - order. 
-0001b0e0: 2020 2069 6e6e 6572 5f6b 6e6f 7473 203d     inner_knots =
-0001b0f0: 206e 702e 6c69 6e73 7061 6365 2830 2c20   np.linspace(0, 
-0001b100: 312c 206e 5f69 6e6e 6572 5f6b 6e6f 7473  1, n_inner_knots
-0001b110: 202b 2032 295b 313a 2d31 5d0a 0a20 2020   + 2)[1:-1]..   
-0001b120: 206e 6f72 6d5f 6b6e 6f74 7320 3d20 6e70   norm_knots = np
-0001b130: 2e63 6f6e 6361 7465 6e61 7465 2828 5b30  .concatenate(([0
-0001b140: 2c20 315d 202a 206f 7264 6572 2c0a 2020  , 1] * order,.  
-0001b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b160: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0001b170: 6e65 725f 6b6e 6f74 7329 290a 2020 2020  ner_knots)).    
-0001b180: 6e6f 726d 5f6b 6e6f 7473 2e73 6f72 7428  norm_knots.sort(
-0001b190: 290a 0a20 2020 2069 6620 6c6f 673a 0a20  )..    if log:. 
-0001b1a0: 2020 2020 2020 2078 7370 6c20 3d20 6e70         xspl = np
-0001b1b0: 2e6c 6f67 2877 6176 6529 0a20 2020 2065  .log(wave).    e
-0001b1c0: 6c73 653a 0a20 2020 2020 2020 2078 7370  lse:.        xsp
-0001b1d0: 6c20 3d20 7761 7665 2a31 0a0a 2020 2020  l = wave*1..    
-0001b1e0: 6966 206d 696e 6d61 7820 6973 204e 6f6e  if minmax is Non
-0001b1f0: 653a 0a20 2020 2020 2020 206d 6920 3d20  e:.        mi = 
-0001b200: 7873 706c 2e6d 696e 2829 0a20 2020 2020  xspl.min().     
-0001b210: 2020 206d 6120 3d20 7873 706c 2e6d 6178     ma = xspl.max
-0001b220: 2829 0a20 2020 2065 6c73 653a 0a20 2020  ().    else:.   
-0001b230: 2020 2020 206d 692c 206d 6120 3d20 6d69       mi, ma = mi
-0001b240: 6e6d 6178 0a0a 2020 2020 7769 6474 6820  nmax..    width 
-0001b250: 3d20 6d61 2d6d 690a 2020 2020 616c 6c5f  = ma-mi.    all_
-0001b260: 6b6e 6f74 7320 3d20 6e6f 726d 5f6b 6e6f  knots = norm_kno
-0001b270: 7473 2a77 6964 7468 2b6d 690a 0a20 2020  ts*width+mi..   
-0001b280: 206e 5f62 6173 6573 203d 206c 656e 2861   n_bases = len(a
-0001b290: 6c6c 5f6b 6e6f 7473 2920 2d20 2864 6567  ll_knots) - (deg
-0001b2a0: 7265 6520 2b20 3129 0a20 2020 2062 6173  ree + 1).    bas
-0001b2b0: 6973 203d 206e 702e 656d 7074 7928 2878  is = np.empty((x
-0001b2c0: 7370 6c2e 7368 6170 655b 305d 2c20 6e5f  spl.shape[0], n_
-0001b2d0: 6261 7365 7329 2c20 6474 7970 653d 666c  bases), dtype=fl
-0001b2e0: 6f61 7429 0a0a 2020 2020 636f 6566 7320  oat)..    coefs 
-0001b2f0: 3d20 6e70 2e69 6465 6e74 6974 7928 6e5f  = np.identity(n_
-0001b300: 6261 7365 7329 0a20 2020 2062 6173 6973  bases).    basis
-0001b310: 203d 2073 706c 6576 2878 7370 6c2c 2028   = splev(xspl, (
-0001b320: 616c 6c5f 6b6e 6f74 732c 2063 6f65 6673  all_knots, coefs
-0001b330: 2c20 6465 6772 6565 2929 0a0a 2020 2020  , degree))..    
-0001b340: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
-0001b350: 5f62 6173 6573 293a 0a20 2020 2020 2020  _bases):.       
-0001b360: 206f 7574 5f6f 665f 7261 6e67 6520 3d20   out_of_range = 
-0001b370: 2878 7370 6c20 3c20 6d69 2920 7c20 2878  (xspl < mi) | (x
-0001b380: 7370 6c20 3e20 6d61 290a 2020 2020 2020  spl > ma).      
-0001b390: 2020 6261 7369 735b 695d 5b6f 7574 5f6f    basis[i][out_o
-0001b3a0: 665f 7261 6e67 655d 203d 2030 0a0a 2020  f_range] = 0..  
-0001b3b0: 2020 7761 7665 5f70 6561 6b20 3d20 6e70    wave_peak = np
-0001b3c0: 2e72 6f75 6e64 2877 6176 655b 6e70 2e61  .round(wave[np.a
-0001b3d0: 7267 6d61 7828 6261 7369 732c 2061 7869  rgmax(basis, axi
-0001b3e0: 733d 3129 5d29 0a0a 2020 2020 6d61 7876  s=1)])..    maxv
-0001b3f0: 616c 203d 206e 702e 6d61 7828 6261 7369  al = np.max(basi
-0001b400: 732c 2061 7869 733d 3129 0a20 2020 2066  s, axis=1).    f
-0001b410: 6f72 2069 2069 6e20 7261 6e67 6528 6e5f  or i in range(n_
-0001b420: 6261 7365 7329 3a0a 2020 2020 2020 2020  bases):.        
-0001b430: 6261 7369 735b 695d 5b62 6173 6973 5b69  basis[i][basis[i
-0001b440: 5d20 3c20 636c 6970 2a6d 6178 7661 6c5b  ] < clip*maxval[
-0001b450: 695d 5d20 3d20 300a 0a20 2020 2069 6620  i]] = 0..    if 
-0001b460: 6765 745f 6d61 7472 6978 3a0a 2020 2020  get_matrix:.    
-0001b470: 2020 2020 7265 7475 726e 206e 702e 7673      return np.vs
-0001b480: 7461 636b 2862 6173 6973 292e 540a 0a20  tack(basis).T.. 
-0001b490: 2020 2074 656d 7020 3d20 4f72 6465 7265     temp = Ordere
-0001b4a0: 6444 6963 7428 290a 2020 2020 666f 7220  dDict().    for 
-0001b4b0: 6920 696e 2072 616e 6765 286e 5f62 6173  i in range(n_bas
-0001b4c0: 6573 293a 0a20 2020 2020 2020 206b 6579  es):.        key
-0001b4d0: 203d 2027 6273 706c 207b 307d 207b 313a   = 'bspl {0} {1:
-0001b4e0: 2e30 667d 272e 666f 726d 6174 2869 2c20  .0f}'.format(i, 
-0001b4f0: 7761 7665 5f70 6561 6b5b 695d 290a 2020  wave_peak[i]).  
-0001b500: 2020 2020 2020 7465 6d70 5b6b 6579 5d20        temp[key] 
-0001b510: 3d20 5370 6563 7472 756d 5465 6d70 6c61  = SpectrumTempla
-0001b520: 7465 2877 6176 652c 2062 6173 6973 5b69  te(wave, basis[i
-0001b530: 5d29 0a20 2020 2020 2020 2074 656d 705b  ]).        temp[
-0001b540: 6b65 795d 2e6e 616d 6520 3d20 6b65 790a  key].name = key.
-0001b550: 2020 2020 2020 2020 7465 6d70 5b6b 6579          temp[key
-0001b560: 5d2e 7761 7665 5f70 6561 6b20 3d20 7761  ].wave_peak = wa
-0001b570: 7665 5f70 6561 6b5b 695d 0a0a 2020 2020  ve_peak[i]..    
-0001b580: 7465 6d70 2e6b 6e6f 7473 203d 2061 6c6c  temp.knots = all
-0001b590: 5f6b 6e6f 7473 0a20 2020 2074 656d 702e  _knots.    temp.
-0001b5a0: 6465 6772 6565 203d 2064 6567 7265 650a  degree = degree.
-0001b5b0: 2020 2020 7465 6d70 2e78 7370 6c20 3d20      temp.xspl = 
-0001b5c0: 7873 706c 0a0a 2020 2020 7265 7475 726e  xspl..    return
-0001b5d0: 2074 656d 700a 0a0a 6465 6620 6576 616c   temp...def eval
-0001b5e0: 5f62 7370 6c69 6e65 5f74 656d 706c 6174  _bspline_templat
-0001b5f0: 6573 2877 6176 652c 2062 7370 6c2c 2063  es(wave, bspl, c
-0001b600: 6f65 6673 293a 0a20 2020 2066 726f 6d20  oefs):.    from 
-0001b610: 7363 6970 792e 696e 7465 7270 6f6c 6174  scipy.interpolat
-0001b620: 6520 696d 706f 7274 2073 706c 6576 0a0a  e import splev..
-0001b630: 2020 2020 7873 706c 203d 206e 702e 6c6f      xspl = np.lo
-0001b640: 6728 7761 7665 290a 2020 2020 6261 7369  g(wave).    basi
-0001b650: 7320 3d20 7370 6c65 7628 7873 706c 2c20  s = splev(xspl, 
-0001b660: 2862 7370 6c2e 6b6e 6f74 732c 2063 6f65  (bspl.knots, coe
-0001b670: 6673 2c20 6273 706c 2e64 6567 7265 6529  fs, bspl.degree)
-0001b680: 290a 2020 2020 7265 7475 726e 206e 702e  ).    return np.
-0001b690: 6172 7261 7928 6261 7369 7329 0a0a 0a64  array(basis)...d
-0001b6a0: 6566 2073 706c 6974 5f73 706c 696e 655f  ef split_spline_
-0001b6b0: 7465 6d70 6c61 7465 2874 656d 706c 2c20  template(templ, 
-0001b6c0: 7761 7665 6c65 6e67 7468 5f72 616e 6765  wavelength_range
-0001b6d0: 3d5b 3530 3030 2c20 322e 3465 345d 2c20  =[5000, 2.4e4], 
-0001b6e0: 5273 706c 696e 653d 3130 2c20 6c6f 673d  Rspline=10, log=
-0001b6f0: 5472 7565 293a 0a20 2020 2022 2222 0a20  True):.    """. 
-0001b700: 2020 204d 756c 7469 706c 7920 6120 7369     Multiply a si
-0001b710: 6e67 6c65 2074 656d 706c 6174 6520 6279  ngle template by
-0001b720: 2073 706c 696e 6520 6261 7365 7320 746f   spline bases to
-0001b730: 2065 6666 6563 7469 7665 6c79 2067 656e   effectively gen
-0001b740: 6572 6174 6520 610a 2020 2020 7370 6c69  erate a.    spli
-0001b750: 6e65 206d 756c 7469 706c 6963 6174 6976  ne multiplicativ
-0001b760: 6520 636f 7272 6563 7469 6f6e 2074 6861  e correction tha
-0001b770: 7420 6361 6e20 6265 2066 6974 2077 6974  t can be fit wit
-0001b780: 6820 6c69 6e65 6172 206c 6561 7374 0a20  h linear least. 
-0001b790: 2020 2073 7175 6172 6573 2e0a 0a20 2020     squares...   
-0001b7a0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0001b7b0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 2020 2020  ----------..    
-0001b7c0: 7465 6d70 6c20 3a20 607e 6772 697a 6c69  templ : `~grizli
-0001b7d0: 2e75 7469 6c73 2e53 7065 6374 7275 6d54  .utils.SpectrumT
-0001b7e0: 656d 706c 6174 6560 0a20 2020 2020 2020  emplate`.       
-0001b7f0: 2054 656d 706c 6174 6520 746f 2073 706c   Template to spl
-0001b800: 6974 2e0a 0a20 2020 2077 6176 656c 656e  it...    wavelen
-0001b810: 6774 685f 7261 6e67 6520 3a20 5b66 6c6f  gth_range : [flo
-0001b820: 6174 2c20 666c 6f61 745d 0a20 2020 2020  at, float].     
-0001b830: 2020 204c 696d 6974 2074 6865 2073 706c     Limit the spl
-0001b840: 696e 6573 2074 6f20 7468 6973 2077 6176  ines to this wav
-0001b850: 656c 656e 6774 6820 7261 6e67 650a 0a20  elength range.. 
-0001b860: 2020 2052 7370 6c69 6e65 203a 2066 6c6f     Rspline : flo
-0001b870: 6174 0a20 2020 2020 2020 2045 6666 6563  at.        Effec
-0001b880: 7469 7665 2072 6573 6f6c 7574 696f 6e2c  tive resolution,
-0001b890: 2052 3d64 6c61 6d62 6461 2f6c 616d 6264   R=dlambda/lambd
-0001b8a0: 612c 206f 6620 7468 6520 7370 6c69 6e65  a, of the spline
-0001b8b0: 2063 6f72 7265 6374 696f 6e0a 2020 2020   correction.    
-0001b8c0: 2020 2020 6675 6e63 7469 6f6e 2e0a 0a20      function... 
-0001b8d0: 2020 206c 6f67 203a 2062 6f6f 6c0a 2020     log : bool.  
-0001b8e0: 2020 2020 2020 4c6f 672d 7370 6163 6564        Log-spaced
-0001b8f0: 2073 706c 696e 6573 0a0a 2020 2020 5265   splines..    Re
-0001b900: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0001b910: 2d0a 0a20 2020 2073 7465 6d70 203a 2064  -..    stemp : d
-0001b920: 6963 740a 0a20 2020 2020 2020 2044 6963  ict..        Dic
-0001b930: 7469 6f6e 6172 7920 6f66 2073 706c 696e  tionary of splin
-0001b940: 652d 636f 6d70 6f6e 656e 7420 7465 6d70  e-component temp
-0001b950: 6c61 7465 732c 2077 6974 6820 6164 6469  lates, with addi
-0001b960: 7469 6f6e 616c 2061 7474 7269 6275 7465  tional attribute
-0001b970: 733a 0a0a 2020 2020 2020 2020 2020 2020  s:..            
-0001b980: 7773 706c 696e 6520 3d20 7761 7665 6c65  wspline = wavele
-0001b990: 6e67 7468 206f 6620 7468 6520 7465 6d70  ngth of the temp
-0001b9a0: 6c61 7465 7320 2f20 7370 6c69 6e65 2063  lates / spline c
-0001b9b0: 6f72 7265 6374 696f 6e0a 2020 2020 2020  orrection.      
-0001b9c0: 2020 2020 2020 7473 706c 696e 6520 3d20        tspline = 
-0001b9d0: 6d61 7472 6978 206f 6620 7468 6520 7370  matrix of the sp
-0001b9e0: 6c69 6e65 2063 6f72 7265 6374 696f 6e73  line corrections
-0001b9f0: 0a20 2020 2020 2020 2020 2020 206b 6e6f  .            kno
-0001ba00: 7473 2020 203d 2070 6561 6b20 7761 7665  ts   = peak wave
-0001ba10: 6c65 6e67 6874 7320 6f66 2065 6163 6820  lenghts of each 
-0001ba20: 7370 6c69 6e65 2063 6f6d 706f 6e65 6e74  spline component
-0001ba30: 0a0a 2020 2020 2222 220a 2020 2020 6672  ..    """.    fr
-0001ba40: 6f6d 2063 6f6c 6c65 6374 696f 6e73 2069  om collections i
-0001ba50: 6d70 6f72 7420 4f72 6465 7265 6444 6963  mport OrderedDic
-0001ba60: 740a 2020 2020 6672 6f6d 2067 7269 7a6c  t.    from grizl
-0001ba70: 6920 696d 706f 7274 2075 7469 6c73 0a0a  i import utils..
-0001ba80: 2020 2020 6966 2046 616c 7365 3a0a 2020      if False:.  
-0001ba90: 2020 2020 2020 7374 6172 7320 3d20 7574        stars = ut
-0001baa0: 696c 732e 6c6f 6164 5f74 656d 706c 6174  ils.load_templat
-0001bab0: 6573 2873 7461 7273 3d54 7275 6529 0a20  es(stars=True). 
-0001bac0: 2020 2020 2020 2074 656d 706c 203d 2073         templ = s
-0001bad0: 7461 7273 5b27 7374 6172 732f 4c31 2e30  tars['stars/L1.0
-0001bae0: 2e74 7874 275d 0a0a 2020 2020 7773 706c  .txt']..    wspl
-0001baf0: 696e 6520 3d20 7465 6d70 6c2e 7761 7665  ine = templ.wave
-0001bb00: 0a0a 2020 2020 636c 6970 203d 2028 7773  ..    clip = (ws
-0001bb10: 706c 696e 6520 3e20 7761 7665 6c65 6e67  pline > waveleng
-0001bb20: 7468 5f72 616e 6765 5b30 5d29 2026 2028  th_range[0]) & (
-0001bb30: 7773 706c 696e 6520 3c20 7761 7665 6c65  wspline < wavele
-0001bb40: 6e67 7468 5f72 616e 6765 5b31 5d29 0a20  ngth_range[1]). 
-0001bb50: 2020 2064 665f 7370 6c20 3d20 6c65 6e28     df_spl = len(
-0001bb60: 7574 696c 732e 6c6f 675f 7a67 7269 6428  utils.log_zgrid(
-0001bb70: 7a72 3d77 6176 656c 656e 6774 685f 7261  zr=wavelength_ra
-0001bb80: 6e67 652c 2064 7a3d 312e 2f52 7370 6c69  nge, dz=1./Rspli
-0001bb90: 6e65 2929 0a0a 2020 2020 7473 706c 696e  ne))..    tsplin
-0001bba0: 6520 3d20 7574 696c 732e 6273 706c 696e  e = utils.bsplin
-0001bbb0: 655f 7465 6d70 6c61 7465 7328 7773 706c  e_templates(wspl
-0001bbc0: 696e 655b 636c 6970 5d2c 2064 663d 6466  ine[clip], df=df
-0001bbd0: 5f73 706c 2b32 2c20 6c6f 673d 6c6f 672c  _spl+2, log=log,
-0001bbe0: 2063 6c69 703d 302e 3030 3031 2c20 6765   clip=0.0001, ge
-0001bbf0: 745f 6d61 7472 6978 3d54 7275 6529 0a0a  t_matrix=True)..
-0001bc00: 2020 2020 6978 203d 206e 702e 6172 676d      ix = np.argm
-0001bc10: 6178 2874 7370 6c69 6e65 2c20 6178 6973  ax(tspline, axis
-0001bc20: 3d30 290a 2020 2020 6b6e 6f74 7320 3d20  =0).    knots = 
-0001bc30: 7773 706c 696e 655b 636c 6970 5d5b 6978  wspline[clip][ix
-0001bc40: 5d0a 0a20 2020 204e 203d 2074 7370 6c69  ]..    N = tspli
-0001bc50: 6e65 2e73 6861 7065 5b31 5d0a 2020 2020  ne.shape[1].    
-0001bc60: 7374 656d 7020 3d20 4f72 6465 7265 6444  stemp = OrderedD
-0001bc70: 6963 7428 290a 2020 2020 666f 7220 6920  ict().    for i 
-0001bc80: 696e 2072 616e 6765 284e 293a 0a20 2020  in range(N):.   
-0001bc90: 2020 2020 206e 616d 6520 3d20 277b 307d       name = '{0}
-0001bca0: 207b 313a 2e32 667d 272e 666f 726d 6174   {1:.2f}'.format
-0001bcb0: 2874 656d 706c 2e6e 616d 652c 206b 6e6f  (templ.name, kno
-0001bcc0: 7473 5b69 5d2f 312e 6534 290a 2020 2020  ts[i]/1.e4).    
-0001bcd0: 2020 2020 7374 656d 705b 6e61 6d65 5d20      stemp[name] 
-0001bce0: 3d20 7574 696c 732e 5370 6563 7472 756d  = utils.Spectrum
-0001bcf0: 5465 6d70 6c61 7465 2877 6176 653d 7773  Template(wave=ws
-0001bd00: 706c 696e 655b 636c 6970 5d2c 2066 6c75  pline[clip], flu
-0001bd10: 783d 7465 6d70 6c2e 666c 7578 5b63 6c69  x=templ.flux[cli
-0001bd20: 705d 2a74 7370 6c69 6e65 5b3a 2c20 695d  p]*tspline[:, i]
-0001bd30: 2c20 6e61 6d65 3d6e 616d 6529 0a20 2020  , name=name).   
-0001bd40: 2020 2020 2073 7465 6d70 5b6e 616d 655d       stemp[name]
-0001bd50: 2e6b 6e6f 7420 3d20 6b6e 6f74 735b 695d  .knot = knots[i]
-0001bd60: 0a0a 2020 2020 7374 656d 702e 7773 706c  ..    stemp.wspl
-0001bd70: 696e 6520 3d20 7773 706c 696e 655b 636c  ine = wspline[cl
-0001bd80: 6970 5d0a 2020 2020 7374 656d 702e 7473  ip].    stemp.ts
-0001bd90: 706c 696e 6520 3d20 7473 706c 696e 650a  pline = tspline.
-0001bda0: 2020 2020 7374 656d 702e 6b6e 6f74 7320      stemp.knots 
-0001bdb0: 3d20 6b6e 6f74 730a 0a20 2020 2072 6574  = knots..    ret
-0001bdc0: 7572 6e20 7374 656d 700a 0a0a 6465 6620  urn stemp...def 
-0001bdd0: 7374 6570 5f74 656d 706c 6174 6573 2877  step_templates(w
-0001bde0: 6c69 6d3d 5b35 3030 302c 2031 2e38 6534  lim=[5000, 1.8e4
-0001bdf0: 5d2c 2062 696e 5f73 7465 7073 3d4e 6f6e  ], bin_steps=Non
-0001be00: 652c 2052 3d33 302c 2072 6f75 6e64 3d31  e, R=30, round=1
-0001be10: 302c 2072 6573 743d 4661 6c73 652c 2073  0, rest=False, s
-0001be20: 7065 6369 616c 3d4e 6f6e 652c 206f 7264  pecial=None, ord
-0001be30: 6572 3d30 293a 0a20 2020 2022 2222 0a20  er=0):.    """. 
-0001be40: 2020 2053 7465 702d 6675 6e63 7469 6f6e     Step-function
-0001be50: 2074 656d 706c 6174 6573 2066 6f72 2065   templates for e
-0001be60: 6173 7920 6269 6e6e 696e 670a 2020 2020  asy binning.    
-0001be70: 2222 220a 2020 2020 6966 2073 7065 6369  """.    if speci
-0001be80: 616c 203d 3d20 2744 6e34 3030 3027 3a0a  al == 'Dn4000':.
-0001be90: 2020 2020 2020 2020 7265 7374 203d 2054          rest = T
-0001bea0: 7275 650a 2020 2020 2020 2020 6269 6e5f  rue.        bin_
-0001beb0: 7374 6570 7320 3d20 6e70 2e68 7374 6163  steps = np.hstac
-0001bec0: 6b28 5b6e 702e 6172 616e 6765 2838 3530  k([np.arange(850
-0001bed0: 2c20 3338 3439 2c20 3130 3029 2c0a 2020  , 3849, 100),.  
-0001bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bef0: 2020 2020 2020 2020 2020 2020 5b33 3835              [385
-0001bf00: 302c 2033 3935 302c 2034 3030 302c 2034  0, 3950, 4000, 4
-0001bf10: 3130 305d 2c0a 2020 2020 2020 2020 2020  100],.          
-0001bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf30: 2020 2020 6e70 2e61 7261 6e67 6528 3432      np.arange(42
-0001bf40: 3030 2c20 312e 3765 342c 2031 3030 295d  00, 1.7e4, 100)]
-0001bf50: 290a 0a20 2020 2065 6c69 6620 7370 6563  )..    elif spec
-0001bf60: 6961 6c20 3d3d 2027 4434 3030 3027 3a0a  ial == 'D4000':.
-0001bf70: 2020 2020 2020 2020 7265 7374 203d 2054          rest = T
-0001bf80: 7275 650a 2020 2020 2020 2020 6269 6e5f  rue.        bin_
-0001bf90: 7374 6570 7320 3d20 6e70 2e68 7374 6163  steps = np.hstac
-0001bfa0: 6b28 5b6e 702e 6172 616e 6765 2838 3530  k([np.arange(850
-0001bfb0: 2c20 3337 3439 2c20 3230 3029 2c0a 2020  , 3749, 200),.  
-0001bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfd0: 2020 2020 2020 2020 2020 2020 5b33 3735              [375
-0001bfe0: 302c 2033 3935 302c 2034 3035 302c 2034  0, 3950, 4050, 4
-0001bff0: 3235 305d 2c0a 2020 2020 2020 2020 2020  250],.          
-0001c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c010: 2020 2020 6e70 2e61 7261 6e67 6528 3434      np.arange(44
-0001c020: 3530 2c20 312e 3765 342c 2032 3030 295d  50, 1.7e4, 200)]
-0001c030: 290a 2020 2020 656c 6966 2073 7065 6369  ).    elif speci
-0001c040: 616c 206e 6f74 2069 6e20 5b27 4434 3030  al not in ['D400
-0001c050: 3027 2c20 2744 6e34 3030 3027 2c20 4e6f  0', 'Dn4000', No
-0001c060: 6e65 5d3a 0a20 2020 2020 2020 2070 7269  ne]:.        pri
-0001c070: 6e74 2827 7374 6570 5f74 656d 706c 6174  nt('step_templat
-0001c080: 6573 3a20 7b30 7d20 6e6f 7420 7265 636f  es: {0} not reco
-0001c090: 676e 697a 6564 2028 6f70 7469 6f6e 7320  gnized (options 
-0001c0a0: 6172 6520 5c27 4434 3030 305c 272c 205c  are \'D4000\', \
-0001c0b0: 2744 6e34 3030 305c 272c 2061 6e64 204e  'Dn4000\', and N
-0001c0c0: 6f6e 6529 272e 666f 726d 6174 2873 7065  one)'.format(spe
-0001c0d0: 6369 616c 2929 0a20 2020 2020 2020 2072  cial)).        r
-0001c0e0: 6574 7572 6e20 7b7d 0a0a 2020 2020 6966  eturn {}..    if
-0001c0f0: 2062 696e 5f73 7465 7073 2069 7320 4e6f   bin_steps is No
-0001c100: 6e65 3a0a 2020 2020 2020 2020 6269 6e5f  ne:.        bin_
-0001c110: 7374 6570 7320 3d20 6e70 2e72 6f75 6e64  steps = np.round
-0001c120: 286c 6f67 5f7a 6772 6964 2877 6c69 6d2c  (log_zgrid(wlim,
-0001c130: 2031 2e2f 5229 2f72 6f75 6e64 292a 726f   1./R)/round)*ro
-0001c140: 756e 640a 2020 2020 656c 7365 3a0a 2020  und.    else:.  
-0001c150: 2020 2020 2020 776c 696d 203d 205b 6269        wlim = [bi
-0001c160: 6e5f 7374 6570 735b 305d 2c20 6269 6e5f  n_steps[0], bin_
-0001c170: 7374 6570 735b 2d31 5d5d 0a0a 2020 2020  steps[-1]]..    
-0001c180: 6473 203d 206e 702e 6469 6666 2862 696e  ds = np.diff(bin
-0001c190: 5f73 7465 7073 290a 0a20 2020 2078 7370  _steps)..    xsp
-0001c1a0: 6563 203d 206e 702e 6172 616e 6765 2877  ec = np.arange(w
-0001c1b0: 6c69 6d5b 305d 2d64 735b 305d 2c20 776c  lim[0]-ds[0], wl
-0001c1c0: 696d 5b31 5d2b 6473 5b2d 315d 290a 0a20  im[1]+ds[-1]).. 
-0001c1d0: 2020 2062 696e 5f6d 6964 203d 2062 696e     bin_mid = bin
-0001c1e0: 5f73 7465 7073 5b3a 2d31 5d2b 6473 2f32  _steps[:-1]+ds/2
-0001c1f0: 2e0a 0a20 2020 2073 7465 705f 7465 6d70  ...    step_temp
-0001c200: 6c20 3d20 7b7d 0a20 2020 2066 6f72 2069  l = {}.    for i
-0001c210: 2069 6e20 7261 6e67 6528 6c65 6e28 6269   in range(len(bi
-0001c220: 6e5f 7374 6570 7329 2d31 293a 0a0a 2020  n_steps)-1):..  
-0001c230: 2020 2020 2020 7973 7065 6320 3d20 2828        yspec = ((
-0001c240: 7873 7065 6320 3e3d 2062 696e 5f73 7465  xspec >= bin_ste
-0001c250: 7073 5b69 5d29 2026 2028 7873 7065 6320  ps[i]) & (xspec 
-0001c260: 3c20 6269 6e5f 7374 6570 735b 692b 315d  < bin_steps[i+1]
-0001c270: 2929 2a31 0a0a 2020 2020 2020 2020 666f  ))*1..        fo
-0001c280: 7220 6f20 696e 2072 616e 6765 286f 7264  r o in range(ord
-0001c290: 6572 2b31 293a 0a20 2020 2020 2020 2020  er+1):.         
-0001c2a0: 2020 206c 6162 656c 203d 2027 7374 6570     label = 'step
-0001c2b0: 207b 303a 2e30 667d 2d7b 313a 2e30 667d   {0:.0f}-{1:.0f}
-0001c2c0: 207b 327d 272e 666f 726d 6174 2862 696e   {2}'.format(bin
-0001c2d0: 5f73 7465 7073 5b69 5d2c 2062 696e 5f73  _steps[i], bin_s
-0001c2e0: 7465 7073 5b69 2b31 5d2c 206f 290a 2020  teps[i+1], o).  
-0001c2f0: 2020 2020 2020 2020 2020 6966 2072 6573            if res
-0001c300: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0001c310: 2020 206c 6162 656c 203d 2027 7227 2b6c     label = 'r'+l
-0001c320: 6162 656c 0a0a 2020 2020 2020 2020 2020  abel..          
-0001c330: 2020 666c 7578 203d 2028 2878 7370 6563    flux = ((xspec
-0001c340: 2d62 696e 5f6d 6964 5b69 5d29 2f64 735b  -bin_mid[i])/ds[
-0001c350: 695d 292a 2a6f 202a 2028 7973 7065 6320  i])**o * (yspec 
-0001c360: 3e20 3029 0a20 2020 2020 2020 2020 2020  > 0).           
-0001c370: 2073 7465 705f 7465 6d70 6c5b 6c61 6265   step_templ[labe
-0001c380: 6c5d 203d 2053 7065 6374 7275 6d54 656d  l] = SpectrumTem
-0001c390: 706c 6174 6528 7761 7665 3d78 7370 6563  plate(wave=xspec
-0001c3a0: 2c20 666c 7578 3d66 6c75 782c 0a20 2020  , flux=flux,.   
-0001c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3d0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-0001c3e0: 6d65 3d6c 6162 656c 290a 0a20 2020 2072  me=label)..    r
-0001c3f0: 6574 7572 6e20 6269 6e5f 7374 6570 732c  eturn bin_steps,
-0001c400: 2073 7465 705f 7465 6d70 6c0a 0a0a 6465   step_templ...de
-0001c410: 6620 706f 6c79 6e6f 6d69 616c 5f74 656d  f polynomial_tem
-0001c420: 706c 6174 6573 2877 6176 652c 2072 6566  plates(wave, ref
-0001c430: 5f77 6176 653d 312e 6534 2c20 6f72 6465  _wave=1.e4, orde
-0001c440: 723d 302c 206c 696e 653d 4661 6c73 6529  r=0, line=False)
-0001c450: 3a0a 2020 2020 7465 6d70 203d 204f 7264  :.    temp = Ord
-0001c460: 6572 6564 4469 6374 2829 0a20 2020 2069  eredDict().    i
-0001c470: 6620 6c69 6e65 3a0a 2020 2020 2020 2020  f line:.        
-0001c480: 666f 7220 7369 676e 2069 6e20 5b31 2c20  for sign in [1, 
-0001c490: 2d31 5d3a 0a20 2020 2020 2020 2020 2020  -1]:.           
-0001c4a0: 206b 6579 203d 2027 706f 6c79 207b 307d   key = 'poly {0}
-0001c4b0: 272e 666f 726d 6174 2873 6967 6e29 0a20  '.format(sign). 
-0001c4c0: 2020 2020 2020 2020 2020 2074 656d 705b             temp[
-0001c4d0: 6b65 795d 203d 2053 7065 6374 7275 6d54  key] = SpectrumT
-0001c4e0: 656d 706c 6174 6528 7761 7665 2c20 7369  emplate(wave, si
-0001c4f0: 676e 2a28 7761 7665 2f72 6566 5f77 6176  gn*(wave/ref_wav
-0001c500: 652d 3129 2b31 290a 2020 2020 2020 2020  e-1)+1).        
-0001c510: 2020 2020 7465 6d70 5b6b 6579 5d2e 6e61      temp[key].na
-0001c520: 6d65 203d 206b 6579 0a0a 2020 2020 2020  me = key..      
-0001c530: 2020 7265 7475 726e 2074 656d 700a 0a20    return temp.. 
-0001c540: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0001c550: 6528 6f72 6465 722b 3129 3a0a 2020 2020  e(order+1):.    
-0001c560: 2020 2020 6b65 7920 3d20 2770 6f6c 7920      key = 'poly 
-0001c570: 7b30 7d27 2e66 6f72 6d61 7428 6929 0a20  {0}'.format(i). 
-0001c580: 2020 2020 2020 2074 656d 705b 6b65 795d         temp[key]
-0001c590: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
-0001c5a0: 6174 6528 7761 7665 2c20 2877 6176 652f  ate(wave, (wave/
-0001c5b0: 7265 665f 7761 7665 2d31 292a 2a69 290a  ref_wave-1)**i).
-0001c5c0: 2020 2020 2020 2020 7465 6d70 5b6b 6579          temp[key
-0001c5d0: 5d2e 6e61 6d65 203d 206b 6579 0a20 2020  ].name = key.   
-0001c5e0: 2020 2020 2074 656d 705b 6b65 795d 2e72       temp[key].r
-0001c5f0: 6566 5f77 6176 6520 3d20 7265 665f 7761  ef_wave = ref_wa
-0001c600: 7665 0a0a 2020 2020 7265 7475 726e 2074  ve..    return t
-0001c610: 656d 700a 0a0a 6465 6620 7370 6c69 745f  emp...def split_
-0001c620: 706f 6c79 5f74 656d 706c 6174 6528 7465  poly_template(te
-0001c630: 6d70 6c2c 2072 6566 5f77 6176 653d 312e  mpl, ref_wave=1.
-0001c640: 6534 2c20 6f72 6465 723d 3329 3a0a 2020  e4, order=3):.  
-0001c650: 2020 2222 220a 2020 2020 4d75 6c74 6970    """.    Multip
-0001c660: 6c79 2061 2073 696e 676c 6520 7465 6d70  ly a single temp
-0001c670: 6c61 7465 2062 7920 706f 6c79 6e6f 6d69  late by polynomi
-0001c680: 616c 2062 6173 6573 2074 6f20 6566 6665  al bases to effe
-0001c690: 6374 6976 656c 7920 6765 6e65 7261 7465  ctively generate
-0001c6a0: 2061 0a20 2020 2070 6f6c 796e 6f6d 6961   a.    polynomia
-0001c6b0: 6c20 6d75 6c74 6970 6c69 6361 7469 7665  l multiplicative
-0001c6c0: 2063 6f72 7265 6374 696f 6e20 7468 6174   correction that
-0001c6d0: 2063 616e 2062 6520 6669 7420 7769 7468   can be fit with
-0001c6e0: 206c 696e 6561 7220 6c65 6173 740a 2020   linear least.  
-0001c6f0: 2020 7371 7561 7265 732e 0a0a 2020 2020    squares...    
-0001c700: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-0001c710: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7465  ---------.    te
-0001c720: 6d70 6c20 3a20 607e 6772 697a 6c69 2e75  mpl : `~grizli.u
-0001c730: 7469 6c73 2e53 7065 6374 7275 6d54 656d  tils.SpectrumTem
-0001c740: 706c 6174 6560 0a20 2020 2020 2020 2054  plate`.        T
-0001c750: 656d 706c 6174 6520 746f 2073 706c 6974  emplate to split
-0001c760: 2e0a 0a20 2020 2072 6566 5f77 6176 6520  ...    ref_wave 
-0001c770: 3a20 666c 6f61 740a 2020 2020 2020 2057  : float.       W
-0001c780: 6176 656c 656e 6774 6820 7768 6572 6520  avelength where 
-0001c790: 746f 206e 6f72 6d61 6c69 7a65 2074 6865  to normalize the
-0001c7a0: 2070 6f6c 796e 6f6d 6961 6c73 2e0a 0a20   polynomials... 
-0001c7b0: 2020 204f 7264 6572 203a 2069 6e74 0a20     Order : int. 
-0001c7c0: 2020 2020 2020 2050 6f6c 796e 6f6d 6961         Polynomia
-0001c7d0: 6c20 6f72 6465 722e 2020 5265 7475 726e  l order.  Return
-0001c7e0: 7320 6f72 6465 722b 3120 7465 6d70 6c61  s order+1 templa
-0001c7f0: 7465 732e 0a0a 2020 2020 5265 7475 726e  tes...    Return
-0001c800: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0001c810: 2020 7074 656d 7020 3a20 6469 6374 0a0a    ptemp : dict..
-0001c820: 2020 2020 2020 2020 4469 6374 696f 6e61          Dictiona
-0001c830: 7279 206f 6620 706f 6c79 6e6f 6d69 616c  ry of polynomial
-0001c840: 2d63 6f6d 706f 6e65 6e74 2074 656d 706c  -component templ
-0001c850: 6174 6573 2c20 7769 7468 2061 6464 6974  ates, with addit
-0001c860: 696f 6e61 6c0a 2020 2020 2020 2020 6174  ional.        at
-0001c870: 7472 6962 7574 6573 3a0a 0a20 2020 2020  tributes:..     
-0001c880: 2020 2020 2020 2072 6566 5f77 6176 6520         ref_wave 
-0001c890: 3d20 7761 7665 6c65 6e67 7468 2077 6865  = wavelength whe
-0001c8a0: 7265 2070 6f6c 796e 6f6d 6961 6c73 206e  re polynomials n
-0001c8b0: 6f72 6d61 6c69 7a65 640a 0a20 2020 2022  ormalized..    "
-0001c8c0: 2222 0a20 2020 2066 726f 6d20 636f 6c6c  "".    from coll
-0001c8d0: 6563 7469 6f6e 7320 696d 706f 7274 204f  ections import O
-0001c8e0: 7264 6572 6564 4469 6374 0a20 2020 2066  rderedDict.    f
-0001c8f0: 726f 6d20 6772 697a 6c69 2069 6d70 6f72  rom grizli impor
-0001c900: 7420 7574 696c 730a 0a20 2020 2074 7370  t utils..    tsp
-0001c910: 6c69 6e65 203d 2070 6f6c 796e 6f6d 6961  line = polynomia
-0001c920: 6c5f 7465 6d70 6c61 7465 7328 7465 6d70  l_templates(temp
-0001c930: 6c2e 7761 7665 2c20 7265 665f 7761 7665  l.wave, ref_wave
-0001c940: 3d72 6566 5f77 6176 652c 0a20 2020 2020  =ref_wave,.     
-0001c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c960: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-0001c970: 6465 723d 6f72 6465 722c 206c 696e 653d  der=order, line=
-0001c980: 4661 6c73 6529 0a0a 2020 2020 7074 656d  False)..    ptem
-0001c990: 7020 3d20 4f72 6465 7265 6444 6963 7428  p = OrderedDict(
-0001c9a0: 290a 0a20 2020 2066 6f72 2069 2c20 7420  )..    for i, t 
-0001c9b0: 696e 2065 6e75 6d65 7261 7465 2874 7370  in enumerate(tsp
-0001c9c0: 6c69 6e65 293a 0a20 2020 2020 2020 206e  line):.        n
-0001c9d0: 616d 6520 3d20 277b 307d 2070 6f6c 7920  ame = '{0} poly 
-0001c9e0: 7b31 7d27 2e66 6f72 6d61 7428 7465 6d70  {1}'.format(temp
-0001c9f0: 6c2e 6e61 6d65 2c20 6929 0a20 2020 2020  l.name, i).     
-0001ca00: 2020 2070 7465 6d70 5b6e 616d 655d 203d     ptemp[name] =
-0001ca10: 2075 7469 6c73 2e53 7065 6374 7275 6d54   utils.SpectrumT
-0001ca20: 656d 706c 6174 6528 7761 7665 3d74 656d  emplate(wave=tem
-0001ca30: 706c 2e77 6176 652c 0a20 2020 2020 2020  pl.wave,.       
-0001ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca50: 2020 2020 2020 2020 2020 666c 7578 3d74            flux=t
-0001ca60: 656d 706c 2e66 6c75 782a 7473 706c 696e  empl.flux*tsplin
-0001ca70: 655b 745d 2e66 6c75 782c 0a20 2020 2020  e[t].flux,.     
-0001ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca90: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0001caa0: 3d6e 616d 6529 0a20 2020 2020 2020 2070  =name).        p
-0001cab0: 7465 6d70 5b6e 616d 655d 2e72 6566 5f77  temp[name].ref_w
-0001cac0: 6176 6520 3d20 7265 665f 7761 7665 0a0a  ave = ref_wave..
-0001cad0: 2020 2020 7074 656d 702e 7265 665f 7761      ptemp.ref_wa
-0001cae0: 7665 203d 2072 6566 5f77 6176 650a 0a20  ve = ref_wave.. 
-0001caf0: 2020 2072 6574 7572 6e20 7074 656d 700a     return ptemp.
-0001cb00: 0a0a 6465 6620 646f 745f 7465 6d70 6c61  ..def dot_templa
-0001cb10: 7465 7328 636f 6566 6673 2c20 7465 6d70  tes(coeffs, temp
-0001cb20: 6c61 7465 732c 207a 3d30 2c20 6d61 785f  lates, z=0, max_
-0001cb30: 523d 3530 3030 2c20 6170 706c 795f 6967  R=5000, apply_ig
-0001cb40: 6d3d 5472 7565 293a 0a20 2020 2022 2222  m=True):.    """
-0001cb50: 436f 6d70 7574 6520 7465 6d70 6c61 7465  Compute template
-0001cb60: 2073 756d 2061 6e61 6c6f 676f 7573 2074   sum analogous t
-0001cb70: 6f20 606e 702e 646f 7428 636f 6566 6673  o `np.dot(coeffs
-0001cb80: 2c20 7465 6d70 6c61 7465 7329 602e 0a20  , templates)`.. 
-0001cb90: 2020 2022 2222 0a0a 2020 2020 6966 206c     """..    if l
-0001cba0: 656e 2863 6f65 6666 7329 2021 3d20 6c65  en(coeffs) != le
-0001cbb0: 6e28 7465 6d70 6c61 7465 7329 3a0a 2020  n(templates):.  
-0001cbc0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-0001cbd0: 6545 7272 6f72 2827 7368 6170 6573 206f  eError('shapes o
-0001cbe0: 6620 636f 6566 6673 2028 7b30 7d29 2061  f coeffs ({0}) a
-0001cbf0: 6e64 2074 656d 706c 6174 6573 2028 7b31  nd templates ({1
-0001cc00: 7d29 2064 6f6e 5c27 7420 6d61 7463 6827  }) don\'t match'
-0001cc10: 2e66 6f72 6d61 7428 6c65 6e28 636f 6566  .format(len(coef
-0001cc20: 6673 292c 206c 656e 2874 656d 706c 6174  fs), len(templat
-0001cc30: 6573 2929 290a 0a20 2020 2023 2066 6f72  es)))..    # for
-0001cc40: 2069 2c20 7465 2069 6e20 656e 756d 6572   i, te in enumer
-0001cc50: 6174 6528 7465 6d70 6c61 7465 7329 3a0a  ate(templates):.
-0001cc60: 2020 2020 2320 2020 2020 6966 2069 203d      #     if i =
-0001cc70: 3d20 303a 0a20 2020 2023 2020 2020 2020  = 0:.    #      
-0001cc80: 2020 2074 6320 3d20 7465 6d70 6c61 7465     tc = template
-0001cc90: 735b 7465 5d2e 7a73 6361 6c65 287a 2c20  s[te].zscale(z, 
-0001cca0: 7363 616c 6172 3d63 6f65 6666 735b 695d  scalar=coeffs[i]
-0001ccb0: 290a 2020 2020 2320 2020 2020 2020 2020  ).    #         
-0001ccc0: 746c 203d 2074 656d 706c 6174 6573 5b74  tl = templates[t
-0001ccd0: 655d 2e7a 7363 616c 6528 7a2c 2073 6361  e].zscale(z, sca
-0001cce0: 6c61 723d 636f 6566 6673 5b69 5d29 0a20  lar=coeffs[i]). 
-0001ccf0: 2020 2023 2020 2020 2065 6c73 653a 0a20     #     else:. 
-0001cd00: 2020 2023 2020 2020 2020 2020 2069 6620     #         if 
-0001cd10: 7465 2e73 7461 7274 7377 6974 6828 276c  te.startswith('l
-0001cd20: 696e 6527 293a 0a20 2020 2023 2020 2020  ine'):.    #    
-0001cd30: 2020 2020 2020 2020 2074 6320 2b3d 2074           tc += t
-0001cd40: 656d 706c 6174 6573 5b74 655d 2e7a 7363  emplates[te].zsc
-0001cd50: 616c 6528 7a2c 2073 6361 6c61 723d 302e  ale(z, scalar=0.
-0001cd60: 290a 2020 2020 2320 2020 2020 2020 2020  ).    #         
-0001cd70: 656c 7365 3a0a 2020 2020 2320 2020 2020  else:.    #     
-0001cd80: 2020 2020 2020 2020 7463 202b 3d20 7465          tc += te
-0001cd90: 6d70 6c61 7465 735b 7465 5d2e 7a73 6361  mplates[te].zsca
-0001cda0: 6c65 287a 2c20 7363 616c 6172 3d63 6f65  le(z, scalar=coe
-0001cdb0: 6666 735b 695d 290a 2020 2020 230a 2020  ffs[i]).    #.  
-0001cdc0: 2020 2320 2020 2020 2020 2020 746c 202b    #         tl +
-0001cdd0: 3d20 7465 6d70 6c61 7465 735b 7465 5d2e  = templates[te].
-0001cde0: 7a73 6361 6c65 287a 2c20 7363 616c 6172  zscale(z, scalar
-0001cdf0: 3d63 6f65 6666 735b 695d 290a 2020 2020  =coeffs[i]).    
-0001ce00: 7761 7665 2c20 666c 7578 5f61 7272 2c20  wave, flux_arr, 
-0001ce10: 6973 5f6c 696e 6520 3d20 6172 7261 795f  is_line = array_
-0001ce20: 7465 6d70 6c61 7465 7328 7465 6d70 6c61  templates(templa
-0001ce30: 7465 732c 206d 6178 5f52 3d6d 6178 5f52  tes, max_R=max_R
-0001ce40: 2c20 7a3d 7a2c 0a20 2020 2020 2020 2020  , z=z,.         
-0001ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce70: 2020 2020 2061 7070 6c79 5f69 676d 3d61       apply_igm=a
-0001ce80: 7070 6c79 5f69 676d 290a 0a20 2020 2023  pply_igm)..    #
-0001ce90: 2023 2049 474d 0a20 2020 2023 2069 6620   # IGM.    # if 
-0001cea0: 6170 706c 795f 6967 6d3a 0a20 2020 2023  apply_igm:.    #
-0001ceb0: 2020 2020 2074 7279 3a0a 2020 2020 2320       try:.    # 
-0001cec0: 2020 2020 2020 2020 696d 706f 7274 2065          import e
-0001ced0: 617a 792e 6967 6d0a 2020 2020 2320 2020  azy.igm.    #   
-0001cee0: 2020 2020 2020 4947 4d20 3d20 6561 7a79        IGM = eazy
-0001cef0: 2e69 676d 2e49 6e6f 7565 3134 2829 0a20  .igm.Inoue14(). 
-0001cf00: 2020 2023 0a20 2020 2023 2020 2020 2020     #.    #      
-0001cf10: 2020 206c 796c 696d 203d 2077 6176 6520     lylim = wave 
-0001cf20: 3c20 3132 3530 0a20 2020 2023 2020 2020  < 1250.    #    
-0001cf30: 2020 2020 2069 676d 7a20 3d20 6e70 2e6f       igmz = np.o
-0001cf40: 6e65 735f 6c69 6b65 2877 6176 6529 0a20  nes_like(wave). 
-0001cf50: 2020 2023 2020 2020 2020 2020 2069 676d     #         igm
-0001cf60: 7a5b 6c79 6c69 6d5d 203d 2049 474d 2e66  z[lylim] = IGM.f
-0001cf70: 756c 6c5f 4947 4d28 7a2c 2077 6176 655b  ull_IGM(z, wave[
-0001cf80: 6c79 6c69 6d5d 2a28 312b 7a29 290a 2020  lylim]*(1+z)).  
-0001cf90: 2020 2320 2020 2020 6578 6365 7074 3a0a    #     except:.
-0001cfa0: 2020 2020 2320 2020 2020 2020 2020 6967      #         ig
-0001cfb0: 6d7a 203d 2031 2e0a 2020 2020 2320 656c  mz = 1..    # el
-0001cfc0: 7365 3a0a 2020 2020 2320 2020 2020 6967  se:.    #     ig
-0001cfd0: 6d7a 203d 2031 2e0a 2020 2020 230a 2020  mz = 1..    #.  
-0001cfe0: 2020 2320 6973 5f6f 6273 6672 616d 6520    # is_obsframe 
-0001cff0: 3d20 6e70 2e61 7272 6179 285b 742e 7370  = np.array([t.sp
-0001d000: 6c69 7428 295b 305d 2069 6e20 5b27 6273  lit()[0] in ['bs
-0001d010: 706c 272c 2027 7374 6570 275d 2066 6f72  pl', 'step'] for
-0001d020: 2074 2069 6e20 7465 6d70 6c61 7465 735d   t in templates]
-0001d030: 290a 2020 2020 230a 2020 2020 2320 666c  ).    #.    # fl
-0001d040: 7578 5f61 7272 5b7e 6973 5f6f 6273 6672  ux_arr[~is_obsfr
-0001d050: 616d 652c 3a5d 202a 3d20 6967 6d7a 0a20  ame,:] *= igmz. 
-0001d060: 2020 2023 0a20 2020 2023 2023 204d 756c     #.    # # Mul
-0001d070: 7469 706c 7920 7370 6c69 6e65 3f0a 2020  tiply spline?.  
-0001d080: 2020 2320 666f 7220 692c 2074 2069 6e20    # for i, t in 
-0001d090: 656e 756d 6572 6174 6528 7465 6d70 6c61  enumerate(templa
-0001d0a0: 7465 7329 3a0a 2020 2020 2320 2020 2020  tes):.    #     
-0001d0b0: 6966 2027 7370 6c69 6e65 2720 696e 2074  if 'spline' in t
-0001d0c0: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
-0001d0d0: 666f 7220 6a2c 2074 6a20 696e 2065 6e75  for j, tj in enu
-0001d0e0: 6d65 7261 7465 2874 656d 706c 6174 6573  merate(templates
-0001d0f0: 293a 0a20 2020 2023 2020 2020 2020 2020  ):.    #        
-0001d100: 2020 2020 2069 6620 6973 5f6f 6273 6672       if is_obsfr
-0001d110: 616d 655b 6a5d 3a0a 2020 2020 2320 2020  ame[j]:.    #   
-0001d120: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0001d130: 696e 7428 2773 6361 6c65 2073 706c 696e  int('scale splin
-0001d140: 653a 207b 307d 2078 207b 317d 272e 666f  e: {0} x {1}'.fo
-0001d150: 726d 6174 2874 6a2c 2074 2929 0a20 2020  rmat(tj, t)).   
-0001d160: 2023 2020 2020 2020 2020 2020 2020 2020   #              
-0001d170: 2020 2066 6c75 785f 6172 725b 6a2c 3a5d     flux_arr[j,:]
-0001d180: 202a 3d20 666c 7578 5f61 7272 5b69 2c3a   *= flux_arr[i,:
-0001d190: 5d0a 0a20 2020 2023 2043 6f6e 7469 6e75  ]..    # Continu
-0001d1a0: 756d 0a20 2020 2063 6f6e 7420 3d20 6e70  um.    cont = np
-0001d1b0: 2e64 6f74 2863 6f65 6666 732a 287e 6973  .dot(coeffs*(~is
-0001d1c0: 5f6c 696e 6529 2c20 666c 7578 5f61 7272  _line), flux_arr
-0001d1d0: 290a 2020 2020 7463 203d 2053 7065 6374  ).    tc = Spect
-0001d1e0: 7275 6d54 656d 706c 6174 6528 7761 7665  rumTemplate(wave
-0001d1f0: 3d77 6176 652c 2066 6c75 783d 636f 6e74  =wave, flux=cont
-0001d200: 292e 7a73 6361 6c65 287a 2c20 6170 706c  ).zscale(z, appl
-0001d210: 795f 6967 6d3d 4661 6c73 6529 0a0a 2020  y_igm=False)..  
-0001d220: 2020 2320 4675 6c6c 2074 656d 706c 6174    # Full templat
-0001d230: 650a 2020 2020 6c69 6e65 203d 206e 702e  e.    line = np.
-0001d240: 646f 7428 636f 6566 6673 2c20 666c 7578  dot(coeffs, flux
-0001d250: 5f61 7272 290a 2020 2020 746c 203d 2053  _arr).    tl = S
-0001d260: 7065 6374 7275 6d54 656d 706c 6174 6528  pectrumTemplate(
-0001d270: 7761 7665 3d77 6176 652c 2066 6c75 783d  wave=wave, flux=
-0001d280: 6c69 6e65 292e 7a73 6361 6c65 287a 2c20  line).zscale(z, 
-0001d290: 6170 706c 795f 6967 6d3d 4661 6c73 6529  apply_igm=False)
-0001d2a0: 0a0a 2020 2020 7265 7475 726e 2074 632c  ..    return tc,
-0001d2b0: 2074 6c0a 0a0a 6465 6620 6172 7261 795f   tl...def array_
-0001d2c0: 7465 6d70 6c61 7465 7328 7465 6d70 6c61  templates(templa
-0001d2d0: 7465 732c 2077 6176 653d 4e6f 6e65 2c20  tes, wave=None, 
-0001d2e0: 6d61 785f 523d 3530 3030 2c20 7a3d 302c  max_R=5000, z=0,
-0001d2f0: 2061 7070 6c79 5f69 676d 3d46 616c 7365   apply_igm=False
-0001d300: 293a 0a20 2020 2022 2222 5265 7475 726e  ):.    """Return
-0001d310: 2061 6e20 6172 7261 7920 7665 7273 696f   an array versio
-0001d320: 6e20 6f66 2074 6865 2074 656d 706c 6174  n of the templat
-0001d330: 6573 2074 6861 7420 6861 7665 2061 6c6c  es that have all
-0001d340: 2062 6565 6e20 696e 7465 7270 6f6c 6174   been interpolat
-0001d350: 6564 2074 6f20 7468 6520 7361 6d65 2067  ed to the same g
-0001d360: 7269 642e 0a0a 0a20 2020 2050 6172 616d  rid....    Param
-0001d370: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-0001d380: 2d2d 2d2d 0a20 2020 2074 656d 706c 6174  ----.    templat
-0001d390: 6573 203a 2064 6963 7469 6f6e 6172 7920  es : dictionary 
-0001d3a0: 6f66 2060 7e67 7269 7a6c 692e 7574 696c  of `~grizli.util
-0001d3b0: 732e 5370 6563 7472 756d 5465 6d70 6c61  s.SpectrumTempla
-0001d3c0: 7465 6020 6f62 6a65 6374 730a 2020 2020  te` objects.    
-0001d3d0: 2020 2020 4f75 7470 7574 2074 656d 706c      Output templ
-0001d3e0: 6174 6520 6c69 7374 2077 6974 6820 604e  ate list with `N
-0001d3f0: 5445 4d50 6020 7465 6d70 6c61 7465 732e  TEMP` templates.
-0001d400: 0a0a 2020 2020 6d61 785f 5220 3a20 666c  ..    max_R : fl
-0001d410: 6f61 740a 2020 2020 2020 2020 4d61 7869  oat.        Maxi
-0001d420: 6d75 6d20 7370 6563 7472 616c 2072 6573  mum spectral res
-0001d430: 6f6c 7574 696f 6e20 6f66 2074 6865 2072  olution of the r
-0001d440: 6567 7269 6464 6564 2074 656d 706c 6174  egridded templat
-0001d450: 6573 2e0a 0a20 2020 207a 203a 2066 6c6f  es...    z : flo
-0001d460: 6174 0a20 2020 2020 2020 2052 6564 7368  at.        Redsh
-0001d470: 6966 7420 7768 6572 6520 746f 2065 7661  ift where to eva
-0001d480: 6c75 6174 6520 7468 6520 7465 6d70 6c61  luate the templa
-0001d490: 7465 732e 2020 4275 7420 6e6f 7465 2074  tes.  But note t
-0001d4a0: 6861 7420 7468 6973 2069 7320 6f6e 6c79  hat this is only
-0001d4b0: 0a20 2020 2020 2020 2075 7365 6420 746f  .        used to
-0001d4c0: 2073 6869 6674 2074 656d 706c 6174 6573   shift templates
-0001d4d0: 2070 726f 6475 6365 6420 6279 2060 6273   produced by `bs
-0001d4e0: 706c 696e 655f 7465 6d70 6c61 7465 7360  pline_templates`
-0001d4f0: 2c20 7768 6963 6820 6172 650a 2020 2020  , which are.    
-0001d500: 2020 2020 6465 6669 6e65 6420 696e 2074      defined in t
-0001d510: 6865 206f 6273 6572 7665 6420 6672 616d  he observed fram
-0001d520: 652e 0a0a 2020 2020 5265 7475 726e 730a  e...    Returns.
-0001d530: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0001d540: 7761 7665 203a 2060 7e6e 756d 7079 2e6e  wave : `~numpy.n
-0001d550: 6461 7272 6179 602c 2064 696d 656e 7369  darray`, dimensi
-0001d560: 6f6e 7320 6028 4e4c 2c29 600a 2020 2020  ons `(NL,)`.    
-0001d570: 2020 2020 4172 7261 7920 636f 6e74 6169      Array contai
-0001d580: 6e69 6e67 2075 6e69 7175 6520 7761 7665  ning unique wave
-0001d590: 6c65 6e67 7468 732e 0a0a 2020 2020 666c  lengths...    fl
-0001d5a0: 7578 5f61 7272 203a 2060 7e6e 756d 7079  ux_arr : `~numpy
-0001d5b0: 2e6e 6461 7272 6179 602c 2064 696d 656e  .ndarray`, dimen
-0001d5c0: 7369 6f6e 7320 6028 4e54 454d 502c 204e  sions `(NTEMP, N
-0001d5d0: 4c29 600a 2020 2020 2020 2020 4172 7261  L)`.        Arra
-0001d5e0: 7920 636f 6e74 6169 6e69 6e67 2074 6865  y containing the
-0001d5f0: 2074 656d 706c 6174 6520 666c 7578 6573   template fluxes
-0001d600: 2069 6e74 6572 706f 6c61 7465 6420 6174   interpolated at
-0001d610: 2060 7761 7665 602e 0a0a 2020 2020 6973   `wave`...    is
-0001d620: 5f6c 696e 6520 3a20 607e 6e75 6d70 792e  _line : `~numpy.
-0001d630: 6e64 6172 7261 7960 0a20 2020 2020 2020  ndarray`.       
-0001d640: 2042 6f6f 6c65 616e 2061 7272 6179 2069   Boolean array i
-0001d650: 6e64 6963 6174 696e 6720 656d 6973 7369  ndicating emissi
-0001d660: 6f6e 206c 696e 6520 7465 6d70 6c61 7465  on line template
-0001d670: 7320 2874 6865 206b 6579 2069 6e20 7468  s (the key in th
-0001d680: 650a 2020 2020 2020 2020 7465 6d70 6c61  e.        templa
-0001d690: 7465 2064 6963 7469 6f6e 6172 7920 7374  te dictionary st
-0001d6a0: 6172 7473 2077 6974 6820 226c 696e 6520  arts with "line 
-0001d6b0: 2229 2e0a 0a20 2020 2022 2222 0a20 2020  ")...    """.   
-0001d6c0: 2066 726f 6d20 6772 697a 6c69 2e75 7469   from grizli.uti
-0001d6d0: 6c73 5f63 2e69 6e74 6572 7020 696d 706f  ls_c.interp impo
-0001d6e0: 7274 2069 6e74 6572 705f 636f 6e73 6572  rt interp_conser
-0001d6f0: 7665 5f63 0a0a 2020 2020 6966 2077 6176  ve_c..    if wav
-0001d700: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-0001d710: 2020 2077 7374 6163 6b20 3d20 5b5d 0a20     wstack = []. 
-0001d720: 2020 2020 2020 2066 6f72 2074 2069 6e20         for t in 
-0001d730: 7465 6d70 6c61 7465 733a 0a20 2020 2020  templates:.     
-0001d740: 2020 2020 2020 2069 6620 742e 7370 6c69         if t.spli
-0001d750: 7428 295b 305d 2069 6e20 5b27 6273 706c  t()[0] in ['bspl
-0001d760: 272c 2027 7374 6570 272c 2027 706f 6c79  ', 'step', 'poly
-0001d770: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
-0001d780: 2020 2020 7773 7461 636b 2e61 7070 656e      wstack.appen
-0001d790: 6428 7465 6d70 6c61 7465 735b 745d 2e77  d(templates[t].w
-0001d7a0: 6176 652f 2831 2b7a 2929 0a20 2020 2020  ave/(1+z)).     
-0001d7b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001d7c0: 2020 2020 2020 2020 2020 2020 2077 7374               wst
-0001d7d0: 6163 6b2e 6170 7065 6e64 2874 656d 706c  ack.append(templ
-0001d7e0: 6174 6573 5b74 5d2e 7761 7665 290a 0a20  ates[t].wave).. 
-0001d7f0: 2020 2020 2020 2077 6176 6520 3d20 6e70         wave = np
-0001d800: 2e75 6e69 7175 6528 6e70 2e68 7374 6163  .unique(np.hstac
-0001d810: 6b28 7773 7461 636b 2929 0a0a 2020 2020  k(wstack))..    
-0001d820: 636c 6970 7375 6d2c 2069 7465 7220 3d20  clipsum, iter = 
-0001d830: 312c 2030 0a20 2020 2077 6869 6c65 2028  1, 0.    while (
-0001d840: 636c 6970 7375 6d20 3e20 3029 2026 2028  clipsum > 0) & (
-0001d850: 6974 6572 203c 2031 3029 3a0a 2020 2020  iter < 10):.    
-0001d860: 2020 2020 636c 6970 203d 206e 702e 6772      clip = np.gr
-0001d870: 6164 6965 6e74 2877 6176 6529 2f77 6176  adient(wave)/wav
-0001d880: 6520 3c20 312f 6d61 785f 520a 2020 2020  e < 1/max_R.    
-0001d890: 2020 2020 6964 7820 3d20 6e70 2e61 7261      idx = np.ara
-0001d8a0: 6e67 6528 6c65 6e28 7761 7665 2929 5b63  nge(len(wave))[c
-0001d8b0: 6c69 705d 0a20 2020 2020 2020 2077 6176  lip].        wav
-0001d8c0: 655b 6964 785b 3a3a 325d 5d20 3d20 6e70  e[idx[::2]] = np
-0001d8d0: 2e6e 616e 0a20 2020 2020 2020 2077 6176  .nan.        wav
-0001d8e0: 6520 3d20 7761 7665 5b6e 702e 6973 6669  e = wave[np.isfi
-0001d8f0: 6e69 7465 2877 6176 6529 5d0a 2020 2020  nite(wave)].    
-0001d900: 2020 2020 6974 6572 202b 3d20 310a 2020      iter += 1.  
-0001d910: 2020 2020 2020 636c 6970 7375 6d20 3d20        clipsum = 
-0001d920: 636c 6970 2e73 756d 2829 0a20 2020 2020  clip.sum().     
-0001d930: 2020 2023 7072 696e 7428 6974 6572 2c20     #print(iter, 
-0001d940: 636c 6970 7375 6d29 0a0a 2020 2020 4e54  clipsum)..    NT
-0001d950: 454d 5020 3d20 6c65 6e28 7465 6d70 6c61  EMP = len(templa
-0001d960: 7465 7329 0a20 2020 2066 6c75 785f 6172  tes).    flux_ar
-0001d970: 7220 3d20 6e70 2e7a 6572 6f73 2828 4e54  r = np.zeros((NT
-0001d980: 454d 502c 206c 656e 2877 6176 6529 2929  EMP, len(wave)))
-0001d990: 0a0a 2020 2020 666f 7220 692c 2074 2069  ..    for i, t i
-0001d9a0: 6e20 656e 756d 6572 6174 6528 7465 6d70  n enumerate(temp
-0001d9b0: 6c61 7465 7329 3a0a 2020 2020 2020 2020  lates):.        
-0001d9c0: 6966 2074 2e73 706c 6974 2829 5b30 5d20  if t.split()[0] 
-0001d9d0: 696e 205b 2762 7370 6c27 2c20 2773 7465  in ['bspl', 'ste
-0001d9e0: 7027 2c20 2770 6f6c 7927 5d3a 0a20 2020  p', 'poly']:.   
-0001d9f0: 2020 2020 2020 2020 2066 6c75 785f 6172           flux_ar
-0001da00: 725b 692c 203a 5d20 3d20 696e 7465 7270  r[i, :] = interp
-0001da10: 5f63 6f6e 7365 7276 655f 6328 7761 7665  _conserve_c(wave
-0001da20: 2c20 7465 6d70 6c61 7465 735b 745d 2e77  , templates[t].w
-0001da30: 6176 652f 2831 2b7a 292c 0a20 2020 2020  ave/(1+z),.     
-0001da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da60: 2020 2020 2074 656d 706c 6174 6573 5b74       templates[t
-0001da70: 5d2e 666c 7578 2a28 312b 7a29 290a 2020  ].flux*(1+z)).  
-0001da80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001da90: 2020 2020 2020 2020 6966 2068 6173 6174          if hasat
-0001daa0: 7472 2874 656d 706c 6174 6573 5b74 5d2c  tr(templates[t],
-0001dab0: 2027 666c 7578 5f66 6c61 6d27 293a 0a20   'flux_flam'):. 
-0001dac0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001dad0: 2052 6564 7368 6966 742d 6465 7065 6e64   Redshift-depend
-0001dae0: 656e 7420 6561 7a79 2d70 7920 5465 6d70  ent eazy-py Temp
-0001daf0: 6c61 7465 0a20 2020 2020 2020 2020 2020  late.           
-0001db00: 2020 2020 2066 6c75 785f 6172 725b 692c       flux_arr[i,
-0001db10: 203a 5d20 3d20 696e 7465 7270 5f63 6f6e   :] = interp_con
-0001db20: 7365 7276 655f 6328 7761 7665 2c20 7465  serve_c(wave, te
-0001db30: 6d70 6c61 7465 735b 745d 2e77 6176 652c  mplates[t].wave,
-0001db40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db60: 2020 2020 2020 2020 2020 2074 656d 706c             templ
-0001db70: 6174 6573 5b74 5d2e 666c 7578 5f66 6c61  ates[t].flux_fla
-0001db80: 6d28 7a3d 7a29 290a 2020 2020 2020 2020  m(z=z)).        
-0001db90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001dba0: 2020 2020 2020 2020 2020 666c 7578 5f61            flux_a
-0001dbb0: 7272 5b69 2c20 3a5d 203d 2069 6e74 6572  rr[i, :] = inter
-0001dbc0: 705f 636f 6e73 6572 7665 5f63 2877 6176  p_conserve_c(wav
-0001dbd0: 652c 2074 656d 706c 6174 6573 5b74 5d2e  e, templates[t].
-0001dbe0: 7761 7665 2c0a 2020 2020 2020 2020 2020  wave,.          
-0001dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc10: 7465 6d70 6c61 7465 735b 745d 2e66 6c75  templates[t].flu
-0001dc20: 7829 0a0a 2020 2020 6973 5f6c 696e 6520  x)..    is_line 
-0001dc30: 3d20 6e70 2e61 7272 6179 285b 742e 7374  = np.array([t.st
-0001dc40: 6172 7473 7769 7468 2827 6c69 6e65 2027  artswith('line '
-0001dc50: 2920 666f 7220 7420 696e 2074 656d 706c  ) for t in templ
-0001dc60: 6174 6573 5d29 0a0a 2020 2020 2320 4947  ates])..    # IG
-0001dc70: 4d0a 2020 2020 6966 2061 7070 6c79 5f69  M.    if apply_i
-0001dc80: 676d 3a0a 2020 2020 2020 2020 7472 793a  gm:.        try:
-0001dc90: 0a20 2020 2020 2020 2020 2020 2069 6d70  .            imp
-0001dca0: 6f72 7420 6561 7a79 2e69 676d 0a20 2020  ort eazy.igm.   
-0001dcb0: 2020 2020 2020 2020 2049 474d 203d 2065           IGM = e
-0001dcc0: 617a 792e 6967 6d2e 496e 6f75 6531 3428  azy.igm.Inoue14(
-0001dcd0: 290a 0a20 2020 2020 2020 2020 2020 206c  )..            l
-0001dce0: 796c 696d 203d 2077 6176 6520 3c20 3132  ylim = wave < 12
-0001dcf0: 3530 0a20 2020 2020 2020 2020 2020 2069  50.            i
-0001dd00: 676d 7a20 3d20 6e70 2e6f 6e65 735f 6c69  gmz = np.ones_li
-0001dd10: 6b65 2877 6176 6529 0a20 2020 2020 2020  ke(wave).       
-0001dd20: 2020 2020 2069 676d 7a5b 6c79 6c69 6d5d       igmz[lylim]
-0001dd30: 203d 2049 474d 2e66 756c 6c5f 4947 4d28   = IGM.full_IGM(
-0001dd40: 7a2c 2077 6176 655b 6c79 6c69 6d5d 2a28  z, wave[lylim]*(
-0001dd50: 312b 7a29 290a 2020 2020 2020 2020 6578  1+z)).        ex
-0001dd60: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-0001dd70: 2020 6967 6d7a 203d 2031 2e0a 2020 2020    igmz = 1..    
-0001dd80: 656c 7365 3a0a 2020 2020 2020 2020 6967  else:.        ig
-0001dd90: 6d7a 203d 2031 2e0a 0a20 2020 206f 6273  mz = 1...    obs
-0001dda0: 6e61 6d65 7320 3d20 5b27 6273 706c 272c  names = ['bspl',
-0001ddb0: 2027 7374 6570 272c 2027 706f 6c79 275d   'step', 'poly']
-0001ddc0: 0a20 2020 2069 735f 6f62 7366 7261 6d65  .    is_obsframe
-0001ddd0: 203d 206e 702e 6172 7261 7928 5b74 2e73   = np.array([t.s
-0001dde0: 706c 6974 2829 5b30 5d20 696e 206f 6273  plit()[0] in obs
-0001ddf0: 6e61 6d65 7320 666f 7220 7420 696e 2074  names for t in t
-0001de00: 656d 706c 6174 6573 5d29 0a0a 2020 2020  emplates])..    
-0001de10: 666c 7578 5f61 7272 5b7e 6973 5f6f 6273  flux_arr[~is_obs
-0001de20: 6672 616d 652c 203a 5d20 2a3d 2069 676d  frame, :] *= igm
-0001de30: 7a0a 0a20 2020 2023 204d 756c 7469 706c  z..    # Multipl
-0001de40: 7920 7370 6c69 6e65 3f0a 2020 2020 666f  y spline?.    fo
-0001de50: 7220 692c 2074 2069 6e20 656e 756d 6572  r i, t in enumer
-0001de60: 6174 6528 7465 6d70 6c61 7465 7329 3a0a  ate(templates):.
-0001de70: 2020 2020 2020 2020 6966 2027 7370 6c69          if 'spli
-0001de80: 6e65 2720 696e 2074 3a0a 2020 2020 2020  ne' in t:.      
-0001de90: 2020 2020 2020 666f 7220 6a2c 2074 6a20        for j, tj 
-0001dea0: 696e 2065 6e75 6d65 7261 7465 2874 656d  in enumerate(tem
-0001deb0: 706c 6174 6573 293a 0a20 2020 2020 2020  plates):.       
-0001dec0: 2020 2020 2020 2020 2069 6620 6973 5f6f           if is_o
-0001ded0: 6273 6672 616d 655b 6a5d 3a0a 2020 2020  bsframe[j]:.    
-0001dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001def0: 6d61 203d 2066 6c75 785f 6172 725b 6a2c  ma = flux_arr[j,
-0001df00: 203a 5d2e 7375 6d28 290a 2020 2020 2020   :].sum().      
-0001df10: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0001df20: 203d 206d 6120 6966 206d 6120 3e20 3020   = ma if ma > 0 
-0001df30: 656c 7365 2031 0a20 2020 2020 2020 2020  else 1.         
-0001df40: 2020 2020 2020 2020 2020 206d 6120 3d20             ma = 
-0001df50: 310a 0a20 2020 2020 2020 2020 2020 2020  1..             
-0001df60: 2020 2020 2020 2066 6c75 785f 6172 725b         flux_arr[
-0001df70: 6a2c 203a 5d20 2a3d 2066 6c75 785f 6172  j, :] *= flux_ar
-0001df80: 725b 692c 203a 5d2f 6d61 0a0a 2020 2020  r[i, :]/ma..    
-0001df90: 7265 7475 726e 2077 6176 652c 2066 6c75  return wave, flu
-0001dfa0: 785f 6172 722c 2069 735f 6c69 6e65 0a0a  x_arr, is_line..
-0001dfb0: 0a64 6566 2063 6f6d 7075 7465 5f65 7175  .def compute_equ
-0001dfc0: 6976 616c 656e 745f 7769 6474 6873 2874  ivalent_widths(t
-0001dfd0: 656d 706c 6174 6573 2c20 636f 6566 6673  emplates, coeffs
-0001dfe0: 2c20 636f 7661 722c 206d 6178 5f52 3d35  , covar, max_R=5
-0001dff0: 3030 302c 204e 6472 6177 3d31 3030 302c  000, Ndraw=1000,
-0001e000: 2073 6565 643d 302c 207a 3d30 2c20 6f62   seed=0, z=0, ob
-0001e010: 7365 7276 6564 5f66 7261 6d65 3d46 616c  served_frame=Fal
-0001e020: 7365 293a 0a20 2020 2022 2222 436f 6d70  se):.    """Comp
-0001e030: 7574 6520 7465 6d70 6c61 7465 2d66 6974  ute template-fit
-0001e040: 2065 6d69 7373 696f 6e20 6c69 6e65 2065   emission line e
-0001e050: 7175 6976 616c 656e 7420 7769 6474 6873  quivalent widths
-0001e060: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-0001e070: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-0001e080: 2020 2020 7465 6d70 6c61 7465 7320 3a20      templates : 
-0001e090: 6469 6374 696f 6e61 7279 206f 6620 607e  dictionary of `~
-0001e0a0: 6772 697a 6c69 2e75 7469 6c73 2e53 7065  grizli.utils.Spe
-0001e0b0: 6374 7275 6d54 656d 706c 6174 6560 206f  ctrumTemplate` o
-0001e0c0: 626a 6563 7473 0a20 2020 2020 2020 204f  bjects.        O
-0001e0d0: 7574 7075 7420 7465 6d70 6c61 7465 206c  utput template l
-0001e0e0: 6973 7420 7769 7468 2060 4e54 454d 5060  ist with `NTEMP`
-0001e0f0: 2074 656d 706c 6174 6573 2e0a 0a20 2020   templates...   
-0001e100: 2063 6f65 6666 7320 3a20 607e 6e75 6d70   coeffs : `~nump
-0001e110: 792e 6e64 6172 7261 7960 2c20 6469 6d65  y.ndarray`, dime
-0001e120: 6e73 696f 6e73 2028 604e 5445 4d50 6029  nsions (`NTEMP`)
-0001e130: 0a20 2020 2020 2020 2046 6974 2063 6f65  .        Fit coe
-0001e140: 6666 6963 6965 6e74 730a 0a20 2020 2063  fficients..    c
-0001e150: 6f76 6172 203a 2020 607e 6e75 6d70 792e  ovar :  `~numpy.
-0001e160: 6e64 6172 7261 7960 2c20 6469 6d65 6e73  ndarray`, dimens
-0001e170: 696f 6e73 2028 604e 5445 4d50 602c 2060  ions (`NTEMP`, `
-0001e180: 4e54 454d 5060 290a 2020 2020 2020 2020  NTEMP`).        
-0001e190: 436f 7661 7269 616e 6365 206d 6174 7269  Covariance matri
-0001e1a0: 780a 0a20 2020 206d 6178 5f52 203a 2066  x..    max_R : f
-0001e1b0: 6c6f 6174 0a20 2020 2020 2020 204d 6178  loat.        Max
-0001e1c0: 696d 756d 2073 7065 6374 7261 6c20 7265  imum spectral re
-0001e1d0: 736f 6c75 7469 6f6e 206f 6620 7468 6520  solution of the 
-0001e1e0: 7265 6772 6964 6465 6420 7465 6d70 6c61  regridded templa
-0001e1f0: 7465 732e 0a0a 2020 2020 4e64 7261 7720  tes...    Ndraw 
-0001e200: 3a20 696e 740a 2020 2020 2020 2020 4e75  : int.        Nu
-0001e210: 6d62 6572 206f 6620 7261 6e64 6f6d 2064  mber of random d
-0001e220: 7261 7773 2074 6f20 6578 7472 6163 7420  raws to extract 
-0001e230: 6672 6f6d 2074 6865 2063 6f76 6172 6961  from the covaria
-0001e240: 6e63 6520 6d61 7472 6978 0a0a 2020 2020  nce matrix..    
-0001e250: 7365 6564 203a 2070 6f73 6974 6976 6520  seed : positive 
-0001e260: 696e 740a 2020 2020 2020 2020 5261 6e64  int.        Rand
-0001e270: 6f6d 206e 756d 6265 7220 7365 6564 2074  om number seed t
-0001e280: 6f20 7072 6f64 7563 6520 7265 7065 6174  o produce repeat
-0001e290: 6962 6c65 2072 6573 756c 7473 2e20 4966  ible results. If
-0001e2a0: 2060 4e6f 6e65 602c 2074 6865 6e0a 2020   `None`, then.  
-0001e2b0: 2020 2020 2020 7573 6520 6465 6661 756c        use defaul
-0001e2c0: 7420 7374 6174 652e 0a0a 2020 2020 7a20  t state...    z 
-0001e2d0: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-0001e2e0: 5265 6473 6869 6674 2077 6865 7265 2074  Redshift where t
-0001e2f0: 6865 2066 6974 2069 7320 6576 616c 7561  he fit is evalua
-0001e300: 7465 640a 0a20 2020 206f 6273 6572 7665  ted..    observe
-0001e310: 645f 6672 616d 6d65 203a 2062 6f6f 6c0a  d_framme : bool.
-0001e320: 2020 2020 2020 2020 4966 2074 7275 652c          If true,
-0001e330: 2074 6865 6e20 636f 6d70 7574 6564 2045   then computed E
-0001e340: 5773 2061 7265 206f 6273 6572 7665 6420  Ws are observed 
-0001e350: 6672 616d 652c 206f 7468 6572 7769 7365  frame, otherwise
-0001e360: 2074 6865 7920 6172 650a 2020 2020 2020   they are.      
-0001e370: 2020 7265 7374 2066 7261 6d65 2061 7420    rest frame at 
-0001e380: 7265 6473 6869 6674 2060 7a60 2e0a 0a20  redshift `z`... 
-0001e390: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-0001e3a0: 2d2d 2d2d 2d2d 0a20 2020 2045 5764 6963  ------.    EWdic
-0001e3b0: 7420 3a20 6469 6374 0a20 2020 2020 2020  t : dict.       
-0001e3c0: 2044 6963 7469 6f6e 6172 7920 6f66 205b   Dictionary of [
-0001e3d0: 3136 2c20 3530 2c20 3834 7468 5d20 7065  16, 50, 84th] pe
-0001e3e0: 7263 656e 7469 6c65 7320 6f66 2074 6865  rcentiles of the
-0001e3f0: 206c 696e 6520 4557 2064 6973 7472 6962   line EW distrib
-0001e400: 7574 696f 6e73 2e0a 0a20 2020 2022 2222  utions...    """
-0001e410: 0a0a 2020 2020 2320 4172 7261 7920 7665  ..    # Array ve
-0001e420: 7273 696f 6e73 206f 6620 7468 6520 7465  rsions of the te
-0001e430: 6d70 6c61 7465 730a 2020 2020 7761 7665  mplates.    wave
-0001e440: 2c20 666c 7578 5f61 7272 2c20 6973 5f6c  , flux_arr, is_l
-0001e450: 696e 6520 3d20 6172 7261 795f 7465 6d70  ine = array_temp
-0001e460: 6c61 7465 7328 7465 6d70 6c61 7465 732c  lates(templates,
-0001e470: 206d 6178 5f52 3d6d 6178 5f52 2c20 7a3d   max_R=max_R, z=
-0001e480: 7a29 0a20 2020 206b 6579 7320 3d20 6e70  z).    keys = np
-0001e490: 2e61 7272 6179 286c 6973 7428 7465 6d70  .array(list(temp
-0001e4a0: 6c61 7465 732e 6b65 7973 2829 2929 0a0a  lates.keys()))..
-0001e4b0: 2020 2020 4557 6469 6374 203d 204f 7264      EWdict = Ord
-0001e4c0: 6572 6564 4469 6374 2829 0a20 2020 2066  eredDict().    f
-0001e4d0: 6f72 206b 6579 2069 6e20 6b65 7973 5b69  or key in keys[i
-0001e4e0: 735f 6c69 6e65 5d3a 0a20 2020 2020 2020  s_line]:.       
-0001e4f0: 2045 5764 6963 745b 6b65 795d 203d 2028   EWdict[key] = (
-0001e500: 302e 2c20 302e 2c20 302e 290a 0a20 2020  0., 0., 0.)..   
-0001e510: 2023 204f 6e6c 7920 776f 7272 7920 6162   # Only worry ab
-0001e520: 6f75 7420 7465 6d70 6c61 7465 7320 7769  out templates wi
-0001e530: 7468 206e 6f6e 2d7a 6572 6f20 636f 6566  th non-zero coef
-0001e540: 6669 6369 656e 7473 2c20 7768 6963 6820  ficients, which 
-0001e550: 7368 6f75 6c64 0a20 2020 2023 2062 6520  should.    # be 
-0001e560: 6163 636f 756e 7465 6420 666f 7220 696e  accounted for in
-0001e570: 2074 6865 2063 6f76 6172 6961 6e63 6520   the covariance 
-0001e580: 6172 7261 7920 2877 6974 6820 6765 745f  array (with get_
-0001e590: 756e 6365 7274 6169 6e74 6965 733d 3229  uncertainties=2)
-0001e5a0: 0a20 2020 2063 6c69 7020 3d20 636f 6566  .    clip = coef
-0001e5b0: 6673 2021 3d20 300a 2020 2020 2320 4e6f  fs != 0.    # No
-0001e5c0: 2076 616c 6964 206c 696e 6573 0a20 2020   valid lines.   
-0001e5d0: 2069 6620 2869 735f 6c69 6e65 2026 2063   if (is_line & c
-0001e5e0: 6c69 7029 2e73 756d 2829 203d 3d20 303a  lip).sum() == 0:
-0001e5f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001e600: 4557 6469 6374 0a0a 2020 2020 2320 5261  EWdict..    # Ra
-0001e610: 6e64 6f6d 2064 7261 7773 2066 726f 6d20  ndom draws from 
-0001e620: 7468 6520 636f 7661 7269 616e 6365 206d  the covariance m
-0001e630: 6174 7269 780a 2020 2020 636f 7661 725f  atrix.    covar_
-0001e640: 636c 6970 203d 2063 6f76 6172 5b63 6c69  clip = covar[cli
-0001e650: 702c 203a 5d5b 3a2c 2063 6c69 705d 0a20  p, :][:, clip]. 
-0001e660: 2020 2069 6620 7365 6564 2069 7320 6e6f     if seed is no
-0001e670: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0001e680: 6e70 2e72 616e 646f 6d2e 7365 6564 2873  np.random.seed(s
-0001e690: 6565 6429 0a0a 2020 2020 6472 6177 7320  eed)..    draws 
-0001e6a0: 3d20 6e70 2e72 616e 646f 6d2e 6d75 6c74  = np.random.mult
-0001e6b0: 6976 6172 6961 7465 5f6e 6f72 6d61 6c28  ivariate_normal(
-0001e6c0: 636f 6566 6673 5b63 6c69 705d 2c20 636f  coeffs[clip], co
-0001e6d0: 7661 725f 636c 6970 2c20 7369 7a65 3d4e  var_clip, size=N
-0001e6e0: 6472 6177 290a 0a20 2020 2023 2045 7661  draw)..    # Eva
-0001e6f0: 6c75 6174 6520 7468 6520 636f 6e74 696e  luate the contin
-0001e700: 7575 6d20 6669 7473 2066 726f 6d20 7468  uum fits from th
-0001e710: 6520 6472 6177 730a 2020 2020 636f 6e74  e draws.    cont
-0001e720: 696e 7575 6d20 3d20 6e70 2e64 6f74 2864  inuum = np.dot(d
-0001e730: 7261 7773 2a28 7e69 735f 6c69 6e65 5b63  raws*(~is_line[c
-0001e740: 6c69 705d 292c 2066 6c75 785f 6172 725b  lip]), flux_arr[
-0001e750: 636c 6970 2c20 3a5d 290a 0a20 2020 2023  clip, :])..    #
-0001e760: 2043 6f6d 7075 7465 2074 6865 2065 6d69   Compute the emi
-0001e770: 7373 696f 6e20 6c69 6e65 2045 5773 0a20  ssion line EWs. 
-0001e780: 2020 2074 6964 7820 3d20 6e70 2e77 6865     tidx = np.whe
-0001e790: 7265 2869 735f 6c69 6e65 5b63 6c69 705d  re(is_line[clip]
-0001e7a0: 295b 305d 0a20 2020 2066 6f72 2069 7820  )[0].    for ix 
-0001e7b0: 696e 2074 6964 783a 0a20 2020 2020 2020  in tidx:.       
-0001e7c0: 206b 6579 203d 206b 6579 735b 636c 6970   key = keys[clip
-0001e7d0: 5d5b 6978 5d0a 0a20 2020 2020 2020 2023  ][ix]..        #
-0001e7e0: 204c 696e 6520 7465 6d70 6c61 7465 0a20   Line template. 
-0001e7f0: 2020 2020 2020 206c 696e 6520 3d20 6e70         line = np
-0001e800: 2e64 6f74 2864 7261 7773 5b3a 2c20 6978  .dot(draws[:, ix
-0001e810: 5d5b 3a2c 204e 6f6e 655d 2c20 666c 7578  ][:, None], flux
-0001e820: 5f61 7272 5b63 6c69 702c 203a 5d5b 6978  _arr[clip, :][ix
-0001e830: 2c20 3a5d 5b4e 6f6e 652c 203a 5d29 0a0a  , :][None, :])..
-0001e840: 2020 2020 2020 2020 2320 5768 6572 6520          # Where 
-0001e850: 6c69 6e65 2074 656d 706c 6174 6520 6e6f  line template no
-0001e860: 6e2d 7a65 726f 0a20 2020 2020 2020 206d  n-zero.        m
-0001e870: 6173 6b20 3d20 666c 7578 5f61 7272 5b63  ask = flux_arr[c
-0001e880: 6c69 702c 203a 5d5b 6978 2c20 3a5d 203e  lip, :][ix, :] >
-0001e890: 2030 0a20 2020 2020 2020 2065 775f 6920   0.        ew_i 
-0001e8a0: 3d20 6e70 2e74 7261 707a 2828 6c69 6e65  = np.trapz((line
-0001e8b0: 2f63 6f6e 7469 6e75 756d 295b 3a2c 206d  /continuum)[:, m
-0001e8c0: 6173 6b5d 2c0a 2020 2020 2020 2020 2020  ask],.          
-0001e8d0: 2020 2020 2020 2020 2020 2020 2020 7761                wa
-0001e8e0: 7665 5b6d 6173 6b5d 2a28 312b 7a2a 6f62  ve[mask]*(1+z*ob
-0001e8f0: 7365 7276 6564 5f66 7261 6d65 292c 2061  served_frame), a
-0001e900: 7869 733d 3129 0a0a 2020 2020 2020 2020  xis=1)..        
-0001e910: 4557 6469 6374 5b6b 6579 5d20 3d20 6e70  EWdict[key] = np
-0001e920: 2e70 6572 6365 6e74 696c 6528 6577 5f69  .percentile(ew_i
-0001e930: 2c20 5b31 362e 2c20 3530 2e2c 2038 342e  , [16., 50., 84.
-0001e940: 5d29 0a0a 2020 2020 7265 7475 726e 2045  ])..    return E
-0001e950: 5764 6963 740a 0a23 2323 2323 2323 2323  Wdict..#########
-0001e960: 2323 2323 2323 2323 2323 2323 0a23 2050  ############.# P
-0001e970: 686f 746f 6d65 7472 7920 6672 6f6d 2056  hotometry from V
-0001e980: 697a 6965 7220 7461 626c 6573 0a0a 0a23  izier tables...#
-0001e990: 2043 4648 544c 530a 4346 4854 4c53 5f57   CFHTLS.CFHTLS_W
-0001e9a0: 5f56 495a 4945 5220 3d20 2749 492f 3331  _VIZIER = 'II/31
-0001e9b0: 372f 6366 6874 6c73 5f77 270a 4346 4854  7/cfhtls_w'.CFHT
-0001e9c0: 4c53 5f57 5f42 414e 4453 203d 204f 7264  LS_W_BANDS = Ord
-0001e9d0: 6572 6564 4469 6374 285b 2827 6366 6874  eredDict([('cfht
-0001e9e0: 5f6d 6567 615f 7527 2c20 5b27 756d 6167  _mega_u', ['umag
-0001e9f0: 272c 2027 655f 756d 6167 275d 292c 0a20  ', 'e_umag']),. 
-0001ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea10: 2020 2020 2020 2020 2020 2020 2827 6366              ('cf
-0001ea20: 6874 5f6d 6567 615f 6727 2c20 5b27 676d  ht_mega_g', ['gm
-0001ea30: 6167 272c 2027 655f 676d 6167 275d 292c  ag', 'e_gmag']),
-0001ea40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ea50: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-0001ea60: 6366 6874 5f6d 6567 615f 7227 2c20 5b27  cfht_mega_r', ['
-0001ea70: 726d 6167 272c 2027 655f 726d 6167 275d  rmag', 'e_rmag']
-0001ea80: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eaa0: 2827 6366 6874 5f6d 6567 615f 6927 2c20  ('cfht_mega_i', 
-0001eab0: 5b27 696d 6167 272c 2027 655f 696d 6167  ['imag', 'e_imag
-0001eac0: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
-0001ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eae0: 2020 2827 6366 6874 5f6d 6567 615f 7a27    ('cfht_mega_z'
-0001eaf0: 2c20 5b27 7a6d 6167 272c 2027 655f 7a6d  , ['zmag', 'e_zm
-0001eb00: 6167 275d 295d 290a 0a43 4648 544c 535f  ag'])])..CFHTLS_
-0001eb10: 445f 5649 5a49 4552 203d 2027 4949 2f33  D_VIZIER = 'II/3
-0001eb20: 3137 2f63 6668 746c 735f 6427 0a43 4648  17/cfhtls_d'.CFH
-0001eb30: 544c 535f 445f 4241 4e44 5320 3d20 4f72  TLS_D_BANDS = Or
-0001eb40: 6465 7265 6444 6963 7428 5b28 2763 6668  deredDict([('cfh
-0001eb50: 745f 6d65 6761 5f75 272c 205b 2775 6d61  t_mega_u', ['uma
-0001eb60: 6727 2c20 2765 5f75 6d61 6727 5d29 2c0a  g', 'e_umag']),.
-0001eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb80: 2020 2020 2020 2020 2020 2020 2028 2763               ('c
-0001eb90: 6668 745f 6d65 6761 5f67 272c 205b 2767  fht_mega_g', ['g
-0001eba0: 6d61 6727 2c20 2765 5f67 6d61 6727 5d29  mag', 'e_gmag'])
-0001ebb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ebc0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0001ebd0: 2763 6668 745f 6d65 6761 5f72 272c 205b  'cfht_mega_r', [
-0001ebe0: 2772 6d61 6727 2c20 2765 5f72 6d61 6727  'rmag', 'e_rmag'
-0001ebf0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec10: 2028 2763 6668 745f 6d65 6761 5f69 272c   ('cfht_mega_i',
-0001ec20: 205b 2769 6d61 6727 2c20 2765 5f69 6d61   ['imag', 'e_ima
-0001ec30: 6727 5d29 2c0a 2020 2020 2020 2020 2020  g']),.          
-0001ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec50: 2020 2028 2763 6668 745f 6d65 6761 5f7a     ('cfht_mega_z
-0001ec60: 272c 205b 277a 6d61 6727 2c20 2765 5f7a  ', ['zmag', 'e_z
-0001ec70: 6d61 6727 5d29 5d29 0a0a 2320 5344 5353  mag'])])..# SDSS
-0001ec80: 2044 5231 320a 5344 5353 5f44 5231 325f   DR12.SDSS_DR12_
-0001ec90: 5649 5a49 4552 203d 2027 562f 3134 372f  VIZIER = 'V/147/
-0001eca0: 7364 7373 3132 270a 5344 5353 5f44 5231  sdss12'.SDSS_DR1
-0001ecb0: 325f 4241 4e44 5320 3d20 4f72 6465 7265  2_BANDS = Ordere
-0001ecc0: 6444 6963 7428 5b28 2753 4453 532f 7527  dDict([('SDSS/u'
-0001ecd0: 2c20 5b27 756d 6167 272c 2027 655f 756d  , ['umag', 'e_um
-0001ece0: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
-0001ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed00: 2028 2753 4453 532f 6727 2c20 5b27 676d   ('SDSS/g', ['gm
-0001ed10: 6167 272c 2027 655f 676d 6167 275d 292c  ag', 'e_gmag']),
-0001ed20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ed30: 2020 2020 2020 2020 2020 2028 2753 4453             ('SDS
-0001ed40: 532f 7227 2c20 5b27 726d 6167 272c 2027  S/r', ['rmag', '
-0001ed50: 655f 726d 6167 275d 292c 0a20 2020 2020  e_rmag']),.     
-0001ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed70: 2020 2020 2028 2753 4453 532f 6927 2c20       ('SDSS/i', 
-0001ed80: 5b27 696d 6167 272c 2027 655f 696d 6167  ['imag', 'e_imag
-0001ed90: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
-0001eda0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0001edb0: 2753 4453 532f 7a27 2c20 5b27 7a6d 6167  'SDSS/z', ['zmag
-0001edc0: 272c 2027 655f 7a6d 6167 275d 295d 290a  ', 'e_zmag'])]).
-0001edd0: 0a23 2050 616e 5374 6172 7273 0a50 5331  .# PanStarrs.PS1
-0001ede0: 5f56 495a 4945 5220 3d20 2749 492f 3334  _VIZIER = 'II/34
-0001edf0: 392f 7073 3127 0a50 5331 5f42 414e 4453  9/ps1'.PS1_BANDS
-0001ee00: 203d 204f 7264 6572 6564 4469 6374 285b   = OrderedDict([
-0001ee10: 2827 5053 312e 6727 2c20 5b27 674b 6d61  ('PS1.g', ['gKma
-0001ee20: 6727 2c20 2765 5f67 4b6d 6167 275d 292c  g', 'e_gKmag']),
-0001ee30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ee40: 2020 2827 5053 312e 7227 2c20 5b27 724b    ('PS1.r', ['rK
-0001ee50: 6d61 6727 2c20 2765 5f72 4b6d 6167 275d  mag', 'e_rKmag']
-0001ee60: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001ee70: 2020 2020 2827 5053 312e 6927 2c20 5b27      ('PS1.i', ['
-0001ee80: 694b 6d61 6727 2c20 2765 5f69 4b6d 6167  iKmag', 'e_iKmag
-0001ee90: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
-0001eea0: 2020 2020 2020 2827 5053 312e 7a27 2c20        ('PS1.z', 
-0001eeb0: 5b27 7a4b 6d61 6727 2c20 2765 5f7a 4b6d  ['zKmag', 'e_zKm
-0001eec0: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
-0001eed0: 2020 2020 2020 2020 2827 5053 312e 7927          ('PS1.y'
-0001eee0: 2c20 5b27 794b 6d61 6727 2c20 2765 5f79  , ['yKmag', 'e_y
-0001eef0: 4b6d 6167 275d 295d 290a 0a23 204b 4944  Kmag'])])..# KID
-0001ef00: 5320 4452 330a 4b49 4453 5f44 5233 5f56  S DR3.KIDS_DR3_V
-0001ef10: 495a 4945 5220 3d20 2749 492f 3334 372f  IZIER = 'II/347/
-0001ef20: 6b69 6473 5f64 7233 270a 4b49 4453 5f44  kids_dr3'.KIDS_D
-0001ef30: 5233 5f42 414e 4453 203d 204f 7264 6572  R3_BANDS = Order
-0001ef40: 6564 4469 6374 285b 2827 4f43 616d 2e73  edDict([('OCam.s
-0001ef50: 6473 732e 7527 2c20 5b27 756d 6167 272c  dss.u', ['umag',
-0001ef60: 2027 655f 756d 6167 275d 292c 0a20 2020   'e_umag']),.   
-0001ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef80: 2020 2020 2020 2028 274f 4361 6d2e 7364         ('OCam.sd
-0001ef90: 7373 2e67 272c 205b 2767 6d61 6727 2c20  ss.g', ['gmag', 
-0001efa0: 2765 5f67 6d61 6727 5d29 2c0a 2020 2020  'e_gmag']),.    
+00016430: 7465 6d70 6c5f 6976 6172 5b7e 6e70 2e69  templ_ivar[~np.i
+00016440: 7366 696e 6974 6528 7465 6d70 6c5f 6976  sfinite(templ_iv
+00016450: 6172 295d 203d 2030 0a0a 2020 2020 2020  ar)] = 0..      
+00016460: 2020 2020 2020 2020 2020 696e 7465 6772            integr
+00016470: 6174 655f 7765 6967 6874 203d 2066 696c  ate_weight = fil
+00016480: 7465 722e 7468 726f 7567 6870 7574 2f66  ter.throughput/f
+00016490: 696c 7465 722e 7761 7665 2a74 656d 706c  ilter.wave*templ
+000164a0: 5f69 7661 722f 6669 6c74 6572 2e6e 6f72  _ivar/filter.nor
+000164b0: 6d0a 2020 2020 2020 2020 2020 2020 656c  m.            el
+000164c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000164d0: 2020 2020 696e 7465 6772 6174 655f 7765      integrate_we
+000164e0: 6967 6874 203d 2066 696c 7465 722e 7468  ight = filter.th
+000164f0: 726f 7567 6870 7574 2f66 696c 7465 722e  roughput/filter.
+00016500: 7761 7665 0a20 2020 2020 2020 2065 6c73  wave.        els
+00016510: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00016520: 2049 6e74 6572 706f 6c61 7465 2074 6f20   Interpolate to 
+00016530: 7370 6563 7472 756d 2077 6176 656c 656e  spectrum wavelen
+00016540: 6774 6873 0a20 2020 2020 2020 2020 2020  gths.           
+00016550: 2069 6e74 6567 7261 7465 5f77 6176 6520   integrate_wave 
+00016560: 3d20 7365 6c66 2e77 6176 650a 2020 2020  = self.wave.    
+00016570: 2020 2020 2020 2020 696e 7465 6772 6174          integrat
+00016580: 655f 7465 6d70 6c20 3d20 7365 6c66 2e66  e_templ = self.f
+00016590: 6c75 785f 666e 750a 0a20 2020 2020 2020  lux_fnu..       
+000165a0: 2020 2020 2023 2074 6573 7420 3d20 6e6f       # test = no
+000165b0: 6e7a 6572 6f0a 2020 2020 2020 2020 2020  nzero.          
+000165c0: 2020 7465 7374 203d 206e 702e 6973 6669    test = np.isfi
+000165d0: 6e69 7465 2866 696c 7465 722e 7468 726f  nite(filter.thro
+000165e0: 7567 6870 7574 290a 2020 2020 2020 2020  ughput).        
+000165f0: 2020 2020 696e 7465 7270 5f74 6872 7520      interp_thru 
+00016600: 3d20 696e 7465 7270 2869 6e74 6567 7261  = interp(integra
+00016610: 7465 5f77 6176 652c 2066 696c 7465 722e  te_wave, filter.
+00016620: 7761 7665 5b74 6573 745d 2c0a 2020 2020  wave[test],.    
+00016630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016640: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00016650: 6c74 6572 2e74 6872 6f75 6768 7075 745b  lter.throughput[
+00016660: 7465 7374 5d2c 0a20 2020 2020 2020 2020  test],.         
+00016670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016680: 2020 2020 2020 2020 206c 6566 743d 302c           left=0,
+00016690: 2072 6967 6874 3d30 290a 0a20 2020 2020   right=0)..     
+000166a0: 2020 2020 2020 2069 6620 7365 6c66 2e65         if self.e
+000166b0: 7272 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rr is not None:.
+000166c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166d0: 7465 6d70 6c5f 6976 6172 203d 2031 2f73  templ_ivar = 1/s
+000166e0: 656c 662e 6572 725f 666e 752a 2a32 0a20  elf.err_fnu**2. 
+000166f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00016700: 656d 706c 5f69 7661 725b 7e6e 702e 6973  empl_ivar[~np.is
+00016710: 6669 6e69 7465 2874 656d 706c 5f69 7661  finite(templ_iva
+00016720: 7229 5d20 3d20 300a 0a20 2020 2020 2020  r)] = 0..       
+00016730: 2020 2020 2020 2020 2069 6e74 6567 7261           integra
+00016740: 7465 5f77 6569 6768 7420 3d20 696e 7465  te_weight = inte
+00016750: 7270 5f74 6872 752f 696e 7465 6772 6174  rp_thru/integrat
+00016760: 655f 7761 7665 2a74 656d 706c 5f69 7661  e_wave*templ_iva
+00016770: 722f 6669 6c74 6572 2e6e 6f72 6d0a 2020  r/filter.norm.  
+00016780: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00016790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167a0: 696e 7465 6772 6174 655f 7765 6967 6874  integrate_weight
+000167b0: 203d 2069 6e74 6572 705f 7468 7275 2f69   = interp_thru/i
+000167c0: 6e74 6567 7261 7465 5f77 6176 6520 2023  ntegrate_wave  #
+000167d0: 202f 7465 6d70 6c5f 6572 722a 2a32 0a0a   /templ_err**2..
+000167e0: 2020 2020 2020 2020 6966 2068 6173 6174          if hasat
+000167f0: 7472 2866 696c 7465 722c 2027 6e6f 726d  tr(filter, 'norm
+00016800: 2729 2026 2028 7365 6c66 2e65 7272 2069  ') & (self.err i
+00016810: 7320 4e6f 6e65 293a 0a20 2020 2020 2020  s None):.       
+00016820: 2020 2020 2066 696c 7465 725f 6e6f 726d       filter_norm
+00016830: 203d 2066 696c 7465 722e 6e6f 726d 0a20   = filter.norm. 
+00016840: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00016850: 2020 2020 2020 2020 2023 2065 2e67 2e2c           # e.g.,
+00016860: 2070 7973 796e 7068 6f74 2062 616e 6470   pysynphot bandp
+00016870: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+00016880: 6669 6c74 6572 5f6e 6f72 6d20 3d20 494e  filter_norm = IN
+00016890: 5445 4752 4154 4f52 2869 6e74 6567 7261  TEGRATOR(integra
+000168a0: 7465 5f77 6569 6768 742c 2069 6e74 6567  te_weight, integ
+000168b0: 7261 7465 5f77 6176 6529 0a0a 2020 2020  rate_wave)..    
+000168c0: 2020 2020 2320 665f 6e75 2f6c 616d 2064      # f_nu/lam d
+000168d0: 6c61 6d20 3d3d 2066 5f6e 7520 6420 286c  lam == f_nu d (l
+000168e0: 6e20 6e75 290a 2020 2020 2020 2020 7465  n nu).        te
+000168f0: 6d70 5f66 6c75 7820 3d20 494e 5445 4752  mp_flux = INTEGR
+00016900: 4154 4f52 2869 6e74 6567 7261 7465 5f74  ATOR(integrate_t
+00016910: 656d 706c 2a69 6e74 6567 7261 7465 5f77  empl*integrate_w
+00016920: 6569 6768 742c 2069 6e74 6567 7261 7465  eight, integrate
+00016930: 5f77 6176 6529 202f 2066 696c 7465 725f  _wave) / filter_
+00016940: 6e6f 726d 0a0a 2020 2020 2020 2020 6966  norm..        if
+00016950: 2073 656c 662e 6572 7220 6973 206e 6f74   self.err is not
+00016960: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00016970: 2020 2074 656d 705f 6572 7220 3d20 312f     temp_err = 1/
+00016980: 6e70 2e73 7172 7428 6669 6c74 6572 5f6e  np.sqrt(filter_n
+00016990: 6f72 6d29 0a0a 2020 2020 2020 2020 6966  orm)..        if
+000169a0: 2061 626d 6167 3a0a 2020 2020 2020 2020   abmag:.        
+000169b0: 2020 2020 7465 6d70 5f6d 6167 203d 202d      temp_mag = -
+000169c0: 322e 352a 6e70 2e6c 6f67 3130 2874 656d  2.5*np.log10(tem
+000169d0: 705f 666c 7578 292d 3438 2e36 0a20 2020  p_flux)-48.6.   
+000169e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000169f0: 7465 6d70 5f6d 6167 0a20 2020 2020 2020  temp_mag.       
+00016a00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00016a10: 2020 2069 6620 7365 6c66 2e65 7272 2069     if self.err i
+00016a20: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00016a30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00016a40: 726e 2074 656d 705f 666c 7578 2c20 7465  rn temp_flux, te
+00016a50: 6d70 5f65 7272 0a20 2020 2020 2020 2020  mp_err.         
+00016a60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00016a70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00016a80: 7465 6d70 5f66 6c75 780a 0a0a 6465 6620  temp_flux...def 
+00016a90: 6c6f 6164 5f74 656d 706c 6174 6573 2866  load_templates(f
+00016aa0: 7768 6d3d 3430 302c 206c 696e 655f 636f  whm=400, line_co
+00016ab0: 6d70 6c65 7865 733d 5472 7565 2c20 7374  mplexes=True, st
+00016ac0: 6172 733d 4661 6c73 652c 0a20 2020 2020  ars=False,.     
+00016ad0: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+00016ae0: 6c6c 5f6c 696e 655f 6c69 7374 3d44 4546  ll_line_list=DEF
+00016af0: 4155 4c54 5f4c 494e 455f 4c49 5354 2c20  AULT_LINE_LIST, 
+00016b00: 636f 6e74 696e 7575 6d5f 6c69 7374 3d4e  continuum_list=N
+00016b10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00016b20: 2020 2020 2020 2020 6673 7073 5f74 656d          fsps_tem
+00016b30: 706c 6174 6573 3d46 616c 7365 2c20 616c  plates=False, al
+00016b40: 665f 7465 6d70 6c61 7465 3d46 616c 7365  f_template=False
+00016b50: 2c20 6c6f 7265 6e74 7a3d 4661 6c73 6529  , lorentz=False)
+00016b60: 3a0a 2020 2020 2222 2247 656e 6572 6174  :.    """Generat
+00016b70: 6520 6120 6c69 7374 206f 6620 7465 6d70  e a list of temp
+00016b80: 6c61 7465 7320 666f 7220 6669 7474 696e  lates for fittin
+00016b90: 6720 746f 2074 6865 2067 7269 736d 2073  g to the grism s
+00016ba0: 7065 6374 7261 0a0a 2020 2020 5468 6520  pectra..    The 
+00016bb0: 6469 6666 6572 656e 7420 7365 7473 206f  different sets o
+00016bc0: 6620 636f 6e74 696e 7575 6d20 7465 6d70  f continuum temp
+00016bd0: 6c61 7465 7320 6172 6520 7374 6f72 6564  lates are stored
+00016be0: 2069 6e0a 0a20 2020 2020 2020 203e 3e3e   in..        >>>
+00016bf0: 2074 656d 705f 6469 7220 3d20 6f73 2e70   temp_dir = os.p
+00016c00: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
+00016c10: 5041 5448 2c20 2774 656d 706c 6174 6573  PATH, 'templates
+00016c20: 2729 0a0a 2020 2020 5061 7261 6d65 7465  ')..    Paramete
+00016c30: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00016c40: 2d0a 2020 2020 6677 686d 203a 2066 6c6f  -.    fwhm : flo
+00016c50: 6174 0a20 2020 2020 2020 2046 5748 4d20  at.        FWHM 
+00016c60: 6f66 2061 2047 6175 7373 6961 6e2c 2069  of a Gaussian, i
+00016c70: 6e20 6b6d 2f73 2c20 7468 6174 2069 7320  n km/s, that is 
+00016c80: 636f 6e76 6f6c 7665 6420 7769 7468 2074  convolved with t
+00016c90: 6865 2065 6d69 7373 696f 6e0a 2020 2020  he emission.    
+00016ca0: 2020 2020 6c69 6e65 2074 656d 706c 6174      line templat
+00016cb0: 6573 2e20 2049 6620 746f 6f20 6e61 7272  es.  If too narr
+00016cc0: 6f77 2c20 7468 656e 2063 616e 2073 6565  ow, then can see
+00016cd0: 2070 6978 656c 2065 6666 6563 7473 2069   pixel effects i
+00016ce0: 6e20 7468 650a 2020 2020 2020 2020 6669  n the.        fi
+00016cf0: 7473 2061 7320 6120 6675 6e63 7469 6f6e  ts as a function
+00016d00: 206f 6620 7265 6473 6869 6674 2e0a 0a20   of redshift... 
+00016d10: 2020 206c 696e 655f 636f 6d70 6c65 7865     line_complexe
+00016d20: 7320 3a20 626f 6f6c 0a20 2020 2020 2020  s : bool.       
+00016d30: 2047 656e 6572 6174 6520 6c69 6e65 2063   Generate line c
+00016d40: 6f6d 706c 6578 2074 656d 706c 6174 6573  omplex templates
+00016d50: 2077 6974 6820 6669 7865 6420 666c 7578   with fixed flux
+00016d60: 2072 6174 696f 7320 7261 7468 6572 2074   ratios rather t
+00016d70: 6861 6e0a 2020 2020 2020 2020 696e 6469  han.        indi
+00016d80: 7669 6475 616c 206c 696e 6573 2e20 5468  vidual lines. Th
+00016d90: 6973 2069 7320 7573 6566 756c 2066 6f72  is is useful for
+00016da0: 2074 6865 2072 6564 7368 6966 7420 6669   the redshift fi
+00016db0: 7473 2077 6865 7265 2074 6865 7265 0a20  ts where there. 
+00016dc0: 2020 2020 2020 2077 6f75 6c64 2062 6520         would be 
+00016dd0: 7265 6473 6869 6674 2064 6567 656e 6572  redshift degener
+00016de0: 6163 6965 7320 6966 2074 6865 206c 696e  acies if the lin
+00016df0: 6520 666c 7578 6573 2066 6f72 2069 6e64  e fluxes for ind
+00016e00: 6976 6964 7561 6c0a 2020 2020 2020 2020  ividual.        
+00016e10: 6c69 6e65 7320 7765 7265 2061 6c6c 6f77  lines were allow
+00016e20: 6564 2074 6f20 7661 7279 2063 6f6d 706c  ed to vary compl
+00016e30: 6574 656c 7920 6672 6565 6c79 2e20 5365  etely freely. Se
+00016e40: 6520 7468 6520 6c69 7374 206f 660a 2020  e the list of.  
+00016e50: 2020 2020 2020 6176 6169 6c61 626c 6520        available 
+00016e60: 6c69 6e65 7320 616e 6420 6c69 6e65 2067  lines and line g
+00016e70: 726f 7570 7320 696e 0a20 2020 2020 2020  roups in.       
+00016e80: 2060 7e67 7269 7a6c 692e 7574 696c 732e   `~grizli.utils.
+00016e90: 6765 745f 6c69 6e65 5f77 6176 656c 656e  get_line_wavelen
+00016ea0: 6774 6873 602e 2043 7572 7265 6e74 6c79  gths`. Currently
+00016eb0: 2c0a 2020 2020 2020 2020 606c 696e 655f  ,.        `line_
+00016ec0: 636f 6d70 6c65 7865 733d 5472 7565 6020  complexes=True` 
+00016ed0: 6765 6e65 7261 7465 7320 7468 6520 666f  generates the fo
+00016ee0: 6c6c 6f77 696e 6720 6772 6f75 7073 3a0a  llowing groups:.
+00016ef0: 0a20 2020 2020 2020 2020 2020 2048 612b  .            Ha+
+00016f00: 4e49 492b 5349 492b 5349 4949 2b48 650a  NII+SII+SIII+He.
+00016f10: 2020 2020 2020 2020 2020 2020 4f49 4949              OIII
+00016f20: 2b48 620a 2020 2020 2020 2020 2020 2020  +Hb.            
+00016f30: 4f49 492b 4e65 0a0a 2020 2020 7374 6172  OII+Ne..    star
+00016f40: 7320 3a20 626f 6f6c 0a20 2020 2020 2020  s : bool.       
+00016f50: 2047 6574 2073 7465 6c6c 6172 2074 656d   Get stellar tem
+00016f60: 706c 6174 6573 2072 6174 6865 7220 7468  plates rather th
+00016f70: 616e 2067 616c 6178 6965 7320 2b20 6c69  an galaxies + li
+00016f80: 6e65 730a 0a20 2020 2066 756c 6c5f 6c69  nes..    full_li
+00016f90: 6e65 5f6c 6973 7420 3a20 4e6f 6e65 206f  ne_list : None o
+00016fa0: 7220 6c69 7374 0a20 2020 2020 2020 2046  r list.        F
+00016fb0: 756c 6c20 7365 7420 6f66 206c 696e 6573  ull set of lines
+00016fc0: 2074 6f20 7472 792e 2020 5468 6520 6465   to try.  The de
+00016fd0: 6661 756c 7420 6973 2073 6574 2069 6e20  fault is set in 
+00016fe0: 7468 6520 676c 6f62 616c 2076 6172 6961  the global varia
+00016ff0: 626c 650a 2020 2020 2020 2020 607e 6772  ble.        `~gr
+00017000: 697a 6c69 2e75 7469 6c73 2e44 4546 4155  izli.utils.DEFAU
+00017010: 4c54 5f4c 494e 455f 4c49 5354 602e 0a0a  LT_LINE_LIST`...
+00017020: 2020 2020 2020 2020 5468 6520 6675 6c6c          The full
+00017030: 206c 6973 7420 6f66 2069 6d70 6c65 6d65   list of impleme
+00017040: 6e74 6564 206c 696e 6573 2069 7320 696e  nted lines is in
+00017050: 2060 7e67 7269 7a6c 692e 7574 696c 732e   `~grizli.utils.
+00017060: 6765 745f 6c69 6e65 5f77 6176 656c 656e  get_line_wavelen
+00017070: 6774 6873 602e 0a0a 2020 2020 636f 6e74  gths`...    cont
+00017080: 696e 7575 6d5f 6c69 7374 203a 204e 6f6e  inuum_list : Non
+00017090: 6520 6f72 206c 6973 740a 2020 2020 2020  e or list.      
+000170a0: 2020 4f76 6572 7269 6465 2074 6865 2064    Override the d
+000170b0: 6566 6175 6c74 2063 6f6e 7469 6e75 756d  efault continuum
+000170c0: 2074 656d 706c 6174 6573 2069 6620 4e6f   templates if No
+000170d0: 6e65 2e0a 0a20 2020 2066 7370 735f 7465  ne...    fsps_te
+000170e0: 6d70 6c61 7465 7320 3a20 626f 6f6c 0a20  mplates : bool. 
+000170f0: 2020 2020 2020 2049 6620 5472 7565 2c20         If True, 
+00017100: 6765 7420 7468 6520 4653 5053 204e 4d46  get the FSPS NMF
+00017110: 2074 656d 706c 6174 6573 2e0a 0a20 2020   templates...   
+00017120: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+00017130: 2d2d 2d2d 0a20 2020 2074 656d 705f 6c69  ----.    temp_li
+00017140: 7374 203a 2064 6963 7469 6f6e 6172 7920  st : dictionary 
+00017150: 6f66 2060 7e67 7269 7a6c 692e 7574 696c  of `~grizli.util
+00017160: 732e 5370 6563 7472 756d 5465 6d70 6c61  s.SpectrumTempla
+00017170: 7465 6020 6f62 6a65 6374 730a 2020 2020  te` objects.    
+00017180: 2020 2020 4f75 7470 7574 2074 656d 706c      Output templ
+00017190: 6174 6520 6c69 7374 0a0a 2020 2020 2222  ate list..    ""
+000171a0: 220a 0a20 2020 2069 6620 7374 6172 733a  "..    if stars:
+000171b0: 0a20 2020 2020 2020 2023 2074 656d 706c  .        # templ
+000171c0: 6174 6573 203d 2067 6c6f 622e 676c 6f62  ates = glob.glob
+000171d0: 2827 2573 2f74 656d 706c 6174 6573 2f50  ('%s/templates/P
+000171e0: 6963 6b6c 6573 5f73 7461 7273 2f65 7874  ickles_stars/ext
+000171f0: 2f2a 6461 7427 2025 2847 5249 5a4c 495f  /*dat' %(GRIZLI_
+00017200: 5041 5448 2929 0a20 2020 2020 2020 2023  PATH)).        #
+00017210: 2074 656d 706c 6174 6573 203d 205b 5d0a   templates = [].
+00017220: 2020 2020 2020 2020 2320 666f 7220 7420          # for t 
+00017230: 696e 2027 6f62 6166 676b 6d72 7727 3a0a  in 'obafgkmrw':.
+00017240: 2020 2020 2020 2020 2320 2020 2020 7465          #     te
+00017250: 6d70 6c61 7465 732e 6578 7465 6e64 2820  mplates.extend( 
+00017260: 676c 6f62 2e67 6c6f 6228 2725 732f 7465  glob.glob('%s/te
+00017270: 6d70 6c61 7465 732f 5069 636b 6c65 735f  mplates/Pickles_
+00017280: 7374 6172 732f 6578 742f 756b 2573 2a64  stars/ext/uk%s*d
+00017290: 6174 2720 2528 6f73 2e67 6574 656e 7628  at' %(os.getenv(
+000172a0: 2754 4852 4545 4448 5354 2729 2c20 7429  'THREEDHST'), t)
+000172b0: 2929 0a20 2020 2020 2020 2023 2074 656d  )).        # tem
+000172c0: 706c 6174 6573 2e65 7874 656e 6428 676c  plates.extend(gl
+000172d0: 6f62 2e67 6c6f 6228 2725 732f 7465 6d70  ob.glob('%s/temp
+000172e0: 6c61 7465 732f 5350 4558 2f73 7065 782d  lates/SPEX/spex-
+000172f0: 7072 6973 6d2d 4d2a 7478 7427 2025 286f  prism-M*txt' %(o
+00017300: 732e 6765 7465 6e76 2827 5448 5245 4544  s.getenv('THREED
+00017310: 4853 5427 2929 2929 0a20 2020 2020 2020  HST')))).       
+00017320: 2023 2074 656d 706c 6174 6573 2e65 7874   # templates.ext
+00017330: 656e 6428 676c 6f62 2e67 6c6f 6228 2725  end(glob.glob('%
+00017340: 732f 7465 6d70 6c61 7465 732f 5350 4558  s/templates/SPEX
+00017350: 2f73 7065 782d 7072 6973 6d2d 5b4c 545d  /spex-prism-[LT]
+00017360: 2a74 7874 2720 2528 6f73 2e67 6574 656e  *txt' %(os.geten
+00017370: 7628 2754 4852 4545 4448 5354 2729 2929  v('THREEDHST')))
+00017380: 290a 2020 2020 2020 2020 230a 2020 2020  ).        #.    
+00017390: 2020 2020 2320 2374 656d 706c 6174 6573      # #templates
+000173a0: 203d 2067 6c6f 622e 676c 6f62 2827 2f55   = glob.glob('/U
+000173b0: 7365 7273 2f62 7261 6d6d 6572 2f44 6f77  sers/brammer/Dow
+000173c0: 6e6c 6f61 6473 2f74 656d 706c 6174 6573  nloads/templates
+000173d0: 2f73 7065 782a 7478 7427 290a 2020 2020  /spex*txt').    
+000173e0: 2020 2020 2320 7465 6d70 6c61 7465 7320      # templates 
+000173f0: 3d20 676c 6f62 2e67 6c6f 6228 2762 7067  = glob.glob('bpg
+00017400: 732f 2a61 7363 6969 2729 0a20 2020 2020  s/*ascii').     
+00017410: 2020 2023 2069 6e66 6f20 3d20 6361 7449     # info = catI
+00017420: 4f2e 5461 626c 6528 2762 7067 732f 6270  O.Table('bpgs/bp
+00017430: 6773 2e69 6e66 6f27 290a 2020 2020 2020  gs.info').      
+00017440: 2020 2320 7479 7065 203d 206e 702e 6172    # type = np.ar
+00017450: 7261 7928 5b74 5b3a 325d 2066 6f72 2074  ray([t[:2] for t
+00017460: 2069 6e20 696e 666f 5b27 7479 7065 275d   in info['type']
+00017470: 5d29 0a20 2020 2020 2020 2023 2074 656d  ]).        # tem
+00017480: 706c 6174 6573 203d 205b 5d0a 2020 2020  plates = [].    
+00017490: 2020 2020 2320 666f 7220 7420 696e 2027      # for t in '
+000174a0: 4f42 4146 474b 4d27 3a0a 2020 2020 2020  OBAFGKM':.      
+000174b0: 2020 2320 2020 2020 7465 7374 203d 2074    #     test = t
+000174c0: 7970 6520 3d3d 2027 2d25 7327 2025 2874  ype == '-%s' %(t
+000174d0: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
+000174e0: 736f 203d 206e 702e 6172 6773 6f72 7428  so = np.argsort(
+000174f0: 696e 666f 5b27 7479 7065 275d 5b74 6573  info['type'][tes
+00017500: 745d 290a 2020 2020 2020 2020 2320 2020  t]).        #   
+00017510: 2020 7465 6d70 6c61 7465 732e 6578 7465    templates.exte
+00017520: 6e64 2869 6e66 6f5b 2766 696c 6527 5d5b  nd(info['file'][
+00017530: 7465 7374 5d5b 736f 5d29 0a20 2020 2020  test][so]).     
+00017540: 2020 2023 0a20 2020 2020 2020 2023 2074     #.        # t
+00017550: 656d 705f 6c69 7374 203d 204f 7264 6572  emp_list = Order
+00017560: 6564 4469 6374 2829 0a20 2020 2020 2020  edDict().       
+00017570: 2023 2066 6f72 2074 656d 7020 696e 2074   # for temp in t
+00017580: 656d 706c 6174 6573 3a0a 2020 2020 2020  emplates:.      
+00017590: 2020 2320 2020 2020 2364 6174 6120 3d20    #     #data = 
+000175a0: 6e70 2e6c 6f61 6474 7874 2827 6270 6773  np.loadtxt('bpgs
+000175b0: 2f27 2b74 656d 702c 2075 6e70 6163 6b3d  /'+temp, unpack=
+000175c0: 5472 7565 290a 2020 2020 2020 2020 2320  True).        # 
+000175d0: 2020 2020 6461 7461 203d 206e 702e 6c6f      data = np.lo
+000175e0: 6164 7478 7428 7465 6d70 2c20 756e 7061  adtxt(temp, unpa
+000175f0: 636b 3d54 7275 6529 0a20 2020 2020 2020  ck=True).       
+00017600: 2023 2020 2020 2023 6461 7461 5b30 5d20   #     #data[0] 
+00017610: 2a3d 2031 2e65 3420 2320 7370 6578 0a20  *= 1.e4 # spex. 
+00017620: 2020 2020 2020 2023 2020 2020 2073 636c         #     scl
+00017630: 203d 206e 702e 696e 7465 7270 2835 3530   = np.interp(550
+00017640: 302e 2c20 6461 7461 5b30 5d2c 2064 6174  0., data[0], dat
+00017650: 615b 315d 290a 2020 2020 2020 2020 2320  a[1]).        # 
+00017660: 2020 2020 6e61 6d65 203d 206f 732e 7061      name = os.pa
+00017670: 7468 2e62 6173 656e 616d 6528 7465 6d70  th.basename(temp
+00017680: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
+00017690: 2369 7820 3d20 696e 666f 5b27 6669 6c65  #ix = info['file
+000176a0: 275d 203d 3d20 7465 6d70 0a20 2020 2020  '] == temp.     
+000176b0: 2020 2023 2020 2020 2023 6e61 6d65 3d27     #     #name='
+000176c0: 2535 7320 2573 2720 2528 696e 666f 5b27  %5s %s' %(info['
+000176d0: 7479 7065 275d 5b69 785d 5b30 5d5b 313a  type'][ix][0][1:
+000176e0: 5d2c 2074 656d 702e 7370 6c69 7428 272e  ], temp.split('.
+000176f0: 6173 2729 5b30 5d29 0a20 2020 2020 2020  as')[0]).       
+00017700: 2023 2020 2020 2070 7269 6e74 286e 616d   #     print(nam
+00017710: 6529 0a20 2020 2020 2020 2023 2020 2020  e).        #    
+00017720: 2074 656d 705f 6c69 7374 5b6e 616d 655d   temp_list[name]
+00017730: 203d 2075 7469 6c73 2e53 7065 6374 7275   = utils.Spectru
+00017740: 6d54 656d 706c 6174 6528 7761 7665 3d64  mTemplate(wave=d
+00017750: 6174 615b 305d 2c0a 2020 2020 2020 2020  ata[0],.        
+00017760: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00017770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017780: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017790: 6c75 783d 6461 7461 5b31 5d2f 7363 6c29  lux=data[1]/scl)
+000177a0: 0a0a 2020 2020 2020 2020 2320 6e70 2e73  ..        # np.s
+000177b0: 6176 6528 2773 7461 7273 5f62 7067 732e  ave('stars_bpgs.
+000177c0: 6e70 7927 2c20 5b74 656d 705f 6c69 7374  npy', [temp_list
+000177d0: 5d29 0a0a 2020 2020 2020 2020 2320 7461  ])..        # ta
+000177e0: 6c6c 203d 206e 702e 6c6f 6164 286f 732e  ll = np.load(os.
+000177f0: 7061 7468 2e6a 6f69 6e28 4752 495a 4c49  path.join(GRIZLI
+00017800: 5f50 4154 482c 0a20 2020 2020 2020 2023  _PATH,.        #
+00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017830: 2020 2774 656d 706c 6174 6573 2f73 7461    'templates/sta
+00017840: 7273 2e6e 7079 2729 295b 305d 0a20 2020  rs.npy'))[0].   
+00017850: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
+00017860: 2072 6574 7572 6e20 7461 6c6c 0a20 2020   return tall.   
+00017870: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
+00017880: 2074 656d 705f 6c69 7374 203d 204f 7264   temp_list = Ord
+00017890: 6572 6564 4469 6374 2829 0a20 2020 2020  eredDict().     
+000178a0: 2020 2023 2066 6f72 206b 2069 6e20 7461     # for k in ta
+000178b0: 6c6c 3a0a 2020 2020 2020 2020 2320 2020  ll:.        #   
+000178c0: 2020 6966 206b 2e73 7461 7274 7377 6974    if k.startswit
+000178d0: 6828 2775 6b27 293a 0a20 2020 2020 2020  h('uk'):.       
+000178e0: 2023 2020 2020 2020 2020 2074 656d 705f   #         temp_
+000178f0: 6c69 7374 5b6b 5d20 3d20 7461 6c6c 5b6b  list[k] = tall[k
+00017900: 5d0a 2020 2020 2020 2020 230a 2020 2020  ].        #.    
+00017910: 2020 2020 2320 7265 7475 726e 2074 656d      # return tem
+00017920: 705f 6c69 7374 0a20 2020 2020 2020 2023  p_list.        #
+00017930: 0a20 2020 2020 2020 2023 2066 6f72 2074  .        # for t
+00017940: 2069 6e20 274d 4c54 273a 0a20 2020 2020   in 'MLT':.     
+00017950: 2020 2023 2020 2020 2066 6f72 206b 2069     #     for k i
+00017960: 6e20 7461 6c6c 3a0a 2020 2020 2020 2020  n tall:.        
+00017970: 2320 2020 2020 2020 2020 6966 206b 2e73  #         if k.s
+00017980: 7461 7274 7377 6974 6828 2773 7065 782d  tartswith('spex-
+00017990: 7072 6973 6d2d 272b 7429 3a0a 2020 2020  prism-'+t):.    
+000179a0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+000179b0: 2020 7465 6d70 5f6c 6973 745b 6b5d 203d    temp_list[k] =
+000179c0: 2074 616c 6c5b 6b5d 0a20 2020 2020 2020   tall[k].       
+000179d0: 2023 0a20 2020 2020 2020 2023 2072 6574   #.        # ret
+000179e0: 7572 6e20 7465 6d70 5f6c 6973 740a 0a20  urn temp_list.. 
+000179f0: 2020 2020 2020 2023 2072 6574 7572 6e20         # return 
+00017a00: 7465 6d70 5f6c 6973 740a 2020 2020 2020  temp_list.      
+00017a10: 2020 7465 6d70 6c61 7465 7320 3d20 5b27    templates = ['
+00017a20: 4d36 2e35 2e74 7874 272c 2027 4d38 2e30  M6.5.txt', 'M8.0
+00017a30: 2e74 7874 272c 2027 4c31 2e30 2e74 7874  .txt', 'L1.0.txt
+00017a40: 272c 2027 4c33 2e35 2e74 7874 272c 2027  ', 'L3.5.txt', '
+00017a50: 4c36 2e30 2e74 7874 272c 2027 5432 2e30  L6.0.txt', 'T2.0
+00017a60: 2e74 7874 272c 2027 5436 2e30 2e74 7874  .txt', 'T6.0.txt
+00017a70: 272c 2027 5437 2e35 2e74 7874 275d 0a20  ', 'T7.5.txt']. 
+00017a80: 2020 2020 2020 2074 656d 706c 6174 6573         templates
+00017a90: 203d 205b 2773 7461 7273 2f27 2b74 2066   = ['stars/'+t f
+00017aa0: 6f72 2074 2069 6e20 7465 6d70 6c61 7465  or t in template
+00017ab0: 735d 0a20 2020 2065 6c73 653a 0a20 2020  s].    else:.   
+00017ac0: 2020 2020 2023 2049 6e74 6572 6d65 6469       # Intermedi
+00017ad0: 6174 6520 616e 6420 7665 7279 206f 6c64  ate and very old
+00017ae0: 0a20 2020 2020 2020 2023 2074 656d 706c  .        # templ
+00017af0: 6174 6573 203d 205b 2774 656d 706c 6174  ates = ['templat
+00017b00: 6573 2f45 415a 595f 7631 2e30 5f6c 696e  es/EAZY_v1.0_lin
+00017b10: 6573 2f65 617a 795f 7631 2e30 5f73 6564  es/eazy_v1.0_sed
+00017b20: 335f 6e6f 6c69 6e65 732e 6461 7427 2c0a  3_nolines.dat',.
+00017b30: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00017b40: 2020 2020 2020 2027 7465 6d70 6c61 7465         'template
+00017b50: 732f 6376 6431 325f 7431 315f 736f 6c61  s/cvd12_t11_sola
+00017b60: 725f 4368 6162 7269 6572 2e65 7874 656e  r_Chabrier.exten
+00017b70: 642e 736b 6970 3130 2e64 6174 275d 0a20  d.skip10.dat']. 
+00017b80: 2020 2020 2020 2074 656d 706c 6174 6573         templates
+00017b90: 203d 205b 2765 617a 795f 696e 7465 726d   = ['eazy_interm
+00017ba0: 6564 6961 7465 2e64 6174 272c 0a20 2020  ediate.dat',.   
+00017bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bc0: 2020 2763 7664 3132 5f74 3131 5f73 6f6c    'cvd12_t11_sol
+00017bd0: 6172 5f43 6861 6272 6965 722e 6461 7427  ar_Chabrier.dat'
+00017be0: 5d0a 0a20 2020 2020 2020 2023 2050 6f73  ]..        # Pos
+00017bf0: 7420 7374 6172 6275 7273 740a 2020 2020  t starburst.    
+00017c00: 2020 2020 2320 7465 6d70 6c61 7465 732e      # templates.
+00017c10: 6170 7065 6e64 2827 7465 6d70 6c61 7465  append('template
+00017c20: 732f 556c 7472 6156 4953 5441 2f65 617a  s/UltraVISTA/eaz
+00017c30: 795f 7631 2e31 5f73 6564 392e 6461 7427  y_v1.1_sed9.dat'
+00017c40: 290a 2020 2020 2020 2020 7465 6d70 6c61  ).        templa
+00017c50: 7465 732e 6170 7065 6e64 2827 706f 7374  tes.append('post
+00017c60: 5f73 7461 7262 7572 7374 2e64 6174 2729  _starburst.dat')
+00017c70: 0a0a 2020 2020 2020 2020 2320 5665 7279  ..        # Very
+00017c80: 2062 6c75 6520 636f 6e74 696e 7575 6d0a   blue continuum.
+00017c90: 2020 2020 2020 2020 2320 7465 6d70 6c61          # templa
+00017ca0: 7465 732e 6170 7065 6e64 2827 7465 6d70  tes.append('temp
+00017cb0: 6c61 7465 732f 596f 756e 6753 422f 6572  lates/YoungSB/er
+00017cc0: 6232 3031 305f 636f 6e74 696e 7575 6d2e  b2010_continuum.
+00017cd0: 6461 7427 290a 2020 2020 2020 2020 7465  dat').        te
+00017ce0: 6d70 6c61 7465 732e 6170 7065 6e64 2827  mplates.append('
+00017cf0: 6572 6232 3031 305f 636f 6e74 696e 7575  erb2010_continuu
+00017d00: 6d2e 6461 7427 290a 0a20 2020 2020 2020  m.dat')..       
+00017d10: 2023 2054 6573 7420 6e65 7720 7465 6d70   # Test new temp
+00017d20: 6c61 7465 730a 2020 2020 2020 2020 2320  lates.        # 
+00017d30: 7465 6d70 6c61 7465 7320 3d20 5b27 7465  templates = ['te
+00017d40: 6d70 6c61 7465 732f 6572 6232 3031 305f  mplates/erb2010_
+00017d50: 636f 6e74 696e 7575 6d2e 6461 7427 2c0a  continuum.dat',.
+00017d60: 2020 2020 2020 2020 2320 2774 656d 706c          # 'templ
+00017d70: 6174 6573 2f66 7370 732f 7477 6561 6b5f  ates/fsps/tweak_
+00017d80: 6673 7073 5f74 656d 705f 6b63 3133 5f31  fsps_temp_kc13_1
+00017d90: 325f 3030 362e 6461 7427 2c0a 2020 2020  2_006.dat',.    
+00017da0: 2020 2020 2320 2774 656d 706c 6174 6573      # 'templates
+00017db0: 2f66 7370 732f 7477 6561 6b5f 6673 7073  /fsps/tweak_fsps
+00017dc0: 5f74 656d 705f 6b63 3133 5f31 325f 3030  _temp_kc13_12_00
+00017dd0: 382e 6461 7427 5d0a 0a20 2020 2020 2020  8.dat']..       
+00017de0: 2069 6620 6673 7073 5f74 656d 706c 6174   if fsps_templat
+00017df0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00017e00: 2374 656d 706c 6174 6573 203d 205b 2774  #templates = ['t
+00017e10: 656d 706c 6174 6573 2f66 7370 732f 7477  emplates/fsps/tw
+00017e20: 6561 6b5f 6673 7073 5f74 656d 705f 6b63  eak_fsps_temp_kc
+00017e30: 3133 5f31 325f 307b 303a 3032 647d 2e64  13_12_0{0:02d}.d
+00017e40: 6174 272e 666f 726d 6174 2869 2b31 2920  at'.format(i+1) 
+00017e50: 666f 7220 6920 696e 2072 616e 6765 2831  for i in range(1
+00017e60: 3229 5d0a 2020 2020 2020 2020 2020 2020  2)].            
+00017e70: 7465 6d70 6c61 7465 7320 3d20 5b27 6673  templates = ['fs
+00017e80: 7073 2f66 7370 735f 5153 465f 3132 5f76  ps/fsps_QSF_12_v
+00017e90: 335f 6e6f 6c69 6e65 735f 307b 303a 3032  3_nolines_0{0:02
+00017ea0: 647d 2e64 6174 272e 666f 726d 6174 2869  d}.dat'.format(i
+00017eb0: 2b31 2920 666f 7220 6920 696e 2072 616e  +1) for i in ran
+00017ec0: 6765 2831 3229 5d0a 2020 2020 2020 2020  ge(12)].        
+00017ed0: 2020 2020 2374 656d 706c 6174 6573 203d      #templates =
+00017ee0: 205b 2766 7370 732f 6673 7073 5f51 5346   ['fsps/fsps_QSF
+00017ef0: 5f37 5f76 335f 6e6f 6c69 6e65 735f 307b  _7_v3_nolines_0{
+00017f00: 303a 3032 647d 2e64 6174 272e 666f 726d  0:02d}.dat'.form
+00017f10: 6174 2869 2b31 2920 666f 7220 6920 696e  at(i+1) for i in
+00017f20: 2072 616e 6765 2837 295d 0a0a 2020 2020   range(7)]..    
+00017f30: 2020 2020 6966 2061 6c66 5f74 656d 706c      if alf_templ
+00017f40: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00017f50: 2074 656d 706c 6174 6573 2e61 7070 656e   templates.appen
+00017f60: 6428 2761 6c66 5f53 5350 2e64 6174 2729  d('alf_SSP.dat')
+00017f70: 0a0a 2020 2020 2020 2020 6966 2063 6f6e  ..        if con
+00017f80: 7469 6e75 756d 5f6c 6973 7420 6973 206e  tinuum_list is n
+00017f90: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00017fa0: 2020 2020 2074 656d 706c 6174 6573 203d       templates =
+00017fb0: 2063 6f6e 7469 6e75 756d 5f6c 6973 740a   continuum_list.
+00017fc0: 0a20 2020 2074 656d 705f 6c69 7374 203d  .    temp_list =
+00017fd0: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
+00017fe0: 2020 2066 6f72 2074 656d 7020 696e 2074     for temp in t
+00017ff0: 656d 706c 6174 6573 3a0a 2020 2020 2020  emplates:.      
+00018000: 2020 6461 7461 203d 206e 702e 6c6f 6164    data = np.load
+00018010: 7478 7428 6f73 2e70 6174 682e 6a6f 696e  txt(os.path.join
+00018020: 2847 5249 5a4c 495f 5041 5448 2c20 2774  (GRIZLI_PATH, 't
+00018030: 656d 706c 6174 6573 272c 2074 656d 7029  emplates', temp)
+00018040: 2c20 756e 7061 636b 3d54 7275 6529 0a20  , unpack=True). 
+00018050: 2020 2020 2020 2023 7363 6c20 3d20 6e70         #scl = np
+00018060: 2e69 6e74 6572 7028 3535 3030 2e2c 2064  .interp(5500., d
+00018070: 6174 615b 305d 2c20 6461 7461 5b31 5d29  ata[0], data[1])
+00018080: 0a20 2020 2020 2020 2073 636c 203d 2031  .        scl = 1
+00018090: 2e0a 2020 2020 2020 2020 6e61 6d65 203d  ..        name =
+000180a0: 2074 656d 7020 2023 206f 732e 7061 7468   temp  # os.path
+000180b0: 2e62 6173 656e 616d 6528 7465 6d70 290a  .basename(temp).
+000180c0: 2020 2020 2020 2020 7465 6d70 5f6c 6973          temp_lis
+000180d0: 745b 6e61 6d65 5d20 3d20 5370 6563 7472  t[name] = Spectr
+000180e0: 756d 5465 6d70 6c61 7465 2877 6176 653d  umTemplate(wave=
+000180f0: 6461 7461 5b30 5d2c 2066 6c75 783d 6461  data[0], flux=da
+00018100: 7461 5b31 5d2f 7363 6c2c 0a20 2020 2020  ta[1]/scl,.     
+00018110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018130: 2020 2020 2020 6e61 6d65 3d6e 616d 6529        name=name)
+00018140: 0a0a 2020 2020 2020 2020 7465 6d70 5f6c  ..        temp_l
+00018150: 6973 745b 6e61 6d65 5d2e 6e61 6d65 203d  ist[name].name =
+00018160: 206e 616d 650a 0a20 2020 2069 6620 7374   name..    if st
+00018170: 6172 733a 0a20 2020 2020 2020 2072 6574  ars:.        ret
+00018180: 7572 6e20 7465 6d70 5f6c 6973 740a 0a20  urn temp_list.. 
+00018190: 2020 2023 2045 6d69 7373 696f 6e20 6c69     # Emission li
+000181a0: 6e65 733a 0a20 2020 206c 696e 655f 7761  nes:.    line_wa
+000181b0: 7665 6c65 6e67 7468 732c 206c 696e 655f  velengths, line_
+000181c0: 7261 7469 6f73 203d 2067 6574 5f6c 696e  ratios = get_lin
+000181d0: 655f 7761 7665 6c65 6e67 7468 7328 290a  e_wavelengths().
+000181e0: 0a20 2020 2069 6620 6c69 6e65 5f63 6f6d  .    if line_com
+000181f0: 706c 6578 6573 3a0a 2020 2020 2020 2020  plexes:.        
+00018200: 236c 696e 655f 6c69 7374 203d 205b 2748  #line_list = ['H
+00018210: 612b 5349 4927 2c20 274f 4949 492b 4862  a+SII', 'OIII+Hb
+00018220: 2b48 6127 2c20 274f 4949 275d 0a20 2020  +Ha', 'OII'].   
+00018230: 2020 2020 2023 6c69 6e65 5f6c 6973 7420       #line_list 
+00018240: 3d20 5b27 4861 2b53 4949 272c 2027 4f49  = ['Ha+SII', 'OI
+00018250: 4949 2b48 6227 2c20 274f 4949 275d 0a20  II+Hb', 'OII']. 
+00018260: 2020 2020 2020 2023 6c69 6e65 5f6c 6973         #line_lis
+00018270: 7420 3d20 5b27 4861 2b4e 4949 2b53 4949  t = ['Ha+NII+SII
+00018280: 2b53 4949 492b 4865 2b50 6142 272c 2027  +SIII+He+PaB', '
+00018290: 4f49 4949 2b48 6227 2c20 274f 4949 2b4e  OIII+Hb', 'OII+N
+000182a0: 6527 2c20 274c 7961 2b43 4956 275d 0a20  e', 'Lya+CIV']. 
+000182b0: 2020 2020 2020 2023 6c69 6e65 5f6c 6973         #line_lis
+000182c0: 7420 3d20 5b27 4861 2b4e 4949 2b53 4949  t = ['Ha+NII+SII
+000182d0: 2b53 4949 492b 4865 2b50 6142 272c 2027  +SIII+He+PaB', '
+000182e0: 4f49 4949 2b48 622b 4867 2b48 6427 2c20  OIII+Hb+Hg+Hd', 
+000182f0: 274f 4949 2b4e 6527 2c20 274c 7961 2b43  'OII+Ne', 'Lya+C
+00018300: 4956 275d 0a20 2020 2020 2020 206c 696e  IV'].        lin
+00018310: 655f 6c69 7374 203d 205b 2748 612b 4e49  e_list = ['Ha+NI
+00018320: 492b 5349 492b 5349 4949 2b48 652b 5061  I+SII+SIII+He+Pa
+00018330: 4227 2c20 274f 4949 492b 4862 2b48 672b  B', 'OIII+Hb+Hg+
+00018340: 4864 272c 2027 4f49 492b 4e65 272c 2027  Hd', 'OII+Ne', '
+00018350: 4761 6c2d 5556 2d6c 696e 6573 275d 0a0a  Gal-UV-lines']..
+00018360: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018370: 2020 6966 2066 756c 6c5f 6c69 6e65 5f6c    if full_line_l
+00018380: 6973 7420 6973 204e 6f6e 653a 0a20 2020  ist is None:.   
+00018390: 2020 2020 2020 2020 206c 696e 655f 6c69           line_li
+000183a0: 7374 203d 2044 4546 4155 4c54 5f4c 494e  st = DEFAULT_LIN
+000183b0: 455f 4c49 5354 0a20 2020 2020 2020 2065  E_LIST.        e
+000183c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000183d0: 206c 696e 655f 6c69 7374 203d 2066 756c   line_list = ful
+000183e0: 6c5f 6c69 6e65 5f6c 6973 740a 0a20 2020  l_line_list..   
+000183f0: 2020 2020 2023 6c69 6e65 5f6c 6973 7420       #line_list 
+00018400: 3d20 5b27 4861 272c 2027 5349 4927 5d0a  = ['Ha', 'SII'].
+00018410: 0a20 2020 2023 2055 7365 2046 5350 5320  .    # Use FSPS 
+00018420: 6772 6964 2066 6f72 206c 696e 6573 0a20  grid for lines. 
+00018430: 2020 2077 6176 655f 6772 6964 203d 204e     wave_grid = N
+00018440: 6f6e 650a 2020 2020 2320 6966 2066 7370  one.    # if fsp
+00018450: 735f 7465 6d70 6c61 7465 733a 0a20 2020  s_templates:.   
+00018460: 2023 2020 2020 2077 6176 655f 6772 6964   #     wave_grid
+00018470: 203d 2064 6174 615b 305d 0a20 2020 2023   = data[0].    #
+00018480: 2065 6c73 653a 0a20 2020 2023 2020 2020   else:.    #    
+00018490: 2077 6176 655f 6772 6964 203d 204e 6f6e   wave_grid = Non
+000184a0: 650a 0a20 2020 2066 6f72 206c 6920 696e  e..    for li in
+000184b0: 206c 696e 655f 6c69 7374 3a0a 2020 2020   line_list:.    
+000184c0: 2020 2020 7363 6c20 3d20 6c69 6e65 5f72      scl = line_r
+000184d0: 6174 696f 735b 6c69 5d2f 6e70 2e73 756d  atios[li]/np.sum
+000184e0: 286c 696e 655f 7261 7469 6f73 5b6c 695d  (line_ratios[li]
+000184f0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
+00018500: 696e 2072 616e 6765 286c 656e 2873 636c  in range(len(scl
+00018510: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00018520: 6966 2028 274f 3332 2720 696e 206c 6929  if ('O32' in li)
+00018530: 2026 2028 6e70 2e61 6273 286c 696e 655f   & (np.abs(line_
+00018540: 7761 7665 6c65 6e67 7468 735b 6c69 5d5b  wavelengths[li][
+00018550: 695d 2d32 3739 3929 203c 2032 293a 0a20  i]-2799) < 2):. 
+00018560: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018570: 7768 6d5f 6920 3d20 3235 3030 0a20 2020  whm_i = 2500.   
+00018580: 2020 2020 2020 2020 2020 2020 206c 6f72               lor
+00018590: 656e 747a 5f69 203d 2054 7275 650a 2020  entz_i = True.  
+000185a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000185b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185c0: 6677 686d 5f69 203d 2066 7768 6d0a 2020  fwhm_i = fwhm.  
+000185d0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+000185e0: 7265 6e74 7a5f 6920 3d20 6c6f 7265 6e74  rentz_i = lorent
+000185f0: 7a0a 0a20 2020 2020 2020 2020 2020 206c  z..            l
+00018600: 696e 655f 6920 3d20 5370 6563 7472 756d  ine_i = Spectrum
+00018610: 5465 6d70 6c61 7465 2877 6176 653d 7761  Template(wave=wa
+00018620: 7665 5f67 7269 642c 0a20 2020 2020 2020  ve_grid,.       
+00018630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018640: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018650: 656e 7472 616c 5f77 6176 653d 6c69 6e65  entral_wave=line
+00018660: 5f77 6176 656c 656e 6774 6873 5b6c 695d  _wavelengths[li]
+00018670: 5b69 5d2c 0a20 2020 2020 2020 2020 2020  [i],.           
+00018680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018690: 2020 2020 2020 2020 2020 2066 6c75 783d             flux=
+000186a0: 4e6f 6e65 2c20 6677 686d 3d66 7768 6d5f  None, fwhm=fwhm_
+000186b0: 692c 2076 656c 6f63 6974 793d 5472 7565  i, velocity=True
+000186c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000186d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186e0: 2020 2020 2020 2020 6c6f 7265 6e74 7a3d          lorentz=
+000186f0: 6c6f 7265 6e74 7a5f 6929 0a0a 2020 2020  lorentz_i)..    
+00018700: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
+00018710: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00018720: 2020 206c 696e 655f 7465 6d70 203d 206c     line_temp = l
+00018730: 696e 655f 692a 7363 6c5b 695d 0a20 2020  ine_i*scl[i].   
+00018740: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00018750: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00018760: 696e 655f 7465 6d70 203d 206c 696e 655f  ine_temp = line_
+00018770: 7465 6d70 202b 206c 696e 655f 692a 7363  temp + line_i*sc
+00018780: 6c5b 695d 0a0a 2020 2020 2020 2020 6e61  l[i]..        na
+00018790: 6d65 203d 2027 6c69 6e65 207b 307d 272e  me = 'line {0}'.
+000187a0: 666f 726d 6174 286c 6929 0a20 2020 2020  format(li).     
+000187b0: 2020 206c 696e 655f 7465 6d70 2e6e 616d     line_temp.nam
+000187c0: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
+000187d0: 2074 656d 705f 6c69 7374 5b6e 616d 655d   temp_list[name]
+000187e0: 203d 206c 696e 655f 7465 6d70 0a0a 2020   = line_temp..  
+000187f0: 2020 7265 7475 726e 2074 656d 705f 6c69    return temp_li
+00018800: 7374 0a0a 0a64 6566 206c 6f61 645f 6265  st...def load_be
+00018810: 7461 5f74 656d 706c 6174 6573 2877 6176  ta_templates(wav
+00018820: 653d 6e70 2e61 7261 6e67 6528 3430 302c  e=np.arange(400,
+00018830: 2032 2e35 6534 292c 2062 6574 6173 3d5b   2.5e4), betas=[
+00018840: 2d32 2c20 2d31 2c20 305d 293a 0a20 2020  -2, -1, 0]):.   
+00018850: 2022 2222 0a20 2020 2053 7465 702d 6675   """.    Step-fu
+00018860: 6e63 7469 6f6e 2074 656d 706c 6174 6573  nction templates
+00018870: 2077 6974 6820 665f 6c61 6d62 6461 207e   with f_lambda ~
+00018880: 2028 7761 7665 2f31 3231 362e 292a 2a62   (wave/1216.)**b
+00018890: 6574 610a 2020 2020 2222 220a 2020 2020  eta.    """.    
+000188a0: 636f 6e74 5f77 6176 6520 3d20 6e70 2e61  cont_wave = np.a
+000188b0: 7261 6e67 6528 3430 302c 2032 2e35 6534  range(400, 2.5e4
+000188c0: 290a 2020 2020 7430 203d 207b 7d0a 2020  ).    t0 = {}.  
+000188d0: 2020 666f 7220 6265 7461 2069 6e20 6265    for beta in be
+000188e0: 7461 733a 0a20 2020 2020 2020 206b 6579  tas:.        key
+000188f0: 203d 2027 6265 7461 207b 307d 272e 666f   = 'beta {0}'.fo
+00018900: 726d 6174 2862 6574 6129 0a20 2020 2020  rmat(beta).     
+00018910: 2020 2074 305b 6b65 795d 203d 2053 7065     t0[key] = Spe
+00018920: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
+00018930: 7665 3d63 6f6e 745f 7761 7665 2c20 666c  ve=cont_wave, fl
+00018940: 7578 3d28 636f 6e74 5f77 6176 652f 3132  ux=(cont_wave/12
+00018950: 3136 2e29 2a2a 6265 7461 290a 2020 2020  16.)**beta).    
+00018960: 7265 7475 726e 2074 300a 0a0a 6465 6620  return t0...def 
+00018970: 6c6f 6164 5f71 7561 7361 725f 7465 6d70  load_quasar_temp
+00018980: 6c61 7465 7328 6272 6f61 645f 6677 686d  lates(broad_fwhm
+00018990: 3d32 3530 302c 206e 6172 726f 775f 6677  =2500, narrow_fw
+000189a0: 686d 3d31 3230 302c 2062 726f 6164 5f6c  hm=1200, broad_l
+000189b0: 696e 6573 3d5b 2748 6549 2d35 3837 3727  ines=['HeI-5877'
+000189c0: 2c20 274d 6749 4927 2c20 274c 7961 272c  , 'MgII', 'Lya',
+000189d0: 2027 4349 562d 3135 3439 272c 2027 4349   'CIV-1549', 'CI
+000189e0: 4949 2d31 3930 3627 2c20 2743 4949 492d  II-1906', 'CIII-
+000189f0: 3139 3038 272c 2027 4f49 4949 2d31 3636  1908', 'OIII-166
+00018a00: 3327 2c20 2748 6549 492d 3136 3430 272c  3', 'HeII-1640',
+00018a10: 2027 5369 4956 2b4f 4956 2d31 3339 3827   'SiIV+OIV-1398'
+00018a20: 2c20 274e 4956 2d31 3438 3727 2c20 274e  , 'NIV-1487', 'N
+00018a30: 562d 3132 3430 272c 2027 5061 4227 2c20  V-1240', 'PaB', 
+00018a40: 2750 6147 275d 2c20 6e61 7272 6f77 5f6c  'PaG'], narrow_l
+00018a50: 696e 6573 3d5b 274e 4949 492d 3137 3530  ines=['NIII-1750
+00018a60: 272c 2027 4f49 4927 2c20 274f 4949 4927  ', 'OII', 'OIII'
+00018a70: 2c20 2753 4949 272c 2027 4f49 2d36 3330  , 'SII', 'OI-630
+00018a80: 3227 2c20 274f 4949 492d 3433 3633 272c  2', 'OIII-4363',
+00018a90: 2027 4e65 4949 492d 3338 3637 272c 2027   'NeIII-3867', '
+00018aa0: 4e65 5649 2d33 3432 3627 2c20 274e 6556  NeVI-3426', 'NeV
+00018ab0: 2d33 3334 3627 2c20 274f 4949 2d37 3332  -3346', 'OII-732
+00018ac0: 3527 2c20 2741 7249 4949 2d37 3133 3827  5', 'ArIII-7138'
+00018ad0: 2c20 2753 4949 4927 2c20 2748 6549 2d31  , 'SIII', 'HeI-1
+00018ae0: 3038 3327 5d2c 2069 6e63 6c75 6465 5f66  083'], include_f
+00018af0: 6569 693d 5472 7565 2c20 736c 6f70 6573  eii=True, slopes
+00018b00: 3d5b 2d32 2e38 2c20 302c 2032 2e38 5d2c  =[-2.8, 0, 2.8],
+00018b10: 2075 765f 6c69 6e65 5f63 6f6d 706c 6578   uv_line_complex
+00018b20: 3d54 7275 652c 2066 6978 6564 5f6e 6172  =True, fixed_nar
+00018b30: 726f 775f 6c69 6e65 733d 4661 6c73 652c  row_lines=False,
+00018b40: 2074 315f 6f6e 6c79 3d46 616c 7365 2c20   t1_only=False, 
+00018b50: 6e73 706c 696e 653d 3133 2c20 5273 706c  nspline=13, Rspl
+00018b60: 696e 653d 3330 2c20 6265 7461 733d 4e6f  ine=30, betas=No
+00018b70: 6e65 2c20 696e 636c 7564 655f 7265 6464  ne, include_redd
+00018b80: 656e 6564 5f62 616c 6d65 725f 6c69 6e65  ened_balmer_line
+00018b90: 733d 4661 6c73 6529 3a0a 2020 2020 2222  s=False):.    ""
+00018ba0: 220a 2020 2020 4d61 6b65 2074 656d 706c  ".    Make templ
+00018bb0: 6174 6573 2073 7569 7461 626c 6520 666f  ates suitable fo
+00018bc0: 7220 6669 7474 696e 6720 6272 6f61 642d  r fitting broad-
+00018bd0: 6c69 6e65 2071 7561 7361 7273 0a20 2020  line quasars.   
+00018be0: 2022 2222 0a0a 2020 2020 6672 6f6d 2063   """..    from c
+00018bf0: 6f6c 6c65 6374 696f 6e73 2069 6d70 6f72  ollections impor
+00018c00: 7420 4f72 6465 7265 6444 6963 740a 2020  t OrderedDict.  
+00018c10: 2020 696d 706f 7274 2073 6369 7079 2e6e    import scipy.n
+00018c20: 6469 6d61 6765 2061 7320 6e64 0a0a 2020  dimage as nd..  
+00018c30: 2020 7430 203d 204f 7264 6572 6564 4469    t0 = OrderedDi
+00018c40: 6374 2829 0a20 2020 2074 3120 3d20 4f72  ct().    t1 = Or
+00018c50: 6465 7265 6444 6963 7428 290a 0a20 2020  deredDict()..   
+00018c60: 2062 726f 6164 3120 3d20 6c6f 6164 5f74   broad1 = load_t
+00018c70: 656d 706c 6174 6573 2866 7768 6d3d 6272  emplates(fwhm=br
+00018c80: 6f61 645f 6677 686d 2c20 6c69 6e65 5f63  oad_fwhm, line_c
+00018c90: 6f6d 706c 6578 6573 3d46 616c 7365 2c20  omplexes=False, 
+00018ca0: 7374 6172 733d 4661 6c73 652c 2066 756c  stars=False, ful
+00018cb0: 6c5f 6c69 6e65 5f6c 6973 743d 5b27 4861  l_line_list=['Ha
+00018cc0: 272c 2027 4862 272c 2027 4867 272c 2027  ', 'Hb', 'Hg', '
+00018cd0: 4864 272c 2027 4837 272c 2027 4838 272c  Hd', 'H7', 'H8',
+00018ce0: 2027 4839 272c 2027 4831 3027 5d20 2b20   'H9', 'H10'] + 
+00018cf0: 6272 6f61 645f 6c69 6e65 732c 2063 6f6e  broad_lines, con
+00018d00: 7469 6e75 756d 5f6c 6973 743d 5b5d 2c20  tinuum_list=[], 
+00018d10: 6673 7073 5f74 656d 706c 6174 6573 3d46  fsps_templates=F
+00018d20: 616c 7365 2c20 616c 665f 7465 6d70 6c61  alse, alf_templa
+00018d30: 7465 3d46 616c 7365 2c20 6c6f 7265 6e74  te=False, lorent
+00018d40: 7a3d 5472 7565 290a 0a20 2020 206e 6172  z=True)..    nar
+00018d50: 726f 7731 203d 206c 6f61 645f 7465 6d70  row1 = load_temp
+00018d60: 6c61 7465 7328 6677 686d 3d34 3030 2c20  lates(fwhm=400, 
+00018d70: 6c69 6e65 5f63 6f6d 706c 6578 6573 3d46  line_complexes=F
+00018d80: 616c 7365 2c20 7374 6172 733d 4661 6c73  alse, stars=Fals
+00018d90: 652c 2066 756c 6c5f 6c69 6e65 5f6c 6973  e, full_line_lis
+00018da0: 743d 6e61 7272 6f77 5f6c 696e 6573 2c20  t=narrow_lines, 
+00018db0: 636f 6e74 696e 7575 6d5f 6c69 7374 3d5b  continuum_list=[
+00018dc0: 5d2c 2066 7370 735f 7465 6d70 6c61 7465  ], fsps_template
+00018dd0: 733d 4661 6c73 652c 2061 6c66 5f74 656d  s=False, alf_tem
+00018de0: 706c 6174 653d 4661 6c73 6529 0a0a 2020  plate=False)..  
+00018df0: 2020 6966 2066 6978 6564 5f6e 6172 726f    if fixed_narro
+00018e00: 775f 6c69 6e65 733a 0a20 2020 2020 2020  w_lines:.       
+00018e10: 2069 6620 7431 5f6f 6e6c 793a 0a20 2020   if t1_only:.   
+00018e20: 2020 2020 2020 2020 206e 6172 726f 7730           narrow0
+00018e30: 203d 206e 6172 726f 7731 0a20 2020 2020   = narrow1.     
+00018e40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00018e50: 2020 2020 206e 6172 726f 7730 203d 206c       narrow0 = l
+00018e60: 6f61 645f 7465 6d70 6c61 7465 7328 6677  oad_templates(fw
+00018e70: 686d 3d6e 6172 726f 775f 6677 686d 2c20  hm=narrow_fwhm, 
+00018e80: 6c69 6e65 5f63 6f6d 706c 6578 6573 3d46  line_complexes=F
+00018e90: 616c 7365 2c20 7374 6172 733d 4661 6c73  alse, stars=Fals
+00018ea0: 652c 2066 756c 6c5f 6c69 6e65 5f6c 6973  e, full_line_lis
+00018eb0: 743d 5b27 5153 4f2d 4e61 7272 6f77 2d6c  t=['QSO-Narrow-l
+00018ec0: 696e 6573 275d 2c20 636f 6e74 696e 7575  ines'], continuu
+00018ed0: 6d5f 6c69 7374 3d5b 5d2c 2066 7370 735f  m_list=[], fsps_
+00018ee0: 7465 6d70 6c61 7465 733d 4661 6c73 652c  templates=False,
+00018ef0: 2061 6c66 5f74 656d 706c 6174 653d 4661   alf_template=Fa
+00018f00: 6c73 6529 0a0a 2020 2020 656c 7365 3a0a  lse)..    else:.
+00018f10: 2020 2020 2020 2020 6e61 7272 6f77 3020          narrow0 
+00018f20: 3d20 6c6f 6164 5f74 656d 706c 6174 6573  = load_templates
+00018f30: 2866 7768 6d3d 6e61 7272 6f77 5f66 7768  (fwhm=narrow_fwh
+00018f40: 6d2c 206c 696e 655f 636f 6d70 6c65 7865  m, line_complexe
+00018f50: 733d 4661 6c73 652c 2073 7461 7273 3d46  s=False, stars=F
+00018f60: 616c 7365 2c20 6675 6c6c 5f6c 696e 655f  alse, full_line_
+00018f70: 6c69 7374 3d6e 6172 726f 775f 6c69 6e65  list=narrow_line
+00018f80: 732c 2063 6f6e 7469 6e75 756d 5f6c 6973  s, continuum_lis
+00018f90: 743d 5b5d 2c20 6673 7073 5f74 656d 706c  t=[], fsps_templ
+00018fa0: 6174 6573 3d46 616c 7365 2c20 616c 665f  ates=False, alf_
+00018fb0: 7465 6d70 6c61 7465 3d46 616c 7365 290a  template=False).
+00018fc0: 0a20 2020 2069 6620 7431 5f6f 6e6c 793a  .    if t1_only:
+00018fd0: 0a20 2020 2020 2020 2062 726f 6164 3020  .        broad0 
+00018fe0: 3d20 6272 6f61 6431 0a20 2020 2065 6c73  = broad1.    els
+00018ff0: 653a 0a20 2020 2020 2020 2069 6620 7576  e:.        if uv
+00019000: 5f6c 696e 655f 636f 6d70 6c65 783a 0a20  _line_complex:. 
+00019010: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
+00019020: 6c69 6e65 5f6c 6973 7420 3d20 5b27 4261  line_list = ['Ba
+00019030: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
+00019040: 2041 763d 302e 3527 2c20 2751 534f 2d55   Av=0.5', 'QSO-U
+00019050: 562d 6c69 6e65 7327 5d0a 2020 2020 2020  V-lines'].      
+00019060: 2020 2020 2020 2362 726f 6164 3020 3d20        #broad0 = 
+00019070: 6c6f 6164 5f74 656d 706c 6174 6573 2866  load_templates(f
+00019080: 7768 6d3d 6272 6f61 645f 6677 686d 2c20  whm=broad_fwhm, 
+00019090: 6c69 6e65 5f63 6f6d 706c 6578 6573 3d46  line_complexes=F
+000190a0: 616c 7365 2c20 7374 6172 733d 4661 6c73  alse, stars=Fals
+000190b0: 652c 2066 756c 6c5f 6c69 6e65 5f6c 6973  e, full_line_lis
+000190c0: 743d 5b27 4261 6c6d 6572 2031 306b 4b20  t=['Balmer 10kK 
+000190d0: 2b20 4d67 4949 272c 2027 5153 4f2d 5556  + MgII', 'QSO-UV
+000190e0: 2d6c 696e 6573 275d 2c20 636f 6e74 696e  -lines'], contin
+000190f0: 7575 6d5f 6c69 7374 3d5b 5d2c 2066 7370  uum_list=[], fsp
+00019100: 735f 7465 6d70 6c61 7465 733d 4661 6c73  s_templates=Fals
+00019110: 652c 2061 6c66 5f74 656d 706c 6174 653d  e, alf_template=
+00019120: 4661 6c73 652c 206c 6f72 656e 747a 3d54  False, lorentz=T
+00019130: 7275 6529 0a20 2020 2020 2020 2065 6c73  rue).        els
+00019140: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+00019150: 756c 6c5f 6c69 6e65 5f6c 6973 7420 3d20  ull_line_list = 
+00019160: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
+00019170: 4d67 4949 2041 763d 302e 3527 5d0a 2020  MgII Av=0.5'].  
+00019180: 2020 2020 2020 2020 2020 2362 726f 6164            #broad
+00019190: 3020 3d20 6c6f 6164 5f74 656d 706c 6174  0 = load_templat
+000191a0: 6573 2866 7768 6d3d 6272 6f61 645f 6677  es(fwhm=broad_fw
+000191b0: 686d 2c20 6c69 6e65 5f63 6f6d 706c 6578  hm, line_complex
+000191c0: 6573 3d46 616c 7365 2c20 7374 6172 733d  es=False, stars=
+000191d0: 4661 6c73 652c 2066 756c 6c5f 6c69 6e65  False, full_line
+000191e0: 5f6c 6973 743d 5b27 4261 6c6d 6572 2031  _list=['Balmer 1
+000191f0: 306b 4b27 5d20 2b20 6272 6f61 645f 6c69  0kK'] + broad_li
+00019200: 6e65 732c 2063 6f6e 7469 6e75 756d 5f6c  nes, continuum_l
+00019210: 6973 743d 5b5d 2c20 6673 7073 5f74 656d  ist=[], fsps_tem
+00019220: 706c 6174 6573 3d46 616c 7365 2c20 616c  plates=False, al
+00019230: 665f 7465 6d70 6c61 7465 3d46 616c 7365  f_template=False
+00019240: 2c20 6c6f 7265 6e74 7a3d 5472 7565 290a  , lorentz=True).
+00019250: 0a20 2020 2020 2020 2069 6620 696e 636c  .        if incl
+00019260: 7564 655f 7265 6464 656e 6564 5f62 616c  ude_reddened_bal
+00019270: 6d65 725f 6c69 6e65 733a 0a20 2020 2020  mer_lines:.     
+00019280: 2020 2020 2020 206c 696e 655f 7761 7665         line_wave
+00019290: 6c65 6e67 7468 732c 206c 696e 655f 7261  lengths, line_ra
+000192a0: 7469 6f73 203d 2067 6574 5f6c 696e 655f  tios = get_line_
+000192b0: 7761 7665 6c65 6e67 7468 7328 290a 2020  wavelengths().  
+000192c0: 2020 2020 2020 2020 2020 6966 2027 4261            if 'Ba
+000192d0: 6c6d 6572 2031 306b 4b20 2b20 4d67 4949  lmer 10kK + MgII
+000192e0: 2041 763d 312e 3027 2069 6e20 6c69 6e65   Av=1.0' in line
+000192f0: 5f77 6176 656c 656e 6774 6873 3a0a 2020  _wavelengths:.  
+00019300: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+00019310: 6c6c 5f6c 696e 655f 6c69 7374 202b 3d20  ll_line_list += 
+00019320: 5b27 4261 6c6d 6572 2031 306b 4b20 2b20  ['Balmer 10kK + 
+00019330: 4d67 4949 275d 0a20 2020 2020 2020 2020  MgII'].         
+00019340: 2020 2020 2020 2066 756c 6c5f 6c69 6e65         full_line
+00019350: 5f6c 6973 7420 2b3d 205b 2742 616c 6d65  _list += ['Balme
+00019360: 7220 3130 6b4b 202b 204d 6749 4920 4176  r 10kK + MgII Av
+00019370: 3d31 2e30 275d 0a20 2020 2020 2020 2020  =1.0'].         
+00019380: 2020 2020 2020 2066 756c 6c5f 6c69 6e65         full_line
+00019390: 5f6c 6973 7420 2b3d 205b 2742 616c 6d65  _list += ['Balme
+000193a0: 7220 3130 6b4b 202b 204d 6749 4920 4176  r 10kK + MgII Av
+000193b0: 3d32 2e30 275d 0a0a 2020 2020 2020 2020  =2.0']..        
+000193c0: 6272 6f61 6430 203d 206c 6f61 645f 7465  broad0 = load_te
+000193d0: 6d70 6c61 7465 7328 6677 686d 3d62 726f  mplates(fwhm=bro
+000193e0: 6164 5f66 7768 6d2c 206c 696e 655f 636f  ad_fwhm, line_co
+000193f0: 6d70 6c65 7865 733d 4661 6c73 652c 2073  mplexes=False, s
+00019400: 7461 7273 3d46 616c 7365 2c20 6675 6c6c  tars=False, full
+00019410: 5f6c 696e 655f 6c69 7374 3d66 756c 6c5f  _line_list=full_
+00019420: 6c69 6e65 5f6c 6973 742c 2063 6f6e 7469  line_list, conti
+00019430: 6e75 756d 5f6c 6973 743d 5b5d 2c20 6673  nuum_list=[], fs
+00019440: 7073 5f74 656d 706c 6174 6573 3d46 616c  ps_templates=Fal
+00019450: 7365 2c20 616c 665f 7465 6d70 6c61 7465  se, alf_template
+00019460: 3d46 616c 7365 2c20 6c6f 7265 6e74 7a3d  =False, lorentz=
+00019470: 5472 7565 290a 0a20 2020 2020 2020 2066  True)..        f
+00019480: 6f72 206b 2069 6e20 6272 6f61 6430 3a0a  or k in broad0:.
+00019490: 2020 2020 2020 2020 2020 2020 7430 5b6b              t0[k
+000194a0: 5d20 3d20 6272 6f61 6430 5b6b 5d0a 0a20  ] = broad0[k].. 
+000194b0: 2020 2066 6f72 206b 2069 6e20 6272 6f61     for k in broa
+000194c0: 6431 3a0a 2020 2020 2020 2020 7431 5b6b  d1:.        t1[k
+000194d0: 5d20 3d20 6272 6f61 6431 5b6b 5d0a 0a20  ] = broad1[k].. 
+000194e0: 2020 2066 6f72 206b 2069 6e20 6e61 7272     for k in narr
+000194f0: 6f77 303a 0a20 2020 2020 2020 2074 305b  ow0:.        t0[
+00019500: 6b5d 203d 206e 6172 726f 7730 5b6b 5d0a  k] = narrow0[k].
+00019510: 0a20 2020 2066 6f72 206b 2069 6e20 6e61  .    for k in na
+00019520: 7272 6f77 313a 0a20 2020 2020 2020 2074  rrow1:.        t
+00019530: 315b 6b5d 203d 206e 6172 726f 7731 5b6b  1[k] = narrow1[k
+00019540: 5d0a 0a20 2020 2023 2046 6520 4949 0a20  ]..    # Fe II. 
+00019550: 2020 2069 6620 696e 636c 7564 655f 6665     if include_fe
+00019560: 6969 3a0a 2020 2020 2020 2020 6665 6969  ii:.        feii
+00019570: 5f77 6176 652c 2066 6569 695f 666c 7578  _wave, feii_flux
+00019580: 203d 206e 702e 6c6f 6164 7478 7428 6f73   = np.loadtxt(os
+00019590: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
+000195a0: 6669 6c65 5f5f 2920 2b20 272f 6461 7461  file__) + '/data
+000195b0: 2f74 656d 706c 6174 6573 2f46 6549 495f  /templates/FeII_
+000195c0: 5665 726f 6e43 6574 7479 3230 3034 2e74  VeronCetty2004.t
+000195d0: 7874 272c 2075 6e70 6163 6b3d 5472 7565  xt', unpack=True
+000195e0: 290a 0a20 2020 2020 2020 2023 2073 6d6f  )..        # smo
+000195f0: 6f74 6869 6e67 2c20 696e 2075 6e69 7473  othing, in units
+00019600: 206f 6620 696e 7075 7420 7665 6c6f 6369   of input veloci
+00019610: 7479 2072 6573 6f6c 7574 696f 6e0a 2020  ty resolution.  
+00019620: 2020 2020 2020 6665 6969 5f6b 6572 6e20        feii_kern 
+00019630: 3d20 6272 6f61 645f 6677 686d 2f32 2e33  = broad_fwhm/2.3
+00019640: 3534 382f 3735 2e0a 2020 2020 2020 2020  548/75..        
+00019650: 6665 6969 5f73 6d20 3d20 6e64 2e67 6175  feii_sm = nd.gau
+00019660: 7373 6961 6e5f 6669 6c74 6572 2866 6569  ssian_filter(fei
+00019670: 695f 666c 7578 2c20 6665 6969 5f6b 6572  i_flux, feii_ker
+00019680: 6e29 0a20 2020 2020 2020 2074 305b 2746  n).        t0['F
+00019690: 6549 492d 5643 3230 3034 275d 203d 2074  eII-VC2004'] = t
+000196a0: 315b 2746 6549 492d 5643 3230 3034 275d  1['FeII-VC2004']
+000196b0: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
+000196c0: 6174 6528 7761 7665 3d66 6569 695f 7761  ate(wave=feii_wa
+000196d0: 7665 2c20 666c 7578 3d66 6569 695f 736d  ve, flux=feii_sm
+000196e0: 2c20 6e61 6d65 3d27 4665 4949 2d56 4332  , name='FeII-VC2
+000196f0: 3030 3427 290a 0a20 2020 2023 204c 696e  004')..    # Lin
+00019700: 6561 7220 636f 6e74 696e 7561 0a20 2020  ear continua.   
+00019710: 2023 2063 6f6e 745f 7761 7665 203d 206e   # cont_wave = n
+00019720: 702e 6172 616e 6765 2834 3030 2c20 322e  p.arange(400, 2.
+00019730: 3565 3429 0a20 2020 2023 2066 6f72 2073  5e4).    # for s
+00019740: 6c6f 7065 2069 6e20 736c 6f70 6573 3a0a  lope in slopes:.
+00019750: 2020 2020 2320 2020 2020 6b65 7920 3d20      #     key = 
+00019760: 2773 6c6f 7065 207b 307d 272e 666f 726d  'slope {0}'.form
+00019770: 6174 2873 6c6f 7065 290a 2020 2020 2320  at(slope).    # 
+00019780: 2020 2020 7430 5b6b 6579 5d20 3d20 7431      t0[key] = t1
+00019790: 5b6b 6579 5d20 3d20 5370 6563 7472 756d  [key] = Spectrum
+000197a0: 5465 6d70 6c61 7465 2877 6176 653d 636f  Template(wave=co
+000197b0: 6e74 5f77 6176 652c 2066 6c75 783d 2863  nt_wave, flux=(c
+000197c0: 6f6e 745f 7761 7665 2f36 3536 332e 292a  ont_wave/6563.)*
+000197d0: 2a73 6c6f 7065 290a 0a20 2020 2069 6620  *slope)..    if 
+000197e0: 5273 706c 696e 6520 6973 206e 6f74 204e  Rspline is not N
+000197f0: 6f6e 653a 0a20 2020 2020 2020 2077 7370  one:.        wsp
+00019800: 6c69 6e65 203d 206e 702e 6172 616e 6765  line = np.arange
+00019810: 2834 3230 302c 2032 2e35 6534 2c20 3130  (4200, 2.5e4, 10
+00019820: 290a 2020 2020 2020 2020 6466 5f73 706c  ).        df_spl
+00019830: 203d 206c 6f67 5f7a 6772 6964 287a 723d   = log_zgrid(zr=
+00019840: 5b77 7370 6c69 6e65 5b30 5d2c 2077 7370  [wspline[0], wsp
+00019850: 6c69 6e65 5b2d 315d 5d2c 2064 7a3d 312e  line[-1]], dz=1.
+00019860: 2f52 7370 6c69 6e65 290a 2020 2020 2020  /Rspline).      
+00019870: 2020 6273 706c 696e 6573 203d 2062 7370    bsplines = bsp
+00019880: 6c69 6e65 5f74 656d 706c 6174 6573 2877  line_templates(w
+00019890: 7370 6c69 6e65 2c20 6466 3d6c 656e 2864  spline, df=len(d
+000198a0: 665f 7370 6c29 2b32 2c20 6c6f 673d 5472  f_spl)+2, log=Tr
+000198b0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+000198c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000198d0: 2020 2020 2020 2020 2063 6c69 703d 302e           clip=0.
+000198e0: 3030 3031 290a 0a20 2020 2020 2020 2066  0001)..        f
+000198f0: 6f72 206b 6579 2069 6e20 6273 706c 696e  or key in bsplin
+00019900: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00019910: 7430 5b6b 6579 5d20 3d20 7431 5b6b 6579  t0[key] = t1[key
+00019920: 5d20 3d20 6273 706c 696e 6573 5b6b 6579  ] = bsplines[key
+00019930: 5d0a 0a20 2020 2065 6c69 6620 6e73 706c  ]..    elif nspl
+00019940: 696e 6520 3e20 303a 0a20 2020 2020 2020  ine > 0:.       
+00019950: 2023 2053 706c 696e 6520 636f 6e74 696e   # Spline contin
+00019960: 7561 0a20 2020 2020 2020 2063 6f6e 745f  ua.        cont_
+00019970: 7761 7665 203d 206e 702e 6172 616e 6765  wave = np.arange
+00019980: 2835 3030 302c 2032 2e34 6534 290a 2020  (5000, 2.4e4).  
+00019990: 2020 2020 2020 6273 706c 696e 6573 203d        bsplines =
+000199a0: 2062 7370 6c69 6e65 5f74 656d 706c 6174   bspline_templat
+000199b0: 6573 2863 6f6e 745f 7761 7665 2c20 6466  es(cont_wave, df
+000199c0: 3d6e 7370 6c69 6e65 2c20 6c6f 673d 5472  =nspline, log=Tr
+000199d0: 7565 290a 2020 2020 2020 2020 666f 7220  ue).        for 
+000199e0: 6b65 7920 696e 2062 7370 6c69 6e65 733a  key in bsplines:
+000199f0: 0a20 2020 2020 2020 2020 2020 2074 305b  .            t0[
+00019a00: 6b65 795d 203d 2074 315b 6b65 795d 203d  key] = t1[key] =
+00019a10: 2062 7370 6c69 6e65 735b 6b65 795d 0a0a   bsplines[key]..
+00019a20: 2020 2020 656c 6966 2062 6574 6173 2069      elif betas i
+00019a30: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00019a40: 2020 2020 6274 656d 7020 3d20 6c6f 6164      btemp = load
+00019a50: 5f62 6574 615f 7465 6d70 6c61 7465 7328  _beta_templates(
+00019a60: 7761 7665 3d6e 702e 6172 616e 6765 2834  wave=np.arange(4
+00019a70: 3030 2c20 322e 3565 3429 2c20 6265 7461  00, 2.5e4), beta
+00019a80: 733d 6265 7461 7329 0a20 2020 2020 2020  s=betas).       
+00019a90: 2066 6f72 206b 6579 2069 6e20 6274 656d   for key in btem
+00019aa0: 703a 0a20 2020 2020 2020 2020 2020 2074  p:.            t
+00019ab0: 305b 6b65 795d 203d 2074 315b 6b65 795d  0[key] = t1[key]
+00019ac0: 203d 2062 7465 6d70 5b6b 6579 5d0a 0a20   = btemp[key].. 
+00019ad0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00019ae0: 2023 204f 6273 6572 7665 6420 6672 616d   # Observed fram
+00019af0: 6520 7374 6570 730a 2020 2020 2020 2020  e steps.        
+00019b00: 6f6e 6564 5220 3d20 2d6e 7370 6c69 6e65  onedR = -nspline
+00019b10: 0a20 2020 2020 2020 2077 6c69 6d20 3d20  .        wlim = 
+00019b20: 5b35 3030 302c 2031 3830 3030 2e30 5d0a  [5000, 18000.0].
+00019b30: 2020 2020 2020 2020 6269 6e5f 7374 6570          bin_step
+00019b40: 732c 2073 7465 705f 7465 6d70 6c20 3d20  s, step_templ = 
+00019b50: 7374 6570 5f74 656d 706c 6174 6573 2877  step_templates(w
+00019b60: 6c69 6d3d 776c 696d 2c20 523d 6f6e 6564  lim=wlim, R=oned
+00019b70: 522c 0a20 2020 2020 2020 2020 2020 2020  R,.             
+00019b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ba0: 2020 726f 756e 643d 3130 290a 2020 2020    round=10).    
+00019bb0: 2020 2020 666f 7220 6b65 7920 696e 2073      for key in s
+00019bc0: 7465 705f 7465 6d70 6c3a 0a20 2020 2020  tep_templ:.     
+00019bd0: 2020 2020 2020 2074 305b 6b65 795d 203d         t0[key] =
+00019be0: 2074 315b 6b65 795d 203d 2073 7465 705f   t1[key] = step_
+00019bf0: 7465 6d70 6c5b 6b65 795d 0a0a 2020 2020  templ[key]..    
+00019c00: 2320 7430 5b27 626c 7565 275d 203d 2074  # t0['blue'] = t
+00019c10: 315b 2762 6c75 6527 5d20 3d20 5370 6563  1['blue'] = Spec
+00019c20: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
+00019c30: 653d 636f 6e74 5f77 6176 652c 2066 6c75  e=cont_wave, flu
+00019c40: 783d 2863 6f6e 745f 7761 7665 2f36 3536  x=(cont_wave/656
+00019c50: 332e 292a 2a2d 322e 3829 0a20 2020 2023  3.)**-2.8).    #
+00019c60: 2074 305b 276d 6964 275d 203d 2074 315b   t0['mid'] = t1[
+00019c70: 276d 6964 275d 203d 2053 7065 6374 7275  'mid'] = Spectru
+00019c80: 6d54 656d 706c 6174 6528 7761 7665 3d63  mTemplate(wave=c
+00019c90: 6f6e 745f 7761 7665 2c20 666c 7578 3d28  ont_wave, flux=(
+00019ca0: 636f 6e74 5f77 6176 652f 3635 3633 2e29  cont_wave/6563.)
+00019cb0: 2a2a 3029 0a20 2020 2023 2074 305b 2772  **0).    # t0['r
+00019cc0: 6564 275d 203d 2074 315b 276d 6964 275d  ed'] = t1['mid']
+00019cd0: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
+00019ce0: 6174 6528 7761 7665 3d63 6f6e 745f 7761  ate(wave=cont_wa
+00019cf0: 7665 2c20 666c 7578 3d28 636f 6e74 5f77  ve, flux=(cont_w
+00019d00: 6176 652f 3635 3633 2e29 2a2a 322e 3829  ave/6563.)**2.8)
+00019d10: 0a0a 2020 2020 7265 7475 726e 2074 302c  ..    return t0,
+00019d20: 2074 310a 0a0a 5048 4f45 4e49 585f 4c4f   t1...PHOENIX_LO
+00019d30: 4747 5f46 554c 4c20 3d20 5b33 2e30 2c20  GG_FULL = [3.0, 
+00019d40: 332e 352c 2034 2e30 2c20 342e 352c 2035  3.5, 4.0, 4.5, 5
+00019d50: 2e30 2c20 352e 355d 0a50 484f 454e 4958  .0, 5.5].PHOENIX
+00019d60: 5f4c 4f47 4720 3d20 5b34 2e30 2c20 342e  _LOGG = [4.0, 4.
+00019d70: 352c 2035 2e30 2c20 352e 355d 0a0a 5048  5, 5.0, 5.5]..PH
+00019d80: 4f45 4e49 585f 5445 4646 5f46 554c 4c20  OENIX_TEFF_FULL 
+00019d90: 3d20 5b34 3030 2e30 2c20 3432 302e 302c  = [400.0, 420.0,
+00019da0: 2034 3530 2e30 2c20 3530 302e 302c 2035   450.0, 500.0, 5
+00019db0: 3530 2e30 2c20 3630 302e 302c 2036 3530  50.0, 600.0, 650
+00019dc0: 2e30 2c20 3730 302e 302c 2037 3530 2e30  .0, 700.0, 750.0
+00019dd0: 2c20 3830 302e 302c 2038 3530 2e30 2c20  , 800.0, 850.0, 
+00019de0: 3930 302e 302c 2039 3530 2e30 2c20 3130  900.0, 950.0, 10
+00019df0: 3030 2e30 2c20 3130 3530 2e30 2c20 3131  00.0, 1050.0, 11
+00019e00: 3030 2e30 2c20 3131 3530 2e30 2c20 3132  00.0, 1150.0, 12
+00019e10: 3030 2e30 2c20 3132 3530 2e30 2c20 3133  00.0, 1250.0, 13
+00019e20: 3030 2e30 2c20 3133 3530 2e30 2c20 3134  00.0, 1350.0, 14
+00019e30: 3030 2e30 2c20 3134 3530 2e30 2c20 3135  00.0, 1450.0, 15
+00019e40: 3030 2e30 2c20 3135 3530 2e30 2c20 3136  00.0, 1550.0, 16
+00019e50: 3030 2e30 2c20 3136 3530 2e30 2c20 3137  00.0, 1650.0, 17
+00019e60: 3030 2e30 2c20 3137 3530 2e30 2c20 3138  00.0, 1750.0, 18
+00019e70: 3030 2e30 2c20 3138 3530 2e30 2c20 3139  00.0, 1850.0, 19
+00019e80: 3030 2e30 2c20 3139 3530 2e30 2c20 3230  00.0, 1950.0, 20
+00019e90: 3030 2e30 2c20 3231 3030 2e30 2c20 3232  00.0, 2100.0, 22
+00019ea0: 3030 2e30 2c20 3233 3030 2e30 2c20 3234  00.0, 2300.0, 24
+00019eb0: 3030 2e30 2c20 3235 3030 2e30 2c20 3236  00.0, 2500.0, 26
+00019ec0: 3030 2e30 2c20 3237 3030 2e30 2c20 3238  00.0, 2700.0, 28
+00019ed0: 3030 2e30 2c20 3239 3030 2e30 2c20 3330  00.0, 2900.0, 30
+00019ee0: 3030 2e30 2c20 3331 3030 2e30 2c20 3332  00.0, 3100.0, 32
+00019ef0: 3030 2e30 2c20 3333 3030 2e30 2c20 3334  00.0, 3300.0, 34
+00019f00: 3030 2e30 2c20 3335 3030 2e30 2c20 3336  00.0, 3500.0, 36
+00019f10: 3030 2e30 2c20 3337 3030 2e30 2c20 3338  00.0, 3700.0, 38
+00019f20: 3030 2e30 2c20 3339 3030 2e30 2c20 3430  00.0, 3900.0, 40
+00019f30: 3030 2e30 2c20 3431 3030 2e30 2c20 3432  00.0, 4100.0, 42
+00019f40: 3030 2e30 2c20 3433 3030 2e30 2c20 3434  00.0, 4300.0, 44
+00019f50: 3030 2e30 2c20 3435 3030 2e30 2c20 3436  00.0, 4500.0, 46
+00019f60: 3030 2e30 2c20 3437 3030 2e30 2c20 3438  00.0, 4700.0, 48
+00019f70: 3030 2e30 2c20 3439 3030 2e30 2c20 3530  00.0, 4900.0, 50
+00019f80: 3030 2e30 5d0a 0a50 484f 454e 4958 5f54  00.0]..PHOENIX_T
+00019f90: 4546 4620 3d20 5b34 3030 2e2c 2020 3432  EFF = [400.,  42
+00019fa0: 302e 2c20 3435 302e 2c20 3530 302e 2c20  0., 450., 500., 
+00019fb0: 2035 3530 2e2c 2036 3030 2e2c 2020 3635   550., 600.,  65
+00019fc0: 302e 2c20 3730 302e 2c20 2037 3530 2e2c  0., 700.,  750.,
+00019fd0: 0a20 2020 2020 2020 3830 302e 2c20 2038  .       800.,  8
+00019fe0: 3530 2e2c 2039 3030 2e2c 2039 3530 2e2c  50., 900., 950.,
+00019ff0: 2031 3030 302e 2c20 3130 3530 2e2c 2031   1000., 1050., 1
+0001a000: 3130 302e 2c20 3131 3530 2e2c 2031 3230  100., 1150., 120
+0001a010: 302e 2c0a 2020 2020 2020 2031 3330 302e  0.,.       1300.
+0001a020: 2c20 3134 3030 2e2c 2031 3530 302e 2c20  , 1400., 1500., 
+0001a030: 3136 3030 2e2c 2031 3730 302e 2c20 3138  1600., 1700., 18
+0001a040: 3030 2e2c 2031 3930 302e 2c20 3230 3030  00., 1900., 2000
+0001a050: 2e2c 2032 3130 302e 2c0a 2020 2020 2020  ., 2100.,.      
+0001a060: 2032 3230 302e 2c20 3233 3030 2e2c 2032   2200., 2300., 2
+0001a070: 3430 302e 2c20 3235 3030 2e2c 2032 3630  400., 2500., 260
+0001a080: 302e 2c20 3237 3030 2e2c 2032 3830 302e  0., 2700., 2800.
+0001a090: 2c20 3239 3030 2e2c 2033 3030 302e 2c0a  , 2900., 3000.,.
+0001a0a0: 2020 2020 2020 2033 3130 302e 2c20 3332         3100., 32
+0001a0b0: 3030 2e2c 2033 3330 302e 2c20 3334 3030  00., 3300., 3400
+0001a0c0: 2e2c 2033 3530 302e 2c20 3336 3030 2e2c  ., 3500., 3600.,
+0001a0d0: 2033 3730 302e 2c20 3338 3030 2e2c 2033   3700., 3800., 3
+0001a0e0: 3930 302e 2c20 3430 3030 2e2c 0a20 2020  900., 4000.,.   
+0001a0f0: 2020 2020 3432 3030 2e2c 2034 3430 302e      4200., 4400.
+0001a100: 2c20 3436 3030 2e2c 2034 3830 302e 2c20  , 4600., 4800., 
+0001a110: 3530 3030 2e2c 2035 3530 302e 2c20 3535  5000., 5500., 55
+0001a120: 3030 2c20 3630 3030 2e2c 2036 3530 302e  00, 6000., 6500.
+0001a130: 2c20 3730 3030 2e5d 0a0a 5048 4f45 4e49  , 7000.]..PHOENI
+0001a140: 585f 5a4d 4554 5f46 554c 4c20 3d20 5b2d  X_ZMET_FULL = [-
+0001a150: 322e 352c 202d 322e 302c 202d 312e 352c  2.5, -2.0, -1.5,
+0001a160: 202d 312e 302c 202d 302e 352c 202d 302e   -1.0, -0.5, -0.
+0001a170: 2c20 302e 355d 0a50 484f 454e 4958 5f5a  , 0.5].PHOENIX_Z
+0001a180: 4d45 5420 3d20 5b2d 312e 302c 202d 302e  MET = [-1.0, -0.
+0001a190: 352c 202d 302e 5d0a 0a0a 6465 6620 6c6f  5, -0.]...def lo
+0001a1a0: 6164 5f70 686f 656e 6978 5f73 7461 7273  ad_phoenix_stars
+0001a1b0: 286c 6f67 675f 6c69 7374 3d50 484f 454e  (logg_list=PHOEN
+0001a1c0: 4958 5f4c 4f47 472c 2074 6566 665f 6c69  IX_LOGG, teff_li
+0001a1d0: 7374 3d50 484f 454e 4958 5f54 4546 462c  st=PHOENIX_TEFF,
+0001a1e0: 207a 6d65 745f 6c69 7374 3d50 484f 454e   zmet_list=PHOEN
+0001a1f0: 4958 5f5a 4d45 542c 2061 6464 5f63 6172  IX_ZMET, add_car
+0001a200: 626f 6e5f 7374 6172 3d54 7275 652c 2066  bon_star=True, f
+0001a210: 696c 653d 2762 742d 7365 7474 6c5f 7434  ile='bt-settl_t4
+0001a220: 3030 2d37 3030 305f 6734 2e35 2e66 6974  00-7000_g4.5.fit
+0001a230: 7327 293a 0a20 2020 2022 2222 0a20 2020  s'):.    """.   
+0001a240: 204c 6f61 6420 5068 6f65 6e69 7820 7374   Load Phoenix st
+0001a250: 656c 6c61 7220 7465 6d70 6c61 7465 730a  ellar templates.
+0001a260: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
+0001a270: 2063 6f6c 6c65 6374 696f 6e73 2069 6d70   collections imp
+0001a280: 6f72 7420 4f72 6465 7265 6444 6963 740a  ort OrderedDict.
+0001a290: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001a2a0: 2066 726f 6d20 7572 6c6c 6962 2e72 6571   from urllib.req
+0001a2b0: 7565 7374 2069 6d70 6f72 7420 7572 6c72  uest import urlr
+0001a2c0: 6574 7269 6576 650a 2020 2020 6578 6365  etrieve.    exce
+0001a2d0: 7074 3a0a 2020 2020 2020 2020 6672 6f6d  pt:.        from
+0001a2e0: 2075 726c 6c69 6220 696d 706f 7274 2075   urllib import u
+0001a2f0: 726c 7265 7472 6965 7665 0a0a 2020 2020  rlretrieve..    
+0001a300: 2320 6669 6c65 3d27 6274 2d73 6574 746c  # file='bt-settl
+0001a310: 5f74 3430 302d 3530 3030 5f67 342e 352e  _t400-5000_g4.5.
+0001a320: 6669 7473 270a 2020 2020 2320 6669 6c65  fits'.    # file
+0001a330: 3d27 6274 2d73 6574 746c 5f74 3430 302d  ='bt-settl_t400-
+0001a340: 3335 3030 5f7a 302e 302e 6669 7473 270a  3500_z0.0.fits'.
+0001a350: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+0001a360: 2020 6864 7520 3d20 7079 6669 7473 2e6f    hdu = pyfits.o
+0001a370: 7065 6e28 6f73 2e70 6174 682e 6a6f 696e  pen(os.path.join
+0001a380: 2847 5249 5a4c 495f 5041 5448 2c20 2774  (GRIZLI_PATH, 't
+0001a390: 656d 706c 6174 6573 2f73 7461 7273 2f27  emplates/stars/'
+0001a3a0: 2c20 6669 6c65 2929 0a20 2020 2065 7863  , file)).    exc
+0001a3b0: 6570 743a 0a20 2020 2020 2020 2023 7572  ept:.        #ur
+0001a3c0: 6c20 3d20 2768 7474 7073 3a2f 2f73 332e  l = 'https://s3.
+0001a3d0: 616d 617a 6f6e 6177 732e 636f 6d2f 6772  amazonaws.com/gr
+0001a3e0: 697a 6c69 2f43 4f4e 4627 0a20 2020 2020  izli/CONF'.     
+0001a3f0: 2020 2023 7572 6c20 3d20 2768 7474 7073     #url = 'https
+0001a400: 3a2f 2f65 7264 612e 6b75 2e64 6b2f 7667  ://erda.ku.dk/vg
+0001a410: 7269 642f 4761 6272 6965 6c25 3230 4272  rid/Gabriel%20Br
+0001a420: 616d 6d65 722f 434f 4e46 270a 2020 2020  ammer/CONF'.    
+0001a430: 2020 2020 7572 6c20 3d20 2827 6874 7470      url = ('http
+0001a440: 733a 2f2f 7261 772e 6769 7468 7562 7573  s://raw.githubus
+0001a450: 6572 636f 6e74 656e 742e 636f 6d2f 6762  ercontent.com/gb
+0001a460: 7261 6d6d 6572 2f27 202b 0a20 2020 2020  rammer/' +.     
+0001a470: 2020 2020 2020 2020 2020 2767 7269 7a6c            'grizl
+0001a480: 692d 636f 6e66 6967 2f6d 6173 7465 7227  i-config/master'
+0001a490: 290a 0a20 2020 2020 2020 2070 7269 6e74  )..        print
+0001a4a0: 2827 4665 7463 6820 7b30 7d2f 7b31 7d27  ('Fetch {0}/{1}'
+0001a4b0: 2e66 6f72 6d61 7428 7572 6c2c 2066 696c  .format(url, fil
+0001a4c0: 6529 290a 0a20 2020 2020 2020 2023 6f73  e))..        #os
+0001a4d0: 2e73 7973 7465 6d28 2777 6765 7420 2d4f  .system('wget -O
+0001a4e0: 202f 746d 702f 7b31 7d20 7b30 7d2f 7b31   /tmp/{1} {0}/{1
+0001a4f0: 7d27 2e66 6f72 6d61 7428 7572 6c2c 2066  }'.format(url, f
+0001a500: 696c 6529 290a 2020 2020 2020 2020 7265  ile)).        re
+0001a510: 7320 3d20 7572 6c72 6574 7269 6576 6528  s = urlretrieve(
+0001a520: 277b 307d 2f7b 317d 272e 666f 726d 6174  '{0}/{1}'.format
+0001a530: 2875 726c 2c20 6669 6c65 292c 0a20 2020  (url, file),.   
+0001a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a550: 2020 2020 2020 2066 696c 656e 616d 653d         filename=
+0001a560: 6f73 2e70 6174 682e 6a6f 696e 2827 2f74  os.path.join('/t
+0001a570: 6d70 272c 2066 696c 6529 290a 0a20 2020  mp', file))..   
+0001a580: 2020 2020 2068 6475 203d 2070 7966 6974       hdu = pyfit
+0001a590: 732e 6f70 656e 286f 732e 7061 7468 2e6a  s.open(os.path.j
+0001a5a0: 6f69 6e28 272f 746d 702f 272c 2066 696c  oin('/tmp/', fil
+0001a5b0: 6529 290a 0a20 2020 2074 6162 203d 2047  e))..    tab = G
+0001a5c0: 5461 626c 652e 6772 6561 6428 6864 755b  Table.gread(hdu[
+0001a5d0: 315d 290a 2020 2020 6864 752e 636c 6f73  1]).    hdu.clos
+0001a5e0: 6528 290a 2020 2020 0a20 2020 2074 7374  e().    .    tst
+0001a5f0: 6172 7320 3d20 4f72 6465 7265 6444 6963  ars = OrderedDic
+0001a600: 7428 290a 2020 2020 4e20 3d20 7461 625b  t().    N = tab[
+0001a610: 2766 6c75 7827 5d2e 7368 6170 655b 315d  'flux'].shape[1]
+0001a620: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+0001a630: 6e67 6528 4e29 3a0a 2020 2020 2020 2020  nge(N):.        
+0001a640: 7465 6666 203d 2074 6162 2e6d 6574 615b  teff = tab.meta[
+0001a650: 2754 4546 467b 303a 3033 647d 272e 666f  'TEFF{0:03d}'.fo
+0001a660: 726d 6174 2869 295d 0a20 2020 2020 2020  rmat(i)].       
+0001a670: 206c 6f67 6720 3d20 7461 622e 6d65 7461   logg = tab.meta
+0001a680: 5b27 4c4f 4747 7b30 3a30 3364 7d27 2e66  ['LOGG{0:03d}'.f
+0001a690: 6f72 6d61 7428 6929 5d0a 2020 2020 2020  ormat(i)].      
+0001a6a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001a6b0: 2020 206d 6574 203d 2074 6162 2e6d 6574     met = tab.met
+0001a6c0: 615b 275a 4d45 547b 303a 3033 647d 272e  a['ZMET{0:03d}'.
+0001a6d0: 666f 726d 6174 2869 295d 0a20 2020 2020  format(i)].     
+0001a6e0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+0001a6f0: 2020 2020 2020 206d 6574 203d 2030 2e0a         met = 0..
+0001a700: 0a20 2020 2020 2020 2069 6620 286c 6f67  .        if (log
+0001a710: 6720 6e6f 7420 696e 206c 6f67 675f 6c69  g not in logg_li
+0001a720: 7374 2920 7c20 2874 6566 6620 6e6f 7420  st) | (teff not 
+0001a730: 696e 2074 6566 665f 6c69 7374 2920 7c20  in teff_list) | 
+0001a740: 286d 6574 206e 6f74 2069 6e20 7a6d 6574  (met not in zmet
+0001a750: 5f6c 6973 7429 3a0a 2020 2020 2020 2020  _list):.        
+0001a760: 2020 2020 2370 7269 6e74 2827 536b 6970      #print('Skip
+0001a770: 207b 307d 207b 317d 272e 666f 726d 6174   {0} {1}'.format
+0001a780: 286c 6f67 672c 2074 6566 6629 290a 2020  (logg, teff)).  
+0001a790: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0001a7a0: 7565 0a0a 2020 2020 2020 2020 6c61 6265  ue..        labe
+0001a7b0: 6c20 3d20 2762 742d 7365 7474 6c5f 747b  l = 'bt-settl_t{
+0001a7c0: 303a 3035 2e30 667d 5f67 7b31 3a33 2e31  0:05.0f}_g{1:3.1
+0001a7d0: 667d 5f6d 7b32 3a2e 3166 7d27 2e66 6f72  f}_m{2:.1f}'.for
+0001a7e0: 6d61 7428 7465 6666 2c20 6c6f 6767 2c20  mat(teff, logg, 
+0001a7f0: 6d65 7429 0a0a 2020 2020 2020 2020 7473  met)..        ts
+0001a800: 7461 7273 5b6c 6162 656c 5d20 3d20 5370  tars[label] = Sp
+0001a810: 6563 7472 756d 5465 6d70 6c61 7465 2877  ectrumTemplate(w
+0001a820: 6176 653d 7461 625b 2777 6176 6527 5d2c  ave=tab['wave'],
+0001a830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a850: 2020 2020 2020 2020 2020 666c 7578 3d74            flux=t
+0001a860: 6162 5b27 666c 7578 275d 5b3a 2c20 695d  ab['flux'][:, i]
+0001a870: 2c20 6e61 6d65 3d6c 6162 656c 290a 0a20  , name=label).. 
+0001a880: 2020 2069 6620 6164 645f 6361 7262 6f6e     if add_carbon
+0001a890: 5f73 7461 723a 0a20 2020 2020 2020 2063  _star:.        c
+0001a8a0: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
+0001a8b0: 6f69 6e28 4752 495a 4c49 5f50 4154 482c  oin(GRIZLI_PATH,
+0001a8c0: 2027 7465 6d70 6c61 7465 732f 7374 6172   'templates/star
+0001a8d0: 732f 6361 7262 6f6e 5f73 7461 722e 7478  s/carbon_star.tx
+0001a8e0: 7427 290a 2020 2020 2020 2020 7370 203d  t').        sp =
+0001a8f0: 2072 6561 645f 6361 7461 6c6f 6728 6366   read_catalog(cf
+0001a900: 696c 6529 0a20 2020 2020 2020 2069 6620  ile).        if 
+0001a910: 6164 645f 6361 7262 6f6e 5f73 7461 7220  add_carbon_star 
+0001a920: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+0001a930: 2069 6d70 6f72 7420 7363 6970 792e 6e64   import scipy.nd
+0001a940: 696d 6167 6520 6173 206e 640a 2020 2020  image as nd.    
+0001a950: 2020 2020 2020 2020 6366 6c75 7820 3d20          cflux = 
+0001a960: 6e64 2e67 6175 7373 6961 6e5f 6669 6c74  nd.gaussian_filt
+0001a970: 6572 2873 705b 2766 6c75 7827 5d2c 2061  er(sp['flux'], a
+0001a980: 6464 5f63 6172 626f 6e5f 7374 6172 290a  dd_carbon_star).
+0001a990: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001a9a0: 2020 2020 2020 2020 2020 6366 6c75 7820            cflux 
+0001a9b0: 3d20 7370 5b27 666c 7578 275d 0a0a 2020  = sp['flux']..  
+0001a9c0: 2020 2020 2020 7473 7461 7273 5b27 6274        tstars['bt
+0001a9d0: 2d73 6574 746c 5f74 3035 3030 305f 6730  -settl_t05000_g0
+0001a9e0: 2e30 5f6d 302e 3027 5d20 3d20 5370 6563  .0_m0.0'] = Spec
+0001a9f0: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
+0001aa00: 653d 7370 5b27 7761 7665 275d 2c20 666c  e=sp['wave'], fl
+0001aa10: 7578 3d63 666c 7578 2c20 6e61 6d65 3d27  ux=cflux, name='
+0001aa20: 6361 7262 6f6e 2d6c 616e 636f 6e32 3030  carbon-lancon200
+0001aa30: 3227 290a 0a20 2020 2072 6574 7572 6e20  2')..    return 
+0001aa40: 7473 7461 7273 0a0a 0a64 6566 206c 6f61  tstars...def loa
+0001aa50: 645f 7364 7373 5f70 6361 5f74 656d 706c  d_sdss_pca_templ
+0001aa60: 6174 6573 2866 696c 653d 2773 7045 6967  ates(file='spEig
+0001aa70: 656e 5153 4f2d 3535 3733 322e 6669 7473  enQSO-55732.fits
+0001aa80: 272c 2073 6d6f 6f74 683d 3330 3030 293a  ', smooth=3000):
+0001aa90: 0a20 2020 2022 2222 0a20 2020 204c 6f61  .    """.    Loa
+0001aaa0: 6420 5344 5353 2065 6967 656e 2074 656d  d SDSS eigen tem
+0001aab0: 706c 6174 6573 0a20 2020 2022 2222 0a20  plates.    """. 
+0001aac0: 2020 2066 726f 6d20 636f 6c6c 6563 7469     from collecti
+0001aad0: 6f6e 7320 696d 706f 7274 204f 7264 6572  ons import Order
+0001aae0: 6564 4469 6374 0a20 2020 2069 6d70 6f72  edDict.    impor
+0001aaf0: 7420 7363 6970 792e 6e64 696d 6167 6520  t scipy.ndimage 
+0001ab00: 6173 206e 640a 0a20 2020 2069 6d20 3d20  as nd..    im = 
+0001ab10: 7079 6669 7473 2e6f 7065 6e28 6f73 2e70  pyfits.open(os.p
+0001ab20: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
+0001ab30: 5041 5448 2c20 2774 656d 706c 6174 6573  PATH, 'templates
+0001ab40: 272c 2066 696c 6529 290a 2020 2020 6820  ', file)).    h 
+0001ab50: 3d20 696d 5b30 5d2e 6865 6164 6572 0a20  = im[0].header. 
+0001ab60: 2020 206c 6f67 5f77 6176 6520 3d20 6e70     log_wave = np
+0001ab70: 2e61 7261 6e67 6528 685b 274e 4158 4953  .arange(h['NAXIS
+0001ab80: 3127 5d29 2a68 5b27 434f 4546 4631 275d  1'])*h['COEFF1']
+0001ab90: 2b68 5b27 434f 4546 4630 275d 0a20 2020  +h['COEFF0'].   
+0001aba0: 2077 6176 6520 3d20 3130 2a2a 6c6f 675f   wave = 10**log_
+0001abb0: 7761 7665 0a0a 2020 2020 6e61 6d65 203d  wave..    name =
+0001abc0: 2066 696c 652e 7370 6c69 7428 272e 6669   file.split('.fi
+0001abd0: 7473 2729 5b30 5d0a 0a20 2020 2069 6620  ts')[0]..    if 
+0001abe0: 736d 6f6f 7468 203e 2030 3a0a 2020 2020  smooth > 0:.    
+0001abf0: 2020 2020 6476 5f69 6e20 3d20 685b 2743      dv_in = h['C
+0001ac00: 4f45 4646 3127 5d2a 332e 6535 0a20 2020  OEFF1']*3.e5.   
+0001ac10: 2020 2020 206e 203d 2073 6d6f 6f74 6820       n = smooth 
+0001ac20: 2f20 6476 5f69 6e0a 2020 2020 2020 2020  / dv_in.        
+0001ac30: 6461 7461 203d 206e 642e 6761 7573 7369  data = nd.gaussi
+0001ac40: 616e 5f66 696c 7465 7231 6428 696d 5b30  an_filter1d(im[0
+0001ac50: 5d2e 6461 7461 2c20 6e2c 2061 7869 733d  ].data, n, axis=
+0001ac60: 3129 2e61 7374 7970 6528 6e70 2e66 6c6f  1).astype(np.flo
+0001ac70: 6174 3634 290a 2020 2020 2020 2020 736b  at64).        sk
+0001ac80: 6970 203d 2069 6e74 286e 2f32 2e35 290a  ip = int(n/2.5).
+0001ac90: 2020 2020 2020 2020 7761 7665 203d 2077          wave = w
+0001aca0: 6176 655b 3a3a 736b 6970 5d0a 2020 2020  ave[::skip].    
+0001acb0: 2020 2020 6461 7461 203d 2064 6174 615b      data = data[
+0001acc0: 3a2c 203a 3a73 6b69 705d 0a20 2020 2065  :, ::skip].    e
+0001acd0: 6c73 653a 0a20 2020 2020 2020 2064 6174  lse:.        dat
+0001ace0: 6120 3d20 696d 5b30 5d2e 6461 7461 2e61  a = im[0].data.a
+0001acf0: 7374 7970 6528 6e70 2e66 6c6f 6174 3634  stype(np.float64
+0001ad00: 290a 0a20 2020 204e 203d 2068 5b27 4e41  )..    N = h['NA
+0001ad10: 5849 5332 275d 0a20 2020 2074 656d 705f  XIS2'].    temp_
+0001ad20: 6c69 7374 203d 204f 7264 6572 6564 4469  list = OrderedDi
+0001ad30: 6374 2829 0a20 2020 2066 6f72 2069 2069  ct().    for i i
+0001ad40: 6e20 7261 6e67 6528 4e29 3a0a 2020 2020  n range(N):.    
+0001ad50: 2020 2020 7465 6d70 5f6c 6973 745b 277b      temp_list['{
+0001ad60: 307d 207b 317d 272e 666f 726d 6174 286e  0} {1}'.format(n
+0001ad70: 616d 652c 2069 2b31 295d 203d 2053 7065  ame, i+1)] = Spe
+0001ad80: 6374 7275 6d54 656d 706c 6174 6528 7761  ctrumTemplate(wa
+0001ad90: 7665 3d77 6176 652c 2066 6c75 783d 6461  ve=wave, flux=da
+0001ada0: 7461 5b69 2c20 3a5d 290a 2020 2020 0a20  ta[i, :]).    . 
+0001adb0: 2020 2069 6d2e 636c 6f73 6528 290a 2020     im.close().  
+0001adc0: 2020 0a20 2020 2072 6574 7572 6e20 7465    .    return te
+0001add0: 6d70 5f6c 6973 740a 0a0a 6465 6620 6368  mp_list...def ch
+0001ade0: 6562 5f74 656d 706c 6174 6573 2877 6176  eb_templates(wav
+0001adf0: 652c 206f 7264 6572 3d36 2c20 6765 745f  e, order=6, get_
+0001ae00: 6d61 7472 6978 3d46 616c 7365 2c20 6c6f  matrix=False, lo
+0001ae10: 673d 4661 6c73 652c 2063 6c69 703d 312e  g=False, clip=1.
+0001ae20: 652d 342c 206d 696e 6d61 783d 4e6f 6e65  e-4, minmax=None
+0001ae30: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+0001ae40: 6865 6279 7368 6576 2070 6f6c 796e 6f6d  hebyshev polynom
+0001ae50: 6961 6c20 6261 7369 7320 6675 6e63 7469  ial basis functi
+0001ae60: 6f6e 730a 2020 2020 2222 220a 2020 2020  ons.    """.    
+0001ae70: 6672 6f6d 206e 756d 7079 2e70 6f6c 796e  from numpy.polyn
+0001ae80: 6f6d 6961 6c2e 6368 6562 7973 6865 7620  omial.chebyshev 
+0001ae90: 696d 706f 7274 2063 6865 6276 616c 2c20  import chebval, 
+0001aea0: 6368 6562 7661 6e64 6572 0a0a 2020 2020  chebvander..    
+0001aeb0: 6966 206d 696e 6d61 7820 6973 204e 6f6e  if minmax is Non
+0001aec0: 653a 0a20 2020 2020 2020 206d 6920 3d20  e:.        mi = 
+0001aed0: 7761 7665 2e6d 696e 2829 0a20 2020 2020  wave.min().     
+0001aee0: 2020 206d 6120 3d20 7761 7665 2e6d 6178     ma = wave.max
+0001aef0: 2829 0a20 2020 2065 6c73 653a 0a20 2020  ().    else:.   
+0001af00: 2020 2020 206d 692c 206d 6120 3d20 6e70       mi, ma = np
+0001af10: 2e73 7175 6565 7a65 286d 696e 6d61 7829  .squeeze(minmax)
+0001af20: 2a31 2e0a 0a20 2020 2069 6620 6c6f 673a  *1...    if log:
+0001af30: 0a20 2020 2020 2020 2078 6920 3d20 6e70  .        xi = np
+0001af40: 2e6c 6f67 2877 6176 6529 0a20 2020 2020  .log(wave).     
+0001af50: 2020 206d 6920 3d20 6e70 2e6c 6f67 286d     mi = np.log(m
+0001af60: 6929 0a20 2020 2020 2020 206d 6120 3d20  i).        ma = 
+0001af70: 6e70 2e6c 6f67 286d 6129 0a20 2020 2065  np.log(ma).    e
+0001af80: 6c73 653a 0a20 2020 2020 2020 2078 6920  lse:.        xi 
+0001af90: 3d20 7761 7665 2a31 0a20 2020 200a 2020  = wave*1.    .  
+0001afa0: 2020 7820 3d20 2878 692d 6d69 292a 322f    x = (xi-mi)*2/
+0001afb0: 286d 612d 6d69 292d 310a 0a20 2020 206e  (ma-mi)-1..    n
+0001afc0: 5f62 6173 6573 203d 206f 7264 6572 2b31  _bases = order+1
+0001afd0: 0a20 2020 200a 2020 2020 6261 7369 7320  .    .    basis 
+0001afe0: 3d20 6368 6562 7661 6e64 6572 2878 2c20  = chebvander(x, 
+0001aff0: 6f72 6465 7229 0a20 2020 2023 2062 6173  order).    # bas
+0001b000: 6973 203d 206e 702e 656d 7074 7928 2878  is = np.empty((x
+0001b010: 2e73 6861 7065 5b30 5d2c 206e 5f62 6173  .shape[0], n_bas
+0001b020: 6573 292c 2064 7479 7065 3d66 6c6f 6174  es), dtype=float
+0001b030: 290a 2020 2020 2320 0a20 2020 2023 2078  ).    # .    # x
+0001b040: 7220 3d20 6e70 2e61 7261 6e67 6528 6e5f  r = np.arange(n_
+0001b050: 6261 7365 7329 0a20 2020 2023 2066 6f72  bases).    # for
+0001b060: 2069 2069 6e20 7261 6e67 6528 6e5f 6261   i in range(n_ba
+0001b070: 7365 7329 3a0a 2020 2020 2320 2020 2020  ses):.    #     
+0001b080: 5f63 203d 2028 7872 203d 3d20 6929 2a31  _c = (xr == i)*1
+0001b090: 0a20 2020 2023 2020 2020 2023 7072 696e  .    #     #prin
+0001b0a0: 7428 5f63 2c20 7872 2c20 6929 0a20 2020  t(_c, xr, i).   
+0001b0b0: 2023 2020 2020 2062 6173 6973 5b3a 2c69   #     basis[:,i
+0001b0c0: 5d20 3d20 6368 6562 7661 6c28 782c 205f  ] = chebval(x, _
+0001b0d0: 6329 0a20 2020 2020 2020 200a 2020 2020  c).        .    
+0001b0e0: 2366 6f72 2069 2069 6e20 7261 6e67 6528  #for i in range(
+0001b0f0: 6e5f 6261 7365 7329 3a0a 2020 2020 6f75  n_bases):.    ou
+0001b100: 745f 6f66 5f72 616e 6765 203d 2028 7869  t_of_range = (xi
+0001b110: 203c 206d 6929 207c 2028 7869 203e 206d   < mi) | (xi > m
+0001b120: 6129 0a20 2020 2062 6173 6973 5b6f 7574  a).    basis[out
+0001b130: 5f6f 665f 7261 6e67 652c 3a5d 203d 2030  _of_range,:] = 0
+0001b140: 0a0a 2020 2020 6966 2067 6574 5f6d 6174  ..    if get_mat
+0001b150: 7269 783a 0a20 2020 2020 2020 2072 6574  rix:.        ret
+0001b160: 7572 6e20 6261 7369 730a 0a20 2020 2074  urn basis..    t
+0001b170: 656d 7020 3d20 4f72 6465 7265 6444 6963  emp = OrderedDic
+0001b180: 7428 290a 2020 2020 666f 7220 6920 696e  t().    for i in
+0001b190: 2072 616e 6765 286e 5f62 6173 6573 293a   range(n_bases):
+0001b1a0: 0a20 2020 2020 2020 206b 6579 203d 2066  .        key = f
+0001b1b0: 2763 6865 6220 6f7b 697d 270a 2020 2020  'cheb o{i}'.    
+0001b1c0: 2020 2020 7465 6d70 5b6b 6579 5d20 3d20      temp[key] = 
+0001b1d0: 5370 6563 7472 756d 5465 6d70 6c61 7465  SpectrumTemplate
+0001b1e0: 2877 6176 652c 2062 6173 6973 5b3a 2c69  (wave, basis[:,i
+0001b1f0: 5d29 0a20 2020 2020 2020 2074 656d 705b  ]).        temp[
+0001b200: 6b65 795d 2e6e 616d 6520 3d20 6b65 790a  key].name = key.
+0001b210: 0a20 2020 2072 6574 7572 6e20 7465 6d70  .    return temp
+0001b220: 0a20 2020 200a 6465 6620 6273 706c 696e  .    .def bsplin
+0001b230: 655f 7465 6d70 6c61 7465 7328 7761 7665  e_templates(wave
+0001b240: 2c20 6465 6772 6565 3d33 2c20 6466 3d36  , degree=3, df=6
+0001b250: 2c20 6765 745f 6d61 7472 6978 3d46 616c  , get_matrix=Fal
+0001b260: 7365 2c20 6c6f 673d 4661 6c73 652c 2063  se, log=False, c
+0001b270: 6c69 703d 312e 652d 342c 206d 696e 6d61  lip=1.e-4, minma
+0001b280: 783d 4e6f 6e65 293a 0a20 2020 2022 2222  x=None):.    """
+0001b290: 0a20 2020 2042 2d73 706c 696e 6520 6261  .    B-spline ba
+0001b2a0: 7369 7320 6675 6e63 7469 6f6e 732c 206d  sis functions, m
+0001b2b0: 6f64 656c 6564 2061 6674 6572 2060 7e70  odeled after `~p
+0001b2c0: 6174 7379 2e73 706c 696e 6573 600a 2020  atsy.splines`.  
+0001b2d0: 2020 2222 220a 2020 2020 6672 6f6d 2073    """.    from s
+0001b2e0: 6369 7079 2e69 6e74 6572 706f 6c61 7465  cipy.interpolate
+0001b2f0: 2069 6d70 6f72 7420 7370 6c65 760a 0a20   import splev.. 
+0001b300: 2020 206f 7264 6572 203d 2064 6567 7265     order = degre
+0001b310: 652b 310a 2020 2020 6e5f 696e 6e65 725f  e+1.    n_inner_
+0001b320: 6b6e 6f74 7320 3d20 6466 202d 206f 7264  knots = df - ord
+0001b330: 6572 0a20 2020 2069 6e6e 6572 5f6b 6e6f  er.    inner_kno
+0001b340: 7473 203d 206e 702e 6c69 6e73 7061 6365  ts = np.linspace
+0001b350: 2830 2c20 312c 206e 5f69 6e6e 6572 5f6b  (0, 1, n_inner_k
+0001b360: 6e6f 7473 202b 2032 295b 313a 2d31 5d0a  nots + 2)[1:-1].
+0001b370: 0a20 2020 206e 6f72 6d5f 6b6e 6f74 7320  .    norm_knots 
+0001b380: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
+0001b390: 2828 5b30 2c20 315d 202a 206f 7264 6572  (([0, 1] * order
+0001b3a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b3c0: 2020 696e 6e65 725f 6b6e 6f74 7329 290a    inner_knots)).
+0001b3d0: 2020 2020 6e6f 726d 5f6b 6e6f 7473 2e73      norm_knots.s
+0001b3e0: 6f72 7428 290a 0a20 2020 2069 6620 6c6f  ort()..    if lo
+0001b3f0: 673a 0a20 2020 2020 2020 2078 7370 6c20  g:.        xspl 
+0001b400: 3d20 6e70 2e6c 6f67 2877 6176 6529 0a20  = np.log(wave). 
+0001b410: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001b420: 2078 7370 6c20 3d20 7761 7665 2a31 0a0a   xspl = wave*1..
+0001b430: 2020 2020 6966 206d 696e 6d61 7820 6973      if minmax is
+0001b440: 204e 6f6e 653a 0a20 2020 2020 2020 206d   None:.        m
+0001b450: 6920 3d20 7873 706c 2e6d 696e 2829 0a20  i = xspl.min(). 
+0001b460: 2020 2020 2020 206d 6120 3d20 7873 706c         ma = xspl
+0001b470: 2e6d 6178 2829 0a20 2020 2065 6c73 653a  .max().    else:
+0001b480: 0a20 2020 2020 2020 206d 692c 206d 6120  .        mi, ma 
+0001b490: 3d20 6d69 6e6d 6178 0a0a 2020 2020 7769  = minmax..    wi
+0001b4a0: 6474 6820 3d20 6d61 2d6d 690a 2020 2020  dth = ma-mi.    
+0001b4b0: 616c 6c5f 6b6e 6f74 7320 3d20 6e6f 726d  all_knots = norm
+0001b4c0: 5f6b 6e6f 7473 2a77 6964 7468 2b6d 690a  _knots*width+mi.
+0001b4d0: 0a20 2020 206e 5f62 6173 6573 203d 206c  .    n_bases = l
+0001b4e0: 656e 2861 6c6c 5f6b 6e6f 7473 2920 2d20  en(all_knots) - 
+0001b4f0: 2864 6567 7265 6520 2b20 3129 0a20 2020  (degree + 1).   
+0001b500: 2062 6173 6973 203d 206e 702e 656d 7074   basis = np.empt
+0001b510: 7928 2878 7370 6c2e 7368 6170 655b 305d  y((xspl.shape[0]
+0001b520: 2c20 6e5f 6261 7365 7329 2c20 6474 7970  , n_bases), dtyp
+0001b530: 653d 666c 6f61 7429 0a0a 2020 2020 636f  e=float)..    co
+0001b540: 6566 7320 3d20 6e70 2e69 6465 6e74 6974  efs = np.identit
+0001b550: 7928 6e5f 6261 7365 7329 0a20 2020 2062  y(n_bases).    b
+0001b560: 6173 6973 203d 2073 706c 6576 2878 7370  asis = splev(xsp
+0001b570: 6c2c 2028 616c 6c5f 6b6e 6f74 732c 2063  l, (all_knots, c
+0001b580: 6f65 6673 2c20 6465 6772 6565 2929 0a0a  oefs, degree))..
+0001b590: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0001b5a0: 6765 286e 5f62 6173 6573 293a 0a20 2020  ge(n_bases):.   
+0001b5b0: 2020 2020 206f 7574 5f6f 665f 7261 6e67       out_of_rang
+0001b5c0: 6520 3d20 2878 7370 6c20 3c20 6d69 2920  e = (xspl < mi) 
+0001b5d0: 7c20 2878 7370 6c20 3e20 6d61 290a 2020  | (xspl > ma).  
+0001b5e0: 2020 2020 2020 6261 7369 735b 695d 5b6f        basis[i][o
+0001b5f0: 7574 5f6f 665f 7261 6e67 655d 203d 2030  ut_of_range] = 0
+0001b600: 0a0a 2020 2020 7761 7665 5f70 6561 6b20  ..    wave_peak 
+0001b610: 3d20 6e70 2e72 6f75 6e64 2877 6176 655b  = np.round(wave[
+0001b620: 6e70 2e61 7267 6d61 7828 6261 7369 732c  np.argmax(basis,
+0001b630: 2061 7869 733d 3129 5d29 0a0a 2020 2020   axis=1)])..    
+0001b640: 6d61 7876 616c 203d 206e 702e 6d61 7828  maxval = np.max(
+0001b650: 6261 7369 732c 2061 7869 733d 3129 0a20  basis, axis=1). 
+0001b660: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0001b670: 6528 6e5f 6261 7365 7329 3a0a 2020 2020  e(n_bases):.    
+0001b680: 2020 2020 6261 7369 735b 695d 5b62 6173      basis[i][bas
+0001b690: 6973 5b69 5d20 3c20 636c 6970 2a6d 6178  is[i] < clip*max
+0001b6a0: 7661 6c5b 695d 5d20 3d20 300a 0a20 2020  val[i]] = 0..   
+0001b6b0: 2069 6620 6765 745f 6d61 7472 6978 3a0a   if get_matrix:.
+0001b6c0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+0001b6d0: 702e 7673 7461 636b 2862 6173 6973 292e  p.vstack(basis).
+0001b6e0: 540a 0a20 2020 2074 656d 7020 3d20 4f72  T..    temp = Or
+0001b6f0: 6465 7265 6444 6963 7428 290a 2020 2020  deredDict().    
+0001b700: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
+0001b710: 5f62 6173 6573 293a 0a20 2020 2020 2020  _bases):.       
+0001b720: 206b 6579 203d 2027 6273 706c 207b 307d   key = 'bspl {0}
+0001b730: 207b 313a 2e30 667d 272e 666f 726d 6174   {1:.0f}'.format
+0001b740: 2869 2c20 7761 7665 5f70 6561 6b5b 695d  (i, wave_peak[i]
+0001b750: 290a 2020 2020 2020 2020 7465 6d70 5b6b  ).        temp[k
+0001b760: 6579 5d20 3d20 5370 6563 7472 756d 5465  ey] = SpectrumTe
+0001b770: 6d70 6c61 7465 2877 6176 652c 2062 6173  mplate(wave, bas
+0001b780: 6973 5b69 5d29 0a20 2020 2020 2020 2074  is[i]).        t
+0001b790: 656d 705b 6b65 795d 2e6e 616d 6520 3d20  emp[key].name = 
+0001b7a0: 6b65 790a 2020 2020 2020 2020 7465 6d70  key.        temp
+0001b7b0: 5b6b 6579 5d2e 7761 7665 5f70 6561 6b20  [key].wave_peak 
+0001b7c0: 3d20 7761 7665 5f70 6561 6b5b 695d 0a0a  = wave_peak[i]..
+0001b7d0: 2020 2020 7465 6d70 2e6b 6e6f 7473 203d      temp.knots =
+0001b7e0: 2061 6c6c 5f6b 6e6f 7473 0a20 2020 2074   all_knots.    t
+0001b7f0: 656d 702e 6465 6772 6565 203d 2064 6567  emp.degree = deg
+0001b800: 7265 650a 2020 2020 7465 6d70 2e78 7370  ree.    temp.xsp
+0001b810: 6c20 3d20 7873 706c 0a0a 2020 2020 7265  l = xspl..    re
+0001b820: 7475 726e 2074 656d 700a 0a0a 6465 6620  turn temp...def 
+0001b830: 6576 616c 5f62 7370 6c69 6e65 5f74 656d  eval_bspline_tem
+0001b840: 706c 6174 6573 2877 6176 652c 2062 7370  plates(wave, bsp
+0001b850: 6c2c 2063 6f65 6673 293a 0a20 2020 2066  l, coefs):.    f
+0001b860: 726f 6d20 7363 6970 792e 696e 7465 7270  rom scipy.interp
+0001b870: 6f6c 6174 6520 696d 706f 7274 2073 706c  olate import spl
+0001b880: 6576 0a0a 2020 2020 7873 706c 203d 206e  ev..    xspl = n
+0001b890: 702e 6c6f 6728 7761 7665 290a 2020 2020  p.log(wave).    
+0001b8a0: 6261 7369 7320 3d20 7370 6c65 7628 7873  basis = splev(xs
+0001b8b0: 706c 2c20 2862 7370 6c2e 6b6e 6f74 732c  pl, (bspl.knots,
+0001b8c0: 2063 6f65 6673 2c20 6273 706c 2e64 6567   coefs, bspl.deg
+0001b8d0: 7265 6529 290a 2020 2020 7265 7475 726e  ree)).    return
+0001b8e0: 206e 702e 6172 7261 7928 6261 7369 7329   np.array(basis)
+0001b8f0: 0a0a 0a64 6566 2073 706c 6974 5f73 706c  ...def split_spl
+0001b900: 696e 655f 7465 6d70 6c61 7465 2874 656d  ine_template(tem
+0001b910: 706c 2c20 7761 7665 6c65 6e67 7468 5f72  pl, wavelength_r
+0001b920: 616e 6765 3d5b 3530 3030 2c20 322e 3465  ange=[5000, 2.4e
+0001b930: 345d 2c20 5273 706c 696e 653d 3130 2c20  4], Rspline=10, 
+0001b940: 6c6f 673d 5472 7565 293a 0a20 2020 2022  log=True):.    "
+0001b950: 2222 0a20 2020 204d 756c 7469 706c 7920  "".    Multiply 
+0001b960: 6120 7369 6e67 6c65 2074 656d 706c 6174  a single templat
+0001b970: 6520 6279 2073 706c 696e 6520 6261 7365  e by spline base
+0001b980: 7320 746f 2065 6666 6563 7469 7665 6c79  s to effectively
+0001b990: 2067 656e 6572 6174 6520 610a 2020 2020   generate a.    
+0001b9a0: 7370 6c69 6e65 206d 756c 7469 706c 6963  spline multiplic
+0001b9b0: 6174 6976 6520 636f 7272 6563 7469 6f6e  ative correction
+0001b9c0: 2074 6861 7420 6361 6e20 6265 2066 6974   that can be fit
+0001b9d0: 2077 6974 6820 6c69 6e65 6172 206c 6561   with linear lea
+0001b9e0: 7374 0a20 2020 2073 7175 6172 6573 2e0a  st.    squares..
+0001b9f0: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+0001ba00: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a      ----------..
+0001ba10: 2020 2020 7465 6d70 6c20 3a20 607e 6772      templ : `~gr
+0001ba20: 697a 6c69 2e75 7469 6c73 2e53 7065 6374  izli.utils.Spect
+0001ba30: 7275 6d54 656d 706c 6174 6560 0a20 2020  rumTemplate`.   
+0001ba40: 2020 2020 2054 656d 706c 6174 6520 746f       Template to
+0001ba50: 2073 706c 6974 2e0a 0a20 2020 2077 6176   split...    wav
+0001ba60: 656c 656e 6774 685f 7261 6e67 6520 3a20  elength_range : 
+0001ba70: 5b66 6c6f 6174 2c20 666c 6f61 745d 0a20  [float, float]. 
+0001ba80: 2020 2020 2020 204c 696d 6974 2074 6865         Limit the
+0001ba90: 2073 706c 696e 6573 2074 6f20 7468 6973   splines to this
+0001baa0: 2077 6176 656c 656e 6774 6820 7261 6e67   wavelength rang
+0001bab0: 650a 0a20 2020 2052 7370 6c69 6e65 203a  e..    Rspline :
+0001bac0: 2066 6c6f 6174 0a20 2020 2020 2020 2045   float.        E
+0001bad0: 6666 6563 7469 7665 2072 6573 6f6c 7574  ffective resolut
+0001bae0: 696f 6e2c 2052 3d64 6c61 6d62 6461 2f6c  ion, R=dlambda/l
+0001baf0: 616d 6264 612c 206f 6620 7468 6520 7370  ambda, of the sp
+0001bb00: 6c69 6e65 2063 6f72 7265 6374 696f 6e0a  line correction.
+0001bb10: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
+0001bb20: 2e0a 0a20 2020 206c 6f67 203a 2062 6f6f  ...    log : boo
+0001bb30: 6c0a 2020 2020 2020 2020 4c6f 672d 7370  l.        Log-sp
+0001bb40: 6163 6564 2073 706c 696e 6573 0a0a 2020  aced splines..  
+0001bb50: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0001bb60: 2d2d 2d2d 2d0a 0a20 2020 2073 7465 6d70  -----..    stemp
+0001bb70: 203a 2064 6963 740a 0a20 2020 2020 2020   : dict..       
+0001bb80: 2044 6963 7469 6f6e 6172 7920 6f66 2073   Dictionary of s
+0001bb90: 706c 696e 652d 636f 6d70 6f6e 656e 7420  pline-component 
+0001bba0: 7465 6d70 6c61 7465 732c 2077 6974 6820  templates, with 
+0001bbb0: 6164 6469 7469 6f6e 616c 2061 7474 7269  additional attri
+0001bbc0: 6275 7465 733a 0a0a 2020 2020 2020 2020  butes:..        
+0001bbd0: 2020 2020 7773 706c 696e 6520 3d20 7761      wspline = wa
+0001bbe0: 7665 6c65 6e67 7468 206f 6620 7468 6520  velength of the 
+0001bbf0: 7465 6d70 6c61 7465 7320 2f20 7370 6c69  templates / spli
+0001bc00: 6e65 2063 6f72 7265 6374 696f 6e0a 2020  ne correction.  
+0001bc10: 2020 2020 2020 2020 2020 7473 706c 696e            tsplin
+0001bc20: 6520 3d20 6d61 7472 6978 206f 6620 7468  e = matrix of th
+0001bc30: 6520 7370 6c69 6e65 2063 6f72 7265 6374  e spline correct
+0001bc40: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
+0001bc50: 206b 6e6f 7473 2020 203d 2070 6561 6b20   knots   = peak 
+0001bc60: 7761 7665 6c65 6e67 6874 7320 6f66 2065  wavelenghts of e
+0001bc70: 6163 6820 7370 6c69 6e65 2063 6f6d 706f  ach spline compo
+0001bc80: 6e65 6e74 0a0a 2020 2020 2222 220a 2020  nent..    """.  
+0001bc90: 2020 6672 6f6d 2063 6f6c 6c65 6374 696f    from collectio
+0001bca0: 6e73 2069 6d70 6f72 7420 4f72 6465 7265  ns import Ordere
+0001bcb0: 6444 6963 740a 2020 2020 6672 6f6d 2067  dDict.    from g
+0001bcc0: 7269 7a6c 6920 696d 706f 7274 2075 7469  rizli import uti
+0001bcd0: 6c73 0a0a 2020 2020 6966 2046 616c 7365  ls..    if False
+0001bce0: 3a0a 2020 2020 2020 2020 7374 6172 7320  :.        stars 
+0001bcf0: 3d20 7574 696c 732e 6c6f 6164 5f74 656d  = utils.load_tem
+0001bd00: 706c 6174 6573 2873 7461 7273 3d54 7275  plates(stars=Tru
+0001bd10: 6529 0a20 2020 2020 2020 2074 656d 706c  e).        templ
+0001bd20: 203d 2073 7461 7273 5b27 7374 6172 732f   = stars['stars/
+0001bd30: 4c31 2e30 2e74 7874 275d 0a0a 2020 2020  L1.0.txt']..    
+0001bd40: 7773 706c 696e 6520 3d20 7465 6d70 6c2e  wspline = templ.
+0001bd50: 7761 7665 0a0a 2020 2020 636c 6970 203d  wave..    clip =
+0001bd60: 2028 7773 706c 696e 6520 3e20 7761 7665   (wspline > wave
+0001bd70: 6c65 6e67 7468 5f72 616e 6765 5b30 5d29  length_range[0])
+0001bd80: 2026 2028 7773 706c 696e 6520 3c20 7761   & (wspline < wa
+0001bd90: 7665 6c65 6e67 7468 5f72 616e 6765 5b31  velength_range[1
+0001bda0: 5d29 0a20 2020 2064 665f 7370 6c20 3d20  ]).    df_spl = 
+0001bdb0: 6c65 6e28 7574 696c 732e 6c6f 675f 7a67  len(utils.log_zg
+0001bdc0: 7269 6428 7a72 3d77 6176 656c 656e 6774  rid(zr=wavelengt
+0001bdd0: 685f 7261 6e67 652c 2064 7a3d 312e 2f52  h_range, dz=1./R
+0001bde0: 7370 6c69 6e65 2929 0a0a 2020 2020 7473  spline))..    ts
+0001bdf0: 706c 696e 6520 3d20 7574 696c 732e 6273  pline = utils.bs
+0001be00: 706c 696e 655f 7465 6d70 6c61 7465 7328  pline_templates(
+0001be10: 7773 706c 696e 655b 636c 6970 5d2c 2064  wspline[clip], d
+0001be20: 663d 6466 5f73 706c 2b32 2c20 6c6f 673d  f=df_spl+2, log=
+0001be30: 6c6f 672c 2063 6c69 703d 302e 3030 3031  log, clip=0.0001
+0001be40: 2c20 6765 745f 6d61 7472 6978 3d54 7275  , get_matrix=Tru
+0001be50: 6529 0a0a 2020 2020 6978 203d 206e 702e  e)..    ix = np.
+0001be60: 6172 676d 6178 2874 7370 6c69 6e65 2c20  argmax(tspline, 
+0001be70: 6178 6973 3d30 290a 2020 2020 6b6e 6f74  axis=0).    knot
+0001be80: 7320 3d20 7773 706c 696e 655b 636c 6970  s = wspline[clip
+0001be90: 5d5b 6978 5d0a 0a20 2020 204e 203d 2074  ][ix]..    N = t
+0001bea0: 7370 6c69 6e65 2e73 6861 7065 5b31 5d0a  spline.shape[1].
+0001beb0: 2020 2020 7374 656d 7020 3d20 4f72 6465      stemp = Orde
+0001bec0: 7265 6444 6963 7428 290a 2020 2020 666f  redDict().    fo
+0001bed0: 7220 6920 696e 2072 616e 6765 284e 293a  r i in range(N):
+0001bee0: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
+0001bef0: 277b 307d 207b 313a 2e32 667d 272e 666f  '{0} {1:.2f}'.fo
+0001bf00: 726d 6174 2874 656d 706c 2e6e 616d 652c  rmat(templ.name,
+0001bf10: 206b 6e6f 7473 5b69 5d2f 312e 6534 290a   knots[i]/1.e4).
+0001bf20: 2020 2020 2020 2020 7374 656d 705b 6e61          stemp[na
+0001bf30: 6d65 5d20 3d20 7574 696c 732e 5370 6563  me] = utils.Spec
+0001bf40: 7472 756d 5465 6d70 6c61 7465 2877 6176  trumTemplate(wav
+0001bf50: 653d 7773 706c 696e 655b 636c 6970 5d2c  e=wspline[clip],
+0001bf60: 2066 6c75 783d 7465 6d70 6c2e 666c 7578   flux=templ.flux
+0001bf70: 5b63 6c69 705d 2a74 7370 6c69 6e65 5b3a  [clip]*tspline[:
+0001bf80: 2c20 695d 2c20 6e61 6d65 3d6e 616d 6529  , i], name=name)
+0001bf90: 0a20 2020 2020 2020 2073 7465 6d70 5b6e  .        stemp[n
+0001bfa0: 616d 655d 2e6b 6e6f 7420 3d20 6b6e 6f74  ame].knot = knot
+0001bfb0: 735b 695d 0a0a 2020 2020 7374 656d 702e  s[i]..    stemp.
+0001bfc0: 7773 706c 696e 6520 3d20 7773 706c 696e  wspline = wsplin
+0001bfd0: 655b 636c 6970 5d0a 2020 2020 7374 656d  e[clip].    stem
+0001bfe0: 702e 7473 706c 696e 6520 3d20 7473 706c  p.tspline = tspl
+0001bff0: 696e 650a 2020 2020 7374 656d 702e 6b6e  ine.    stemp.kn
+0001c000: 6f74 7320 3d20 6b6e 6f74 730a 0a20 2020  ots = knots..   
+0001c010: 2072 6574 7572 6e20 7374 656d 700a 0a0a   return stemp...
+0001c020: 6465 6620 7374 6570 5f74 656d 706c 6174  def step_templat
+0001c030: 6573 2877 6c69 6d3d 5b35 3030 302c 2031  es(wlim=[5000, 1
+0001c040: 2e38 6534 5d2c 2062 696e 5f73 7465 7073  .8e4], bin_steps
+0001c050: 3d4e 6f6e 652c 2052 3d33 302c 2072 6f75  =None, R=30, rou
+0001c060: 6e64 3d31 302c 2072 6573 743d 4661 6c73  nd=10, rest=Fals
+0001c070: 652c 2073 7065 6369 616c 3d4e 6f6e 652c  e, special=None,
+0001c080: 206f 7264 6572 3d30 293a 0a20 2020 2022   order=0):.    "
+0001c090: 2222 0a20 2020 2053 7465 702d 6675 6e63  "".    Step-func
+0001c0a0: 7469 6f6e 2074 656d 706c 6174 6573 2066  tion templates f
+0001c0b0: 6f72 2065 6173 7920 6269 6e6e 696e 670a  or easy binning.
+0001c0c0: 2020 2020 2222 220a 2020 2020 6966 2073      """.    if s
+0001c0d0: 7065 6369 616c 203d 3d20 2744 6e34 3030  pecial == 'Dn400
+0001c0e0: 3027 3a0a 2020 2020 2020 2020 7265 7374  0':.        rest
+0001c0f0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0001c100: 6269 6e5f 7374 6570 7320 3d20 6e70 2e68  bin_steps = np.h
+0001c110: 7374 6163 6b28 5b6e 702e 6172 616e 6765  stack([np.arange
+0001c120: 2838 3530 2c20 3338 3439 2c20 3130 3029  (850, 3849, 100)
+0001c130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c150: 5b33 3835 302c 2033 3935 302c 2034 3030  [3850, 3950, 400
+0001c160: 302c 2034 3130 305d 2c0a 2020 2020 2020  0, 4100],.      
+0001c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c180: 2020 2020 2020 2020 6e70 2e61 7261 6e67          np.arang
+0001c190: 6528 3432 3030 2c20 312e 3765 342c 2031  e(4200, 1.7e4, 1
+0001c1a0: 3030 295d 290a 0a20 2020 2065 6c69 6620  00)])..    elif 
+0001c1b0: 7370 6563 6961 6c20 3d3d 2027 4434 3030  special == 'D400
+0001c1c0: 3027 3a0a 2020 2020 2020 2020 7265 7374  0':.        rest
+0001c1d0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0001c1e0: 6269 6e5f 7374 6570 7320 3d20 6e70 2e68  bin_steps = np.h
+0001c1f0: 7374 6163 6b28 5b6e 702e 6172 616e 6765  stack([np.arange
+0001c200: 2838 3530 2c20 3337 3439 2c20 3230 3029  (850, 3749, 200)
+0001c210: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c230: 5b33 3735 302c 2033 3935 302c 2034 3035  [3750, 3950, 405
+0001c240: 302c 2034 3235 305d 2c0a 2020 2020 2020  0, 4250],.      
+0001c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c260: 2020 2020 2020 2020 6e70 2e61 7261 6e67          np.arang
+0001c270: 6528 3434 3530 2c20 312e 3765 342c 2032  e(4450, 1.7e4, 2
+0001c280: 3030 295d 290a 2020 2020 656c 6966 2073  00)]).    elif s
+0001c290: 7065 6369 616c 206e 6f74 2069 6e20 5b27  pecial not in ['
+0001c2a0: 4434 3030 3027 2c20 2744 6e34 3030 3027  D4000', 'Dn4000'
+0001c2b0: 2c20 4e6f 6e65 5d3a 0a20 2020 2020 2020  , None]:.       
+0001c2c0: 2070 7269 6e74 2827 7374 6570 5f74 656d   print('step_tem
+0001c2d0: 706c 6174 6573 3a20 7b30 7d20 6e6f 7420  plates: {0} not 
+0001c2e0: 7265 636f 676e 697a 6564 2028 6f70 7469  recognized (opti
+0001c2f0: 6f6e 7320 6172 6520 5c27 4434 3030 305c  ons are \'D4000\
+0001c300: 272c 205c 2744 6e34 3030 305c 272c 2061  ', \'Dn4000\', a
+0001c310: 6e64 204e 6f6e 6529 272e 666f 726d 6174  nd None)'.format
+0001c320: 2873 7065 6369 616c 2929 0a20 2020 2020  (special)).     
+0001c330: 2020 2072 6574 7572 6e20 7b7d 0a0a 2020     return {}..  
+0001c340: 2020 6966 2062 696e 5f73 7465 7073 2069    if bin_steps i
+0001c350: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001c360: 6269 6e5f 7374 6570 7320 3d20 6e70 2e72  bin_steps = np.r
+0001c370: 6f75 6e64 286c 6f67 5f7a 6772 6964 2877  ound(log_zgrid(w
+0001c380: 6c69 6d2c 2031 2e2f 5229 2f72 6f75 6e64  lim, 1./R)/round
+0001c390: 292a 726f 756e 640a 2020 2020 656c 7365  )*round.    else
+0001c3a0: 3a0a 2020 2020 2020 2020 776c 696d 203d  :.        wlim =
+0001c3b0: 205b 6269 6e5f 7374 6570 735b 305d 2c20   [bin_steps[0], 
+0001c3c0: 6269 6e5f 7374 6570 735b 2d31 5d5d 0a0a  bin_steps[-1]]..
+0001c3d0: 2020 2020 6473 203d 206e 702e 6469 6666      ds = np.diff
+0001c3e0: 2862 696e 5f73 7465 7073 290a 0a20 2020  (bin_steps)..   
+0001c3f0: 2078 7370 6563 203d 206e 702e 6172 616e   xspec = np.aran
+0001c400: 6765 2877 6c69 6d5b 305d 2d64 735b 305d  ge(wlim[0]-ds[0]
+0001c410: 2c20 776c 696d 5b31 5d2b 6473 5b2d 315d  , wlim[1]+ds[-1]
+0001c420: 290a 0a20 2020 2062 696e 5f6d 6964 203d  )..    bin_mid =
+0001c430: 2062 696e 5f73 7465 7073 5b3a 2d31 5d2b   bin_steps[:-1]+
+0001c440: 6473 2f32 2e0a 0a20 2020 2073 7465 705f  ds/2...    step_
+0001c450: 7465 6d70 6c20 3d20 7b7d 0a20 2020 2066  templ = {}.    f
+0001c460: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+0001c470: 6e28 6269 6e5f 7374 6570 7329 2d31 293a  n(bin_steps)-1):
+0001c480: 0a0a 2020 2020 2020 2020 7973 7065 6320  ..        yspec 
+0001c490: 3d20 2828 7873 7065 6320 3e3d 2062 696e  = ((xspec >= bin
+0001c4a0: 5f73 7465 7073 5b69 5d29 2026 2028 7873  _steps[i]) & (xs
+0001c4b0: 7065 6320 3c20 6269 6e5f 7374 6570 735b  pec < bin_steps[
+0001c4c0: 692b 315d 2929 2a31 0a0a 2020 2020 2020  i+1]))*1..      
+0001c4d0: 2020 666f 7220 6f20 696e 2072 616e 6765    for o in range
+0001c4e0: 286f 7264 6572 2b31 293a 0a20 2020 2020  (order+1):.     
+0001c4f0: 2020 2020 2020 206c 6162 656c 203d 2027         label = '
+0001c500: 7374 6570 207b 303a 2e30 667d 2d7b 313a  step {0:.0f}-{1:
+0001c510: 2e30 667d 207b 327d 272e 666f 726d 6174  .0f} {2}'.format
+0001c520: 2862 696e 5f73 7465 7073 5b69 5d2c 2062  (bin_steps[i], b
+0001c530: 696e 5f73 7465 7073 5b69 2b31 5d2c 206f  in_steps[i+1], o
+0001c540: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001c550: 2072 6573 743a 0a20 2020 2020 2020 2020   rest:.         
+0001c560: 2020 2020 2020 206c 6162 656c 203d 2027         label = '
+0001c570: 7227 2b6c 6162 656c 0a0a 2020 2020 2020  r'+label..      
+0001c580: 2020 2020 2020 666c 7578 203d 2028 2878        flux = ((x
+0001c590: 7370 6563 2d62 696e 5f6d 6964 5b69 5d29  spec-bin_mid[i])
+0001c5a0: 2f64 735b 695d 292a 2a6f 202a 2028 7973  /ds[i])**o * (ys
+0001c5b0: 7065 6320 3e20 3029 0a20 2020 2020 2020  pec > 0).       
+0001c5c0: 2020 2020 2073 7465 705f 7465 6d70 6c5b       step_templ[
+0001c5d0: 6c61 6265 6c5d 203d 2053 7065 6374 7275  label] = Spectru
+0001c5e0: 6d54 656d 706c 6174 6528 7761 7665 3d78  mTemplate(wave=x
+0001c5f0: 7370 6563 2c20 666c 7578 3d66 6c75 782c  spec, flux=flux,
+0001c600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c630: 2020 6e61 6d65 3d6c 6162 656c 290a 0a20    name=label).. 
+0001c640: 2020 2072 6574 7572 6e20 6269 6e5f 7374     return bin_st
+0001c650: 6570 732c 2073 7465 705f 7465 6d70 6c0a  eps, step_templ.
+0001c660: 0a0a 6465 6620 706f 6c79 6e6f 6d69 616c  ..def polynomial
+0001c670: 5f74 656d 706c 6174 6573 2877 6176 652c  _templates(wave,
+0001c680: 2072 6566 5f77 6176 653d 312e 6534 2c20   ref_wave=1.e4, 
+0001c690: 6f72 6465 723d 302c 206c 696e 653d 4661  order=0, line=Fa
+0001c6a0: 6c73 6529 3a0a 2020 2020 7465 6d70 203d  lse):.    temp =
+0001c6b0: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
+0001c6c0: 2020 2069 6620 6c69 6e65 3a0a 2020 2020     if line:.    
+0001c6d0: 2020 2020 666f 7220 7369 676e 2069 6e20      for sign in 
+0001c6e0: 5b31 2c20 2d31 5d3a 0a20 2020 2020 2020  [1, -1]:.       
+0001c6f0: 2020 2020 206b 6579 203d 2027 706f 6c79       key = 'poly
+0001c700: 207b 307d 272e 666f 726d 6174 2873 6967   {0}'.format(sig
+0001c710: 6e29 0a20 2020 2020 2020 2020 2020 2074  n).            t
+0001c720: 656d 705b 6b65 795d 203d 2053 7065 6374  emp[key] = Spect
+0001c730: 7275 6d54 656d 706c 6174 6528 7761 7665  rumTemplate(wave
+0001c740: 2c20 7369 676e 2a28 7761 7665 2f72 6566  , sign*(wave/ref
+0001c750: 5f77 6176 652d 3129 2b31 290a 2020 2020  _wave-1)+1).    
+0001c760: 2020 2020 2020 2020 7465 6d70 5b6b 6579          temp[key
+0001c770: 5d2e 6e61 6d65 203d 206b 6579 0a0a 2020  ].name = key..  
+0001c780: 2020 2020 2020 7265 7475 726e 2074 656d        return tem
+0001c790: 700a 0a20 2020 2066 6f72 2069 2069 6e20  p..    for i in 
+0001c7a0: 7261 6e67 6528 6f72 6465 722b 3129 3a0a  range(order+1):.
+0001c7b0: 2020 2020 2020 2020 6b65 7920 3d20 2770          key = 'p
+0001c7c0: 6f6c 7920 7b30 7d27 2e66 6f72 6d61 7428  oly {0}'.format(
+0001c7d0: 6929 0a20 2020 2020 2020 2074 656d 705b  i).        temp[
+0001c7e0: 6b65 795d 203d 2053 7065 6374 7275 6d54  key] = SpectrumT
+0001c7f0: 656d 706c 6174 6528 7761 7665 2c20 2877  emplate(wave, (w
+0001c800: 6176 652f 7265 665f 7761 7665 2d31 292a  ave/ref_wave-1)*
+0001c810: 2a69 290a 2020 2020 2020 2020 7465 6d70  *i).        temp
+0001c820: 5b6b 6579 5d2e 6e61 6d65 203d 206b 6579  [key].name = key
+0001c830: 0a20 2020 2020 2020 2074 656d 705b 6b65  .        temp[ke
+0001c840: 795d 2e72 6566 5f77 6176 6520 3d20 7265  y].ref_wave = re
+0001c850: 665f 7761 7665 0a0a 2020 2020 7265 7475  f_wave..    retu
+0001c860: 726e 2074 656d 700a 0a0a 6465 6620 7370  rn temp...def sp
+0001c870: 6c69 745f 706f 6c79 5f74 656d 706c 6174  lit_poly_templat
+0001c880: 6528 7465 6d70 6c2c 2072 6566 5f77 6176  e(templ, ref_wav
+0001c890: 653d 312e 6534 2c20 6f72 6465 723d 3329  e=1.e4, order=3)
+0001c8a0: 3a0a 2020 2020 2222 220a 2020 2020 4d75  :.    """.    Mu
+0001c8b0: 6c74 6970 6c79 2061 2073 696e 676c 6520  ltiply a single 
+0001c8c0: 7465 6d70 6c61 7465 2062 7920 706f 6c79  template by poly
+0001c8d0: 6e6f 6d69 616c 2062 6173 6573 2074 6f20  nomial bases to 
+0001c8e0: 6566 6665 6374 6976 656c 7920 6765 6e65  effectively gene
+0001c8f0: 7261 7465 2061 0a20 2020 2070 6f6c 796e  rate a.    polyn
+0001c900: 6f6d 6961 6c20 6d75 6c74 6970 6c69 6361  omial multiplica
+0001c910: 7469 7665 2063 6f72 7265 6374 696f 6e20  tive correction 
+0001c920: 7468 6174 2063 616e 2062 6520 6669 7420  that can be fit 
+0001c930: 7769 7468 206c 696e 6561 7220 6c65 6173  with linear leas
+0001c940: 740a 2020 2020 7371 7561 7265 732e 0a0a  t.    squares...
+0001c950: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+0001c960: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+0001c970: 2020 7465 6d70 6c20 3a20 607e 6772 697a    templ : `~griz
+0001c980: 6c69 2e75 7469 6c73 2e53 7065 6374 7275  li.utils.Spectru
+0001c990: 6d54 656d 706c 6174 6560 0a20 2020 2020  mTemplate`.     
+0001c9a0: 2020 2054 656d 706c 6174 6520 746f 2073     Template to s
+0001c9b0: 706c 6974 2e0a 0a20 2020 2072 6566 5f77  plit...    ref_w
+0001c9c0: 6176 6520 3a20 666c 6f61 740a 2020 2020  ave : float.    
+0001c9d0: 2020 2057 6176 656c 656e 6774 6820 7768     Wavelength wh
+0001c9e0: 6572 6520 746f 206e 6f72 6d61 6c69 7a65  ere to normalize
+0001c9f0: 2074 6865 2070 6f6c 796e 6f6d 6961 6c73   the polynomials
+0001ca00: 2e0a 0a20 2020 204f 7264 6572 203a 2069  ...    Order : i
+0001ca10: 6e74 0a20 2020 2020 2020 2050 6f6c 796e  nt.        Polyn
+0001ca20: 6f6d 6961 6c20 6f72 6465 722e 2020 5265  omial order.  Re
+0001ca30: 7475 726e 7320 6f72 6465 722b 3120 7465  turns order+1 te
+0001ca40: 6d70 6c61 7465 732e 0a0a 2020 2020 5265  mplates...    Re
+0001ca50: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+0001ca60: 2d0a 2020 2020 7074 656d 7020 3a20 6469  -.    ptemp : di
+0001ca70: 6374 0a0a 2020 2020 2020 2020 4469 6374  ct..        Dict
+0001ca80: 696f 6e61 7279 206f 6620 706f 6c79 6e6f  ionary of polyno
+0001ca90: 6d69 616c 2d63 6f6d 706f 6e65 6e74 2074  mial-component t
+0001caa0: 656d 706c 6174 6573 2c20 7769 7468 2061  emplates, with a
+0001cab0: 6464 6974 696f 6e61 6c0a 2020 2020 2020  dditional.      
+0001cac0: 2020 6174 7472 6962 7574 6573 3a0a 0a20    attributes:.. 
+0001cad0: 2020 2020 2020 2020 2020 2072 6566 5f77             ref_w
+0001cae0: 6176 6520 3d20 7761 7665 6c65 6e67 7468  ave = wavelength
+0001caf0: 2077 6865 7265 2070 6f6c 796e 6f6d 6961   where polynomia
+0001cb00: 6c73 206e 6f72 6d61 6c69 7a65 640a 0a20  ls normalized.. 
+0001cb10: 2020 2022 2222 0a20 2020 2066 726f 6d20     """.    from 
+0001cb20: 636f 6c6c 6563 7469 6f6e 7320 696d 706f  collections impo
+0001cb30: 7274 204f 7264 6572 6564 4469 6374 0a20  rt OrderedDict. 
+0001cb40: 2020 2066 726f 6d20 6772 697a 6c69 2069     from grizli i
+0001cb50: 6d70 6f72 7420 7574 696c 730a 0a20 2020  mport utils..   
+0001cb60: 2074 7370 6c69 6e65 203d 2070 6f6c 796e   tspline = polyn
+0001cb70: 6f6d 6961 6c5f 7465 6d70 6c61 7465 7328  omial_templates(
+0001cb80: 7465 6d70 6c2e 7761 7665 2c20 7265 665f  templ.wave, ref_
+0001cb90: 7761 7665 3d72 6566 5f77 6176 652c 0a20  wave=ref_wave,. 
+0001cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbc0: 2020 6f72 6465 723d 6f72 6465 722c 206c    order=order, l
+0001cbd0: 696e 653d 4661 6c73 6529 0a0a 2020 2020  ine=False)..    
+0001cbe0: 7074 656d 7020 3d20 4f72 6465 7265 6444  ptemp = OrderedD
+0001cbf0: 6963 7428 290a 0a20 2020 2066 6f72 2069  ict()..    for i
+0001cc00: 2c20 7420 696e 2065 6e75 6d65 7261 7465  , t in enumerate
+0001cc10: 2874 7370 6c69 6e65 293a 0a20 2020 2020  (tspline):.     
+0001cc20: 2020 206e 616d 6520 3d20 277b 307d 2070     name = '{0} p
+0001cc30: 6f6c 7920 7b31 7d27 2e66 6f72 6d61 7428  oly {1}'.format(
+0001cc40: 7465 6d70 6c2e 6e61 6d65 2c20 6929 0a20  templ.name, i). 
+0001cc50: 2020 2020 2020 2070 7465 6d70 5b6e 616d         ptemp[nam
+0001cc60: 655d 203d 2075 7469 6c73 2e53 7065 6374  e] = utils.Spect
+0001cc70: 7275 6d54 656d 706c 6174 6528 7761 7665  rumTemplate(wave
+0001cc80: 3d74 656d 706c 2e77 6176 652c 0a20 2020  =templ.wave,.   
+0001cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cca0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0001ccb0: 7578 3d74 656d 706c 2e66 6c75 782a 7473  ux=templ.flux*ts
+0001ccc0: 706c 696e 655b 745d 2e66 6c75 782c 0a20  pline[t].flux,. 
+0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ccf0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
+0001cd00: 2020 2070 7465 6d70 5b6e 616d 655d 2e72     ptemp[name].r
+0001cd10: 6566 5f77 6176 6520 3d20 7265 665f 7761  ef_wave = ref_wa
+0001cd20: 7665 0a0a 2020 2020 7074 656d 702e 7265  ve..    ptemp.re
+0001cd30: 665f 7761 7665 203d 2072 6566 5f77 6176  f_wave = ref_wav
+0001cd40: 650a 0a20 2020 2072 6574 7572 6e20 7074  e..    return pt
+0001cd50: 656d 700a 0a0a 6465 6620 646f 745f 7465  emp...def dot_te
+0001cd60: 6d70 6c61 7465 7328 636f 6566 6673 2c20  mplates(coeffs, 
+0001cd70: 7465 6d70 6c61 7465 732c 207a 3d30 2c20  templates, z=0, 
+0001cd80: 6d61 785f 523d 3530 3030 2c20 6170 706c  max_R=5000, appl
+0001cd90: 795f 6967 6d3d 5472 7565 293a 0a20 2020  y_igm=True):.   
+0001cda0: 2022 2222 436f 6d70 7574 6520 7465 6d70   """Compute temp
+0001cdb0: 6c61 7465 2073 756d 2061 6e61 6c6f 676f  late sum analogo
+0001cdc0: 7573 2074 6f20 606e 702e 646f 7428 636f  us to `np.dot(co
+0001cdd0: 6566 6673 2c20 7465 6d70 6c61 7465 7329  effs, templates)
+0001cde0: 602e 0a20 2020 2022 2222 0a0a 2020 2020  `..    """..    
+0001cdf0: 6966 206c 656e 2863 6f65 6666 7329 2021  if len(coeffs) !
+0001ce00: 3d20 6c65 6e28 7465 6d70 6c61 7465 7329  = len(templates)
+0001ce10: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+0001ce20: 5661 6c75 6545 7272 6f72 2827 7368 6170  ValueError('shap
+0001ce30: 6573 206f 6620 636f 6566 6673 2028 7b30  es of coeffs ({0
+0001ce40: 7d29 2061 6e64 2074 656d 706c 6174 6573  }) and templates
+0001ce50: 2028 7b31 7d29 2064 6f6e 5c27 7420 6d61   ({1}) don\'t ma
+0001ce60: 7463 6827 2e66 6f72 6d61 7428 6c65 6e28  tch'.format(len(
+0001ce70: 636f 6566 6673 292c 206c 656e 2874 656d  coeffs), len(tem
+0001ce80: 706c 6174 6573 2929 290a 0a20 2020 2023  plates)))..    #
+0001ce90: 2066 6f72 2069 2c20 7465 2069 6e20 656e   for i, te in en
+0001cea0: 756d 6572 6174 6528 7465 6d70 6c61 7465  umerate(template
+0001ceb0: 7329 3a0a 2020 2020 2320 2020 2020 6966  s):.    #     if
+0001cec0: 2069 203d 3d20 303a 0a20 2020 2023 2020   i == 0:.    #  
+0001ced0: 2020 2020 2020 2074 6320 3d20 7465 6d70         tc = temp
+0001cee0: 6c61 7465 735b 7465 5d2e 7a73 6361 6c65  lates[te].zscale
+0001cef0: 287a 2c20 7363 616c 6172 3d63 6f65 6666  (z, scalar=coeff
+0001cf00: 735b 695d 290a 2020 2020 2320 2020 2020  s[i]).    #     
+0001cf10: 2020 2020 746c 203d 2074 656d 706c 6174      tl = templat
+0001cf20: 6573 5b74 655d 2e7a 7363 616c 6528 7a2c  es[te].zscale(z,
+0001cf30: 2073 6361 6c61 723d 636f 6566 6673 5b69   scalar=coeffs[i
+0001cf40: 5d29 0a20 2020 2023 2020 2020 2065 6c73  ]).    #     els
+0001cf50: 653a 0a20 2020 2023 2020 2020 2020 2020  e:.    #        
+0001cf60: 2069 6620 7465 2e73 7461 7274 7377 6974   if te.startswit
+0001cf70: 6828 276c 696e 6527 293a 0a20 2020 2023  h('line'):.    #
+0001cf80: 2020 2020 2020 2020 2020 2020 2074 6320               tc 
+0001cf90: 2b3d 2074 656d 706c 6174 6573 5b74 655d  += templates[te]
+0001cfa0: 2e7a 7363 616c 6528 7a2c 2073 6361 6c61  .zscale(z, scala
+0001cfb0: 723d 302e 290a 2020 2020 2320 2020 2020  r=0.).    #     
+0001cfc0: 2020 2020 656c 7365 3a0a 2020 2020 2320      else:.    # 
+0001cfd0: 2020 2020 2020 2020 2020 2020 7463 202b              tc +
+0001cfe0: 3d20 7465 6d70 6c61 7465 735b 7465 5d2e  = templates[te].
+0001cff0: 7a73 6361 6c65 287a 2c20 7363 616c 6172  zscale(z, scalar
+0001d000: 3d63 6f65 6666 735b 695d 290a 2020 2020  =coeffs[i]).    
+0001d010: 230a 2020 2020 2320 2020 2020 2020 2020  #.    #         
+0001d020: 746c 202b 3d20 7465 6d70 6c61 7465 735b  tl += templates[
+0001d030: 7465 5d2e 7a73 6361 6c65 287a 2c20 7363  te].zscale(z, sc
+0001d040: 616c 6172 3d63 6f65 6666 735b 695d 290a  alar=coeffs[i]).
+0001d050: 2020 2020 7761 7665 2c20 666c 7578 5f61      wave, flux_a
+0001d060: 7272 2c20 6973 5f6c 696e 6520 3d20 6172  rr, is_line = ar
+0001d070: 7261 795f 7465 6d70 6c61 7465 7328 7465  ray_templates(te
+0001d080: 6d70 6c61 7465 732c 206d 6178 5f52 3d6d  mplates, max_R=m
+0001d090: 6178 5f52 2c20 7a3d 7a2c 0a20 2020 2020  ax_R, z=z,.     
+0001d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d0c0: 2020 2020 2020 2020 2061 7070 6c79 5f69           apply_i
+0001d0d0: 676d 3d61 7070 6c79 5f69 676d 290a 0a20  gm=apply_igm).. 
+0001d0e0: 2020 2023 2023 2049 474d 0a20 2020 2023     # # IGM.    #
+0001d0f0: 2069 6620 6170 706c 795f 6967 6d3a 0a20   if apply_igm:. 
+0001d100: 2020 2023 2020 2020 2074 7279 3a0a 2020     #     try:.  
+0001d110: 2020 2320 2020 2020 2020 2020 696d 706f    #         impo
+0001d120: 7274 2065 617a 792e 6967 6d0a 2020 2020  rt eazy.igm.    
+0001d130: 2320 2020 2020 2020 2020 4947 4d20 3d20  #         IGM = 
+0001d140: 6561 7a79 2e69 676d 2e49 6e6f 7565 3134  eazy.igm.Inoue14
+0001d150: 2829 0a20 2020 2023 0a20 2020 2023 2020  ().    #.    #  
+0001d160: 2020 2020 2020 206c 796c 696d 203d 2077         lylim = w
+0001d170: 6176 6520 3c20 3132 3530 0a20 2020 2023  ave < 1250.    #
+0001d180: 2020 2020 2020 2020 2069 676d 7a20 3d20           igmz = 
+0001d190: 6e70 2e6f 6e65 735f 6c69 6b65 2877 6176  np.ones_like(wav
+0001d1a0: 6529 0a20 2020 2023 2020 2020 2020 2020  e).    #        
+0001d1b0: 2069 676d 7a5b 6c79 6c69 6d5d 203d 2049   igmz[lylim] = I
+0001d1c0: 474d 2e66 756c 6c5f 4947 4d28 7a2c 2077  GM.full_IGM(z, w
+0001d1d0: 6176 655b 6c79 6c69 6d5d 2a28 312b 7a29  ave[lylim]*(1+z)
+0001d1e0: 290a 2020 2020 2320 2020 2020 6578 6365  ).    #     exce
+0001d1f0: 7074 3a0a 2020 2020 2320 2020 2020 2020  pt:.    #       
+0001d200: 2020 6967 6d7a 203d 2031 2e0a 2020 2020    igmz = 1..    
+0001d210: 2320 656c 7365 3a0a 2020 2020 2320 2020  # else:.    #   
+0001d220: 2020 6967 6d7a 203d 2031 2e0a 2020 2020    igmz = 1..    
+0001d230: 230a 2020 2020 2320 6973 5f6f 6273 6672  #.    # is_obsfr
+0001d240: 616d 6520 3d20 6e70 2e61 7272 6179 285b  ame = np.array([
+0001d250: 742e 7370 6c69 7428 295b 305d 2069 6e20  t.split()[0] in 
+0001d260: 5b27 6273 706c 272c 2027 7374 6570 275d  ['bspl', 'step']
+0001d270: 2066 6f72 2074 2069 6e20 7465 6d70 6c61   for t in templa
+0001d280: 7465 735d 290a 2020 2020 230a 2020 2020  tes]).    #.    
+0001d290: 2320 666c 7578 5f61 7272 5b7e 6973 5f6f  # flux_arr[~is_o
+0001d2a0: 6273 6672 616d 652c 3a5d 202a 3d20 6967  bsframe,:] *= ig
+0001d2b0: 6d7a 0a20 2020 2023 0a20 2020 2023 2023  mz.    #.    # #
+0001d2c0: 204d 756c 7469 706c 7920 7370 6c69 6e65   Multiply spline
+0001d2d0: 3f0a 2020 2020 2320 666f 7220 692c 2074  ?.    # for i, t
+0001d2e0: 2069 6e20 656e 756d 6572 6174 6528 7465   in enumerate(te
+0001d2f0: 6d70 6c61 7465 7329 3a0a 2020 2020 2320  mplates):.    # 
+0001d300: 2020 2020 6966 2027 7370 6c69 6e65 2720      if 'spline' 
+0001d310: 696e 2074 3a0a 2020 2020 2320 2020 2020  in t:.    #     
+0001d320: 2020 2020 666f 7220 6a2c 2074 6a20 696e      for j, tj in
+0001d330: 2065 6e75 6d65 7261 7465 2874 656d 706c   enumerate(templ
+0001d340: 6174 6573 293a 0a20 2020 2023 2020 2020  ates):.    #    
+0001d350: 2020 2020 2020 2020 2069 6620 6973 5f6f           if is_o
+0001d360: 6273 6672 616d 655b 6a5d 3a0a 2020 2020  bsframe[j]:.    
+0001d370: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+0001d380: 2020 7072 696e 7428 2773 6361 6c65 2073    print('scale s
+0001d390: 706c 696e 653a 207b 307d 2078 207b 317d  pline: {0} x {1}
+0001d3a0: 272e 666f 726d 6174 2874 6a2c 2074 2929  '.format(tj, t))
+0001d3b0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
+0001d3c0: 2020 2020 2020 2066 6c75 785f 6172 725b         flux_arr[
+0001d3d0: 6a2c 3a5d 202a 3d20 666c 7578 5f61 7272  j,:] *= flux_arr
+0001d3e0: 5b69 2c3a 5d0a 0a20 2020 2023 2043 6f6e  [i,:]..    # Con
+0001d3f0: 7469 6e75 756d 0a20 2020 2063 6f6e 7420  tinuum.    cont 
+0001d400: 3d20 6e70 2e64 6f74 2863 6f65 6666 732a  = np.dot(coeffs*
+0001d410: 287e 6973 5f6c 696e 6529 2c20 666c 7578  (~is_line), flux
+0001d420: 5f61 7272 290a 2020 2020 7463 203d 2053  _arr).    tc = S
+0001d430: 7065 6374 7275 6d54 656d 706c 6174 6528  pectrumTemplate(
+0001d440: 7761 7665 3d77 6176 652c 2066 6c75 783d  wave=wave, flux=
+0001d450: 636f 6e74 292e 7a73 6361 6c65 287a 2c20  cont).zscale(z, 
+0001d460: 6170 706c 795f 6967 6d3d 4661 6c73 6529  apply_igm=False)
+0001d470: 0a0a 2020 2020 2320 4675 6c6c 2074 656d  ..    # Full tem
+0001d480: 706c 6174 650a 2020 2020 6c69 6e65 203d  plate.    line =
+0001d490: 206e 702e 646f 7428 636f 6566 6673 2c20   np.dot(coeffs, 
+0001d4a0: 666c 7578 5f61 7272 290a 2020 2020 746c  flux_arr).    tl
+0001d4b0: 203d 2053 7065 6374 7275 6d54 656d 706c   = SpectrumTempl
+0001d4c0: 6174 6528 7761 7665 3d77 6176 652c 2066  ate(wave=wave, f
+0001d4d0: 6c75 783d 6c69 6e65 292e 7a73 6361 6c65  lux=line).zscale
+0001d4e0: 287a 2c20 6170 706c 795f 6967 6d3d 4661  (z, apply_igm=Fa
+0001d4f0: 6c73 6529 0a0a 2020 2020 7265 7475 726e  lse)..    return
+0001d500: 2074 632c 2074 6c0a 0a0a 6465 6620 6172   tc, tl...def ar
+0001d510: 7261 795f 7465 6d70 6c61 7465 7328 7465  ray_templates(te
+0001d520: 6d70 6c61 7465 732c 2077 6176 653d 4e6f  mplates, wave=No
+0001d530: 6e65 2c20 6d61 785f 523d 3530 3030 2c20  ne, max_R=5000, 
+0001d540: 7a3d 302c 2061 7070 6c79 5f69 676d 3d46  z=0, apply_igm=F
+0001d550: 616c 7365 293a 0a20 2020 2022 2222 5265  alse):.    """Re
+0001d560: 7475 726e 2061 6e20 6172 7261 7920 7665  turn an array ve
+0001d570: 7273 696f 6e20 6f66 2074 6865 2074 656d  rsion of the tem
+0001d580: 706c 6174 6573 2074 6861 7420 6861 7665  plates that have
+0001d590: 2061 6c6c 2062 6565 6e20 696e 7465 7270   all been interp
+0001d5a0: 6f6c 6174 6564 2074 6f20 7468 6520 7361  olated to the sa
+0001d5b0: 6d65 2067 7269 642e 0a0a 0a20 2020 2050  me grid....    P
+0001d5c0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+0001d5d0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2074 656d  --------.    tem
+0001d5e0: 706c 6174 6573 203a 2064 6963 7469 6f6e  plates : diction
+0001d5f0: 6172 7920 6f66 2060 7e67 7269 7a6c 692e  ary of `~grizli.
+0001d600: 7574 696c 732e 5370 6563 7472 756d 5465  utils.SpectrumTe
+0001d610: 6d70 6c61 7465 6020 6f62 6a65 6374 730a  mplate` objects.
+0001d620: 2020 2020 2020 2020 4f75 7470 7574 2074          Output t
+0001d630: 656d 706c 6174 6520 6c69 7374 2077 6974  emplate list wit
+0001d640: 6820 604e 5445 4d50 6020 7465 6d70 6c61  h `NTEMP` templa
+0001d650: 7465 732e 0a0a 2020 2020 6d61 785f 5220  tes...    max_R 
+0001d660: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
+0001d670: 4d61 7869 6d75 6d20 7370 6563 7472 616c  Maximum spectral
+0001d680: 2072 6573 6f6c 7574 696f 6e20 6f66 2074   resolution of t
+0001d690: 6865 2072 6567 7269 6464 6564 2074 656d  he regridded tem
+0001d6a0: 706c 6174 6573 2e0a 0a20 2020 207a 203a  plates...    z :
+0001d6b0: 2066 6c6f 6174 0a20 2020 2020 2020 2052   float.        R
+0001d6c0: 6564 7368 6966 7420 7768 6572 6520 746f  edshift where to
+0001d6d0: 2065 7661 6c75 6174 6520 7468 6520 7465   evaluate the te
+0001d6e0: 6d70 6c61 7465 732e 2020 4275 7420 6e6f  mplates.  But no
+0001d6f0: 7465 2074 6861 7420 7468 6973 2069 7320  te that this is 
+0001d700: 6f6e 6c79 0a20 2020 2020 2020 2075 7365  only.        use
+0001d710: 6420 746f 2073 6869 6674 2074 656d 706c  d to shift templ
+0001d720: 6174 6573 2070 726f 6475 6365 6420 6279  ates produced by
+0001d730: 2060 6273 706c 696e 655f 7465 6d70 6c61   `bspline_templa
+0001d740: 7465 7360 2c20 7768 6963 6820 6172 650a  tes`, which are.
+0001d750: 2020 2020 2020 2020 6465 6669 6e65 6420          defined 
+0001d760: 696e 2074 6865 206f 6273 6572 7665 6420  in the observed 
+0001d770: 6672 616d 652e 0a0a 2020 2020 5265 7475  frame...    Retu
+0001d780: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+0001d790: 2020 2020 7761 7665 203a 2060 7e6e 756d      wave : `~num
+0001d7a0: 7079 2e6e 6461 7272 6179 602c 2064 696d  py.ndarray`, dim
+0001d7b0: 656e 7369 6f6e 7320 6028 4e4c 2c29 600a  ensions `(NL,)`.
+0001d7c0: 2020 2020 2020 2020 4172 7261 7920 636f          Array co
+0001d7d0: 6e74 6169 6e69 6e67 2075 6e69 7175 6520  ntaining unique 
+0001d7e0: 7761 7665 6c65 6e67 7468 732e 0a0a 2020  wavelengths...  
+0001d7f0: 2020 666c 7578 5f61 7272 203a 2060 7e6e    flux_arr : `~n
+0001d800: 756d 7079 2e6e 6461 7272 6179 602c 2064  umpy.ndarray`, d
+0001d810: 696d 656e 7369 6f6e 7320 6028 4e54 454d  imensions `(NTEM
+0001d820: 502c 204e 4c29 600a 2020 2020 2020 2020  P, NL)`.        
+0001d830: 4172 7261 7920 636f 6e74 6169 6e69 6e67  Array containing
+0001d840: 2074 6865 2074 656d 706c 6174 6520 666c   the template fl
+0001d850: 7578 6573 2069 6e74 6572 706f 6c61 7465  uxes interpolate
+0001d860: 6420 6174 2060 7761 7665 602e 0a0a 2020  d at `wave`...  
+0001d870: 2020 6973 5f6c 696e 6520 3a20 607e 6e75    is_line : `~nu
+0001d880: 6d70 792e 6e64 6172 7261 7960 0a20 2020  mpy.ndarray`.   
+0001d890: 2020 2020 2042 6f6f 6c65 616e 2061 7272       Boolean arr
+0001d8a0: 6179 2069 6e64 6963 6174 696e 6720 656d  ay indicating em
+0001d8b0: 6973 7369 6f6e 206c 696e 6520 7465 6d70  ission line temp
+0001d8c0: 6c61 7465 7320 2874 6865 206b 6579 2069  lates (the key i
+0001d8d0: 6e20 7468 650a 2020 2020 2020 2020 7465  n the.        te
+0001d8e0: 6d70 6c61 7465 2064 6963 7469 6f6e 6172  mplate dictionar
+0001d8f0: 7920 7374 6172 7473 2077 6974 6820 226c  y starts with "l
+0001d900: 696e 6520 2229 2e0a 0a20 2020 2022 2222  ine ")...    """
+0001d910: 0a20 2020 2066 726f 6d20 6772 697a 6c69  .    from grizli
+0001d920: 2e75 7469 6c73 5f63 2e69 6e74 6572 7020  .utils_c.interp 
+0001d930: 696d 706f 7274 2069 6e74 6572 705f 636f  import interp_co
+0001d940: 6e73 6572 7665 5f63 0a0a 2020 2020 6966  nserve_c..    if
+0001d950: 2077 6176 6520 6973 204e 6f6e 653a 0a20   wave is None:. 
+0001d960: 2020 2020 2020 2077 7374 6163 6b20 3d20         wstack = 
+0001d970: 5b5d 0a20 2020 2020 2020 2066 6f72 2074  [].        for t
+0001d980: 2069 6e20 7465 6d70 6c61 7465 733a 0a20   in templates:. 
+0001d990: 2020 2020 2020 2020 2020 2069 6620 742e             if t.
+0001d9a0: 7370 6c69 7428 295b 305d 2069 6e20 5b27  split()[0] in ['
+0001d9b0: 6273 706c 272c 2027 7374 6570 272c 2027  bspl', 'step', '
+0001d9c0: 706f 6c79 275d 3a0a 2020 2020 2020 2020  poly']:.        
+0001d9d0: 2020 2020 2020 2020 7773 7461 636b 2e61          wstack.a
+0001d9e0: 7070 656e 6428 7465 6d70 6c61 7465 735b  ppend(templates[
+0001d9f0: 745d 2e77 6176 652f 2831 2b7a 2929 0a20  t].wave/(1+z)). 
+0001da00: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001da10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001da20: 2077 7374 6163 6b2e 6170 7065 6e64 2874   wstack.append(t
+0001da30: 656d 706c 6174 6573 5b74 5d2e 7761 7665  emplates[t].wave
+0001da40: 290a 0a20 2020 2020 2020 2077 6176 6520  )..        wave 
+0001da50: 3d20 6e70 2e75 6e69 7175 6528 6e70 2e68  = np.unique(np.h
+0001da60: 7374 6163 6b28 7773 7461 636b 2929 0a0a  stack(wstack))..
+0001da70: 2020 2020 636c 6970 7375 6d2c 2069 7465      clipsum, ite
+0001da80: 7220 3d20 312c 2030 0a20 2020 2077 6869  r = 1, 0.    whi
+0001da90: 6c65 2028 636c 6970 7375 6d20 3e20 3029  le (clipsum > 0)
+0001daa0: 2026 2028 6974 6572 203c 2031 3029 3a0a   & (iter < 10):.
+0001dab0: 2020 2020 2020 2020 636c 6970 203d 206e          clip = n
+0001dac0: 702e 6772 6164 6965 6e74 2877 6176 6529  p.gradient(wave)
+0001dad0: 2f77 6176 6520 3c20 312f 6d61 785f 520a  /wave < 1/max_R.
+0001dae0: 2020 2020 2020 2020 6964 7820 3d20 6e70          idx = np
+0001daf0: 2e61 7261 6e67 6528 6c65 6e28 7761 7665  .arange(len(wave
+0001db00: 2929 5b63 6c69 705d 0a20 2020 2020 2020  ))[clip].       
+0001db10: 2077 6176 655b 6964 785b 3a3a 325d 5d20   wave[idx[::2]] 
+0001db20: 3d20 6e70 2e6e 616e 0a20 2020 2020 2020  = np.nan.       
+0001db30: 2077 6176 6520 3d20 7761 7665 5b6e 702e   wave = wave[np.
+0001db40: 6973 6669 6e69 7465 2877 6176 6529 5d0a  isfinite(wave)].
+0001db50: 2020 2020 2020 2020 6974 6572 202b 3d20          iter += 
+0001db60: 310a 2020 2020 2020 2020 636c 6970 7375  1.        clipsu
+0001db70: 6d20 3d20 636c 6970 2e73 756d 2829 0a20  m = clip.sum(). 
+0001db80: 2020 2020 2020 2023 7072 696e 7428 6974         #print(it
+0001db90: 6572 2c20 636c 6970 7375 6d29 0a0a 2020  er, clipsum)..  
+0001dba0: 2020 4e54 454d 5020 3d20 6c65 6e28 7465    NTEMP = len(te
+0001dbb0: 6d70 6c61 7465 7329 0a20 2020 2066 6c75  mplates).    flu
+0001dbc0: 785f 6172 7220 3d20 6e70 2e7a 6572 6f73  x_arr = np.zeros
+0001dbd0: 2828 4e54 454d 502c 206c 656e 2877 6176  ((NTEMP, len(wav
+0001dbe0: 6529 2929 0a0a 2020 2020 666f 7220 692c  e)))..    for i,
+0001dbf0: 2074 2069 6e20 656e 756d 6572 6174 6528   t in enumerate(
+0001dc00: 7465 6d70 6c61 7465 7329 3a0a 2020 2020  templates):.    
+0001dc10: 2020 2020 6966 2074 2e73 706c 6974 2829      if t.split()
+0001dc20: 5b30 5d20 696e 205b 2762 7370 6c27 2c20  [0] in ['bspl', 
+0001dc30: 2773 7465 7027 2c20 2770 6f6c 7927 5d3a  'step', 'poly']:
+0001dc40: 0a20 2020 2020 2020 2020 2020 2066 6c75  .            flu
+0001dc50: 785f 6172 725b 692c 203a 5d20 3d20 696e  x_arr[i, :] = in
+0001dc60: 7465 7270 5f63 6f6e 7365 7276 655f 6328  terp_conserve_c(
+0001dc70: 7761 7665 2c20 7465 6d70 6c61 7465 735b  wave, templates[
+0001dc80: 745d 2e77 6176 652f 2831 2b7a 292c 0a20  t].wave/(1+z),. 
+0001dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dcb0: 2020 2020 2020 2020 2074 656d 706c 6174           templat
+0001dcc0: 6573 5b74 5d2e 666c 7578 2a28 312b 7a29  es[t].flux*(1+z)
+0001dcd0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001dce0: 2020 2020 2020 2020 2020 2020 6966 2068              if h
+0001dcf0: 6173 6174 7472 2874 656d 706c 6174 6573  asattr(templates
+0001dd00: 5b74 5d2c 2027 666c 7578 5f66 6c61 6d27  [t], 'flux_flam'
+0001dd10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001dd20: 2020 2023 2052 6564 7368 6966 742d 6465     # Redshift-de
+0001dd30: 7065 6e64 656e 7420 6561 7a79 2d70 7920  pendent eazy-py 
+0001dd40: 5465 6d70 6c61 7465 0a20 2020 2020 2020  Template.       
+0001dd50: 2020 2020 2020 2020 2066 6c75 785f 6172           flux_ar
+0001dd60: 725b 692c 203a 5d20 3d20 696e 7465 7270  r[i, :] = interp
+0001dd70: 5f63 6f6e 7365 7276 655f 6328 7761 7665  _conserve_c(wave
+0001dd80: 2c20 7465 6d70 6c61 7465 735b 745d 2e77  , templates[t].w
+0001dd90: 6176 652c 0a20 2020 2020 2020 2020 2020  ave,.           
+0001dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001ddc0: 656d 706c 6174 6573 5b74 5d2e 666c 7578  emplates[t].flux
+0001ddd0: 5f66 6c61 6d28 7a3d 7a29 290a 2020 2020  _flam(z=z)).    
+0001dde0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001ddf0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0001de00: 7578 5f61 7272 5b69 2c20 3a5d 203d 2069  ux_arr[i, :] = i
+0001de10: 6e74 6572 705f 636f 6e73 6572 7665 5f63  nterp_conserve_c
+0001de20: 2877 6176 652c 2074 656d 706c 6174 6573  (wave, templates
+0001de30: 5b74 5d2e 7761 7665 2c0a 2020 2020 2020  [t].wave,.      
+0001de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de60: 2020 2020 7465 6d70 6c61 7465 735b 745d      templates[t]
+0001de70: 2e66 6c75 7829 0a0a 2020 2020 6973 5f6c  .flux)..    is_l
+0001de80: 696e 6520 3d20 6e70 2e61 7272 6179 285b  ine = np.array([
+0001de90: 742e 7374 6172 7473 7769 7468 2827 6c69  t.startswith('li
+0001dea0: 6e65 2027 2920 666f 7220 7420 696e 2074  ne ') for t in t
+0001deb0: 656d 706c 6174 6573 5d29 0a0a 2020 2020  emplates])..    
+0001dec0: 2320 4947 4d0a 2020 2020 6966 2061 7070  # IGM.    if app
+0001ded0: 6c79 5f69 676d 3a0a 2020 2020 2020 2020  ly_igm:.        
+0001dee0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0001def0: 2069 6d70 6f72 7420 6561 7a79 2e69 676d   import eazy.igm
+0001df00: 0a20 2020 2020 2020 2020 2020 2049 474d  .            IGM
+0001df10: 203d 2065 617a 792e 6967 6d2e 496e 6f75   = eazy.igm.Inou
+0001df20: 6531 3428 290a 0a20 2020 2020 2020 2020  e14()..         
+0001df30: 2020 206c 796c 696d 203d 2077 6176 6520     lylim = wave 
+0001df40: 3c20 3132 3530 0a20 2020 2020 2020 2020  < 1250.         
+0001df50: 2020 2069 676d 7a20 3d20 6e70 2e6f 6e65     igmz = np.one
+0001df60: 735f 6c69 6b65 2877 6176 6529 0a20 2020  s_like(wave).   
+0001df70: 2020 2020 2020 2020 2069 676d 7a5b 6c79           igmz[ly
+0001df80: 6c69 6d5d 203d 2049 474d 2e66 756c 6c5f  lim] = IGM.full_
+0001df90: 4947 4d28 7a2c 2077 6176 655b 6c79 6c69  IGM(z, wave[lyli
+0001dfa0: 6d5d 2a28 312b 7a29 290a 2020 2020 2020  m]*(1+z)).      
+0001dfb0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+0001dfc0: 2020 2020 2020 6967 6d7a 203d 2031 2e0a        igmz = 1..
+0001dfd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001dfe0: 2020 6967 6d7a 203d 2031 2e0a 0a20 2020    igmz = 1...   
+0001dff0: 206f 6273 6e61 6d65 7320 3d20 5b27 6273   obsnames = ['bs
+0001e000: 706c 272c 2027 7374 6570 272c 2027 706f  pl', 'step', 'po
+0001e010: 6c79 275d 0a20 2020 2069 735f 6f62 7366  ly'].    is_obsf
+0001e020: 7261 6d65 203d 206e 702e 6172 7261 7928  rame = np.array(
+0001e030: 5b74 2e73 706c 6974 2829 5b30 5d20 696e  [t.split()[0] in
+0001e040: 206f 6273 6e61 6d65 7320 666f 7220 7420   obsnames for t 
+0001e050: 696e 2074 656d 706c 6174 6573 5d29 0a0a  in templates])..
+0001e060: 2020 2020 666c 7578 5f61 7272 5b7e 6973      flux_arr[~is
+0001e070: 5f6f 6273 6672 616d 652c 203a 5d20 2a3d  _obsframe, :] *=
+0001e080: 2069 676d 7a0a 0a20 2020 2023 204d 756c   igmz..    # Mul
+0001e090: 7469 706c 7920 7370 6c69 6e65 3f0a 2020  tiply spline?.  
+0001e0a0: 2020 666f 7220 692c 2074 2069 6e20 656e    for i, t in en
+0001e0b0: 756d 6572 6174 6528 7465 6d70 6c61 7465  umerate(template
+0001e0c0: 7329 3a0a 2020 2020 2020 2020 6966 2027  s):.        if '
+0001e0d0: 7370 6c69 6e65 2720 696e 2074 3a0a 2020  spline' in t:.  
+0001e0e0: 2020 2020 2020 2020 2020 666f 7220 6a2c            for j,
+0001e0f0: 2074 6a20 696e 2065 6e75 6d65 7261 7465   tj in enumerate
+0001e100: 2874 656d 706c 6174 6573 293a 0a20 2020  (templates):.   
+0001e110: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001e120: 6973 5f6f 6273 6672 616d 655b 6a5d 3a0a  is_obsframe[j]:.
+0001e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e140: 2020 2020 6d61 203d 2066 6c75 785f 6172      ma = flux_ar
+0001e150: 725b 6a2c 203a 5d2e 7375 6d28 290a 2020  r[j, :].sum().  
+0001e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e170: 2020 6d61 203d 206d 6120 6966 206d 6120    ma = ma if ma 
+0001e180: 3e20 3020 656c 7365 2031 0a20 2020 2020  > 0 else 1.     
+0001e190: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0001e1a0: 6120 3d20 310a 0a20 2020 2020 2020 2020  a = 1..         
+0001e1b0: 2020 2020 2020 2020 2020 2066 6c75 785f             flux_
+0001e1c0: 6172 725b 6a2c 203a 5d20 2a3d 2066 6c75  arr[j, :] *= flu
+0001e1d0: 785f 6172 725b 692c 203a 5d2f 6d61 0a0a  x_arr[i, :]/ma..
+0001e1e0: 2020 2020 7265 7475 726e 2077 6176 652c      return wave,
+0001e1f0: 2066 6c75 785f 6172 722c 2069 735f 6c69   flux_arr, is_li
+0001e200: 6e65 0a0a 0a64 6566 2063 6f6d 7075 7465  ne...def compute
+0001e210: 5f65 7175 6976 616c 656e 745f 7769 6474  _equivalent_widt
+0001e220: 6873 2874 656d 706c 6174 6573 2c20 636f  hs(templates, co
+0001e230: 6566 6673 2c20 636f 7661 722c 206d 6178  effs, covar, max
+0001e240: 5f52 3d35 3030 302c 204e 6472 6177 3d31  _R=5000, Ndraw=1
+0001e250: 3030 302c 2073 6565 643d 302c 207a 3d30  000, seed=0, z=0
+0001e260: 2c20 6f62 7365 7276 6564 5f66 7261 6d65  , observed_frame
+0001e270: 3d46 616c 7365 293a 0a20 2020 2022 2222  =False):.    """
+0001e280: 436f 6d70 7574 6520 7465 6d70 6c61 7465  Compute template
+0001e290: 2d66 6974 2065 6d69 7373 696f 6e20 6c69  -fit emission li
+0001e2a0: 6e65 2065 7175 6976 616c 656e 7420 7769  ne equivalent wi
+0001e2b0: 6474 6873 0a0a 2020 2020 5061 7261 6d65  dths..    Parame
+0001e2c0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+0001e2d0: 2d2d 2d0a 2020 2020 7465 6d70 6c61 7465  ---.    template
+0001e2e0: 7320 3a20 6469 6374 696f 6e61 7279 206f  s : dictionary o
+0001e2f0: 6620 607e 6772 697a 6c69 2e75 7469 6c73  f `~grizli.utils
+0001e300: 2e53 7065 6374 7275 6d54 656d 706c 6174  .SpectrumTemplat
+0001e310: 6560 206f 626a 6563 7473 0a20 2020 2020  e` objects.     
+0001e320: 2020 204f 7574 7075 7420 7465 6d70 6c61     Output templa
+0001e330: 7465 206c 6973 7420 7769 7468 2060 4e54  te list with `NT
+0001e340: 454d 5060 2074 656d 706c 6174 6573 2e0a  EMP` templates..
+0001e350: 0a20 2020 2063 6f65 6666 7320 3a20 607e  .    coeffs : `~
+0001e360: 6e75 6d70 792e 6e64 6172 7261 7960 2c20  numpy.ndarray`, 
+0001e370: 6469 6d65 6e73 696f 6e73 2028 604e 5445  dimensions (`NTE
+0001e380: 4d50 6029 0a20 2020 2020 2020 2046 6974  MP`).        Fit
+0001e390: 2063 6f65 6666 6963 6965 6e74 730a 0a20   coefficients.. 
+0001e3a0: 2020 2063 6f76 6172 203a 2020 607e 6e75     covar :  `~nu
+0001e3b0: 6d70 792e 6e64 6172 7261 7960 2c20 6469  mpy.ndarray`, di
+0001e3c0: 6d65 6e73 696f 6e73 2028 604e 5445 4d50  mensions (`NTEMP
+0001e3d0: 602c 2060 4e54 454d 5060 290a 2020 2020  `, `NTEMP`).    
+0001e3e0: 2020 2020 436f 7661 7269 616e 6365 206d      Covariance m
+0001e3f0: 6174 7269 780a 0a20 2020 206d 6178 5f52  atrix..    max_R
+0001e400: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
+0001e410: 204d 6178 696d 756d 2073 7065 6374 7261   Maximum spectra
+0001e420: 6c20 7265 736f 6c75 7469 6f6e 206f 6620  l resolution of 
+0001e430: 7468 6520 7265 6772 6964 6465 6420 7465  the regridded te
+0001e440: 6d70 6c61 7465 732e 0a0a 2020 2020 4e64  mplates...    Nd
+0001e450: 7261 7720 3a20 696e 740a 2020 2020 2020  raw : int.      
+0001e460: 2020 4e75 6d62 6572 206f 6620 7261 6e64    Number of rand
+0001e470: 6f6d 2064 7261 7773 2074 6f20 6578 7472  om draws to extr
+0001e480: 6163 7420 6672 6f6d 2074 6865 2063 6f76  act from the cov
+0001e490: 6172 6961 6e63 6520 6d61 7472 6978 0a0a  ariance matrix..
+0001e4a0: 2020 2020 7365 6564 203a 2070 6f73 6974      seed : posit
+0001e4b0: 6976 6520 696e 740a 2020 2020 2020 2020  ive int.        
+0001e4c0: 5261 6e64 6f6d 206e 756d 6265 7220 7365  Random number se
+0001e4d0: 6564 2074 6f20 7072 6f64 7563 6520 7265  ed to produce re
+0001e4e0: 7065 6174 6962 6c65 2072 6573 756c 7473  peatible results
+0001e4f0: 2e20 4966 2060 4e6f 6e65 602c 2074 6865  . If `None`, the
+0001e500: 6e0a 2020 2020 2020 2020 7573 6520 6465  n.        use de
+0001e510: 6661 756c 7420 7374 6174 652e 0a0a 2020  fault state...  
+0001e520: 2020 7a20 3a20 666c 6f61 740a 2020 2020    z : float.    
+0001e530: 2020 2020 5265 6473 6869 6674 2077 6865      Redshift whe
+0001e540: 7265 2074 6865 2066 6974 2069 7320 6576  re the fit is ev
+0001e550: 616c 7561 7465 640a 0a20 2020 206f 6273  aluated..    obs
+0001e560: 6572 7665 645f 6672 616d 6d65 203a 2062  erved_framme : b
+0001e570: 6f6f 6c0a 2020 2020 2020 2020 4966 2074  ool.        If t
+0001e580: 7275 652c 2074 6865 6e20 636f 6d70 7574  rue, then comput
+0001e590: 6564 2045 5773 2061 7265 206f 6273 6572  ed EWs are obser
+0001e5a0: 7665 6420 6672 616d 652c 206f 7468 6572  ved frame, other
+0001e5b0: 7769 7365 2074 6865 7920 6172 650a 2020  wise they are.  
+0001e5c0: 2020 2020 2020 7265 7374 2066 7261 6d65        rest frame
+0001e5d0: 2061 7420 7265 6473 6869 6674 2060 7a60   at redshift `z`
+0001e5e0: 2e0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+0001e5f0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2045     -------.    E
+0001e600: 5764 6963 7420 3a20 6469 6374 0a20 2020  Wdict : dict.   
+0001e610: 2020 2020 2044 6963 7469 6f6e 6172 7920       Dictionary 
+0001e620: 6f66 205b 3136 2c20 3530 2c20 3834 7468  of [16, 50, 84th
+0001e630: 5d20 7065 7263 656e 7469 6c65 7320 6f66  ] percentiles of
+0001e640: 2074 6865 206c 696e 6520 4557 2064 6973   the line EW dis
+0001e650: 7472 6962 7574 696f 6e73 2e0a 0a20 2020  tributions...   
+0001e660: 2022 2222 0a0a 2020 2020 2320 4172 7261   """..    # Arra
+0001e670: 7920 7665 7273 696f 6e73 206f 6620 7468  y versions of th
+0001e680: 6520 7465 6d70 6c61 7465 730a 2020 2020  e templates.    
+0001e690: 7761 7665 2c20 666c 7578 5f61 7272 2c20  wave, flux_arr, 
+0001e6a0: 6973 5f6c 696e 6520 3d20 6172 7261 795f  is_line = array_
+0001e6b0: 7465 6d70 6c61 7465 7328 7465 6d70 6c61  templates(templa
+0001e6c0: 7465 732c 206d 6178 5f52 3d6d 6178 5f52  tes, max_R=max_R
+0001e6d0: 2c20 7a3d 7a29 0a20 2020 206b 6579 7320  , z=z).    keys 
+0001e6e0: 3d20 6e70 2e61 7272 6179 286c 6973 7428  = np.array(list(
+0001e6f0: 7465 6d70 6c61 7465 732e 6b65 7973 2829  templates.keys()
+0001e700: 2929 0a0a 2020 2020 4557 6469 6374 203d  ))..    EWdict =
+0001e710: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
+0001e720: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+0001e730: 7973 5b69 735f 6c69 6e65 5d3a 0a20 2020  ys[is_line]:.   
+0001e740: 2020 2020 2045 5764 6963 745b 6b65 795d       EWdict[key]
+0001e750: 203d 2028 302e 2c20 302e 2c20 302e 290a   = (0., 0., 0.).
+0001e760: 0a20 2020 2023 204f 6e6c 7920 776f 7272  .    # Only worr
+0001e770: 7920 6162 6f75 7420 7465 6d70 6c61 7465  y about template
+0001e780: 7320 7769 7468 206e 6f6e 2d7a 6572 6f20  s with non-zero 
+0001e790: 636f 6566 6669 6369 656e 7473 2c20 7768  coefficients, wh
+0001e7a0: 6963 6820 7368 6f75 6c64 0a20 2020 2023  ich should.    #
+0001e7b0: 2062 6520 6163 636f 756e 7465 6420 666f   be accounted fo
+0001e7c0: 7220 696e 2074 6865 2063 6f76 6172 6961  r in the covaria
+0001e7d0: 6e63 6520 6172 7261 7920 2877 6974 6820  nce array (with 
+0001e7e0: 6765 745f 756e 6365 7274 6169 6e74 6965  get_uncertaintie
+0001e7f0: 733d 3229 0a20 2020 2063 6c69 7020 3d20  s=2).    clip = 
+0001e800: 636f 6566 6673 2021 3d20 300a 2020 2020  coeffs != 0.    
+0001e810: 2320 4e6f 2076 616c 6964 206c 696e 6573  # No valid lines
+0001e820: 0a20 2020 2069 6620 2869 735f 6c69 6e65  .    if (is_line
+0001e830: 2026 2063 6c69 7029 2e73 756d 2829 203d   & clip).sum() =
+0001e840: 3d20 303a 0a20 2020 2020 2020 2072 6574  = 0:.        ret
+0001e850: 7572 6e20 4557 6469 6374 0a0a 2020 2020  urn EWdict..    
+0001e860: 2320 5261 6e64 6f6d 2064 7261 7773 2066  # Random draws f
+0001e870: 726f 6d20 7468 6520 636f 7661 7269 616e  rom the covarian
+0001e880: 6365 206d 6174 7269 780a 2020 2020 636f  ce matrix.    co
+0001e890: 7661 725f 636c 6970 203d 2063 6f76 6172  var_clip = covar
+0001e8a0: 5b63 6c69 702c 203a 5d5b 3a2c 2063 6c69  [clip, :][:, cli
+0001e8b0: 705d 0a20 2020 2069 6620 7365 6564 2069  p].    if seed i
+0001e8c0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001e8d0: 2020 2020 6e70 2e72 616e 646f 6d2e 7365      np.random.se
+0001e8e0: 6564 2873 6565 6429 0a0a 2020 2020 6472  ed(seed)..    dr
+0001e8f0: 6177 7320 3d20 6e70 2e72 616e 646f 6d2e  aws = np.random.
+0001e900: 6d75 6c74 6976 6172 6961 7465 5f6e 6f72  multivariate_nor
+0001e910: 6d61 6c28 636f 6566 6673 5b63 6c69 705d  mal(coeffs[clip]
+0001e920: 2c20 636f 7661 725f 636c 6970 2c20 7369  , covar_clip, si
+0001e930: 7a65 3d4e 6472 6177 290a 0a20 2020 2023  ze=Ndraw)..    #
+0001e940: 2045 7661 6c75 6174 6520 7468 6520 636f   Evaluate the co
+0001e950: 6e74 696e 7575 6d20 6669 7473 2066 726f  ntinuum fits fro
+0001e960: 6d20 7468 6520 6472 6177 730a 2020 2020  m the draws.    
+0001e970: 636f 6e74 696e 7575 6d20 3d20 6e70 2e64  continuum = np.d
+0001e980: 6f74 2864 7261 7773 2a28 7e69 735f 6c69  ot(draws*(~is_li
+0001e990: 6e65 5b63 6c69 705d 292c 2066 6c75 785f  ne[clip]), flux_
+0001e9a0: 6172 725b 636c 6970 2c20 3a5d 290a 0a20  arr[clip, :]).. 
+0001e9b0: 2020 2023 2043 6f6d 7075 7465 2074 6865     # Compute the
+0001e9c0: 2065 6d69 7373 696f 6e20 6c69 6e65 2045   emission line E
+0001e9d0: 5773 0a20 2020 2074 6964 7820 3d20 6e70  Ws.    tidx = np
+0001e9e0: 2e77 6865 7265 2869 735f 6c69 6e65 5b63  .where(is_line[c
+0001e9f0: 6c69 705d 295b 305d 0a20 2020 2066 6f72  lip])[0].    for
+0001ea00: 2069 7820 696e 2074 6964 783a 0a20 2020   ix in tidx:.   
+0001ea10: 2020 2020 206b 6579 203d 206b 6579 735b       key = keys[
+0001ea20: 636c 6970 5d5b 6978 5d0a 0a20 2020 2020  clip][ix]..     
+0001ea30: 2020 2023 204c 696e 6520 7465 6d70 6c61     # Line templa
+0001ea40: 7465 0a20 2020 2020 2020 206c 696e 6520  te.        line 
+0001ea50: 3d20 6e70 2e64 6f74 2864 7261 7773 5b3a  = np.dot(draws[:
+0001ea60: 2c20 6978 5d5b 3a2c 204e 6f6e 655d 2c20  , ix][:, None], 
+0001ea70: 666c 7578 5f61 7272 5b63 6c69 702c 203a  flux_arr[clip, :
+0001ea80: 5d5b 6978 2c20 3a5d 5b4e 6f6e 652c 203a  ][ix, :][None, :
+0001ea90: 5d29 0a0a 2020 2020 2020 2020 2320 5768  ])..        # Wh
+0001eaa0: 6572 6520 6c69 6e65 2074 656d 706c 6174  ere line templat
+0001eab0: 6520 6e6f 6e2d 7a65 726f 0a20 2020 2020  e non-zero.     
+0001eac0: 2020 206d 6173 6b20 3d20 666c 7578 5f61     mask = flux_a
+0001ead0: 7272 5b63 6c69 702c 203a 5d5b 6978 2c20  rr[clip, :][ix, 
+0001eae0: 3a5d 203e 2030 0a20 2020 2020 2020 2065  :] > 0.        e
+0001eaf0: 775f 6920 3d20 6e70 2e74 7261 707a 2828  w_i = np.trapz((
+0001eb00: 6c69 6e65 2f63 6f6e 7469 6e75 756d 295b  line/continuum)[
+0001eb10: 3a2c 206d 6173 6b5d 2c0a 2020 2020 2020  :, mask],.      
+0001eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb30: 2020 7761 7665 5b6d 6173 6b5d 2a28 312b    wave[mask]*(1+
+0001eb40: 7a2a 6f62 7365 7276 6564 5f66 7261 6d65  z*observed_frame
+0001eb50: 292c 2061 7869 733d 3129 0a0a 2020 2020  ), axis=1)..    
+0001eb60: 2020 2020 4557 6469 6374 5b6b 6579 5d20      EWdict[key] 
+0001eb70: 3d20 6e70 2e70 6572 6365 6e74 696c 6528  = np.percentile(
+0001eb80: 6577 5f69 2c20 5b31 362e 2c20 3530 2e2c  ew_i, [16., 50.,
+0001eb90: 2038 342e 5d29 0a0a 2020 2020 7265 7475   84.])..    retu
+0001eba0: 726e 2045 5764 6963 740a 0a23 2323 2323  rn EWdict..#####
+0001ebb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ebc0: 0a23 2050 686f 746f 6d65 7472 7920 6672  .# Photometry fr
+0001ebd0: 6f6d 2056 697a 6965 7220 7461 626c 6573  om Vizier tables
+0001ebe0: 0a0a 0a23 2043 4648 544c 530a 4346 4854  ...# CFHTLS.CFHT
+0001ebf0: 4c53 5f57 5f56 495a 4945 5220 3d20 2749  LS_W_VIZIER = 'I
+0001ec00: 492f 3331 372f 6366 6874 6c73 5f77 270a  I/317/cfhtls_w'.
+0001ec10: 4346 4854 4c53 5f57 5f42 414e 4453 203d  CFHTLS_W_BANDS =
+0001ec20: 204f 7264 6572 6564 4469 6374 285b 2827   OrderedDict([('
+0001ec30: 6366 6874 5f6d 6567 615f 7527 2c20 5b27  cfht_mega_u', ['
+0001ec40: 756d 6167 272c 2027 655f 756d 6167 275d  umag', 'e_umag']
+0001ec50: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec70: 2827 6366 6874 5f6d 6567 615f 6727 2c20  ('cfht_mega_g', 
+0001ec80: 5b27 676d 6167 272c 2027 655f 676d 6167  ['gmag', 'e_gmag
+0001ec90: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
+0001eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ecb0: 2020 2827 6366 6874 5f6d 6567 615f 7227    ('cfht_mega_r'
+0001ecc0: 2c20 5b27 726d 6167 272c 2027 655f 726d  , ['rmag', 'e_rm
+0001ecd0: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
+0001ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ecf0: 2020 2020 2827 6366 6874 5f6d 6567 615f      ('cfht_mega_
+0001ed00: 6927 2c20 5b27 696d 6167 272c 2027 655f  i', ['imag', 'e_
+0001ed10: 696d 6167 275d 292c 0a20 2020 2020 2020  imag']),.       
+0001ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed30: 2020 2020 2020 2827 6366 6874 5f6d 6567        ('cfht_meg
+0001ed40: 615f 7a27 2c20 5b27 7a6d 6167 272c 2027  a_z', ['zmag', '
+0001ed50: 655f 7a6d 6167 275d 295d 290a 0a43 4648  e_zmag'])])..CFH
+0001ed60: 544c 535f 445f 5649 5a49 4552 203d 2027  TLS_D_VIZIER = '
+0001ed70: 4949 2f33 3137 2f63 6668 746c 735f 6427  II/317/cfhtls_d'
+0001ed80: 0a43 4648 544c 535f 445f 4241 4e44 5320  .CFHTLS_D_BANDS 
+0001ed90: 3d20 4f72 6465 7265 6444 6963 7428 5b28  = OrderedDict([(
+0001eda0: 2763 6668 745f 6d65 6761 5f75 272c 205b  'cfht_mega_u', [
+0001edb0: 2775 6d61 6727 2c20 2765 5f75 6d61 6727  'umag', 'e_umag'
+0001edc0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0001edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ede0: 2028 2763 6668 745f 6d65 6761 5f67 272c   ('cfht_mega_g',
+0001edf0: 205b 2767 6d61 6727 2c20 2765 5f67 6d61   ['gmag', 'e_gma
+0001ee00: 6727 5d29 2c0a 2020 2020 2020 2020 2020  g']),.          
+0001ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee20: 2020 2028 2763 6668 745f 6d65 6761 5f72     ('cfht_mega_r
+0001ee30: 272c 205b 2772 6d61 6727 2c20 2765 5f72  ', ['rmag', 'e_r
+0001ee40: 6d61 6727 5d29 2c0a 2020 2020 2020 2020  mag']),.        
+0001ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee60: 2020 2020 2028 2763 6668 745f 6d65 6761       ('cfht_mega
+0001ee70: 5f69 272c 205b 2769 6d61 6727 2c20 2765  _i', ['imag', 'e
+0001ee80: 5f69 6d61 6727 5d29 2c0a 2020 2020 2020  _imag']),.      
+0001ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eea0: 2020 2020 2020 2028 2763 6668 745f 6d65         ('cfht_me
+0001eeb0: 6761 5f7a 272c 205b 277a 6d61 6727 2c20  ga_z', ['zmag', 
+0001eec0: 2765 5f7a 6d61 6727 5d29 5d29 0a0a 2320  'e_zmag'])])..# 
+0001eed0: 5344 5353 2044 5231 320a 5344 5353 5f44  SDSS DR12.SDSS_D
+0001eee0: 5231 325f 5649 5a49 4552 203d 2027 562f  R12_VIZIER = 'V/
+0001eef0: 3134 372f 7364 7373 3132 270a 5344 5353  147/sdss12'.SDSS
+0001ef00: 5f44 5231 325f 4241 4e44 5320 3d20 4f72  _DR12_BANDS = Or
+0001ef10: 6465 7265 6444 6963 7428 5b28 2753 4453  deredDict([('SDS
+0001ef20: 532f 7527 2c20 5b27 756d 6167 272c 2027  S/u', ['umag', '
+0001ef30: 655f 756d 6167 275d 292c 0a20 2020 2020  e_umag']),.     
+0001ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef50: 2020 2020 2028 2753 4453 532f 6727 2c20       ('SDSS/g', 
+0001ef60: 5b27 676d 6167 272c 2027 655f 676d 6167  ['gmag', 'e_gmag
+0001ef70: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
+0001ef80: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0001ef90: 2753 4453 532f 7227 2c20 5b27 726d 6167  'SDSS/r', ['rmag
+0001efa0: 272c 2027 655f 726d 6167 275d 292c 0a20  ', 'e_rmag']),. 
 0001efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efc0: 2020 2020 2020 2827 4f43 616d 2e73 6473        ('OCam.sds
-0001efd0: 732e 7227 2c20 5b27 726d 6167 272c 2027  s.r', ['rmag', '
-0001efe0: 655f 726d 6167 275d 292c 0a20 2020 2020  e_rmag']),.     
+0001efc0: 2020 2020 2020 2020 2028 2753 4453 532f           ('SDSS/
+0001efd0: 6927 2c20 5b27 696d 6167 272c 2027 655f  i', ['imag', 'e_
+0001efe0: 696d 6167 275d 292c 0a20 2020 2020 2020  imag']),.       
 0001eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f000: 2020 2020 2028 274f 4361 6d2e 7364 7373       ('OCam.sdss
-0001f010: 2e69 272c 205b 2769 6d61 6727 2c20 2765  .i', ['imag', 'e
-0001f020: 5f69 6d61 6727 5d29 5d29 0a0a 2320 5749  _imag'])])..# WI
-0001f030: 5345 2061 6c6c 2d73 6b79 0a57 4953 455f  SE all-sky.WISE_
-0001f040: 5649 5a49 4552 203d 2027 4949 2f33 3238  VIZIER = 'II/328
-0001f050: 2f61 6c6c 7769 7365 270a 5749 5345 5f42  /allwise'.WISE_B
-0001f060: 414e 4453 203d 204f 7264 6572 6564 4469  ANDS = OrderedDi
-0001f070: 6374 285b 2827 5749 5345 2f52 5352 2d57  ct([('WISE/RSR-W
-0001f080: 3127 2c20 5b27 5731 6d61 6727 2c20 2765  1', ['W1mag', 'e
-0001f090: 5f57 316d 6167 275d 292c 0a20 2020 2020  _W1mag']),.     
-0001f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0b0: 2020 2020 2028 2757 4953 452f 5253 522d       ('WISE/RSR-
-0001f0c0: 5732 272c 205b 2757 326d 6167 272c 2027  W2', ['W2mag', '
-0001f0d0: 655f 5732 6d61 6727 5d29 5d29 0a23 2028  e_W2mag'])]).# (
-0001f0e0: 2757 4953 452f 5253 522d 5733 272c 205b  'WISE/RSR-W3', [
-0001f0f0: 2757 336d 6167 272c 2027 655f 5733 6d61  'W3mag', 'e_W3ma
-0001f100: 6727 5d29 2c0a 2320 2827 5749 5345 2f52  g']),.# ('WISE/R
-0001f110: 5352 2d57 3427 2c20 5b27 5734 6d61 6727  SR-W4', ['W4mag'
-0001f120: 2c20 2765 5f57 346d 6167 275d 295d 290a  , 'e_W4mag'])]).
-0001f130: 0a23 2056 494b 494e 4720 5649 5354 410a  .# VIKING VISTA.
-0001f140: 5649 4b49 4e47 5f56 495a 4945 5220 3d20  VIKING_VIZIER = 
-0001f150: 2749 492f 3334 332f 7669 6b69 6e67 3227  'II/343/viking2'
-0001f160: 0a56 494b 494e 475f 4241 4e44 5320 3d20  .VIKING_BANDS = 
-0001f170: 4f72 6465 7265 6444 6963 7428 5b28 2753  OrderedDict([('S
-0001f180: 4453 532f 7a27 2c20 5b27 5a70 6d61 6727  DSS/z', ['Zpmag'
-0001f190: 2c20 2765 5f5a 706d 6167 275d 292c 0a20  , 'e_Zpmag']),. 
-0001f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1b0: 2020 2020 2020 2020 2020 2028 2756 4953             ('VIS
-0001f1c0: 5441 2f59 272c 2020 5b27 5970 6d61 6727  TA/Y',  ['Ypmag'
-0001f1d0: 2c20 2027 655f 5970 6d61 6727 5d29 2c0a  ,  'e_Ypmag']),.
-0001f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1f0: 2020 2020 2020 2020 2020 2020 2827 5649              ('VI
-0001f200: 5354 412f 4a27 2c20 205b 274a 706d 6167  STA/J',  ['Jpmag
-0001f210: 272c 2020 2765 5f4a 706d 6167 275d 292c  ',  'e_Jpmag']),
-0001f220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f230: 2020 2020 2020 2020 2020 2020 2028 2756               ('V
-0001f240: 4953 5441 2f48 272c 2020 5b27 4870 6d61  ISTA/H',  ['Hpma
-0001f250: 6727 2c20 2027 655f 4870 6d61 6727 5d29  g',  'e_Hpmag'])
-0001f260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f270: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-0001f280: 5649 5354 412f 4b73 272c 205b 274b 7370  VISTA/Ks', ['Ksp
-0001f290: 6d61 6727 2c20 2765 5f4b 7370 6d61 6727  mag', 'e_Kspmag'
-0001f2a0: 5d29 5d29 0a0a 2320 554b 4944 5353 2077  ])])..# UKIDSS w
-0001f2b0: 6964 6520 7375 7276 6579 730a 554b 4944  ide surveys.UKID
-0001f2c0: 5353 5f4c 4153 5f56 495a 4945 5220 3d20  SS_LAS_VIZIER = 
-0001f2d0: 2749 492f 3331 392f 6c61 7339 270a 554b  'II/319/las9'.UK
-0001f2e0: 4944 5353 5f4c 4153 5f42 414e 4453 203d  IDSS_LAS_BANDS =
-0001f2f0: 204f 7264 6572 6564 4469 6374 285b 2827   OrderedDict([('
-0001f300: 5746 4341 4d5f 5927 2c20 5b27 596d 6167  WFCAM_Y', ['Ymag
-0001f310: 272c 2027 655f 596d 6167 275d 292c 0a20  ', 'e_Ymag']),. 
-0001f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f330: 2020 2020 2020 2020 2020 2028 2757 4643             ('WFC
-0001f340: 414d 5f4a 272c 205b 274a 6d61 6731 272c  AM_J', ['Jmag1',
-0001f350: 2027 655f 4a6d 6167 3127 5d29 2c0a 2020   'e_Jmag1']),.  
-0001f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f370: 2020 2020 2020 2020 2020 2827 5746 4341            ('WFCA
-0001f380: 4d5f 4a27 2c20 5b27 4a6d 6167 3227 2c20  M_J', ['Jmag2', 
-0001f390: 2765 5f4a 6d61 6732 275d 292c 0a20 2020  'e_Jmag2']),.   
-0001f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3b0: 2020 2020 2020 2020 2028 2757 4643 414d           ('WFCAM
-0001f3c0: 5f48 272c 205b 2748 6d61 6727 2c20 2765  _H', ['Hmag', 'e
-0001f3d0: 5f48 6d61 6727 5d29 2c0a 2020 2020 2020  _Hmag']),.      
-0001f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3f0: 2020 2020 2020 2827 5746 4341 4d5f 4b27        ('WFCAM_K'
-0001f400: 2c20 5b27 4b6d 6167 272c 2027 655f 4b6d  , ['Kmag', 'e_Km
-0001f410: 6167 275d 295d 290a 0a55 4b49 4453 535f  ag'])])..UKIDSS_
-0001f420: 4458 535f 5649 5a49 4552 203d 2027 4949  DXS_VIZIER = 'II
-0001f430: 2f33 3139 2f64 7873 3927 0a55 4b49 4453  /319/dxs9'.UKIDS
-0001f440: 535f 4458 535f 4241 4e44 5320 3d20 4f72  S_DXS_BANDS = Or
-0001f450: 6465 7265 6444 6963 7428 5b28 2757 4643  deredDict([('WFC
-0001f460: 414d 5f4a 272c 205b 274a 6d61 6727 2c20  AM_J', ['Jmag', 
-0001f470: 2765 5f4a 6d61 6727 5d29 2c0a 2020 2020  'e_Jmag']),.    
+0001f000: 2020 2028 2753 4453 532f 7a27 2c20 5b27     ('SDSS/z', ['
+0001f010: 7a6d 6167 272c 2027 655f 7a6d 6167 275d  zmag', 'e_zmag']
+0001f020: 295d 290a 0a23 2050 616e 5374 6172 7273  )])..# PanStarrs
+0001f030: 0a50 5331 5f56 495a 4945 5220 3d20 2749  .PS1_VIZIER = 'I
+0001f040: 492f 3334 392f 7073 3127 0a50 5331 5f42  I/349/ps1'.PS1_B
+0001f050: 414e 4453 203d 204f 7264 6572 6564 4469  ANDS = OrderedDi
+0001f060: 6374 285b 2827 5053 312e 6727 2c20 5b27  ct([('PS1.g', ['
+0001f070: 674b 6d61 6727 2c20 2765 5f67 4b6d 6167  gKmag', 'e_gKmag
+0001f080: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
+0001f090: 2020 2020 2020 2827 5053 312e 7227 2c20        ('PS1.r', 
+0001f0a0: 5b27 724b 6d61 6727 2c20 2765 5f72 4b6d  ['rKmag', 'e_rKm
+0001f0b0: 6167 275d 292c 0a20 2020 2020 2020 2020  ag']),.         
+0001f0c0: 2020 2020 2020 2020 2827 5053 312e 6927          ('PS1.i'
+0001f0d0: 2c20 5b27 694b 6d61 6727 2c20 2765 5f69  , ['iKmag', 'e_i
+0001f0e0: 4b6d 6167 275d 292c 0a20 2020 2020 2020  Kmag']),.       
+0001f0f0: 2020 2020 2020 2020 2020 2827 5053 312e            ('PS1.
+0001f100: 7a27 2c20 5b27 7a4b 6d61 6727 2c20 2765  z', ['zKmag', 'e
+0001f110: 5f7a 4b6d 6167 275d 292c 0a20 2020 2020  _zKmag']),.     
+0001f120: 2020 2020 2020 2020 2020 2020 2827 5053              ('PS
+0001f130: 312e 7927 2c20 5b27 794b 6d61 6727 2c20  1.y', ['yKmag', 
+0001f140: 2765 5f79 4b6d 6167 275d 295d 290a 0a23  'e_yKmag'])])..#
+0001f150: 204b 4944 5320 4452 330a 4b49 4453 5f44   KIDS DR3.KIDS_D
+0001f160: 5233 5f56 495a 4945 5220 3d20 2749 492f  R3_VIZIER = 'II/
+0001f170: 3334 372f 6b69 6473 5f64 7233 270a 4b49  347/kids_dr3'.KI
+0001f180: 4453 5f44 5233 5f42 414e 4453 203d 204f  DS_DR3_BANDS = O
+0001f190: 7264 6572 6564 4469 6374 285b 2827 4f43  rderedDict([('OC
+0001f1a0: 616d 2e73 6473 732e 7527 2c20 5b27 756d  am.sdss.u', ['um
+0001f1b0: 6167 272c 2027 655f 756d 6167 275d 292c  ag', 'e_umag']),
+0001f1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f1d0: 2020 2020 2020 2020 2020 2028 274f 4361             ('OCa
+0001f1e0: 6d2e 7364 7373 2e67 272c 205b 2767 6d61  m.sdss.g', ['gma
+0001f1f0: 6727 2c20 2765 5f67 6d61 6727 5d29 2c0a  g', 'e_gmag']),.
+0001f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f210: 2020 2020 2020 2020 2020 2827 4f43 616d            ('OCam
+0001f220: 2e73 6473 732e 7227 2c20 5b27 726d 6167  .sdss.r', ['rmag
+0001f230: 272c 2027 655f 726d 6167 275d 292c 0a20  ', 'e_rmag']),. 
+0001f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f250: 2020 2020 2020 2020 2028 274f 4361 6d2e           ('OCam.
+0001f260: 7364 7373 2e69 272c 205b 2769 6d61 6727  sdss.i', ['imag'
+0001f270: 2c20 2765 5f69 6d61 6727 5d29 5d29 0a0a  , 'e_imag'])])..
+0001f280: 2320 5749 5345 2061 6c6c 2d73 6b79 0a57  # WISE all-sky.W
+0001f290: 4953 455f 5649 5a49 4552 203d 2027 4949  ISE_VIZIER = 'II
+0001f2a0: 2f33 3238 2f61 6c6c 7769 7365 270a 5749  /328/allwise'.WI
+0001f2b0: 5345 5f42 414e 4453 203d 204f 7264 6572  SE_BANDS = Order
+0001f2c0: 6564 4469 6374 285b 2827 5749 5345 2f52  edDict([('WISE/R
+0001f2d0: 5352 2d57 3127 2c20 5b27 5731 6d61 6727  SR-W1', ['W1mag'
+0001f2e0: 2c20 2765 5f57 316d 6167 275d 292c 0a20  , 'e_W1mag']),. 
+0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f300: 2020 2020 2020 2020 2028 2757 4953 452f           ('WISE/
+0001f310: 5253 522d 5732 272c 205b 2757 326d 6167  RSR-W2', ['W2mag
+0001f320: 272c 2027 655f 5732 6d61 6727 5d29 5d29  ', 'e_W2mag'])])
+0001f330: 0a23 2028 2757 4953 452f 5253 522d 5733  .# ('WISE/RSR-W3
+0001f340: 272c 205b 2757 336d 6167 272c 2027 655f  ', ['W3mag', 'e_
+0001f350: 5733 6d61 6727 5d29 2c0a 2320 2827 5749  W3mag']),.# ('WI
+0001f360: 5345 2f52 5352 2d57 3427 2c20 5b27 5734  SE/RSR-W4', ['W4
+0001f370: 6d61 6727 2c20 2765 5f57 346d 6167 275d  mag', 'e_W4mag']
+0001f380: 295d 290a 0a23 2056 494b 494e 4720 5649  )])..# VIKING VI
+0001f390: 5354 410a 5649 4b49 4e47 5f56 495a 4945  STA.VIKING_VIZIE
+0001f3a0: 5220 3d20 2749 492f 3334 332f 7669 6b69  R = 'II/343/viki
+0001f3b0: 6e67 3227 0a56 494b 494e 475f 4241 4e44  ng2'.VIKING_BAND
+0001f3c0: 5320 3d20 4f72 6465 7265 6444 6963 7428  S = OrderedDict(
+0001f3d0: 5b28 2753 4453 532f 7a27 2c20 5b27 5a70  [('SDSS/z', ['Zp
+0001f3e0: 6d61 6727 2c20 2765 5f5a 706d 6167 275d  mag', 'e_Zpmag']
+0001f3f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001f400: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0001f410: 2756 4953 5441 2f59 272c 2020 5b27 5970  'VISTA/Y',  ['Yp
+0001f420: 6d61 6727 2c20 2027 655f 5970 6d61 6727  mag',  'e_Ypmag'
+0001f430: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0001f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f450: 2827 5649 5354 412f 4a27 2c20 205b 274a  ('VISTA/J',  ['J
+0001f460: 706d 6167 272c 2020 2765 5f4a 706d 6167  pmag',  'e_Jpmag
+0001f470: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
 0001f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f490: 2020 2020 2020 2020 2827 5746 4341 4d5f          ('WFCAM_
-0001f4a0: 4b27 2c20 5b27 4b6d 6167 272c 2027 655f  K', ['Kmag', 'e_
-0001f4b0: 4b6d 6167 275d 295d 290a 0a23 2047 414c  Kmag'])])..# GAL
-0001f4c0: 4558 0a47 414c 4558 5f4d 4953 5f56 495a  EX.GALEX_MIS_VIZ
-0001f4d0: 4945 5220 3d20 2749 492f 3331 322f 6d69  IER = 'II/312/mi
-0001f4e0: 7327 0a47 414c 4558 5f4d 4953 5f42 414e  s'.GALEX_MIS_BAN
-0001f4f0: 4453 203d 204f 7264 6572 6564 4469 6374  DS = OrderedDict
-0001f500: 285b 2827 4655 5627 2c20 5b27 4655 5627  ([('FUV', ['FUV'
-0001f510: 2c20 2765 5f46 5556 275d 292c 0a20 2020  , 'e_FUV']),.   
-0001f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f530: 2020 2020 2020 2020 2020 2028 274e 5556             ('NUV
-0001f540: 272c 205b 274e 5556 272c 2027 655f 4e55  ', ['NUV', 'e_NU
-0001f550: 5627 5d29 5d29 0a0a 4741 4c45 585f 4149  V'])])..GALEX_AI
-0001f560: 535f 5649 5a49 4552 203d 2027 4949 2f33  S_VIZIER = 'II/3
-0001f570: 3132 2f61 6973 270a 4741 4c45 585f 4149  12/ais'.GALEX_AI
-0001f580: 535f 4241 4e44 5320 3d20 4f72 6465 7265  S_BANDS = Ordere
-0001f590: 6444 6963 7428 5b28 2746 5556 272c 205b  dDict([('FUV', [
-0001f5a0: 2746 5556 272c 2027 655f 4655 5627 5d29  'FUV', 'e_FUV'])
+0001f490: 2028 2756 4953 5441 2f48 272c 2020 5b27   ('VISTA/H',  ['
+0001f4a0: 4870 6d61 6727 2c20 2027 655f 4870 6d61  Hpmag',  'e_Hpma
+0001f4b0: 6727 5d29 2c0a 2020 2020 2020 2020 2020  g']),.          
+0001f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f4d0: 2020 2827 5649 5354 412f 4b73 272c 205b    ('VISTA/Ks', [
+0001f4e0: 274b 7370 6d61 6727 2c20 2765 5f4b 7370  'Kspmag', 'e_Ksp
+0001f4f0: 6d61 6727 5d29 5d29 0a0a 2320 554b 4944  mag'])])..# UKID
+0001f500: 5353 2077 6964 6520 7375 7276 6579 730a  SS wide surveys.
+0001f510: 554b 4944 5353 5f4c 4153 5f56 495a 4945  UKIDSS_LAS_VIZIE
+0001f520: 5220 3d20 2749 492f 3331 392f 6c61 7339  R = 'II/319/las9
+0001f530: 270a 554b 4944 5353 5f4c 4153 5f42 414e  '.UKIDSS_LAS_BAN
+0001f540: 4453 203d 204f 7264 6572 6564 4469 6374  DS = OrderedDict
+0001f550: 285b 2827 5746 4341 4d5f 5927 2c20 5b27  ([('WFCAM_Y', ['
+0001f560: 596d 6167 272c 2027 655f 596d 6167 275d  Ymag', 'e_Ymag']
+0001f570: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001f580: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0001f590: 2757 4643 414d 5f4a 272c 205b 274a 6d61  'WFCAM_J', ['Jma
+0001f5a0: 6731 272c 2027 655f 4a6d 6167 3127 5d29  g1', 'e_Jmag1'])
 0001f5b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5d0: 2827 4e55 5627 2c20 5b27 4e55 5627 2c20  ('NUV', ['NUV', 
-0001f5e0: 2765 5f4e 5556 275d 295d 290a 0a23 2043  'e_NUV'])])..# C
-0001f5f0: 6f6d 6269 6e65 6420 4469 6374 0a56 495a  ombined Dict.VIZ
-0001f600: 4945 525f 4241 4e44 5320 3d20 4f72 6465  IER_BANDS = Orde
-0001f610: 7265 6444 6963 7428 290a 5649 5a49 4552  redDict().VIZIER
-0001f620: 5f42 414e 4453 5b43 4648 544c 535f 575f  _BANDS[CFHTLS_W_
-0001f630: 5649 5a49 4552 5d20 3d20 4346 4854 4c53  VIZIER] = CFHTLS
-0001f640: 5f57 5f42 414e 4453 0a56 495a 4945 525f  _W_BANDS.VIZIER_
-0001f650: 4241 4e44 535b 4346 4854 4c53 5f44 5f56  BANDS[CFHTLS_D_V
-0001f660: 495a 4945 525d 203d 2043 4648 544c 535f  IZIER] = CFHTLS_
-0001f670: 445f 4241 4e44 530a 5649 5a49 4552 5f42  D_BANDS.VIZIER_B
-0001f680: 414e 4453 5b53 4453 535f 4452 3132 5f56  ANDS[SDSS_DR12_V
-0001f690: 495a 4945 525d 203d 2053 4453 535f 4452  IZIER] = SDSS_DR
-0001f6a0: 3132 5f42 414e 4453 0a56 495a 4945 525f  12_BANDS.VIZIER_
-0001f6b0: 4241 4e44 535b 5053 315f 5649 5a49 4552  BANDS[PS1_VIZIER
-0001f6c0: 5d20 3d20 5053 315f 4241 4e44 530a 5649  ] = PS1_BANDS.VI
-0001f6d0: 5a49 4552 5f42 414e 4453 5b4b 4944 535f  ZIER_BANDS[KIDS_
-0001f6e0: 4452 335f 5649 5a49 4552 5d20 3d20 4b49  DR3_VIZIER] = KI
-0001f6f0: 4453 5f44 5233 5f42 414e 4453 0a56 495a  DS_DR3_BANDS.VIZ
-0001f700: 4945 525f 4241 4e44 535b 5749 5345 5f56  IER_BANDS[WISE_V
-0001f710: 495a 4945 525d 203d 2057 4953 455f 4241  IZIER] = WISE_BA
-0001f720: 4e44 530a 5649 5a49 4552 5f42 414e 4453  NDS.VIZIER_BANDS
-0001f730: 5b56 494b 494e 475f 5649 5a49 4552 5d20  [VIKING_VIZIER] 
-0001f740: 3d20 5649 4b49 4e47 5f42 414e 4453 0a56  = VIKING_BANDS.V
-0001f750: 495a 4945 525f 4241 4e44 535b 554b 4944  IZIER_BANDS[UKID
-0001f760: 5353 5f4c 4153 5f56 495a 4945 525d 203d  SS_LAS_VIZIER] =
-0001f770: 2055 4b49 4453 535f 4c41 535f 4241 4e44   UKIDSS_LAS_BAND
-0001f780: 530a 5649 5a49 4552 5f42 414e 4453 5b55  S.VIZIER_BANDS[U
-0001f790: 4b49 4453 535f 4458 535f 5649 5a49 4552  KIDSS_DXS_VIZIER
-0001f7a0: 5d20 3d20 554b 4944 5353 5f44 5853 5f42  ] = UKIDSS_DXS_B
-0001f7b0: 414e 4453 0a56 495a 4945 525f 4241 4e44  ANDS.VIZIER_BAND
-0001f7c0: 535b 4741 4c45 585f 4d49 535f 5649 5a49  S[GALEX_MIS_VIZI
-0001f7d0: 4552 5d20 3d20 4741 4c45 585f 4d49 535f  ER] = GALEX_MIS_
-0001f7e0: 4241 4e44 530a 5649 5a49 4552 5f42 414e  BANDS.VIZIER_BAN
-0001f7f0: 4453 5b47 414c 4558 5f41 4953 5f56 495a  DS[GALEX_AIS_VIZ
-0001f800: 4945 525d 203d 2047 414c 4558 5f41 4953  IER] = GALEX_AIS
-0001f810: 5f42 414e 4453 0a0a 5649 5a49 4552 5f56  _BANDS..VIZIER_V
-0001f820: 4547 4120 3d20 4f72 6465 7265 6444 6963  EGA = OrderedDic
-0001f830: 7428 290a 5649 5a49 4552 5f56 4547 415b  t().VIZIER_VEGA[
-0001f840: 4346 4854 4c53 5f57 5f56 495a 4945 525d  CFHTLS_W_VIZIER]
-0001f850: 203d 2046 616c 7365 0a56 495a 4945 525f   = False.VIZIER_
-0001f860: 5645 4741 5b43 4648 544c 535f 445f 5649  VEGA[CFHTLS_D_VI
-0001f870: 5a49 4552 5d20 3d20 4661 6c73 650a 5649  ZIER] = False.VI
-0001f880: 5a49 4552 5f56 4547 415b 5344 5353 5f44  ZIER_VEGA[SDSS_D
-0001f890: 5231 325f 5649 5a49 4552 5d20 3d20 4661  R12_VIZIER] = Fa
-0001f8a0: 6c73 650a 5649 5a49 4552 5f56 4547 415b  lse.VIZIER_VEGA[
-0001f8b0: 5053 315f 5649 5a49 4552 5d20 3d20 4661  PS1_VIZIER] = Fa
-0001f8c0: 6c73 650a 5649 5a49 4552 5f56 4547 415b  lse.VIZIER_VEGA[
-0001f8d0: 4b49 4453 5f44 5233 5f56 495a 4945 525d  KIDS_DR3_VIZIER]
-0001f8e0: 203d 2046 616c 7365 0a56 495a 4945 525f   = False.VIZIER_
-0001f8f0: 5645 4741 5b57 4953 455f 5649 5a49 4552  VEGA[WISE_VIZIER
-0001f900: 5d20 3d20 5472 7565 0a56 495a 4945 525f  ] = True.VIZIER_
-0001f910: 5645 4741 5b56 494b 494e 475f 5649 5a49  VEGA[VIKING_VIZI
-0001f920: 4552 5d20 3d20 5472 7565 0a56 495a 4945  ER] = True.VIZIE
-0001f930: 525f 5645 4741 5b55 4b49 4453 535f 4c41  R_VEGA[UKIDSS_LA
-0001f940: 535f 5649 5a49 4552 5d20 3d20 5472 7565  S_VIZIER] = True
-0001f950: 0a56 495a 4945 525f 5645 4741 5b55 4b49  .VIZIER_VEGA[UKI
-0001f960: 4453 535f 4458 535f 5649 5a49 4552 5d20  DSS_DXS_VIZIER] 
-0001f970: 3d20 5472 7565 0a56 495a 4945 525f 5645  = True.VIZIER_VE
-0001f980: 4741 5b47 414c 4558 5f4d 4953 5f56 495a  GA[GALEX_MIS_VIZ
-0001f990: 4945 525d 203d 2046 616c 7365 0a56 495a  IER] = False.VIZ
-0001f9a0: 4945 525f 5645 4741 5b47 414c 4558 5f41  IER_VEGA[GALEX_A
-0001f9b0: 4953 5f56 495a 4945 525d 203d 2046 616c  IS_VIZIER] = Fal
-0001f9c0: 7365 0a0a 0a64 6566 2067 6574 5f56 697a  se...def get_Viz
-0001f9d0: 6965 725f 7068 6f74 6f6d 6574 7279 2872  ier_photometry(r
-0001f9e0: 612c 2064 6563 2c20 7465 6d70 6c61 7465  a, dec, template
-0001f9f0: 733d 4e6f 6e65 2c20 7261 6469 7573 3d32  s=None, radius=2
-0001fa00: 2c20 7669 7a69 6572 5f63 6174 616c 6f67  , vizier_catalog
-0001fa10: 3d50 5331 5f56 495a 4945 522c 2062 616e  =PS1_VIZIER, ban
-0001fa20: 6473 3d50 5331 5f42 414e 4453 2c20 6669  ds=PS1_BANDS, fi
-0001fa30: 6c74 6572 5f66 696c 653d 272f 7573 722f  lter_file='/usr/
-0001fa40: 6c6f 6361 6c2f 7368 6172 652f 6561 7a79  local/share/eazy
-0001fa50: 2d70 686f 746f 7a2f 6669 6c74 6572 732f  -photoz/filters/
-0001fa60: 4649 4c54 4552 2e52 4553 2e6c 6174 6573  FILTER.RES.lates
-0001fa70: 7427 2c20 4d57 5f45 4256 3d30 2c20 636f  t', MW_EBV=0, co
-0001fa80: 6e76 6572 745f 7665 6761 3d46 616c 7365  nvert_vega=False
-0001fa90: 2c20 7261 775f 7175 6572 793d 4661 6c73  , raw_query=Fals
-0001faa0: 652c 2076 6572 626f 7365 3d54 7275 652c  e, verbose=True,
-0001fab0: 2074 696d 656f 7574 3d33 3030 2c20 726f   timeout=300, ro
-0001fac0: 776c 696d 6974 3d35 3030 3030 293a 0a20  wlimit=50000):. 
-0001fad0: 2020 2022 2222 0a20 2020 2046 6574 6368     """.    Fetch
-0001fae0: 2070 686f 746f 6d65 7472 7920 6672 6f6d   photometry from
-0001faf0: 2061 2056 697a 6965 7220 6361 7461 6c6f   a Vizier catalo
-0001fb00: 670a 0a20 2020 2052 6571 7569 7265 7320  g..    Requires 
-0001fb10: 6561 7a79 7079 2f65 617a 790a 2020 2020  eazypy/eazy.    
-0001fb20: 2222 220a 0a20 2020 2066 726f 6d20 636f  """..    from co
-0001fb30: 6c6c 6563 7469 6f6e 7320 696d 706f 7274  llections import
-0001fb40: 204f 7264 6572 6564 4469 6374 0a0a 2020   OrderedDict..  
-0001fb50: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
-0001fb60: 2e75 6e69 7473 2061 7320 750a 2020 2020  .units as u.    
-0001fb70: 6672 6f6d 2061 7374 726f 7175 6572 792e  from astroquery.
-0001fb80: 7669 7a69 6572 2069 6d70 6f72 7420 5669  vizier import Vi
-0001fb90: 7a69 6572 0a20 2020 2056 697a 6965 722e  zier.    Vizier.
-0001fba0: 524f 575f 4c49 4d49 5420 3d20 726f 776c  ROW_LIMIT = rowl
-0001fbb0: 696d 6974 0a20 2020 2056 697a 6965 722e  imit.    Vizier.
-0001fbc0: 5449 4d45 4f55 5420 3d20 7469 6d65 6f75  TIMEOUT = timeou
-0001fbd0: 740a 0a20 2020 2023 7072 696e 7428 2778  t..    #print('x
-0001fbe0: 7878 272c 2056 697a 6965 722e 524f 575f  xx', Vizier.ROW_
-0001fbf0: 4c49 4d49 542c 2056 697a 6965 722e 5449  LIMIT, Vizier.TI
-0001fc00: 4d45 4f55 5429 0a0a 2020 2020 696d 706f  MEOUT)..    impo
-0001fc10: 7274 2061 7374 726f 7079 2e63 6f6f 7264  rt astropy.coord
-0001fc20: 696e 6174 6573 2061 7320 636f 6f72 640a  inates as coord.
-0001fc30: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
-0001fc40: 7079 2e75 6e69 7473 2061 7320 750a 0a20  py.units as u.. 
-0001fc50: 2020 2023 696d 706f 7274 2070 7973 796e     #import pysyn
-0001fc60: 7068 6f74 2061 7320 530a 0a20 2020 2066  phot as S..    f
-0001fc70: 726f 6d20 6561 7a79 2e74 656d 706c 6174  rom eazy.templat
-0001fc80: 6573 2069 6d70 6f72 7420 5465 6d70 6c61  es import Templa
-0001fc90: 7465 0a20 2020 2066 726f 6d20 6561 7a79  te.    from eazy
-0001fca0: 2e66 696c 7465 7273 2069 6d70 6f72 7420  .filters import 
-0001fcb0: 4669 6c74 6572 4669 6c65 0a20 2020 2066  FilterFile.    f
-0001fcc0: 726f 6d20 6561 7a79 2e70 686f 746f 7a20  rom eazy.photoz 
-0001fcd0: 696d 706f 7274 2054 656d 706c 6174 6547  import TemplateG
-0001fce0: 7269 640a 2020 2020 6672 6f6d 2065 617a  rid.    from eaz
-0001fcf0: 792e 6669 6c74 6572 7320 696d 706f 7274  y.filters import
-0001fd00: 2046 696c 7465 7244 6566 696e 6974 696f   FilterDefinitio
-0001fd10: 6e0a 0a20 2020 2072 6573 203d 2046 696c  n..    res = Fil
-0001fd20: 7465 7246 696c 6528 6669 6c74 6572 5f66  terFile(filter_f
-0001fd30: 696c 6529 0a0a 2020 2020 636f 6f20 3d20  ile)..    coo = 
-0001fd40: 636f 6f72 642e 536b 7943 6f6f 7264 2872  coord.SkyCoord(r
-0001fd50: 613d 7261 2c20 6465 633d 6465 632c 2075  a=ra, dec=dec, u
-0001fd60: 6e69 743d 2875 2e64 6567 2c20 752e 6465  nit=(u.deg, u.de
-0001fd70: 6729 2c0a 2020 2020 2020 2020 2020 2020  g),.            
-0001fd80: 2020 2020 2020 2020 2020 2020 2066 7261               fra
-0001fd90: 6d65 3d27 6963 7273 2729 0a0a 2020 2020  me='icrs')..    
-0001fda0: 636f 6c75 6d6e 7320 3d20 5b27 2a27 5d0a  columns = ['*'].
-0001fdb0: 2020 2020 2363 6f6c 756d 6e73 203d 205b      #columns = [
-0001fdc0: 5d0a 2020 2020 6966 2069 7369 6e73 7461  ].    if isinsta
-0001fdd0: 6e63 6528 7669 7a69 6572 5f63 6174 616c  nce(vizier_catal
-0001fde0: 6f67 2c20 6c69 7374 293a 0a20 2020 2020  og, list):.     
-0001fdf0: 2020 2066 6f72 2063 2069 6e20 5b56 494b     for c in [VIK
-0001fe00: 494e 475f 5649 5a49 4552 5d3a 0a20 2020  ING_VIZIER]:.   
-0001fe10: 2020 2020 2020 2020 2066 6f72 2062 2069           for b i
-0001fe20: 6e20 5649 5a49 4552 5f42 414e 4453 5b63  n VIZIER_BANDS[c
-0001fe30: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0001fe40: 2020 2063 6f6c 756d 6e73 202b 3d20 5649     columns += VI
-0001fe50: 5a49 4552 5f42 414e 4453 5b63 5d5b 625d  ZIER_BANDS[c][b]
-0001fe60: 0a0a 2020 2020 2020 2020 636f 6c75 6d6e  ..        column
-0001fe70: 7320 3d20 6c69 7374 286e 702e 756e 6971  s = list(np.uniq
-0001fe80: 7565 2863 6f6c 756d 6e73 2929 0a20 2020  ue(columns)).   
-0001fe90: 2020 2020 2023 7072 696e 7428 2278 7878       #print("xxx
-0001fea0: 2063 6f6c 756d 6e73 222c 2063 6f6c 756d   columns", colum
-0001feb0: 6e73 290a 2020 2020 656c 7365 3a0a 2020  ns).    else:.  
-0001fec0: 2020 2020 2020 666f 7220 6220 696e 2062        for b in b
-0001fed0: 616e 6473 3a0a 2020 2020 2020 2020 2020  ands:.          
-0001fee0: 2020 636f 6c75 6d6e 7320 2b3d 2062 616e    columns += ban
-0001fef0: 6473 5b62 5d0a 0a20 2020 2069 6620 6973  ds[b]..    if is
-0001ff00: 696e 7374 616e 6365 2876 697a 6965 725f  instance(vizier_
-0001ff10: 6361 7461 6c6f 672c 206c 6973 7429 3a0a  catalog, list):.
-0001ff20: 2020 2020 2020 2020 7620 3d20 5669 7a69          v = Vizi
-0001ff30: 6572 2863 6174 616c 6f67 3d56 494b 494e  er(catalog=VIKIN
-0001ff40: 475f 5649 5a49 4552 2c20 636f 6c75 6d6e  G_VIZIER, column
-0001ff50: 733d 5b27 2b5f 7227 5d2b 636f 6c75 6d6e  s=['+_r']+column
-0001ff60: 7329 0a20 2020 2065 6c73 653a 0a20 2020  s).    else:.   
-0001ff70: 2020 2020 2076 203d 2056 697a 6965 7228       v = Vizier(
-0001ff80: 6361 7461 6c6f 673d 7669 7a69 6572 5f63  catalog=vizier_c
-0001ff90: 6174 616c 6f67 2c20 636f 6c75 6d6e 733d  atalog, columns=
-0001ffa0: 5b27 2b5f 7227 5d2b 636f 6c75 6d6e 7329  ['+_r']+columns)
-0001ffb0: 0a0a 2020 2020 762e 524f 575f 4c49 4d49  ..    v.ROW_LIMI
-0001ffc0: 5420 3d20 726f 776c 696d 6974 0a20 2020  T = rowlimit.   
-0001ffd0: 2076 2e54 494d 454f 5554 203d 2074 696d   v.TIMEOUT = tim
-0001ffe0: 656f 7574 0a0a 2020 2020 2371 7565 7279  eout..    #query
-0001fff0: 5f63 6174 616c 6f67 203d 2076 697a 6965  _catalog = vizie
-00020000: 725f 6361 7461 6c6f 670a 2020 2020 7472  r_catalog.    tr
-00020010: 793a 0a20 2020 2020 2020 2074 6162 7320  y:.        tabs 
-00020020: 3d20 762e 7175 6572 795f 7265 6769 6f6e  = v.query_region
-00020030: 2863 6f6f 2c20 7261 6469 7573 3d22 7b30  (coo, radius="{0
-00020040: 7d73 222e 666f 726d 6174 2872 6164 6975  }s".format(radiu
-00020050: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00020060: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00020070: 7461 6c6f 673d 7669 7a69 6572 5f63 6174  talog=vizier_cat
-00020080: 616c 6f67 2920 2023 205b 305d 0a0a 2020  alog)  # [0]..  
-00020090: 2020 2020 2020 6966 2072 6177 5f71 7565        if raw_que
-000200a0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000200b0: 7265 7475 726e 2874 6162 7329 0a0a 2020  return(tabs)..  
-000200c0: 2020 2020 2020 7461 6220 3d20 7461 6273        tab = tabs
-000200d0: 5b30 5d0a 0a20 2020 2020 2020 2069 6620  [0]..        if 
-000200e0: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-000200f0: 2020 2066 6f72 2074 2069 6e20 7461 6273     for t in tabs
-00020100: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020110: 2020 6261 6e64 7320 3d20 5649 5a49 4552    bands = VIZIER
-00020120: 5f42 414e 4453 5b74 2e6d 6574 615b 276e  _BANDS[t.meta['n
-00020130: 616d 6527 5d5d 0a20 2020 2020 2020 2020  ame']].         
-00020140: 2020 2020 2020 2066 6f72 2062 2069 6e20         for b in 
-00020150: 6261 6e64 733a 0a20 2020 2020 2020 2020  bands:.         
-00020160: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-00020170: 2069 6e20 6261 6e64 735b 625d 3a0a 2020   in bands[b]:.  
-00020180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020190: 2020 2020 2020 7072 696e 7428 742e 6d65        print(t.me
-000201a0: 7461 5b27 6e61 6d65 275d 2c20 632c 2063  ta['name'], c, c
-000201b0: 2069 6e20 742e 636f 6c6e 616d 6573 2920   in t.colnames) 
-000201c0: 2023 2063 203d 2062 616e 6473 5b62 5d5b   # c = bands[b][
-000201d0: 305d 0a0a 2020 2020 2020 2020 6978 203d  0]..        ix =
-000201e0: 206e 702e 6172 676d 696e 2874 6162 5b27   np.argmin(tab['
-000201f0: 5f72 275d 290a 2020 2020 2020 2020 7461  _r']).        ta
-00020200: 6220 3d20 7461 625b 6978 5d0a 2020 2020  b = tab[ix].    
-00020210: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00020220: 7461 6220 3d20 4e6f 6e65 0a0a 2020 2020  tab = None..    
-00020230: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-00020240: 0a20 2020 2076 697a 5f74 6162 6c65 7320  .    viz_tables 
-00020250: 3d20 272c 2027 2e6a 6f69 6e28 5b74 2e6d  = ', '.join([t.m
-00020260: 6574 615b 276e 616d 6527 5d20 666f 7220  eta['name'] for 
-00020270: 7420 696e 2074 6162 735d 290a 2020 2020  t in tabs]).    
-00020280: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00020290: 2020 2020 7072 696e 7428 2750 686f 746f      print('Photo
-000202a0: 6d65 7472 7920 6672 6f6d 2076 697a 6965  metry from vizie
-000202b0: 7220 6361 7461 6c6f 6773 3a20 7b30 7d27  r catalogs: {0}'
-000202c0: 2e66 6f72 6d61 7428 7669 7a5f 7461 626c  .format(viz_tabl
-000202d0: 6573 2929 0a0a 2020 2020 7069 766f 7420  es))..    pivot 
-000202e0: 3d20 5b5d 2020 2320 4f72 6465 7265 6444  = []  # OrderedD
-000202f0: 6963 7428 290a 2020 2020 666c 616d 203d  ict().    flam =
-00020300: 205b 5d0a 2020 2020 6566 6c61 6d20 3d20   [].    eflam = 
-00020310: 5b5d 0a20 2020 2066 696c 7465 7273 203d  [].    filters =
-00020320: 205b 5d0a 0a20 2020 2066 6f72 2074 6162   []..    for tab
-00020330: 2069 6e20 7461 6273 3a0a 0a20 2020 2020   in tabs:..     
-00020340: 2020 2023 2044 6f77 6e77 6569 6768 7420     # Downweight 
-00020350: 5053 3120 6966 2068 6176 6520 5344 5353  PS1 if have SDSS
-00020360: 203f 2020 466f 7220 6e6f 772c 2064 6f20   ?  For now, do 
-00020370: 6e6f 7468 696e 670a 2020 2020 2020 2020  nothing.        
-00020380: 6966 2028 7461 622e 6d65 7461 5b27 6e61  if (tab.meta['na
-00020390: 6d65 275d 203d 3d20 5053 315f 5649 5a49  me'] == PS1_VIZI
-000203a0: 4552 2920 2620 2853 4453 535f 4452 3132  ER) & (SDSS_DR12
-000203b0: 5f56 495a 4945 5220 696e 2076 697a 5f74  _VIZIER in viz_t
-000203c0: 6162 6c65 7329 3a0a 2020 2020 2020 2020  ables):.        
-000203d0: 2020 2020 2320 636f 6e74 696e 7565 0a20      # continue. 
-000203e0: 2020 2020 2020 2020 2020 2065 7272 5f73             err_s
-000203f0: 6361 6c65 203d 2031 0a20 2020 2020 2020  cale = 1.       
-00020400: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00020410: 2020 2065 7272 5f73 6361 6c65 203d 2031     err_scale = 1
-00020420: 0a0a 2020 2020 2020 2020 2320 4f6e 6c79  ..        # Only
-00020430: 2075 7365 206f 6e65 2043 4648 5420 6361   use one CFHT ca
-00020440: 7461 6c6f 670a 2020 2020 2020 2020 6966  talog.        if
-00020450: 2028 7461 622e 6d65 7461 5b27 6e61 6d65   (tab.meta['name
-00020460: 275d 203d 3d20 4346 4854 4c53 5f57 5f56  '] == CFHTLS_W_V
-00020470: 495a 4945 5229 2026 2028 4346 4854 4c53  IZIER) & (CFHTLS
-00020480: 5f44 5f56 495a 4945 5220 696e 2076 697a  _D_VIZIER in viz
-00020490: 5f74 6162 6c65 7329 3a0a 2020 2020 2020  _tables):.      
-000204a0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-000204b0: 2020 2020 2020 2020 6966 2028 7461 622e          if (tab.
-000204c0: 6d65 7461 5b27 6e61 6d65 275d 203d 3d20  meta['name'] == 
-000204d0: 554b 4944 5353 5f4c 4153 5f56 495a 4945  UKIDSS_LAS_VIZIE
-000204e0: 5229 3a0a 2020 2020 2020 2020 2020 2020  R):.            
-000204f0: 666c 7578 5f73 6361 6c65 203d 2031 2e33  flux_scale = 1.3
-00020500: 330a 2020 2020 2020 2020 656c 7365 3a0a  3.        else:.
-00020510: 2020 2020 2020 2020 2020 2020 666c 7578              flux
-00020520: 5f73 6361 6c65 203d 2031 2e0a 0a20 2020  _scale = 1...   
-00020530: 2020 2020 2063 6f6e 7665 7274 5f76 6567       convert_veg
-00020540: 6120 3d20 5649 5a49 4552 5f56 4547 415b  a = VIZIER_VEGA[
-00020550: 7461 622e 6d65 7461 5b27 6e61 6d65 275d  tab.meta['name']
-00020560: 5d0a 2020 2020 2020 2020 6261 6e64 7320  ].        bands 
-00020570: 3d20 5649 5a49 4552 5f42 414e 4453 5b74  = VIZIER_BANDS[t
-00020580: 6162 2e6d 6574 615b 276e 616d 6527 5d5d  ab.meta['name']]
-00020590: 0a0a 2020 2020 2020 2020 2320 6966 2076  ..        # if v
-000205a0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-000205b0: 2320 2020 2070 7269 6e74 2874 6162 2e63  #    print(tab.c
-000205c0: 6f6c 6e61 6d65 7329 0a0a 2020 2020 2020  olnames)..      
-000205d0: 2020 2366 696c 7465 7273 202b 3d20 5b72    #filters += [r
-000205e0: 6573 2e66 696c 7465 7273 5b72 6573 2e73  es.filters[res.s
-000205f0: 6561 7263 6828 622c 2076 6572 626f 7365  earch(b, verbose
-00020600: 3d46 616c 7365 295b 305d 5d20 666f 7220  =False)[0]] for 
-00020610: 6220 696e 2062 616e 6473 5d0a 0a20 2020  b in bands]..   
-00020620: 2020 2020 2074 6f5f 666c 616d 203d 2031       to_flam = 1
-00020630: 302a 2a28 2d30 2e34 2a28 3438 2e36 2929  0**(-0.4*(48.6))
-00020640: 2a33 2e65 3138 2020 2320 2f20 7069 766f  *3.e18  # / pivo
-00020650: 7428 416e 6729 2a2a 320a 0a20 2020 2020  t(Ang)**2..     
-00020660: 2020 2066 6f72 2069 622c 2062 2069 6e20     for ib, b in 
-00020670: 656e 756d 6572 6174 6528 6261 6e64 7329  enumerate(bands)
-00020680: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-00020690: 6c74 203d 2072 6573 2e66 696c 7465 7273  lt = res.filters
-000206a0: 5b72 6573 2e73 6561 7263 6828 622c 2076  [res.search(b, v
-000206b0: 6572 626f 7365 3d46 616c 7365 295b 305d  erbose=False)[0]
-000206c0: 5d0a 2020 2020 2020 2020 2020 2020 6669  ].            fi
-000206d0: 6c74 6572 732e 6170 7065 6e64 2866 696c  lters.append(fil
-000206e0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-000206f0: 6966 2063 6f6e 7665 7274 5f76 6567 613a  if convert_vega:
-00020700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020710: 2074 6f5f 6162 203d 2066 696c 742e 4142   to_ab = filt.AB
-00020720: 5665 6761 2829 0a20 2020 2020 2020 2020  Vega().         
-00020730: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00020740: 2020 2020 2020 2020 2074 6f5f 6162 203d           to_ab =
-00020750: 2030 2e0a 0a20 2020 2020 2020 2020 2020   0...           
-00020760: 2066 636f 6c2c 2065 636f 6c20 3d20 6261   fcol, ecol = ba
-00020770: 6e64 735b 625d 0a20 2020 2020 2020 2020  nds[b].         
-00020780: 2020 2070 6976 6f74 2e61 7070 656e 6428     pivot.append(
-00020790: 6669 6c74 2e70 6976 6f74 2829 290a 2020  filt.pivot()).  
-000207a0: 2020 2020 2020 2020 2020 666c 616d 2e61            flam.a
-000207b0: 7070 656e 6428 3130 2a2a 282d 302e 342a  ppend(10**(-0.4*
-000207c0: 2874 6162 5b66 636f 6c5d 5b30 5d2b 746f  (tab[fcol][0]+to
-000207d0: 5f61 6229 292a 746f 5f66 6c61 6d2f 7069  _ab))*to_flam/pi
-000207e0: 766f 745b 2d31 5d2a 2a32 290a 2020 2020  vot[-1]**2).    
-000207f0: 2020 2020 2020 2020 666c 616d 5b2d 315d          flam[-1]
-00020800: 202a 3d20 666c 7578 5f73 6361 6c65 0a20   *= flux_scale. 
-00020810: 2020 2020 2020 2020 2020 2065 666c 616d             eflam
-00020820: 2e61 7070 656e 6428 7461 625b 6563 6f6c  .append(tab[ecol
-00020830: 5d5b 305d 2a6e 702e 6c6f 6728 3130 292f  ][0]*np.log(10)/
-00020840: 322e 352a 666c 616d 5b2d 315d 2a65 7272  2.5*flam[-1]*err
-00020850: 5f73 6361 6c65 290a 0a20 2020 2066 6f72  _scale)..    for
-00020860: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-00020870: 6669 6c74 6572 7329 295b 3a3a 2d31 5d3a  filters))[::-1]:
-00020880: 0a20 2020 2020 2020 2069 6620 6e70 2e69  .        if np.i
-00020890: 7373 6361 6c61 7228 666c 616d 5b69 5d29  sscalar(flam[i])
-000208a0: 2026 206e 702e 6973 7363 616c 6172 2865   & np.isscalar(e
-000208b0: 666c 616d 5b69 5d29 3a0a 2020 2020 2020  flam[i]):.      
-000208c0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-000208d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000208e0: 2020 2020 2020 2020 2066 6c61 6d2e 706f           flam.po
-000208f0: 7028 6929 0a20 2020 2020 2020 2020 2020  p(i).           
-00020900: 2065 666c 616d 2e70 6f70 2869 290a 2020   eflam.pop(i).  
-00020910: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
-00020920: 732e 706f 7028 6929 0a20 2020 2020 2020  s.pop(i).       
-00020930: 2020 2020 2070 6976 6f74 2e70 6f70 2869       pivot.pop(i
-00020940: 290a 0a20 2020 206c 6320 3d20 6e70 2e61  )..    lc = np.a
-00020950: 7272 6179 2870 6976 6f74 2920 2023 205b  rray(pivot)  # [
-00020960: 7069 766f 745b 6962 5d20 666f 7220 6962  pivot[ib] for ib
-00020970: 2069 6e20 7261 6e67 6528 6c65 6e28 6261   in range(len(ba
-00020980: 6e64 7329 295d 0a0a 2020 2020 6966 2074  nds))]..    if t
-00020990: 656d 706c 6174 6573 2069 7320 6e6f 7420  emplates is not 
-000209a0: 4e6f 6e65 3a0a 0a20 2020 2020 2020 2065  None:..        e
-000209b0: 617a 795f 7465 6d70 6c61 7465 7320 3d20  azy_templates = 
-000209c0: 5b54 656d 706c 6174 6528 6172 7261 7973  [Template(arrays
-000209d0: 3d28 7465 6d70 6c61 7465 735b 6b5d 2e77  =(templates[k].w
-000209e0: 6176 652c 2074 656d 706c 6174 6573 5b6b  ave, templates[k
-000209f0: 5d2e 666c 7578 292c 206e 616d 653d 6b29  ].flux), name=k)
-00020a00: 2066 6f72 206b 2069 6e20 7465 6d70 6c61   for k in templa
-00020a10: 7465 735d 0a0a 2020 2020 2020 2020 7a67  tes]..        zg
-00020a20: 7269 6420 3d20 6c6f 675f 7a67 7269 6428  rid = log_zgrid(
-00020a30: 7a72 3d5b 302e 3031 2c20 332e 345d 2c20  zr=[0.01, 3.4], 
-00020a40: 647a 3d30 2e30 3035 290a 0a20 2020 2020  dz=0.005)..     
-00020a50: 2020 2074 656d 7066 696c 7420 3d20 5465     tempfilt = Te
-00020a60: 6d70 6c61 7465 4772 6964 287a 6772 6964  mplateGrid(zgrid
-00020a70: 2c20 6561 7a79 5f74 656d 706c 6174 6573  , eazy_templates
-00020a80: 2c20 6669 6c74 6572 733d 6669 6c74 6572  , filters=filter
-00020a90: 732c 2061 6464 5f69 676d 3d54 7275 652c  s, add_igm=True,
-00020aa0: 2067 616c 6163 7469 635f 6562 763d 4d57   galactic_ebv=MW
-00020ab0: 5f45 4256 2c20 4562 3d30 2c20 6e5f 7072  _EBV, Eb=0, n_pr
-00020ac0: 6f63 3d30 2c20 7665 7262 6f73 653d 4661  oc=0, verbose=Fa
-00020ad0: 6c73 6529 0a20 2020 2065 6c73 653a 0a20  lse).    else:. 
-00020ae0: 2020 2020 2020 2074 656d 7066 696c 7420         tempfilt 
-00020af0: 3d20 4e6f 6e65 0a0a 2020 2020 7068 6f74  = None..    phot
-00020b00: 203d 204f 7264 6572 6564 4469 6374 285b   = OrderedDict([
-00020b10: 2827 666c 616d 272c 206e 702e 6172 7261  ('flam', np.arra
-00020b20: 7928 666c 616d 2929 2c20 2827 6566 6c61  y(flam)), ('efla
-00020b30: 6d27 2c20 6e70 2e61 7272 6179 2865 666c  m', np.array(efl
-00020b40: 616d 2929 2c20 2827 6669 6c74 6572 7327  am)), ('filters'
-00020b50: 2c20 6669 6c74 6572 7329 2c20 2827 7465  , filters), ('te
-00020b60: 6d70 6669 6c74 272c 2074 656d 7066 696c  mpfilt', tempfil
-00020b70: 7429 2c20 2827 6c63 272c 206e 702e 6172  t), ('lc', np.ar
-00020b80: 7261 7928 6c63 2929 2c20 2827 736f 7572  ray(lc)), ('sour
-00020b90: 6365 272c 2027 5669 7a69 6572 2027 2b76  ce', 'Vizier '+v
-00020ba0: 697a 5f74 6162 6c65 7329 5d29 0a0a 2020  iz_tables)])..  
-00020bb0: 2020 7265 7475 726e 2070 686f 740a 0a0a    return phot...
-00020bc0: 6465 6620 6765 6e65 7261 7465 5f74 656d  def generate_tem
-00020bd0: 7066 696c 7428 7465 6d70 6c61 7465 732c  pfilt(templates,
-00020be0: 2066 696c 7465 7273 2c20 7a67 7269 643d   filters, zgrid=
-00020bf0: 4e6f 6e65 2c20 4d57 5f45 4256 3d30 293a  None, MW_EBV=0):
-00020c00: 0a0a 2020 2020 6672 6f6d 2065 617a 792e  ..    from eazy.
-00020c10: 7465 6d70 6c61 7465 7320 696d 706f 7274  templates import
-00020c20: 2054 656d 706c 6174 650a 2020 2020 6672   Template.    fr
-00020c30: 6f6d 2065 617a 792e 7068 6f74 6f7a 2069  om eazy.photoz i
-00020c40: 6d70 6f72 7420 5465 6d70 6c61 7465 4772  mport TemplateGr
-00020c50: 6964 0a0a 2020 2020 2320 7477 6176 652c  id..    # twave,
-00020c60: 2074 666c 7578 2c20 6973 5f6c 696e 6520   tflux, is_line 
-00020c70: 3d20 6172 7261 795f 7465 6d70 6c61 7465  = array_template
-00020c80: 7328 7465 6d70 6c61 7465 732c 207a 3d30  s(templates, z=0
-00020c90: 290a 2020 2020 2320 6561 7a79 5f74 656d  ).    # eazy_tem
-00020ca0: 706c 6174 6573 203d 205b 5d0a 2020 2020  plates = [].    
-00020cb0: 2320 666f 7220 692c 2074 2069 6e20 656e  # for i, t in en
-00020cc0: 756d 6572 6174 6528 7465 6d70 6c61 7465  umerate(template
-00020cd0: 7329 3a0a 2020 2020 2320 2020 2020 6561  s):.    #     ea
-00020ce0: 7a79 5f74 656d 706c 6174 6573 2e61 7070  zy_templates.app
-00020cf0: 656e 6428 5465 6d70 6c61 7465 2861 7272  end(Template(arr
-00020d00: 6179 733d 5b74 7761 7665 2c20 6e70 2e6d  ays=[twave, np.m
-00020d10: 6178 696d 756d 2874 7761 7665 2c20 312e  aximum(twave, 1.
-00020d20: 652d 3330 295d 2c20 6e61 6d65 3d74 2929  e-30)], name=t))
-00020d30: 0a0a 2020 2020 6561 7a79 5f74 656d 706c  ..    eazy_templ
-00020d40: 6174 6573 203d 205b 5465 6d70 6c61 7465  ates = [Template
-00020d50: 2861 7272 6179 733d 2874 656d 706c 6174  (arrays=(templat
-00020d60: 6573 5b6b 5d2e 7761 7665 2c20 7465 6d70  es[k].wave, temp
-00020d70: 6c61 7465 735b 6b5d 2e66 6c75 7829 2c20  lates[k].flux), 
-00020d80: 6e61 6d65 3d6b 2920 666f 7220 6b20 696e  name=k) for k in
-00020d90: 2074 656d 706c 6174 6573 5d0a 0a20 2020   templates]..   
-00020da0: 2069 6620 7a67 7269 6420 6973 204e 6f6e   if zgrid is Non
-00020db0: 653a 0a20 2020 2020 2020 207a 6772 6964  e:.        zgrid
-00020dc0: 203d 206c 6f67 5f7a 6772 6964 287a 723d   = log_zgrid(zr=
-00020dd0: 5b30 2e30 312c 2033 2e34 5d2c 2064 7a3d  [0.01, 3.4], dz=
-00020de0: 302e 3030 3529 0a0a 2020 2020 7465 6d70  0.005)..    temp
-00020df0: 6669 6c74 203d 2054 656d 706c 6174 6547  filt = TemplateG
-00020e00: 7269 6428 7a67 7269 642c 2065 617a 795f  rid(zgrid, eazy_
-00020e10: 7465 6d70 6c61 7465 732c 2066 696c 7465  templates, filte
-00020e20: 7273 3d66 696c 7465 7273 2c20 6164 645f  rs=filters, add_
-00020e30: 6967 6d3d 5472 7565 2c20 6761 6c61 6374  igm=True, galact
-00020e40: 6963 5f65 6276 3d4d 575f 4542 562c 2045  ic_ebv=MW_EBV, E
-00020e50: 623d 302c 206e 5f70 726f 633d 302c 2076  b=0, n_proc=0, v
-00020e60: 6572 626f 7365 3d46 616c 7365 290a 0a20  erbose=False).. 
-00020e70: 2020 2072 6574 7572 6e20 7465 6d70 6669     return tempfi
-00020e80: 6c74 0a0a 0a64 6566 2063 6f6d 6269 6e65  lt...def combine
-00020e90: 5f70 686f 745f 6469 6374 2870 686f 7473  _phot_dict(phots
-00020ea0: 2c20 7465 6d70 6c61 7465 733d 4e6f 6e65  , templates=None
-00020eb0: 2c20 4d57 5f45 4256 3d30 293a 0a20 2020  , MW_EBV=0):.   
-00020ec0: 2022 2222 0a20 2020 2043 6f6d 6269 6e65   """.    Combine
-00020ed0: 2070 686f 746d 6574 7279 2064 6963 7469   photmetry dicti
-00020ee0: 6f6e 6172 6965 730a 2020 2020 2222 220a  onaries.    """.
-00020ef0: 2020 2020 7068 6f74 203d 207b 7d0a 2020      phot = {}.  
-00020f00: 2020 7068 6f74 5b27 666c 616d 275d 203d    phot['flam'] =
-00020f10: 205b 5d0a 2020 2020 7068 6f74 5b27 6566   [].    phot['ef
-00020f20: 6c61 6d27 5d20 3d20 5b5d 0a20 2020 2070  lam'] = [].    p
-00020f30: 686f 745b 2766 696c 7465 7273 275d 203d  hot['filters'] =
-00020f40: 205b 5d0a 2020 2020 666f 7220 7020 696e   [].    for p in
-00020f50: 2070 686f 7473 3a0a 2020 2020 2020 2020   phots:.        
-00020f60: 7068 6f74 5b27 666c 616d 275d 203d 206e  phot['flam'] = n
-00020f70: 702e 6170 7065 6e64 2870 686f 745b 2766  p.append(phot['f
-00020f80: 6c61 6d27 5d2c 2070 5b27 666c 616d 275d  lam'], p['flam']
-00020f90: 290a 2020 2020 2020 2020 7068 6f74 5b27  ).        phot['
-00020fa0: 6566 6c61 6d27 5d20 3d20 6e70 2e61 7070  eflam'] = np.app
-00020fb0: 656e 6428 7068 6f74 5b27 6566 6c61 6d27  end(phot['eflam'
-00020fc0: 5d2c 2070 5b27 6566 6c61 6d27 5d29 0a20  ], p['eflam']). 
-00020fd0: 2020 2020 2020 2070 686f 745b 2766 696c         phot['fil
-00020fe0: 7465 7273 275d 2e65 7874 656e 6428 705b  ters'].extend(p[
-00020ff0: 2766 696c 7465 7273 275d 290a 0a20 2020  'filters'])..   
-00021000: 2069 6620 7465 6d70 6c61 7465 7320 6973   if templates is
-00021010: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00021020: 2020 2070 686f 745b 2774 656d 7066 696c     phot['tempfil
-00021030: 7427 5d20 3d20 6765 6e65 7261 7465 5f74  t'] = generate_t
-00021040: 656d 7066 696c 7428 7465 6d70 6c61 7465  empfilt(template
-00021050: 732c 2070 686f 745b 2766 696c 7465 7273  s, phot['filters
-00021060: 275d 2c20 4d57 5f45 4256 3d4d 575f 4542  '], MW_EBV=MW_EB
-00021070: 5629 0a0a 2020 2020 7265 7475 726e 2070  V)..    return p
-00021080: 686f 740a 0a0a 6465 6620 6765 745f 7370  hot...def get_sp
-00021090: 6563 7472 756d 5f41 425f 6d61 6773 2873  ectrum_AB_mags(s
-000210a0: 7065 6374 7275 6d2c 2062 616e 6470 6173  pectrum, bandpas
-000210b0: 7365 733d 5b5d 293a 0a20 2020 2022 2222  ses=[]):.    """
-000210c0: 0a20 2020 2049 6e74 6567 7261 7465 2061  .    Integrate a
-000210d0: 2060 7e70 7973 796e 7068 6f74 6020 7370   `~pysynphot` sp
-000210e0: 6563 7472 756d 2074 6872 6f75 6768 2066  ectrum through f
-000210f0: 696c 7465 7220 6261 6e64 7061 7373 6573  ilter bandpasses
-00021100: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00021110: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00021120: 2020 2020 7370 6563 7472 756d 203a 2074      spectrum : t
-00021130: 7970 650a 0a20 2020 2062 616e 6470 6173  ype..    bandpas
-00021140: 7365 7320 3a20 6c69 7374 0a20 2020 2020  ses : list.     
-00021150: 2020 204c 6973 7420 6f66 2060 7079 7379     List of `pysy
-00021160: 6e70 686f 7460 2062 616e 6470 6173 7320  nphot` bandpass 
-00021170: 6f62 6a65 6374 732c 2065 2e67 2e2c 0a0a  objects, e.g.,..
-00021180: 2020 2020 2020 2020 2020 203e 3e3e 2069             >>> i
-00021190: 6d70 6f72 7420 7079 7379 6e70 686f 7420  mport pysynphot 
-000211a0: 6173 2053 0a20 2020 2020 2020 2020 2020  as S.           
-000211b0: 3e3e 3e20 6261 6e64 7061 7373 6573 203d  >>> bandpasses =
-000211c0: 205b 532e 4f62 7342 616e 6470 6173 7328   [S.ObsBandpass(
-000211d0: 2777 6663 332c 6972 2c66 3134 3077 2729  'wfc3,ir,f140w')
-000211e0: 5d0a 0a0a 2020 2020 5265 7475 726e 730a  ]...    Returns.
-000211f0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00021200: 6162 5f6d 6167 7320 3a20 6469 6374 0a20  ab_mags : dict. 
-00021210: 2020 2020 2020 2044 6963 7469 6f6e 6172         Dictionar
-00021220: 7920 7769 7468 206b 6579 7320 6672 6f6d  y with keys from
-00021230: 2060 6261 6e64 7061 7373 6573 6020 616e   `bandpasses` an
-00021240: 6420 7468 6520 696e 7465 6772 6174 6564  d the integrated
-00021250: 206d 6167 6e69 7475 6465 730a 0a20 2020   magnitudes..   
-00021260: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
-00021270: 7079 7379 6e70 686f 7420 6173 2053 0a20  pysynphot as S. 
-00021280: 2020 2066 6c61 7420 3d20 532e 466c 6174     flat = S.Flat
-00021290: 5370 6563 7472 756d 2830 2c20 666c 7578  Spectrum(0, flux
-000212a0: 756e 6974 733d 2741 424d 6167 2729 0a20  units='ABMag'). 
-000212b0: 2020 2061 625f 6d61 6773 203d 204f 7264     ab_mags = Ord
-000212c0: 6572 6564 4469 6374 2829 0a0a 2020 2020  eredDict()..    
-000212d0: 666f 7220 6270 2069 6e20 6261 6e64 7061  for bp in bandpa
-000212e0: 7373 6573 3a0a 2020 2020 2020 2020 666c  sses:.        fl
-000212f0: 6174 5f6f 6273 203d 2053 2e4f 6273 6572  at_obs = S.Obser
-00021300: 7661 7469 6f6e 2866 6c61 742c 2062 7029  vation(flat, bp)
-00021310: 0a20 2020 2020 2020 2073 7065 635f 6f62  .        spec_ob
-00021320: 7320 3d20 532e 4f62 7365 7276 6174 696f  s = S.Observatio
-00021330: 6e28 7370 6563 7472 756d 2c20 6270 290a  n(spectrum, bp).
-00021340: 2020 2020 2020 2020 6162 5f6d 6167 735b          ab_mags[
-00021350: 6270 2e6e 616d 655d 203d 202d 322e 352a  bp.name] = -2.5*
-00021360: 6e70 2e6c 6f67 3130 2873 7065 635f 6f62  np.log10(spec_ob
-00021370: 732e 636f 756e 7472 6174 6528 292f 666c  s.countrate()/fl
-00021380: 6174 5f6f 6273 2e63 6f75 6e74 7261 7465  at_obs.countrate
-00021390: 2829 290a 0a20 2020 2072 6574 7572 6e20  ())..    return 
-000213a0: 6162 5f6d 6167 730a 0a0a 6465 6620 6c6f  ab_mags...def lo
-000213b0: 675f 7a67 7269 6428 7a72 3d5b 302e 372c  g_zgrid(zr=[0.7,
-000213c0: 2033 2e34 5d2c 2064 7a3d 302e 3031 293a   3.4], dz=0.01):
-000213d0: 0a20 2020 2022 2222 4d61 6b65 2061 206c  .    """Make a l
-000213e0: 6f67 6172 6974 686d 6963 616c 6c79 2073  ogarithmically s
-000213f0: 7061 6365 6420 7265 6473 6869 6674 2067  paced redshift g
-00021400: 7269 640a 0a20 2020 2050 6172 616d 6574  rid..    Paramet
-00021410: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00021420: 2d2d 0a20 2020 207a 7220 3a20 5b66 6c6f  --.    zr : [flo
-00021430: 6174 2c20 666c 6f61 745d 0a20 2020 2020  at, float].     
-00021440: 2020 204d 696e 696d 756d 2061 6e64 206d     Minimum and m
-00021450: 6178 696d 756d 206f 6620 7468 6520 6465  aximum of the de
-00021460: 7369 7265 6420 6772 6964 0a0a 2020 2020  sired grid..    
-00021470: 647a 203a 2066 6c6f 6174 0a20 2020 2020  dz : float.     
-00021480: 2020 2053 7465 7020 7369 7a65 2c20 647a     Step size, dz
-00021490: 2f28 312b 7a29 0a0a 2020 2020 5265 7475  /(1+z)..    Retu
-000214a0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-000214b0: 2020 2020 7a67 7269 6420 3a20 6172 7261      zgrid : arra
-000214c0: 792d 6c69 6b65 0a20 2020 2020 2020 2052  y-like.        R
-000214d0: 6564 7368 6966 7420 6772 6964 0a0a 2020  edshift grid..  
-000214e0: 2020 2222 220a 2020 2020 7a67 7269 6420    """.    zgrid 
-000214f0: 3d20 6e70 2e65 7870 286e 702e 6172 616e  = np.exp(np.aran
-00021500: 6765 286e 702e 6c6f 6728 312b 7a72 5b30  ge(np.log(1+zr[0
-00021510: 5d29 2c20 6e70 2e6c 6f67 2831 2b7a 725b  ]), np.log(1+zr[
-00021520: 315d 292c 2064 7a29 292d 310a 2020 2020  1]), dz))-1.    
-00021530: 7265 7475 726e 207a 6772 6964 0a0a 6465  return zgrid..de
-00021540: 6620 7472 6170 7a5f 6478 2878 293a 0a20  f trapz_dx(x):. 
-00021550: 2020 2022 2222 0a20 2020 2052 6574 7572     """.    Retur
-00021560: 6e20 7472 6170 657a 6f69 6420 7275 6c65  n trapezoid rule
-00021570: 2063 6f65 6666 6963 6965 6e74 732c 2075   coefficients, u
-00021580: 7365 6675 6c20 666f 7220 6e75 6d65 7269  seful for numeri
-00021590: 6361 6c20 696e 7465 6772 6174 696f 6e20  cal integration 
-000215a0: 0a20 2020 2075 7369 6e67 2061 2064 6f74  .    using a dot
-000215b0: 2070 726f 6475 6374 0a20 2020 200a 2020   product.    .  
-000215c0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-000215d0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-000215e0: 7820 3a20 6172 7261 792d 6c69 6b65 0a20  x : array-like. 
-000215f0: 2020 2020 2020 2049 6e64 6570 656e 6465         Independe
-00021600: 6e74 2076 6172 6961 626c 650a 2020 2020  nt variable.    
-00021610: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00021620: 202d 2d2d 2d2d 2d2d 0a20 2020 2064 7820   -------.    dx 
-00021630: 3a20 6172 7261 795f 6c69 6b65 0a20 2020  : array_like.   
-00021640: 2020 2020 2043 6f65 6666 6963 6965 6e74       Coefficient
-00021650: 7320 666f 7220 7472 6170 657a 6f69 6461  s for trapezoida
-00021660: 6c20 7275 6c65 2069 6e74 6567 7261 7469  l rule integrati
-00021670: 6f6e 2e0a 2020 2020 2020 2020 0a20 2020  on..        .   
-00021680: 2022 2222 0a20 2020 2064 7820 3d20 6e70   """.    dx = np
-00021690: 2e7a 6572 6f73 5f6c 696b 6528 7829 0a20  .zeros_like(x). 
-000216a0: 2020 2064 6966 6620 3d20 6e70 2e64 6966     diff = np.dif
-000216b0: 6628 7829 2f32 2e0a 2020 2020 6478 5b3a  f(x)/2..    dx[:
-000216c0: 2d31 5d20 2b3d 2064 6966 660a 2020 2020  -1] += diff.    
-000216d0: 6478 5b31 3a5d 202b 3d20 6469 6666 0a20  dx[1:] += diff. 
-000216e0: 2020 2072 6574 7572 6e20 6478 0a0a 0a64     return dx...d
-000216f0: 6566 2067 6574 5f77 6373 5f70 7363 616c  ef get_wcs_pscal
-00021700: 6528 7763 732c 2073 6574 5f61 7474 7269  e(wcs, set_attri
-00021710: 6275 7465 3d54 7275 6529 3a0a 2020 2020  bute=True):.    
-00021720: 2222 2247 6574 2063 6f72 7265 6374 2070  """Get correct p
-00021730: 7363 616c 6520 6672 6f6d 2061 2060 7e61  scale from a `~a
-00021740: 7374 726f 7079 2e77 6373 2e57 4353 6020  stropy.wcs.WCS` 
-00021750: 6f62 6a65 6374 0a0a 2020 2020 5061 7261  object..    Para
-00021760: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00021770: 2d2d 2d2d 2d0a 2020 2020 7763 7320 3a20  -----.    wcs : 
-00021780: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
-00021790: 5360 206f 7220 607e 6173 7472 6f70 792e  S` or `~astropy.
-000217a0: 696f 2e66 6974 732e 4865 6164 6572 600a  io.fits.Header`.
-000217b0: 0a20 2020 2073 6574 5f61 7474 7269 6275  .    set_attribu
-000217c0: 7465 203a 2062 6f6f 6c0a 2020 2020 2020  te : bool.      
-000217d0: 2020 5365 7420 7468 6520 6070 7363 616c    Set the `pscal
-000217e0: 6560 2061 7474 7269 6275 7465 206f 6e20  e` attribute on 
-000217f0: 6077 6373 602c 2061 6c6f 6e67 2077 6974  `wcs`, along wit
-00021800: 6820 7265 7475 726e 696e 6720 7468 6520  h returning the 
-00021810: 7661 6c75 652e 0a0a 2020 2020 5265 7475  value...    Retu
-00021820: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00021830: 2020 2020 7073 6361 6c65 203a 2066 6c6f      pscale : flo
-00021840: 6174 0a20 2020 2020 2020 2050 6978 656c  at.        Pixel
-00021850: 2073 6361 6c65 2066 726f 6d20 6077 6373   scale from `wcs
-00021860: 2e63 6460 0a0a 2020 2020 2222 220a 2020  .cd`..    """.  
-00021870: 2020 6672 6f6d 206e 756d 7079 2069 6d70    from numpy imp
-00021880: 6f72 7420 6c69 6e61 6c67 0a0a 2020 2020  ort linalg..    
-00021890: 6966 2069 7369 6e73 7461 6e63 6528 7763  if isinstance(wc
-000218a0: 732c 2070 7966 6974 732e 4865 6164 6572  s, pyfits.Header
-000218b0: 293a 0a20 2020 2020 2020 2077 6373 203d  ):.        wcs =
-000218c0: 2070 7977 6373 2e57 4353 2877 6373 2c20   pywcs.WCS(wcs, 
-000218d0: 7265 6c61 783d 5472 7565 290a 0a20 2020  relax=True)..   
-000218e0: 2069 6620 6861 7361 7474 7228 7763 732e   if hasattr(wcs.
-000218f0: 7763 732c 2027 6364 2729 3a0a 2020 2020  wcs, 'cd'):.    
-00021900: 2020 2020 6465 7420 3d20 6c69 6e61 6c67      det = linalg
-00021910: 2e64 6574 2877 6373 2e77 6373 2e63 6429  .det(wcs.wcs.cd)
-00021920: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00021930: 2020 2064 6574 203d 206c 696e 616c 672e     det = linalg.
-00021940: 6465 7428 7763 732e 7763 732e 7063 290a  det(wcs.wcs.pc).
-00021950: 0a20 2020 2070 7363 616c 6520 3d20 6e70  .    pscale = np
-00021960: 2e73 7172 7428 6e70 2e61 6273 2864 6574  .sqrt(np.abs(det
-00021970: 2929 2a33 3630 302e 0a20 2020 200a 2020  ))*3600..    .  
-00021980: 2020 7769 7468 2077 6172 6e69 6e67 732e    with warnings.
-00021990: 6361 7463 685f 7761 726e 696e 6773 2829  catch_warnings()
-000219a0: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
-000219b0: 6773 2e66 696c 7465 7277 6172 6e69 6e67  gs.filterwarning
-000219c0: 7328 2769 676e 6f72 6527 2c20 0a20 2020  s('ignore', .   
-000219d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000219e0: 6364 656c 7420 7769 6c6c 2062 6520 6967  cdelt will be ig
-000219f0: 6e6f 7265 6420 7369 6e63 6520 6364 2069  nored since cd i
-00021a00: 7320 7072 6573 656e 7427 2c20 5275 6e74  s present', Runt
-00021a10: 696d 6557 6172 6e69 6e67 290a 2020 2020  imeWarning).    
-00021a20: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-00021a30: 6861 7361 7474 7228 7763 732e 7763 732c  hasattr(wcs.wcs,
-00021a40: 2027 6364 656c 7427 293a 0a20 2020 2020   'cdelt'):.     
-00021a50: 2020 2020 2020 2070 7363 616c 6520 2a3d         pscale *=
-00021a60: 2077 6373 2e77 6373 2e63 6465 6c74 5b30   wcs.wcs.cdelt[0
-00021a70: 5d0a 2020 2020 2020 2020 0a20 2020 2077  ].        .    w
-00021a80: 6373 2e70 7363 616c 6520 3d20 7073 6361  cs.pscale = psca
-00021a90: 6c65 0a0a 2020 2020 7265 7475 726e 2070  le..    return p
-00021aa0: 7363 616c 650a 0a0a 6465 6620 7472 616e  scale...def tran
-00021ab0: 7366 6f72 6d5f 7763 7328 696e 5f77 6373  sform_wcs(in_wcs
-00021ac0: 2c20 7472 616e 736c 6174 696f 6e3d 5b30  , translation=[0
-00021ad0: 2e2c 2030 2e5d 2c20 726f 7461 7469 6f6e  ., 0.], rotation
-00021ae0: 3d30 2e2c 2073 6361 6c65 3d31 2e29 3a0a  =0., scale=1.):.
-00021af0: 2020 2020 2222 2255 7064 6174 6520 5743      """Update WC
-00021b00: 5320 7769 7468 2073 6869 6674 2c20 726f  S with shift, ro
-00021b10: 7461 7469 6f6e 2c20 2620 7363 616c 650a  tation, & scale.
-00021b20: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-00021b30: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00021b40: 2020 2069 6e5f 7763 733a 2060 7e61 7374     in_wcs: `~ast
-00021b50: 726f 7079 2e77 6373 2e57 4353 600a 2020  ropy.wcs.WCS`.  
-00021b60: 2020 2020 2020 496e 7075 7420 5743 530a        Input WCS.
-00021b70: 0a20 2020 2074 7261 6e73 6c61 7469 6f6e  .    translation
-00021b80: 3a20 5b66 6c6f 6174 2c20 666c 6f61 745d  : [float, float]
-00021b90: 0a20 2020 2020 2020 2078 7368 6966 7420  .        xshift 
-00021ba0: 2620 7973 6869 6674 2069 6e20 7069 7865  & yshift in pixe
-00021bb0: 6c73 0a0a 2020 2020 726f 7461 7469 6f6e  ls..    rotation
-00021bc0: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-00021bd0: 4343 5720 726f 7461 7469 6f6e 2028 746f  CCW rotation (to
-00021be0: 7761 7264 7320 4561 7374 292c 2072 6164  wards East), rad
-00021bf0: 6961 6e73 0a0a 2020 2020 7363 616c 653a  ians..    scale:
-00021c00: 2066 6c6f 6174 0a20 2020 2020 2020 2050   float.        P
-00021c10: 6978 656c 2073 6361 6c65 2066 6163 746f  ixel scale facto
-00021c20: 720a 0a20 2020 2052 6574 7572 6e73 0a20  r..    Returns. 
-00021c30: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 206f     -------.    o
-00021c40: 7574 5f77 6373 3a20 607e 6173 7472 6f70  ut_wcs: `~astrop
-00021c50: 792e 7763 732e 5743 5360 0a20 2020 2020  y.wcs.WCS`.     
-00021c60: 2020 204d 6f64 6966 6965 6420 5743 530a     Modified WCS.
-00021c70: 2020 2020 2222 220a 2020 2020 6f75 745f      """.    out_
-00021c80: 7763 7320 3d20 696e 5f77 6373 2e64 6565  wcs = in_wcs.dee
-00021c90: 7063 6f70 7928 290a 0a20 2020 2023 6f75  pcopy()..    #ou
-00021ca0: 745f 7763 732e 7763 732e 6372 7069 7820  t_wcs.wcs.crpix 
-00021cb0: 2b3d 206e 702e 6172 7261 7928 7472 616e  += np.array(tran
-00021cc0: 736c 6174 696f 6e29 0a0a 2020 2020 2320  slation)..    # 
-00021cd0: 436f 6d70 7574 6520 7368 6966 7420 666f  Compute shift fo
-00021ce0: 7220 6372 7661 6c2c 206e 6f74 2063 7270  r crval, not crp
-00021cf0: 6978 0a20 2020 2063 7276 616c 203d 2069  ix.    crval = i
-00021d00: 6e5f 7763 732e 616c 6c5f 7069 7832 776f  n_wcs.all_pix2wo
-00021d10: 726c 6428 5b69 6e5f 7763 732e 7763 732e  rld([in_wcs.wcs.
-00021d20: 6372 7069 782d 6e70 2e61 7272 6179 2874  crpix-np.array(t
-00021d30: 7261 6e73 6c61 7469 6f6e 295d 2c0a 2020  ranslation)],.  
-00021d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d60: 2020 2031 292e 666c 6174 7465 6e28 290a     1).flatten().
-00021d70: 0a20 2020 2023 2043 6f6d 7075 7465 2073  .    # Compute s
-00021d80: 6869 6674 2061 7420 696d 6167 6520 6365  hift at image ce
-00021d90: 6e74 6572 0a20 2020 2069 6620 6861 7361  nter.    if hasa
-00021da0: 7474 7228 696e 5f77 6373 2c20 275f 6e61  ttr(in_wcs, '_na
-00021db0: 7869 7331 2729 3a0a 2020 2020 2020 2020  xis1'):.        
-00021dc0: 7265 6670 6978 203d 206e 702e 6172 7261  refpix = np.arra
-00021dd0: 7928 5b69 6e5f 7763 732e 5f6e 6178 6973  y([in_wcs._naxis
-00021de0: 312f 322e 2c20 696e 5f77 6373 2e5f 6e61  1/2., in_wcs._na
-00021df0: 7869 7332 2f32 2e5d 290a 2020 2020 656c  xis2/2.]).    el
-00021e00: 7365 3a0a 2020 2020 2020 2020 7265 6670  se:.        refp
-00021e10: 6978 203d 206e 702e 6172 7261 7928 696e  ix = np.array(in
-00021e20: 5f77 6373 2e5f 6e61 7869 7329 2f32 2e0a  _wcs._naxis)/2..
-00021e30: 0a20 2020 2063 3020 3d20 696e 5f77 6373  .    c0 = in_wcs
-00021e40: 2e61 6c6c 5f70 6978 3277 6f72 6c64 285b  .all_pix2world([
-00021e50: 7265 6670 6978 5d2c 2031 292e 666c 6174  refpix], 1).flat
-00021e60: 7465 6e28 290a 2020 2020 6331 203d 2069  ten().    c1 = i
-00021e70: 6e5f 7763 732e 616c 6c5f 7069 7832 776f  n_wcs.all_pix2wo
-00021e80: 726c 6428 5b72 6566 7069 782d 6e70 2e61  rld([refpix-np.a
-00021e90: 7272 6179 2874 7261 6e73 6c61 7469 6f6e  rray(translation
-00021ea0: 295d 2c20 3129 2e66 6c61 7474 656e 2829  )], 1).flatten()
-00021eb0: 0a0a 2020 2020 6f75 745f 7763 732e 7763  ..    out_wcs.wc
-00021ec0: 732e 6372 7661 6c20 2b3d 2063 312d 6330  s.crval += c1-c0
-00021ed0: 0a0a 2020 2020 7468 6574 6120 3d20 2d72  ..    theta = -r
-00021ee0: 6f74 6174 696f 6e0a 2020 2020 5f6d 6174  otation.    _mat
-00021ef0: 203d 206e 702e 6172 7261 7928 5b5b 6e70   = np.array([[np
-00021f00: 2e63 6f73 2874 6865 7461 292c 202d 6e70  .cos(theta), -np
-00021f10: 2e73 696e 2874 6865 7461 295d 2c0a 2020  .sin(theta)],.  
-00021f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f30: 2020 205b 6e70 2e73 696e 2874 6865 7461     [np.sin(theta
-00021f40: 292c 206e 702e 636f 7328 7468 6574 6129  ), np.cos(theta)
-00021f50: 5d5d 290a 0a20 2020 2074 7279 3a0a 2020  ]])..    try:.  
-00021f60: 2020 2020 2020 6f75 745f 7763 732e 7763        out_wcs.wc
-00021f70: 732e 6364 5b3a 322c 3a32 5d20 3d20 6e70  s.cd[:2,:2] = np
-00021f80: 2e64 6f74 286f 7574 5f77 6373 2e77 6373  .dot(out_wcs.wcs
-00021f90: 2e63 645b 3a32 2c3a 325d 2c20 5f6d 6174  .cd[:2,:2], _mat
-00021fa0: 292f 7363 616c 650a 2020 2020 6578 6365  )/scale.    exce
-00021fb0: 7074 3a0a 2020 2020 2020 2020 6f75 745f  pt:.        out_
-00021fc0: 7763 732e 7763 732e 7063 203d 206e 702e  wcs.wcs.pc = np.
-00021fd0: 646f 7428 6f75 745f 7763 732e 7763 732e  dot(out_wcs.wcs.
-00021fe0: 7063 2c20 5f6d 6174 292f 7363 616c 650a  pc, _mat)/scale.
-00021ff0: 0a20 2020 206f 7574 5f77 6373 2e70 7363  .    out_wcs.psc
-00022000: 616c 6520 3d20 6765 745f 7763 735f 7073  ale = get_wcs_ps
-00022010: 6361 6c65 286f 7574 5f77 6373 290a 2020  cale(out_wcs).  
-00022020: 2020 236f 7574 5f77 6373 2e77 6373 2e63    #out_wcs.wcs.c
-00022030: 7270 6978 202a 3d20 7363 616c 650a 2020  rpix *= scale.  
-00022040: 2020 6966 2068 6173 6174 7472 286f 7574    if hasattr(out
-00022050: 5f77 6373 2c20 2770 6978 656c 5f73 6861  _wcs, 'pixel_sha
-00022060: 7065 2729 3a0a 2020 2020 2020 2020 5f6e  pe'):.        _n
-00022070: 6178 6973 3120 3d20 696e 7428 6e70 2e72  axis1 = int(np.r
-00022080: 6f75 6e64 286f 7574 5f77 6373 2e70 6978  ound(out_wcs.pix
-00022090: 656c 5f73 6861 7065 5b30 5d2a 7363 616c  el_shape[0]*scal
-000220a0: 6529 290a 2020 2020 2020 2020 5f6e 6178  e)).        _nax
-000220b0: 6973 3220 3d20 696e 7428 6e70 2e72 6f75  is2 = int(np.rou
-000220c0: 6e64 286f 7574 5f77 6373 2e70 6978 656c  nd(out_wcs.pixel
-000220d0: 5f73 6861 7065 5b31 5d2a 7363 616c 6529  _shape[1]*scale)
-000220e0: 290a 2020 2020 2020 2020 6f75 745f 7763  ).        out_wc
-000220f0: 732e 5f6e 6178 6973 203d 205b 5f6e 6178  s._naxis = [_nax
-00022100: 6973 312c 205f 6e61 7869 7332 5d0a 2020  is1, _naxis2].  
-00022110: 2020 656c 6966 2068 6173 6174 7472 286f    elif hasattr(o
-00022120: 7574 5f77 6373 2c20 275f 6e61 7869 7331  ut_wcs, '_naxis1
-00022130: 2729 3a0a 2020 2020 2020 2020 6f75 745f  '):.        out_
-00022140: 7763 732e 5f6e 6178 6973 3120 3d20 696e  wcs._naxis1 = in
-00022150: 7428 6e70 2e72 6f75 6e64 286f 7574 5f77  t(np.round(out_w
-00022160: 6373 2e5f 6e61 7869 7331 2a73 6361 6c65  cs._naxis1*scale
-00022170: 2929 0a20 2020 2020 2020 206f 7574 5f77  )).        out_w
-00022180: 6373 2e5f 6e61 7869 7332 203d 2069 6e74  cs._naxis2 = int
-00022190: 286e 702e 726f 756e 6428 6f75 745f 7763  (np.round(out_wc
-000221a0: 732e 5f6e 6178 6973 322a 7363 616c 6529  s._naxis2*scale)
-000221b0: 290a 0a20 2020 2072 6574 7572 6e20 6f75  )..    return ou
-000221c0: 745f 7763 730a 0a0a 6465 6620 7369 705f  t_wcs...def sip_
-000221d0: 726f 7439 3028 696e 7075 742c 2072 6f74  rot90(input, rot
-000221e0: 2c20 7265 7665 7273 653d 4661 6c73 652c  , reverse=False,
-000221f0: 2076 6572 626f 7365 3d46 616c 7365 2c20   verbose=False, 
-00022200: 636f 6d70 6172 653d 4661 6c73 6529 3a0a  compare=False):.
-00022210: 2020 2020 2222 220a 2020 2020 526f 7461      """.    Rota
-00022220: 7465 2061 2053 4950 2057 4353 2062 7920  te a SIP WCS by 
-00022230: 696e 6372 656d 656e 7473 206f 6620 3930  increments of 90
-00022240: 2064 6567 7265 6573 2075 7369 6e67 2064   degrees using d
-00022250: 6972 6563 7420 7472 616e 7366 6f72 6d61  irect transforma
-00022260: 7469 6f6e 730a 2020 2020 6265 7477 6565  tions.    betwee
-00022270: 6e20 7820 2f20 7920 636f 6f72 6469 6e61  n x / y coordina
-00022280: 7465 730a 2020 2020 0a20 2020 2050 6172  tes.    .    Par
-00022290: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-000222a0: 2d2d 2d2d 2d2d 0a20 2020 2069 6e70 7574  ------.    input
-000222b0: 203a 2060 7e61 7374 726f 7079 2e69 6f2e   : `~astropy.io.
-000222c0: 6669 7473 2e48 6561 6465 7260 206f 7220  fits.Header` or 
-000222d0: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
-000222e0: 5360 0a20 2020 2020 2020 2048 6561 6465  S`.        Heade
-000222f0: 7220 6f72 2057 4353 0a20 2020 200a 2020  r or WCS.    .  
-00022300: 2020 726f 7420 3a20 696e 740a 2020 2020    rot : int.    
-00022310: 2020 2020 4e75 6d62 6572 206f 6620 7469      Number of ti
-00022320: 6d65 7320 746f 2072 6f74 6174 6520 7468  mes to rotate th
-00022330: 6520 5743 5320 3930 2064 6567 7265 6573  e WCS 90 degrees
-00022340: 202a 636c 6f63 6b77 6973 652a 2c20 616e   *clockwise*, an
-00022350: 616c 6f67 6f75 730a 2020 2020 2020 2020  alogous.        
-00022360: 746f 2060 6e75 6d70 792e 726f 7439 3060  to `numpy.rot90`
-00022370: 0a20 2020 200a 2020 2020 7265 7665 7273  .    .    revers
-00022380: 6520 3a20 626f 6f6c 0a20 2020 2020 2020  e : bool.       
-00022390: 2049 6620 6069 6e70 7574 6020 6973 2061   If `input` is a
-000223a0: 2068 6561 6465 7220 616e 6420 696e 636c   header and incl
-000223b0: 7564 6573 2061 206b 6579 776f 7264 2060  udes a keyword `
-000223c0: 6052 4f54 3930 6060 2c20 7468 656e 2075  `ROT90``, then u
-000223d0: 6e64 6f20 0a20 2020 2020 2020 2074 6865  ndo .        the
-000223e0: 2072 6f74 6174 696f 6e20 616e 6420 7265   rotation and re
-000223f0: 6d6f 7665 2074 6865 206b 6579 776f 7264  move the keyword
-00022400: 2066 726f 6d20 7468 6520 6f75 7470 7574   from the output
-00022410: 2068 6561 6465 720a 2020 2020 2020 2020   header.        
-00022420: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00022430: 202d 2d2d 2d2d 2d2d 0a20 2020 2068 6561   -------.    hea
-00022440: 6465 7220 3a20 607e 6173 7472 6f70 792e  der : `~astropy.
-00022450: 696f 2e66 6974 732e 4865 6164 6572 600a  io.fits.Header`.
-00022460: 2020 2020 2020 2020 526f 7461 7465 6420          Rotated 
-00022470: 5743 5320 6865 6164 6572 0a20 2020 2020  WCS header.     
-00022480: 2020 200a 2020 2020 7763 7320 3a20 607e     .    wcs : `~
-00022490: 6173 7472 6f70 792e 7763 732e 5743 5360  astropy.wcs.WCS`
-000224a0: 0a20 2020 2020 2020 2052 6f74 6174 6564  .        Rotated
-000224b0: 2057 4353 0a20 2020 200a 2020 2020 6465   WCS.    .    de
-000224c0: 7363 203a 2073 7472 0a20 2020 2020 2020  sc : str.       
-000224d0: 2044 6573 6372 6970 7469 6f6e 206f 6620   Description of 
-000224e0: 7468 6520 7472 616e 7366 6f72 6d20 6173  the transform as
-000224f0: 736f 6369 6174 6564 2077 6974 6820 6060  sociated with ``
-00022500: 726f 7460 602c 2065 2e67 2c20 0a20 2020  rot``, e.g, .   
-00022510: 2020 2020 2060 6078 3d6e 782d 782c 2079       ``x=nx-x, y
-00022520: 3d6e 792d 7960 6020 666f 7220 6060 726f  =ny-y`` for ``ro
-00022530: 743d c2b1 3260 602e 0a20 2020 2020 2020  t=..2``..       
-00022540: 200a 2020 2020 2222 220a 2020 2020 696d   .    """.    im
-00022550: 706f 7274 2063 6f70 790a 2020 2020 696d  port copy.    im
-00022560: 706f 7274 2061 7374 726f 7079 2e69 6f2e  port astropy.io.
-00022570: 6669 7473 0a20 2020 2069 6d70 6f72 7420  fits.    import 
-00022580: 6173 7472 6f70 792e 7763 730a 2020 2020  astropy.wcs.    
-00022590: 696d 706f 7274 206d 6174 706c 6f74 6c69  import matplotli
-000225a0: 622e 7079 706c 6f74 2061 7320 706c 740a  b.pyplot as plt.
-000225b0: 2020 2020 0a20 2020 2069 6620 6973 696e      .    if isin
-000225c0: 7374 616e 6365 2869 6e70 7574 2c20 6173  stance(input, as
-000225d0: 7472 6f70 792e 696f 2e66 6974 732e 4865  tropy.io.fits.He
-000225e0: 6164 6572 293a 0a20 2020 2020 2020 206f  ader):.        o
-000225f0: 7269 6720 3d20 636f 7079 2e64 6565 7063  rig = copy.deepc
-00022600: 6f70 7928 696e 7075 7429 0a20 2020 2020  opy(input).     
-00022610: 2020 206e 6577 203d 2063 6f70 792e 6465     new = copy.de
-00022620: 6570 636f 7079 2869 6e70 7574 290a 2020  epcopy(input).  
-00022630: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-00022640: 6620 2827 524f 5439 3027 2069 6e20 696e  f ('ROT90' in in
-00022650: 7075 7429 3a0a 2020 2020 2020 2020 2020  put):.          
-00022660: 2020 6966 2072 6576 6572 7365 3a0a 2020    if reverse:.  
-00022670: 2020 2020 2020 2020 2020 2020 2020 726f                ro
-00022680: 7420 3d20 2d6f 7269 675b 2752 4f54 3930  t = -orig['ROT90
-00022690: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-000226a0: 2020 206e 6577 2e72 656d 6f76 6528 2752     new.remove('R
-000226b0: 4f54 3930 2729 0a20 2020 2020 2020 2020  OT90').         
-000226c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000226d0: 2020 2020 2020 2020 206e 6577 5b27 524f           new['RO
-000226e0: 5439 3027 5d20 3d20 6f72 6967 5b27 524f  T90'] = orig['RO
-000226f0: 5439 3027 5d20 2b20 726f 740a 2020 2020  T90'] + rot.    
-00022700: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00022710: 2020 2020 2020 6e65 775b 2752 4f54 3930        new['ROT90
-00022720: 275d 203d 2072 6f74 0a20 2020 2065 6c73  '] = rot.    els
-00022730: 653a 0a20 2020 2020 2020 206f 7269 6720  e:.        orig 
-00022740: 3d20 746f 5f68 6561 6465 7228 696e 7075  = to_header(inpu
-00022750: 7429 0a20 2020 2020 2020 206e 6577 203d  t).        new =
-00022760: 2074 6f5f 6865 6164 6572 2869 6e70 7574   to_header(input
-00022770: 290a 0a20 2020 206f 7269 675f 7763 7320  )..    orig_wcs 
-00022780: 3d20 7079 7763 732e 5743 5328 6f72 6967  = pywcs.WCS(orig
-00022790: 2c20 7265 6c61 783d 5472 7565 290a 0a20  , relax=True).. 
-000227a0: 2020 2023 2323 2043 4420 3d20 5b5b 6472     ### CD = [[dr
-000227b0: 612f 6478 2c20 6472 612f 6479 5d2c 205b  a/dx, dra/dy], [
-000227c0: 6464 652f 6478 2c20 6464 652f 6479 5d5d  dde/dx, dde/dy]]
-000227d0: 0a20 2020 2023 2323 2078 203d 2061 5f69  .    ### x = a_i
-000227e0: 5f6a 202a 2075 2a2a 6920 2a20 762a 2a6a  _j * u**i * v**j
-000227f0: 0a20 2020 2023 2323 2079 203d 2062 5f69  .    ### y = b_i
-00022800: 5f6a 202a 2075 2a2a 6920 2a20 762a 2a6a  _j * u**i * v**j
-00022810: 0a20 2020 200a 2020 2020 6978 203d 2031  .    .    ix = 1
-00022820: 0a20 2020 200a 2020 2020 6966 2063 6f6d  .    .    if com
-00022830: 7061 7265 3a0a 2020 2020 2020 2020 7861  pare:.        xa
-00022840: 7272 203d 206e 702e 6172 616e 6765 2830  rr = np.arange(0
-00022850: 2c32 3034 382c 3634 290a 2020 2020 2020  ,2048,64).      
-00022860: 2020 7870 2c20 7970 203d 206e 702e 6d65    xp, yp = np.me
-00022870: 7368 6772 6964 2878 6172 722c 2078 6172  shgrid(xarr, xar
-00022880: 7229 0a20 2020 2020 2020 2072 6420 3d20  r).        rd = 
-00022890: 6f72 6967 5f77 6373 2e61 6c6c 5f70 6978  orig_wcs.all_pix
-000228a0: 3277 6f72 6c64 2878 702c 2079 702c 2069  2world(xp, yp, i
-000228b0: 7829 0a0a 2020 2020 6966 2072 6f74 2025  x)..    if rot %
-000228c0: 2034 203d 3d20 313a 0a20 2020 2020 2020   4 == 1:.       
-000228d0: 2023 2043 5720 3930 2064 6567 203a 2078   # CW 90 deg : x
-000228e0: 203d 2079 2c20 7920 3d20 286e 7820 2d20   = y, y = (nx - 
-000228f0: 7829 2c20 753d 762c 2076 3d2d 750a 2020  x), u=v, v=-u.  
-00022900: 2020 2020 2020 6465 7363 203d 2027 783d        desc = 'x=
-00022910: 792c 2079 3d6e 782d 7827 0a20 2020 2020  y, y=nx-x'.     
-00022920: 2020 200a 2020 2020 2020 2020 6e65 775b     .        new[
-00022930: 2743 5250 4958 3127 5d20 3d20 6f72 6967  'CRPIX1'] = orig
-00022940: 5b27 4352 5049 5832 275d 0a20 2020 2020  ['CRPIX2'].     
-00022950: 2020 206e 6577 5b27 4352 5049 5832 275d     new['CRPIX2']
-00022960: 203d 206f 7269 675b 274e 4158 4953 3127   = orig['NAXIS1'
-00022970: 5d20 2d20 6f72 6967 5b27 4352 5049 5831  ] - orig['CRPIX1
-00022980: 275d 202b 2031 0a0a 2020 2020 2020 2020  '] + 1..        
-00022990: 6e65 775b 2743 4431 5f31 275d 203d 206f  new['CD1_1'] = o
-000229a0: 7269 675b 2743 4431 5f32 275d 0a20 2020  rig['CD1_2'].   
-000229b0: 2020 2020 206e 6577 5b27 4344 315f 3227       new['CD1_2'
-000229c0: 5d20 3d20 2d6f 7269 675b 2743 4431 5f31  ] = -orig['CD1_1
-000229d0: 275d 0a20 2020 2020 2020 206e 6577 5b27  '].        new['
-000229e0: 4344 325f 3127 5d20 3d20 6f72 6967 5b27  CD2_1'] = orig['
-000229f0: 4344 325f 3227 5d0a 2020 2020 2020 2020  CD2_2'].        
-00022a00: 6e65 775b 2743 4432 5f32 275d 203d 202d  new['CD2_2'] = -
-00022a10: 6f72 6967 5b27 4344 325f 3127 5d0a 0a20  orig['CD2_1'].. 
-00022a20: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-00022a30: 7261 6e67 6528 6e65 775b 2741 5f4f 5244  range(new['A_ORD
-00022a40: 4552 275d 2b31 293a 0a20 2020 2020 2020  ER']+1):.       
-00022a50: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-00022a60: 6e67 6528 6e65 775b 2742 5f4f 5244 4552  nge(new['B_ORDER
-00022a70: 275d 2b31 293a 0a20 2020 2020 2020 2020  ']+1):.         
-00022a80: 2020 2020 2020 2041 696a 2020 3d20 6627         Aij  = f'
-00022a90: 415f 7b69 7d5f 7b6a 7d27 0a20 2020 2020  A_{i}_{j}'.     
-00022aa0: 2020 2020 2020 2020 2020 2069 6620 4169             if Ai
-00022ab0: 6a20 6e6f 7420 696e 206e 6577 3a0a 2020  j not in new:.  
-00022ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ad0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-00022ae0: 2020 2020 2020 2020 2020 2020 6e65 775b              new[
-00022af0: 6627 415f 7b69 7d5f 7b6a 7d27 5d20 3d20  f'A_{i}_{j}'] = 
-00022b00: 6f72 6967 5b66 2742 5f7b 6a7d 5f7b 697d  orig[f'B_{j}_{i}
-00022b10: 275d 2a28 2d31 292a 2a6a 0a20 2020 2020  ']*(-1)**j.     
-00022b20: 2020 2020 2020 2020 2020 206e 6577 5b66             new[f
-00022b30: 2742 5f7b 697d 5f7b 6a7d 275d 203d 206f  'B_{i}_{j}'] = o
-00022b40: 7269 675b 6627 415f 7b6a 7d5f 7b69 7d27  rig[f'A_{j}_{i}'
-00022b50: 5d2a 282d 3129 2a2a 6a2a 2d31 0a0a 2020  ]*(-1)**j*-1..  
-00022b60: 2020 2020 2020 6e65 775f 7763 7320 3d20        new_wcs = 
-00022b70: 6173 7472 6f70 792e 7763 732e 5743 5328  astropy.wcs.WCS(
-00022b80: 6e65 772c 2072 656c 6178 3d54 7275 6529  new, relax=True)
-00022b90: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00022ba0: 2020 6966 2063 6f6d 7061 7265 3a0a 2020    if compare:.  
-00022bb0: 2020 2020 2020 2020 2020 7872 2c20 7972            xr, yr
-00022bc0: 203d 206e 6577 5f77 6373 2e61 6c6c 5f77   = new_wcs.all_w
-00022bd0: 6f72 6c64 3270 6978 282a 7264 2c20 6978  orld2pix(*rd, ix
-00022be0: 290a 2020 2020 2020 2020 2020 2020 786f  ).            xo
-00022bf0: 203d 2079 700a 2020 2020 2020 2020 2020   = yp.          
-00022c00: 2020 796f 203d 206f 7269 675b 274e 4158    yo = orig['NAX
-00022c10: 4953 3127 5d20 2d20 7870 0a0a 2020 2020  IS1'] - xp..    
-00022c20: 656c 6966 2072 6f74 2025 2034 203d 3d20  elif rot % 4 == 
-00022c30: 333a 0a20 2020 2020 2020 2023 2043 5720  3:.        # CW 
-00022c40: 3237 3020 6465 6720 3a20 7920 3d20 782c  270 deg : y = x,
-00022c50: 2078 203d 2028 6e79 202d 2075 292c 2075   x = (ny - u), u
-00022c60: 3d2d 762c 2076 3d75 0a20 2020 2020 2020  =-v, v=u.       
-00022c70: 2064 6573 6320 3d20 2778 3d6e 792d 792c   desc = 'x=ny-y,
-00022c80: 2079 3d78 270a 0a20 2020 2020 2020 206e   y=x'..        n
-00022c90: 6577 5b27 4352 5049 5831 275d 203d 206f  ew['CRPIX1'] = o
-00022ca0: 7269 675b 274e 4158 4953 3227 5d20 2d20  rig['NAXIS2'] - 
-00022cb0: 6f72 6967 5b27 4352 5049 5832 275d 202b  orig['CRPIX2'] +
-00022cc0: 2031 0a20 2020 2020 2020 206e 6577 5b27   1.        new['
-00022cd0: 4352 5049 5832 275d 203d 206f 7269 675b  CRPIX2'] = orig[
-00022ce0: 2743 5250 4958 3127 5d0a 0a20 2020 2020  'CRPIX1']..     
-00022cf0: 2020 206e 6577 5b27 4344 315f 3127 5d20     new['CD1_1'] 
-00022d00: 3d20 2d6f 7269 675b 2743 4431 5f32 275d  = -orig['CD1_2']
-00022d10: 0a20 2020 2020 2020 206e 6577 5b27 4344  .        new['CD
-00022d20: 315f 3227 5d20 3d20 6f72 6967 5b27 4344  1_2'] = orig['CD
-00022d30: 315f 3127 5d0a 2020 2020 2020 2020 6e65  1_1'].        ne
-00022d40: 775b 2743 4432 5f31 275d 203d 202d 6f72  w['CD2_1'] = -or
-00022d50: 6967 5b27 4344 325f 3227 5d0a 2020 2020  ig['CD2_2'].    
-00022d60: 2020 2020 6e65 775b 2743 4432 5f32 275d      new['CD2_2']
-00022d70: 203d 206f 7269 675b 2743 4432 5f31 275d   = orig['CD2_1']
-00022d80: 0a0a 2020 2020 2020 2020 666f 7220 6920  ..        for i 
-00022d90: 696e 2072 616e 6765 286e 6577 5b27 415f  in range(new['A_
-00022da0: 4f52 4445 5227 5d2b 3129 3a0a 2020 2020  ORDER']+1):.    
-00022db0: 2020 2020 2020 2020 666f 7220 6a20 696e          for j in
-00022dc0: 2072 616e 6765 286e 6577 5b27 425f 4f52   range(new['B_OR
-00022dd0: 4445 5227 5d2b 3129 3a0a 2020 2020 2020  DER']+1):.      
-00022de0: 2020 2020 2020 2020 2020 4169 6a20 203d            Aij  =
-00022df0: 2066 2741 5f7b 697d 5f7b 6a7d 270a 2020   f'A_{i}_{j}'.  
-00022e00: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00022e10: 2041 696a 206e 6f74 2069 6e20 6e65 773a   Aij not in new:
-00022e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022e30: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-00022e40: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00022e50: 6577 5b66 2741 5f7b 697d 5f7b 6a7d 275d  ew[f'A_{i}_{j}']
-00022e60: 203d 206f 7269 675b 6627 425f 7b6a 7d5f   = orig[f'B_{j}_
-00022e70: 7b69 7d27 5d2a 282d 3129 2a2a 692a 2d31  {i}']*(-1)**i*-1
-00022e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022e90: 206e 6577 5b66 2742 5f7b 697d 5f7b 6a7d   new[f'B_{i}_{j}
-00022ea0: 275d 203d 206f 7269 675b 6627 415f 7b6a  '] = orig[f'A_{j
-00022eb0: 7d5f 7b69 7d27 5d2a 282d 3129 2a2a 690a  }_{i}']*(-1)**i.
-00022ec0: 0a20 2020 2020 2020 206e 6577 5f77 6373  .        new_wcs
-00022ed0: 203d 2061 7374 726f 7079 2e77 6373 2e57   = astropy.wcs.W
-00022ee0: 4353 286e 6577 2c20 7265 6c61 783d 5472  CS(new, relax=Tr
-00022ef0: 7565 290a 2020 2020 2020 2020 0a20 2020  ue).        .   
-00022f00: 2020 2020 2069 6620 636f 6d70 6172 653a       if compare:
-00022f10: 0a20 2020 2020 2020 2020 2020 2078 722c  .            xr,
-00022f20: 2079 7220 3d20 6e65 775f 7763 732e 616c   yr = new_wcs.al
-00022f30: 6c5f 776f 726c 6432 7069 7828 2a72 642c  l_world2pix(*rd,
-00022f40: 2069 7829 0a20 2020 2020 2020 2020 2020   ix).           
-00022f50: 2078 6f20 3d20 6f72 6967 5b27 4e41 5849   xo = orig['NAXI
-00022f60: 5332 275d 202d 2079 700a 2020 2020 2020  S2'] - yp.      
-00022f70: 2020 2020 2020 796f 203d 2078 700a 0a0a        yo = xp...
-00022f80: 2020 2020 656c 6966 2072 6f74 2025 2034      elif rot % 4
-00022f90: 203d 3d20 323a 0a20 2020 2020 2020 2023   == 2:.        #
-00022fa0: 2043 5720 3138 3020 6465 6720 3a20 783d   CW 180 deg : x=
-00022fb0: 6e78 2d78 2c20 793d 6e79 2d79 2c20 753d  nx-x, y=ny-y, u=
-00022fc0: 2d75 2c20 763d 2d76 0a20 2020 2020 2020  -u, v=-v.       
-00022fd0: 2064 6573 6320 3d20 2778 3d6e 782d 782c   desc = 'x=nx-x,
-00022fe0: 2079 3d6e 792d 7927 0a0a 2020 2020 2020   y=ny-y'..      
-00022ff0: 2020 6e65 775b 2743 5250 4958 3127 5d20    new['CRPIX1'] 
-00023000: 3d20 6f72 6967 5b27 4e41 5849 5331 275d  = orig['NAXIS1']
-00023010: 202d 206f 7269 675b 2743 5250 4958 3127   - orig['CRPIX1'
-00023020: 5d20 2b20 310a 2020 2020 2020 2020 6e65  ] + 1.        ne
-00023030: 775b 2743 5250 4958 3227 5d20 3d20 6f72  w['CRPIX2'] = or
-00023040: 6967 5b27 4e41 5849 5332 275d 202d 206f  ig['NAXIS2'] - o
-00023050: 7269 675b 2743 5250 4958 3227 5d20 2b20  rig['CRPIX2'] + 
-00023060: 310a 0a20 2020 2020 2020 206e 6577 5b27  1..        new['
-00023070: 4344 315f 3127 5d20 3d20 2d6f 7269 675b  CD1_1'] = -orig[
-00023080: 2743 4431 5f31 275d 0a20 2020 2020 2020  'CD1_1'].       
-00023090: 206e 6577 5b27 4344 315f 3227 5d20 3d20   new['CD1_2'] = 
-000230a0: 2d6f 7269 675b 2743 4431 5f32 275d 0a20  -orig['CD1_2']. 
-000230b0: 2020 2020 2020 206e 6577 5b27 4344 325f         new['CD2_
-000230c0: 3127 5d20 3d20 2d6f 7269 675b 2743 4432  1'] = -orig['CD2
-000230d0: 5f31 275d 0a20 2020 2020 2020 206e 6577  _1'].        new
-000230e0: 5b27 4344 325f 3227 5d20 3d20 2d6f 7269  ['CD2_2'] = -ori
-000230f0: 675b 2743 4432 5f32 275d 0a0a 2020 2020  g['CD2_2']..    
-00023100: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00023110: 6765 286e 6577 5b27 415f 4f52 4445 5227  ge(new['A_ORDER'
-00023120: 5d2b 3129 3a0a 2020 2020 2020 2020 2020  ]+1):.          
-00023130: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
-00023140: 286e 6577 5b27 425f 4f52 4445 5227 5d2b  (new['B_ORDER']+
-00023150: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
-00023160: 2020 2020 4169 6a20 203d 2066 2741 5f7b      Aij  = f'A_{
-00023170: 697d 5f7b 6a7d 270a 2020 2020 2020 2020  i}_{j}'.        
-00023180: 2020 2020 2020 2020 6966 2041 696a 206e          if Aij n
-00023190: 6f74 2069 6e20 6e65 773a 0a20 2020 2020  ot in new:.     
-000231a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000231b0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-000231c0: 2020 2020 2020 2020 206e 6577 5b66 2741           new[f'A
-000231d0: 5f7b 697d 5f7b 6a7d 275d 203d 206f 7269  _{i}_{j}'] = ori
-000231e0: 675b 6627 415f 7b69 7d5f 7b6a 7d27 5d2a  g[f'A_{i}_{j}']*
-000231f0: 282d 3129 2a2a 6a2a 282d 3129 2a2a 692a  (-1)**j*(-1)**i*
-00023200: 2d31 0a20 2020 2020 2020 2020 2020 2020  -1.             
-00023210: 2020 206e 6577 5b66 2742 5f7b 697d 5f7b     new[f'B_{i}_{
-00023220: 6a7d 275d 203d 206f 7269 675b 6627 425f  j}'] = orig[f'B_
-00023230: 7b69 7d5f 7b6a 7d27 5d2a 282d 3129 2a2a  {i}_{j}']*(-1)**
-00023240: 6a2a 282d 3129 2a2a 692a 2d31 0a0a 2020  j*(-1)**i*-1..  
-00023250: 2020 2020 2020 6e65 775f 7763 7320 3d20        new_wcs = 
-00023260: 6173 7472 6f70 792e 7763 732e 5743 5328  astropy.wcs.WCS(
-00023270: 6e65 772c 2072 656c 6178 3d54 7275 6529  new, relax=True)
-00023280: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00023290: 2020 6966 2063 6f6d 7061 7265 3a0a 2020    if compare:.  
-000232a0: 2020 2020 2020 2020 2020 7872 2c20 7972            xr, yr
-000232b0: 203d 206e 6577 5f77 6373 2e61 6c6c 5f77   = new_wcs.all_w
-000232c0: 6f72 6c64 3270 6978 282a 7264 2c20 6978  orld2pix(*rd, ix
-000232d0: 290a 2020 2020 2020 2020 2020 2020 786f  ).            xo
-000232e0: 203d 206f 7269 675b 274e 4158 4953 3127   = orig['NAXIS1'
-000232f0: 5d20 2d20 7870 0a20 2020 2020 2020 2020  ] - xp.         
-00023300: 2020 2079 6f20 3d20 6f72 6967 5b27 4e41     yo = orig['NA
-00023310: 5849 5332 275d 202d 2079 700a 2020 2020  XIS2'] - yp.    
-00023320: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00023330: 726f 743d 302c 2064 6f20 6e6f 7468 696e  rot=0, do nothin
-00023340: 670a 2020 2020 2020 2020 6465 7363 203d  g.        desc =
-00023350: 2027 783d 782c 2079 3d79 270a 2020 2020   'x=x, y=y'.    
-00023360: 2020 2020 6e65 775f 7763 7320 3d20 6f72      new_wcs = or
-00023370: 6967 5f77 6373 0a20 2020 2020 2020 2069  ig_wcs.        i
-00023380: 6620 636f 6d70 6172 653a 0a20 2020 2020  f compare:.     
-00023390: 2020 2020 2020 2078 6f20 3d20 7870 0a20         xo = xp. 
-000233a0: 2020 2020 2020 2020 2020 2079 6f20 3d20             yo = 
-000233b0: 7970 0a20 2020 2020 2020 2020 2020 2078  yp.            x
-000233c0: 722c 2079 7220 3d20 6e65 775f 7763 732e  r, yr = new_wcs.
-000233d0: 616c 6c5f 776f 726c 6432 7069 7828 2a72  all_world2pix(*r
-000233e0: 642c 2069 7829 0a20 2020 2020 2020 200a  d, ix).        .
-000233f0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-00023400: 2020 2020 2020 2020 6966 2063 6f6d 7061          if compa
-00023410: 7265 3a0a 2020 2020 2020 2020 2020 2020  re:.            
-00023420: 7872 6d73 203d 206e 6d61 6428 7872 2d78  xrms = nmad(xr-x
-00023430: 6f29 0a20 2020 2020 2020 2020 2020 2079  o).            y
-00023440: 726d 7320 3d20 6e6d 6164 2879 722d 796f  rms = nmad(yr-yo
-00023450: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-00023460: 696e 7428 6627 526f 7439 303a 207b 726f  int(f'Rot90: {ro
-00023470: 747d 2072 6d73 3d7b 7872 6d73 3a2e 3265  t} rms={xrms:.2e
-00023480: 7d20 7b79 726d 733a 2e32 657d 2729 0a20  } {yrms:.2e}'). 
-00023490: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-000234a0: 6966 2063 6f6d 7061 7265 3a0a 2020 2020  if compare:.    
-000234b0: 2020 2020 6669 672c 2061 7865 7320 3d20      fig, axes = 
-000234c0: 706c 742e 7375 6270 6c6f 7473 2831 2c32  plt.subplots(1,2
-000234d0: 2c66 6967 7369 7a65 3d28 3130 2c35 292c  ,figsize=(10,5),
-000234e0: 2073 6861 7265 783d 5472 7565 2c20 7368   sharex=True, sh
-000234f0: 6172 6579 3d54 7275 6529 0a20 2020 2020  arey=True).     
-00023500: 2020 2061 7865 735b 305d 2e73 6361 7474     axes[0].scatt
-00023510: 6572 2878 702c 2078 722d 786f 290a 2020  er(xp, xr-xo).  
-00023520: 2020 2020 2020 6178 6573 5b30 5d2e 7365        axes[0].se
-00023530: 745f 786c 6162 656c 2827 6478 2729 0a20  t_xlabel('dx'). 
-00023540: 2020 2020 2020 2061 7865 735b 315d 2e73         axes[1].s
-00023550: 6361 7474 6572 2879 702c 2079 722d 796f  catter(yp, yr-yo
-00023560: 290a 2020 2020 2020 2020 6178 6573 5b31  ).        axes[1
-00023570: 5d2e 7365 745f 786c 6162 656c 2827 6479  ].set_xlabel('dy
-00023580: 2729 0a20 2020 2020 2020 2066 6f72 2061  ').        for a
-00023590: 7820 696e 2061 7865 733a 0a20 2020 2020  x in axes:.     
-000235a0: 2020 2020 2020 2061 782e 6772 6964 2829         ax.grid()
-000235b0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000235c0: 2020 6669 672e 7469 6768 745f 6c61 796f    fig.tight_layo
-000235d0: 7574 2870 6164 3d30 2e35 290a 2020 2020  ut(pad=0.5).    
-000235e0: 0a20 2020 2072 6574 7572 6e20 6e65 772c  .    return new,
-000235f0: 206e 6577 5f77 6373 2c20 6465 7363 0a0a   new_wcs, desc..
-00023600: 0a64 6566 2067 6574 5f77 6373 5f73 6c69  .def get_wcs_sli
-00023610: 6365 5f68 6561 6465 7228 7763 732c 2073  ce_header(wcs, s
-00023620: 6c78 2c20 736c 7929 3a0a 2020 2020 2222  lx, sly):.    ""
-00023630: 2254 4244 0a20 2020 2022 2222 0a20 2020  "TBD.    """.   
-00023640: 2023 736c 782c 2073 6c79 203d 2073 6c69   #slx, sly = sli
-00023650: 6365 2831 3237 392c 2031 3434 3529 2c20  ce(1279, 1445), 
-00023660: 736c 6963 6528 3236 3635 2c32 3831 3329  slice(2665,2813)
-00023670: 0a20 2020 2068 203d 2077 6373 2e73 6c69  .    h = wcs.sli
-00023680: 6365 2828 736c 792c 2073 6c78 2929 2e74  ce((sly, slx)).t
-00023690: 6f5f 6865 6164 6572 2872 656c 6178 3d54  o_header(relax=T
-000236a0: 7275 6529 0a20 2020 2068 5b27 4e41 5849  rue).    h['NAXI
-000236b0: 5327 5d20 3d20 320a 2020 2020 685b 274e  S'] = 2.    h['N
-000236c0: 4158 4953 3127 5d20 3d20 736c 782e 7374  AXIS1'] = slx.st
-000236d0: 6f70 2d73 6c78 2e73 7461 7274 0a20 2020  op-slx.start.   
-000236e0: 2068 5b27 4e41 5849 5332 275d 203d 2073   h['NAXIS2'] = s
-000236f0: 6c79 2e73 746f 702d 736c 792e 7374 6172  ly.stop-sly.star
-00023700: 740a 2020 2020 666f 7220 6b20 696e 2068  t.    for k in h
-00023710: 3a0a 2020 2020 2020 2020 6966 206b 2e73  :.        if k.s
-00023720: 7461 7274 7377 6974 6828 2750 4327 293a  tartswith('PC'):
-00023730: 0a20 2020 2020 2020 2020 2020 2068 2e72  .            h.r
-00023740: 656e 616d 655f 6b65 7977 6f72 6428 6b2c  ename_keyword(k,
-00023750: 206b 2e72 6570 6c61 6365 2827 5043 272c   k.replace('PC',
-00023760: 2027 4344 2729 290a 0a20 2020 2072 6574   'CD'))..    ret
-00023770: 7572 6e20 680a 0a0a 6465 6620 6765 745f  urn h...def get_
-00023780: 636f 6d6d 6f6e 5f73 6c69 6365 7328 615f  common_slices(a_
-00023790: 6f72 6967 696e 2c20 615f 7368 6170 652c  origin, a_shape,
-000237a0: 2062 5f6f 7269 6769 6e2c 2062 5f73 6861   b_origin, b_sha
-000237b0: 7065 293a 0a20 2020 2022 2222 0a20 2020  pe):.    """.   
-000237c0: 2047 6574 2073 6c69 6365 7320 6f66 206f   Get slices of o
-000237d0: 7665 726c 6170 7320 6265 7477 6565 6e20  verlaps between 
-000237e0: 7477 6f20 7265 6374 616e 6775 6c61 7220  two rectangular 
-000237f0: 6772 6964 730a 2020 2020 2222 220a 0a20  grids.    """.. 
-00023800: 2020 206c 6c20 3d20 6e70 2e6d 696e 285b     ll = np.min([
-00023810: 615f 6f72 6967 696e 2c20 625f 6f72 6967  a_origin, b_orig
-00023820: 696e 5d2c 2061 7869 733d 3029 0a20 2020  in], axis=0).   
-00023830: 2075 7220 3d20 6e70 2e6d 6178 285b 615f   ur = np.max([a_
-00023840: 6f72 6967 696e 2b61 5f73 6861 7065 2c20  origin+a_shape, 
-00023850: 625f 6f72 6967 696e 2b62 5f73 6861 7065  b_origin+b_shape
-00023860: 5d2c 2061 7869 733d 3029 0a0a 2020 2020  ], axis=0)..    
-00023870: 2320 6f74 6865 7220 696e 2073 656c 660a  # other in self.
-00023880: 2020 2020 6c6c 7320 3d20 6e70 2e6d 696e      lls = np.min
-00023890: 696d 756d 2862 5f6f 7269 6769 6e20 2d20  imum(b_origin - 
-000238a0: 6c6c 2c20 615f 7368 6170 6529 0a20 2020  ll, a_shape).   
-000238b0: 2075 7273 203d 206e 702e 636c 6970 2862   urs = np.clip(b
-000238c0: 5f6f 7269 6769 6e20 2b20 625f 7368 6170  _origin + b_shap
-000238d0: 6520 2d20 615f 6f72 6967 696e 2c20 5b30  e - a_origin, [0
-000238e0: 2c20 305d 2c20 615f 7368 6170 6529 0a0a  , 0], a_shape)..
-000238f0: 2020 2020 2320 7365 6c66 2069 6e20 6f74      # self in ot
-00023900: 6865 720a 2020 2020 6c6c 6f20 3d20 6e70  her.    llo = np
-00023910: 2e6d 696e 696d 756d 2861 5f6f 7269 6769  .minimum(a_origi
-00023920: 6e20 2d20 6c6c 2c20 625f 7368 6170 6529  n - ll, b_shape)
-00023930: 0a20 2020 2075 726f 203d 206e 702e 636c  .    uro = np.cl
-00023940: 6970 2861 5f6f 7269 6769 6e20 2b20 615f  ip(a_origin + a_
-00023950: 7368 6170 6520 2d20 625f 6f72 6967 696e  shape - b_origin
-00023960: 2c20 5b30 2c20 305d 2c20 625f 7368 6170  , [0, 0], b_shap
-00023970: 6529 0a0a 2020 2020 615f 736c 6963 6520  e)..    a_slice 
-00023980: 3d20 2873 6c69 6365 286c 6c73 5b30 5d2c  = (slice(lls[0],
-00023990: 2075 7273 5b30 5d29 2c20 736c 6963 6528   urs[0]), slice(
-000239a0: 6c6c 735b 315d 2c20 7572 735b 315d 2929  lls[1], urs[1]))
-000239b0: 0a20 2020 2062 5f73 6c69 6365 203d 2028  .    b_slice = (
-000239c0: 736c 6963 6528 6c6c 6f5b 305d 2c20 7572  slice(llo[0], ur
-000239d0: 6f5b 305d 292c 2073 6c69 6365 286c 6c6f  o[0]), slice(llo
-000239e0: 5b31 5d2c 2075 726f 5b31 5d29 290a 2020  [1], uro[1])).  
-000239f0: 2020 7265 7475 726e 2061 5f73 6c69 6365    return a_slice
-00023a00: 2c20 625f 736c 6963 650a 0a0a 636c 6173  , b_slice...clas
-00023a10: 7320 5743 5346 6f6f 7470 7269 6e74 286f  s WCSFootprint(o
-00023a20: 626a 6563 7429 3a0a 2020 2020 2222 220a  bject):.    """.
-00023a30: 2020 2020 4865 6c70 6572 2066 756e 6374      Helper funct
-00023a40: 696f 6e73 2066 6f72 2064 6561 6c69 6e67  ions for dealing
-00023a50: 2077 6974 6820 5743 5320 666f 6f74 7072   with WCS footpr
-00023a60: 696e 7473 0a20 2020 2022 2222 0a0a 2020  ints.    """..  
-00023a70: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00023a80: 656c 662c 2077 6373 2c20 6578 743d 312c  elf, wcs, ext=1,
-00023a90: 206c 6162 656c 3d4e 6f6e 6529 3a0a 2020   label=None):.  
-00023aa0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00023ab0: 6e63 6528 7763 732c 2070 7977 6373 2e57  nce(wcs, pywcs.W
-00023ac0: 4353 293a 0a20 2020 2020 2020 2020 2020  CS):.           
-00023ad0: 2073 656c 662e 7763 7320 3d20 7763 732e   self.wcs = wcs.
-00023ae0: 6465 6570 636f 7079 2829 0a20 2020 2020  deepcopy().     
-00023af0: 2020 2020 2020 2069 6620 6e6f 7420 6861         if not ha
-00023b00: 7361 7474 7228 7365 6c66 2e77 6373 2c20  sattr(self.wcs, 
-00023b10: 2770 6978 656c 5f73 6861 7065 2729 3a0a  'pixel_shape'):.
-00023b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b30: 7365 6c66 2e77 6373 2e70 6978 656c 5f73  self.wcs.pixel_s
-00023b40: 6861 7065 203d 204e 6f6e 650a 0a20 2020  hape = None..   
-00023b50: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00023b60: 2e77 6373 2e70 6978 656c 5f73 6861 7065  .wcs.pixel_shape
-00023b70: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00023b80: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
-00023b90: 6373 2e70 6978 656c 5f73 6861 7065 203d  cs.pixel_shape =
-00023ba0: 205b 696e 7428 702a 3229 2066 6f72 2070   [int(p*2) for p
-00023bb0: 2069 6e20 7365 6c66 2e77 6373 2e77 6373   in self.wcs.wcs
-00023bc0: 2e63 7270 6978 5d0a 2020 2020 2020 2020  .crpix].        
-00023bd0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00023be0: 7763 732c 2073 7472 293a 0a20 2020 2020  wcs, str):.     
-00023bf0: 2020 2020 2020 2068 6475 203d 2070 7966         hdu = pyf
-00023c00: 6974 732e 6f70 656e 2877 6373 290a 2020  its.open(wcs).  
-00023c10: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00023c20: 2868 6475 2920 3d3d 2031 3a0a 2020 2020  (hdu) == 1:.    
-00023c30: 2020 2020 2020 2020 2020 2020 6578 7420              ext 
-00023c40: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
-00023c50: 2073 656c 662e 6164 645f 6e61 7869 7328   self.add_naxis(
-00023c60: 6864 755b 6578 745d 2e68 6561 6465 7229  hdu[ext].header)
-00023c70: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00023c80: 5f77 6373 203d 2070 7977 6373 2e57 4353  _wcs = pywcs.WCS
-00023c90: 2868 6475 5b65 7874 5d2e 6865 6164 6572  (hdu[ext].header
-00023ca0: 2c20 666f 626a 3d68 6475 290a 2020 2020  , fobj=hdu).    
-00023cb0: 2020 2020 2020 2020 7365 6c66 2e77 6373          self.wcs
-00023cc0: 203d 2074 6865 5f77 6373 0a20 2020 2020   = the_wcs.     
-00023cd0: 2020 2020 2020 2068 6475 2e63 6c6f 7365         hdu.close
-00023ce0: 2829 0a20 2020 2020 2020 2020 2020 200a  ().            .
-00023cf0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00023d00: 6e73 7461 6e63 6528 7763 732c 2070 7966  nstance(wcs, pyf
-00023d10: 6974 732e 4844 554c 6973 7429 3a0a 2020  its.HDUList):.  
-00023d20: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00023d30: 2877 6373 2920 3d3d 2031 3a0a 2020 2020  (wcs) == 1:.    
-00023d40: 2020 2020 2020 2020 2020 2020 6578 7420              ext 
-00023d50: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-00023d60: 7365 6c66 2e61 6464 5f6e 6178 6973 2877  self.add_naxis(w
-00023d70: 6373 5b65 7874 5d2e 6865 6164 6572 290a  cs[ext].header).
-00023d80: 2020 2020 2020 2020 2020 2020 7468 655f              the_
-00023d90: 7763 7320 3d20 7079 7763 732e 5743 5328  wcs = pywcs.WCS(
-00023da0: 7763 735b 6578 745d 2e68 6561 6465 722c  wcs[ext].header,
-00023db0: 2066 6f62 6a3d 7763 7329 0a20 2020 2020   fobj=wcs).     
-00023dc0: 2020 2020 2020 2073 656c 662e 7763 7320         self.wcs 
-00023dd0: 3d20 7468 655f 7763 730a 2020 2020 2020  = the_wcs.      
-00023de0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00023df0: 2020 2020 7072 696e 7428 2757 4353 2063      print('WCS c
-00023e00: 6c61 7373 206e 6f74 2072 6563 6f67 6e69  lass not recogni
-00023e10: 7a65 643a 207b 307d 272e 666f 726d 6174  zed: {0}'.format
-00023e20: 2877 6373 2e5f 5f63 6c61 7373 5f5f 2929  (wcs.__class__))
-00023e30: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00023e40: 7365 2056 616c 7565 4572 726f 720a 0a20  se ValueError.. 
-00023e50: 2020 2020 2020 2073 656c 662e 6670 203d         self.fp =
-00023e60: 2073 656c 662e 7763 732e 6361 6c63 5f66   self.wcs.calc_f
-00023e70: 6f6f 7470 7269 6e74 2829 0a20 2020 2020  ootprint().     
-00023e80: 2020 2073 656c 662e 636f 7364 6563 203d     self.cosdec =
-00023e90: 206e 702e 636f 7328 7365 6c66 2e66 705b   np.cos(self.fp[
-00023ea0: 302c 2031 5d2f 3138 302a 6e70 2e70 6929  0, 1]/180*np.pi)
-00023eb0: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
-00023ec0: 6265 6c20 3d20 6c61 6265 6c0a 2020 2020  bel = label.    
-00023ed0: 2020 2020 7365 6c66 2e70 6978 656c 5f73      self.pixel_s
-00023ee0: 6361 6c65 203d 2067 6574 5f77 6373 5f70  cale = get_wcs_p
-00023ef0: 7363 616c 6528 7365 6c66 2e77 6373 290a  scale(self.wcs).
-00023f00: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00023f10: 2020 2064 6566 2063 656e 7472 6f69 6428     def centroid(
-00023f20: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-00023f30: 6574 7572 6e20 6e70 2e6d 6561 6e28 7365  eturn np.mean(se
-00023f40: 6c66 2e66 702c 2061 7869 733d 3029 0a0a  lf.fp, axis=0)..
-00023f50: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00023f60: 2020 2064 6566 2070 6174 6828 7365 6c66     def path(self
-00023f70: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00023f80: 2020 2020 2020 2060 7e6d 6174 706c 6f74         `~matplot
-00023f90: 6c69 622e 7061 7468 2e50 6174 6860 206f  lib.path.Path` o
-00023fa0: 626a 6563 740a 2020 2020 2020 2020 2222  bject.        ""
-00023fb0: 220a 2020 2020 2020 2020 696d 706f 7274  ".        import
-00023fc0: 206d 6174 706c 6f74 6c69 622e 7061 7468   matplotlib.path
-00023fd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00023fe0: 6d61 7470 6c6f 746c 6962 2e70 6174 682e  matplotlib.path.
-00023ff0: 5061 7468 2873 656c 662e 6670 290a 0a0a  Path(self.fp)...
-00024000: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00024010: 2020 6465 6620 706f 6c79 676f 6e28 7365    def polygon(se
-00024020: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-00024030: 0a20 2020 2020 2020 2060 7e73 6861 7065  .        `~shape
-00024040: 6c79 2e67 656f 6d65 7472 792e 506f 6c79  ly.geometry.Poly
-00024050: 676f 6e60 206f 626a 6563 742e 0a20 2020  gon` object..   
-00024060: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00024070: 2066 726f 6d20 7368 6170 656c 792e 6765   from shapely.ge
-00024080: 6f6d 6574 7279 2069 6d70 6f72 7420 506f  ometry import Po
-00024090: 6c79 676f 6e0a 2020 2020 2020 2020 7265  lygon.        re
-000240a0: 7475 726e 2050 6f6c 7967 6f6e 2873 656c  turn Polygon(sel
-000240b0: 662e 6670 290a 0a0a 2020 2020 6465 6620  f.fp)...    def 
-000240c0: 6765 745f 7061 7463 6828 7365 6c66 2c20  get_patch(self, 
-000240d0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-000240e0: 2020 2022 2222 0a20 2020 2020 2020 2060     """.        `
-000240f0: 7e6d 6174 706c 6f74 6c69 622e 7061 6368  ~matplotlib.pach
-00024100: 2e50 6174 6850 6174 6368 6020 6f62 6a65  .PathPatch` obje
-00024110: 6374 0a20 2020 2020 2020 2022 2222 0a20  ct.        """. 
-00024120: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-00024130: 7463 685f 6672 6f6d 5f70 6f6c 7967 6f6e  tch_from_polygon
-00024140: 2873 656c 662e 706f 6c79 676f 6e2c 202a  (self.polygon, *
-00024150: 2a6b 7761 7267 7329 0a0a 0a20 2020 2040  *kwargs)...    @
-00024160: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00024170: 2072 6567 696f 6e28 7365 6c66 293a 0a20   region(self):. 
-00024180: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00024190: 2020 2050 6f6c 7967 6f6e 2073 7472 696e     Polygon strin
-000241a0: 6720 696e 2044 5339 2072 6567 696f 6e20  g in DS9 region 
-000241b0: 666f 726d 6174 0a20 2020 2020 2020 2022  format.        "
-000241c0: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-000241d0: 6e20 2770 6f6c 7967 6f6e 287b 307d 2927  n 'polygon({0})'
-000241e0: 2e66 6f72 6d61 7428 272c 272e 6a6f 696e  .format(','.join
-000241f0: 285b 277b 303a 2e36 667d 272e 666f 726d  (['{0:.6f}'.form
-00024200: 6174 2863 2920 666f 7220 6320 696e 2073  at(c) for c in s
-00024210: 656c 662e 6670 2e66 6c61 7474 656e 2829  elf.fp.flatten()
-00024220: 5d29 290a 0a0a 2020 2020 4073 7461 7469  ]))...    @stati
-00024230: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-00024240: 6164 645f 6e61 7869 7328 6865 6164 6572  add_naxis(header
-00024250: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00024260: 2020 2020 2020 2049 6620 4e41 5849 5320         If NAXIS 
-00024270: 6b65 7977 6f72 6473 206e 6f74 2066 6f75  keywords not fou
-00024280: 6e64 2069 6e20 616e 2069 6d61 6765 2068  nd in an image h
-00024290: 6561 6465 722c 2061 7373 756d 6520 7468  eader, assume th
-000242a0: 6520 7061 7265 6e74 0a20 2020 2020 2020  e parent.       
-000242b0: 2069 6d61 6765 2064 696d 656e 7369 6f6e   image dimension
-000242c0: 7320 6172 6520 322a 4352 5049 580a 2020  s are 2*CRPIX.  
-000242d0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000242e0: 2020 666f 7220 6920 696e 205b 312c 2032    for i in [1, 2
-000242f0: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
-00024300: 6620 274e 4158 4953 7b30 7d27 2e66 6f72  f 'NAXIS{0}'.for
-00024310: 6d61 7428 6929 206e 6f74 2069 6e20 6865  mat(i) not in he
-00024320: 6164 6572 3a0a 2020 2020 2020 2020 2020  ader:.          
-00024330: 2020 2020 2020 6865 6164 6572 5b27 4e41        header['NA
-00024340: 5849 537b 307d 272e 666f 726d 6174 2869  XIS{0}'.format(i
-00024350: 295d 203d 2069 6e74 2868 6561 6465 725b  )] = int(header[
-00024360: 2743 5250 4958 7b30 7d27 2e66 6f72 6d61  'CRPIX{0}'.forma
-00024370: 7428 6929 5d2a 3229 0a0a 0a64 6566 2072  t(i)]*2)...def r
-00024380: 6570 726f 6a65 6374 5f66 6173 7465 7228  eproject_faster(
-00024390: 696e 7075 745f 6864 752c 206f 7574 7075  input_hdu, outpu
-000243a0: 742c 2070 6164 3d31 302c 202a 2a6b 7761  t, pad=10, **kwa
-000243b0: 7267 7329 3a0a 2020 2020 2222 2253 7065  rgs):.    """Spe
-000243c0: 6564 2075 7020 6072 6570 726f 6a65 6374  ed up `reproject
-000243d0: 6020 6d6f 6475 6c65 2077 6974 6820 6172  ` module with ar
-000243e0: 7261 7920 736c 6963 6573 206f 6620 7468  ray slices of th
-000243f0: 6520 696e 7075 7420 696d 6167 650a 0a20  e input image.. 
-00024400: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00024410: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00024420: 2069 6e70 7574 5f68 6475 203a 2060 7e61   input_hdu : `~a
-00024430: 7374 726f 7079 2e69 6f2e 6669 7473 2e49  stropy.io.fits.I
-00024440: 6d61 6765 4844 5560 0a20 2020 2020 2020  mageHDU`.       
-00024450: 2049 6e70 7574 2069 6d61 6765 2048 4455   Input image HDU
-00024460: 2074 6f20 7265 7072 6f6a 6563 742e 0a0a   to reproject...
-00024470: 2020 2020 6f75 7470 7574 203a 2060 7e61      output : `~a
-00024480: 7374 726f 7079 2e77 6373 2e57 4353 6020  stropy.wcs.WCS` 
-00024490: 6f72 2060 7e61 7374 726f 7079 2e69 6f2e  or `~astropy.io.
-000244a0: 6669 7473 2e48 6561 6465 7260 0a20 2020  fits.Header`.   
-000244b0: 2020 2020 204f 7574 7075 7420 6672 616d       Output fram
-000244c0: 6520 6465 6669 6e69 7469 6f6e 2e0a 0a20  e definition... 
-000244d0: 2020 2070 6164 203a 2069 6e74 0a20 2020     pad : int.   
-000244e0: 2020 2020 2050 6978 656c 2070 6164 6469       Pixel paddi
-000244f0: 6e67 206f 6e20 736c 6963 6573 2063 7574  ng on slices cut
-00024500: 2066 726f 6d20 7468 6520 6069 6e70 7574   from the `input
-00024510: 5f68 6475 602e 0a0a 2020 2020 6b77 6172  _hdu`...    kwar
-00024520: 6773 203a 2064 6963 740a 2020 2020 2020  gs : dict.      
-00024530: 2020 4172 6775 6d65 6e74 7320 7061 7373    Arguments pass
-00024540: 6564 2074 6872 6f75 6768 2074 6f20 607e  ed through to `~
-00024550: 7265 7072 6f6a 6563 742e 7265 7072 6f6a  reproject.reproj
-00024560: 6563 745f 696e 7465 7270 602e 2020 466f  ect_interp`.  Fo
-00024570: 720a 2020 2020 2020 2020 6578 616d 706c  r.        exampl
-00024580: 652c 2060 6f72 6465 723d 276e 6561 7265  e, `order='neare
-00024590: 7374 2d6e 6569 6768 626f 7227 602e 0a0a  st-neighbor'`...
-000245a0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-000245b0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7265 7072  -------.    repr
-000245c0: 6f6a 6563 7465 6420 3a20 607e 6e75 6d70  ojected : `~nump
-000245d0: 792e 6e64 6172 7261 7960 0a20 2020 2020  y.ndarray`.     
-000245e0: 2020 2052 6570 726f 6a65 6374 6564 2064     Reprojected d
-000245f0: 6174 6120 6672 6f6d 2060 696e 7075 745f  ata from `input_
-00024600: 6864 7560 2e0a 0a20 2020 2066 6f6f 7470  hdu`...    footp
-00024610: 7269 6e74 203a 2060 7e6e 756d 7079 2e6e  rint : `~numpy.n
-00024620: 6461 7272 6179 600a 2020 2020 2020 2020  darray`.        
-00024630: 466f 6f74 7072 696e 7420 6f66 2074 6865  Footprint of the
-00024640: 2069 6e70 7574 2061 7272 6179 2069 6e20   input array in 
-00024650: 7468 6520 6f75 7470 7574 2066 7261 6d65  the output frame
-00024660: 2e0a 0a20 2020 204e 6f74 6573 0a20 2020  ...    Notes.   
-00024670: 202d 2d2d 2d2d 0a0a 2020 2020 6072 6570   -----..    `rep
-00024680: 726f 6a65 6374 2720 6973 2061 6e20 6173  roject' is an as
-00024690: 7472 6f70 792d 636f 6d70 6174 6962 6c65  tropy-compatible
-000246a0: 206d 6f64 756c 6520 7468 6174 2063 616e   module that can
-000246b0: 2062 6520 696e 7374 616c 6c65 6420 7769   be installed wi
-000246c0: 7468 0a20 2020 2060 7069 7060 2e20 2053  th.    `pip`.  S
-000246d0: 6565 2068 7474 7073 3a2f 2f72 6570 726f  ee https://repro
-000246e0: 6a65 6374 2e72 6561 6474 6865 646f 6373  ject.readthedocs
-000246f0: 2e69 6f2e 0a20 2020 2022 2222 0a20 2020  .io..    """.   
-00024700: 2069 6d70 6f72 7420 7265 7072 6f6a 6563   import reprojec
-00024710: 740a 0a20 2020 2023 204f 7574 7075 7420  t..    # Output 
-00024720: 5743 530a 2020 2020 6966 2069 7369 6e73  WCS.    if isins
-00024730: 7461 6e63 6528 6f75 7470 7574 2c20 7079  tance(output, py
-00024740: 7763 732e 5743 5329 3a0a 2020 2020 2020  wcs.WCS):.      
-00024750: 2020 6f75 745f 7763 7320 3d20 6f75 7470    out_wcs = outp
-00024760: 7574 0a20 2020 2065 6c73 653a 0a20 2020  ut.    else:.   
-00024770: 2020 2020 206f 7574 5f77 6373 203d 2070       out_wcs = p
-00024780: 7977 6373 2e57 4353 286f 7574 7075 742c  ywcs.WCS(output,
-00024790: 2072 656c 6178 3d54 7275 6529 0a0a 2020   relax=True)..  
-000247a0: 2020 6966 2027 5349 5027 2069 6e20 6f75    if 'SIP' in ou
-000247b0: 745f 7763 732e 7763 732e 6374 7970 655b  t_wcs.wcs.ctype[
-000247c0: 305d 3a0a 2020 2020 2020 2020 7072 696e  0]:.        prin
-000247d0: 7428 2757 6172 6e69 6e67 3a20 6072 6570  t('Warning: `rep
-000247e0: 726f 6a65 6374 6020 646f 6573 6e5c 2774  roject` doesn\'t
-000247f0: 2061 7070 6561 7220 746f 2073 7570 706f   appear to suppo
-00024800: 7274 2053 4950 2070 726f 6a65 6374 696f  rt SIP projectio
-00024810: 6e27 290a 0a20 2020 2023 2043 6f6d 7075  n')..    # Compu
-00024820: 7465 2070 6978 656c 2063 6f6f 7264 696e  te pixel coordin
-00024830: 6174 6573 206f 6620 7468 6520 6f75 7470  ates of the outp
-00024840: 7574 2066 7261 6d65 2063 6f72 6e65 7273  ut frame corners
-00024850: 2069 6e20 7468 6520 696e 7075 7420 696d   in the input im
-00024860: 6167 650a 2020 2020 696e 7075 745f 7763  age.    input_wc
-00024870: 7320 3d20 7079 7763 732e 5743 5328 696e  s = pywcs.WCS(in
-00024880: 7075 745f 6864 752e 6865 6164 6572 2c20  put_hdu.header, 
-00024890: 7265 6c61 783d 5472 7565 290a 2020 2020  relax=True).    
-000248a0: 6f75 745f 6670 203d 206f 7574 5f77 6373  out_fp = out_wcs
-000248b0: 2e63 616c 635f 666f 6f74 7072 696e 7428  .calc_footprint(
-000248c0: 290a 2020 2020 696e 7075 745f 7879 203d  ).    input_xy =
-000248d0: 2069 6e70 7574 5f77 6373 2e61 6c6c 5f77   input_wcs.all_w
-000248e0: 6f72 6c64 3270 6978 286f 7574 5f66 702c  orld2pix(out_fp,
-000248f0: 2030 290a 2020 2020 736c 7820 3d20 736c   0).    slx = sl
-00024900: 6963 6528 696e 7428 696e 7075 745f 7879  ice(int(input_xy
-00024910: 5b3a 2c20 305d 2e6d 696e 2829 292d 7061  [:, 0].min())-pa
-00024920: 642c 2069 6e74 2869 6e70 7574 5f78 795b  d, int(input_xy[
-00024930: 3a2c 2030 5d2e 6d61 7828 2929 2b70 6164  :, 0].max())+pad
-00024940: 290a 2020 2020 736c 7920 3d20 736c 6963  ).    sly = slic
-00024950: 6528 696e 7428 696e 7075 745f 7879 5b3a  e(int(input_xy[:
-00024960: 2c20 315d 2e6d 696e 2829 292d 7061 642c  , 1].min())-pad,
-00024970: 2069 6e74 2869 6e70 7574 5f78 795b 3a2c   int(input_xy[:,
-00024980: 2031 5d2e 6d61 7828 2929 2b70 6164 290a   1].max())+pad).
-00024990: 0a20 2020 2023 204d 616b 6520 7468 6520  .    # Make the 
-000249a0: 6375 746f 7574 0a20 2020 2073 7562 5f64  cutout.    sub_d
-000249b0: 6174 6120 3d20 696e 7075 745f 6864 752e  ata = input_hdu.
-000249c0: 6461 7461 5b73 6c79 2c20 736c 785d 0a20  data[sly, slx]. 
-000249d0: 2020 2073 7562 5f68 6561 6465 7220 3d20     sub_header = 
-000249e0: 6765 745f 7763 735f 736c 6963 655f 6865  get_wcs_slice_he
-000249f0: 6164 6572 2869 6e70 7574 5f77 6373 2c20  ader(input_wcs, 
-00024a00: 736c 782c 2073 6c79 290a 2020 2020 7375  slx, sly).    su
-00024a10: 625f 6864 7520 3d20 7079 6669 7473 2e50  b_hdu = pyfits.P
-00024a20: 7269 6d61 7279 4844 5528 6461 7461 3d73  rimaryHDU(data=s
-00024a30: 7562 5f64 6174 612c 2068 6561 6465 723d  ub_data, header=
-00024a40: 7375 625f 6865 6164 6572 290a 0a20 2020  sub_header)..   
-00024a50: 2023 2047 6574 2074 6865 2072 6570 726f   # Get the repro
-00024a60: 6a65 6374 696f 6e0a 2020 2020 7365 675f  jection.    seg_
-00024a70: 692c 2066 705f 6920 3d20 7265 7072 6f6a  i, fp_i = reproj
-00024a80: 6563 742e 7265 7072 6f6a 6563 745f 696e  ect.reproject_in
-00024a90: 7465 7270 2873 7562 5f68 6475 2c20 6f75  terp(sub_hdu, ou
-00024aa0: 7470 7574 2c20 2a2a 6b77 6172 6773 290a  tput, **kwargs).
-00024ab0: 2020 2020 7265 7475 726e 2073 6567 5f69      return seg_i
-00024ac0: 2e61 7374 7970 6528 7375 625f 6461 7461  .astype(sub_data
-00024ad0: 2e64 7479 7065 292c 2066 705f 692e 6173  .dtype), fp_i.as
-00024ae0: 7479 7065 286e 702e 7569 6e74 3829 0a0a  type(np.uint8)..
-00024af0: 0a64 6566 2066 756c 6c5f 7370 6563 7472  .def full_spectr
-00024b00: 756d 5f77 6373 6865 6164 6572 2863 656e  um_wcsheader(cen
-00024b10: 7465 725f 7761 7665 3d31 2e34 6534 2c20  ter_wave=1.4e4, 
-00024b20: 646c 616d 3d34 302c 204e 583d 3130 302c  dlam=40, NX=100,
-00024b30: 2073 7061 7469 616c 5f73 6361 6c65 3d31   spatial_scale=1
-00024b40: 2c20 4e59 3d31 3029 3a0a 2020 2020 2222  , NY=10):.    ""
-00024b50: 224d 616b 6520 6120 5743 5320 6865 6164  "Make a WCS head
-00024b60: 6572 2066 6f72 2061 2032 4420 7370 6563  er for a 2D spec
-00024b70: 7472 756d 0a0a 2020 2020 5061 7261 6d65  trum..    Parame
-00024b80: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00024b90: 2d2d 2d0a 2020 2020 6365 6e74 6572 5f77  ---.    center_w
-00024ba0: 6176 6520 3a20 666c 6f61 740a 2020 2020  ave : float.    
-00024bb0: 2020 2020 5761 7665 6c65 6e67 7468 206f      Wavelength o
-00024bc0: 6620 7468 6520 6365 6e74 7261 6c20 7069  f the central pi
-00024bd0: 7865 6c2c 2069 6e20 416e 7374 726f 6d73  xel, in Anstroms
-00024be0: 0a0a 2020 2020 646c 616d 203a 2066 6c6f  ..    dlam : flo
-00024bf0: 6174 0a20 2020 2020 2020 2044 656c 7461  at.        Delta
-00024c00: 2d77 6176 656c 656e 6774 6820 7065 7220  -wavelength per 
-00024c10: 2878 2920 7069 7865 6c0a 0a20 2020 204e  (x) pixel..    N
-00024c20: 582c 204e 5920 3a20 696e 740a 2020 2020  X, NY : int.    
-00024c30: 2020 2020 4e75 6d62 6572 206f 6620 7820      Number of x 
-00024c40: 2620 7920 7069 7865 6c73 2e20 4f75 7470  & y pixels. Outp
-00024c50: 7574 2077 696c 6c20 6861 7665 2073 6861  ut will have sha
-00024c60: 7065 2060 2832 2a4e 592c 2032 2a4e 5829  pe `(2*NY, 2*NX)
-00024c70: 602e 0a0a 2020 2020 7370 6174 6961 6c5f  `...    spatial_
-00024c80: 7363 616c 6520 3a20 666c 6f61 740a 2020  scale : float.  
-00024c90: 2020 2020 2020 5370 6174 6961 6c20 7363        Spatial sc
-00024ca0: 616c 6520 6f66 2074 6865 206f 7574 7075  ale of the outpu
-00024cb0: 742c 2069 6e20 756e 6974 7320 6f66 2074  t, in units of t
-00024cc0: 6865 2069 6e70 7574 2070 6978 656c 730a  he input pixels.
-00024cd0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00024ce0: 202d 2d2d 2d2d 2d2d 0a20 2020 2068 6561   -------.    hea
-00024cf0: 6465 7220 3a20 607e 6173 7472 6f70 792e  der : `~astropy.
-00024d00: 696f 2e66 6974 732e 4865 6164 6572 600a  io.fits.Header`.
-00024d10: 2020 2020 2020 2020 4f75 7470 7574 2057          Output W
-00024d20: 4353 2068 6561 6465 720a 0a20 2020 2077  CS header..    w
-00024d30: 6373 203a 2060 7e61 7374 726f 7079 2e77  cs : `~astropy.w
-00024d40: 6373 2e57 4353 600a 2020 2020 2020 2020  cs.WCS`.        
-00024d50: 4f75 7470 7574 2057 4353 0a0a 2020 2020  Output WCS..    
-00024d60: 4578 616d 706c 6573 0a20 2020 202d 2d2d  Examples.    ---
-00024d70: 2d2d 2d2d 2d0a 0a20 2020 2020 2020 203e  -----..        >
-00024d80: 3e3e 2066 726f 6d20 6772 697a 6c69 2e75  >> from grizli.u
-00024d90: 7469 6c73 2069 6d70 6f72 7420 6d61 6b65  tils import make
-00024da0: 5f73 7065 6374 7275 6d5f 7763 7368 6561  _spectrum_wcshea
-00024db0: 6465 720a 2020 2020 2020 2020 3e3e 3e20  der.        >>> 
-00024dc0: 682c 2077 6373 203d 206d 616b 655f 7370  h, wcs = make_sp
-00024dd0: 6563 7472 756d 5f77 6373 6865 6164 6572  ectrum_wcsheader
-00024de0: 2829 0a20 2020 2020 2020 203e 3e3e 2070  ().        >>> p
-00024df0: 7269 6e74 2877 6373 290a 2020 2020 2020  rint(wcs).      
-00024e00: 2020 5743 5320 4b65 7977 6f72 6473 0a20    WCS Keywords. 
-00024e10: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
-00024e20: 2057 4353 2061 7865 733a 2032 0a20 2020   WCS axes: 2.   
-00024e30: 2020 2020 2043 5459 5045 203a 2027 5741       CTYPE : 'WA
-00024e40: 5645 2720 2027 4c49 4e45 4152 270a 2020  VE'  'LINEAR'.  
-00024e50: 2020 2020 2020 4352 5641 4c20 3a20 3134        CRVAL : 14
-00024e60: 3030 302e 3020 2030 2e30 0a20 2020 2020  000.0  0.0.     
-00024e70: 2020 2043 5250 4958 203a 2031 3031 2e30     CRPIX : 101.0
-00024e80: 2020 3131 2e30 0a20 2020 2020 2020 2043    11.0.        C
-00024e90: 4431 5f31 2043 4431 5f32 2020 3a20 3430  D1_1 CD1_2  : 40
-00024ea0: 2e30 2020 302e 300a 2020 2020 2020 2020  .0  0.0.        
-00024eb0: 4344 325f 3120 4344 325f 3220 203a 2030  CD2_1 CD2_2  : 0
-00024ec0: 2e30 2020 312e 300a 2020 2020 2020 2020  .0  1.0.        
-00024ed0: 4e41 5849 5320 2020 203a 2032 3030 2032  NAXIS    : 200 2
-00024ee0: 300a 0a20 2020 2022 2222 0a0a 2020 2020  0..    """..    
-00024ef0: 6820 3d20 7079 6669 7473 2e49 6d61 6765  h = pyfits.Image
-00024f00: 4844 5528 6461 7461 3d6e 702e 7a65 726f  HDU(data=np.zero
-00024f10: 7328 2832 2a4e 592c 2032 2a4e 5829 2c20  s((2*NY, 2*NX), 
-00024f20: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
-00024f30: 2929 0a0a 2020 2020 7265 6668 203d 2068  ))..    refh = h
-00024f40: 2e68 6561 6465 720a 2020 2020 7265 6668  .header.    refh
-00024f50: 5b27 4352 5049 5831 275d 203d 204e 582b  ['CRPIX1'] = NX+
-00024f60: 310a 2020 2020 7265 6668 5b27 4352 5049  1.    refh['CRPI
-00024f70: 5832 275d 203d 204e 592b 310a 2020 2020  X2'] = NY+1.    
-00024f80: 7265 6668 5b27 4352 5641 4c31 275d 203d  refh['CRVAL1'] =
-00024f90: 2063 656e 7465 725f 7761 7665 2f31 2e65   center_wave/1.e
-00024fa0: 340a 2020 2020 7265 6668 5b27 4344 315f  4.    refh['CD1_
-00024fb0: 3127 5d20 3d20 646c 616d 2f31 2e65 340a  1'] = dlam/1.e4.
-00024fc0: 2020 2020 7265 6668 5b27 4344 315f 3227      refh['CD1_2'
-00024fd0: 5d20 3d20 302e 0a20 2020 2072 6566 685b  ] = 0..    refh[
-00024fe0: 2743 5256 414c 3227 5d20 3d20 302e 0a20  'CRVAL2'] = 0.. 
-00024ff0: 2020 2072 6566 685b 2743 4432 5f32 275d     refh['CD2_2']
-00025000: 203d 2073 7061 7469 616c 5f73 6361 6c65   = spatial_scale
-00025010: 0a20 2020 2072 6566 685b 2743 4432 5f31  .    refh['CD2_1
-00025020: 275d 203d 2030 2e0a 2020 2020 7265 6668  '] = 0..    refh
-00025030: 5b27 5241 4445 5359 5327 5d20 3d20 2727  ['RADESYS'] = ''
-00025040: 0a0a 2020 2020 7265 6668 5b27 4354 5950  ..    refh['CTYP
-00025050: 4531 275d 203d 2027 5241 2d2d 2d54 414e  E1'] = 'RA---TAN
-00025060: 2d53 4950 270a 2020 2020 7265 6668 5b27  -SIP'.    refh['
-00025070: 4355 4e49 5431 275d 203d 2027 6d61 7327  CUNIT1'] = 'mas'
-00025080: 0a20 2020 2072 6566 685b 2743 5459 5045  .    refh['CTYPE
-00025090: 3227 5d20 3d20 2744 4543 2d2d 5441 4e2d  2'] = 'DEC--TAN-
-000250a0: 5349 5027 0a20 2020 2072 6566 685b 2743  SIP'.    refh['C
-000250b0: 554e 4954 3227 5d20 3d20 276d 6173 270a  UNIT2'] = 'mas'.
-000250c0: 0a20 2020 2072 6566 5f77 6373 203d 2070  .    ref_wcs = p
-000250d0: 7977 6373 2e57 4353 2872 6566 6829 0a20  ywcs.WCS(refh). 
-000250e0: 2020 2072 6566 5f77 6373 2e70 7363 616c     ref_wcs.pscal
-000250f0: 6520 3d20 6765 745f 7763 735f 7073 6361  e = get_wcs_psca
-00025100: 6c65 2872 6566 5f77 6373 290a 0a20 2020  le(ref_wcs)..   
-00025110: 2072 6574 7572 6e20 7265 6668 2c20 7265   return refh, re
-00025120: 665f 7763 730a 0a0a 6465 6620 6d61 6b65  f_wcs...def make
-00025130: 5f73 7065 6374 7275 6d5f 7763 7368 6561  _spectrum_wcshea
-00025140: 6465 7228 6365 6e74 6572 5f77 6176 653d  der(center_wave=
-00025150: 312e 3465 342c 2064 6c61 6d3d 3430 2c20  1.4e4, dlam=40, 
-00025160: 4e58 3d31 3030 2c20 7370 6174 6961 6c5f  NX=100, spatial_
-00025170: 7363 616c 653d 312c 204e 593d 3130 293a  scale=1, NY=10):
-00025180: 0a20 2020 2022 2222 4d61 6b65 2061 2057  .    """Make a W
-00025190: 4353 2068 6561 6465 7220 666f 7220 6120  CS header for a 
-000251a0: 3244 2073 7065 6374 7275 6d0a 0a20 2020  2D spectrum..   
-000251b0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-000251c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
-000251d0: 656e 7465 725f 7761 7665 203a 2066 6c6f  enter_wave : flo
-000251e0: 6174 0a20 2020 2020 2020 2057 6176 656c  at.        Wavel
-000251f0: 656e 6774 6820 6f66 2074 6865 2063 656e  ength of the cen
-00025200: 7472 616c 2070 6978 656c 2c20 696e 2041  tral pixel, in A
-00025210: 6e73 7472 6f6d 730a 0a20 2020 2064 6c61  nstroms..    dla
-00025220: 6d20 3a20 666c 6f61 740a 2020 2020 2020  m : float.      
-00025230: 2020 4465 6c74 612d 7761 7665 6c65 6e67    Delta-waveleng
-00025240: 7468 2070 6572 2028 7829 2070 6978 656c  th per (x) pixel
-00025250: 0a0a 2020 2020 4e58 2c20 4e59 203a 2069  ..    NX, NY : i
-00025260: 6e74 0a20 2020 2020 2020 204e 756d 6265  nt.        Numbe
-00025270: 7220 6f66 2078 2026 2079 2070 6978 656c  r of x & y pixel
-00025280: 732e 204f 7574 7075 7420 7769 6c6c 2068  s. Output will h
-00025290: 6176 6520 7368 6170 6520 6028 322a 4e59  ave shape `(2*NY
-000252a0: 2c20 322a 4e58 2960 2e0a 0a20 2020 2073  , 2*NX)`...    s
-000252b0: 7061 7469 616c 5f73 6361 6c65 203a 2066  patial_scale : f
-000252c0: 6c6f 6174 0a20 2020 2020 2020 2053 7061  loat.        Spa
-000252d0: 7469 616c 2073 6361 6c65 206f 6620 7468  tial scale of th
-000252e0: 6520 6f75 7470 7574 2c20 696e 2075 6e69  e output, in uni
-000252f0: 7473 206f 6620 7468 6520 696e 7075 7420  ts of the input 
-00025300: 7069 7865 6c73 0a0a 2020 2020 5265 7475  pixels..    Retu
-00025310: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00025320: 2020 2020 6865 6164 6572 203a 2060 7e61      header : `~a
-00025330: 7374 726f 7079 2e69 6f2e 6669 7473 2e48  stropy.io.fits.H
-00025340: 6561 6465 7260 0a20 2020 2020 2020 204f  eader`.        O
-00025350: 7574 7075 7420 5743 5320 6865 6164 6572  utput WCS header
-00025360: 0a0a 2020 2020 7763 7320 3a20 607e 6173  ..    wcs : `~as
-00025370: 7472 6f70 792e 7763 732e 5743 5360 0a20  tropy.wcs.WCS`. 
-00025380: 2020 2020 2020 204f 7574 7075 7420 5743         Output WC
-00025390: 530a 0a20 2020 2045 7861 6d70 6c65 730a  S..    Examples.
-000253a0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a0a 2020      --------..  
-000253b0: 2020 2020 2020 3e3e 3e20 6672 6f6d 2067        >>> from g
-000253c0: 7269 7a6c 692e 7574 696c 7320 696d 706f  rizli.utils impo
-000253d0: 7274 206d 616b 655f 7370 6563 7472 756d  rt make_spectrum
-000253e0: 5f77 6373 6865 6164 6572 0a20 2020 2020  _wcsheader.     
-000253f0: 2020 203e 3e3e 2068 2c20 7763 7320 3d20     >>> h, wcs = 
-00025400: 6d61 6b65 5f73 7065 6374 7275 6d5f 7763  make_spectrum_wc
-00025410: 7368 6561 6465 7228 290a 2020 2020 2020  sheader().      
-00025420: 2020 3e3e 3e20 7072 696e 7428 7763 7329    >>> print(wcs)
-00025430: 0a20 2020 2020 2020 2057 4353 204b 6579  .        WCS Key
-00025440: 776f 7264 730a 2020 2020 2020 2020 4e75  words.        Nu
-00025450: 6d62 6572 206f 6620 5743 5320 6178 6573  mber of WCS axes
-00025460: 3a20 320a 2020 2020 2020 2020 4354 5950  : 2.        CTYP
-00025470: 4520 3a20 2757 4156 4527 2020 274c 494e  E : 'WAVE'  'LIN
-00025480: 4541 5227 0a20 2020 2020 2020 2043 5256  EAR'.        CRV
-00025490: 414c 203a 2031 3430 3030 2e30 2020 302e  AL : 14000.0  0.
-000254a0: 300a 2020 2020 2020 2020 4352 5049 5820  0.        CRPIX 
-000254b0: 3a20 3130 312e 3020 2031 312e 300a 2020  : 101.0  11.0.  
-000254c0: 2020 2020 2020 4344 315f 3120 4344 315f        CD1_1 CD1_
-000254d0: 3220 203a 2034 302e 3020 2030 2e30 0a20  2  : 40.0  0.0. 
-000254e0: 2020 2020 2020 2043 4432 5f31 2043 4432         CD2_1 CD2
-000254f0: 5f32 2020 3a20 302e 3020 2031 2e30 0a20  _2  : 0.0  1.0. 
-00025500: 2020 2020 2020 204e 4158 4953 2020 2020         NAXIS    
-00025510: 3a20 3230 3020 3230 0a0a 2020 2020 2222  : 200 20..    ""
-00025520: 220a 0a20 2020 2068 203d 2070 7966 6974  "..    h = pyfit
-00025530: 732e 496d 6167 6548 4455 2864 6174 613d  s.ImageHDU(data=
-00025540: 6e70 2e7a 6572 6f73 2828 322a 4e59 2c20  np.zeros((2*NY, 
-00025550: 322a 4e58 292c 2064 7479 7065 3d6e 702e  2*NX), dtype=np.
-00025560: 666c 6f61 7433 3229 290a 0a20 2020 2072  float32))..    r
-00025570: 6566 6820 3d20 682e 6865 6164 6572 0a20  efh = h.header. 
-00025580: 2020 2072 6566 685b 2743 5250 4958 3127     refh['CRPIX1'
-00025590: 5d20 3d20 4e58 2b31 0a20 2020 2072 6566  ] = NX+1.    ref
-000255a0: 685b 2743 5250 4958 3227 5d20 3d20 4e59  h['CRPIX2'] = NY
-000255b0: 2b31 0a20 2020 2072 6566 685b 2743 5256  +1.    refh['CRV
-000255c0: 414c 3127 5d20 3d20 6365 6e74 6572 5f77  AL1'] = center_w
-000255d0: 6176 650a 2020 2020 7265 6668 5b27 4344  ave.    refh['CD
-000255e0: 315f 3127 5d20 3d20 646c 616d 0a20 2020  1_1'] = dlam.   
-000255f0: 2072 6566 685b 2743 4431 5f32 275d 203d   refh['CD1_2'] =
-00025600: 2030 2e0a 2020 2020 7265 6668 5b27 4352   0..    refh['CR
-00025610: 5641 4c32 275d 203d 2030 2e0a 2020 2020  VAL2'] = 0..    
-00025620: 7265 6668 5b27 4344 325f 3227 5d20 3d20  refh['CD2_2'] = 
-00025630: 7370 6174 6961 6c5f 7363 616c 650a 2020  spatial_scale.  
-00025640: 2020 7265 6668 5b27 4344 325f 3127 5d20    refh['CD2_1'] 
-00025650: 3d20 302e 0a20 2020 2072 6566 685b 2752  = 0..    refh['R
-00025660: 4144 4553 5953 275d 203d 2027 270a 0a20  ADESYS'] = ''.. 
-00025670: 2020 2072 6566 685b 2743 5459 5045 3127     refh['CTYPE1'
-00025680: 5d20 3d20 2757 4156 4527 0a20 2020 2072  ] = 'WAVE'.    r
-00025690: 6566 685b 2743 5459 5045 3227 5d20 3d20  efh['CTYPE2'] = 
-000256a0: 274c 494e 4541 5227 0a0a 2020 2020 7265  'LINEAR'..    re
-000256b0: 665f 7763 7320 3d20 7079 7763 732e 5743  f_wcs = pywcs.WC
-000256c0: 5328 682e 6865 6164 6572 290a 2020 2020  S(h.header).    
-000256d0: 7265 665f 7763 732e 7073 6361 6c65 203d  ref_wcs.pscale =
-000256e0: 206e 702e 7371 7274 2872 6566 5f77 6373   np.sqrt(ref_wcs
-000256f0: 2e77 6373 2e63 645b 302c 2030 5d2a 2a32  .wcs.cd[0, 0]**2
-00025700: 202b 2072 6566 5f77 6373 2e77 6373 2e63   + ref_wcs.wcs.c
-00025710: 645b 312c 2030 5d2a 2a32 292a 3336 3030  d[1, 0]**2)*3600
-00025720: 2e0a 0a20 2020 2072 6574 7572 6e20 7265  ...    return re
-00025730: 6668 2c20 7265 665f 7763 730a 0a0a 6465  fh, ref_wcs...de
-00025740: 6620 7265 6164 5f67 7a69 7070 6564 5f68  f read_gzipped_h
-00025750: 6561 6465 7228 6669 6c65 3d27 7465 7374  eader(file='test
-00025760: 2e66 6974 732e 677a 272c 2042 4c4f 434b  .fits.gz', BLOCK
-00025770: 3d31 3032 342c 204e 4d41 583d 3235 362c  =1024, NMAX=256,
-00025780: 206e 7370 6163 653d 3136 2c20 7374 7269   nspace=16, stri
-00025790: 703d 4661 6c73 6529 3a0a 2020 2020 2222  p=False):.    ""
-000257a0: 220a 2020 2020 5265 6164 2070 7269 6d61  ".    Read prima
-000257b0: 7279 2068 6561 6465 7220 6672 6f6d 2061  ry header from a
-000257c0: 2028 706f 7465 6e74 6961 6c6c 7920 6c61   (potentially la
-000257d0: 7267 6529 207a 6970 7065 6420 4649 5453  rge) zipped FITS
-000257e0: 2066 696c 650a 0a20 2020 2054 6865 2073   file..    The s
-000257f0: 6372 6970 7420 7072 6f63 6565 6473 2062  cript proceeds b
-00025800: 7920 7265 6164 696e 6720 604e 4d41 5860  y reading `NMAX`
-00025810: 2073 6567 6d65 6e74 7320 6f66 2073 697a   segments of siz
-00025820: 6520 6042 4c4f 434b 6020 6279 7465 7320  e `BLOCK` bytes 
-00025830: 6672 6f6d 0a20 2020 2074 6865 2066 696c  from.    the fil
-00025840: 6520 616e 6420 7365 6172 6368 696e 6720  e and searching 
-00025850: 666f 7220 6120 7374 7269 6e67 2060 454e  for a string `EN
-00025860: 4420 2b20 2720 272a 6e73 7061 6365 6020  D + ' '*nspace` 
-00025870: 696e 2074 6865 2064 6174 610a 2020 2020  in the data.    
-00025880: 696e 6469 6361 7469 6e67 2074 6865 2065  indicating the e
-00025890: 6e64 206f 6620 7468 6520 7072 696d 6172  nd of the primar
-000258a0: 7920 6865 6164 6572 2e0a 0a20 2020 2050  y header...    P
-000258b0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-000258c0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2066 696c  --------.    fil
-000258d0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
-000258e0: 4669 6c65 6e61 6d65 206f 6620 677a 6970  Filename of gzip
-000258f0: 7065 6420 4649 5453 2066 696c 650a 0a20  ped FITS file.. 
-00025900: 2020 2042 4c4f 434b 2c20 4e4d 4158 2c20     BLOCK, NMAX, 
-00025910: 6e73 7061 6365 203a 2069 6e74 0a20 2020  nspace : int.   
-00025920: 2020 2020 2050 6172 616d 6574 6572 7320       Parameters 
-00025930: 666f 7220 7265 6164 696e 6720 6279 7465  for reading byte
-00025940: 7320 6672 6f6d 2074 6865 2069 6e70 7574  s from the input
-00025950: 2066 696c 650a 0a20 2020 2073 7472 6970   file..    strip
-00025960: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
-00025970: 5365 6e64 206f 7574 7075 7420 7468 726f  Send output thro
-00025980: 7567 6820 6073 7472 6970 5f68 6561 6465  ugh `strip_heade
-00025990: 725f 6b65 7973 602e 0a0a 0a20 2020 2052  r_keys`....    R
-000259a0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-000259b0: 2d2d 0a20 2020 2068 6561 6465 7220 3a20  --.    header : 
-000259c0: 607e 6173 7472 6f70 792e 696f 2e66 6974  `~astropy.io.fit
-000259d0: 732e 4865 6164 6572 600a 2020 2020 2020  s.Header`.      
-000259e0: 2020 4865 6164 6572 206f 626a 6563 740a    Header object.
-000259f0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-00025a00: 6f72 7420 677a 6970 0a20 2020 2069 6d70  ort gzip.    imp
-00025a10: 6f72 7420 6173 7472 6f70 792e 696f 2e66  ort astropy.io.f
-00025a20: 6974 7320 6173 2070 7966 6974 730a 0a20  its as pyfits.. 
-00025a30: 2020 2066 203d 2067 7a69 702e 477a 6970     f = gzip.Gzip
-00025a40: 4669 6c65 2866 696c 656f 626a 3d6f 7065  File(fileobj=ope
-00025a50: 6e28 6669 6c65 2c20 2772 6227 2929 0a0a  n(file, 'rb'))..
-00025a60: 2020 2020 6461 7461 203d 2062 2727 0a20      data = b''. 
-00025a70: 2020 2065 6e64 203d 2062 2720 454e 4427     end = b' END'
-00025a80: 2b62 2720 272a 6e73 7061 6365 0a0a 2020  +b' '*nspace..  
-00025a90: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-00025aa0: 284e 4d41 5829 3a0a 2020 2020 2020 2020  (NMAX):.        
-00025ab0: 6461 7461 5f69 203d 2066 2e72 6561 6428  data_i = f.read(
-00025ac0: 424c 4f43 4b29 0a20 2020 2020 2020 2069  BLOCK).        i
-00025ad0: 6620 656e 6420 696e 2064 6174 615f 693a  f end in data_i:
-00025ae0: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
-00025af0: 616b 0a0a 2020 2020 2020 2020 6461 7461  ak..        data
-00025b00: 202b 3d20 6461 7461 5f69 0a0a 2020 2020   += data_i..    
-00025b10: 6966 2028 6920 3d3d 204e 4d41 582d 3129  if (i == NMAX-1)
-00025b20: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-00025b30: 2745 7272 6f72 3a20 454e 442b 7b33 7d2a  'Error: END+{3}*
-00025b40: 2220 2220 6e6f 7420 666f 756e 6420 696e  " " not found in
-00025b50: 2066 6972 7374 207b 307d 787b 317d 2062   first {0}x{1} b
-00025b60: 7974 6573 206f 6620 7b32 7d29 272e 666f  ytes of {2})'.fo
-00025b70: 726d 6174 284e 4d41 582c 2042 4c4f 434b  rmat(NMAX, BLOCK
-00025b80: 2c20 6669 6c65 2c20 6e73 7061 6365 2929  , file, nspace))
-00025b90: 0a20 2020 2020 2020 2066 2e63 6c6f 7365  .        f.close
-00025ba0: 2829 0a20 2020 2020 2020 2072 6574 7572  ().        retur
-00025bb0: 6e20 7b7d 0a0a 2020 2020 6978 203d 2064  n {}..    ix = d
-00025bc0: 6174 615f 692e 696e 6465 7828 656e 6429  ata_i.index(end)
-00025bd0: 0a20 2020 2064 6174 6120 2b3d 2064 6174  .    data += dat
-00025be0: 615f 695b 3a69 785d 2b65 6e64 2020 2320  a_i[:ix]+end  # 
-00025bf0: 6461 7461 5f69 5b3a 6978 5d0a 0a20 2020  data_i[:ix]..   
-00025c00: 2066 2e63 6c6f 7365 2829 0a20 2020 2064   f.close().    d
-00025c10: 6174 615f 7374 7220 3d20 6461 7461 2e64  ata_str = data.d
-00025c20: 6563 6f64 6528 2775 7466 3827 290a 2020  ecode('utf8').  
-00025c30: 2020 6820 3d20 7079 6669 7473 2e48 6561    h = pyfits.Hea
-00025c40: 6465 722e 6672 6f6d 7374 7269 6e67 2864  der.fromstring(d
-00025c50: 6174 615f 7374 7229 0a0a 2020 2020 6966  ata_str)..    if
-00025c60: 2073 7472 6970 3a0a 2020 2020 2020 2020   strip:.        
-00025c70: 7265 7475 726e 2073 7472 6970 5f68 6561  return strip_hea
-00025c80: 6465 725f 6b65 7973 2868 2c20 7573 6577  der_keys(h, usew
-00025c90: 6373 3d54 7275 6529 0a20 2020 2065 6c73  cs=True).    els
-00025ca0: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-00025cb0: 6e20 680a 0a0a 4452 495a 5a4c 455f 4b45  n h...DRIZZLE_KE
-00025cc0: 5953 203d 205b 2747 454f 4d27 2c20 2744  YS = ['GEOM', 'D
-00025cd0: 4154 4127 2c20 2744 4558 5027 2c20 274f  ATA', 'DEXP', 'O
-00025ce0: 5544 4127 2c20 274f 5557 4527 2c20 274f  UDA', 'OUWE', 'O
-00025cf0: 5543 4f27 2c20 274d 4153 4b27 2c20 2757  UCO', 'MASK', 'W
-00025d00: 5453 4327 2c20 274b 4552 4e27 2c20 2750  TSC', 'KERN', 'P
-00025d10: 4958 4627 2c20 2743 4f45 4627 2c20 274f  IXF', 'COEF', 'O
-00025d20: 5555 4e27 2c20 2746 5641 4c27 2c20 2757  UUN', 'FVAL', 'W
-00025d30: 4b45 5927 2c20 2753 4341 4c27 2c20 2749  KEY', 'SCAL', 'I
-00025d40: 5343 4c27 5d0a 0a0a 6465 6620 7374 7269  SCL']...def stri
-00025d50: 705f 6865 6164 6572 5f6b 6579 7328 6865  p_header_keys(he
-00025d60: 6164 6572 2c20 636f 6d6d 656e 743d 5472  ader, comment=Tr
-00025d70: 7565 2c20 6869 7374 6f72 793d 5472 7565  ue, history=True
-00025d80: 2c20 6472 697a 7a6c 655f 6b65 7973 3d44  , drizzle_keys=D
-00025d90: 5249 5a5a 4c45 5f4b 4559 532c 2075 7365  RIZZLE_KEYS, use
-00025da0: 7763 733d 4661 6c73 652c 206b 6565 705f  wcs=False, keep_
-00025db0: 7769 7468 5f77 6373 3d5b 2745 5850 5449  with_wcs=['EXPTI
-00025dc0: 4d45 272c 2027 4649 4c54 4552 272c 2027  ME', 'FILTER', '
-00025dd0: 5445 4c45 5343 4f50 272c 2027 494e 5354  TELESCOP', 'INST
-00025de0: 5255 4d45 272c 2027 4441 5445 2d4f 4253  RUME', 'DATE-OBS
-00025df0: 272c 2027 4558 5053 5441 5254 272c 2027  ', 'EXPSTART', '
-00025e00: 4558 5045 4e44 275d 293a 0a20 2020 2022  EXPEND']):.    "
-00025e10: 2222 0a20 2020 2053 7472 6970 2068 6561  "".    Strip hea
-00025e20: 6465 7220 6b65 7977 6f72 6473 0a0a 2020  der keywords..  
-00025e30: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00025e40: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 0a20 2020   ----------..   
-00025e50: 2063 6f6d 6d65 6e74 2c20 6869 7374 6f72   comment, histor
-00025e60: 7920 3a20 626f 6f6c 0a20 2020 2020 2020  y : bool.       
-00025e70: 2053 7472 6970 2027 434f 4d4d 454e 5427   Strip 'COMMENT'
-00025e80: 2061 6e64 2027 4849 5354 4f52 5927 206b   and 'HISTORY' k
-00025e90: 6579 776f 7264 732c 2072 6573 7065 6374  eywords, respect
-00025ea0: 6976 656c 792e 0a0a 2020 2020 6472 697a  ively...    driz
-00025eb0: 7a6c 655f 6b65 7973 203a 206c 6973 740a  zle_keys : list.
-00025ec0: 2020 2020 2020 2020 5374 7269 7020 6b65          Strip ke
-00025ed0: 7973 2070 726f 6475 6365 6420 6279 2060  ys produced by `
-00025ee0: 7e64 7269 7a7a 6c65 7061 632e 6173 7472  ~drizzlepac.astr
-00025ef0: 6f64 7269 7a7a 6c65 602e 0a0a 2020 2020  odrizzle`...    
-00025f00: 7573 6577 6373 203a 2062 6f6f 6c0a 2020  usewcs : bool.  
-00025f10: 2020 2020 2020 416c 7465 726e 6174 6976        Alternativ
-00025f20: 656c 792c 206a 7573 7420 6765 6e65 7261  ely, just genera
-00025f30: 7465 2061 2073 696d 706c 6520 5743 532d  te a simple WCS-
-00025f40: 6f6e 6c79 2068 6561 6465 7220 6672 6f6d  only header from
-00025f50: 2074 6865 2069 6e70 7574 0a20 2020 2020   the input.     
-00025f60: 2020 2068 6561 6465 722e 0a0a 2020 2020     header...    
-00025f70: 6b65 6570 5f77 6974 685f 7763 7320 3a20  keep_with_wcs : 
-00025f80: 6c69 7374 0a20 2020 2020 2020 2041 6464  list.        Add
-00025f90: 6974 696f 6e61 6c20 6b65 7973 2074 6f20  itional keys to 
-00025fa0: 7472 7920 746f 2061 6464 2074 6f20 7468  try to add to th
-00025fb0: 6520 6075 7365 7763 7360 2068 6561 6465  e `usewcs` heade
-00025fc0: 722e 0a0a 2020 2020 5265 7475 726e 730a  r...    Returns.
-00025fd0: 2020 2020 2d2d 2d2d 2d2d 2d0a 0a20 2020      -------..   
-00025fe0: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
-00025ff0: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
-00026000: 6572 600a 2020 2020 2020 2020 4865 6164  er`.        Head
-00026010: 6572 206f 626a 6563 742e 0a0a 2020 2020  er object...    
-00026020: 2222 220a 2020 2020 696d 706f 7274 2063  """.    import c
-00026030: 6f70 790a 2020 2020 696d 706f 7274 2061  opy.    import a
-00026040: 7374 726f 7079 2e77 6373 2061 7320 7079  stropy.wcs as py
-00026050: 7763 730a 0a20 2020 2023 2050 6172 7365  wcs..    # Parse
-00026060: 2057 4353 2061 6e64 2062 7569 6c64 2068   WCS and build h
-00026070: 6561 6465 720a 2020 2020 6966 2075 7365  eader.    if use
-00026080: 7763 733a 0a20 2020 2020 2020 2077 6373  wcs:.        wcs
-00026090: 203d 2070 7977 6373 2e57 4353 2868 6561   = pywcs.WCS(hea
-000260a0: 6465 7229 0a20 2020 2020 2020 2068 203d  der).        h =
-000260b0: 2074 6f5f 6865 6164 6572 2877 6373 290a   to_header(wcs).
-000260c0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-000260d0: 206b 6565 705f 7769 7468 5f77 6373 3a0a   keep_with_wcs:.
-000260e0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-000260f0: 2069 6e20 6865 6164 6572 3a0a 2020 2020   in header:.    
-00026100: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00026110: 2069 6e20 6865 6164 6572 2e63 6f6d 6d65   in header.comme
-00026120: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00026130: 2020 2020 2020 2020 2068 5b6b 5d20 3d20           h[k] = 
-00026140: 6865 6164 6572 5b6b 5d2c 2068 6561 6465  header[k], heade
-00026150: 722e 636f 6d6d 656e 7473 5b6b 5d0a 2020  r.comments[k].  
-00026160: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00026170: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00026180: 2020 2020 2020 2020 685b 6b5d 203d 2068          h[k] = h
-00026190: 6561 6465 725b 6b5d 0a0a 2020 2020 2020  eader[k]..      
-000261a0: 2020 6966 2027 4649 4c54 4552 2720 696e    if 'FILTER' in
-000261b0: 206b 6565 705f 7769 7468 5f77 6373 3a0a   keep_with_wcs:.
-000261c0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000261d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000261e0: 2068 5b27 4649 4c54 4552 275d 203d 2028   h['FILTER'] = (
-000261f0: 7061 7273 655f 6669 6c74 6572 5f66 726f  parse_filter_fro
-00026200: 6d5f 6865 6164 6572 2868 6561 6465 7229  m_header(header)
-00026210: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00026220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026230: 2027 656c 656d 656e 7420 7365 6c65 6374   'element select
-00026240: 6564 2066 726f 6d20 6669 6c74 6572 2077  ed from filter w
-00026250: 6865 656c 2729 0a20 2020 2020 2020 2020  heel').         
-00026260: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00026270: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00026280: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00026290: 680a 0a20 2020 2068 203d 2063 6f70 792e  h..    h = copy.
-000262a0: 6465 6570 636f 7079 2868 6561 6465 7229  deepcopy(header)
-000262b0: 0a20 2020 206b 6579 7320 3d20 6c69 7374  .    keys = list
-000262c0: 2868 2e6b 6579 7328 2929 0a20 2020 2073  (h.keys()).    s
-000262d0: 7472 6970 5f6b 6579 7320 3d20 5b5d 0a20  trip_keys = []. 
-000262e0: 2020 2069 6620 636f 6d6d 656e 743a 0a20     if comment:. 
-000262f0: 2020 2020 2020 2073 7472 6970 5f6b 6579         strip_key
-00026300: 732e 6170 7065 6e64 2827 434f 4d4d 454e  s.append('COMMEN
-00026310: 5427 290a 0a20 2020 2069 6620 6869 7374  T')..    if hist
-00026320: 6f72 793a 0a20 2020 2020 2020 2073 7472  ory:.        str
-00026330: 6970 5f6b 6579 732e 6170 7065 6e64 2827  ip_keys.append('
-00026340: 4849 5354 4f52 5927 290a 0a20 2020 2066  HISTORY')..    f
-00026350: 6f72 206b 2069 6e20 6b65 7973 3a0a 2020  or k in keys:.  
-00026360: 2020 2020 2020 6966 206b 2069 6e20 7374        if k in st
-00026370: 7269 705f 6b65 7973 3a0a 2020 2020 2020  rip_keys:.      
-00026380: 2020 2020 2020 682e 7265 6d6f 7665 286b        h.remove(k
-00026390: 290a 0a20 2020 2020 2020 2069 6620 6472  )..        if dr
-000263a0: 697a 7a6c 655f 6b65 7973 3a0a 2020 2020  izzle_keys:.    
-000263b0: 2020 2020 2020 2020 6966 206b 2e73 7461          if k.sta
-000263c0: 7274 7377 6974 6828 2744 2729 3a0a 2020  rtswith('D'):.  
-000263d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000263e0: 2028 6b5b 2d34 3a5d 2069 6e20 6472 697a   (k[-4:] in driz
-000263f0: 7a6c 655f 6b65 7973 2920 7c20 6b2e 656e  zle_keys) | k.en
-00026400: 6473 7769 7468 2827 5645 5227 293a 0a20  dswith('VER'):. 
-00026410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026420: 2020 2068 2e72 656d 6f76 6528 6b29 0a0a     h.remove(k)..
-00026430: 2020 2020 7265 7475 726e 2068 0a0a 0a64      return h...d
-00026440: 6566 2077 6373 5f66 726f 6d5f 6865 6164  ef wcs_from_head
-00026450: 6572 2868 6561 6465 722c 2072 656c 6178  er(header, relax
-00026460: 3d54 7275 652c 202a 2a6b 7761 7267 7329  =True, **kwargs)
-00026470: 3a0a 2020 2020 2222 220a 2020 2020 496e  :.    """.    In
-00026480: 6974 6961 6c69 7a65 2060 7e61 7374 726f  itialize `~astro
-00026490: 7079 2e77 6373 2e57 4353 6020 6672 6f6d  py.wcs.WCS` from
-000264a0: 2061 2060 7e61 7374 726f 7079 2e69 6f2e   a `~astropy.io.
-000264b0: 6669 7473 2e48 6561 6465 7260 0a20 2020  fits.Header`.   
-000264c0: 200a 2020 2020 5061 7261 6d65 7465 7273   .    Parameters
-000264d0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-000264e0: 2020 2020 6865 6164 6572 203a 2060 7e61      header : `~a
-000264f0: 7374 726f 7079 2e69 6f2e 6669 7473 2e48  stropy.io.fits.H
-00026500: 6561 6465 7260 0a20 2020 2020 2020 2046  eader`.        F
-00026510: 4954 5320 6865 6164 6572 2077 6974 6820  ITS header with 
-00026520: 6f70 7469 6f6e 616c 2060 6053 4950 4352  optional ``SIPCR
-00026530: 5058 3160 6020 616e 6420 6060 5349 5043  PX1`` and ``SIPC
-00026540: 5250 5832 6060 206b 6579 776f 7264 7320  RPX2`` keywords 
-00026550: 7468 6174 0a20 2020 2020 2020 2064 6566  that.        def
-00026560: 696e 6520 6120 7365 7061 7261 7465 2072  ine a separate r
-00026570: 6566 6572 656e 6365 2070 6978 656c 2066  eference pixel f
-00026580: 6f72 2061 2053 4950 2068 6561 6465 720a  or a SIP header.
-00026590: 2020 2020 0a20 2020 2072 656c 6178 2c20      .    relax, 
-000265a0: 6b77 6172 6773 203a 2062 6f6f 6c2c 2064  kwargs : bool, d
-000265b0: 6963 740a 2020 2020 2020 2020 4b65 7977  ict.        Keyw
-000265c0: 6f72 6473 2070 6173 7365 6420 746f 2060  ords passed to `
-000265d0: 6173 7472 6f70 792e 7763 732e 5743 5360  astropy.wcs.WCS`
-000265e0: 0a20 2020 200a 2020 2020 5265 7475 726e  .    .    Return
-000265f0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00026600: 2020 7763 7320 3a20 607e 6173 7472 6f70    wcs : `~astrop
-00026610: 792e 7763 732e 5743 5360 0a20 2020 2020  y.wcs.WCS`.     
-00026620: 2020 2057 4353 206f 626a 6563 740a 2020     WCS object.  
-00026630: 2020 2020 2020 0a20 2020 2022 2222 0a20        .    """. 
-00026640: 2020 2077 6373 203d 2070 7977 6373 2e57     wcs = pywcs.W
-00026650: 4353 2868 6561 6465 722c 2072 656c 6178  CS(header, relax
-00026660: 3d72 656c 6178 290a 2020 2020 0a20 2020  =relax).    .   
-00026670: 2069 6620 2827 5349 5043 5250 5831 2720   if ('SIPCRPX1' 
-00026680: 696e 2068 6561 6465 7229 2026 2068 6173  in header) & has
-00026690: 6174 7472 2877 6373 2c20 2773 6970 2729  attr(wcs, 'sip')
-000266a0: 3a0a 2020 2020 2020 2020 7763 732e 7369  :.        wcs.si
-000266b0: 702e 6372 7069 785b 305d 203d 2068 6561  p.crpix[0] = hea
-000266c0: 6465 725b 2753 4950 4352 5058 3127 5d0a  der['SIPCRPX1'].
-000266d0: 2020 2020 2020 2020 7763 732e 7369 702e          wcs.sip.
-000266e0: 6372 7069 785b 315d 203d 2068 6561 6465  crpix[1] = heade
-000266f0: 725b 2753 4950 4352 5058 3227 5d0a 2020  r['SIPCRPX2'].  
-00026700: 2020 656c 6966 2028 2753 4941 465f 5852    elif ('SIAF_XR
-00026710: 4546 5f53 4349 2720 696e 2068 6561 6465  EF_SCI' in heade
-00026720: 7229 2026 2068 6173 6174 7472 2877 6373  r) & hasattr(wcs
-00026730: 2c20 2773 6970 2729 3a0a 2020 2020 2020  , 'sip'):.      
-00026740: 2020 7763 732e 7369 702e 6372 7069 785b    wcs.sip.crpix[
-00026750: 305d 203d 2068 6561 6465 725b 2753 4941  0] = header['SIA
-00026760: 465f 5852 4546 5f53 4349 275d 0a20 2020  F_XREF_SCI'].   
-00026770: 2020 2020 2077 6373 2e73 6970 2e63 7270       wcs.sip.crp
-00026780: 6978 5b31 5d20 3d20 6865 6164 6572 5b27  ix[1] = header['
-00026790: 5349 4146 5f59 5245 465f 5343 4927 5d0a  SIAF_YREF_SCI'].
-000267a0: 2020 2020 2020 2020 0a20 2020 2072 6574          .    ret
-000267b0: 7572 6e20 7763 730a 0a0a 6465 6620 746f  urn wcs...def to
-000267c0: 5f68 6561 6465 7228 7763 732c 2061 6464  _header(wcs, add
-000267d0: 5f6e 6178 6973 3d54 7275 652c 2072 656c  _naxis=True, rel
-000267e0: 6178 3d54 7275 652c 206b 6579 3d4e 6f6e  ax=True, key=Non
-000267f0: 6529 3a0a 2020 2020 2222 224d 6f64 6966  e):.    """Modif
-00026800: 7920 6061 7374 726f 7079 2e77 6373 2e57  y `astropy.wcs.W
-00026810: 4353 2e74 6f5f 6865 6164 6572 6020 746f  CS.to_header` to
-00026820: 2070 726f 6475 6365 206d 6f72 6520 6b65   produce more ke
-00026830: 7977 6f72 6473 0a0a 2020 2020 5061 7261  ywords..    Para
-00026840: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00026850: 2d2d 2d2d 2d0a 2020 2020 7763 7320 3a20  -----.    wcs : 
-00026860: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
-00026870: 5360 0a20 2020 2020 2020 2049 6e70 7574  S`.        Input
-00026880: 2057 4353 2e0a 0a20 2020 2061 6464 5f6e   WCS...    add_n
-00026890: 6178 6973 203a 2062 6f6f 6c0a 2020 2020  axis : bool.    
-000268a0: 2020 2020 4164 6420 4e41 5849 5320 6b65      Add NAXIS ke
-000268b0: 7977 6f72 6473 2066 726f 6d20 5743 5320  ywords from WCS 
-000268c0: 6469 6d65 6e73 696f 6e73 0a0a 2020 2020  dimensions..    
-000268d0: 7265 6c61 7820 3a20 626f 6f6c 0a20 2020  relax : bool.   
-000268e0: 2020 2020 2050 6173 7365 6420 746f 2060       Passed to `
-000268f0: 5743 532e 746f 5f68 6561 6465 7228 7265  WCS.to_header(re
-00026900: 6c61 783d 2960 2e0a 0a20 2020 206b 6579  lax=)`...    key
-00026910: 203a 2073 7472 0a20 2020 2020 2020 2053   : str.        S
-00026920: 6565 2060 7e61 7374 726f 7079 2e77 6373  ee `~astropy.wcs
-00026930: 2e57 4353 2e74 6f5f 6865 6164 6572 602e  .WCS.to_header`.
-00026940: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-00026950: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6865    -------.    he
-00026960: 6164 6572 203a 2060 7e61 7374 726f 7079  ader : `~astropy
-00026970: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
-00026980: 0a20 2020 2020 2020 204f 7574 7075 7420  .        Output 
-00026990: 6865 6164 6572 2e0a 0a20 2020 2022 2222  header...    """
-000269a0: 0a20 2020 2068 6561 6465 7220 3d20 7763  .    header = wc
-000269b0: 732e 746f 5f68 6561 6465 7228 7265 6c61  s.to_header(rela
-000269c0: 783d 7265 6c61 782c 206b 6579 3d6b 6579  x=relax, key=key
-000269d0: 290a 2020 2020 6966 2061 6464 5f6e 6178  ).    if add_nax
-000269e0: 6973 3a0a 2020 2020 2020 2020 6966 2068  is:.        if h
-000269f0: 6173 6174 7472 2877 6373 2c20 2770 6978  asattr(wcs, 'pix
-00026a00: 656c 5f73 6861 7065 2729 3a0a 2020 2020  el_shape'):.    
-00026a10: 2020 2020 2020 2020 6865 6164 6572 5b27          header['
-00026a20: 4e41 5849 5327 5d20 3d20 7763 732e 6e61  NAXIS'] = wcs.na
-00026a30: 7869 730a 2020 2020 2020 2020 2020 2020  xis.            
-00026a40: 6966 2077 6373 2e70 6978 656c 5f73 6861  if wcs.pixel_sha
-00026a50: 7065 2069 7320 6e6f 7420 4e6f 6e65 3a0a  pe is not None:.
-00026a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a70: 6865 6164 6572 5b27 4e41 5849 5331 275d  header['NAXIS1']
-00026a80: 203d 2077 6373 2e70 6978 656c 5f73 6861   = wcs.pixel_sha
-00026a90: 7065 5b30 5d0a 2020 2020 2020 2020 2020  pe[0].          
-00026aa0: 2020 2020 2020 6865 6164 6572 5b27 4e41        header['NA
-00026ab0: 5849 5332 275d 203d 2077 6373 2e70 6978  XIS2'] = wcs.pix
-00026ac0: 656c 5f73 6861 7065 5b31 5d0a 0a20 2020  el_shape[1]..   
-00026ad0: 2020 2020 2065 6c69 6620 6861 7361 7474       elif hasatt
-00026ae0: 7228 7763 732c 2027 5f6e 6178 6973 3127  r(wcs, '_naxis1'
-00026af0: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-00026b00: 6561 6465 725b 274e 4158 4953 275d 203d  eader['NAXIS'] =
-00026b10: 2077 6373 2e6e 6178 6973 0a20 2020 2020   wcs.naxis.     
-00026b20: 2020 2020 2020 2068 6561 6465 725b 274e         header['N
-00026b30: 4158 4953 3127 5d20 3d20 7763 732e 5f6e  AXIS1'] = wcs._n
-00026b40: 6178 6973 310a 2020 2020 2020 2020 2020  axis1.          
-00026b50: 2020 6865 6164 6572 5b27 4e41 5849 5332    header['NAXIS2
-00026b60: 275d 203d 2077 6373 2e5f 6e61 7869 7332  '] = wcs._naxis2
-00026b70: 0a0a 2020 2020 666f 7220 6b20 696e 2068  ..    for k in h
-00026b80: 6561 6465 723a 0a20 2020 2020 2020 2069  eader:.        i
-00026b90: 6620 6b2e 7374 6172 7473 7769 7468 2827  f k.startswith('
-00026ba0: 5043 2729 3a0a 2020 2020 2020 2020 2020  PC'):.          
-00026bb0: 2020 6364 203d 206b 2e72 6570 6c61 6365    cd = k.replace
-00026bc0: 2827 5043 272c 2027 4344 2729 0a20 2020  ('PC', 'CD').   
-00026bd0: 2020 2020 2020 2020 2068 6561 6465 722e           header.
-00026be0: 7265 6e61 6d65 5f6b 6579 776f 7264 286b  rename_keyword(k
-00026bf0: 2c20 6364 290a 2020 2020 0a20 2020 2069  , cd).    .    i
-00026c00: 6620 6861 7361 7474 7228 7763 732e 7763  f hasattr(wcs.wc
-00026c10: 732c 2027 6364 2729 3a0a 2020 2020 2020  s, 'cd'):.      
-00026c20: 2020 666f 7220 6920 696e 205b 302c 315d    for i in [0,1]
-00026c30: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00026c40: 7220 6a20 696e 205b 302c 315d 3a0a 2020  r j in [0,1]:.  
-00026c50: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00026c60: 6164 6572 5b66 2743 447b 692b 317d 5f7b  ader[f'CD{i+1}_{
-00026c70: 6a2b 317d 275d 203d 2077 6373 2e77 6373  j+1}'] = wcs.wcs
-00026c80: 2e63 645b 695d 5b6a 5d0a 2020 2020 2020  .cd[i][j].      
-00026c90: 2020 2020 2020 2020 2020 0a20 2020 2069            .    i
-00026ca0: 6620 6861 7361 7474 7228 7763 732c 2027  f hasattr(wcs, '
-00026cb0: 7369 7027 293a 0a20 2020 2020 2020 2069  sip'):.        i
-00026cc0: 6620 6861 7361 7474 7228 7763 732e 7369  f hasattr(wcs.si
-00026cd0: 702c 2027 6372 7069 7827 293a 0a20 2020  p, 'crpix'):.   
-00026ce0: 2020 2020 2020 2020 2068 6561 6465 725b           header[
-00026cf0: 2753 4950 4352 5058 3127 5d2c 2068 6561  'SIPCRPX1'], hea
-00026d00: 6465 725b 2753 4950 4352 5058 3227 5d20  der['SIPCRPX2'] 
-00026d10: 3d20 7763 732e 7369 702e 6372 7069 780a  = wcs.sip.crpix.
-00026d20: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00026d30: 2072 6574 7572 6e20 6865 6164 6572 0a0a   return header..
-00026d40: 0a64 6566 206d 616b 655f 7763 7368 6561  .def make_wcshea
-00026d50: 6465 7228 7261 3d34 302e 3037 3239 332c  der(ra=40.07293,
-00026d60: 2064 6563 3d2d 312e 3631 3337 3734 382c   dec=-1.6137748,
-00026d70: 2073 697a 653d 322c 2070 6978 7363 616c   size=2, pixscal
-00026d80: 653d 302e 312c 2067 6574 5f68 6475 3d46  e=0.1, get_hdu=F
-00026d90: 616c 7365 2c20 7468 6574 613d 3029 3a0a  alse, theta=0):.
-00026da0: 2020 2020 2222 224d 616b 6520 6120 6365      """Make a ce
-00026db0: 6c65 7374 6961 6c20 5743 5320 6865 6164  lestial WCS head
-00026dc0: 6572 0a0a 2020 2020 5061 7261 6d65 7465  er..    Paramete
-00026dd0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00026de0: 2d0a 2020 2020 7261 2c20 6465 6320 3a20  -.    ra, dec : 
-00026df0: 666c 6f61 740a 2020 2020 2020 2020 4365  float.        Ce
-00026e00: 6c65 7374 6961 6c20 636f 6f72 6469 6e61  lestial coordina
-00026e10: 7465 7320 696e 2064 6563 696d 616c 2064  tes in decimal d
-00026e20: 6567 7265 6573 0a0a 2020 2020 7369 7a65  egrees..    size
-00026e30: 2c20 7069 7873 6361 6c65 203a 2066 6c6f  , pixscale : flo
-00026e40: 6174 206f 7220 322d 6c69 7374 0a20 2020  at or 2-list.   
-00026e50: 2020 2020 2053 697a 6520 6f66 2074 6865       Size of the
-00026e60: 2074 6875 6d62 6e61 696c 2c20 696e 2061   thumbnail, in a
-00026e70: 7263 7365 632c 2061 6e64 2070 6978 656c  rcsec, and pixel
-00026e80: 2073 6361 6c65 2c20 696e 2061 7263 7365   scale, in arcse
-00026e90: 632f 7069 7865 6c2e 0a20 2020 2020 2020  c/pixel..       
-00026ea0: 204f 7574 7075 7420 696d 6167 6520 7769   Output image wi
-00026eb0: 6c6c 2068 6176 6520 6469 6d65 6e73 696f  ll have dimensio
-00026ec0: 6e73 2060 286e 7069 782c 6e70 6978 2960  ns `(npix,npix)`
-00026ed0: 2c20 7768 6572 650a 0a20 2020 2020 2020  , where..       
-00026ee0: 2020 2020 203e 3e3e 206e 7069 7820 3d20       >>> npix = 
-00026ef0: 7369 7a65 2f70 6978 7363 616c 650a 0a20  size/pixscale.. 
-00026f00: 2020 2067 6574 5f68 6475 203a 2062 6f6f     get_hdu : boo
-00026f10: 6c0a 2020 2020 2020 2020 5265 7475 726e  l.        Return
-00026f20: 2061 2060 7e61 7374 726f 7079 2e69 6f2e   a `~astropy.io.
-00026f30: 6669 7473 2e49 6d61 6765 4844 5560 2072  fits.ImageHDU` r
-00026f40: 6174 6865 7220 7468 616e 2068 6561 6465  ather than heade
-00026f50: 722f 7763 732e 0a0a 2020 2020 7468 6574  r/wcs...    thet
-00026f60: 6120 3a20 666c 6f61 740a 2020 2020 2020  a : float.      
-00026f70: 2020 506f 7369 7469 6f6e 2061 6e67 6c65    Position angle
-00026f80: 206f 6620 7468 6520 6f75 7470 7574 2074   of the output t
-00026f90: 6875 6d62 6e61 696c 2028 6465 6772 6565  humbnail (degree
-00026fa0: 7329 0a0a 2020 2020 5265 7475 726e 730a  s)..    Returns.
-00026fb0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00026fc0: 6864 7520 3a20 607e 6173 7472 6f70 792e  hdu : `~astropy.
-00026fd0: 696f 2e66 6974 732e 496d 6167 6548 4455  io.fits.ImageHDU
-00026fe0: 600a 2020 2020 2020 2020 4844 5520 7769  `.        HDU wi
-00026ff0: 7468 2064 6174 6120 6669 6c6c 6564 2077  th data filled w
-00027000: 6974 6820 7a65 726f 7320 6966 2060 6765  ith zeros if `ge
-00027010: 745f 6864 753d 5472 7565 602e 0a0a 2020  t_hdu=True`...  
-00027020: 2020 6865 6164 6572 2c20 7763 7320 3a20    header, wcs : 
-00027030: 607e 6173 7472 6f70 792e 696f 2e66 6974  `~astropy.io.fit
-00027040: 732e 4865 6164 6572 602c 2060 7e61 7374  s.Header`, `~ast
-00027050: 726f 7079 2e77 6373 2e57 4353 600a 2020  ropy.wcs.WCS`.  
-00027060: 2020 2020 2020 4865 6164 6572 2061 6e64        Header and
-00027070: 2057 4353 206f 626a 6563 7420 6966 2060   WCS object if `
-00027080: 6765 745f 6864 753d 4661 6c73 6560 2e0a  get_hdu=False`..
-00027090: 0a20 2020 2045 7861 6d70 6c65 730a 2020  .    Examples.  
-000270a0: 2020 2d2d 2d2d 2d2d 2d2d 0a0a 2020 2020    --------..    
-000270b0: 2020 2020 3e3e 3e20 6672 6f6d 2067 7269      >>> from gri
-000270c0: 7a6c 692e 7574 696c 7320 696d 706f 7274  zli.utils import
-000270d0: 206d 616b 655f 7763 7368 6561 6465 720a   make_wcsheader.
-000270e0: 2020 2020 2020 2020 3e3e 3e20 682c 2077          >>> h, w
-000270f0: 6373 203d 206d 616b 655f 7763 7368 6561  cs = make_wcshea
-00027100: 6465 7228 290a 2020 2020 2020 2020 3e3e  der().        >>
-00027110: 3e20 7072 696e 7428 7763 7329 0a20 2020  > print(wcs).   
-00027120: 2020 2020 2057 4353 204b 6579 776f 7264       WCS Keyword
-00027130: 730a 2020 2020 2020 2020 4e75 6d62 6572  s.        Number
-00027140: 206f 6620 5743 5320 6178 6573 3a20 320a   of WCS axes: 2.
-00027150: 2020 2020 2020 2020 4354 5950 4520 3a20          CTYPE : 
-00027160: 2752 412d 2d2d 5441 4e27 2020 2744 4543  'RA---TAN'  'DEC
-00027170: 2d2d 5441 4e27 0a20 2020 2020 2020 2043  --TAN'.        C
-00027180: 5256 414c 203a 2034 302e 3037 3239 3239  RVAL : 40.072929
-00027190: 3939 3939 3939 3939 3920 202d 312e 3631  999999999  -1.61
-000271a0: 3337 3734 3830 3030 3030 3030 3031 0a20  37748000000001. 
-000271b0: 2020 2020 2020 2043 5250 4958 203a 2031         CRPIX : 1
-000271c0: 302e 3020 2031 302e 300a 2020 2020 2020  0.0  10.0.      
-000271d0: 2020 4344 315f 3120 4344 315f 3220 203a    CD1_1 CD1_2  :
-000271e0: 202d 322e 3737 3737 3737 3737 3737 3737   -2.777777777777
-000271f0: 3765 2d30 3520 2030 2e30 0a20 2020 2020  7e-05  0.0.     
-00027200: 2020 2043 4432 5f31 2043 4432 5f32 2020     CD2_1 CD2_2  
-00027210: 3a20 302e 3020 2032 2e37 3737 3737 3737  : 0.0  2.7777777
-00027220: 3737 3737 3737 3730 3165 2d30 350a 2020  777777701e-05.  
-00027230: 2020 2020 2020 4e41 5849 5320 2020 203a        NAXIS    :
-00027240: 2032 3020 3230 0a0a 2020 2020 2020 2020   20 20..        
-00027250: 3e3e 3e20 6672 6f6d 2067 7269 7a6c 692e  >>> from grizli.
-00027260: 7574 696c 7320 696d 706f 7274 206d 616b  utils import mak
-00027270: 655f 7763 7368 6561 6465 720a 2020 2020  e_wcsheader.    
-00027280: 2020 2020 3e3e 3e20 6864 7520 3d20 6d61      >>> hdu = ma
-00027290: 6b65 5f77 6373 6865 6164 6572 2867 6574  ke_wcsheader(get
-000272a0: 5f68 6475 3d54 7275 6529 0a20 2020 2020  _hdu=True).     
-000272b0: 2020 203e 3e3e 2070 7269 6e74 2868 6475     >>> print(hdu
-000272c0: 2e64 6174 612e 7368 6170 6529 0a20 2020  .data.shape).   
-000272d0: 2020 2020 2028 3230 2c20 3230 290a 2020       (20, 20).  
-000272e0: 2020 2020 2020 3e3e 3e20 7072 696e 7428        >>> print(
-000272f0: 6864 752e 6865 6164 6572 2e74 6f73 7472  hdu.header.tostr
-00027300: 696e 6729 0a20 2020 2020 2020 2058 5445  ing).        XTE
-00027310: 4e53 494f 4e3d 2027 494d 4147 4520 2020  NSION= 'IMAGE   
-00027320: 2720 2020 2020 2020 2020 2020 2f20 496d  '           / Im
-00027330: 6167 6520 6578 7465 6e73 696f 6e0a 2020  age extension.  
-00027340: 2020 2020 2020 4249 5450 4958 2020 3d20        BITPIX  = 
-00027350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027360: 202d 3332 202f 2061 7272 6179 2064 6174   -32 / array dat
-00027370: 6120 7479 7065 0a20 2020 2020 2020 204e  a type.        N
-00027380: 4158 4953 2020 203d 2020 2020 2020 2020  AXIS   =        
-00027390: 2020 2020 2020 2020 2020 2020 3220 2f20              2 / 
-000273a0: 6e75 6d62 6572 206f 6620 6172 7261 7920  number of array 
-000273b0: 6469 6d65 6e73 696f 6e73 0a20 2020 2020  dimensions.     
-000273c0: 2020 2050 434f 554e 5420 203d 2020 2020     PCOUNT  =    
-000273d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000273e0: 3020 2f20 6e75 6d62 6572 206f 6620 7061  0 / number of pa
-000273f0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-00027400: 2047 434f 554e 5420 203d 2020 2020 2020   GCOUNT  =      
-00027410: 2020 2020 2020 2020 2020 2020 2020 3120                1 
-00027420: 2f20 6e75 6d62 6572 206f 6620 6772 6f75  / number of grou
-00027430: 7073 0a20 2020 2020 2020 2043 5250 4958  ps.        CRPIX
-00027440: 3120 203d 2020 2020 2020 2020 2020 2020  1  =            
-00027450: 2020 2020 2020 2031 300a 2020 2020 2020         10.      
-00027460: 2020 4352 5049 5832 2020 3d20 2020 2020    CRPIX2  =     
-00027470: 2020 2020 2020 2020 2020 2020 2020 3130                10
-00027480: 0a20 2020 2020 2020 2043 5256 414c 3120  .        CRVAL1 
-00027490: 203d 2020 2020 2020 2020 2020 2020 2034   =             4
-000274a0: 302e 3037 3239 330a 2020 2020 2020 2020  0.07293.        
-000274b0: 4352 5641 4c32 2020 3d20 2020 2020 2020  CRVAL2  =       
-000274c0: 2020 2020 2d31 2e36 3133 3737 3438 0a20      -1.6137748. 
-000274d0: 2020 2020 2020 2043 4431 5f31 2020 203d         CD1_1   =
-000274e0: 202d 322e 3737 3737 3737 3737 3737 3737   -2.777777777777
-000274f0: 3745 2d30 350a 2020 2020 2020 2020 4344  7E-05.        CD
-00027500: 315f 3220 2020 3d20 2020 2020 2020 2020  1_2   =         
-00027510: 2020 2020 2020 2020 2030 2e30 0a20 2020           0.0.   
-00027520: 2020 2020 2043 4432 5f31 2020 203d 2020       CD2_1   =  
-00027530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027540: 302e 300a 2020 2020 2020 2020 4344 325f  0.0.        CD2_
-00027550: 3220 2020 3d20 322e 3737 3737 3737 3737  2   = 2.77777777
-00027560: 3737 3737 3737 452d 3035 0a20 2020 2020  777777E-05.     
-00027570: 2020 204e 4158 4953 3120 203d 2020 2020     NAXIS1  =    
-00027580: 2020 2020 2020 2020 2020 2020 2020 2032                 2
-00027590: 300a 2020 2020 2020 2020 4e41 5849 5332  0.        NAXIS2
+0001f5c0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+0001f5d0: 5746 4341 4d5f 4a27 2c20 5b27 4a6d 6167  WFCAM_J', ['Jmag
+0001f5e0: 3227 2c20 2765 5f4a 6d61 6732 275d 292c  2', 'e_Jmag2']),
+0001f5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f600: 2020 2020 2020 2020 2020 2020 2028 2757               ('W
+0001f610: 4643 414d 5f48 272c 205b 2748 6d61 6727  FCAM_H', ['Hmag'
+0001f620: 2c20 2765 5f48 6d61 6727 5d29 2c0a 2020  , 'e_Hmag']),.  
+0001f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f640: 2020 2020 2020 2020 2020 2827 5746 4341            ('WFCA
+0001f650: 4d5f 4b27 2c20 5b27 4b6d 6167 272c 2027  M_K', ['Kmag', '
+0001f660: 655f 4b6d 6167 275d 295d 290a 0a55 4b49  e_Kmag'])])..UKI
+0001f670: 4453 535f 4458 535f 5649 5a49 4552 203d  DSS_DXS_VIZIER =
+0001f680: 2027 4949 2f33 3139 2f64 7873 3927 0a55   'II/319/dxs9'.U
+0001f690: 4b49 4453 535f 4458 535f 4241 4e44 5320  KIDSS_DXS_BANDS 
+0001f6a0: 3d20 4f72 6465 7265 6444 6963 7428 5b28  = OrderedDict([(
+0001f6b0: 2757 4643 414d 5f4a 272c 205b 274a 6d61  'WFCAM_J', ['Jma
+0001f6c0: 6727 2c20 2765 5f4a 6d61 6727 5d29 2c0a  g', 'e_Jmag']),.
+0001f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f6e0: 2020 2020 2020 2020 2020 2020 2827 5746              ('WF
+0001f6f0: 4341 4d5f 4b27 2c20 5b27 4b6d 6167 272c  CAM_K', ['Kmag',
+0001f700: 2027 655f 4b6d 6167 275d 295d 290a 0a23   'e_Kmag'])])..#
+0001f710: 2047 414c 4558 0a47 414c 4558 5f4d 4953   GALEX.GALEX_MIS
+0001f720: 5f56 495a 4945 5220 3d20 2749 492f 3331  _VIZIER = 'II/31
+0001f730: 322f 6d69 7327 0a47 414c 4558 5f4d 4953  2/mis'.GALEX_MIS
+0001f740: 5f42 414e 4453 203d 204f 7264 6572 6564  _BANDS = Ordered
+0001f750: 4469 6374 285b 2827 4655 5627 2c20 5b27  Dict([('FUV', ['
+0001f760: 4655 5627 2c20 2765 5f46 5556 275d 292c  FUV', 'e_FUV']),
+0001f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f780: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0001f790: 274e 5556 272c 205b 274e 5556 272c 2027  'NUV', ['NUV', '
+0001f7a0: 655f 4e55 5627 5d29 5d29 0a0a 4741 4c45  e_NUV'])])..GALE
+0001f7b0: 585f 4149 535f 5649 5a49 4552 203d 2027  X_AIS_VIZIER = '
+0001f7c0: 4949 2f33 3132 2f61 6973 270a 4741 4c45  II/312/ais'.GALE
+0001f7d0: 585f 4149 535f 4241 4e44 5320 3d20 4f72  X_AIS_BANDS = Or
+0001f7e0: 6465 7265 6444 6963 7428 5b28 2746 5556  deredDict([('FUV
+0001f7f0: 272c 205b 2746 5556 272c 2027 655f 4655  ', ['FUV', 'e_FU
+0001f800: 5627 5d29 2c0a 2020 2020 2020 2020 2020  V']),.          
+0001f810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f820: 2020 2020 2827 4e55 5627 2c20 5b27 4e55      ('NUV', ['NU
+0001f830: 5627 2c20 2765 5f4e 5556 275d 295d 290a  V', 'e_NUV'])]).
+0001f840: 0a23 2043 6f6d 6269 6e65 6420 4469 6374  .# Combined Dict
+0001f850: 0a56 495a 4945 525f 4241 4e44 5320 3d20  .VIZIER_BANDS = 
+0001f860: 4f72 6465 7265 6444 6963 7428 290a 5649  OrderedDict().VI
+0001f870: 5a49 4552 5f42 414e 4453 5b43 4648 544c  ZIER_BANDS[CFHTL
+0001f880: 535f 575f 5649 5a49 4552 5d20 3d20 4346  S_W_VIZIER] = CF
+0001f890: 4854 4c53 5f57 5f42 414e 4453 0a56 495a  HTLS_W_BANDS.VIZ
+0001f8a0: 4945 525f 4241 4e44 535b 4346 4854 4c53  IER_BANDS[CFHTLS
+0001f8b0: 5f44 5f56 495a 4945 525d 203d 2043 4648  _D_VIZIER] = CFH
+0001f8c0: 544c 535f 445f 4241 4e44 530a 5649 5a49  TLS_D_BANDS.VIZI
+0001f8d0: 4552 5f42 414e 4453 5b53 4453 535f 4452  ER_BANDS[SDSS_DR
+0001f8e0: 3132 5f56 495a 4945 525d 203d 2053 4453  12_VIZIER] = SDS
+0001f8f0: 535f 4452 3132 5f42 414e 4453 0a56 495a  S_DR12_BANDS.VIZ
+0001f900: 4945 525f 4241 4e44 535b 5053 315f 5649  IER_BANDS[PS1_VI
+0001f910: 5a49 4552 5d20 3d20 5053 315f 4241 4e44  ZIER] = PS1_BAND
+0001f920: 530a 5649 5a49 4552 5f42 414e 4453 5b4b  S.VIZIER_BANDS[K
+0001f930: 4944 535f 4452 335f 5649 5a49 4552 5d20  IDS_DR3_VIZIER] 
+0001f940: 3d20 4b49 4453 5f44 5233 5f42 414e 4453  = KIDS_DR3_BANDS
+0001f950: 0a56 495a 4945 525f 4241 4e44 535b 5749  .VIZIER_BANDS[WI
+0001f960: 5345 5f56 495a 4945 525d 203d 2057 4953  SE_VIZIER] = WIS
+0001f970: 455f 4241 4e44 530a 5649 5a49 4552 5f42  E_BANDS.VIZIER_B
+0001f980: 414e 4453 5b56 494b 494e 475f 5649 5a49  ANDS[VIKING_VIZI
+0001f990: 4552 5d20 3d20 5649 4b49 4e47 5f42 414e  ER] = VIKING_BAN
+0001f9a0: 4453 0a56 495a 4945 525f 4241 4e44 535b  DS.VIZIER_BANDS[
+0001f9b0: 554b 4944 5353 5f4c 4153 5f56 495a 4945  UKIDSS_LAS_VIZIE
+0001f9c0: 525d 203d 2055 4b49 4453 535f 4c41 535f  R] = UKIDSS_LAS_
+0001f9d0: 4241 4e44 530a 5649 5a49 4552 5f42 414e  BANDS.VIZIER_BAN
+0001f9e0: 4453 5b55 4b49 4453 535f 4458 535f 5649  DS[UKIDSS_DXS_VI
+0001f9f0: 5a49 4552 5d20 3d20 554b 4944 5353 5f44  ZIER] = UKIDSS_D
+0001fa00: 5853 5f42 414e 4453 0a56 495a 4945 525f  XS_BANDS.VIZIER_
+0001fa10: 4241 4e44 535b 4741 4c45 585f 4d49 535f  BANDS[GALEX_MIS_
+0001fa20: 5649 5a49 4552 5d20 3d20 4741 4c45 585f  VIZIER] = GALEX_
+0001fa30: 4d49 535f 4241 4e44 530a 5649 5a49 4552  MIS_BANDS.VIZIER
+0001fa40: 5f42 414e 4453 5b47 414c 4558 5f41 4953  _BANDS[GALEX_AIS
+0001fa50: 5f56 495a 4945 525d 203d 2047 414c 4558  _VIZIER] = GALEX
+0001fa60: 5f41 4953 5f42 414e 4453 0a0a 5649 5a49  _AIS_BANDS..VIZI
+0001fa70: 4552 5f56 4547 4120 3d20 4f72 6465 7265  ER_VEGA = Ordere
+0001fa80: 6444 6963 7428 290a 5649 5a49 4552 5f56  dDict().VIZIER_V
+0001fa90: 4547 415b 4346 4854 4c53 5f57 5f56 495a  EGA[CFHTLS_W_VIZ
+0001faa0: 4945 525d 203d 2046 616c 7365 0a56 495a  IER] = False.VIZ
+0001fab0: 4945 525f 5645 4741 5b43 4648 544c 535f  IER_VEGA[CFHTLS_
+0001fac0: 445f 5649 5a49 4552 5d20 3d20 4661 6c73  D_VIZIER] = Fals
+0001fad0: 650a 5649 5a49 4552 5f56 4547 415b 5344  e.VIZIER_VEGA[SD
+0001fae0: 5353 5f44 5231 325f 5649 5a49 4552 5d20  SS_DR12_VIZIER] 
+0001faf0: 3d20 4661 6c73 650a 5649 5a49 4552 5f56  = False.VIZIER_V
+0001fb00: 4547 415b 5053 315f 5649 5a49 4552 5d20  EGA[PS1_VIZIER] 
+0001fb10: 3d20 4661 6c73 650a 5649 5a49 4552 5f56  = False.VIZIER_V
+0001fb20: 4547 415b 4b49 4453 5f44 5233 5f56 495a  EGA[KIDS_DR3_VIZ
+0001fb30: 4945 525d 203d 2046 616c 7365 0a56 495a  IER] = False.VIZ
+0001fb40: 4945 525f 5645 4741 5b57 4953 455f 5649  IER_VEGA[WISE_VI
+0001fb50: 5a49 4552 5d20 3d20 5472 7565 0a56 495a  ZIER] = True.VIZ
+0001fb60: 4945 525f 5645 4741 5b56 494b 494e 475f  IER_VEGA[VIKING_
+0001fb70: 5649 5a49 4552 5d20 3d20 5472 7565 0a56  VIZIER] = True.V
+0001fb80: 495a 4945 525f 5645 4741 5b55 4b49 4453  IZIER_VEGA[UKIDS
+0001fb90: 535f 4c41 535f 5649 5a49 4552 5d20 3d20  S_LAS_VIZIER] = 
+0001fba0: 5472 7565 0a56 495a 4945 525f 5645 4741  True.VIZIER_VEGA
+0001fbb0: 5b55 4b49 4453 535f 4458 535f 5649 5a49  [UKIDSS_DXS_VIZI
+0001fbc0: 4552 5d20 3d20 5472 7565 0a56 495a 4945  ER] = True.VIZIE
+0001fbd0: 525f 5645 4741 5b47 414c 4558 5f4d 4953  R_VEGA[GALEX_MIS
+0001fbe0: 5f56 495a 4945 525d 203d 2046 616c 7365  _VIZIER] = False
+0001fbf0: 0a56 495a 4945 525f 5645 4741 5b47 414c  .VIZIER_VEGA[GAL
+0001fc00: 4558 5f41 4953 5f56 495a 4945 525d 203d  EX_AIS_VIZIER] =
+0001fc10: 2046 616c 7365 0a0a 0a64 6566 2067 6574   False...def get
+0001fc20: 5f56 697a 6965 725f 7068 6f74 6f6d 6574  _Vizier_photomet
+0001fc30: 7279 2872 612c 2064 6563 2c20 7465 6d70  ry(ra, dec, temp
+0001fc40: 6c61 7465 733d 4e6f 6e65 2c20 7261 6469  lates=None, radi
+0001fc50: 7573 3d32 2c20 7669 7a69 6572 5f63 6174  us=2, vizier_cat
+0001fc60: 616c 6f67 3d50 5331 5f56 495a 4945 522c  alog=PS1_VIZIER,
+0001fc70: 2062 616e 6473 3d50 5331 5f42 414e 4453   bands=PS1_BANDS
+0001fc80: 2c20 6669 6c74 6572 5f66 696c 653d 272f  , filter_file='/
+0001fc90: 7573 722f 6c6f 6361 6c2f 7368 6172 652f  usr/local/share/
+0001fca0: 6561 7a79 2d70 686f 746f 7a2f 6669 6c74  eazy-photoz/filt
+0001fcb0: 6572 732f 4649 4c54 4552 2e52 4553 2e6c  ers/FILTER.RES.l
+0001fcc0: 6174 6573 7427 2c20 4d57 5f45 4256 3d30  atest', MW_EBV=0
+0001fcd0: 2c20 636f 6e76 6572 745f 7665 6761 3d46  , convert_vega=F
+0001fce0: 616c 7365 2c20 7261 775f 7175 6572 793d  alse, raw_query=
+0001fcf0: 4661 6c73 652c 2076 6572 626f 7365 3d54  False, verbose=T
+0001fd00: 7275 652c 2074 696d 656f 7574 3d33 3030  rue, timeout=300
+0001fd10: 2c20 726f 776c 696d 6974 3d35 3030 3030  , rowlimit=50000
+0001fd20: 293a 0a20 2020 2022 2222 0a20 2020 2046  ):.    """.    F
+0001fd30: 6574 6368 2070 686f 746f 6d65 7472 7920  etch photometry 
+0001fd40: 6672 6f6d 2061 2056 697a 6965 7220 6361  from a Vizier ca
+0001fd50: 7461 6c6f 670a 0a20 2020 2052 6571 7569  talog..    Requi
+0001fd60: 7265 7320 6561 7a79 7079 2f65 617a 790a  res eazypy/eazy.
+0001fd70: 2020 2020 2222 220a 0a20 2020 2066 726f      """..    fro
+0001fd80: 6d20 636f 6c6c 6563 7469 6f6e 7320 696d  m collections im
+0001fd90: 706f 7274 204f 7264 6572 6564 4469 6374  port OrderedDict
+0001fda0: 0a0a 2020 2020 696d 706f 7274 2061 7374  ..    import ast
+0001fdb0: 726f 7079 2e75 6e69 7473 2061 7320 750a  ropy.units as u.
+0001fdc0: 2020 2020 6672 6f6d 2061 7374 726f 7175      from astroqu
+0001fdd0: 6572 792e 7669 7a69 6572 2069 6d70 6f72  ery.vizier impor
+0001fde0: 7420 5669 7a69 6572 0a20 2020 2056 697a  t Vizier.    Viz
+0001fdf0: 6965 722e 524f 575f 4c49 4d49 5420 3d20  ier.ROW_LIMIT = 
+0001fe00: 726f 776c 696d 6974 0a20 2020 2056 697a  rowlimit.    Viz
+0001fe10: 6965 722e 5449 4d45 4f55 5420 3d20 7469  ier.TIMEOUT = ti
+0001fe20: 6d65 6f75 740a 0a20 2020 2023 7072 696e  meout..    #prin
+0001fe30: 7428 2778 7878 272c 2056 697a 6965 722e  t('xxx', Vizier.
+0001fe40: 524f 575f 4c49 4d49 542c 2056 697a 6965  ROW_LIMIT, Vizie
+0001fe50: 722e 5449 4d45 4f55 5429 0a0a 2020 2020  r.TIMEOUT)..    
+0001fe60: 696d 706f 7274 2061 7374 726f 7079 2e63  import astropy.c
+0001fe70: 6f6f 7264 696e 6174 6573 2061 7320 636f  oordinates as co
+0001fe80: 6f72 640a 2020 2020 696d 706f 7274 2061  ord.    import a
+0001fe90: 7374 726f 7079 2e75 6e69 7473 2061 7320  stropy.units as 
+0001fea0: 750a 0a20 2020 2023 696d 706f 7274 2070  u..    #import p
+0001feb0: 7973 796e 7068 6f74 2061 7320 530a 0a20  ysynphot as S.. 
+0001fec0: 2020 2066 726f 6d20 6561 7a79 2e74 656d     from eazy.tem
+0001fed0: 706c 6174 6573 2069 6d70 6f72 7420 5465  plates import Te
+0001fee0: 6d70 6c61 7465 0a20 2020 2066 726f 6d20  mplate.    from 
+0001fef0: 6561 7a79 2e66 696c 7465 7273 2069 6d70  eazy.filters imp
+0001ff00: 6f72 7420 4669 6c74 6572 4669 6c65 0a20  ort FilterFile. 
+0001ff10: 2020 2066 726f 6d20 6561 7a79 2e70 686f     from eazy.pho
+0001ff20: 746f 7a20 696d 706f 7274 2054 656d 706c  toz import Templ
+0001ff30: 6174 6547 7269 640a 2020 2020 6672 6f6d  ateGrid.    from
+0001ff40: 2065 617a 792e 6669 6c74 6572 7320 696d   eazy.filters im
+0001ff50: 706f 7274 2046 696c 7465 7244 6566 696e  port FilterDefin
+0001ff60: 6974 696f 6e0a 0a20 2020 2072 6573 203d  ition..    res =
+0001ff70: 2046 696c 7465 7246 696c 6528 6669 6c74   FilterFile(filt
+0001ff80: 6572 5f66 696c 6529 0a0a 2020 2020 636f  er_file)..    co
+0001ff90: 6f20 3d20 636f 6f72 642e 536b 7943 6f6f  o = coord.SkyCoo
+0001ffa0: 7264 2872 613d 7261 2c20 6465 633d 6465  rd(ra=ra, dec=de
+0001ffb0: 632c 2075 6e69 743d 2875 2e64 6567 2c20  c, unit=(u.deg, 
+0001ffc0: 752e 6465 6729 2c0a 2020 2020 2020 2020  u.deg),.        
+0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ffe0: 2066 7261 6d65 3d27 6963 7273 2729 0a0a   frame='icrs')..
+0001fff0: 2020 2020 636f 6c75 6d6e 7320 3d20 5b27      columns = ['
+00020000: 2a27 5d0a 2020 2020 2363 6f6c 756d 6e73  *'].    #columns
+00020010: 203d 205b 5d0a 2020 2020 6966 2069 7369   = [].    if isi
+00020020: 6e73 7461 6e63 6528 7669 7a69 6572 5f63  nstance(vizier_c
+00020030: 6174 616c 6f67 2c20 6c69 7374 293a 0a20  atalog, list):. 
+00020040: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
+00020050: 5b56 494b 494e 475f 5649 5a49 4552 5d3a  [VIKING_VIZIER]:
+00020060: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00020070: 2062 2069 6e20 5649 5a49 4552 5f42 414e   b in VIZIER_BAN
+00020080: 4453 5b63 5d3a 0a20 2020 2020 2020 2020  DS[c]:.         
+00020090: 2020 2020 2020 2063 6f6c 756d 6e73 202b         columns +
+000200a0: 3d20 5649 5a49 4552 5f42 414e 4453 5b63  = VIZIER_BANDS[c
+000200b0: 5d5b 625d 0a0a 2020 2020 2020 2020 636f  ][b]..        co
+000200c0: 6c75 6d6e 7320 3d20 6c69 7374 286e 702e  lumns = list(np.
+000200d0: 756e 6971 7565 2863 6f6c 756d 6e73 2929  unique(columns))
+000200e0: 0a20 2020 2020 2020 2023 7072 696e 7428  .        #print(
+000200f0: 2278 7878 2063 6f6c 756d 6e73 222c 2063  "xxx columns", c
+00020100: 6f6c 756d 6e73 290a 2020 2020 656c 7365  olumns).    else
+00020110: 3a0a 2020 2020 2020 2020 666f 7220 6220  :.        for b 
+00020120: 696e 2062 616e 6473 3a0a 2020 2020 2020  in bands:.      
+00020130: 2020 2020 2020 636f 6c75 6d6e 7320 2b3d        columns +=
+00020140: 2062 616e 6473 5b62 5d0a 0a20 2020 2069   bands[b]..    i
+00020150: 6620 6973 696e 7374 616e 6365 2876 697a  f isinstance(viz
+00020160: 6965 725f 6361 7461 6c6f 672c 206c 6973  ier_catalog, lis
+00020170: 7429 3a0a 2020 2020 2020 2020 7620 3d20  t):.        v = 
+00020180: 5669 7a69 6572 2863 6174 616c 6f67 3d56  Vizier(catalog=V
+00020190: 494b 494e 475f 5649 5a49 4552 2c20 636f  IKING_VIZIER, co
+000201a0: 6c75 6d6e 733d 5b27 2b5f 7227 5d2b 636f  lumns=['+_r']+co
+000201b0: 6c75 6d6e 7329 0a20 2020 2065 6c73 653a  lumns).    else:
+000201c0: 0a20 2020 2020 2020 2076 203d 2056 697a  .        v = Viz
+000201d0: 6965 7228 6361 7461 6c6f 673d 7669 7a69  ier(catalog=vizi
+000201e0: 6572 5f63 6174 616c 6f67 2c20 636f 6c75  er_catalog, colu
+000201f0: 6d6e 733d 5b27 2b5f 7227 5d2b 636f 6c75  mns=['+_r']+colu
+00020200: 6d6e 7329 0a0a 2020 2020 762e 524f 575f  mns)..    v.ROW_
+00020210: 4c49 4d49 5420 3d20 726f 776c 696d 6974  LIMIT = rowlimit
+00020220: 0a20 2020 2076 2e54 494d 454f 5554 203d  .    v.TIMEOUT =
+00020230: 2074 696d 656f 7574 0a0a 2020 2020 2371   timeout..    #q
+00020240: 7565 7279 5f63 6174 616c 6f67 203d 2076  uery_catalog = v
+00020250: 697a 6965 725f 6361 7461 6c6f 670a 2020  izier_catalog.  
+00020260: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
+00020270: 6162 7320 3d20 762e 7175 6572 795f 7265  abs = v.query_re
+00020280: 6769 6f6e 2863 6f6f 2c20 7261 6469 7573  gion(coo, radius
+00020290: 3d22 7b30 7d73 222e 666f 726d 6174 2872  ="{0}s".format(r
+000202a0: 6164 6975 7329 2c0a 2020 2020 2020 2020  adius),.        
+000202b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202c0: 2020 6361 7461 6c6f 673d 7669 7a69 6572    catalog=vizier
+000202d0: 5f63 6174 616c 6f67 2920 2023 205b 305d  _catalog)  # [0]
+000202e0: 0a0a 2020 2020 2020 2020 6966 2072 6177  ..        if raw
+000202f0: 5f71 7565 7279 3a0a 2020 2020 2020 2020  _query:.        
+00020300: 2020 2020 7265 7475 726e 2874 6162 7329      return(tabs)
+00020310: 0a0a 2020 2020 2020 2020 7461 6220 3d20  ..        tab = 
+00020320: 7461 6273 5b30 5d0a 0a20 2020 2020 2020  tabs[0]..       
+00020330: 2069 6620 4661 6c73 653a 0a20 2020 2020   if False:.     
+00020340: 2020 2020 2020 2066 6f72 2074 2069 6e20         for t in 
+00020350: 7461 6273 3a0a 2020 2020 2020 2020 2020  tabs:.          
+00020360: 2020 2020 2020 6261 6e64 7320 3d20 5649        bands = VI
+00020370: 5a49 4552 5f42 414e 4453 5b74 2e6d 6574  ZIER_BANDS[t.met
+00020380: 615b 276e 616d 6527 5d5d 0a20 2020 2020  a['name']].     
+00020390: 2020 2020 2020 2020 2020 2066 6f72 2062             for b
+000203a0: 2069 6e20 6261 6e64 733a 0a20 2020 2020   in bands:.     
+000203b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000203c0: 6f72 2063 2069 6e20 6261 6e64 735b 625d  or c in bands[b]
+000203d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000203e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000203f0: 742e 6d65 7461 5b27 6e61 6d65 275d 2c20  t.meta['name'], 
+00020400: 632c 2063 2069 6e20 742e 636f 6c6e 616d  c, c in t.colnam
+00020410: 6573 2920 2023 2063 203d 2062 616e 6473  es)  # c = bands
+00020420: 5b62 5d5b 305d 0a0a 2020 2020 2020 2020  [b][0]..        
+00020430: 6978 203d 206e 702e 6172 676d 696e 2874  ix = np.argmin(t
+00020440: 6162 5b27 5f72 275d 290a 2020 2020 2020  ab['_r']).      
+00020450: 2020 7461 6220 3d20 7461 625b 6978 5d0a    tab = tab[ix].
+00020460: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00020470: 2020 2020 7461 6220 3d20 4e6f 6e65 0a0a      tab = None..
+00020480: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00020490: 6f6e 650a 0a20 2020 2076 697a 5f74 6162  one..    viz_tab
+000204a0: 6c65 7320 3d20 272c 2027 2e6a 6f69 6e28  les = ', '.join(
+000204b0: 5b74 2e6d 6574 615b 276e 616d 6527 5d20  [t.meta['name'] 
+000204c0: 666f 7220 7420 696e 2074 6162 735d 290a  for t in tabs]).
+000204d0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+000204e0: 2020 2020 2020 2020 7072 696e 7428 2750          print('P
+000204f0: 686f 746f 6d65 7472 7920 6672 6f6d 2076  hotometry from v
+00020500: 697a 6965 7220 6361 7461 6c6f 6773 3a20  izier catalogs: 
+00020510: 7b30 7d27 2e66 6f72 6d61 7428 7669 7a5f  {0}'.format(viz_
+00020520: 7461 626c 6573 2929 0a0a 2020 2020 7069  tables))..    pi
+00020530: 766f 7420 3d20 5b5d 2020 2320 4f72 6465  vot = []  # Orde
+00020540: 7265 6444 6963 7428 290a 2020 2020 666c  redDict().    fl
+00020550: 616d 203d 205b 5d0a 2020 2020 6566 6c61  am = [].    efla
+00020560: 6d20 3d20 5b5d 0a20 2020 2066 696c 7465  m = [].    filte
+00020570: 7273 203d 205b 5d0a 0a20 2020 2066 6f72  rs = []..    for
+00020580: 2074 6162 2069 6e20 7461 6273 3a0a 0a20   tab in tabs:.. 
+00020590: 2020 2020 2020 2023 2044 6f77 6e77 6569         # Downwei
+000205a0: 6768 7420 5053 3120 6966 2068 6176 6520  ght PS1 if have 
+000205b0: 5344 5353 203f 2020 466f 7220 6e6f 772c  SDSS ?  For now,
+000205c0: 2064 6f20 6e6f 7468 696e 670a 2020 2020   do nothing.    
+000205d0: 2020 2020 6966 2028 7461 622e 6d65 7461      if (tab.meta
+000205e0: 5b27 6e61 6d65 275d 203d 3d20 5053 315f  ['name'] == PS1_
+000205f0: 5649 5a49 4552 2920 2620 2853 4453 535f  VIZIER) & (SDSS_
+00020600: 4452 3132 5f56 495a 4945 5220 696e 2076  DR12_VIZIER in v
+00020610: 697a 5f74 6162 6c65 7329 3a0a 2020 2020  iz_tables):.    
+00020620: 2020 2020 2020 2020 2320 636f 6e74 696e          # contin
+00020630: 7565 0a20 2020 2020 2020 2020 2020 2065  ue.            e
+00020640: 7272 5f73 6361 6c65 203d 2031 0a20 2020  rr_scale = 1.   
+00020650: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00020660: 2020 2020 2020 2065 7272 5f73 6361 6c65         err_scale
+00020670: 203d 2031 0a0a 2020 2020 2020 2020 2320   = 1..        # 
+00020680: 4f6e 6c79 2075 7365 206f 6e65 2043 4648  Only use one CFH
+00020690: 5420 6361 7461 6c6f 670a 2020 2020 2020  T catalog.      
+000206a0: 2020 6966 2028 7461 622e 6d65 7461 5b27    if (tab.meta['
+000206b0: 6e61 6d65 275d 203d 3d20 4346 4854 4c53  name'] == CFHTLS
+000206c0: 5f57 5f56 495a 4945 5229 2026 2028 4346  _W_VIZIER) & (CF
+000206d0: 4854 4c53 5f44 5f56 495a 4945 5220 696e  HTLS_D_VIZIER in
+000206e0: 2076 697a 5f74 6162 6c65 7329 3a0a 2020   viz_tables):.  
+000206f0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00020700: 7565 0a0a 2020 2020 2020 2020 6966 2028  ue..        if (
+00020710: 7461 622e 6d65 7461 5b27 6e61 6d65 275d  tab.meta['name']
+00020720: 203d 3d20 554b 4944 5353 5f4c 4153 5f56   == UKIDSS_LAS_V
+00020730: 495a 4945 5229 3a0a 2020 2020 2020 2020  IZIER):.        
+00020740: 2020 2020 666c 7578 5f73 6361 6c65 203d      flux_scale =
+00020750: 2031 2e33 330a 2020 2020 2020 2020 656c   1.33.        el
+00020760: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00020770: 666c 7578 5f73 6361 6c65 203d 2031 2e0a  flux_scale = 1..
+00020780: 0a20 2020 2020 2020 2063 6f6e 7665 7274  .        convert
+00020790: 5f76 6567 6120 3d20 5649 5a49 4552 5f56  _vega = VIZIER_V
+000207a0: 4547 415b 7461 622e 6d65 7461 5b27 6e61  EGA[tab.meta['na
+000207b0: 6d65 275d 5d0a 2020 2020 2020 2020 6261  me']].        ba
+000207c0: 6e64 7320 3d20 5649 5a49 4552 5f42 414e  nds = VIZIER_BAN
+000207d0: 4453 5b74 6162 2e6d 6574 615b 276e 616d  DS[tab.meta['nam
+000207e0: 6527 5d5d 0a0a 2020 2020 2020 2020 2320  e']]..        # 
+000207f0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+00020800: 2020 2020 2320 2020 2070 7269 6e74 2874      #    print(t
+00020810: 6162 2e63 6f6c 6e61 6d65 7329 0a0a 2020  ab.colnames)..  
+00020820: 2020 2020 2020 2366 696c 7465 7273 202b        #filters +
+00020830: 3d20 5b72 6573 2e66 696c 7465 7273 5b72  = [res.filters[r
+00020840: 6573 2e73 6561 7263 6828 622c 2076 6572  es.search(b, ver
+00020850: 626f 7365 3d46 616c 7365 295b 305d 5d20  bose=False)[0]] 
+00020860: 666f 7220 6220 696e 2062 616e 6473 5d0a  for b in bands].
+00020870: 0a20 2020 2020 2020 2074 6f5f 666c 616d  .        to_flam
+00020880: 203d 2031 302a 2a28 2d30 2e34 2a28 3438   = 10**(-0.4*(48
+00020890: 2e36 2929 2a33 2e65 3138 2020 2320 2f20  .6))*3.e18  # / 
+000208a0: 7069 766f 7428 416e 6729 2a2a 320a 0a20  pivot(Ang)**2.. 
+000208b0: 2020 2020 2020 2066 6f72 2069 622c 2062         for ib, b
+000208c0: 2069 6e20 656e 756d 6572 6174 6528 6261   in enumerate(ba
+000208d0: 6e64 7329 3a0a 2020 2020 2020 2020 2020  nds):.          
+000208e0: 2020 6669 6c74 203d 2072 6573 2e66 696c    filt = res.fil
+000208f0: 7465 7273 5b72 6573 2e73 6561 7263 6828  ters[res.search(
+00020900: 622c 2076 6572 626f 7365 3d46 616c 7365  b, verbose=False
+00020910: 295b 305d 5d0a 2020 2020 2020 2020 2020  )[0]].          
+00020920: 2020 6669 6c74 6572 732e 6170 7065 6e64    filters.append
+00020930: 2866 696c 7429 0a0a 2020 2020 2020 2020  (filt)..        
+00020940: 2020 2020 6966 2063 6f6e 7665 7274 5f76      if convert_v
+00020950: 6567 613a 0a20 2020 2020 2020 2020 2020  ega:.           
+00020960: 2020 2020 2074 6f5f 6162 203d 2066 696c       to_ab = fil
+00020970: 742e 4142 5665 6761 2829 0a20 2020 2020  t.ABVega().     
+00020980: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00020990: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
+000209a0: 6162 203d 2030 2e0a 0a20 2020 2020 2020  ab = 0...       
+000209b0: 2020 2020 2066 636f 6c2c 2065 636f 6c20       fcol, ecol 
+000209c0: 3d20 6261 6e64 735b 625d 0a20 2020 2020  = bands[b].     
+000209d0: 2020 2020 2020 2070 6976 6f74 2e61 7070         pivot.app
+000209e0: 656e 6428 6669 6c74 2e70 6976 6f74 2829  end(filt.pivot()
+000209f0: 290a 2020 2020 2020 2020 2020 2020 666c  ).            fl
+00020a00: 616d 2e61 7070 656e 6428 3130 2a2a 282d  am.append(10**(-
+00020a10: 302e 342a 2874 6162 5b66 636f 6c5d 5b30  0.4*(tab[fcol][0
+00020a20: 5d2b 746f 5f61 6229 292a 746f 5f66 6c61  ]+to_ab))*to_fla
+00020a30: 6d2f 7069 766f 745b 2d31 5d2a 2a32 290a  m/pivot[-1]**2).
+00020a40: 2020 2020 2020 2020 2020 2020 666c 616d              flam
+00020a50: 5b2d 315d 202a 3d20 666c 7578 5f73 6361  [-1] *= flux_sca
+00020a60: 6c65 0a20 2020 2020 2020 2020 2020 2065  le.            e
+00020a70: 666c 616d 2e61 7070 656e 6428 7461 625b  flam.append(tab[
+00020a80: 6563 6f6c 5d5b 305d 2a6e 702e 6c6f 6728  ecol][0]*np.log(
+00020a90: 3130 292f 322e 352a 666c 616d 5b2d 315d  10)/2.5*flam[-1]
+00020aa0: 2a65 7272 5f73 6361 6c65 290a 0a20 2020  *err_scale)..   
+00020ab0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00020ac0: 6c65 6e28 6669 6c74 6572 7329 295b 3a3a  len(filters))[::
+00020ad0: 2d31 5d3a 0a20 2020 2020 2020 2069 6620  -1]:.        if 
+00020ae0: 6e70 2e69 7373 6361 6c61 7228 666c 616d  np.isscalar(flam
+00020af0: 5b69 5d29 2026 206e 702e 6973 7363 616c  [i]) & np.isscal
+00020b00: 6172 2865 666c 616d 5b69 5d29 3a0a 2020  ar(eflam[i]):.  
+00020b10: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00020b20: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
+00020b30: 0a20 2020 2020 2020 2020 2020 2066 6c61  .            fla
+00020b40: 6d2e 706f 7028 6929 0a20 2020 2020 2020  m.pop(i).       
+00020b50: 2020 2020 2065 666c 616d 2e70 6f70 2869       eflam.pop(i
+00020b60: 290a 2020 2020 2020 2020 2020 2020 6669  ).            fi
+00020b70: 6c74 6572 732e 706f 7028 6929 0a20 2020  lters.pop(i).   
+00020b80: 2020 2020 2020 2020 2070 6976 6f74 2e70           pivot.p
+00020b90: 6f70 2869 290a 0a20 2020 206c 6320 3d20  op(i)..    lc = 
+00020ba0: 6e70 2e61 7272 6179 2870 6976 6f74 2920  np.array(pivot) 
+00020bb0: 2023 205b 7069 766f 745b 6962 5d20 666f   # [pivot[ib] fo
+00020bc0: 7220 6962 2069 6e20 7261 6e67 6528 6c65  r ib in range(le
+00020bd0: 6e28 6261 6e64 7329 295d 0a0a 2020 2020  n(bands))]..    
+00020be0: 6966 2074 656d 706c 6174 6573 2069 7320  if templates is 
+00020bf0: 6e6f 7420 4e6f 6e65 3a0a 0a20 2020 2020  not None:..     
+00020c00: 2020 2065 617a 795f 7465 6d70 6c61 7465     eazy_template
+00020c10: 7320 3d20 5b54 656d 706c 6174 6528 6172  s = [Template(ar
+00020c20: 7261 7973 3d28 7465 6d70 6c61 7465 735b  rays=(templates[
+00020c30: 6b5d 2e77 6176 652c 2074 656d 706c 6174  k].wave, templat
+00020c40: 6573 5b6b 5d2e 666c 7578 292c 206e 616d  es[k].flux), nam
+00020c50: 653d 6b29 2066 6f72 206b 2069 6e20 7465  e=k) for k in te
+00020c60: 6d70 6c61 7465 735d 0a0a 2020 2020 2020  mplates]..      
+00020c70: 2020 7a67 7269 6420 3d20 6c6f 675f 7a67    zgrid = log_zg
+00020c80: 7269 6428 7a72 3d5b 302e 3031 2c20 332e  rid(zr=[0.01, 3.
+00020c90: 345d 2c20 647a 3d30 2e30 3035 290a 0a20  4], dz=0.005).. 
+00020ca0: 2020 2020 2020 2074 656d 7066 696c 7420         tempfilt 
+00020cb0: 3d20 5465 6d70 6c61 7465 4772 6964 287a  = TemplateGrid(z
+00020cc0: 6772 6964 2c20 6561 7a79 5f74 656d 706c  grid, eazy_templ
+00020cd0: 6174 6573 2c20 6669 6c74 6572 733d 6669  ates, filters=fi
+00020ce0: 6c74 6572 732c 2061 6464 5f69 676d 3d54  lters, add_igm=T
+00020cf0: 7275 652c 2067 616c 6163 7469 635f 6562  rue, galactic_eb
+00020d00: 763d 4d57 5f45 4256 2c20 4562 3d30 2c20  v=MW_EBV, Eb=0, 
+00020d10: 6e5f 7072 6f63 3d30 2c20 7665 7262 6f73  n_proc=0, verbos
+00020d20: 653d 4661 6c73 6529 0a20 2020 2065 6c73  e=False).    els
+00020d30: 653a 0a20 2020 2020 2020 2074 656d 7066  e:.        tempf
+00020d40: 696c 7420 3d20 4e6f 6e65 0a0a 2020 2020  ilt = None..    
+00020d50: 7068 6f74 203d 204f 7264 6572 6564 4469  phot = OrderedDi
+00020d60: 6374 285b 2827 666c 616d 272c 206e 702e  ct([('flam', np.
+00020d70: 6172 7261 7928 666c 616d 2929 2c20 2827  array(flam)), ('
+00020d80: 6566 6c61 6d27 2c20 6e70 2e61 7272 6179  eflam', np.array
+00020d90: 2865 666c 616d 2929 2c20 2827 6669 6c74  (eflam)), ('filt
+00020da0: 6572 7327 2c20 6669 6c74 6572 7329 2c20  ers', filters), 
+00020db0: 2827 7465 6d70 6669 6c74 272c 2074 656d  ('tempfilt', tem
+00020dc0: 7066 696c 7429 2c20 2827 6c63 272c 206e  pfilt), ('lc', n
+00020dd0: 702e 6172 7261 7928 6c63 2929 2c20 2827  p.array(lc)), ('
+00020de0: 736f 7572 6365 272c 2027 5669 7a69 6572  source', 'Vizier
+00020df0: 2027 2b76 697a 5f74 6162 6c65 7329 5d29   '+viz_tables)])
+00020e00: 0a0a 2020 2020 7265 7475 726e 2070 686f  ..    return pho
+00020e10: 740a 0a0a 6465 6620 6765 6e65 7261 7465  t...def generate
+00020e20: 5f74 656d 7066 696c 7428 7465 6d70 6c61  _tempfilt(templa
+00020e30: 7465 732c 2066 696c 7465 7273 2c20 7a67  tes, filters, zg
+00020e40: 7269 643d 4e6f 6e65 2c20 4d57 5f45 4256  rid=None, MW_EBV
+00020e50: 3d30 293a 0a0a 2020 2020 6672 6f6d 2065  =0):..    from e
+00020e60: 617a 792e 7465 6d70 6c61 7465 7320 696d  azy.templates im
+00020e70: 706f 7274 2054 656d 706c 6174 650a 2020  port Template.  
+00020e80: 2020 6672 6f6d 2065 617a 792e 7068 6f74    from eazy.phot
+00020e90: 6f7a 2069 6d70 6f72 7420 5465 6d70 6c61  oz import Templa
+00020ea0: 7465 4772 6964 0a0a 2020 2020 2320 7477  teGrid..    # tw
+00020eb0: 6176 652c 2074 666c 7578 2c20 6973 5f6c  ave, tflux, is_l
+00020ec0: 696e 6520 3d20 6172 7261 795f 7465 6d70  ine = array_temp
+00020ed0: 6c61 7465 7328 7465 6d70 6c61 7465 732c  lates(templates,
+00020ee0: 207a 3d30 290a 2020 2020 2320 6561 7a79   z=0).    # eazy
+00020ef0: 5f74 656d 706c 6174 6573 203d 205b 5d0a  _templates = [].
+00020f00: 2020 2020 2320 666f 7220 692c 2074 2069      # for i, t i
+00020f10: 6e20 656e 756d 6572 6174 6528 7465 6d70  n enumerate(temp
+00020f20: 6c61 7465 7329 3a0a 2020 2020 2320 2020  lates):.    #   
+00020f30: 2020 6561 7a79 5f74 656d 706c 6174 6573    eazy_templates
+00020f40: 2e61 7070 656e 6428 5465 6d70 6c61 7465  .append(Template
+00020f50: 2861 7272 6179 733d 5b74 7761 7665 2c20  (arrays=[twave, 
+00020f60: 6e70 2e6d 6178 696d 756d 2874 7761 7665  np.maximum(twave
+00020f70: 2c20 312e 652d 3330 295d 2c20 6e61 6d65  , 1.e-30)], name
+00020f80: 3d74 2929 0a0a 2020 2020 6561 7a79 5f74  =t))..    eazy_t
+00020f90: 656d 706c 6174 6573 203d 205b 5465 6d70  emplates = [Temp
+00020fa0: 6c61 7465 2861 7272 6179 733d 2874 656d  late(arrays=(tem
+00020fb0: 706c 6174 6573 5b6b 5d2e 7761 7665 2c20  plates[k].wave, 
+00020fc0: 7465 6d70 6c61 7465 735b 6b5d 2e66 6c75  templates[k].flu
+00020fd0: 7829 2c20 6e61 6d65 3d6b 2920 666f 7220  x), name=k) for 
+00020fe0: 6b20 696e 2074 656d 706c 6174 6573 5d0a  k in templates].
+00020ff0: 0a20 2020 2069 6620 7a67 7269 6420 6973  .    if zgrid is
+00021000: 204e 6f6e 653a 0a20 2020 2020 2020 207a   None:.        z
+00021010: 6772 6964 203d 206c 6f67 5f7a 6772 6964  grid = log_zgrid
+00021020: 287a 723d 5b30 2e30 312c 2033 2e34 5d2c  (zr=[0.01, 3.4],
+00021030: 2064 7a3d 302e 3030 3529 0a0a 2020 2020   dz=0.005)..    
+00021040: 7465 6d70 6669 6c74 203d 2054 656d 706c  tempfilt = Templ
+00021050: 6174 6547 7269 6428 7a67 7269 642c 2065  ateGrid(zgrid, e
+00021060: 617a 795f 7465 6d70 6c61 7465 732c 2066  azy_templates, f
+00021070: 696c 7465 7273 3d66 696c 7465 7273 2c20  ilters=filters, 
+00021080: 6164 645f 6967 6d3d 5472 7565 2c20 6761  add_igm=True, ga
+00021090: 6c61 6374 6963 5f65 6276 3d4d 575f 4542  lactic_ebv=MW_EB
+000210a0: 562c 2045 623d 302c 206e 5f70 726f 633d  V, Eb=0, n_proc=
+000210b0: 302c 2076 6572 626f 7365 3d46 616c 7365  0, verbose=False
+000210c0: 290a 0a20 2020 2072 6574 7572 6e20 7465  )..    return te
+000210d0: 6d70 6669 6c74 0a0a 0a64 6566 2063 6f6d  mpfilt...def com
+000210e0: 6269 6e65 5f70 686f 745f 6469 6374 2870  bine_phot_dict(p
+000210f0: 686f 7473 2c20 7465 6d70 6c61 7465 733d  hots, templates=
+00021100: 4e6f 6e65 2c20 4d57 5f45 4256 3d30 293a  None, MW_EBV=0):
+00021110: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
+00021120: 6269 6e65 2070 686f 746d 6574 7279 2064  bine photmetry d
+00021130: 6963 7469 6f6e 6172 6965 730a 2020 2020  ictionaries.    
+00021140: 2222 220a 2020 2020 7068 6f74 203d 207b  """.    phot = {
+00021150: 7d0a 2020 2020 7068 6f74 5b27 666c 616d  }.    phot['flam
+00021160: 275d 203d 205b 5d0a 2020 2020 7068 6f74  '] = [].    phot
+00021170: 5b27 6566 6c61 6d27 5d20 3d20 5b5d 0a20  ['eflam'] = []. 
+00021180: 2020 2070 686f 745b 2766 696c 7465 7273     phot['filters
+00021190: 275d 203d 205b 5d0a 2020 2020 666f 7220  '] = [].    for 
+000211a0: 7020 696e 2070 686f 7473 3a0a 2020 2020  p in phots:.    
+000211b0: 2020 2020 7068 6f74 5b27 666c 616d 275d      phot['flam']
+000211c0: 203d 206e 702e 6170 7065 6e64 2870 686f   = np.append(pho
+000211d0: 745b 2766 6c61 6d27 5d2c 2070 5b27 666c  t['flam'], p['fl
+000211e0: 616d 275d 290a 2020 2020 2020 2020 7068  am']).        ph
+000211f0: 6f74 5b27 6566 6c61 6d27 5d20 3d20 6e70  ot['eflam'] = np
+00021200: 2e61 7070 656e 6428 7068 6f74 5b27 6566  .append(phot['ef
+00021210: 6c61 6d27 5d2c 2070 5b27 6566 6c61 6d27  lam'], p['eflam'
+00021220: 5d29 0a20 2020 2020 2020 2070 686f 745b  ]).        phot[
+00021230: 2766 696c 7465 7273 275d 2e65 7874 656e  'filters'].exten
+00021240: 6428 705b 2766 696c 7465 7273 275d 290a  d(p['filters']).
+00021250: 0a20 2020 2069 6620 7465 6d70 6c61 7465  .    if template
+00021260: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00021270: 2020 2020 2020 2070 686f 745b 2774 656d         phot['tem
+00021280: 7066 696c 7427 5d20 3d20 6765 6e65 7261  pfilt'] = genera
+00021290: 7465 5f74 656d 7066 696c 7428 7465 6d70  te_tempfilt(temp
+000212a0: 6c61 7465 732c 2070 686f 745b 2766 696c  lates, phot['fil
+000212b0: 7465 7273 275d 2c20 4d57 5f45 4256 3d4d  ters'], MW_EBV=M
+000212c0: 575f 4542 5629 0a0a 2020 2020 7265 7475  W_EBV)..    retu
+000212d0: 726e 2070 686f 740a 0a0a 6465 6620 6765  rn phot...def ge
+000212e0: 745f 7370 6563 7472 756d 5f41 425f 6d61  t_spectrum_AB_ma
+000212f0: 6773 2873 7065 6374 7275 6d2c 2062 616e  gs(spectrum, ban
+00021300: 6470 6173 7365 733d 5b5d 293a 0a20 2020  dpasses=[]):.   
+00021310: 2022 2222 0a20 2020 2049 6e74 6567 7261   """.    Integra
+00021320: 7465 2061 2060 7e70 7973 796e 7068 6f74  te a `~pysynphot
+00021330: 6020 7370 6563 7472 756d 2074 6872 6f75  ` spectrum throu
+00021340: 6768 2066 696c 7465 7220 6261 6e64 7061  gh filter bandpa
+00021350: 7373 6573 0a0a 2020 2020 5061 7261 6d65  sses..    Parame
+00021360: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00021370: 2d2d 2d0a 2020 2020 7370 6563 7472 756d  ---.    spectrum
+00021380: 203a 2074 7970 650a 0a20 2020 2062 616e   : type..    ban
+00021390: 6470 6173 7365 7320 3a20 6c69 7374 0a20  dpasses : list. 
+000213a0: 2020 2020 2020 204c 6973 7420 6f66 2060         List of `
+000213b0: 7079 7379 6e70 686f 7460 2062 616e 6470  pysynphot` bandp
+000213c0: 6173 7320 6f62 6a65 6374 732c 2065 2e67  ass objects, e.g
+000213d0: 2e2c 0a0a 2020 2020 2020 2020 2020 203e  .,..           >
+000213e0: 3e3e 2069 6d70 6f72 7420 7079 7379 6e70  >> import pysynp
+000213f0: 686f 7420 6173 2053 0a20 2020 2020 2020  hot as S.       
+00021400: 2020 2020 3e3e 3e20 6261 6e64 7061 7373      >>> bandpass
+00021410: 6573 203d 205b 532e 4f62 7342 616e 6470  es = [S.ObsBandp
+00021420: 6173 7328 2777 6663 332c 6972 2c66 3134  ass('wfc3,ir,f14
+00021430: 3077 2729 5d0a 0a0a 2020 2020 5265 7475  0w')]...    Retu
+00021440: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00021450: 2020 2020 6162 5f6d 6167 7320 3a20 6469      ab_mags : di
+00021460: 6374 0a20 2020 2020 2020 2044 6963 7469  ct.        Dicti
+00021470: 6f6e 6172 7920 7769 7468 206b 6579 7320  onary with keys 
+00021480: 6672 6f6d 2060 6261 6e64 7061 7373 6573  from `bandpasses
+00021490: 6020 616e 6420 7468 6520 696e 7465 6772  ` and the integr
+000214a0: 6174 6564 206d 6167 6e69 7475 6465 730a  ated magnitudes.
+000214b0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+000214c0: 6f72 7420 7079 7379 6e70 686f 7420 6173  ort pysynphot as
+000214d0: 2053 0a20 2020 2066 6c61 7420 3d20 532e   S.    flat = S.
+000214e0: 466c 6174 5370 6563 7472 756d 2830 2c20  FlatSpectrum(0, 
+000214f0: 666c 7578 756e 6974 733d 2741 424d 6167  fluxunits='ABMag
+00021500: 2729 0a20 2020 2061 625f 6d61 6773 203d  ').    ab_mags =
+00021510: 204f 7264 6572 6564 4469 6374 2829 0a0a   OrderedDict()..
+00021520: 2020 2020 666f 7220 6270 2069 6e20 6261      for bp in ba
+00021530: 6e64 7061 7373 6573 3a0a 2020 2020 2020  ndpasses:.      
+00021540: 2020 666c 6174 5f6f 6273 203d 2053 2e4f    flat_obs = S.O
+00021550: 6273 6572 7661 7469 6f6e 2866 6c61 742c  bservation(flat,
+00021560: 2062 7029 0a20 2020 2020 2020 2073 7065   bp).        spe
+00021570: 635f 6f62 7320 3d20 532e 4f62 7365 7276  c_obs = S.Observ
+00021580: 6174 696f 6e28 7370 6563 7472 756d 2c20  ation(spectrum, 
+00021590: 6270 290a 2020 2020 2020 2020 6162 5f6d  bp).        ab_m
+000215a0: 6167 735b 6270 2e6e 616d 655d 203d 202d  ags[bp.name] = -
+000215b0: 322e 352a 6e70 2e6c 6f67 3130 2873 7065  2.5*np.log10(spe
+000215c0: 635f 6f62 732e 636f 756e 7472 6174 6528  c_obs.countrate(
+000215d0: 292f 666c 6174 5f6f 6273 2e63 6f75 6e74  )/flat_obs.count
+000215e0: 7261 7465 2829 290a 0a20 2020 2072 6574  rate())..    ret
+000215f0: 7572 6e20 6162 5f6d 6167 730a 0a0a 6465  urn ab_mags...de
+00021600: 6620 6c6f 675f 7a67 7269 6428 7a72 3d5b  f log_zgrid(zr=[
+00021610: 302e 372c 2033 2e34 5d2c 2064 7a3d 302e  0.7, 3.4], dz=0.
+00021620: 3031 293a 0a20 2020 2022 2222 4d61 6b65  01):.    """Make
+00021630: 2061 206c 6f67 6172 6974 686d 6963 616c   a logarithmical
+00021640: 6c79 2073 7061 6365 6420 7265 6473 6869  ly spaced redshi
+00021650: 6674 2067 7269 640a 0a20 2020 2050 6172  ft grid..    Par
+00021660: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00021670: 2d2d 2d2d 2d2d 0a20 2020 207a 7220 3a20  ------.    zr : 
+00021680: 5b66 6c6f 6174 2c20 666c 6f61 745d 0a20  [float, float]. 
+00021690: 2020 2020 2020 204d 696e 696d 756d 2061         Minimum a
+000216a0: 6e64 206d 6178 696d 756d 206f 6620 7468  nd maximum of th
+000216b0: 6520 6465 7369 7265 6420 6772 6964 0a0a  e desired grid..
+000216c0: 2020 2020 647a 203a 2066 6c6f 6174 0a20      dz : float. 
+000216d0: 2020 2020 2020 2053 7465 7020 7369 7a65         Step size
+000216e0: 2c20 647a 2f28 312b 7a29 0a0a 2020 2020  , dz/(1+z)..    
+000216f0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00021700: 2d2d 2d0a 2020 2020 7a67 7269 6420 3a20  ---.    zgrid : 
+00021710: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
+00021720: 2020 2052 6564 7368 6966 7420 6772 6964     Redshift grid
+00021730: 0a0a 2020 2020 2222 220a 2020 2020 7a67  ..    """.    zg
+00021740: 7269 6420 3d20 6e70 2e65 7870 286e 702e  rid = np.exp(np.
+00021750: 6172 616e 6765 286e 702e 6c6f 6728 312b  arange(np.log(1+
+00021760: 7a72 5b30 5d29 2c20 6e70 2e6c 6f67 2831  zr[0]), np.log(1
+00021770: 2b7a 725b 315d 292c 2064 7a29 292d 310a  +zr[1]), dz))-1.
+00021780: 2020 2020 7265 7475 726e 207a 6772 6964      return zgrid
+00021790: 0a0a 6465 6620 7472 6170 7a5f 6478 2878  ..def trapz_dx(x
+000217a0: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
+000217b0: 6574 7572 6e20 7472 6170 657a 6f69 6420  eturn trapezoid 
+000217c0: 7275 6c65 2063 6f65 6666 6963 6965 6e74  rule coefficient
+000217d0: 732c 2075 7365 6675 6c20 666f 7220 6e75  s, useful for nu
+000217e0: 6d65 7269 6361 6c20 696e 7465 6772 6174  merical integrat
+000217f0: 696f 6e20 0a20 2020 2075 7369 6e67 2061  ion .    using a
+00021800: 2064 6f74 2070 726f 6475 6374 0a20 2020   dot product.   
+00021810: 200a 2020 2020 5061 7261 6d65 7465 7273   .    Parameters
+00021820: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00021830: 2020 2020 7820 3a20 6172 7261 792d 6c69      x : array-li
+00021840: 6b65 0a20 2020 2020 2020 2049 6e64 6570  ke.        Indep
+00021850: 656e 6465 6e74 2076 6172 6961 626c 650a  endent variable.
+00021860: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
+00021870: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00021880: 2064 7820 3a20 6172 7261 795f 6c69 6b65   dx : array_like
+00021890: 0a20 2020 2020 2020 2043 6f65 6666 6963  .        Coeffic
+000218a0: 6965 6e74 7320 666f 7220 7472 6170 657a  ients for trapez
+000218b0: 6f69 6461 6c20 7275 6c65 2069 6e74 6567  oidal rule integ
+000218c0: 7261 7469 6f6e 2e0a 2020 2020 2020 2020  ration..        
+000218d0: 0a20 2020 2022 2222 0a20 2020 2064 7820  .    """.    dx 
+000218e0: 3d20 6e70 2e7a 6572 6f73 5f6c 696b 6528  = np.zeros_like(
+000218f0: 7829 0a20 2020 2064 6966 6620 3d20 6e70  x).    diff = np
+00021900: 2e64 6966 6628 7829 2f32 2e0a 2020 2020  .diff(x)/2..    
+00021910: 6478 5b3a 2d31 5d20 2b3d 2064 6966 660a  dx[:-1] += diff.
+00021920: 2020 2020 6478 5b31 3a5d 202b 3d20 6469      dx[1:] += di
+00021930: 6666 0a20 2020 2072 6574 7572 6e20 6478  ff.    return dx
+00021940: 0a0a 0a64 6566 2067 6574 5f77 6373 5f70  ...def get_wcs_p
+00021950: 7363 616c 6528 7763 732c 2073 6574 5f61  scale(wcs, set_a
+00021960: 7474 7269 6275 7465 3d54 7275 6529 3a0a  ttribute=True):.
+00021970: 2020 2020 2222 2247 6574 2063 6f72 7265      """Get corre
+00021980: 6374 2070 7363 616c 6520 6672 6f6d 2061  ct pscale from a
+00021990: 2060 7e61 7374 726f 7079 2e77 6373 2e57   `~astropy.wcs.W
+000219a0: 4353 6020 6f62 6a65 6374 0a0a 2020 2020  CS` object..    
+000219b0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+000219c0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7763  ---------.    wc
+000219d0: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
+000219e0: 732e 5743 5360 206f 7220 607e 6173 7472  s.WCS` or `~astr
+000219f0: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
+00021a00: 6572 600a 0a20 2020 2073 6574 5f61 7474  er`..    set_att
+00021a10: 7269 6275 7465 203a 2062 6f6f 6c0a 2020  ribute : bool.  
+00021a20: 2020 2020 2020 5365 7420 7468 6520 6070        Set the `p
+00021a30: 7363 616c 6560 2061 7474 7269 6275 7465  scale` attribute
+00021a40: 206f 6e20 6077 6373 602c 2061 6c6f 6e67   on `wcs`, along
+00021a50: 2077 6974 6820 7265 7475 726e 696e 6720   with returning 
+00021a60: 7468 6520 7661 6c75 652e 0a0a 2020 2020  the value...    
+00021a70: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00021a80: 2d2d 2d0a 2020 2020 7073 6361 6c65 203a  ---.    pscale :
+00021a90: 2066 6c6f 6174 0a20 2020 2020 2020 2050   float.        P
+00021aa0: 6978 656c 2073 6361 6c65 2066 726f 6d20  ixel scale from 
+00021ab0: 6077 6373 2e63 6460 0a0a 2020 2020 2222  `wcs.cd`..    ""
+00021ac0: 220a 2020 2020 6672 6f6d 206e 756d 7079  ".    from numpy
+00021ad0: 2069 6d70 6f72 7420 6c69 6e61 6c67 0a0a   import linalg..
+00021ae0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00021af0: 6528 7763 732c 2070 7966 6974 732e 4865  e(wcs, pyfits.He
+00021b00: 6164 6572 293a 0a20 2020 2020 2020 2077  ader):.        w
+00021b10: 6373 203d 2070 7977 6373 2e57 4353 2877  cs = pywcs.WCS(w
+00021b20: 6373 2c20 7265 6c61 783d 5472 7565 290a  cs, relax=True).
+00021b30: 0a20 2020 2069 6620 6861 7361 7474 7228  .    if hasattr(
+00021b40: 7763 732e 7763 732c 2027 6364 2729 3a0a  wcs.wcs, 'cd'):.
+00021b50: 2020 2020 2020 2020 6465 7420 3d20 6c69          det = li
+00021b60: 6e61 6c67 2e64 6574 2877 6373 2e77 6373  nalg.det(wcs.wcs
+00021b70: 2e63 6429 0a20 2020 2065 6c73 653a 0a20  .cd).    else:. 
+00021b80: 2020 2020 2020 2064 6574 203d 206c 696e         det = lin
+00021b90: 616c 672e 6465 7428 7763 732e 7763 732e  alg.det(wcs.wcs.
+00021ba0: 7063 290a 0a20 2020 2070 7363 616c 6520  pc)..    pscale 
+00021bb0: 3d20 6e70 2e73 7172 7428 6e70 2e61 6273  = np.sqrt(np.abs
+00021bc0: 2864 6574 2929 2a33 3630 302e 0a20 2020  (det))*3600..   
+00021bd0: 200a 2020 2020 7769 7468 2077 6172 6e69   .    with warni
+00021be0: 6e67 732e 6361 7463 685f 7761 726e 696e  ngs.catch_warnin
+00021bf0: 6773 2829 3a0a 2020 2020 2020 2020 7761  gs():.        wa
+00021c00: 726e 696e 6773 2e66 696c 7465 7277 6172  rnings.filterwar
+00021c10: 6e69 6e67 7328 2769 676e 6f72 6527 2c20  nings('ignore', 
+00021c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021c30: 2020 2027 6364 656c 7420 7769 6c6c 2062     'cdelt will b
+00021c40: 6520 6967 6e6f 7265 6420 7369 6e63 6520  e ignored since 
+00021c50: 6364 2069 7320 7072 6573 656e 7427 2c20  cd is present', 
+00021c60: 5275 6e74 696d 6557 6172 6e69 6e67 290a  RuntimeWarning).
+00021c70: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00021c80: 2069 6620 6861 7361 7474 7228 7763 732e   if hasattr(wcs.
+00021c90: 7763 732c 2027 6364 656c 7427 293a 0a20  wcs, 'cdelt'):. 
+00021ca0: 2020 2020 2020 2020 2020 2070 7363 616c             pscal
+00021cb0: 6520 2a3d 2077 6373 2e77 6373 2e63 6465  e *= wcs.wcs.cde
+00021cc0: 6c74 5b30 5d0a 2020 2020 2020 2020 0a20  lt[0].        . 
+00021cd0: 2020 2077 6373 2e70 7363 616c 6520 3d20     wcs.pscale = 
+00021ce0: 7073 6361 6c65 0a0a 2020 2020 7265 7475  pscale..    retu
+00021cf0: 726e 2070 7363 616c 650a 0a0a 6465 6620  rn pscale...def 
+00021d00: 7472 616e 7366 6f72 6d5f 7763 7328 696e  transform_wcs(in
+00021d10: 5f77 6373 2c20 7472 616e 736c 6174 696f  _wcs, translatio
+00021d20: 6e3d 5b30 2e2c 2030 2e5d 2c20 726f 7461  n=[0., 0.], rota
+00021d30: 7469 6f6e 3d30 2e2c 2073 6361 6c65 3d31  tion=0., scale=1
+00021d40: 2e29 3a0a 2020 2020 2222 2255 7064 6174  .):.    """Updat
+00021d50: 6520 5743 5320 7769 7468 2073 6869 6674  e WCS with shift
+00021d60: 2c20 726f 7461 7469 6f6e 2c20 2620 7363  , rotation, & sc
+00021d70: 616c 650a 0a20 2020 2050 6172 616d 6574  ale..    Paramet
+00021d80: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
+00021d90: 2d2d 0a20 2020 2069 6e5f 7763 733a 2060  --.    in_wcs: `
+00021da0: 7e61 7374 726f 7079 2e77 6373 2e57 4353  ~astropy.wcs.WCS
+00021db0: 600a 2020 2020 2020 2020 496e 7075 7420  `.        Input 
+00021dc0: 5743 530a 0a20 2020 2074 7261 6e73 6c61  WCS..    transla
+00021dd0: 7469 6f6e 3a20 5b66 6c6f 6174 2c20 666c  tion: [float, fl
+00021de0: 6f61 745d 0a20 2020 2020 2020 2078 7368  oat].        xsh
+00021df0: 6966 7420 2620 7973 6869 6674 2069 6e20  ift & yshift in 
+00021e00: 7069 7865 6c73 0a0a 2020 2020 726f 7461  pixels..    rota
+00021e10: 7469 6f6e 3a20 666c 6f61 740a 2020 2020  tion: float.    
+00021e20: 2020 2020 4343 5720 726f 7461 7469 6f6e      CCW rotation
+00021e30: 2028 746f 7761 7264 7320 4561 7374 292c   (towards East),
+00021e40: 2072 6164 6961 6e73 0a0a 2020 2020 7363   radians..    sc
+00021e50: 616c 653a 2066 6c6f 6174 0a20 2020 2020  ale: float.     
+00021e60: 2020 2050 6978 656c 2073 6361 6c65 2066     Pixel scale f
+00021e70: 6163 746f 720a 0a20 2020 2052 6574 7572  actor..    Retur
+00021e80: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00021e90: 2020 206f 7574 5f77 6373 3a20 607e 6173     out_wcs: `~as
+00021ea0: 7472 6f70 792e 7763 732e 5743 5360 0a20  tropy.wcs.WCS`. 
+00021eb0: 2020 2020 2020 204d 6f64 6966 6965 6420         Modified 
+00021ec0: 5743 530a 2020 2020 2222 220a 2020 2020  WCS.    """.    
+00021ed0: 6f75 745f 7763 7320 3d20 696e 5f77 6373  out_wcs = in_wcs
+00021ee0: 2e64 6565 7063 6f70 7928 290a 0a20 2020  .deepcopy()..   
+00021ef0: 2023 6f75 745f 7763 732e 7763 732e 6372   #out_wcs.wcs.cr
+00021f00: 7069 7820 2b3d 206e 702e 6172 7261 7928  pix += np.array(
+00021f10: 7472 616e 736c 6174 696f 6e29 0a0a 2020  translation)..  
+00021f20: 2020 2320 436f 6d70 7574 6520 7368 6966    # Compute shif
+00021f30: 7420 666f 7220 6372 7661 6c2c 206e 6f74  t for crval, not
+00021f40: 2063 7270 6978 0a20 2020 2063 7276 616c   crpix.    crval
+00021f50: 203d 2069 6e5f 7763 732e 616c 6c5f 7069   = in_wcs.all_pi
+00021f60: 7832 776f 726c 6428 5b69 6e5f 7763 732e  x2world([in_wcs.
+00021f70: 7763 732e 6372 7069 782d 6e70 2e61 7272  wcs.crpix-np.arr
+00021f80: 6179 2874 7261 6e73 6c61 7469 6f6e 295d  ay(translation)]
+00021f90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021fb0: 2020 2020 2020 2031 292e 666c 6174 7465         1).flatte
+00021fc0: 6e28 290a 0a20 2020 2023 2043 6f6d 7075  n()..    # Compu
+00021fd0: 7465 2073 6869 6674 2061 7420 696d 6167  te shift at imag
+00021fe0: 6520 6365 6e74 6572 0a20 2020 2069 6620  e center.    if 
+00021ff0: 6861 7361 7474 7228 696e 5f77 6373 2c20  hasattr(in_wcs, 
+00022000: 275f 6e61 7869 7331 2729 3a0a 2020 2020  '_naxis1'):.    
+00022010: 2020 2020 7265 6670 6978 203d 206e 702e      refpix = np.
+00022020: 6172 7261 7928 5b69 6e5f 7763 732e 5f6e  array([in_wcs._n
+00022030: 6178 6973 312f 322e 2c20 696e 5f77 6373  axis1/2., in_wcs
+00022040: 2e5f 6e61 7869 7332 2f32 2e5d 290a 2020  ._naxis2/2.]).  
+00022050: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00022060: 7265 6670 6978 203d 206e 702e 6172 7261  refpix = np.arra
+00022070: 7928 696e 5f77 6373 2e5f 6e61 7869 7329  y(in_wcs._naxis)
+00022080: 2f32 2e0a 0a20 2020 2063 3020 3d20 696e  /2...    c0 = in
+00022090: 5f77 6373 2e61 6c6c 5f70 6978 3277 6f72  _wcs.all_pix2wor
+000220a0: 6c64 285b 7265 6670 6978 5d2c 2031 292e  ld([refpix], 1).
+000220b0: 666c 6174 7465 6e28 290a 2020 2020 6331  flatten().    c1
+000220c0: 203d 2069 6e5f 7763 732e 616c 6c5f 7069   = in_wcs.all_pi
+000220d0: 7832 776f 726c 6428 5b72 6566 7069 782d  x2world([refpix-
+000220e0: 6e70 2e61 7272 6179 2874 7261 6e73 6c61  np.array(transla
+000220f0: 7469 6f6e 295d 2c20 3129 2e66 6c61 7474  tion)], 1).flatt
+00022100: 656e 2829 0a0a 2020 2020 6f75 745f 7763  en()..    out_wc
+00022110: 732e 7763 732e 6372 7661 6c20 2b3d 2063  s.wcs.crval += c
+00022120: 312d 6330 0a0a 2020 2020 7468 6574 6120  1-c0..    theta 
+00022130: 3d20 2d72 6f74 6174 696f 6e0a 2020 2020  = -rotation.    
+00022140: 5f6d 6174 203d 206e 702e 6172 7261 7928  _mat = np.array(
+00022150: 5b5b 6e70 2e63 6f73 2874 6865 7461 292c  [[np.cos(theta),
+00022160: 202d 6e70 2e73 696e 2874 6865 7461 295d   -np.sin(theta)]
+00022170: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022180: 2020 2020 2020 205b 6e70 2e73 696e 2874         [np.sin(t
+00022190: 6865 7461 292c 206e 702e 636f 7328 7468  heta), np.cos(th
+000221a0: 6574 6129 5d5d 290a 0a20 2020 2074 7279  eta)]])..    try
+000221b0: 3a0a 2020 2020 2020 2020 6f75 745f 7763  :.        out_wc
+000221c0: 732e 7763 732e 6364 5b3a 322c 3a32 5d20  s.wcs.cd[:2,:2] 
+000221d0: 3d20 6e70 2e64 6f74 286f 7574 5f77 6373  = np.dot(out_wcs
+000221e0: 2e77 6373 2e63 645b 3a32 2c3a 325d 2c20  .wcs.cd[:2,:2], 
+000221f0: 5f6d 6174 292f 7363 616c 650a 2020 2020  _mat)/scale.    
+00022200: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+00022210: 6f75 745f 7763 732e 7763 732e 7063 203d  out_wcs.wcs.pc =
+00022220: 206e 702e 646f 7428 6f75 745f 7763 732e   np.dot(out_wcs.
+00022230: 7763 732e 7063 2c20 5f6d 6174 292f 7363  wcs.pc, _mat)/sc
+00022240: 616c 650a 0a20 2020 206f 7574 5f77 6373  ale..    out_wcs
+00022250: 2e70 7363 616c 6520 3d20 6765 745f 7763  .pscale = get_wc
+00022260: 735f 7073 6361 6c65 286f 7574 5f77 6373  s_pscale(out_wcs
+00022270: 290a 2020 2020 236f 7574 5f77 6373 2e77  ).    #out_wcs.w
+00022280: 6373 2e63 7270 6978 202a 3d20 7363 616c  cs.crpix *= scal
+00022290: 650a 2020 2020 6966 2068 6173 6174 7472  e.    if hasattr
+000222a0: 286f 7574 5f77 6373 2c20 2770 6978 656c  (out_wcs, 'pixel
+000222b0: 5f73 6861 7065 2729 3a0a 2020 2020 2020  _shape'):.      
+000222c0: 2020 5f6e 6178 6973 3120 3d20 696e 7428    _naxis1 = int(
+000222d0: 6e70 2e72 6f75 6e64 286f 7574 5f77 6373  np.round(out_wcs
+000222e0: 2e70 6978 656c 5f73 6861 7065 5b30 5d2a  .pixel_shape[0]*
+000222f0: 7363 616c 6529 290a 2020 2020 2020 2020  scale)).        
+00022300: 5f6e 6178 6973 3220 3d20 696e 7428 6e70  _naxis2 = int(np
+00022310: 2e72 6f75 6e64 286f 7574 5f77 6373 2e70  .round(out_wcs.p
+00022320: 6978 656c 5f73 6861 7065 5b31 5d2a 7363  ixel_shape[1]*sc
+00022330: 616c 6529 290a 2020 2020 2020 2020 6f75  ale)).        ou
+00022340: 745f 7763 732e 5f6e 6178 6973 203d 205b  t_wcs._naxis = [
+00022350: 5f6e 6178 6973 312c 205f 6e61 7869 7332  _naxis1, _naxis2
+00022360: 5d0a 2020 2020 656c 6966 2068 6173 6174  ].    elif hasat
+00022370: 7472 286f 7574 5f77 6373 2c20 275f 6e61  tr(out_wcs, '_na
+00022380: 7869 7331 2729 3a0a 2020 2020 2020 2020  xis1'):.        
+00022390: 6f75 745f 7763 732e 5f6e 6178 6973 3120  out_wcs._naxis1 
+000223a0: 3d20 696e 7428 6e70 2e72 6f75 6e64 286f  = int(np.round(o
+000223b0: 7574 5f77 6373 2e5f 6e61 7869 7331 2a73  ut_wcs._naxis1*s
+000223c0: 6361 6c65 2929 0a20 2020 2020 2020 206f  cale)).        o
+000223d0: 7574 5f77 6373 2e5f 6e61 7869 7332 203d  ut_wcs._naxis2 =
+000223e0: 2069 6e74 286e 702e 726f 756e 6428 6f75   int(np.round(ou
+000223f0: 745f 7763 732e 5f6e 6178 6973 322a 7363  t_wcs._naxis2*sc
+00022400: 616c 6529 290a 0a20 2020 2072 6574 7572  ale))..    retur
+00022410: 6e20 6f75 745f 7763 730a 0a0a 6465 6620  n out_wcs...def 
+00022420: 7369 705f 726f 7439 3028 696e 7075 742c  sip_rot90(input,
+00022430: 2072 6f74 2c20 7265 7665 7273 653d 4661   rot, reverse=Fa
+00022440: 6c73 652c 2076 6572 626f 7365 3d46 616c  lse, verbose=Fal
+00022450: 7365 2c20 636f 6d70 6172 653d 4661 6c73  se, compare=Fals
+00022460: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+00022470: 526f 7461 7465 2061 2053 4950 2057 4353  Rotate a SIP WCS
+00022480: 2062 7920 696e 6372 656d 656e 7473 206f   by increments o
+00022490: 6620 3930 2064 6567 7265 6573 2075 7369  f 90 degrees usi
+000224a0: 6e67 2064 6972 6563 7420 7472 616e 7366  ng direct transf
+000224b0: 6f72 6d61 7469 6f6e 730a 2020 2020 6265  ormations.    be
+000224c0: 7477 6565 6e20 7820 2f20 7920 636f 6f72  tween x / y coor
+000224d0: 6469 6e61 7465 730a 2020 2020 0a20 2020  dinates.    .   
+000224e0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+000224f0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2069  ----------.    i
+00022500: 6e70 7574 203a 2060 7e61 7374 726f 7079  nput : `~astropy
+00022510: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
+00022520: 206f 7220 607e 6173 7472 6f70 792e 7763   or `~astropy.wc
+00022530: 732e 5743 5360 0a20 2020 2020 2020 2048  s.WCS`.        H
+00022540: 6561 6465 7220 6f72 2057 4353 0a20 2020  eader or WCS.   
+00022550: 200a 2020 2020 726f 7420 3a20 696e 740a   .    rot : int.
+00022560: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
+00022570: 6620 7469 6d65 7320 746f 2072 6f74 6174  f times to rotat
+00022580: 6520 7468 6520 5743 5320 3930 2064 6567  e the WCS 90 deg
+00022590: 7265 6573 202a 636c 6f63 6b77 6973 652a  rees *clockwise*
+000225a0: 2c20 616e 616c 6f67 6f75 730a 2020 2020  , analogous.    
+000225b0: 2020 2020 746f 2060 6e75 6d70 792e 726f      to `numpy.ro
+000225c0: 7439 3060 0a20 2020 200a 2020 2020 7265  t90`.    .    re
+000225d0: 7665 7273 6520 3a20 626f 6f6c 0a20 2020  verse : bool.   
+000225e0: 2020 2020 2049 6620 6069 6e70 7574 6020       If `input` 
+000225f0: 6973 2061 2068 6561 6465 7220 616e 6420  is a header and 
+00022600: 696e 636c 7564 6573 2061 206b 6579 776f  includes a keywo
+00022610: 7264 2060 6052 4f54 3930 6060 2c20 7468  rd ``ROT90``, th
+00022620: 656e 2075 6e64 6f20 0a20 2020 2020 2020  en undo .       
+00022630: 2074 6865 2072 6f74 6174 696f 6e20 616e   the rotation an
+00022640: 6420 7265 6d6f 7665 2074 6865 206b 6579  d remove the key
+00022650: 776f 7264 2066 726f 6d20 7468 6520 6f75  word from the ou
+00022660: 7470 7574 2068 6561 6465 720a 2020 2020  tput header.    
+00022670: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
+00022680: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00022690: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
+000226a0: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
+000226b0: 6572 600a 2020 2020 2020 2020 526f 7461  er`.        Rota
+000226c0: 7465 6420 5743 5320 6865 6164 6572 0a20  ted WCS header. 
+000226d0: 2020 2020 2020 200a 2020 2020 7763 7320         .    wcs 
+000226e0: 3a20 607e 6173 7472 6f70 792e 7763 732e  : `~astropy.wcs.
+000226f0: 5743 5360 0a20 2020 2020 2020 2052 6f74  WCS`.        Rot
+00022700: 6174 6564 2057 4353 0a20 2020 200a 2020  ated WCS.    .  
+00022710: 2020 6465 7363 203a 2073 7472 0a20 2020    desc : str.   
+00022720: 2020 2020 2044 6573 6372 6970 7469 6f6e       Description
+00022730: 206f 6620 7468 6520 7472 616e 7366 6f72   of the transfor
+00022740: 6d20 6173 736f 6369 6174 6564 2077 6974  m associated wit
+00022750: 6820 6060 726f 7460 602c 2065 2e67 2c20  h ``rot``, e.g, 
+00022760: 0a20 2020 2020 2020 2060 6078 3d6e 782d  .        ``x=nx-
+00022770: 782c 2079 3d6e 792d 7960 6020 666f 7220  x, y=ny-y`` for 
+00022780: 6060 726f 743d c2b1 3260 602e 0a20 2020  ``rot=..2``..   
+00022790: 2020 2020 200a 2020 2020 2222 220a 2020       .    """.  
+000227a0: 2020 696d 706f 7274 2063 6f70 790a 2020    import copy.  
+000227b0: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
+000227c0: 2e69 6f2e 6669 7473 0a20 2020 2069 6d70  .io.fits.    imp
+000227d0: 6f72 7420 6173 7472 6f70 792e 7763 730a  ort astropy.wcs.
+000227e0: 2020 2020 696d 706f 7274 206d 6174 706c      import matpl
+000227f0: 6f74 6c69 622e 7079 706c 6f74 2061 7320  otlib.pyplot as 
+00022800: 706c 740a 2020 2020 0a20 2020 2069 6620  plt.    .    if 
+00022810: 6973 696e 7374 616e 6365 2869 6e70 7574  isinstance(input
+00022820: 2c20 6173 7472 6f70 792e 696f 2e66 6974  , astropy.io.fit
+00022830: 732e 4865 6164 6572 293a 0a20 2020 2020  s.Header):.     
+00022840: 2020 206f 7269 6720 3d20 636f 7079 2e64     orig = copy.d
+00022850: 6565 7063 6f70 7928 696e 7075 7429 0a20  eepcopy(input). 
+00022860: 2020 2020 2020 206e 6577 203d 2063 6f70         new = cop
+00022870: 792e 6465 6570 636f 7079 2869 6e70 7574  y.deepcopy(input
+00022880: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+00022890: 2020 2069 6620 2827 524f 5439 3027 2069     if ('ROT90' i
+000228a0: 6e20 696e 7075 7429 3a0a 2020 2020 2020  n input):.      
+000228b0: 2020 2020 2020 6966 2072 6576 6572 7365        if reverse
+000228c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000228d0: 2020 726f 7420 3d20 2d6f 7269 675b 2752    rot = -orig['R
+000228e0: 4f54 3930 275d 0a20 2020 2020 2020 2020  OT90'].         
+000228f0: 2020 2020 2020 206e 6577 2e72 656d 6f76         new.remov
+00022900: 6528 2752 4f54 3930 2729 0a20 2020 2020  e('ROT90').     
+00022910: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00022920: 2020 2020 2020 2020 2020 2020 206e 6577               new
+00022930: 5b27 524f 5439 3027 5d20 3d20 6f72 6967  ['ROT90'] = orig
+00022940: 5b27 524f 5439 3027 5d20 2b20 726f 740a  ['ROT90'] + rot.
+00022950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00022960: 2020 2020 2020 2020 2020 6e65 775b 2752            new['R
+00022970: 4f54 3930 275d 203d 2072 6f74 0a20 2020  OT90'] = rot.   
+00022980: 2065 6c73 653a 0a20 2020 2020 2020 206f   else:.        o
+00022990: 7269 6720 3d20 746f 5f68 6561 6465 7228  rig = to_header(
+000229a0: 696e 7075 7429 0a20 2020 2020 2020 206e  input).        n
+000229b0: 6577 203d 2074 6f5f 6865 6164 6572 2869  ew = to_header(i
+000229c0: 6e70 7574 290a 0a20 2020 206f 7269 675f  nput)..    orig_
+000229d0: 7763 7320 3d20 7079 7763 732e 5743 5328  wcs = pywcs.WCS(
+000229e0: 6f72 6967 2c20 7265 6c61 783d 5472 7565  orig, relax=True
+000229f0: 290a 0a20 2020 2023 2323 2043 4420 3d20  )..    ### CD = 
+00022a00: 5b5b 6472 612f 6478 2c20 6472 612f 6479  [[dra/dx, dra/dy
+00022a10: 5d2c 205b 6464 652f 6478 2c20 6464 652f  ], [dde/dx, dde/
+00022a20: 6479 5d5d 0a20 2020 2023 2323 2078 203d  dy]].    ### x =
+00022a30: 2061 5f69 5f6a 202a 2075 2a2a 6920 2a20   a_i_j * u**i * 
+00022a40: 762a 2a6a 0a20 2020 2023 2323 2079 203d  v**j.    ### y =
+00022a50: 2062 5f69 5f6a 202a 2075 2a2a 6920 2a20   b_i_j * u**i * 
+00022a60: 762a 2a6a 0a20 2020 200a 2020 2020 6978  v**j.    .    ix
+00022a70: 203d 2031 0a20 2020 200a 2020 2020 6966   = 1.    .    if
+00022a80: 2063 6f6d 7061 7265 3a0a 2020 2020 2020   compare:.      
+00022a90: 2020 7861 7272 203d 206e 702e 6172 616e    xarr = np.aran
+00022aa0: 6765 2830 2c32 3034 382c 3634 290a 2020  ge(0,2048,64).  
+00022ab0: 2020 2020 2020 7870 2c20 7970 203d 206e        xp, yp = n
+00022ac0: 702e 6d65 7368 6772 6964 2878 6172 722c  p.meshgrid(xarr,
+00022ad0: 2078 6172 7229 0a20 2020 2020 2020 2072   xarr).        r
+00022ae0: 6420 3d20 6f72 6967 5f77 6373 2e61 6c6c  d = orig_wcs.all
+00022af0: 5f70 6978 3277 6f72 6c64 2878 702c 2079  _pix2world(xp, y
+00022b00: 702c 2069 7829 0a0a 2020 2020 6966 2072  p, ix)..    if r
+00022b10: 6f74 2025 2034 203d 3d20 313a 0a20 2020  ot % 4 == 1:.   
+00022b20: 2020 2020 2023 2043 5720 3930 2064 6567       # CW 90 deg
+00022b30: 203a 2078 203d 2079 2c20 7920 3d20 286e   : x = y, y = (n
+00022b40: 7820 2d20 7829 2c20 753d 762c 2076 3d2d  x - x), u=v, v=-
+00022b50: 750a 2020 2020 2020 2020 6465 7363 203d  u.        desc =
+00022b60: 2027 783d 792c 2079 3d6e 782d 7827 0a20   'x=y, y=nx-x'. 
+00022b70: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00022b80: 6e65 775b 2743 5250 4958 3127 5d20 3d20  new['CRPIX1'] = 
+00022b90: 6f72 6967 5b27 4352 5049 5832 275d 0a20  orig['CRPIX2']. 
+00022ba0: 2020 2020 2020 206e 6577 5b27 4352 5049         new['CRPI
+00022bb0: 5832 275d 203d 206f 7269 675b 274e 4158  X2'] = orig['NAX
+00022bc0: 4953 3127 5d20 2d20 6f72 6967 5b27 4352  IS1'] - orig['CR
+00022bd0: 5049 5831 275d 202b 2031 0a0a 2020 2020  PIX1'] + 1..    
+00022be0: 2020 2020 6e65 775b 2743 4431 5f31 275d      new['CD1_1']
+00022bf0: 203d 206f 7269 675b 2743 4431 5f32 275d   = orig['CD1_2']
+00022c00: 0a20 2020 2020 2020 206e 6577 5b27 4344  .        new['CD
+00022c10: 315f 3227 5d20 3d20 2d6f 7269 675b 2743  1_2'] = -orig['C
+00022c20: 4431 5f31 275d 0a20 2020 2020 2020 206e  D1_1'].        n
+00022c30: 6577 5b27 4344 325f 3127 5d20 3d20 6f72  ew['CD2_1'] = or
+00022c40: 6967 5b27 4344 325f 3227 5d0a 2020 2020  ig['CD2_2'].    
+00022c50: 2020 2020 6e65 775b 2743 4432 5f32 275d      new['CD2_2']
+00022c60: 203d 202d 6f72 6967 5b27 4344 325f 3127   = -orig['CD2_1'
+00022c70: 5d0a 0a20 2020 2020 2020 2066 6f72 2069  ]..        for i
+00022c80: 2069 6e20 7261 6e67 6528 6e65 775b 2741   in range(new['A
+00022c90: 5f4f 5244 4552 275d 2b31 293a 0a20 2020  _ORDER']+1):.   
+00022ca0: 2020 2020 2020 2020 2066 6f72 206a 2069           for j i
+00022cb0: 6e20 7261 6e67 6528 6e65 775b 2742 5f4f  n range(new['B_O
+00022cc0: 5244 4552 275d 2b31 293a 0a20 2020 2020  RDER']+1):.     
+00022cd0: 2020 2020 2020 2020 2020 2041 696a 2020             Aij  
+00022ce0: 3d20 6627 415f 7b69 7d5f 7b6a 7d27 0a20  = f'A_{i}_{j}'. 
+00022cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00022d00: 6620 4169 6a20 6e6f 7420 696e 206e 6577  f Aij not in new
+00022d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00022d20: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
+00022d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d40: 6e65 775b 6627 415f 7b69 7d5f 7b6a 7d27  new[f'A_{i}_{j}'
+00022d50: 5d20 3d20 6f72 6967 5b66 2742 5f7b 6a7d  ] = orig[f'B_{j}
+00022d60: 5f7b 697d 275d 2a28 2d31 292a 2a6a 0a20  _{i}']*(-1)**j. 
+00022d70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00022d80: 6577 5b66 2742 5f7b 697d 5f7b 6a7d 275d  ew[f'B_{i}_{j}']
+00022d90: 203d 206f 7269 675b 6627 415f 7b6a 7d5f   = orig[f'A_{j}_
+00022da0: 7b69 7d27 5d2a 282d 3129 2a2a 6a2a 2d31  {i}']*(-1)**j*-1
+00022db0: 0a0a 2020 2020 2020 2020 6e65 775f 7763  ..        new_wc
+00022dc0: 7320 3d20 6173 7472 6f70 792e 7763 732e  s = astropy.wcs.
+00022dd0: 5743 5328 6e65 772c 2072 656c 6178 3d54  WCS(new, relax=T
+00022de0: 7275 6529 0a20 2020 2020 2020 200a 2020  rue).        .  
+00022df0: 2020 2020 2020 6966 2063 6f6d 7061 7265        if compare
+00022e00: 3a0a 2020 2020 2020 2020 2020 2020 7872  :.            xr
+00022e10: 2c20 7972 203d 206e 6577 5f77 6373 2e61  , yr = new_wcs.a
+00022e20: 6c6c 5f77 6f72 6c64 3270 6978 282a 7264  ll_world2pix(*rd
+00022e30: 2c20 6978 290a 2020 2020 2020 2020 2020  , ix).          
+00022e40: 2020 786f 203d 2079 700a 2020 2020 2020    xo = yp.      
+00022e50: 2020 2020 2020 796f 203d 206f 7269 675b        yo = orig[
+00022e60: 274e 4158 4953 3127 5d20 2d20 7870 0a0a  'NAXIS1'] - xp..
+00022e70: 2020 2020 656c 6966 2072 6f74 2025 2034      elif rot % 4
+00022e80: 203d 3d20 333a 0a20 2020 2020 2020 2023   == 3:.        #
+00022e90: 2043 5720 3237 3020 6465 6720 3a20 7920   CW 270 deg : y 
+00022ea0: 3d20 782c 2078 203d 2028 6e79 202d 2075  = x, x = (ny - u
+00022eb0: 292c 2075 3d2d 762c 2076 3d75 0a20 2020  ), u=-v, v=u.   
+00022ec0: 2020 2020 2064 6573 6320 3d20 2778 3d6e       desc = 'x=n
+00022ed0: 792d 792c 2079 3d78 270a 0a20 2020 2020  y-y, y=x'..     
+00022ee0: 2020 206e 6577 5b27 4352 5049 5831 275d     new['CRPIX1']
+00022ef0: 203d 206f 7269 675b 274e 4158 4953 3227   = orig['NAXIS2'
+00022f00: 5d20 2d20 6f72 6967 5b27 4352 5049 5832  ] - orig['CRPIX2
+00022f10: 275d 202b 2031 0a20 2020 2020 2020 206e  '] + 1.        n
+00022f20: 6577 5b27 4352 5049 5832 275d 203d 206f  ew['CRPIX2'] = o
+00022f30: 7269 675b 2743 5250 4958 3127 5d0a 0a20  rig['CRPIX1'].. 
+00022f40: 2020 2020 2020 206e 6577 5b27 4344 315f         new['CD1_
+00022f50: 3127 5d20 3d20 2d6f 7269 675b 2743 4431  1'] = -orig['CD1
+00022f60: 5f32 275d 0a20 2020 2020 2020 206e 6577  _2'].        new
+00022f70: 5b27 4344 315f 3227 5d20 3d20 6f72 6967  ['CD1_2'] = orig
+00022f80: 5b27 4344 315f 3127 5d0a 2020 2020 2020  ['CD1_1'].      
+00022f90: 2020 6e65 775b 2743 4432 5f31 275d 203d    new['CD2_1'] =
+00022fa0: 202d 6f72 6967 5b27 4344 325f 3227 5d0a   -orig['CD2_2'].
+00022fb0: 2020 2020 2020 2020 6e65 775b 2743 4432          new['CD2
+00022fc0: 5f32 275d 203d 206f 7269 675b 2743 4432  _2'] = orig['CD2
+00022fd0: 5f31 275d 0a0a 2020 2020 2020 2020 666f  _1']..        fo
+00022fe0: 7220 6920 696e 2072 616e 6765 286e 6577  r i in range(new
+00022ff0: 5b27 415f 4f52 4445 5227 5d2b 3129 3a0a  ['A_ORDER']+1):.
+00023000: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00023010: 6a20 696e 2072 616e 6765 286e 6577 5b27  j in range(new['
+00023020: 425f 4f52 4445 5227 5d2b 3129 3a0a 2020  B_ORDER']+1):.  
+00023030: 2020 2020 2020 2020 2020 2020 2020 4169                Ai
+00023040: 6a20 203d 2066 2741 5f7b 697d 5f7b 6a7d  j  = f'A_{i}_{j}
+00023050: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00023060: 2020 6966 2041 696a 206e 6f74 2069 6e20    if Aij not in 
+00023070: 6e65 773a 0a20 2020 2020 2020 2020 2020  new:.           
+00023080: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+00023090: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+000230a0: 2020 206e 6577 5b66 2741 5f7b 697d 5f7b     new[f'A_{i}_{
+000230b0: 6a7d 275d 203d 206f 7269 675b 6627 425f  j}'] = orig[f'B_
+000230c0: 7b6a 7d5f 7b69 7d27 5d2a 282d 3129 2a2a  {j}_{i}']*(-1)**
+000230d0: 692a 2d31 0a20 2020 2020 2020 2020 2020  i*-1.           
+000230e0: 2020 2020 206e 6577 5b66 2742 5f7b 697d       new[f'B_{i}
+000230f0: 5f7b 6a7d 275d 203d 206f 7269 675b 6627  _{j}'] = orig[f'
+00023100: 415f 7b6a 7d5f 7b69 7d27 5d2a 282d 3129  A_{j}_{i}']*(-1)
+00023110: 2a2a 690a 0a20 2020 2020 2020 206e 6577  **i..        new
+00023120: 5f77 6373 203d 2061 7374 726f 7079 2e77  _wcs = astropy.w
+00023130: 6373 2e57 4353 286e 6577 2c20 7265 6c61  cs.WCS(new, rela
+00023140: 783d 5472 7565 290a 2020 2020 2020 2020  x=True).        
+00023150: 0a20 2020 2020 2020 2069 6620 636f 6d70  .        if comp
+00023160: 6172 653a 0a20 2020 2020 2020 2020 2020  are:.           
+00023170: 2078 722c 2079 7220 3d20 6e65 775f 7763   xr, yr = new_wc
+00023180: 732e 616c 6c5f 776f 726c 6432 7069 7828  s.all_world2pix(
+00023190: 2a72 642c 2069 7829 0a20 2020 2020 2020  *rd, ix).       
+000231a0: 2020 2020 2078 6f20 3d20 6f72 6967 5b27       xo = orig['
+000231b0: 4e41 5849 5332 275d 202d 2079 700a 2020  NAXIS2'] - yp.  
+000231c0: 2020 2020 2020 2020 2020 796f 203d 2078            yo = x
+000231d0: 700a 0a0a 2020 2020 656c 6966 2072 6f74  p...    elif rot
+000231e0: 2025 2034 203d 3d20 323a 0a20 2020 2020   % 4 == 2:.     
+000231f0: 2020 2023 2043 5720 3138 3020 6465 6720     # CW 180 deg 
+00023200: 3a20 783d 6e78 2d78 2c20 793d 6e79 2d79  : x=nx-x, y=ny-y
+00023210: 2c20 753d 2d75 2c20 763d 2d76 0a20 2020  , u=-u, v=-v.   
+00023220: 2020 2020 2064 6573 6320 3d20 2778 3d6e       desc = 'x=n
+00023230: 782d 782c 2079 3d6e 792d 7927 0a0a 2020  x-x, y=ny-y'..  
+00023240: 2020 2020 2020 6e65 775b 2743 5250 4958        new['CRPIX
+00023250: 3127 5d20 3d20 6f72 6967 5b27 4e41 5849  1'] = orig['NAXI
+00023260: 5331 275d 202d 206f 7269 675b 2743 5250  S1'] - orig['CRP
+00023270: 4958 3127 5d20 2b20 310a 2020 2020 2020  IX1'] + 1.      
+00023280: 2020 6e65 775b 2743 5250 4958 3227 5d20    new['CRPIX2'] 
+00023290: 3d20 6f72 6967 5b27 4e41 5849 5332 275d  = orig['NAXIS2']
+000232a0: 202d 206f 7269 675b 2743 5250 4958 3227   - orig['CRPIX2'
+000232b0: 5d20 2b20 310a 0a20 2020 2020 2020 206e  ] + 1..        n
+000232c0: 6577 5b27 4344 315f 3127 5d20 3d20 2d6f  ew['CD1_1'] = -o
+000232d0: 7269 675b 2743 4431 5f31 275d 0a20 2020  rig['CD1_1'].   
+000232e0: 2020 2020 206e 6577 5b27 4344 315f 3227       new['CD1_2'
+000232f0: 5d20 3d20 2d6f 7269 675b 2743 4431 5f32  ] = -orig['CD1_2
+00023300: 275d 0a20 2020 2020 2020 206e 6577 5b27  '].        new['
+00023310: 4344 325f 3127 5d20 3d20 2d6f 7269 675b  CD2_1'] = -orig[
+00023320: 2743 4432 5f31 275d 0a20 2020 2020 2020  'CD2_1'].       
+00023330: 206e 6577 5b27 4344 325f 3227 5d20 3d20   new['CD2_2'] = 
+00023340: 2d6f 7269 675b 2743 4432 5f32 275d 0a0a  -orig['CD2_2']..
+00023350: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+00023360: 2072 616e 6765 286e 6577 5b27 415f 4f52   range(new['A_OR
+00023370: 4445 5227 5d2b 3129 3a0a 2020 2020 2020  DER']+1):.      
+00023380: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
+00023390: 616e 6765 286e 6577 5b27 425f 4f52 4445  ange(new['B_ORDE
+000233a0: 5227 5d2b 3129 3a0a 2020 2020 2020 2020  R']+1):.        
+000233b0: 2020 2020 2020 2020 4169 6a20 203d 2066          Aij  = f
+000233c0: 2741 5f7b 697d 5f7b 6a7d 270a 2020 2020  'A_{i}_{j}'.    
+000233d0: 2020 2020 2020 2020 2020 2020 6966 2041              if A
+000233e0: 696a 206e 6f74 2069 6e20 6e65 773a 0a20  ij not in new:. 
+000233f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023400: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+00023410: 2020 2020 2020 2020 2020 2020 206e 6577               new
+00023420: 5b66 2741 5f7b 697d 5f7b 6a7d 275d 203d  [f'A_{i}_{j}'] =
+00023430: 206f 7269 675b 6627 415f 7b69 7d5f 7b6a   orig[f'A_{i}_{j
+00023440: 7d27 5d2a 282d 3129 2a2a 6a2a 282d 3129  }']*(-1)**j*(-1)
+00023450: 2a2a 692a 2d31 0a20 2020 2020 2020 2020  **i*-1.         
+00023460: 2020 2020 2020 206e 6577 5b66 2742 5f7b         new[f'B_{
+00023470: 697d 5f7b 6a7d 275d 203d 206f 7269 675b  i}_{j}'] = orig[
+00023480: 6627 425f 7b69 7d5f 7b6a 7d27 5d2a 282d  f'B_{i}_{j}']*(-
+00023490: 3129 2a2a 6a2a 282d 3129 2a2a 692a 2d31  1)**j*(-1)**i*-1
+000234a0: 0a0a 2020 2020 2020 2020 6e65 775f 7763  ..        new_wc
+000234b0: 7320 3d20 6173 7472 6f70 792e 7763 732e  s = astropy.wcs.
+000234c0: 5743 5328 6e65 772c 2072 656c 6178 3d54  WCS(new, relax=T
+000234d0: 7275 6529 0a20 2020 2020 2020 200a 2020  rue).        .  
+000234e0: 2020 2020 2020 6966 2063 6f6d 7061 7265        if compare
+000234f0: 3a0a 2020 2020 2020 2020 2020 2020 7872  :.            xr
+00023500: 2c20 7972 203d 206e 6577 5f77 6373 2e61  , yr = new_wcs.a
+00023510: 6c6c 5f77 6f72 6c64 3270 6978 282a 7264  ll_world2pix(*rd
+00023520: 2c20 6978 290a 2020 2020 2020 2020 2020  , ix).          
+00023530: 2020 786f 203d 206f 7269 675b 274e 4158    xo = orig['NAX
+00023540: 4953 3127 5d20 2d20 7870 0a20 2020 2020  IS1'] - xp.     
+00023550: 2020 2020 2020 2079 6f20 3d20 6f72 6967         yo = orig
+00023560: 5b27 4e41 5849 5332 275d 202d 2079 700a  ['NAXIS2'] - yp.
+00023570: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00023580: 2020 2320 726f 743d 302c 2064 6f20 6e6f    # rot=0, do no
+00023590: 7468 696e 670a 2020 2020 2020 2020 6465  thing.        de
+000235a0: 7363 203d 2027 783d 782c 2079 3d79 270a  sc = 'x=x, y=y'.
+000235b0: 2020 2020 2020 2020 6e65 775f 7763 7320          new_wcs 
+000235c0: 3d20 6f72 6967 5f77 6373 0a20 2020 2020  = orig_wcs.     
+000235d0: 2020 2069 6620 636f 6d70 6172 653a 0a20     if compare:. 
+000235e0: 2020 2020 2020 2020 2020 2078 6f20 3d20             xo = 
+000235f0: 7870 0a20 2020 2020 2020 2020 2020 2079  xp.            y
+00023600: 6f20 3d20 7970 0a20 2020 2020 2020 2020  o = yp.         
+00023610: 2020 2078 722c 2079 7220 3d20 6e65 775f     xr, yr = new_
+00023620: 7763 732e 616c 6c5f 776f 726c 6432 7069  wcs.all_world2pi
+00023630: 7828 2a72 642c 2069 7829 0a20 2020 2020  x(*rd, ix).     
+00023640: 2020 200a 2020 2020 6966 2076 6572 626f     .    if verbo
+00023650: 7365 3a0a 2020 2020 2020 2020 6966 2063  se:.        if c
+00023660: 6f6d 7061 7265 3a0a 2020 2020 2020 2020  ompare:.        
+00023670: 2020 2020 7872 6d73 203d 206e 6d61 6428      xrms = nmad(
+00023680: 7872 2d78 6f29 0a20 2020 2020 2020 2020  xr-xo).         
+00023690: 2020 2079 726d 7320 3d20 6e6d 6164 2879     yrms = nmad(y
+000236a0: 722d 796f 290a 2020 2020 2020 2020 2020  r-yo).          
+000236b0: 2020 7072 696e 7428 6627 526f 7439 303a    print(f'Rot90:
+000236c0: 207b 726f 747d 2072 6d73 3d7b 7872 6d73   {rot} rms={xrms
+000236d0: 3a2e 3265 7d20 7b79 726d 733a 2e32 657d  :.2e} {yrms:.2e}
+000236e0: 2729 0a20 2020 2020 2020 2020 2020 200a  ').            .
+000236f0: 2020 2020 6966 2063 6f6d 7061 7265 3a0a      if compare:.
+00023700: 2020 2020 2020 2020 6669 672c 2061 7865          fig, axe
+00023710: 7320 3d20 706c 742e 7375 6270 6c6f 7473  s = plt.subplots
+00023720: 2831 2c32 2c66 6967 7369 7a65 3d28 3130  (1,2,figsize=(10
+00023730: 2c35 292c 2073 6861 7265 783d 5472 7565  ,5), sharex=True
+00023740: 2c20 7368 6172 6579 3d54 7275 6529 0a20  , sharey=True). 
+00023750: 2020 2020 2020 2061 7865 735b 305d 2e73         axes[0].s
+00023760: 6361 7474 6572 2878 702c 2078 722d 786f  catter(xp, xr-xo
+00023770: 290a 2020 2020 2020 2020 6178 6573 5b30  ).        axes[0
+00023780: 5d2e 7365 745f 786c 6162 656c 2827 6478  ].set_xlabel('dx
+00023790: 2729 0a20 2020 2020 2020 2061 7865 735b  ').        axes[
+000237a0: 315d 2e73 6361 7474 6572 2879 702c 2079  1].scatter(yp, y
+000237b0: 722d 796f 290a 2020 2020 2020 2020 6178  r-yo).        ax
+000237c0: 6573 5b31 5d2e 7365 745f 786c 6162 656c  es[1].set_xlabel
+000237d0: 2827 6479 2729 0a20 2020 2020 2020 2066  ('dy').        f
+000237e0: 6f72 2061 7820 696e 2061 7865 733a 0a20  or ax in axes:. 
+000237f0: 2020 2020 2020 2020 2020 2061 782e 6772             ax.gr
+00023800: 6964 2829 0a20 2020 2020 2020 200a 2020  id().        .  
+00023810: 2020 2020 2020 6669 672e 7469 6768 745f        fig.tight_
+00023820: 6c61 796f 7574 2870 6164 3d30 2e35 290a  layout(pad=0.5).
+00023830: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
+00023840: 6e65 772c 206e 6577 5f77 6373 2c20 6465  new, new_wcs, de
+00023850: 7363 0a0a 0a64 6566 2067 6574 5f77 6373  sc...def get_wcs
+00023860: 5f73 6c69 6365 5f68 6561 6465 7228 7763  _slice_header(wc
+00023870: 732c 2073 6c78 2c20 736c 7929 3a0a 2020  s, slx, sly):.  
+00023880: 2020 2222 2254 4244 0a20 2020 2022 2222    """TBD.    """
+00023890: 0a20 2020 2023 736c 782c 2073 6c79 203d  .    #slx, sly =
+000238a0: 2073 6c69 6365 2831 3237 392c 2031 3434   slice(1279, 144
+000238b0: 3529 2c20 736c 6963 6528 3236 3635 2c32  5), slice(2665,2
+000238c0: 3831 3329 0a20 2020 2068 203d 2077 6373  813).    h = wcs
+000238d0: 2e73 6c69 6365 2828 736c 792c 2073 6c78  .slice((sly, slx
+000238e0: 2929 2e74 6f5f 6865 6164 6572 2872 656c  )).to_header(rel
+000238f0: 6178 3d54 7275 6529 0a20 2020 2068 5b27  ax=True).    h['
+00023900: 4e41 5849 5327 5d20 3d20 320a 2020 2020  NAXIS'] = 2.    
+00023910: 685b 274e 4158 4953 3127 5d20 3d20 736c  h['NAXIS1'] = sl
+00023920: 782e 7374 6f70 2d73 6c78 2e73 7461 7274  x.stop-slx.start
+00023930: 0a20 2020 2068 5b27 4e41 5849 5332 275d  .    h['NAXIS2']
+00023940: 203d 2073 6c79 2e73 746f 702d 736c 792e   = sly.stop-sly.
+00023950: 7374 6172 740a 2020 2020 666f 7220 6b20  start.    for k 
+00023960: 696e 2068 3a0a 2020 2020 2020 2020 6966  in h:.        if
+00023970: 206b 2e73 7461 7274 7377 6974 6828 2750   k.startswith('P
+00023980: 4327 293a 0a20 2020 2020 2020 2020 2020  C'):.           
+00023990: 2068 2e72 656e 616d 655f 6b65 7977 6f72   h.rename_keywor
+000239a0: 6428 6b2c 206b 2e72 6570 6c61 6365 2827  d(k, k.replace('
+000239b0: 5043 272c 2027 4344 2729 290a 0a20 2020  PC', 'CD'))..   
+000239c0: 2072 6574 7572 6e20 680a 0a0a 6465 6620   return h...def 
+000239d0: 6765 745f 636f 6d6d 6f6e 5f73 6c69 6365  get_common_slice
+000239e0: 7328 615f 6f72 6967 696e 2c20 615f 7368  s(a_origin, a_sh
+000239f0: 6170 652c 2062 5f6f 7269 6769 6e2c 2062  ape, b_origin, b
+00023a00: 5f73 6861 7065 293a 0a20 2020 2022 2222  _shape):.    """
+00023a10: 0a20 2020 2047 6574 2073 6c69 6365 7320  .    Get slices 
+00023a20: 6f66 206f 7665 726c 6170 7320 6265 7477  of overlaps betw
+00023a30: 6565 6e20 7477 6f20 7265 6374 616e 6775  een two rectangu
+00023a40: 6c61 7220 6772 6964 730a 2020 2020 2222  lar grids.    ""
+00023a50: 220a 0a20 2020 206c 6c20 3d20 6e70 2e6d  "..    ll = np.m
+00023a60: 696e 285b 615f 6f72 6967 696e 2c20 625f  in([a_origin, b_
+00023a70: 6f72 6967 696e 5d2c 2061 7869 733d 3029  origin], axis=0)
+00023a80: 0a20 2020 2075 7220 3d20 6e70 2e6d 6178  .    ur = np.max
+00023a90: 285b 615f 6f72 6967 696e 2b61 5f73 6861  ([a_origin+a_sha
+00023aa0: 7065 2c20 625f 6f72 6967 696e 2b62 5f73  pe, b_origin+b_s
+00023ab0: 6861 7065 5d2c 2061 7869 733d 3029 0a0a  hape], axis=0)..
+00023ac0: 2020 2020 2320 6f74 6865 7220 696e 2073      # other in s
+00023ad0: 656c 660a 2020 2020 6c6c 7320 3d20 6e70  elf.    lls = np
+00023ae0: 2e6d 696e 696d 756d 2862 5f6f 7269 6769  .minimum(b_origi
+00023af0: 6e20 2d20 6c6c 2c20 615f 7368 6170 6529  n - ll, a_shape)
+00023b00: 0a20 2020 2075 7273 203d 206e 702e 636c  .    urs = np.cl
+00023b10: 6970 2862 5f6f 7269 6769 6e20 2b20 625f  ip(b_origin + b_
+00023b20: 7368 6170 6520 2d20 615f 6f72 6967 696e  shape - a_origin
+00023b30: 2c20 5b30 2c20 305d 2c20 615f 7368 6170  , [0, 0], a_shap
+00023b40: 6529 0a0a 2020 2020 2320 7365 6c66 2069  e)..    # self i
+00023b50: 6e20 6f74 6865 720a 2020 2020 6c6c 6f20  n other.    llo 
+00023b60: 3d20 6e70 2e6d 696e 696d 756d 2861 5f6f  = np.minimum(a_o
+00023b70: 7269 6769 6e20 2d20 6c6c 2c20 625f 7368  rigin - ll, b_sh
+00023b80: 6170 6529 0a20 2020 2075 726f 203d 206e  ape).    uro = n
+00023b90: 702e 636c 6970 2861 5f6f 7269 6769 6e20  p.clip(a_origin 
+00023ba0: 2b20 615f 7368 6170 6520 2d20 625f 6f72  + a_shape - b_or
+00023bb0: 6967 696e 2c20 5b30 2c20 305d 2c20 625f  igin, [0, 0], b_
+00023bc0: 7368 6170 6529 0a0a 2020 2020 615f 736c  shape)..    a_sl
+00023bd0: 6963 6520 3d20 2873 6c69 6365 286c 6c73  ice = (slice(lls
+00023be0: 5b30 5d2c 2075 7273 5b30 5d29 2c20 736c  [0], urs[0]), sl
+00023bf0: 6963 6528 6c6c 735b 315d 2c20 7572 735b  ice(lls[1], urs[
+00023c00: 315d 2929 0a20 2020 2062 5f73 6c69 6365  1])).    b_slice
+00023c10: 203d 2028 736c 6963 6528 6c6c 6f5b 305d   = (slice(llo[0]
+00023c20: 2c20 7572 6f5b 305d 292c 2073 6c69 6365  , uro[0]), slice
+00023c30: 286c 6c6f 5b31 5d2c 2075 726f 5b31 5d29  (llo[1], uro[1])
+00023c40: 290a 2020 2020 7265 7475 726e 2061 5f73  ).    return a_s
+00023c50: 6c69 6365 2c20 625f 736c 6963 650a 0a0a  lice, b_slice...
+00023c60: 636c 6173 7320 5743 5346 6f6f 7470 7269  class WCSFootpri
+00023c70: 6e74 286f 626a 6563 7429 3a0a 2020 2020  nt(object):.    
+00023c80: 2222 220a 2020 2020 4865 6c70 6572 2066  """.    Helper f
+00023c90: 756e 6374 696f 6e73 2066 6f72 2064 6561  unctions for dea
+00023ca0: 6c69 6e67 2077 6974 6820 5743 5320 666f  ling with WCS fo
+00023cb0: 6f74 7072 696e 7473 0a20 2020 2022 2222  otprints.    """
+00023cc0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00023cd0: 5f5f 2873 656c 662c 2077 6373 2c20 6578  __(self, wcs, ex
+00023ce0: 743d 312c 206c 6162 656c 3d4e 6f6e 6529  t=1, label=None)
+00023cf0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+00023d00: 6e73 7461 6e63 6528 7763 732c 2070 7977  nstance(wcs, pyw
+00023d10: 6373 2e57 4353 293a 0a20 2020 2020 2020  cs.WCS):.       
+00023d20: 2020 2020 2073 656c 662e 7763 7320 3d20       self.wcs = 
+00023d30: 7763 732e 6465 6570 636f 7079 2829 0a20  wcs.deepcopy(). 
+00023d40: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00023d50: 7420 6861 7361 7474 7228 7365 6c66 2e77  t hasattr(self.w
+00023d60: 6373 2c20 2770 6978 656c 5f73 6861 7065  cs, 'pixel_shape
+00023d70: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00023d80: 2020 2020 7365 6c66 2e77 6373 2e70 6978      self.wcs.pix
+00023d90: 656c 5f73 6861 7065 203d 204e 6f6e 650a  el_shape = None.
+00023da0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00023db0: 7365 6c66 2e77 6373 2e70 6978 656c 5f73  self.wcs.pixel_s
+00023dc0: 6861 7065 2069 7320 4e6f 6e65 3a0a 2020  hape is None:.  
+00023dd0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00023de0: 6c66 2e77 6373 2e70 6978 656c 5f73 6861  lf.wcs.pixel_sha
+00023df0: 7065 203d 205b 696e 7428 702a 3229 2066  pe = [int(p*2) f
+00023e00: 6f72 2070 2069 6e20 7365 6c66 2e77 6373  or p in self.wcs
+00023e10: 2e77 6373 2e63 7270 6978 5d0a 2020 2020  .wcs.crpix].    
+00023e20: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00023e30: 6e63 6528 7763 732c 2073 7472 293a 0a20  nce(wcs, str):. 
+00023e40: 2020 2020 2020 2020 2020 2068 6475 203d             hdu =
+00023e50: 2070 7966 6974 732e 6f70 656e 2877 6373   pyfits.open(wcs
+00023e60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00023e70: 206c 656e 2868 6475 2920 3d3d 2031 3a0a   len(hdu) == 1:.
+00023e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e90: 6578 7420 3d20 300a 0a20 2020 2020 2020  ext = 0..       
+00023ea0: 2020 2020 2073 656c 662e 6164 645f 6e61       self.add_na
+00023eb0: 7869 7328 6864 755b 6578 745d 2e68 6561  xis(hdu[ext].hea
+00023ec0: 6465 7229 0a20 2020 2020 2020 2020 2020  der).           
+00023ed0: 2074 6865 5f77 6373 203d 2070 7977 6373   the_wcs = pywcs
+00023ee0: 2e57 4353 2868 6475 5b65 7874 5d2e 6865  .WCS(hdu[ext].he
+00023ef0: 6164 6572 2c20 666f 626a 3d68 6475 290a  ader, fobj=hdu).
+00023f00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00023f10: 2e77 6373 203d 2074 6865 5f77 6373 0a20  .wcs = the_wcs. 
+00023f20: 2020 2020 2020 2020 2020 2068 6475 2e63             hdu.c
+00023f30: 6c6f 7365 2829 0a20 2020 2020 2020 2020  lose().         
+00023f40: 2020 200a 2020 2020 2020 2020 656c 6966     .        elif
+00023f50: 2069 7369 6e73 7461 6e63 6528 7763 732c   isinstance(wcs,
+00023f60: 2070 7966 6974 732e 4844 554c 6973 7429   pyfits.HDUList)
+00023f70: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00023f80: 206c 656e 2877 6373 2920 3d3d 2031 3a0a   len(wcs) == 1:.
+00023f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023fa0: 6578 7420 3d20 300a 2020 2020 2020 2020  ext = 0.        
+00023fb0: 2020 2020 7365 6c66 2e61 6464 5f6e 6178      self.add_nax
+00023fc0: 6973 2877 6373 5b65 7874 5d2e 6865 6164  is(wcs[ext].head
+00023fd0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00023fe0: 7468 655f 7763 7320 3d20 7079 7763 732e  the_wcs = pywcs.
+00023ff0: 5743 5328 7763 735b 6578 745d 2e68 6561  WCS(wcs[ext].hea
+00024000: 6465 722c 2066 6f62 6a3d 7763 7329 0a20  der, fobj=wcs). 
+00024010: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00024020: 7763 7320 3d20 7468 655f 7763 730a 2020  wcs = the_wcs.  
+00024030: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00024040: 2020 2020 2020 2020 7072 696e 7428 2757          print('W
+00024050: 4353 2063 6c61 7373 206e 6f74 2072 6563  CS class not rec
+00024060: 6f67 6e69 7a65 643a 207b 307d 272e 666f  ognized: {0}'.fo
+00024070: 726d 6174 2877 6373 2e5f 5f63 6c61 7373  rmat(wcs.__class
+00024080: 5f5f 2929 0a20 2020 2020 2020 2020 2020  __)).           
+00024090: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000240a0: 720a 0a20 2020 2020 2020 2073 656c 662e  r..        self.
+000240b0: 6670 203d 2073 656c 662e 7763 732e 6361  fp = self.wcs.ca
+000240c0: 6c63 5f66 6f6f 7470 7269 6e74 2829 0a20  lc_footprint(). 
+000240d0: 2020 2020 2020 2073 656c 662e 636f 7364         self.cosd
+000240e0: 6563 203d 206e 702e 636f 7328 7365 6c66  ec = np.cos(self
+000240f0: 2e66 705b 302c 2031 5d2f 3138 302a 6e70  .fp[0, 1]/180*np
+00024100: 2e70 6929 0a20 2020 2020 2020 2073 656c  .pi).        sel
+00024110: 662e 6c61 6265 6c20 3d20 6c61 6265 6c0a  f.label = label.
+00024120: 2020 2020 2020 2020 7365 6c66 2e70 6978          self.pix
+00024130: 656c 5f73 6361 6c65 203d 2067 6574 5f77  el_scale = get_w
+00024140: 6373 5f70 7363 616c 6528 7365 6c66 2e77  cs_pscale(self.w
+00024150: 6373 290a 0a20 2020 2040 7072 6f70 6572  cs)..    @proper
+00024160: 7479 0a20 2020 2064 6566 2063 656e 7472  ty.    def centr
+00024170: 6f69 6428 7365 6c66 293a 0a20 2020 2020  oid(self):.     
+00024180: 2020 2072 6574 7572 6e20 6e70 2e6d 6561     return np.mea
+00024190: 6e28 7365 6c66 2e66 702c 2061 7869 733d  n(self.fp, axis=
+000241a0: 3029 0a0a 0a20 2020 2040 7072 6f70 6572  0)...    @proper
+000241b0: 7479 0a20 2020 2064 6566 2070 6174 6828  ty.    def path(
+000241c0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+000241d0: 2222 0a20 2020 2020 2020 2060 7e6d 6174  "".        `~mat
+000241e0: 706c 6f74 6c69 622e 7061 7468 2e50 6174  plotlib.path.Pat
+000241f0: 6860 206f 626a 6563 740a 2020 2020 2020  h` object.      
+00024200: 2020 2222 220a 2020 2020 2020 2020 696d    """.        im
+00024210: 706f 7274 206d 6174 706c 6f74 6c69 622e  port matplotlib.
+00024220: 7061 7468 0a20 2020 2020 2020 2072 6574  path.        ret
+00024230: 7572 6e20 6d61 7470 6c6f 746c 6962 2e70  urn matplotlib.p
+00024240: 6174 682e 5061 7468 2873 656c 662e 6670  ath.Path(self.fp
+00024250: 290a 0a0a 2020 2020 4070 726f 7065 7274  )...    @propert
+00024260: 790a 2020 2020 6465 6620 706f 6c79 676f  y.    def polygo
+00024270: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+00024280: 2022 2222 0a20 2020 2020 2020 2060 7e73   """.        `~s
+00024290: 6861 7065 6c79 2e67 656f 6d65 7472 792e  hapely.geometry.
+000242a0: 506f 6c79 676f 6e60 206f 626a 6563 742e  Polygon` object.
+000242b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000242c0: 2020 2020 2066 726f 6d20 7368 6170 656c       from shapel
+000242d0: 792e 6765 6f6d 6574 7279 2069 6d70 6f72  y.geometry impor
+000242e0: 7420 506f 6c79 676f 6e0a 2020 2020 2020  t Polygon.      
+000242f0: 2020 7265 7475 726e 2050 6f6c 7967 6f6e    return Polygon
+00024300: 2873 656c 662e 6670 290a 0a0a 2020 2020  (self.fp)...    
+00024310: 6465 6620 6765 745f 7061 7463 6828 7365  def get_patch(se
+00024320: 6c66 2c20 2a2a 6b77 6172 6773 293a 0a20  lf, **kwargs):. 
+00024330: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00024340: 2020 2060 7e6d 6174 706c 6f74 6c69 622e     `~matplotlib.
+00024350: 7061 6368 2e50 6174 6850 6174 6368 6020  pach.PathPatch` 
+00024360: 6f62 6a65 6374 0a20 2020 2020 2020 2022  object.        "
+00024370: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00024380: 6e20 7061 7463 685f 6672 6f6d 5f70 6f6c  n patch_from_pol
+00024390: 7967 6f6e 2873 656c 662e 706f 6c79 676f  ygon(self.polygo
+000243a0: 6e2c 202a 2a6b 7761 7267 7329 0a0a 0a20  n, **kwargs)... 
+000243b0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+000243c0: 2064 6566 2072 6567 696f 6e28 7365 6c66   def region(self
+000243d0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+000243e0: 2020 2020 2020 2050 6f6c 7967 6f6e 2073         Polygon s
+000243f0: 7472 696e 6720 696e 2044 5339 2072 6567  tring in DS9 reg
+00024400: 696f 6e20 666f 726d 6174 0a20 2020 2020  ion format.     
+00024410: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00024420: 6574 7572 6e20 2770 6f6c 7967 6f6e 287b  eturn 'polygon({
+00024430: 307d 2927 2e66 6f72 6d61 7428 272c 272e  0})'.format(','.
+00024440: 6a6f 696e 285b 277b 303a 2e36 667d 272e  join(['{0:.6f}'.
+00024450: 666f 726d 6174 2863 2920 666f 7220 6320  format(c) for c 
+00024460: 696e 2073 656c 662e 6670 2e66 6c61 7474  in self.fp.flatt
+00024470: 656e 2829 5d29 290a 0a0a 2020 2020 4073  en()]))...    @s
+00024480: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00024490: 6465 6620 6164 645f 6e61 7869 7328 6865  def add_naxis(he
+000244a0: 6164 6572 293a 0a20 2020 2020 2020 2022  ader):.        "
+000244b0: 2222 0a20 2020 2020 2020 2049 6620 4e41  "".        If NA
+000244c0: 5849 5320 6b65 7977 6f72 6473 206e 6f74  XIS keywords not
+000244d0: 2066 6f75 6e64 2069 6e20 616e 2069 6d61   found in an ima
+000244e0: 6765 2068 6561 6465 722c 2061 7373 756d  ge header, assum
+000244f0: 6520 7468 6520 7061 7265 6e74 0a20 2020  e the parent.   
+00024500: 2020 2020 2069 6d61 6765 2064 696d 656e       image dimen
+00024510: 7369 6f6e 7320 6172 6520 322a 4352 5049  sions are 2*CRPI
+00024520: 580a 2020 2020 2020 2020 2222 220a 2020  X.        """.  
+00024530: 2020 2020 2020 666f 7220 6920 696e 205b        for i in [
+00024540: 312c 2032 5d3a 0a20 2020 2020 2020 2020  1, 2]:.         
+00024550: 2020 2069 6620 274e 4158 4953 7b30 7d27     if 'NAXIS{0}'
+00024560: 2e66 6f72 6d61 7428 6929 206e 6f74 2069  .format(i) not i
+00024570: 6e20 6865 6164 6572 3a0a 2020 2020 2020  n header:.      
+00024580: 2020 2020 2020 2020 2020 6865 6164 6572            header
+00024590: 5b27 4e41 5849 537b 307d 272e 666f 726d  ['NAXIS{0}'.form
+000245a0: 6174 2869 295d 203d 2069 6e74 2868 6561  at(i)] = int(hea
+000245b0: 6465 725b 2743 5250 4958 7b30 7d27 2e66  der['CRPIX{0}'.f
+000245c0: 6f72 6d61 7428 6929 5d2a 3229 0a0a 0a64  ormat(i)]*2)...d
+000245d0: 6566 2072 6570 726f 6a65 6374 5f66 6173  ef reproject_fas
+000245e0: 7465 7228 696e 7075 745f 6864 752c 206f  ter(input_hdu, o
+000245f0: 7574 7075 742c 2070 6164 3d31 302c 202a  utput, pad=10, *
+00024600: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+00024610: 2253 7065 6564 2075 7020 6072 6570 726f  "Speed up `repro
+00024620: 6a65 6374 6020 6d6f 6475 6c65 2077 6974  ject` module wit
+00024630: 6820 6172 7261 7920 736c 6963 6573 206f  h array slices o
+00024640: 6620 7468 6520 696e 7075 7420 696d 6167  f the input imag
+00024650: 650a 0a20 2020 2050 6172 616d 6574 6572  e..    Parameter
+00024660: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00024670: 0a20 2020 2069 6e70 7574 5f68 6475 203a  .    input_hdu :
+00024680: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
+00024690: 7473 2e49 6d61 6765 4844 5560 0a20 2020  ts.ImageHDU`.   
+000246a0: 2020 2020 2049 6e70 7574 2069 6d61 6765       Input image
+000246b0: 2048 4455 2074 6f20 7265 7072 6f6a 6563   HDU to reprojec
+000246c0: 742e 0a0a 2020 2020 6f75 7470 7574 203a  t...    output :
+000246d0: 2060 7e61 7374 726f 7079 2e77 6373 2e57   `~astropy.wcs.W
+000246e0: 4353 6020 6f72 2060 7e61 7374 726f 7079  CS` or `~astropy
+000246f0: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
+00024700: 0a20 2020 2020 2020 204f 7574 7075 7420  .        Output 
+00024710: 6672 616d 6520 6465 6669 6e69 7469 6f6e  frame definition
+00024720: 2e0a 0a20 2020 2070 6164 203a 2069 6e74  ...    pad : int
+00024730: 0a20 2020 2020 2020 2050 6978 656c 2070  .        Pixel p
+00024740: 6164 6469 6e67 206f 6e20 736c 6963 6573  adding on slices
+00024750: 2063 7574 2066 726f 6d20 7468 6520 6069   cut from the `i
+00024760: 6e70 7574 5f68 6475 602e 0a0a 2020 2020  nput_hdu`...    
+00024770: 6b77 6172 6773 203a 2064 6963 740a 2020  kwargs : dict.  
+00024780: 2020 2020 2020 4172 6775 6d65 6e74 7320        Arguments 
+00024790: 7061 7373 6564 2074 6872 6f75 6768 2074  passed through t
+000247a0: 6f20 607e 7265 7072 6f6a 6563 742e 7265  o `~reproject.re
+000247b0: 7072 6f6a 6563 745f 696e 7465 7270 602e  project_interp`.
+000247c0: 2020 466f 720a 2020 2020 2020 2020 6578    For.        ex
+000247d0: 616d 706c 652c 2060 6f72 6465 723d 276e  ample, `order='n
+000247e0: 6561 7265 7374 2d6e 6569 6768 626f 7227  earest-neighbor'
+000247f0: 602e 0a0a 2020 2020 5265 7475 726e 730a  `...    Returns.
+00024800: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00024810: 7265 7072 6f6a 6563 7465 6420 3a20 607e  reprojected : `~
+00024820: 6e75 6d70 792e 6e64 6172 7261 7960 0a20  numpy.ndarray`. 
+00024830: 2020 2020 2020 2052 6570 726f 6a65 6374         Reproject
+00024840: 6564 2064 6174 6120 6672 6f6d 2060 696e  ed data from `in
+00024850: 7075 745f 6864 7560 2e0a 0a20 2020 2066  put_hdu`...    f
+00024860: 6f6f 7470 7269 6e74 203a 2060 7e6e 756d  ootprint : `~num
+00024870: 7079 2e6e 6461 7272 6179 600a 2020 2020  py.ndarray`.    
+00024880: 2020 2020 466f 6f74 7072 696e 7420 6f66      Footprint of
+00024890: 2074 6865 2069 6e70 7574 2061 7272 6179   the input array
+000248a0: 2069 6e20 7468 6520 6f75 7470 7574 2066   in the output f
+000248b0: 7261 6d65 2e0a 0a20 2020 204e 6f74 6573  rame...    Notes
+000248c0: 0a20 2020 202d 2d2d 2d2d 0a0a 2020 2020  .    -----..    
+000248d0: 6072 6570 726f 6a65 6374 2720 6973 2061  `reproject' is a
+000248e0: 6e20 6173 7472 6f70 792d 636f 6d70 6174  n astropy-compat
+000248f0: 6962 6c65 206d 6f64 756c 6520 7468 6174  ible module that
+00024900: 2063 616e 2062 6520 696e 7374 616c 6c65   can be installe
+00024910: 6420 7769 7468 0a20 2020 2060 7069 7060  d with.    `pip`
+00024920: 2e20 2053 6565 2068 7474 7073 3a2f 2f72  .  See https://r
+00024930: 6570 726f 6a65 6374 2e72 6561 6474 6865  eproject.readthe
+00024940: 646f 6373 2e69 6f2e 0a20 2020 2022 2222  docs.io..    """
+00024950: 0a20 2020 2069 6d70 6f72 7420 7265 7072  .    import repr
+00024960: 6f6a 6563 740a 0a20 2020 2023 204f 7574  oject..    # Out
+00024970: 7075 7420 5743 530a 2020 2020 6966 2069  put WCS.    if i
+00024980: 7369 6e73 7461 6e63 6528 6f75 7470 7574  sinstance(output
+00024990: 2c20 7079 7763 732e 5743 5329 3a0a 2020  , pywcs.WCS):.  
+000249a0: 2020 2020 2020 6f75 745f 7763 7320 3d20        out_wcs = 
+000249b0: 6f75 7470 7574 0a20 2020 2065 6c73 653a  output.    else:
+000249c0: 0a20 2020 2020 2020 206f 7574 5f77 6373  .        out_wcs
+000249d0: 203d 2070 7977 6373 2e57 4353 286f 7574   = pywcs.WCS(out
+000249e0: 7075 742c 2072 656c 6178 3d54 7275 6529  put, relax=True)
+000249f0: 0a0a 2020 2020 6966 2027 5349 5027 2069  ..    if 'SIP' i
+00024a00: 6e20 6f75 745f 7763 732e 7763 732e 6374  n out_wcs.wcs.ct
+00024a10: 7970 655b 305d 3a0a 2020 2020 2020 2020  ype[0]:.        
+00024a20: 7072 696e 7428 2757 6172 6e69 6e67 3a20  print('Warning: 
+00024a30: 6072 6570 726f 6a65 6374 6020 646f 6573  `reproject` does
+00024a40: 6e5c 2774 2061 7070 6561 7220 746f 2073  n\'t appear to s
+00024a50: 7570 706f 7274 2053 4950 2070 726f 6a65  upport SIP proje
+00024a60: 6374 696f 6e27 290a 0a20 2020 2023 2043  ction')..    # C
+00024a70: 6f6d 7075 7465 2070 6978 656c 2063 6f6f  ompute pixel coo
+00024a80: 7264 696e 6174 6573 206f 6620 7468 6520  rdinates of the 
+00024a90: 6f75 7470 7574 2066 7261 6d65 2063 6f72  output frame cor
+00024aa0: 6e65 7273 2069 6e20 7468 6520 696e 7075  ners in the inpu
+00024ab0: 7420 696d 6167 650a 2020 2020 696e 7075  t image.    inpu
+00024ac0: 745f 7763 7320 3d20 7079 7763 732e 5743  t_wcs = pywcs.WC
+00024ad0: 5328 696e 7075 745f 6864 752e 6865 6164  S(input_hdu.head
+00024ae0: 6572 2c20 7265 6c61 783d 5472 7565 290a  er, relax=True).
+00024af0: 2020 2020 6f75 745f 6670 203d 206f 7574      out_fp = out
+00024b00: 5f77 6373 2e63 616c 635f 666f 6f74 7072  _wcs.calc_footpr
+00024b10: 696e 7428 290a 2020 2020 696e 7075 745f  int().    input_
+00024b20: 7879 203d 2069 6e70 7574 5f77 6373 2e61  xy = input_wcs.a
+00024b30: 6c6c 5f77 6f72 6c64 3270 6978 286f 7574  ll_world2pix(out
+00024b40: 5f66 702c 2030 290a 2020 2020 736c 7820  _fp, 0).    slx 
+00024b50: 3d20 736c 6963 6528 696e 7428 696e 7075  = slice(int(inpu
+00024b60: 745f 7879 5b3a 2c20 305d 2e6d 696e 2829  t_xy[:, 0].min()
+00024b70: 292d 7061 642c 2069 6e74 2869 6e70 7574  )-pad, int(input
+00024b80: 5f78 795b 3a2c 2030 5d2e 6d61 7828 2929  _xy[:, 0].max())
+00024b90: 2b70 6164 290a 2020 2020 736c 7920 3d20  +pad).    sly = 
+00024ba0: 736c 6963 6528 696e 7428 696e 7075 745f  slice(int(input_
+00024bb0: 7879 5b3a 2c20 315d 2e6d 696e 2829 292d  xy[:, 1].min())-
+00024bc0: 7061 642c 2069 6e74 2869 6e70 7574 5f78  pad, int(input_x
+00024bd0: 795b 3a2c 2031 5d2e 6d61 7828 2929 2b70  y[:, 1].max())+p
+00024be0: 6164 290a 0a20 2020 2023 204d 616b 6520  ad)..    # Make 
+00024bf0: 7468 6520 6375 746f 7574 0a20 2020 2073  the cutout.    s
+00024c00: 7562 5f64 6174 6120 3d20 696e 7075 745f  ub_data = input_
+00024c10: 6864 752e 6461 7461 5b73 6c79 2c20 736c  hdu.data[sly, sl
+00024c20: 785d 0a20 2020 2073 7562 5f68 6561 6465  x].    sub_heade
+00024c30: 7220 3d20 6765 745f 7763 735f 736c 6963  r = get_wcs_slic
+00024c40: 655f 6865 6164 6572 2869 6e70 7574 5f77  e_header(input_w
+00024c50: 6373 2c20 736c 782c 2073 6c79 290a 2020  cs, slx, sly).  
+00024c60: 2020 7375 625f 6864 7520 3d20 7079 6669    sub_hdu = pyfi
+00024c70: 7473 2e50 7269 6d61 7279 4844 5528 6461  ts.PrimaryHDU(da
+00024c80: 7461 3d73 7562 5f64 6174 612c 2068 6561  ta=sub_data, hea
+00024c90: 6465 723d 7375 625f 6865 6164 6572 290a  der=sub_header).
+00024ca0: 0a20 2020 2023 2047 6574 2074 6865 2072  .    # Get the r
+00024cb0: 6570 726f 6a65 6374 696f 6e0a 2020 2020  eprojection.    
+00024cc0: 7365 675f 692c 2066 705f 6920 3d20 7265  seg_i, fp_i = re
+00024cd0: 7072 6f6a 6563 742e 7265 7072 6f6a 6563  project.reprojec
+00024ce0: 745f 696e 7465 7270 2873 7562 5f68 6475  t_interp(sub_hdu
+00024cf0: 2c20 6f75 7470 7574 2c20 2a2a 6b77 6172  , output, **kwar
+00024d00: 6773 290a 2020 2020 7265 7475 726e 2073  gs).    return s
+00024d10: 6567 5f69 2e61 7374 7970 6528 7375 625f  eg_i.astype(sub_
+00024d20: 6461 7461 2e64 7479 7065 292c 2066 705f  data.dtype), fp_
+00024d30: 692e 6173 7479 7065 286e 702e 7569 6e74  i.astype(np.uint
+00024d40: 3829 0a0a 0a64 6566 2066 756c 6c5f 7370  8)...def full_sp
+00024d50: 6563 7472 756d 5f77 6373 6865 6164 6572  ectrum_wcsheader
+00024d60: 2863 656e 7465 725f 7761 7665 3d31 2e34  (center_wave=1.4
+00024d70: 6534 2c20 646c 616d 3d34 302c 204e 583d  e4, dlam=40, NX=
+00024d80: 3130 302c 2073 7061 7469 616c 5f73 6361  100, spatial_sca
+00024d90: 6c65 3d31 2c20 4e59 3d31 3029 3a0a 2020  le=1, NY=10):.  
+00024da0: 2020 2222 224d 616b 6520 6120 5743 5320    """Make a WCS 
+00024db0: 6865 6164 6572 2066 6f72 2061 2032 4420  header for a 2D 
+00024dc0: 7370 6563 7472 756d 0a0a 2020 2020 5061  spectrum..    Pa
+00024dd0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00024de0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6365 6e74  -------.    cent
+00024df0: 6572 5f77 6176 6520 3a20 666c 6f61 740a  er_wave : float.
+00024e00: 2020 2020 2020 2020 5761 7665 6c65 6e67          Waveleng
+00024e10: 7468 206f 6620 7468 6520 6365 6e74 7261  th of the centra
+00024e20: 6c20 7069 7865 6c2c 2069 6e20 416e 7374  l pixel, in Anst
+00024e30: 726f 6d73 0a0a 2020 2020 646c 616d 203a  roms..    dlam :
+00024e40: 2066 6c6f 6174 0a20 2020 2020 2020 2044   float.        D
+00024e50: 656c 7461 2d77 6176 656c 656e 6774 6820  elta-wavelength 
+00024e60: 7065 7220 2878 2920 7069 7865 6c0a 0a20  per (x) pixel.. 
+00024e70: 2020 204e 582c 204e 5920 3a20 696e 740a     NX, NY : int.
+00024e80: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
+00024e90: 6620 7820 2620 7920 7069 7865 6c73 2e20  f x & y pixels. 
+00024ea0: 4f75 7470 7574 2077 696c 6c20 6861 7665  Output will have
+00024eb0: 2073 6861 7065 2060 2832 2a4e 592c 2032   shape `(2*NY, 2
+00024ec0: 2a4e 5829 602e 0a0a 2020 2020 7370 6174  *NX)`...    spat
+00024ed0: 6961 6c5f 7363 616c 6520 3a20 666c 6f61  ial_scale : floa
+00024ee0: 740a 2020 2020 2020 2020 5370 6174 6961  t.        Spatia
+00024ef0: 6c20 7363 616c 6520 6f66 2074 6865 206f  l scale of the o
+00024f00: 7574 7075 742c 2069 6e20 756e 6974 7320  utput, in units 
+00024f10: 6f66 2074 6865 2069 6e70 7574 2070 6978  of the input pix
+00024f20: 656c 730a 0a20 2020 2052 6574 7572 6e73  els..    Returns
+00024f30: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00024f40: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
+00024f50: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
+00024f60: 6572 600a 2020 2020 2020 2020 4f75 7470  er`.        Outp
+00024f70: 7574 2057 4353 2068 6561 6465 720a 0a20  ut WCS header.. 
+00024f80: 2020 2077 6373 203a 2060 7e61 7374 726f     wcs : `~astro
+00024f90: 7079 2e77 6373 2e57 4353 600a 2020 2020  py.wcs.WCS`.    
+00024fa0: 2020 2020 4f75 7470 7574 2057 4353 0a0a      Output WCS..
+00024fb0: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
+00024fc0: 202d 2d2d 2d2d 2d2d 2d0a 0a20 2020 2020   --------..     
+00024fd0: 2020 203e 3e3e 2066 726f 6d20 6772 697a     >>> from griz
+00024fe0: 6c69 2e75 7469 6c73 2069 6d70 6f72 7420  li.utils import 
+00024ff0: 6d61 6b65 5f73 7065 6374 7275 6d5f 7763  make_spectrum_wc
+00025000: 7368 6561 6465 720a 2020 2020 2020 2020  sheader.        
+00025010: 3e3e 3e20 682c 2077 6373 203d 206d 616b  >>> h, wcs = mak
+00025020: 655f 7370 6563 7472 756d 5f77 6373 6865  e_spectrum_wcshe
+00025030: 6164 6572 2829 0a20 2020 2020 2020 203e  ader().        >
+00025040: 3e3e 2070 7269 6e74 2877 6373 290a 2020  >> print(wcs).  
+00025050: 2020 2020 2020 5743 5320 4b65 7977 6f72        WCS Keywor
+00025060: 6473 0a20 2020 2020 2020 204e 756d 6265  ds.        Numbe
+00025070: 7220 6f66 2057 4353 2061 7865 733a 2032  r of WCS axes: 2
+00025080: 0a20 2020 2020 2020 2043 5459 5045 203a  .        CTYPE :
+00025090: 2027 5741 5645 2720 2027 4c49 4e45 4152   'WAVE'  'LINEAR
+000250a0: 270a 2020 2020 2020 2020 4352 5641 4c20  '.        CRVAL 
+000250b0: 3a20 3134 3030 302e 3020 2030 2e30 0a20  : 14000.0  0.0. 
+000250c0: 2020 2020 2020 2043 5250 4958 203a 2031         CRPIX : 1
+000250d0: 3031 2e30 2020 3131 2e30 0a20 2020 2020  01.0  11.0.     
+000250e0: 2020 2043 4431 5f31 2043 4431 5f32 2020     CD1_1 CD1_2  
+000250f0: 3a20 3430 2e30 2020 302e 300a 2020 2020  : 40.0  0.0.    
+00025100: 2020 2020 4344 325f 3120 4344 325f 3220      CD2_1 CD2_2 
+00025110: 203a 2030 2e30 2020 312e 300a 2020 2020   : 0.0  1.0.    
+00025120: 2020 2020 4e41 5849 5320 2020 203a 2032      NAXIS    : 2
+00025130: 3030 2032 300a 0a20 2020 2022 2222 0a0a  00 20..    """..
+00025140: 2020 2020 6820 3d20 7079 6669 7473 2e49      h = pyfits.I
+00025150: 6d61 6765 4844 5528 6461 7461 3d6e 702e  mageHDU(data=np.
+00025160: 7a65 726f 7328 2832 2a4e 592c 2032 2a4e  zeros((2*NY, 2*N
+00025170: 5829 2c20 6474 7970 653d 6e70 2e66 6c6f  X), dtype=np.flo
+00025180: 6174 3332 2929 0a0a 2020 2020 7265 6668  at32))..    refh
+00025190: 203d 2068 2e68 6561 6465 720a 2020 2020   = h.header.    
+000251a0: 7265 6668 5b27 4352 5049 5831 275d 203d  refh['CRPIX1'] =
+000251b0: 204e 582b 310a 2020 2020 7265 6668 5b27   NX+1.    refh['
+000251c0: 4352 5049 5832 275d 203d 204e 592b 310a  CRPIX2'] = NY+1.
+000251d0: 2020 2020 7265 6668 5b27 4352 5641 4c31      refh['CRVAL1
+000251e0: 275d 203d 2063 656e 7465 725f 7761 7665  '] = center_wave
+000251f0: 2f31 2e65 340a 2020 2020 7265 6668 5b27  /1.e4.    refh['
+00025200: 4344 315f 3127 5d20 3d20 646c 616d 2f31  CD1_1'] = dlam/1
+00025210: 2e65 340a 2020 2020 7265 6668 5b27 4344  .e4.    refh['CD
+00025220: 315f 3227 5d20 3d20 302e 0a20 2020 2072  1_2'] = 0..    r
+00025230: 6566 685b 2743 5256 414c 3227 5d20 3d20  efh['CRVAL2'] = 
+00025240: 302e 0a20 2020 2072 6566 685b 2743 4432  0..    refh['CD2
+00025250: 5f32 275d 203d 2073 7061 7469 616c 5f73  _2'] = spatial_s
+00025260: 6361 6c65 0a20 2020 2072 6566 685b 2743  cale.    refh['C
+00025270: 4432 5f31 275d 203d 2030 2e0a 2020 2020  D2_1'] = 0..    
+00025280: 7265 6668 5b27 5241 4445 5359 5327 5d20  refh['RADESYS'] 
+00025290: 3d20 2727 0a0a 2020 2020 7265 6668 5b27  = ''..    refh['
+000252a0: 4354 5950 4531 275d 203d 2027 5241 2d2d  CTYPE1'] = 'RA--
+000252b0: 2d54 414e 2d53 4950 270a 2020 2020 7265  -TAN-SIP'.    re
+000252c0: 6668 5b27 4355 4e49 5431 275d 203d 2027  fh['CUNIT1'] = '
+000252d0: 6d61 7327 0a20 2020 2072 6566 685b 2743  mas'.    refh['C
+000252e0: 5459 5045 3227 5d20 3d20 2744 4543 2d2d  TYPE2'] = 'DEC--
+000252f0: 5441 4e2d 5349 5027 0a20 2020 2072 6566  TAN-SIP'.    ref
+00025300: 685b 2743 554e 4954 3227 5d20 3d20 276d  h['CUNIT2'] = 'm
+00025310: 6173 270a 0a20 2020 2072 6566 5f77 6373  as'..    ref_wcs
+00025320: 203d 2070 7977 6373 2e57 4353 2872 6566   = pywcs.WCS(ref
+00025330: 6829 0a20 2020 2072 6566 5f77 6373 2e70  h).    ref_wcs.p
+00025340: 7363 616c 6520 3d20 6765 745f 7763 735f  scale = get_wcs_
+00025350: 7073 6361 6c65 2872 6566 5f77 6373 290a  pscale(ref_wcs).
+00025360: 0a20 2020 2072 6574 7572 6e20 7265 6668  .    return refh
+00025370: 2c20 7265 665f 7763 730a 0a0a 6465 6620  , ref_wcs...def 
+00025380: 6d61 6b65 5f73 7065 6374 7275 6d5f 7763  make_spectrum_wc
+00025390: 7368 6561 6465 7228 6365 6e74 6572 5f77  sheader(center_w
+000253a0: 6176 653d 312e 3465 342c 2064 6c61 6d3d  ave=1.4e4, dlam=
+000253b0: 3430 2c20 4e58 3d31 3030 2c20 7370 6174  40, NX=100, spat
+000253c0: 6961 6c5f 7363 616c 653d 312c 204e 593d  ial_scale=1, NY=
+000253d0: 3130 293a 0a20 2020 2022 2222 4d61 6b65  10):.    """Make
+000253e0: 2061 2057 4353 2068 6561 6465 7220 666f   a WCS header fo
+000253f0: 7220 6120 3244 2073 7065 6374 7275 6d0a  r a 2D spectrum.
+00025400: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00025410: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00025420: 2020 2063 656e 7465 725f 7761 7665 203a     center_wave :
+00025430: 2066 6c6f 6174 0a20 2020 2020 2020 2057   float.        W
+00025440: 6176 656c 656e 6774 6820 6f66 2074 6865  avelength of the
+00025450: 2063 656e 7472 616c 2070 6978 656c 2c20   central pixel, 
+00025460: 696e 2041 6e73 7472 6f6d 730a 0a20 2020  in Anstroms..   
+00025470: 2064 6c61 6d20 3a20 666c 6f61 740a 2020   dlam : float.  
+00025480: 2020 2020 2020 4465 6c74 612d 7761 7665        Delta-wave
+00025490: 6c65 6e67 7468 2070 6572 2028 7829 2070  length per (x) p
+000254a0: 6978 656c 0a0a 2020 2020 4e58 2c20 4e59  ixel..    NX, NY
+000254b0: 203a 2069 6e74 0a20 2020 2020 2020 204e   : int.        N
+000254c0: 756d 6265 7220 6f66 2078 2026 2079 2070  umber of x & y p
+000254d0: 6978 656c 732e 204f 7574 7075 7420 7769  ixels. Output wi
+000254e0: 6c6c 2068 6176 6520 7368 6170 6520 6028  ll have shape `(
+000254f0: 322a 4e59 2c20 322a 4e58 2960 2e0a 0a20  2*NY, 2*NX)`... 
+00025500: 2020 2073 7061 7469 616c 5f73 6361 6c65     spatial_scale
+00025510: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
+00025520: 2053 7061 7469 616c 2073 6361 6c65 206f   Spatial scale o
+00025530: 6620 7468 6520 6f75 7470 7574 2c20 696e  f the output, in
+00025540: 2075 6e69 7473 206f 6620 7468 6520 696e   units of the in
+00025550: 7075 7420 7069 7865 6c73 0a0a 2020 2020  put pixels..    
+00025560: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00025570: 2d2d 2d0a 2020 2020 6865 6164 6572 203a  ---.    header :
+00025580: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
+00025590: 7473 2e48 6561 6465 7260 0a20 2020 2020  ts.Header`.     
+000255a0: 2020 204f 7574 7075 7420 5743 5320 6865     Output WCS he
+000255b0: 6164 6572 0a0a 2020 2020 7763 7320 3a20  ader..    wcs : 
+000255c0: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
+000255d0: 5360 0a20 2020 2020 2020 204f 7574 7075  S`.        Outpu
+000255e0: 7420 5743 530a 0a20 2020 2045 7861 6d70  t WCS..    Examp
+000255f0: 6c65 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  les.    --------
+00025600: 0a0a 2020 2020 2020 2020 3e3e 3e20 6672  ..        >>> fr
+00025610: 6f6d 2067 7269 7a6c 692e 7574 696c 7320  om grizli.utils 
+00025620: 696d 706f 7274 206d 616b 655f 7370 6563  import make_spec
+00025630: 7472 756d 5f77 6373 6865 6164 6572 0a20  trum_wcsheader. 
+00025640: 2020 2020 2020 203e 3e3e 2068 2c20 7763         >>> h, wc
+00025650: 7320 3d20 6d61 6b65 5f73 7065 6374 7275  s = make_spectru
+00025660: 6d5f 7763 7368 6561 6465 7228 290a 2020  m_wcsheader().  
+00025670: 2020 2020 2020 3e3e 3e20 7072 696e 7428        >>> print(
+00025680: 7763 7329 0a20 2020 2020 2020 2057 4353  wcs).        WCS
+00025690: 204b 6579 776f 7264 730a 2020 2020 2020   Keywords.      
+000256a0: 2020 4e75 6d62 6572 206f 6620 5743 5320    Number of WCS 
+000256b0: 6178 6573 3a20 320a 2020 2020 2020 2020  axes: 2.        
+000256c0: 4354 5950 4520 3a20 2757 4156 4527 2020  CTYPE : 'WAVE'  
+000256d0: 274c 494e 4541 5227 0a20 2020 2020 2020  'LINEAR'.       
+000256e0: 2043 5256 414c 203a 2031 3430 3030 2e30   CRVAL : 14000.0
+000256f0: 2020 302e 300a 2020 2020 2020 2020 4352    0.0.        CR
+00025700: 5049 5820 3a20 3130 312e 3020 2031 312e  PIX : 101.0  11.
+00025710: 300a 2020 2020 2020 2020 4344 315f 3120  0.        CD1_1 
+00025720: 4344 315f 3220 203a 2034 302e 3020 2030  CD1_2  : 40.0  0
+00025730: 2e30 0a20 2020 2020 2020 2043 4432 5f31  .0.        CD2_1
+00025740: 2043 4432 5f32 2020 3a20 302e 3020 2031   CD2_2  : 0.0  1
+00025750: 2e30 0a20 2020 2020 2020 204e 4158 4953  .0.        NAXIS
+00025760: 2020 2020 3a20 3230 3020 3230 0a0a 2020      : 200 20..  
+00025770: 2020 2222 220a 0a20 2020 2068 203d 2070    """..    h = p
+00025780: 7966 6974 732e 496d 6167 6548 4455 2864  yfits.ImageHDU(d
+00025790: 6174 613d 6e70 2e7a 6572 6f73 2828 322a  ata=np.zeros((2*
+000257a0: 4e59 2c20 322a 4e58 292c 2064 7479 7065  NY, 2*NX), dtype
+000257b0: 3d6e 702e 666c 6f61 7433 3229 290a 0a20  =np.float32)).. 
+000257c0: 2020 2072 6566 6820 3d20 682e 6865 6164     refh = h.head
+000257d0: 6572 0a20 2020 2072 6566 685b 2743 5250  er.    refh['CRP
+000257e0: 4958 3127 5d20 3d20 4e58 2b31 0a20 2020  IX1'] = NX+1.   
+000257f0: 2072 6566 685b 2743 5250 4958 3227 5d20   refh['CRPIX2'] 
+00025800: 3d20 4e59 2b31 0a20 2020 2072 6566 685b  = NY+1.    refh[
+00025810: 2743 5256 414c 3127 5d20 3d20 6365 6e74  'CRVAL1'] = cent
+00025820: 6572 5f77 6176 650a 2020 2020 7265 6668  er_wave.    refh
+00025830: 5b27 4344 315f 3127 5d20 3d20 646c 616d  ['CD1_1'] = dlam
+00025840: 0a20 2020 2072 6566 685b 2743 4431 5f32  .    refh['CD1_2
+00025850: 275d 203d 2030 2e0a 2020 2020 7265 6668  '] = 0..    refh
+00025860: 5b27 4352 5641 4c32 275d 203d 2030 2e0a  ['CRVAL2'] = 0..
+00025870: 2020 2020 7265 6668 5b27 4344 325f 3227      refh['CD2_2'
+00025880: 5d20 3d20 7370 6174 6961 6c5f 7363 616c  ] = spatial_scal
+00025890: 650a 2020 2020 7265 6668 5b27 4344 325f  e.    refh['CD2_
+000258a0: 3127 5d20 3d20 302e 0a20 2020 2072 6566  1'] = 0..    ref
+000258b0: 685b 2752 4144 4553 5953 275d 203d 2027  h['RADESYS'] = '
+000258c0: 270a 0a20 2020 2072 6566 685b 2743 5459  '..    refh['CTY
+000258d0: 5045 3127 5d20 3d20 2757 4156 4527 0a20  PE1'] = 'WAVE'. 
+000258e0: 2020 2072 6566 685b 2743 5459 5045 3227     refh['CTYPE2'
+000258f0: 5d20 3d20 274c 494e 4541 5227 0a0a 2020  ] = 'LINEAR'..  
+00025900: 2020 7265 665f 7763 7320 3d20 7079 7763    ref_wcs = pywc
+00025910: 732e 5743 5328 682e 6865 6164 6572 290a  s.WCS(h.header).
+00025920: 2020 2020 7265 665f 7763 732e 7073 6361      ref_wcs.psca
+00025930: 6c65 203d 206e 702e 7371 7274 2872 6566  le = np.sqrt(ref
+00025940: 5f77 6373 2e77 6373 2e63 645b 302c 2030  _wcs.wcs.cd[0, 0
+00025950: 5d2a 2a32 202b 2072 6566 5f77 6373 2e77  ]**2 + ref_wcs.w
+00025960: 6373 2e63 645b 312c 2030 5d2a 2a32 292a  cs.cd[1, 0]**2)*
+00025970: 3336 3030 2e0a 0a20 2020 2072 6574 7572  3600...    retur
+00025980: 6e20 7265 6668 2c20 7265 665f 7763 730a  n refh, ref_wcs.
+00025990: 0a0a 6465 6620 7265 6164 5f67 7a69 7070  ..def read_gzipp
+000259a0: 6564 5f68 6561 6465 7228 6669 6c65 3d27  ed_header(file='
+000259b0: 7465 7374 2e66 6974 732e 677a 272c 2042  test.fits.gz', B
+000259c0: 4c4f 434b 3d31 3032 342c 204e 4d41 583d  LOCK=1024, NMAX=
+000259d0: 3235 362c 206e 7370 6163 653d 3136 2c20  256, nspace=16, 
+000259e0: 7374 7269 703d 4661 6c73 6529 3a0a 2020  strip=False):.  
+000259f0: 2020 2222 220a 2020 2020 5265 6164 2070    """.    Read p
+00025a00: 7269 6d61 7279 2068 6561 6465 7220 6672  rimary header fr
+00025a10: 6f6d 2061 2028 706f 7465 6e74 6961 6c6c  om a (potentiall
+00025a20: 7920 6c61 7267 6529 207a 6970 7065 6420  y large) zipped 
+00025a30: 4649 5453 2066 696c 650a 0a20 2020 2054  FITS file..    T
+00025a40: 6865 2073 6372 6970 7420 7072 6f63 6565  he script procee
+00025a50: 6473 2062 7920 7265 6164 696e 6720 604e  ds by reading `N
+00025a60: 4d41 5860 2073 6567 6d65 6e74 7320 6f66  MAX` segments of
+00025a70: 2073 697a 6520 6042 4c4f 434b 6020 6279   size `BLOCK` by
+00025a80: 7465 7320 6672 6f6d 0a20 2020 2074 6865  tes from.    the
+00025a90: 2066 696c 6520 616e 6420 7365 6172 6368   file and search
+00025aa0: 696e 6720 666f 7220 6120 7374 7269 6e67  ing for a string
+00025ab0: 2060 454e 4420 2b20 2720 272a 6e73 7061   `END + ' '*nspa
+00025ac0: 6365 6020 696e 2074 6865 2064 6174 610a  ce` in the data.
+00025ad0: 2020 2020 696e 6469 6361 7469 6e67 2074      indicating t
+00025ae0: 6865 2065 6e64 206f 6620 7468 6520 7072  he end of the pr
+00025af0: 696d 6172 7920 6865 6164 6572 2e0a 0a20  imary header... 
+00025b00: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00025b10: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00025b20: 2066 696c 6520 3a20 7374 720a 2020 2020   file : str.    
+00025b30: 2020 2020 4669 6c65 6e61 6d65 206f 6620      Filename of 
+00025b40: 677a 6970 7065 6420 4649 5453 2066 696c  gzipped FITS fil
+00025b50: 650a 0a20 2020 2042 4c4f 434b 2c20 4e4d  e..    BLOCK, NM
+00025b60: 4158 2c20 6e73 7061 6365 203a 2069 6e74  AX, nspace : int
+00025b70: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00025b80: 6572 7320 666f 7220 7265 6164 696e 6720  ers for reading 
+00025b90: 6279 7465 7320 6672 6f6d 2074 6865 2069  bytes from the i
+00025ba0: 6e70 7574 2066 696c 650a 0a20 2020 2073  nput file..    s
+00025bb0: 7472 6970 203a 2062 6f6f 6c0a 2020 2020  trip : bool.    
+00025bc0: 2020 2020 5365 6e64 206f 7574 7075 7420      Send output 
+00025bd0: 7468 726f 7567 6820 6073 7472 6970 5f68  through `strip_h
+00025be0: 6561 6465 725f 6b65 7973 602e 0a0a 0a20  eader_keys`.... 
+00025bf0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+00025c00: 2d2d 2d2d 2d2d 0a20 2020 2068 6561 6465  ------.    heade
+00025c10: 7220 3a20 607e 6173 7472 6f70 792e 696f  r : `~astropy.io
+00025c20: 2e66 6974 732e 4865 6164 6572 600a 2020  .fits.Header`.  
+00025c30: 2020 2020 2020 4865 6164 6572 206f 626a        Header obj
+00025c40: 6563 740a 0a20 2020 2022 2222 0a20 2020  ect..    """.   
+00025c50: 2069 6d70 6f72 7420 677a 6970 0a20 2020   import gzip.   
+00025c60: 2069 6d70 6f72 7420 6173 7472 6f70 792e   import astropy.
+00025c70: 696f 2e66 6974 7320 6173 2070 7966 6974  io.fits as pyfit
+00025c80: 730a 0a20 2020 2066 203d 2067 7a69 702e  s..    f = gzip.
+00025c90: 477a 6970 4669 6c65 2866 696c 656f 626a  GzipFile(fileobj
+00025ca0: 3d6f 7065 6e28 6669 6c65 2c20 2772 6227  =open(file, 'rb'
+00025cb0: 2929 0a0a 2020 2020 6461 7461 203d 2062  ))..    data = b
+00025cc0: 2727 0a20 2020 2065 6e64 203d 2062 2720  ''.    end = b' 
+00025cd0: 454e 4427 2b62 2720 272a 6e73 7061 6365  END'+b' '*nspace
+00025ce0: 0a0a 2020 2020 666f 7220 6920 696e 2072  ..    for i in r
+00025cf0: 616e 6765 284e 4d41 5829 3a0a 2020 2020  ange(NMAX):.    
+00025d00: 2020 2020 6461 7461 5f69 203d 2066 2e72      data_i = f.r
+00025d10: 6561 6428 424c 4f43 4b29 0a20 2020 2020  ead(BLOCK).     
+00025d20: 2020 2069 6620 656e 6420 696e 2064 6174     if end in dat
+00025d30: 615f 693a 0a20 2020 2020 2020 2020 2020  a_i:.           
+00025d40: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
+00025d50: 6461 7461 202b 3d20 6461 7461 5f69 0a0a  data += data_i..
+00025d60: 2020 2020 6966 2028 6920 3d3d 204e 4d41      if (i == NMA
+00025d70: 582d 3129 3a0a 2020 2020 2020 2020 7072  X-1):.        pr
+00025d80: 696e 7428 2745 7272 6f72 3a20 454e 442b  int('Error: END+
+00025d90: 7b33 7d2a 2220 2220 6e6f 7420 666f 756e  {3}*" " not foun
+00025da0: 6420 696e 2066 6972 7374 207b 307d 787b  d in first {0}x{
+00025db0: 317d 2062 7974 6573 206f 6620 7b32 7d29  1} bytes of {2})
+00025dc0: 272e 666f 726d 6174 284e 4d41 582c 2042  '.format(NMAX, B
+00025dd0: 4c4f 434b 2c20 6669 6c65 2c20 6e73 7061  LOCK, file, nspa
+00025de0: 6365 2929 0a20 2020 2020 2020 2066 2e63  ce)).        f.c
+00025df0: 6c6f 7365 2829 0a20 2020 2020 2020 2072  lose().        r
+00025e00: 6574 7572 6e20 7b7d 0a0a 2020 2020 6978  eturn {}..    ix
+00025e10: 203d 2064 6174 615f 692e 696e 6465 7828   = data_i.index(
+00025e20: 656e 6429 0a20 2020 2064 6174 6120 2b3d  end).    data +=
+00025e30: 2064 6174 615f 695b 3a69 785d 2b65 6e64   data_i[:ix]+end
+00025e40: 2020 2320 6461 7461 5f69 5b3a 6978 5d0a    # data_i[:ix].
+00025e50: 0a20 2020 2066 2e63 6c6f 7365 2829 0a20  .    f.close(). 
+00025e60: 2020 2064 6174 615f 7374 7220 3d20 6461     data_str = da
+00025e70: 7461 2e64 6563 6f64 6528 2775 7466 3827  ta.decode('utf8'
+00025e80: 290a 2020 2020 6820 3d20 7079 6669 7473  ).    h = pyfits
+00025e90: 2e48 6561 6465 722e 6672 6f6d 7374 7269  .Header.fromstri
+00025ea0: 6e67 2864 6174 615f 7374 7229 0a0a 2020  ng(data_str)..  
+00025eb0: 2020 6966 2073 7472 6970 3a0a 2020 2020    if strip:.    
+00025ec0: 2020 2020 7265 7475 726e 2073 7472 6970      return strip
+00025ed0: 5f68 6561 6465 725f 6b65 7973 2868 2c20  _header_keys(h, 
+00025ee0: 7573 6577 6373 3d54 7275 6529 0a20 2020  usewcs=True).   
+00025ef0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+00025f00: 6574 7572 6e20 680a 0a0a 4452 495a 5a4c  eturn h...DRIZZL
+00025f10: 455f 4b45 5953 203d 205b 2747 454f 4d27  E_KEYS = ['GEOM'
+00025f20: 2c20 2744 4154 4127 2c20 2744 4558 5027  , 'DATA', 'DEXP'
+00025f30: 2c20 274f 5544 4127 2c20 274f 5557 4527  , 'OUDA', 'OUWE'
+00025f40: 2c20 274f 5543 4f27 2c20 274d 4153 4b27  , 'OUCO', 'MASK'
+00025f50: 2c20 2757 5453 4327 2c20 274b 4552 4e27  , 'WTSC', 'KERN'
+00025f60: 2c20 2750 4958 4627 2c20 2743 4f45 4627  , 'PIXF', 'COEF'
+00025f70: 2c20 274f 5555 4e27 2c20 2746 5641 4c27  , 'OUUN', 'FVAL'
+00025f80: 2c20 2757 4b45 5927 2c20 2753 4341 4c27  , 'WKEY', 'SCAL'
+00025f90: 2c20 2749 5343 4c27 5d0a 0a0a 6465 6620  , 'ISCL']...def 
+00025fa0: 7374 7269 705f 6865 6164 6572 5f6b 6579  strip_header_key
+00025fb0: 7328 6865 6164 6572 2c20 636f 6d6d 656e  s(header, commen
+00025fc0: 743d 5472 7565 2c20 6869 7374 6f72 793d  t=True, history=
+00025fd0: 5472 7565 2c20 6472 697a 7a6c 655f 6b65  True, drizzle_ke
+00025fe0: 7973 3d44 5249 5a5a 4c45 5f4b 4559 532c  ys=DRIZZLE_KEYS,
+00025ff0: 2075 7365 7763 733d 4661 6c73 652c 206b   usewcs=False, k
+00026000: 6565 705f 7769 7468 5f77 6373 3d5b 2745  eep_with_wcs=['E
+00026010: 5850 5449 4d45 272c 2027 4649 4c54 4552  XPTIME', 'FILTER
+00026020: 272c 2027 5445 4c45 5343 4f50 272c 2027  ', 'TELESCOP', '
+00026030: 494e 5354 5255 4d45 272c 2027 4441 5445  INSTRUME', 'DATE
+00026040: 2d4f 4253 272c 2027 4558 5053 5441 5254  -OBS', 'EXPSTART
+00026050: 272c 2027 4558 5045 4e44 275d 293a 0a20  ', 'EXPEND']):. 
+00026060: 2020 2022 2222 0a20 2020 2053 7472 6970     """.    Strip
+00026070: 2068 6561 6465 7220 6b65 7977 6f72 6473   header keywords
+00026080: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00026090: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+000260a0: 0a20 2020 2063 6f6d 6d65 6e74 2c20 6869  .    comment, hi
+000260b0: 7374 6f72 7920 3a20 626f 6f6c 0a20 2020  story : bool.   
+000260c0: 2020 2020 2053 7472 6970 2027 434f 4d4d       Strip 'COMM
+000260d0: 454e 5427 2061 6e64 2027 4849 5354 4f52  ENT' and 'HISTOR
+000260e0: 5927 206b 6579 776f 7264 732c 2072 6573  Y' keywords, res
+000260f0: 7065 6374 6976 656c 792e 0a0a 2020 2020  pectively...    
+00026100: 6472 697a 7a6c 655f 6b65 7973 203a 206c  drizzle_keys : l
+00026110: 6973 740a 2020 2020 2020 2020 5374 7269  ist.        Stri
+00026120: 7020 6b65 7973 2070 726f 6475 6365 6420  p keys produced 
+00026130: 6279 2060 7e64 7269 7a7a 6c65 7061 632e  by `~drizzlepac.
+00026140: 6173 7472 6f64 7269 7a7a 6c65 602e 0a0a  astrodrizzle`...
+00026150: 2020 2020 7573 6577 6373 203a 2062 6f6f      usewcs : boo
+00026160: 6c0a 2020 2020 2020 2020 416c 7465 726e  l.        Altern
+00026170: 6174 6976 656c 792c 206a 7573 7420 6765  atively, just ge
+00026180: 6e65 7261 7465 2061 2073 696d 706c 6520  nerate a simple 
+00026190: 5743 532d 6f6e 6c79 2068 6561 6465 7220  WCS-only header 
+000261a0: 6672 6f6d 2074 6865 2069 6e70 7574 0a20  from the input. 
+000261b0: 2020 2020 2020 2068 6561 6465 722e 0a0a         header...
+000261c0: 2020 2020 6b65 6570 5f77 6974 685f 7763      keep_with_wc
+000261d0: 7320 3a20 6c69 7374 0a20 2020 2020 2020  s : list.       
+000261e0: 2041 6464 6974 696f 6e61 6c20 6b65 7973   Additional keys
+000261f0: 2074 6f20 7472 7920 746f 2061 6464 2074   to try to add t
+00026200: 6f20 7468 6520 6075 7365 7763 7360 2068  o the `usewcs` h
+00026210: 6561 6465 722e 0a0a 2020 2020 5265 7475  eader...    Retu
+00026220: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00026230: 0a20 2020 2068 6561 6465 7220 3a20 607e  .    header : `~
+00026240: 6173 7472 6f70 792e 696f 2e66 6974 732e  astropy.io.fits.
+00026250: 4865 6164 6572 600a 2020 2020 2020 2020  Header`.        
+00026260: 4865 6164 6572 206f 626a 6563 742e 0a0a  Header object...
+00026270: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
+00026280: 7274 2063 6f70 790a 2020 2020 696d 706f  rt copy.    impo
+00026290: 7274 2061 7374 726f 7079 2e77 6373 2061  rt astropy.wcs a
+000262a0: 7320 7079 7763 730a 0a20 2020 2023 2050  s pywcs..    # P
+000262b0: 6172 7365 2057 4353 2061 6e64 2062 7569  arse WCS and bui
+000262c0: 6c64 2068 6561 6465 720a 2020 2020 6966  ld header.    if
+000262d0: 2075 7365 7763 733a 0a20 2020 2020 2020   usewcs:.       
+000262e0: 2077 6373 203d 2070 7977 6373 2e57 4353   wcs = pywcs.WCS
+000262f0: 2868 6561 6465 7229 0a20 2020 2020 2020  (header).       
+00026300: 2068 203d 2074 6f5f 6865 6164 6572 2877   h = to_header(w
+00026310: 6373 290a 2020 2020 2020 2020 666f 7220  cs).        for 
+00026320: 6b20 696e 206b 6565 705f 7769 7468 5f77  k in keep_with_w
+00026330: 6373 3a0a 2020 2020 2020 2020 2020 2020  cs:.            
+00026340: 6966 206b 2069 6e20 6865 6164 6572 3a0a  if k in header:.
+00026350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026360: 6966 206b 2069 6e20 6865 6164 6572 2e63  if k in header.c
+00026370: 6f6d 6d65 6e74 733a 0a20 2020 2020 2020  omments:.       
+00026380: 2020 2020 2020 2020 2020 2020 2068 5b6b               h[k
+00026390: 5d20 3d20 6865 6164 6572 5b6b 5d2c 2068  ] = header[k], h
+000263a0: 6561 6465 722e 636f 6d6d 656e 7473 5b6b  eader.comments[k
+000263b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000263c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000263d0: 2020 2020 2020 2020 2020 2020 685b 6b5d              h[k]
+000263e0: 203d 2068 6561 6465 725b 6b5d 0a0a 2020   = header[k]..  
+000263f0: 2020 2020 2020 6966 2027 4649 4c54 4552        if 'FILTER
+00026400: 2720 696e 206b 6565 705f 7769 7468 5f77  ' in keep_with_w
+00026410: 6373 3a0a 2020 2020 2020 2020 2020 2020  cs:.            
+00026420: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00026430: 2020 2020 2068 5b27 4649 4c54 4552 275d       h['FILTER']
+00026440: 203d 2028 7061 7273 655f 6669 6c74 6572   = (parse_filter
+00026450: 5f66 726f 6d5f 6865 6164 6572 2868 6561  _from_header(hea
+00026460: 6465 7229 2c0a 2020 2020 2020 2020 2020  der),.          
+00026470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026480: 2020 2020 2027 656c 656d 656e 7420 7365       'element se
+00026490: 6c65 6374 6564 2066 726f 6d20 6669 6c74  lected from filt
+000264a0: 6572 2077 6865 656c 2729 0a20 2020 2020  er wheel').     
+000264b0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+000264c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000264d0: 6173 730a 0a20 2020 2020 2020 2072 6574  ass..        ret
+000264e0: 7572 6e20 680a 0a20 2020 2068 203d 2063  urn h..    h = c
+000264f0: 6f70 792e 6465 6570 636f 7079 2868 6561  opy.deepcopy(hea
+00026500: 6465 7229 0a20 2020 206b 6579 7320 3d20  der).    keys = 
+00026510: 6c69 7374 2868 2e6b 6579 7328 2929 0a20  list(h.keys()). 
+00026520: 2020 2073 7472 6970 5f6b 6579 7320 3d20     strip_keys = 
+00026530: 5b5d 0a20 2020 2069 6620 636f 6d6d 656e  [].    if commen
+00026540: 743a 0a20 2020 2020 2020 2073 7472 6970  t:.        strip
+00026550: 5f6b 6579 732e 6170 7065 6e64 2827 434f  _keys.append('CO
+00026560: 4d4d 454e 5427 290a 0a20 2020 2069 6620  MMENT')..    if 
+00026570: 6869 7374 6f72 793a 0a20 2020 2020 2020  history:.       
+00026580: 2073 7472 6970 5f6b 6579 732e 6170 7065   strip_keys.appe
+00026590: 6e64 2827 4849 5354 4f52 5927 290a 0a20  nd('HISTORY').. 
+000265a0: 2020 2066 6f72 206b 2069 6e20 6b65 7973     for k in keys
+000265b0: 3a0a 2020 2020 2020 2020 6966 206b 2069  :.        if k i
+000265c0: 6e20 7374 7269 705f 6b65 7973 3a0a 2020  n strip_keys:.  
+000265d0: 2020 2020 2020 2020 2020 682e 7265 6d6f            h.remo
+000265e0: 7665 286b 290a 0a20 2020 2020 2020 2069  ve(k)..        i
+000265f0: 6620 6472 697a 7a6c 655f 6b65 7973 3a0a  f drizzle_keys:.
+00026600: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00026610: 2e73 7461 7274 7377 6974 6828 2744 2729  .startswith('D')
+00026620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026630: 2020 6966 2028 6b5b 2d34 3a5d 2069 6e20    if (k[-4:] in 
+00026640: 6472 697a 7a6c 655f 6b65 7973 2920 7c20  drizzle_keys) | 
+00026650: 6b2e 656e 6473 7769 7468 2827 5645 5227  k.endswith('VER'
+00026660: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00026670: 2020 2020 2020 2068 2e72 656d 6f76 6528         h.remove(
+00026680: 6b29 0a0a 2020 2020 7265 7475 726e 2068  k)..    return h
+00026690: 0a0a 0a64 6566 2077 6373 5f66 726f 6d5f  ...def wcs_from_
+000266a0: 6865 6164 6572 2868 6561 6465 722c 2072  header(header, r
+000266b0: 656c 6178 3d54 7275 652c 202a 2a6b 7761  elax=True, **kwa
+000266c0: 7267 7329 3a0a 2020 2020 2222 220a 2020  rgs):.    """.  
+000266d0: 2020 496e 6974 6961 6c69 7a65 2060 7e61    Initialize `~a
+000266e0: 7374 726f 7079 2e77 6373 2e57 4353 6020  stropy.wcs.WCS` 
+000266f0: 6672 6f6d 2061 2060 7e61 7374 726f 7079  from a `~astropy
+00026700: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
+00026710: 0a20 2020 200a 2020 2020 5061 7261 6d65  .    .    Parame
+00026720: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00026730: 2d2d 2d0a 2020 2020 6865 6164 6572 203a  ---.    header :
+00026740: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
+00026750: 7473 2e48 6561 6465 7260 0a20 2020 2020  ts.Header`.     
+00026760: 2020 2046 4954 5320 6865 6164 6572 2077     FITS header w
+00026770: 6974 6820 6f70 7469 6f6e 616c 2060 6053  ith optional ``S
+00026780: 4950 4352 5058 3160 6020 616e 6420 6060  IPCRPX1`` and ``
+00026790: 5349 5043 5250 5832 6060 206b 6579 776f  SIPCRPX2`` keywo
+000267a0: 7264 7320 7468 6174 0a20 2020 2020 2020  rds that.       
+000267b0: 2064 6566 696e 6520 6120 7365 7061 7261   define a separa
+000267c0: 7465 2072 6566 6572 656e 6365 2070 6978  te reference pix
+000267d0: 656c 2066 6f72 2061 2053 4950 2068 6561  el for a SIP hea
+000267e0: 6465 720a 2020 2020 0a20 2020 2072 656c  der.    .    rel
+000267f0: 6178 2c20 6b77 6172 6773 203a 2062 6f6f  ax, kwargs : boo
+00026800: 6c2c 2064 6963 740a 2020 2020 2020 2020  l, dict.        
+00026810: 4b65 7977 6f72 6473 2070 6173 7365 6420  Keywords passed 
+00026820: 746f 2060 6173 7472 6f70 792e 7763 732e  to `astropy.wcs.
+00026830: 5743 5360 0a20 2020 200a 2020 2020 5265  WCS`.    .    Re
+00026840: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00026850: 2d0a 2020 2020 7763 7320 3a20 607e 6173  -.    wcs : `~as
+00026860: 7472 6f70 792e 7763 732e 5743 5360 0a20  tropy.wcs.WCS`. 
+00026870: 2020 2020 2020 2057 4353 206f 626a 6563         WCS objec
+00026880: 740a 2020 2020 2020 2020 0a20 2020 2022  t.        .    "
+00026890: 2222 0a20 2020 2077 6373 203d 2070 7977  "".    wcs = pyw
+000268a0: 6373 2e57 4353 2868 6561 6465 722c 2072  cs.WCS(header, r
+000268b0: 656c 6178 3d72 656c 6178 290a 2020 2020  elax=relax).    
+000268c0: 0a20 2020 2069 6620 2827 5349 5043 5250  .    if ('SIPCRP
+000268d0: 5831 2720 696e 2068 6561 6465 7229 2026  X1' in header) &
+000268e0: 2068 6173 6174 7472 2877 6373 2c20 2773   hasattr(wcs, 's
+000268f0: 6970 2729 3a0a 2020 2020 2020 2020 7763  ip'):.        wc
+00026900: 732e 7369 702e 6372 7069 785b 305d 203d  s.sip.crpix[0] =
+00026910: 2068 6561 6465 725b 2753 4950 4352 5058   header['SIPCRPX
+00026920: 3127 5d0a 2020 2020 2020 2020 7763 732e  1'].        wcs.
+00026930: 7369 702e 6372 7069 785b 315d 203d 2068  sip.crpix[1] = h
+00026940: 6561 6465 725b 2753 4950 4352 5058 3227  eader['SIPCRPX2'
+00026950: 5d0a 2020 2020 656c 6966 2028 2753 4941  ].    elif ('SIA
+00026960: 465f 5852 4546 5f53 4349 2720 696e 2068  F_XREF_SCI' in h
+00026970: 6561 6465 7229 2026 2068 6173 6174 7472  eader) & hasattr
+00026980: 2877 6373 2c20 2773 6970 2729 3a0a 2020  (wcs, 'sip'):.  
+00026990: 2020 2020 2020 7763 732e 7369 702e 6372        wcs.sip.cr
+000269a0: 7069 785b 305d 203d 2068 6561 6465 725b  pix[0] = header[
+000269b0: 2753 4941 465f 5852 4546 5f53 4349 275d  'SIAF_XREF_SCI']
+000269c0: 0a20 2020 2020 2020 2077 6373 2e73 6970  .        wcs.sip
+000269d0: 2e63 7270 6978 5b31 5d20 3d20 6865 6164  .crpix[1] = head
+000269e0: 6572 5b27 5349 4146 5f59 5245 465f 5343  er['SIAF_YREF_SC
+000269f0: 4927 5d0a 2020 2020 2020 2020 0a20 2020  I'].        .   
+00026a00: 2072 6574 7572 6e20 7763 730a 0a0a 6465   return wcs...de
+00026a10: 6620 746f 5f68 6561 6465 7228 7763 732c  f to_header(wcs,
+00026a20: 2061 6464 5f6e 6178 6973 3d54 7275 652c   add_naxis=True,
+00026a30: 2072 656c 6178 3d54 7275 652c 206b 6579   relax=True, key
+00026a40: 3d4e 6f6e 6529 3a0a 2020 2020 2222 224d  =None):.    """M
+00026a50: 6f64 6966 7920 6061 7374 726f 7079 2e77  odify `astropy.w
+00026a60: 6373 2e57 4353 2e74 6f5f 6865 6164 6572  cs.WCS.to_header
+00026a70: 6020 746f 2070 726f 6475 6365 206d 6f72  ` to produce mor
+00026a80: 6520 6b65 7977 6f72 6473 0a0a 2020 2020  e keywords..    
+00026a90: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00026aa0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7763  ---------.    wc
+00026ab0: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
+00026ac0: 732e 5743 5360 0a20 2020 2020 2020 2049  s.WCS`.        I
+00026ad0: 6e70 7574 2057 4353 2e0a 0a20 2020 2061  nput WCS...    a
+00026ae0: 6464 5f6e 6178 6973 203a 2062 6f6f 6c0a  dd_naxis : bool.
+00026af0: 2020 2020 2020 2020 4164 6420 4e41 5849          Add NAXI
+00026b00: 5320 6b65 7977 6f72 6473 2066 726f 6d20  S keywords from 
+00026b10: 5743 5320 6469 6d65 6e73 696f 6e73 0a0a  WCS dimensions..
+00026b20: 2020 2020 7265 6c61 7820 3a20 626f 6f6c      relax : bool
+00026b30: 0a20 2020 2020 2020 2050 6173 7365 6420  .        Passed 
+00026b40: 746f 2060 5743 532e 746f 5f68 6561 6465  to `WCS.to_heade
+00026b50: 7228 7265 6c61 783d 2960 2e0a 0a20 2020  r(relax=)`...   
+00026b60: 206b 6579 203a 2073 7472 0a20 2020 2020   key : str.     
+00026b70: 2020 2053 6565 2060 7e61 7374 726f 7079     See `~astropy
+00026b80: 2e77 6373 2e57 4353 2e74 6f5f 6865 6164  .wcs.WCS.to_head
+00026b90: 6572 602e 0a0a 2020 2020 5265 7475 726e  er`...    Return
+00026ba0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+00026bb0: 2020 6865 6164 6572 203a 2060 7e61 7374    header : `~ast
+00026bc0: 726f 7079 2e69 6f2e 6669 7473 2e48 6561  ropy.io.fits.Hea
+00026bd0: 6465 7260 0a20 2020 2020 2020 204f 7574  der`.        Out
+00026be0: 7075 7420 6865 6164 6572 2e0a 0a20 2020  put header...   
+00026bf0: 2022 2222 0a20 2020 2068 6561 6465 7220   """.    header 
+00026c00: 3d20 7763 732e 746f 5f68 6561 6465 7228  = wcs.to_header(
+00026c10: 7265 6c61 783d 7265 6c61 782c 206b 6579  relax=relax, key
+00026c20: 3d6b 6579 290a 2020 2020 6966 2061 6464  =key).    if add
+00026c30: 5f6e 6178 6973 3a0a 2020 2020 2020 2020  _naxis:.        
+00026c40: 6966 2068 6173 6174 7472 2877 6373 2c20  if hasattr(wcs, 
+00026c50: 2770 6978 656c 5f73 6861 7065 2729 3a0a  'pixel_shape'):.
+00026c60: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00026c70: 6572 5b27 4e41 5849 5327 5d20 3d20 7763  er['NAXIS'] = wc
+00026c80: 732e 6e61 7869 730a 2020 2020 2020 2020  s.naxis.        
+00026c90: 2020 2020 6966 2077 6373 2e70 6978 656c      if wcs.pixel
+00026ca0: 5f73 6861 7065 2069 7320 6e6f 7420 4e6f  _shape is not No
+00026cb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00026cc0: 2020 2020 6865 6164 6572 5b27 4e41 5849      header['NAXI
+00026cd0: 5331 275d 203d 2077 6373 2e70 6978 656c  S1'] = wcs.pixel
+00026ce0: 5f73 6861 7065 5b30 5d0a 2020 2020 2020  _shape[0].      
+00026cf0: 2020 2020 2020 2020 2020 6865 6164 6572            header
+00026d00: 5b27 4e41 5849 5332 275d 203d 2077 6373  ['NAXIS2'] = wcs
+00026d10: 2e70 6978 656c 5f73 6861 7065 5b31 5d0a  .pixel_shape[1].
+00026d20: 0a20 2020 2020 2020 2065 6c69 6620 6861  .        elif ha
+00026d30: 7361 7474 7228 7763 732c 2027 5f6e 6178  sattr(wcs, '_nax
+00026d40: 6973 3127 293a 0a20 2020 2020 2020 2020  is1'):.         
+00026d50: 2020 2068 6561 6465 725b 274e 4158 4953     header['NAXIS
+00026d60: 275d 203d 2077 6373 2e6e 6178 6973 0a20  '] = wcs.naxis. 
+00026d70: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+00026d80: 725b 274e 4158 4953 3127 5d20 3d20 7763  r['NAXIS1'] = wc
+00026d90: 732e 5f6e 6178 6973 310a 2020 2020 2020  s._naxis1.      
+00026da0: 2020 2020 2020 6865 6164 6572 5b27 4e41        header['NA
+00026db0: 5849 5332 275d 203d 2077 6373 2e5f 6e61  XIS2'] = wcs._na
+00026dc0: 7869 7332 0a0a 2020 2020 666f 7220 6b20  xis2..    for k 
+00026dd0: 696e 2068 6561 6465 723a 0a20 2020 2020  in header:.     
+00026de0: 2020 2069 6620 6b2e 7374 6172 7473 7769     if k.startswi
+00026df0: 7468 2827 5043 2729 3a0a 2020 2020 2020  th('PC'):.      
+00026e00: 2020 2020 2020 6364 203d 206b 2e72 6570        cd = k.rep
+00026e10: 6c61 6365 2827 5043 272c 2027 4344 2729  lace('PC', 'CD')
+00026e20: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
+00026e30: 6465 722e 7265 6e61 6d65 5f6b 6579 776f  der.rename_keywo
+00026e40: 7264 286b 2c20 6364 290a 2020 2020 0a20  rd(k, cd).    . 
+00026e50: 2020 2069 6620 6861 7361 7474 7228 7763     if hasattr(wc
+00026e60: 732e 7763 732c 2027 6364 2729 3a0a 2020  s.wcs, 'cd'):.  
+00026e70: 2020 2020 2020 666f 7220 6920 696e 205b        for i in [
+00026e80: 302c 315d 3a0a 2020 2020 2020 2020 2020  0,1]:.          
+00026e90: 2020 666f 7220 6a20 696e 205b 302c 315d    for j in [0,1]
+00026ea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026eb0: 2020 6865 6164 6572 5b66 2743 447b 692b    header[f'CD{i+
+00026ec0: 317d 5f7b 6a2b 317d 275d 203d 2077 6373  1}_{j+1}'] = wcs
+00026ed0: 2e77 6373 2e63 645b 695d 5b6a 5d0a 2020  .wcs.cd[i][j].  
+00026ee0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00026ef0: 2020 2069 6620 6861 7361 7474 7228 7763     if hasattr(wc
+00026f00: 732c 2027 7369 7027 293a 0a20 2020 2020  s, 'sip'):.     
+00026f10: 2020 2069 6620 6861 7361 7474 7228 7763     if hasattr(wc
+00026f20: 732e 7369 702c 2027 6372 7069 7827 293a  s.sip, 'crpix'):
+00026f30: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
+00026f40: 6465 725b 2753 4950 4352 5058 3127 5d2c  der['SIPCRPX1'],
+00026f50: 2068 6561 6465 725b 2753 4950 4352 5058   header['SIPCRPX
+00026f60: 3227 5d20 3d20 7763 732e 7369 702e 6372  2'] = wcs.sip.cr
+00026f70: 7069 780a 2020 2020 2020 2020 2020 2020  pix.            
+00026f80: 0a20 2020 2072 6574 7572 6e20 6865 6164  .    return head
+00026f90: 6572 0a0a 0a64 6566 206d 616b 655f 7763  er...def make_wc
+00026fa0: 7368 6561 6465 7228 7261 3d34 302e 3037  sheader(ra=40.07
+00026fb0: 3239 332c 2064 6563 3d2d 312e 3631 3337  293, dec=-1.6137
+00026fc0: 3734 382c 2073 697a 653d 322c 2070 6978  748, size=2, pix
+00026fd0: 7363 616c 653d 302e 312c 2067 6574 5f68  scale=0.1, get_h
+00026fe0: 6475 3d46 616c 7365 2c20 7468 6574 613d  du=False, theta=
+00026ff0: 3029 3a0a 2020 2020 2222 224d 616b 6520  0):.    """Make 
+00027000: 6120 6365 6c65 7374 6961 6c20 5743 5320  a celestial WCS 
+00027010: 6865 6164 6572 0a0a 2020 2020 5061 7261  header..    Para
+00027020: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00027030: 2d2d 2d2d 2d0a 2020 2020 7261 2c20 6465  -----.    ra, de
+00027040: 6320 3a20 666c 6f61 740a 2020 2020 2020  c : float.      
+00027050: 2020 4365 6c65 7374 6961 6c20 636f 6f72    Celestial coor
+00027060: 6469 6e61 7465 7320 696e 2064 6563 696d  dinates in decim
+00027070: 616c 2064 6567 7265 6573 0a0a 2020 2020  al degrees..    
+00027080: 7369 7a65 2c20 7069 7873 6361 6c65 203a  size, pixscale :
+00027090: 2066 6c6f 6174 206f 7220 322d 6c69 7374   float or 2-list
+000270a0: 0a20 2020 2020 2020 2053 697a 6520 6f66  .        Size of
+000270b0: 2074 6865 2074 6875 6d62 6e61 696c 2c20   the thumbnail, 
+000270c0: 696e 2061 7263 7365 632c 2061 6e64 2070  in arcsec, and p
+000270d0: 6978 656c 2073 6361 6c65 2c20 696e 2061  ixel scale, in a
+000270e0: 7263 7365 632f 7069 7865 6c2e 0a20 2020  rcsec/pixel..   
+000270f0: 2020 2020 204f 7574 7075 7420 696d 6167       Output imag
+00027100: 6520 7769 6c6c 2068 6176 6520 6469 6d65  e will have dime
+00027110: 6e73 696f 6e73 2060 286e 7069 782c 6e70  nsions `(npix,np
+00027120: 6978 2960 2c20 7768 6572 650a 0a20 2020  ix)`, where..   
+00027130: 2020 2020 2020 2020 203e 3e3e 206e 7069           >>> npi
+00027140: 7820 3d20 7369 7a65 2f70 6978 7363 616c  x = size/pixscal
+00027150: 650a 0a20 2020 2067 6574 5f68 6475 203a  e..    get_hdu :
+00027160: 2062 6f6f 6c0a 2020 2020 2020 2020 5265   bool.        Re
+00027170: 7475 726e 2061 2060 7e61 7374 726f 7079  turn a `~astropy
+00027180: 2e69 6f2e 6669 7473 2e49 6d61 6765 4844  .io.fits.ImageHD
+00027190: 5560 2072 6174 6865 7220 7468 616e 2068  U` rather than h
+000271a0: 6561 6465 722f 7763 732e 0a0a 2020 2020  eader/wcs...    
+000271b0: 7468 6574 6120 3a20 666c 6f61 740a 2020  theta : float.  
+000271c0: 2020 2020 2020 506f 7369 7469 6f6e 2061        Position a
+000271d0: 6e67 6c65 206f 6620 7468 6520 6f75 7470  ngle of the outp
+000271e0: 7574 2074 6875 6d62 6e61 696c 2028 6465  ut thumbnail (de
+000271f0: 6772 6565 7329 0a0a 2020 2020 5265 7475  grees)..    Retu
+00027200: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00027210: 2020 2020 6864 7520 3a20 607e 6173 7472      hdu : `~astr
+00027220: 6f70 792e 696f 2e66 6974 732e 496d 6167  opy.io.fits.Imag
+00027230: 6548 4455 600a 2020 2020 2020 2020 4844  eHDU`.        HD
+00027240: 5520 7769 7468 2064 6174 6120 6669 6c6c  U with data fill
+00027250: 6564 2077 6974 6820 7a65 726f 7320 6966  ed with zeros if
+00027260: 2060 6765 745f 6864 753d 5472 7565 602e   `get_hdu=True`.
+00027270: 0a0a 2020 2020 6865 6164 6572 2c20 7763  ..    header, wc
+00027280: 7320 3a20 607e 6173 7472 6f70 792e 696f  s : `~astropy.io
+00027290: 2e66 6974 732e 4865 6164 6572 602c 2060  .fits.Header`, `
+000272a0: 7e61 7374 726f 7079 2e77 6373 2e57 4353  ~astropy.wcs.WCS
+000272b0: 600a 2020 2020 2020 2020 4865 6164 6572  `.        Header
+000272c0: 2061 6e64 2057 4353 206f 626a 6563 7420   and WCS object 
+000272d0: 6966 2060 6765 745f 6864 753d 4661 6c73  if `get_hdu=Fals
+000272e0: 6560 2e0a 0a20 2020 2045 7861 6d70 6c65  e`...    Example
+000272f0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a0a  s.    --------..
+00027300: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
+00027310: 2067 7269 7a6c 692e 7574 696c 7320 696d   grizli.utils im
+00027320: 706f 7274 206d 616b 655f 7763 7368 6561  port make_wcshea
+00027330: 6465 720a 2020 2020 2020 2020 3e3e 3e20  der.        >>> 
+00027340: 682c 2077 6373 203d 206d 616b 655f 7763  h, wcs = make_wc
+00027350: 7368 6561 6465 7228 290a 2020 2020 2020  sheader().      
+00027360: 2020 3e3e 3e20 7072 696e 7428 7763 7329    >>> print(wcs)
+00027370: 0a20 2020 2020 2020 2057 4353 204b 6579  .        WCS Key
+00027380: 776f 7264 730a 2020 2020 2020 2020 4e75  words.        Nu
+00027390: 6d62 6572 206f 6620 5743 5320 6178 6573  mber of WCS axes
+000273a0: 3a20 320a 2020 2020 2020 2020 4354 5950  : 2.        CTYP
+000273b0: 4520 3a20 2752 412d 2d2d 5441 4e27 2020  E : 'RA---TAN'  
+000273c0: 2744 4543 2d2d 5441 4e27 0a20 2020 2020  'DEC--TAN'.     
+000273d0: 2020 2043 5256 414c 203a 2034 302e 3037     CRVAL : 40.07
+000273e0: 3239 3239 3939 3939 3939 3939 3920 202d  2929999999999  -
+000273f0: 312e 3631 3337 3734 3830 3030 3030 3030  1.61377480000000
+00027400: 3031 0a20 2020 2020 2020 2043 5250 4958  01.        CRPIX
+00027410: 203a 2031 302e 3020 2031 302e 300a 2020   : 10.0  10.0.  
+00027420: 2020 2020 2020 4344 315f 3120 4344 315f        CD1_1 CD1_
+00027430: 3220 203a 202d 322e 3737 3737 3737 3737  2  : -2.77777777
+00027440: 3737 3737 3765 2d30 3520 2030 2e30 0a20  77777e-05  0.0. 
+00027450: 2020 2020 2020 2043 4432 5f31 2043 4432         CD2_1 CD2
+00027460: 5f32 2020 3a20 302e 3020 2032 2e37 3737  _2  : 0.0  2.777
+00027470: 3737 3737 3737 3737 3737 3730 3165 2d30  7777777777701e-0
+00027480: 350a 2020 2020 2020 2020 4e41 5849 5320  5.        NAXIS 
+00027490: 2020 203a 2032 3020 3230 0a0a 2020 2020     : 20 20..    
+000274a0: 2020 2020 3e3e 3e20 6672 6f6d 2067 7269      >>> from gri
+000274b0: 7a6c 692e 7574 696c 7320 696d 706f 7274  zli.utils import
+000274c0: 206d 616b 655f 7763 7368 6561 6465 720a   make_wcsheader.
+000274d0: 2020 2020 2020 2020 3e3e 3e20 6864 7520          >>> hdu 
+000274e0: 3d20 6d61 6b65 5f77 6373 6865 6164 6572  = make_wcsheader
+000274f0: 2867 6574 5f68 6475 3d54 7275 6529 0a20  (get_hdu=True). 
+00027500: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+00027510: 2868 6475 2e64 6174 612e 7368 6170 6529  (hdu.data.shape)
+00027520: 0a20 2020 2020 2020 2028 3230 2c20 3230  .        (20, 20
+00027530: 290a 2020 2020 2020 2020 3e3e 3e20 7072  ).        >>> pr
+00027540: 696e 7428 6864 752e 6865 6164 6572 2e74  int(hdu.header.t
+00027550: 6f73 7472 696e 6729 0a20 2020 2020 2020  ostring).       
+00027560: 2058 5445 4e53 494f 4e3d 2027 494d 4147   XTENSION= 'IMAG
+00027570: 4520 2020 2720 2020 2020 2020 2020 2020  E   '           
+00027580: 2f20 496d 6167 6520 6578 7465 6e73 696f  / Image extensio
+00027590: 6e0a 2020 2020 2020 2020 4249 5450 4958  n.        BITPIX
 000275a0: 2020 3d20 2020 2020 2020 2020 2020 2020    =             
-000275b0: 2020 2020 2020 3230 0a20 2020 2020 2020        20.       
-000275c0: 2043 5459 5045 3120 203d 2027 5241 2d2d   CTYPE1  = 'RA--
-000275d0: 2d54 414e 270a 2020 2020 2020 2020 4354  -TAN'.        CT
-000275e0: 5950 4532 2020 3d20 2744 4543 2d2d 5441  YPE2  = 'DEC--TA
-000275f0: 4e27 0a20 2020 2022 2222 0a0a 2020 2020  N'.    """..    
-00027600: 6966 206e 702e 6973 7363 616c 6172 2870  if np.isscalar(p
-00027610: 6978 7363 616c 6529 3a0a 2020 2020 2020  ixscale):.      
-00027620: 2020 6364 656c 7420 3d20 5b70 6978 7363    cdelt = [pixsc
-00027630: 616c 652f 3336 3030 2e5d 2a32 0a20 2020  ale/3600.]*2.   
-00027640: 2065 6c73 653a 0a20 2020 2020 2020 2063   else:.        c
-00027650: 6465 6c74 203d 205b 7069 7873 6361 6c65  delt = [pixscale
-00027660: 5b30 5d2f 3336 3030 2e2c 2070 6978 7363  [0]/3600., pixsc
-00027670: 616c 655b 315d 2f33 3630 302e 5d0a 0a20  ale[1]/3600.].. 
-00027680: 2020 2069 6620 6e70 2e69 7373 6361 6c61     if np.isscala
-00027690: 7228 7369 7a65 293a 0a20 2020 2020 2020  r(size):.       
-000276a0: 206e 7069 7820 3d20 6e70 2e63 6173 745b   npix = np.cast[
-000276b0: 696e 745d 286e 702e 726f 756e 6428 5b73  int](np.round([s
-000276c0: 697a 652f 7069 7873 6361 6c65 2c20 7369  ize/pixscale, si
-000276d0: 7a65 2f70 6978 7363 616c 655d 2929 0a20  ze/pixscale])). 
-000276e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000276f0: 206e 7069 7820 3d20 6e70 2e63 6173 745b   npix = np.cast[
-00027700: 696e 745d 286e 702e 726f 756e 6428 5b73  int](np.round([s
-00027710: 697a 655b 305d 2f70 6978 7363 616c 652c  ize[0]/pixscale,
-00027720: 2073 697a 655b 315d 2f70 6978 7363 616c   size[1]/pixscal
-00027730: 655d 2929 0a0a 2020 2020 686f 7574 203d  e]))..    hout =
-00027740: 2070 7966 6974 732e 4865 6164 6572 2829   pyfits.Header()
-00027750: 0a20 2020 2068 6f75 745b 2743 5250 4958  .    hout['CRPIX
-00027760: 3127 5d20 3d20 286e 7069 785b 305d 2d31  1'] = (npix[0]-1
-00027770: 292f 322b 310a 2020 2020 686f 7574 5b27  )/2+1.    hout['
-00027780: 4352 5049 5832 275d 203d 2028 6e70 6978  CRPIX2'] = (npix
-00027790: 5b31 5d2d 3129 2f32 2b31 0a20 2020 2068  [1]-1)/2+1.    h
-000277a0: 6f75 745b 2743 5256 414c 3127 5d20 3d20  out['CRVAL1'] = 
-000277b0: 7261 0a20 2020 2068 6f75 745b 2743 5256  ra.    hout['CRV
-000277c0: 414c 3227 5d20 3d20 6465 630a 2020 2020  AL2'] = dec.    
-000277d0: 686f 7574 5b27 4344 315f 3127 5d20 3d20  hout['CD1_1'] = 
-000277e0: 2d63 6465 6c74 5b30 5d0a 2020 2020 686f  -cdelt[0].    ho
-000277f0: 7574 5b27 4344 315f 3227 5d20 3d20 686f  ut['CD1_2'] = ho
-00027800: 7574 5b27 4344 325f 3127 5d20 3d20 302e  ut['CD2_1'] = 0.
-00027810: 0a20 2020 2068 6f75 745b 2743 4432 5f32  .    hout['CD2_2
-00027820: 275d 203d 2063 6465 6c74 5b31 5d0a 2020  '] = cdelt[1].  
-00027830: 2020 686f 7574 5b27 4e41 5849 5331 275d    hout['NAXIS1']
-00027840: 203d 206e 7069 785b 305d 0a20 2020 2068   = npix[0].    h
-00027850: 6f75 745b 274e 4158 4953 3227 5d20 3d20  out['NAXIS2'] = 
-00027860: 6e70 6978 5b31 5d0a 2020 2020 686f 7574  npix[1].    hout
-00027870: 5b27 4354 5950 4531 275d 203d 2027 5241  ['CTYPE1'] = 'RA
-00027880: 2d2d 2d54 414e 270a 2020 2020 686f 7574  ---TAN'.    hout
-00027890: 5b27 4354 5950 4532 275d 203d 2027 4445  ['CTYPE2'] = 'DE
-000278a0: 432d 2d54 414e 270a 0a20 2020 2068 6f75  C--TAN'..    hou
-000278b0: 745b 2752 4144 4553 5953 275d 203d 2027  t['RADESYS'] = '
-000278c0: 4943 5253 270a 2020 2020 686f 7574 5b27  ICRS'.    hout['
-000278d0: 4551 5549 4e4f 5827 5d20 3d20 3230 3030  EQUINOX'] = 2000
-000278e0: 0a20 2020 2068 6f75 745b 274c 4154 504f  .    hout['LATPO
-000278f0: 4c45 275d 203d 2068 6f75 745b 2743 5256  LE'] = hout['CRV
-00027900: 414c 3227 5d0a 2020 2020 686f 7574 5b27  AL2'].    hout['
-00027910: 4c4f 4e50 4f4c 4527 5d20 3d20 3138 300a  LONPOLE'] = 180.
-00027920: 0a20 2020 2068 6f75 745b 2750 4958 4153  .    hout['PIXAS
-00027930: 4543 275d 203d 2070 6978 7363 616c 652c  EC'] = pixscale,
-00027940: 2027 5069 7865 6c20 7363 616c 6520 696e   'Pixel scale in
-00027950: 2061 7263 7365 6327 0a0a 2020 2020 7763   arcsec'..    wc
-00027960: 735f 6f75 7420 3d20 7079 7763 732e 5743  s_out = pywcs.WC
-00027970: 5328 686f 7574 290a 0a20 2020 2074 6865  S(hout)..    the
-00027980: 7461 5f72 6164 203d 206e 702e 6465 6732  ta_rad = np.deg2
-00027990: 7261 6428 7468 6574 6129 0a20 2020 206d  rad(theta).    m
-000279a0: 6174 203d 206e 702e 6172 7261 7928 5b5b  at = np.array([[
-000279b0: 6e70 2e63 6f73 2874 6865 7461 5f72 6164  np.cos(theta_rad
-000279c0: 292c 202d 6e70 2e73 696e 2874 6865 7461  ), -np.sin(theta
-000279d0: 5f72 6164 295d 2c0a 2020 2020 2020 2020  _rad)],.        
-000279e0: 2020 2020 2020 2020 2020 2020 5b6e 702e              [np.
-000279f0: 7369 6e28 7468 6574 615f 7261 6429 2c20  sin(theta_rad), 
-00027a00: 206e 702e 636f 7328 7468 6574 615f 7261   np.cos(theta_ra
-00027a10: 6429 5d5d 290a 0a20 2020 2072 6f74 5f63  d)]])..    rot_c
-00027a20: 6420 3d20 6e70 2e64 6f74 286d 6174 2c20  d = np.dot(mat, 
-00027a30: 7763 735f 6f75 742e 7763 732e 6364 290a  wcs_out.wcs.cd).
-00027a40: 0a20 2020 2066 6f72 2069 2069 6e20 5b30  .    for i in [0
-00027a50: 2c20 315d 3a0a 2020 2020 2020 2020 666f  , 1]:.        fo
-00027a60: 7220 6a20 696e 205b 302c 2031 5d3a 0a20  r j in [0, 1]:. 
-00027a70: 2020 2020 2020 2020 2020 2068 6f75 745b             hout[
-00027a80: 2743 447b 303a 647d 5f7b 313a 647d 272e  'CD{0:d}_{1:d}'.
-00027a90: 666f 726d 6174 2869 2b31 2c20 6a2b 3129  format(i+1, j+1)
-00027aa0: 5d20 3d20 726f 745f 6364 5b69 2c20 6a5d  ] = rot_cd[i, j]
-00027ab0: 0a20 2020 2020 2020 2020 2020 2077 6373  .            wcs
-00027ac0: 5f6f 7574 2e77 6373 2e63 645b 692c 206a  _out.wcs.cd[i, j
-00027ad0: 5d20 3d20 726f 745f 6364 5b69 2c20 6a5d  ] = rot_cd[i, j]
-00027ae0: 0a0a 2020 2020 6364 203d 2077 6373 5f6f  ..    cd = wcs_o
-00027af0: 7574 2e77 6373 2e63 640a 2020 2020 7763  ut.wcs.cd.    wc
-00027b00: 735f 6f75 742e 7073 6361 6c65 203d 2067  s_out.pscale = g
-00027b10: 6574 5f77 6373 5f70 7363 616c 6528 7763  et_wcs_pscale(wc
-00027b20: 735f 6f75 7429 2020 2320 6e70 2e73 7172  s_out)  # np.sqr
-00027b30: 7428 2863 645b 302c 3a5d 2a2a 3229 2e73  t((cd[0,:]**2).s
-00027b40: 756d 2829 292a 3336 3030 2e0a 0a20 2020  um())*3600...   
-00027b50: 2069 6620 6765 745f 6864 753a 0a20 2020   if get_hdu:.   
-00027b60: 2020 2020 2068 6475 203d 2070 7966 6974       hdu = pyfit
-00027b70: 732e 496d 6167 6548 4455 2868 6561 6465  s.ImageHDU(heade
-00027b80: 723d 686f 7574 2c20 6461 7461 3d6e 702e  r=hout, data=np.
-00027b90: 7a65 726f 7328 286e 7069 785b 315d 2c20  zeros((npix[1], 
-00027ba0: 6e70 6978 5b30 5d29 2c20 6474 7970 653d  npix[0]), dtype=
-00027bb0: 6e70 2e66 6c6f 6174 3332 2929 0a20 2020  np.float32)).   
-00027bc0: 2020 2020 2072 6574 7572 6e20 6864 750a       return hdu.
-00027bd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00027be0: 2020 7265 7475 726e 2068 6f75 742c 2077    return hout, w
-00027bf0: 6373 5f6f 7574 0a0a 0a64 6566 2067 6574  cs_out...def get
-00027c00: 5f66 6c74 5f66 6f6f 7470 7269 6e74 2866  _flt_footprint(f
-00027c10: 6c74 5f66 696c 652c 2065 7874 656e 7369  lt_file, extensi
-00027c20: 6f6e 733d 5b31 2c20 322c 2033 2c20 345d  ons=[1, 2, 3, 4]
-00027c30: 2c20 7061 7463 685f 6172 6773 3d4e 6f6e  , patch_args=Non
-00027c40: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00027c50: 436f 6d70 7574 6520 666f 6f74 7072 696e  Compute footprin
-00027c60: 7420 6f66 2061 6c6c 2053 4349 2065 7874  t of all SCI ext
-00027c70: 656e 7369 6f6e 7320 6f66 2061 6e20 4853  ensions of an HS
-00027c80: 5420 6578 706f 7375 7265 0a0a 2020 2020  T exposure..    
-00027c90: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00027ca0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6578  ---------.    ex
-00027cb0: 7465 6e73 696f 6e73 203a 206c 6973 740a  tensions : list.
-00027cc0: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
-00027cd0: 6578 7465 6e73 696f 6e73 2074 6f20 7265  extensions to re
-00027ce0: 7472 6965 7665 2028 6361 6e20 6861 7665  trieve (can have
-00027cf0: 2065 7874 7261 7329 2e0a 0a20 2020 2070   extras)...    p
-00027d00: 6174 6368 5f61 7267 7320 3a20 6469 6374  atch_args : dict
-00027d10: 206f 7220 4e6f 6e65 0a20 2020 2020 2020   or None.       
-00027d20: 2049 6620 6120 6064 6963 7460 2c20 7468   If a `dict`, th
-00027d30: 656e 2067 656e 6572 6174 6520 6120 7061  en generate a pa
-00027d40: 7463 6820 666f 7220 7468 6520 666f 6f74  tch for the foot
-00027d50: 7072 696e 7420 7061 7373 696e 670a 2020  print passing.  
-00027d60: 2020 2020 2020 602a 2a70 6174 6368 5f61        `**patch_a
-00027d70: 7267 7360 2061 7267 756d 656e 7473 2028  rgs` arguments (
-00027d80: 652e 672e 2c20 607b 2766 6327 3a27 626c  e.g., `{'fc':'bl
-00027d90: 7565 272c 2027 616c 7068 6127 3a30 2e31  ue', 'alpha':0.1
-00027da0: 7d60 292e 0a0a 2020 2020 5265 7475 726e  }`)...    Return
-00027db0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00027dc0: 2020 6670 202f 2070 6174 6368 203a 2060    fp / patch : `
-00027dd0: 7e73 6861 7065 6c79 2e67 656f 6d65 7472  ~shapely.geometr
-00027de0: 7960 206f 626a 6563 7420 6f72 2060 6d61  y` object or `ma
-00027df0: 7470 6c6f 746c 6962 2e70 6174 6368 2e50  tplotlib.patch.P
-00027e00: 6174 6368 600a 2020 2020 2020 2020 5468  atch`.        Th
-00027e10: 6520 666f 6f74 7072 696e 7420 6f72 2066  e footprint or f
-00027e20: 6f6f 7470 7269 6e74 2070 6174 6368 2e0a  ootprint patch..
-00027e30: 0a20 2020 2022 2222 0a20 2020 2066 726f  .    """.    fro
-00027e40: 6d20 7368 6170 656c 792e 6765 6f6d 6574  m shapely.geomet
-00027e50: 7279 2069 6d70 6f72 7420 506f 6c79 676f  ry import Polygo
-00027e60: 6e0a 0a20 2020 2069 6d20 3d20 7079 6669  n..    im = pyfi
-00027e70: 7473 2e6f 7065 6e28 666c 745f 6669 6c65  ts.open(flt_file
-00027e80: 290a 2020 2020 6670 203d 204e 6f6e 650a  ).    fp = None.
-00027e90: 0a20 2020 2066 6f72 2065 7874 2069 6e20  .    for ext in 
-00027ea0: 6578 7465 6e73 696f 6e73 3a0a 2020 2020  extensions:.    
-00027eb0: 2020 2020 6966 2028 2753 4349 272c 2065      if ('SCI', e
-00027ec0: 7874 2920 6e6f 7420 696e 2069 6d3a 0a20  xt) not in im:. 
-00027ed0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00027ee0: 6e75 650a 0a20 2020 2020 2020 2077 6373  nue..        wcs
-00027ef0: 203d 2070 7977 6373 2e57 4353 2869 6d5b   = pywcs.WCS(im[
-00027f00: 2753 4349 272c 2065 7874 5d2e 6865 6164  'SCI', ext].head
-00027f10: 6572 2c20 666f 626a 3d69 6d29 0a20 2020  er, fobj=im).   
-00027f20: 2020 2020 2070 5f69 203d 2050 6f6c 7967       p_i = Polyg
-00027f30: 6f6e 2877 6373 2e63 616c 635f 666f 6f74  on(wcs.calc_foot
-00027f40: 7072 696e 7428 2929 0a20 2020 2020 2020  print()).       
-00027f50: 2069 6620 6670 2069 7320 4e6f 6e65 3a0a   if fp is None:.
-00027f60: 2020 2020 2020 2020 2020 2020 6670 203d              fp =
-00027f70: 2070 5f69 0a20 2020 2020 2020 2065 6c73   p_i.        els
-00027f80: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00027f90: 7020 3d20 6670 2e75 6e69 6f6e 2870 5f69  p = fp.union(p_i
-00027fa0: 290a 2020 2020 0a20 2020 2069 6d2e 636c  ).    .    im.cl
-00027fb0: 6f73 6528 290a 2020 2020 0a20 2020 2069  ose().    .    i
-00027fc0: 6620 7061 7463 685f 6172 6773 2069 7320  f patch_args is 
-00027fd0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00027fe0: 2020 7061 7463 6820 3d20 7061 7463 685f    patch = patch_
-00027ff0: 6672 6f6d 5f70 6f6c 7967 6f6e 2866 702c  from_polygon(fp,
-00028000: 202a 2a70 6174 6368 5f61 7267 7329 0a20   **patch_args). 
-00028010: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-00028020: 7463 680a 2020 2020 656c 7365 3a0a 2020  tch.    else:.  
-00028030: 2020 2020 2020 7265 7475 726e 2066 700a        return fp.
-00028040: 0a0a 6465 6620 6d61 6b65 5f6d 6178 696d  ..def make_maxim
-00028050: 616c 5f77 6373 2866 696c 6573 2c20 7069  al_wcs(files, pi
-00028060: 7865 6c5f 7363 616c 653d 4e6f 6e65 2c20  xel_scale=None, 
-00028070: 6765 745f 6864 753d 5472 7565 2c20 7061  get_hdu=True, pa
-00028080: 643d 3930 2c20 7665 7262 6f73 653d 5472  d=90, verbose=Tr
-00028090: 7565 2c20 7468 6574 613d 302c 2070 6f6c  ue, theta=0, pol
-000280a0: 795f 6275 6666 6572 3d31 2e2f 3336 3030  y_buffer=1./3600
-000280b0: 2c20 6e73 6369 5f65 7874 656e 7369 6f6e  , nsci_extension
-000280c0: 733d 3429 3a0a 2020 2020 2222 220a 2020  s=4):.    """.  
-000280d0: 2020 436f 6d70 7574 6520 616e 2049 6d61    Compute an Ima
-000280e0: 6765 4844 5520 7769 7468 2061 2066 6f6f  geHDU with a foo
-000280f0: 7470 7269 6e74 2074 6861 7420 636f 6e74  tprint that cont
-00028100: 6169 6e73 2061 6c6c 206f 6620 6066 696c  ains all of `fil
-00028110: 6573 600a 0a20 2020 2050 6172 616d 6574  es`..    Paramet
-00028120: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00028130: 2d2d 0a20 2020 2066 696c 6573 203a 206c  --.    files : l
-00028140: 6973 740a 2020 2020 2020 2020 4c69 7374  ist.        List
-00028150: 206f 6620 4853 5420 4649 5453 2066 696c   of HST FITS fil
-00028160: 6573 2028 652e 672e 2c20 464c 542e 2920  es (e.g., FLT.) 
-00028170: 6f72 2057 4353 206f 626a 6563 7473 2e0a  or WCS objects..
-00028180: 0a20 2020 2070 6978 656c 5f73 6361 6c65  .    pixel_scale
-00028190: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
-000281a0: 2050 6978 656c 2073 6361 6c65 206f 6620   Pixel scale of 
-000281b0: 6f75 7470 7574 2057 4353 2c20 696e 2060  output WCS, in `
-000281c0: 7e61 7374 726f 7079 2e75 6e69 7473 2e61  ~astropy.units.a
-000281d0: 7263 7365 6360 2e20 2049 6620 604e 6f6e  rcsec`.  If `Non
-000281e0: 6560 2c0a 2020 2020 2020 2020 6765 7420  e`,.        get 
-000281f0: 7069 7865 6c20 7363 616c 6520 6f66 2066  pixel scale of f
-00028200: 6972 7374 2066 696c 6520 696e 2060 6669  irst file in `fi
-00028210: 6c65 7360 2e0a 0a20 2020 2067 6574 5f68  les`...    get_h
-00028220: 6475 203a 2062 6f6f 6c0a 2020 2020 2020  du : bool.      
-00028230: 2020 5365 6520 6265 6c6f 772e 0a0a 2020    See below...  
-00028240: 2020 7061 6420 3a20 666c 6f61 740a 2020    pad : float.  
-00028250: 2020 2020 2020 5061 6464 696e 6720 746f        Padding to
-00028260: 2061 6464 2074 6f20 7468 6520 746f 7461   add to the tota
-00028270: 6c20 696d 6167 6520 7369 7a65 2c20 696e  l image size, in
-00028280: 2060 7e61 7374 726f 7079 2e75 6e69 7473   `~astropy.units
-00028290: 2e61 7263 7365 6360 2e0a 0a20 2020 2074  .arcsec`...    t
-000282a0: 6865 7461 203a 2066 6c6f 6174 0a20 2020  heta : float.   
-000282b0: 2020 2020 2050 6f73 6974 696f 6e20 616e       Position an
-000282c0: 676c 652c 2064 6567 7265 6573 0a0a 2020  gle, degrees..  
-000282d0: 2020 6e73 6369 5f65 7874 656e 7369 6f6e    nsci_extension
-000282e0: 7320 3a20 696e 740a 2020 2020 2020 2020  s : int.        
-000282f0: 4e75 6d62 6572 206f 6620 2753 4349 2720  Number of 'SCI' 
-00028300: 6578 7465 6e73 696f 6e73 2074 6f20 7472  extensions to tr
-00028310: 7920 696e 2074 6865 2065 7870 6f73 7572  y in the exposur
-00028320: 6520 6669 6c65 732e 0a0a 2020 2020 5265  e files...    Re
-00028330: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00028340: 2d0a 2020 2020 6864 7520 3a20 607e 6173  -.    hdu : `~as
-00028350: 7472 6f70 792e 696f 2e66 6974 732e 496d  tropy.io.fits.Im
-00028360: 6167 6548 4455 600a 2020 2020 2020 2020  ageHDU`.        
-00028370: 4966 2060 6765 745f 6864 7560 2069 7320  If `get_hdu` is 
-00028380: 5472 7565 2e0a 0a20 2020 202d 6f72 2d0a  True...    -or-.
-00028390: 0a20 2020 2068 6561 6465 722c 2077 6373  .    header, wcs
-000283a0: 203a 2060 7e61 7374 726f 7079 2e69 6f2e   : `~astropy.io.
-000283b0: 6669 7473 2e48 6561 6465 7260 2c20 607e  fits.Header`, `~
-000283c0: 6173 7472 6f70 792e 7763 732e 5743 5360  astropy.wcs.WCS`
-000283d0: 0a20 2020 2020 2020 2049 6620 6067 6574  .        If `get
-000283e0: 5f68 6475 6020 6973 2046 616c 7365 2e0a  _hdu` is False..
-000283f0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-00028400: 6f72 7420 6e75 6d70 7920 6173 206e 700a  ort numpy as np.
-00028410: 2020 2020 6672 6f6d 2073 6861 7065 6c79      from shapely
-00028420: 2e67 656f 6d65 7472 7920 696d 706f 7274  .geometry import
-00028430: 2050 6f6c 7967 6f6e 0a0a 2020 2020 696d   Polygon..    im
-00028440: 706f 7274 2061 7374 726f 7079 2e69 6f2e  port astropy.io.
-00028450: 6669 7473 2061 7320 7079 6669 7473 0a20  fits as pyfits. 
-00028460: 2020 2069 6d70 6f72 7420 6173 7472 6f70     import astrop
-00028470: 792e 7763 7320 6173 2070 7977 6373 0a0a  y.wcs as pywcs..
-00028480: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00028490: 6528 6669 6c65 735b 305d 2c20 7079 7763  e(files[0], pywc
-000284a0: 732e 5743 5329 3a0a 2020 2020 2020 2020  s.WCS):.        
-000284b0: 2320 416c 7265 6164 7920 7763 735f 6c69  # Already wcs_li
-000284c0: 7374 0a20 2020 2020 2020 2077 6373 5f6c  st.        wcs_l
-000284d0: 6973 7420 3d20 5b28 7763 732c 2027 5743  ist = [(wcs, 'WC
-000284e0: 5327 2c20 2d31 2920 666f 7220 7763 7320  S', -1) for wcs 
-000284f0: 696e 2066 696c 6573 5d0a 2020 2020 656c  in files].    el
-00028500: 7365 3a0a 2020 2020 2020 2020 7763 735f  se:.        wcs_
-00028510: 6c69 7374 203d 205b 5d0a 2020 2020 2020  list = [].      
-00028520: 2020 666f 7220 692c 2066 696c 6520 696e    for i, file in
-00028530: 2065 6e75 6d65 7261 7465 2866 696c 6573   enumerate(files
-00028540: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00028550: 6620 6e6f 7420 6f73 2e70 6174 682e 6578  f not os.path.ex
-00028560: 6973 7473 2866 696c 6529 3a0a 2020 2020  ists(file):.    
-00028570: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00028580: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-00028590: 2020 7769 7468 2070 7966 6974 732e 6f70    with pyfits.op
-000285a0: 656e 2866 696c 6529 2061 7320 696d 3a0a  en(file) as im:.
-000285b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285c0: 666f 7220 6578 7420 696e 2072 616e 6765  for ext in range
-000285d0: 286e 7363 695f 6578 7465 6e73 696f 6e73  (nsci_extensions
-000285e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000285f0: 2020 2020 2020 2069 6620 2827 5343 4927         if ('SCI'
-00028600: 2c20 6578 742b 3129 206e 6f74 2069 6e20  , ext+1) not in 
-00028610: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-00028620: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00028630: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-00028640: 2020 2020 2020 2020 2020 7763 7320 3d20            wcs = 
-00028650: 7079 7763 732e 5743 5328 696d 5b27 5343  pywcs.WCS(im['SC
-00028660: 4927 2c20 6578 742b 315d 2e68 6561 6465  I', ext+1].heade
-00028670: 722c 2066 6f62 6a3d 696d 290a 2020 2020  r, fobj=im).    
-00028680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028690: 7763 735f 6c69 7374 2e61 7070 656e 6428  wcs_list.append(
-000286a0: 2877 6373 2c20 6669 6c65 2c20 6578 7429  (wcs, file, ext)
-000286b0: 290a 2020 2020 0a20 2020 2069 6620 7069  ).    .    if pi
-000286c0: 7865 6c5f 7363 616c 6520 6973 204e 6f6e  xel_scale is Non
-000286d0: 653a 0a20 2020 2020 2020 2070 6978 656c  e:.        pixel
-000286e0: 5f73 6361 6c65 203d 2067 6574 5f77 6373  _scale = get_wcs
-000286f0: 5f70 7363 616c 6528 7763 735f 6c69 7374  _pscale(wcs_list
-00028700: 5b30 5d5b 305d 290a 2020 2020 2020 2020  [0][0]).        
-00028710: 0a20 2020 2067 726f 7570 5f70 6f6c 7920  .    group_poly 
-00028720: 3d20 4e6f 6e65 0a20 2020 2066 6f72 2069  = None.    for i
-00028730: 2c20 2877 6373 2c20 6669 6c65 2c20 6368  , (wcs, file, ch
-00028740: 6970 2920 696e 2065 6e75 6d65 7261 7465  ip) in enumerate
-00028750: 2877 6373 5f6c 6973 7429 3a0a 2020 2020  (wcs_list):.    
-00028760: 2020 2020 705f 6920 3d20 506f 6c79 676f      p_i = Polygo
-00028770: 6e28 7763 732e 6361 6c63 5f66 6f6f 7470  n(wcs.calc_footp
-00028780: 7269 6e74 2829 290a 2020 2020 2020 2020  rint()).        
-00028790: 6966 2067 726f 7570 5f70 6f6c 7920 6973  if group_poly is
-000287a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000287b0: 2020 2069 6620 706f 6c79 5f62 7566 6665     if poly_buffe
-000287c0: 7220 3e20 303a 0a20 2020 2020 2020 2020  r > 0:.         
-000287d0: 2020 2020 2020 2067 726f 7570 5f70 6f6c         group_pol
-000287e0: 7920 3d20 705f 692e 6275 6666 6572 2831  y = p_i.buffer(1
-000287f0: 2e2f 3336 3030 290a 2020 2020 2020 2020  ./3600).        
-00028800: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00028810: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
-00028820: 706f 6c79 203d 2070 5f69 0a20 2020 2020  poly = p_i.     
-00028830: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00028840: 2020 2020 2069 6620 706f 6c79 5f62 7566       if poly_buf
-00028850: 6665 7220 3e20 303a 0a20 2020 2020 2020  fer > 0:.       
-00028860: 2020 2020 2020 2020 2067 726f 7570 5f70           group_p
-00028870: 6f6c 7920 3d20 6772 6f75 705f 706f 6c79  oly = group_poly
-00028880: 2e75 6e69 6f6e 2870 5f69 2e62 7566 6665  .union(p_i.buffe
-00028890: 7228 312e 2f33 3630 3029 290a 2020 2020  r(1./3600)).    
-000288a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000288b0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-000288c0: 6f75 705f 706f 6c79 203d 2067 726f 7570  oup_poly = group
-000288d0: 5f70 6f6c 792e 756e 696f 6e28 705f 6929  _poly.union(p_i)
-000288e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000288f0: 2020 0a20 2020 2020 2020 2078 302c 2079    .        x0, y
-00028900: 3020 3d20 6e70 2e63 6173 745b 666c 6f61  0 = np.cast[floa
-00028910: 745d 2867 726f 7570 5f70 6f6c 792e 6365  t](group_poly.ce
-00028920: 6e74 726f 6964 2e78 7929 5b3a 2c20 305d  ntroid.xy)[:, 0]
-00028930: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-00028940: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00028950: 206d 7367 203d 2027 7b30 3a3e 3364 7d2f   msg = '{0:>3d}/
-00028960: 7b31 3a3e 3364 7d3a 207b 327d 5b53 4349  {1:>3d}: {2}[SCI
-00028970: 2c7b 337d 5d20 207b 343a 3e36 2e32 667d  ,{3}]  {4:>6.2f}
-00028980: 270a 2020 2020 2020 2020 2020 2020 7072  '.            pr
-00028990: 696e 7428 6d73 672e 666f 726d 6174 2869  int(msg.format(i
-000289a0: 2c20 6c65 6e28 6669 6c65 7329 2c20 6669  , len(files), fi
-000289b0: 6c65 2c20 6368 6970 2b31 2c0a 2020 2020  le, chip+1,.    
-000289c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289d0: 2020 2020 2020 2020 2067 726f 7570 5f70           group_p
-000289e0: 6f6c 792e 6172 6561 2a33 3630 302a 6e70  oly.area*3600*np
-000289f0: 2e63 6f73 2879 302f 3138 302a 6e70 2e70  .cos(y0/180*np.p
-00028a00: 6929 0a20 2020 2020 2020 2020 2020 2020  i).             
-00028a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028a30: 2020 2020 290a 0a20 2020 2070 7820 3d20      )..    px = 
-00028a40: 6e70 2e63 6173 745b 666c 6f61 745d 2867  np.cast[float](g
-00028a50: 726f 7570 5f70 6f6c 792e 636f 6e76 6578  roup_poly.convex
-00028a60: 5f68 756c 6c2e 626f 756e 6461 7279 2e78  _hull.boundary.x
-00028a70: 7929 2e54 0a20 2020 2023 7830 2c20 7930  y).T.    #x0, y0
-00028a80: 203d 206e 702e 6361 7374 5b66 6c6f 6174   = np.cast[float
-00028a90: 5d28 6772 6f75 705f 706f 6c79 2e63 656e  ](group_poly.cen
-00028aa0: 7472 6f69 642e 7879 295b 3a2c 305d 0a0a  troid.xy)[:,0]..
-00028ab0: 2020 2020 7830 203d 2028 7078 2e6d 6178      x0 = (px.max
-00028ac0: 2861 7869 733d 3029 2b70 782e 6d69 6e28  (axis=0)+px.min(
-00028ad0: 6178 6973 3d30 2929 2f32 2e0a 0a20 2020  axis=0))/2...   
-00028ae0: 2063 6f73 6420 3d20 6e70 2e61 7272 6179   cosd = np.array
-00028af0: 285b 6e70 2e63 6f73 2878 305b 315d 2f31  ([np.cos(x0[1]/1
-00028b00: 3830 2a6e 702e 7069 292c 2031 5d29 0a0a  80*np.pi), 1])..
-00028b10: 2020 2020 5f6d 6174 203d 206e 702e 6172      _mat = np.ar
-00028b20: 7261 7928 5b5b 6e70 2e63 6f73 2874 6865  ray([[np.cos(the
-00028b30: 7461 292c 202d 6e70 2e73 696e 2874 6865  ta), -np.sin(the
-00028b40: 7461 295d 2c0a 2020 2020 2020 2020 2020  ta)],.          
-00028b50: 2020 2020 2020 2020 2020 205b 6e70 2e73             [np.s
-00028b60: 696e 2874 6865 7461 292c 206e 702e 636f  in(theta), np.co
-00028b70: 7328 7468 6574 6129 5d5d 290a 0a20 2020  s(theta)]])..   
-00028b80: 2023 2052 6f74 6174 6564 0a20 2020 2070   # Rotated.    p
-00028b90: 7220 3d20 2828 7078 2d78 3029 2a63 6f73  r = ((px-x0)*cos
-00028ba0: 6429 2e64 6f74 285f 6d61 7429 2f63 6f73  d).dot(_mat)/cos
-00028bb0: 642b 7830 0a0a 2020 2020 7369 7a65 5f61  d+x0..    size_a
-00028bc0: 7263 7365 6320 3d20 2870 722e 6d61 7828  rcsec = (pr.max(
-00028bd0: 6178 6973 3d30 292d 7072 2e6d 696e 2861  axis=0)-pr.min(a
-00028be0: 7869 733d 3029 292a 636f 7364 2a33 3630  xis=0))*cosd*360
-00028bf0: 300a 2020 2020 7378 2c20 7379 203d 2073  0.    sx, sy = s
-00028c00: 697a 655f 6172 6373 6563 0a0a 2020 2020  ize_arcsec..    
-00028c10: 2320 7378 203d 2028 7078 2e6d 6178 2829  # sx = (px.max()
-00028c20: 2d70 782e 6d69 6e28 2929 2a63 6f73 642a  -px.min())*cosd*
-00028c30: 3336 3030 2023 2061 7263 7365 630a 2020  3600 # arcsec.  
-00028c40: 2020 2320 7379 203d 2028 7079 2e6d 6178    # sy = (py.max
-00028c50: 2829 2d70 792e 6d69 6e28 2929 2a33 3630  ()-py.min())*360
-00028c60: 3020 2320 6172 6373 6563 0a0a 2020 2020  0 # arcsec..    
-00028c70: 7369 7a65 203d 206e 702e 6d61 7869 6d75  size = np.maximu
-00028c80: 6d28 7378 2b70 6164 2c20 7379 2b70 6164  m(sx+pad, sy+pad
-00028c90: 290a 0a20 2020 2069 6620 7665 7262 6f73  )..    if verbos
-00028ca0: 653a 0a20 2020 2020 2020 206d 7367 203d  e:.        msg =
-00028cb0: 2027 5c6e 2020 4d6f 7361 6963 2057 4353   '\n  Mosaic WCS
-00028cc0: 3a20 287b 303a 2e35 667d 2c7b 313a 2e35  : ({0:.5f},{1:.5
-00028cd0: 667d 2920 270a 2020 2020 2020 2020 6d73  f}) '.        ms
-00028ce0: 6720 2b3d 2027 7b32 3a2e 3166 7d5c 2778  g += '{2:.1f}\'x
-00028cf0: 7b33 3a2e 3166 7d5c 2720 207b 343a 2e33  {3:.1f}\'  {4:.3
-00028d00: 667d 222f 7069 785c 6e27 0a20 2020 2020  f}"/pix\n'.     
-00028d10: 2020 2070 7269 6e74 286d 7367 2e66 6f72     print(msg.for
-00028d20: 6d61 7428 7830 5b30 5d2c 2078 305b 315d  mat(x0[0], x0[1]
-00028d30: 2c20 2873 782b 7061 6429 2f36 302e 2c20  , (sx+pad)/60., 
-00028d40: 2873 792b 7061 6429 2f36 302e 2c20 7069  (sy+pad)/60., pi
-00028d50: 7865 6c5f 7363 616c 6529 290a 0a20 2020  xel_scale))..   
-00028d60: 206f 7574 203d 206d 616b 655f 7763 7368   out = make_wcsh
-00028d70: 6561 6465 7228 7261 3d78 305b 305d 2c20  eader(ra=x0[0], 
-00028d80: 6465 633d 7830 5b31 5d2c 0a20 2020 2020  dec=x0[1],.     
-00028d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028da0: 2020 2020 7369 7a65 3d28 7378 2b70 6164      size=(sx+pad
-00028db0: 2a32 2c20 7379 2b70 6164 2a32 292c 0a20  *2, sy+pad*2),. 
-00028dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028dd0: 2020 2020 2020 2020 7069 7873 6361 6c65          pixscale
-00028de0: 3d70 6978 656c 5f73 6361 6c65 2c0a 2020  =pixel_scale,.  
-00028df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e00: 2020 2020 2020 2067 6574 5f68 6475 3d67         get_hdu=g
-00028e10: 6574 5f68 6475 2c20 7468 6574 613d 7468  et_hdu, theta=th
-00028e20: 6574 612f 6e70 2e70 692a 3138 3029 0a0a  eta/np.pi*180)..
-00028e30: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
-00028e40: 0a64 6566 2068 616c 665f 7069 7865 6c5f  .def half_pixel_
-00028e50: 7363 616c 6528 7763 7329 3a0a 2020 2020  scale(wcs):.    
-00028e60: 2222 220a 2020 2020 4372 6561 7465 2061  """.    Create a
-00028e70: 206e 6577 2057 4353 2077 6974 6820 6861   new WCS with ha
-00028e80: 6c66 2074 6865 2070 6978 656c 2073 6361  lf the pixel sca
-00028e90: 6c65 206f 6620 616e 6f74 6865 7220 7468  le of another th
-00028ea0: 6174 2063 616e 2062 6520 0a20 2020 2062  at can be .    b
-00028eb0: 6c6f 636b 2d61 7665 7261 6765 6420 3278  lock-averaged 2x
-00028ec0: 320a 2020 2020 0a20 2020 2050 6172 616d  2.    .    Param
-00028ed0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-00028ee0: 2d2d 2d2d 0a20 2020 2077 6373 203a 2060  ----.    wcs : `
-00028ef0: 7e61 7374 726f 7079 2e77 6373 2e57 4353  ~astropy.wcs.WCS
-00028f00: 600a 2020 2020 2020 2020 496e 7075 7420  `.        Input 
-00028f10: 5743 530a 2020 2020 0a20 2020 2052 6574  WCS.    .    Ret
-00028f20: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-00028f30: 0a20 2020 2068 616c 665f 7763 7320 3a20  .    half_wcs : 
-00028f40: 607e 6173 7472 6f70 792e 7763 732e 5743  `~astropy.wcs.WC
-00028f50: 5360 0a20 2020 2020 2020 204e 6577 2057  S`.        New W
-00028f60: 4353 2077 6974 6820 736d 616c 6c65 7220  CS with smaller 
-00028f70: 7069 7865 6c73 0a20 2020 2022 2222 0a20  pixels.    """. 
-00028f80: 2020 2068 203d 2074 6f5f 6865 6164 6572     h = to_header
-00028f90: 2877 6373 290a 2020 2020 0a20 2020 2066  (wcs).    .    f
-00028fa0: 6f72 206b 2069 6e20 5b27 4e41 5849 5331  or k in ['NAXIS1
-00028fb0: 272c 2027 4e41 5849 5332 275d 3a20 232c  ', 'NAXIS2']: #,
-00028fc0: 2027 4352 5049 5831 272c 2027 4352 5049   'CRPIX1', 'CRPI
-00028fd0: 5832 275d 3a0a 2020 2020 2020 2020 685b  X2']:.        h[
-00028fe0: 6b5d 202a 3d20 320a 0a20 2020 2066 6f72  k] *= 2..    for
-00028ff0: 206b 2069 6e20 5b27 4352 5049 5831 272c   k in ['CRPIX1',
-00029000: 2027 4352 5049 5832 275d 3a0a 2020 2020   'CRPIX2']:.    
-00029010: 2020 2020 685b 6b5d 203d 2068 5b6b 5d2a      h[k] = h[k]*
-00029020: 3220 2d20 302e 350a 2020 2020 2020 2020  2 - 0.5.        
-00029030: 0a20 2020 2066 6f72 206b 2069 6e20 5b27  .    for k in ['
-00029040: 4344 315f 3127 2c20 2743 4431 5f32 272c  CD1_1', 'CD1_2',
-00029050: 2027 4344 325f 3127 2c20 2743 4432 5f32   'CD2_1', 'CD2_2
-00029060: 275d 3a0a 2020 2020 2020 2020 6966 206b  ']:.        if k
-00029070: 2069 6e20 683a 0a20 2020 2020 2020 2020   in h:.         
-00029080: 2020 2068 5b6b 5d20 2f3d 2032 0a20 2020     h[k] /= 2.   
-00029090: 200a 2020 2020 6966 2030 3a0a 2020 2020   .    if 0:.    
-000290a0: 2020 2020 2320 5465 7374 0a20 2020 2020      # Test.     
-000290b0: 2020 206e 6577 203d 2070 7977 6373 2e57     new = pywcs.W
-000290c0: 4353 2868 290a 2020 2020 2020 2020 7368  CS(h).        sh
-000290d0: 203d 206e 6577 2e70 6978 656c 5f73 6861   = new.pixel_sha
-000290e0: 7065 0a20 2020 2020 2020 200a 2020 2020  pe.        .    
-000290f0: 2020 2020 7763 6f72 6e65 7220 3d20 7763      wcorner = wc
-00029100: 732e 616c 6c5f 776f 726c 6432 7069 7828  s.all_world2pix(
-00029110: 6e65 772e 616c 6c5f 7069 7832 776f 726c  new.all_pix2worl
-00029120: 6428 5b5b 2d30 2e35 2c20 2d30 2e35 5d2c  d([[-0.5, -0.5],
-00029130: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00029140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029150: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00029160: 7368 5b30 5d2d 302e 352c 2073 685b 315d  sh[0]-0.5, sh[1]
-00029170: 2d30 2e35 5d5d 2c20 3029 2c30 290a 2020  -0.5]], 0),0).  
-00029180: 2020 2020 2020 7072 696e 7428 2773 6d61        print('sma
-00029190: 6c6c 203e 206c 6172 6765 2729 0a20 2020  ll > large').   
-000291a0: 2020 2020 2070 7269 6e74 2827 2c20 272e       print(', '.
-000291b0: 6a6f 696e 285b 6627 7b77 3a2e 3266 7d27  join([f'{w:.2f}'
-000291c0: 2066 6f72 2077 2069 6e20 7763 6f72 6e65   for w in wcorne
-000291d0: 725b 305d 5d29 290a 2020 2020 2020 2020  r[0]])).        
-000291e0: 7072 696e 7428 272c 2027 2e6a 6f69 6e28  print(', '.join(
-000291f0: 5b66 277b 773a 2e32 667d 2720 666f 7220  [f'{w:.2f}' for 
-00029200: 7720 696e 2077 636f 726e 6572 5b31 5d5d  w in wcorner[1]]
-00029210: 292c 2077 6373 2e70 6978 656c 5f73 6861  ), wcs.pixel_sha
-00029220: 7065 290a 2020 2020 2020 2020 0a20 2020  pe).        .   
-00029230: 2020 2020 2073 6820 3d20 7763 732e 7069       sh = wcs.pi
-00029240: 7865 6c5f 7368 6170 650a 2020 2020 2020  xel_shape.      
-00029250: 2020 7763 6f72 6e65 7220 3d20 6e65 772e    wcorner = new.
-00029260: 616c 6c5f 776f 726c 6432 7069 7828 7763  all_world2pix(wc
-00029270: 732e 616c 6c5f 7069 7832 776f 726c 6428  s.all_pix2world(
-00029280: 5b5b 2d30 2e35 2c20 2d30 2e35 5d2c 200a  [[-0.5, -0.5], .
-00029290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292b0: 2020 2020 2020 2020 2020 2020 205b 7368               [sh
-000292c0: 5b30 5d2d 302e 352c 2073 685b 315d 2d30  [0]-0.5, sh[1]-0
-000292d0: 2e35 5d5d 2c20 3029 2c30 290a 2020 2020  .5]], 0),0).    
-000292e0: 2020 2020 7072 696e 7428 276c 6172 6765      print('large
-000292f0: 203e 2073 6d61 6c6c 2729 0a20 2020 2020   > small').     
-00029300: 2020 2070 7269 6e74 2827 2c20 272e 6a6f     print(', '.jo
-00029310: 696e 285b 6627 7b77 3a2e 3266 7d27 2066  in([f'{w:.2f}' f
-00029320: 6f72 2077 2069 6e20 7763 6f72 6e65 725b  or w in wcorner[
-00029330: 305d 5d29 290a 2020 2020 2020 2020 7072  0]])).        pr
-00029340: 696e 7428 272c 2027 2e6a 6f69 6e28 5b66  int(', '.join([f
-00029350: 277b 773a 2e32 667d 2720 666f 7220 7720  '{w:.2f}' for w 
-00029360: 696e 2077 636f 726e 6572 5b31 5d5d 292c  in wcorner[1]]),
-00029370: 206e 6577 2e70 6978 656c 5f73 6861 7065   new.pixel_shape
-00029380: 290a 2020 2020 2020 2020 0a20 2020 206e  ).        .    n
-00029390: 6577 5f77 6373 203d 2070 7977 6373 2e57  ew_wcs = pywcs.W
-000293a0: 4353 2868 2c20 7265 6c61 783d 5472 7565  CS(h, relax=True
-000293b0: 290a 2020 2020 0a20 2020 2072 6574 7572  ).    .    retur
-000293c0: 6e20 6e65 775f 7763 730a 0a0a 6465 6620  n new_wcs...def 
-000293d0: 6865 6164 6572 5f6b 6579 735f 6672 6f6d  header_keys_from
-000293e0: 5f66 696c 656c 6973 7428 6669 7473 5f66  _filelist(fits_f
-000293f0: 696c 6573 2c20 6b65 7977 6f72 6473 3d5b  iles, keywords=[
-00029400: 5d2c 2065 7874 3d30 2c20 636f 6c6e 616d  ], ext=0, colnam
-00029410: 655f 6361 7365 3d73 7472 2e6c 6f77 6572  e_case=str.lower
-00029420: 293a 0a20 2020 2022 2222 4475 6d70 2068  ):.    """Dump h
-00029430: 6561 6465 7220 6b65 7977 6f72 6473 2074  eader keywords t
-00029440: 6f20 6120 607e 6173 7472 6f70 792e 7461  o a `~astropy.ta
-00029450: 626c 652e 5461 626c 6560 0a0a 2020 2020  ble.Table`..    
-00029460: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00029470: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6669  ---------.    fi
-00029480: 7473 5f66 696c 6573 203a 206c 6973 740a  ts_files : list.
-00029490: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
-000294a0: 4649 5453 2066 696c 656e 616d 6573 0a0a  FITS filenames..
-000294b0: 2020 2020 6b65 7977 6f72 6473 203a 206c      keywords : l
-000294c0: 6973 7420 6f72 204e 6f6e 650a 2020 2020  ist or None.    
-000294d0: 2020 2020 4c69 7374 206f 6620 6865 6164      List of head
-000294e0: 6572 206b 6579 776f 7264 7320 746f 2072  er keywords to r
-000294f0: 6574 7269 6576 652e 2020 4966 2060 4e6f  etrieve.  If `No
-00029500: 6e65 602c 2074 6865 6e20 6765 6e65 7261  ne`, then genera
-00029510: 7465 2061 206c 6973 740a 2020 2020 2020  te a list.      
-00029520: 2020 6f66 202a 616c 6c2a 206b 6579 776f    of *all* keywo
-00029530: 7264 7320 6672 6f6d 2074 6865 2066 6972  rds from the fir
-00029540: 7374 2066 696c 6520 696e 2074 6865 206c  st file in the l
-00029550: 6973 742e 0a0a 2020 2020 6578 7420 3a20  ist...    ext : 
-00029560: 696e 742c 2074 7570 6c65 0a20 2020 2020  int, tuple.     
-00029570: 2020 2046 4954 5320 6578 7465 6e73 696f     FITS extensio
-00029580: 6e20 6672 6f6d 2077 6869 6368 2074 6f20  n from which to 
-00029590: 7075 6c6c 2074 6865 2068 6561 6465 722e  pull the header.
-000295a0: 2020 4361 6e20 6265 2069 6e74 6567 6572    Can be integer
-000295b0: 206f 720a 2020 2020 2020 2020 7475 706c   or.        tupl
-000295c0: 652c 2065 2e67 2e2c 2028 2753 4349 272c  e, e.g., ('SCI',
-000295d0: 3129 2066 6f72 2048 5354 2041 4353 2f57  1) for HST ACS/W
-000295e0: 4643 3320 464c 5420 6669 6c65 732e 0a0a  FC3 FLT files...
-000295f0: 2020 2020 636f 6c6e 616d 655f 6361 7365      colname_case
-00029600: 203a 2066 756e 630a 2020 2020 2020 2020   : func.        
-00029610: 4675 6e63 7469 6f6e 2074 6f20 7365 7420  Function to set 
-00029620: 7468 6520 6361 7365 206f 6620 7468 6520  the case of the 
-00029630: 6f75 7470 7574 2063 6f6c 6e61 6d65 732c  output colnames,
-00029640: 2065 2e67 2e2c 2060 7374 722e 6c6f 7765   e.g., `str.lowe
-00029650: 7260 2c0a 2020 2020 2020 2020 6073 7472  r`,.        `str
-00029660: 2e75 7070 6572 602c 2060 7374 722e 7469  .upper`, `str.ti
-00029670: 746c 6560 2e0a 0a20 2020 2052 6574 7572  tle`...    Retur
-00029680: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00029690: 2020 2074 6162 203a 2060 7e61 7374 726f     tab : `~astro
-000296a0: 7079 2e74 6162 6c65 2e54 6162 6c65 600a  py.table.Table`.
-000296b0: 2020 2020 2020 2020 4f75 7470 7574 2074          Output t
-000296c0: 6162 6c65 2e0a 0a20 2020 2022 2222 0a20  able...    """. 
-000296d0: 2020 2069 6d70 6f72 7420 6e75 6d70 7920     import numpy 
-000296e0: 6173 206e 700a 2020 2020 696d 706f 7274  as np.    import
-000296f0: 2061 7374 726f 7079 2e69 6f2e 6669 7473   astropy.io.fits
-00029700: 2061 7320 7079 6669 7473 0a20 2020 2066   as pyfits.    f
-00029710: 726f 6d20 6173 7472 6f70 792e 7461 626c  rom astropy.tabl
-00029720: 6520 696d 706f 7274 2054 6162 6c65 0a0a  e import Table..
-00029730: 2020 2020 2320 4966 206b 6579 776f 7264      # If keyword
-00029740: 733d 4e6f 6e65 2c20 6765 7420 6675 6c6c  s=None, get full
-00029750: 206c 6973 7420 6672 6f6d 2066 6972 7374   list from first
-00029760: 2046 4954 5320 6669 6c65 0a20 2020 2069   FITS file.    i
-00029770: 6620 6b65 7977 6f72 6473 2069 7320 4e6f  f keywords is No
-00029780: 6e65 3a0a 2020 2020 2020 2020 6820 3d20  ne:.        h = 
-00029790: 7079 6669 7473 2e67 6574 6865 6164 6572  pyfits.getheader
-000297a0: 2866 6974 735f 6669 6c65 735b 305d 2c20  (fits_files[0], 
-000297b0: 6578 7429 0a20 2020 2020 2020 206b 6579  ext).        key
-000297c0: 776f 7264 7320 3d20 6c69 7374 286e 702e  words = list(np.
-000297d0: 756e 6971 7565 286c 6973 7428 682e 6b65  unique(list(h.ke
-000297e0: 7973 2829 2929 290a 2020 2020 2020 2020  ys()))).        
-000297f0: 6b65 7977 6f72 6473 2e70 6f70 286b 6579  keywords.pop(key
-00029800: 776f 7264 732e 696e 6465 7828 2727 2929  words.index(''))
-00029810: 0a20 2020 2020 2020 206b 6579 776f 7264  .        keyword
-00029820: 732e 706f 7028 6b65 7977 6f72 6473 2e69  s.pop(keywords.i
-00029830: 6e64 6578 2827 4849 5354 4f52 5927 2929  ndex('HISTORY'))
-00029840: 0a0a 2020 2020 2320 4c6f 6f70 2074 6872  ..    # Loop thr
-00029850: 6f75 6768 2066 696c 6573 0a20 2020 206c  ough files.    l
-00029860: 696e 6573 203d 205b 5d0a 2020 2020 666f  ines = [].    fo
-00029870: 7220 6669 6c65 2069 6e20 6669 7473 5f66  r file in fits_f
-00029880: 696c 6573 3a0a 2020 2020 2020 2020 6c69  iles:.        li
-00029890: 6e65 203d 205b 6669 6c65 5d0a 2020 2020  ne = [file].    
-000298a0: 2020 2020 6820 3d20 7079 6669 7473 2e67      h = pyfits.g
-000298b0: 6574 6865 6164 6572 2866 696c 652c 2065  etheader(file, e
-000298c0: 7874 290a 2020 2020 2020 2020 666f 7220  xt).        for 
-000298d0: 6b65 7920 696e 206b 6579 776f 7264 733a  key in keywords:
-000298e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000298f0: 6b65 7920 696e 2068 3a0a 2020 2020 2020  key in h:.      
-00029900: 2020 2020 2020 2020 2020 6c69 6e65 2e61            line.a
-00029910: 7070 656e 6428 685b 6b65 795d 290a 2020  ppend(h[key]).  
-00029920: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00029930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029940: 6c69 6e65 2e61 7070 656e 6428 4e6f 6e65  line.append(None
-00029950: 290a 0a20 2020 2020 2020 206c 696e 6573  )..        lines
-00029960: 2e61 7070 656e 6428 6c69 6e65 290a 0a20  .append(line).. 
-00029970: 2020 2023 2043 6f6c 756d 6e20 6e61 6d65     # Column name
-00029980: 730a 2020 2020 7461 626c 655f 6865 6164  s.    table_head
-00029990: 6572 203d 205b 636f 6c6e 616d 655f 6361  er = [colname_ca
-000299a0: 7365 286b 6579 2920 666f 7220 6b65 7920  se(key) for key 
-000299b0: 696e 205b 2766 696c 6527 5d2b 6b65 7977  in ['file']+keyw
-000299c0: 6f72 6473 5d0a 0a20 2020 2023 204f 7574  ords]..    # Out
-000299d0: 7075 7420 7461 626c 650a 2020 2020 7461  put table.    ta
-000299e0: 6220 3d20 5461 626c 6528 6461 7461 3d6e  b = Table(data=n
-000299f0: 702e 6172 7261 7928 6c69 6e65 7329 2c20  p.array(lines), 
-00029a00: 6e61 6d65 733d 7461 626c 655f 6865 6164  names=table_head
-00029a10: 6572 290a 0a20 2020 2072 6574 7572 6e20  er)..    return 
-00029a20: 7461 620a 0a0a 6465 6620 7061 7273 655f  tab...def parse_
-00029a30: 7333 5f75 726c 2875 726c 3d27 7333 3a2f  s3_url(url='s3:/
-00029a40: 2f62 7563 6b65 742f 7061 7468 2f74 6f2f  /bucket/path/to/
-00029a50: 6669 6c65 2e74 7874 2729 3a0a 2020 2020  file.txt'):.    
-00029a60: 2222 220a 2020 2020 5061 7273 6520 7333  """.    Parse s3
-00029a70: 2070 6174 6820 7374 7269 6e67 0a20 2020   path string.   
-00029a80: 200a 2020 2020 5061 7261 6d65 7465 7273   .    Parameters
-00029a90: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00029aa0: 2020 2020 7572 6c20 3a20 7374 720a 2020      url : str.  
-00029ab0: 2020 2020 2020 4675 6c6c 2053 3320 7061        Full S3 pa
-00029ac0: 7468 2c20 652e 672e 2c20 6060 5b73 333a  th, e.g., ``[s3:
-00029ad0: 2f2f 5d7b 6275 636b 6574 5f6e 616d 657d  //]{bucket_name}
-00029ae0: 2f7b 7333 5f6f 626a 6563 747d 6060 0a20  /{s3_object}``. 
-00029af0: 2020 200a 2020 2020 5265 7475 726e 730a     .    Returns.
-00029b00: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00029b10: 6275 636b 6574 5f6e 616d 6520 3a20 7374  bucket_name : st
-00029b20: 720a 2020 2020 2020 2020 4275 636b 6574  r.        Bucket
-00029b30: 206e 616d 650a 2020 2020 0a20 2020 2073   name.    .    s
-00029b40: 335f 6f62 6a65 6374 203a 2073 7472 0a20  3_object : str. 
-00029b50: 2020 2020 2020 2046 756c 6c20 7061 7468         Full path
-00029b60: 206f 6620 7468 6520 5333 2066 696c 6520   of the S3 file 
-00029b70: 6f62 6a65 6374 0a20 2020 200a 2020 2020  object.    .    
-00029b80: 6669 6c65 6e61 6d65 203a 2073 7472 0a20  filename : str. 
-00029b90: 2020 2020 2020 2046 696c 6520 6e61 6d65         File name
-00029ba0: 206f 6620 7468 6520 6f62 6a65 6374 2c20   of the object, 
-00029bb0: 652e 672e 2060 606f 732e 7061 7468 2e62  e.g. ``os.path.b
-00029bc0: 6173 656e 616d 6528 7333 5f6f 626a 6563  asename(s3_objec
-00029bd0: 7429 6060 0a20 2020 2020 2020 200a 2020  t)``.        .  
-00029be0: 2020 2222 220a 2020 2020 7375 726c 203d    """.    surl =
-00029bf0: 2075 726c 2e73 7472 6970 2827 7333 3a2f   url.strip('s3:/
-00029c00: 2f27 290a 2020 2020 7370 6c20 3d20 7375  /').    spl = su
-00029c10: 726c 2e73 706c 6974 2827 2f27 290a 2020  rl.split('/').  
-00029c20: 2020 6966 206c 656e 2873 706c 2920 3c20    if len(spl) < 
-00029c30: 323a 0a20 2020 2020 2020 2070 7269 6e74  2:.        print
-00029c40: 2866 2262 7563 6b65 7420 2f20 7061 7468  (f"bucket / path
-00029c50: 206e 6f74 2066 6f75 6e64 2069 6e20 7b75   not found in {u
-00029c60: 726c 7d22 290a 2020 2020 2020 2020 7265  rl}").        re
-00029c70: 7475 726e 204e 6f6e 652c 204e 6f6e 652c  turn None, None,
-00029c80: 204e 6f6e 650a 2020 2020 2020 2020 0a20   None.        . 
-00029c90: 2020 2062 7563 6b65 745f 6e61 6d65 203d     bucket_name =
-00029ca0: 2073 706c 5b30 5d0a 2020 2020 7333 5f6f   spl[0].    s3_o
-00029cb0: 626a 6563 7420 3d20 272f 272e 6a6f 696e  bject = '/'.join
-00029cc0: 2873 706c 5b31 3a5d 290a 2020 2020 6669  (spl[1:]).    fi
-00029cd0: 6c65 6e61 6d65 203d 206f 732e 7061 7468  lename = os.path
-00029ce0: 2e62 6173 656e 616d 6528 7333 5f6f 626a  .basename(s3_obj
-00029cf0: 6563 7429 0a20 2020 2072 6574 7572 6e20  ect).    return 
-00029d00: 6275 636b 6574 5f6e 616d 652c 2073 335f  bucket_name, s3_
-00029d10: 6f62 6a65 6374 2c20 6669 6c65 6e61 6d65  object, filename
-00029d20: 0a0a 0a64 6566 2066 6574 6368 5f73 335f  ...def fetch_s3_
-00029d30: 7572 6c28 7572 6c3d 2773 333a 2f2f 6275  url(url='s3://bu
-00029d40: 636b 6574 2f70 6174 682f 746f 2f66 696c  cket/path/to/fil
-00029d50: 652e 7478 7427 2c20 6669 6c65 5f66 756e  e.txt', file_fun
-00029d60: 633d 6c61 6d62 6461 2078 203a 206f 732e  c=lambda x : os.
-00029d70: 7061 7468 2e6a 6f69 6e28 272e 2f27 2c78  path.join('./',x
-00029d80: 292c 2073 6b69 705f 6578 6973 7469 6e67  ), skip_existing
-00029d90: 3d54 7275 652c 2076 6572 626f 7365 3d54  =True, verbose=T
-00029da0: 7275 6529 3a0a 2020 2020 2222 220a 2020  rue):.    """.  
-00029db0: 2020 4665 7463 6820 6669 6c65 2066 726f    Fetch file fro
-00029dc0: 6d20 616e 2053 3320 6275 636b 6574 0a20  m an S3 bucket. 
-00029dd0: 2020 200a 2020 2020 5061 7261 6d65 7465     .    Paramete
-00029de0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00029df0: 2d0a 2020 2020 7572 6c20 3a20 7374 720a  -.    url : str.
-00029e00: 2020 2020 2020 2020 5333 2075 726c 206f          S3 url o
-00029e10: 6620 6120 6669 6c65 2074 6f20 646f 776e  f a file to down
-00029e20: 6c6f 6164 0a20 2020 200a 2020 2020 6669  load.    .    fi
-00029e30: 6c65 5f66 756e 6320 3a20 6675 6e63 7469  le_func : functi
-00029e40: 6f6e 0a20 2020 2020 2020 2046 756e 6374  on.        Funct
-00029e50: 696f 6e20 6170 706c 6965 6420 746f 2074  ion applied to t
-00029e60: 6865 2066 696c 6520 6e61 6d65 2065 7874  he file name ext
-00029e70: 7261 6374 6564 2066 726f 6d20 6075 726c  racted from `url
-00029e80: 602c 2065 2e67 2e2c 2074 6f20 0a20 2020  `, e.g., to .   
-00029e90: 2020 2020 2073 6574 206f 7574 7075 7420       set output 
-00029ea0: 6469 7265 6374 6f72 792c 2072 656e 616d  directory, renam
-00029eb0: 6520 6669 6c65 732c 2073 6574 2061 2070  e files, set a p
-00029ec0: 7265 6669 782c 2065 7463 2e0a 2020 2020  refix, etc..    
-00029ed0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-00029ee0: 202d 2d2d 2d2d 2d2d 0a20 2020 206c 6f63   -------.    loc
-00029ef0: 616c 5f66 696c 6520 3a20 7374 720a 2020  al_file : str.  
-00029f00: 2020 2020 2020 4e61 6d65 206f 6620 6c6f        Name of lo
-00029f10: 6361 6c20 6669 6c65 206f 7220 604e 6f6e  cal file or `Non
-00029f20: 6560 2069 6620 6661 696c 6564 2074 6f20  e` if failed to 
-00029f30: 7061 7273 6520 6075 726c 600a 2020 2020  parse `url`.    
-00029f40: 0a20 2020 2073 7461 7475 7320 3a20 696e  .    status : in
-00029f50: 740a 2020 2020 2020 2020 4269 7420 666c  t.        Bit fl
-00029f60: 6167 206f 6620 7265 7375 6c74 733a 202a  ag of results: *
-00029f70: 2a31 2a2a 203d 3d20 6669 6c65 2066 6f75  *1** == file fou
-00029f80: 6e64 2c20 2a2a 322a 2a20 3d20 646f 776e  nd, **2** = down
-00029f90: 6c6f 6164 2073 7563 6365 7373 6675 6c0a  load successful.
-00029fa0: 2020 2020 2020 2020 0a20 2020 2022 2222          .    """
-00029fb0: 0a20 2020 2069 6d70 6f72 7420 7472 6163  .    import trac
-00029fc0: 6562 6163 6b0a 2020 2020 696d 706f 7274  eback.    import
-00029fd0: 2062 6f74 6f33 0a20 2020 2069 6d70 6f72   boto3.    impor
-00029fe0: 7420 626f 746f 636f 7265 2e65 7863 6570  t botocore.excep
-00029ff0: 7469 6f6e 730a 2020 2020 0a20 2020 2073  tions.    .    s
-0002a000: 3320 3d20 626f 746f 332e 7265 736f 7572  3 = boto3.resour
-0002a010: 6365 2827 7333 2729 0a20 2020 2062 7563  ce('s3').    buc
-0002a020: 6b65 745f 6e61 6d65 2c20 7333 5f6f 626a  ket_name, s3_obj
-0002a030: 6563 742c 2066 696c 656e 616d 6520 3d20  ect, filename = 
-0002a040: 7061 7273 655f 7333 5f75 726c 2875 726c  parse_s3_url(url
-0002a050: 3d75 726c 290a 2020 2020 6966 2062 7563  =url).    if buc
-0002a060: 6b65 745f 6e61 6d65 2069 7320 4e6f 6e65  ket_name is None
-0002a070: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0002a080: 2075 726c 2c20 6f73 2e70 6174 682e 6578   url, os.path.ex
-0002a090: 6973 7473 2875 726c 290a 2020 2020 2020  ists(url).      
-0002a0a0: 2020 0a20 2020 2062 6b74 203d 2073 332e    .    bkt = s3.
-0002a0b0: 4275 636b 6574 2862 7563 6b65 745f 6e61  Bucket(bucket_na
-0002a0c0: 6d65 290a 2020 2020 6c6f 6361 6c5f 6669  me).    local_fi
-0002a0d0: 6c65 203d 2066 696c 655f 6675 6e63 2866  le = file_func(f
-0002a0e0: 696c 656e 616d 6529 0a20 2020 2073 7461  ilename).    sta
-0002a0f0: 7475 7320 3d20 6f73 2e70 6174 682e 6578  tus = os.path.ex
-0002a100: 6973 7473 286c 6f63 616c 5f66 696c 6529  ists(local_file)
-0002a110: 2a31 0a20 2020 200a 2020 2020 6966 2028  *1.    .    if (
-0002a120: 7374 6174 7573 203e 2030 2920 2620 736b  status > 0) & sk
-0002a130: 6970 5f65 7869 7374 696e 673a 0a20 2020  ip_existing:.   
-0002a140: 2020 2020 2070 7269 6e74 2866 277b 6c6f       print(f'{lo
-0002a150: 6361 6c5f 6669 6c65 7d20 6578 6973 7473  cal_file} exists
-0002a160: 2c20 736b 6970 7069 6e67 2e27 290a 2020  , skipping.').  
-0002a170: 2020 656c 7365 3a0a 0a20 2020 2020 2020    else:..       
-0002a180: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0002a190: 2020 626b 742e 646f 776e 6c6f 6164 5f66    bkt.download_f
-0002a1a0: 696c 6528 7333 5f6f 626a 6563 742c 206c  ile(s3_object, l
-0002a1b0: 6f63 616c 5f66 696c 652c 0a20 2020 2020  ocal_file,.     
-0002a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a1d0: 2045 7874 7261 4172 6773 3d7b 2252 6571   ExtraArgs={"Req
-0002a1e0: 7565 7374 5061 7965 7222 3a20 2272 6571  uestPayer": "req
-0002a1f0: 7565 7374 6572 227d 290a 2020 2020 2020  uester"}).      
-0002a200: 2020 2020 2020 7374 6174 7573 202b 3d20        status += 
-0002a210: 320a 2020 2020 2020 2020 2020 2020 6966  2.            if
-0002a220: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0002a230: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002a240: 6627 7b75 726c 7d20 3e20 7b6c 6f63 616c  f'{url} > {local
-0002a250: 5f66 696c 657d 2729 0a20 2020 2020 2020  _file}').       
-0002a260: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0002a270: 2020 6578 6365 7074 2062 6f74 6f63 6f72    except botocor
-0002a280: 652e 6578 6365 7074 696f 6e73 2e43 6c69  e.exceptions.Cli
-0002a290: 656e 7445 7272 6f72 3a0a 2020 2020 2020  entError:.      
-0002a2a0: 2020 2020 2020 7472 6163 6520 3d20 7472        trace = tr
-0002a2b0: 6163 6562 6163 6b2e 666f 726d 6174 5f65  aceback.format_e
-0002a2c0: 7863 286c 696d 6974 3d32 290a 2020 2020  xc(limit=2).    
-0002a2d0: 2020 2020 2020 2020 6d73 6720 3d20 7472          msg = tr
-0002a2e0: 6163 652e 7370 6c69 7428 275c 6e27 295b  ace.split('\n')[
-0002a2f0: 2d32 5d2e 7370 6c69 7428 2743 6c69 656e  -2].split('Clien
-0002a300: 7445 7272 6f72 3a20 2729 5b31 5d0a 2020  tError: ')[1].  
-0002a310: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-0002a320: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0002a330: 2020 2020 2020 7072 696e 7428 6627 4661        print(f'Fa
-0002a340: 696c 6564 207b 7572 6c7d 3a20 7b6d 7367  iled {url}: {msg
-0002a350: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
-0002a360: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0002a370: 2023 2044 6f77 6e6c 6f61 6420 6661 696c   # Download fail
-0002a380: 6564 2064 7565 2074 6f20 6120 436c 6965  ed due to a Clie
-0002a390: 6e74 4572 726f 720a 2020 2020 2020 2020  ntError.        
-0002a3a0: 2020 2020 2320 466f 7262 6964 6465 6e20      # Forbidden 
-0002a3b0: 7072 6f62 6162 6c79 206d 6561 6e73 2069  probably means i
-0002a3c0: 6e73 7566 6669 6369 656e 7420 6275 636b  nsufficient buck
-0002a3d0: 6574 2061 6363 6573 7320 7072 6976 696c  et access privil
-0002a3e0: 6567 6573 0a20 2020 2020 2020 2020 2020  eges.           
-0002a3f0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-0002a400: 2020 0a20 2020 2072 6574 7572 6e20 6c6f    .    return lo
-0002a410: 6361 6c5f 6669 6c65 2c20 7374 6174 7573  cal_file, status
-0002a420: 0a0a 0a64 6566 206e 6972 6973 735f 6768  ...def niriss_gh
-0002a430: 6f73 745f 6d61 736b 2869 6d2c 2069 6e69  ost_mask(im, ini
-0002a440: 745f 7468 7265 7368 3d30 2e30 352c 2069  t_thresh=0.05, i
-0002a450: 6e69 745f 7369 676d 613d 332c 2066 696e  nit_sigma=3, fin
-0002a460: 616c 5f74 6872 6573 683d 302e 3031 2c20  al_thresh=0.01, 
-0002a470: 6669 6e61 6c5f 7369 676d 613d 332c 2065  final_sigma=3, e
-0002a480: 726f 7369 6f6e 733d 302c 2064 696c 6174  rosions=0, dilat
-0002a490: 696f 6e73 3d39 2c20 7665 7262 6f73 653d  ions=9, verbose=
-0002a4a0: 5472 7565 2c20 2a2a 6b77 6172 6773 293a  True, **kwargs):
-0002a4b0: 0a20 2020 2022 2222 0a20 2020 204d 616b  .    """.    Mak
-0002a4c0: 6520 6120 6d61 736b 2066 6f72 204e 4952  e a mask for NIR
-0002a4d0: 4953 5320 696d 6167 696e 6720 6768 6f73  ISS imaging ghos
-0002a4e0: 7473 0a20 2020 200a 2020 2020 5365 6520  ts.    .    See 
-0002a4f0: 616c 736f 204d 6172 7465 6c2e 204a 5753  also Martel. JWS
-0002a500: 542d 5354 5363 492d 3030 3438 3737 2061  T-STScI-004877 a
-0002a510: 6e64 0a20 2020 2068 7474 7073 3a2f 2f67  nd.    https://g
-0002a520: 6974 6875 622e 636f 6d2f 7370 6163 6574  ithub.com/spacet
-0002a530: 656c 6573 636f 7065 2f6e 6972 6973 735f  elescope/niriss_
-0002a540: 6768 6f73 740a 2020 2020 0a20 2020 2048  ghost.    .    H
-0002a550: 6572 650a 2020 2020 2222 220a 2020 2020  ere.    """.    
-0002a560: 696d 706f 7274 2073 6369 7079 2e6e 6469  import scipy.ndi
-0002a570: 6d61 6765 2061 7320 6e64 0a20 2020 200a  mage as nd.    .
-0002a580: 2020 2020 6966 2069 6d5b 305d 2e68 6561      if im[0].hea
-0002a590: 6465 725b 2750 5550 494c 275d 206e 6f74  der['PUPIL'] not
-0002a5a0: 2069 6e20 5b27 4631 3135 5727 2c27 4631   in ['F115W','F1
-0002a5b0: 3530 5727 2c27 4632 3030 5727 5d3a 0a20  50W','F200W']:. 
-0002a5c0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0002a5d0: 6c73 650a 2020 2020 0a20 2020 2069 6620  lse.    .    if 
-0002a5e0: 696d 5b30 5d2e 6865 6164 6572 5b27 5055  im[0].header['PU
-0002a5f0: 5049 4c27 5d20 3d3d 2027 4631 3135 5727  PIL'] == 'F115W'
-0002a600: 3a0a 2020 2020 2020 2020 7867 6170 2c20  :.        xgap, 
-0002a610: 7967 6170 203d 2031 3135 362c 2039 3237  ygap = 1156, 927
-0002a620: 0a20 2020 2065 6c69 6620 696d 5b30 5d2e  .    elif im[0].
-0002a630: 6865 6164 6572 5b27 5055 5049 4c27 5d20  header['PUPIL'] 
-0002a640: 3d3d 2027 4631 3135 5727 3a0a 2020 2020  == 'F115W':.    
-0002a650: 2020 2020 7867 6170 2c20 7967 6170 203d      xgap, ygap =
-0002a660: 2031 3136 322c 2039 3338 0a20 2020 2065   1162, 938.    e
-0002a670: 6c73 653a 0a20 2020 2020 2020 2078 6761  lse:.        xga
-0002a680: 702c 2079 6761 7020 3d20 3131 3536 2c20  p, ygap = 1156, 
-0002a690: 3934 342d 320a 2020 2020 2020 2020 0a20  944-2.        . 
-0002a6a0: 2020 2079 702c 2078 7020 3d20 6e70 2e69     yp, xp = np.i
-0002a6b0: 6e64 6963 6573 2828 3230 3438 2c20 3230  ndices((2048, 20
-0002a6c0: 3438 2929 0a20 2020 200a 2020 2020 7967  48)).    .    yg
-0002a6d0: 203d 2032 2a28 7967 6170 2d31 2920 2d20   = 2*(ygap-1) - 
-0002a6e0: 7970 0a20 2020 2078 6720 3d20 322a 2878  yp.    xg = 2*(x
-0002a6f0: 6761 702d 3129 202d 2078 700a 0a20 2020  gap-1) - xp..   
-0002a700: 2064 7820 3d20 2878 7020 2d20 7867 6170   dx = (xp - xgap
-0002a710: 290a 2020 2020 6479 203d 2028 7970 202d  ).    dy = (yp -
-0002a720: 2079 6761 7029 0a0a 2020 2020 696e 5f69   ygap)..    in_i
-0002a730: 6d67 203d 2028 7867 203e 3d20 3029 2026  mg = (xg >= 0) &
-0002a740: 2028 7867 203c 2032 3034 3829 0a20 2020   (xg < 2048).   
-0002a750: 2069 6e5f 696d 6720 263d 2028 7967 203e   in_img &= (yg >
-0002a760: 3d20 3029 2026 2028 7967 203c 2032 3034  = 0) & (yg < 204
-0002a770: 3829 0a0a 2020 2020 696e 5f69 6d67 2026  8)..    in_img &
-0002a780: 3d20 6e70 2e61 6273 2864 7829 203c 2034  = np.abs(dx) < 4
-0002a790: 3030 0a20 2020 2069 6e5f 696d 6720 263d  00.    in_img &=
-0002a7a0: 206e 702e 6162 7328 6479 2920 3c20 3430   np.abs(dy) < 40
-0002a7b0: 300a 2020 2020 0a20 2020 2069 6620 274d  0.    .    if 'M
-0002a7c0: 4452 495a 534b 5927 2069 6e20 696d 5b27  DRIZSKY' in im['
-0002a7d0: 5343 4927 5d2e 6865 6164 6572 3a0a 2020  SCI'].header:.  
-0002a7e0: 2020 2020 2020 626b 6720 3d20 696d 5b27        bkg = im['
-0002a7f0: 5343 4927 5d2e 6865 6164 6572 5b27 4d44  SCI'].header['MD
-0002a800: 5249 5a53 4b59 275d 0a20 2020 2065 6c73  RIZSKY'].    els
-0002a810: 653a 0a20 2020 2020 2020 2062 6b67 203d  e:.        bkg =
-0002a820: 206e 702e 6e61 6e6d 6564 6961 6e28 696d   np.nanmedian(im
-0002a830: 5b27 5343 4927 5d2e 6461 7461 5b69 6d5b  ['SCI'].data[im[
-0002a840: 2744 5127 5d2e 6461 7461 203d 3d20 305d  'DQ'].data == 0]
-0002a850: 290a 2020 2020 2020 2020 0a20 2020 2074  ).        .    t
-0002a860: 6872 6573 6820 3d20 2869 6d5b 2753 4349  hresh = (im['SCI
-0002a870: 275d 2e64 6174 6120 2d20 626b 6729 2a69  '].data - bkg)*i
-0002a880: 6e69 745f 7468 7265 7368 203e 2069 6e69  nit_thresh > ini
-0002a890: 745f 7369 676d 612a 696d 5b27 4552 5227  t_sigma*im['ERR'
-0002a8a0: 5d2e 6461 7461 0a20 2020 2074 6872 6573  ].data.    thres
-0002a8b0: 6820 263d 2069 6e5f 696d 670a 0a20 2020  h &= in_img..   
-0002a8c0: 205f 7265 666c 6563 7465 6420 3d20 6e70   _reflected = np
-0002a8d0: 2e7a 6572 6f73 5f6c 696b 6528 696d 5b27  .zeros_like(im['
-0002a8e0: 5343 4927 5d2e 6461 7461 290a 2020 2020  SCI'].data).    
-0002a8f0: 666f 7220 7870 692c 2079 7069 2c20 7867  for xpi, ypi, xg
-0002a900: 692c 2079 6769 2069 6e20 7a69 7028 7870  i, ygi in zip(xp
-0002a910: 5b74 6872 6573 685d 2c20 7970 5b74 6872  [thresh], yp[thr
-0002a920: 6573 685d 2c0a 2020 2020 2020 2020 2020  esh],.          
-0002a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a940: 2020 2020 2020 2020 7867 5b74 6872 6573          xg[thres
-0002a950: 685d 2c20 7967 5b74 6872 6573 685d 293a  h], yg[thresh]):
-0002a960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a980: 2020 200a 2020 2020 2020 2020 5f72 6566     .        _ref
-0002a990: 6c65 6374 6564 5b79 6769 2c20 7867 695d  lected[ygi, xgi]
-0002a9a0: 203d 2069 6d5b 2753 4349 275d 2e64 6174   = im['SCI'].dat
-0002a9b0: 615b 7970 692c 2078 7069 5d20 2d20 626b  a[ypi, xpi] - bk
-0002a9c0: 670a 0a20 2020 2067 686f 7374 5f6d 6173  g..    ghost_mas
-0002a9d0: 6b20 3d20 5f72 6566 6c65 6374 6564 2a66  k = _reflected*f
-0002a9e0: 696e 616c 5f74 6872 6573 6820 3e20 6669  inal_thresh > fi
-0002a9f0: 6e61 6c5f 7369 676d 612a 696d 5b27 4552  nal_sigma*im['ER
-0002aa00: 5227 5d2e 6461 7461 0a20 2020 200a 2020  R'].data.    .  
-0002aa10: 2020 6966 2065 726f 7369 6f6e 7320 3e20    if erosions > 
-0002aa20: 303a 0a20 2020 2020 2020 2067 686f 7374  0:.        ghost
-0002aa30: 5f6d 6173 6b20 3d20 6e64 2e62 696e 6172  _mask = nd.binar
-0002aa40: 795f 6572 6f73 696f 6e28 6768 6f73 745f  y_erosion(ghost_
-0002aa50: 6d61 736b 2c20 6974 6572 6174 696f 6e73  mask, iterations
-0002aa60: 3d65 726f 7369 6f6e 7329 0a20 2020 2020  =erosions).     
-0002aa70: 2020 200a 2020 2020 6768 6f73 745f 6d61     .    ghost_ma
-0002aa80: 736b 203d 206e 642e 6269 6e61 7279 5f64  sk = nd.binary_d
-0002aa90: 696c 6174 696f 6e28 6768 6f73 745f 6d61  ilation(ghost_ma
-0002aaa0: 736b 2c20 6974 6572 6174 696f 6e73 3d64  sk, iterations=d
-0002aab0: 696c 6174 696f 6e73 290a 2020 2020 0a20  ilations).    . 
-0002aac0: 2020 2069 6d5b 305d 2e68 6561 6465 725b     im[0].header[
-0002aad0: 2747 484f 5354 4d53 4b27 5d20 3d20 5472  'GHOSTMSK'] = Tr
-0002aae0: 7565 2c20 274e 4952 4953 5320 6768 6f73  ue, 'NIRISS ghos
-0002aaf0: 7420 6d61 736b 2061 7070 6c69 6564 270a  t mask applied'.
-0002ab00: 2020 2020 696d 5b30 5d2e 6865 6164 6572      im[0].header
-0002ab10: 5b27 4748 4f53 544e 5058 275d 203d 2067  ['GHOSTNPX'] = g
-0002ab20: 686f 7374 5f6d 6173 6b2e 7375 6d28 292c  host_mask.sum(),
-0002ab30: 2027 5069 7865 6c73 2069 6e20 4e49 5249   'Pixels in NIRI
-0002ab40: 5353 2067 686f 7374 206d 6173 6b27 0a20  SS ghost mask'. 
-0002ab50: 2020 200a 2020 2020 6d73 6720 3d20 274e     .    msg = 'N
-0002ab60: 4952 4953 5320 6768 6f73 7420 6d61 736b  IRISS ghost mask
-0002ab70: 207b 307d 204e 7069 783a 207b 317d 5c6e   {0} Npix: {1}\n
-0002ab80: 272e 666f 726d 6174 2869 6d5b 305d 2e68  '.format(im[0].h
-0002ab90: 6561 6465 725b 2750 5550 494c 275d 2c20  eader['PUPIL'], 
-0002aba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000275b0: 2020 2020 202d 3332 202f 2061 7272 6179       -32 / array
+000275c0: 2064 6174 6120 7479 7065 0a20 2020 2020   data type.     
+000275d0: 2020 204e 4158 4953 2020 203d 2020 2020     NAXIS   =    
+000275e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000275f0: 3220 2f20 6e75 6d62 6572 206f 6620 6172  2 / number of ar
+00027600: 7261 7920 6469 6d65 6e73 696f 6e73 0a20  ray dimensions. 
+00027610: 2020 2020 2020 2050 434f 554e 5420 203d         PCOUNT  =
+00027620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027630: 2020 2020 3020 2f20 6e75 6d62 6572 206f      0 / number o
+00027640: 6620 7061 7261 6d65 7465 7273 0a20 2020  f parameters.   
+00027650: 2020 2020 2047 434f 554e 5420 203d 2020       GCOUNT  =  
+00027660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027670: 2020 3120 2f20 6e75 6d62 6572 206f 6620    1 / number of 
+00027680: 6772 6f75 7073 0a20 2020 2020 2020 2043  groups.        C
+00027690: 5250 4958 3120 203d 2020 2020 2020 2020  RPIX1  =        
+000276a0: 2020 2020 2020 2020 2020 2031 300a 2020             10.  
+000276b0: 2020 2020 2020 4352 5049 5832 2020 3d20        CRPIX2  = 
+000276c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000276d0: 2020 3130 0a20 2020 2020 2020 2043 5256    10.        CRV
+000276e0: 414c 3120 203d 2020 2020 2020 2020 2020  AL1  =          
+000276f0: 2020 2034 302e 3037 3239 330a 2020 2020     40.07293.    
+00027700: 2020 2020 4352 5641 4c32 2020 3d20 2020      CRVAL2  =   
+00027710: 2020 2020 2020 2020 2d31 2e36 3133 3737          -1.61377
+00027720: 3438 0a20 2020 2020 2020 2043 4431 5f31  48.        CD1_1
+00027730: 2020 203d 202d 322e 3737 3737 3737 3737     = -2.77777777
+00027740: 3737 3737 3745 2d30 350a 2020 2020 2020  77777E-05.      
+00027750: 2020 4344 315f 3220 2020 3d20 2020 2020    CD1_2   =     
+00027760: 2020 2020 2020 2020 2020 2020 2030 2e30               0.0
+00027770: 0a20 2020 2020 2020 2043 4432 5f31 2020  .        CD2_1  
+00027780: 203d 2020 2020 2020 2020 2020 2020 2020   =              
+00027790: 2020 2020 302e 300a 2020 2020 2020 2020      0.0.        
+000277a0: 4344 325f 3220 2020 3d20 322e 3737 3737  CD2_2   = 2.7777
+000277b0: 3737 3737 3737 3737 3737 452d 3035 0a20  7777777777E-05. 
+000277c0: 2020 2020 2020 204e 4158 4953 3120 203d         NAXIS1  =
+000277d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000277e0: 2020 2032 300a 2020 2020 2020 2020 4e41     20.        NA
+000277f0: 5849 5332 2020 3d20 2020 2020 2020 2020  XIS2  =         
+00027800: 2020 2020 2020 2020 2020 3230 0a20 2020            20.   
+00027810: 2020 2020 2043 5459 5045 3120 203d 2027       CTYPE1  = '
+00027820: 5241 2d2d 2d54 414e 270a 2020 2020 2020  RA---TAN'.      
+00027830: 2020 4354 5950 4532 2020 3d20 2744 4543    CTYPE2  = 'DEC
+00027840: 2d2d 5441 4e27 0a20 2020 2022 2222 0a0a  --TAN'.    """..
+00027850: 2020 2020 6966 206e 702e 6973 7363 616c      if np.isscal
+00027860: 6172 2870 6978 7363 616c 6529 3a0a 2020  ar(pixscale):.  
+00027870: 2020 2020 2020 6364 656c 7420 3d20 5b70        cdelt = [p
+00027880: 6978 7363 616c 652f 3336 3030 2e5d 2a32  ixscale/3600.]*2
+00027890: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000278a0: 2020 2063 6465 6c74 203d 205b 7069 7873     cdelt = [pixs
+000278b0: 6361 6c65 5b30 5d2f 3336 3030 2e2c 2070  cale[0]/3600., p
+000278c0: 6978 7363 616c 655b 315d 2f33 3630 302e  ixscale[1]/3600.
+000278d0: 5d0a 0a20 2020 2069 6620 6e70 2e69 7373  ]..    if np.iss
+000278e0: 6361 6c61 7228 7369 7a65 293a 0a20 2020  calar(size):.   
+000278f0: 2020 2020 206e 7069 7820 3d20 6e70 2e63       npix = np.c
+00027900: 6173 745b 696e 745d 286e 702e 726f 756e  ast[int](np.roun
+00027910: 6428 5b73 697a 652f 7069 7873 6361 6c65  d([size/pixscale
+00027920: 2c20 7369 7a65 2f70 6978 7363 616c 655d  , size/pixscale]
+00027930: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
+00027940: 2020 2020 206e 7069 7820 3d20 6e70 2e63       npix = np.c
+00027950: 6173 745b 696e 745d 286e 702e 726f 756e  ast[int](np.roun
+00027960: 6428 5b73 697a 655b 305d 2f70 6978 7363  d([size[0]/pixsc
+00027970: 616c 652c 2073 697a 655b 315d 2f70 6978  ale, size[1]/pix
+00027980: 7363 616c 655d 2929 0a0a 2020 2020 686f  scale]))..    ho
+00027990: 7574 203d 2070 7966 6974 732e 4865 6164  ut = pyfits.Head
+000279a0: 6572 2829 0a20 2020 2068 6f75 745b 2743  er().    hout['C
+000279b0: 5250 4958 3127 5d20 3d20 286e 7069 785b  RPIX1'] = (npix[
+000279c0: 305d 2d31 292f 322b 310a 2020 2020 686f  0]-1)/2+1.    ho
+000279d0: 7574 5b27 4352 5049 5832 275d 203d 2028  ut['CRPIX2'] = (
+000279e0: 6e70 6978 5b31 5d2d 3129 2f32 2b31 0a20  npix[1]-1)/2+1. 
+000279f0: 2020 2068 6f75 745b 2743 5256 414c 3127     hout['CRVAL1'
+00027a00: 5d20 3d20 7261 0a20 2020 2068 6f75 745b  ] = ra.    hout[
+00027a10: 2743 5256 414c 3227 5d20 3d20 6465 630a  'CRVAL2'] = dec.
+00027a20: 2020 2020 686f 7574 5b27 4344 315f 3127      hout['CD1_1'
+00027a30: 5d20 3d20 2d63 6465 6c74 5b30 5d0a 2020  ] = -cdelt[0].  
+00027a40: 2020 686f 7574 5b27 4344 315f 3227 5d20    hout['CD1_2'] 
+00027a50: 3d20 686f 7574 5b27 4344 325f 3127 5d20  = hout['CD2_1'] 
+00027a60: 3d20 302e 0a20 2020 2068 6f75 745b 2743  = 0..    hout['C
+00027a70: 4432 5f32 275d 203d 2063 6465 6c74 5b31  D2_2'] = cdelt[1
+00027a80: 5d0a 2020 2020 686f 7574 5b27 4e41 5849  ].    hout['NAXI
+00027a90: 5331 275d 203d 206e 7069 785b 305d 0a20  S1'] = npix[0]. 
+00027aa0: 2020 2068 6f75 745b 274e 4158 4953 3227     hout['NAXIS2'
+00027ab0: 5d20 3d20 6e70 6978 5b31 5d0a 2020 2020  ] = npix[1].    
+00027ac0: 686f 7574 5b27 4354 5950 4531 275d 203d  hout['CTYPE1'] =
+00027ad0: 2027 5241 2d2d 2d54 414e 270a 2020 2020   'RA---TAN'.    
+00027ae0: 686f 7574 5b27 4354 5950 4532 275d 203d  hout['CTYPE2'] =
+00027af0: 2027 4445 432d 2d54 414e 270a 0a20 2020   'DEC--TAN'..   
+00027b00: 2068 6f75 745b 2752 4144 4553 5953 275d   hout['RADESYS']
+00027b10: 203d 2027 4943 5253 270a 2020 2020 686f   = 'ICRS'.    ho
+00027b20: 7574 5b27 4551 5549 4e4f 5827 5d20 3d20  ut['EQUINOX'] = 
+00027b30: 3230 3030 0a20 2020 2068 6f75 745b 274c  2000.    hout['L
+00027b40: 4154 504f 4c45 275d 203d 2068 6f75 745b  ATPOLE'] = hout[
+00027b50: 2743 5256 414c 3227 5d0a 2020 2020 686f  'CRVAL2'].    ho
+00027b60: 7574 5b27 4c4f 4e50 4f4c 4527 5d20 3d20  ut['LONPOLE'] = 
+00027b70: 3138 300a 0a20 2020 2068 6f75 745b 2750  180..    hout['P
+00027b80: 4958 4153 4543 275d 203d 2070 6978 7363  IXASEC'] = pixsc
+00027b90: 616c 652c 2027 5069 7865 6c20 7363 616c  ale, 'Pixel scal
+00027ba0: 6520 696e 2061 7263 7365 6327 0a0a 2020  e in arcsec'..  
+00027bb0: 2020 7763 735f 6f75 7420 3d20 7079 7763    wcs_out = pywc
+00027bc0: 732e 5743 5328 686f 7574 290a 0a20 2020  s.WCS(hout)..   
+00027bd0: 2074 6865 7461 5f72 6164 203d 206e 702e   theta_rad = np.
+00027be0: 6465 6732 7261 6428 7468 6574 6129 0a20  deg2rad(theta). 
+00027bf0: 2020 206d 6174 203d 206e 702e 6172 7261     mat = np.arra
+00027c00: 7928 5b5b 6e70 2e63 6f73 2874 6865 7461  y([[np.cos(theta
+00027c10: 5f72 6164 292c 202d 6e70 2e73 696e 2874  _rad), -np.sin(t
+00027c20: 6865 7461 5f72 6164 295d 2c0a 2020 2020  heta_rad)],.    
+00027c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c40: 5b6e 702e 7369 6e28 7468 6574 615f 7261  [np.sin(theta_ra
+00027c50: 6429 2c20 206e 702e 636f 7328 7468 6574  d),  np.cos(thet
+00027c60: 615f 7261 6429 5d5d 290a 0a20 2020 2072  a_rad)]])..    r
+00027c70: 6f74 5f63 6420 3d20 6e70 2e64 6f74 286d  ot_cd = np.dot(m
+00027c80: 6174 2c20 7763 735f 6f75 742e 7763 732e  at, wcs_out.wcs.
+00027c90: 6364 290a 0a20 2020 2066 6f72 2069 2069  cd)..    for i i
+00027ca0: 6e20 5b30 2c20 315d 3a0a 2020 2020 2020  n [0, 1]:.      
+00027cb0: 2020 666f 7220 6a20 696e 205b 302c 2031    for j in [0, 1
+00027cc0: 5d3a 0a20 2020 2020 2020 2020 2020 2068  ]:.            h
+00027cd0: 6f75 745b 2743 447b 303a 647d 5f7b 313a  out['CD{0:d}_{1:
+00027ce0: 647d 272e 666f 726d 6174 2869 2b31 2c20  d}'.format(i+1, 
+00027cf0: 6a2b 3129 5d20 3d20 726f 745f 6364 5b69  j+1)] = rot_cd[i
+00027d00: 2c20 6a5d 0a20 2020 2020 2020 2020 2020  , j].           
+00027d10: 2077 6373 5f6f 7574 2e77 6373 2e63 645b   wcs_out.wcs.cd[
+00027d20: 692c 206a 5d20 3d20 726f 745f 6364 5b69  i, j] = rot_cd[i
+00027d30: 2c20 6a5d 0a0a 2020 2020 6364 203d 2077  , j]..    cd = w
+00027d40: 6373 5f6f 7574 2e77 6373 2e63 640a 2020  cs_out.wcs.cd.  
+00027d50: 2020 7763 735f 6f75 742e 7073 6361 6c65    wcs_out.pscale
+00027d60: 203d 2067 6574 5f77 6373 5f70 7363 616c   = get_wcs_pscal
+00027d70: 6528 7763 735f 6f75 7429 2020 2320 6e70  e(wcs_out)  # np
+00027d80: 2e73 7172 7428 2863 645b 302c 3a5d 2a2a  .sqrt((cd[0,:]**
+00027d90: 3229 2e73 756d 2829 292a 3336 3030 2e0a  2).sum())*3600..
+00027da0: 0a20 2020 2069 6620 6765 745f 6864 753a  .    if get_hdu:
+00027db0: 0a20 2020 2020 2020 2068 6475 203d 2070  .        hdu = p
+00027dc0: 7966 6974 732e 496d 6167 6548 4455 2868  yfits.ImageHDU(h
+00027dd0: 6561 6465 723d 686f 7574 2c20 6461 7461  eader=hout, data
+00027de0: 3d6e 702e 7a65 726f 7328 286e 7069 785b  =np.zeros((npix[
+00027df0: 315d 2c20 6e70 6978 5b30 5d29 2c20 6474  1], npix[0]), dt
+00027e00: 7970 653d 6e70 2e66 6c6f 6174 3332 2929  ype=np.float32))
+00027e10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00027e20: 6864 750a 2020 2020 656c 7365 3a0a 2020  hdu.    else:.  
+00027e30: 2020 2020 2020 7265 7475 726e 2068 6f75        return hou
+00027e40: 742c 2077 6373 5f6f 7574 0a0a 0a64 6566  t, wcs_out...def
+00027e50: 2067 6574 5f66 6c74 5f66 6f6f 7470 7269   get_flt_footpri
+00027e60: 6e74 2866 6c74 5f66 696c 652c 2065 7874  nt(flt_file, ext
+00027e70: 656e 7369 6f6e 733d 5b31 2c20 322c 2033  ensions=[1, 2, 3
+00027e80: 2c20 345d 2c20 7061 7463 685f 6172 6773  , 4], patch_args
+00027e90: 3d4e 6f6e 6529 3a0a 2020 2020 2222 220a  =None):.    """.
+00027ea0: 2020 2020 436f 6d70 7574 6520 666f 6f74      Compute foot
+00027eb0: 7072 696e 7420 6f66 2061 6c6c 2053 4349  print of all SCI
+00027ec0: 2065 7874 656e 7369 6f6e 7320 6f66 2061   extensions of a
+00027ed0: 6e20 4853 5420 6578 706f 7375 7265 0a0a  n HST exposure..
+00027ee0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00027ef0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00027f00: 2020 6578 7465 6e73 696f 6e73 203a 206c    extensions : l
+00027f10: 6973 740a 2020 2020 2020 2020 4c69 7374  ist.        List
+00027f20: 206f 6620 6578 7465 6e73 696f 6e73 2074   of extensions t
+00027f30: 6f20 7265 7472 6965 7665 2028 6361 6e20  o retrieve (can 
+00027f40: 6861 7665 2065 7874 7261 7329 2e0a 0a20  have extras)... 
+00027f50: 2020 2070 6174 6368 5f61 7267 7320 3a20     patch_args : 
+00027f60: 6469 6374 206f 7220 4e6f 6e65 0a20 2020  dict or None.   
+00027f70: 2020 2020 2049 6620 6120 6064 6963 7460       If a `dict`
+00027f80: 2c20 7468 656e 2067 656e 6572 6174 6520  , then generate 
+00027f90: 6120 7061 7463 6820 666f 7220 7468 6520  a patch for the 
+00027fa0: 666f 6f74 7072 696e 7420 7061 7373 696e  footprint passin
+00027fb0: 670a 2020 2020 2020 2020 602a 2a70 6174  g.        `**pat
+00027fc0: 6368 5f61 7267 7360 2061 7267 756d 656e  ch_args` argumen
+00027fd0: 7473 2028 652e 672e 2c20 607b 2766 6327  ts (e.g., `{'fc'
+00027fe0: 3a27 626c 7565 272c 2027 616c 7068 6127  :'blue', 'alpha'
+00027ff0: 3a30 2e31 7d60 292e 0a0a 2020 2020 5265  :0.1}`)...    Re
+00028000: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00028010: 2d0a 2020 2020 6670 202f 2070 6174 6368  -.    fp / patch
+00028020: 203a 2060 7e73 6861 7065 6c79 2e67 656f   : `~shapely.geo
+00028030: 6d65 7472 7960 206f 626a 6563 7420 6f72  metry` object or
+00028040: 2060 6d61 7470 6c6f 746c 6962 2e70 6174   `matplotlib.pat
+00028050: 6368 2e50 6174 6368 600a 2020 2020 2020  ch.Patch`.      
+00028060: 2020 5468 6520 666f 6f74 7072 696e 7420    The footprint 
+00028070: 6f72 2066 6f6f 7470 7269 6e74 2070 6174  or footprint pat
+00028080: 6368 2e0a 0a20 2020 2022 2222 0a20 2020  ch...    """.   
+00028090: 2066 726f 6d20 7368 6170 656c 792e 6765   from shapely.ge
+000280a0: 6f6d 6574 7279 2069 6d70 6f72 7420 506f  ometry import Po
+000280b0: 6c79 676f 6e0a 0a20 2020 2069 6d20 3d20  lygon..    im = 
+000280c0: 7079 6669 7473 2e6f 7065 6e28 666c 745f  pyfits.open(flt_
+000280d0: 6669 6c65 290a 2020 2020 6670 203d 204e  file).    fp = N
+000280e0: 6f6e 650a 0a20 2020 2066 6f72 2065 7874  one..    for ext
+000280f0: 2069 6e20 6578 7465 6e73 696f 6e73 3a0a   in extensions:.
+00028100: 2020 2020 2020 2020 6966 2028 2753 4349          if ('SCI
+00028110: 272c 2065 7874 2920 6e6f 7420 696e 2069  ', ext) not in i
+00028120: 6d3a 0a20 2020 2020 2020 2020 2020 2063  m:.            c
+00028130: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+00028140: 2077 6373 203d 2070 7977 6373 2e57 4353   wcs = pywcs.WCS
+00028150: 2869 6d5b 2753 4349 272c 2065 7874 5d2e  (im['SCI', ext].
+00028160: 6865 6164 6572 2c20 666f 626a 3d69 6d29  header, fobj=im)
+00028170: 0a20 2020 2020 2020 2070 5f69 203d 2050  .        p_i = P
+00028180: 6f6c 7967 6f6e 2877 6373 2e63 616c 635f  olygon(wcs.calc_
+00028190: 666f 6f74 7072 696e 7428 2929 0a20 2020  footprint()).   
+000281a0: 2020 2020 2069 6620 6670 2069 7320 4e6f       if fp is No
+000281b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000281c0: 6670 203d 2070 5f69 0a20 2020 2020 2020  fp = p_i.       
+000281d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000281e0: 2020 2066 7020 3d20 6670 2e75 6e69 6f6e     fp = fp.union
+000281f0: 2870 5f69 290a 2020 2020 0a20 2020 2069  (p_i).    .    i
+00028200: 6d2e 636c 6f73 6528 290a 2020 2020 0a20  m.close().    . 
+00028210: 2020 2069 6620 7061 7463 685f 6172 6773     if patch_args
+00028220: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00028230: 2020 2020 2020 7061 7463 6820 3d20 7061        patch = pa
+00028240: 7463 685f 6672 6f6d 5f70 6f6c 7967 6f6e  tch_from_polygon
+00028250: 2866 702c 202a 2a70 6174 6368 5f61 7267  (fp, **patch_arg
+00028260: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+00028270: 6e20 7061 7463 680a 2020 2020 656c 7365  n patch.    else
+00028280: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00028290: 2066 700a 0a0a 6465 6620 6d61 6b65 5f6d   fp...def make_m
+000282a0: 6178 696d 616c 5f77 6373 2866 696c 6573  aximal_wcs(files
+000282b0: 2c20 7069 7865 6c5f 7363 616c 653d 4e6f  , pixel_scale=No
+000282c0: 6e65 2c20 6765 745f 6864 753d 5472 7565  ne, get_hdu=True
+000282d0: 2c20 7061 643d 3930 2c20 7665 7262 6f73  , pad=90, verbos
+000282e0: 653d 5472 7565 2c20 7468 6574 613d 302c  e=True, theta=0,
+000282f0: 2070 6f6c 795f 6275 6666 6572 3d31 2e2f   poly_buffer=1./
+00028300: 3336 3030 2c20 6e73 6369 5f65 7874 656e  3600, nsci_exten
+00028310: 7369 6f6e 733d 3429 3a0a 2020 2020 2222  sions=4):.    ""
+00028320: 220a 2020 2020 436f 6d70 7574 6520 616e  ".    Compute an
+00028330: 2049 6d61 6765 4844 5520 7769 7468 2061   ImageHDU with a
+00028340: 2066 6f6f 7470 7269 6e74 2074 6861 7420   footprint that 
+00028350: 636f 6e74 6169 6e73 2061 6c6c 206f 6620  contains all of 
+00028360: 6066 696c 6573 600a 0a20 2020 2050 6172  `files`..    Par
+00028370: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00028380: 2d2d 2d2d 2d2d 0a20 2020 2066 696c 6573  ------.    files
+00028390: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+000283a0: 4c69 7374 206f 6620 4853 5420 4649 5453  List of HST FITS
+000283b0: 2066 696c 6573 2028 652e 672e 2c20 464c   files (e.g., FL
+000283c0: 542e 2920 6f72 2057 4353 206f 626a 6563  T.) or WCS objec
+000283d0: 7473 2e0a 0a20 2020 2070 6978 656c 5f73  ts...    pixel_s
+000283e0: 6361 6c65 203a 2066 6c6f 6174 0a20 2020  cale : float.   
+000283f0: 2020 2020 2050 6978 656c 2073 6361 6c65       Pixel scale
+00028400: 206f 6620 6f75 7470 7574 2057 4353 2c20   of output WCS, 
+00028410: 696e 2060 7e61 7374 726f 7079 2e75 6e69  in `~astropy.uni
+00028420: 7473 2e61 7263 7365 6360 2e20 2049 6620  ts.arcsec`.  If 
+00028430: 604e 6f6e 6560 2c0a 2020 2020 2020 2020  `None`,.        
+00028440: 6765 7420 7069 7865 6c20 7363 616c 6520  get pixel scale 
+00028450: 6f66 2066 6972 7374 2066 696c 6520 696e  of first file in
+00028460: 2060 6669 6c65 7360 2e0a 0a20 2020 2067   `files`...    g
+00028470: 6574 5f68 6475 203a 2062 6f6f 6c0a 2020  et_hdu : bool.  
+00028480: 2020 2020 2020 5365 6520 6265 6c6f 772e        See below.
+00028490: 0a0a 2020 2020 7061 6420 3a20 666c 6f61  ..    pad : floa
+000284a0: 740a 2020 2020 2020 2020 5061 6464 696e  t.        Paddin
+000284b0: 6720 746f 2061 6464 2074 6f20 7468 6520  g to add to the 
+000284c0: 746f 7461 6c20 696d 6167 6520 7369 7a65  total image size
+000284d0: 2c20 696e 2060 7e61 7374 726f 7079 2e75  , in `~astropy.u
+000284e0: 6e69 7473 2e61 7263 7365 6360 2e0a 0a20  nits.arcsec`... 
+000284f0: 2020 2074 6865 7461 203a 2066 6c6f 6174     theta : float
+00028500: 0a20 2020 2020 2020 2050 6f73 6974 696f  .        Positio
+00028510: 6e20 616e 676c 652c 2064 6567 7265 6573  n angle, degrees
+00028520: 0a0a 2020 2020 6e73 6369 5f65 7874 656e  ..    nsci_exten
+00028530: 7369 6f6e 7320 3a20 696e 740a 2020 2020  sions : int.    
+00028540: 2020 2020 4e75 6d62 6572 206f 6620 2753      Number of 'S
+00028550: 4349 2720 6578 7465 6e73 696f 6e73 2074  CI' extensions t
+00028560: 6f20 7472 7920 696e 2074 6865 2065 7870  o try in the exp
+00028570: 6f73 7572 6520 6669 6c65 732e 0a0a 2020  osure files...  
+00028580: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00028590: 2d2d 2d2d 2d0a 2020 2020 6864 7520 3a20  -----.    hdu : 
+000285a0: 607e 6173 7472 6f70 792e 696f 2e66 6974  `~astropy.io.fit
+000285b0: 732e 496d 6167 6548 4455 600a 2020 2020  s.ImageHDU`.    
+000285c0: 2020 2020 4966 2060 6765 745f 6864 7560      If `get_hdu`
+000285d0: 2069 7320 5472 7565 2e0a 0a20 2020 202d   is True...    -
+000285e0: 6f72 2d0a 0a20 2020 2068 6561 6465 722c  or-..    header,
+000285f0: 2077 6373 203a 2060 7e61 7374 726f 7079   wcs : `~astropy
+00028600: 2e69 6f2e 6669 7473 2e48 6561 6465 7260  .io.fits.Header`
+00028610: 2c20 607e 6173 7472 6f70 792e 7763 732e  , `~astropy.wcs.
+00028620: 5743 5360 0a20 2020 2020 2020 2049 6620  WCS`.        If 
+00028630: 6067 6574 5f68 6475 6020 6973 2046 616c  `get_hdu` is Fal
+00028640: 7365 2e0a 0a20 2020 2022 2222 0a20 2020  se...    """.   
+00028650: 2069 6d70 6f72 7420 6e75 6d70 7920 6173   import numpy as
+00028660: 206e 700a 2020 2020 6672 6f6d 2073 6861   np.    from sha
+00028670: 7065 6c79 2e67 656f 6d65 7472 7920 696d  pely.geometry im
+00028680: 706f 7274 2050 6f6c 7967 6f6e 0a0a 2020  port Polygon..  
+00028690: 2020 696d 706f 7274 2061 7374 726f 7079    import astropy
+000286a0: 2e69 6f2e 6669 7473 2061 7320 7079 6669  .io.fits as pyfi
+000286b0: 7473 0a20 2020 2069 6d70 6f72 7420 6173  ts.    import as
+000286c0: 7472 6f70 792e 7763 7320 6173 2070 7977  tropy.wcs as pyw
+000286d0: 6373 0a0a 2020 2020 6966 2069 7369 6e73  cs..    if isins
+000286e0: 7461 6e63 6528 6669 6c65 735b 305d 2c20  tance(files[0], 
+000286f0: 7079 7763 732e 5743 5329 3a0a 2020 2020  pywcs.WCS):.    
+00028700: 2020 2020 2320 416c 7265 6164 7920 7763      # Already wc
+00028710: 735f 6c69 7374 0a20 2020 2020 2020 2077  s_list.        w
+00028720: 6373 5f6c 6973 7420 3d20 5b28 7763 732c  cs_list = [(wcs,
+00028730: 2027 5743 5327 2c20 2d31 2920 666f 7220   'WCS', -1) for 
+00028740: 7763 7320 696e 2066 696c 6573 5d0a 2020  wcs in files].  
+00028750: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00028760: 7763 735f 6c69 7374 203d 205b 5d0a 2020  wcs_list = [].  
+00028770: 2020 2020 2020 666f 7220 692c 2066 696c        for i, fil
+00028780: 6520 696e 2065 6e75 6d65 7261 7465 2866  e in enumerate(f
+00028790: 696c 6573 293a 0a20 2020 2020 2020 2020  iles):.         
+000287a0: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
+000287b0: 682e 6578 6973 7473 2866 696c 6529 3a0a  h.exists(file):.
+000287c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000287d0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+000287e0: 2020 2020 2020 7769 7468 2070 7966 6974        with pyfit
+000287f0: 732e 6f70 656e 2866 696c 6529 2061 7320  s.open(file) as 
+00028800: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
+00028810: 2020 2020 666f 7220 6578 7420 696e 2072      for ext in r
+00028820: 616e 6765 286e 7363 695f 6578 7465 6e73  ange(nsci_extens
+00028830: 696f 6e73 293a 0a20 2020 2020 2020 2020  ions):.         
+00028840: 2020 2020 2020 2020 2020 2069 6620 2827             if ('
+00028850: 5343 4927 2c20 6578 742b 3129 206e 6f74  SCI', ext+1) not
+00028860: 2069 6e20 696d 3a0a 2020 2020 2020 2020   in im:.        
+00028870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028880: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+00028890: 2020 2020 2020 2020 2020 2020 2020 7763                wc
+000288a0: 7320 3d20 7079 7763 732e 5743 5328 696d  s = pywcs.WCS(im
+000288b0: 5b27 5343 4927 2c20 6578 742b 315d 2e68  ['SCI', ext+1].h
+000288c0: 6561 6465 722c 2066 6f62 6a3d 696d 290a  eader, fobj=im).
+000288d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000288e0: 2020 2020 7763 735f 6c69 7374 2e61 7070      wcs_list.app
+000288f0: 656e 6428 2877 6373 2c20 6669 6c65 2c20  end((wcs, file, 
+00028900: 6578 7429 290a 2020 2020 0a20 2020 2069  ext)).    .    i
+00028910: 6620 7069 7865 6c5f 7363 616c 6520 6973  f pixel_scale is
+00028920: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+00028930: 6978 656c 5f73 6361 6c65 203d 2067 6574  ixel_scale = get
+00028940: 5f77 6373 5f70 7363 616c 6528 7763 735f  _wcs_pscale(wcs_
+00028950: 6c69 7374 5b30 5d5b 305d 290a 2020 2020  list[0][0]).    
+00028960: 2020 2020 0a20 2020 2067 726f 7570 5f70      .    group_p
+00028970: 6f6c 7920 3d20 4e6f 6e65 0a20 2020 2066  oly = None.    f
+00028980: 6f72 2069 2c20 2877 6373 2c20 6669 6c65  or i, (wcs, file
+00028990: 2c20 6368 6970 2920 696e 2065 6e75 6d65  , chip) in enume
+000289a0: 7261 7465 2877 6373 5f6c 6973 7429 3a0a  rate(wcs_list):.
+000289b0: 2020 2020 2020 2020 705f 6920 3d20 506f          p_i = Po
+000289c0: 6c79 676f 6e28 7763 732e 6361 6c63 5f66  lygon(wcs.calc_f
+000289d0: 6f6f 7470 7269 6e74 2829 290a 2020 2020  ootprint()).    
+000289e0: 2020 2020 6966 2067 726f 7570 5f70 6f6c      if group_pol
+000289f0: 7920 6973 204e 6f6e 653a 0a20 2020 2020  y is None:.     
+00028a00: 2020 2020 2020 2069 6620 706f 6c79 5f62         if poly_b
+00028a10: 7566 6665 7220 3e20 303a 0a20 2020 2020  uffer > 0:.     
+00028a20: 2020 2020 2020 2020 2020 2067 726f 7570             group
+00028a30: 5f70 6f6c 7920 3d20 705f 692e 6275 6666  _poly = p_i.buff
+00028a40: 6572 2831 2e2f 3336 3030 290a 2020 2020  er(1./3600).    
+00028a50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00028a60: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+00028a70: 6f75 705f 706f 6c79 203d 2070 5f69 0a20  oup_poly = p_i. 
+00028a80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00028a90: 2020 2020 2020 2020 2069 6620 706f 6c79           if poly
+00028aa0: 5f62 7566 6665 7220 3e20 303a 0a20 2020  _buffer > 0:.   
+00028ab0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00028ac0: 7570 5f70 6f6c 7920 3d20 6772 6f75 705f  up_poly = group_
+00028ad0: 706f 6c79 2e75 6e69 6f6e 2870 5f69 2e62  poly.union(p_i.b
+00028ae0: 7566 6665 7228 312e 2f33 3630 3029 290a  uffer(1./3600)).
+00028af0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00028b00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028b10: 2020 6772 6f75 705f 706f 6c79 203d 2067    group_poly = g
+00028b20: 726f 7570 5f70 6f6c 792e 756e 696f 6e28  roup_poly.union(
+00028b30: 705f 6929 0a20 2020 2020 2020 2020 2020  p_i).           
+00028b40: 2020 2020 2020 0a20 2020 2020 2020 2078        .        x
+00028b50: 302c 2079 3020 3d20 6e70 2e63 6173 745b  0, y0 = np.cast[
+00028b60: 666c 6f61 745d 2867 726f 7570 5f70 6f6c  float](group_pol
+00028b70: 792e 6365 6e74 726f 6964 2e78 7929 5b3a  y.centroid.xy)[:
+00028b80: 2c20 305d 0a20 2020 2020 2020 2069 6620  , 0].        if 
+00028b90: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00028ba0: 2020 2020 206d 7367 203d 2027 7b30 3a3e       msg = '{0:>
+00028bb0: 3364 7d2f 7b31 3a3e 3364 7d3a 207b 327d  3d}/{1:>3d}: {2}
+00028bc0: 5b53 4349 2c7b 337d 5d20 207b 343a 3e36  [SCI,{3}]  {4:>6
+00028bd0: 2e32 667d 270a 2020 2020 2020 2020 2020  .2f}'.          
+00028be0: 2020 7072 696e 7428 6d73 672e 666f 726d    print(msg.form
+00028bf0: 6174 2869 2c20 6c65 6e28 6669 6c65 7329  at(i, len(files)
+00028c00: 2c20 6669 6c65 2c20 6368 6970 2b31 2c0a  , file, chip+1,.
+00028c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028c20: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00028c30: 7570 5f70 6f6c 792e 6172 6561 2a33 3630  up_poly.area*360
+00028c40: 302a 6e70 2e63 6f73 2879 302f 3138 302a  0*np.cos(y0/180*
+00028c50: 6e70 2e70 6929 0a20 2020 2020 2020 2020  np.pi).         
+00028c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028c70: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00028c80: 2020 2020 2020 2020 290a 0a20 2020 2070          )..    p
+00028c90: 7820 3d20 6e70 2e63 6173 745b 666c 6f61  x = np.cast[floa
+00028ca0: 745d 2867 726f 7570 5f70 6f6c 792e 636f  t](group_poly.co
+00028cb0: 6e76 6578 5f68 756c 6c2e 626f 756e 6461  nvex_hull.bounda
+00028cc0: 7279 2e78 7929 2e54 0a20 2020 2023 7830  ry.xy).T.    #x0
+00028cd0: 2c20 7930 203d 206e 702e 6361 7374 5b66  , y0 = np.cast[f
+00028ce0: 6c6f 6174 5d28 6772 6f75 705f 706f 6c79  loat](group_poly
+00028cf0: 2e63 656e 7472 6f69 642e 7879 295b 3a2c  .centroid.xy)[:,
+00028d00: 305d 0a0a 2020 2020 7830 203d 2028 7078  0]..    x0 = (px
+00028d10: 2e6d 6178 2861 7869 733d 3029 2b70 782e  .max(axis=0)+px.
+00028d20: 6d69 6e28 6178 6973 3d30 2929 2f32 2e0a  min(axis=0))/2..
+00028d30: 0a20 2020 2063 6f73 6420 3d20 6e70 2e61  .    cosd = np.a
+00028d40: 7272 6179 285b 6e70 2e63 6f73 2878 305b  rray([np.cos(x0[
+00028d50: 315d 2f31 3830 2a6e 702e 7069 292c 2031  1]/180*np.pi), 1
+00028d60: 5d29 0a0a 2020 2020 5f6d 6174 203d 206e  ])..    _mat = n
+00028d70: 702e 6172 7261 7928 5b5b 6e70 2e63 6f73  p.array([[np.cos
+00028d80: 2874 6865 7461 292c 202d 6e70 2e73 696e  (theta), -np.sin
+00028d90: 2874 6865 7461 295d 2c0a 2020 2020 2020  (theta)],.      
+00028da0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00028db0: 6e70 2e73 696e 2874 6865 7461 292c 206e  np.sin(theta), n
+00028dc0: 702e 636f 7328 7468 6574 6129 5d5d 290a  p.cos(theta)]]).
+00028dd0: 0a20 2020 2023 2052 6f74 6174 6564 0a20  .    # Rotated. 
+00028de0: 2020 2070 7220 3d20 2828 7078 2d78 3029     pr = ((px-x0)
+00028df0: 2a63 6f73 6429 2e64 6f74 285f 6d61 7429  *cosd).dot(_mat)
+00028e00: 2f63 6f73 642b 7830 0a0a 2020 2020 7369  /cosd+x0..    si
+00028e10: 7a65 5f61 7263 7365 6320 3d20 2870 722e  ze_arcsec = (pr.
+00028e20: 6d61 7828 6178 6973 3d30 292d 7072 2e6d  max(axis=0)-pr.m
+00028e30: 696e 2861 7869 733d 3029 292a 636f 7364  in(axis=0))*cosd
+00028e40: 2a33 3630 300a 2020 2020 7378 2c20 7379  *3600.    sx, sy
+00028e50: 203d 2073 697a 655f 6172 6373 6563 0a0a   = size_arcsec..
+00028e60: 2020 2020 2320 7378 203d 2028 7078 2e6d      # sx = (px.m
+00028e70: 6178 2829 2d70 782e 6d69 6e28 2929 2a63  ax()-px.min())*c
+00028e80: 6f73 642a 3336 3030 2023 2061 7263 7365  osd*3600 # arcse
+00028e90: 630a 2020 2020 2320 7379 203d 2028 7079  c.    # sy = (py
+00028ea0: 2e6d 6178 2829 2d70 792e 6d69 6e28 2929  .max()-py.min())
+00028eb0: 2a33 3630 3020 2320 6172 6373 6563 0a0a  *3600 # arcsec..
+00028ec0: 2020 2020 7369 7a65 203d 206e 702e 6d61      size = np.ma
+00028ed0: 7869 6d75 6d28 7378 2b70 6164 2c20 7379  ximum(sx+pad, sy
+00028ee0: 2b70 6164 290a 0a20 2020 2069 6620 7665  +pad)..    if ve
+00028ef0: 7262 6f73 653a 0a20 2020 2020 2020 206d  rbose:.        m
+00028f00: 7367 203d 2027 5c6e 2020 4d6f 7361 6963  sg = '\n  Mosaic
+00028f10: 2057 4353 3a20 287b 303a 2e35 667d 2c7b   WCS: ({0:.5f},{
+00028f20: 313a 2e35 667d 2920 270a 2020 2020 2020  1:.5f}) '.      
+00028f30: 2020 6d73 6720 2b3d 2027 7b32 3a2e 3166    msg += '{2:.1f
+00028f40: 7d5c 2778 7b33 3a2e 3166 7d5c 2720 207b  }\'x{3:.1f}\'  {
+00028f50: 343a 2e33 667d 222f 7069 785c 6e27 0a20  4:.3f}"/pix\n'. 
+00028f60: 2020 2020 2020 2070 7269 6e74 286d 7367         print(msg
+00028f70: 2e66 6f72 6d61 7428 7830 5b30 5d2c 2078  .format(x0[0], x
+00028f80: 305b 315d 2c20 2873 782b 7061 6429 2f36  0[1], (sx+pad)/6
+00028f90: 302e 2c20 2873 792b 7061 6429 2f36 302e  0., (sy+pad)/60.
+00028fa0: 2c20 7069 7865 6c5f 7363 616c 6529 290a  , pixel_scale)).
+00028fb0: 0a20 2020 206f 7574 203d 206d 616b 655f  .    out = make_
+00028fc0: 7763 7368 6561 6465 7228 7261 3d78 305b  wcsheader(ra=x0[
+00028fd0: 305d 2c20 6465 633d 7830 5b31 5d2c 0a20  0], dec=x0[1],. 
+00028fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ff0: 2020 2020 2020 2020 7369 7a65 3d28 7378          size=(sx
+00029000: 2b70 6164 2a32 2c20 7379 2b70 6164 2a32  +pad*2, sy+pad*2
+00029010: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00029020: 2020 2020 2020 2020 2020 2020 7069 7873              pixs
+00029030: 6361 6c65 3d70 6978 656c 5f73 6361 6c65  cale=pixel_scale
+00029040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029050: 2020 2020 2020 2020 2020 2067 6574 5f68             get_h
+00029060: 6475 3d67 6574 5f68 6475 2c20 7468 6574  du=get_hdu, thet
+00029070: 613d 7468 6574 612f 6e70 2e70 692a 3138  a=theta/np.pi*18
+00029080: 3029 0a0a 2020 2020 7265 7475 726e 206f  0)..    return o
+00029090: 7574 0a0a 0a64 6566 2068 616c 665f 7069  ut...def half_pi
+000290a0: 7865 6c5f 7363 616c 6528 7763 7329 3a0a  xel_scale(wcs):.
+000290b0: 2020 2020 2222 220a 2020 2020 4372 6561      """.    Crea
+000290c0: 7465 2061 206e 6577 2057 4353 2077 6974  te a new WCS wit
+000290d0: 6820 6861 6c66 2074 6865 2070 6978 656c  h half the pixel
+000290e0: 2073 6361 6c65 206f 6620 616e 6f74 6865   scale of anothe
+000290f0: 7220 7468 6174 2063 616e 2062 6520 0a20  r that can be . 
+00029100: 2020 2062 6c6f 636b 2d61 7665 7261 6765     block-average
+00029110: 6420 3278 320a 2020 2020 0a20 2020 2050  d 2x2.    .    P
+00029120: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00029130: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2077 6373  --------.    wcs
+00029140: 203a 2060 7e61 7374 726f 7079 2e77 6373   : `~astropy.wcs
+00029150: 2e57 4353 600a 2020 2020 2020 2020 496e  .WCS`.        In
+00029160: 7075 7420 5743 530a 2020 2020 0a20 2020  put WCS.    .   
+00029170: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+00029180: 2d2d 2d2d 0a20 2020 2068 616c 665f 7763  ----.    half_wc
+00029190: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
+000291a0: 732e 5743 5360 0a20 2020 2020 2020 204e  s.WCS`.        N
+000291b0: 6577 2057 4353 2077 6974 6820 736d 616c  ew WCS with smal
+000291c0: 6c65 7220 7069 7865 6c73 0a20 2020 2022  ler pixels.    "
+000291d0: 2222 0a20 2020 2068 203d 2074 6f5f 6865  "".    h = to_he
+000291e0: 6164 6572 2877 6373 290a 2020 2020 0a20  ader(wcs).    . 
+000291f0: 2020 2066 6f72 206b 2069 6e20 5b27 4e41     for k in ['NA
+00029200: 5849 5331 272c 2027 4e41 5849 5332 275d  XIS1', 'NAXIS2']
+00029210: 3a20 232c 2027 4352 5049 5831 272c 2027  : #, 'CRPIX1', '
+00029220: 4352 5049 5832 275d 3a0a 2020 2020 2020  CRPIX2']:.      
+00029230: 2020 685b 6b5d 202a 3d20 320a 0a20 2020    h[k] *= 2..   
+00029240: 2066 6f72 206b 2069 6e20 5b27 4352 5049   for k in ['CRPI
+00029250: 5831 272c 2027 4352 5049 5832 275d 3a0a  X1', 'CRPIX2']:.
+00029260: 2020 2020 2020 2020 685b 6b5d 203d 2068          h[k] = h
+00029270: 5b6b 5d2a 3220 2d20 302e 350a 2020 2020  [k]*2 - 0.5.    
+00029280: 2020 2020 0a20 2020 2066 6f72 206b 2069      .    for k i
+00029290: 6e20 5b27 4344 315f 3127 2c20 2743 4431  n ['CD1_1', 'CD1
+000292a0: 5f32 272c 2027 4344 325f 3127 2c20 2743  _2', 'CD2_1', 'C
+000292b0: 4432 5f32 275d 3a0a 2020 2020 2020 2020  D2_2']:.        
+000292c0: 6966 206b 2069 6e20 683a 0a20 2020 2020  if k in h:.     
+000292d0: 2020 2020 2020 2068 5b6b 5d20 2f3d 2032         h[k] /= 2
+000292e0: 0a20 2020 200a 2020 2020 6966 2030 3a0a  .    .    if 0:.
+000292f0: 2020 2020 2020 2020 2320 5465 7374 0a20          # Test. 
+00029300: 2020 2020 2020 206e 6577 203d 2070 7977         new = pyw
+00029310: 6373 2e57 4353 2868 290a 2020 2020 2020  cs.WCS(h).      
+00029320: 2020 7368 203d 206e 6577 2e70 6978 656c    sh = new.pixel
+00029330: 5f73 6861 7065 0a20 2020 2020 2020 200a  _shape.        .
+00029340: 2020 2020 2020 2020 7763 6f72 6e65 7220          wcorner 
+00029350: 3d20 7763 732e 616c 6c5f 776f 726c 6432  = wcs.all_world2
+00029360: 7069 7828 6e65 772e 616c 6c5f 7069 7832  pix(new.all_pix2
+00029370: 776f 726c 6428 5b5b 2d30 2e35 2c20 2d30  world([[-0.5, -0
+00029380: 2e35 5d2c 200a 2020 2020 2020 2020 2020  .5], .          
+00029390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293b0: 2020 205b 7368 5b30 5d2d 302e 352c 2073     [sh[0]-0.5, s
+000293c0: 685b 315d 2d30 2e35 5d5d 2c20 3029 2c30  h[1]-0.5]], 0),0
+000293d0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+000293e0: 2773 6d61 6c6c 203e 206c 6172 6765 2729  'small > large')
+000293f0: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
+00029400: 2c20 272e 6a6f 696e 285b 6627 7b77 3a2e  , '.join([f'{w:.
+00029410: 3266 7d27 2066 6f72 2077 2069 6e20 7763  2f}' for w in wc
+00029420: 6f72 6e65 725b 305d 5d29 290a 2020 2020  orner[0]])).    
+00029430: 2020 2020 7072 696e 7428 272c 2027 2e6a      print(', '.j
+00029440: 6f69 6e28 5b66 277b 773a 2e32 667d 2720  oin([f'{w:.2f}' 
+00029450: 666f 7220 7720 696e 2077 636f 726e 6572  for w in wcorner
+00029460: 5b31 5d5d 292c 2077 6373 2e70 6978 656c  [1]]), wcs.pixel
+00029470: 5f73 6861 7065 290a 2020 2020 2020 2020  _shape).        
+00029480: 0a20 2020 2020 2020 2073 6820 3d20 7763  .        sh = wc
+00029490: 732e 7069 7865 6c5f 7368 6170 650a 2020  s.pixel_shape.  
+000294a0: 2020 2020 2020 7763 6f72 6e65 7220 3d20        wcorner = 
+000294b0: 6e65 772e 616c 6c5f 776f 726c 6432 7069  new.all_world2pi
+000294c0: 7828 7763 732e 616c 6c5f 7069 7832 776f  x(wcs.all_pix2wo
+000294d0: 726c 6428 5b5b 2d30 2e35 2c20 2d30 2e35  rld([[-0.5, -0.5
+000294e0: 5d2c 200a 2020 2020 2020 2020 2020 2020  ], .            
+000294f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029510: 205b 7368 5b30 5d2d 302e 352c 2073 685b   [sh[0]-0.5, sh[
+00029520: 315d 2d30 2e35 5d5d 2c20 3029 2c30 290a  1]-0.5]], 0),0).
+00029530: 2020 2020 2020 2020 7072 696e 7428 276c          print('l
+00029540: 6172 6765 203e 2073 6d61 6c6c 2729 0a20  arge > small'). 
+00029550: 2020 2020 2020 2070 7269 6e74 2827 2c20         print(', 
+00029560: 272e 6a6f 696e 285b 6627 7b77 3a2e 3266  '.join([f'{w:.2f
+00029570: 7d27 2066 6f72 2077 2069 6e20 7763 6f72  }' for w in wcor
+00029580: 6e65 725b 305d 5d29 290a 2020 2020 2020  ner[0]])).      
+00029590: 2020 7072 696e 7428 272c 2027 2e6a 6f69    print(', '.joi
+000295a0: 6e28 5b66 277b 773a 2e32 667d 2720 666f  n([f'{w:.2f}' fo
+000295b0: 7220 7720 696e 2077 636f 726e 6572 5b31  r w in wcorner[1
+000295c0: 5d5d 292c 206e 6577 2e70 6978 656c 5f73  ]]), new.pixel_s
+000295d0: 6861 7065 290a 2020 2020 2020 2020 0a20  hape).        . 
+000295e0: 2020 206e 6577 5f77 6373 203d 2070 7977     new_wcs = pyw
+000295f0: 6373 2e57 4353 2868 2c20 7265 6c61 783d  cs.WCS(h, relax=
+00029600: 5472 7565 290a 2020 2020 0a20 2020 2072  True).    .    r
+00029610: 6574 7572 6e20 6e65 775f 7763 730a 0a0a  eturn new_wcs...
+00029620: 6465 6620 6865 6164 6572 5f6b 6579 735f  def header_keys_
+00029630: 6672 6f6d 5f66 696c 656c 6973 7428 6669  from_filelist(fi
+00029640: 7473 5f66 696c 6573 2c20 6b65 7977 6f72  ts_files, keywor
+00029650: 6473 3d5b 5d2c 2065 7874 3d30 2c20 636f  ds=[], ext=0, co
+00029660: 6c6e 616d 655f 6361 7365 3d73 7472 2e6c  lname_case=str.l
+00029670: 6f77 6572 293a 0a20 2020 2022 2222 4475  ower):.    """Du
+00029680: 6d70 2068 6561 6465 7220 6b65 7977 6f72  mp header keywor
+00029690: 6473 2074 6f20 6120 607e 6173 7472 6f70  ds to a `~astrop
+000296a0: 792e 7461 626c 652e 5461 626c 6560 0a0a  y.table.Table`..
+000296b0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000296c0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+000296d0: 2020 6669 7473 5f66 696c 6573 203a 206c    fits_files : l
+000296e0: 6973 740a 2020 2020 2020 2020 4c69 7374  ist.        List
+000296f0: 206f 6620 4649 5453 2066 696c 656e 616d   of FITS filenam
+00029700: 6573 0a0a 2020 2020 6b65 7977 6f72 6473  es..    keywords
+00029710: 203a 206c 6973 7420 6f72 204e 6f6e 650a   : list or None.
+00029720: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
+00029730: 6865 6164 6572 206b 6579 776f 7264 7320  header keywords 
+00029740: 746f 2072 6574 7269 6576 652e 2020 4966  to retrieve.  If
+00029750: 2060 4e6f 6e65 602c 2074 6865 6e20 6765   `None`, then ge
+00029760: 6e65 7261 7465 2061 206c 6973 740a 2020  nerate a list.  
+00029770: 2020 2020 2020 6f66 202a 616c 6c2a 206b        of *all* k
+00029780: 6579 776f 7264 7320 6672 6f6d 2074 6865  eywords from the
+00029790: 2066 6972 7374 2066 696c 6520 696e 2074   first file in t
+000297a0: 6865 206c 6973 742e 0a0a 2020 2020 6578  he list...    ex
+000297b0: 7420 3a20 696e 742c 2074 7570 6c65 0a20  t : int, tuple. 
+000297c0: 2020 2020 2020 2046 4954 5320 6578 7465         FITS exte
+000297d0: 6e73 696f 6e20 6672 6f6d 2077 6869 6368  nsion from which
+000297e0: 2074 6f20 7075 6c6c 2074 6865 2068 6561   to pull the hea
+000297f0: 6465 722e 2020 4361 6e20 6265 2069 6e74  der.  Can be int
+00029800: 6567 6572 206f 720a 2020 2020 2020 2020  eger or.        
+00029810: 7475 706c 652c 2065 2e67 2e2c 2028 2753  tuple, e.g., ('S
+00029820: 4349 272c 3129 2066 6f72 2048 5354 2041  CI',1) for HST A
+00029830: 4353 2f57 4643 3320 464c 5420 6669 6c65  CS/WFC3 FLT file
+00029840: 732e 0a0a 2020 2020 636f 6c6e 616d 655f  s...    colname_
+00029850: 6361 7365 203a 2066 756e 630a 2020 2020  case : func.    
+00029860: 2020 2020 4675 6e63 7469 6f6e 2074 6f20      Function to 
+00029870: 7365 7420 7468 6520 6361 7365 206f 6620  set the case of 
+00029880: 7468 6520 6f75 7470 7574 2063 6f6c 6e61  the output colna
+00029890: 6d65 732c 2065 2e67 2e2c 2060 7374 722e  mes, e.g., `str.
+000298a0: 6c6f 7765 7260 2c0a 2020 2020 2020 2020  lower`,.        
+000298b0: 6073 7472 2e75 7070 6572 602c 2060 7374  `str.upper`, `st
+000298c0: 722e 7469 746c 6560 2e0a 0a20 2020 2052  r.title`...    R
+000298d0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+000298e0: 2d2d 0a20 2020 2074 6162 203a 2060 7e61  --.    tab : `~a
+000298f0: 7374 726f 7079 2e74 6162 6c65 2e54 6162  stropy.table.Tab
+00029900: 6c65 600a 2020 2020 2020 2020 4f75 7470  le`.        Outp
+00029910: 7574 2074 6162 6c65 2e0a 0a20 2020 2022  ut table...    "
+00029920: 2222 0a20 2020 2069 6d70 6f72 7420 6e75  "".    import nu
+00029930: 6d70 7920 6173 206e 700a 2020 2020 696d  mpy as np.    im
+00029940: 706f 7274 2061 7374 726f 7079 2e69 6f2e  port astropy.io.
+00029950: 6669 7473 2061 7320 7079 6669 7473 0a20  fits as pyfits. 
+00029960: 2020 2066 726f 6d20 6173 7472 6f70 792e     from astropy.
+00029970: 7461 626c 6520 696d 706f 7274 2054 6162  table import Tab
+00029980: 6c65 0a0a 2020 2020 2320 4966 206b 6579  le..    # If key
+00029990: 776f 7264 733d 4e6f 6e65 2c20 6765 7420  words=None, get 
+000299a0: 6675 6c6c 206c 6973 7420 6672 6f6d 2066  full list from f
+000299b0: 6972 7374 2046 4954 5320 6669 6c65 0a20  irst FITS file. 
+000299c0: 2020 2069 6620 6b65 7977 6f72 6473 2069     if keywords i
+000299d0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000299e0: 6820 3d20 7079 6669 7473 2e67 6574 6865  h = pyfits.gethe
+000299f0: 6164 6572 2866 6974 735f 6669 6c65 735b  ader(fits_files[
+00029a00: 305d 2c20 6578 7429 0a20 2020 2020 2020  0], ext).       
+00029a10: 206b 6579 776f 7264 7320 3d20 6c69 7374   keywords = list
+00029a20: 286e 702e 756e 6971 7565 286c 6973 7428  (np.unique(list(
+00029a30: 682e 6b65 7973 2829 2929 290a 2020 2020  h.keys()))).    
+00029a40: 2020 2020 6b65 7977 6f72 6473 2e70 6f70      keywords.pop
+00029a50: 286b 6579 776f 7264 732e 696e 6465 7828  (keywords.index(
+00029a60: 2727 2929 0a20 2020 2020 2020 206b 6579  '')).        key
+00029a70: 776f 7264 732e 706f 7028 6b65 7977 6f72  words.pop(keywor
+00029a80: 6473 2e69 6e64 6578 2827 4849 5354 4f52  ds.index('HISTOR
+00029a90: 5927 2929 0a0a 2020 2020 2320 4c6f 6f70  Y'))..    # Loop
+00029aa0: 2074 6872 6f75 6768 2066 696c 6573 0a20   through files. 
+00029ab0: 2020 206c 696e 6573 203d 205b 5d0a 2020     lines = [].  
+00029ac0: 2020 666f 7220 6669 6c65 2069 6e20 6669    for file in fi
+00029ad0: 7473 5f66 696c 6573 3a0a 2020 2020 2020  ts_files:.      
+00029ae0: 2020 6c69 6e65 203d 205b 6669 6c65 5d0a    line = [file].
+00029af0: 2020 2020 2020 2020 6820 3d20 7079 6669          h = pyfi
+00029b00: 7473 2e67 6574 6865 6164 6572 2866 696c  ts.getheader(fil
+00029b10: 652c 2065 7874 290a 2020 2020 2020 2020  e, ext).        
+00029b20: 666f 7220 6b65 7920 696e 206b 6579 776f  for key in keywo
+00029b30: 7264 733a 0a20 2020 2020 2020 2020 2020  rds:.           
+00029b40: 2069 6620 6b65 7920 696e 2068 3a0a 2020   if key in h:.  
+00029b50: 2020 2020 2020 2020 2020 2020 2020 6c69                li
+00029b60: 6e65 2e61 7070 656e 6428 685b 6b65 795d  ne.append(h[key]
+00029b70: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00029b80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00029b90: 2020 2020 6c69 6e65 2e61 7070 656e 6428      line.append(
+00029ba0: 4e6f 6e65 290a 0a20 2020 2020 2020 206c  None)..        l
+00029bb0: 696e 6573 2e61 7070 656e 6428 6c69 6e65  ines.append(line
+00029bc0: 290a 0a20 2020 2023 2043 6f6c 756d 6e20  )..    # Column 
+00029bd0: 6e61 6d65 730a 2020 2020 7461 626c 655f  names.    table_
+00029be0: 6865 6164 6572 203d 205b 636f 6c6e 616d  header = [colnam
+00029bf0: 655f 6361 7365 286b 6579 2920 666f 7220  e_case(key) for 
+00029c00: 6b65 7920 696e 205b 2766 696c 6527 5d2b  key in ['file']+
+00029c10: 6b65 7977 6f72 6473 5d0a 0a20 2020 2023  keywords]..    #
+00029c20: 204f 7574 7075 7420 7461 626c 650a 2020   Output table.  
+00029c30: 2020 7461 6220 3d20 5461 626c 6528 6461    tab = Table(da
+00029c40: 7461 3d6e 702e 6172 7261 7928 6c69 6e65  ta=np.array(line
+00029c50: 7329 2c20 6e61 6d65 733d 7461 626c 655f  s), names=table_
+00029c60: 6865 6164 6572 290a 0a20 2020 2072 6574  header)..    ret
+00029c70: 7572 6e20 7461 620a 0a0a 6465 6620 7061  urn tab...def pa
+00029c80: 7273 655f 7333 5f75 726c 2875 726c 3d27  rse_s3_url(url='
+00029c90: 7333 3a2f 2f62 7563 6b65 742f 7061 7468  s3://bucket/path
+00029ca0: 2f74 6f2f 6669 6c65 2e74 7874 2729 3a0a  /to/file.txt'):.
+00029cb0: 2020 2020 2222 220a 2020 2020 5061 7273      """.    Pars
+00029cc0: 6520 7333 2070 6174 6820 7374 7269 6e67  e s3 path string
+00029cd0: 0a20 2020 200a 2020 2020 5061 7261 6d65  .    .    Parame
+00029ce0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00029cf0: 2d2d 2d0a 2020 2020 7572 6c20 3a20 7374  ---.    url : st
+00029d00: 720a 2020 2020 2020 2020 4675 6c6c 2053  r.        Full S
+00029d10: 3320 7061 7468 2c20 652e 672e 2c20 6060  3 path, e.g., ``
+00029d20: 5b73 333a 2f2f 5d7b 6275 636b 6574 5f6e  [s3://]{bucket_n
+00029d30: 616d 657d 2f7b 7333 5f6f 626a 6563 747d  ame}/{s3_object}
+00029d40: 6060 0a20 2020 200a 2020 2020 5265 7475  ``.    .    Retu
+00029d50: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00029d60: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
+00029d70: 3a20 7374 720a 2020 2020 2020 2020 4275  : str.        Bu
+00029d80: 636b 6574 206e 616d 650a 2020 2020 0a20  cket name.    . 
+00029d90: 2020 2073 335f 6f62 6a65 6374 203a 2073     s3_object : s
+00029da0: 7472 0a20 2020 2020 2020 2046 756c 6c20  tr.        Full 
+00029db0: 7061 7468 206f 6620 7468 6520 5333 2066  path of the S3 f
+00029dc0: 696c 6520 6f62 6a65 6374 0a20 2020 200a  ile object.    .
+00029dd0: 2020 2020 6669 6c65 6e61 6d65 203a 2073      filename : s
+00029de0: 7472 0a20 2020 2020 2020 2046 696c 6520  tr.        File 
+00029df0: 6e61 6d65 206f 6620 7468 6520 6f62 6a65  name of the obje
+00029e00: 6374 2c20 652e 672e 2060 606f 732e 7061  ct, e.g. ``os.pa
+00029e10: 7468 2e62 6173 656e 616d 6528 7333 5f6f  th.basename(s3_o
+00029e20: 626a 6563 7429 6060 0a20 2020 2020 2020  bject)``.       
+00029e30: 200a 2020 2020 2222 220a 2020 2020 7375   .    """.    su
+00029e40: 726c 203d 2075 726c 2e73 7472 6970 2827  rl = url.strip('
+00029e50: 7333 3a2f 2f27 290a 2020 2020 7370 6c20  s3://').    spl 
+00029e60: 3d20 7375 726c 2e73 706c 6974 2827 2f27  = surl.split('/'
+00029e70: 290a 2020 2020 6966 206c 656e 2873 706c  ).    if len(spl
+00029e80: 2920 3c20 323a 0a20 2020 2020 2020 2070  ) < 2:.        p
+00029e90: 7269 6e74 2866 2262 7563 6b65 7420 2f20  rint(f"bucket / 
+00029ea0: 7061 7468 206e 6f74 2066 6f75 6e64 2069  path not found i
+00029eb0: 6e20 7b75 726c 7d22 290a 2020 2020 2020  n {url}").      
+00029ec0: 2020 7265 7475 726e 204e 6f6e 652c 204e    return None, N
+00029ed0: 6f6e 652c 204e 6f6e 650a 2020 2020 2020  one, None.      
+00029ee0: 2020 0a20 2020 2062 7563 6b65 745f 6e61    .    bucket_na
+00029ef0: 6d65 203d 2073 706c 5b30 5d0a 2020 2020  me = spl[0].    
+00029f00: 7333 5f6f 626a 6563 7420 3d20 272f 272e  s3_object = '/'.
+00029f10: 6a6f 696e 2873 706c 5b31 3a5d 290a 2020  join(spl[1:]).  
+00029f20: 2020 6669 6c65 6e61 6d65 203d 206f 732e    filename = os.
+00029f30: 7061 7468 2e62 6173 656e 616d 6528 7333  path.basename(s3
+00029f40: 5f6f 626a 6563 7429 0a20 2020 2072 6574  _object).    ret
+00029f50: 7572 6e20 6275 636b 6574 5f6e 616d 652c  urn bucket_name,
+00029f60: 2073 335f 6f62 6a65 6374 2c20 6669 6c65   s3_object, file
+00029f70: 6e61 6d65 0a0a 0a64 6566 2066 6574 6368  name...def fetch
+00029f80: 5f73 335f 7572 6c28 7572 6c3d 2773 333a  _s3_url(url='s3:
+00029f90: 2f2f 6275 636b 6574 2f70 6174 682f 746f  //bucket/path/to
+00029fa0: 2f66 696c 652e 7478 7427 2c20 6669 6c65  /file.txt', file
+00029fb0: 5f66 756e 633d 6c61 6d62 6461 2078 203a  _func=lambda x :
+00029fc0: 206f 732e 7061 7468 2e6a 6f69 6e28 272e   os.path.join('.
+00029fd0: 2f27 2c78 292c 2073 6b69 705f 6578 6973  /',x), skip_exis
+00029fe0: 7469 6e67 3d54 7275 652c 2076 6572 626f  ting=True, verbo
+00029ff0: 7365 3d54 7275 6529 3a0a 2020 2020 2222  se=True):.    ""
+0002a000: 220a 2020 2020 4665 7463 6820 6669 6c65  ".    Fetch file
+0002a010: 2066 726f 6d20 616e 2053 3320 6275 636b   from an S3 buck
+0002a020: 6574 0a20 2020 200a 2020 2020 5061 7261  et.    .    Para
+0002a030: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+0002a040: 2d2d 2d2d 2d0a 2020 2020 7572 6c20 3a20  -----.    url : 
+0002a050: 7374 720a 2020 2020 2020 2020 5333 2075  str.        S3 u
+0002a060: 726c 206f 6620 6120 6669 6c65 2074 6f20  rl of a file to 
+0002a070: 646f 776e 6c6f 6164 0a20 2020 200a 2020  download.    .  
+0002a080: 2020 6669 6c65 5f66 756e 6320 3a20 6675    file_func : fu
+0002a090: 6e63 7469 6f6e 0a20 2020 2020 2020 2046  nction.        F
+0002a0a0: 756e 6374 696f 6e20 6170 706c 6965 6420  unction applied 
+0002a0b0: 746f 2074 6865 2066 696c 6520 6e61 6d65  to the file name
+0002a0c0: 2065 7874 7261 6374 6564 2066 726f 6d20   extracted from 
+0002a0d0: 6075 726c 602c 2065 2e67 2e2c 2074 6f20  `url`, e.g., to 
+0002a0e0: 0a20 2020 2020 2020 2073 6574 206f 7574  .        set out
+0002a0f0: 7075 7420 6469 7265 6374 6f72 792c 2072  put directory, r
+0002a100: 656e 616d 6520 6669 6c65 732c 2073 6574  ename files, set
+0002a110: 2061 2070 7265 6669 782c 2065 7463 2e0a   a prefix, etc..
+0002a120: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
+0002a130: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+0002a140: 206c 6f63 616c 5f66 696c 6520 3a20 7374   local_file : st
+0002a150: 720a 2020 2020 2020 2020 4e61 6d65 206f  r.        Name o
+0002a160: 6620 6c6f 6361 6c20 6669 6c65 206f 7220  f local file or 
+0002a170: 604e 6f6e 6560 2069 6620 6661 696c 6564  `None` if failed
+0002a180: 2074 6f20 7061 7273 6520 6075 726c 600a   to parse `url`.
+0002a190: 2020 2020 0a20 2020 2073 7461 7475 7320      .    status 
+0002a1a0: 3a20 696e 740a 2020 2020 2020 2020 4269  : int.        Bi
+0002a1b0: 7420 666c 6167 206f 6620 7265 7375 6c74  t flag of result
+0002a1c0: 733a 202a 2a31 2a2a 203d 3d20 6669 6c65  s: **1** == file
+0002a1d0: 2066 6f75 6e64 2c20 2a2a 322a 2a20 3d20   found, **2** = 
+0002a1e0: 646f 776e 6c6f 6164 2073 7563 6365 7373  download success
+0002a1f0: 6675 6c0a 2020 2020 2020 2020 0a20 2020  ful.        .   
+0002a200: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
+0002a210: 7472 6163 6562 6163 6b0a 2020 2020 696d  traceback.    im
+0002a220: 706f 7274 2062 6f74 6f33 0a20 2020 2069  port boto3.    i
+0002a230: 6d70 6f72 7420 626f 746f 636f 7265 2e65  mport botocore.e
+0002a240: 7863 6570 7469 6f6e 730a 2020 2020 0a20  xceptions.    . 
+0002a250: 2020 2073 3320 3d20 626f 746f 332e 7265     s3 = boto3.re
+0002a260: 736f 7572 6365 2827 7333 2729 0a20 2020  source('s3').   
+0002a270: 2062 7563 6b65 745f 6e61 6d65 2c20 7333   bucket_name, s3
+0002a280: 5f6f 626a 6563 742c 2066 696c 656e 616d  _object, filenam
+0002a290: 6520 3d20 7061 7273 655f 7333 5f75 726c  e = parse_s3_url
+0002a2a0: 2875 726c 3d75 726c 290a 2020 2020 6966  (url=url).    if
+0002a2b0: 2062 7563 6b65 745f 6e61 6d65 2069 7320   bucket_name is 
+0002a2c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7265  None:.        re
+0002a2d0: 7475 726e 2075 726c 2c20 6f73 2e70 6174  turn url, os.pat
+0002a2e0: 682e 6578 6973 7473 2875 726c 290a 2020  h.exists(url).  
+0002a2f0: 2020 2020 2020 0a20 2020 2062 6b74 203d        .    bkt =
+0002a300: 2073 332e 4275 636b 6574 2862 7563 6b65   s3.Bucket(bucke
+0002a310: 745f 6e61 6d65 290a 2020 2020 6c6f 6361  t_name).    loca
+0002a320: 6c5f 6669 6c65 203d 2066 696c 655f 6675  l_file = file_fu
+0002a330: 6e63 2866 696c 656e 616d 6529 0a20 2020  nc(filename).   
+0002a340: 2073 7461 7475 7320 3d20 6f73 2e70 6174   status = os.pat
+0002a350: 682e 6578 6973 7473 286c 6f63 616c 5f66  h.exists(local_f
+0002a360: 696c 6529 2a31 0a20 2020 200a 2020 2020  ile)*1.    .    
+0002a370: 6966 2028 7374 6174 7573 203e 2030 2920  if (status > 0) 
+0002a380: 2620 736b 6970 5f65 7869 7374 696e 673a  & skip_existing:
+0002a390: 0a20 2020 2020 2020 2070 7269 6e74 2866  .        print(f
+0002a3a0: 277b 6c6f 6361 6c5f 6669 6c65 7d20 6578  '{local_file} ex
+0002a3b0: 6973 7473 2c20 736b 6970 7069 6e67 2e27  ists, skipping.'
+0002a3c0: 290a 2020 2020 656c 7365 3a0a 0a20 2020  ).    else:..   
+0002a3d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002a3e0: 2020 2020 2020 626b 742e 646f 776e 6c6f        bkt.downlo
+0002a3f0: 6164 5f66 696c 6528 7333 5f6f 626a 6563  ad_file(s3_objec
+0002a400: 742c 206c 6f63 616c 5f66 696c 652c 0a20  t, local_file,. 
+0002a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a420: 2020 2020 2045 7874 7261 4172 6773 3d7b       ExtraArgs={
+0002a430: 2252 6571 7565 7374 5061 7965 7222 3a20  "RequestPayer": 
+0002a440: 2272 6571 7565 7374 6572 227d 290a 2020  "requester"}).  
+0002a450: 2020 2020 2020 2020 2020 7374 6174 7573            status
+0002a460: 202b 3d20 320a 2020 2020 2020 2020 2020   += 2.          
+0002a470: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0002a480: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0002a490: 696e 7428 6627 7b75 726c 7d20 3e20 7b6c  int(f'{url} > {l
+0002a4a0: 6f63 616c 5f66 696c 657d 2729 0a20 2020  ocal_file}').   
+0002a4b0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+0002a4c0: 2020 2020 2020 6578 6365 7074 2062 6f74        except bot
+0002a4d0: 6f63 6f72 652e 6578 6365 7074 696f 6e73  ocore.exceptions
+0002a4e0: 2e43 6c69 656e 7445 7272 6f72 3a0a 2020  .ClientError:.  
+0002a4f0: 2020 2020 2020 2020 2020 7472 6163 6520            trace 
+0002a500: 3d20 7472 6163 6562 6163 6b2e 666f 726d  = traceback.form
+0002a510: 6174 5f65 7863 286c 696d 6974 3d32 290a  at_exc(limit=2).
+0002a520: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0002a530: 3d20 7472 6163 652e 7370 6c69 7428 275c  = trace.split('\
+0002a540: 6e27 295b 2d32 5d2e 7370 6c69 7428 2743  n')[-2].split('C
+0002a550: 6c69 656e 7445 7272 6f72 3a20 2729 5b31  lientError: ')[1
+0002a560: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+0002a570: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0002a580: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0002a590: 6627 4661 696c 6564 207b 7572 6c7d 3a20  f'Failed {url}: 
+0002a5a0: 7b6d 7367 7d27 290a 2020 2020 2020 2020  {msg}').        
+0002a5b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0002a5c0: 2020 2020 2023 2044 6f77 6e6c 6f61 6420       # Download 
+0002a5d0: 6661 696c 6564 2064 7565 2074 6f20 6120  failed due to a 
+0002a5e0: 436c 6965 6e74 4572 726f 720a 2020 2020  ClientError.    
+0002a5f0: 2020 2020 2020 2020 2320 466f 7262 6964          # Forbid
+0002a600: 6465 6e20 7072 6f62 6162 6c79 206d 6561  den probably mea
+0002a610: 6e73 2069 6e73 7566 6669 6369 656e 7420  ns insufficient 
+0002a620: 6275 636b 6574 2061 6363 6573 7320 7072  bucket access pr
+0002a630: 6976 696c 6567 6573 0a20 2020 2020 2020  ivileges.       
+0002a640: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+0002a650: 2020 2020 2020 0a20 2020 2072 6574 7572        .    retur
+0002a660: 6e20 6c6f 6361 6c5f 6669 6c65 2c20 7374  n local_file, st
+0002a670: 6174 7573 0a0a 0a64 6566 206e 6972 6973  atus...def niris
+0002a680: 735f 6768 6f73 745f 6d61 736b 2869 6d2c  s_ghost_mask(im,
+0002a690: 2069 6e69 745f 7468 7265 7368 3d30 2e30   init_thresh=0.0
+0002a6a0: 352c 2069 6e69 745f 7369 676d 613d 332c  5, init_sigma=3,
+0002a6b0: 2066 696e 616c 5f74 6872 6573 683d 302e   final_thresh=0.
+0002a6c0: 3031 2c20 6669 6e61 6c5f 7369 676d 613d  01, final_sigma=
+0002a6d0: 332c 2065 726f 7369 6f6e 733d 302c 2064  3, erosions=0, d
+0002a6e0: 696c 6174 696f 6e73 3d39 2c20 7665 7262  ilations=9, verb
+0002a6f0: 6f73 653d 5472 7565 2c20 2a2a 6b77 6172  ose=True, **kwar
+0002a700: 6773 293a 0a20 2020 2022 2222 0a20 2020  gs):.    """.   
+0002a710: 204d 616b 6520 6120 6d61 736b 2066 6f72   Make a mask for
+0002a720: 204e 4952 4953 5320 696d 6167 696e 6720   NIRISS imaging 
+0002a730: 6768 6f73 7473 0a20 2020 200a 2020 2020  ghosts.    .    
+0002a740: 5365 6520 616c 736f 204d 6172 7465 6c2e  See also Martel.
+0002a750: 204a 5753 542d 5354 5363 492d 3030 3438   JWST-STScI-0048
+0002a760: 3737 2061 6e64 0a20 2020 2068 7474 7073  77 and.    https
+0002a770: 3a2f 2f67 6974 6875 622e 636f 6d2f 7370  ://github.com/sp
+0002a780: 6163 6574 656c 6573 636f 7065 2f6e 6972  acetelescope/nir
+0002a790: 6973 735f 6768 6f73 740a 2020 2020 0a20  iss_ghost.    . 
+0002a7a0: 2020 2048 6572 650a 2020 2020 2222 220a     Here.    """.
+0002a7b0: 2020 2020 696d 706f 7274 2073 6369 7079      import scipy
+0002a7c0: 2e6e 6469 6d61 6765 2061 7320 6e64 0a20  .ndimage as nd. 
+0002a7d0: 2020 200a 2020 2020 6966 2069 6d5b 305d     .    if im[0]
+0002a7e0: 2e68 6561 6465 725b 2750 5550 494c 275d  .header['PUPIL']
+0002a7f0: 206e 6f74 2069 6e20 5b27 4631 3135 5727   not in ['F115W'
+0002a800: 2c27 4631 3530 5727 2c27 4632 3030 5727  ,'F150W','F200W'
+0002a810: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+0002a820: 6e20 4661 6c73 650a 2020 2020 0a20 2020  n False.    .   
+0002a830: 2069 6620 696d 5b30 5d2e 6865 6164 6572   if im[0].header
+0002a840: 5b27 5055 5049 4c27 5d20 3d3d 2027 4631  ['PUPIL'] == 'F1
+0002a850: 3135 5727 3a0a 2020 2020 2020 2020 7867  15W':.        xg
+0002a860: 6170 2c20 7967 6170 203d 2031 3135 362c  ap, ygap = 1156,
+0002a870: 2039 3237 0a20 2020 2065 6c69 6620 696d   927.    elif im
+0002a880: 5b30 5d2e 6865 6164 6572 5b27 5055 5049  [0].header['PUPI
+0002a890: 4c27 5d20 3d3d 2027 4631 3135 5727 3a0a  L'] == 'F115W':.
+0002a8a0: 2020 2020 2020 2020 7867 6170 2c20 7967          xgap, yg
+0002a8b0: 6170 203d 2031 3136 322c 2039 3338 0a20  ap = 1162, 938. 
+0002a8c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002a8d0: 2078 6761 702c 2079 6761 7020 3d20 3131   xgap, ygap = 11
+0002a8e0: 3536 2c20 3934 342d 320a 2020 2020 2020  56, 944-2.      
+0002a8f0: 2020 0a20 2020 2079 702c 2078 7020 3d20    .    yp, xp = 
+0002a900: 6e70 2e69 6e64 6963 6573 2828 3230 3438  np.indices((2048
+0002a910: 2c20 3230 3438 2929 0a20 2020 200a 2020  , 2048)).    .  
+0002a920: 2020 7967 203d 2032 2a28 7967 6170 2d31    yg = 2*(ygap-1
+0002a930: 2920 2d20 7970 0a20 2020 2078 6720 3d20  ) - yp.    xg = 
+0002a940: 322a 2878 6761 702d 3129 202d 2078 700a  2*(xgap-1) - xp.
+0002a950: 0a20 2020 2064 7820 3d20 2878 7020 2d20  .    dx = (xp - 
+0002a960: 7867 6170 290a 2020 2020 6479 203d 2028  xgap).    dy = (
+0002a970: 7970 202d 2079 6761 7029 0a0a 2020 2020  yp - ygap)..    
+0002a980: 696e 5f69 6d67 203d 2028 7867 203e 3d20  in_img = (xg >= 
+0002a990: 3029 2026 2028 7867 203c 2032 3034 3829  0) & (xg < 2048)
+0002a9a0: 0a20 2020 2069 6e5f 696d 6720 263d 2028  .    in_img &= (
+0002a9b0: 7967 203e 3d20 3029 2026 2028 7967 203c  yg >= 0) & (yg <
+0002a9c0: 2032 3034 3829 0a0a 2020 2020 696e 5f69   2048)..    in_i
+0002a9d0: 6d67 2026 3d20 6e70 2e61 6273 2864 7829  mg &= np.abs(dx)
+0002a9e0: 203c 2034 3030 0a20 2020 2069 6e5f 696d   < 400.    in_im
+0002a9f0: 6720 263d 206e 702e 6162 7328 6479 2920  g &= np.abs(dy) 
+0002aa00: 3c20 3430 300a 2020 2020 0a20 2020 2069  < 400.    .    i
+0002aa10: 6620 274d 4452 495a 534b 5927 2069 6e20  f 'MDRIZSKY' in 
+0002aa20: 696d 5b27 5343 4927 5d2e 6865 6164 6572  im['SCI'].header
+0002aa30: 3a0a 2020 2020 2020 2020 626b 6720 3d20  :.        bkg = 
+0002aa40: 696d 5b27 5343 4927 5d2e 6865 6164 6572  im['SCI'].header
+0002aa50: 5b27 4d44 5249 5a53 4b59 275d 0a20 2020  ['MDRIZSKY'].   
+0002aa60: 2065 6c73 653a 0a20 2020 2020 2020 2062   else:.        b
+0002aa70: 6b67 203d 206e 702e 6e61 6e6d 6564 6961  kg = np.nanmedia
+0002aa80: 6e28 696d 5b27 5343 4927 5d2e 6461 7461  n(im['SCI'].data
+0002aa90: 5b69 6d5b 2744 5127 5d2e 6461 7461 203d  [im['DQ'].data =
+0002aaa0: 3d20 305d 290a 2020 2020 2020 2020 0a20  = 0]).        . 
+0002aab0: 2020 2074 6872 6573 6820 3d20 2869 6d5b     thresh = (im[
+0002aac0: 2753 4349 275d 2e64 6174 6120 2d20 626b  'SCI'].data - bk
+0002aad0: 6729 2a69 6e69 745f 7468 7265 7368 203e  g)*init_thresh >
+0002aae0: 2069 6e69 745f 7369 676d 612a 696d 5b27   init_sigma*im['
+0002aaf0: 4552 5227 5d2e 6461 7461 0a20 2020 2074  ERR'].data.    t
+0002ab00: 6872 6573 6820 263d 2069 6e5f 696d 670a  hresh &= in_img.
+0002ab10: 0a20 2020 205f 7265 666c 6563 7465 6420  .    _reflected 
+0002ab20: 3d20 6e70 2e7a 6572 6f73 5f6c 696b 6528  = np.zeros_like(
+0002ab30: 696d 5b27 5343 4927 5d2e 6461 7461 290a  im['SCI'].data).
+0002ab40: 2020 2020 666f 7220 7870 692c 2079 7069      for xpi, ypi
+0002ab50: 2c20 7867 692c 2079 6769 2069 6e20 7a69  , xgi, ygi in zi
+0002ab60: 7028 7870 5b74 6872 6573 685d 2c20 7970  p(xp[thresh], yp
+0002ab70: 5b74 6872 6573 685d 2c0a 2020 2020 2020  [thresh],.      
+0002ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab90: 2020 2020 2020 2020 2020 2020 7867 5b74              xg[t
+0002aba0: 6872 6573 685d 2c20 7967 5b74 6872 6573  hresh], yg[thres
+0002abb0: 685d 293a 0a20 2020 2020 2020 2020 2020  h]):.           
 0002abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002abd0: 2020 2020 2067 686f 7374 5f6d 6173 6b2e       ghost_mask.
-0002abe0: 7375 6d28 2929 0a20 2020 206c 6f67 5f63  sum()).    log_c
-0002abf0: 6f6d 6d65 6e74 284c 4f47 4649 4c45 2c20  omment(LOGFILE, 
-0002ac00: 6d73 672c 2076 6572 626f 7365 3d76 6572  msg, verbose=ver
-0002ac10: 626f 7365 290a 2020 2020 0a20 2020 2072  bose).    .    r
-0002ac20: 6574 7572 6e20 6768 6f73 745f 6d61 736b  eturn ghost_mask
-0002ac30: 0a0a 0a64 6566 2067 6574 5f70 686f 746f  ...def get_photo
-0002ac40: 6d5f 7363 616c 6528 6865 6164 6572 2c20  m_scale(header, 
-0002ac50: 7665 7262 6f73 653d 5472 7565 293a 0a20  verbose=True):. 
-0002ac60: 2020 2022 2222 0a20 2020 2047 6574 2074     """.    Get t
-0002ac70: 6162 756c 6174 6564 2073 6361 6c65 2066  abulated scale f
-0002ac80: 6163 746f 720a 2020 2020 0a20 2020 2050  actor.    .    P
-0002ac90: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-0002aca0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2068 6561  --------.    hea
-0002acb0: 6465 7220 3a20 607e 6173 7472 6f70 792e  der : `~astropy.
-0002acc0: 696f 2e66 6974 732e 4865 6164 6572 600a  io.fits.Header`.
-0002acd0: 2020 2020 2020 2020 496d 6167 6520 6865          Image he
-0002ace0: 6164 6572 0a20 2020 200a 2020 2020 5265  ader.    .    Re
-0002acf0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0002ad00: 2d0a 2020 2020 6b65 7920 3a20 7374 720a  -.    key : str.
-0002ad10: 2020 2020 2020 2020 4465 7465 6374 6f72          Detector
-0002ad20: 202b 2066 696c 7465 7220 6b65 790a 2020   + filter key.  
-0002ad30: 2020 0a20 2020 2073 6361 6c65 203a 2066    .    scale : f
-0002ad40: 6c6f 6174 0a20 2020 2020 2020 2053 6361  loat.        Sca
-0002ad50: 6c65 2076 616c 7565 2e20 2049 6620 606b  le value.  If `k
-0002ad60: 6579 6020 6e6f 7420 666f 756e 6420 696e  ey` not found in
-0002ad70: 2074 6865 2060 6064 6174 612f 7068 6f74   the ``data/phot
-0002ad80: 6f6d 5f63 6f72 7265 6374 696f 6e2e 796d  om_correction.ym
-0002ad90: 6c60 600a 2020 2020 2020 2020 7461 626c  l``.        tabl
-0002ada0: 6520 6f72 2069 6620 7468 6520 4354 5820  e or if the CTX 
-0002adb0: 6973 206e 6577 6572 2074 6861 6e20 7468  is newer than th
-0002adc0: 6174 2069 6e64 6963 6174 6564 2069 6e20  at indicated in 
-0002add0: 7468 6520 636f 7272 6563 7469 6f6e 0a20  the correction. 
-0002ade0: 2020 2020 2020 2074 6162 6c65 2074 6865         table the
-0002adf0: 6e20 7265 7475 726e 2031 2e30 2e0a 2020  n return 1.0..  
-0002ae00: 2020 2020 2020 0a20 2020 2022 2222 0a20        .    """. 
-0002ae10: 2020 2069 6d70 6f72 7420 7961 6d6c 0a20     import yaml. 
-0002ae20: 2020 2069 6620 2754 454c 4553 434f 5027     if 'TELESCOP'
-0002ae30: 2069 6e20 6865 6164 6572 3a0a 2020 2020   in header:.    
-0002ae40: 2020 2020 6966 2068 6561 6465 725b 2754      if header['T
-0002ae50: 454c 4553 434f 5027 5d20 6e6f 7420 696e  ELESCOP'] not in
-0002ae60: 205b 274a 5753 5427 5d3a 0a20 2020 2020   ['JWST']:.     
-0002ae70: 2020 2020 2020 206d 7367 203d 2066 2267         msg = f"g
-0002ae80: 6574 5f70 686f 746f 6d5f 7363 616c 653a  et_photom_scale:
-0002ae90: 2054 454c 4553 434f 503d 7b68 6561 6465   TELESCOP={heade
-0002aea0: 725b 2754 454c 4553 434f 5027 5d7d 2069  r['TELESCOP']} i
-0002aeb0: 7320 6e6f 7420 274a 5753 5427 220a 2020  s not 'JWST'".  
-0002aec0: 2020 2020 2020 2020 2020 6c6f 675f 636f            log_co
-0002aed0: 6d6d 656e 7428 4c4f 4746 494c 452c 206d  mment(LOGFILE, m
-0002aee0: 7367 2c20 7665 7262 6f73 653d 7665 7262  sg, verbose=verb
-0002aef0: 6f73 6529 0a20 2020 2020 2020 2020 2020  ose).           
-0002af00: 2072 6574 7572 6e20 6865 6164 6572 5b27   return header['
-0002af10: 5445 4c45 5343 4f50 275d 2c20 312e 300a  TELESCOP'], 1.0.
-0002af20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002af30: 2020 7265 7475 726e 204e 6f6e 652c 2031    return None, 1
-0002af40: 2e30 0a20 2020 2020 2020 200a 2020 2020  .0.        .    
-0002af50: 636f 7272 5f66 696c 6520 3d20 6f73 2e70  corr_file = os.p
-0002af60: 6174 682e 6a6f 696e 286f 732e 7061 7468  ath.join(os.path
-0002af70: 2e64 6972 6e61 6d65 285f 5f66 696c 655f  .dirname(__file_
-0002af80: 5f29 2c20 0a20 2020 2020 2020 2020 2020  _), .           
-0002af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002afa0: 2020 2764 6174 612f 7068 6f74 6f6d 5f63    'data/photom_c
-0002afb0: 6f72 7265 6374 696f 6e2e 796d 6c27 290a  orrection.yml').
-0002afc0: 2020 2020 0a20 2020 2069 6620 6e6f 7420      .    if not 
-0002afd0: 6f73 2e70 6174 682e 6578 6973 7473 2863  os.path.exists(c
-0002afe0: 6f72 725f 6669 6c65 293a 0a20 2020 2020  orr_file):.     
-0002aff0: 2020 206d 7367 203d 2066 277b 636f 7272     msg = f'{corr
-0002b000: 5f66 696c 657d 206e 6f74 2066 6f75 6e64  _file} not found
-0002b010: 2e27 0a20 2020 2020 2020 206c 6f67 5f63  .'.        log_c
-0002b020: 6f6d 6d65 6e74 284c 4f47 4649 4c45 2c20  omment(LOGFILE, 
-0002b030: 6d73 672c 2076 6572 626f 7365 3d76 6572  msg, verbose=ver
-0002b040: 626f 7365 290a 2020 2020 2020 2020 7265  bose).        re
-0002b050: 7475 726e 204e 6f6e 652c 2031 0a20 2020  turn None, 1.   
-0002b060: 200a 2020 2020 7769 7468 206f 7065 6e28   .    with open(
-0002b070: 636f 7272 5f66 696c 6529 2061 7320 6670  corr_file) as fp
-0002b080: 3a0a 2020 2020 2020 2020 636f 7272 203d  :.        corr =
-0002b090: 2079 616d 6c2e 6c6f 6164 2866 702c 204c   yaml.load(fp, L
-0002b0a0: 6f61 6465 723d 7961 6d6c 2e53 6166 654c  oader=yaml.SafeL
-0002b0b0: 6f61 6465 7229 0a20 2020 2020 2020 200a  oader).        .
-0002b0c0: 2020 2020 6966 2027 4352 4453 5f43 5458      if 'CRDS_CTX
-0002b0d0: 2720 696e 2068 6561 6465 723a 0a20 2020  ' in header:.   
-0002b0e0: 2020 2020 2069 6620 6865 6164 6572 5b27       if header['
-0002b0f0: 4352 4453 5f43 5458 275d 203e 2063 6f72  CRDS_CTX'] > cor
-0002b100: 725b 2743 5244 535f 4354 585f 4d41 5827  r['CRDS_CTX_MAX'
-0002b110: 5d3a 0a20 2020 2020 2020 2020 2020 206d  ]:.            m
-0002b120: 7367 203d 2066 2267 6574 5f70 686f 746f  sg = f"get_photo
-0002b130: 6d5f 7363 616c 6520 7b63 6f72 725f 6669  m_scale {corr_fi
-0002b140: 6c65 7d3a 207b 6865 6164 6572 5b27 4352  le}: {header['CR
-0002b150: 4453 5f43 5458 275d 7d20 3e20 7b63 6f72  DS_CTX']} > {cor
-0002b160: 725b 2743 5244 535f 4354 585f 4d41 5827  r['CRDS_CTX_MAX'
-0002b170: 5d7d 220a 2020 2020 2020 2020 2020 2020  ]}".            
-0002b180: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
-0002b190: 494c 452c 206d 7367 2c20 7665 7262 6f73  ILE, msg, verbos
-0002b1a0: 653d 7665 7262 6f73 6529 0a20 2020 2020  e=verbose).     
-0002b1b0: 2020 2020 2020 2072 6574 7572 6e20 6865         return he
-0002b1c0: 6164 6572 5b27 4352 4453 5f43 5458 275d  ader['CRDS_CTX']
-0002b1d0: 2c20 312e 300a 2020 2020 2020 2020 2020  , 1.0.          
-0002b1e0: 2020 0a20 2020 206b 6579 203d 2027 7b30    .    key = '{0
-0002b1f0: 7d2d 7b31 7d27 2e66 6f72 6d61 7428 6865  }-{1}'.format(he
-0002b200: 6164 6572 5b27 4445 5445 4354 4f52 275d  ader['DETECTOR']
-0002b210: 2c20 6865 6164 6572 5b27 4649 4c54 4552  , header['FILTER
-0002b220: 275d 290a 2020 2020 6966 2027 5055 5049  ']).    if 'PUPI
-0002b230: 4c27 2069 6e20 6865 6164 6572 3a0a 2020  L' in header:.  
-0002b240: 2020 2020 2020 6b65 7920 2b3d 2027 2d7b        key += '-{
-0002b250: 307d 272e 666f 726d 6174 2868 6561 6465  0}'.format(heade
-0002b260: 725b 2750 5550 494c 275d 290a 2020 2020  r['PUPIL']).    
-0002b270: 0a20 2020 2069 6620 6b65 7920 6e6f 7420  .    if key not 
-0002b280: 696e 2063 6f72 723a 0a20 2020 2020 2020  in corr:.       
-0002b290: 206d 7367 203d 2066 2267 6574 5f70 686f   msg = f"get_pho
-0002b2a0: 746f 6d5f 7363 616c 6520 7b63 6f72 725f  tom_scale {corr_
-0002b2b0: 6669 6c65 7d3a 207b 6b65 797d 206e 6f74  file}: {key} not
-0002b2c0: 2066 6f75 6e64 220a 2020 2020 2020 2020   found".        
-0002b2d0: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
-0002b2e0: 494c 452c 206d 7367 2c20 7665 7262 6f73  ILE, msg, verbos
-0002b2f0: 653d 7665 7262 6f73 6529 0a20 2020 2020  e=verbose).     
-0002b300: 2020 200a 2020 2020 2020 2020 7265 7475     .        retu
-0002b310: 726e 206b 6579 2c20 312e 300a 2020 2020  rn key, 1.0.    
-0002b320: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0002b330: 2020 206d 7367 203d 2066 2267 6574 5f70     msg = f"get_p
-0002b340: 686f 746f 6d5f 7363 616c 6520 7b63 6f72  hotom_scale {cor
-0002b350: 725f 6669 6c65 7d3a 2053 6361 6c65 207b  r_file}: Scale {
-0002b360: 6b65 797d 2062 7920 7b31 2e2f 636f 7272  key} by {1./corr
-0002b370: 5b6b 6579 5d3a 2e33 667d 220a 2020 2020  [key]:.3f}".    
-0002b380: 2020 2020 6c6f 675f 636f 6d6d 656e 7428      log_comment(
-0002b390: 4c4f 4746 494c 452c 206d 7367 2c20 7665  LOGFILE, msg, ve
-0002b3a0: 7262 6f73 653d 7665 7262 6f73 6529 0a20  rbose=verbose). 
-0002b3b0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002b3c0: 7265 7475 726e 206b 6579 2c20 312e 2f63  return key, 1./c
-0002b3d0: 6f72 725b 6b65 795d 0a0a 0a64 6566 2064  orr[key]...def d
-0002b3e0: 7269 7a7a 6c65 5f66 726f 6d5f 7669 7369  rizzle_from_visi
-0002b3f0: 7428 7669 7369 742c 206f 7574 7075 743d  t(visit, output=
-0002b400: 4e6f 6e65 2c20 7069 7866 7261 633d 312e  None, pixfrac=1.
-0002b410: 2c20 6b65 726e 656c 3d27 706f 696e 7427  , kernel='point'
-0002b420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b430: 2020 2020 2020 2020 2063 6c65 616e 3d54           clean=T
-0002b440: 7275 652c 2069 6e63 6c75 6465 5f73 6174  rue, include_sat
-0002b450: 7572 6174 6564 3d54 7275 652c 206b 6565  urated=True, kee
-0002b460: 705f 6269 7473 3d4e 6f6e 652c 0a20 2020  p_bits=None,.   
-0002b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b480: 2020 2020 6472 7972 756e 3d46 616c 7365      dryrun=False
-0002b490: 2c20 736b 6970 3d4e 6f6e 652c 2065 7874  , skip=None, ext
-0002b4a0: 7261 5f77 6663 3369 725f 6261 6470 6978  ra_wfc3ir_badpix
-0002b4b0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-0002b4c0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-0002b4d0: 7262 6f73 653d 5472 7565 2c0a 2020 2020  rbose=True,.    
-0002b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4f0: 2020 2073 6361 6c65 5f70 686f 746f 6d3d     scale_photom=
-0002b500: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0002b510: 2020 2020 2020 2020 2020 2020 2063 616c               cal
-0002b520: 635f 7763 736d 6170 3d46 616c 7365 2c0a  c_wcsmap=False,.
-0002b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b540: 2020 2020 2020 206e 6972 6973 735f 6768         niriss_gh
-0002b550: 6f73 745f 6b77 6172 6773 3d7b 7d29 3a0a  ost_kwargs={}):.
-0002b560: 2020 2020 2222 220a 2020 2020 4d61 6b65      """.    Make
-0002b570: 2064 7269 7a7a 6c65 206d 6f73 6169 6320   drizzle mosaic 
-0002b580: 6672 6f6d 2065 7870 6f73 7572 6573 2069  from exposures i
-0002b590: 6e20 6120 7669 7369 7420 6469 6374 696f  n a visit dictio
-0002b5a0: 6e61 7279 0a20 2020 200a 2020 2020 5061  nary.    .    Pa
-0002b5b0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0002b5c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7669 7369  -------.    visi
-0002b5d0: 7420 3a20 6469 6374 0a20 2020 2020 2020  t : dict.       
-0002b5e0: 2056 6973 6974 2064 6963 7469 6f6e 6172   Visit dictionar
-0002b5f0: 7920 7769 7468 2027 7072 6f64 7563 7427  y with 'product'
-0002b600: 2061 6e64 2027 6669 6c65 7327 206b 6579   and 'files' key
-0002b610: 730a 2020 2020 0a20 2020 206f 7574 7075  s.    .    outpu
-0002b620: 7420 3a20 607e 6173 7472 6f70 792e 7763  t : `~astropy.wc
-0002b630: 732e 5743 5360 2c20 607e 6173 7472 6f70  s.WCS`, `~astrop
-0002b640: 792e 696f 2e66 6974 732e 4865 6164 6572  y.io.fits.Header
-0002b650: 602c 2060 7e61 7374 726f 7079 2e69 6f2e  `, `~astropy.io.
-0002b660: 496d 6167 6548 4455 600a 2020 2020 2020  ImageHDU`.      
-0002b670: 2020 4f75 7470 7574 2066 7261 6d65 2064    Output frame d
-0002b680: 6566 696e 6974 696f 6e2e 2020 4361 6e20  efinition.  Can 
-0002b690: 6265 2061 2057 4353 206f 626a 6563 742c  be a WCS object,
-0002b6a0: 2068 6561 6465 722c 206f 7220 4649 5453   header, or FITS
-0002b6b0: 2048 4455 2e20 2049 660a 2020 2020 2020   HDU.  If.      
-0002b6c0: 2020 4e6f 6e65 2c20 7468 656e 2067 656e    None, then gen
-0002b6d0: 6572 6174 6573 2061 2057 4353 2077 6974  erates a WCS wit
-0002b6e0: 6820 6067 7269 7a6c 692e 7574 696c 732e  h `grizli.utils.
-0002b6f0: 6d61 6b65 5f6d 6178 696d 616c 5f77 6373  make_maximal_wcs
-0002b700: 600a 2020 2020 0a20 2020 2070 6978 6672  `.    .    pixfr
-0002b710: 6163 203a 2066 6c6f 6174 0a20 2020 2020  ac : float.     
-0002b720: 2020 2044 7269 7a7a 6c65 2060 7069 7866     Drizzle `pixf
-0002b730: 7261 6360 0a20 2020 200a 2020 2020 6b65  rac`.    .    ke
-0002b740: 726e 656c 203a 2073 7472 0a20 2020 2020  rnel : str.     
-0002b750: 2020 2044 7269 7a7a 6c65 2060 6b65 726e     Drizzle `kern
-0002b760: 656c 6020 2865 2e67 2e2c 2027 706f 696e  el` (e.g., 'poin
-0002b770: 7427 2c20 2773 7175 6172 6527 290a 2020  t', 'square').  
-0002b780: 2020 0a20 2020 2063 6c65 616e 203a 2062    .    clean : b
-0002b790: 6f6f 6c0a 2020 2020 2020 2020 5265 6d6f  ool.        Remo
-0002b7a0: 7665 2065 7870 6f73 7572 6520 6669 6c65  ve exposure file
-0002b7b0: 7320 6166 7465 7220 6164 6469 6e67 2074  s after adding t
-0002b7c0: 6f20 7468 6520 6d6f 7361 6963 0a20 2020  o the mosaic.   
-0002b7d0: 200a 2020 2020 696e 636c 7564 655f 7361   .    include_sa
-0002b7e0: 7475 7261 7465 6420 3a20 626f 6f6c 0a20  turated : bool. 
-0002b7f0: 2020 2020 2020 2049 6e63 6c75 6465 2070         Include p
-0002b800: 6978 656c 7320 7769 7468 2073 6174 7572  ixels with satur
-0002b810: 6174 6564 2044 5120 666c 6167 0a20 2020  ated DQ flag.   
-0002b820: 200a 2020 2020 6b65 6570 5f62 6974 7320   .    keep_bits 
-0002b830: 3a20 696e 742c 204e 6f6e 650a 2020 2020  : int, None.    
-0002b840: 2020 2020 4578 7472 6120 4451 2062 6974      Extra DQ bit
-0002b850: 7320 746f 206b 6565 7020 6173 2076 616c  s to keep as val
-0002b860: 6964 0a20 2020 200a 2020 2020 6472 7972  id.    .    dryr
-0002b870: 756e 203a 2062 6f6f 6c0a 2020 2020 2020  un : bool.      
-0002b880: 2020 4966 2054 7275 652c 2064 6f6e 2774    If True, don't
-0002b890: 2061 6374 7561 6c6c 7920 7072 6f64 7563   actually produc
-0002b8a0: 6520 7468 6520 6f75 7470 7574 0a20 2020  e the output.   
-0002b8b0: 200a 2020 2020 736b 6970 203a 2069 6e74   .    skip : int
-0002b8c0: 0a20 2020 2020 2020 2053 6c69 6365 2073  .        Slice s
-0002b8d0: 6b69 7020 746f 2064 7269 7a7a 6c65 2061  kip to drizzle a
-0002b8e0: 2073 7562 7365 7420 6f66 2065 7870 6f73   subset of expos
-0002b8f0: 7572 6573 0a20 2020 200a 2020 2020 6578  ures.    .    ex
-0002b900: 7472 615f 7766 6333 6972 5f62 6164 7069  tra_wfc3ir_badpi
-0002b910: 7820 3a20 626f 6f6c 0a20 2020 2020 2020  x : bool.       
-0002b920: 2041 7070 6c79 2065 7874 7261 2057 4643   Apply extra WFC
-0002b930: 332f 4952 2062 6164 2070 6978 2074 6f20  3/IR bad pix to 
-0002b940: 4451 0a20 2020 200a 2020 2020 7665 7262  DQ.    .    verb
-0002b950: 6f73 6520 3a20 626f 6f6c 0a20 2020 2020  ose : bool.     
-0002b960: 2020 2053 6f6d 6520 7665 7262 6f73 6520     Some verbose 
-0002b970: 6d65 7373 6167 6520 7072 696e 7469 6e67  message printing
-0002b980: 0a20 2020 200a 2020 2020 7363 616c 655f  .    .    scale_
-0002b990: 7068 6f74 6f6d 203a 2062 6f6f 6c0a 2020  photom : bool.  
-0002b9a0: 2020 2020 2020 466f 7220 4a57 5354 2c20        For JWST, 
-0002b9b0: 6170 706c 7920 7068 6f74 6f6d 6574 7279  apply photometry
-0002b9c0: 2073 6361 6c65 2063 6f72 7265 6374 696f   scale correctio
-0002b9d0: 6e73 2066 726f 6d20 7468 6520 200a 2020  ns from the  .  
-0002b9e0: 2020 2020 2020 6067 7269 7a6c 692f 6461        `grizli/da
-0002b9f0: 7461 2f70 686f 746f 6d5f 636f 7272 6563  ta/photom_correc
-0002ba00: 7469 6f6e 2e79 6d6c 6020 7461 626c 650a  tion.yml` table.
-0002ba10: 2020 2020 0a20 2020 206e 6972 6973 735f      .    niriss_
-0002ba20: 6768 6f73 745f 6b77 6172 6773 203a 2064  ghost_kwargs : d
-0002ba30: 6963 740a 2020 2020 2020 2020 4b65 7977  ict.        Keyw
-0002ba40: 6f72 6420 6172 6775 6d65 6e74 7320 666f  ord arguments fo
-0002ba50: 7220 607e 6772 697a 6c69 2e75 7469 6c73  r `~grizli.utils
-0002ba60: 2e6e 6972 6973 735f 6768 6f73 745f 6d61  .niriss_ghost_ma
-0002ba70: 736b 600a 2020 2020 0a20 2020 2052 6574  sk`.    .    Ret
-0002ba80: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-0002ba90: 0a20 2020 206f 7574 7363 6920 3a20 6172  .    outsci : ar
-0002baa0: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
-0002bab0: 2053 4349 2061 7272 6179 0a20 2020 200a   SCI array.    .
-0002bac0: 2020 2020 6f75 7477 6874 203a 2061 7272      outwht : arr
-0002bad0: 6179 2d6c 696b 650a 2020 2020 2020 2020  ay-like.        
-0002bae0: 496e 7665 7273 6520 7661 7269 616e 6365  Inverse variance
-0002baf0: 2057 4854 2061 7272 6179 0a20 2020 200a   WHT array.    .
-0002bb00: 2020 2020 6865 6164 6572 203a 2060 7e61      header : `~a
-0002bb10: 7374 726f 7079 2e69 6f2e 6669 7473 2e48  stropy.io.fits.H
-0002bb20: 6561 6465 7260 0a20 2020 2020 2020 2049  eader`.        I
-0002bb30: 6d61 6765 2068 6561 6465 720a 2020 2020  mage header.    
-0002bb40: 0a20 2020 2066 6c69 7374 203a 206c 6973  .    flist : lis
-0002bb50: 740a 2020 2020 2020 2020 4c69 7374 206f  t.        List o
-0002bb60: 6620 6669 6c65 7320 7468 6174 2077 6572  f files that wer
-0002bb70: 6520 6472 697a 7a6c 6564 2074 6f20 7468  e drizzled to th
-0002bb80: 6520 6d6f 7361 6963 0a20 2020 2020 2020  e mosaic.       
-0002bb90: 200a 2020 2020 7763 735f 7461 6220 3a20   .    wcs_tab : 
-0002bba0: 607e 6173 7472 6f70 792e 7461 626c 652e  `~astropy.table.
-0002bbb0: 5461 626c 6560 0a20 2020 2020 2020 2054  Table`.        T
-0002bbc0: 6162 6c65 206f 6620 5743 5320 7061 7261  able of WCS para
-0002bbd0: 6d65 7465 7273 206f 6620 696e 6469 7669  meters of indivi
-0002bbe0: 6475 616c 2065 7870 6f73 7572 6573 0a20  dual exposures. 
-0002bbf0: 2020 200a 2020 2020 2222 220a 2020 2020     .    """.    
-0002bc00: 6672 6f6d 2073 6861 7065 6c79 2e67 656f  from shapely.geo
-0002bc10: 6d65 7472 7920 696d 706f 7274 2050 6f6c  metry import Pol
-0002bc20: 7967 6f6e 0a20 2020 2069 6d70 6f72 7420  ygon.    import 
-0002bc30: 626f 746f 330a 2020 2020 6672 6f6d 2062  boto3.    from b
-0002bc40: 6f74 6f63 6f72 652e 6578 6365 7074 696f  otocore.exceptio
-0002bc50: 6e73 2069 6d70 6f72 7420 436c 6965 6e74  ns import Client
-0002bc60: 4572 726f 720a 2020 2020 696d 706f 7274  Error.    import
-0002bc70: 2073 6369 7079 2e6e 6469 6d61 6765 2061   scipy.ndimage a
-0002bc80: 7320 6e64 0a20 2020 2066 726f 6d20 6173  s nd.    from as
-0002bc90: 7472 6f70 792e 696f 2e66 6974 7320 696d  tropy.io.fits im
-0002bca0: 706f 7274 2050 7269 6d61 7279 4844 552c  port PrimaryHDU,
-0002bcb0: 2049 6d61 6765 4844 550a 2020 2020 6672   ImageHDU.    fr
-0002bcc0: 6f6d 202e 7665 7273 696f 6e20 696d 706f  om .version impo
-0002bcd0: 7274 205f 5f76 6572 7369 6f6e 5f5f 2061  rt __version__ a
-0002bce0: 7320 6772 697a 6c69 5f5f 7665 7273 696f  s grizli__versio
-0002bcf0: 6e0a 2020 2020 0a20 2020 2062 7563 6b65  n.    .    bucke
-0002bd00: 745f 6e61 6d65 203d 204e 6f6e 650a 2020  t_name = None.  
-0002bd10: 2020 7333 203d 2062 6f74 6f33 2e72 6573    s3 = boto3.res
-0002bd20: 6f75 7263 6528 2773 3327 290a 2020 2020  ource('s3').    
-0002bd30: 7333 5f63 6c69 656e 7420 3d20 626f 746f  s3_client = boto
-0002bd40: 332e 636c 6965 6e74 2827 7333 2729 0a20  3.client('s3'). 
-0002bd50: 2020 200a 2020 2020 0a20 2020 2069 6620     .    .    if 
-0002bd60: 6973 696e 7374 616e 6365 286f 7574 7075  isinstance(outpu
-0002bd70: 742c 2070 7977 6373 2e57 4353 293a 0a20  t, pywcs.WCS):. 
-0002bd80: 2020 2020 2020 206f 7574 7075 7477 6373         outputwcs
-0002bd90: 203d 206f 7574 7075 740a 2020 2020 656c   = output.    el
-0002bda0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-0002bdb0: 7470 7574 2c20 7079 6669 7473 2e48 6561  tput, pyfits.Hea
-0002bdc0: 6465 7229 3a0a 2020 2020 2020 2020 6f75  der):.        ou
-0002bdd0: 7470 7574 7763 7320 3d20 7079 7763 732e  tputwcs = pywcs.
-0002bde0: 5743 5328 6f75 7470 7574 290a 2020 2020  WCS(output).    
-0002bdf0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0002be00: 6f75 7470 7574 2c20 5072 696d 6172 7948  output, PrimaryH
-0002be10: 4455 2920 7c20 6973 696e 7374 616e 6365  DU) | isinstance
-0002be20: 286f 7574 7075 742c 2049 6d61 6765 4844  (output, ImageHD
-0002be30: 5529 3a0a 2020 2020 2020 2020 6f75 7470  U):.        outp
-0002be40: 7574 7763 7320 3d20 7079 7763 732e 5743  utwcs = pywcs.WC
-0002be50: 5328 6f75 7470 7574 2e68 6561 6465 7229  S(output.header)
-0002be60: 0a20 2020 2065 6c69 6620 6f75 7470 7574  .    elif output
-0002be70: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002be80: 2020 5f68 6475 203d 206d 616b 655f 6d61    _hdu = make_ma
-0002be90: 7869 6d61 6c5f 7763 7328 6669 6c65 733d  ximal_wcs(files=
-0002bea0: 7669 7369 745b 2766 696c 6573 275d 2c0a  visit['files'],.
-0002beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bed0: 7069 7865 6c5f 7363 616c 653d 4e6f 6e65  pixel_scale=None
-0002bee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf00: 2020 6765 745f 6864 753d 5472 7565 2c0a    get_hdu=True,.
-0002bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf30: 7665 7262 6f73 653d 4661 6c73 652c 0a20  verbose=False,. 
-0002bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002bf60: 6164 3d34 290a 2020 2020 2020 2020 6f75  ad=4).        ou
-0002bf70: 7470 7574 7763 7320 3d20 7079 7763 732e  tputwcs = pywcs.
-0002bf80: 5743 5328 5f68 6475 2e68 6561 6465 7229  WCS(_hdu.header)
-0002bf90: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0002bfa0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-0002bfb0: 2020 2020 6966 206e 6f74 2068 6173 6174      if not hasat
-0002bfc0: 7472 286f 7574 7075 7477 6373 2c20 275f  tr(outputwcs, '_
-0002bfd0: 6e61 7869 7331 2729 3a0a 2020 2020 2020  naxis1'):.      
-0002bfe0: 2020 6f75 7470 7574 7763 732e 5f6e 6178    outputwcs._nax
-0002bff0: 6973 312c 206f 7574 7075 7477 6373 2e5f  is1, outputwcs._
-0002c000: 6e61 7869 7332 203d 206f 7574 7075 7477  naxis2 = outputw
-0002c010: 6373 2e5f 6e61 7869 730a 0a20 2020 206f  cs._naxis..    o
-0002c020: 7574 7075 7477 6373 2e70 7363 616c 6520  utputwcs.pscale 
-0002c030: 3d20 6765 745f 7763 735f 7073 6361 6c65  = get_wcs_pscale
-0002c040: 286f 7574 7075 7477 6373 290a 0a20 2020  (outputwcs)..   
-0002c050: 206f 7574 7075 745f 706f 6c79 203d 2050   output_poly = P
-0002c060: 6f6c 7967 6f6e 286f 7574 7075 7477 6373  olygon(outputwcs
-0002c070: 2e63 616c 635f 666f 6f74 7072 696e 7428  .calc_footprint(
-0002c080: 2929 0a20 2020 2063 6f75 6e74 203d 2030  )).    count = 0
-0002c090: 0a0a 2020 2020 7265 665f 7068 6f74 666c  ..    ref_photfl
-0002c0a0: 616d 203d 204e 6f6e 650a 2020 2020 0a20  am = None.    . 
-0002c0b0: 2020 2069 6e64 6963 6573 203d 205b 5d0a     indices = [].
-0002c0c0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0002c0d0: 6765 286c 656e 2876 6973 6974 5b27 6669  ge(len(visit['fi
-0002c0e0: 6c65 7327 5d29 293a 0a20 2020 2020 2020  les'])):.       
-0002c0f0: 2069 6620 2766 6f6f 7470 7269 6e74 7327   if 'footprints'
-0002c100: 2069 6e20 7669 7369 743a 0a20 2020 2020   in visit:.     
-0002c110: 2020 2020 2020 206f 6c61 7020 3d20 7669         olap = vi
-0002c120: 7369 745b 2766 6f6f 7470 7269 6e74 7327  sit['footprints'
-0002c130: 5d5b 695d 2e69 6e74 6572 7365 6374 696f  ][i].intersectio
-0002c140: 6e28 6f75 7470 7574 5f70 6f6c 7929 0a20  n(output_poly). 
-0002c150: 2020 2020 2020 2020 2020 2069 6620 6f6c             if ol
-0002c160: 6170 2e61 7265 6120 3e20 303a 0a20 2020  ap.area > 0:.   
-0002c170: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-0002c180: 6963 6573 2e61 7070 656e 6428 6929 0a20  ices.append(i). 
-0002c190: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002c1a0: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-0002c1b0: 2e61 7070 656e 6428 6929 0a0a 2020 2020  .append(i)..    
-0002c1c0: 6966 2073 6b69 7020 6973 206e 6f74 204e  if skip is not N
-0002c1d0: 6f6e 653a 0a20 2020 2020 2020 2069 6e64  one:.        ind
-0002c1e0: 6963 6573 203d 2069 6e64 6963 6573 5b3a  ices = indices[:
-0002c1f0: 3a73 6b69 705d 0a0a 2020 2020 4e54 4f54  :skip]..    NTOT
-0002c200: 414c 203d 206c 656e 2869 6e64 6963 6573  AL = len(indices
-0002c210: 290a 2020 2020 0a20 2020 2077 6373 5f72  ).    .    wcs_r
-0002c220: 6f77 7320 3d20 5b5d 0a20 2020 2077 6373  ows = [].    wcs
-0002c230: 5f63 6f6c 6e61 6d65 7320 3d20 4e6f 6e65  _colnames = None
-0002c240: 0a20 2020 2077 6373 5f6b 6579 7320 3d20  .    wcs_keys = 
-0002c250: 7b7d 0a20 2020 200a 2020 2020 6270 6461  {}.    .    bpda
-0002c260: 7461 203d 2030 0a20 2020 200a 2020 2020  ta = 0.    .    
-0002c270: 666f 7220 6920 696e 2069 6e64 6963 6573  for i in indices
-0002c280: 3a0a 0a20 2020 2020 2020 2066 696c 6520  :..        file 
-0002c290: 3d20 7669 7369 745b 2766 696c 6573 275d  = visit['files']
-0002c2a0: 5b69 5d0a 0a20 2020 2020 2020 206d 7367  [i]..        msg
-0002c2b0: 203d 2027 5c6e 287b 303a 3464 7d2f 7b31   = '\n({0:4d}/{1
-0002c2c0: 3a34 647d 2920 4164 6420 6578 706f 7375  :4d}) Add exposu
-0002c2d0: 7265 207b 327d 5c6e 270a 2020 2020 2020  re {2}\n'.      
-0002c2e0: 2020 6d73 6720 3d20 6d73 672e 666f 726d    msg = msg.form
-0002c2f0: 6174 2863 6f75 6e74 2b31 2c20 4e54 4f54  at(count+1, NTOT
-0002c300: 414c 2c20 6669 6c65 290a 2020 2020 2020  AL, file).      
-0002c310: 2020 6c6f 675f 636f 6d6d 656e 7428 4c4f    log_comment(LO
-0002c320: 4746 494c 452c 206d 7367 2c20 7665 7262  GFILE, msg, verb
-0002c330: 6f73 653d 7665 7262 6f73 6529 0a0a 2020  ose=verbose)..  
-0002c340: 2020 2020 2020 6966 2064 7279 7275 6e3a        if dryrun:
-0002c350: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0002c360: 7469 6e75 650a 0a20 2020 2020 2020 2069  tinue..        i
-0002c370: 6620 6e6f 7420 6f73 2e70 6174 682e 6578  f not os.path.ex
-0002c380: 6973 7473 2866 696c 6529 3a0a 2020 2020  ists(file):.    
-0002c390: 2020 2020 2020 2020 6275 636b 6574 5f69          bucket_i
-0002c3a0: 203d 2076 6973 6974 5b27 6177 7370 6174   = visit['awspat
-0002c3b0: 6827 5d5b 695d 2e73 706c 6974 2827 2f27  h'][i].split('/'
-0002c3c0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-0002c3d0: 2069 6620 6275 636b 6574 5f6e 616d 6520   if bucket_name 
-0002c3e0: 213d 2062 7563 6b65 745f 693a 0a20 2020  != bucket_i:.   
-0002c3f0: 2020 2020 2020 2020 2020 2020 2062 7563               buc
-0002c400: 6b65 745f 6e61 6d65 203d 2062 7563 6b65  ket_name = bucke
-0002c410: 745f 690a 2020 2020 2020 2020 2020 2020  t_i.            
-0002c420: 2020 2020 626b 7420 3d20 7333 2e42 7563      bkt = s3.Buc
-0002c430: 6b65 7428 6275 636b 6574 5f6e 616d 6529  ket(bucket_name)
-0002c440: 0a0a 2020 2020 2020 2020 2020 2020 7333  ..            s3
-0002c450: 5f70 6174 6820 3d20 272f 272e 6a6f 696e  _path = '/'.join
-0002c460: 2876 6973 6974 5b27 6177 7370 6174 6827  (visit['awspath'
-0002c470: 5d5b 695d 2e73 706c 6974 2827 2f27 295b  ][i].split('/')[
-0002c480: 313a 5d29 0a20 2020 2020 2020 2020 2020  1:]).           
-0002c490: 2072 656d 6f74 655f 6669 6c65 203d 206f   remote_file = o
-0002c4a0: 732e 7061 7468 2e6a 6f69 6e28 7333 5f70  s.path.join(s3_p
-0002c4b0: 6174 682c 2066 696c 6529 0a0a 2020 2020  ath, file)..    
-0002c4c0: 2020 2020 2020 2020 7072 696e 7428 2720          print(' 
-0002c4d0: 2028 6665 7463 6820 6672 6f6d 2073 333a   (fetch from s3:
-0002c4e0: 2f2f 7b30 7d2f 7b31 7d29 272e 666f 726d  //{0}/{1})'.form
-0002c4f0: 6174 2862 7563 6b65 745f 692c 2072 656d  at(bucket_i, rem
-0002c500: 6f74 655f 6669 6c65 2929 0a0a 2020 2020  ote_file))..    
-0002c510: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002c520: 2020 2020 2020 2020 2020 2020 2062 6b74               bkt
-0002c530: 2e64 6f77 6e6c 6f61 645f 6669 6c65 2872  .download_file(r
-0002c540: 656d 6f74 655f 6669 6c65 2c20 6669 6c65  emote_file, file
-0002c550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c570: 4578 7472 6141 7267 733d 7b22 5265 7175  ExtraArgs={"Requ
-0002c580: 6573 7450 6179 6572 223a 2022 7265 7175  estPayer": "requ
-0002c590: 6573 7465 7222 7d29 0a20 2020 2020 2020  ester"}).       
-0002c5a0: 2020 2020 2065 7863 6570 7420 436c 6965       except Clie
-0002c5b0: 6e74 4572 726f 723a 0a20 2020 2020 2020  ntError:.       
-0002c5c0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-0002c5d0: 2020 2866 6169 6c65 6420 7333 3a2f 2f7b    (failed s3://{
-0002c5e0: 307d 2f7b 317d 2927 2e66 6f72 6d61 7428  0}/{1})'.format(
-0002c5f0: 6275 636b 6574 5f69 2c20 7265 6d6f 7465  bucket_i, remote
-0002c600: 5f66 696c 6529 290a 2020 2020 2020 2020  _file)).        
-0002c610: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0002c620: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-0002c630: 2020 2020 2020 2020 2020 2066 6c74 203d             flt =
-0002c640: 2070 7966 6974 732e 6f70 656e 2866 696c   pyfits.open(fil
-0002c650: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
-0002c660: 7420 4f53 4572 726f 723a 0a20 2020 2020  t OSError:.     
-0002c670: 2020 2020 2020 2070 7269 6e74 2866 276f         print(f'o
-0002c680: 7065 6e28 7b66 696c 657d 2920 6661 696c  pen({file}) fail
-0002c690: 6564 2127 290a 2020 2020 2020 2020 2020  ed!').          
-0002c6a0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-0002c6b0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002c6c0: 7363 695f 6c69 7374 2c20 7768 745f 6c69  sci_list, wht_li
-0002c6d0: 7374 2c20 7763 735f 6c69 7374 203d 205b  st, wcs_list = [
-0002c6e0: 5d2c 205b 5d2c 205b 5d0a 2020 2020 2020  ], [], [].      
-0002c6f0: 2020 0a20 2020 2020 2020 206b 6579 7320    .        keys 
-0002c700: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
-0002c710: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-0002c720: 205b 2745 5850 5449 4d45 272c 2027 5445   ['EXPTIME', 'TE
-0002c730: 4c45 5343 4f50 272c 2027 4649 4c54 4552  LESCOP', 'FILTER
-0002c740: 272c 2746 494c 5445 5231 272c 2027 4649  ','FILTER1', 'FI
-0002c750: 4c54 4552 3227 2c20 0a20 2020 2020 2020  LTER2', .       
-0002c760: 2020 2020 2020 2020 2020 2027 5055 5049             'PUPI
-0002c770: 4c27 2c20 2744 4554 4543 544f 5227 2c20  L', 'DETECTOR', 
-0002c780: 2749 4e53 5452 554d 4527 2c20 2750 484f  'INSTRUME', 'PHO
-0002c790: 5446 4c41 4d27 2c20 2750 484f 5450 4c41  TFLAM', 'PHOTPLA
-0002c7a0: 4d27 2c20 0a20 2020 2020 2020 2020 2020  M', .           
-0002c7b0: 2020 2020 2020 2027 5048 4f54 464e 5527         'PHOTFNU'
-0002c7c0: 2c20 2750 484f 545a 5054 272c 2027 5048  , 'PHOTZPT', 'PH
-0002c7d0: 4f54 4257 272c 2027 5048 4f54 4d4f 4445  OTBW', 'PHOTMODE
-0002c7e0: 272c 2027 4558 5053 5441 5254 272c 200a  ', 'EXPSTART', .
-0002c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c800: 2020 2745 5850 454e 4427 2c20 2744 4154    'EXPEND', 'DAT
-0002c810: 452d 4f42 5327 2c20 2754 494d 452d 4f42  E-OBS', 'TIME-OB
-0002c820: 5327 2c0a 2020 2020 2020 2020 2020 2020  S',.            
-0002c830: 2020 2020 2020 2755 5044 415f 4354 5827        'UPDA_CTX'
-0002c840: 2c20 2743 5244 535f 4354 5827 2c20 2752  , 'CRDS_CTX', 'R
-0002c850: 5f44 4953 544f 5227 2c20 2752 5f50 484f  _DISTOR', 'R_PHO
-0002c860: 544f 4d27 2c20 2752 5f46 4c41 5427 5d3a  TOM', 'R_FLAT']:
-0002c870: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002c880: 6b20 696e 2066 6c74 5b30 5d2e 6865 6164  k in flt[0].head
-0002c890: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-0002c8a0: 2020 2020 6b65 7973 5b6b 5d20 3d20 666c      keys[k] = fl
-0002c8b0: 745b 305d 2e68 6561 6465 725b 6b5d 0a20  t[0].header[k]. 
-0002c8c0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002c8d0: 6966 2066 6c74 5b30 5d2e 6865 6164 6572  if flt[0].header
-0002c8e0: 5b27 5445 4c45 5343 4f50 275d 2069 6e20  ['TELESCOP'] in 
-0002c8f0: 5b27 4a57 5354 275d 3a0a 2020 2020 2020  ['JWST']:.      
-0002c900: 2020 2020 2020 6269 7473 203d 2034 0a20        bits = 4. 
-0002c910: 2020 2020 2020 2020 2020 2069 6e63 6c75             inclu
-0002c920: 6465 5f73 6174 7572 6174 6564 203d 2046  de_saturated = F
-0002c930: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-0002c940: 200a 2020 2020 2020 2020 2020 2020 2362   .            #b
-0002c950: 7064 6174 6120 3d20 300a 2020 2020 2020  pdata = 0.      
-0002c960: 2020 2020 2020 5f69 6e73 7420 3d20 666c        _inst = fl
-0002c970: 745b 305d 2e68 6561 6465 725b 2749 4e53  t[0].header['INS
-0002c980: 5452 554d 4527 5d0a 2020 2020 2020 2020  TRUME'].        
-0002c990: 2020 2020 6966 2028 6578 7472 615f 7766      if (extra_wf
-0002c9a0: 6333 6972 5f62 6164 7069 7829 2026 2028  c3ir_badpix) & (
-0002c9b0: 5f69 6e73 7420 696e 205b 274e 4952 4341  _inst in ['NIRCA
-0002c9c0: 4d27 5d29 3a0a 2020 2020 2020 2020 2020  M']):.          
-0002c9d0: 2020 2020 2020 5f64 6574 203d 2066 6c74        _det = flt
-0002c9e0: 5b30 5d2e 6865 6164 6572 5b27 4445 5445  [0].header['DETE
-0002c9f0: 4354 4f52 275d 0a20 2020 2020 2020 2020  CTOR'].         
-0002ca00: 2020 2020 2020 2062 7066 696c 6573 203d         bpfiles =
-0002ca10: 205b 6f73 2e70 6174 682e 6a6f 696e 286f   [os.path.join(o
-0002ca20: 732e 7061 7468 2e64 6972 6e61 6d65 285f  s.path.dirname(_
-0002ca30: 5f66 696c 655f 5f29 2c20 0a20 2020 2020  _file__), .     
-0002ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ca50: 2020 2020 2020 6627 6461 7461 2f6e 7263        f'data/nrc
-0002ca60: 5f62 6164 7069 785f 3233 3031 3230 5f7b  _badpix_230120_{
-0002ca70: 5f64 6574 7d2e 6669 7473 2e67 7a27 295d  _det}.fits.gz')]
-0002ca80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ca90: 2062 7066 696c 6573 202b 3d20 5b6f 732e   bpfiles += [os.
-0002caa0: 7061 7468 2e6a 6f69 6e28 6f73 2e70 6174  path.join(os.pat
-0002cab0: 682e 6469 726e 616d 6528 5f5f 6669 6c65  h.dirname(__file
-0002cac0: 5f5f 292c 200a 2020 2020 2020 2020 2020  __), .          
-0002cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cae0: 2066 2764 6174 612f 6e72 635f 6c6f 7770   f'data/nrc_lowp
-0002caf0: 6978 5f30 3931 365f 7b5f 6465 747d 2e66  ix_0916_{_det}.f
-0002cb00: 6974 732e 677a 2729 5d0a 2020 2020 2020  its.gz')].      
-0002cb10: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0002cb20: 2020 2020 2020 2020 2020 2066 6f72 2062             for b
-0002cb30: 7066 696c 6520 696e 2062 7066 696c 6573  pfile in bpfiles
-0002cb40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002cb50: 2020 2020 2020 6966 206f 732e 7061 7468        if os.path
-0002cb60: 2e65 7869 7374 7328 6270 6669 6c65 293a  .exists(bpfile):
-0002cb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cb80: 2020 2020 2020 2020 2062 7064 6174 6120           bpdata 
-0002cb90: 3d20 7079 6669 7473 2e6f 7065 6e28 6270  = pyfits.open(bp
-0002cba0: 6669 6c65 295b 305d 2e64 6174 610a 2020  file)[0].data.  
-0002cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cbc0: 2020 2020 2020 6270 6461 7461 203d 206e        bpdata = n
-0002cbd0: 642e 6269 6e61 7279 5f64 696c 6174 696f  d.binary_dilatio
-0002cbe0: 6e28 6270 6461 7461 203e 2030 292a 3130  n(bpdata > 0)*10
-0002cbf0: 3234 0a20 2020 2020 2020 2020 2020 2020  24.             
-0002cc00: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0002cc10: 2066 2755 7365 2065 7874 7261 2062 6164   f'Use extra bad
-0002cc20: 7069 7820 696e 207b 6270 6669 6c65 7d27  pix in {bpfile}'
-0002cc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cc40: 2020 2020 2020 2020 206c 6f67 5f63 6f6d           log_com
-0002cc50: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
-0002cc60: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
-0002cc70: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-0002cc80: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0002cc90: 6b0a 2020 2020 2020 2020 2020 2020 656c  k.            el
-0002cca0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002ccb0: 2020 2020 6270 6461 7461 203d 206e 702e      bpdata = np.
-0002ccc0: 7a65 726f 7328 666c 745b 2753 4349 275d  zeros(flt['SCI']
-0002ccd0: 2e64 6174 612e 7368 6170 652c 2064 7479  .data.shape, dty
-0002cce0: 7065 3d69 6e74 290a 2020 2020 2020 2020  pe=int).        
-0002ccf0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0002cd00: 2020 2020 2023 204e 4952 4953 5320 6768       # NIRISS gh
-0002cd10: 6f73 7420 6d61 736b 0a20 2020 2020 2020  ost mask.       
-0002cd20: 2020 2020 2069 6620 285f 696e 7374 2069       if (_inst i
-0002cd30: 6e20 5b27 4e49 5249 5353 275d 2920 2620  n ['NIRISS']) & 
-0002cd40: 286e 6972 6973 735f 6768 6f73 745f 6b77  (niriss_ghost_kw
-0002cd50: 6172 6773 2069 7320 6e6f 7420 4e6f 6e65  args is not None
-0002cd60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002cd70: 2020 2069 6620 2776 6572 626f 7365 2720     if 'verbose' 
-0002cd80: 6e6f 7420 696e 206e 6972 6973 735f 6768  not in niriss_gh
-0002cd90: 6f73 745f 6b77 6172 6773 3a0a 2020 2020  ost_kwargs:.    
-0002cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cdb0: 6e69 7269 7373 5f67 686f 7374 5f6b 7761  niriss_ghost_kwa
-0002cdc0: 7267 735b 2776 6572 626f 7365 275d 203d  rgs['verbose'] =
-0002cdd0: 2076 6572 626f 7365 0a20 2020 2020 2020   verbose.       
-0002cde0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0002cdf0: 2020 2020 2020 2020 2020 5f67 686f 7374            _ghost
-0002ce00: 203d 206e 6972 6973 735f 6768 6f73 745f   = niriss_ghost_
-0002ce10: 6d61 736b 2866 6c74 2c20 2a2a 6e69 7269  mask(flt, **niri
-0002ce20: 7373 5f67 686f 7374 5f6b 7761 7267 7329  ss_ghost_kwargs)
-0002ce30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ce40: 2062 7064 6174 6120 7c3d 205f 6768 6f73   bpdata |= _ghos
-0002ce50: 742a 3130 3234 0a20 2020 2020 2020 2020  t*1024.         
-0002ce60: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0002ce70: 2320 4e65 6761 7469 7665 0a20 2020 2020  # Negative.     
-0002ce80: 2020 2020 2020 2069 6620 274d 4452 495a         if 'MDRIZ
-0002ce90: 534b 5927 2069 6e20 666c 745b 2753 4349  SKY' in flt['SCI
-0002cea0: 275d 2e68 6561 6465 723a 0a20 2020 2020  '].header:.     
-0002ceb0: 2020 2020 2020 2020 2020 205f 6c6f 7720             _low 
-0002cec0: 3d20 2828 666c 745b 2753 4349 275d 2e64  = ((flt['SCI'].d
-0002ced0: 6174 6120 2d20 666c 745b 2753 4349 275d  ata - flt['SCI']
-0002cee0: 2e68 6561 6465 725b 274d 4452 495a 534b  .header['MDRIZSK
-0002cef0: 5927 5d29 203c 200a 2020 2020 2020 2020  Y']) < .        
-0002cf00: 2020 2020 2020 2020 2020 2020 2020 2d35                -5
-0002cf10: 2a66 6c74 5b27 4552 5227 5d2e 6461 7461  *flt['ERR'].data
-0002cf20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002cf30: 2020 6d73 6720 3d20 6627 4578 7472 6120    msg = f'Extra 
-0002cf40: 2d35 2073 6967 6d61 206c 6f77 2070 6978  -5 sigma low pix
-0002cf50: 656c 733a 204e 3d20 7b5f 6c6f 772e 7375  els: N= {_low.su
-0002cf60: 6d28 297d 2027 0a20 2020 2020 2020 2020  m()} '.         
-0002cf70: 2020 2020 2020 206d 7367 202b 3d20 6627         msg += f'
-0002cf80: 2028 207b 5f6c 6f77 2e73 756d 2829 2f5f   ( {_low.sum()/_
-0002cf90: 6c6f 772e 7369 7a65 2a31 3030 3a2e 317d  low.size*100:.1}
-0002cfa0: 2025 2927 0a20 2020 2020 2020 2020 2020   %)'.           
-0002cfb0: 2020 2020 206c 6f67 5f63 6f6d 6d65 6e74       log_comment
-0002cfc0: 284c 4f47 4649 4c45 2c20 6d73 672c 2076  (LOGFILE, msg, v
-0002cfd0: 6572 626f 7365 3d76 6572 626f 7365 290a  erbose=verbose).
-0002cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cff0: 6270 6461 7461 207c 3d20 5f6c 6f77 2a31  bpdata |= _low*1
-0002d000: 3032 340a 2020 2020 2020 2020 2020 2020  024.            
-0002d010: 0a20 2020 2020 2020 2065 6c69 6620 666c  .        elif fl
-0002d020: 745b 305d 2e68 6561 6465 725b 2744 4554  t[0].header['DET
-0002d030: 4543 544f 5227 5d20 3d3d 2027 4952 273a  ECTOR'] == 'IR':
-0002d040: 0a20 2020 2020 2020 2020 2020 2062 6974  .            bit
-0002d050: 7320 3d20 3537 360a 2020 2020 2020 2020  s = 576.        
-0002d060: 2020 2020 6966 2065 7874 7261 5f77 6663      if extra_wfc
-0002d070: 3369 725f 6261 6470 6978 3a0a 2020 2020  3ir_badpix:.    
-0002d080: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0002d090: 6920 3d3d 2069 6e64 6963 6573 5b30 5d29  i == indices[0])
-0002d0a0: 207c 2028 6e6f 7420 6861 7361 7474 7228   | (not hasattr(
-0002d0b0: 6270 6461 7461 2c20 2773 6861 7065 2729  bpdata, 'shape')
-0002d0c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002d0d0: 2020 2020 2020 2062 7066 696c 6520 3d20         bpfile = 
-0002d0e0: 6f73 2e70 6174 682e 6a6f 696e 286f 732e  os.path.join(os.
-0002d0f0: 7061 7468 2e64 6972 6e61 6d65 285f 5f66  path.dirname(__f
-0002d100: 696c 655f 5f29 2c20 0a20 2020 2020 2020  ile__), .       
-0002d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d120: 2020 2020 2020 2020 2764 6174 612f 7766          'data/wf
-0002d130: 6333 6972 5f62 6164 7069 785f 7370 6172  c3ir_badpix_spar
-0002d140: 7332 3030 5f32 322e 3033 2e33 312e 6669  s200_22.03.31.fi
-0002d150: 7473 2e67 7a27 290a 2020 2020 2020 2020  ts.gz').        
-0002d160: 2020 2020 2020 2020 2020 2020 6270 6461              bpda
-0002d170: 7461 203d 2070 7966 6974 732e 6f70 656e  ta = pyfits.open
-0002d180: 2862 7066 696c 6529 5b30 5d2e 6461 7461  (bpfile)[0].data
-0002d190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d1a0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0002d1b0: 2020 2020 2020 6d73 6720 3d20 6627 5573        msg = f'Us
-0002d1c0: 6520 6578 7472 6120 6261 6470 6978 2069  e extra badpix i
-0002d1d0: 6e20 7b62 7066 696c 657d 270a 2020 2020  n {bpfile}'.    
-0002d1e0: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
-0002d1f0: 636f 6d6d 656e 7428 4c4f 4746 494c 452c  comment(LOGFILE,
-0002d200: 206d 7367 2c20 7665 7262 6f73 653d 7665   msg, verbose=ve
-0002d210: 7262 6f73 6529 0a20 2020 2020 2020 2065  rbose).        e
-0002d220: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002d230: 2062 6974 7320 3d20 3634 2b33 320a 2020   bits = 64+32.  
-0002d240: 2020 2020 2020 2020 2020 6270 6461 7461            bpdata
-0002d250: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-0002d260: 200a 2020 2020 2020 2020 6966 2069 6e63   .        if inc
-0002d270: 6c75 6465 5f73 6174 7572 6174 6564 3a0a  lude_saturated:.
-0002d280: 2020 2020 2020 2020 2020 2020 6269 7473              bits
-0002d290: 207c 3d20 3235 360a 0a20 2020 2020 2020   |= 256..       
-0002d2a0: 2069 6620 6b65 6570 5f62 6974 7320 6973   if keep_bits is
-0002d2b0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0002d2c0: 2020 2020 2020 2062 6974 7320 7c3d 206b         bits |= k
-0002d2d0: 6565 705f 6269 7473 0a20 2020 2020 2020  eep_bits.       
-0002d2e0: 200a 2020 2020 2020 2020 6966 2073 6361   .        if sca
-0002d2f0: 6c65 5f70 686f 746f 6d3a 0a20 2020 2020  le_photom:.     
-0002d300: 2020 2020 2020 205f 6b65 792c 205f 7363         _key, _sc
-0002d310: 616c 655f 7068 6f74 6f6d 203d 2067 6574  ale_photom = get
-0002d320: 5f70 686f 746f 6d5f 7363 616c 6528 666c  _photom_scale(fl
-0002d330: 745b 305d 2e68 6561 6465 722c 200a 2020  t[0].header, .  
-0002d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002abd0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002abe0: 5f72 6566 6c65 6374 6564 5b79 6769 2c20  _reflected[ygi, 
+0002abf0: 7867 695d 203d 2069 6d5b 2753 4349 275d  xgi] = im['SCI']
+0002ac00: 2e64 6174 615b 7970 692c 2078 7069 5d20  .data[ypi, xpi] 
+0002ac10: 2d20 626b 670a 0a20 2020 2067 686f 7374  - bkg..    ghost
+0002ac20: 5f6d 6173 6b20 3d20 5f72 6566 6c65 6374  _mask = _reflect
+0002ac30: 6564 2a66 696e 616c 5f74 6872 6573 6820  ed*final_thresh 
+0002ac40: 3e20 6669 6e61 6c5f 7369 676d 612a 696d  > final_sigma*im
+0002ac50: 5b27 4552 5227 5d2e 6461 7461 0a20 2020  ['ERR'].data.   
+0002ac60: 200a 2020 2020 6966 2065 726f 7369 6f6e   .    if erosion
+0002ac70: 7320 3e20 303a 0a20 2020 2020 2020 2067  s > 0:.        g
+0002ac80: 686f 7374 5f6d 6173 6b20 3d20 6e64 2e62  host_mask = nd.b
+0002ac90: 696e 6172 795f 6572 6f73 696f 6e28 6768  inary_erosion(gh
+0002aca0: 6f73 745f 6d61 736b 2c20 6974 6572 6174  ost_mask, iterat
+0002acb0: 696f 6e73 3d65 726f 7369 6f6e 7329 0a20  ions=erosions). 
+0002acc0: 2020 2020 2020 200a 2020 2020 6768 6f73         .    ghos
+0002acd0: 745f 6d61 736b 203d 206e 642e 6269 6e61  t_mask = nd.bina
+0002ace0: 7279 5f64 696c 6174 696f 6e28 6768 6f73  ry_dilation(ghos
+0002acf0: 745f 6d61 736b 2c20 6974 6572 6174 696f  t_mask, iteratio
+0002ad00: 6e73 3d64 696c 6174 696f 6e73 290a 2020  ns=dilations).  
+0002ad10: 2020 0a20 2020 2069 6d5b 305d 2e68 6561    .    im[0].hea
+0002ad20: 6465 725b 2747 484f 5354 4d53 4b27 5d20  der['GHOSTMSK'] 
+0002ad30: 3d20 5472 7565 2c20 274e 4952 4953 5320  = True, 'NIRISS 
+0002ad40: 6768 6f73 7420 6d61 736b 2061 7070 6c69  ghost mask appli
+0002ad50: 6564 270a 2020 2020 696d 5b30 5d2e 6865  ed'.    im[0].he
+0002ad60: 6164 6572 5b27 4748 4f53 544e 5058 275d  ader['GHOSTNPX']
+0002ad70: 203d 2067 686f 7374 5f6d 6173 6b2e 7375   = ghost_mask.su
+0002ad80: 6d28 292c 2027 5069 7865 6c73 2069 6e20  m(), 'Pixels in 
+0002ad90: 4e49 5249 5353 2067 686f 7374 206d 6173  NIRISS ghost mas
+0002ada0: 6b27 0a20 2020 200a 2020 2020 6d73 6720  k'.    .    msg 
+0002adb0: 3d20 274e 4952 4953 5320 6768 6f73 7420  = 'NIRISS ghost 
+0002adc0: 6d61 736b 207b 307d 204e 7069 783a 207b  mask {0} Npix: {
+0002add0: 317d 5c6e 272e 666f 726d 6174 2869 6d5b  1}\n'.format(im[
+0002ade0: 305d 2e68 6561 6465 725b 2750 5550 494c  0].header['PUPIL
+0002adf0: 275d 2c20 0a20 2020 2020 2020 2020 2020  '], .           
+0002ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ae20: 2020 2020 2020 2020 2067 686f 7374 5f6d           ghost_m
+0002ae30: 6173 6b2e 7375 6d28 2929 0a20 2020 206c  ask.sum()).    l
+0002ae40: 6f67 5f63 6f6d 6d65 6e74 284c 4f47 4649  og_comment(LOGFI
+0002ae50: 4c45 2c20 6d73 672c 2076 6572 626f 7365  LE, msg, verbose
+0002ae60: 3d76 6572 626f 7365 290a 2020 2020 0a20  =verbose).    . 
+0002ae70: 2020 2072 6574 7572 6e20 6768 6f73 745f     return ghost_
+0002ae80: 6d61 736b 0a0a 0a64 6566 2067 6574 5f70  mask...def get_p
+0002ae90: 686f 746f 6d5f 7363 616c 6528 6865 6164  hotom_scale(head
+0002aea0: 6572 2c20 7665 7262 6f73 653d 5472 7565  er, verbose=True
+0002aeb0: 293a 0a20 2020 2022 2222 0a20 2020 2047  ):.    """.    G
+0002aec0: 6574 2074 6162 756c 6174 6564 2073 6361  et tabulated sca
+0002aed0: 6c65 2066 6163 746f 720a 2020 2020 0a20  le factor.    . 
+0002aee0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+0002aef0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+0002af00: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
+0002af10: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
+0002af20: 6572 600a 2020 2020 2020 2020 496d 6167  er`.        Imag
+0002af30: 6520 6865 6164 6572 0a20 2020 200a 2020  e header.    .  
+0002af40: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0002af50: 2d2d 2d2d 2d0a 2020 2020 6b65 7920 3a20  -----.    key : 
+0002af60: 7374 720a 2020 2020 2020 2020 4465 7465  str.        Dete
+0002af70: 6374 6f72 202b 2066 696c 7465 7220 6b65  ctor + filter ke
+0002af80: 790a 2020 2020 0a20 2020 2073 6361 6c65  y.    .    scale
+0002af90: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
+0002afa0: 2053 6361 6c65 2076 616c 7565 2e20 2049   Scale value.  I
+0002afb0: 6620 606b 6579 6020 6e6f 7420 666f 756e  f `key` not foun
+0002afc0: 6420 696e 2074 6865 2060 6064 6174 612f  d in the ``data/
+0002afd0: 7068 6f74 6f6d 5f63 6f72 7265 6374 696f  photom_correctio
+0002afe0: 6e2e 796d 6c60 600a 2020 2020 2020 2020  n.yml``.        
+0002aff0: 7461 626c 6520 6f72 2069 6620 7468 6520  table or if the 
+0002b000: 4354 5820 6973 206e 6577 6572 2074 6861  CTX is newer tha
+0002b010: 6e20 7468 6174 2069 6e64 6963 6174 6564  n that indicated
+0002b020: 2069 6e20 7468 6520 636f 7272 6563 7469   in the correcti
+0002b030: 6f6e 0a20 2020 2020 2020 2074 6162 6c65  on.        table
+0002b040: 2074 6865 6e20 7265 7475 726e 2031 2e30   then return 1.0
+0002b050: 2e0a 2020 2020 2020 2020 0a20 2020 2022  ..        .    "
+0002b060: 2222 0a20 2020 2069 6d70 6f72 7420 7961  "".    import ya
+0002b070: 6d6c 0a20 2020 2069 6620 2754 454c 4553  ml.    if 'TELES
+0002b080: 434f 5027 2069 6e20 6865 6164 6572 3a0a  COP' in header:.
+0002b090: 2020 2020 2020 2020 6966 2068 6561 6465          if heade
+0002b0a0: 725b 2754 454c 4553 434f 5027 5d20 6e6f  r['TELESCOP'] no
+0002b0b0: 7420 696e 205b 274a 5753 5427 5d3a 0a20  t in ['JWST']:. 
+0002b0c0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+0002b0d0: 2066 2267 6574 5f70 686f 746f 6d5f 7363   f"get_photom_sc
+0002b0e0: 616c 653a 2054 454c 4553 434f 503d 7b68  ale: TELESCOP={h
+0002b0f0: 6561 6465 725b 2754 454c 4553 434f 5027  eader['TELESCOP'
+0002b100: 5d7d 2069 7320 6e6f 7420 274a 5753 5427  ]} is not 'JWST'
+0002b110: 220a 2020 2020 2020 2020 2020 2020 6c6f  ".            lo
+0002b120: 675f 636f 6d6d 656e 7428 4c4f 4746 494c  g_comment(LOGFIL
+0002b130: 452c 206d 7367 2c20 7665 7262 6f73 653d  E, msg, verbose=
+0002b140: 7665 7262 6f73 6529 0a20 2020 2020 2020  verbose).       
+0002b150: 2020 2020 2072 6574 7572 6e20 6865 6164       return head
+0002b160: 6572 5b27 5445 4c45 5343 4f50 275d 2c20  er['TELESCOP'], 
+0002b170: 312e 300a 2020 2020 656c 7365 3a0a 2020  1.0.    else:.  
+0002b180: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0002b190: 652c 2031 2e30 0a20 2020 2020 2020 200a  e, 1.0.        .
+0002b1a0: 2020 2020 636f 7272 5f66 696c 6520 3d20      corr_file = 
+0002b1b0: 6f73 2e70 6174 682e 6a6f 696e 286f 732e  os.path.join(os.
+0002b1c0: 7061 7468 2e64 6972 6e61 6d65 285f 5f66  path.dirname(__f
+0002b1d0: 696c 655f 5f29 2c20 0a20 2020 2020 2020  ile__), .       
+0002b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1f0: 2020 2020 2020 2764 6174 612f 7068 6f74        'data/phot
+0002b200: 6f6d 5f63 6f72 7265 6374 696f 6e2e 796d  om_correction.ym
+0002b210: 6c27 290a 2020 2020 0a20 2020 2069 6620  l').    .    if 
+0002b220: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
+0002b230: 7473 2863 6f72 725f 6669 6c65 293a 0a20  ts(corr_file):. 
+0002b240: 2020 2020 2020 206d 7367 203d 2066 277b         msg = f'{
+0002b250: 636f 7272 5f66 696c 657d 206e 6f74 2066  corr_file} not f
+0002b260: 6f75 6e64 2e27 0a20 2020 2020 2020 206c  ound.'.        l
+0002b270: 6f67 5f63 6f6d 6d65 6e74 284c 4f47 4649  og_comment(LOGFI
+0002b280: 4c45 2c20 6d73 672c 2076 6572 626f 7365  LE, msg, verbose
+0002b290: 3d76 6572 626f 7365 290a 2020 2020 2020  =verbose).      
+0002b2a0: 2020 7265 7475 726e 204e 6f6e 652c 2031    return None, 1
+0002b2b0: 0a20 2020 200a 2020 2020 7769 7468 206f  .    .    with o
+0002b2c0: 7065 6e28 636f 7272 5f66 696c 6529 2061  pen(corr_file) a
+0002b2d0: 7320 6670 3a0a 2020 2020 2020 2020 636f  s fp:.        co
+0002b2e0: 7272 203d 2079 616d 6c2e 6c6f 6164 2866  rr = yaml.load(f
+0002b2f0: 702c 204c 6f61 6465 723d 7961 6d6c 2e53  p, Loader=yaml.S
+0002b300: 6166 654c 6f61 6465 7229 0a20 2020 2020  afeLoader).     
+0002b310: 2020 200a 2020 2020 6966 2027 4352 4453     .    if 'CRDS
+0002b320: 5f43 5458 2720 696e 2068 6561 6465 723a  _CTX' in header:
+0002b330: 0a20 2020 2020 2020 2069 6620 6865 6164  .        if head
+0002b340: 6572 5b27 4352 4453 5f43 5458 275d 203e  er['CRDS_CTX'] >
+0002b350: 2063 6f72 725b 2743 5244 535f 4354 585f   corr['CRDS_CTX_
+0002b360: 4d41 5827 5d3a 0a20 2020 2020 2020 2020  MAX']:.         
+0002b370: 2020 206d 7367 203d 2066 2267 6574 5f70     msg = f"get_p
+0002b380: 686f 746f 6d5f 7363 616c 6520 7b63 6f72  hotom_scale {cor
+0002b390: 725f 6669 6c65 7d3a 207b 6865 6164 6572  r_file}: {header
+0002b3a0: 5b27 4352 4453 5f43 5458 275d 7d20 3e20  ['CRDS_CTX']} > 
+0002b3b0: 7b63 6f72 725b 2743 5244 535f 4354 585f  {corr['CRDS_CTX_
+0002b3c0: 4d41 5827 5d7d 220a 2020 2020 2020 2020  MAX']}".        
+0002b3d0: 2020 2020 6c6f 675f 636f 6d6d 656e 7428      log_comment(
+0002b3e0: 4c4f 4746 494c 452c 206d 7367 2c20 7665  LOGFILE, msg, ve
+0002b3f0: 7262 6f73 653d 7665 7262 6f73 6529 0a20  rbose=verbose). 
+0002b400: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002b410: 6e20 6865 6164 6572 5b27 4352 4453 5f43  n header['CRDS_C
+0002b420: 5458 275d 2c20 312e 300a 2020 2020 2020  TX'], 1.0.      
+0002b430: 2020 2020 2020 0a20 2020 206b 6579 203d        .    key =
+0002b440: 2027 7b30 7d2d 7b31 7d27 2e66 6f72 6d61   '{0}-{1}'.forma
+0002b450: 7428 6865 6164 6572 5b27 4445 5445 4354  t(header['DETECT
+0002b460: 4f52 275d 2c20 6865 6164 6572 5b27 4649  OR'], header['FI
+0002b470: 4c54 4552 275d 290a 2020 2020 6966 2027  LTER']).    if '
+0002b480: 5055 5049 4c27 2069 6e20 6865 6164 6572  PUPIL' in header
+0002b490: 3a0a 2020 2020 2020 2020 6b65 7920 2b3d  :.        key +=
+0002b4a0: 2027 2d7b 307d 272e 666f 726d 6174 2868   '-{0}'.format(h
+0002b4b0: 6561 6465 725b 2750 5550 494c 275d 290a  eader['PUPIL']).
+0002b4c0: 2020 2020 0a20 2020 2069 6620 6b65 7920      .    if key 
+0002b4d0: 6e6f 7420 696e 2063 6f72 723a 0a20 2020  not in corr:.   
+0002b4e0: 2020 2020 206d 7367 203d 2066 2267 6574       msg = f"get
+0002b4f0: 5f70 686f 746f 6d5f 7363 616c 6520 7b63  _photom_scale {c
+0002b500: 6f72 725f 6669 6c65 7d3a 207b 6b65 797d  orr_file}: {key}
+0002b510: 206e 6f74 2066 6f75 6e64 220a 2020 2020   not found".    
+0002b520: 2020 2020 6c6f 675f 636f 6d6d 656e 7428      log_comment(
+0002b530: 4c4f 4746 494c 452c 206d 7367 2c20 7665  LOGFILE, msg, ve
+0002b540: 7262 6f73 653d 7665 7262 6f73 6529 0a20  rbose=verbose). 
+0002b550: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002b560: 7265 7475 726e 206b 6579 2c20 312e 300a  return key, 1.0.
+0002b570: 2020 2020 0a20 2020 2065 6c73 653a 0a20      .    else:. 
+0002b580: 2020 2020 2020 206d 7367 203d 2066 2267         msg = f"g
+0002b590: 6574 5f70 686f 746f 6d5f 7363 616c 6520  et_photom_scale 
+0002b5a0: 7b63 6f72 725f 6669 6c65 7d3a 2053 6361  {corr_file}: Sca
+0002b5b0: 6c65 207b 6b65 797d 2062 7920 7b31 2e2f  le {key} by {1./
+0002b5c0: 636f 7272 5b6b 6579 5d3a 2e33 667d 220a  corr[key]:.3f}".
+0002b5d0: 2020 2020 2020 2020 6c6f 675f 636f 6d6d          log_comm
+0002b5e0: 656e 7428 4c4f 4746 494c 452c 206d 7367  ent(LOGFILE, msg
+0002b5f0: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
+0002b600: 6529 0a20 2020 2020 2020 200a 2020 2020  e).        .    
+0002b610: 2020 2020 7265 7475 726e 206b 6579 2c20      return key, 
+0002b620: 312e 2f63 6f72 725b 6b65 795d 0a0a 0a64  1./corr[key]...d
+0002b630: 6566 2064 7269 7a7a 6c65 5f66 726f 6d5f  ef drizzle_from_
+0002b640: 7669 7369 7428 7669 7369 742c 206f 7574  visit(visit, out
+0002b650: 7075 743d 4e6f 6e65 2c20 7069 7866 7261  put=None, pixfra
+0002b660: 633d 312e 2c20 6b65 726e 656c 3d27 706f  c=1., kernel='po
+0002b670: 696e 7427 2c0a 2020 2020 2020 2020 2020  int',.          
+0002b680: 2020 2020 2020 2020 2020 2020 2063 6c65               cle
+0002b690: 616e 3d54 7275 652c 2069 6e63 6c75 6465  an=True, include
+0002b6a0: 5f73 6174 7572 6174 6564 3d54 7275 652c  _saturated=True,
+0002b6b0: 206b 6565 705f 6269 7473 3d4e 6f6e 652c   keep_bits=None,
+0002b6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b6d0: 2020 2020 2020 2020 6472 7972 756e 3d46          dryrun=F
+0002b6e0: 616c 7365 2c20 736b 6970 3d4e 6f6e 652c  alse, skip=None,
+0002b6f0: 2065 7874 7261 5f77 6663 3369 725f 6261   extra_wfc3ir_ba
+0002b700: 6470 6978 3d54 7275 652c 0a20 2020 2020  dpix=True,.     
+0002b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b720: 2020 7665 7262 6f73 653d 5472 7565 2c0a    verbose=True,.
+0002b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b740: 2020 2020 2020 2073 6361 6c65 5f70 686f         scale_pho
+0002b750: 746f 6d3d 5472 7565 2c0a 2020 2020 2020  tom=True,.      
+0002b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b770: 2063 616c 635f 7763 736d 6170 3d46 616c   calc_wcsmap=Fal
+0002b780: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+0002b790: 2020 2020 2020 2020 2020 206e 6972 6973             niris
+0002b7a0: 735f 6768 6f73 745f 6b77 6172 6773 3d7b  s_ghost_kwargs={
+0002b7b0: 7d29 3a0a 2020 2020 2222 220a 2020 2020  }):.    """.    
+0002b7c0: 4d61 6b65 2064 7269 7a7a 6c65 206d 6f73  Make drizzle mos
+0002b7d0: 6169 6320 6672 6f6d 2065 7870 6f73 7572  aic from exposur
+0002b7e0: 6573 2069 6e20 6120 7669 7369 7420 6469  es in a visit di
+0002b7f0: 6374 696f 6e61 7279 0a20 2020 200a 2020  ctionary.    .  
+0002b800: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0002b810: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0002b820: 7669 7369 7420 3a20 6469 6374 0a20 2020  visit : dict.   
+0002b830: 2020 2020 2056 6973 6974 2064 6963 7469       Visit dicti
+0002b840: 6f6e 6172 7920 7769 7468 2027 7072 6f64  onary with 'prod
+0002b850: 7563 7427 2061 6e64 2027 6669 6c65 7327  uct' and 'files'
+0002b860: 206b 6579 730a 2020 2020 0a20 2020 206f   keys.    .    o
+0002b870: 7574 7075 7420 3a20 607e 6173 7472 6f70  utput : `~astrop
+0002b880: 792e 7763 732e 5743 5360 2c20 607e 6173  y.wcs.WCS`, `~as
+0002b890: 7472 6f70 792e 696f 2e66 6974 732e 4865  tropy.io.fits.He
+0002b8a0: 6164 6572 602c 2060 7e61 7374 726f 7079  ader`, `~astropy
+0002b8b0: 2e69 6f2e 496d 6167 6548 4455 600a 2020  .io.ImageHDU`.  
+0002b8c0: 2020 2020 2020 4f75 7470 7574 2066 7261        Output fra
+0002b8d0: 6d65 2064 6566 696e 6974 696f 6e2e 2020  me definition.  
+0002b8e0: 4361 6e20 6265 2061 2057 4353 206f 626a  Can be a WCS obj
+0002b8f0: 6563 742c 2068 6561 6465 722c 206f 7220  ect, header, or 
+0002b900: 4649 5453 2048 4455 2e20 2049 660a 2020  FITS HDU.  If.  
+0002b910: 2020 2020 2020 4e6f 6e65 2c20 7468 656e        None, then
+0002b920: 2067 656e 6572 6174 6573 2061 2057 4353   generates a WCS
+0002b930: 2077 6974 6820 6067 7269 7a6c 692e 7574   with `grizli.ut
+0002b940: 696c 732e 6d61 6b65 5f6d 6178 696d 616c  ils.make_maximal
+0002b950: 5f77 6373 600a 2020 2020 0a20 2020 2070  _wcs`.    .    p
+0002b960: 6978 6672 6163 203a 2066 6c6f 6174 0a20  ixfrac : float. 
+0002b970: 2020 2020 2020 2044 7269 7a7a 6c65 2060         Drizzle `
+0002b980: 7069 7866 7261 6360 0a20 2020 200a 2020  pixfrac`.    .  
+0002b990: 2020 6b65 726e 656c 203a 2073 7472 0a20    kernel : str. 
+0002b9a0: 2020 2020 2020 2044 7269 7a7a 6c65 2060         Drizzle `
+0002b9b0: 6b65 726e 656c 6020 2865 2e67 2e2c 2027  kernel` (e.g., '
+0002b9c0: 706f 696e 7427 2c20 2773 7175 6172 6527  point', 'square'
+0002b9d0: 290a 2020 2020 0a20 2020 2063 6c65 616e  ).    .    clean
+0002b9e0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+0002b9f0: 5265 6d6f 7665 2065 7870 6f73 7572 6520  Remove exposure 
+0002ba00: 6669 6c65 7320 6166 7465 7220 6164 6469  files after addi
+0002ba10: 6e67 2074 6f20 7468 6520 6d6f 7361 6963  ng to the mosaic
+0002ba20: 0a20 2020 200a 2020 2020 696e 636c 7564  .    .    includ
+0002ba30: 655f 7361 7475 7261 7465 6420 3a20 626f  e_saturated : bo
+0002ba40: 6f6c 0a20 2020 2020 2020 2049 6e63 6c75  ol.        Inclu
+0002ba50: 6465 2070 6978 656c 7320 7769 7468 2073  de pixels with s
+0002ba60: 6174 7572 6174 6564 2044 5120 666c 6167  aturated DQ flag
+0002ba70: 0a20 2020 200a 2020 2020 6b65 6570 5f62  .    .    keep_b
+0002ba80: 6974 7320 3a20 696e 742c 204e 6f6e 650a  its : int, None.
+0002ba90: 2020 2020 2020 2020 4578 7472 6120 4451          Extra DQ
+0002baa0: 2062 6974 7320 746f 206b 6565 7020 6173   bits to keep as
+0002bab0: 2076 616c 6964 0a20 2020 200a 2020 2020   valid.    .    
+0002bac0: 6472 7972 756e 203a 2062 6f6f 6c0a 2020  dryrun : bool.  
+0002bad0: 2020 2020 2020 4966 2054 7275 652c 2064        If True, d
+0002bae0: 6f6e 2774 2061 6374 7561 6c6c 7920 7072  on't actually pr
+0002baf0: 6f64 7563 6520 7468 6520 6f75 7470 7574  oduce the output
+0002bb00: 0a20 2020 200a 2020 2020 736b 6970 203a  .    .    skip :
+0002bb10: 2069 6e74 0a20 2020 2020 2020 2053 6c69   int.        Sli
+0002bb20: 6365 2073 6b69 7020 746f 2064 7269 7a7a  ce skip to drizz
+0002bb30: 6c65 2061 2073 7562 7365 7420 6f66 2065  le a subset of e
+0002bb40: 7870 6f73 7572 6573 0a20 2020 200a 2020  xposures.    .  
+0002bb50: 2020 6578 7472 615f 7766 6333 6972 5f62    extra_wfc3ir_b
+0002bb60: 6164 7069 7820 3a20 626f 6f6c 0a20 2020  adpix : bool.   
+0002bb70: 2020 2020 2041 7070 6c79 2065 7874 7261       Apply extra
+0002bb80: 2057 4643 332f 4952 2062 6164 2070 6978   WFC3/IR bad pix
+0002bb90: 2074 6f20 4451 0a20 2020 200a 2020 2020   to DQ.    .    
+0002bba0: 7665 7262 6f73 6520 3a20 626f 6f6c 0a20  verbose : bool. 
+0002bbb0: 2020 2020 2020 2053 6f6d 6520 7665 7262         Some verb
+0002bbc0: 6f73 6520 6d65 7373 6167 6520 7072 696e  ose message prin
+0002bbd0: 7469 6e67 0a20 2020 200a 2020 2020 7363  ting.    .    sc
+0002bbe0: 616c 655f 7068 6f74 6f6d 203a 2062 6f6f  ale_photom : boo
+0002bbf0: 6c0a 2020 2020 2020 2020 466f 7220 4a57  l.        For JW
+0002bc00: 5354 2c20 6170 706c 7920 7068 6f74 6f6d  ST, apply photom
+0002bc10: 6574 7279 2073 6361 6c65 2063 6f72 7265  etry scale corre
+0002bc20: 6374 696f 6e73 2066 726f 6d20 7468 6520  ctions from the 
+0002bc30: 200a 2020 2020 2020 2020 6067 7269 7a6c   .        `grizl
+0002bc40: 692f 6461 7461 2f70 686f 746f 6d5f 636f  i/data/photom_co
+0002bc50: 7272 6563 7469 6f6e 2e79 6d6c 6020 7461  rrection.yml` ta
+0002bc60: 626c 650a 2020 2020 0a20 2020 206e 6972  ble.    .    nir
+0002bc70: 6973 735f 6768 6f73 745f 6b77 6172 6773  iss_ghost_kwargs
+0002bc80: 203a 2064 6963 740a 2020 2020 2020 2020   : dict.        
+0002bc90: 4b65 7977 6f72 6420 6172 6775 6d65 6e74  Keyword argument
+0002bca0: 7320 666f 7220 607e 6772 697a 6c69 2e75  s for `~grizli.u
+0002bcb0: 7469 6c73 2e6e 6972 6973 735f 6768 6f73  tils.niriss_ghos
+0002bcc0: 745f 6d61 736b 600a 2020 2020 0a20 2020  t_mask`.    .   
+0002bcd0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+0002bce0: 2d2d 2d2d 0a20 2020 206f 7574 7363 6920  ----.    outsci 
+0002bcf0: 3a20 6172 7261 792d 6c69 6b65 0a20 2020  : array-like.   
+0002bd00: 2020 2020 2053 4349 2061 7272 6179 0a20       SCI array. 
+0002bd10: 2020 200a 2020 2020 6f75 7477 6874 203a     .    outwht :
+0002bd20: 2061 7272 6179 2d6c 696b 650a 2020 2020   array-like.    
+0002bd30: 2020 2020 496e 7665 7273 6520 7661 7269      Inverse vari
+0002bd40: 616e 6365 2057 4854 2061 7272 6179 0a20  ance WHT array. 
+0002bd50: 2020 200a 2020 2020 6865 6164 6572 203a     .    header :
+0002bd60: 2060 7e61 7374 726f 7079 2e69 6f2e 6669   `~astropy.io.fi
+0002bd70: 7473 2e48 6561 6465 7260 0a20 2020 2020  ts.Header`.     
+0002bd80: 2020 2049 6d61 6765 2068 6561 6465 720a     Image header.
+0002bd90: 2020 2020 0a20 2020 2066 6c69 7374 203a      .    flist :
+0002bda0: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
+0002bdb0: 7374 206f 6620 6669 6c65 7320 7468 6174  st of files that
+0002bdc0: 2077 6572 6520 6472 697a 7a6c 6564 2074   were drizzled t
+0002bdd0: 6f20 7468 6520 6d6f 7361 6963 0a20 2020  o the mosaic.   
+0002bde0: 2020 2020 200a 2020 2020 7763 735f 7461       .    wcs_ta
+0002bdf0: 6220 3a20 607e 6173 7472 6f70 792e 7461  b : `~astropy.ta
+0002be00: 626c 652e 5461 626c 6560 0a20 2020 2020  ble.Table`.     
+0002be10: 2020 2054 6162 6c65 206f 6620 5743 5320     Table of WCS 
+0002be20: 7061 7261 6d65 7465 7273 206f 6620 696e  parameters of in
+0002be30: 6469 7669 6475 616c 2065 7870 6f73 7572  dividual exposur
+0002be40: 6573 0a20 2020 200a 2020 2020 2222 220a  es.    .    """.
+0002be50: 2020 2020 6672 6f6d 2073 6861 7065 6c79      from shapely
+0002be60: 2e67 656f 6d65 7472 7920 696d 706f 7274  .geometry import
+0002be70: 2050 6f6c 7967 6f6e 0a20 2020 2069 6d70   Polygon.    imp
+0002be80: 6f72 7420 626f 746f 330a 2020 2020 6672  ort boto3.    fr
+0002be90: 6f6d 2062 6f74 6f63 6f72 652e 6578 6365  om botocore.exce
+0002bea0: 7074 696f 6e73 2069 6d70 6f72 7420 436c  ptions import Cl
+0002beb0: 6965 6e74 4572 726f 720a 2020 2020 696d  ientError.    im
+0002bec0: 706f 7274 2073 6369 7079 2e6e 6469 6d61  port scipy.ndima
+0002bed0: 6765 2061 7320 6e64 0a20 2020 2066 726f  ge as nd.    fro
+0002bee0: 6d20 6173 7472 6f70 792e 696f 2e66 6974  m astropy.io.fit
+0002bef0: 7320 696d 706f 7274 2050 7269 6d61 7279  s import Primary
+0002bf00: 4844 552c 2049 6d61 6765 4844 550a 2020  HDU, ImageHDU.  
+0002bf10: 2020 6672 6f6d 202e 7665 7273 696f 6e20    from .version 
+0002bf20: 696d 706f 7274 205f 5f76 6572 7369 6f6e  import __version
+0002bf30: 5f5f 2061 7320 6772 697a 6c69 5f5f 7665  __ as grizli__ve
+0002bf40: 7273 696f 6e0a 2020 2020 0a20 2020 2062  rsion.    .    b
+0002bf50: 7563 6b65 745f 6e61 6d65 203d 204e 6f6e  ucket_name = Non
+0002bf60: 650a 2020 2020 7333 203d 2062 6f74 6f33  e.    s3 = boto3
+0002bf70: 2e72 6573 6f75 7263 6528 2773 3327 290a  .resource('s3').
+0002bf80: 2020 2020 7333 5f63 6c69 656e 7420 3d20      s3_client = 
+0002bf90: 626f 746f 332e 636c 6965 6e74 2827 7333  boto3.client('s3
+0002bfa0: 2729 0a20 2020 200a 2020 2020 0a20 2020  ').    .    .   
+0002bfb0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+0002bfc0: 7574 7075 742c 2070 7977 6373 2e57 4353  utput, pywcs.WCS
+0002bfd0: 293a 0a20 2020 2020 2020 206f 7574 7075  ):.        outpu
+0002bfe0: 7477 6373 203d 206f 7574 7075 740a 2020  twcs = output.  
+0002bff0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0002c000: 6528 6f75 7470 7574 2c20 7079 6669 7473  e(output, pyfits
+0002c010: 2e48 6561 6465 7229 3a0a 2020 2020 2020  .Header):.      
+0002c020: 2020 6f75 7470 7574 7763 7320 3d20 7079    outputwcs = py
+0002c030: 7763 732e 5743 5328 6f75 7470 7574 290a  wcs.WCS(output).
+0002c040: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0002c050: 6e63 6528 6f75 7470 7574 2c20 5072 696d  nce(output, Prim
+0002c060: 6172 7948 4455 2920 7c20 6973 696e 7374  aryHDU) | isinst
+0002c070: 616e 6365 286f 7574 7075 742c 2049 6d61  ance(output, Ima
+0002c080: 6765 4844 5529 3a0a 2020 2020 2020 2020  geHDU):.        
+0002c090: 6f75 7470 7574 7763 7320 3d20 7079 7763  outputwcs = pywc
+0002c0a0: 732e 5743 5328 6f75 7470 7574 2e68 6561  s.WCS(output.hea
+0002c0b0: 6465 7229 0a20 2020 2065 6c69 6620 6f75  der).    elif ou
+0002c0c0: 7470 7574 2069 7320 4e6f 6e65 3a0a 2020  tput is None:.  
+0002c0d0: 2020 2020 2020 5f68 6475 203d 206d 616b        _hdu = mak
+0002c0e0: 655f 6d61 7869 6d61 6c5f 7763 7328 6669  e_maximal_wcs(fi
+0002c0f0: 6c65 733d 7669 7369 745b 2766 696c 6573  les=visit['files
+0002c100: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0002c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c120: 2020 2020 7069 7865 6c5f 7363 616c 653d      pixel_scale=
+0002c130: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c150: 2020 2020 2020 6765 745f 6864 753d 5472        get_hdu=Tr
+0002c160: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0002c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c180: 2020 2020 7665 7262 6f73 653d 4661 6c73      verbose=Fals
+0002c190: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c1b0: 2020 2070 6164 3d34 290a 2020 2020 2020     pad=4).      
+0002c1c0: 2020 6f75 7470 7574 7763 7320 3d20 7079    outputwcs = py
+0002c1d0: 7763 732e 5743 5328 5f68 6475 2e68 6561  wcs.WCS(_hdu.hea
+0002c1e0: 6465 7229 0a20 2020 2065 6c73 653a 0a20  der).    else:. 
+0002c1f0: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+0002c200: 6e65 0a0a 2020 2020 6966 206e 6f74 2068  ne..    if not h
+0002c210: 6173 6174 7472 286f 7574 7075 7477 6373  asattr(outputwcs
+0002c220: 2c20 275f 6e61 7869 7331 2729 3a0a 2020  , '_naxis1'):.  
+0002c230: 2020 2020 2020 6f75 7470 7574 7763 732e        outputwcs.
+0002c240: 5f6e 6178 6973 312c 206f 7574 7075 7477  _naxis1, outputw
+0002c250: 6373 2e5f 6e61 7869 7332 203d 206f 7574  cs._naxis2 = out
+0002c260: 7075 7477 6373 2e5f 6e61 7869 730a 0a20  putwcs._naxis.. 
+0002c270: 2020 206f 7574 7075 7477 6373 2e70 7363     outputwcs.psc
+0002c280: 616c 6520 3d20 6765 745f 7763 735f 7073  ale = get_wcs_ps
+0002c290: 6361 6c65 286f 7574 7075 7477 6373 290a  cale(outputwcs).
+0002c2a0: 0a20 2020 206f 7574 7075 745f 706f 6c79  .    output_poly
+0002c2b0: 203d 2050 6f6c 7967 6f6e 286f 7574 7075   = Polygon(outpu
+0002c2c0: 7477 6373 2e63 616c 635f 666f 6f74 7072  twcs.calc_footpr
+0002c2d0: 696e 7428 2929 0a20 2020 2063 6f75 6e74  int()).    count
+0002c2e0: 203d 2030 0a0a 2020 2020 7265 665f 7068   = 0..    ref_ph
+0002c2f0: 6f74 666c 616d 203d 204e 6f6e 650a 2020  otflam = None.  
+0002c300: 2020 0a20 2020 2069 6e64 6963 6573 203d    .    indices =
+0002c310: 205b 5d0a 2020 2020 666f 7220 6920 696e   [].    for i in
+0002c320: 2072 616e 6765 286c 656e 2876 6973 6974   range(len(visit
+0002c330: 5b27 6669 6c65 7327 5d29 293a 0a20 2020  ['files'])):.   
+0002c340: 2020 2020 2069 6620 2766 6f6f 7470 7269       if 'footpri
+0002c350: 6e74 7327 2069 6e20 7669 7369 743a 0a20  nts' in visit:. 
+0002c360: 2020 2020 2020 2020 2020 206f 6c61 7020             olap 
+0002c370: 3d20 7669 7369 745b 2766 6f6f 7470 7269  = visit['footpri
+0002c380: 6e74 7327 5d5b 695d 2e69 6e74 6572 7365  nts'][i].interse
+0002c390: 6374 696f 6e28 6f75 7470 7574 5f70 6f6c  ction(output_pol
+0002c3a0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
+0002c3b0: 6620 6f6c 6170 2e61 7265 6120 3e20 303a  f olap.area > 0:
+0002c3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c3d0: 2069 6e64 6963 6573 2e61 7070 656e 6428   indices.append(
+0002c3e0: 6929 0a20 2020 2020 2020 2065 6c73 653a  i).        else:
+0002c3f0: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+0002c400: 6963 6573 2e61 7070 656e 6428 6929 0a0a  ices.append(i)..
+0002c410: 2020 2020 6966 2073 6b69 7020 6973 206e      if skip is n
+0002c420: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0002c430: 2069 6e64 6963 6573 203d 2069 6e64 6963   indices = indic
+0002c440: 6573 5b3a 3a73 6b69 705d 0a0a 2020 2020  es[::skip]..    
+0002c450: 4e54 4f54 414c 203d 206c 656e 2869 6e64  NTOTAL = len(ind
+0002c460: 6963 6573 290a 2020 2020 0a20 2020 2077  ices).    .    w
+0002c470: 6373 5f72 6f77 7320 3d20 5b5d 0a20 2020  cs_rows = [].   
+0002c480: 2077 6373 5f63 6f6c 6e61 6d65 7320 3d20   wcs_colnames = 
+0002c490: 4e6f 6e65 0a20 2020 2077 6373 5f6b 6579  None.    wcs_key
+0002c4a0: 7320 3d20 7b7d 0a20 2020 200a 2020 2020  s = {}.    .    
+0002c4b0: 6270 6461 7461 203d 2030 0a20 2020 200a  bpdata = 0.    .
+0002c4c0: 2020 2020 666f 7220 6920 696e 2069 6e64      for i in ind
+0002c4d0: 6963 6573 3a0a 0a20 2020 2020 2020 2066  ices:..        f
+0002c4e0: 696c 6520 3d20 7669 7369 745b 2766 696c  ile = visit['fil
+0002c4f0: 6573 275d 5b69 5d0a 0a20 2020 2020 2020  es'][i]..       
+0002c500: 206d 7367 203d 2027 5c6e 287b 303a 3464   msg = '\n({0:4d
+0002c510: 7d2f 7b31 3a34 647d 2920 4164 6420 6578  }/{1:4d}) Add ex
+0002c520: 706f 7375 7265 207b 327d 5c6e 270a 2020  posure {2}\n'.  
+0002c530: 2020 2020 2020 6d73 6720 3d20 6d73 672e        msg = msg.
+0002c540: 666f 726d 6174 2863 6f75 6e74 2b31 2c20  format(count+1, 
+0002c550: 4e54 4f54 414c 2c20 6669 6c65 290a 2020  NTOTAL, file).  
+0002c560: 2020 2020 2020 6c6f 675f 636f 6d6d 656e        log_commen
+0002c570: 7428 4c4f 4746 494c 452c 206d 7367 2c20  t(LOGFILE, msg, 
+0002c580: 7665 7262 6f73 653d 7665 7262 6f73 6529  verbose=verbose)
+0002c590: 0a0a 2020 2020 2020 2020 6966 2064 7279  ..        if dry
+0002c5a0: 7275 6e3a 0a20 2020 2020 2020 2020 2020  run:.           
+0002c5b0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0002c5c0: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
+0002c5d0: 682e 6578 6973 7473 2866 696c 6529 3a0a  h.exists(file):.
+0002c5e0: 2020 2020 2020 2020 2020 2020 6275 636b              buck
+0002c5f0: 6574 5f69 203d 2076 6973 6974 5b27 6177  et_i = visit['aw
+0002c600: 7370 6174 6827 5d5b 695d 2e73 706c 6974  spath'][i].split
+0002c610: 2827 2f27 295b 305d 0a20 2020 2020 2020  ('/')[0].       
+0002c620: 2020 2020 2069 6620 6275 636b 6574 5f6e       if bucket_n
+0002c630: 616d 6520 213d 2062 7563 6b65 745f 693a  ame != bucket_i:
+0002c640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c650: 2062 7563 6b65 745f 6e61 6d65 203d 2062   bucket_name = b
+0002c660: 7563 6b65 745f 690a 2020 2020 2020 2020  ucket_i.        
+0002c670: 2020 2020 2020 2020 626b 7420 3d20 7333          bkt = s3
+0002c680: 2e42 7563 6b65 7428 6275 636b 6574 5f6e  .Bucket(bucket_n
+0002c690: 616d 6529 0a0a 2020 2020 2020 2020 2020  ame)..          
+0002c6a0: 2020 7333 5f70 6174 6820 3d20 272f 272e    s3_path = '/'.
+0002c6b0: 6a6f 696e 2876 6973 6974 5b27 6177 7370  join(visit['awsp
+0002c6c0: 6174 6827 5d5b 695d 2e73 706c 6974 2827  ath'][i].split('
+0002c6d0: 2f27 295b 313a 5d29 0a20 2020 2020 2020  /')[1:]).       
+0002c6e0: 2020 2020 2072 656d 6f74 655f 6669 6c65       remote_file
+0002c6f0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0002c700: 7333 5f70 6174 682c 2066 696c 6529 0a0a  s3_path, file)..
+0002c710: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0002c720: 7428 2720 2028 6665 7463 6820 6672 6f6d  t('  (fetch from
+0002c730: 2073 333a 2f2f 7b30 7d2f 7b31 7d29 272e   s3://{0}/{1})'.
+0002c740: 666f 726d 6174 2862 7563 6b65 745f 692c  format(bucket_i,
+0002c750: 2072 656d 6f74 655f 6669 6c65 2929 0a0a   remote_file))..
+0002c760: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0002c770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c780: 2062 6b74 2e64 6f77 6e6c 6f61 645f 6669   bkt.download_fi
+0002c790: 6c65 2872 656d 6f74 655f 6669 6c65 2c20  le(remote_file, 
+0002c7a0: 6669 6c65 2c0a 2020 2020 2020 2020 2020  file,.          
+0002c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c7c0: 2020 2020 4578 7472 6141 7267 733d 7b22      ExtraArgs={"
+0002c7d0: 5265 7175 6573 7450 6179 6572 223a 2022  RequestPayer": "
+0002c7e0: 7265 7175 6573 7465 7222 7d29 0a20 2020  requester"}).   
+0002c7f0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0002c800: 436c 6965 6e74 4572 726f 723a 0a20 2020  ClientError:.   
+0002c810: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0002c820: 6e74 2827 2020 2866 6169 6c65 6420 7333  nt('  (failed s3
+0002c830: 3a2f 2f7b 307d 2f7b 317d 2927 2e66 6f72  ://{0}/{1})'.for
+0002c840: 6d61 7428 6275 636b 6574 5f69 2c20 7265  mat(bucket_i, re
+0002c850: 6d6f 7465 5f66 696c 6529 290a 2020 2020  mote_file)).    
+0002c860: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0002c870: 696e 7565 0a0a 2020 2020 2020 2020 7472  inue..        tr
+0002c880: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
+0002c890: 6c74 203d 2070 7966 6974 732e 6f70 656e  lt = pyfits.open
+0002c8a0: 2866 696c 6529 0a20 2020 2020 2020 2065  (file).        e
+0002c8b0: 7863 6570 7420 4f53 4572 726f 723a 0a20  xcept OSError:. 
+0002c8c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0002c8d0: 2866 276f 7065 6e28 7b66 696c 657d 2920  (f'open({file}) 
+0002c8e0: 6661 696c 6564 2127 290a 2020 2020 2020  failed!').      
+0002c8f0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+0002c900: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0002c910: 2020 2020 7363 695f 6c69 7374 2c20 7768      sci_list, wh
+0002c920: 745f 6c69 7374 2c20 7763 735f 6c69 7374  t_list, wcs_list
+0002c930: 203d 205b 5d2c 205b 5d2c 205b 5d0a 2020   = [], [], [].  
+0002c940: 2020 2020 2020 0a20 2020 2020 2020 206b        .        k
+0002c950: 6579 7320 3d20 4f72 6465 7265 6444 6963  eys = OrderedDic
+0002c960: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
+0002c970: 6b20 696e 205b 2745 5850 5449 4d45 272c  k in ['EXPTIME',
+0002c980: 2027 5445 4c45 5343 4f50 272c 2027 4649   'TELESCOP', 'FI
+0002c990: 4c54 4552 272c 2746 494c 5445 5231 272c  LTER','FILTER1',
+0002c9a0: 2027 4649 4c54 4552 3227 2c20 0a20 2020   'FILTER2', .   
+0002c9b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002c9c0: 5055 5049 4c27 2c20 2744 4554 4543 544f  PUPIL', 'DETECTO
+0002c9d0: 5227 2c20 2749 4e53 5452 554d 4527 2c20  R', 'INSTRUME', 
+0002c9e0: 2750 484f 5446 4c41 4d27 2c20 2750 484f  'PHOTFLAM', 'PHO
+0002c9f0: 5450 4c41 4d27 2c20 0a20 2020 2020 2020  TPLAM', .       
+0002ca00: 2020 2020 2020 2020 2020 2027 5048 4f54             'PHOT
+0002ca10: 464e 5527 2c20 2750 484f 545a 5054 272c  FNU', 'PHOTZPT',
+0002ca20: 2027 5048 4f54 4257 272c 2027 5048 4f54   'PHOTBW', 'PHOT
+0002ca30: 4d4f 4445 272c 2027 4558 5053 5441 5254  MODE', 'EXPSTART
+0002ca40: 272c 200a 2020 2020 2020 2020 2020 2020  ', .            
+0002ca50: 2020 2020 2020 2745 5850 454e 4427 2c20        'EXPEND', 
+0002ca60: 2744 4154 452d 4f42 5327 2c20 2754 494d  'DATE-OBS', 'TIM
+0002ca70: 452d 4f42 5327 2c0a 2020 2020 2020 2020  E-OBS',.        
+0002ca80: 2020 2020 2020 2020 2020 2755 5044 415f            'UPDA_
+0002ca90: 4354 5827 2c20 2743 5244 535f 4354 5827  CTX', 'CRDS_CTX'
+0002caa0: 2c20 2752 5f44 4953 544f 5227 2c20 2752  , 'R_DISTOR', 'R
+0002cab0: 5f50 484f 544f 4d27 2c20 2752 5f46 4c41  _PHOTOM', 'R_FLA
+0002cac0: 5427 5d3a 0a20 2020 2020 2020 2020 2020  T']:.           
+0002cad0: 2069 6620 6b20 696e 2066 6c74 5b30 5d2e   if k in flt[0].
+0002cae0: 6865 6164 6572 3a0a 2020 2020 2020 2020  header:.        
+0002caf0: 2020 2020 2020 2020 6b65 7973 5b6b 5d20          keys[k] 
+0002cb00: 3d20 666c 745b 305d 2e68 6561 6465 725b  = flt[0].header[
+0002cb10: 6b5d 0a20 2020 2020 2020 200a 2020 2020  k].        .    
+0002cb20: 2020 2020 6966 2066 6c74 5b30 5d2e 6865      if flt[0].he
+0002cb30: 6164 6572 5b27 5445 4c45 5343 4f50 275d  ader['TELESCOP']
+0002cb40: 2069 6e20 5b27 4a57 5354 275d 3a0a 2020   in ['JWST']:.  
+0002cb50: 2020 2020 2020 2020 2020 6269 7473 203d            bits =
+0002cb60: 2034 0a20 2020 2020 2020 2020 2020 2069   4.            i
+0002cb70: 6e63 6c75 6465 5f73 6174 7572 6174 6564  nclude_saturated
+0002cb80: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0002cb90: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0002cba0: 2020 2362 7064 6174 6120 3d20 300a 2020    #bpdata = 0.  
+0002cbb0: 2020 2020 2020 2020 2020 5f69 6e73 7420            _inst 
+0002cbc0: 3d20 666c 745b 305d 2e68 6561 6465 725b  = flt[0].header[
+0002cbd0: 2749 4e53 5452 554d 4527 5d0a 2020 2020  'INSTRUME'].    
+0002cbe0: 2020 2020 2020 2020 6966 2028 6578 7472          if (extr
+0002cbf0: 615f 7766 6333 6972 5f62 6164 7069 7829  a_wfc3ir_badpix)
+0002cc00: 2026 2028 5f69 6e73 7420 696e 205b 274e   & (_inst in ['N
+0002cc10: 4952 4341 4d27 5d29 3a0a 2020 2020 2020  IRCAM']):.      
+0002cc20: 2020 2020 2020 2020 2020 5f64 6574 203d            _det =
+0002cc30: 2066 6c74 5b30 5d2e 6865 6164 6572 5b27   flt[0].header['
+0002cc40: 4445 5445 4354 4f52 275d 0a20 2020 2020  DETECTOR'].     
+0002cc50: 2020 2020 2020 2020 2020 2062 7066 696c             bpfil
+0002cc60: 6573 203d 205b 6f73 2e70 6174 682e 6a6f  es = [os.path.jo
+0002cc70: 696e 286f 732e 7061 7468 2e64 6972 6e61  in(os.path.dirna
+0002cc80: 6d65 285f 5f66 696c 655f 5f29 2c20 0a20  me(__file__), . 
+0002cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cca0: 2020 2020 2020 2020 2020 6627 6461 7461            f'data
+0002ccb0: 2f6e 7263 5f62 6164 7069 785f 3233 3031  /nrc_badpix_2301
+0002ccc0: 3230 5f7b 5f64 6574 7d2e 6669 7473 2e67  20_{_det}.fits.g
+0002ccd0: 7a27 295d 0a20 2020 2020 2020 2020 2020  z')].           
+0002cce0: 2020 2020 2062 7066 696c 6573 202b 3d20       bpfiles += 
+0002ccf0: 5b6f 732e 7061 7468 2e6a 6f69 6e28 6f73  [os.path.join(os
+0002cd00: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
+0002cd10: 6669 6c65 5f5f 292c 200a 2020 2020 2020  file__), .      
+0002cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cd30: 2020 2020 2066 2764 6174 612f 6e72 635f       f'data/nrc_
+0002cd40: 6c6f 7770 6978 5f30 3931 365f 7b5f 6465  lowpix_0916_{_de
+0002cd50: 747d 2e66 6974 732e 677a 2729 5d0a 2020  t}.fits.gz')].  
+0002cd60: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0002cd70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002cd80: 6f72 2062 7066 696c 6520 696e 2062 7066  or bpfile in bpf
+0002cd90: 696c 6573 3a0a 2020 2020 2020 2020 2020  iles:.          
+0002cda0: 2020 2020 2020 2020 2020 6966 206f 732e            if os.
+0002cdb0: 7061 7468 2e65 7869 7374 7328 6270 6669  path.exists(bpfi
+0002cdc0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+0002cdd0: 2020 2020 2020 2020 2020 2020 2062 7064               bpd
+0002cde0: 6174 6120 3d20 7079 6669 7473 2e6f 7065  ata = pyfits.ope
+0002cdf0: 6e28 6270 6669 6c65 295b 305d 2e64 6174  n(bpfile)[0].dat
+0002ce00: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0002ce10: 2020 2020 2020 2020 2020 6270 6461 7461            bpdata
+0002ce20: 203d 206e 642e 6269 6e61 7279 5f64 696c   = nd.binary_dil
+0002ce30: 6174 696f 6e28 6270 6461 7461 203e 2030  ation(bpdata > 0
+0002ce40: 292a 3130 3234 0a20 2020 2020 2020 2020  )*1024.         
+0002ce50: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0002ce60: 7367 203d 2066 2755 7365 2065 7874 7261  sg = f'Use extra
+0002ce70: 2062 6164 7069 7820 696e 207b 6270 6669   badpix in {bpfi
+0002ce80: 6c65 7d27 0a20 2020 2020 2020 2020 2020  le}'.           
+0002ce90: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002cea0: 5f63 6f6d 6d65 6e74 284c 4f47 4649 4c45  _comment(LOGFILE
+0002ceb0: 2c20 6d73 672c 2076 6572 626f 7365 3d76  , msg, verbose=v
+0002cec0: 6572 626f 7365 290a 2020 2020 2020 2020  erbose).        
+0002ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cee0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+0002cef0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002cf00: 2020 2020 2020 2020 6270 6461 7461 203d          bpdata =
+0002cf10: 206e 702e 7a65 726f 7328 666c 745b 2753   np.zeros(flt['S
+0002cf20: 4349 275d 2e64 6174 612e 7368 6170 652c  CI'].data.shape,
+0002cf30: 2064 7479 7065 3d69 6e74 290a 2020 2020   dtype=int).    
+0002cf40: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0002cf50: 2020 2020 2020 2020 2023 204e 4952 4953           # NIRIS
+0002cf60: 5320 6768 6f73 7420 6d61 736b 0a20 2020  S ghost mask.   
+0002cf70: 2020 2020 2020 2020 2069 6620 285f 696e           if (_in
+0002cf80: 7374 2069 6e20 5b27 4e49 5249 5353 275d  st in ['NIRISS']
+0002cf90: 2920 2620 286e 6972 6973 735f 6768 6f73  ) & (niriss_ghos
+0002cfa0: 745f 6b77 6172 6773 2069 7320 6e6f 7420  t_kwargs is not 
+0002cfb0: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
+0002cfc0: 2020 2020 2020 2069 6620 2776 6572 626f         if 'verbo
+0002cfd0: 7365 2720 6e6f 7420 696e 206e 6972 6973  se' not in niris
+0002cfe0: 735f 6768 6f73 745f 6b77 6172 6773 3a0a  s_ghost_kwargs:.
+0002cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d000: 2020 2020 6e69 7269 7373 5f67 686f 7374      niriss_ghost
+0002d010: 5f6b 7761 7267 735b 2776 6572 626f 7365  _kwargs['verbose
+0002d020: 275d 203d 2076 6572 626f 7365 0a20 2020  '] = verbose.   
+0002d030: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+0002d040: 2020 2020 2020 2020 2020 2020 2020 5f67                _g
+0002d050: 686f 7374 203d 206e 6972 6973 735f 6768  host = niriss_gh
+0002d060: 6f73 745f 6d61 736b 2866 6c74 2c20 2a2a  ost_mask(flt, **
+0002d070: 6e69 7269 7373 5f67 686f 7374 5f6b 7761  niriss_ghost_kwa
+0002d080: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+0002d090: 2020 2020 2062 7064 6174 6120 7c3d 205f       bpdata |= _
+0002d0a0: 6768 6f73 742a 3130 3234 0a20 2020 2020  ghost*1024.     
+0002d0b0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002d0c0: 2020 2020 2320 4e65 6761 7469 7665 0a20      # Negative. 
+0002d0d0: 2020 2020 2020 2020 2020 2069 6620 274d             if 'M
+0002d0e0: 4452 495a 534b 5927 2069 6e20 666c 745b  DRIZSKY' in flt[
+0002d0f0: 2753 4349 275d 2e68 6561 6465 723a 0a20  'SCI'].header:. 
+0002d100: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0002d110: 6c6f 7720 3d20 2828 666c 745b 2753 4349  low = ((flt['SCI
+0002d120: 275d 2e64 6174 6120 2d20 666c 745b 2753  '].data - flt['S
+0002d130: 4349 275d 2e68 6561 6465 725b 274d 4452  CI'].header['MDR
+0002d140: 495a 534b 5927 5d29 203c 200a 2020 2020  IZSKY']) < .    
+0002d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d160: 2020 2d35 2a66 6c74 5b27 4552 5227 5d2e    -5*flt['ERR'].
+0002d170: 6461 7461 290a 2020 2020 2020 2020 2020  data).          
+0002d180: 2020 2020 2020 6d73 6720 3d20 6627 4578        msg = f'Ex
+0002d190: 7472 6120 2d35 2073 6967 6d61 206c 6f77  tra -5 sigma low
+0002d1a0: 2070 6978 656c 733a 204e 3d20 7b5f 6c6f   pixels: N= {_lo
+0002d1b0: 772e 7375 6d28 297d 2027 0a20 2020 2020  w.sum()} '.     
+0002d1c0: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
+0002d1d0: 3d20 6627 2028 207b 5f6c 6f77 2e73 756d  = f' ( {_low.sum
+0002d1e0: 2829 2f5f 6c6f 772e 7369 7a65 2a31 3030  ()/_low.size*100
+0002d1f0: 3a2e 317d 2025 2927 0a20 2020 2020 2020  :.1} %)'.       
+0002d200: 2020 2020 2020 2020 206c 6f67 5f63 6f6d           log_com
+0002d210: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
+0002d220: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
+0002d230: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+0002d240: 2020 2020 6270 6461 7461 207c 3d20 5f6c      bpdata |= _l
+0002d250: 6f77 2a31 3032 340a 2020 2020 2020 2020  ow*1024.        
+0002d260: 2020 2020 0a20 2020 2020 2020 2065 6c69      .        eli
+0002d270: 6620 666c 745b 305d 2e68 6561 6465 725b  f flt[0].header[
+0002d280: 2744 4554 4543 544f 5227 5d20 3d3d 2027  'DETECTOR'] == '
+0002d290: 4952 273a 0a20 2020 2020 2020 2020 2020  IR':.           
+0002d2a0: 2062 6974 7320 3d20 3537 360a 2020 2020   bits = 576.    
+0002d2b0: 2020 2020 2020 2020 6966 2065 7874 7261          if extra
+0002d2c0: 5f77 6663 3369 725f 6261 6470 6978 3a0a  _wfc3ir_badpix:.
+0002d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d2e0: 6966 2028 6920 3d3d 2069 6e64 6963 6573  if (i == indices
+0002d2f0: 5b30 5d29 207c 2028 6e6f 7420 6861 7361  [0]) | (not hasa
+0002d300: 7474 7228 6270 6461 7461 2c20 2773 6861  ttr(bpdata, 'sha
+0002d310: 7065 2729 293a 0a20 2020 2020 2020 2020  pe')):.         
+0002d320: 2020 2020 2020 2020 2020 2062 7066 696c             bpfil
+0002d330: 6520 3d20 6f73 2e70 6174 682e 6a6f 696e  e = os.path.join
+0002d340: 286f 732e 7061 7468 2e64 6972 6e61 6d65  (os.path.dirname
+0002d350: 285f 5f66 696c 655f 5f29 2c20 0a20 2020  (__file__), .   
 0002d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d370: 2076 6572 626f 7365 3d76 6572 626f 7365   verbose=verbose
-0002d380: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0002d390: 2020 2020 2020 2020 2020 2020 5f73 6361              _sca
-0002d3a0: 6c65 5f70 686f 746f 6d20 3d20 312e 300a  le_photom = 1.0.
-0002d3b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0002d3c0: 2069 6620 2750 484f 5446 4c41 4d27 2069   if 'PHOTFLAM' i
-0002d3d0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-0002d3e0: 2020 2020 6d73 6720 3d20 2720 2030 2020      msg = '  0  
-0002d3f0: 2020 5048 4f54 464c 414d 3d7b 303a 2e32    PHOTFLAM={0:.2
-0002d400: 657d 2c20 7363 616c 653d 7b31 3a2e 3366  e}, scale={1:.3f
-0002d410: 7d27 0a20 2020 2020 2020 2020 2020 206d  }'.            m
-0002d420: 7367 203d 206d 7367 2e66 6f72 6d61 7428  sg = msg.format(
-0002d430: 6b65 7973 5b27 5048 4f54 464c 414d 275d  keys['PHOTFLAM']
-0002d440: 2c20 5f73 6361 6c65 5f70 686f 746f 6d29  , _scale_photom)
-0002d450: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0002d460: 5f63 6f6d 6d65 6e74 284c 4f47 4649 4c45  _comment(LOGFILE
-0002d470: 2c20 6d73 672c 2076 6572 626f 7365 3d76  , msg, verbose=v
-0002d480: 6572 626f 7365 290a 2020 2020 2020 2020  erbose).        
-0002d490: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0002d4a0: 2069 6620 7265 665f 7068 6f74 666c 616d   if ref_photflam
-0002d4b0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002d4c0: 2020 2020 2020 2020 2020 7265 665f 7068            ref_ph
-0002d4d0: 6f74 666c 616d 203d 206b 6579 735b 2750  otflam = keys['P
-0002d4e0: 484f 5446 4c41 4d27 5d0a 2020 2020 2020  HOTFLAM'].      
-0002d4f0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-0002d500: 2020 2020 2020 2066 6f72 2065 7874 2069         for ext i
-0002d510: 6e20 5b31 2c20 322c 2033 2c20 345d 3a0a  n [1, 2, 3, 4]:.
-0002d520: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0002d530: 2753 4349 272c 2065 7874 2920 696e 2066  'SCI', ext) in f
-0002d540: 6c74 3a0a 0a20 2020 2020 2020 2020 2020  lt:..           
-0002d550: 2020 2020 2068 203d 2066 6c74 5b28 2753       h = flt[('S
-0002d560: 4349 272c 2065 7874 295d 2e68 6561 6465  CI', ext)].heade
-0002d570: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0002d580: 2020 6966 2027 4d44 5249 5a53 4b59 2720    if 'MDRIZSKY' 
-0002d590: 696e 2068 3a0a 2020 2020 2020 2020 2020  in h:.          
-0002d5a0: 2020 2020 2020 2020 2020 736b 795f 7661            sky_va
-0002d5b0: 6c75 6520 3d20 685b 274d 4452 495a 534b  lue = h['MDRIZSK
-0002d5c0: 5927 5d0a 2020 2020 2020 2020 2020 2020  Y'].            
-0002d5d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002d5e0: 2020 2020 2020 2020 2020 2020 2020 736b                sk
-0002d5f0: 795f 7661 6c75 6520 3d20 300a 2020 2020  y_value = 0.    
-0002d600: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0002d610: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002d620: 2827 424b 4727 2c65 7874 2920 696e 2066  ('BKG',ext) in f
-0002d630: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
-0002d640: 2020 2020 2020 2020 6861 735f 626b 6720          has_bkg 
-0002d650: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0002d660: 2020 2020 2020 2020 2020 2073 6b79 203d             sky =
-0002d670: 2066 6c74 5b27 424b 4727 2c65 7874 5d2e   flt['BKG',ext].
-0002d680: 6461 7461 202b 2073 6b79 5f76 616c 7565  data + sky_value
-0002d690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d6a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002d6b0: 2020 2020 2020 2020 2020 2068 6173 5f62             has_b
-0002d6c0: 6b67 203d 2046 616c 7365 0a20 2020 2020  kg = False.     
-0002d6d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002d6e0: 6b79 203d 2073 6b79 5f76 616c 7565 0a20  ky = sky_value. 
-0002d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d700: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0002d710: 2020 2020 6d73 6720 3d20 6627 2020 6578      msg = f'  ex
-0002d720: 7420 2853 4349 2c7b 6578 747d 292c 2073  t (SCI,{ext}), s
-0002d730: 6b79 3d7b 736b 795f 7661 6c75 653a 2e33  ky={sky_value:.3
-0002d740: 667d 270a 2020 2020 2020 2020 2020 2020  f}'.            
-0002d750: 2020 2020 6d73 6720 2b3d 2066 2720 6861      msg += f' ha
-0002d760: 735f 626b 673a 7b68 6173 5f62 6b67 7d27  s_bkg:{has_bkg}'
-0002d770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d780: 206c 6f67 5f63 6f6d 6d65 6e74 284c 4f47   log_comment(LOG
-0002d790: 4649 4c45 2c20 6d73 672c 2076 6572 626f  FILE, msg, verbo
-0002d7a0: 7365 3d76 6572 626f 7365 290a 2020 2020  se=verbose).    
-0002d7b0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0002d7c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002d7d0: 685b 2742 554e 4954 275d 203d 3d20 2745  h['BUNIT'] == 'E
-0002d7e0: 4c45 4354 524f 4e53 273a 0a20 2020 2020  LECTRONS':.     
-0002d7f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002d800: 6f5f 7065 725f 7365 6320 3d20 312e 2f6b  o_per_sec = 1./k
-0002d810: 6579 735b 2745 5850 5449 4d45 275d 0a20  eys['EXPTIME']. 
-0002d820: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002d830: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002d840: 2020 2020 2020 2020 2074 6f5f 7065 725f           to_per_
-0002d850: 7365 6320 3d20 312e 0a0a 2020 2020 2020  sec = 1...      
-0002d860: 2020 2020 2020 2020 2020 7068 6f74 5f73            phot_s
-0002d870: 6361 6c65 203d 2074 6f5f 7065 725f 7365  cale = to_per_se
-0002d880: 6320 2a20 5f73 6361 6c65 5f70 686f 746f  c * _scale_photo
-0002d890: 6d0a 0a20 2020 2020 2020 2020 2020 2020  m..             
-0002d8a0: 2020 2069 6620 2750 484f 5446 4c41 4d27     if 'PHOTFLAM'
-0002d8b0: 2069 6e20 683a 0a20 2020 2020 2020 2020   in h:.         
-0002d8c0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0002d8d0: 665f 7068 6f74 666c 616d 2069 7320 4e6f  f_photflam is No
-0002d8e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0002d8f0: 2020 2020 2020 2020 2020 2020 7265 665f              ref_
-0002d900: 7068 6f74 666c 616d 203d 2068 5b27 5048  photflam = h['PH
-0002d910: 4f54 464c 414d 275d 0a0a 2020 2020 2020  OTFLAM']..      
-0002d920: 2020 2020 2020 2020 2020 2020 2020 7068                ph
-0002d930: 6f74 5f73 6361 6c65 203d 2068 5b27 5048  ot_scale = h['PH
-0002d940: 4f54 464c 414d 275d 202f 2072 6566 5f70  OTFLAM'] / ref_p
-0002d950: 686f 7466 6c61 6d20 2a20 5f73 6361 6c65  hotflam * _scale
-0002d960: 5f70 686f 746f 6d0a 2020 2020 2020 2020  _photom.        
-0002d970: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0002d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d990: 2069 6620 2750 484f 5446 4e55 2720 6e6f   if 'PHOTFNU' no
-0002d9a0: 7420 696e 2068 3a0a 2020 2020 2020 2020  t in h:.        
-0002d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d9c0: 685b 2750 484f 5446 4e55 275d 203d 2028  h['PHOTFNU'] = (
-0002d9d0: 7068 6f74 666e 755f 6672 6f6d 5f70 686f  photfnu_from_pho
-0002d9e0: 7466 6c61 6d28 685b 2750 484f 5446 4c41  tflam(h['PHOTFLA
-0002d9f0: 4d27 5d2c 0a20 2020 2020 2020 2020 2020  M'],.           
+0002d370: 2020 2020 2020 2020 2020 2020 2764 6174              'dat
+0002d380: 612f 7766 6333 6972 5f62 6164 7069 785f  a/wfc3ir_badpix_
+0002d390: 7370 6172 7332 3030 5f32 322e 3033 2e33  spars200_22.03.3
+0002d3a0: 312e 6669 7473 2e67 7a27 290a 2020 2020  1.fits.gz').    
+0002d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d3c0: 6270 6461 7461 203d 2070 7966 6974 732e  bpdata = pyfits.
+0002d3d0: 6f70 656e 2862 7066 696c 6529 5b30 5d2e  open(bpfile)[0].
+0002d3e0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0002d3f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0002d400: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+0002d410: 6627 5573 6520 6578 7472 6120 6261 6470  f'Use extra badp
+0002d420: 6978 2069 6e20 7b62 7066 696c 657d 270a  ix in {bpfile}'.
+0002d430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d440: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
+0002d450: 494c 452c 206d 7367 2c20 7665 7262 6f73  ILE, msg, verbos
+0002d460: 653d 7665 7262 6f73 6529 0a20 2020 2020  e=verbose).     
+0002d470: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002d480: 2020 2020 2062 6974 7320 3d20 3634 2b33       bits = 64+3
+0002d490: 320a 2020 2020 2020 2020 2020 2020 6270  2.            bp
+0002d4a0: 6461 7461 203d 2030 0a20 2020 2020 2020  data = 0.       
+0002d4b0: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+0002d4c0: 2069 6e63 6c75 6465 5f73 6174 7572 6174   include_saturat
+0002d4d0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+0002d4e0: 6269 7473 207c 3d20 3235 360a 0a20 2020  bits |= 256..   
+0002d4f0: 2020 2020 2069 6620 6b65 6570 5f62 6974       if keep_bit
+0002d500: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+0002d510: 2020 2020 2020 2020 2020 2062 6974 7320             bits 
+0002d520: 7c3d 206b 6565 705f 6269 7473 0a20 2020  |= keep_bits.   
+0002d530: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+0002d540: 2073 6361 6c65 5f70 686f 746f 6d3a 0a20   scale_photom:. 
+0002d550: 2020 2020 2020 2020 2020 205f 6b65 792c             _key,
+0002d560: 205f 7363 616c 655f 7068 6f74 6f6d 203d   _scale_photom =
+0002d570: 2067 6574 5f70 686f 746f 6d5f 7363 616c   get_photom_scal
+0002d580: 6528 666c 745b 305d 2e68 6561 6465 722c  e(flt[0].header,
+0002d590: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0002d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d5c0: 2020 2020 2076 6572 626f 7365 3d76 6572       verbose=ver
+0002d5d0: 626f 7365 290a 2020 2020 2020 2020 656c  bose).        el
+0002d5e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002d5f0: 5f73 6361 6c65 5f70 686f 746f 6d20 3d20  _scale_photom = 
+0002d600: 312e 300a 2020 2020 2020 2020 0a20 2020  1.0.        .   
+0002d610: 2020 2020 2069 6620 2750 484f 5446 4c41       if 'PHOTFLA
+0002d620: 4d27 2069 6e20 6b65 7973 3a0a 2020 2020  M' in keys:.    
+0002d630: 2020 2020 2020 2020 6d73 6720 3d20 2720          msg = ' 
+0002d640: 2030 2020 2020 5048 4f54 464c 414d 3d7b   0    PHOTFLAM={
+0002d650: 303a 2e32 657d 2c20 7363 616c 653d 7b31  0:.2e}, scale={1
+0002d660: 3a2e 3366 7d27 0a20 2020 2020 2020 2020  :.3f}'.         
+0002d670: 2020 206d 7367 203d 206d 7367 2e66 6f72     msg = msg.for
+0002d680: 6d61 7428 6b65 7973 5b27 5048 4f54 464c  mat(keys['PHOTFL
+0002d690: 414d 275d 2c20 5f73 6361 6c65 5f70 686f  AM'], _scale_pho
+0002d6a0: 746f 6d29 0a20 2020 2020 2020 2020 2020  tom).           
+0002d6b0: 206c 6f67 5f63 6f6d 6d65 6e74 284c 4f47   log_comment(LOG
+0002d6c0: 4649 4c45 2c20 6d73 672c 2076 6572 626f  FILE, msg, verbo
+0002d6d0: 7365 3d76 6572 626f 7365 290a 2020 2020  se=verbose).    
+0002d6e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0002d6f0: 2020 2020 2069 6620 7265 665f 7068 6f74       if ref_phot
+0002d700: 666c 616d 2069 7320 4e6f 6e65 3a0a 2020  flam is None:.  
+0002d710: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002d720: 665f 7068 6f74 666c 616d 203d 206b 6579  f_photflam = key
+0002d730: 735b 2750 484f 5446 4c41 4d27 5d0a 2020  s['PHOTFLAM'].  
+0002d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d750: 2020 0a20 2020 2020 2020 2066 6f72 2065    .        for e
+0002d760: 7874 2069 6e20 5b31 2c20 322c 2033 2c20  xt in [1, 2, 3, 
+0002d770: 345d 3a0a 2020 2020 2020 2020 2020 2020  4]:.            
+0002d780: 6966 2028 2753 4349 272c 2065 7874 2920  if ('SCI', ext) 
+0002d790: 696e 2066 6c74 3a0a 0a20 2020 2020 2020  in flt:..       
+0002d7a0: 2020 2020 2020 2020 2068 203d 2066 6c74           h = flt
+0002d7b0: 5b28 2753 4349 272c 2065 7874 295d 2e68  [('SCI', ext)].h
+0002d7c0: 6561 6465 720a 2020 2020 2020 2020 2020  eader.          
+0002d7d0: 2020 2020 2020 6966 2027 4d44 5249 5a53        if 'MDRIZS
+0002d7e0: 4b59 2720 696e 2068 3a0a 2020 2020 2020  KY' in h:.      
+0002d7f0: 2020 2020 2020 2020 2020 2020 2020 736b                sk
+0002d800: 795f 7661 6c75 6520 3d20 685b 274d 4452  y_value = h['MDR
+0002d810: 495a 534b 5927 5d0a 2020 2020 2020 2020  IZSKY'].        
+0002d820: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d840: 2020 736b 795f 7661 6c75 6520 3d20 300a    sky_value = 0.
+0002d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d870: 2069 6620 2827 424b 4727 2c65 7874 2920   if ('BKG',ext) 
+0002d880: 696e 2066 6c74 3a0a 2020 2020 2020 2020  in flt:.        
+0002d890: 2020 2020 2020 2020 2020 2020 6861 735f              has_
+0002d8a0: 626b 6720 3d20 5472 7565 0a20 2020 2020  bkg = True.     
+0002d8b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002d8c0: 6b79 203d 2066 6c74 5b27 424b 4727 2c65  ky = flt['BKG',e
+0002d8d0: 7874 5d2e 6461 7461 202b 2073 6b79 5f76  xt].data + sky_v
+0002d8e0: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+0002d8f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002d900: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0002d910: 6173 5f62 6b67 203d 2046 616c 7365 0a20  as_bkg = False. 
+0002d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d930: 2020 2073 6b79 203d 2073 6b79 5f76 616c     sky = sky_val
+0002d940: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0002d950: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002d960: 2020 2020 2020 2020 6d73 6720 3d20 6627          msg = f'
+0002d970: 2020 6578 7420 2853 4349 2c7b 6578 747d    ext (SCI,{ext}
+0002d980: 292c 2073 6b79 3d7b 736b 795f 7661 6c75  ), sky={sky_valu
+0002d990: 653a 2e33 667d 270a 2020 2020 2020 2020  e:.3f}'.        
+0002d9a0: 2020 2020 2020 2020 6d73 6720 2b3d 2066          msg += f
+0002d9b0: 2720 6861 735f 626b 673a 7b68 6173 5f62  ' has_bkg:{has_b
+0002d9c0: 6b67 7d27 0a20 2020 2020 2020 2020 2020  kg}'.           
+0002d9d0: 2020 2020 206c 6f67 5f63 6f6d 6d65 6e74       log_comment
+0002d9e0: 284c 4f47 4649 4c45 2c20 6d73 672c 2076  (LOGFILE, msg, v
+0002d9f0: 6572 626f 7365 3d76 6572 626f 7365 290a  erbose=verbose).
 0002da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da30: 2020 685b 2750 484f 5450 4c41 4d27 5d29    h['PHOTPLAM'])
-0002da40: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0002da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da60: 2020 2020 2020 2020 2020 2027 496e 7665             'Inve
-0002da70: 7273 6520 7365 6e73 6974 6976 6974 792c  rse sensitivity,
-0002da80: 204a 792f 444e 2729 0a20 2020 2020 2020   Jy/DN').       
-0002da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dac0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0002dad0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0002dae0: 2027 2020 2020 2020 2050 484f 5446 4c41   '       PHOTFLA
-0002daf0: 4d3d 7b30 3a2e 3265 7d2c 2073 6361 6c65  M={0:.2e}, scale
-0002db00: 3d7b 313a 2e33 667d 270a 2020 2020 2020  ={1:.3f}'.      
-0002db10: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-0002db20: 6720 3d20 6d73 672e 666f 726d 6174 2868  g = msg.format(h
-0002db30: 5b27 5048 4f54 464c 414d 275d 2c20 7068  ['PHOTFLAM'], ph
-0002db40: 6f74 5f73 6361 6c65 290a 2020 2020 2020  ot_scale).      
-0002db50: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002db60: 675f 636f 6d6d 656e 7428 4c4f 4746 494c  g_comment(LOGFIL
-0002db70: 452c 206d 7367 2c20 7665 7262 6f73 653d  E, msg, verbose=
-0002db80: 7665 7262 6f73 6529 0a20 2020 2020 2020  verbose).       
-0002db90: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0002dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dbb0: 2020 6b65 7973 5b27 5048 4f54 464c 414d    keys['PHOTFLAM
-0002dbc0: 275d 203d 2068 5b27 5048 4f54 464c 414d  '] = h['PHOTFLAM
-0002dbd0: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-0002dbe0: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
-0002dbf0: 5b27 5048 4f54 464c 414d 272c 2027 5048  ['PHOTFLAM', 'PH
-0002dc00: 4f54 504c 414d 272c 2027 5048 4f54 464e  OTPLAM', 'PHOTFN
-0002dc10: 5527 2c0a 2020 2020 2020 2020 2020 2020  U',.            
-0002dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc30: 2020 2750 484f 545a 5054 272c 2027 5048    'PHOTZPT', 'PH
-0002dc40: 4f54 4257 272c 2027 5048 4f54 4d4f 4445  OTBW', 'PHOTMODE
-0002dc50: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002da10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002da20: 2069 6620 685b 2742 554e 4954 275d 203d   if h['BUNIT'] =
+0002da30: 3d20 2745 4c45 4354 524f 4e53 273a 0a20  = 'ELECTRONS':. 
+0002da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da50: 2020 2074 6f5f 7065 725f 7365 6320 3d20     to_per_sec = 
+0002da60: 312e 2f6b 6579 735b 2745 5850 5449 4d45  1./keys['EXPTIME
+0002da70: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
+0002da80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002da90: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
+0002daa0: 7065 725f 7365 6320 3d20 312e 0a0a 2020  per_sec = 1...  
+0002dab0: 2020 2020 2020 2020 2020 2020 2020 7068                ph
+0002dac0: 6f74 5f73 6361 6c65 203d 2074 6f5f 7065  ot_scale = to_pe
+0002dad0: 725f 7365 6320 2a20 5f73 6361 6c65 5f70  r_sec * _scale_p
+0002dae0: 686f 746f 6d0a 0a20 2020 2020 2020 2020  hotom..         
+0002daf0: 2020 2020 2020 2069 6620 2750 484f 5446         if 'PHOTF
+0002db00: 4c41 4d27 2069 6e20 683a 0a20 2020 2020  LAM' in h:.     
+0002db10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002db20: 6620 7265 665f 7068 6f74 666c 616d 2069  f ref_photflam i
+0002db30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0002db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002db50: 7265 665f 7068 6f74 666c 616d 203d 2068  ref_photflam = h
+0002db60: 5b27 5048 4f54 464c 414d 275d 0a0a 2020  ['PHOTFLAM']..  
+0002db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002db80: 2020 7068 6f74 5f73 6361 6c65 203d 2068    phot_scale = h
+0002db90: 5b27 5048 4f54 464c 414d 275d 202f 2072  ['PHOTFLAM'] / r
+0002dba0: 6566 5f70 686f 7466 6c61 6d20 2a20 5f73  ef_photflam * _s
+0002dbb0: 6361 6c65 5f70 686f 746f 6d0a 2020 2020  cale_photom.    
+0002dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002dbe0: 2020 2020 2069 6620 2750 484f 5446 4e55       if 'PHOTFNU
+0002dbf0: 2720 6e6f 7420 696e 2068 3a0a 2020 2020  ' not in h:.    
+0002dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dc10: 2020 2020 685b 2750 484f 5446 4e55 275d      h['PHOTFNU']
+0002dc20: 203d 2028 7068 6f74 666e 755f 6672 6f6d   = (photfnu_from
+0002dc30: 5f70 686f 7466 6c61 6d28 685b 2750 484f  _photflam(h['PHO
+0002dc40: 5446 4c41 4d27 5d2c 0a20 2020 2020 2020  TFLAM'],.       
+0002dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc70: 2027 5048 4f54 4d4a 5352 272c 2027 5049   'PHOTMJSR', 'PI
-0002dc80: 5841 525f 5352 275d 3a0a 2020 2020 2020  XAR_SR']:.      
-0002dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dca0: 2020 6966 206b 2069 6e20 683a 0a20 2020    if k in h:.   
-0002dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dcc0: 2020 2020 2020 2020 206b 6579 735b 6b5d           keys[k]
-0002dcd0: 203d 2068 5b6b 5d0a 0a20 2020 2020 2020   = h[k]..       
-0002dce0: 2020 2020 2020 2020 2020 2020 2070 686f               pho
-0002dcf0: 745f 7363 616c 6520 2a3d 2074 6f5f 7065  t_scale *= to_pe
-0002dd00: 725f 7365 630a 2020 2020 2020 2020 2020  r_sec.          
+0002dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dc80: 2020 2020 2020 685b 2750 484f 5450 4c41        h['PHOTPLA
+0002dc90: 4d27 5d29 2c20 0a20 2020 2020 2020 2020  M']), .         
+0002dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dcb0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002dcc0: 496e 7665 7273 6520 7365 6e73 6974 6976  Inverse sensitiv
+0002dcd0: 6974 792c 204a 792f 444e 2729 0a20 2020  ity, Jy/DN').   
+0002dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002dd10: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0002dd20: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd40: 2020 2020 7763 735f 6920 3d20 7079 7763      wcs_i = pywc
-0002dd50: 732e 5743 5328 6865 6164 6572 3d66 6c74  s.WCS(header=flt
-0002dd60: 5b28 2753 4349 272c 2065 7874 295d 2e68  [('SCI', ext)].h
-0002dd70: 6561 6465 722c 200a 2020 2020 2020 2020  eader, .        
-0002dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0002dda0: 626a 3d66 6c74 290a 2020 2020 2020 2020  bj=flt).        
-0002ddb0: 2020 2020 2020 2020 2020 2020 7763 735f              wcs_
-0002ddc0: 692e 7073 6361 6c65 203d 2067 6574 5f77  i.pscale = get_w
-0002ddd0: 6373 5f70 7363 616c 6528 7763 735f 6929  cs_pscale(wcs_i)
-0002dde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ddf0: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0002de00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002de10: 2020 2020 2020 7072 696e 7428 6627 4661        print(f'Fa
-0002de20: 696c 6564 2074 6f20 696e 6974 6961 6c69  iled to initiali
-0002de30: 7a65 2057 4353 206f 6e20 7b66 696c 657d  ze WCS on {file}
-0002de40: 5b53 4349 2c7b 6578 747d 5d27 290a 2020  [SCI,{ext}]').  
-0002de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002de60: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-0002de70: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0002de80: 2020 2020 2020 2020 2020 2020 7763 7368              wcsh
-0002de90: 203d 2074 6f5f 6865 6164 6572 2877 6373   = to_header(wcs
-0002dea0: 5f69 290a 2020 2020 2020 2020 2020 2020  _i).            
-0002deb0: 2020 2020 726f 7720 3d20 5b66 696c 652c      row = [file,
-0002dec0: 2065 7874 2c20 6b65 7973 5b27 4558 5054   ext, keys['EXPT
-0002ded0: 494d 4527 5d5d 0a20 2020 2020 2020 2020  IME']].         
-0002dee0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002def0: 2020 2020 2020 2020 6966 2077 6373 5f63          if wcs_c
-0002df00: 6f6c 6e61 6d65 7320 6973 204e 6f6e 653a  olnames is None:
-0002df10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002df20: 2020 2020 2077 6373 5f63 6f6c 6e61 6d65       wcs_colname
-0002df30: 7320 3d20 5b27 6669 6c65 272c 2765 7874  s = ['file','ext
-0002df40: 272c 2765 7870 7469 6d65 275d 0a20 2020  ','exptime'].   
-0002df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002df60: 2066 6f72 206b 2069 6e20 7763 7368 3a0a   for k in wcsh:.
-0002df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002df80: 2020 2020 2020 2020 7763 735f 636f 6c6e          wcs_coln
-0002df90: 616d 6573 2e61 7070 656e 6428 6b2e 6c6f  ames.append(k.lo
-0002dfa0: 7765 7228 2929 0a20 2020 2020 2020 2020  wer()).         
-0002dfb0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0002dfc0: 6373 5f6b 6579 735b 6b2e 6c6f 7765 7228  cs_keys[k.lower(
-0002dfd0: 295d 203d 2077 6373 685b 6b5d 0a20 2020  )] = wcsh[k].   
+0002dd20: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0002dd30: 7367 203d 2027 2020 2020 2020 2050 484f  sg = '       PHO
+0002dd40: 5446 4c41 4d3d 7b30 3a2e 3265 7d2c 2073  TFLAM={0:.2e}, s
+0002dd50: 6361 6c65 3d7b 313a 2e33 667d 270a 2020  cale={1:.3f}'.  
+0002dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd70: 2020 6d73 6720 3d20 6d73 672e 666f 726d    msg = msg.form
+0002dd80: 6174 2868 5b27 5048 4f54 464c 414d 275d  at(h['PHOTFLAM']
+0002dd90: 2c20 7068 6f74 5f73 6361 6c65 290a 2020  , phot_scale).  
+0002dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ddb0: 2020 6c6f 675f 636f 6d6d 656e 7428 4c4f    log_comment(LO
+0002ddc0: 4746 494c 452c 206d 7367 2c20 7665 7262  GFILE, msg, verb
+0002ddd0: 6f73 653d 7665 7262 6f73 6529 0a20 2020  ose=verbose).   
+0002dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ddf0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0002de00: 2020 2020 2020 6b65 7973 5b27 5048 4f54        keys['PHOT
+0002de10: 464c 414d 275d 203d 2068 5b27 5048 4f54  FLAM'] = h['PHOT
+0002de20: 464c 414d 275d 0a20 2020 2020 2020 2020  FLAM'].         
+0002de30: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0002de40: 2069 6e20 5b27 5048 4f54 464c 414d 272c   in ['PHOTFLAM',
+0002de50: 2027 5048 4f54 504c 414d 272c 2027 5048   'PHOTPLAM', 'PH
+0002de60: 4f54 464e 5527 2c0a 2020 2020 2020 2020  OTFNU',.        
+0002de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de80: 2020 2020 2020 2750 484f 545a 5054 272c        'PHOTZPT',
+0002de90: 2027 5048 4f54 4257 272c 2027 5048 4f54   'PHOTBW', 'PHOT
+0002dea0: 4d4f 4445 272c 0a20 2020 2020 2020 2020  MODE',.         
+0002deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dec0: 2020 2020 2027 5048 4f54 4d4a 5352 272c       'PHOTMJSR',
+0002ded0: 2027 5049 5841 525f 5352 275d 3a0a 2020   'PIXAR_SR']:.  
+0002dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002def0: 2020 2020 2020 6966 206b 2069 6e20 683a        if k in h:
+0002df00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002df10: 2020 2020 2020 2020 2020 2020 206b 6579               key
+0002df20: 735b 6b5d 203d 2068 5b6b 5d0a 0a20 2020  s[k] = h[k]..   
+0002df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002df40: 2070 686f 745f 7363 616c 6520 2a3d 2074   phot_scale *= t
+0002df50: 6f5f 7065 725f 7365 630a 2020 2020 2020  o_per_sec.      
+0002df60: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0002df70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002df80: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0002df90: 2020 2020 2020 2020 7763 735f 6920 3d20          wcs_i = 
+0002dfa0: 7079 7763 732e 5743 5328 6865 6164 6572  pywcs.WCS(header
+0002dfb0: 3d66 6c74 5b28 2753 4349 272c 2065 7874  =flt[('SCI', ext
+0002dfc0: 295d 2e68 6561 6465 722c 200a 2020 2020  )].header, .    
+0002dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dff0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0002e000: 2020 2020 2020 666f 7220 6b20 696e 2077        for k in w
-0002e010: 6373 5f63 6f6c 6e61 6d65 735b 333a 5d3a  cs_colnames[3:]:
-0002e020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e030: 2020 2020 206b 7520 3d20 6b2e 7570 7065       ku = k.uppe
-0002e040: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-0002e050: 2020 2020 2020 2020 6966 206b 7520 6e6f          if ku no
-0002e060: 7420 696e 2077 6373 683a 0a20 2020 2020  t in wcsh:.     
-0002e070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e080: 2020 2070 7269 6e74 2866 274b 6579 776f     print(f'Keywo
-0002e090: 7264 207b 6b75 7d20 6e6f 7420 666f 756e  rd {ku} not foun
-0002e0a0: 6420 696e 2057 4353 2068 6561 6465 7227  d in WCS header'
-0002e0b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002e0c0: 2020 2020 2020 2020 2020 726f 772e 6170            row.ap
-0002e0d0: 7065 6e64 2877 6373 5f6b 6579 735b 6b5d  pend(wcs_keys[k]
-0002e0e0: 2a30 290a 2020 2020 2020 2020 2020 2020  *0).            
-0002e0f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e110: 2020 2020 2020 726f 772e 6170 7065 6e64        row.append
-0002e120: 2877 6373 685b 6b75 5d29 0a20 2020 2020  (wcsh[ku]).     
-0002e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e140: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0002e150: 2020 2020 666f 7220 6b20 696e 2077 6373      for k in wcs
-0002e160: 683a 0a20 2020 2020 2020 2020 2020 2020  h:.             
-0002e170: 2020 2020 2020 2069 6620 6b2e 6c6f 7765         if k.lowe
-0002e180: 7228 2920 6e6f 7420 696e 2077 6373 5f63  r() not in wcs_c
-0002e190: 6f6c 6e61 6d65 733a 0a20 2020 2020 2020  olnames:.       
-0002e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e1b0: 2070 7269 6e74 2866 2745 7874 7261 206b   print(f'Extra k
-0002e1c0: 6579 776f 7264 207b 6b75 7d20 666f 756e  eyword {ku} foun
-0002e1d0: 6420 696e 2057 4353 2068 6561 6465 7227  d in WCS header'
-0002e1e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002e1f0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-0002e200: 2020 2077 6373 5f72 6f77 732e 6170 7065     wcs_rows.appe
-0002e210: 6e64 2872 6f77 290a 2020 2020 2020 2020  nd(row).        
-0002e220: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0002e230: 2020 2020 2020 2020 2073 6369 5f6c 6973           sci_lis
-0002e240: 742e 6170 7065 6e64 2828 666c 745b 2827  t.append((flt[('
-0002e250: 5343 4927 2c20 6578 7429 5d2e 6461 7461  SCI', ext)].data
-0002e260: 202d 2073 6b79 292a 7068 6f74 5f73 6361   - sky)*phot_sca
-0002e270: 6c65 290a 0a20 2020 2020 2020 2020 2020  le)..           
-0002e280: 2020 2020 2065 7272 203d 2066 6c74 5b28       err = flt[(
-0002e290: 2745 5252 272c 2065 7874 295d 2e64 6174  'ERR', ext)].dat
-0002e2a0: 612a 7068 6f74 5f73 6361 6c65 0a20 2020  a*phot_scale.   
-0002e2b0: 2020 2020 2020 2020 2020 2020 2064 7120               dq 
-0002e2c0: 3d20 756e 7365 745f 6471 5f62 6974 7328  = unset_dq_bits(
-0002e2d0: 666c 745b 2827 4451 272c 2065 7874 295d  flt[('DQ', ext)]
-0002e2e0: 2e64 6174 612c 2062 6974 7329 207c 2062  .data, bits) | b
-0002e2f0: 7064 6174 610a 2020 2020 2020 2020 2020  pdata.          
-0002e300: 2020 2020 2020 7768 7420 3d20 312f 6572        wht = 1/er
-0002e310: 722a 2a32 0a20 2020 2020 2020 2020 2020  r**2.           
-0002e320: 2020 2020 2077 6874 5b28 6572 7220 3d3d       wht[(err ==
-0002e330: 2030 2920 7c20 2864 7120 3e20 3029 5d20   0) | (dq > 0)] 
-0002e340: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
-0002e350: 2020 2020 2077 6874 5f6c 6973 742e 6170       wht_list.ap
-0002e360: 7065 6e64 2877 6874 290a 0a20 2020 2020  pend(wht)..     
-0002e370: 2020 2020 2020 2020 2020 2023 2077 6373             # wcs
-0002e380: 5f69 203d 2048 5354 5743 5328 666f 626a  _i = HSTWCS(fobj
-0002e390: 3d66 6c74 2c20 6578 743d 2827 5343 4927  =flt, ext=('SCI'
-0002e3a0: 2c65 7874 292c 206d 696e 6572 723d 302e  ,ext), minerr=0.
-0002e3b0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-0002e3c0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-0002e3d0: 2020 2020 7763 736b 6579 3d27 2027 290a      wcskey=' ').
-0002e3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3f0: 6966 206e 6f74 2068 6173 6174 7472 2877  if not hasattr(w
-0002e400: 6373 5f69 2c20 2770 6978 656c 5f73 6861  cs_i, 'pixel_sha
-0002e410: 7065 2729 3a0a 2020 2020 2020 2020 2020  pe'):.          
-0002e420: 2020 2020 2020 2020 2020 7763 735f 692e            wcs_i.
-0002e430: 7069 7865 6c5f 7368 6170 6520 3d20 7763  pixel_shape = wc
-0002e440: 735f 692e 5f6e 6178 6973 312c 2077 6373  s_i._naxis1, wcs
-0002e450: 5f69 2e5f 6e61 7869 7332 0a0a 2020 2020  _i._naxis2..    
-0002e460: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002e470: 6f74 2068 6173 6174 7472 2877 6373 5f69  ot hasattr(wcs_i
-0002e480: 2c20 275f 6e61 7869 7331 2729 3a0a 2020  , '_naxis1'):.  
-0002e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4a0: 2020 7763 735f 692e 5f6e 6178 6973 312c    wcs_i._naxis1,
-0002e4b0: 2077 6373 5f69 2e5f 6e61 7869 7332 203d   wcs_i._naxis2 =
-0002e4c0: 2077 6373 5f69 2e5f 6e61 7869 730a 0a20   wcs_i._naxis.. 
-0002e4d0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0002e4e0: 6373 5f6c 6973 742e 6170 7065 6e64 2877  cs_list.append(w
-0002e4f0: 6373 5f69 290a 0a20 2020 2020 2020 2069  cs_i)..        i
-0002e500: 6620 636f 756e 7420 3d3d 2030 3a0a 2020  f count == 0:.  
-0002e510: 2020 2020 2020 2020 2020 7265 7320 3d20            res = 
-0002e520: 6472 697a 7a6c 655f 6172 7261 795f 6772  drizzle_array_gr
-0002e530: 6f75 7073 2873 6369 5f6c 6973 742c 2077  oups(sci_list, w
-0002e540: 6874 5f6c 6973 742c 2077 6373 5f6c 6973  ht_list, wcs_lis
-0002e550: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0002e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e570: 2020 2020 2020 2020 6f75 7470 7574 7763          outputwc
-0002e580: 733d 6f75 7470 7574 7763 732c 0a20 2020  s=outputwcs,.   
-0002e590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5b0: 2020 7363 616c 653d 302e 312c 206b 6572    scale=0.1, ker
-0002e5c0: 6e65 6c3d 6b65 726e 656c 2c0a 2020 2020  nel=kernel,.    
-0002e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5f0: 2070 6978 6672 6163 3d70 6978 6672 6163   pixfrac=pixfrac
-0002e600: 2c20 6361 6c63 5f77 6373 6d61 703d 6361  , calc_wcsmap=ca
-0002e610: 6c63 5f77 6373 6d61 702c 0a20 2020 2020  lc_wcsmap,.     
-0002e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e640: 7665 7262 6f73 653d 7665 7262 6f73 652c  verbose=verbose,
-0002e650: 2064 6174 613d 4e6f 6e65 290a 0a20 2020   data=None)..   
-0002e660: 2020 2020 2020 2020 206f 7574 7363 692c           outsci,
-0002e670: 206f 7574 7768 742c 206f 7574 6374 782c   outwht, outctx,
-0002e680: 2068 6561 6465 722c 2078 6f75 7477 6373   header, xoutwcs
-0002e690: 203d 2072 6573 0a20 2020 2020 2020 2020   = res.         
-0002e6a0: 2020 2068 6561 6465 725b 2745 5850 5449     header['EXPTI
-0002e6b0: 4d45 275d 203d 2066 6c74 5b30 5d2e 6865  ME'] = flt[0].he
-0002e6c0: 6164 6572 5b27 4558 5054 494d 4527 5d0a  ader['EXPTIME'].
-0002e6d0: 2020 2020 2020 2020 2020 2020 6865 6164              head
-0002e6e0: 6572 5b27 4e44 5249 5a49 4d27 5d20 3d20  er['NDRIZIM'] = 
-0002e6f0: 310a 2020 2020 2020 2020 2020 2020 6865  1.            he
-0002e700: 6164 6572 5b27 5049 5846 5241 4327 5d20  ader['PIXFRAC'] 
-0002e710: 3d20 7069 7866 7261 630a 2020 2020 2020  = pixfrac.      
-0002e720: 2020 2020 2020 6865 6164 6572 5b27 4b45        header['KE
-0002e730: 524e 454c 275d 203d 206b 6572 6e65 6c0a  RNEL'] = kernel.
-0002e740: 2020 2020 2020 2020 2020 2020 6865 6164              head
-0002e750: 6572 5b27 4f4b 4249 5453 275d 203d 2028  er['OKBITS'] = (
-0002e760: 6269 7473 2c20 2246 4c54 2062 6974 7320  bits, "FLT bits 
-0002e770: 7472 6561 7465 6420 6173 2076 616c 6964  treated as valid
-0002e780: 2229 0a20 2020 2020 2020 2020 2020 2068  ").            h
-0002e790: 6561 6465 725b 2750 484f 5453 4341 4c27  eader['PHOTSCAL'
-0002e7a0: 5d20 3d20 5f73 6361 6c65 5f70 686f 746f  ] = _scale_photo
-0002e7b0: 6d2c 2027 5363 616c 6520 6661 6374 6f72  m, 'Scale factor
-0002e7c0: 2061 7070 6c69 6564 270a 2020 2020 2020   applied'.      
-0002e7d0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0002e7e0: 2020 2068 6561 6465 725b 2747 5249 5a4c     header['GRIZL
-0002e7f0: 4956 275d 203d 2067 7269 7a6c 695f 5f76  IV'] = grizli__v
-0002e800: 6572 7369 6f6e 2c20 2747 7269 7a6c 6920  ersion, 'Grizli 
-0002e810: 636f 6465 2076 6572 7369 6f6e 270a 2020  code version'.  
-0002e820: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0002e830: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
-0002e840: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0002e850: 2020 2020 2020 6865 6164 6572 5b6b 5d20        header[k] 
-0002e860: 3d20 6b65 7973 5b6b 5d0a 0a20 2020 2020  = keys[k]..     
-0002e870: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002e880: 2020 2020 2064 6174 6120 3d20 6f75 7473       data = outs
-0002e890: 6369 2c20 6f75 7477 6874 2c20 6f75 7463  ci, outwht, outc
-0002e8a0: 7478 0a20 2020 2020 2020 2020 2020 2072  tx.            r
-0002e8b0: 6573 203d 2064 7269 7a7a 6c65 5f61 7272  es = drizzle_arr
-0002e8c0: 6179 5f67 726f 7570 7328 7363 695f 6c69  ay_groups(sci_li
-0002e8d0: 7374 2c20 7768 745f 6c69 7374 2c20 7763  st, wht_list, wc
-0002e8e0: 735f 6c69 7374 2c0a 2020 2020 2020 2020  s_list,.        
-0002e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e900: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0002e910: 7075 7477 6373 3d6f 7574 7075 7477 6373  putwcs=outputwcs
-0002e920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e940: 2020 2020 2020 2073 6361 6c65 3d30 2e31         scale=0.1
-0002e950: 2c20 6b65 726e 656c 3d6b 6572 6e65 6c2c  , kernel=kernel,
-0002e960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e980: 2020 2020 2020 7069 7866 7261 633d 7069        pixfrac=pi
-0002e990: 7866 7261 632c 2063 616c 635f 7763 736d  xfrac, calc_wcsm
-0002e9a0: 6170 3d63 616c 635f 7763 736d 6170 2c0a  ap=calc_wcsmap,.
-0002e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e9d0: 2020 2020 2076 6572 626f 7365 3d76 6572       verbose=ver
-0002e9e0: 626f 7365 2c20 6461 7461 3d64 6174 6129  bose, data=data)
-0002e9f0: 0a0a 2020 2020 2020 2020 2020 2020 6f75  ..            ou
-0002ea00: 7473 6369 2c20 6f75 7477 6874 2c20 6f75  tsci, outwht, ou
-0002ea10: 7463 7478 203d 2072 6573 5b3a 335d 0a20  tctx = res[:3]. 
-0002ea20: 2020 2020 2020 2020 2020 2068 6561 6465             heade
-0002ea30: 725b 2745 5850 5449 4d45 275d 202b 3d20  r['EXPTIME'] += 
-0002ea40: 666c 745b 305d 2e68 6561 6465 725b 2745  flt[0].header['E
-0002ea50: 5850 5449 4d45 275d 0a20 2020 2020 2020  XPTIME'].       
-0002ea60: 2020 2020 2068 6561 6465 725b 274e 4452       header['NDR
-0002ea70: 495a 494d 275d 202b 3d20 310a 0a20 2020  IZIM'] += 1..   
-0002ea80: 2020 2020 2063 6f75 6e74 202b 3d20 310a       count += 1.
-0002ea90: 2020 2020 2020 2020 6865 6164 6572 5b27          header['
-0002eaa0: 464c 547b 303a 3035 647d 272e 666f 726d  FLT{0:05d}'.form
-0002eab0: 6174 2863 6f75 6e74 295d 203d 2066 696c  at(count)] = fil
-0002eac0: 650a 2020 2020 2020 2020 0a20 2020 2020  e.        .     
-0002ead0: 2020 2066 6c74 2e63 6c6f 7365 2829 0a20     flt.close(). 
-0002eae0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0002eaf0: 2378 6669 6c65 7320 3d20 676c 6f62 2e67  #xfiles = glob.g
-0002eb00: 6c6f 6228 272a 2729 0a20 2020 2020 2020  lob('*').       
-0002eb10: 2023 7072 696e 7428 2743 6c65 616e 3a20   #print('Clean: 
-0002eb20: 272c 2063 6c65 616e 2c20 7866 696c 6573  ', clean, xfiles
-0002eb30: 290a 2020 2020 2020 2020 6966 2063 6c65  ).        if cle
-0002eb40: 616e 3a0a 2020 2020 2020 2020 2020 2020  an:.            
-0002eb50: 6f73 2e72 656d 6f76 6528 6669 6c65 290a  os.remove(file).
-0002eb60: 0a20 2020 2069 6620 2761 7773 7061 7468  .    if 'awspath
-0002eb70: 2720 696e 2076 6973 6974 3a0a 2020 2020  ' in visit:.    
-0002eb80: 2020 2020 6177 7370 6174 6820 3d20 7669      awspath = vi
-0002eb90: 7369 745b 2761 7773 7061 7468 275d 0a20  sit['awspath']. 
-0002eba0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002ebb0: 2061 7773 7061 7468 203d 205b 272e 2720   awspath = ['.' 
-0002ebc0: 666f 7220 6620 696e 2076 6973 6974 5b27  for f in visit['
-0002ebd0: 6669 6c65 7327 5d5d 0a0a 2020 2020 6966  files']]..    if
-0002ebe0: 206c 656e 2861 7773 7061 7468 2920 3d3d   len(awspath) ==
-0002ebf0: 2031 3a0a 2020 2020 2020 2020 6177 7370   1:.        awsp
-0002ec00: 6174 6820 3d20 5b61 7773 7061 7468 5b30  ath = [awspath[0
-0002ec10: 5d20 666f 7220 6620 696e 2076 6973 6974  ] for f in visit
-0002ec20: 5b27 6669 6c65 7327 5d5d 0a20 2020 2065  ['files']].    e
-0002ec30: 6c69 6620 6973 696e 7374 616e 6365 2861  lif isinstance(a
-0002ec40: 7773 7061 7468 2c20 7374 7229 3a0a 2020  wspath, str):.  
-0002ec50: 2020 2020 2020 5f61 7773 7061 7468 203d        _awspath =
-0002ec60: 205b 6177 7370 6174 6820 666f 7220 6620   [awspath for f 
-0002ec70: 696e 2076 6973 6974 5b27 6669 6c65 7327  in visit['files'
-0002ec80: 5d5d 0a20 2020 2020 2020 2061 7773 7061  ]].        awspa
-0002ec90: 7468 203d 205f 6177 7370 6174 680a 0a20  th = _awspath.. 
-0002eca0: 2020 2066 6c69 7374 203d 205b 277b 307d     flist = ['{0}
-0002ecb0: 2f7b 317d 272e 666f 726d 6174 2861 7773  /{1}'.format(aws
-0002ecc0: 7061 7468 2c20 7669 7369 745b 2766 696c  path, visit['fil
-0002ecd0: 6573 275d 5b69 5d29 0a20 2020 2020 2020  es'][i]).       
-0002ece0: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-0002ecf0: 6e20 696e 6469 6365 735d 0a20 2020 200a  n indices].    .
-0002ed00: 2020 2020 6966 2064 7279 7275 6e3a 0a20      if dryrun:. 
-0002ed10: 2020 2020 2020 2072 6574 7572 6e20 666c         return fl
-0002ed20: 6973 740a 0a20 2020 2065 6c69 6620 636f  ist..    elif co
-0002ed30: 756e 7420 3d3d 2030 3a0a 2020 2020 2020  unt == 0:.      
-0002ed40: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-0002ed50: 2020 2065 6c73 653a 2020 2020 2020 2020     else:        
-0002ed60: 0a20 2020 2020 2020 2077 6373 5f74 6162  .        wcs_tab
-0002ed70: 203d 2047 5461 626c 6528 6e61 6d65 733d   = GTable(names=
-0002ed80: 7763 735f 636f 6c6e 616d 6573 2c20 726f  wcs_colnames, ro
-0002ed90: 7773 3d77 6373 5f72 6f77 7329 0a20 2020  ws=wcs_rows).   
-0002eda0: 2020 2020 200a 2020 2020 2020 2020 6f75       .        ou
-0002edb0: 7477 6874 202a 3d20 2877 6373 5f69 2e70  twht *= (wcs_i.p
-0002edc0: 7363 616c 652f 6f75 7470 7574 7763 732e  scale/outputwcs.
-0002edd0: 7073 6361 6c65 292a 2a34 0a20 2020 2020  pscale)**4.     
-0002ede0: 2020 2072 6574 7572 6e20 6f75 7473 6369     return outsci
-0002edf0: 2c20 6f75 7477 6874 2c20 6865 6164 6572  , outwht, header
-0002ee00: 2c20 666c 6973 742c 2077 6373 5f74 6162  , flist, wcs_tab
-0002ee10: 0a0a 0a64 6566 2064 7269 7a7a 6c65 5f61  ...def drizzle_a
-0002ee20: 7272 6179 5f67 726f 7570 7328 7363 695f  rray_groups(sci_
-0002ee30: 6c69 7374 2c20 7768 745f 6c69 7374 2c20  list, wht_list, 
-0002ee40: 7763 735f 6c69 7374 2c20 6f75 7470 7574  wcs_list, output
-0002ee50: 7763 733d 4e6f 6e65 2c0a 2020 2020 2020  wcs=None,.      
-0002ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ee70: 2020 2073 6361 6c65 3d30 2e31 2c20 6b65     scale=0.1, ke
-0002ee80: 726e 656c 3d27 706f 696e 7427 2c20 7069  rnel='point', pi
-0002ee90: 7866 7261 633d 312e 2c0a 2020 2020 2020  xfrac=1.,.      
-0002eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eeb0: 2020 2063 616c 635f 7763 736d 6170 3d46     calc_wcsmap=F
-0002eec0: 616c 7365 2c20 7665 7262 6f73 653d 5472  alse, verbose=Tr
-0002eed0: 7565 2c20 6461 7461 3d4e 6f6e 6529 3a0a  ue, data=None):.
-0002eee0: 2020 2020 2222 2244 7269 7a7a 6c65 2061      """Drizzle a
-0002eef0: 7272 6179 2064 6174 6120 7769 7468 2061  rray data with a
-0002ef00: 7373 6f63 6961 7465 6420 7763 730a 0a20  ssociated wcs.. 
-0002ef10: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0002ef20: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0002ef30: 2073 6369 5f6c 6973 742c 2077 6874 5f6c   sci_list, wht_l
-0002ef40: 6973 7420 3a20 6c69 7374 0a20 2020 2020  ist : list.     
-0002ef50: 2020 204c 6973 7420 6f66 2073 6369 656e     List of scien
-0002ef60: 6365 2061 6e64 2077 6569 6768 7420 607e  ce and weight `~
-0002ef70: 6e75 6d70 792e 6e64 6172 7261 7960 206f  numpy.ndarray` o
-0002ef80: 626a 6563 7473 2e0a 0a20 2020 2077 6373  bjects...    wcs
-0002ef90: 5f6c 6973 7420 3a20 6c69 7374 0a0a 2020  _list : list..  
-0002efa0: 2020 7363 616c 6520 3a20 666c 6f61 740a    scale : float.
-0002efb0: 2020 2020 2020 2020 4f75 7470 7574 2070          Output p
-0002efc0: 6978 656c 2073 6361 6c65 2069 6e20 6172  ixel scale in ar
-0002efd0: 6373 6563 2e0a 0a20 2020 206b 6572 6e65  csec...    kerne
-0002efe0: 6c2c 2070 6978 6672 6163 203a 2073 7472  l, pixfrac : str
-0002eff0: 2c20 666c 6f61 740a 2020 2020 2020 2020  , float.        
-0002f000: 4472 697a 7a6c 6520 7061 7261 6d65 7465  Drizzle paramete
-0002f010: 7273 0a0a 2020 2020 7665 7262 6f73 6520  rs..    verbose 
-0002f020: 3a20 626f 6f6c 0a20 2020 2020 2020 2050  : bool.        P
-0002f030: 7269 6e74 2073 7461 7475 7320 6d65 7373  rint status mess
-0002f040: 6167 6573 0a0a 2020 2020 5265 7475 726e  ages..    Return
-0002f050: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0002f060: 2020 6f75 7473 6369 2c20 6f75 7477 6874    outsci, outwht
-0002f070: 2c20 6f75 7463 7478 203a 2060 7e6e 756d  , outctx : `~num
-0002f080: 7079 2e6e 6461 7272 6179 600a 2020 2020  py.ndarray`.    
-0002f090: 2020 2020 4f75 7470 7574 2064 7269 7a7a      Output drizz
-0002f0a0: 6c65 6420 7363 6965 6e63 652c 2077 6569  led science, wei
-0002f0b0: 6768 7420 616e 6420 636f 6e74 6578 7420  ght and context 
-0002f0c0: 696d 6167 6573 0a0a 2020 2020 6865 6164  images..    head
-0002f0d0: 6572 2c20 6f75 7470 7574 7763 7320 3a20  er, outputwcs : 
-0002f0e0: 607e 6173 7472 6f70 792e 6669 7473 2e69  `~astropy.fits.i
-0002f0f0: 6f2e 4865 6164 6572 602c 2060 7e61 7374  o.Header`, `~ast
-0002f100: 726f 7079 2e77 6373 2e57 4353 600a 2020  ropy.wcs.WCS`.  
-0002f110: 2020 2020 2020 4472 697a 7a6c 6564 2069        Drizzled i
-0002f120: 6d61 6765 2068 6561 6465 7220 616e 6420  mage header and 
-0002f130: 5743 532e 0a0a 2020 2020 2222 220a 2020  WCS...    """.  
-0002f140: 2020 6672 6f6d 2064 7269 7a7a 6c65 7061    from drizzlepa
-0002f150: 6320 696d 706f 7274 2061 6472 697a 7a6c  c import adrizzl
-0002f160: 650a 2020 2020 6672 6f6d 2064 7269 7a7a  e.    from drizz
-0002f170: 6c65 7061 6320 696d 706f 7274 2063 6472  lepac import cdr
-0002f180: 697a 0a0a 2020 2020 2366 726f 6d20 7374  iz..    #from st
-0002f190: 7363 692e 746f 6f6c 7320 696d 706f 7274  sci.tools import
-0002f1a0: 206c 6f67 7574 696c 0a20 2020 2023 6c6f   logutil.    #lo
-0002f1b0: 6720 3d20 6c6f 6775 7469 6c2e 6372 6561  g = logutil.crea
-0002f1c0: 7465 5f6c 6f67 6765 7228 5f5f 6e61 6d65  te_logger(__name
-0002f1d0: 5f5f 290a 0a20 2020 2023 204f 7574 7075  __)..    # Outpu
-0002f1e0: 7420 6865 6164 6572 202f 2057 4353 0a20  t header / WCS. 
-0002f1f0: 2020 2069 6620 6f75 7470 7574 7763 7320     if outputwcs 
-0002f200: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0002f210: 2023 6865 6164 6572 2c20 6f75 7470 7574   #header, output
-0002f220: 7763 7320 3d20 636f 6d70 7574 655f 6f75  wcs = compute_ou
-0002f230: 7470 7574 5f77 6373 2877 6373 5f6c 6973  tput_wcs(wcs_lis
-0002f240: 742c 2070 6978 656c 5f73 6361 6c65 3d73  t, pixel_scale=s
-0002f250: 6361 6c65 290a 2020 2020 2020 2020 6865  cale).        he
-0002f260: 6164 6572 2c20 6f75 7470 7574 7763 7320  ader, outputwcs 
-0002f270: 3d20 6d61 6b65 5f6d 6178 696d 616c 5f77  = make_maximal_w
-0002f280: 6373 2877 6373 5f6c 6973 742c 0a20 2020  cs(wcs_list,.   
-0002f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2b0: 2020 2020 2020 2020 2020 7069 7865 6c5f            pixel_
-0002f2c0: 7363 616c 653d 7363 616c 652c 0a20 2020  scale=scale,.   
-0002f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2f0: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-0002f300: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
-0002f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f330: 2020 2020 2020 7061 643d 302c 0a20 2020        pad=0,.   
-0002f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f360: 2020 2020 2020 2020 2020 6765 745f 6864            get_hd
-0002f370: 753d 4661 6c73 6529 0a20 2020 2065 6c73  u=False).    els
-0002f380: 653a 0a20 2020 2020 2020 2068 6561 6465  e:.        heade
-0002f390: 7220 3d20 746f 5f68 6561 6465 7228 6f75  r = to_header(ou
-0002f3a0: 7470 7574 7763 7329 0a0a 2020 2020 6865  tputwcs)..    he
-0002f3b0: 6164 6572 5b27 4452 495a 4b45 524e 275d  ader['DRIZKERN']
-0002f3c0: 203d 206b 6572 6e65 6c2c 2022 4472 697a   = kernel, "Driz
-0002f3d0: 7a6c 6520 6b65 726e 656c 220a 2020 2020  zle kernel".    
-0002f3e0: 6865 6164 6572 5b27 4452 495a 5049 5846  header['DRIZPIXF
-0002f3f0: 275d 203d 2070 6978 6672 6163 2c20 2244  '] = pixfrac, "D
-0002f400: 7269 7a7a 6c65 2070 6978 6672 6163 220a  rizzle pixfrac".
-0002f410: 0a20 2020 2069 6620 6e6f 7420 6861 7361  .    if not hasa
-0002f420: 7474 7228 6f75 7470 7574 7763 732c 2027  ttr(outputwcs, '
-0002f430: 5f6e 6178 6973 3127 293a 0a20 2020 2020  _naxis1'):.     
-0002f440: 2020 206f 7574 7075 7477 6373 2e5f 6e61     outputwcs._na
-0002f450: 7869 7331 2c20 6f75 7470 7574 7763 732e  xis1, outputwcs.
-0002f460: 5f6e 6178 6973 3220 3d20 6f75 7470 7574  _naxis2 = output
-0002f470: 7763 732e 5f6e 6178 6973 0a0a 2020 2020  wcs._naxis..    
-0002f480: 2320 5472 7920 746f 2066 6978 2064 6570  # Try to fix dep
-0002f490: 7265 6361 7465 6420 5743 530a 2020 2020  recated WCS.    
-0002f4a0: 666f 7220 7763 735f 6920 696e 2077 6373  for wcs_i in wcs
-0002f4b0: 5f6c 6973 743a 0a20 2020 2020 2020 2069  _list:.        i
-0002f4c0: 6620 6e6f 7420 6861 7361 7474 7228 7763  f not hasattr(wc
-0002f4d0: 735f 692c 2027 7069 7865 6c5f 7368 6170  s_i, 'pixel_shap
-0002f4e0: 6527 293a 0a20 2020 2020 2020 2020 2020  e'):.           
-0002f4f0: 2077 6373 5f69 2e70 6978 656c 5f73 6861   wcs_i.pixel_sha
-0002f500: 7065 203d 2077 6373 5f69 2e5f 6e61 7869  pe = wcs_i._naxi
-0002f510: 7331 2c20 7763 735f 692e 5f6e 6178 6973  s1, wcs_i._naxis
-0002f520: 320a 0a20 2020 2020 2020 2069 6620 6e6f  2..        if no
-0002f530: 7420 6861 7361 7474 7228 7763 735f 692c  t hasattr(wcs_i,
-0002f540: 2027 5f6e 6178 6973 3127 293a 0a20 2020   '_naxis1'):.   
-0002f550: 2020 2020 2020 2020 2077 6373 5f69 2e5f           wcs_i._
-0002f560: 6e61 7869 7331 2c20 7763 735f 692e 5f6e  naxis1, wcs_i._n
-0002f570: 6178 6973 3220 3d20 7763 735f 692e 5f6e  axis2 = wcs_i._n
-0002f580: 6178 6973 5b3a 325d 0a0a 2020 2020 2320  axis[:2]..    # 
-0002f590: 4f75 7470 7574 2057 4353 2072 6571 7569  Output WCS requi
-0002f5a0: 7265 7320 6675 6c6c 2057 4353 206d 6170  res full WCS map
-0002f5b0: 3f0a 2020 2020 6966 2063 616c 635f 7763  ?.    if calc_wc
-0002f5c0: 736d 6170 203c 2032 3a0a 2020 2020 2020  smap < 2:.      
-0002f5d0: 2020 6374 7970 6520 3d20 6f75 7470 7574    ctype = output
-0002f5e0: 7763 732e 7763 732e 6374 7970 650a 2020  wcs.wcs.ctype.  
-0002f5f0: 2020 2020 2020 6966 2027 2d53 4950 2720        if '-SIP' 
-0002f600: 696e 2063 7479 7065 5b30 5d3a 0a20 2020  in ctype[0]:.   
-0002f610: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-0002f620: 4f75 7470 7574 2057 4353 2028 7b30 7d29  Output WCS ({0})
-0002f630: 2072 6571 7569 7265 7320 6063 616c 635f   requires `calc_
-0002f640: 7763 736d 6170 3d32 6027 2e66 6f72 6d61  wcsmap=2`'.forma
-0002f650: 7428 6374 7970 6529 290a 2020 2020 2020  t(ctype)).      
-0002f660: 2020 2020 2020 6361 6c63 5f77 6373 6d61        calc_wcsma
-0002f670: 7020 3d20 320a 2020 2020 2020 2020 656c  p = 2.        el
-0002f680: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002f690: 2320 496e 7465 726e 616c 2057 4353 4d41  # Internal WCSMA
-0002f6a0: 5020 6e6f 7420 7265 7175 6972 6564 0a20  P not required. 
-0002f6b0: 2020 2020 2020 2020 2020 2063 616c 635f             calc_
-0002f6c0: 7763 736d 6170 203d 2030 0a0a 2020 2020  wcsmap = 0..    
-0002f6d0: 7368 6170 6520 3d20 2868 6561 6465 725b  shape = (header[
-0002f6e0: 274e 4158 4953 3227 5d2c 2068 6561 6465  'NAXIS2'], heade
-0002f6f0: 725b 274e 4158 4953 3127 5d29 0a0a 2020  r['NAXIS1'])..  
-0002f700: 2020 2320 4f75 7470 7574 2061 7272 6179    # Output array
-0002f710: 730a 2020 2020 6966 2064 6174 6120 6973  s.    if data is
-0002f720: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0002f730: 2020 206f 7574 7363 692c 206f 7574 7768     outsci, outwh
-0002f740: 742c 206f 7574 6374 7820 3d20 6461 7461  t, outctx = data
-0002f750: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0002f760: 2020 206f 7574 7363 6920 3d20 6e70 2e7a     outsci = np.z
-0002f770: 6572 6f73 2873 6861 7065 2c20 6474 7970  eros(shape, dtyp
-0002f780: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
-0002f790: 2020 2020 2020 6f75 7477 6874 203d 206e        outwht = n
-0002f7a0: 702e 7a65 726f 7328 7368 6170 652c 2064  p.zeros(shape, d
-0002f7b0: 7479 7065 3d6e 702e 666c 6f61 7433 3229  type=np.float32)
-0002f7c0: 0a20 2020 2020 2020 206f 7574 6374 7820  .        outctx 
-0002f7d0: 3d20 6e70 2e7a 6572 6f73 2873 6861 7065  = np.zeros(shape
-0002f7e0: 2c20 6474 7970 653d 6e70 2e69 6e74 3332  , dtype=np.int32
-0002f7f0: 290a 0a20 2020 2023 2044 6f20 6472 697a  )..    # Do driz
-0002f800: 7a6c 650a 2020 2020 4e20 3d20 6c65 6e28  zle.    N = len(
-0002f810: 7363 695f 6c69 7374 290a 2020 2020 666f  sci_list).    fo
-0002f820: 7220 6920 696e 2072 616e 6765 284e 293a  r i in range(N):
-0002f830: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-0002f840: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0002f850: 2023 6c6f 672e 696e 666f 2827 4472 697a   #log.info('Driz
-0002f860: 7a6c 6520 6172 7261 7920 7b30 7d2f 7b31  zle array {0}/{1
-0002f870: 7d27 2e66 6f72 6d61 7428 692b 312c 204e  }'.format(i+1, N
-0002f880: 2929 0a20 2020 2020 2020 2020 2020 206d  )).            m
-0002f890: 7367 203d 2027 4472 697a 7a6c 6520 6172  sg = 'Drizzle ar
-0002f8a0: 7261 7920 7b30 7d2f 7b31 7d27 2e66 6f72  ray {0}/{1}'.for
-0002f8b0: 6d61 7428 692b 312c 204e 290a 2020 2020  mat(i+1, N).    
-0002f8c0: 2020 2020 2020 2020 6c6f 675f 636f 6d6d          log_comm
-0002f8d0: 656e 7428 4c4f 4746 494c 452c 206d 7367  ent(LOGFILE, msg
-0002f8e0: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
-0002f8f0: 652c 2073 686f 775f 6461 7465 3d54 7275  e, show_date=Tru
-0002f900: 6529 0a0a 2020 2020 2020 2020 6966 2063  e)..        if c
-0002f910: 616c 635f 7763 736d 6170 203e 2031 3a0a  alc_wcsmap > 1:.
-0002f920: 2020 2020 2020 2020 2020 2020 7763 736d              wcsm
-0002f930: 6170 203d 2057 4353 4d61 7041 6c6c 2020  ap = WCSMapAll  
-0002f940: 2320 2877 6373 5f6c 6973 745b 695d 2c20  # (wcs_list[i], 
-0002f950: 6f75 7470 7574 7763 7329 0a20 2020 2020  outputwcs).     
-0002f960: 2020 2020 2020 2023 7763 736d 6170 203d         #wcsmap =
-0002f970: 2063 6472 697a 2e44 6566 6175 6c74 5743   cdriz.DefaultWC
-0002f980: 534d 6170 7069 6e67 0a20 2020 2020 2020  SMapping.       
-0002f990: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002f9a0: 2020 2077 6373 6d61 7020 3d20 4e6f 6e65     wcsmap = None
-0002f9b0: 0a0a 2020 2020 2020 2020 6164 7269 7a7a  ..        adrizz
-0002f9c0: 6c65 2e64 6f5f 6472 697a 2873 6369 5f6c  le.do_driz(sci_l
-0002f9d0: 6973 745b 695d 2e61 7374 7970 6528 6e70  ist[i].astype(np
-0002f9e0: 2e66 6c6f 6174 3332 2c20 636f 7079 3d46  .float32, copy=F
-0002f9f0: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
-0002fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa10: 7763 735f 6c69 7374 5b69 5d2c 0a20 2020  wcs_list[i],.   
-0002fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa30: 2020 2020 2020 7768 745f 6c69 7374 5b69        wht_list[i
-0002fa40: 5d2e 6173 7479 7065 286e 702e 666c 6f61  ].astype(np.floa
-0002fa50: 7433 322c 2063 6f70 793d 4661 6c73 6529  t32, copy=False)
-0002fa60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002fa70: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-0002fa80: 7477 6373 2c20 6f75 7473 6369 2c20 6f75  twcs, outsci, ou
-0002fa90: 7477 6874 2c20 6f75 7463 7478 2c20 312e  twht, outctx, 1.
-0002faa0: 2c20 2763 7073 272c 2031 2c0a 2020 2020  , 'cps', 1,.    
-0002fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fac0: 2020 2020 2077 6373 6c69 6e5f 7073 6361       wcslin_psca
-0002fad0: 6c65 3d77 6373 5f6c 6973 745b 695d 2e70  le=wcs_list[i].p
-0002fae0: 7363 616c 652c 2075 6e69 7169 643d 312c  scale, uniqid=1,
-0002faf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fb00: 2020 2020 2020 2020 2020 7069 7866 7261            pixfra
-0002fb10: 633d 7069 7866 7261 632c 206b 6572 6e65  c=pixfrac, kerne
-0002fb20: 6c3d 6b65 726e 656c 2c20 6669 6c6c 7661  l=kernel, fillva
-0002fb30: 6c3d 2730 272c 0a20 2020 2020 2020 2020  l='0',.         
-0002fb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb50: 7763 736d 6170 3d77 6373 6d61 7029 0a0a  wcsmap=wcsmap)..
-0002fb60: 2020 2020 7265 7475 726e 206f 7574 7363      return outsc
-0002fb70: 692c 206f 7574 7768 742c 206f 7574 6374  i, outwht, outct
-0002fb80: 782c 2068 6561 6465 722c 206f 7574 7075  x, header, outpu
-0002fb90: 7477 6373 0a0a 0a63 6c61 7373 2057 4353  twcs...class WCS
-0002fba0: 4d61 7041 6c6c 3a0a 2020 2020 2222 2220  MapAll:.    """ 
-0002fbb0: 5361 6d70 6c65 2063 6c61 7373 2074 6f20  Sample class to 
-0002fbc0: 6465 6d6f 6e73 7472 6174 6520 686f 7720  demonstrate how 
-0002fbd0: 746f 2064 6566 696e 6520 6120 636f 6f72  to define a coor
-0002fbe0: 6469 6e61 7465 2074 7261 6e73 666f 726d  dinate transform
-0002fbf0: 6174 696f 6e0a 2020 2020 2222 220a 0a20  ation.    """.. 
-0002fc00: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-0002fc10: 7365 6c66 2c20 696e 7075 742c 206f 7574  self, input, out
-0002fc20: 7075 742c 206f 7269 6769 6e3d 3029 3a0a  put, origin=0):.
-0002fc30: 2020 2020 2020 2020 2320 5665 7269 6679          # Verify
-0002fc40: 2074 6861 7420 7765 2068 6176 6520 7661   that we have va
-0002fc50: 6c69 6420 5743 5320 696e 7075 7420 6f62  lid WCS input ob
-0002fc60: 6a65 6374 730a 2020 2020 2020 2020 696d  jects.        im
-0002fc70: 706f 7274 2063 6f70 790a 2020 2020 2020  port copy.      
-0002fc80: 2020 7365 6c66 2e63 6865 636b 5743 5328    self.checkWCS(
-0002fc90: 696e 7075 742c 2027 496e 7075 7427 290a  input, 'Input').
-0002fca0: 2020 2020 2020 2020 7365 6c66 2e63 6865          self.che
-0002fcb0: 636b 5743 5328 6f75 7470 7574 2c20 274f  ckWCS(output, 'O
-0002fcc0: 7574 7075 7427 290a 0a20 2020 2020 2020  utput')..       
-0002fcd0: 2073 656c 662e 696e 7075 7420 3d20 696e   self.input = in
-0002fce0: 7075 740a 2020 2020 2020 2020 7365 6c66  put.        self
-0002fcf0: 2e6f 7574 7075 7420 3d20 636f 7079 2e64  .output = copy.d
-0002fd00: 6565 7063 6f70 7928 6f75 7470 7574 290a  eepcopy(output).
-0002fd10: 2020 2020 2020 2020 2373 656c 662e 6f75          #self.ou
-0002fd20: 7470 7574 203d 206f 7574 7075 740a 0a20  tput = output.. 
-0002fd30: 2020 2020 2020 2073 656c 662e 6f72 6967         self.orig
-0002fd40: 696e 203d 2031 2023 6f72 6967 696e 0a20  in = 1 #origin. 
-0002fd50: 2020 2020 2020 2073 656c 662e 7368 6966         self.shif
-0002fd60: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0002fd70: 2073 656c 662e 726f 7420 3d20 4e6f 6e65   self.rot = None
-0002fd80: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
-0002fd90: 616c 6520 3d20 4e6f 6e65 0a0a 2020 2020  ale = None..    
-0002fda0: 6465 6620 6368 6563 6b57 4353 2873 656c  def checkWCS(sel
-0002fdb0: 662c 206f 626a 2c20 6e61 6d65 293a 0a20  f, obj, name):. 
-0002fdc0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0002fdd0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0002fde0: 7369 6e73 7461 6e63 6528 6f62 6a2c 2070  sinstance(obj, p
-0002fdf0: 7977 6373 2e57 4353 290a 2020 2020 2020  ywcs.WCS).      
-0002fe00: 2020 6578 6365 7074 2041 7373 6572 7469    except Asserti
-0002fe10: 6f6e 4572 726f 723a 0a20 2020 2020 2020  onError:.       
-0002fe20: 2020 2020 2070 7269 6e74 286e 616d 6520       print(name 
-0002fe30: 2b20 2720 6f62 6a65 6374 206e 6565 6473  + ' object needs
-0002fe40: 2074 6f20 6265 2061 6e20 696e 7374 616e   to be an instan
-0002fe50: 6365 206f 7220 7375 6263 6c61 7373 206f  ce or subclass o
-0002fe60: 6620 6120 5079 5743 5320 6f62 6a65 6374  f a PyWCS object
-0002fe70: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-0002fe80: 7261 6973 650a 0a20 2020 2064 6566 2066  raise..    def f
-0002fe90: 6f72 7761 7264 2873 656c 662c 2070 6978  orward(self, pix
-0002fea0: 782c 2070 6978 7929 3a0a 2020 2020 2020  x, pixy):.      
-0002feb0: 2020 2222 2220 5472 616e 7366 6f72 6d20    """ Transform 
-0002fec0: 7468 6520 696e 7075 7420 7069 7878 2c70  the input pixx,p
-0002fed0: 6978 7920 706f 7369 7469 6f6e 7320 696e  ixy positions in
-0002fee0: 2074 6865 2069 6e70 7574 2066 7261 6d65   the input frame
-0002fef0: 0a20 2020 2020 2020 2020 2020 2074 6f20  .            to 
-0002ff00: 7069 7865 6c20 706f 7369 7469 6f6e 7320  pixel positions 
-0002ff10: 696e 2074 6865 206f 7574 7075 7420 6672  in the output fr
-0002ff20: 616d 652e 0a0a 2020 2020 2020 2020 2020  ame...          
-0002ff30: 2020 5468 6973 206d 6574 686f 6420 6765    This method ge
-0002ff40: 7473 2070 6173 7365 6420 746f 2074 6865  ts passed to the
-0002ff50: 2064 7269 7a7a 6c65 2061 6c67 6f72 6974   drizzle algorit
-0002ff60: 686d 2e0a 2020 2020 2020 2020 2222 220a  hm..        """.
-0002ff70: 2020 2020 2020 2020 2320 5468 6973 206d          # This m
-0002ff80: 6174 6368 6573 2057 5452 4158 5920 7265  atches WTRAXY re
-0002ff90: 7375 6c74 7320 746f 2062 6574 7465 7220  sults to better 
-0002ffa0: 7468 616e 2031 652d 3420 7069 7865 6c73  than 1e-4 pixels
-0002ffb0: 2e0a 2020 2020 2020 2020 736b 7978 2c20  ..        skyx, 
-0002ffc0: 736b 7979 203d 2073 656c 662e 696e 7075  skyy = self.inpu
-0002ffd0: 742e 616c 6c5f 7069 7832 776f 726c 6428  t.all_pix2world(
-0002ffe0: 7069 7878 2c20 7069 7879 2c20 7365 6c66  pixx, pixy, self
-0002fff0: 2e6f 7269 6769 6e29 0a20 2020 2020 2020  .origin).       
-00030000: 2072 6573 756c 7420 3d20 7365 6c66 2e6f   result = self.o
-00030010: 7574 7075 742e 616c 6c5f 776f 726c 6432  utput.all_world2
-00030020: 7069 7828 736b 7978 2c20 736b 7979 2c20  pix(skyx, skyy, 
-00030030: 7365 6c66 2e6f 7269 6769 6e29 0a20 2020  self.origin).   
-00030040: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-00030050: 6c74 0a0a 2020 2020 6465 6620 6261 636b  lt..    def back
-00030060: 7761 7264 2873 656c 662c 2070 6978 782c  ward(self, pixx,
-00030070: 2070 6978 7929 3a0a 2020 2020 2020 2020   pixy):.        
-00030080: 2222 2220 5472 616e 7366 6f72 6d20 7069  """ Transform pi
-00030090: 7878 2c70 6978 7920 706f 7369 7469 6f6e  xx,pixy position
-000300a0: 7320 6672 6f6d 2074 6865 206f 7574 7075  s from the outpu
-000300b0: 7420 6672 616d 6520 6261 636b 206f 6e74  t frame back ont
-000300c0: 6f20 7468 6569 720a 2020 2020 2020 2020  o their.        
-000300d0: 2020 2020 6f72 6967 696e 616c 2070 6f73      original pos
-000300e0: 6974 696f 6e73 2069 6e20 7468 6520 696e  itions in the in
-000300f0: 7075 7420 6672 616d 652e 0a20 2020 2020  put frame..     
-00030100: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-00030110: 6b79 782c 2073 6b79 7920 3d20 7365 6c66  kyx, skyy = self
-00030120: 2e6f 7574 7075 742e 616c 6c5f 7069 7832  .output.all_pix2
-00030130: 776f 726c 6428 7069 7878 2c20 7069 7879  world(pixx, pixy
-00030140: 2c20 7365 6c66 2e6f 7269 6769 6e29 0a20  , self.origin). 
-00030150: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00030160: 7365 6c66 2e69 6e70 7574 2e61 6c6c 5f77  self.input.all_w
-00030170: 6f72 6c64 3270 6978 2873 6b79 782c 2073  orld2pix(skyx, s
-00030180: 6b79 792c 2073 656c 662e 6f72 6967 696e  kyy, self.origin
-00030190: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000301a0: 2072 6573 756c 740a 0a20 2020 2064 6566   result..    def
-000301b0: 2067 6574 5f70 6978 5f72 6174 696f 2873   get_pix_ratio(s
-000301c0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-000301d0: 2220 5265 7475 726e 2074 6865 2072 6174  " Return the rat
-000301e0: 696f 206f 6620 706c 6174 6520 7363 616c  io of plate scal
-000301f0: 6573 2062 6574 7765 656e 2074 6865 2069  es between the i
-00030200: 6e70 7574 2061 6e64 206f 7574 7075 7420  nput and output 
-00030210: 5743 532e 0a20 2020 2020 2020 2020 2020  WCS..           
-00030220: 2054 6869 7320 6973 2075 7365 6420 746f   This is used to
-00030230: 2070 726f 7065 726c 7920 6469 7374 7269   properly distri
-00030240: 6275 7465 2074 6865 2066 6c75 7820 696e  bute the flux in
-00030250: 2065 6163 6820 7069 7865 6c20 696e 2027   each pixel in '
-00030260: 7464 7269 7a27 2e0a 2020 2020 2020 2020  tdriz'..        
-00030270: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-00030280: 726e 2073 656c 662e 6f75 7470 7574 2e70  rn self.output.p
-00030290: 7363 616c 6520 2f20 7365 6c66 2e69 6e70  scale / self.inp
-000302a0: 7574 2e70 7363 616c 650a 0a20 2020 2064  ut.pscale..    d
-000302b0: 6566 2078 7932 7264 2873 656c 662c 2077  ef xy2rd(self, w
-000302c0: 6373 2c20 7069 7878 2c20 7069 7879 293a  cs, pixx, pixy):
-000302d0: 0a20 2020 2020 2020 2022 2222 2054 7261  .        """ Tra
-000302e0: 6e73 666f 726d 2069 6e70 7574 2070 6978  nsform input pix
-000302f0: 656c 2070 6f73 6974 696f 6e73 2069 6e74  el positions int
-00030300: 6f20 736b 7920 706f 7369 7469 6f6e 7320  o sky positions 
-00030310: 696e 2074 6865 2057 4353 2070 726f 7669  in the WCS provi
-00030320: 6465 642e 0a20 2020 2020 2020 2022 2222  ded..        """
-00030330: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00030340: 7763 732e 616c 6c5f 7069 7832 776f 726c  wcs.all_pix2worl
-00030350: 6428 7069 7878 2c20 7069 7879 2c20 3129  d(pixx, pixy, 1)
-00030360: 0a0a 2020 2020 6465 6620 7264 3278 7928  ..    def rd2xy(
-00030370: 7365 6c66 2c20 7763 732c 2072 612c 2064  self, wcs, ra, d
-00030380: 6563 293a 0a20 2020 2020 2020 2022 2222  ec):.        """
-00030390: 2054 7261 6e73 666f 726d 2069 6e70 7574   Transform input
-000303a0: 2073 6b79 2070 6f73 6974 696f 6e73 2069   sky positions i
-000303b0: 6e74 6f20 7069 7865 6c20 706f 7369 7469  nto pixel positi
-000303c0: 6f6e 7320 696e 2074 6865 2057 4353 2070  ons in the WCS p
-000303d0: 726f 7669 6465 642e 0a20 2020 2020 2020  rovided..       
-000303e0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-000303f0: 7572 6e20 7763 732e 616c 6c5f 776f 726c  urn wcs.all_worl
-00030400: 6432 7069 7828 7261 2c20 6465 632c 2031  d2pix(ra, dec, 1
-00030410: 290a 0a0a 6465 6620 636f 6d70 7574 655f  )...def compute_
-00030420: 6f75 7470 7574 5f77 6373 2877 6373 5f6c  output_wcs(wcs_l
-00030430: 6973 742c 2070 6978 656c 5f73 6361 6c65  ist, pixel_scale
-00030440: 3d30 2e31 2c20 6d61 785f 7369 7a65 3d31  =0.1, max_size=1
-00030450: 3030 3030 293a 0a20 2020 2022 2222 0a20  0000):.    """. 
-00030460: 2020 2043 6f6d 7075 7465 206f 7574 7075     Compute outpu
-00030470: 7420 5743 5320 7468 6174 2063 6f6e 7461  t WCS that conta
-00030480: 696e 7320 7468 6520 6675 6c6c 206c 6973  ins the full lis
-00030490: 7420 6f66 2069 6e70 7574 2057 4353 0a0a  t of input WCS..
-000304a0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-000304b0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-000304c0: 2020 7763 735f 6c69 7374 203a 206c 6973    wcs_list : lis
-000304d0: 740a 2020 2020 2020 2020 4c69 7374 206f  t.        List o
-000304e0: 6620 696e 6469 7669 6475 616c 2060 7e61  f individual `~a
-000304f0: 7374 726f 7079 2e77 6373 2e57 4353 6020  stropy.wcs.WCS` 
-00030500: 6f62 6a65 6374 732e 0a0a 2020 2020 7069  objects...    pi
-00030510: 7865 6c5f 7363 616c 6520 3a20 7479 7065  xel_scale : type
-00030520: 0a20 2020 2020 2020 2050 6978 656c 2073  .        Pixel s
-00030530: 6361 6c65 206f 6620 7468 6520 6f75 7470  cale of the outp
-00030540: 7574 2057 4353 0a0a 2020 2020 6d61 785f  ut WCS..    max_
-00030550: 7369 7a65 203a 2069 6e74 0a20 2020 2020  size : int.     
-00030560: 2020 204d 6178 696d 756d 2073 697a 6520     Maximum size 
-00030570: 6f75 7420 7468 6520 6f75 7470 7574 2069  out the output i
-00030580: 6d61 6765 2064 696d 656e 7369 6f6e 730a  mage dimensions.
-00030590: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-000305a0: 202d 2d2d 2d2d 2d2d 0a20 2020 2068 6561   -------.    hea
-000305b0: 6465 7220 3a20 607e 6173 7472 6f70 792e  der : `~astropy.
-000305c0: 696f 2e66 6974 732e 4865 6164 6572 600a  io.fits.Header`.
-000305d0: 2020 2020 2020 2020 5743 5320 6865 6164          WCS head
-000305e0: 6572 0a0a 2020 2020 6f75 7470 7574 7763  er..    outputwc
-000305f0: 7320 3a20 607e 6173 7472 6f70 792e 7763  s : `~astropy.wc
-00030600: 732e 5743 5360 0a20 2020 2020 2020 204f  s.WCS`.        O
-00030610: 7574 7075 7420 5743 530a 0a20 2020 2022  utput WCS..    "
-00030620: 2222 0a20 2020 2066 726f 6d20 7368 6170  "".    from shap
-00030630: 656c 792e 6765 6f6d 6574 7279 2069 6d70  ely.geometry imp
-00030640: 6f72 7420 506f 6c79 676f 6e0a 0a20 2020  ort Polygon..   
-00030650: 2066 6f6f 7470 7269 6e74 203d 2050 6f6c   footprint = Pol
-00030660: 7967 6f6e 2877 6373 5f6c 6973 745b 305d  ygon(wcs_list[0]
-00030670: 2e63 616c 635f 666f 6f74 7072 696e 7428  .calc_footprint(
-00030680: 2929 0a20 2020 2066 6f72 2069 2069 6e20  )).    for i in 
-00030690: 7261 6e67 6528 312c 206c 656e 2877 6373  range(1, len(wcs
-000306a0: 5f6c 6973 7429 293a 0a20 2020 2020 2020  _list)):.       
-000306b0: 2066 705f 6920 3d20 506f 6c79 676f 6e28   fp_i = Polygon(
-000306c0: 7763 735f 6c69 7374 5b69 5d2e 6361 6c63  wcs_list[i].calc
-000306d0: 5f66 6f6f 7470 7269 6e74 2829 290a 2020  _footprint()).  
-000306e0: 2020 2020 2020 666f 6f74 7072 696e 7420        footprint 
-000306f0: 3d20 666f 6f74 7072 696e 742e 756e 696f  = footprint.unio
-00030700: 6e28 6670 5f69 290a 0a20 2020 2078 2c20  n(fp_i)..    x, 
-00030710: 7920 3d20 666f 6f74 7072 696e 742e 636f  y = footprint.co
-00030720: 6e76 6578 5f68 756c 6c2e 626f 756e 6461  nvex_hull.bounda
-00030730: 7279 2e78 790a 2020 2020 782c 2079 203d  ry.xy.    x, y =
-00030740: 206e 702e 6172 7261 7928 7829 2c20 6e70   np.array(x), np
-00030750: 2e61 7272 6179 2879 290a 0a20 2020 2023  .array(y)..    #
-00030760: 2063 656e 7465 720a 2020 2020 6372 7661   center.    crva
-00030770: 6c20 3d20 6e70 2e61 7272 6179 2866 6f6f  l = np.array(foo
-00030780: 7470 7269 6e74 2e63 656e 7472 6f69 642e  tprint.centroid.
-00030790: 7879 292e 666c 6174 7465 6e28 290a 0a20  xy).flatten().. 
-000307a0: 2020 2023 2064 696d 656e 7369 6f6e 7320     # dimensions 
-000307b0: 696e 2061 7263 7365 630a 2020 2020 7873  in arcsec.    xs
-000307c0: 697a 6520 3d20 2878 2e6d 6178 2829 2d78  ize = (x.max()-x
-000307d0: 2e6d 696e 2829 292a 6e70 2e63 6f73 2863  .min())*np.cos(c
-000307e0: 7276 616c 5b31 5d2f 3138 302a 6e70 2e70  rval[1]/180*np.p
-000307f0: 6929 2a33 3630 300a 2020 2020 7973 697a  i)*3600.    ysiz
-00030800: 6520 3d20 2879 2e6d 6178 2829 2d79 2e6d  e = (y.max()-y.m
-00030810: 696e 2829 292a 3336 3030 0a0a 2020 2020  in())*3600..    
-00030820: 7873 697a 6520 3d20 6e70 2e6d 696e 696d  xsize = np.minim
-00030830: 756d 2878 7369 7a65 2c20 6d61 785f 7369  um(xsize, max_si
-00030840: 7a65 2a70 6978 656c 5f73 6361 6c65 290a  ze*pixel_scale).
-00030850: 2020 2020 7973 697a 6520 3d20 6e70 2e6d      ysize = np.m
-00030860: 696e 696d 756d 2879 7369 7a65 2c20 6d61  inimum(ysize, ma
-00030870: 785f 7369 7a65 2a70 6978 656c 5f73 6361  x_size*pixel_sca
-00030880: 6c65 290a 0a20 2020 2068 6561 6465 722c  le)..    header,
-00030890: 206f 7574 7075 7477 6373 203d 206d 616b   outputwcs = mak
-000308a0: 655f 7763 7368 6561 6465 7228 7261 3d63  e_wcsheader(ra=c
-000308b0: 7276 616c 5b30 5d2c 2064 6563 3d63 7276  rval[0], dec=crv
-000308c0: 616c 5b31 5d2c 0a20 2020 2020 2020 2020  al[1],.         
-000308d0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-000308e0: 3d28 7873 697a 652c 2079 7369 7a65 292c  =(xsize, ysize),
-000308f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030900: 2020 2020 2020 7069 7873 6361 6c65 3d70        pixscale=p
-00030910: 6978 656c 5f73 6361 6c65 2c0a 2020 2020  ixel_scale,.    
-00030920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030930: 2067 6574 5f68 6475 3d46 616c 7365 2c0a   get_hdu=False,.
-00030940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030950: 2020 2020 2074 6865 7461 3d30 290a 0a20       theta=0).. 
-00030960: 2020 2072 6574 7572 6e20 6865 6164 6572     return header
-00030970: 2c20 6f75 7470 7574 7763 730a 0a0a 6465  , outputwcs...de
-00030980: 6620 7379 6d6c 696e 6b5f 7465 6d70 6c61  f symlink_templa
-00030990: 7465 7328 666f 7263 653d 4661 6c73 6529  tes(force=False)
-000309a0: 3a0a 2020 2020 2222 2253 796d 6c69 6e6b  :.    """Symlink
-000309b0: 2074 656d 706c 6174 6573 2066 726f 6d20   templates from 
-000309c0: 6d6f 6475 6c65 2074 6f20 2447 5249 5a4c  module to $GRIZL
-000309d0: 492f 7465 6d70 6c61 7465 7320 6173 2070  I/templates as p
-000309e0: 6172 7420 6f66 2074 6865 2069 6e69 7469  art of the initi
-000309f0: 616c 2073 6574 7570 0a20 2020 2050 6172  al setup.    Par
-00030a00: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00030a10: 2d2d 2d2d 2d2d 0a20 2020 2066 6f72 6365  ------.    force
-00030a20: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
-00030a30: 466f 7263 6520 6c69 6e6b 2066 696c 6573  Force link files
-00030a40: 2065 7665 6e20 6966 2074 6865 7920 616c   even if they al
-00030a50: 7265 6164 7920 6578 6973 742e 0a20 2020  ready exist..   
-00030a60: 2022 2222 0a20 2020 2023 2069 6620 2747   """.    # if 'G
-00030a70: 5249 5a4c 4927 206e 6f74 2069 6e20 6f73  RIZLI' not in os
-00030a80: 2e65 6e76 6972 6f6e 3a0a 2020 2020 2320  .environ:.    # 
-00030a90: 2020 2020 7072 696e 7428 2722 4752 495a      print('"GRIZ
-00030aa0: 4c49 2220 656e 7669 726f 6e6d 656e 7420  LI" environment 
-00030ab0: 7661 7269 6162 6c65 206e 6f74 2073 6574  variable not set
-00030ac0: 2127 290a 2020 2020 2320 2020 2020 7265  !').    #     re
-00030ad0: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00030ae0: 6d6f 6475 6c65 5f70 6174 6820 3d20 6f73  module_path = os
-00030af0: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
-00030b00: 6669 6c65 5f5f 290a 2020 2020 7465 6d70  file__).    temp
-00030b10: 6c61 7465 735f 7061 7468 203d 206f 732e  lates_path = os.
-00030b20: 7061 7468 2e6a 6f69 6e28 6d6f 6475 6c65  path.join(module
-00030b30: 5f70 6174 682c 2027 6461 7461 2f74 656d  _path, 'data/tem
-00030b40: 706c 6174 6573 2729 0a0a 2020 2020 6f75  plates')..    ou
-00030b50: 745f 7061 7468 203d 206f 732e 7061 7468  t_path = os.path
-00030b60: 2e6a 6f69 6e28 4752 495a 4c49 5f50 4154  .join(GRIZLI_PAT
-00030b70: 482c 2027 7465 6d70 6c61 7465 7327 290a  H, 'templates').
-00030b80: 0a20 2020 2069 6620 286e 6f74 206f 732e  .    if (not os.
-00030b90: 7061 7468 2e65 7869 7374 7328 6f75 745f  path.exists(out_
-00030ba0: 7061 7468 2929 207c 2066 6f72 6365 3a0a  path)) | force:.
-00030bb0: 2020 2020 2020 2020 6966 206f 732e 7061          if os.pa
-00030bc0: 7468 2e65 7869 7374 7328 6f75 745f 7061  th.exists(out_pa
-00030bd0: 7468 293a 2020 2320 2866 6f72 6365 290a  th):  # (force).
-00030be0: 2020 2020 2020 2020 2020 2020 7368 7574              shut
-00030bf0: 696c 2e72 6d74 7265 6528 6f75 745f 7061  il.rmtree(out_pa
-00030c00: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
-00030c10: 206f 732e 7379 6d6c 696e 6b28 7465 6d70   os.symlink(temp
-00030c20: 6c61 7465 735f 7061 7468 2c20 6f75 745f  lates_path, out_
-00030c30: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
-00030c40: 2020 7072 696e 7428 2753 796d 6c69 6e6b    print('Symlink
-00030c50: 3a20 7b30 7d20 2d3e 207b 317d 272e 666f  : {0} -> {1}'.fo
-00030c60: 726d 6174 2874 656d 706c 6174 6573 5f70  rmat(templates_p
-00030c70: 6174 682c 206f 7574 5f70 6174 6829 290a  ath, out_path)).
-00030c80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00030c90: 2020 7072 696e 7428 2754 656d 706c 6174    print('Templat
-00030ca0: 6573 2064 6972 6563 746f 7279 2065 7869  es directory exi
-00030cb0: 7374 733a 207b 307d 272e 666f 726d 6174  sts: {0}'.format
-00030cc0: 286f 7574 5f70 6174 6829 290a 2020 2020  (out_path)).    
-00030cd0: 2020 2020 7072 696e 7428 2755 7365 2060      print('Use `
-00030ce0: 666f 7263 653d 5472 7565 6020 746f 2066  force=True` to f
-00030cf0: 6f72 6365 2061 206e 6577 2073 796d 626f  orce a new symbo
-00030d00: 6c69 6320 6c69 6e6b 2e27 290a 0a0a 6465  lic link.')...de
-00030d10: 6620 6665 7463 685f 6163 735f 7763 735f  f fetch_acs_wcs_
-00030d20: 6669 6c65 7328 6265 616d 735f 6669 6c65  files(beams_file
-00030d30: 2c20 6275 636b 6574 5f6e 616d 653d 2767  , bucket_name='g
-00030d40: 7269 7a6c 692d 7631 2729 3a0a 2020 2020  rizli-v1'):.    
-00030d50: 2222 220a 2020 2020 4665 7463 6820 7763  """.    Fetch wc
-00030d60: 7320 6669 6c65 7320 666f 7220 6120 6769  s files for a gi
-00030d70: 7665 6e20 6265 616d 732e 6669 7473 2066  ven beams.fits f
-00030d80: 696c 6573 0a20 2020 2022 2222 0a20 2020  iles.    """.   
-00030d90: 2066 726f 6d20 7572 6c6c 6962 2069 6d70   from urllib imp
-00030da0: 6f72 7420 7265 7175 6573 740a 2020 2020  ort request.    
-00030db0: 7472 793a 0a20 2020 2020 2020 2069 6d70  try:.        imp
-00030dc0: 6f72 7420 626f 746f 330a 2020 2020 2020  ort boto3.      
-00030dd0: 2020 4841 535f 424f 544f 203d 2054 7275    HAS_BOTO = Tru
-00030de0: 650a 2020 2020 6578 6365 7074 3a0a 2020  e.    except:.  
-00030df0: 2020 2020 2020 4841 535f 424f 544f 203d        HAS_BOTO =
-00030e00: 2046 616c 7365 0a0a 2020 2020 696d 203d   False..    im =
-00030e10: 2070 7966 6974 732e 6f70 656e 2862 6561   pyfits.open(bea
-00030e20: 6d73 5f66 696c 6529 0a20 2020 2072 6f6f  ms_file).    roo
-00030e30: 7420 3d20 275f 272e 6a6f 696e 2862 6561  t = '_'.join(bea
-00030e40: 6d73 5f66 696c 652e 7370 6c69 7428 275f  ms_file.split('_
-00030e50: 2729 5b3a 2d31 5d29 0a0a 2020 2020 666f  ')[:-1])..    fo
-00030e60: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-00030e70: 2869 6d29 293a 0a20 2020 2020 2020 2068  (im)):.        h
-00030e80: 203d 2069 6d5b 695d 2e68 6561 6465 720a   = im[i].header.
-00030e90: 2020 2020 2020 2020 6966 2027 4558 544e          if 'EXTN
-00030ea0: 414d 4527 206e 6f74 2069 6e20 683a 0a20  AME' not in h:. 
-00030eb0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00030ec0: 6e75 650a 0a20 2020 2020 2020 2069 6620  nue..        if 
-00030ed0: 2746 494c 5445 5227 206e 6f74 2069 6e20  'FILTER' not in 
-00030ee0: 683a 0a20 2020 2020 2020 2020 2020 2063  h:.            c
-00030ef0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-00030f00: 2069 6620 2868 5b27 4558 544e 414d 4527   if (h['EXTNAME'
-00030f10: 5d20 213d 2027 5343 4927 2920 7c20 2868  ] != 'SCI') | (h
-00030f20: 5b27 4649 4c54 4552 275d 206e 6f74 2069  ['FILTER'] not i
-00030f30: 6e20 5b27 4738 3030 4c27 5d29 3a0a 2020  n ['G800L']):.  
-00030f40: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00030f50: 7565 0a0a 2020 2020 2020 2020 6578 7420  ue..        ext 
-00030f60: 3d20 7b31 3a20 322c 2032 3a20 317d 5b68  = {1: 2, 2: 1}[h
-00030f70: 5b27 4343 4443 4849 5027 5d5d 0a0a 2020  ['CCDCHIP']]..  
-00030f80: 2020 2020 2020 7763 7366 696c 6520 3d20        wcsfile = 
-00030f90: 685b 2747 5041 5245 4e54 275d 2e72 6570  h['GPARENT'].rep
-00030fa0: 6c61 6365 2827 2e66 6974 7327 2c20 272e  lace('.fits', '.
-00030fb0: 7b30 3a30 3264 7d2e 7763 732e 6669 7473  {0:02d}.wcs.fits
-00030fc0: 272e 666f 726d 6174 2865 7874 2929 0a0a  '.format(ext))..
-00030fd0: 2020 2020 2020 2020 2320 446f 776e 6c6f          # Downlo
-00030fe0: 6164 2074 6865 2066 696c 6520 7769 7468  ad the file with
-00030ff0: 2053 3320 6f72 2048 5454 500a 2020 2020   S3 or HTTP.    
-00031000: 2020 2020 6966 206e 6f74 206f 732e 7061      if not os.pa
-00031010: 7468 2e65 7869 7374 7328 7763 7366 696c  th.exists(wcsfil
-00031020: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00031030: 7072 696e 7428 2746 6574 6368 207b 307d  print('Fetch {0}
-00031040: 2066 726f 6d20 7b31 7d2f 5069 7065 6c69   from {1}/Pipeli
-00031050: 6e65 2f7b 327d 272e 666f 726d 6174 2877  ne/{2}'.format(w
-00031060: 6373 6669 6c65 2c0a 2020 2020 2020 2020  csfile,.        
-00031070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310a0: 2020 2062 7563 6b65 745f 6e61 6d65 2c20     bucket_name, 
-000310b0: 726f 6f74 2929 0a0a 2020 2020 2020 2020  root))..        
-000310c0: 2020 2020 6966 2048 4153 5f42 4f54 4f3a      if HAS_BOTO:
-000310d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000310e0: 2073 3320 3d20 626f 746f 332e 7265 736f   s3 = boto3.reso
-000310f0: 7572 6365 2827 7333 2729 0a20 2020 2020  urce('s3').     
-00031100: 2020 2020 2020 2020 2020 2073 335f 636c             s3_cl
-00031110: 6965 6e74 203d 2062 6f74 6f33 2e63 6c69  ient = boto3.cli
-00031120: 656e 7428 2773 3327 290a 2020 2020 2020  ent('s3').      
-00031130: 2020 2020 2020 2020 2020 626b 7420 3d20            bkt = 
-00031140: 7333 2e42 7563 6b65 7428 6275 636b 6574  s3.Bucket(bucket
-00031150: 5f6e 616d 6529 0a0a 2020 2020 2020 2020  _name)..        
-00031160: 2020 2020 2020 2020 7333 5f70 6174 6820          s3_path 
-00031170: 3d20 2750 6970 656c 696e 652f 7b30 7d2f  = 'Pipeline/{0}/
-00031180: 4578 7472 6163 7469 6f6e 732f 7b31 7d27  Extractions/{1}'
-00031190: 2e66 6f72 6d61 7428 726f 6f74 2c20 7763  .format(root, wc
-000311a0: 7366 696c 6529 0a20 2020 2020 2020 2020  sfile).         
-000311b0: 2020 2020 2020 2062 6b74 2e64 6f77 6e6c         bkt.downl
-000311c0: 6f61 645f 6669 6c65 2873 335f 7061 7468  oad_file(s3_path
-000311d0: 2c20 272e 2f7b 307d 272e 666f 726d 6174  , './{0}'.format
-000311e0: 2877 6373 6669 6c65 292c 0a20 2020 2020  (wcsfile),.     
-000311f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031200: 2020 2020 2020 2020 2020 2020 2045 7874               Ext
-00031210: 7261 4172 6773 3d7b 2252 6571 7565 7374  raArgs={"Request
-00031220: 5061 7965 7222 3a20 2272 6571 7565 7374  Payer": "request
-00031230: 6572 227d 290a 0a20 2020 2020 2020 2020  er"})..         
-00031240: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00031250: 2020 2020 2020 2020 2075 726c 203d 2027           url = '
-00031260: 6874 7470 733a 2f2f 7333 2e61 6d61 7a6f  https://s3.amazo
-00031270: 6e61 7773 2e63 6f6d 2f7b 307d 2f27 2e66  naws.com/{0}/'.f
-00031280: 6f72 6d61 7428 6275 636b 6574 5f6e 616d  ormat(bucket_nam
-00031290: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000312a0: 2020 2075 726c 202b 3d20 2750 6970 656c     url += 'Pipel
-000312b0: 696e 652f 7b30 7d2f 4578 7472 6163 7469  ine/{0}/Extracti
-000312c0: 6f6e 732f 7b31 7d27 2e66 6f72 6d61 7428  ons/{1}'.format(
-000312d0: 726f 6f74 2c20 7763 7366 696c 6529 0a0a  root, wcsfile)..
+0002dff0: 2020 666f 626a 3d66 6c74 290a 2020 2020    fobj=flt).    
+0002e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e010: 7763 735f 692e 7073 6361 6c65 203d 2067  wcs_i.pscale = g
+0002e020: 6574 5f77 6373 5f70 7363 616c 6528 7763  et_wcs_pscale(wc
+0002e030: 735f 6929 0a20 2020 2020 2020 2020 2020  s_i).           
+0002e040: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+0002e050: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0002e060: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0002e070: 6627 4661 696c 6564 2074 6f20 696e 6974  f'Failed to init
+0002e080: 6961 6c69 7a65 2057 4353 206f 6e20 7b66  ialize WCS on {f
+0002e090: 696c 657d 5b53 4349 2c7b 6578 747d 5d27  ile}[SCI,{ext}]'
+0002e0a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002e0b0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+0002e0c0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+0002e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e0e0: 7763 7368 203d 2074 6f5f 6865 6164 6572  wcsh = to_header
+0002e0f0: 2877 6373 5f69 290a 2020 2020 2020 2020  (wcs_i).        
+0002e100: 2020 2020 2020 2020 726f 7720 3d20 5b66          row = [f
+0002e110: 696c 652c 2065 7874 2c20 6b65 7973 5b27  ile, ext, keys['
+0002e120: 4558 5054 494d 4527 5d5d 0a20 2020 2020  EXPTIME']].     
+0002e130: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0002e140: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+0002e150: 6373 5f63 6f6c 6e61 6d65 7320 6973 204e  cs_colnames is N
+0002e160: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002e170: 2020 2020 2020 2020 2077 6373 5f63 6f6c           wcs_col
+0002e180: 6e61 6d65 7320 3d20 5b27 6669 6c65 272c  names = ['file',
+0002e190: 2765 7874 272c 2765 7870 7469 6d65 275d  'ext','exptime']
+0002e1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e1b0: 2020 2020 2066 6f72 206b 2069 6e20 7763       for k in wc
+0002e1c0: 7368 3a0a 2020 2020 2020 2020 2020 2020  sh:.            
+0002e1d0: 2020 2020 2020 2020 2020 2020 7763 735f              wcs_
+0002e1e0: 636f 6c6e 616d 6573 2e61 7070 656e 6428  colnames.append(
+0002e1f0: 6b2e 6c6f 7765 7228 2929 0a20 2020 2020  k.lower()).     
+0002e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e210: 2020 2077 6373 5f6b 6579 735b 6b2e 6c6f     wcs_keys[k.lo
+0002e220: 7765 7228 295d 203d 2077 6373 685b 6b5d  wer()] = wcsh[k]
+0002e230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e240: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0002e250: 2020 2020 2020 2020 2020 666f 7220 6b20            for k 
+0002e260: 696e 2077 6373 5f63 6f6c 6e61 6d65 735b  in wcs_colnames[
+0002e270: 333a 5d3a 0a20 2020 2020 2020 2020 2020  3:]:.           
+0002e280: 2020 2020 2020 2020 206b 7520 3d20 6b2e           ku = k.
+0002e290: 7570 7065 7228 290a 2020 2020 2020 2020  upper().        
+0002e2a0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+0002e2b0: 7520 6e6f 7420 696e 2077 6373 683a 0a20  u not in wcsh:. 
+0002e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e2d0: 2020 2020 2020 2070 7269 6e74 2866 274b         print(f'K
+0002e2e0: 6579 776f 7264 207b 6b75 7d20 6e6f 7420  eyword {ku} not 
+0002e2f0: 666f 756e 6420 696e 2057 4353 2068 6561  found in WCS hea
+0002e300: 6465 7227 290a 2020 2020 2020 2020 2020  der').          
+0002e310: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+0002e320: 772e 6170 7065 6e64 2877 6373 5f6b 6579  w.append(wcs_key
+0002e330: 735b 6b5d 2a30 290a 2020 2020 2020 2020  s[k]*0).        
+0002e340: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002e350: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002e360: 2020 2020 2020 2020 2020 726f 772e 6170            row.ap
+0002e370: 7065 6e64 2877 6373 685b 6b75 5d29 0a20  pend(wcsh[ku]). 
+0002e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e390: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0002e3a0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
+0002e3b0: 2077 6373 683a 0a20 2020 2020 2020 2020   wcsh:.         
+0002e3c0: 2020 2020 2020 2020 2020 2069 6620 6b2e             if k.
+0002e3d0: 6c6f 7765 7228 2920 6e6f 7420 696e 2077  lower() not in w
+0002e3e0: 6373 5f63 6f6c 6e61 6d65 733a 0a20 2020  cs_colnames:.   
+0002e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e400: 2020 2020 2070 7269 6e74 2866 2745 7874       print(f'Ext
+0002e410: 7261 206b 6579 776f 7264 207b 6b75 7d20  ra keyword {ku} 
+0002e420: 666f 756e 6420 696e 2057 4353 2068 6561  found in WCS hea
+0002e430: 6465 7227 290a 2020 2020 2020 2020 2020  der').          
+0002e440: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0002e450: 2020 2020 2020 2077 6373 5f72 6f77 732e         wcs_rows.
+0002e460: 6170 7065 6e64 2872 6f77 290a 2020 2020  append(row).    
+0002e470: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0002e480: 2020 2020 2020 2020 2020 2020 2073 6369               sci
+0002e490: 5f6c 6973 742e 6170 7065 6e64 2828 666c  _list.append((fl
+0002e4a0: 745b 2827 5343 4927 2c20 6578 7429 5d2e  t[('SCI', ext)].
+0002e4b0: 6461 7461 202d 2073 6b79 292a 7068 6f74  data - sky)*phot
+0002e4c0: 5f73 6361 6c65 290a 0a20 2020 2020 2020  _scale)..       
+0002e4d0: 2020 2020 2020 2020 2065 7272 203d 2066           err = f
+0002e4e0: 6c74 5b28 2745 5252 272c 2065 7874 295d  lt[('ERR', ext)]
+0002e4f0: 2e64 6174 612a 7068 6f74 5f73 6361 6c65  .data*phot_scale
+0002e500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e510: 2064 7120 3d20 756e 7365 745f 6471 5f62   dq = unset_dq_b
+0002e520: 6974 7328 666c 745b 2827 4451 272c 2065  its(flt[('DQ', e
+0002e530: 7874 295d 2e64 6174 612c 2062 6974 7329  xt)].data, bits)
+0002e540: 207c 2062 7064 6174 610a 2020 2020 2020   | bpdata.      
+0002e550: 2020 2020 2020 2020 2020 7768 7420 3d20            wht = 
+0002e560: 312f 6572 722a 2a32 0a20 2020 2020 2020  1/err**2.       
+0002e570: 2020 2020 2020 2020 2077 6874 5b28 6572           wht[(er
+0002e580: 7220 3d3d 2030 2920 7c20 2864 7120 3e20  r == 0) | (dq > 
+0002e590: 3029 5d20 3d20 300a 0a20 2020 2020 2020  0)] = 0..       
+0002e5a0: 2020 2020 2020 2020 2077 6874 5f6c 6973           wht_lis
+0002e5b0: 742e 6170 7065 6e64 2877 6874 290a 0a20  t.append(wht).. 
+0002e5c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002e5d0: 2077 6373 5f69 203d 2048 5354 5743 5328   wcs_i = HSTWCS(
+0002e5e0: 666f 626a 3d66 6c74 2c20 6578 743d 2827  fobj=flt, ext=('
+0002e5f0: 5343 4927 2c65 7874 292c 206d 696e 6572  SCI',ext), miner
+0002e600: 723d 302e 302c 0a20 2020 2020 2020 2020  r=0.0,.         
+0002e610: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+0002e620: 2020 2020 2020 2020 7763 736b 6579 3d27          wcskey='
+0002e630: 2027 290a 2020 2020 2020 2020 2020 2020   ').            
+0002e640: 2020 2020 6966 206e 6f74 2068 6173 6174      if not hasat
+0002e650: 7472 2877 6373 5f69 2c20 2770 6978 656c  tr(wcs_i, 'pixel
+0002e660: 5f73 6861 7065 2729 3a0a 2020 2020 2020  _shape'):.      
+0002e670: 2020 2020 2020 2020 2020 2020 2020 7763                wc
+0002e680: 735f 692e 7069 7865 6c5f 7368 6170 6520  s_i.pixel_shape 
+0002e690: 3d20 7763 735f 692e 5f6e 6178 6973 312c  = wcs_i._naxis1,
+0002e6a0: 2077 6373 5f69 2e5f 6e61 7869 7332 0a0a   wcs_i._naxis2..
+0002e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6c0: 6966 206e 6f74 2068 6173 6174 7472 2877  if not hasattr(w
+0002e6d0: 6373 5f69 2c20 275f 6e61 7869 7331 2729  cs_i, '_naxis1')
+0002e6e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002e6f0: 2020 2020 2020 7763 735f 692e 5f6e 6178        wcs_i._nax
+0002e700: 6973 312c 2077 6373 5f69 2e5f 6e61 7869  is1, wcs_i._naxi
+0002e710: 7332 203d 2077 6373 5f69 2e5f 6e61 7869  s2 = wcs_i._naxi
+0002e720: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
+0002e730: 2020 2077 6373 5f6c 6973 742e 6170 7065     wcs_list.appe
+0002e740: 6e64 2877 6373 5f69 290a 0a20 2020 2020  nd(wcs_i)..     
+0002e750: 2020 2069 6620 636f 756e 7420 3d3d 2030     if count == 0
+0002e760: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0002e770: 7320 3d20 6472 697a 7a6c 655f 6172 7261  s = drizzle_arra
+0002e780: 795f 6772 6f75 7073 2873 6369 5f6c 6973  y_groups(sci_lis
+0002e790: 742c 2077 6874 5f6c 6973 742c 2077 6373  t, wht_list, wcs
+0002e7a0: 5f6c 6973 742c 0a20 2020 2020 2020 2020  _list,.         
+0002e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e7c0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0002e7d0: 7574 7763 733d 6f75 7470 7574 7763 732c  utwcs=outputwcs,
+0002e7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e800: 2020 2020 2020 7363 616c 653d 302e 312c        scale=0.1,
+0002e810: 206b 6572 6e65 6c3d 6b65 726e 656c 2c0a   kernel=kernel,.
+0002e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e840: 2020 2020 2070 6978 6672 6163 3d70 6978       pixfrac=pix
+0002e850: 6672 6163 2c20 6361 6c63 5f77 6373 6d61  frac, calc_wcsma
+0002e860: 703d 6361 6c63 5f77 6373 6d61 702c 0a20  p=calc_wcsmap,. 
+0002e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e890: 2020 2020 7665 7262 6f73 653d 7665 7262      verbose=verb
+0002e8a0: 6f73 652c 2064 6174 613d 4e6f 6e65 290a  ose, data=None).
+0002e8b0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0002e8c0: 7363 692c 206f 7574 7768 742c 206f 7574  sci, outwht, out
+0002e8d0: 6374 782c 2068 6561 6465 722c 2078 6f75  ctx, header, xou
+0002e8e0: 7477 6373 203d 2072 6573 0a20 2020 2020  twcs = res.     
+0002e8f0: 2020 2020 2020 2068 6561 6465 725b 2745         header['E
+0002e900: 5850 5449 4d45 275d 203d 2066 6c74 5b30  XPTIME'] = flt[0
+0002e910: 5d2e 6865 6164 6572 5b27 4558 5054 494d  ].header['EXPTIM
+0002e920: 4527 5d0a 2020 2020 2020 2020 2020 2020  E'].            
+0002e930: 6865 6164 6572 5b27 4e44 5249 5a49 4d27  header['NDRIZIM'
+0002e940: 5d20 3d20 310a 2020 2020 2020 2020 2020  ] = 1.          
+0002e950: 2020 6865 6164 6572 5b27 5049 5846 5241    header['PIXFRA
+0002e960: 4327 5d20 3d20 7069 7866 7261 630a 2020  C'] = pixfrac.  
+0002e970: 2020 2020 2020 2020 2020 6865 6164 6572            header
+0002e980: 5b27 4b45 524e 454c 275d 203d 206b 6572  ['KERNEL'] = ker
+0002e990: 6e65 6c0a 2020 2020 2020 2020 2020 2020  nel.            
+0002e9a0: 6865 6164 6572 5b27 4f4b 4249 5453 275d  header['OKBITS']
+0002e9b0: 203d 2028 6269 7473 2c20 2246 4c54 2062   = (bits, "FLT b
+0002e9c0: 6974 7320 7472 6561 7465 6420 6173 2076  its treated as v
+0002e9d0: 616c 6964 2229 0a20 2020 2020 2020 2020  alid").         
+0002e9e0: 2020 2068 6561 6465 725b 2750 484f 5453     header['PHOTS
+0002e9f0: 4341 4c27 5d20 3d20 5f73 6361 6c65 5f70  CAL'] = _scale_p
+0002ea00: 686f 746f 6d2c 2027 5363 616c 6520 6661  hotom, 'Scale fa
+0002ea10: 6374 6f72 2061 7070 6c69 6564 270a 2020  ctor applied'.  
+0002ea20: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0002ea30: 2020 2020 2020 2068 6561 6465 725b 2747         header['G
+0002ea40: 5249 5a4c 4956 275d 203d 2067 7269 7a6c  RIZLIV'] = grizl
+0002ea50: 695f 5f76 6572 7369 6f6e 2c20 2747 7269  i__version, 'Gri
+0002ea60: 7a6c 6920 636f 6465 2076 6572 7369 6f6e  zli code version
+0002ea70: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
+0002ea80: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0002ea90: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
+0002eaa0: 2020 2020 2020 2020 2020 6865 6164 6572            header
+0002eab0: 5b6b 5d20 3d20 6b65 7973 5b6b 5d0a 0a20  [k] = keys[k].. 
+0002eac0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002ead0: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+0002eae0: 6f75 7473 6369 2c20 6f75 7477 6874 2c20  outsci, outwht, 
+0002eaf0: 6f75 7463 7478 0a20 2020 2020 2020 2020  outctx.         
+0002eb00: 2020 2072 6573 203d 2064 7269 7a7a 6c65     res = drizzle
+0002eb10: 5f61 7272 6179 5f67 726f 7570 7328 7363  _array_groups(sc
+0002eb20: 695f 6c69 7374 2c20 7768 745f 6c69 7374  i_list, wht_list
+0002eb30: 2c20 7763 735f 6c69 7374 2c0a 2020 2020  , wcs_list,.    
+0002eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb60: 206f 7574 7075 7477 6373 3d6f 7574 7075   outputwcs=outpu
+0002eb70: 7477 6373 2c0a 2020 2020 2020 2020 2020  twcs,.          
+0002eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb90: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
+0002eba0: 3d30 2e31 2c20 6b65 726e 656c 3d6b 6572  =0.1, kernel=ker
+0002ebb0: 6e65 6c2c 0a20 2020 2020 2020 2020 2020  nel,.           
+0002ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ebd0: 2020 2020 2020 2020 2020 7069 7866 7261            pixfra
+0002ebe0: 633d 7069 7866 7261 632c 2063 616c 635f  c=pixfrac, calc_
+0002ebf0: 7763 736d 6170 3d63 616c 635f 7763 736d  wcsmap=calc_wcsm
+0002ec00: 6170 2c0a 2020 2020 2020 2020 2020 2020  ap,.            
+0002ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec20: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
+0002ec30: 3d76 6572 626f 7365 2c20 6461 7461 3d64  =verbose, data=d
+0002ec40: 6174 6129 0a0a 2020 2020 2020 2020 2020  ata)..          
+0002ec50: 2020 6f75 7473 6369 2c20 6f75 7477 6874    outsci, outwht
+0002ec60: 2c20 6f75 7463 7478 203d 2072 6573 5b3a  , outctx = res[:
+0002ec70: 335d 0a20 2020 2020 2020 2020 2020 2068  3].            h
+0002ec80: 6561 6465 725b 2745 5850 5449 4d45 275d  eader['EXPTIME']
+0002ec90: 202b 3d20 666c 745b 305d 2e68 6561 6465   += flt[0].heade
+0002eca0: 725b 2745 5850 5449 4d45 275d 0a20 2020  r['EXPTIME'].   
+0002ecb0: 2020 2020 2020 2020 2068 6561 6465 725b           header[
+0002ecc0: 274e 4452 495a 494d 275d 202b 3d20 310a  'NDRIZIM'] += 1.
+0002ecd0: 0a20 2020 2020 2020 2063 6f75 6e74 202b  .        count +
+0002ece0: 3d20 310a 2020 2020 2020 2020 6865 6164  = 1.        head
+0002ecf0: 6572 5b27 464c 547b 303a 3035 647d 272e  er['FLT{0:05d}'.
+0002ed00: 666f 726d 6174 2863 6f75 6e74 295d 203d  format(count)] =
+0002ed10: 2066 696c 650a 2020 2020 2020 2020 0a20   file.        . 
+0002ed20: 2020 2020 2020 2066 6c74 2e63 6c6f 7365         flt.close
+0002ed30: 2829 0a20 2020 2020 2020 200a 2020 2020  ().        .    
+0002ed40: 2020 2020 2378 6669 6c65 7320 3d20 676c      #xfiles = gl
+0002ed50: 6f62 2e67 6c6f 6228 272a 2729 0a20 2020  ob.glob('*').   
+0002ed60: 2020 2020 2023 7072 696e 7428 2743 6c65       #print('Cle
+0002ed70: 616e 3a20 272c 2063 6c65 616e 2c20 7866  an: ', clean, xf
+0002ed80: 696c 6573 290a 2020 2020 2020 2020 6966  iles).        if
+0002ed90: 2063 6c65 616e 3a0a 2020 2020 2020 2020   clean:.        
+0002eda0: 2020 2020 6f73 2e72 656d 6f76 6528 6669      os.remove(fi
+0002edb0: 6c65 290a 0a20 2020 2069 6620 2761 7773  le)..    if 'aws
+0002edc0: 7061 7468 2720 696e 2076 6973 6974 3a0a  path' in visit:.
+0002edd0: 2020 2020 2020 2020 6177 7370 6174 6820          awspath 
+0002ede0: 3d20 7669 7369 745b 2761 7773 7061 7468  = visit['awspath
+0002edf0: 275d 0a20 2020 2065 6c73 653a 0a20 2020  '].    else:.   
+0002ee00: 2020 2020 2061 7773 7061 7468 203d 205b       awspath = [
+0002ee10: 272e 2720 666f 7220 6620 696e 2076 6973  '.' for f in vis
+0002ee20: 6974 5b27 6669 6c65 7327 5d5d 0a0a 2020  it['files']]..  
+0002ee30: 2020 6966 206c 656e 2861 7773 7061 7468    if len(awspath
+0002ee40: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+0002ee50: 6177 7370 6174 6820 3d20 5b61 7773 7061  awspath = [awspa
+0002ee60: 7468 5b30 5d20 666f 7220 6620 696e 2076  th[0] for f in v
+0002ee70: 6973 6974 5b27 6669 6c65 7327 5d5d 0a20  isit['files']]. 
+0002ee80: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0002ee90: 6365 2861 7773 7061 7468 2c20 7374 7229  ce(awspath, str)
+0002eea0: 3a0a 2020 2020 2020 2020 5f61 7773 7061  :.        _awspa
+0002eeb0: 7468 203d 205b 6177 7370 6174 6820 666f  th = [awspath fo
+0002eec0: 7220 6620 696e 2076 6973 6974 5b27 6669  r f in visit['fi
+0002eed0: 6c65 7327 5d5d 0a20 2020 2020 2020 2061  les']].        a
+0002eee0: 7773 7061 7468 203d 205f 6177 7370 6174  wspath = _awspat
+0002eef0: 680a 0a20 2020 2066 6c69 7374 203d 205b  h..    flist = [
+0002ef00: 277b 307d 2f7b 317d 272e 666f 726d 6174  '{0}/{1}'.format
+0002ef10: 2861 7773 7061 7468 2c20 7669 7369 745b  (awspath, visit[
+0002ef20: 2766 696c 6573 275d 5b69 5d29 0a20 2020  'files'][i]).   
+0002ef30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002ef40: 2069 2069 6e20 696e 6469 6365 735d 0a20   i in indices]. 
+0002ef50: 2020 200a 2020 2020 6966 2064 7279 7275     .    if dryru
+0002ef60: 6e3a 0a20 2020 2020 2020 2072 6574 7572  n:.        retur
+0002ef70: 6e20 666c 6973 740a 0a20 2020 2065 6c69  n flist..    eli
+0002ef80: 6620 636f 756e 7420 3d3d 2030 3a0a 2020  f count == 0:.  
+0002ef90: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0002efa0: 650a 0a20 2020 2065 6c73 653a 2020 2020  e..    else:    
+0002efb0: 2020 2020 0a20 2020 2020 2020 2077 6373      .        wcs
+0002efc0: 5f74 6162 203d 2047 5461 626c 6528 6e61  _tab = GTable(na
+0002efd0: 6d65 733d 7763 735f 636f 6c6e 616d 6573  mes=wcs_colnames
+0002efe0: 2c20 726f 7773 3d77 6373 5f72 6f77 7329  , rows=wcs_rows)
+0002eff0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+0002f000: 2020 6f75 7477 6874 202a 3d20 2877 6373    outwht *= (wcs
+0002f010: 5f69 2e70 7363 616c 652f 6f75 7470 7574  _i.pscale/output
+0002f020: 7763 732e 7073 6361 6c65 292a 2a34 0a20  wcs.pscale)**4. 
+0002f030: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+0002f040: 7473 6369 2c20 6f75 7477 6874 2c20 6865  tsci, outwht, he
+0002f050: 6164 6572 2c20 666c 6973 742c 2077 6373  ader, flist, wcs
+0002f060: 5f74 6162 0a0a 0a64 6566 2064 7269 7a7a  _tab...def drizz
+0002f070: 6c65 5f61 7272 6179 5f67 726f 7570 7328  le_array_groups(
+0002f080: 7363 695f 6c69 7374 2c20 7768 745f 6c69  sci_list, wht_li
+0002f090: 7374 2c20 7763 735f 6c69 7374 2c20 6f75  st, wcs_list, ou
+0002f0a0: 7470 7574 7763 733d 4e6f 6e65 2c0a 2020  tputwcs=None,.  
+0002f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0c0: 2020 2020 2020 2073 6361 6c65 3d30 2e31         scale=0.1
+0002f0d0: 2c20 6b65 726e 656c 3d27 706f 696e 7427  , kernel='point'
+0002f0e0: 2c20 7069 7866 7261 633d 312e 2c0a 2020  , pixfrac=1.,.  
+0002f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f100: 2020 2020 2020 2063 616c 635f 7763 736d         calc_wcsm
+0002f110: 6170 3d46 616c 7365 2c20 7665 7262 6f73  ap=False, verbos
+0002f120: 653d 5472 7565 2c20 6461 7461 3d4e 6f6e  e=True, data=Non
+0002f130: 6529 3a0a 2020 2020 2222 2244 7269 7a7a  e):.    """Drizz
+0002f140: 6c65 2061 7272 6179 2064 6174 6120 7769  le array data wi
+0002f150: 7468 2061 7373 6f63 6961 7465 6420 7763  th associated wc
+0002f160: 730a 0a20 2020 2050 6172 616d 6574 6572  s..    Parameter
+0002f170: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+0002f180: 0a20 2020 2073 6369 5f6c 6973 742c 2077  .    sci_list, w
+0002f190: 6874 5f6c 6973 7420 3a20 6c69 7374 0a20  ht_list : list. 
+0002f1a0: 2020 2020 2020 204c 6973 7420 6f66 2073         List of s
+0002f1b0: 6369 656e 6365 2061 6e64 2077 6569 6768  cience and weigh
+0002f1c0: 7420 607e 6e75 6d70 792e 6e64 6172 7261  t `~numpy.ndarra
+0002f1d0: 7960 206f 626a 6563 7473 2e0a 0a20 2020  y` objects...   
+0002f1e0: 2077 6373 5f6c 6973 7420 3a20 6c69 7374   wcs_list : list
+0002f1f0: 0a0a 2020 2020 7363 616c 6520 3a20 666c  ..    scale : fl
+0002f200: 6f61 740a 2020 2020 2020 2020 4f75 7470  oat.        Outp
+0002f210: 7574 2070 6978 656c 2073 6361 6c65 2069  ut pixel scale i
+0002f220: 6e20 6172 6373 6563 2e0a 0a20 2020 206b  n arcsec...    k
+0002f230: 6572 6e65 6c2c 2070 6978 6672 6163 203a  ernel, pixfrac :
+0002f240: 2073 7472 2c20 666c 6f61 740a 2020 2020   str, float.    
+0002f250: 2020 2020 4472 697a 7a6c 6520 7061 7261      Drizzle para
+0002f260: 6d65 7465 7273 0a0a 2020 2020 7665 7262  meters..    verb
+0002f270: 6f73 6520 3a20 626f 6f6c 0a20 2020 2020  ose : bool.     
+0002f280: 2020 2050 7269 6e74 2073 7461 7475 7320     Print status 
+0002f290: 6d65 7373 6167 6573 0a0a 2020 2020 5265  messages..    Re
+0002f2a0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+0002f2b0: 2d0a 2020 2020 6f75 7473 6369 2c20 6f75  -.    outsci, ou
+0002f2c0: 7477 6874 2c20 6f75 7463 7478 203a 2060  twht, outctx : `
+0002f2d0: 7e6e 756d 7079 2e6e 6461 7272 6179 600a  ~numpy.ndarray`.
+0002f2e0: 2020 2020 2020 2020 4f75 7470 7574 2064          Output d
+0002f2f0: 7269 7a7a 6c65 6420 7363 6965 6e63 652c  rizzled science,
+0002f300: 2077 6569 6768 7420 616e 6420 636f 6e74   weight and cont
+0002f310: 6578 7420 696d 6167 6573 0a0a 2020 2020  ext images..    
+0002f320: 6865 6164 6572 2c20 6f75 7470 7574 7763  header, outputwc
+0002f330: 7320 3a20 607e 6173 7472 6f70 792e 6669  s : `~astropy.fi
+0002f340: 7473 2e69 6f2e 4865 6164 6572 602c 2060  ts.io.Header`, `
+0002f350: 7e61 7374 726f 7079 2e77 6373 2e57 4353  ~astropy.wcs.WCS
+0002f360: 600a 2020 2020 2020 2020 4472 697a 7a6c  `.        Drizzl
+0002f370: 6564 2069 6d61 6765 2068 6561 6465 7220  ed image header 
+0002f380: 616e 6420 5743 532e 0a0a 2020 2020 2222  and WCS...    ""
+0002f390: 220a 2020 2020 6672 6f6d 2064 7269 7a7a  ".    from drizz
+0002f3a0: 6c65 7061 6320 696d 706f 7274 2061 6472  lepac import adr
+0002f3b0: 697a 7a6c 650a 2020 2020 6672 6f6d 2064  izzle.    from d
+0002f3c0: 7269 7a7a 6c65 7061 6320 696d 706f 7274  rizzlepac import
+0002f3d0: 2063 6472 697a 0a0a 2020 2020 2366 726f   cdriz..    #fro
+0002f3e0: 6d20 7374 7363 692e 746f 6f6c 7320 696d  m stsci.tools im
+0002f3f0: 706f 7274 206c 6f67 7574 696c 0a20 2020  port logutil.   
+0002f400: 2023 6c6f 6720 3d20 6c6f 6775 7469 6c2e   #log = logutil.
+0002f410: 6372 6561 7465 5f6c 6f67 6765 7228 5f5f  create_logger(__
+0002f420: 6e61 6d65 5f5f 290a 0a20 2020 2023 204f  name__)..    # O
+0002f430: 7574 7075 7420 6865 6164 6572 202f 2057  utput header / W
+0002f440: 4353 0a20 2020 2069 6620 6f75 7470 7574  CS.    if output
+0002f450: 7763 7320 6973 204e 6f6e 653a 0a20 2020  wcs is None:.   
+0002f460: 2020 2020 2023 6865 6164 6572 2c20 6f75       #header, ou
+0002f470: 7470 7574 7763 7320 3d20 636f 6d70 7574  tputwcs = comput
+0002f480: 655f 6f75 7470 7574 5f77 6373 2877 6373  e_output_wcs(wcs
+0002f490: 5f6c 6973 742c 2070 6978 656c 5f73 6361  _list, pixel_sca
+0002f4a0: 6c65 3d73 6361 6c65 290a 2020 2020 2020  le=scale).      
+0002f4b0: 2020 6865 6164 6572 2c20 6f75 7470 7574    header, output
+0002f4c0: 7763 7320 3d20 6d61 6b65 5f6d 6178 696d  wcs = make_maxim
+0002f4d0: 616c 5f77 6373 2877 6373 5f6c 6973 742c  al_wcs(wcs_list,
+0002f4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f500: 2020 2020 2020 2020 2020 2020 2020 7069                pi
+0002f510: 7865 6c5f 7363 616c 653d 7363 616c 652c  xel_scale=scale,
+0002f520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f540: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+0002f550: 7262 6f73 653d 4661 6c73 652c 0a20 2020  rbose=False,.   
+0002f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f580: 2020 2020 2020 2020 2020 7061 643d 302c            pad=0,
+0002f590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f5b0: 2020 2020 2020 2020 2020 2020 2020 6765                ge
+0002f5c0: 745f 6864 753d 4661 6c73 6529 0a20 2020  t_hdu=False).   
+0002f5d0: 2065 6c73 653a 0a20 2020 2020 2020 2068   else:.        h
+0002f5e0: 6561 6465 7220 3d20 746f 5f68 6561 6465  eader = to_heade
+0002f5f0: 7228 6f75 7470 7574 7763 7329 0a0a 2020  r(outputwcs)..  
+0002f600: 2020 6865 6164 6572 5b27 4452 495a 4b45    header['DRIZKE
+0002f610: 524e 275d 203d 206b 6572 6e65 6c2c 2022  RN'] = kernel, "
+0002f620: 4472 697a 7a6c 6520 6b65 726e 656c 220a  Drizzle kernel".
+0002f630: 2020 2020 6865 6164 6572 5b27 4452 495a      header['DRIZ
+0002f640: 5049 5846 275d 203d 2070 6978 6672 6163  PIXF'] = pixfrac
+0002f650: 2c20 2244 7269 7a7a 6c65 2070 6978 6672  , "Drizzle pixfr
+0002f660: 6163 220a 0a20 2020 2069 6620 6e6f 7420  ac"..    if not 
+0002f670: 6861 7361 7474 7228 6f75 7470 7574 7763  hasattr(outputwc
+0002f680: 732c 2027 5f6e 6178 6973 3127 293a 0a20  s, '_naxis1'):. 
+0002f690: 2020 2020 2020 206f 7574 7075 7477 6373         outputwcs
+0002f6a0: 2e5f 6e61 7869 7331 2c20 6f75 7470 7574  ._naxis1, output
+0002f6b0: 7763 732e 5f6e 6178 6973 3220 3d20 6f75  wcs._naxis2 = ou
+0002f6c0: 7470 7574 7763 732e 5f6e 6178 6973 0a0a  tputwcs._naxis..
+0002f6d0: 2020 2020 2320 5472 7920 746f 2066 6978      # Try to fix
+0002f6e0: 2064 6570 7265 6361 7465 6420 5743 530a   deprecated WCS.
+0002f6f0: 2020 2020 666f 7220 7763 735f 6920 696e      for wcs_i in
+0002f700: 2077 6373 5f6c 6973 743a 0a20 2020 2020   wcs_list:.     
+0002f710: 2020 2069 6620 6e6f 7420 6861 7361 7474     if not hasatt
+0002f720: 7228 7763 735f 692c 2027 7069 7865 6c5f  r(wcs_i, 'pixel_
+0002f730: 7368 6170 6527 293a 0a20 2020 2020 2020  shape'):.       
+0002f740: 2020 2020 2077 6373 5f69 2e70 6978 656c       wcs_i.pixel
+0002f750: 5f73 6861 7065 203d 2077 6373 5f69 2e5f  _shape = wcs_i._
+0002f760: 6e61 7869 7331 2c20 7763 735f 692e 5f6e  naxis1, wcs_i._n
+0002f770: 6178 6973 320a 0a20 2020 2020 2020 2069  axis2..        i
+0002f780: 6620 6e6f 7420 6861 7361 7474 7228 7763  f not hasattr(wc
+0002f790: 735f 692c 2027 5f6e 6178 6973 3127 293a  s_i, '_naxis1'):
+0002f7a0: 0a20 2020 2020 2020 2020 2020 2077 6373  .            wcs
+0002f7b0: 5f69 2e5f 6e61 7869 7331 2c20 7763 735f  _i._naxis1, wcs_
+0002f7c0: 692e 5f6e 6178 6973 3220 3d20 7763 735f  i._naxis2 = wcs_
+0002f7d0: 692e 5f6e 6178 6973 5b3a 325d 0a0a 2020  i._naxis[:2]..  
+0002f7e0: 2020 2320 4f75 7470 7574 2057 4353 2072    # Output WCS r
+0002f7f0: 6571 7569 7265 7320 6675 6c6c 2057 4353  equires full WCS
+0002f800: 206d 6170 3f0a 2020 2020 6966 2063 616c   map?.    if cal
+0002f810: 635f 7763 736d 6170 203c 2032 3a0a 2020  c_wcsmap < 2:.  
+0002f820: 2020 2020 2020 6374 7970 6520 3d20 6f75        ctype = ou
+0002f830: 7470 7574 7763 732e 7763 732e 6374 7970  tputwcs.wcs.ctyp
+0002f840: 650a 2020 2020 2020 2020 6966 2027 2d53  e.        if '-S
+0002f850: 4950 2720 696e 2063 7479 7065 5b30 5d3a  IP' in ctype[0]:
+0002f860: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0002f870: 6e74 2827 4f75 7470 7574 2057 4353 2028  nt('Output WCS (
+0002f880: 7b30 7d29 2072 6571 7569 7265 7320 6063  {0}) requires `c
+0002f890: 616c 635f 7763 736d 6170 3d32 6027 2e66  alc_wcsmap=2`'.f
+0002f8a0: 6f72 6d61 7428 6374 7970 6529 290a 2020  ormat(ctype)).  
+0002f8b0: 2020 2020 2020 2020 2020 6361 6c63 5f77            calc_w
+0002f8c0: 6373 6d61 7020 3d20 320a 2020 2020 2020  csmap = 2.      
+0002f8d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002f8e0: 2020 2020 2320 496e 7465 726e 616c 2057      # Internal W
+0002f8f0: 4353 4d41 5020 6e6f 7420 7265 7175 6972  CSMAP not requir
+0002f900: 6564 0a20 2020 2020 2020 2020 2020 2063  ed.            c
+0002f910: 616c 635f 7763 736d 6170 203d 2030 0a0a  alc_wcsmap = 0..
+0002f920: 2020 2020 7368 6170 6520 3d20 2868 6561      shape = (hea
+0002f930: 6465 725b 274e 4158 4953 3227 5d2c 2068  der['NAXIS2'], h
+0002f940: 6561 6465 725b 274e 4158 4953 3127 5d29  eader['NAXIS1'])
+0002f950: 0a0a 2020 2020 2320 4f75 7470 7574 2061  ..    # Output a
+0002f960: 7272 6179 730a 2020 2020 6966 2064 6174  rrays.    if dat
+0002f970: 6120 6973 206e 6f74 204e 6f6e 653a 0a20  a is not None:. 
+0002f980: 2020 2020 2020 206f 7574 7363 692c 206f         outsci, o
+0002f990: 7574 7768 742c 206f 7574 6374 7820 3d20  utwht, outctx = 
+0002f9a0: 6461 7461 0a20 2020 2065 6c73 653a 0a20  data.    else:. 
+0002f9b0: 2020 2020 2020 206f 7574 7363 6920 3d20         outsci = 
+0002f9c0: 6e70 2e7a 6572 6f73 2873 6861 7065 2c20  np.zeros(shape, 
+0002f9d0: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
+0002f9e0: 290a 2020 2020 2020 2020 6f75 7477 6874  ).        outwht
+0002f9f0: 203d 206e 702e 7a65 726f 7328 7368 6170   = np.zeros(shap
+0002fa00: 652c 2064 7479 7065 3d6e 702e 666c 6f61  e, dtype=np.floa
+0002fa10: 7433 3229 0a20 2020 2020 2020 206f 7574  t32).        out
+0002fa20: 6374 7820 3d20 6e70 2e7a 6572 6f73 2873  ctx = np.zeros(s
+0002fa30: 6861 7065 2c20 6474 7970 653d 6e70 2e69  hape, dtype=np.i
+0002fa40: 6e74 3332 290a 0a20 2020 2023 2044 6f20  nt32)..    # Do 
+0002fa50: 6472 697a 7a6c 650a 2020 2020 4e20 3d20  drizzle.    N = 
+0002fa60: 6c65 6e28 7363 695f 6c69 7374 290a 2020  len(sci_list).  
+0002fa70: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0002fa80: 284e 293a 0a20 2020 2020 2020 2069 6620  (N):.        if 
+0002fa90: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0002faa0: 2020 2020 2023 6c6f 672e 696e 666f 2827       #log.info('
+0002fab0: 4472 697a 7a6c 6520 6172 7261 7920 7b30  Drizzle array {0
+0002fac0: 7d2f 7b31 7d27 2e66 6f72 6d61 7428 692b  }/{1}'.format(i+
+0002fad0: 312c 204e 2929 0a20 2020 2020 2020 2020  1, N)).         
+0002fae0: 2020 206d 7367 203d 2027 4472 697a 7a6c     msg = 'Drizzl
+0002faf0: 6520 6172 7261 7920 7b30 7d2f 7b31 7d27  e array {0}/{1}'
+0002fb00: 2e66 6f72 6d61 7428 692b 312c 204e 290a  .format(i+1, N).
+0002fb10: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+0002fb20: 636f 6d6d 656e 7428 4c4f 4746 494c 452c  comment(LOGFILE,
+0002fb30: 206d 7367 2c20 7665 7262 6f73 653d 7665   msg, verbose=ve
+0002fb40: 7262 6f73 652c 2073 686f 775f 6461 7465  rbose, show_date
+0002fb50: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+0002fb60: 6966 2063 616c 635f 7763 736d 6170 203e  if calc_wcsmap >
+0002fb70: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0002fb80: 7763 736d 6170 203d 2057 4353 4d61 7041  wcsmap = WCSMapA
+0002fb90: 6c6c 2020 2320 2877 6373 5f6c 6973 745b  ll  # (wcs_list[
+0002fba0: 695d 2c20 6f75 7470 7574 7763 7329 0a20  i], outputwcs). 
+0002fbb0: 2020 2020 2020 2020 2020 2023 7763 736d             #wcsm
+0002fbc0: 6170 203d 2063 6472 697a 2e44 6566 6175  ap = cdriz.Defau
+0002fbd0: 6c74 5743 534d 6170 7069 6e67 0a20 2020  ltWCSMapping.   
+0002fbe0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002fbf0: 2020 2020 2020 2077 6373 6d61 7020 3d20         wcsmap = 
+0002fc00: 4e6f 6e65 0a0a 2020 2020 2020 2020 6164  None..        ad
+0002fc10: 7269 7a7a 6c65 2e64 6f5f 6472 697a 2873  rizzle.do_driz(s
+0002fc20: 6369 5f6c 6973 745b 695d 2e61 7374 7970  ci_list[i].astyp
+0002fc30: 6528 6e70 2e66 6c6f 6174 3332 2c20 636f  e(np.float32, co
+0002fc40: 7079 3d46 616c 7365 292c 0a20 2020 2020  py=False),.     
+0002fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc60: 2020 2020 7763 735f 6c69 7374 5b69 5d2c      wcs_list[i],
+0002fc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fc80: 2020 2020 2020 2020 2020 7768 745f 6c69            wht_li
+0002fc90: 7374 5b69 5d2e 6173 7479 7065 286e 702e  st[i].astype(np.
+0002fca0: 666c 6f61 7433 322c 2063 6f70 793d 4661  float32, copy=Fa
+0002fcb0: 6c73 6529 2c0a 2020 2020 2020 2020 2020  lse),.          
+0002fcc0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0002fcd0: 7574 7075 7477 6373 2c20 6f75 7473 6369  utputwcs, outsci
+0002fce0: 2c20 6f75 7477 6874 2c20 6f75 7463 7478  , outwht, outctx
+0002fcf0: 2c20 312e 2c20 2763 7073 272c 2031 2c0a  , 1., 'cps', 1,.
+0002fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fd10: 2020 2020 2020 2020 2077 6373 6c69 6e5f           wcslin_
+0002fd20: 7073 6361 6c65 3d77 6373 5f6c 6973 745b  pscale=wcs_list[
+0002fd30: 695d 2e70 7363 616c 652c 2075 6e69 7169  i].pscale, uniqi
+0002fd40: 643d 312c 0a20 2020 2020 2020 2020 2020  d=1,.           
+0002fd50: 2020 2020 2020 2020 2020 2020 2020 7069                pi
+0002fd60: 7866 7261 633d 7069 7866 7261 632c 206b  xfrac=pixfrac, k
+0002fd70: 6572 6e65 6c3d 6b65 726e 656c 2c20 6669  ernel=kernel, fi
+0002fd80: 6c6c 7661 6c3d 2730 272c 0a20 2020 2020  llval='0',.     
+0002fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fda0: 2020 2020 7763 736d 6170 3d77 6373 6d61      wcsmap=wcsma
+0002fdb0: 7029 0a0a 2020 2020 7265 7475 726e 206f  p)..    return o
+0002fdc0: 7574 7363 692c 206f 7574 7768 742c 206f  utsci, outwht, o
+0002fdd0: 7574 6374 782c 2068 6561 6465 722c 206f  utctx, header, o
+0002fde0: 7574 7075 7477 6373 0a0a 0a63 6c61 7373  utputwcs...class
+0002fdf0: 2057 4353 4d61 7041 6c6c 3a0a 2020 2020   WCSMapAll:.    
+0002fe00: 2222 2220 5361 6d70 6c65 2063 6c61 7373  """ Sample class
+0002fe10: 2074 6f20 6465 6d6f 6e73 7472 6174 6520   to demonstrate 
+0002fe20: 686f 7720 746f 2064 6566 696e 6520 6120  how to define a 
+0002fe30: 636f 6f72 6469 6e61 7465 2074 7261 6e73  coordinate trans
+0002fe40: 666f 726d 6174 696f 6e0a 2020 2020 2222  formation.    ""
+0002fe50: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
+0002fe60: 745f 5f28 7365 6c66 2c20 696e 7075 742c  t__(self, input,
+0002fe70: 206f 7574 7075 742c 206f 7269 6769 6e3d   output, origin=
+0002fe80: 3029 3a0a 2020 2020 2020 2020 2320 5665  0):.        # Ve
+0002fe90: 7269 6679 2074 6861 7420 7765 2068 6176  rify that we hav
+0002fea0: 6520 7661 6c69 6420 5743 5320 696e 7075  e valid WCS inpu
+0002feb0: 7420 6f62 6a65 6374 730a 2020 2020 2020  t objects.      
+0002fec0: 2020 696d 706f 7274 2063 6f70 790a 2020    import copy.  
+0002fed0: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
+0002fee0: 5743 5328 696e 7075 742c 2027 496e 7075  WCS(input, 'Inpu
+0002fef0: 7427 290a 2020 2020 2020 2020 7365 6c66  t').        self
+0002ff00: 2e63 6865 636b 5743 5328 6f75 7470 7574  .checkWCS(output
+0002ff10: 2c20 274f 7574 7075 7427 290a 0a20 2020  , 'Output')..   
+0002ff20: 2020 2020 2073 656c 662e 696e 7075 7420       self.input 
+0002ff30: 3d20 696e 7075 740a 2020 2020 2020 2020  = input.        
+0002ff40: 7365 6c66 2e6f 7574 7075 7420 3d20 636f  self.output = co
+0002ff50: 7079 2e64 6565 7063 6f70 7928 6f75 7470  py.deepcopy(outp
+0002ff60: 7574 290a 2020 2020 2020 2020 2373 656c  ut).        #sel
+0002ff70: 662e 6f75 7470 7574 203d 206f 7574 7075  f.output = outpu
+0002ff80: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
+0002ff90: 6f72 6967 696e 203d 2031 2023 6f72 6967  origin = 1 #orig
+0002ffa0: 696e 0a20 2020 2020 2020 2073 656c 662e  in.        self.
+0002ffb0: 7368 6966 7420 3d20 4e6f 6e65 0a20 2020  shift = None.   
+0002ffc0: 2020 2020 2073 656c 662e 726f 7420 3d20       self.rot = 
+0002ffd0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+0002ffe0: 662e 7363 616c 6520 3d20 4e6f 6e65 0a0a  f.scale = None..
+0002fff0: 2020 2020 6465 6620 6368 6563 6b57 4353      def checkWCS
+00030000: 2873 656c 662c 206f 626a 2c20 6e61 6d65  (self, obj, name
+00030010: 293a 0a20 2020 2020 2020 2074 7279 3a0a  ):.        try:.
+00030020: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00030030: 7274 2069 7369 6e73 7461 6e63 6528 6f62  rt isinstance(ob
+00030040: 6a2c 2070 7977 6373 2e57 4353 290a 2020  j, pywcs.WCS).  
+00030050: 2020 2020 2020 6578 6365 7074 2041 7373        except Ass
+00030060: 6572 7469 6f6e 4572 726f 723a 0a20 2020  ertionError:.   
+00030070: 2020 2020 2020 2020 2070 7269 6e74 286e           print(n
+00030080: 616d 6520 2b20 2720 6f62 6a65 6374 206e  ame + ' object n
+00030090: 6565 6473 2074 6f20 6265 2061 6e20 696e  eeds to be an in
+000300a0: 7374 616e 6365 206f 7220 7375 6263 6c61  stance or subcla
+000300b0: 7373 206f 6620 6120 5079 5743 5320 6f62  ss of a PyWCS ob
+000300c0: 6a65 6374 2e27 290a 2020 2020 2020 2020  ject.').        
+000300d0: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
+000300e0: 6566 2066 6f72 7761 7264 2873 656c 662c  ef forward(self,
+000300f0: 2070 6978 782c 2070 6978 7929 3a0a 2020   pixx, pixy):.  
+00030100: 2020 2020 2020 2222 2220 5472 616e 7366        """ Transf
+00030110: 6f72 6d20 7468 6520 696e 7075 7420 7069  orm the input pi
+00030120: 7878 2c70 6978 7920 706f 7369 7469 6f6e  xx,pixy position
+00030130: 7320 696e 2074 6865 2069 6e70 7574 2066  s in the input f
+00030140: 7261 6d65 0a20 2020 2020 2020 2020 2020  rame.           
+00030150: 2074 6f20 7069 7865 6c20 706f 7369 7469   to pixel positi
+00030160: 6f6e 7320 696e 2074 6865 206f 7574 7075  ons in the outpu
+00030170: 7420 6672 616d 652e 0a0a 2020 2020 2020  t frame...      
+00030180: 2020 2020 2020 5468 6973 206d 6574 686f        This metho
+00030190: 6420 6765 7473 2070 6173 7365 6420 746f  d gets passed to
+000301a0: 2074 6865 2064 7269 7a7a 6c65 2061 6c67   the drizzle alg
+000301b0: 6f72 6974 686d 2e0a 2020 2020 2020 2020  orithm..        
+000301c0: 2222 220a 2020 2020 2020 2020 2320 5468  """.        # Th
+000301d0: 6973 206d 6174 6368 6573 2057 5452 4158  is matches WTRAX
+000301e0: 5920 7265 7375 6c74 7320 746f 2062 6574  Y results to bet
+000301f0: 7465 7220 7468 616e 2031 652d 3420 7069  ter than 1e-4 pi
+00030200: 7865 6c73 2e0a 2020 2020 2020 2020 736b  xels..        sk
+00030210: 7978 2c20 736b 7979 203d 2073 656c 662e  yx, skyy = self.
+00030220: 696e 7075 742e 616c 6c5f 7069 7832 776f  input.all_pix2wo
+00030230: 726c 6428 7069 7878 2c20 7069 7879 2c20  rld(pixx, pixy, 
+00030240: 7365 6c66 2e6f 7269 6769 6e29 0a20 2020  self.origin).   
+00030250: 2020 2020 2072 6573 756c 7420 3d20 7365       result = se
+00030260: 6c66 2e6f 7574 7075 742e 616c 6c5f 776f  lf.output.all_wo
+00030270: 726c 6432 7069 7828 736b 7978 2c20 736b  rld2pix(skyx, sk
+00030280: 7979 2c20 7365 6c66 2e6f 7269 6769 6e29  yy, self.origin)
+00030290: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000302a0: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
+000302b0: 6261 636b 7761 7264 2873 656c 662c 2070  backward(self, p
+000302c0: 6978 782c 2070 6978 7929 3a0a 2020 2020  ixx, pixy):.    
+000302d0: 2020 2020 2222 2220 5472 616e 7366 6f72      """ Transfor
+000302e0: 6d20 7069 7878 2c70 6978 7920 706f 7369  m pixx,pixy posi
+000302f0: 7469 6f6e 7320 6672 6f6d 2074 6865 206f  tions from the o
+00030300: 7574 7075 7420 6672 616d 6520 6261 636b  utput frame back
+00030310: 206f 6e74 6f20 7468 6569 720a 2020 2020   onto their.    
+00030320: 2020 2020 2020 2020 6f72 6967 696e 616c          original
+00030330: 2070 6f73 6974 696f 6e73 2069 6e20 7468   positions in th
+00030340: 6520 696e 7075 7420 6672 616d 652e 0a20  e input frame.. 
+00030350: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00030360: 2020 2073 6b79 782c 2073 6b79 7920 3d20     skyx, skyy = 
+00030370: 7365 6c66 2e6f 7574 7075 742e 616c 6c5f  self.output.all_
+00030380: 7069 7832 776f 726c 6428 7069 7878 2c20  pix2world(pixx, 
+00030390: 7069 7879 2c20 7365 6c66 2e6f 7269 6769  pixy, self.origi
+000303a0: 6e29 0a20 2020 2020 2020 2072 6573 756c  n).        resul
+000303b0: 7420 3d20 7365 6c66 2e69 6e70 7574 2e61  t = self.input.a
+000303c0: 6c6c 5f77 6f72 6c64 3270 6978 2873 6b79  ll_world2pix(sky
+000303d0: 782c 2073 6b79 792c 2073 656c 662e 6f72  x, skyy, self.or
+000303e0: 6967 696e 290a 2020 2020 2020 2020 7265  igin).        re
+000303f0: 7475 726e 2072 6573 756c 740a 0a20 2020  turn result..   
+00030400: 2064 6566 2067 6574 5f70 6978 5f72 6174   def get_pix_rat
+00030410: 696f 2873 656c 6629 3a0a 2020 2020 2020  io(self):.      
+00030420: 2020 2222 2220 5265 7475 726e 2074 6865    """ Return the
+00030430: 2072 6174 696f 206f 6620 706c 6174 6520   ratio of plate 
+00030440: 7363 616c 6573 2062 6574 7765 656e 2074  scales between t
+00030450: 6865 2069 6e70 7574 2061 6e64 206f 7574  he input and out
+00030460: 7075 7420 5743 532e 0a20 2020 2020 2020  put WCS..       
+00030470: 2020 2020 2054 6869 7320 6973 2075 7365       This is use
+00030480: 6420 746f 2070 726f 7065 726c 7920 6469  d to properly di
+00030490: 7374 7269 6275 7465 2074 6865 2066 6c75  stribute the flu
+000304a0: 7820 696e 2065 6163 6820 7069 7865 6c20  x in each pixel 
+000304b0: 696e 2027 7464 7269 7a27 2e0a 2020 2020  in 'tdriz'..    
+000304c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000304d0: 7265 7475 726e 2073 656c 662e 6f75 7470  return self.outp
+000304e0: 7574 2e70 7363 616c 6520 2f20 7365 6c66  ut.pscale / self
+000304f0: 2e69 6e70 7574 2e70 7363 616c 650a 0a20  .input.pscale.. 
+00030500: 2020 2064 6566 2078 7932 7264 2873 656c     def xy2rd(sel
+00030510: 662c 2077 6373 2c20 7069 7878 2c20 7069  f, wcs, pixx, pi
+00030520: 7879 293a 0a20 2020 2020 2020 2022 2222  xy):.        """
+00030530: 2054 7261 6e73 666f 726d 2069 6e70 7574   Transform input
+00030540: 2070 6978 656c 2070 6f73 6974 696f 6e73   pixel positions
+00030550: 2069 6e74 6f20 736b 7920 706f 7369 7469   into sky positi
+00030560: 6f6e 7320 696e 2074 6865 2057 4353 2070  ons in the WCS p
+00030570: 726f 7669 6465 642e 0a20 2020 2020 2020  rovided..       
+00030580: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00030590: 7572 6e20 7763 732e 616c 6c5f 7069 7832  urn wcs.all_pix2
+000305a0: 776f 726c 6428 7069 7878 2c20 7069 7879  world(pixx, pixy
+000305b0: 2c20 3129 0a0a 2020 2020 6465 6620 7264  , 1)..    def rd
+000305c0: 3278 7928 7365 6c66 2c20 7763 732c 2072  2xy(self, wcs, r
+000305d0: 612c 2064 6563 293a 0a20 2020 2020 2020  a, dec):.       
+000305e0: 2022 2222 2054 7261 6e73 666f 726d 2069   """ Transform i
+000305f0: 6e70 7574 2073 6b79 2070 6f73 6974 696f  nput sky positio
+00030600: 6e73 2069 6e74 6f20 7069 7865 6c20 706f  ns into pixel po
+00030610: 7369 7469 6f6e 7320 696e 2074 6865 2057  sitions in the W
+00030620: 4353 2070 726f 7669 6465 642e 0a20 2020  CS provided..   
+00030630: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00030640: 2072 6574 7572 6e20 7763 732e 616c 6c5f   return wcs.all_
+00030650: 776f 726c 6432 7069 7828 7261 2c20 6465  world2pix(ra, de
+00030660: 632c 2031 290a 0a0a 6465 6620 636f 6d70  c, 1)...def comp
+00030670: 7574 655f 6f75 7470 7574 5f77 6373 2877  ute_output_wcs(w
+00030680: 6373 5f6c 6973 742c 2070 6978 656c 5f73  cs_list, pixel_s
+00030690: 6361 6c65 3d30 2e31 2c20 6d61 785f 7369  cale=0.1, max_si
+000306a0: 7a65 3d31 3030 3030 293a 0a20 2020 2022  ze=10000):.    "
+000306b0: 2222 0a20 2020 2043 6f6d 7075 7465 206f  "".    Compute o
+000306c0: 7574 7075 7420 5743 5320 7468 6174 2063  utput WCS that c
+000306d0: 6f6e 7461 696e 7320 7468 6520 6675 6c6c  ontains the full
+000306e0: 206c 6973 7420 6f66 2069 6e70 7574 2057   list of input W
+000306f0: 4353 0a0a 2020 2020 5061 7261 6d65 7465  CS..    Paramete
+00030700: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00030710: 2d0a 2020 2020 7763 735f 6c69 7374 203a  -.    wcs_list :
+00030720: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
+00030730: 7374 206f 6620 696e 6469 7669 6475 616c  st of individual
+00030740: 2060 7e61 7374 726f 7079 2e77 6373 2e57   `~astropy.wcs.W
+00030750: 4353 6020 6f62 6a65 6374 732e 0a0a 2020  CS` objects...  
+00030760: 2020 7069 7865 6c5f 7363 616c 6520 3a20    pixel_scale : 
+00030770: 7479 7065 0a20 2020 2020 2020 2050 6978  type.        Pix
+00030780: 656c 2073 6361 6c65 206f 6620 7468 6520  el scale of the 
+00030790: 6f75 7470 7574 2057 4353 0a0a 2020 2020  output WCS..    
+000307a0: 6d61 785f 7369 7a65 203a 2069 6e74 0a20  max_size : int. 
+000307b0: 2020 2020 2020 204d 6178 696d 756d 2073         Maximum s
+000307c0: 697a 6520 6f75 7420 7468 6520 6f75 7470  ize out the outp
+000307d0: 7574 2069 6d61 6765 2064 696d 656e 7369  ut image dimensi
+000307e0: 6f6e 730a 0a20 2020 2052 6574 7572 6e73  ons..    Returns
+000307f0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00030800: 2068 6561 6465 7220 3a20 607e 6173 7472   header : `~astr
+00030810: 6f70 792e 696f 2e66 6974 732e 4865 6164  opy.io.fits.Head
+00030820: 6572 600a 2020 2020 2020 2020 5743 5320  er`.        WCS 
+00030830: 6865 6164 6572 0a0a 2020 2020 6f75 7470  header..    outp
+00030840: 7574 7763 7320 3a20 607e 6173 7472 6f70  utwcs : `~astrop
+00030850: 792e 7763 732e 5743 5360 0a20 2020 2020  y.wcs.WCS`.     
+00030860: 2020 204f 7574 7075 7420 5743 530a 0a20     Output WCS.. 
+00030870: 2020 2022 2222 0a20 2020 2066 726f 6d20     """.    from 
+00030880: 7368 6170 656c 792e 6765 6f6d 6574 7279  shapely.geometry
+00030890: 2069 6d70 6f72 7420 506f 6c79 676f 6e0a   import Polygon.
+000308a0: 0a20 2020 2066 6f6f 7470 7269 6e74 203d  .    footprint =
+000308b0: 2050 6f6c 7967 6f6e 2877 6373 5f6c 6973   Polygon(wcs_lis
+000308c0: 745b 305d 2e63 616c 635f 666f 6f74 7072  t[0].calc_footpr
+000308d0: 696e 7428 2929 0a20 2020 2066 6f72 2069  int()).    for i
+000308e0: 2069 6e20 7261 6e67 6528 312c 206c 656e   in range(1, len
+000308f0: 2877 6373 5f6c 6973 7429 293a 0a20 2020  (wcs_list)):.   
+00030900: 2020 2020 2066 705f 6920 3d20 506f 6c79       fp_i = Poly
+00030910: 676f 6e28 7763 735f 6c69 7374 5b69 5d2e  gon(wcs_list[i].
+00030920: 6361 6c63 5f66 6f6f 7470 7269 6e74 2829  calc_footprint()
+00030930: 290a 2020 2020 2020 2020 666f 6f74 7072  ).        footpr
+00030940: 696e 7420 3d20 666f 6f74 7072 696e 742e  int = footprint.
+00030950: 756e 696f 6e28 6670 5f69 290a 0a20 2020  union(fp_i)..   
+00030960: 2078 2c20 7920 3d20 666f 6f74 7072 696e   x, y = footprin
+00030970: 742e 636f 6e76 6578 5f68 756c 6c2e 626f  t.convex_hull.bo
+00030980: 756e 6461 7279 2e78 790a 2020 2020 782c  undary.xy.    x,
+00030990: 2079 203d 206e 702e 6172 7261 7928 7829   y = np.array(x)
+000309a0: 2c20 6e70 2e61 7272 6179 2879 290a 0a20  , np.array(y).. 
+000309b0: 2020 2023 2063 656e 7465 720a 2020 2020     # center.    
+000309c0: 6372 7661 6c20 3d20 6e70 2e61 7272 6179  crval = np.array
+000309d0: 2866 6f6f 7470 7269 6e74 2e63 656e 7472  (footprint.centr
+000309e0: 6f69 642e 7879 292e 666c 6174 7465 6e28  oid.xy).flatten(
+000309f0: 290a 0a20 2020 2023 2064 696d 656e 7369  )..    # dimensi
+00030a00: 6f6e 7320 696e 2061 7263 7365 630a 2020  ons in arcsec.  
+00030a10: 2020 7873 697a 6520 3d20 2878 2e6d 6178    xsize = (x.max
+00030a20: 2829 2d78 2e6d 696e 2829 292a 6e70 2e63  ()-x.min())*np.c
+00030a30: 6f73 2863 7276 616c 5b31 5d2f 3138 302a  os(crval[1]/180*
+00030a40: 6e70 2e70 6929 2a33 3630 300a 2020 2020  np.pi)*3600.    
+00030a50: 7973 697a 6520 3d20 2879 2e6d 6178 2829  ysize = (y.max()
+00030a60: 2d79 2e6d 696e 2829 292a 3336 3030 0a0a  -y.min())*3600..
+00030a70: 2020 2020 7873 697a 6520 3d20 6e70 2e6d      xsize = np.m
+00030a80: 696e 696d 756d 2878 7369 7a65 2c20 6d61  inimum(xsize, ma
+00030a90: 785f 7369 7a65 2a70 6978 656c 5f73 6361  x_size*pixel_sca
+00030aa0: 6c65 290a 2020 2020 7973 697a 6520 3d20  le).    ysize = 
+00030ab0: 6e70 2e6d 696e 696d 756d 2879 7369 7a65  np.minimum(ysize
+00030ac0: 2c20 6d61 785f 7369 7a65 2a70 6978 656c  , max_size*pixel
+00030ad0: 5f73 6361 6c65 290a 0a20 2020 2068 6561  _scale)..    hea
+00030ae0: 6465 722c 206f 7574 7075 7477 6373 203d  der, outputwcs =
+00030af0: 206d 616b 655f 7763 7368 6561 6465 7228   make_wcsheader(
+00030b00: 7261 3d63 7276 616c 5b30 5d2c 2064 6563  ra=crval[0], dec
+00030b10: 3d63 7276 616c 5b31 5d2c 0a20 2020 2020  =crval[1],.     
+00030b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b30: 7369 7a65 3d28 7873 697a 652c 2079 7369  size=(xsize, ysi
+00030b40: 7a65 292c 0a20 2020 2020 2020 2020 2020  ze),.           
+00030b50: 2020 2020 2020 2020 2020 7069 7873 6361            pixsca
+00030b60: 6c65 3d70 6978 656c 5f73 6361 6c65 2c0a  le=pixel_scale,.
+00030b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b80: 2020 2020 2067 6574 5f68 6475 3d46 616c       get_hdu=Fal
+00030b90: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00030ba0: 2020 2020 2020 2020 2074 6865 7461 3d30           theta=0
+00030bb0: 290a 0a20 2020 2072 6574 7572 6e20 6865  )..    return he
+00030bc0: 6164 6572 2c20 6f75 7470 7574 7763 730a  ader, outputwcs.
+00030bd0: 0a0a 6465 6620 7379 6d6c 696e 6b5f 7465  ..def symlink_te
+00030be0: 6d70 6c61 7465 7328 666f 7263 653d 4661  mplates(force=Fa
+00030bf0: 6c73 6529 3a0a 2020 2020 2222 2253 796d  lse):.    """Sym
+00030c00: 6c69 6e6b 2074 656d 706c 6174 6573 2066  link templates f
+00030c10: 726f 6d20 6d6f 6475 6c65 2074 6f20 2447  rom module to $G
+00030c20: 5249 5a4c 492f 7465 6d70 6c61 7465 7320  RIZLI/templates 
+00030c30: 6173 2070 6172 7420 6f66 2074 6865 2069  as part of the i
+00030c40: 6e69 7469 616c 2073 6574 7570 0a20 2020  nitial setup.   
+00030c50: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00030c60: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2066  ----------.    f
+00030c70: 6f72 6365 203a 2062 6f6f 6c0a 2020 2020  orce : bool.    
+00030c80: 2020 2020 466f 7263 6520 6c69 6e6b 2066      Force link f
+00030c90: 696c 6573 2065 7665 6e20 6966 2074 6865  iles even if the
+00030ca0: 7920 616c 7265 6164 7920 6578 6973 742e  y already exist.
+00030cb0: 0a20 2020 2022 2222 0a20 2020 2023 2069  .    """.    # i
+00030cc0: 6620 2747 5249 5a4c 4927 206e 6f74 2069  f 'GRIZLI' not i
+00030cd0: 6e20 6f73 2e65 6e76 6972 6f6e 3a0a 2020  n os.environ:.  
+00030ce0: 2020 2320 2020 2020 7072 696e 7428 2722    #     print('"
+00030cf0: 4752 495a 4c49 2220 656e 7669 726f 6e6d  GRIZLI" environm
+00030d00: 656e 7420 7661 7269 6162 6c65 206e 6f74  ent variable not
+00030d10: 2073 6574 2127 290a 2020 2020 2320 2020   set!').    #   
+00030d20: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+00030d30: 2020 2020 6d6f 6475 6c65 5f70 6174 6820      module_path 
+00030d40: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
+00030d50: 6528 5f5f 6669 6c65 5f5f 290a 2020 2020  e(__file__).    
+00030d60: 7465 6d70 6c61 7465 735f 7061 7468 203d  templates_path =
+00030d70: 206f 732e 7061 7468 2e6a 6f69 6e28 6d6f   os.path.join(mo
+00030d80: 6475 6c65 5f70 6174 682c 2027 6461 7461  dule_path, 'data
+00030d90: 2f74 656d 706c 6174 6573 2729 0a0a 2020  /templates')..  
+00030da0: 2020 6f75 745f 7061 7468 203d 206f 732e    out_path = os.
+00030db0: 7061 7468 2e6a 6f69 6e28 4752 495a 4c49  path.join(GRIZLI
+00030dc0: 5f50 4154 482c 2027 7465 6d70 6c61 7465  _PATH, 'template
+00030dd0: 7327 290a 0a20 2020 2069 6620 286e 6f74  s')..    if (not
+00030de0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
+00030df0: 6f75 745f 7061 7468 2929 207c 2066 6f72  out_path)) | for
+00030e00: 6365 3a0a 2020 2020 2020 2020 6966 206f  ce:.        if o
+00030e10: 732e 7061 7468 2e65 7869 7374 7328 6f75  s.path.exists(ou
+00030e20: 745f 7061 7468 293a 2020 2320 2866 6f72  t_path):  # (for
+00030e30: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
+00030e40: 7368 7574 696c 2e72 6d74 7265 6528 6f75  shutil.rmtree(ou
+00030e50: 745f 7061 7468 290a 0a20 2020 2020 2020  t_path)..       
+00030e60: 2020 2020 206f 732e 7379 6d6c 696e 6b28       os.symlink(
+00030e70: 7465 6d70 6c61 7465 735f 7061 7468 2c20  templates_path, 
+00030e80: 6f75 745f 7061 7468 290a 2020 2020 2020  out_path).      
+00030e90: 2020 2020 2020 7072 696e 7428 2753 796d        print('Sym
+00030ea0: 6c69 6e6b 3a20 7b30 7d20 2d3e 207b 317d  link: {0} -> {1}
+00030eb0: 272e 666f 726d 6174 2874 656d 706c 6174  '.format(templat
+00030ec0: 6573 5f70 6174 682c 206f 7574 5f70 6174  es_path, out_pat
+00030ed0: 6829 290a 2020 2020 656c 7365 3a0a 2020  h)).    else:.  
+00030ee0: 2020 2020 2020 7072 696e 7428 2754 656d        print('Tem
+00030ef0: 706c 6174 6573 2064 6972 6563 746f 7279  plates directory
+00030f00: 2065 7869 7374 733a 207b 307d 272e 666f   exists: {0}'.fo
+00030f10: 726d 6174 286f 7574 5f70 6174 6829 290a  rmat(out_path)).
+00030f20: 2020 2020 2020 2020 7072 696e 7428 2755          print('U
+00030f30: 7365 2060 666f 7263 653d 5472 7565 6020  se `force=True` 
+00030f40: 746f 2066 6f72 6365 2061 206e 6577 2073  to force a new s
+00030f50: 796d 626f 6c69 6320 6c69 6e6b 2e27 290a  ymbolic link.').
+00030f60: 0a0a 6465 6620 6665 7463 685f 6163 735f  ..def fetch_acs_
+00030f70: 7763 735f 6669 6c65 7328 6265 616d 735f  wcs_files(beams_
+00030f80: 6669 6c65 2c20 6275 636b 6574 5f6e 616d  file, bucket_nam
+00030f90: 653d 2767 7269 7a6c 692d 7631 2729 3a0a  e='grizli-v1'):.
+00030fa0: 2020 2020 2222 220a 2020 2020 4665 7463      """.    Fetc
+00030fb0: 6820 7763 7320 6669 6c65 7320 666f 7220  h wcs files for 
+00030fc0: 6120 6769 7665 6e20 6265 616d 732e 6669  a given beams.fi
+00030fd0: 7473 2066 696c 6573 0a20 2020 2022 2222  ts files.    """
+00030fe0: 0a20 2020 2066 726f 6d20 7572 6c6c 6962  .    from urllib
+00030ff0: 2069 6d70 6f72 7420 7265 7175 6573 740a   import request.
+00031000: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00031010: 2069 6d70 6f72 7420 626f 746f 330a 2020   import boto3.  
+00031020: 2020 2020 2020 4841 535f 424f 544f 203d        HAS_BOTO =
+00031030: 2054 7275 650a 2020 2020 6578 6365 7074   True.    except
+00031040: 3a0a 2020 2020 2020 2020 4841 535f 424f  :.        HAS_BO
+00031050: 544f 203d 2046 616c 7365 0a0a 2020 2020  TO = False..    
+00031060: 696d 203d 2070 7966 6974 732e 6f70 656e  im = pyfits.open
+00031070: 2862 6561 6d73 5f66 696c 6529 0a20 2020  (beams_file).   
+00031080: 2072 6f6f 7420 3d20 275f 272e 6a6f 696e   root = '_'.join
+00031090: 2862 6561 6d73 5f66 696c 652e 7370 6c69  (beams_file.spli
+000310a0: 7428 275f 2729 5b3a 2d31 5d29 0a0a 2020  t('_')[:-1])..  
+000310b0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+000310c0: 286c 656e 2869 6d29 293a 0a20 2020 2020  (len(im)):.     
+000310d0: 2020 2068 203d 2069 6d5b 695d 2e68 6561     h = im[i].hea
+000310e0: 6465 720a 2020 2020 2020 2020 6966 2027  der.        if '
+000310f0: 4558 544e 414d 4527 206e 6f74 2069 6e20  EXTNAME' not in 
+00031100: 683a 0a20 2020 2020 2020 2020 2020 2063  h:.            c
+00031110: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+00031120: 2069 6620 2746 494c 5445 5227 206e 6f74   if 'FILTER' not
+00031130: 2069 6e20 683a 0a20 2020 2020 2020 2020   in h:.         
+00031140: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+00031150: 2020 2020 2069 6620 2868 5b27 4558 544e       if (h['EXTN
+00031160: 414d 4527 5d20 213d 2027 5343 4927 2920  AME'] != 'SCI') 
+00031170: 7c20 2868 5b27 4649 4c54 4552 275d 206e  | (h['FILTER'] n
+00031180: 6f74 2069 6e20 5b27 4738 3030 4c27 5d29  ot in ['G800L'])
+00031190: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000311a0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+000311b0: 6578 7420 3d20 7b31 3a20 322c 2032 3a20  ext = {1: 2, 2: 
+000311c0: 317d 5b68 5b27 4343 4443 4849 5027 5d5d  1}[h['CCDCHIP']]
+000311d0: 0a0a 2020 2020 2020 2020 7763 7366 696c  ..        wcsfil
+000311e0: 6520 3d20 685b 2747 5041 5245 4e54 275d  e = h['GPARENT']
+000311f0: 2e72 6570 6c61 6365 2827 2e66 6974 7327  .replace('.fits'
+00031200: 2c20 272e 7b30 3a30 3264 7d2e 7763 732e  , '.{0:02d}.wcs.
+00031210: 6669 7473 272e 666f 726d 6174 2865 7874  fits'.format(ext
+00031220: 2929 0a0a 2020 2020 2020 2020 2320 446f  ))..        # Do
+00031230: 776e 6c6f 6164 2074 6865 2066 696c 6520  wnload the file 
+00031240: 7769 7468 2053 3320 6f72 2048 5454 500a  with S3 or HTTP.
+00031250: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
+00031260: 732e 7061 7468 2e65 7869 7374 7328 7763  s.path.exists(wc
+00031270: 7366 696c 6529 3a0a 2020 2020 2020 2020  sfile):.        
+00031280: 2020 2020 7072 696e 7428 2746 6574 6368      print('Fetch
+00031290: 207b 307d 2066 726f 6d20 7b31 7d2f 5069   {0} from {1}/Pi
+000312a0: 7065 6c69 6e65 2f7b 327d 272e 666f 726d  peline/{2}'.form
+000312b0: 6174 2877 6373 6669 6c65 2c0a 2020 2020  at(wcsfile,.    
+000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000312e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312f0: 7072 696e 7428 2746 6574 6368 2057 4353  print('Fetch WCS
-00031300: 2066 696c 653a 207b 307d 272e 666f 726d   file: {0}'.form
-00031310: 6174 2875 726c 2929 0a20 2020 2020 2020  at(url)).       
-00031320: 2020 2020 2020 2020 2072 6571 203d 2072           req = r
-00031330: 6571 7565 7374 2e75 726c 7265 7472 6965  equest.urlretrie
-00031340: 7665 2875 726c 2c20 7763 7366 696c 6529  ve(url, wcsfile)
-00031350: 0a0a 2020 2020 696d 2e63 6c6f 7365 2829  ..    im.close()
-00031360: 0a0a 0a64 6566 2066 6574 6368 5f68 7374  ...def fetch_hst
-00031370: 5f63 616c 6962 2866 696c 653d 2769 7265  _calib(file='ire
-00031380: 6624 7563 3732 3131 336f 695f 7066 6c2e  f$uc72113oi_pfl.
-00031390: 6669 7473 272c 2020 6674 7064 6972 3d27  fits',  ftpdir='
-000313a0: 6874 7470 733a 2f2f 6873 742d 6372 6473  https://hst-crds
-000313b0: 2e73 7473 6369 2e65 6475 2f75 6e63 6865  .stsci.edu/unche
-000313c0: 636b 6564 5f67 6574 2f72 6566 6572 656e  cked_get/referen
-000313d0: 6365 732f 6873 742f 272c 2076 6572 626f  ces/hst/', verbo
-000313e0: 7365 3d54 7275 652c 2072 6566 5f70 6174  se=True, ref_pat
-000313f0: 6873 3d7b 7d2c 2072 656d 6f76 655f 636f  hs={}, remove_co
-00031400: 7272 7570 743d 5472 7565 293a 0a20 2020  rrupt=True):.   
-00031410: 2022 2222 0a20 2020 2054 4244 0a20 2020   """.    TBD.   
-00031420: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
-00031430: 6f73 0a0a 2020 2020 7265 665f 6469 7220  os..    ref_dir 
-00031440: 3d20 6669 6c65 2e73 706c 6974 2827 2427  = file.split('$'
-00031450: 295b 305d 0a20 2020 2063 696d 6720 3d20  )[0].    cimg = 
-00031460: 6669 6c65 2e73 706c 6974 2827 7b30 7d24  file.split('{0}$
-00031470: 272e 666f 726d 6174 2872 6566 5f64 6972  '.format(ref_dir
-00031480: 2929 5b31 5d0a 2020 2020 0a20 2020 2069  ))[1].    .    i
-00031490: 6620 7265 665f 6469 7220 696e 2072 6566  f ref_dir in ref
-000314a0: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
-000314b0: 7265 665f 7061 7468 203d 2072 6566 5f70  ref_path = ref_p
-000314c0: 6174 6873 5b72 6566 5f64 6972 5d0a 2020  aths[ref_dir].  
-000314d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000314e0: 7265 665f 7061 7468 203d 206f 732e 6765  ref_path = os.ge
-000314f0: 7465 6e76 2872 6566 5f64 6972 290a 2020  tenv(ref_dir).  
-00031500: 2020 2020 2020 0a20 2020 2069 7265 665f        .    iref_
-00031510: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
-00031520: 6f69 6e28 7265 665f 7061 7468 2c20 6369  oin(ref_path, ci
-00031530: 6d67 290a 2020 2020 6966 206e 6f74 206f  mg).    if not o
-00031540: 732e 7061 7468 2e65 7869 7374 7328 6972  s.path.exists(ir
-00031550: 6566 5f66 696c 6529 3a0a 2020 2020 2020  ef_file):.      
-00031560: 2020 6f73 2e73 7973 7465 6d28 2763 7572    os.system('cur
-00031570: 6c20 2d6f 207b 307d 207b 317d 2f7b 327d  l -o {0} {1}/{2}
-00031580: 272e 666f 726d 6174 2869 7265 665f 6669  '.format(iref_fi
-00031590: 6c65 2c20 6674 7064 6972 2c20 6369 6d67  le, ftpdir, cimg
-000315a0: 2929 0a20 2020 2020 2020 2069 6620 2766  )).        if 'f
-000315b0: 6974 7327 2069 6e20 6972 6566 5f66 696c  its' in iref_fil
-000315c0: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-000315d0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000315e0: 2020 2020 5f69 6d20 3d20 2070 7966 6974      _im =  pyfit
-000315f0: 732e 6f70 656e 2869 7265 665f 6669 6c65  s.open(iref_file
-00031600: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00031610: 2020 5f69 6d2e 636c 6f73 6528 290a 2020    _im.close().  
-00031620: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00031630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031640: 2020 6d73 6720 3d20 2827 446f 776e 6c6f    msg = ('Downlo
-00031650: 6164 6564 2066 696c 6520 7b30 7d20 6170  aded file {0} ap
-00031660: 7065 6172 7320 746f 2062 6520 636f 7272  pears to be corr
-00031670: 7570 742e 5c6e 270a 2020 2020 2020 2020  upt.\n'.        
-00031680: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00031690: 4368 6563 6b20 7468 6174 207b 317d 2f7b  Check that {1}/{
-000316a0: 327d 2065 7869 7374 7320 616e 6420 6973  2} exists and is
-000316b0: 2061 2076 616c 6964 2066 696c 6527 290a   a valid file').
-000316c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000316d0: 2070 7269 6e74 286d 7367 2e66 6f72 6d61   print(msg.forma
-000316e0: 7428 6972 6566 5f66 696c 652c 2066 7470  t(iref_file, ftp
-000316f0: 6469 722c 2063 696d 6729 290a 2020 2020  dir, cimg)).    
-00031700: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00031710: 656d 6f76 655f 636f 7272 7570 743a 0a20  emove_corrupt:. 
-00031720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031730: 2020 206f 732e 7265 6d6f 7665 2869 7265     os.remove(ire
-00031740: 665f 6669 6c65 290a 0a20 2020 2020 2020  f_file)..       
-00031750: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00031760: 4661 6c73 650a 2020 2020 656c 7365 3a0a  False.    else:.
-00031770: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00031780: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00031790: 7072 696e 7428 277b 307d 2065 7869 7374  print('{0} exist
-000317a0: 7327 2e66 6f72 6d61 7428 6972 6566 5f66  s'.format(iref_f
-000317b0: 696c 6529 290a 0a20 2020 2072 6574 7572  ile))..    retur
-000317c0: 6e20 6972 6566 5f66 696c 650a 0a0a 6465  n iref_file...de
-000317d0: 6620 6665 7463 685f 6873 745f 6361 6c69  f fetch_hst_cali
-000317e0: 6273 2866 6c74 5f66 696c 652c 2066 7470  bs(flt_file, ftp
-000317f0: 6469 723d 2768 7474 7073 3a2f 2f68 7374  dir='https://hst
-00031800: 2d63 7264 732e 7374 7363 692e 6564 752f  -crds.stsci.edu/
-00031810: 756e 6368 6563 6b65 645f 6765 742f 7265  unchecked_get/re
-00031820: 6665 7265 6e63 6573 2f68 7374 2f27 2c20  ferences/hst/', 
-00031830: 6361 6c69 625f 7479 7065 733d 5b27 4250  calib_types=['BP
-00031840: 4958 5441 4227 2c20 2743 4344 5441 4227  IXTAB', 'CCDTAB'
-00031850: 2c20 274f 5343 4e54 4142 272c 2027 4352  , 'OSCNTAB', 'CR
-00031860: 5245 4a54 4142 272c 2027 4441 524b 4649  REJTAB', 'DARKFI
-00031870: 4c45 272c 2027 4e4c 494e 4649 4c45 272c  LE', 'NLINFILE',
-00031880: 2027 4446 4c54 4649 4c45 272c 2750 464c   'DFLTFILE','PFL
-00031890: 5446 494c 4527 2c20 2749 4d50 4854 5441  TFILE', 'IMPHTTA
-000318a0: 4227 2c20 2749 4443 5441 4227 2c20 274e  B', 'IDCTAB', 'N
-000318b0: 504f 4c46 494c 4527 5d2c 2076 6572 626f  POLFILE'], verbo
-000318c0: 7365 3d54 7275 652c 2072 6566 5f70 6174  se=True, ref_pat
-000318d0: 6873 3d7b 7d29 3a0a 2020 2020 2222 220a  hs={}):.    """.
-000318e0: 2020 2020 5442 440a 2020 2020 4665 7463      TBD.    Fetc
-000318f0: 6820 6e65 6365 7373 6172 7920 6361 6c69  h necessary cali
-00031900: 6272 6174 696f 6e20 6669 6c65 7320 6e65  bration files ne
-00031910: 6564 6564 2066 6f72 2072 756e 6e69 6e67  eded for running
-00031920: 2063 616c 7766 3320 6672 6f6d 2053 5453   calwf3 from STS
-00031930: 6349 2046 5450 0a0a 2020 2020 4f6c 6420  cI FTP..    Old 
-00031940: 4654 5020 6469 723a 2066 7470 3a2f 2f66  FTP dir: ftp://f
-00031950: 7470 2e73 7473 6369 2e65 6475 2f63 6462  tp.stsci.edu/cdb
-00031960: 732f 6972 6566 2f22 2222 0a20 2020 2069  s/iref/""".    i
-00031970: 6d70 6f72 7420 6f73 0a0a 2020 2020 696d  mport os..    im
-00031980: 203d 2070 7966 6974 732e 6f70 656e 2866   = pyfits.open(f
-00031990: 6c74 5f66 696c 6529 0a20 2020 2069 6620  lt_file).    if 
-000319a0: 696d 5b30 5d2e 6865 6164 6572 5b27 494e  im[0].header['IN
-000319b0: 5354 5255 4d45 275d 203d 3d20 2741 4353  STRUME'] == 'ACS
-000319c0: 273a 0a20 2020 2020 2020 2072 6566 5f64  ':.        ref_d
-000319d0: 6972 203d 2027 6a72 6566 270a 0a20 2020  ir = 'jref'..   
-000319e0: 2069 6620 696d 5b30 5d2e 6865 6164 6572   if im[0].header
-000319f0: 5b27 494e 5354 5255 4d45 275d 203d 3d20  ['INSTRUME'] == 
-00031a00: 2757 4643 3327 3a0a 2020 2020 2020 2020  'WFC3':.        
-00031a10: 7265 665f 6469 7220 3d20 2769 7265 6627  ref_dir = 'iref'
-00031a20: 0a0a 2020 2020 6966 2069 6d5b 305d 2e68  ..    if im[0].h
-00031a30: 6561 6465 725b 2749 4e53 5452 554d 4527  eader['INSTRUME'
-00031a40: 5d20 3d3d 2027 5746 5043 3227 3a0a 2020  ] == 'WFPC2':.  
-00031a50: 2020 2020 2020 7265 665f 6469 7220 3d20        ref_dir = 
-00031a60: 2775 7265 6627 0a0a 2020 2020 6966 206e  'uref'..    if n
-00031a70: 6f74 206f 732e 6765 7465 6e76 2872 6566  ot os.getenv(ref
-00031a80: 5f64 6972 293a 0a20 2020 2020 2020 2070  _dir):.        p
-00031a90: 7269 6e74 2827 4e6f 2024 7b30 7d20 7365  rint('No ${0} se
-00031aa0: 7421 2020 5075 7420 6974 2069 6e20 7e2f  t!  Put it in ~/
-00031ab0: 2e62 6173 6872 6320 6f72 207e 2f2e 6373  .bashrc or ~/.cs
-00031ac0: 6872 632e 272e 666f 726d 6174 2872 6566  hrc.'.format(ref
-00031ad0: 5f64 6972 2929 0a20 2020 2020 2020 2072  _dir)).        r
-00031ae0: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-00031af0: 2063 616c 6962 5f70 6174 6873 203d 205b   calib_paths = [
-00031b00: 5d0a 0a20 2020 2066 6f72 2063 7479 7065  ]..    for ctype
-00031b10: 2069 6e20 6361 6c69 625f 7479 7065 733a   in calib_types:
-00031b20: 0a20 2020 2020 2020 2069 6620 6374 7970  .        if ctyp
-00031b30: 6520 6e6f 7420 696e 2069 6d5b 305d 2e68  e not in im[0].h
-00031b40: 6561 6465 723a 0a20 2020 2020 2020 2020  eader:.         
-00031b50: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-00031b60: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00031b70: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00031b80: 6e74 2827 4361 6c69 623a 207b 307d 3d7b  nt('Calib: {0}={
-00031b90: 317d 272e 666f 726d 6174 2863 7479 7065  1}'.format(ctype
-00031ba0: 2c20 696d 5b30 5d2e 6865 6164 6572 5b63  , im[0].header[c
-00031bb0: 7479 7065 5d29 290a 0a20 2020 2020 2020  type]))..       
-00031bc0: 2069 6620 696d 5b30 5d2e 6865 6164 6572   if im[0].header
-00031bd0: 5b63 7479 7065 5d20 3d3d 2027 4e2f 4127  [ctype] == 'N/A'
-00031be0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-00031bf0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-00031c00: 7061 7468 203d 2066 6574 6368 5f68 7374  path = fetch_hst
-00031c10: 5f63 616c 6962 2869 6d5b 305d 2e68 6561  _calib(im[0].hea
-00031c20: 6465 725b 6374 7970 655d 2c20 6674 7064  der[ctype], ftpd
-00031c30: 6972 3d66 7470 6469 722c 0a20 2020 2020  ir=ftpdir,.     
-00031c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031c50: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-00031c60: 653d 7665 7262 6f73 652c 2072 6566 5f70  e=verbose, ref_p
-00031c70: 6174 6873 3d72 6566 5f70 6174 6873 290a  aths=ref_paths).
-00031c80: 2020 2020 2020 2020 6361 6c69 625f 7061          calib_pa
-00031c90: 7468 732e 6170 7065 6e64 2870 6174 6829  ths.append(path)
-00031ca0: 0a20 2020 200a 2020 2020 696d 2e63 6c6f  .    .    im.clo
-00031cb0: 7365 2829 0a20 2020 200a 2020 2020 7265  se().    .    re
-00031cc0: 7475 726e 2063 616c 6962 5f70 6174 6873  turn calib_paths
-00031cd0: 0a0a 0a64 6566 206d 6173 745f 7175 6572  ...def mast_quer
-00031ce0: 795f 6672 6f6d 5f66 696c 655f 6c69 7374  y_from_file_list
-00031cf0: 2866 696c 6573 3d5b 5d2c 206f 735f 6f70  (files=[], os_op
-00031d00: 656e 3d54 7275 6529 3a0a 2020 2020 2222  en=True):.    ""
-00031d10: 220a 2020 2020 4765 6e65 7261 7465 2061  ".    Generate a
-00031d20: 204d 4153 5420 7175 6572 7920 6f6e 2064   MAST query on d
-00031d30: 6174 6173 6574 7320 696e 2061 206c 6973  atasets in a lis
-00031d40: 742e 0a20 2020 2022 2222 0a20 2020 2069  t..    """.    i
-00031d50: 6620 6c65 6e28 6669 6c65 7329 203d 3d20  f len(files) == 
-00031d60: 303a 0a20 2020 2020 2020 2066 696c 6573  0:.        files
-00031d70: 203d 2067 6c6f 622e 676c 6f62 2827 2a72   = glob.glob('*r
-00031d80: 6177 2e66 6974 7327 290a 0a20 2020 2069  aw.fits')..    i
-00031d90: 6620 6c65 6e28 6669 6c65 7329 203d 3d20  f len(files) == 
-00031da0: 303a 0a20 2020 2020 2020 2070 7269 6e74  0:.        print
-00031db0: 2827 4e6f 2060 6669 6c65 7360 2073 7065  ('No `files` spe
-00031dc0: 6369 6669 6564 2e27 290a 2020 2020 2020  cified.').      
-00031dd0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00031de0: 2020 2020 6461 7461 7365 7473 203d 206e      datasets = n
-00031df0: 702e 756e 6971 7565 285b 6669 6c65 5b3a  p.unique([file[:
-00031e00: 365d 2b27 2a27 2066 6f72 2066 696c 6520  6]+'*' for file 
-00031e10: 696e 2066 696c 6573 5d29 2e74 6f6c 6973  in files]).tolis
-00031e20: 7428 290a 2020 2020 5552 4c20 3d20 2268  t().    URL = "h
-00031e30: 7474 703a 2f2f 6172 6368 6976 652e 7374  ttp://archive.st
-00031e40: 7363 692e 6564 752f 6873 742f 7365 6172  sci.edu/hst/sear
-00031e50: 6368 2e70 6870 3f61 6374 696f 6e3d 5365  ch.php?action=Se
-00031e60: 6172 6368 2622 0a20 2020 2055 524c 202b  arch&".    URL +
-00031e70: 3d20 2273 6369 5f64 6174 615f 7365 745f  = "sci_data_set_
-00031e80: 6e61 6d65 3d22 2b27 2c27 2e6a 6f69 6e28  name="+','.join(
-00031e90: 6461 7461 7365 7473 290a 2020 2020 6966  datasets).    if
-00031ea0: 206f 735f 6f70 656e 3a0a 2020 2020 2020   os_open:.      
-00031eb0: 2020 6f73 2e73 7973 7465 6d28 276f 7065    os.system('ope
-00031ec0: 6e20 227b 307d 2227 2e66 6f72 6d61 7428  n "{0}"'.format(
-00031ed0: 5552 4c29 290a 0a20 2020 2072 6574 7572  URL))..    retur
-00031ee0: 6e20 5552 4c0a 0a0a 6465 6620 6665 7463  n URL...def fetc
-00031ef0: 685f 6465 6661 756c 745f 6361 6c69 6273  h_default_calibs
-00031f00: 2867 6574 5f61 6373 3d46 616c 7365 2c20  (get_acs=False, 
-00031f10: 2a2a 6b77 6172 6773 293a 0a20 2020 2022  **kwargs):.    "
-00031f20: 2222 0a20 2020 2046 6574 6368 2061 2073  "".    Fetch a s
-00031f30: 6574 206f 6620 6465 6661 756c 7420 4853  et of default HS
-00031f40: 5420 6361 6c69 6272 6174 696f 6e20 6669  T calibration fi
-00031f50: 6c65 7320 0a20 2020 2022 2222 0a20 2020  les .    """.   
-00031f60: 2070 6174 6873 203d 207b 7d0a 2020 2020   paths = {}.    
-00031f70: 0a20 2020 2066 6f72 2072 6566 5f64 6972  .    for ref_dir
-00031f80: 2069 6e20 5b27 6972 6566 272c 2027 6a72   in ['iref', 'jr
-00031f90: 6566 275d 3a0a 2020 2020 2020 2020 6861  ef']:.        ha
-00031fa0: 735f 6469 7220 3d20 5472 7565 0a20 2020  s_dir = True.   
-00031fb0: 2020 2020 2069 6620 6e6f 7420 6f73 2e67       if not os.g
-00031fc0: 6574 656e 7628 7265 665f 6469 7229 3a20  etenv(ref_dir): 
-00031fd0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00031fe0: 6861 735f 6469 7220 3d20 4661 6c73 6520  has_dir = False 
-00031ff0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00032000: 2020 2020 2320 446f 2064 6972 6563 746f      # Do directo
-00032010: 7269 6573 2065 7869 7374 2069 6e20 4752  ries exist in GR
-00032020: 495a 4c49 5f50 4154 483f 0a20 2020 2020  IZLI_PATH?.     
-00032030: 2020 2020 2020 2069 6620 6f73 2e70 6174         if os.pat
-00032040: 682e 6578 6973 7473 286f 732e 7061 7468  h.exists(os.path
-00032050: 2e6a 6f69 6e28 4752 495a 4c49 5f50 4154  .join(GRIZLI_PAT
-00032060: 482c 2072 6566 5f64 6972 2929 3a0a 2020  H, ref_dir)):.  
-00032070: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00032080: 735f 6469 7220 3d20 5472 7565 0a20 2020  s_dir = True.   
-00032090: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-000320a0: 6873 5b72 6566 5f64 6972 5d20 3d20 6f73  hs[ref_dir] = os
-000320b0: 2e70 6174 682e 6a6f 696e 2847 5249 5a4c  .path.join(GRIZL
-000320c0: 495f 5041 5448 2c20 7265 665f 6469 7229  I_PATH, ref_dir)
-000320d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000320e0: 2020 2020 2020 2020 2020 2070 6174 6873             paths
-000320f0: 5b72 6566 5f64 6972 5d20 3d20 6f73 2e67  [ref_dir] = os.g
-00032100: 6574 656e 7628 7265 665f 6469 7229 0a20  etenv(ref_dir). 
-00032110: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00032120: 2020 2020 6966 206e 6f74 2068 6173 5f64      if not has_d
-00032130: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
-00032140: 7072 696e 7428 2222 220a 4e6f 2024 7b30  print(""".No ${0
-00032150: 7d20 7365 7421 2020 4d61 6b65 2061 2064  } set!  Make a d
-00032160: 6972 6563 746f 7279 2061 6e64 2070 6f69  irectory and poi
-00032170: 6e74 2074 6f20 6974 2069 6e20 7e2f 2e62  nt to it in ~/.b
-00032180: 6173 6872 6320 6f72 207e 2f2e 6373 6872  ashrc or ~/.cshr
-00032190: 632e 0a46 6f72 2065 7861 6d70 6c65 2c0a  c..For example,.
-000321a0: 0a20 2024 206d 6b64 6972 2024 4752 495a  .  $ mkdir $GRIZ
-000321b0: 4c49 2f7b 307d 0a20 2024 2065 7870 6f72  LI/{0}.  $ expor
-000321c0: 7420 7b30 7d3d 2224 7b47 5249 5a4c 497d  t {0}="${GRIZLI}
-000321d0: 2f7b 307d 2f22 2023 2070 7574 2074 6869  /{0}/" # put thi
-000321e0: 7320 696e 207e 2f2e 6261 7368 7263 0a22  s in ~/.bashrc."
-000321f0: 2222 2e66 6f72 6d61 7428 7265 665f 6469  "".format(ref_di
-00032200: 7229 290a 0a20 2020 2020 2020 2020 2020  r))..           
-00032210: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-00032220: 2020 2023 2057 4643 330a 2020 2020 6669     # WFC3.    fi
-00032230: 6c65 7320 3d20 5b27 6972 6566 2475 6337  les = ['iref$uc7
-00032240: 3231 3133 6f69 5f70 666c 2e66 6974 7327  2113oi_pfl.fits'
-00032250: 2c20 2023 2046 3130 3557 2046 6c61 740a  ,  # F105W Flat.
-00032260: 2020 2020 2020 2020 2020 2020 2027 6972               'ir
-00032270: 6566 2475 6337 3231 3134 3369 5f70 666c  ef$uc721143i_pfl
-00032280: 2e66 6974 7327 2c20 2023 2046 3134 3057  .fits',  # F140W
-00032290: 2066 6c61 740a 2020 2020 2020 2020 2020   flat.          
-000322a0: 2020 2027 6972 6566 2475 346d 3133 3335     'iref$u4m1335
-000322b0: 6c69 5f70 666c 2e66 6974 7327 2c20 2023  li_pfl.fits',  #
-000322c0: 2047 3130 3220 666c 6174 0a20 2020 2020   G102 flat.     
-000322d0: 2020 2020 2020 2020 2769 7265 6624 7534          'iref$u4
-000322e0: 6d31 3333 356d 695f 7066 6c2e 6669 7473  m1335mi_pfl.fits
-000322f0: 272c 2020 2320 4731 3431 2066 6c61 740a  ',  # G141 flat.
-00032300: 2020 2020 2020 2020 2020 2020 2027 6972               'ir
-00032310: 6566 2477 336d 3138 3532 3569 5f69 6463  ef$w3m18525i_idc
-00032320: 2e66 6974 7327 2c20 2023 2049 4443 5441  .fits',  # IDCTA
-00032330: 4220 6469 7374 6f72 7469 6f6e 2074 6162  B distortion tab
-00032340: 6c65 7d0a 2020 2020 2020 2020 2020 2020  le}.            
-00032350: 205d 0a20 2020 200a 2020 2020 6966 2027   ].    .    if '
-00032360: 4143 5327 2069 6e20 6b77 6172 6773 3a0a  ACS' in kwargs:.
-00032370: 2020 2020 2020 2020 6765 745f 6163 7320          get_acs 
-00032380: 3d20 6b77 6172 6773 5b27 4143 5327 5d0a  = kwargs['ACS'].
-00032390: 2020 2020 2020 2020 0a20 2020 2069 6620          .    if 
-000323a0: 6765 745f 6163 733a 0a20 2020 2020 2020  get_acs:.       
-000323b0: 2066 696c 6573 2e65 7874 656e 6428 5b27   files.extend(['
-000323c0: 6a72 6566 246e 3675 3132 3539 326a 5f70  jref$n6u12592j_p
-000323d0: 666c 2e66 6974 7327 2c20 2023 2046 3831  fl.fits',  # F81
-000323e0: 3420 466c 6174 0a20 2020 2020 2020 2020  4 Flat.         
-000323f0: 2020 2020 2020 2020 2020 2020 2027 6a72               'jr
-00032400: 6566 246f 3834 3133 3530 6d6a 5f70 666c  ef$o841350mj_pfl
-00032410: 2e66 6974 7327 2c20 2023 2047 3830 304c  .fits',  # G800L
-00032420: 2066 6c61 745d 290a 2020 2020 2020 2020   flat]).        
-00032430: 2020 2020 2020 2020 2020 2020 2020 276a                'j
-00032440: 7265 6624 7639 3731 3832 366a 6a5f 6e70  ref$v971826jj_np
-00032450: 6c2e 6669 7473 275d 290a 0a20 2020 2066  l.fits'])..    f
-00032460: 6f72 2066 696c 6520 696e 2066 696c 6573  or file in files
-00032470: 3a0a 2020 2020 2020 2020 6665 7463 685f  :.        fetch_
-00032480: 6873 745f 6361 6c69 6228 6669 6c65 2c20  hst_calib(file, 
-00032490: 7265 665f 7061 7468 733d 7061 7468 7329  ref_paths=paths)
-000324a0: 0a0a 2020 2020 6261 6470 6978 203d 206f  ..    badpix = o
-000324b0: 732e 7061 7468 2e6a 6f69 6e28 7061 7468  s.path.join(path
-000324c0: 735b 2769 7265 6627 5d2c 2027 6261 6470  s['iref'], 'badp
-000324d0: 6978 5f73 7061 7273 3230 305f 4e6f 7639  ix_spars200_Nov9
-000324e0: 2e66 6974 7327 290a 2020 2020 7072 696e  .fits').    prin
-000324f0: 7428 2745 7874 7261 2057 4643 332f 4952  t('Extra WFC3/IR
-00032500: 2062 6164 2070 6978 656c 733a 207b 307d   bad pixels: {0}
-00032510: 272e 666f 726d 6174 2862 6164 7069 7829  '.format(badpix)
-00032520: 290a 2020 2020 6966 206e 6f74 206f 732e  ).    if not os.
-00032530: 7061 7468 2e65 7869 7374 7328 6261 6470  path.exists(badp
-00032540: 6978 293a 0a20 2020 2020 2020 206f 732e  ix):.        os.
-00032550: 7379 7374 656d 2827 6375 726c 202d 6f20  system('curl -o 
-00032560: 7b30 7d2f 6261 6470 6978 5f73 7061 7273  {0}/badpix_spars
-00032570: 3230 305f 4e6f 7639 2e66 6974 7320 6874  200_Nov9.fits ht
-00032580: 7470 733a 2f2f 7261 772e 6769 7468 7562  tps://raw.github
-00032590: 7573 6572 636f 6e74 656e 742e 636f 6d2f  usercontent.com/
-000325a0: 6762 7261 6d6d 6572 2f77 6663 332f 6d61  gbrammer/wfc3/ma
-000325b0: 7374 6572 2f64 6174 612f 6261 6470 6978  ster/data/badpix
-000325c0: 5f73 7061 7273 3230 305f 4e6f 7639 2e66  _spars200_Nov9.f
-000325d0: 6974 7327 2e66 6f72 6d61 7428 7061 7468  its'.format(path
-000325e0: 735b 2769 7265 6627 5d29 290a 0a20 2020  s['iref']))..   
-000325f0: 2023 2050 6978 656c 2061 7265 6120 6d61   # Pixel area ma
-00032600: 700a 2020 2020 7061 6d20 3d20 6f73 2e70  p.    pam = os.p
-00032610: 6174 682e 6a6f 696e 2870 6174 6873 5b27  ath.join(paths['
-00032620: 6972 6566 275d 2c20 2769 725f 7766 6333  iref'], 'ir_wfc3
-00032630: 5f6d 6170 2e66 6974 7327 290a 2020 2020  _map.fits').    
-00032640: 7072 696e 7428 2750 6978 656c 2061 7265  print('Pixel are
-00032650: 6120 6d61 703a 207b 307d 272e 666f 726d  a map: {0}'.form
-00032660: 6174 2870 616d 2929 0a20 2020 2069 6620  at(pam)).    if 
-00032670: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
-00032680: 7473 2870 616d 293a 0a20 2020 2020 2020  ts(pam):.       
-00032690: 206f 732e 7379 7374 656d 2827 6375 726c   os.system('curl
-000326a0: 202d 6f20 7b30 7d20 6874 7470 733a 2f2f   -o {0} https://
-000326b0: 7777 772e 7374 7363 692e 6564 752f 6669  www.stsci.edu/fi
-000326c0: 6c65 732f 6c69 7665 2f73 6974 6573 2f77  les/live/sites/w
-000326d0: 7777 2f66 696c 6573 2f68 6f6d 652f 6873  ww/files/home/hs
-000326e0: 742f 696e 7374 7275 6d65 6e74 6174 696f  t/instrumentatio
-000326f0: 6e2f 7766 6333 2f64 6174 612d 616e 616c  n/wfc3/data-anal
-00032700: 7973 6973 2f70 6978 656c 2d61 7265 612d  ysis/pixel-area-
-00032710: 6d61 7073 2f5f 646f 6375 6d65 6e74 732f  maps/_documents/
-00032720: 6972 5f77 6663 335f 6d61 702e 6669 7473  ir_wfc3_map.fits
-00032730: 272e 666f 726d 6174 2870 616d 2929 0a0a  '.format(pam))..
-00032740: 0a64 6566 2066 6574 6368 5f77 6670 6332  .def fetch_wfpc2
-00032750: 5f63 616c 6962 2866 696c 653d 2767 3671  _calib(file='g6q
-00032760: 3139 3132 6875 5f72 3466 2e66 6974 7327  1912hu_r4f.fits'
-00032770: 2c20 7061 7468 3d6f 732e 6765 7465 6e76  , path=os.getenv
-00032780: 2827 7572 6566 2729 2c20 7573 655f 6d61  ('uref'), use_ma
-00032790: 7374 3d46 616c 7365 2c20 7665 7262 6f73  st=False, verbos
-000327a0: 653d 5472 7565 2c20 6f76 6572 7772 6974  e=True, overwrit
-000327b0: 653d 5472 7565 2c20 736b 6970 5f65 7869  e=True, skip_exi
-000327c0: 7374 696e 673d 5472 7565 293a 0a20 2020  sting=True):.   
-000327d0: 2022 2222 0a20 2020 2046 6574 6368 2073   """.    Fetch s
-000327e0: 7461 7469 6320 5746 5043 3220 6361 6c69  tatic WFPC2 cali
-000327f0: 6272 6174 696f 6e20 6669 6c65 2061 6e64  bration file and
-00032800: 2072 756e 2060 7374 7363 692e 746f 6f6c   run `stsci.tool
-00032810: 732e 636f 6e76 6572 7477 6169 7665 7265  s.convertwaivere
-00032820: 6466 6974 7360 206f 6e20 6974 2e0a 0a20  dfits` on it... 
-00032830: 2020 2070 6174 6820 3a20 7374 720a 2020     path : str.  
-00032840: 2020 2020 2020 4f75 7470 7574 2070 6174        Output pat
-00032850: 6820 6f66 2074 6865 2072 6566 6572 656e  h of the referen
-00032860: 6365 2066 696c 6520 2867 656e 6572 616c  ce file (general
-00032870: 6c79 2073 686f 756c 6420 6265 2069 6e20  ly should be in 
-00032880: 2475 7265 6629 2e0a 0a20 2020 2075 7365  $uref)...    use
-00032890: 5f6d 6173 7420 3a20 626f 6f6c 0a20 2020  _mast : bool.   
-000328a0: 2020 2020 2049 6620 5472 7565 2c20 7472       If True, tr
-000328b0: 7920 746f 2066 6574 6368 2066 726f 6d20  y to fetch from 
-000328c0: 226d 6173 742e 7374 7363 692e 6564 752f  "mast.stsci.edu/
-000328d0: 2f61 7069 2f76 302f 646f 776e 6c6f 6164  /api/v0/download
-000328e0: 2f66 696c 653f 7572 6922 2c0a 2020 2020  /file?uri",.    
-000328f0: 2020 2020 6f74 6865 7277 6973 652c 2066      otherwise, f
-00032900: 6574 6368 2066 726f 6d20 6120 7374 6174  etch from a stat
-00032910: 6963 2064 6972 6563 746f 7279 0a20 2020  ic directory.   
-00032920: 2020 2020 2022 7373 622e 7374 7363 692e       "ssb.stsci.
-00032930: 6564 752f 6364 6273 5f6f 7065 6e2f 6364  edu/cdbs_open/cd
-00032940: 6273 2f75 7265 665f 6c69 6e75 782f 222e  bs/uref_linux/".
-00032950: 0a0a 2020 2020 2222 220a 2020 2020 6672  ..    """.    fr
-00032960: 6f6d 2073 7473 6369 2e74 6f6f 6c73 2069  om stsci.tools i
-00032970: 6d70 6f72 7420 636f 6e76 6572 7477 6169  mport convertwai
-00032980: 7665 7265 6466 6974 730a 0a20 2020 2074  veredfits..    t
-00032990: 7279 3a20 2023 2050 7974 686f 6e20 332e  ry:  # Python 3.
-000329a0: 780a 2020 2020 2020 2020 696d 706f 7274  x.        import
-000329b0: 2068 7474 702e 636c 6965 6e74 2061 7320   http.client as 
-000329c0: 6874 7470 6c69 620a 2020 2020 6578 6365  httplib.    exce
-000329d0: 7074 2049 6d70 6f72 7445 7272 6f72 3a20  pt ImportError: 
-000329e0: 2023 2050 7974 686f 6e20 322e 780a 2020   # Python 2.x.  
-000329f0: 2020 2020 2020 696d 706f 7274 2068 7474        import htt
-00032a00: 706c 6962 0a0a 2020 2020 6966 2066 696c  plib..    if fil
-00032a10: 652e 656e 6473 7769 7468 2827 6827 293a  e.endswith('h'):
-00032a20: 0a20 2020 2020 2020 2023 2046 696c 6520  .        # File 
-00032a30: 6c69 6b65 2022 6736 7131 3931 3268 752e  like "g6q1912hu.
-00032a40: 7234 6822 0a20 2020 2020 2020 2066 696c  r4h".        fil
-00032a50: 6520 3d20 6669 6c65 5b3a 2d31 5d2e 7265  e = file[:-1].re
-00032a60: 706c 6163 6528 272e 272c 2027 5f27 292b  place('.', '_')+
-00032a70: 2766 2e66 6974 7327 0a0a 2020 2020 6f75  'f.fits'..    ou
-00032a80: 7450 6174 6820 3d20 6f73 2e70 6174 682e  tPath = os.path.
-00032a90: 6a6f 696e 2870 6174 682c 2066 696c 6529  join(path, file)
-00032aa0: 0a20 2020 2069 6620 6f73 2e70 6174 682e  .    if os.path.
-00032ab0: 6578 6973 7473 286f 7574 5061 7468 2920  exists(outPath) 
-00032ac0: 2620 736b 6970 5f65 7869 7374 696e 673a  & skip_existing:
-00032ad0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
-00032ae0: 2320 6665 7463 685f 7766 7063 325f 6361  # fetch_wfpc2_ca
-00032af0: 6c69 623a 207b 307d 2065 7869 7374 7322  lib: {0} exists"
-00032b00: 2e66 6f72 6d61 7428 6f75 7450 6174 6829  .format(outPath)
-00032b10: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00032b20: 2054 7275 650a 0a20 2020 2069 6620 7573   True..    if us
-00032b30: 655f 6d61 7374 3a0a 2020 2020 2020 2020  e_mast:.        
-00032b40: 7365 7276 6572 203d 2027 6d61 7374 2e73  server = 'mast.s
-00032b50: 7473 6369 2e65 6475 270a 2020 2020 2020  tsci.edu'.      
-00032b60: 2020 7572 6920 3d20 276d 6173 743a 4853    uri = 'mast:HS
-00032b70: 542f 7072 6f64 7563 742f 272b 6669 6c65  T/product/'+file
-00032b80: 0a20 2020 2020 2020 2072 6571 7565 7374  .        request
-00032b90: 5f70 6174 6820 3d20 222f 6170 692f 7630  _path = "/api/v0
-00032ba0: 2f64 6f77 6e6c 6f61 642f 6669 6c65 3f75  /download/file?u
-00032bb0: 7269 3d22 2b75 7269 0a20 2020 2065 6c73  ri="+uri.    els
-00032bc0: 653a 0a20 2020 2020 2020 2073 6572 7665  e:.        serve
-00032bd0: 7220 3d20 2773 7362 2e73 7473 6369 2e65  r = 'ssb.stsci.e
-00032be0: 6475 270a 2020 2020 2020 2020 7265 7175  du'.        requ
-00032bf0: 6573 745f 7061 7468 203d 2027 2f63 6462  est_path = '/cdb
-00032c00: 735f 6f70 656e 2f63 6462 732f 7572 6566  s_open/cdbs/uref
-00032c10: 5f6c 696e 7578 2f27 2b66 696c 650a 0a20  _linux/'+file.. 
-00032c20: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00032c30: 2020 2020 2020 2070 7269 6e74 2827 2320         print('# 
-00032c40: 6665 7463 685f 7766 7063 325f 6361 6c69  fetch_wfpc2_cali
-00032c50: 623a 2022 7b30 7d22 2074 6f20 7b31 7d27  b: "{0}" to {1}'
-00032c60: 2e66 6f72 6d61 7428 7365 7276 6572 2b72  .format(server+r
-00032c70: 6571 7565 7374 5f70 6174 682c 2070 6174  equest_path, pat
-00032c80: 6829 290a 0a20 2020 2063 6f6e 6e20 3d20  h))..    conn = 
-00032c90: 6874 7470 6c69 622e 4854 5450 5343 6f6e  httplib.HTTPSCon
-00032ca0: 6e65 6374 696f 6e28 7365 7276 6572 290a  nection(server).
-00032cb0: 0a20 2020 2063 6f6e 6e2e 7265 7175 6573  .    conn.reques
-00032cc0: 7428 2247 4554 222c 2072 6571 7565 7374  t("GET", request
-00032cd0: 5f70 6174 6829 0a20 2020 2072 6573 7020  _path).    resp 
-00032ce0: 3d20 636f 6e6e 2e67 6574 7265 7370 6f6e  = conn.getrespon
-00032cf0: 7365 2829 0a20 2020 2066 696c 6543 6f6e  se().    fileCon
-00032d00: 7465 6e74 203d 2072 6573 702e 7265 6164  tent = resp.read
-00032d10: 2829 0a20 2020 2063 6f6e 6e2e 636c 6f73  ().    conn.clos
-00032d20: 6528 290a 0a20 2020 2023 2063 6865 636b  e()..    # check
-00032d30: 2066 6f72 2066 696c 650a 2020 2020 6966   for file.    if
-00032d40: 206c 656e 2866 696c 6543 6f6e 7465 6e74   len(fileContent
-00032d50: 2920 3c20 3430 3936 3a0a 2020 2020 2020  ) < 4096:.      
-00032d60: 2020 7072 696e 7428 2745 5252 4f52 3a20    print('ERROR: 
-00032d70: 227b 307d 2220 6661 696c 6564 2074 6f20  "{0}" failed to 
-00032d80: 646f 776e 6c6f 6164 2e20 2054 7279 2060  download.  Try `
-00032d90: 7573 655f 6d61 7374 3d7b 317d 602e 272e  use_mast={1}`.'.
-00032da0: 666f 726d 6174 2873 6572 7665 722b 7265  format(server+re
-00032db0: 7175 6573 745f 7061 7468 2c20 2875 7365  quest_path, (use
-00032dc0: 5f6d 6173 7420 6973 2046 616c 7365 2929  _mast is False))
-00032dd0: 290a 2020 2020 2020 2020 7374 6174 7573  ).        status
-00032de0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00032df0: 2072 6169 7365 2046 696c 654e 6f74 466f   raise FileNotFo
-00032e00: 756e 6445 7272 6f72 0a20 2020 2065 6c73  undError.    els
-00032e10: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
-00032e20: 2822 2320 6665 7463 685f 7766 7063 325f  ("# fetch_wfpc2_
-00032e30: 6361 6c69 623a 207b 307d 2028 434f 4d50  calib: {0} (COMP
-00032e40: 4c45 5445 2922 2e66 6f72 6d61 7428 6f75  LETE)".format(ou
-00032e50: 7450 6174 6829 290a 2020 2020 2020 2020  tPath)).        
-00032e60: 7374 6174 7573 203d 2054 7275 650a 0a20  status = True.. 
-00032e70: 2020 2023 2073 6176 6520 746f 2066 696c     # save to fil
-00032e80: 650a 2020 2020 7769 7468 206f 7065 6e28  e.    with open(
-00032e90: 6f75 7450 6174 682c 2027 7762 2729 2061  outPath, 'wb') a
-00032ea0: 7320 464c 453a 0a20 2020 2020 2020 2046  s FLE:.        F
-00032eb0: 4c45 2e77 7269 7465 2866 696c 6543 6f6e  LE.write(fileCon
-00032ec0: 7465 6e74 290a 0a20 2020 2069 6620 7374  tent)..    if st
-00032ed0: 6174 7573 3a0a 2020 2020 2020 2020 2320  atus:.        # 
-00032ee0: 436f 6e76 6572 7420 746f 2073 7461 6e64  Convert to stand
-00032ef0: 6172 6420 4649 5453 0a20 2020 2020 2020  ard FITS.       
-00032f00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00032f10: 2020 6864 7520 3d20 636f 6e76 6572 7477    hdu = convertw
-00032f20: 6169 7665 7265 6466 6974 732e 636f 6e76  aiveredfits.conv
-00032f30: 6572 7477 6169 7665 7265 6466 6974 7328  ertwaiveredfits(
-00032f40: 6f75 7450 6174 6829 0a20 2020 2020 2020  outPath).       
-00032f50: 2020 2020 2077 6869 6c65 2027 4849 5354       while 'HIST
-00032f60: 4f52 5927 2069 6e20 6864 755b 305d 2e68  ORY' in hdu[0].h
-00032f70: 6561 6465 723a 0a20 2020 2020 2020 2020  eader:.         
-00032f80: 2020 2020 2020 2068 6475 5b30 5d2e 6865         hdu[0].he
-00032f90: 6164 6572 2e72 656d 6f76 6528 2748 4953  ader.remove('HIS
-00032fa0: 544f 5259 2729 0a0a 2020 2020 2020 2020  TORY')..        
-00032fb0: 2020 2020 6864 752e 7772 6974 6574 6f28      hdu.writeto(
-00032fc0: 6f75 7450 6174 682e 7265 706c 6163 6528  outPath.replace(
-00032fd0: 272e 6669 7473 272c 2027 5f63 3068 2e66  '.fits', '_c0h.f
-00032fe0: 6974 7327 292c 0a20 2020 2020 2020 2020  its'),.         
-00032ff0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00033000: 7665 7277 7269 7465 3d6f 7665 7277 7269  verwrite=overwri
-00033010: 7465 2c20 6f75 7470 7574 5f76 6572 6966  te, output_verif
-00033020: 793d 2766 6978 2729 0a20 2020 2020 2020  y='fix').       
-00033030: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-00033040: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00033050: 0a0a 0a64 6566 2066 6574 6368 5f6e 6972  ...def fetch_nir
-00033060: 6361 6d5f 736b 7966 6c61 7473 2829 3a0a  cam_skyflats():.
-00033070: 2020 2020 2222 220a 2020 2020 446f 776e      """.    Down
-00033080: 6c6f 6164 2073 6b79 666c 6174 2066 696c  load skyflat fil
-00033090: 6573 0a20 2020 2022 2222 0a20 2020 2063  es.    """.    c
-000330a0: 6f6e 665f 7061 7468 203d 206f 732e 7061  onf_path = os.pa
-000330b0: 7468 2e6a 6f69 6e28 4752 495a 4c49 5f50  th.join(GRIZLI_P
-000330c0: 4154 482c 2027 434f 4e46 272c 2027 4e69  ATH, 'CONF', 'Ni
-000330d0: 7263 616d 536b 7946 6c61 7427 290a 2020  rcamSkyFlat').  
-000330e0: 2020 6f73 2e73 7973 7465 6d28 6627 6177    os.system(f'aw
-000330f0: 7320 7333 2073 796e 6320 7333 3a2f 2f67  s s3 sync s3://g
-00033100: 7269 7a6c 692d 7632 2f4e 6972 6361 6d53  rizli-v2/NircamS
-00033110: 6b79 666c 6174 732f 207b 636f 6e66 5f70  kyflats/ {conf_p
-00033120: 6174 687d 202d 2d65 7863 6c75 6465 2022  ath} --exclude "
-00033130: 2a22 202d 2d69 6e63 6c75 6465 2022 6e72  *" --include "nr
-00033140: 632a 6669 7473 2227 290a 2020 2020 0a20  c*fits"').    . 
-00033150: 2020 205f 6669 6c65 7320 3d20 676c 6f62     _files = glob
-00033160: 2e67 6c6f 6228 636f 6e66 5f70 6174 682b  .glob(conf_path+
-00033170: 272f 2a66 6974 7327 290a 2020 2020 5f66  '/*fits').    _f
-00033180: 696c 6573 2e73 6f72 7428 290a 2020 2020  iles.sort().    
-00033190: 0a20 2020 2072 6574 7572 6e20 5f66 696c  .    return _fil
-000331a0: 6573 0a0a 0a64 6566 2066 6574 6368 5f63  es...def fetch_c
-000331b0: 6f6e 6669 675f 6669 6c65 7328 6765 745f  onfig_files(get_
-000331c0: 6163 733d 4661 6c73 652c 2067 6574 5f73  acs=False, get_s
-000331d0: 6b79 3d54 7275 652c 2067 6574 5f73 7461  ky=True, get_sta
-000331e0: 7273 3d54 7275 652c 2067 6574 5f65 7073  rs=True, get_eps
-000331f0: 663d 5472 7565 2c20 6765 745f 6a77 7374  f=True, get_jwst
-00033200: 3d46 616c 7365 2c20 6765 745f 7766 6333  =False, get_wfc3
-00033210: 3d54 7275 652c 202a 2a6b 7761 7267 7329  =True, **kwargs)
-00033220: 3a0a 2020 2020 2222 220a 2020 2020 436f  :.    """.    Co
-00033230: 6e66 6967 2066 696c 6573 206e 6565 6465  nfig files neede
-00033240: 6420 666f 7220 4772 697a 6c69 0a20 2020  d for Grizli.   
-00033250: 2022 2222 0a20 2020 2069 6620 2741 4353   """.    if 'ACS
-00033260: 2720 696e 206b 7761 7267 733a 0a20 2020  ' in kwargs:.   
-00033270: 2020 2020 2067 6574 5f61 6373 203d 206b       get_acs = k
-00033280: 7761 7267 735b 2741 4353 275d 0a0a 2020  wargs['ACS']..  
-00033290: 2020 6377 6420 3d20 6f73 2e67 6574 6377    cwd = os.getcw
-000332a0: 6428 290a 0a20 2020 2070 7269 6e74 2827  d()..    print('
-000332b0: 436f 6e66 6967 2064 6972 6563 746f 7279  Config directory
-000332c0: 3a20 7b30 7d2f 434f 4e46 272e 666f 726d  : {0}/CONF'.form
-000332d0: 6174 2847 5249 5a4c 495f 5041 5448 2929  at(GRIZLI_PATH))
-000332e0: 0a0a 2020 2020 6f73 2e63 6864 6972 286f  ..    os.chdir(o
-000332f0: 732e 7061 7468 2e6a 6f69 6e28 4752 495a  s.path.join(GRIZ
-00033300: 4c49 5f50 4154 482c 2027 434f 4e46 2729  LI_PATH, 'CONF')
-00033310: 290a 0a20 2020 2066 7470 6469 7220 3d20  )..    ftpdir = 
-00033320: 2766 7470 3a2f 2f66 7470 2e73 7473 6369  'ftp://ftp.stsci
-00033330: 2e65 6475 2f63 6462 732f 7766 6333 5f61  .edu/cdbs/wfc3_a
-00033340: 7578 2f27 0a20 2020 2074 6172 6669 6c65  ux/'.    tarfile
-00033350: 7320 3d20 5b5d 0a0a 2020 2020 2320 436f  s = []..    # Co
-00033360: 6e66 6967 2066 696c 6573 0a20 2020 2023  nfig files.    #
-00033370: 2042 4153 4555 524c 203d 2027 6874 7470   BASEURL = 'http
-00033380: 733a 2f2f 7333 2e61 6d61 7a6f 6e61 7773  s://s3.amazonaws
-00033390: 2e63 6f6d 2f67 7269 7a6c 692f 434f 4e46  .com/grizli/CONF
-000333a0: 2f27 0a20 2020 2023 2042 4153 4555 524c  /'.    # BASEURL
-000333b0: 203d 2027 6874 7470 733a 2f2f 6572 6461   = 'https://erda
-000333c0: 2e6b 752e 646b 2f76 6772 6964 2f47 6162  .ku.dk/vgrid/Gab
-000333d0: 7269 656c 2532 3042 7261 6d6d 6572 2f43  riel%20Brammer/C
-000333e0: 4f4e 462f 270a 2020 2020 4241 5345 5552  ONF/'.    BASEUR
-000333f0: 4c20 3d20 2827 6874 7470 733a 2f2f 7261  L = ('https://ra
-00033400: 772e 6769 7468 7562 7573 6572 636f 6e74  w.githubusercont
-00033410: 656e 742e 636f 6d2f 6762 7261 6d6d 6572  ent.com/gbrammer
-00033420: 2f27 202b 0a20 2020 2020 2020 2020 2020  /' +.           
-00033430: 2020 2020 2767 7269 7a6c 692d 636f 6e66      'grizli-conf
-00033440: 6967 2f6d 6173 7465 7227 290a 0a20 2020  ig/master')..   
-00033450: 2069 6620 6765 745f 7766 6333 3a0a 2020   if get_wfc3:.  
-00033460: 2020 2020 2020 7461 7266 696c 6573 203d        tarfiles =
-00033470: 205b 277b 307d 2f57 4643 332e 4952 2e47   ['{0}/WFC3.IR.G
-00033480: 3130 322e 6361 6c2e 5634 2e33 322e 7461  102.cal.V4.32.ta
-00033490: 722e 677a 272e 666f 726d 6174 2866 7470  r.gz'.format(ftp
-000334a0: 6469 7229 2c0a 2020 2020 2020 2020 2020  dir),.          
-000334b0: 2020 2020 2020 2020 2020 277b 307d 2f57            '{0}/W
-000334c0: 4643 332e 4952 2e47 3134 312e 6361 6c2e  FC3.IR.G141.cal.
-000334d0: 5634 2e33 322e 7461 722e 677a 272e 666f  V4.32.tar.gz'.fo
-000334e0: 726d 6174 2866 7470 6469 7229 5d0a 2020  rmat(ftpdir)].  
-000334f0: 2020 2020 2020 7461 7266 696c 6573 202b        tarfiles +
-00033500: 3d20 5b66 277b 4241 5345 5552 4c7d 2f57  = [f'{BASEURL}/W
-00033510: 4643 332e 4952 2e47 3130 322e 5744 2e56  FC3.IR.G102.WD.V
-00033520: 342e 3332 2e74 6172 2e67 7a27 2c20 0a20  4.32.tar.gz', . 
-00033530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033540: 2020 2066 277b 4241 5345 5552 4c7d 2f57     f'{BASEURL}/W
-00033550: 4643 332e 4952 2e47 3134 312e 5744 2e56  FC3.IR.G141.WD.V
-00033560: 342e 3332 2e74 6172 2e67 7a27 5d0a 0a20  4.32.tar.gz'].. 
-00033570: 2020 2069 6620 6765 745f 6a77 7374 3a0a     if get_jwst:.
-00033580: 2020 2020 2020 2020 7461 7266 696c 6573          tarfiles
-00033590: 202b 3d20 5b66 277b 4241 5345 5552 4c7d   += [f'{BASEURL}
-000335a0: 2f6a 7773 742d 6772 6973 6d2d 636f 6e66  /jwst-grism-conf
-000335b0: 2e74 6172 2e67 7a27 2c20 0a20 2020 2020  .tar.gz', .     
-000335c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000335d0: 6627 7b42 4153 4555 524c 7d2f 6e69 7269  f'{BASEURL}/niri
-000335e0: 7373 2e63 6f6e 662e 3232 3037 3235 2e74  ss.conf.220725.t
-000335f0: 6172 2e67 7a27 2c0a 2020 2020 2020 2020  ar.gz',.        
-00033600: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-00033610: 4241 5345 5552 4c7d 2f6e 6972 6361 6d2d  BASEURL}/nircam-
-00033620: 7769 7370 2d61 7567 3230 3232 2e74 6172  wisp-aug2022.tar
-00033630: 2e67 7a27 5d0a 2020 2020 0a20 2020 2069  .gz'].    .    i
-00033640: 6620 6765 745f 736b 793a 0a20 2020 2020  f get_sky:.     
-00033650: 2020 2066 7470 6469 7220 3d20 4241 5345     ftpdir = BASE
-00033660: 5552 4c0a 2020 2020 2020 2020 7461 7266  URL.        tarf
-00033670: 696c 6573 2e61 7070 656e 6428 277b 307d  iles.append('{0}
-00033680: 2f67 7269 736d 5f6d 6173 7465 725f 736b  /grism_master_sk
-00033690: 795f 7630 2e35 2e74 6172 2e67 7a27 2e66  y_v0.5.tar.gz'.f
-000336a0: 6f72 6d61 7428 6674 7064 6972 2929 0a0a  ormat(ftpdir))..
-000336b0: 2020 2020 2367 5552 4c20 3d20 2768 7474      #gURL = 'htt
-000336c0: 703a 2f2f 7777 772e 7374 7363 692e 6564  p://www.stsci.ed
-000336d0: 752f 7e62 7261 6d6d 6572 2f47 7269 7a6c  u/~brammer/Grizl
-000336e0: 692f 4669 6c65 7327 0a20 2020 2023 6755  i/Files'.    #gU
-000336f0: 524c 203d 2027 6874 7470 733a 2f2f 7333  RL = 'https://s3
-00033700: 2e61 6d61 7a6f 6e61 7773 2e63 6f6d 2f67  .amazonaws.com/g
-00033710: 7269 7a6c 692f 434f 4e46 270a 2020 2020  rizli/CONF'.    
-00033720: 6755 524c 203d 2042 4153 4555 524c 0a20  gURL = BASEURL. 
-00033730: 2020 200a 2020 2020 7461 7266 696c 6573     .    tarfiles
-00033740: 2e61 7070 656e 6428 277b 307d 2f57 4643  .append('{0}/WFC
-00033750: 3349 525f 6578 7465 6e64 6564 5f50 5346  3IR_extended_PSF
-00033760: 2e76 312e 7461 722e 677a 272e 666f 726d  .v1.tar.gz'.form
-00033770: 6174 2867 5552 4c29 290a 0a20 2020 2069  at(gURL))..    i
-00033780: 6620 6765 745f 6163 733a 0a20 2020 2020  f get_acs:.     
-00033790: 2020 2074 6172 6669 6c65 7320 2b3d 205b     tarfiles += [
-000337a0: 6627 7b42 4153 4555 524c 7d2f 4143 532e  f'{BASEURL}/ACS.
-000337b0: 5746 432e 4348 4950 312e 5374 6172 732e  WFC.CHIP1.Stars.
-000337c0: 636f 6e66 272c 200a 2020 2020 2020 2020  conf', .        
-000337d0: 2020 2020 2020 2020 2020 2020 6627 7b42              f'{B
-000337e0: 4153 4555 524c 7d2f 4143 532e 5746 432e  ASEURL}/ACS.WFC.
-000337f0: 4348 4950 322e 5374 6172 732e 636f 6e66  CHIP2.Stars.conf
-00033800: 275d 0a20 2020 2020 2020 2074 6172 6669  '].        tarfi
-00033810: 6c65 732e 6170 7065 6e64 2827 7b30 7d2f  les.append('{0}/
-00033820: 4143 532e 5746 432e 736b 792e 7461 722e  ACS.WFC.sky.tar.
-00033830: 677a 272e 666f 726d 6174 2867 5552 4c29  gz'.format(gURL)
-00033840: 290a 2020 2020 2020 2020 7461 7266 696c  ).        tarfil
-00033850: 6573 2e61 7070 656e 6428 277b 307d 2f41  es.append('{0}/A
-00033860: 4353 5f43 4f4e 4649 472e 7461 722e 677a  CS_CONFIG.tar.gz
-00033870: 272e 666f 726d 6174 2867 5552 4c29 290a  '.format(gURL)).
-00033880: 0a20 2020 2066 6f72 2075 726c 2069 6e20  .    for url in 
-00033890: 7461 7266 696c 6573 3a0a 2020 2020 2020  tarfiles:.      
-000338a0: 2020 6669 6c65 203d 206f 732e 7061 7468    file = os.path
-000338b0: 2e62 6173 656e 616d 6528 7572 6c29 0a20  .basename(url). 
-000338c0: 2020 2020 2020 2069 6620 6e6f 7420 6f73         if not os
-000338d0: 2e70 6174 682e 6578 6973 7473 2866 696c  .path.exists(fil
-000338e0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-000338f0: 7072 696e 7428 2747 6574 207b 307d 272e  print('Get {0}'.
-00033900: 666f 726d 6174 2866 696c 6529 290a 2020  format(file)).  
-00033910: 2020 2020 2020 2020 2020 6f73 2e73 7973            os.sys
-00033920: 7465 6d28 2763 7572 6c20 2d6f 207b 307d  tem('curl -o {0}
-00033930: 207b 317d 272e 666f 726d 6174 2866 696c   {1}'.format(fil
-00033940: 652c 2075 726c 2929 0a0a 2020 2020 2020  e, url))..      
-00033950: 2020 6966 2027 2e74 6172 2720 696e 2066    if '.tar' in f
-00033960: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
-00033970: 206f 732e 7379 7374 656d 2827 7461 7220   os.system('tar 
-00033980: 787a 7666 207b 307d 272e 666f 726d 6174  xzvf {0}'.format
-00033990: 2866 696c 6529 290a 0a20 2020 2069 6620  (file))..    if 
-000339a0: 6765 745f 6570 7366 3a0a 2020 2020 2020  get_epsf:.      
-000339b0: 2020 2320 6550 5346 2066 696c 6573 2066    # ePSF files f
-000339c0: 6f72 2066 6974 7469 6e67 2070 6f69 6e74  or fitting point
-000339d0: 2073 6f75 7263 6573 0a20 2020 2020 2020   sources.       
-000339e0: 2023 7073 665f 7061 7468 203d 2027 6874   #psf_path = 'ht
-000339f0: 7470 3a2f 2f77 7777 2e73 7473 6369 2e65  tp://www.stsci.e
-00033a00: 6475 2f68 7374 2f77 6663 332f 616e 616c  du/hst/wfc3/anal
-00033a10: 7973 6973 2f50 5346 2f70 7366 5f64 6f77  ysis/PSF/psf_dow
-00033a20: 6e6c 6f61 6473 2f77 6663 335f 6972 2f27  nloads/wfc3_ir/'
-00033a30: 0a20 2020 2020 2020 2023 7073 665f 7061  .        #psf_pa
-00033a40: 7468 203d 2027 6874 7470 733a 2f2f 7777  th = 'https://ww
-00033a50: 772e 7374 7363 692e 6564 752f 7e6a 6179  w.stsci.edu/~jay
-00033a60: 616e 6465 722f 5354 4450 5346 732f 5746  ander/STDPSFs/WF
-00033a70: 4333 4952 2f27 0a20 2020 2020 2020 2023  C3IR/'.        #
-00033a80: 7073 665f 726f 6f74 203d 2027 5053 4653  psf_root = 'PSFS
-00033a90: 5444 270a 2020 2020 2020 2020 2370 7366  TD'.        #psf
-00033aa0: 5f70 6174 6820 3d20 2768 7474 7073 3a2f  _path = 'https:/
-00033ab0: 2f77 7777 2e73 7473 6369 2e65 6475 2f7e  /www.stsci.edu/~
-00033ac0: 6a61 7961 6e64 6572 2f48 5354 3150 4153  jayander/HST1PAS
-00033ad0: 532f 270a 2020 2020 2020 2020 7073 665f  S/'.        psf_
-00033ae0: 7061 7468 203d 2027 6874 7470 733a 2f2f  path = 'https://
-00033af0: 7777 772e 7374 7363 692e 6564 752f 7e6a  www.stsci.edu/~j
-00033b00: 6179 616e 6465 722f 4853 5431 5041 5353  ayander/HST1PASS
-00033b10: 2f4c 4942 2f27 0a20 2020 2020 2020 2070  /LIB/'.        p
-00033b20: 7366 5f70 6174 6820 2b3d 2027 5053 4673  sf_path += 'PSFs
-00033b30: 2f53 5444 5053 4673 2f57 4643 3349 522f  /STDPSFs/WFC3IR/
-00033b40: 270a 2020 2020 2020 2020 7073 665f 726f  '.        psf_ro
-00033b50: 6f74 203d 2027 5354 4450 5346 270a 2020  ot = 'STDPSF'.  
-00033b60: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-00033b70: 725f 7073 665f 6669 6c74 6572 7320 3d20  r_psf_filters = 
-00033b80: 5b27 4631 3035 5727 2c20 2746 3132 3557  ['F105W', 'F125W
-00033b90: 272c 2027 4631 3430 5727 2c20 2746 3136  ', 'F140W', 'F16
-00033ba0: 3057 275d 0a0a 2020 2020 2020 2020 2320  0W']..        # 
-00033bb0: 4e65 7720 5053 4673 0a20 2020 2020 2020  New PSFs.       
-00033bc0: 2069 725f 7073 665f 6669 6c74 6572 7320   ir_psf_filters 
-00033bd0: 2b3d 205b 2746 3131 3057 272c 2027 4631  += ['F110W', 'F1
-00033be0: 3237 4d27 5d0a 0a20 2020 2020 2020 2066  27M']..        f
-00033bf0: 696c 6573 203d 205b 277b 307d 2f7b 317d  iles = ['{0}/{1}
-00033c00: 5f57 4643 3349 525f 7b32 7d2e 6669 7473  _WFC3IR_{2}.fits
-00033c10: 272e 666f 726d 6174 2870 7366 5f70 6174  '.format(psf_pat
-00033c20: 682c 2070 7366 5f72 6f6f 742c 2066 696c  h, psf_root, fil
-00033c30: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00033c40: 2020 2020 666f 7220 6669 6c74 2069 6e20      for filt in 
-00033c50: 6972 5f70 7366 5f66 696c 7465 7273 5d0a  ir_psf_filters].
-00033c60: 0a20 2020 2020 2020 2066 6f72 2075 726c  .        for url
-00033c70: 2069 6e20 6669 6c65 733a 0a20 2020 2020   in files:.     
-00033c80: 2020 2020 2020 2066 696c 6520 3d20 6f73         file = os
-00033c90: 2e70 6174 682e 6261 7365 6e61 6d65 2875  .path.basename(u
-00033ca0: 726c 292e 7265 706c 6163 6528 2753 5444  rl).replace('STD
-00033cb0: 5053 4627 2c20 2750 5346 5354 4427 290a  PSF', 'PSFSTD').
-00033cc0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00033cd0: 6f74 206f 732e 7061 7468 2e65 7869 7374  ot os.path.exist
-00033ce0: 7328 6669 6c65 293a 0a20 2020 2020 2020  s(file):.       
-00033cf0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00033d00: 4765 7420 7b30 7d27 2e66 6f72 6d61 7428  Get {0}'.format(
-00033d10: 6669 6c65 2929 0a20 2020 2020 2020 2020  file)).         
-00033d20: 2020 2020 2020 206f 732e 7379 7374 656d         os.system
-00033d30: 2827 6375 726c 202d 6f20 7b30 7d20 7b31  ('curl -o {0} {1
-00033d40: 7d27 2e66 6f72 6d61 7428 6669 6c65 2c20  }'.format(file, 
-00033d50: 7572 6c29 290a 2020 2020 2020 2020 2020  url)).          
-00033d60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00033d70: 2020 2020 2020 2020 7072 696e 7428 2746          print('F
-00033d80: 696c 6520 7b30 7d20 6578 6973 7473 272e  ile {0} exists'.
-00033d90: 666f 726d 6174 2866 696c 6529 290a 0a20  format(file)).. 
-00033da0: 2020 2069 6620 6765 745f 7374 6172 733a     if get_stars:
-00033db0: 0a20 2020 2020 2020 2023 2053 7465 6c6c  .        # Stell
-00033dc0: 6172 2074 656d 706c 6174 6573 0a20 2020  ar templates.   
-00033dd0: 2020 2020 2070 7269 6e74 2827 5465 6d70       print('Temp
-00033de0: 6c61 7465 7320 6469 7265 6374 6f72 793a  lates directory:
-00033df0: 207b 307d 2f74 656d 706c 6174 6573 272e   {0}/templates'.
-00033e00: 666f 726d 6174 2847 5249 5a4c 495f 5041  format(GRIZLI_PA
-00033e10: 5448 2929 0a20 2020 2020 2020 206f 732e  TH)).        os.
-00033e20: 6368 6469 7228 277b 307d 2f74 656d 706c  chdir('{0}/templ
-00033e30: 6174 6573 272e 666f 726d 6174 2847 5249  ates'.format(GRI
-00033e40: 5a4c 495f 5041 5448 2929 0a0a 2020 2020  ZLI_PATH))..    
-00033e50: 2020 2020 7572 6c20 3d20 2768 7474 7073      url = 'https
-00033e60: 3a2f 2f77 7777 2e73 7473 6369 2e65 6475  ://www.stsci.edu
-00033e70: 2f7e 6272 616d 6d65 722f 4772 697a 6c69  /~brammer/Grizli
-00033e80: 2f46 696c 6573 2f27 0a20 2020 2020 2020  /Files/'.       
-00033e90: 2066 696c 6573 203d 205b 7572 6c2b 2773   files = [url+'s
-00033ea0: 7461 7273 5f70 6963 6b6c 6573 2e6e 7079  tars_pickles.npy
-00033eb0: 272c 2075 726c 2b27 7374 6172 735f 6270  ', url+'stars_bp
-00033ec0: 6773 2e6e 7079 275d 0a0a 2020 2020 2020  gs.npy']..      
-00033ed0: 2020 666f 7220 7572 6c20 696e 2066 696c    for url in fil
-00033ee0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00033ef0: 6669 6c65 203d 206f 732e 7061 7468 2e62  file = os.path.b
-00033f00: 6173 656e 616d 6528 7572 6c29 0a20 2020  asename(url).   
-00033f10: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00033f20: 6f73 2e70 6174 682e 6578 6973 7473 2866  os.path.exists(f
-00033f30: 696c 6529 3a0a 2020 2020 2020 2020 2020  ile):.          
-00033f40: 2020 2020 2020 7072 696e 7428 2747 6574        print('Get
-00033f50: 207b 307d 272e 666f 726d 6174 2866 696c   {0}'.format(fil
-00033f60: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00033f70: 2020 2020 6f73 2e73 7973 7465 6d28 2763      os.system('c
-00033f80: 7572 6c20 2d6f 207b 307d 207b 317d 272e  url -o {0} {1}'.
-00033f90: 666f 726d 6174 2866 696c 652c 2075 726c  format(file, url
-00033fa0: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-00033fb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00033fc0: 2020 2020 2070 7269 6e74 2827 4669 6c65       print('File
-00033fd0: 207b 307d 2065 7869 7374 7327 2e66 6f72   {0} exists'.for
-00033fe0: 6d61 7428 6669 6c65 2929 0a0a 2020 2020  mat(file))..    
-00033ff0: 2020 2020 7072 696e 7428 276c 6e20 2d73      print('ln -s
-00034000: 2073 7461 7273 5f70 6963 6b6c 6573 2e6e   stars_pickles.n
-00034010: 7079 2073 7461 7273 2e6e 7079 2729 0a20  py stars.npy'). 
-00034020: 2020 2020 2020 206f 732e 7379 7374 656d         os.system
-00034030: 2827 6c6e 202d 7320 7374 6172 735f 7069  ('ln -s stars_pi
-00034040: 636b 6c65 732e 6e70 7920 7374 6172 732e  ckles.npy stars.
-00034050: 6e70 7927 290a 0a20 2020 206f 732e 6368  npy')..    os.ch
-00034060: 6469 7228 6377 6429 0a0a 0a63 6c61 7373  dir(cwd)...class
-00034070: 204d 575f 4639 3928 6f62 6a65 6374 293a   MW_F99(object):
-00034080: 0a20 2020 2022 2222 0a20 2020 2057 7261  .    """.    Wra
-00034090: 7070 6572 2061 726f 756e 6420 7468 6520  pper around the 
-000340a0: 6073 7065 6375 7469 6c73 2e65 7874 696e  `specutils.extin
-000340b0: 6374 696f 6e60 202f 2060 6578 7469 6e63  ction` / `extinc
-000340c0: 7469 6f6e 6020 6d6f 6475 6c65 732c 2077  tion` modules, w
-000340d0: 6869 6368 2061 7265 2063 616c 6c65 6420  hich are called 
-000340e0: 6469 6666 6572 656e 746c 790a 2020 2020  differently.    
-000340f0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
-00034100: 6e69 745f 5f28 7365 6c66 2c20 615f 762c  nit__(self, a_v,
-00034110: 2072 5f76 3d33 2e31 293a 0a20 2020 2020   r_v=3.1):.     
-00034120: 2020 2073 656c 662e 615f 7620 3d20 615f     self.a_v = a_
-00034130: 760a 2020 2020 2020 2020 7365 6c66 2e72  v.        self.r
-00034140: 5f76 203d 2072 5f76 0a0a 2020 2020 2020  _v = r_v..      
-00034150: 2020 7365 6c66 2e49 535f 5350 4543 5554    self.IS_SPECUT
-00034160: 494c 5320 3d20 4661 6c73 650a 2020 2020  ILS = False.    
-00034170: 2020 2020 7365 6c66 2e49 535f 4558 5449      self.IS_EXTI
-00034180: 4e43 5449 4f4e 203d 2046 616c 7365 0a0a  NCTION = False..
-00034190: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000341a0: 2020 2020 2020 2020 2066 726f 6d20 7370           from sp
-000341b0: 6563 7574 696c 732e 6578 7469 6e63 7469  ecutils.extincti
-000341c0: 6f6e 2069 6d70 6f72 7420 4578 7469 6e63  on import Extinc
-000341d0: 7469 6f6e 4639 390a 2020 2020 2020 2020  tionF99.        
-000341e0: 2020 2020 7365 6c66 2e49 535f 5350 4543      self.IS_SPEC
-000341f0: 5554 494c 5320 3d20 5472 7565 0a20 2020  UTILS = True.   
-00034200: 2020 2020 2020 2020 2073 656c 662e 4639           self.F9
-00034210: 3920 3d20 4578 7469 6e63 7469 6f6e 4639  9 = ExtinctionF9
-00034220: 3928 7365 6c66 2e61 5f76 2c20 725f 763d  9(self.a_v, r_v=
-00034230: 7365 6c66 2e72 5f76 290a 2020 2020 2020  self.r_v).      
-00034240: 2020 6578 6365 7074 2849 6d70 6f72 7445    except(ImportE
-00034250: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00034260: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00034270: 2020 2020 2020 2020 6672 6f6d 2065 7874          from ext
-00034280: 696e 6374 696f 6e20 696d 706f 7274 2046  inction import F
-00034290: 6974 7a70 6174 7269 636b 3939 0a20 2020  itzpatrick99.   
-000342a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000342b0: 662e 4953 5f45 5854 494e 4354 494f 4e20  f.IS_EXTINCTION 
-000342c0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-000342d0: 2020 2020 2020 2073 656c 662e 4639 3920         self.F99 
-000342e0: 3d20 4669 747a 7061 7472 6963 6b39 3928  = Fitzpatrick99(
-000342f0: 725f 763d 7365 6c66 2e72 5f76 290a 0a20  r_v=self.r_v).. 
-00034300: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00034310: 7428 496d 706f 7274 4572 726f 7229 3a0a  t(ImportError):.
-00034320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034330: 7072 696e 7428 2222 220a 436f 756c 646e  print(""".Couldn
-00034340: 5c27 7420 6669 6e64 2065 7874 696e 6374  \'t find extinct
-00034350: 696f 6e20 6d6f 6475 6c65 7320 696e 0a60  ion modules in.`
-00034360: 7370 6563 7574 696c 732e 6578 7469 6e63  specutils.extinc
-00034370: 7469 6f6e 6020 6f72 0a60 6578 7469 6e63  tion` or.`extinc
-00034380: 7469 6f6e 2e46 6974 7a70 6174 7269 636b  tion.Fitzpatrick
-00034390: 3939 602e 0a0a 4d57 2065 7874 696e 6374  99`...MW extinct
-000343a0: 696f 6e20 6e6f 7420 696d 706c 656d 656e  ion not implemen
-000343b0: 7465 642e 0a22 2222 290a 0a20 2020 2020  ted..""")..     
-000343c0: 2020 2073 656c 662e 7374 6174 7573 203d     self.status =
-000343d0: 2073 656c 662e 4953 5f53 5045 4355 5449   self.IS_SPECUTI
-000343e0: 4c53 207c 2073 656c 662e 4953 5f45 5854  LS | self.IS_EXT
-000343f0: 494e 4354 494f 4e0a 0a20 2020 2064 6566  INCTION..    def
-00034400: 205f 5f63 616c 6c5f 5f28 7365 6c66 2c20   __call__(self, 
-00034410: 7761 7665 5f69 6e70 7574 293a 0a20 2020  wave_input):.   
-00034420: 2020 2020 2069 6d70 6f72 7420 6173 7472       import astr
-00034430: 6f70 792e 756e 6974 7320 6173 2075 0a0a  opy.units as u..
-00034440: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00034450: 7461 6e63 6528 7761 7665 5f69 6e70 7574  tance(wave_input
-00034460: 2c20 6c69 7374 293a 0a20 2020 2020 2020  , list):.       
-00034470: 2020 2020 2077 6176 6520 3d20 6e70 2e61       wave = np.a
-00034480: 7272 6179 2877 6176 655f 696e 7075 7429  rray(wave_input)
-00034490: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000344a0: 2020 2020 2020 2020 2020 2077 6176 6520             wave 
-000344b0: 3d20 7761 7665 5f69 6e70 7574 0a0a 2020  = wave_input..  
-000344c0: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
-000344d0: 6174 7573 2069 7320 4661 6c73 653a 0a20  atus is False:. 
-000344e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000344f0: 6e20 6e70 2e7a 6572 6f73 5f6c 696b 6528  n np.zeros_like(
-00034500: 7761 7665 290a 0a20 2020 2020 2020 2069  wave)..        i
-00034510: 6620 7365 6c66 2e49 535f 5350 4543 5554  f self.IS_SPECUT
-00034520: 494c 533a 0a20 2020 2020 2020 2020 2020  ILS:.           
-00034530: 2069 6620 6861 7361 7474 7228 7761 7665   if hasattr(wave
-00034540: 2c20 2775 6e69 7427 293a 0a20 2020 2020  , 'unit'):.     
-00034550: 2020 2020 2020 2020 2020 2077 6176 655f             wave_
-00034560: 6161 203d 2077 6176 650a 2020 2020 2020  aa = wave.      
-00034570: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00034580: 2020 2020 2020 2020 2020 2020 7761 7665              wave
-00034590: 5f61 6120 3d20 7761 7665 2a75 2e41 410a  _aa = wave*u.AA.
-000345a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000345b0: 7572 6e20 7365 6c66 2e46 3939 2877 6176  urn self.F99(wav
-000345c0: 655f 6161 290a 0a20 2020 2020 2020 2069  e_aa)..        i
-000345d0: 6620 7365 6c66 2e49 535f 4558 5449 4e43  f self.IS_EXTINC
-000345e0: 5449 4f4e 3a0a 2020 2020 2020 2020 2020  TION:.          
-000345f0: 2020 6966 2068 6173 6174 7472 2877 6176    if hasattr(wav
-00034600: 652c 2027 756e 6974 2729 3a0a 2020 2020  e, 'unit'):.    
-00034610: 2020 2020 2020 2020 2020 2020 7761 7665              wave
-00034620: 5f61 6120 3d20 7761 7665 2e74 6f28 752e  _aa = wave.to(u.
-00034630: 4141 290a 2020 2020 2020 2020 2020 2020  AA).            
-00034640: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00034650: 2020 2020 2020 7761 7665 5f61 6120 3d20        wave_aa = 
-00034660: 7761 7665 0a0a 2020 2020 2020 2020 2020  wave..          
-00034670: 2020 7265 7475 726e 2073 656c 662e 4639    return self.F9
-00034680: 3928 7761 7665 5f61 612c 2073 656c 662e  9(wave_aa, self.
-00034690: 615f 762c 2075 6e69 743d 2761 6127 290a  a_v, unit='aa').
-000346a0: 0a0a 636c 6173 7320 4566 6665 6374 6976  ..class Effectiv
-000346b0: 6550 5346 3a0a 2020 2020 6465 6620 5f5f  ePSF:.    def __
-000346c0: 696e 6974 5f5f 2873 656c 6629 3a0a 2020  init__(self):.  
-000346d0: 2020 2020 2020 2222 2254 6f6f 6c73 2066        """Tools f
-000346e0: 6f72 2068 616e 646c 696e 6720 5746 4333  or handling WFC3
-000346f0: 2f49 5220 4566 6665 6374 6976 6520 5053  /IR Effective PS
-00034700: 460a 0a20 2020 2020 2020 2053 6565 2064  F..        See d
-00034710: 6f63 756d 656e 7461 7469 6f6e 2061 7420  ocumentation at 
-00034720: 6874 7470 3a2f 2f77 7777 2e73 7473 6369  http://www.stsci
-00034730: 2e65 6475 2f68 7374 2f77 6663 332f 616e  .edu/hst/wfc3/an
-00034740: 616c 7973 6973 2f50 5346 2e0a 0a20 2020  alysis/PSF...   
-00034750: 2020 2020 2050 5346 2066 696c 6573 2073       PSF files s
-00034760: 746f 7265 6420 696e 2024 4752 495a 4c49  tored in $GRIZLI
-00034770: 2f43 4f4e 462f 0a20 2020 2020 2020 2022  /CONF/.        "
-00034780: 2222 0a0a 2020 2020 2020 2020 7365 6c66  ""..        self
-00034790: 2e6c 6f61 645f 5053 465f 6461 7461 2829  .load_PSF_data()
-000347a0: 0a0a 2020 2020 6465 6620 6c6f 6164 5f50  ..    def load_P
-000347b0: 5346 5f64 6174 6128 7365 6c66 293a 0a20  SF_data(self):. 
-000347c0: 2020 2020 2020 2022 2222 4c6f 6164 2064         """Load d
-000347d0: 6174 6120 6672 6f6d 2050 5346 5354 4420  ata from PSFSTD 
-000347e0: 6669 6c65 730a 0a20 2020 2020 2020 2046  files..        F
-000347f0: 696c 6573 2073 686f 756c 6420 6265 206c  iles should be l
-00034800: 6f63 6174 6564 2069 6e20 247b 4752 495a  ocated in ${GRIZ
-00034810: 4c49 7d2f 434f 4e46 2f20 6469 7265 6374  LI}/CONF/ direct
-00034820: 6f72 792e 0a20 2020 2020 2020 2022 2222  ory..        """
-00034830: 0a20 2020 2020 2020 2073 656c 662e 6570  .        self.ep
-00034840: 7366 203d 204f 7264 6572 6564 4469 6374  sf = OrderedDict
-00034850: 2829 0a0a 2020 2020 2020 2020 666f 7220  ()..        for 
-00034860: 6669 6c74 6572 2069 6e20 5b27 4631 3035  filter in ['F105
-00034870: 5727 2c20 2746 3131 3057 272c 2027 4631  W', 'F110W', 'F1
-00034880: 3235 5727 2c20 2746 3134 3057 272c 2027  25W', 'F140W', '
-00034890: 4631 3630 5727 2c20 2746 3132 374d 275d  F160W', 'F127M']
-000348a0: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-000348b0: 6c65 203d 206f 732e 7061 7468 2e6a 6f69  le = os.path.joi
-000348c0: 6e28 4752 495a 4c49 5f50 4154 482c 2027  n(GRIZLI_PATH, '
-000348d0: 434f 4e46 272c 0a20 2020 2020 2020 2020  CONF',.         
-000348e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000348f0: 2020 2020 2020 2027 5053 4653 5444 5f57         'PSFSTD_W
-00034900: 4643 3349 525f 7b30 7d2e 6669 7473 272e  FC3IR_{0}.fits'.
-00034910: 666f 726d 6174 2866 696c 7465 7229 290a  format(filter)).
-00034920: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00034930: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
-00034940: 7473 2866 696c 6529 3a0a 2020 2020 2020  ts(file):.      
-00034950: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00034960: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-00034970: 7769 7468 2070 7966 6974 732e 6f70 656e  with pyfits.open
-00034980: 2866 696c 6529 2061 7320 5f69 6d3a 0a20  (file) as _im:. 
-00034990: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000349a0: 6174 6120 3d20 5f69 6d5b 305d 2e64 6174  ata = _im[0].dat
-000349b0: 612e 542a 310a 2020 2020 2020 2020 2020  a.T*1.          
-000349c0: 2020 2020 2020 6461 7461 5b64 6174 6120        data[data 
-000349d0: 3c20 305d 203d 2030 0a0a 2020 2020 2020  < 0] = 0..      
-000349e0: 2020 2020 2020 7365 6c66 2e65 7073 665b        self.epsf[
-000349f0: 6669 6c74 6572 5d20 3d20 6461 7461 0a20  filter] = data. 
-00034a00: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00034a10: 2320 5556 4953 0a20 2020 2020 2020 2066  # UVIS.        f
-00034a20: 696c 7465 725f 6669 6c65 7320 3d20 676c  ilter_files = gl
-00034a30: 6f62 2e67 6c6f 6228 6f73 2e70 6174 682e  ob.glob(os.path.
-00034a40: 6a6f 696e 2847 5249 5a4c 495f 5041 5448  join(GRIZLI_PATH
-00034a50: 2c20 2743 4f4e 4627 2c0a 2020 2020 2020  , 'CONF',.      
-00034a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034a70: 2020 2020 2020 2750 5346 5354 445f 5746        'PSFSTD_WF
-00034a80: 4333 5556 2a2e 6669 7473 2729 290a 2020  C3UV*.fits')).  
-00034a90: 2020 2020 2020 6669 6c74 6572 5f66 696c        filter_fil
-00034aa0: 6573 2e73 6f72 7428 290a 2020 2020 2020  es.sort().      
-00034ab0: 2020 666f 7220 6669 6c65 2069 6e20 6669    for file in fi
-00034ac0: 6c74 6572 5f66 696c 6573 3a0a 2020 2020  lter_files:.    
-00034ad0: 2020 2020 2020 2020 7769 7468 2070 7966          with pyf
-00034ae0: 6974 732e 6f70 656e 2866 696c 652c 2069  its.open(file, i
-00034af0: 676e 6f72 655f 6d69 7373 696e 675f 656e  gnore_missing_en
-00034b00: 643d 5472 7565 2920 6173 205f 696d 3a0a  d=True) as _im:.
-00034b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b20: 6461 7461 203d 205f 696d 5b30 5d2e 6461  data = _im[0].da
-00034b30: 7461 2e54 2a31 0a20 2020 2020 2020 2020  ta.T*1.         
-00034b40: 2020 2020 2020 2064 6174 615b 6461 7461         data[data
-00034b50: 203c 2030 5d20 3d20 300a 2020 2020 2020   < 0] = 0.      
-00034b60: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00034b70: 2020 2020 2020 2066 696c 7420 3d20 275f         filt = '_
-00034b80: 272e 6a6f 696e 2866 696c 652e 7374 7269  '.join(file.stri
-00034b90: 7028 272e 6669 7473 2729 2e73 706c 6974  p('.fits').split
-00034ba0: 2827 5f27 295b 323a 5d29 0a20 2020 2020  ('_')[2:]).     
-00034bb0: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
-00034bc0: 5b66 696c 742b 2755 275d 203d 2064 6174  [filt+'U'] = dat
-00034bd0: 610a 0a20 2020 2020 2020 2023 2041 4353  a..        # ACS
-00034be0: 0a20 2020 2020 2020 2066 696c 7465 725f  .        filter_
-00034bf0: 6669 6c65 7320 3d20 676c 6f62 2e67 6c6f  files = glob.glo
-00034c00: 6228 6f73 2e70 6174 682e 6a6f 696e 2847  b(os.path.join(G
-00034c10: 5249 5a4c 495f 5041 5448 2c20 2743 4f4e  RIZLI_PATH, 'CON
-00034c20: 4627 2c0a 2020 2020 2020 2020 2020 2020  F',.            
-00034c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034c40: 2750 5346 5354 445f 4143 5357 4643 2a2e  'PSFSTD_ACSWFC*.
-00034c50: 6669 7473 2729 290a 2020 2020 2020 2020  fits')).        
-00034c60: 6669 6c74 6572 5f66 696c 6573 2e73 6f72  filter_files.sor
-00034c70: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
-00034c80: 6669 6c65 2069 6e20 6669 6c74 6572 5f66  file in filter_f
-00034c90: 696c 6573 3a0a 2020 2020 2020 2020 2020  iles:.          
-00034ca0: 2020 7769 7468 2070 7966 6974 732e 6f70    with pyfits.op
-00034cb0: 656e 2866 696c 652c 2069 676e 6f72 655f  en(file, ignore_
-00034cc0: 6d69 7373 696e 675f 656e 643d 5472 7565  missing_end=True
-00034cd0: 2920 6173 205f 696d 3a0a 2020 2020 2020  ) as _im:.      
-00034ce0: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00034cf0: 205f 696d 5b30 5d2e 6461 7461 2e54 2a31   _im[0].data.T*1
-00034d00: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00034d10: 2020 6461 7461 5b64 6174 6120 3c20 305d    data[data < 0]
-00034d20: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-00034d30: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00034d40: 2020 6669 6c74 203d 2027 5f27 2e6a 6f69    filt = '_'.joi
-00034d50: 6e28 6669 6c65 2e73 7472 6970 2827 2e66  n(file.strip('.f
-00034d60: 6974 7327 292e 7370 6c69 7428 275f 2729  its').split('_')
-00034d70: 5b32 3a5d 290a 2020 2020 2020 2020 2020  [2:]).          
-00034d80: 2020 7365 6c66 2e65 7073 665b 6669 6c74    self.epsf[filt
-00034d90: 5d20 3d20 6461 7461 0a20 2020 2020 2020  ] = data.       
-00034da0: 200a 2020 2020 2020 2020 2320 4a57 5354   .        # JWST
-00034db0: 0a20 2020 2020 2020 2066 696c 7465 725f  .        filter_
-00034dc0: 6669 6c65 7320 3d20 676c 6f62 2e67 6c6f  files = glob.glo
-00034dd0: 6228 6f73 2e70 6174 682e 6a6f 696e 2847  b(os.path.join(G
-00034de0: 5249 5a4c 495f 5041 5448 2c20 2743 4f4e  RIZLI_PATH, 'CON
-00034df0: 462f 4a57 5354 6550 5346 272c 0a20 2020  F/JWSTePSF',.   
-00034e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034e10: 2020 2020 2020 2020 2027 6e69 7263 616d           'nircam
-00034e20: 2a2e 6669 7473 2729 290a 2020 2020 2020  *.fits')).      
-00034e30: 2020 6669 6c74 6572 5f66 696c 6573 202b    filter_files +
-00034e40: 3d20 676c 6f62 2e67 6c6f 6228 6f73 2e70  = glob.glob(os.p
-00034e50: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
-00034e60: 5041 5448 2c20 2743 4f4e 462f 4a57 5354  PATH, 'CONF/JWST
-00034e70: 6550 5346 272c 0a20 2020 2020 2020 2020  ePSF',.         
+000312f0: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
+00031300: 6d65 2c20 726f 6f74 2929 0a0a 2020 2020  me, root))..    
+00031310: 2020 2020 2020 2020 6966 2048 4153 5f42          if HAS_B
+00031320: 4f54 4f3a 0a20 2020 2020 2020 2020 2020  OTO:.           
+00031330: 2020 2020 2073 3320 3d20 626f 746f 332e       s3 = boto3.
+00031340: 7265 736f 7572 6365 2827 7333 2729 0a20  resource('s3'). 
+00031350: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00031360: 335f 636c 6965 6e74 203d 2062 6f74 6f33  3_client = boto3
+00031370: 2e63 6c69 656e 7428 2773 3327 290a 2020  .client('s3').  
+00031380: 2020 2020 2020 2020 2020 2020 2020 626b                bk
+00031390: 7420 3d20 7333 2e42 7563 6b65 7428 6275  t = s3.Bucket(bu
+000313a0: 636b 6574 5f6e 616d 6529 0a0a 2020 2020  cket_name)..    
+000313b0: 2020 2020 2020 2020 2020 2020 7333 5f70              s3_p
+000313c0: 6174 6820 3d20 2750 6970 656c 696e 652f  ath = 'Pipeline/
+000313d0: 7b30 7d2f 4578 7472 6163 7469 6f6e 732f  {0}/Extractions/
+000313e0: 7b31 7d27 2e66 6f72 6d61 7428 726f 6f74  {1}'.format(root
+000313f0: 2c20 7763 7366 696c 6529 0a20 2020 2020  , wcsfile).     
+00031400: 2020 2020 2020 2020 2020 2062 6b74 2e64             bkt.d
+00031410: 6f77 6e6c 6f61 645f 6669 6c65 2873 335f  ownload_file(s3_
+00031420: 7061 7468 2c20 272e 2f7b 307d 272e 666f  path, './{0}'.fo
+00031430: 726d 6174 2877 6373 6669 6c65 292c 0a20  rmat(wcsfile),. 
+00031440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031460: 2045 7874 7261 4172 6773 3d7b 2252 6571   ExtraArgs={"Req
+00031470: 7565 7374 5061 7965 7222 3a20 2272 6571  uestPayer": "req
+00031480: 7565 7374 6572 227d 290a 0a20 2020 2020  uester"})..     
+00031490: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000314a0: 2020 2020 2020 2020 2020 2020 2075 726c               url
+000314b0: 203d 2027 6874 7470 733a 2f2f 7333 2e61   = 'https://s3.a
+000314c0: 6d61 7a6f 6e61 7773 2e63 6f6d 2f7b 307d  mazonaws.com/{0}
+000314d0: 2f27 2e66 6f72 6d61 7428 6275 636b 6574  /'.format(bucket
+000314e0: 5f6e 616d 6529 0a20 2020 2020 2020 2020  _name).         
+000314f0: 2020 2020 2020 2075 726c 202b 3d20 2750         url += 'P
+00031500: 6970 656c 696e 652f 7b30 7d2f 4578 7472  ipeline/{0}/Extr
+00031510: 6163 7469 6f6e 732f 7b31 7d27 2e66 6f72  actions/{1}'.for
+00031520: 6d61 7428 726f 6f74 2c20 7763 7366 696c  mat(root, wcsfil
+00031530: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+00031540: 2020 2020 7072 696e 7428 2746 6574 6368      print('Fetch
+00031550: 2057 4353 2066 696c 653a 207b 307d 272e   WCS file: {0}'.
+00031560: 666f 726d 6174 2875 726c 2929 0a20 2020  format(url)).   
+00031570: 2020 2020 2020 2020 2020 2020 2072 6571               req
+00031580: 203d 2072 6571 7565 7374 2e75 726c 7265   = request.urlre
+00031590: 7472 6965 7665 2875 726c 2c20 7763 7366  trieve(url, wcsf
+000315a0: 696c 6529 0a0a 2020 2020 696d 2e63 6c6f  ile)..    im.clo
+000315b0: 7365 2829 0a0a 0a64 6566 2066 6574 6368  se()...def fetch
+000315c0: 5f68 7374 5f63 616c 6962 2866 696c 653d  _hst_calib(file=
+000315d0: 2769 7265 6624 7563 3732 3131 336f 695f  'iref$uc72113oi_
+000315e0: 7066 6c2e 6669 7473 272c 2020 6674 7064  pfl.fits',  ftpd
+000315f0: 6972 3d27 6874 7470 733a 2f2f 6873 742d  ir='https://hst-
+00031600: 6372 6473 2e73 7473 6369 2e65 6475 2f75  crds.stsci.edu/u
+00031610: 6e63 6865 636b 6564 5f67 6574 2f72 6566  nchecked_get/ref
+00031620: 6572 656e 6365 732f 6873 742f 272c 2076  erences/hst/', v
+00031630: 6572 626f 7365 3d54 7275 652c 2072 6566  erbose=True, ref
+00031640: 5f70 6174 6873 3d7b 7d2c 2072 656d 6f76  _paths={}, remov
+00031650: 655f 636f 7272 7570 743d 5472 7565 293a  e_corrupt=True):
+00031660: 0a20 2020 2022 2222 0a20 2020 2054 4244  .    """.    TBD
+00031670: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+00031680: 6f72 7420 6f73 0a0a 2020 2020 7265 665f  ort os..    ref_
+00031690: 6469 7220 3d20 6669 6c65 2e73 706c 6974  dir = file.split
+000316a0: 2827 2427 295b 305d 0a20 2020 2063 696d  ('$')[0].    cim
+000316b0: 6720 3d20 6669 6c65 2e73 706c 6974 2827  g = file.split('
+000316c0: 7b30 7d24 272e 666f 726d 6174 2872 6566  {0}$'.format(ref
+000316d0: 5f64 6972 2929 5b31 5d0a 2020 2020 0a20  _dir))[1].    . 
+000316e0: 2020 2069 6620 7265 665f 6469 7220 696e     if ref_dir in
+000316f0: 2072 6566 5f70 6174 6873 3a0a 2020 2020   ref_paths:.    
+00031700: 2020 2020 7265 665f 7061 7468 203d 2072      ref_path = r
+00031710: 6566 5f70 6174 6873 5b72 6566 5f64 6972  ef_paths[ref_dir
+00031720: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
+00031730: 2020 2020 7265 665f 7061 7468 203d 206f      ref_path = o
+00031740: 732e 6765 7465 6e76 2872 6566 5f64 6972  s.getenv(ref_dir
+00031750: 290a 2020 2020 2020 2020 0a20 2020 2069  ).        .    i
+00031760: 7265 665f 6669 6c65 203d 206f 732e 7061  ref_file = os.pa
+00031770: 7468 2e6a 6f69 6e28 7265 665f 7061 7468  th.join(ref_path
+00031780: 2c20 6369 6d67 290a 2020 2020 6966 206e  , cimg).    if n
+00031790: 6f74 206f 732e 7061 7468 2e65 7869 7374  ot os.path.exist
+000317a0: 7328 6972 6566 5f66 696c 6529 3a0a 2020  s(iref_file):.  
+000317b0: 2020 2020 2020 6f73 2e73 7973 7465 6d28        os.system(
+000317c0: 2763 7572 6c20 2d6f 207b 307d 207b 317d  'curl -o {0} {1}
+000317d0: 2f7b 327d 272e 666f 726d 6174 2869 7265  /{2}'.format(ire
+000317e0: 665f 6669 6c65 2c20 6674 7064 6972 2c20  f_file, ftpdir, 
+000317f0: 6369 6d67 2929 0a20 2020 2020 2020 2069  cimg)).        i
+00031800: 6620 2766 6974 7327 2069 6e20 6972 6566  f 'fits' in iref
+00031810: 5f66 696c 653a 0a20 2020 2020 2020 2020  _file:.         
+00031820: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00031830: 2020 2020 2020 2020 5f69 6d20 3d20 2070          _im =  p
+00031840: 7966 6974 732e 6f70 656e 2869 7265 665f  yfits.open(iref_
+00031850: 6669 6c65 290a 2020 2020 2020 2020 2020  file).          
+00031860: 2020 2020 2020 5f69 6d2e 636c 6f73 6528        _im.close(
+00031870: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+00031880: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+00031890: 2020 2020 2020 6d73 6720 3d20 2827 446f        msg = ('Do
+000318a0: 776e 6c6f 6164 6564 2066 696c 6520 7b30  wnloaded file {0
+000318b0: 7d20 6170 7065 6172 7320 746f 2062 6520  } appears to be 
+000318c0: 636f 7272 7570 742e 5c6e 270a 2020 2020  corrupt.\n'.    
+000318d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000318e0: 2020 2027 4368 6563 6b20 7468 6174 207b     'Check that {
+000318f0: 317d 2f7b 327d 2065 7869 7374 7320 616e  1}/{2} exists an
+00031900: 6420 6973 2061 2076 616c 6964 2066 696c  d is a valid fil
+00031910: 6527 290a 0a20 2020 2020 2020 2020 2020  e')..           
+00031920: 2020 2020 2070 7269 6e74 286d 7367 2e66       print(msg.f
+00031930: 6f72 6d61 7428 6972 6566 5f66 696c 652c  ormat(iref_file,
+00031940: 2066 7470 6469 722c 2063 696d 6729 290a   ftpdir, cimg)).
+00031950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031960: 6966 2072 656d 6f76 655f 636f 7272 7570  if remove_corrup
+00031970: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00031980: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
+00031990: 2869 7265 665f 6669 6c65 290a 0a20 2020  (iref_file)..   
+000319a0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000319b0: 7572 6e20 4661 6c73 650a 2020 2020 656c  urn False.    el
+000319c0: 7365 3a0a 2020 2020 2020 2020 6966 2076  se:.        if v
+000319d0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+000319e0: 2020 2020 7072 696e 7428 277b 307d 2065      print('{0} e
+000319f0: 7869 7374 7327 2e66 6f72 6d61 7428 6972  xists'.format(ir
+00031a00: 6566 5f66 696c 6529 290a 0a20 2020 2072  ef_file))..    r
+00031a10: 6574 7572 6e20 6972 6566 5f66 696c 650a  eturn iref_file.
+00031a20: 0a0a 6465 6620 6665 7463 685f 6873 745f  ..def fetch_hst_
+00031a30: 6361 6c69 6273 2866 6c74 5f66 696c 652c  calibs(flt_file,
+00031a40: 2066 7470 6469 723d 2768 7474 7073 3a2f   ftpdir='https:/
+00031a50: 2f68 7374 2d63 7264 732e 7374 7363 692e  /hst-crds.stsci.
+00031a60: 6564 752f 756e 6368 6563 6b65 645f 6765  edu/unchecked_ge
+00031a70: 742f 7265 6665 7265 6e63 6573 2f68 7374  t/references/hst
+00031a80: 2f27 2c20 6361 6c69 625f 7479 7065 733d  /', calib_types=
+00031a90: 5b27 4250 4958 5441 4227 2c20 2743 4344  ['BPIXTAB', 'CCD
+00031aa0: 5441 4227 2c20 274f 5343 4e54 4142 272c  TAB', 'OSCNTAB',
+00031ab0: 2027 4352 5245 4a54 4142 272c 2027 4441   'CRREJTAB', 'DA
+00031ac0: 524b 4649 4c45 272c 2027 4e4c 494e 4649  RKFILE', 'NLINFI
+00031ad0: 4c45 272c 2027 4446 4c54 4649 4c45 272c  LE', 'DFLTFILE',
+00031ae0: 2750 464c 5446 494c 4527 2c20 2749 4d50  'PFLTFILE', 'IMP
+00031af0: 4854 5441 4227 2c20 2749 4443 5441 4227  HTTAB', 'IDCTAB'
+00031b00: 2c20 274e 504f 4c46 494c 4527 5d2c 2076  , 'NPOLFILE'], v
+00031b10: 6572 626f 7365 3d54 7275 652c 2072 6566  erbose=True, ref
+00031b20: 5f70 6174 6873 3d7b 7d29 3a0a 2020 2020  _paths={}):.    
+00031b30: 2222 220a 2020 2020 5442 440a 2020 2020  """.    TBD.    
+00031b40: 4665 7463 6820 6e65 6365 7373 6172 7920  Fetch necessary 
+00031b50: 6361 6c69 6272 6174 696f 6e20 6669 6c65  calibration file
+00031b60: 7320 6e65 6564 6564 2066 6f72 2072 756e  s needed for run
+00031b70: 6e69 6e67 2063 616c 7766 3320 6672 6f6d  ning calwf3 from
+00031b80: 2053 5453 6349 2046 5450 0a0a 2020 2020   STScI FTP..    
+00031b90: 4f6c 6420 4654 5020 6469 723a 2066 7470  Old FTP dir: ftp
+00031ba0: 3a2f 2f66 7470 2e73 7473 6369 2e65 6475  ://ftp.stsci.edu
+00031bb0: 2f63 6462 732f 6972 6566 2f22 2222 0a20  /cdbs/iref/""". 
+00031bc0: 2020 2069 6d70 6f72 7420 6f73 0a0a 2020     import os..  
+00031bd0: 2020 696d 203d 2070 7966 6974 732e 6f70    im = pyfits.op
+00031be0: 656e 2866 6c74 5f66 696c 6529 0a20 2020  en(flt_file).   
+00031bf0: 2069 6620 696d 5b30 5d2e 6865 6164 6572   if im[0].header
+00031c00: 5b27 494e 5354 5255 4d45 275d 203d 3d20  ['INSTRUME'] == 
+00031c10: 2741 4353 273a 0a20 2020 2020 2020 2072  'ACS':.        r
+00031c20: 6566 5f64 6972 203d 2027 6a72 6566 270a  ef_dir = 'jref'.
+00031c30: 0a20 2020 2069 6620 696d 5b30 5d2e 6865  .    if im[0].he
+00031c40: 6164 6572 5b27 494e 5354 5255 4d45 275d  ader['INSTRUME']
+00031c50: 203d 3d20 2757 4643 3327 3a0a 2020 2020   == 'WFC3':.    
+00031c60: 2020 2020 7265 665f 6469 7220 3d20 2769      ref_dir = 'i
+00031c70: 7265 6627 0a0a 2020 2020 6966 2069 6d5b  ref'..    if im[
+00031c80: 305d 2e68 6561 6465 725b 2749 4e53 5452  0].header['INSTR
+00031c90: 554d 4527 5d20 3d3d 2027 5746 5043 3227  UME'] == 'WFPC2'
+00031ca0: 3a0a 2020 2020 2020 2020 7265 665f 6469  :.        ref_di
+00031cb0: 7220 3d20 2775 7265 6627 0a0a 2020 2020  r = 'uref'..    
+00031cc0: 6966 206e 6f74 206f 732e 6765 7465 6e76  if not os.getenv
+00031cd0: 2872 6566 5f64 6972 293a 0a20 2020 2020  (ref_dir):.     
+00031ce0: 2020 2070 7269 6e74 2827 4e6f 2024 7b30     print('No ${0
+00031cf0: 7d20 7365 7421 2020 5075 7420 6974 2069  } set!  Put it i
+00031d00: 6e20 7e2f 2e62 6173 6872 6320 6f72 207e  n ~/.bashrc or ~
+00031d10: 2f2e 6373 6872 632e 272e 666f 726d 6174  /.cshrc.'.format
+00031d20: 2872 6566 5f64 6972 2929 0a20 2020 2020  (ref_dir)).     
+00031d30: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00031d40: 0a20 2020 2063 616c 6962 5f70 6174 6873  .    calib_paths
+00031d50: 203d 205b 5d0a 0a20 2020 2066 6f72 2063   = []..    for c
+00031d60: 7479 7065 2069 6e20 6361 6c69 625f 7479  type in calib_ty
+00031d70: 7065 733a 0a20 2020 2020 2020 2069 6620  pes:.        if 
+00031d80: 6374 7970 6520 6e6f 7420 696e 2069 6d5b  ctype not in im[
+00031d90: 305d 2e68 6561 6465 723a 0a20 2020 2020  0].header:.     
+00031da0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00031db0: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
+00031dc0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00031dd0: 2070 7269 6e74 2827 4361 6c69 623a 207b   print('Calib: {
+00031de0: 307d 3d7b 317d 272e 666f 726d 6174 2863  0}={1}'.format(c
+00031df0: 7479 7065 2c20 696d 5b30 5d2e 6865 6164  type, im[0].head
+00031e00: 6572 5b63 7479 7065 5d29 290a 0a20 2020  er[ctype]))..   
+00031e10: 2020 2020 2069 6620 696d 5b30 5d2e 6865       if im[0].he
+00031e20: 6164 6572 5b63 7479 7065 5d20 3d3d 2027  ader[ctype] == '
+00031e30: 4e2f 4127 3a0a 2020 2020 2020 2020 2020  N/A':.          
+00031e40: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+00031e50: 2020 2020 7061 7468 203d 2066 6574 6368      path = fetch
+00031e60: 5f68 7374 5f63 616c 6962 2869 6d5b 305d  _hst_calib(im[0]
+00031e70: 2e68 6561 6465 725b 6374 7970 655d 2c20  .header[ctype], 
+00031e80: 6674 7064 6972 3d66 7470 6469 722c 0a20  ftpdir=ftpdir,. 
+00031e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ea0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00031eb0: 7262 6f73 653d 7665 7262 6f73 652c 2072  rbose=verbose, r
+00031ec0: 6566 5f70 6174 6873 3d72 6566 5f70 6174  ef_paths=ref_pat
+00031ed0: 6873 290a 2020 2020 2020 2020 6361 6c69  hs).        cali
+00031ee0: 625f 7061 7468 732e 6170 7065 6e64 2870  b_paths.append(p
+00031ef0: 6174 6829 0a20 2020 200a 2020 2020 696d  ath).    .    im
+00031f00: 2e63 6c6f 7365 2829 0a20 2020 200a 2020  .close().    .  
+00031f10: 2020 7265 7475 726e 2063 616c 6962 5f70    return calib_p
+00031f20: 6174 6873 0a0a 0a64 6566 206d 6173 745f  aths...def mast_
+00031f30: 7175 6572 795f 6672 6f6d 5f66 696c 655f  query_from_file_
+00031f40: 6c69 7374 2866 696c 6573 3d5b 5d2c 206f  list(files=[], o
+00031f50: 735f 6f70 656e 3d54 7275 6529 3a0a 2020  s_open=True):.  
+00031f60: 2020 2222 220a 2020 2020 4765 6e65 7261    """.    Genera
+00031f70: 7465 2061 204d 4153 5420 7175 6572 7920  te a MAST query 
+00031f80: 6f6e 2064 6174 6173 6574 7320 696e 2061  on datasets in a
+00031f90: 206c 6973 742e 0a20 2020 2022 2222 0a20   list..    """. 
+00031fa0: 2020 2069 6620 6c65 6e28 6669 6c65 7329     if len(files)
+00031fb0: 203d 3d20 303a 0a20 2020 2020 2020 2066   == 0:.        f
+00031fc0: 696c 6573 203d 2067 6c6f 622e 676c 6f62  iles = glob.glob
+00031fd0: 2827 2a72 6177 2e66 6974 7327 290a 0a20  ('*raw.fits').. 
+00031fe0: 2020 2069 6620 6c65 6e28 6669 6c65 7329     if len(files)
+00031ff0: 203d 3d20 303a 0a20 2020 2020 2020 2070   == 0:.        p
+00032000: 7269 6e74 2827 4e6f 2060 6669 6c65 7360  rint('No `files`
+00032010: 2073 7065 6369 6669 6564 2e27 290a 2020   specified.').  
+00032020: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00032030: 7365 0a0a 2020 2020 6461 7461 7365 7473  se..    datasets
+00032040: 203d 206e 702e 756e 6971 7565 285b 6669   = np.unique([fi
+00032050: 6c65 5b3a 365d 2b27 2a27 2066 6f72 2066  le[:6]+'*' for f
+00032060: 696c 6520 696e 2066 696c 6573 5d29 2e74  ile in files]).t
+00032070: 6f6c 6973 7428 290a 2020 2020 5552 4c20  olist().    URL 
+00032080: 3d20 2268 7474 703a 2f2f 6172 6368 6976  = "http://archiv
+00032090: 652e 7374 7363 692e 6564 752f 6873 742f  e.stsci.edu/hst/
+000320a0: 7365 6172 6368 2e70 6870 3f61 6374 696f  search.php?actio
+000320b0: 6e3d 5365 6172 6368 2622 0a20 2020 2055  n=Search&".    U
+000320c0: 524c 202b 3d20 2273 6369 5f64 6174 615f  RL += "sci_data_
+000320d0: 7365 745f 6e61 6d65 3d22 2b27 2c27 2e6a  set_name="+','.j
+000320e0: 6f69 6e28 6461 7461 7365 7473 290a 2020  oin(datasets).  
+000320f0: 2020 6966 206f 735f 6f70 656e 3a0a 2020    if os_open:.  
+00032100: 2020 2020 2020 6f73 2e73 7973 7465 6d28        os.system(
+00032110: 276f 7065 6e20 227b 307d 2227 2e66 6f72  'open "{0}"'.for
+00032120: 6d61 7428 5552 4c29 290a 0a20 2020 2072  mat(URL))..    r
+00032130: 6574 7572 6e20 5552 4c0a 0a0a 6465 6620  eturn URL...def 
+00032140: 6665 7463 685f 6465 6661 756c 745f 6361  fetch_default_ca
+00032150: 6c69 6273 2867 6574 5f61 6373 3d46 616c  libs(get_acs=Fal
+00032160: 7365 2c20 2a2a 6b77 6172 6773 293a 0a20  se, **kwargs):. 
+00032170: 2020 2022 2222 0a20 2020 2046 6574 6368     """.    Fetch
+00032180: 2061 2073 6574 206f 6620 6465 6661 756c   a set of defaul
+00032190: 7420 4853 5420 6361 6c69 6272 6174 696f  t HST calibratio
+000321a0: 6e20 6669 6c65 7320 0a20 2020 2022 2222  n files .    """
+000321b0: 0a20 2020 2070 6174 6873 203d 207b 7d0a  .    paths = {}.
+000321c0: 2020 2020 0a20 2020 2066 6f72 2072 6566      .    for ref
+000321d0: 5f64 6972 2069 6e20 5b27 6972 6566 272c  _dir in ['iref',
+000321e0: 2027 6a72 6566 275d 3a0a 2020 2020 2020   'jref']:.      
+000321f0: 2020 6861 735f 6469 7220 3d20 5472 7565    has_dir = True
+00032200: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00032210: 6f73 2e67 6574 656e 7628 7265 665f 6469  os.getenv(ref_di
+00032220: 7229 3a20 2020 200a 2020 2020 2020 2020  r):    .        
+00032230: 2020 2020 6861 735f 6469 7220 3d20 4661      has_dir = Fa
+00032240: 6c73 6520 2020 2020 2020 200a 2020 2020  lse        .    
+00032250: 2020 2020 2020 2020 2320 446f 2064 6972          # Do dir
+00032260: 6563 746f 7269 6573 2065 7869 7374 2069  ectories exist i
+00032270: 6e20 4752 495a 4c49 5f50 4154 483f 0a20  n GRIZLI_PATH?. 
+00032280: 2020 2020 2020 2020 2020 2069 6620 6f73             if os
+00032290: 2e70 6174 682e 6578 6973 7473 286f 732e  .path.exists(os.
+000322a0: 7061 7468 2e6a 6f69 6e28 4752 495a 4c49  path.join(GRIZLI
+000322b0: 5f50 4154 482c 2072 6566 5f64 6972 2929  _PATH, ref_dir))
+000322c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000322d0: 2020 6861 735f 6469 7220 3d20 5472 7565    has_dir = True
+000322e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000322f0: 2070 6174 6873 5b72 6566 5f64 6972 5d20   paths[ref_dir] 
+00032300: 3d20 6f73 2e70 6174 682e 6a6f 696e 2847  = os.path.join(G
+00032310: 5249 5a4c 495f 5041 5448 2c20 7265 665f  RIZLI_PATH, ref_
+00032320: 6469 7229 0a20 2020 2020 2020 2065 6c73  dir).        els
+00032330: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00032340: 6174 6873 5b72 6566 5f64 6972 5d20 3d20  aths[ref_dir] = 
+00032350: 6f73 2e67 6574 656e 7628 7265 665f 6469  os.getenv(ref_di
+00032360: 7229 0a20 2020 2020 2020 2020 2020 200a  r).            .
+00032370: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
+00032380: 6173 5f64 6972 3a0a 2020 2020 2020 2020  as_dir:.        
+00032390: 2020 2020 7072 696e 7428 2222 220a 4e6f      print(""".No
+000323a0: 2024 7b30 7d20 7365 7421 2020 4d61 6b65   ${0} set!  Make
+000323b0: 2061 2064 6972 6563 746f 7279 2061 6e64   a directory and
+000323c0: 2070 6f69 6e74 2074 6f20 6974 2069 6e20   point to it in 
+000323d0: 7e2f 2e62 6173 6872 6320 6f72 207e 2f2e  ~/.bashrc or ~/.
+000323e0: 6373 6872 632e 0a46 6f72 2065 7861 6d70  cshrc..For examp
+000323f0: 6c65 2c0a 0a20 2024 206d 6b64 6972 2024  le,..  $ mkdir $
+00032400: 4752 495a 4c49 2f7b 307d 0a20 2024 2065  GRIZLI/{0}.  $ e
+00032410: 7870 6f72 7420 7b30 7d3d 2224 7b47 5249  xport {0}="${GRI
+00032420: 5a4c 497d 2f7b 307d 2f22 2023 2070 7574  ZLI}/{0}/" # put
+00032430: 2074 6869 7320 696e 207e 2f2e 6261 7368   this in ~/.bash
+00032440: 7263 0a22 2222 2e66 6f72 6d61 7428 7265  rc.""".format(re
+00032450: 665f 6469 7229 290a 0a20 2020 2020 2020  f_dir))..       
+00032460: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+00032470: 650a 0a20 2020 2023 2057 4643 330a 2020  e..    # WFC3.  
+00032480: 2020 6669 6c65 7320 3d20 5b27 6972 6566    files = ['iref
+00032490: 2475 6337 3231 3133 6f69 5f70 666c 2e66  $uc72113oi_pfl.f
+000324a0: 6974 7327 2c20 2023 2046 3130 3557 2046  its',  # F105W F
+000324b0: 6c61 740a 2020 2020 2020 2020 2020 2020  lat.            
+000324c0: 2027 6972 6566 2475 6337 3231 3134 3369   'iref$uc721143i
+000324d0: 5f70 666c 2e66 6974 7327 2c20 2023 2046  _pfl.fits',  # F
+000324e0: 3134 3057 2066 6c61 740a 2020 2020 2020  140W flat.      
+000324f0: 2020 2020 2020 2027 6972 6566 2475 346d         'iref$u4m
+00032500: 3133 3335 6c69 5f70 666c 2e66 6974 7327  1335li_pfl.fits'
+00032510: 2c20 2023 2047 3130 3220 666c 6174 0a20  ,  # G102 flat. 
+00032520: 2020 2020 2020 2020 2020 2020 2769 7265              'ire
+00032530: 6624 7534 6d31 3333 356d 695f 7066 6c2e  f$u4m1335mi_pfl.
+00032540: 6669 7473 272c 2020 2320 4731 3431 2066  fits',  # G141 f
+00032550: 6c61 740a 2020 2020 2020 2020 2020 2020  lat.            
+00032560: 2027 6972 6566 2477 336d 3138 3532 3569   'iref$w3m18525i
+00032570: 5f69 6463 2e66 6974 7327 2c20 2023 2049  _idc.fits',  # I
+00032580: 4443 5441 4220 6469 7374 6f72 7469 6f6e  DCTAB distortion
+00032590: 2074 6162 6c65 7d0a 2020 2020 2020 2020   table}.        
+000325a0: 2020 2020 205d 0a20 2020 200a 2020 2020       ].    .    
+000325b0: 6966 2027 4143 5327 2069 6e20 6b77 6172  if 'ACS' in kwar
+000325c0: 6773 3a0a 2020 2020 2020 2020 6765 745f  gs:.        get_
+000325d0: 6163 7320 3d20 6b77 6172 6773 5b27 4143  acs = kwargs['AC
+000325e0: 5327 5d0a 2020 2020 2020 2020 0a20 2020  S'].        .   
+000325f0: 2069 6620 6765 745f 6163 733a 0a20 2020   if get_acs:.   
+00032600: 2020 2020 2066 696c 6573 2e65 7874 656e       files.exten
+00032610: 6428 5b27 6a72 6566 246e 3675 3132 3539  d(['jref$n6u1259
+00032620: 326a 5f70 666c 2e66 6974 7327 2c20 2023  2j_pfl.fits',  #
+00032630: 2046 3831 3420 466c 6174 0a20 2020 2020   F814 Flat.     
+00032640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032650: 2027 6a72 6566 246f 3834 3133 3530 6d6a   'jref$o841350mj
+00032660: 5f70 666c 2e66 6974 7327 2c20 2023 2047  _pfl.fits',  # G
+00032670: 3830 304c 2066 6c61 745d 290a 2020 2020  800L flat]).    
+00032680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032690: 2020 276a 7265 6624 7639 3731 3832 366a    'jref$v971826j
+000326a0: 6a5f 6e70 6c2e 6669 7473 275d 290a 0a20  j_npl.fits']).. 
+000326b0: 2020 2066 6f72 2066 696c 6520 696e 2066     for file in f
+000326c0: 696c 6573 3a0a 2020 2020 2020 2020 6665  iles:.        fe
+000326d0: 7463 685f 6873 745f 6361 6c69 6228 6669  tch_hst_calib(fi
+000326e0: 6c65 2c20 7265 665f 7061 7468 733d 7061  le, ref_paths=pa
+000326f0: 7468 7329 0a0a 2020 2020 6261 6470 6978  ths)..    badpix
+00032700: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+00032710: 7061 7468 735b 2769 7265 6627 5d2c 2027  paths['iref'], '
+00032720: 6261 6470 6978 5f73 7061 7273 3230 305f  badpix_spars200_
+00032730: 4e6f 7639 2e66 6974 7327 290a 2020 2020  Nov9.fits').    
+00032740: 7072 696e 7428 2745 7874 7261 2057 4643  print('Extra WFC
+00032750: 332f 4952 2062 6164 2070 6978 656c 733a  3/IR bad pixels:
+00032760: 207b 307d 272e 666f 726d 6174 2862 6164   {0}'.format(bad
+00032770: 7069 7829 290a 2020 2020 6966 206e 6f74  pix)).    if not
+00032780: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
+00032790: 6261 6470 6978 293a 0a20 2020 2020 2020  badpix):.       
+000327a0: 206f 732e 7379 7374 656d 2827 6375 726c   os.system('curl
+000327b0: 202d 6f20 7b30 7d2f 6261 6470 6978 5f73   -o {0}/badpix_s
+000327c0: 7061 7273 3230 305f 4e6f 7639 2e66 6974  pars200_Nov9.fit
+000327d0: 7320 6874 7470 733a 2f2f 7261 772e 6769  s https://raw.gi
+000327e0: 7468 7562 7573 6572 636f 6e74 656e 742e  thubusercontent.
+000327f0: 636f 6d2f 6762 7261 6d6d 6572 2f77 6663  com/gbrammer/wfc
+00032800: 332f 6d61 7374 6572 2f64 6174 612f 6261  3/master/data/ba
+00032810: 6470 6978 5f73 7061 7273 3230 305f 4e6f  dpix_spars200_No
+00032820: 7639 2e66 6974 7327 2e66 6f72 6d61 7428  v9.fits'.format(
+00032830: 7061 7468 735b 2769 7265 6627 5d29 290a  paths['iref'])).
+00032840: 0a20 2020 2023 2050 6978 656c 2061 7265  .    # Pixel are
+00032850: 6120 6d61 700a 2020 2020 7061 6d20 3d20  a map.    pam = 
+00032860: 6f73 2e70 6174 682e 6a6f 696e 2870 6174  os.path.join(pat
+00032870: 6873 5b27 6972 6566 275d 2c20 2769 725f  hs['iref'], 'ir_
+00032880: 7766 6333 5f6d 6170 2e66 6974 7327 290a  wfc3_map.fits').
+00032890: 2020 2020 7072 696e 7428 2750 6978 656c      print('Pixel
+000328a0: 2061 7265 6120 6d61 703a 207b 307d 272e   area map: {0}'.
+000328b0: 666f 726d 6174 2870 616d 2929 0a20 2020  format(pam)).   
+000328c0: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
+000328d0: 6578 6973 7473 2870 616d 293a 0a20 2020  exists(pam):.   
+000328e0: 2020 2020 206f 732e 7379 7374 656d 2827       os.system('
+000328f0: 6375 726c 202d 6f20 7b30 7d20 6874 7470  curl -o {0} http
+00032900: 733a 2f2f 7777 772e 7374 7363 692e 6564  s://www.stsci.ed
+00032910: 752f 6669 6c65 732f 6c69 7665 2f73 6974  u/files/live/sit
+00032920: 6573 2f77 7777 2f66 696c 6573 2f68 6f6d  es/www/files/hom
+00032930: 652f 6873 742f 696e 7374 7275 6d65 6e74  e/hst/instrument
+00032940: 6174 696f 6e2f 7766 6333 2f64 6174 612d  ation/wfc3/data-
+00032950: 616e 616c 7973 6973 2f70 6978 656c 2d61  analysis/pixel-a
+00032960: 7265 612d 6d61 7073 2f5f 646f 6375 6d65  rea-maps/_docume
+00032970: 6e74 732f 6972 5f77 6663 335f 6d61 702e  nts/ir_wfc3_map.
+00032980: 6669 7473 272e 666f 726d 6174 2870 616d  fits'.format(pam
+00032990: 2929 0a0a 0a64 6566 2066 6574 6368 5f77  ))...def fetch_w
+000329a0: 6670 6332 5f63 616c 6962 2866 696c 653d  fpc2_calib(file=
+000329b0: 2767 3671 3139 3132 6875 5f72 3466 2e66  'g6q1912hu_r4f.f
+000329c0: 6974 7327 2c20 7061 7468 3d6f 732e 6765  its', path=os.ge
+000329d0: 7465 6e76 2827 7572 6566 2729 2c20 7573  tenv('uref'), us
+000329e0: 655f 6d61 7374 3d46 616c 7365 2c20 7665  e_mast=False, ve
+000329f0: 7262 6f73 653d 5472 7565 2c20 6f76 6572  rbose=True, over
+00032a00: 7772 6974 653d 5472 7565 2c20 736b 6970  write=True, skip
+00032a10: 5f65 7869 7374 696e 673d 5472 7565 293a  _existing=True):
+00032a20: 0a20 2020 2022 2222 0a20 2020 2046 6574  .    """.    Fet
+00032a30: 6368 2073 7461 7469 6320 5746 5043 3220  ch static WFPC2 
+00032a40: 6361 6c69 6272 6174 696f 6e20 6669 6c65  calibration file
+00032a50: 2061 6e64 2072 756e 2060 7374 7363 692e   and run `stsci.
+00032a60: 746f 6f6c 732e 636f 6e76 6572 7477 6169  tools.convertwai
+00032a70: 7665 7265 6466 6974 7360 206f 6e20 6974  veredfits` on it
+00032a80: 2e0a 0a20 2020 2070 6174 6820 3a20 7374  ...    path : st
+00032a90: 720a 2020 2020 2020 2020 4f75 7470 7574  r.        Output
+00032aa0: 2070 6174 6820 6f66 2074 6865 2072 6566   path of the ref
+00032ab0: 6572 656e 6365 2066 696c 6520 2867 656e  erence file (gen
+00032ac0: 6572 616c 6c79 2073 686f 756c 6420 6265  erally should be
+00032ad0: 2069 6e20 2475 7265 6629 2e0a 0a20 2020   in $uref)...   
+00032ae0: 2075 7365 5f6d 6173 7420 3a20 626f 6f6c   use_mast : bool
+00032af0: 0a20 2020 2020 2020 2049 6620 5472 7565  .        If True
+00032b00: 2c20 7472 7920 746f 2066 6574 6368 2066  , try to fetch f
+00032b10: 726f 6d20 226d 6173 742e 7374 7363 692e  rom "mast.stsci.
+00032b20: 6564 752f 2f61 7069 2f76 302f 646f 776e  edu//api/v0/down
+00032b30: 6c6f 6164 2f66 696c 653f 7572 6922 2c0a  load/file?uri",.
+00032b40: 2020 2020 2020 2020 6f74 6865 7277 6973          otherwis
+00032b50: 652c 2066 6574 6368 2066 726f 6d20 6120  e, fetch from a 
+00032b60: 7374 6174 6963 2064 6972 6563 746f 7279  static directory
+00032b70: 0a20 2020 2020 2020 2022 7373 622e 7374  .        "ssb.st
+00032b80: 7363 692e 6564 752f 6364 6273 5f6f 7065  sci.edu/cdbs_ope
+00032b90: 6e2f 6364 6273 2f75 7265 665f 6c69 6e75  n/cdbs/uref_linu
+00032ba0: 782f 222e 0a0a 2020 2020 2222 220a 2020  x/"...    """.  
+00032bb0: 2020 6672 6f6d 2073 7473 6369 2e74 6f6f    from stsci.too
+00032bc0: 6c73 2069 6d70 6f72 7420 636f 6e76 6572  ls import conver
+00032bd0: 7477 6169 7665 7265 6466 6974 730a 0a20  twaiveredfits.. 
+00032be0: 2020 2074 7279 3a20 2023 2050 7974 686f     try:  # Pytho
+00032bf0: 6e20 332e 780a 2020 2020 2020 2020 696d  n 3.x.        im
+00032c00: 706f 7274 2068 7474 702e 636c 6965 6e74  port http.client
+00032c10: 2061 7320 6874 7470 6c69 620a 2020 2020   as httplib.    
+00032c20: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
+00032c30: 6f72 3a20 2023 2050 7974 686f 6e20 322e  or:  # Python 2.
+00032c40: 780a 2020 2020 2020 2020 696d 706f 7274  x.        import
+00032c50: 2068 7474 706c 6962 0a0a 2020 2020 6966   httplib..    if
+00032c60: 2066 696c 652e 656e 6473 7769 7468 2827   file.endswith('
+00032c70: 6827 293a 0a20 2020 2020 2020 2023 2046  h'):.        # F
+00032c80: 696c 6520 6c69 6b65 2022 6736 7131 3931  ile like "g6q191
+00032c90: 3268 752e 7234 6822 0a20 2020 2020 2020  2hu.r4h".       
+00032ca0: 2066 696c 6520 3d20 6669 6c65 5b3a 2d31   file = file[:-1
+00032cb0: 5d2e 7265 706c 6163 6528 272e 272c 2027  ].replace('.', '
+00032cc0: 5f27 292b 2766 2e66 6974 7327 0a0a 2020  _')+'f.fits'..  
+00032cd0: 2020 6f75 7450 6174 6820 3d20 6f73 2e70    outPath = os.p
+00032ce0: 6174 682e 6a6f 696e 2870 6174 682c 2066  ath.join(path, f
+00032cf0: 696c 6529 0a20 2020 2069 6620 6f73 2e70  ile).    if os.p
+00032d00: 6174 682e 6578 6973 7473 286f 7574 5061  ath.exists(outPa
+00032d10: 7468 2920 2620 736b 6970 5f65 7869 7374  th) & skip_exist
+00032d20: 696e 673a 0a20 2020 2020 2020 2070 7269  ing:.        pri
+00032d30: 6e74 2822 2320 6665 7463 685f 7766 7063  nt("# fetch_wfpc
+00032d40: 325f 6361 6c69 623a 207b 307d 2065 7869  2_calib: {0} exi
+00032d50: 7374 7322 2e66 6f72 6d61 7428 6f75 7450  sts".format(outP
+00032d60: 6174 6829 290a 2020 2020 2020 2020 7265  ath)).        re
+00032d70: 7475 726e 2054 7275 650a 0a20 2020 2069  turn True..    i
+00032d80: 6620 7573 655f 6d61 7374 3a0a 2020 2020  f use_mast:.    
+00032d90: 2020 2020 7365 7276 6572 203d 2027 6d61      server = 'ma
+00032da0: 7374 2e73 7473 6369 2e65 6475 270a 2020  st.stsci.edu'.  
+00032db0: 2020 2020 2020 7572 6920 3d20 276d 6173        uri = 'mas
+00032dc0: 743a 4853 542f 7072 6f64 7563 742f 272b  t:HST/product/'+
+00032dd0: 6669 6c65 0a20 2020 2020 2020 2072 6571  file.        req
+00032de0: 7565 7374 5f70 6174 6820 3d20 222f 6170  uest_path = "/ap
+00032df0: 692f 7630 2f64 6f77 6e6c 6f61 642f 6669  i/v0/download/fi
+00032e00: 6c65 3f75 7269 3d22 2b75 7269 0a20 2020  le?uri="+uri.   
+00032e10: 2065 6c73 653a 0a20 2020 2020 2020 2073   else:.        s
+00032e20: 6572 7665 7220 3d20 2773 7362 2e73 7473  erver = 'ssb.sts
+00032e30: 6369 2e65 6475 270a 2020 2020 2020 2020  ci.edu'.        
+00032e40: 7265 7175 6573 745f 7061 7468 203d 2027  request_path = '
+00032e50: 2f63 6462 735f 6f70 656e 2f63 6462 732f  /cdbs_open/cdbs/
+00032e60: 7572 6566 5f6c 696e 7578 2f27 2b66 696c  uref_linux/'+fil
+00032e70: 650a 0a20 2020 2069 6620 7665 7262 6f73  e..    if verbos
+00032e80: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
+00032e90: 2827 2320 6665 7463 685f 7766 7063 325f  ('# fetch_wfpc2_
+00032ea0: 6361 6c69 623a 2022 7b30 7d22 2074 6f20  calib: "{0}" to 
+00032eb0: 7b31 7d27 2e66 6f72 6d61 7428 7365 7276  {1}'.format(serv
+00032ec0: 6572 2b72 6571 7565 7374 5f70 6174 682c  er+request_path,
+00032ed0: 2070 6174 6829 290a 0a20 2020 2063 6f6e   path))..    con
+00032ee0: 6e20 3d20 6874 7470 6c69 622e 4854 5450  n = httplib.HTTP
+00032ef0: 5343 6f6e 6e65 6374 696f 6e28 7365 7276  SConnection(serv
+00032f00: 6572 290a 0a20 2020 2063 6f6e 6e2e 7265  er)..    conn.re
+00032f10: 7175 6573 7428 2247 4554 222c 2072 6571  quest("GET", req
+00032f20: 7565 7374 5f70 6174 6829 0a20 2020 2072  uest_path).    r
+00032f30: 6573 7020 3d20 636f 6e6e 2e67 6574 7265  esp = conn.getre
+00032f40: 7370 6f6e 7365 2829 0a20 2020 2066 696c  sponse().    fil
+00032f50: 6543 6f6e 7465 6e74 203d 2072 6573 702e  eContent = resp.
+00032f60: 7265 6164 2829 0a20 2020 2063 6f6e 6e2e  read().    conn.
+00032f70: 636c 6f73 6528 290a 0a20 2020 2023 2063  close()..    # c
+00032f80: 6865 636b 2066 6f72 2066 696c 650a 2020  heck for file.  
+00032f90: 2020 6966 206c 656e 2866 696c 6543 6f6e    if len(fileCon
+00032fa0: 7465 6e74 2920 3c20 3430 3936 3a0a 2020  tent) < 4096:.  
+00032fb0: 2020 2020 2020 7072 696e 7428 2745 5252        print('ERR
+00032fc0: 4f52 3a20 227b 307d 2220 6661 696c 6564  OR: "{0}" failed
+00032fd0: 2074 6f20 646f 776e 6c6f 6164 2e20 2054   to download.  T
+00032fe0: 7279 2060 7573 655f 6d61 7374 3d7b 317d  ry `use_mast={1}
+00032ff0: 602e 272e 666f 726d 6174 2873 6572 7665  `.'.format(serve
+00033000: 722b 7265 7175 6573 745f 7061 7468 2c20  r+request_path, 
+00033010: 2875 7365 5f6d 6173 7420 6973 2046 616c  (use_mast is Fal
+00033020: 7365 2929 290a 2020 2020 2020 2020 7374  se))).        st
+00033030: 6174 7573 203d 2046 616c 7365 0a20 2020  atus = False.   
+00033040: 2020 2020 2072 6169 7365 2046 696c 654e       raise FileN
+00033050: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
+00033060: 2065 6c73 653a 0a20 2020 2020 2020 2070   else:.        p
+00033070: 7269 6e74 2822 2320 6665 7463 685f 7766  rint("# fetch_wf
+00033080: 7063 325f 6361 6c69 623a 207b 307d 2028  pc2_calib: {0} (
+00033090: 434f 4d50 4c45 5445 2922 2e66 6f72 6d61  COMPLETE)".forma
+000330a0: 7428 6f75 7450 6174 6829 290a 2020 2020  t(outPath)).    
+000330b0: 2020 2020 7374 6174 7573 203d 2054 7275      status = Tru
+000330c0: 650a 0a20 2020 2023 2073 6176 6520 746f  e..    # save to
+000330d0: 2066 696c 650a 2020 2020 7769 7468 206f   file.    with o
+000330e0: 7065 6e28 6f75 7450 6174 682c 2027 7762  pen(outPath, 'wb
+000330f0: 2729 2061 7320 464c 453a 0a20 2020 2020  ') as FLE:.     
+00033100: 2020 2046 4c45 2e77 7269 7465 2866 696c     FLE.write(fil
+00033110: 6543 6f6e 7465 6e74 290a 0a20 2020 2069  eContent)..    i
+00033120: 6620 7374 6174 7573 3a0a 2020 2020 2020  f status:.      
+00033130: 2020 2320 436f 6e76 6572 7420 746f 2073    # Convert to s
+00033140: 7461 6e64 6172 6420 4649 5453 0a20 2020  tandard FITS.   
+00033150: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00033160: 2020 2020 2020 6864 7520 3d20 636f 6e76        hdu = conv
+00033170: 6572 7477 6169 7665 7265 6466 6974 732e  ertwaiveredfits.
+00033180: 636f 6e76 6572 7477 6169 7665 7265 6466  convertwaiveredf
+00033190: 6974 7328 6f75 7450 6174 6829 0a20 2020  its(outPath).   
+000331a0: 2020 2020 2020 2020 2077 6869 6c65 2027           while '
+000331b0: 4849 5354 4f52 5927 2069 6e20 6864 755b  HISTORY' in hdu[
+000331c0: 305d 2e68 6561 6465 723a 0a20 2020 2020  0].header:.     
+000331d0: 2020 2020 2020 2020 2020 2068 6475 5b30             hdu[0
+000331e0: 5d2e 6865 6164 6572 2e72 656d 6f76 6528  ].header.remove(
+000331f0: 2748 4953 544f 5259 2729 0a0a 2020 2020  'HISTORY')..    
+00033200: 2020 2020 2020 2020 6864 752e 7772 6974          hdu.writ
+00033210: 6574 6f28 6f75 7450 6174 682e 7265 706c  eto(outPath.repl
+00033220: 6163 6528 272e 6669 7473 272c 2027 5f63  ace('.fits', '_c
+00033230: 3068 2e66 6974 7327 292c 0a20 2020 2020  0h.fits'),.     
+00033240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033250: 2020 206f 7665 7277 7269 7465 3d6f 7665     overwrite=ove
+00033260: 7277 7269 7465 2c20 6f75 7470 7574 5f76  rwrite, output_v
+00033270: 6572 6966 793d 2766 6978 2729 0a20 2020  erify='fix').   
+00033280: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00033290: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000332a0: 5472 7565 0a0a 0a64 6566 2066 6574 6368  True...def fetch
+000332b0: 5f6e 6972 6361 6d5f 736b 7966 6c61 7473  _nircam_skyflats
+000332c0: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
+000332d0: 446f 776e 6c6f 6164 2073 6b79 666c 6174  Download skyflat
+000332e0: 2066 696c 6573 0a20 2020 2022 2222 0a20   files.    """. 
+000332f0: 2020 2063 6f6e 665f 7061 7468 203d 206f     conf_path = o
+00033300: 732e 7061 7468 2e6a 6f69 6e28 4752 495a  s.path.join(GRIZ
+00033310: 4c49 5f50 4154 482c 2027 434f 4e46 272c  LI_PATH, 'CONF',
+00033320: 2027 4e69 7263 616d 536b 7946 6c61 7427   'NircamSkyFlat'
+00033330: 290a 2020 2020 6f73 2e73 7973 7465 6d28  ).    os.system(
+00033340: 6627 6177 7320 7333 2073 796e 6320 7333  f'aws s3 sync s3
+00033350: 3a2f 2f67 7269 7a6c 692d 7632 2f4e 6972  ://grizli-v2/Nir
+00033360: 6361 6d53 6b79 666c 6174 732f 207b 636f  camSkyflats/ {co
+00033370: 6e66 5f70 6174 687d 202d 2d65 7863 6c75  nf_path} --exclu
+00033380: 6465 2022 2a22 202d 2d69 6e63 6c75 6465  de "*" --include
+00033390: 2022 6e72 632a 6669 7473 2227 290a 2020   "nrc*fits"').  
+000333a0: 2020 0a20 2020 205f 6669 6c65 7320 3d20    .    _files = 
+000333b0: 676c 6f62 2e67 6c6f 6228 636f 6e66 5f70  glob.glob(conf_p
+000333c0: 6174 682b 272f 2a66 6974 7327 290a 2020  ath+'/*fits').  
+000333d0: 2020 5f66 696c 6573 2e73 6f72 7428 290a    _files.sort().
+000333e0: 2020 2020 0a20 2020 2072 6574 7572 6e20      .    return 
+000333f0: 5f66 696c 6573 0a0a 0a64 6566 2066 6574  _files...def fet
+00033400: 6368 5f63 6f6e 6669 675f 6669 6c65 7328  ch_config_files(
+00033410: 6765 745f 6163 733d 4661 6c73 652c 2067  get_acs=False, g
+00033420: 6574 5f73 6b79 3d54 7275 652c 2067 6574  et_sky=True, get
+00033430: 5f73 7461 7273 3d54 7275 652c 2067 6574  _stars=True, get
+00033440: 5f65 7073 663d 5472 7565 2c20 6765 745f  _epsf=True, get_
+00033450: 6a77 7374 3d46 616c 7365 2c20 6765 745f  jwst=False, get_
+00033460: 7766 6333 3d54 7275 652c 202a 2a6b 7761  wfc3=True, **kwa
+00033470: 7267 7329 3a0a 2020 2020 2222 220a 2020  rgs):.    """.  
+00033480: 2020 436f 6e66 6967 2066 696c 6573 206e    Config files n
+00033490: 6565 6465 6420 666f 7220 4772 697a 6c69  eeded for Grizli
+000334a0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+000334b0: 2741 4353 2720 696e 206b 7761 7267 733a  'ACS' in kwargs:
+000334c0: 0a20 2020 2020 2020 2067 6574 5f61 6373  .        get_acs
+000334d0: 203d 206b 7761 7267 735b 2741 4353 275d   = kwargs['ACS']
+000334e0: 0a0a 2020 2020 6377 6420 3d20 6f73 2e67  ..    cwd = os.g
+000334f0: 6574 6377 6428 290a 0a20 2020 2070 7269  etcwd()..    pri
+00033500: 6e74 2827 436f 6e66 6967 2064 6972 6563  nt('Config direc
+00033510: 746f 7279 3a20 7b30 7d2f 434f 4e46 272e  tory: {0}/CONF'.
+00033520: 666f 726d 6174 2847 5249 5a4c 495f 5041  format(GRIZLI_PA
+00033530: 5448 2929 0a0a 2020 2020 6f73 2e63 6864  TH))..    os.chd
+00033540: 6972 286f 732e 7061 7468 2e6a 6f69 6e28  ir(os.path.join(
+00033550: 4752 495a 4c49 5f50 4154 482c 2027 434f  GRIZLI_PATH, 'CO
+00033560: 4e46 2729 290a 0a20 2020 2066 7470 6469  NF'))..    ftpdi
+00033570: 7220 3d20 2766 7470 3a2f 2f66 7470 2e73  r = 'ftp://ftp.s
+00033580: 7473 6369 2e65 6475 2f63 6462 732f 7766  tsci.edu/cdbs/wf
+00033590: 6333 5f61 7578 2f27 0a20 2020 2074 6172  c3_aux/'.    tar
+000335a0: 6669 6c65 7320 3d20 5b5d 0a0a 2020 2020  files = []..    
+000335b0: 2320 436f 6e66 6967 2066 696c 6573 0a20  # Config files. 
+000335c0: 2020 2023 2042 4153 4555 524c 203d 2027     # BASEURL = '
+000335d0: 6874 7470 733a 2f2f 7333 2e61 6d61 7a6f  https://s3.amazo
+000335e0: 6e61 7773 2e63 6f6d 2f67 7269 7a6c 692f  naws.com/grizli/
+000335f0: 434f 4e46 2f27 0a20 2020 2023 2042 4153  CONF/'.    # BAS
+00033600: 4555 524c 203d 2027 6874 7470 733a 2f2f  EURL = 'https://
+00033610: 6572 6461 2e6b 752e 646b 2f76 6772 6964  erda.ku.dk/vgrid
+00033620: 2f47 6162 7269 656c 2532 3042 7261 6d6d  /Gabriel%20Bramm
+00033630: 6572 2f43 4f4e 462f 270a 2020 2020 4241  er/CONF/'.    BA
+00033640: 5345 5552 4c20 3d20 2827 6874 7470 733a  SEURL = ('https:
+00033650: 2f2f 7261 772e 6769 7468 7562 7573 6572  //raw.githubuser
+00033660: 636f 6e74 656e 742e 636f 6d2f 6762 7261  content.com/gbra
+00033670: 6d6d 6572 2f27 202b 0a20 2020 2020 2020  mmer/' +.       
+00033680: 2020 2020 2020 2020 2767 7269 7a6c 692d          'grizli-
+00033690: 636f 6e66 6967 2f6d 6173 7465 7227 290a  config/master').
+000336a0: 0a20 2020 2069 6620 6765 745f 7766 6333  .    if get_wfc3
+000336b0: 3a0a 2020 2020 2020 2020 7461 7266 696c  :.        tarfil
+000336c0: 6573 203d 205b 277b 307d 2f57 4643 332e  es = ['{0}/WFC3.
+000336d0: 4952 2e47 3130 322e 6361 6c2e 5634 2e33  IR.G102.cal.V4.3
+000336e0: 322e 7461 722e 677a 272e 666f 726d 6174  2.tar.gz'.format
+000336f0: 2866 7470 6469 7229 2c0a 2020 2020 2020  (ftpdir),.      
+00033700: 2020 2020 2020 2020 2020 2020 2020 277b                '{
+00033710: 307d 2f57 4643 332e 4952 2e47 3134 312e  0}/WFC3.IR.G141.
+00033720: 6361 6c2e 5634 2e33 322e 7461 722e 677a  cal.V4.32.tar.gz
+00033730: 272e 666f 726d 6174 2866 7470 6469 7229  '.format(ftpdir)
+00033740: 5d0a 2020 2020 2020 2020 7461 7266 696c  ].        tarfil
+00033750: 6573 202b 3d20 5b66 277b 4241 5345 5552  es += [f'{BASEUR
+00033760: 4c7d 2f57 4643 332e 4952 2e47 3130 322e  L}/WFC3.IR.G102.
+00033770: 5744 2e56 342e 3332 2e74 6172 2e67 7a27  WD.V4.32.tar.gz'
+00033780: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00033790: 2020 2020 2020 2066 277b 4241 5345 5552         f'{BASEUR
+000337a0: 4c7d 2f57 4643 332e 4952 2e47 3134 312e  L}/WFC3.IR.G141.
+000337b0: 5744 2e56 342e 3332 2e74 6172 2e67 7a27  WD.V4.32.tar.gz'
+000337c0: 5d0a 0a20 2020 2069 6620 6765 745f 6a77  ]..    if get_jw
+000337d0: 7374 3a0a 2020 2020 2020 2020 7461 7266  st:.        tarf
+000337e0: 696c 6573 202b 3d20 5b66 277b 4241 5345  iles += [f'{BASE
+000337f0: 5552 4c7d 2f6a 7773 742d 6772 6973 6d2d  URL}/jwst-grism-
+00033800: 636f 6e66 2e74 6172 2e67 7a27 2c20 0a20  conf.tar.gz', . 
+00033810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033820: 2020 2020 6627 7b42 4153 4555 524c 7d2f      f'{BASEURL}/
+00033830: 6e69 7269 7373 2e63 6f6e 662e 3232 3037  niriss.conf.2207
+00033840: 3235 2e74 6172 2e67 7a27 2c0a 2020 2020  25.tar.gz',.    
+00033850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033860: 2066 277b 4241 5345 5552 4c7d 2f6e 6972   f'{BASEURL}/nir
+00033870: 6361 6d2d 7769 7370 2d61 7567 3230 3232  cam-wisp-aug2022
+00033880: 2e74 6172 2e67 7a27 5d0a 2020 2020 0a20  .tar.gz'].    . 
+00033890: 2020 2069 6620 6765 745f 736b 793a 0a20     if get_sky:. 
+000338a0: 2020 2020 2020 2066 7470 6469 7220 3d20         ftpdir = 
+000338b0: 4241 5345 5552 4c0a 2020 2020 2020 2020  BASEURL.        
+000338c0: 7461 7266 696c 6573 2e61 7070 656e 6428  tarfiles.append(
+000338d0: 277b 307d 2f67 7269 736d 5f6d 6173 7465  '{0}/grism_maste
+000338e0: 725f 736b 795f 7630 2e35 2e74 6172 2e67  r_sky_v0.5.tar.g
+000338f0: 7a27 2e66 6f72 6d61 7428 6674 7064 6972  z'.format(ftpdir
+00033900: 2929 0a0a 2020 2020 2367 5552 4c20 3d20  ))..    #gURL = 
+00033910: 2768 7474 703a 2f2f 7777 772e 7374 7363  'http://www.stsc
+00033920: 692e 6564 752f 7e62 7261 6d6d 6572 2f47  i.edu/~brammer/G
+00033930: 7269 7a6c 692f 4669 6c65 7327 0a20 2020  rizli/Files'.   
+00033940: 2023 6755 524c 203d 2027 6874 7470 733a   #gURL = 'https:
+00033950: 2f2f 7333 2e61 6d61 7a6f 6e61 7773 2e63  //s3.amazonaws.c
+00033960: 6f6d 2f67 7269 7a6c 692f 434f 4e46 270a  om/grizli/CONF'.
+00033970: 2020 2020 6755 524c 203d 2042 4153 4555      gURL = BASEU
+00033980: 524c 0a20 2020 200a 2020 2020 7461 7266  RL.    .    tarf
+00033990: 696c 6573 2e61 7070 656e 6428 277b 307d  iles.append('{0}
+000339a0: 2f57 4643 3349 525f 6578 7465 6e64 6564  /WFC3IR_extended
+000339b0: 5f50 5346 2e76 312e 7461 722e 677a 272e  _PSF.v1.tar.gz'.
+000339c0: 666f 726d 6174 2867 5552 4c29 290a 0a20  format(gURL)).. 
+000339d0: 2020 2069 6620 6765 745f 6163 733a 0a20     if get_acs:. 
+000339e0: 2020 2020 2020 2074 6172 6669 6c65 7320         tarfiles 
+000339f0: 2b3d 205b 6627 7b42 4153 4555 524c 7d2f  += [f'{BASEURL}/
+00033a00: 4143 532e 5746 432e 4348 4950 312e 5374  ACS.WFC.CHIP1.St
+00033a10: 6172 732e 636f 6e66 272c 200a 2020 2020  ars.conf', .    
+00033a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a30: 6627 7b42 4153 4555 524c 7d2f 4143 532e  f'{BASEURL}/ACS.
+00033a40: 5746 432e 4348 4950 322e 5374 6172 732e  WFC.CHIP2.Stars.
+00033a50: 636f 6e66 275d 0a20 2020 2020 2020 2074  conf'].        t
+00033a60: 6172 6669 6c65 732e 6170 7065 6e64 2827  arfiles.append('
+00033a70: 7b30 7d2f 4143 532e 5746 432e 736b 792e  {0}/ACS.WFC.sky.
+00033a80: 7461 722e 677a 272e 666f 726d 6174 2867  tar.gz'.format(g
+00033a90: 5552 4c29 290a 2020 2020 2020 2020 7461  URL)).        ta
+00033aa0: 7266 696c 6573 2e61 7070 656e 6428 277b  rfiles.append('{
+00033ab0: 307d 2f41 4353 5f43 4f4e 4649 472e 7461  0}/ACS_CONFIG.ta
+00033ac0: 722e 677a 272e 666f 726d 6174 2867 5552  r.gz'.format(gUR
+00033ad0: 4c29 290a 0a20 2020 2066 6f72 2075 726c  L))..    for url
+00033ae0: 2069 6e20 7461 7266 696c 6573 3a0a 2020   in tarfiles:.  
+00033af0: 2020 2020 2020 6669 6c65 203d 206f 732e        file = os.
+00033b00: 7061 7468 2e62 6173 656e 616d 6528 7572  path.basename(ur
+00033b10: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+00033b20: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+00033b30: 2866 696c 6529 3a0a 2020 2020 2020 2020  (file):.        
+00033b40: 2020 2020 7072 696e 7428 2747 6574 207b      print('Get {
+00033b50: 307d 272e 666f 726d 6174 2866 696c 6529  0}'.format(file)
+00033b60: 290a 2020 2020 2020 2020 2020 2020 6f73  ).            os
+00033b70: 2e73 7973 7465 6d28 2763 7572 6c20 2d6f  .system('curl -o
+00033b80: 207b 307d 207b 317d 272e 666f 726d 6174   {0} {1}'.format
+00033b90: 2866 696c 652c 2075 726c 2929 0a0a 2020  (file, url))..  
+00033ba0: 2020 2020 2020 6966 2027 2e74 6172 2720        if '.tar' 
+00033bb0: 696e 2066 696c 653a 0a20 2020 2020 2020  in file:.       
+00033bc0: 2020 2020 206f 732e 7379 7374 656d 2827       os.system('
+00033bd0: 7461 7220 787a 7666 207b 307d 272e 666f  tar xzvf {0}'.fo
+00033be0: 726d 6174 2866 696c 6529 290a 0a20 2020  rmat(file))..   
+00033bf0: 2069 6620 6765 745f 6570 7366 3a0a 2020   if get_epsf:.  
+00033c00: 2020 2020 2020 2320 6550 5346 2066 696c        # ePSF fil
+00033c10: 6573 2066 6f72 2066 6974 7469 6e67 2070  es for fitting p
+00033c20: 6f69 6e74 2073 6f75 7263 6573 0a20 2020  oint sources.   
+00033c30: 2020 2020 2023 7073 665f 7061 7468 203d       #psf_path =
+00033c40: 2027 6874 7470 3a2f 2f77 7777 2e73 7473   'http://www.sts
+00033c50: 6369 2e65 6475 2f68 7374 2f77 6663 332f  ci.edu/hst/wfc3/
+00033c60: 616e 616c 7973 6973 2f50 5346 2f70 7366  analysis/PSF/psf
+00033c70: 5f64 6f77 6e6c 6f61 6473 2f77 6663 335f  _downloads/wfc3_
+00033c80: 6972 2f27 0a20 2020 2020 2020 2023 7073  ir/'.        #ps
+00033c90: 665f 7061 7468 203d 2027 6874 7470 733a  f_path = 'https:
+00033ca0: 2f2f 7777 772e 7374 7363 692e 6564 752f  //www.stsci.edu/
+00033cb0: 7e6a 6179 616e 6465 722f 5354 4450 5346  ~jayander/STDPSF
+00033cc0: 732f 5746 4333 4952 2f27 0a20 2020 2020  s/WFC3IR/'.     
+00033cd0: 2020 2023 7073 665f 726f 6f74 203d 2027     #psf_root = '
+00033ce0: 5053 4653 5444 270a 2020 2020 2020 2020  PSFSTD'.        
+00033cf0: 2370 7366 5f70 6174 6820 3d20 2768 7474  #psf_path = 'htt
+00033d00: 7073 3a2f 2f77 7777 2e73 7473 6369 2e65  ps://www.stsci.e
+00033d10: 6475 2f7e 6a61 7961 6e64 6572 2f48 5354  du/~jayander/HST
+00033d20: 3150 4153 532f 270a 2020 2020 2020 2020  1PASS/'.        
+00033d30: 7073 665f 7061 7468 203d 2027 6874 7470  psf_path = 'http
+00033d40: 733a 2f2f 7777 772e 7374 7363 692e 6564  s://www.stsci.ed
+00033d50: 752f 7e6a 6179 616e 6465 722f 4853 5431  u/~jayander/HST1
+00033d60: 5041 5353 2f4c 4942 2f27 0a20 2020 2020  PASS/LIB/'.     
+00033d70: 2020 2070 7366 5f70 6174 6820 2b3d 2027     psf_path += '
+00033d80: 5053 4673 2f53 5444 5053 4673 2f57 4643  PSFs/STDPSFs/WFC
+00033d90: 3349 522f 270a 2020 2020 2020 2020 7073  3IR/'.        ps
+00033da0: 665f 726f 6f74 203d 2027 5354 4450 5346  f_root = 'STDPSF
+00033db0: 270a 2020 2020 2020 2020 0a20 2020 2020  '.        .     
+00033dc0: 2020 2069 725f 7073 665f 6669 6c74 6572     ir_psf_filter
+00033dd0: 7320 3d20 5b27 4631 3035 5727 2c20 2746  s = ['F105W', 'F
+00033de0: 3132 3557 272c 2027 4631 3430 5727 2c20  125W', 'F140W', 
+00033df0: 2746 3136 3057 275d 0a0a 2020 2020 2020  'F160W']..      
+00033e00: 2020 2320 4e65 7720 5053 4673 0a20 2020    # New PSFs.   
+00033e10: 2020 2020 2069 725f 7073 665f 6669 6c74       ir_psf_filt
+00033e20: 6572 7320 2b3d 205b 2746 3131 3057 272c  ers += ['F110W',
+00033e30: 2027 4631 3237 4d27 5d0a 0a20 2020 2020   'F127M']..     
+00033e40: 2020 2066 696c 6573 203d 205b 277b 307d     files = ['{0}
+00033e50: 2f7b 317d 5f57 4643 3349 525f 7b32 7d2e  /{1}_WFC3IR_{2}.
+00033e60: 6669 7473 272e 666f 726d 6174 2870 7366  fits'.format(psf
+00033e70: 5f70 6174 682c 2070 7366 5f72 6f6f 742c  _path, psf_root,
+00033e80: 2066 696c 7429 0a20 2020 2020 2020 2020   filt).         
+00033e90: 2020 2020 2020 2020 666f 7220 6669 6c74          for filt
+00033ea0: 2069 6e20 6972 5f70 7366 5f66 696c 7465   in ir_psf_filte
+00033eb0: 7273 5d0a 0a20 2020 2020 2020 2066 6f72  rs]..        for
+00033ec0: 2075 726c 2069 6e20 6669 6c65 733a 0a20   url in files:. 
+00033ed0: 2020 2020 2020 2020 2020 2066 696c 6520             file 
+00033ee0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+00033ef0: 6d65 2875 726c 292e 7265 706c 6163 6528  me(url).replace(
+00033f00: 2753 5444 5053 4627 2c20 2750 5346 5354  'STDPSF', 'PSFST
+00033f10: 4427 290a 2020 2020 2020 2020 2020 2020  D').            
+00033f20: 6966 206e 6f74 206f 732e 7061 7468 2e65  if not os.path.e
+00033f30: 7869 7374 7328 6669 6c65 293a 0a20 2020  xists(file):.   
+00033f40: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00033f50: 6e74 2827 4765 7420 7b30 7d27 2e66 6f72  nt('Get {0}'.for
+00033f60: 6d61 7428 6669 6c65 2929 0a20 2020 2020  mat(file)).     
+00033f70: 2020 2020 2020 2020 2020 206f 732e 7379             os.sy
+00033f80: 7374 656d 2827 6375 726c 202d 6f20 7b30  stem('curl -o {0
+00033f90: 7d20 7b31 7d27 2e66 6f72 6d61 7428 6669  } {1}'.format(fi
+00033fa0: 6c65 2c20 7572 6c29 290a 2020 2020 2020  le, url)).      
+00033fb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00033fc0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00033fd0: 7428 2746 696c 6520 7b30 7d20 6578 6973  t('File {0} exis
+00033fe0: 7473 272e 666f 726d 6174 2866 696c 6529  ts'.format(file)
+00033ff0: 290a 0a20 2020 2069 6620 6765 745f 7374  )..    if get_st
+00034000: 6172 733a 0a20 2020 2020 2020 2023 2053  ars:.        # S
+00034010: 7465 6c6c 6172 2074 656d 706c 6174 6573  tellar templates
+00034020: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
+00034030: 5465 6d70 6c61 7465 7320 6469 7265 6374  Templates direct
+00034040: 6f72 793a 207b 307d 2f74 656d 706c 6174  ory: {0}/templat
+00034050: 6573 272e 666f 726d 6174 2847 5249 5a4c  es'.format(GRIZL
+00034060: 495f 5041 5448 2929 0a20 2020 2020 2020  I_PATH)).       
+00034070: 206f 732e 6368 6469 7228 277b 307d 2f74   os.chdir('{0}/t
+00034080: 656d 706c 6174 6573 272e 666f 726d 6174  emplates'.format
+00034090: 2847 5249 5a4c 495f 5041 5448 2929 0a0a  (GRIZLI_PATH))..
+000340a0: 2020 2020 2020 2020 7572 6c20 3d20 2768          url = 'h
+000340b0: 7474 7073 3a2f 2f77 7777 2e73 7473 6369  ttps://www.stsci
+000340c0: 2e65 6475 2f7e 6272 616d 6d65 722f 4772  .edu/~brammer/Gr
+000340d0: 697a 6c69 2f46 696c 6573 2f27 0a20 2020  izli/Files/'.   
+000340e0: 2020 2020 2066 696c 6573 203d 205b 7572       files = [ur
+000340f0: 6c2b 2773 7461 7273 5f70 6963 6b6c 6573  l+'stars_pickles
+00034100: 2e6e 7079 272c 2075 726c 2b27 7374 6172  .npy', url+'star
+00034110: 735f 6270 6773 2e6e 7079 275d 0a0a 2020  s_bpgs.npy']..  
+00034120: 2020 2020 2020 666f 7220 7572 6c20 696e        for url in
+00034130: 2066 696c 6573 3a0a 2020 2020 2020 2020   files:.        
+00034140: 2020 2020 6669 6c65 203d 206f 732e 7061      file = os.pa
+00034150: 7468 2e62 6173 656e 616d 6528 7572 6c29  th.basename(url)
+00034160: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00034170: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
+00034180: 7473 2866 696c 6529 3a0a 2020 2020 2020  ts(file):.      
+00034190: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000341a0: 2747 6574 207b 307d 272e 666f 726d 6174  'Get {0}'.format
+000341b0: 2866 696c 6529 290a 2020 2020 2020 2020  (file)).        
+000341c0: 2020 2020 2020 2020 6f73 2e73 7973 7465          os.syste
+000341d0: 6d28 2763 7572 6c20 2d6f 207b 307d 207b  m('curl -o {0} {
+000341e0: 317d 272e 666f 726d 6174 2866 696c 652c  1}'.format(file,
+000341f0: 2075 726c 2929 0a20 2020 2020 2020 2020   url)).         
+00034200: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00034210: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00034220: 4669 6c65 207b 307d 2065 7869 7374 7327  File {0} exists'
+00034230: 2e66 6f72 6d61 7428 6669 6c65 2929 0a0a  .format(file))..
+00034240: 2020 2020 2020 2020 7072 696e 7428 276c          print('l
+00034250: 6e20 2d73 2073 7461 7273 5f70 6963 6b6c  n -s stars_pickl
+00034260: 6573 2e6e 7079 2073 7461 7273 2e6e 7079  es.npy stars.npy
+00034270: 2729 0a20 2020 2020 2020 206f 732e 7379  ').        os.sy
+00034280: 7374 656d 2827 6c6e 202d 7320 7374 6172  stem('ln -s star
+00034290: 735f 7069 636b 6c65 732e 6e70 7920 7374  s_pickles.npy st
+000342a0: 6172 732e 6e70 7927 290a 0a20 2020 206f  ars.npy')..    o
+000342b0: 732e 6368 6469 7228 6377 6429 0a0a 0a63  s.chdir(cwd)...c
+000342c0: 6c61 7373 204d 575f 4639 3928 6f62 6a65  lass MW_F99(obje
+000342d0: 6374 293a 0a20 2020 2022 2222 0a20 2020  ct):.    """.   
+000342e0: 2057 7261 7070 6572 2061 726f 756e 6420   Wrapper around 
+000342f0: 7468 6520 6073 7065 6375 7469 6c73 2e65  the `specutils.e
+00034300: 7874 696e 6374 696f 6e60 202f 2060 6578  xtinction` / `ex
+00034310: 7469 6e63 7469 6f6e 6020 6d6f 6475 6c65  tinction` module
+00034320: 732c 2077 6869 6368 2061 7265 2063 616c  s, which are cal
+00034330: 6c65 6420 6469 6666 6572 656e 746c 790a  led differently.
+00034340: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+00034350: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00034360: 615f 762c 2072 5f76 3d33 2e31 293a 0a20  a_v, r_v=3.1):. 
+00034370: 2020 2020 2020 2073 656c 662e 615f 7620         self.a_v 
+00034380: 3d20 615f 760a 2020 2020 2020 2020 7365  = a_v.        se
+00034390: 6c66 2e72 5f76 203d 2072 5f76 0a0a 2020  lf.r_v = r_v..  
+000343a0: 2020 2020 2020 7365 6c66 2e49 535f 5350        self.IS_SP
+000343b0: 4543 5554 494c 5320 3d20 4661 6c73 650a  ECUTILS = False.
+000343c0: 2020 2020 2020 2020 7365 6c66 2e49 535f          self.IS_
+000343d0: 4558 5449 4e43 5449 4f4e 203d 2046 616c  EXTINCTION = Fal
+000343e0: 7365 0a0a 2020 2020 2020 2020 7472 793a  se..        try:
+000343f0: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+00034400: 6d20 7370 6563 7574 696c 732e 6578 7469  m specutils.exti
+00034410: 6e63 7469 6f6e 2069 6d70 6f72 7420 4578  nction import Ex
+00034420: 7469 6e63 7469 6f6e 4639 390a 2020 2020  tinctionF99.    
+00034430: 2020 2020 2020 2020 7365 6c66 2e49 535f          self.IS_
+00034440: 5350 4543 5554 494c 5320 3d20 5472 7565  SPECUTILS = True
+00034450: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00034460: 662e 4639 3920 3d20 4578 7469 6e63 7469  f.F99 = Extincti
+00034470: 6f6e 4639 3928 7365 6c66 2e61 5f76 2c20  onF99(self.a_v, 
+00034480: 725f 763d 7365 6c66 2e72 5f76 290a 2020  r_v=self.r_v).  
+00034490: 2020 2020 2020 6578 6365 7074 2849 6d70        except(Imp
+000344a0: 6f72 7445 7272 6f72 293a 0a20 2020 2020  ortError):.     
+000344b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000344c0: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+000344d0: 2065 7874 696e 6374 696f 6e20 696d 706f   extinction impo
+000344e0: 7274 2046 6974 7a70 6174 7269 636b 3939  rt Fitzpatrick99
+000344f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034500: 2073 656c 662e 4953 5f45 5854 494e 4354   self.IS_EXTINCT
+00034510: 494f 4e20 3d20 5472 7565 0a20 2020 2020  ION = True.     
+00034520: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00034530: 4639 3920 3d20 4669 747a 7061 7472 6963  F99 = Fitzpatric
+00034540: 6b39 3928 725f 763d 7365 6c66 2e72 5f76  k99(r_v=self.r_v
+00034550: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
+00034560: 7863 6570 7428 496d 706f 7274 4572 726f  xcept(ImportErro
+00034570: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00034580: 2020 2020 7072 696e 7428 2222 220a 436f      print(""".Co
+00034590: 756c 646e 5c27 7420 6669 6e64 2065 7874  uldn\'t find ext
+000345a0: 696e 6374 696f 6e20 6d6f 6475 6c65 7320  inction modules 
+000345b0: 696e 0a60 7370 6563 7574 696c 732e 6578  in.`specutils.ex
+000345c0: 7469 6e63 7469 6f6e 6020 6f72 0a60 6578  tinction` or.`ex
+000345d0: 7469 6e63 7469 6f6e 2e46 6974 7a70 6174  tinction.Fitzpat
+000345e0: 7269 636b 3939 602e 0a0a 4d57 2065 7874  rick99`...MW ext
+000345f0: 696e 6374 696f 6e20 6e6f 7420 696d 706c  inction not impl
+00034600: 656d 656e 7465 642e 0a22 2222 290a 0a20  emented..""").. 
+00034610: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
+00034620: 7573 203d 2073 656c 662e 4953 5f53 5045  us = self.IS_SPE
+00034630: 4355 5449 4c53 207c 2073 656c 662e 4953  CUTILS | self.IS
+00034640: 5f45 5854 494e 4354 494f 4e0a 0a20 2020  _EXTINCTION..   
+00034650: 2064 6566 205f 5f63 616c 6c5f 5f28 7365   def __call__(se
+00034660: 6c66 2c20 7761 7665 5f69 6e70 7574 293a  lf, wave_input):
+00034670: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+00034680: 6173 7472 6f70 792e 756e 6974 7320 6173  astropy.units as
+00034690: 2075 0a0a 2020 2020 2020 2020 6966 2069   u..        if i
+000346a0: 7369 6e73 7461 6e63 6528 7761 7665 5f69  sinstance(wave_i
+000346b0: 6e70 7574 2c20 6c69 7374 293a 0a20 2020  nput, list):.   
+000346c0: 2020 2020 2020 2020 2077 6176 6520 3d20           wave = 
+000346d0: 6e70 2e61 7272 6179 2877 6176 655f 696e  np.array(wave_in
+000346e0: 7075 7429 0a20 2020 2020 2020 2065 6c73  put).        els
+000346f0: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00034700: 6176 6520 3d20 7761 7665 5f69 6e70 7574  ave = wave_input
+00034710: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00034720: 662e 7374 6174 7573 2069 7320 4661 6c73  f.status is Fals
+00034730: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00034740: 6574 7572 6e20 6e70 2e7a 6572 6f73 5f6c  eturn np.zeros_l
+00034750: 696b 6528 7761 7665 290a 0a20 2020 2020  ike(wave)..     
+00034760: 2020 2069 6620 7365 6c66 2e49 535f 5350     if self.IS_SP
+00034770: 4543 5554 494c 533a 0a20 2020 2020 2020  ECUTILS:.       
+00034780: 2020 2020 2069 6620 6861 7361 7474 7228       if hasattr(
+00034790: 7761 7665 2c20 2775 6e69 7427 293a 0a20  wave, 'unit'):. 
+000347a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000347b0: 6176 655f 6161 203d 2077 6176 650a 2020  ave_aa = wave.  
+000347c0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000347d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000347e0: 7761 7665 5f61 6120 3d20 7761 7665 2a75  wave_aa = wave*u
+000347f0: 2e41 410a 0a20 2020 2020 2020 2020 2020  .AA..           
+00034800: 2072 6574 7572 6e20 7365 6c66 2e46 3939   return self.F99
+00034810: 2877 6176 655f 6161 290a 0a20 2020 2020  (wave_aa)..     
+00034820: 2020 2069 6620 7365 6c66 2e49 535f 4558     if self.IS_EX
+00034830: 5449 4e43 5449 4f4e 3a0a 2020 2020 2020  TINCTION:.      
+00034840: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
+00034850: 2877 6176 652c 2027 756e 6974 2729 3a0a  (wave, 'unit'):.
+00034860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034870: 7761 7665 5f61 6120 3d20 7761 7665 2e74  wave_aa = wave.t
+00034880: 6f28 752e 4141 290a 2020 2020 2020 2020  o(u.AA).        
+00034890: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000348a0: 2020 2020 2020 2020 2020 7761 7665 5f61            wave_a
+000348b0: 6120 3d20 7761 7665 0a0a 2020 2020 2020  a = wave..      
+000348c0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000348d0: 662e 4639 3928 7761 7665 5f61 612c 2073  f.F99(wave_aa, s
+000348e0: 656c 662e 615f 762c 2075 6e69 743d 2761  elf.a_v, unit='a
+000348f0: 6127 290a 0a0a 636c 6173 7320 4566 6665  a')...class Effe
+00034900: 6374 6976 6550 5346 3a0a 2020 2020 6465  ctivePSF:.    de
+00034910: 6620 5f5f 696e 6974 5f5f 2873 656c 6629  f __init__(self)
+00034920: 3a0a 2020 2020 2020 2020 2222 2254 6f6f  :.        """Too
+00034930: 6c73 2066 6f72 2068 616e 646c 696e 6720  ls for handling 
+00034940: 5746 4333 2f49 5220 4566 6665 6374 6976  WFC3/IR Effectiv
+00034950: 6520 5053 460a 0a20 2020 2020 2020 2053  e PSF..        S
+00034960: 6565 2064 6f63 756d 656e 7461 7469 6f6e  ee documentation
+00034970: 2061 7420 6874 7470 3a2f 2f77 7777 2e73   at http://www.s
+00034980: 7473 6369 2e65 6475 2f68 7374 2f77 6663  tsci.edu/hst/wfc
+00034990: 332f 616e 616c 7973 6973 2f50 5346 2e0a  3/analysis/PSF..
+000349a0: 0a20 2020 2020 2020 2050 5346 2066 696c  .        PSF fil
+000349b0: 6573 2073 746f 7265 6420 696e 2024 4752  es stored in $GR
+000349c0: 495a 4c49 2f43 4f4e 462f 0a20 2020 2020  IZLI/CONF/.     
+000349d0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+000349e0: 7365 6c66 2e6c 6f61 645f 5053 465f 6461  self.load_PSF_da
+000349f0: 7461 2829 0a0a 2020 2020 6465 6620 6c6f  ta()..    def lo
+00034a00: 6164 5f50 5346 5f64 6174 6128 7365 6c66  ad_PSF_data(self
+00034a10: 293a 0a20 2020 2020 2020 2022 2222 4c6f  ):.        """Lo
+00034a20: 6164 2064 6174 6120 6672 6f6d 2050 5346  ad data from PSF
+00034a30: 5354 4420 6669 6c65 730a 0a20 2020 2020  STD files..     
+00034a40: 2020 2046 696c 6573 2073 686f 756c 6420     Files should 
+00034a50: 6265 206c 6f63 6174 6564 2069 6e20 247b  be located in ${
+00034a60: 4752 495a 4c49 7d2f 434f 4e46 2f20 6469  GRIZLI}/CONF/ di
+00034a70: 7265 6374 6f72 792e 0a20 2020 2020 2020  rectory..       
+00034a80: 2022 2222 0a20 2020 2020 2020 2073 656c   """.        sel
+00034a90: 662e 6570 7366 203d 204f 7264 6572 6564  f.epsf = Ordered
+00034aa0: 4469 6374 2829 0a0a 2020 2020 2020 2020  Dict()..        
+00034ab0: 666f 7220 6669 6c74 6572 2069 6e20 5b27  for filter in ['
+00034ac0: 4631 3035 5727 2c20 2746 3131 3057 272c  F105W', 'F110W',
+00034ad0: 2027 4631 3235 5727 2c20 2746 3134 3057   'F125W', 'F140W
+00034ae0: 272c 2027 4631 3630 5727 2c20 2746 3132  ', 'F160W', 'F12
+00034af0: 374d 275d 3a0a 2020 2020 2020 2020 2020  7M']:.          
+00034b00: 2020 6669 6c65 203d 206f 732e 7061 7468    file = os.path
+00034b10: 2e6a 6f69 6e28 4752 495a 4c49 5f50 4154  .join(GRIZLI_PAT
+00034b20: 482c 2027 434f 4e46 272c 0a20 2020 2020  H, 'CONF',.     
+00034b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034b40: 2020 2020 2020 2020 2020 2027 5053 4653             'PSFS
+00034b50: 5444 5f57 4643 3349 525f 7b30 7d2e 6669  TD_WFC3IR_{0}.fi
+00034b60: 7473 272e 666f 726d 6174 2866 696c 7465  ts'.format(filte
+00034b70: 7229 290a 0a20 2020 2020 2020 2020 2020  r))..           
+00034b80: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
+00034b90: 6578 6973 7473 2866 696c 6529 3a0a 2020  exists(file):.  
+00034ba0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00034bb0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+00034bc0: 2020 2020 7769 7468 2070 7966 6974 732e      with pyfits.
+00034bd0: 6f70 656e 2866 696c 6529 2061 7320 5f69  open(file) as _i
+00034be0: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
+00034bf0: 2020 2064 6174 6120 3d20 5f69 6d5b 305d     data = _im[0]
+00034c00: 2e64 6174 612e 542a 310a 2020 2020 2020  .data.T*1.      
+00034c10: 2020 2020 2020 2020 2020 6461 7461 5b64            data[d
+00034c20: 6174 6120 3c20 305d 203d 2030 0a0a 2020  ata < 0] = 0..  
+00034c30: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00034c40: 7073 665b 6669 6c74 6572 5d20 3d20 6461  psf[filter] = da
+00034c50: 7461 0a20 2020 2020 2020 200a 2020 2020  ta.        .    
+00034c60: 2020 2020 2320 5556 4953 0a20 2020 2020      # UVIS.     
+00034c70: 2020 2066 696c 7465 725f 6669 6c65 7320     filter_files 
+00034c80: 3d20 676c 6f62 2e67 6c6f 6228 6f73 2e70  = glob.glob(os.p
+00034c90: 6174 682e 6a6f 696e 2847 5249 5a4c 495f  ath.join(GRIZLI_
+00034ca0: 5041 5448 2c20 2743 4f4e 4627 2c0a 2020  PATH, 'CONF',.  
+00034cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034cc0: 2020 2020 2020 2020 2020 2750 5346 5354            'PSFST
+00034cd0: 445f 5746 4333 5556 2a2e 6669 7473 2729  D_WFC3UV*.fits')
+00034ce0: 290a 2020 2020 2020 2020 6669 6c74 6572  ).        filter
+00034cf0: 5f66 696c 6573 2e73 6f72 7428 290a 2020  _files.sort().  
+00034d00: 2020 2020 2020 666f 7220 6669 6c65 2069        for file i
+00034d10: 6e20 6669 6c74 6572 5f66 696c 6573 3a0a  n filter_files:.
+00034d20: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00034d30: 2070 7966 6974 732e 6f70 656e 2866 696c   pyfits.open(fil
+00034d40: 652c 2069 676e 6f72 655f 6d69 7373 696e  e, ignore_missin
+00034d50: 675f 656e 643d 5472 7565 2920 6173 205f  g_end=True) as _
+00034d60: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
+00034d70: 2020 2020 6461 7461 203d 205f 696d 5b30      data = _im[0
+00034d80: 5d2e 6461 7461 2e54 2a31 0a20 2020 2020  ].data.T*1.     
+00034d90: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00034da0: 6461 7461 203c 2030 5d20 3d20 300a 2020  data < 0] = 0.  
+00034db0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00034dc0: 2020 2020 2020 2020 2020 2066 696c 7420             filt 
+00034dd0: 3d20 275f 272e 6a6f 696e 2866 696c 652e  = '_'.join(file.
+00034de0: 7374 7269 7028 272e 6669 7473 2729 2e73  strip('.fits').s
+00034df0: 706c 6974 2827 5f27 295b 323a 5d29 0a20  plit('_')[2:]). 
+00034e00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00034e10: 6570 7366 5b66 696c 742b 2755 275d 203d  epsf[filt+'U'] =
+00034e20: 2064 6174 610a 0a20 2020 2020 2020 2023   data..        #
+00034e30: 2041 4353 0a20 2020 2020 2020 2066 696c   ACS.        fil
+00034e40: 7465 725f 6669 6c65 7320 3d20 676c 6f62  ter_files = glob
+00034e50: 2e67 6c6f 6228 6f73 2e70 6174 682e 6a6f  .glob(os.path.jo
+00034e60: 696e 2847 5249 5a4c 495f 5041 5448 2c20  in(GRIZLI_PATH, 
+00034e70: 2743 4f4e 4627 2c0a 2020 2020 2020 2020  'CONF',.        
 00034e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034e90: 2020 2027 6e69 7269 7373 2a2e 6669 7473     'niriss*.fits
-00034ea0: 2729 290a 2020 2020 2020 2020 6669 6c74  ')).        filt
-00034eb0: 6572 5f66 696c 6573 202b 3d20 676c 6f62  er_files += glob
-00034ec0: 2e67 6c6f 6228 6f73 2e70 6174 682e 6a6f  .glob(os.path.jo
-00034ed0: 696e 2847 5249 5a4c 495f 5041 5448 2c20  in(GRIZLI_PATH, 
-00034ee0: 2743 4f4e 462f 4a57 5354 6550 5346 272c  'CONF/JWSTePSF',
-00034ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034f00: 2020 2020 2020 2020 2020 2020 2027 6d69               'mi
-00034f10: 7269 2a2e 6669 7473 2729 290a 2020 2020  ri*.fits')).    
-00034f20: 2020 2020 6669 6c74 6572 5f66 696c 6573      filter_files
-00034f30: 2e73 6f72 7428 290a 2020 2020 2020 2020  .sort().        
-00034f40: 666f 7220 6669 6c65 2069 6e20 6669 6c74  for file in filt
-00034f50: 6572 5f66 696c 6573 3a0a 2020 2020 2020  er_files:.      
-00034f60: 2020 2020 2020 7769 7468 2070 7966 6974        with pyfit
-00034f70: 732e 6f70 656e 2866 696c 652c 2069 676e  s.open(file, ign
-00034f80: 6f72 655f 6d69 7373 696e 675f 656e 643d  ore_missing_end=
-00034f90: 5472 7565 2920 6173 205f 696d 3a0a 2020  True) as _im:.  
-00034fa0: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00034fb0: 7461 203d 205f 696d 5b30 5d2e 6461 7461  ta = _im[0].data
-00034fc0: 2a31 2023 205b 3a3a 2d31 2c3a 2c3a 5d23  *1 # [::-1,:,:]#
-00034fd0: 5b3a 2c3a 3a2d 312c 3a5d 0a20 2020 2020  [:,::-1,:].     
-00034fe0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00034ff0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00035000: 5b64 6174 6120 3c20 305d 203d 2030 0a20  [data < 0] = 0. 
-00035010: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00035020: 6579 203d 2027 7b30 7d2d 7b31 7d27 2e66  ey = '{0}-{1}'.f
-00035030: 6f72 6d61 7428 5f69 6d5b 305d 2e68 6561  ormat(_im[0].hea
-00035040: 6465 725b 2744 4554 4543 544f 5227 5d2e  der['DETECTOR'].
-00035050: 7570 7065 7228 292c 0a20 2020 2020 2020  upper(),.       
-00035060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035080: 5f69 6d5b 305d 2e68 6561 6465 725b 2746  _im[0].header['F
-00035090: 494c 5445 5227 5d29 0a20 2020 2020 2020  ILTER']).       
-000350a0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-000350b0: 2020 2020 2020 6966 2027 4c41 4245 4c27        if 'LABEL'
-000350c0: 2069 6e20 5f69 6d5b 305d 2e68 6561 6465   in _im[0].heade
-000350d0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-000350e0: 2020 2020 2020 206b 6579 202b 3d20 272d         key += '-
-000350f0: 2720 2b20 5f69 6d5b 305d 2e68 6561 6465  ' + _im[0].heade
-00035100: 725b 274c 4142 454c 275d 0a20 2020 2020  r['LABEL'].     
-00035110: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00035120: 2020 2020 2020 2020 7365 6c66 2e65 7073          self.eps
-00035130: 665b 6b65 795d 203d 2064 6174 610a 2020  f[key] = data.  
-00035140: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
-00035150: 2044 756d 6d79 2c20 7573 6520 4631 3035   Dummy, use F105
-00035160: 5720 6550 5346 2066 6f72 2046 3039 384d  W ePSF for F098M
-00035170: 2061 6e64 2046 3131 3057 0a20 2020 2020   and F110W.     
-00035180: 2020 2073 656c 662e 6570 7366 5b27 4630     self.epsf['F0
-00035190: 3938 4d27 5d20 3d20 7365 6c66 2e65 7073  98M'] = self.eps
-000351a0: 665b 2746 3130 3557 275d 0a20 2020 2020  f['F105W'].     
-000351b0: 2020 2073 656c 662e 6570 7366 5b27 4631     self.epsf['F1
-000351c0: 3238 4e27 5d20 3d20 7365 6c66 2e65 7073  28N'] = self.eps
-000351d0: 665b 2746 3132 3557 275d 0a20 2020 2020  f['F125W'].     
-000351e0: 2020 2073 656c 662e 6570 7366 5b27 4631     self.epsf['F1
-000351f0: 3330 4e27 5d20 3d20 7365 6c66 2e65 7073  30N'] = self.eps
-00035200: 665b 2746 3132 3557 275d 0a20 2020 2020  f['F125W'].     
-00035210: 2020 2073 656c 662e 6570 7366 5b27 4631     self.epsf['F1
-00035220: 3332 4e27 5d20 3d20 7365 6c66 2e65 7073  32N'] = self.eps
-00035230: 665b 2746 3132 3557 275d 0a20 2020 2020  f['F125W'].     
-00035240: 2020 200a 2020 2020 2020 2020 2320 4475     .        # Du
-00035250: 6d6d 7920 6669 6c74 6572 7320 666f 7220  mmy filters for 
-00035260: 4952 2067 7269 736d 730a 2020 2020 2020  IR grisms.      
-00035270: 2020 7365 6c66 2e65 7073 665b 2747 3134    self.epsf['G14
-00035280: 3127 5d20 3d20 7365 6c66 2e65 7073 665b  1'] = self.epsf[
-00035290: 2746 3134 3057 275d 0a20 2020 2020 2020  'F140W'].       
-000352a0: 2073 656c 662e 6570 7366 5b27 4731 3032   self.epsf['G102
-000352b0: 275d 203d 2073 656c 662e 6570 7366 5b27  '] = self.epsf['
-000352c0: 4631 3035 5727 5d0a 2020 2020 2020 2020  F105W'].        
-000352d0: 0a20 2020 2020 2020 2023 2045 7874 656e  .        # Exten
-000352e0: 6465 640a 2020 2020 2020 2020 7365 6c66  ded.        self
-000352f0: 2e65 7874 656e 6465 645f 6570 7366 203d  .extended_epsf =
-00035300: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-00035310: 6669 6c74 6572 2069 6e20 5b27 4631 3035  filter in ['F105
-00035320: 5727 2c20 2746 3132 3557 272c 2027 4631  W', 'F125W', 'F1
-00035330: 3430 5727 2c20 2746 3136 3057 275d 3a0a  40W', 'F160W']:.
-00035340: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-00035350: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-00035360: 4752 495a 4c49 5f50 4154 482c 2027 434f  GRIZLI_PATH, 'CO
-00035370: 4e46 272c 0a20 2020 2020 2020 2020 2020  NF',.           
-00035380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035390: 2020 2020 2027 6578 7465 6e64 6564 5f50       'extended_P
-000353a0: 5346 5f7b 307d 2e66 6974 7327 2e66 6f72  SF_{0}.fits'.for
-000353b0: 6d61 7428 6669 6c74 6572 2929 0a0a 2020  mat(filter))..  
-000353c0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-000353d0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-000353e0: 6669 6c65 293a 0a20 2020 2020 2020 2020  file):.         
-000353f0: 2020 2020 2020 2023 4241 5345 5552 4c20         #BASEURL 
-00035400: 3d20 2768 7474 7073 3a2f 2f65 7264 612e  = 'https://erda.
-00035410: 6b75 2e64 6b2f 7667 7269 642f 4761 6272  ku.dk/vgrid/Gabr
-00035420: 6965 6c25 3230 4272 616d 6d65 722f 434f  iel%20Brammer/CO
-00035430: 4e46 2f27 0a20 2020 2020 2020 2020 2020  NF/'.           
-00035440: 2020 2020 2042 4153 4555 524c 203d 2028       BASEURL = (
-00035450: 2768 7474 7073 3a2f 2f72 6177 2e67 6974  'https://raw.git
-00035460: 6875 6275 7365 7263 6f6e 7465 6e74 2e63  hubusercontent.c
-00035470: 6f6d 2f67 6272 616d 6d65 722f 2720 2b0a  om/gbrammer/' +.
-00035480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035490: 2020 2020 2020 2020 2020 2027 6772 697a             'griz
-000354a0: 6c69 2d63 6f6e 6669 672f 6d61 7374 6572  li-config/master
-000354b0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-000354c0: 2020 2020 6d73 6720 3d20 2745 7874 656e      msg = 'Exten
-000354d0: 6465 6420 5053 4620 6669 6c65 205c 277b  ded PSF file \'{
-000354e0: 307d 5c27 206e 6f74 2066 6f75 6e64 2e27  0}\' not found.'
-000354f0: 2e66 6f72 6d61 7428 6669 6c65 290a 2020  .format(file).  
-00035500: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00035510: 6720 2b3d 2027 4765 7420 7468 6520 6172  g += 'Get the ar
-00035520: 6368 6976 6520 6672 6f6d 2027 0a20 2020  chive from '.   
-00035530: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00035540: 202b 3d20 6627 207b 4241 5345 5552 4c7d   += f' {BASEURL}
-00035550: 2f57 4643 3349 525f 6578 7465 6e64 6564  /WFC3IR_extended
-00035560: 5f50 5346 2e76 312e 7461 722e 677a 270a  _PSF.v1.tar.gz'.
-00035570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035580: 6d73 6720 2b3d 2027 2061 6e64 2075 6e70  msg += ' and unp
-00035590: 6163 6b20 696e 2024 7b47 5249 5a4c 497d  ack in ${GRIZLI}
-000355a0: 2f43 4f4e 462f 270a 2020 2020 2020 2020  /CONF/'.        
-000355b0: 2020 2020 2020 2020 7261 6973 6520 4669          raise Fi
-000355c0: 6c65 4e6f 7446 6f75 6e64 4572 726f 7228  leNotFoundError(
-000355d0: 6d73 6729 0a0a 2020 2020 2020 2020 2020  msg)..          
-000355e0: 2020 7769 7468 2070 7966 6974 732e 6f70    with pyfits.op
-000355f0: 656e 2866 696c 6529 2061 7320 5f69 6d3a  en(file) as _im:
-00035600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035610: 2064 6174 6120 3d20 5f69 6d5b 305d 2e64   data = _im[0].d
-00035620: 6174 612a 310a 2020 2020 2020 2020 2020  ata*1.          
-00035630: 2020 2020 2020 6461 7461 5b64 6174 6120        data[data 
-00035640: 3c20 305d 203d 2030 0a0a 2020 2020 2020  < 0] = 0..      
-00035650: 2020 2020 2020 2320 4d61 736b 2063 656e        # Mask cen
-00035660: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
-00035670: 4e58 203d 2064 6174 612e 7368 6170 655b  NX = data.shape[
-00035680: 305d 2f32 2d31 0a20 2020 2020 2020 2020  0]/2-1.         
-00035690: 2020 2079 702c 2078 7020 3d20 6e70 2e69     yp, xp = np.i
-000356a0: 6e64 6963 6573 2864 6174 612e 7368 6170  ndices(data.shap
-000356b0: 6529 0a20 2020 2020 2020 2020 2020 2052  e).            R
-000356c0: 203d 206e 702e 7371 7274 2828 7870 2d4e   = np.sqrt((xp-N
-000356d0: 5829 2a2a 322b 2879 702d 4e58 292a 2a32  X)**2+(yp-NX)**2
-000356e0: 290a 2020 2020 2020 2020 2020 2020 6461  ).            da
-000356f0: 7461 5b52 203c 3d20 345d 203d 2030 2e0a  ta[R <= 4] = 0..
-00035700: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00035710: 662e 6578 7465 6e64 6564 5f65 7073 665b  f.extended_epsf[
-00035720: 6669 6c74 6572 5d20 3d20 6461 7461 0a20  filter] = data. 
-00035730: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00035740: 6578 7465 6e64 6564 5f4e 203d 2069 6e74  extended_N = int
-00035750: 284e 5829 0a0a 2020 2020 2020 2020 7365  (NX)..        se
-00035760: 6c66 2e65 7874 656e 6465 645f 6570 7366  lf.extended_epsf
-00035770: 5b27 4630 3938 4d27 5d20 3d20 7365 6c66  ['F098M'] = self
-00035780: 2e65 7874 656e 6465 645f 6570 7366 5b27  .extended_epsf['
-00035790: 4631 3035 5727 5d0a 2020 2020 2020 2020  F105W'].        
-000357a0: 7365 6c66 2e65 7874 656e 6465 645f 6570  self.extended_ep
-000357b0: 7366 5b27 4631 3130 5727 5d20 3d20 7365  sf['F110W'] = se
-000357c0: 6c66 2e65 7874 656e 6465 645f 6570 7366  lf.extended_epsf
-000357d0: 5b27 4631 3035 5727 5d0a 2020 2020 2020  ['F105W'].      
-000357e0: 2020 7365 6c66 2e65 7874 656e 6465 645f    self.extended_
-000357f0: 6570 7366 5b27 4631 3238 4e27 5d20 3d20  epsf['F128N'] = 
-00035800: 7365 6c66 2e65 7874 656e 6465 645f 6570  self.extended_ep
-00035810: 7366 5b27 4631 3235 5727 5d0a 2020 2020  sf['F125W'].    
-00035820: 2020 2020 7365 6c66 2e65 7874 656e 6465      self.extende
-00035830: 645f 6570 7366 5b27 4631 3330 4e27 5d20  d_epsf['F130N'] 
-00035840: 3d20 7365 6c66 2e65 7874 656e 6465 645f  = self.extended_
-00035850: 6570 7366 5b27 4631 3235 5727 5d0a 2020  epsf['F125W'].  
-00035860: 2020 2020 2020 7365 6c66 2e65 7874 656e        self.exten
-00035870: 6465 645f 6570 7366 5b27 4631 3332 4e27  ded_epsf['F132N'
-00035880: 5d20 3d20 7365 6c66 2e65 7874 656e 6465  ] = self.extende
-00035890: 645f 6570 7366 5b27 4631 3235 5727 5d0a  d_epsf['F125W'].
-000358a0: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
-000358b0: 656e 6465 645f 6570 7366 5b27 4731 3032  ended_epsf['G102
-000358c0: 275d 203d 2073 656c 662e 6578 7465 6e64  '] = self.extend
-000358d0: 6564 5f65 7073 665b 2746 3130 3557 275d  ed_epsf['F105W']
-000358e0: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
-000358f0: 7465 6e64 6564 5f65 7073 665b 2747 3134  tended_epsf['G14
-00035900: 3127 5d20 3d20 7365 6c66 2e65 7874 656e  1'] = self.exten
-00035910: 6465 645f 6570 7366 5b27 4631 3430 5727  ded_epsf['F140W'
-00035920: 5d0a 0a0a 2020 2020 6465 6620 6765 745f  ]...    def get_
-00035930: 6174 5f70 6f73 6974 696f 6e28 7365 6c66  at_position(self
-00035940: 2c20 783d 3530 372c 2079 3d35 3037 2c20  , x=507, y=507, 
-00035950: 6669 6c74 6572 3d27 4631 3430 5727 2c20  filter='F140W', 
-00035960: 726f 7439 303d 3029 3a0a 2020 2020 2020  rot90=0):.      
-00035970: 2020 2222 2245 7661 6c75 6174 6520 6550    """Evaluate eP
-00035980: 5346 2061 7420 6465 7465 6374 6f72 2063  SF at detector c
-00035990: 6f6f 7264 696e 6174 6573 0a20 2020 2020  oordinates.     
-000359a0: 2020 2054 4244 0a20 2020 2020 2020 2022     TBD.        "
-000359b0: 2222 0a20 2020 2020 2020 2065 7073 6620  "".        epsf 
-000359c0: 3d20 7365 6c66 2e65 7073 665b 6669 6c74  = self.epsf[filt
-000359d0: 6572 5d0a 2020 2020 2020 2020 0a20 2020  er].        .   
-000359e0: 2020 2020 2070 7366 5f74 7970 6520 3d20       psf_type = 
-000359f0: 2748 5354 2f4f 7074 6963 616c 270a 2020  'HST/Optical'.  
-00035a00: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-00035a10: 6620 6669 6c74 6572 2069 6e20 5b27 4630  f filter in ['F0
-00035a20: 3938 4d27 2c20 2746 3131 3057 272c 2027  98M', 'F110W', '
-00035a30: 4631 3035 5727 2c20 2746 3132 3557 272c  F105W', 'F125W',
-00035a40: 2027 4631 3430 5727 2c20 2746 3136 3057   'F140W', 'F160W
-00035a50: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00035a60: 2020 2020 2020 2020 2027 4731 3032 272c           'G102',
-00035a70: 2747 3134 3127 2c27 4631 3238 4e27 2c27  'G141','F128N','
-00035a80: 4631 3330 4e27 2c27 4631 3332 4e27 5d3a  F130N','F132N']:
-00035a90: 0a20 2020 2020 2020 2020 2020 2070 7366  .            psf
-00035aa0: 5f74 7970 6520 3d20 2757 4643 332f 4952  _type = 'WFC3/IR
-00035ab0: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
-00035ac0: 2020 2020 2020 2065 6c69 6620 6669 6c74         elif filt
-00035ad0: 6572 2e73 7461 7274 7377 6974 6828 274e  er.startswith('N
-00035ae0: 5243 2729 207c 2066 696c 7465 722e 7374  RC') | filter.st
-00035af0: 6172 7473 7769 7468 2827 4e49 5327 293a  artswith('NIS'):
-00035b00: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-00035b10: 4952 4953 532c 204e 4952 4361 6d20 324b  IRISS, NIRCam 2K
-00035b20: 0a20 2020 2020 2020 2020 2020 2070 7366  .            psf
-00035b30: 5f74 7970 6520 3d20 274a 5753 542f 324b  _type = 'JWST/2K
-00035b40: 270a 2020 2020 2020 2020 2020 2020 0a20  '.            . 
-00035b50: 2020 2020 2020 2065 6c69 6620 6669 6c74         elif filt
-00035b60: 6572 2e73 7461 7274 7377 6974 6828 274d  er.startswith('M
-00035b70: 4952 4927 293a 0a20 2020 2020 2020 2020  IRI'):.         
-00035b80: 2020 2070 7366 5f74 7970 6520 3d20 274a     psf_type = 'J
-00035b90: 5753 542f 4d49 5249 270a 2020 2020 2020  WST/MIRI'.      
-00035ba0: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
-00035bb0: 6576 616c 5f70 7366 5f74 7970 6520 3d20  eval_psf_type = 
-00035bc0: 7073 665f 7479 7065 0a20 2020 2020 2020  psf_type.       
-00035bd0: 200a 2020 2020 2020 2020 6966 2070 7366   .        if psf
-00035be0: 5f74 7970 6520 3d3d 2027 5746 4333 2f49  _type == 'WFC3/I
-00035bf0: 5227 3a0a 2020 2020 2020 2020 2020 2020  R':.            
-00035c00: 2320 2049 5220 6465 7465 6374 6f72 0a20  #  IR detector. 
-00035c10: 2020 2020 2020 2020 2020 2072 7820 3d20             rx = 
-00035c20: 312b 286e 702e 636c 6970 2878 2c20 312c  1+(np.clip(x, 1,
-00035c30: 2031 3031 3329 2d30 292f 3530 372e 0a20   1013)-0)/507.. 
-00035c40: 2020 2020 2020 2020 2020 2072 7920 3d20             ry = 
-00035c50: 312b 286e 702e 636c 6970 2879 2c20 312c  1+(np.clip(y, 1,
-00035c60: 2031 3031 3329 2d30 292f 3530 372e 0a0a   1013)-0)/507...
-00035c70: 2020 2020 2020 2020 2020 2020 2320 7a65              # ze
-00035c80: 726f 2069 6e64 6578 0a20 2020 2020 2020  ro index.       
-00035c90: 2020 2020 2072 7820 2d3d 2031 0a20 2020       rx -= 1.   
-00035ca0: 2020 2020 2020 2020 2072 7920 2d3d 2031           ry -= 1
-00035cb0: 0a0a 2020 2020 2020 2020 2020 2020 6e78  ..            nx
-00035cc0: 203d 206e 702e 636c 6970 2869 6e74 2872   = np.clip(int(r
-00035cd0: 7829 2c20 302c 2032 290a 2020 2020 2020  x), 0, 2).      
-00035ce0: 2020 2020 2020 6e79 203d 206e 702e 636c        ny = np.cl
-00035cf0: 6970 2869 6e74 2872 7929 2c20 302c 2032  ip(int(ry), 0, 2
-00035d00: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00035d10: 2070 7269 6e74 2078 2c20 792c 2072 782c   print x, y, rx,
-00035d20: 2072 792c 206e 782c 206e 790a 0a20 2020   ry, nx, ny..   
-00035d30: 2020 2020 2020 2020 2066 7820 3d20 7278           fx = rx
-00035d40: 2d6e 780a 2020 2020 2020 2020 2020 2020  -nx.            
-00035d50: 6679 203d 2072 792d 6e79 0a0a 2020 2020  fy = ry-ny..    
-00035d60: 2020 2020 2020 2020 7073 665f 7879 203d          psf_xy =
-00035d70: 2028 312d 6678 292a 2831 2d66 7929 2a65   (1-fx)*(1-fy)*e
-00035d80: 7073 665b 3a2c 203a 2c20 6e78 2b6e 792a  psf[:, :, nx+ny*
-00035d90: 335d 0a20 2020 2020 2020 2020 2020 2070  3].            p
-00035da0: 7366 5f78 7920 2b3d 2066 782a 2831 2d66  sf_xy += fx*(1-f
-00035db0: 7929 2a65 7073 665b 3a2c 203a 2c20 286e  y)*epsf[:, :, (n
-00035dc0: 782b 3129 2b6e 792a 335d 0a20 2020 2020  x+1)+ny*3].     
-00035dd0: 2020 2020 2020 2070 7366 5f78 7920 2b3d         psf_xy +=
-00035de0: 2028 312d 6678 292a 6679 2a65 7073 665b   (1-fx)*fy*epsf[
-00035df0: 3a2c 203a 2c20 6e78 2b28 6e79 2b31 292a  :, :, nx+(ny+1)*
-00035e00: 335d 0a20 2020 2020 2020 2020 2020 2070  3].            p
-00035e10: 7366 5f78 7920 2b3d 2066 782a 6679 2a65  sf_xy += fx*fy*e
-00035e20: 7073 665b 3a2c 203a 2c20 286e 782b 3129  psf[:, :, (nx+1)
-00035e30: 2b28 6e79 2b31 292a 335d 0a20 2020 2020  +(ny+1)*3].     
-00035e40: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00035e50: 2020 2020 7365 6c66 2e65 7661 6c5f 6669      self.eval_fi
-00035e60: 6c74 6572 203d 2066 696c 7465 720a 2020  lter = filter.  
-00035e70: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-00035e80: 6620 7073 665f 7479 7065 203d 3d20 274a  f psf_type == 'J
-00035e90: 5753 542f 4d49 5249 273a 0a20 2020 2020  WST/MIRI':.     
-00035ea0: 2020 2020 2020 2023 2020 4952 2064 6574         #  IR det
-00035eb0: 6563 746f 720a 2020 2020 2020 2020 2020  ector.          
-00035ec0: 2020 4e44 4554 203d 2069 6e74 286e 702e    NDET = int(np.
-00035ed0: 7371 7274 2865 7073 662e 7368 6170 655b  sqrt(epsf.shape[
-00035ee0: 325d 2929 0a20 2020 2020 2020 2020 2020  2])).           
-00035ef0: 200a 2020 2020 2020 2020 2020 2020 7278   .            rx
-00035f00: 203d 2031 2b28 6e70 2e63 6c69 7028 782c   = 1+(np.clip(x,
-00035f10: 2031 2c20 3130 3233 292d 3029 2f35 3132   1, 1023)-0)/512
-00035f20: 2e0a 2020 2020 2020 2020 2020 2020 7279  ..            ry
-00035f30: 203d 2031 2b28 6e70 2e63 6c69 7028 792c   = 1+(np.clip(y,
-00035f40: 2031 2c20 3130 3233 292d 3029 2f35 3132   1, 1023)-0)/512
-00035f50: 2e0a 0a20 2020 2020 2020 2020 2020 2023  ...            #
-00035f60: 207a 6572 6f20 696e 6465 780a 2020 2020   zero index.    
-00035f70: 2020 2020 2020 2020 7278 202d 3d20 310a          rx -= 1.
-00035f80: 2020 2020 2020 2020 2020 2020 7279 202d              ry -
-00035f90: 3d20 310a 0a20 2020 2020 2020 2020 2020  = 1..           
-00035fa0: 2023 206e 7820 3d20 6e70 2e63 6c69 7028   # nx = np.clip(
-00035fb0: 696e 7428 7278 292c 2030 2c20 3229 0a20  int(rx), 0, 2). 
-00035fc0: 2020 2020 2020 2020 2020 2023 206e 7920             # ny 
-00035fd0: 3d20 6e70 2e63 6c69 7028 696e 7428 7279  = np.clip(int(ry
-00035fe0: 292c 2030 2c20 3229 0a20 2020 2020 2020  ), 0, 2).       
-00035ff0: 2020 2020 206e 7820 3d20 6e70 2e63 6c69       nx = np.cli
-00036000: 7028 696e 7428 7278 292c 2030 2c20 4e44  p(int(rx), 0, ND
-00036010: 4554 2d31 290a 2020 2020 2020 2020 2020  ET-1).          
-00036020: 2020 6e79 203d 206e 702e 636c 6970 2869    ny = np.clip(i
-00036030: 6e74 2872 7929 2c20 302c 204e 4445 542d  nt(ry), 0, NDET-
-00036040: 3129 0a20 2020 2020 2020 2020 2020 200a  1).            .
-00036050: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-00036060: 696e 7420 782c 2079 2c20 7278 2c20 7279  int x, y, rx, ry
-00036070: 2c20 6e78 2c20 6e79 0a0a 2020 2020 2020  , nx, ny..      
-00036080: 2020 2020 2020 6678 203d 2072 782d 6e78        fx = rx-nx
-00036090: 0a20 2020 2020 2020 2020 2020 2066 7920  .            fy 
-000360a0: 3d20 7279 2d6e 790a 0a20 2020 2020 2020  = ry-ny..       
-000360b0: 2020 2020 2023 2070 7366 5f78 7920 3d20       # psf_xy = 
-000360c0: 2831 2d66 7829 2a28 312d 6679 292a 6570  (1-fx)*(1-fy)*ep
-000360d0: 7366 5b3a 2c20 3a2c 206e 782b 6e79 2a33  sf[:, :, nx+ny*3
-000360e0: 5d0a 2020 2020 2020 2020 2020 2020 2320  ].            # 
-000360f0: 7073 665f 7879 202b 3d20 6678 2a28 312d  psf_xy += fx*(1-
-00036100: 6679 292a 6570 7366 5b3a 2c20 3a2c 2028  fy)*epsf[:, :, (
-00036110: 6e78 2b31 292b 6e79 2a33 5d0a 2020 2020  nx+1)+ny*3].    
-00036120: 2020 2020 2020 2020 2320 7073 665f 7879          # psf_xy
-00036130: 202b 3d20 2831 2d66 7829 2a66 792a 6570   += (1-fx)*fy*ep
-00036140: 7366 5b3a 2c20 3a2c 206e 782b 286e 792b  sf[:, :, nx+(ny+
-00036150: 3129 2a33 5d0a 2020 2020 2020 2020 2020  1)*3].          
-00036160: 2020 2320 7073 665f 7879 202b 3d20 6678    # psf_xy += fx
-00036170: 2a66 792a 6570 7366 5b3a 2c20 3a2c 2028  *fy*epsf[:, :, (
-00036180: 6e78 2b31 292b 286e 792b 3129 2a33 5d0a  nx+1)+(ny+1)*3].
-00036190: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000361a0: 4e44 4554 203d 3d20 313a 0a20 2020 2020  NDET == 1:.     
-000361b0: 2020 2020 2020 2020 2020 2070 7366 5f78             psf_x
-000361c0: 7920 3d20 6570 7366 5b3a 2c3a 2c30 5d0a  y = epsf[:,:,0].
-000361d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000361e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000361f0: 2020 7073 665f 7879 203d 2028 312d 6678    psf_xy = (1-fx
-00036200: 292a 2831 2d66 7929 2a65 7073 665b 3a2c  )*(1-fy)*epsf[:,
-00036210: 203a 2c20 6e78 2b6e 792a 4e44 4554 5d0a   :, nx+ny*NDET].
-00036220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036230: 7073 665f 7879 202b 3d20 6678 2a28 312d  psf_xy += fx*(1-
-00036240: 6679 292a 6570 7366 5b3a 2c20 3a2c 2028  fy)*epsf[:, :, (
-00036250: 6e78 2b31 292b 6e79 2a4e 4445 545d 0a20  nx+1)+ny*NDET]. 
-00036260: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00036270: 7366 5f78 7920 2b3d 2028 312d 6678 292a  sf_xy += (1-fx)*
-00036280: 6679 2a65 7073 665b 3a2c 203a 2c20 6e78  fy*epsf[:, :, nx
-00036290: 2b28 6e79 2b31 292a 4e44 4554 5d0a 2020  +(ny+1)*NDET].  
-000362a0: 2020 2020 2020 2020 2020 2020 2020 7073                ps
-000362b0: 665f 7879 202b 3d20 6678 2a66 792a 6570  f_xy += fx*fy*ep
-000362c0: 7366 5b3a 2c20 3a2c 2028 6e78 2b31 292b  sf[:, :, (nx+1)+
-000362d0: 286e 792b 3129 2a4e 4445 545d 0a20 2020  (ny+1)*NDET].   
-000362e0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-000362f0: 2020 2020 2020 2320 7073 665f 7879 203d        # psf_xy =
-00036300: 206e 702e 726f 7439 3028 7073 665f 7879   np.rot90(psf_xy
-00036310: 2e54 2c20 3229 0a20 2020 2020 2020 2020  .T, 2).         
-00036320: 2020 2070 7366 5f78 7920 3d20 7073 665f     psf_xy = psf_
-00036330: 7879 2e54 0a20 2020 2020 2020 2020 2020  xy.T.           
-00036340: 200a 2020 2020 2020 2020 2020 2020 7365   .            se
-00036350: 6c66 2e65 7661 6c5f 6669 6c74 6572 203d  lf.eval_filter =
-00036360: 2066 696c 7465 720a 2020 2020 2020 2020   filter.        
-00036370: 0a20 2020 2020 2020 2069 6620 7073 665f  .        if psf_
-00036380: 7479 7065 203d 3d20 274a 5753 542f 324b  type == 'JWST/2K
-00036390: 273a 0a20 2020 2020 2020 2020 2020 200a  ':.            .
-000363a0: 2020 2020 2020 2020 2020 2020 4e44 4554              NDET
-000363b0: 203d 2069 6e74 286e 702e 7371 7274 2865   = int(np.sqrt(e
-000363c0: 7073 662e 7368 6170 655b 325d 2929 0a20  psf.shape[2])). 
-000363d0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-000363e0: 2020 2020 2020 2020 2320 2049 5220 6465          #  IR de
-000363f0: 7465 6374 6f72 0a20 2020 2020 2020 2020  tector.         
-00036400: 2020 2072 7820 3d20 312b 286e 702e 636c     rx = 1+(np.cl
-00036410: 6970 2878 2c20 312c 2032 3034 3729 2d30  ip(x, 1, 2047)-0
-00036420: 292f 3130 3234 2e0a 2020 2020 2020 2020  )/1024..        
-00036430: 2020 2020 7279 203d 2031 2b28 6e70 2e63      ry = 1+(np.c
-00036440: 6c69 7028 792c 2031 2c20 3230 3437 292d  lip(y, 1, 2047)-
-00036450: 3029 2f31 3032 342e 0a0a 2020 2020 2020  0)/1024...      
-00036460: 2020 2020 2020 2320 7a65 726f 2069 6e64        # zero ind
-00036470: 6578 0a20 2020 2020 2020 2020 2020 2072  ex.            r
-00036480: 7820 2d3d 2031 0a20 2020 2020 2020 2020  x -= 1.         
-00036490: 2020 2072 7920 2d3d 2031 0a0a 2020 2020     ry -= 1..    
-000364a0: 2020 2020 2020 2020 6e78 203d 206e 702e          nx = np.
-000364b0: 636c 6970 2869 6e74 2872 7829 2c20 302c  clip(int(rx), 0,
-000364c0: 204e 4445 542d 3129 0a20 2020 2020 2020   NDET-1).       
-000364d0: 2020 2020 206e 7920 3d20 6e70 2e63 6c69       ny = np.cli
-000364e0: 7028 696e 7428 7279 292c 2030 2c20 4e44  p(int(ry), 0, ND
-000364f0: 4554 2d31 290a 0a20 2020 2020 2020 2020  ET-1)..         
-00036500: 2020 2023 2070 7269 6e74 2078 2c20 792c     # print x, y,
-00036510: 2072 782c 2072 792c 206e 782c 206e 790a   rx, ry, nx, ny.
-00036520: 0a20 2020 2020 2020 2020 2020 2066 7820  .            fx 
-00036530: 3d20 7278 2d6e 780a 2020 2020 2020 2020  = rx-nx.        
-00036540: 2020 2020 6679 203d 2072 792d 6e79 0a20      fy = ry-ny. 
-00036550: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00036560: 2020 2020 2020 2020 6966 204e 4445 5420          if NDET 
-00036570: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-00036580: 2020 2020 2020 7073 665f 7879 203d 2065        psf_xy = e
-00036590: 7073 665b 3a2c 3a2c 305d 0a20 2020 2020  psf[:,:,0].     
-000365a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000365b0: 2020 2020 2020 2020 2020 2020 2070 7366               psf
-000365c0: 5f78 7920 3d20 2831 2d66 7829 2a28 312d  _xy = (1-fx)*(1-
-000365d0: 6679 292a 6570 7366 5b3a 2c20 3a2c 206e  fy)*epsf[:, :, n
-000365e0: 782b 6e79 2a4e 4445 545d 0a20 2020 2020  x+ny*NDET].     
-000365f0: 2020 2020 2020 2020 2020 2070 7366 5f78             psf_x
-00036600: 7920 2b3d 2066 782a 2831 2d66 7929 2a65  y += fx*(1-fy)*e
-00036610: 7073 665b 3a2c 203a 2c20 286e 782b 3129  psf[:, :, (nx+1)
-00036620: 2b6e 792a 4e44 4554 5d0a 2020 2020 2020  +ny*NDET].      
-00036630: 2020 2020 2020 2020 2020 7073 665f 7879            psf_xy
-00036640: 202b 3d20 2831 2d66 7829 2a66 792a 6570   += (1-fx)*fy*ep
-00036650: 7366 5b3a 2c20 3a2c 206e 782b 286e 792b  sf[:, :, nx+(ny+
-00036660: 3129 2a4e 4445 545d 0a20 2020 2020 2020  1)*NDET].       
-00036670: 2020 2020 2020 2020 2070 7366 5f78 7920           psf_xy 
-00036680: 2b3d 2066 782a 6679 2a65 7073 665b 3a2c  += fx*fy*epsf[:,
-00036690: 203a 2c20 286e 782b 3129 2b28 6e79 2b31   :, (nx+1)+(ny+1
-000366a0: 292a 4e44 4554 5d0a 2020 2020 2020 2020  )*NDET].        
-000366b0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-000366c0: 2070 7366 5f78 7920 3d20 7073 665f 7879   psf_xy = psf_xy
-000366d0: 2e54 0a20 2020 2020 2020 2020 2020 2023  .T.            #
-000366e0: 2070 7366 5f78 7920 3d20 6e70 2e72 6f74   psf_xy = np.rot
-000366f0: 3930 2870 7366 5f78 792e 542c 2032 290a  90(psf_xy.T, 2).
-00036700: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00036710: 2020 2020 2020 2020 2073 656c 662e 6576           self.ev
-00036720: 616c 5f66 696c 7465 7220 3d20 6669 6c74  al_filter = filt
-00036730: 6572 0a20 2020 2020 2020 200a 2020 2020  er.        .    
-00036740: 2020 2020 656c 6966 2070 7366 5f74 7970      elif psf_typ
-00036750: 6520 3d3d 2027 4853 542f 4f70 7469 6361  e == 'HST/Optica
-00036760: 6c27 3a0a 0a20 2020 2020 2020 2020 2020  l':..           
-00036770: 2073 6820 3d20 6570 7366 2e73 6861 7065   sh = epsf.shape
-00036780: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00036790: 2073 685b 325d 203d 3d20 3930 3a0a 2020   sh[2] == 90:.  
-000367a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000367b0: 4143 5320 5746 430a 2020 2020 2020 2020  ACS WFC.        
-000367c0: 2020 2020 2020 2020 6958 2c20 6959 203d          iX, iY =
-000367d0: 2039 2c20 3130 2020 2320 392c 2031 300a   9, 10  # 9, 10.
-000367e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000367f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00036800: 2020 2320 5556 4953 0a20 2020 2020 2020    # UVIS.       
-00036810: 2020 2020 2020 2020 2069 582c 2069 5920           iX, iY 
-00036820: 3d20 372c 2038 0a0a 2020 2020 2020 2020  = 7, 8..        
-00036830: 2020 2020 7278 203d 2031 2b28 6e70 2e63      rx = 1+(np.c
-00036840: 6c69 7028 782c 2031 2c20 3430 3935 292d  lip(x, 1, 4095)-
-00036850: 3029 2f28 3430 3936 2f28 6958 2d31 2929  0)/(4096/(iX-1))
-00036860: 0a20 2020 2020 2020 2020 2020 2072 7920  .            ry 
-00036870: 3d20 312b 286e 702e 636c 6970 2879 2c20  = 1+(np.clip(y, 
-00036880: 312c 2034 3039 3529 2d30 292f 2834 3039  1, 4095)-0)/(409
-00036890: 362f 2869 592d 3129 290a 0a20 2020 2020  6/(iY-1))..     
-000368a0: 2020 2020 2020 2023 207a 6572 6f20 696e         # zero in
-000368b0: 6465 780a 2020 2020 2020 2020 2020 2020  dex.            
-000368c0: 7278 202d 3d20 310a 2020 2020 2020 2020  rx -= 1.        
-000368d0: 2020 2020 7279 202d 3d20 310a 0a20 2020      ry -= 1..   
-000368e0: 2020 2020 2020 2020 206e 7820 3d20 6e70           nx = np
-000368f0: 2e63 6c69 7028 6e70 2e63 6173 745b 696e  .clip(np.cast[in
-00036900: 745d 2872 7829 2c20 302c 2069 582d 3129  t](rx), 0, iX-1)
-00036910: 0a20 2020 2020 2020 2020 2020 206e 7920  .            ny 
-00036920: 3d20 6e70 2e63 6c69 7028 6e70 2e63 6173  = np.clip(np.cas
-00036930: 745b 696e 745d 2872 7929 2c20 302c 2069  t[int](ry), 0, i
-00036940: 592d 3129 0a0a 2020 2020 2020 2020 2020  Y-1)..          
-00036950: 2020 2320 7072 696e 7420 782c 2079 2c20    # print x, y, 
-00036960: 7278 2c20 7279 2c20 6e78 2c20 6e79 0a0a  rx, ry, nx, ny..
-00036970: 2020 2020 2020 2020 2020 2020 6678 203d              fx =
-00036980: 2072 782d 6e78 0a20 2020 2020 2020 2020   rx-nx.         
-00036990: 2020 2066 7920 3d20 7279 2d6e 790a 0a20     fy = ry-ny.. 
-000369a0: 2020 2020 2020 2020 2020 2070 7366 5f78             psf_x
-000369b0: 7920 3d20 2831 2d66 7829 2a28 312d 6679  y = (1-fx)*(1-fy
-000369c0: 292a 6570 7366 5b3a 2c20 3a2c 206e 782b  )*epsf[:, :, nx+
-000369d0: 6e79 2a69 585d 0a20 2020 2020 2020 2020  ny*iX].         
-000369e0: 2020 2070 7366 5f78 7920 2b3d 2066 782a     psf_xy += fx*
-000369f0: 2831 2d66 7929 2a65 7073 665b 3a2c 203a  (1-fy)*epsf[:, :
-00036a00: 2c20 286e 782b 3129 2b6e 792a 6958 5d0a  , (nx+1)+ny*iX].
-00036a10: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
-00036a20: 7879 202b 3d20 2831 2d66 7829 2a66 792a  xy += (1-fx)*fy*
-00036a30: 6570 7366 5b3a 2c20 3a2c 206e 782b 286e  epsf[:, :, nx+(n
-00036a40: 792b 3129 2a69 585d 0a20 2020 2020 2020  y+1)*iX].       
-00036a50: 2020 2020 2070 7366 5f78 7920 2b3d 2066       psf_xy += f
-00036a60: 782a 6679 2a65 7073 665b 3a2c 203a 2c20  x*fy*epsf[:, :, 
-00036a70: 286e 782b 3129 2b28 6e79 2b31 292a 6958  (nx+1)+(ny+1)*iX
-00036a80: 5d0a 0a20 2020 2020 2020 2020 2020 2073  ]..            s
-00036a90: 656c 662e 6576 616c 5f66 696c 7465 7220  elf.eval_filter 
-00036aa0: 3d20 6669 6c74 6572 0a20 2020 2020 2020  = filter.       
-00036ab0: 200a 2020 2020 2020 2020 6966 2072 6f74   .        if rot
-00036ac0: 3930 2021 3d20 303a 0a20 2020 2020 2020  90 != 0:.       
-00036ad0: 2020 2020 2073 656c 662e 7073 665f 7879       self.psf_xy
-00036ae0: 5f72 6f74 3930 203d 2072 6f74 3930 0a20  _rot90 = rot90. 
-00036af0: 2020 2020 2020 2020 2020 2070 7366 5f78             psf_x
-00036b00: 7920 3d20 6e70 2e72 6f74 3930 2870 7366  y = np.rot90(psf
-00036b10: 5f78 792c 2072 6f74 3930 290a 2020 2020  _xy, rot90).    
-00036b20: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00036b30: 2072 6574 7572 6e20 7073 665f 7879 0a0a   return psf_xy..
-00036b40: 2020 2020 6465 6620 6576 616c 5f65 5053      def eval_ePS
-00036b50: 4628 7365 6c66 2c20 7073 665f 7879 2c20  F(self, psf_xy, 
-00036b60: 6478 2c20 6479 2c20 726f 7439 303d 302c  dx, dy, rot90=0,
-00036b70: 2065 7874 656e 6465 645f 6461 7461 3d4e   extended_data=N
-00036b80: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
-00036b90: 2245 7661 6c75 6174 6520 5053 4620 6174  "Evaluate PSF at
-00036ba0: 2064 782c 6479 2063 6f6f 7264 696e 6174   dx,dy coordinat
-00036bb0: 6573 0a0a 2020 2020 2020 2020 5442 440a  es..        TBD.
-00036bc0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00036bd0: 2020 2020 2320 536f 206d 7563 6820 6661      # So much fa
-00036be0: 7374 6572 2074 6861 6e20 7363 6970 792e  ster than scipy.
-00036bf0: 696e 7465 7270 6f6c 6174 652e 6772 6964  interpolate.grid
-00036c00: 6461 7461 210a 2020 2020 2020 2020 6672  data!.        fr
-00036c10: 6f6d 2073 6369 7079 2e6e 6469 6d61 6765  om scipy.ndimage
-00036c20: 2069 6d70 6f72 7420 6d61 705f 636f 6f72   import map_coor
-00036c30: 6469 6e61 7465 730a 0a20 2020 2020 2020  dinates..       
-00036c40: 2023 2065 5053 4620 6f6e 6c79 2064 6566   # ePSF only def
-00036c50: 696e 6564 2074 6f20 3132 2e35 2070 6978  ined to 12.5 pix
-00036c60: 656c 730a 2020 2020 2020 2020 6966 2073  els.        if s
-00036c70: 656c 662e 6576 616c 5f70 7366 5f74 7970  elf.eval_psf_typ
-00036c80: 6520 696e 205b 2757 4643 332f 4952 272c  e in ['WFC3/IR',
-00036c90: 2748 5354 2f4f 7074 6963 616c 275d 3a0a  'HST/Optical']:.
-00036ca0: 2020 2020 2020 2020 2020 2020 6f6b 203d              ok =
-00036cb0: 2028 6e70 2e61 6273 2864 7829 203c 3d20   (np.abs(dx) <= 
-00036cc0: 3132 2e35 2920 2620 286e 702e 6162 7328  12.5) & (np.abs(
-00036cd0: 6479 2920 3c3d 2031 322e 3529 0a20 2020  dy) <= 12.5).   
-00036ce0: 2020 2020 2020 2020 2063 6f6f 7264 7320           coords 
-00036cf0: 3d20 6e70 2e61 7272 6179 285b 3530 2b34  = np.array([50+4
-00036d00: 2a64 785b 6f6b 5d2c 2035 302b 342a 6479  *dx[ok], 50+4*dy
-00036d10: 5b6f 6b5d 5d29 0a20 2020 2020 2020 2065  [ok]]).        e
-00036d20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00036d30: 2023 204a 5753 5420 6172 6520 2b2f 2d20   # JWST are +/- 
-00036d40: 3332 2070 6978 656c 730a 2020 2020 2020  32 pixels.      
-00036d50: 2020 2020 2020 7368 203d 2070 7366 5f78        sh = psf_x
-00036d60: 792e 7368 6170 650a 2020 2020 2020 2020  y.shape.        
-00036d70: 2020 2020 5f73 697a 6520 3d20 2873 685b      _size = (sh[
-00036d80: 305d 2d31 292f 2f34 0a20 2020 2020 2020  0]-1)//4.       
-00036d90: 2020 2020 205f 7830 203d 205f 7369 7a65       _x0 = _size
-00036da0: 2a32 0a20 2020 2020 2020 2020 2020 205f  *2.            _
-00036db0: 6365 6e20 3d20 285f 7830 2d31 292f 2f32  cen = (_x0-1)//2
-00036dc0: 0a20 2020 2020 2020 2020 2020 206f 6b20  .            ok 
-00036dd0: 3d20 286e 702e 6162 7328 6478 2920 3c3d  = (np.abs(dx) <=
-00036de0: 205f 6365 6e29 2026 2028 6e70 2e61 6273   _cen) & (np.abs
-00036df0: 2864 7929 203c 3d20 5f63 656e 290a 2020  (dy) <= _cen).  
-00036e00: 2020 2020 2020 2020 2020 636f 6f72 6473            coords
-00036e10: 203d 206e 702e 6172 7261 7928 5b5f 7830   = np.array([_x0
-00036e20: 2b34 2a64 785b 6f6b 5d2c 205f 7830 2b34  +4*dx[ok], _x0+4
-00036e30: 2a64 795b 6f6b 5d5d 290a 0a20 2020 2020  *dy[ok]])..     
-00036e40: 2020 2023 2044 6f20 7468 6520 696e 7465     # Do the inte
-00036e50: 7270 6f6c 6174 696f 6e0a 2020 2020 2020  rpolation.      
-00036e60: 2020 696e 7465 7270 5f6d 6170 203d 206d    interp_map = m
-00036e70: 6170 5f63 6f6f 7264 696e 6174 6573 2870  ap_coordinates(p
-00036e80: 7366 5f78 792c 2063 6f6f 7264 732c 206f  sf_xy, coords, o
-00036e90: 7264 6572 3d33 290a 0a20 2020 2020 2020  rder=3)..       
-00036ea0: 2023 2046 696c 6c20 6f75 7470 7574 2064   # Fill output d
-00036eb0: 6174 610a 2020 2020 2020 2020 6f75 7420  ata.        out 
-00036ec0: 3d20 6e70 2e7a 6572 6f73 5f6c 696b 6528  = np.zeros_like(
-00036ed0: 6478 2c20 6474 7970 653d 6e70 2e66 6c6f  dx, dtype=np.flo
-00036ee0: 6174 3332 290a 2020 2020 2020 2020 6f75  at32).        ou
-00036ef0: 745b 6f6b 5d20 3d20 696e 7465 7270 5f6d  t[ok] = interp_m
-00036f00: 6170 0a0a 2020 2020 2020 2020 2320 4578  ap..        # Ex
-00036f10: 7465 6e64 6564 2050 5346 0a20 2020 2020  tended PSF.     
-00036f20: 2020 2069 6620 6578 7465 6e64 6564 5f64     if extended_d
-00036f30: 6174 6120 6973 206e 6f74 204e 6f6e 653a  ata is not None:
-00036f40: 0a20 2020 2020 2020 2020 2020 206f 6b20  .            ok 
-00036f50: 3d20 286e 702e 6162 7328 6478 2920 3c20  = (np.abs(dx) < 
-00036f60: 7365 6c66 2e65 7874 656e 6465 645f 4e29  self.extended_N)
-00036f70: 200a 2020 2020 2020 2020 2020 2020 6f6b   .            ok
-00036f80: 2026 3d20 286e 702e 6162 7328 6479 2920   &= (np.abs(dy) 
-00036f90: 3c20 7365 6c66 2e65 7874 656e 6465 645f  < self.extended_
-00036fa0: 4e29 0a20 2020 2020 2020 2020 2020 200a  N).            .
-00036fb0: 2020 2020 2020 2020 2020 2020 7830 203d              x0 =
-00036fc0: 2073 656c 662e 6578 7465 6e64 6564 5f4e   self.extended_N
-00036fd0: 0a20 2020 2020 2020 2020 2020 2063 6f6f  .            coo
-00036fe0: 7264 7320 3d20 6e70 2e61 7272 6179 285b  rds = np.array([
-00036ff0: 7830 2b64 795b 6f6b 5d2b 302c 2078 302b  x0+dy[ok]+0, x0+
-00037000: 6478 5b6f 6b5d 5d29 0a20 2020 2020 2020  dx[ok]]).       
-00037010: 2020 2020 2069 6e74 6572 705f 6d61 7020       interp_map 
-00037020: 3d20 6d61 705f 636f 6f72 6469 6e61 7465  = map_coordinate
-00037030: 7328 6578 7465 6e64 6564 5f64 6174 612c  s(extended_data,
-00037040: 2063 6f6f 7264 732c 206f 7264 6572 3d30   coords, order=0
-00037050: 290a 2020 2020 2020 2020 2020 2020 6f75  ).            ou
-00037060: 745b 6f6b 5d20 2b3d 2069 6e74 6572 705f  t[ok] += interp_
-00037070: 6d61 700a 0a20 2020 2020 2020 2072 6574  map..        ret
-00037080: 7572 6e20 6f75 740a 0a20 2020 2040 7374  urn out..    @st
-00037090: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-000370a0: 6566 206f 626a 6563 7469 7665 5f65 7073  ef objective_eps
-000370b0: 665f 6365 6e74 6572 2870 6172 616d 732c  f_center(params,
-000370c0: 2073 656c 662c 2070 7366 5f78 792c 2073   self, psf_xy, s
-000370d0: 6369 2c20 6976 6172 2c20 7870 2c20 7970  ci, ivar, xp, yp
-000370e0: 2c20 6578 7465 6e64 6564 5f64 6174 612c  , extended_data,
-000370f0: 2072 6574 2c20 6473 3929 3a0a 2020 2020   ret, ds9):.    
-00037100: 2020 2020 2222 224f 626a 6563 7469 7665      """Objective
-00037110: 2066 756e 6374 696f 6e20 666f 7220 6669   function for fi
-00037120: 7474 696e 6720 6550 5346 730a 0a20 2020  tting ePSFs..   
-00037130: 2020 2020 2054 4244 0a0a 2020 2020 2020       TBD..      
-00037140: 2020 7061 7261 6d73 203d 205b 6e6f 726d    params = [norm
-00037150: 616c 697a 6174 696f 6e2c 2078 632c 2079  alization, xc, y
-00037160: 632c 2062 6163 6b67 726f 756e 645d 0a20  c, background]. 
-00037170: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00037180: 2020 2066 726f 6d20 6e75 6d70 792e 6c69     from numpy.li
-00037190: 6e61 6c67 2069 6d70 6f72 7420 6c73 7473  nalg import lsts
-000371a0: 710a 0a20 2020 2020 2020 2073 6820 3d20  q..        sh = 
-000371b0: 7363 692e 7368 6170 650a 2020 2020 2020  sci.shape.      
-000371c0: 2020 7930 2c20 7830 203d 206e 702e 6172    y0, x0 = np.ar
-000371d0: 7261 7928 7368 292f 322e 2d31 0a0a 2020  ray(sh)/2.-1..  
-000371e0: 2020 2020 2020 6478 203d 2078 702d 7061        dx = xp-pa
-000371f0: 7261 6d73 5b30 5d0a 2020 2020 2020 2020  rams[0].        
-00037200: 6479 203d 2079 702d 7061 7261 6d73 5b31  dy = yp-params[1
-00037210: 5d0a 0a20 2020 2020 2020 2064 6478 203d  ]..        ddx =
-00037220: 2078 7020 2023 202d 7830 0a20 2020 2020   xp  # -x0.     
-00037230: 2020 2064 6479 203d 2079 7020 2023 202d     ddy = yp  # -
-00037240: 7930 0a0a 2020 2020 2020 2020 6464 7820  y0..        ddx 
-00037250: 3d20 6464 782f 6464 782e 6d61 7828 290a  = ddx/ddx.max().
-00037260: 2020 2020 2020 2020 6464 7920 3d20 6464          ddy = dd
-00037270: 792f 6464 792e 6d61 7828 290a 0a20 2020  y/ddy.max()..   
-00037280: 2020 2020 2023 2062 6b67 203d 2070 6172       # bkg = par
-00037290: 616d 735b 335d 202b 2070 6172 616d 735b  ams[3] + params[
-000372a0: 345d 2a64 6478 202b 2070 6172 616d 735b  4]*ddx + params[
-000372b0: 355d 2a64 6479 2023 2b20 7061 7261 6d73  5]*ddy #+ params
-000372c0: 5b36 5d2a 6464 782a 6464 790a 0a20 2020  [6]*ddx*ddy..   
-000372d0: 2020 2020 2070 7366 5f6f 6666 7365 7420       psf_offset 
-000372e0: 3d20 7365 6c66 2e65 7661 6c5f 6550 5346  = self.eval_ePSF
-000372f0: 2870 7366 5f78 792c 2064 782c 2064 792c  (psf_xy, dx, dy,
-00037300: 2065 7874 656e 6465 645f 6461 7461 3d65   extended_data=e
-00037310: 7874 656e 6465 645f 6461 7461 2920 2023  xtended_data)  #
-00037320: 202a 7061 7261 6d73 5b30 5d0a 0a20 2020   *params[0]..   
-00037330: 2020 2020 2041 203d 2028 6e70 2e61 7272       A = (np.arr
-00037340: 6179 285b 7073 665f 6f66 6673 6574 2c20  ay([psf_offset, 
-00037350: 6e70 2e6f 6e65 735f 6c69 6b65 2873 6369  np.ones_like(sci
-00037360: 292c 2064 6478 2c20 6464 795d 292a 6e70  ), ddx, ddy])*np
-00037370: 2e73 7172 7428 6976 6172 2929 2e72 6573  .sqrt(ivar)).res
-00037380: 6861 7065 2828 342c 202d 3129 290a 2020  hape((4, -1)).  
-00037390: 2020 2020 2020 7363 6966 203d 2028 7363        scif = (sc
-000373a0: 692a 6e70 2e73 7172 7428 6976 6172 2929  i*np.sqrt(ivar))
-000373b0: 2e66 6c61 7474 656e 2829 0a20 2020 2020  .flatten().     
-000373c0: 2020 206d 6173 6b20 3d20 2873 6369 6620     mask = (scif 
-000373d0: 213d 2030 290a 2020 2020 2020 2020 636f  != 0).        co
-000373e0: 6566 6673 2c20 5f72 6573 6964 2c20 5f72  effs, _resid, _r
-000373f0: 616e 6b2c 205f 7320 3d20 6c73 7473 7128  ank, _s = lstsq(
-00037400: 415b 3a2c 206d 6173 6b5d 2e54 2c20 7363  A[:, mask].T, sc
-00037410: 6966 5b6d 6173 6b5d 2c20 0a20 2020 2020  if[mask], .     
-00037420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037440: 2020 2020 2072 636f 6e64 3d4c 5354 5351       rcond=LSTSQ
-00037450: 5f52 434f 4e44 290a 2020 2020 2020 2020  _RCOND).        
-00037460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037480: 2020 0a20 2020 2020 2020 2072 6573 6964    .        resid
-00037490: 203d 2028 7363 6966 202d 206e 702e 646f   = (scif - np.do
-000374a0: 7428 636f 6566 6673 2c20 4129 290a 0a20  t(coeffs, A)).. 
-000374b0: 2020 2020 2020 2069 6620 6473 393a 0a20         if ds9:. 
-000374c0: 2020 2020 2020 2020 2020 2041 7820 3d20             Ax = 
-000374d0: 286e 702e 6172 7261 7928 5b70 7366 5f6f  (np.array([psf_o
-000374e0: 6666 7365 742c 206e 702e 6f6e 6573 5f6c  ffset, np.ones_l
-000374f0: 696b 6528 7363 6929 2c20 6464 782c 2064  ike(sci), ddx, d
-00037500: 6479 5d29 292e 7265 7368 6170 6528 2834  dy])).reshape((4
-00037510: 2c20 2d31 2929 0a20 2020 2020 2020 2020  , -1)).         
-00037520: 2020 2070 7366 5f6d 6f64 656c 203d 206e     psf_model = n
-00037530: 702e 646f 7428 636f 6566 6673 5b3a 315d  p.dot(coeffs[:1]
-00037540: 2c20 4178 5b3a 312c 203a 5d29 2e72 6573  , Ax[:1, :]).res
-00037550: 6861 7065 2873 6369 2e73 6861 7065 290a  hape(sci.shape).
-00037560: 2020 2020 2020 2020 2020 2020 626b 6720              bkg 
-00037570: 3d20 6e70 2e64 6f74 2863 6f65 6666 735b  = np.dot(coeffs[
-00037580: 313a 5d2c 2041 785b 313a 2c20 3a5d 292e  1:], Ax[1:, :]).
-00037590: 7265 7368 6170 6528 7363 692e 7368 6170  reshape(sci.shap
-000375a0: 6529 0a20 2020 2020 2020 2020 2020 2064  e).            d
-000375b0: 7339 2e76 6965 7728 2873 6369 2d70 7366  s9.view((sci-psf
-000375c0: 5f6d 6f64 656c 2d62 6b67 292a 6d61 736b  _model-bkg)*mask
-000375d0: 2e72 6573 6861 7065 2873 6369 2e73 6861  .reshape(sci.sha
-000375e0: 7065 2929 0a0a 2020 2020 2020 2020 6966  pe))..        if
-000375f0: 2072 6574 203d 3d20 2772 6573 6964 273a   ret == 'resid':
-00037600: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00037610: 7572 6e20 7265 7369 640a 2020 2020 2020  urn resid.      
-00037620: 2020 656c 6966 2072 6574 203d 3d20 276c    elif ret == 'l
-00037630: 6d27 3a0a 2020 2020 2020 2020 2020 2020  m':.            
-00037640: 2320 6d61 736b 6564 2072 6573 6964 7561  # masked residua
-00037650: 6c73 2066 6f72 204c 4d20 6f70 7469 6d69  ls for LM optimi
-00037660: 7a61 7469 6f6e 0a20 2020 2020 2020 2020  zation.         
-00037670: 2020 2069 6620 4661 6c73 653a 0a20 2020     if False:.   
-00037680: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00037690: 6e74 2870 6172 616d 732c 2028 7265 7369  nt(params, (resi
-000376a0: 642a 2a32 292e 7375 6d28 292c 2063 6f65  d**2).sum(), coe
-000376b0: 6666 735b 305d 290a 0a20 2020 2020 2020  ffs[0])..       
-000376c0: 2020 2020 2072 6574 7572 6e20 7265 7369       return resi
-000376d0: 645b 7265 7369 6420 213d 2030 5d0a 2020  d[resid != 0].  
-000376e0: 2020 2020 2020 656c 6966 2072 6574 203d        elif ret =
-000376f0: 3d20 276d 6f64 656c 273a 0a20 2020 2020  = 'model':.     
-00037700: 2020 2020 2020 2041 7820 3d20 286e 702e         Ax = (np.
-00037710: 6172 7261 7928 5b70 7366 5f6f 6666 7365  array([psf_offse
-00037720: 742c 206e 702e 6f6e 6573 5f6c 696b 6528  t, np.ones_like(
-00037730: 7363 6929 2c20 6464 782c 2064 6479 5d29  sci), ddx, ddy])
-00037740: 292e 7265 7368 6170 6528 2834 2c20 2d31  ).reshape((4, -1
-00037750: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
-00037760: 7366 5f6d 6f64 656c 203d 206e 702e 646f  sf_model = np.do
-00037770: 7428 636f 6566 6673 5b3a 315d 2c20 4178  t(coeffs[:1], Ax
-00037780: 5b3a 312c 203a 5d29 2e72 6573 6861 7065  [:1, :]).reshape
-00037790: 2873 6369 2e73 6861 7065 290a 2020 2020  (sci.shape).    
-000377a0: 2020 2020 2020 2020 626b 6720 3d20 6e70          bkg = np
-000377b0: 2e64 6f74 2863 6f65 6666 735b 313a 5d2c  .dot(coeffs[1:],
-000377c0: 2041 785b 313a 2c20 3a5d 292e 7265 7368   Ax[1:, :]).resh
-000377d0: 6170 6528 7363 692e 7368 6170 6529 0a20  ape(sci.shape). 
-000377e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000377f0: 6e20 7073 665f 6d6f 6465 6c2c 2062 6b67  n psf_model, bkg
-00037800: 2c20 4178 2c20 636f 6566 6673 0a20 2020  , Ax, coeffs.   
-00037810: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00037820: 2020 2020 2020 2063 6869 3220 3d20 2872         chi2 = (r
-00037830: 6573 6964 2a2a 3229 2e73 756d 2829 0a20  esid**2).sum(). 
-00037840: 2020 2020 2020 2020 2020 2023 7072 696e             #prin
-00037850: 7428 7061 7261 6d73 2c20 6368 6932 2c20  t(params, chi2, 
-00037860: 636f 6566 6673 5b30 5d29 0a20 2020 2020  coeffs[0]).     
-00037870: 2020 2020 2020 2072 6574 7572 6e20 6368         return ch
-00037880: 6932 0a0a 2020 2020 4073 7461 7469 636d  i2..    @staticm
-00037890: 6574 686f 640a 2020 2020 6465 6620 6f62  ethod.    def ob
-000378a0: 6a65 6374 6976 655f 6570 7366 2870 6172  jective_epsf(par
-000378b0: 616d 732c 2073 656c 662c 2070 7366 5f78  ams, self, psf_x
-000378c0: 792c 2073 6369 2c20 6976 6172 2c20 7870  y, sci, ivar, xp
-000378d0: 2c20 7970 2c20 6578 7465 6e64 6564 5f64  , yp, extended_d
-000378e0: 6174 612c 2072 6574 2c20 6473 3929 3a0a  ata, ret, ds9):.
-000378f0: 2020 2020 2020 2020 2222 224f 626a 6563          """Objec
-00037900: 7469 7665 2066 756e 6374 696f 6e20 666f  tive function fo
-00037910: 7220 6669 7474 696e 6720 6550 5346 730a  r fitting ePSFs.
-00037920: 0a20 2020 2020 2020 2054 4244 0a0a 2020  .        TBD..  
-00037930: 2020 2020 2020 7061 7261 6d73 203d 205b        params = [
-00037940: 6e6f 726d 616c 697a 6174 696f 6e2c 2078  normalization, x
-00037950: 632c 2079 632c 2062 6163 6b67 726f 756e  c, yc, backgroun
-00037960: 645d 0a20 2020 2020 2020 2022 2222 0a20  d].        """. 
-00037970: 2020 2020 2020 2064 7820 3d20 7870 2d70         dx = xp-p
-00037980: 6172 616d 735b 315d 0a20 2020 2020 2020  arams[1].       
-00037990: 2064 7920 3d20 7970 2d70 6172 616d 735b   dy = yp-params[
-000379a0: 325d 0a0a 2020 2020 2020 2020 6464 7820  2]..        ddx 
-000379b0: 3d20 7870 2d78 702e 6d69 6e28 290a 2020  = xp-xp.min().  
-000379c0: 2020 2020 2020 6464 7920 3d20 7970 2d79        ddy = yp-y
-000379d0: 702e 6d69 6e28 290a 0a20 2020 2020 2020  p.min()..       
-000379e0: 2064 6478 203d 2064 6478 2f64 6478 2e6d   ddx = ddx/ddx.m
-000379f0: 6178 2829 0a20 2020 2020 2020 2064 6479  ax().        ddy
-00037a00: 203d 2064 6479 2f64 6479 2e6d 6178 2829   = ddy/ddy.max()
-00037a10: 0a0a 2020 2020 2020 2020 626b 6720 3d20  ..        bkg = 
-00037a20: 7061 7261 6d73 5b33 5d20 2b20 7061 7261  params[3] + para
-00037a30: 6d73 5b34 5d2a 6464 7820 2b20 7061 7261  ms[4]*ddx + para
-00037a40: 6d73 5b35 5d2a 6464 7920 2023 202b 2070  ms[5]*ddy  # + p
-00037a50: 6172 616d 735b 365d 2a64 6478 2a64 6479  arams[6]*ddx*ddy
-00037a60: 0a0a 2020 2020 2020 2020 7073 665f 6f66  ..        psf_of
-00037a70: 6673 6574 203d 2073 656c 662e 6576 616c  fset = self.eval
-00037a80: 5f65 5053 4628 7073 665f 7879 2c20 6478  _ePSF(psf_xy, dx
-00037a90: 2c20 6479 2c20 6578 7465 6e64 6564 5f64  , dy, extended_d
-00037aa0: 6174 613d 6578 7465 6e64 6564 5f64 6174  ata=extended_dat
-00037ab0: 6129 2a70 6172 616d 735b 305d 0a0a 2020  a)*params[0]..  
-00037ac0: 2020 2020 2020 7265 7369 6420 3d20 2873        resid = (s
-00037ad0: 6369 2d70 7366 5f6f 6666 7365 742d 626b  ci-psf_offset-bk
-00037ae0: 6729 2a6e 702e 7371 7274 2869 7661 7229  g)*np.sqrt(ivar)
-00037af0: 0a0a 2020 2020 2020 2020 6966 2064 7339  ..        if ds9
-00037b00: 3a0a 2020 2020 2020 2020 2020 2020 6473  :.            ds
-00037b10: 392e 7669 6577 2873 6369 2d70 7366 5f6f  9.view(sci-psf_o
-00037b20: 6666 7365 742d 626b 6729 0a0a 2020 2020  ffset-bkg)..    
-00037b30: 2020 2020 6966 2072 6574 203d 3d20 2772      if ret == 'r
-00037b40: 6573 6964 273a 0a20 2020 2020 2020 2020  esid':.         
-00037b50: 2020 2072 6574 7572 6e20 7265 7369 640a     return resid.
-00037b60: 2020 2020 2020 2020 656c 6966 2072 6574          elif ret
-00037b70: 203d 3d20 276c 6d27 3a0a 2020 2020 2020   == 'lm':.      
-00037b80: 2020 2020 2020 2320 6d61 736b 6564 2072        # masked r
-00037b90: 6573 6964 7561 6c73 2066 6f72 204c 4d20  esiduals for LM 
-00037ba0: 6f70 7469 6d69 7a61 7469 6f6e 0a20 2020  optimization.   
-00037bb0: 2020 2020 2020 2020 2069 6620 4661 6c73           if Fals
-00037bc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00037bd0: 2020 2070 7269 6e74 2870 6172 616d 732c     print(params,
-00037be0: 2028 7265 7369 642a 2a32 292e 7375 6d28   (resid**2).sum(
-00037bf0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00037c00: 7265 7475 726e 2072 6573 6964 5b72 6573  return resid[res
-00037c10: 6964 2021 3d20 305d 0a20 2020 2020 2020  id != 0].       
-00037c20: 2065 6c69 6620 7265 7420 3d3d 2027 6d6f   elif ret == 'mo
-00037c30: 6465 6c27 3a0a 2020 2020 2020 2020 2020  del':.          
-00037c40: 2020 7265 7475 726e 2070 7366 5f6f 6666    return psf_off
-00037c50: 7365 742c 2062 6b67 2c20 4e6f 6e65 2c20  set, bkg, None, 
-00037c60: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
-00037c70: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-00037c80: 6869 3220 3d20 2872 6573 6964 2a2a 3229  hi2 = (resid**2)
-00037c90: 2e73 756d 2829 0a20 2020 2020 2020 2020  .sum().         
-00037ca0: 2020 2023 7072 696e 7428 7061 7261 6d73     #print(params
-00037cb0: 2c20 6368 6932 290a 2020 2020 2020 2020  , chi2).        
-00037cc0: 2020 2020 7265 7475 726e 2063 6869 320a      return chi2.
-00037cd0: 0a20 2020 2064 6566 2066 6974 5f65 5053  .    def fit_ePS
-00037ce0: 4628 7365 6c66 2c20 7363 692c 2063 656e  F(self, sci, cen
-00037cf0: 7465 723d 4e6f 6e65 2c20 6f72 6967 696e  ter=None, origin
-00037d00: 3d5b 302c 2030 5d2c 2069 7661 723d 312c  =[0, 0], ivar=1,
-00037d10: 204e 3d37 2c0a 2020 2020 2020 2020 2020   N=7,.          
-00037d20: 2020 2020 2020 2066 696c 7465 723d 2746         filter='F
-00037d30: 3134 3057 272c 2074 6f6c 3d31 2e65 2d34  140W', tol=1.e-4
-00037d40: 2c20 6775 6573 733d 4e6f 6e65 2c20 6765  , guess=None, ge
-00037d50: 745f 6578 7465 6e64 6564 3d46 616c 7365  t_extended=False
-00037d60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00037d70: 2020 206d 6574 686f 643d 276c 6d27 2c20     method='lm', 
-00037d80: 6473 393d 4e6f 6e65 2c20 7073 665f 7061  ds9=None, psf_pa
-00037d90: 7261 6d73 3d4e 6f6e 652c 206f 6e6c 795f  rams=None, only_
-00037da0: 6365 6e74 6572 696e 673d 5472 7565 2c20  centering=True, 
-00037db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037dc0: 2020 726f 7439 303d 3029 3a0a 2020 2020    rot90=0):.    
-00037dd0: 2020 2020 2222 2246 6974 2065 5053 4620      """Fit ePSF 
-00037de0: 746f 2069 6e70 7574 2064 6174 610a 2020  to input data.  
-00037df0: 2020 2020 2020 5442 440a 2020 2020 2020        TBD.      
-00037e00: 2020 2222 220a 2020 2020 2020 2020 6672    """.        fr
-00037e10: 6f6d 2073 6369 7079 2e6f 7074 696d 697a  om scipy.optimiz
-00037e20: 6520 696d 706f 7274 206d 696e 696d 697a  e import minimiz
-00037e30: 652c 206c 6561 7374 5f73 7175 6172 6573  e, least_squares
-00037e40: 0a0a 2020 2020 2020 2020 7368 203d 2073  ..        sh = s
-00037e50: 6369 2e73 6861 7065 0a20 2020 2020 2020  ci.shape.       
-00037e60: 2069 6620 6365 6e74 6572 2069 7320 4e6f   if center is No
-00037e70: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00037e80: 7930 2c20 7830 203d 206e 702e 6172 7261  y0, x0 = np.arra
-00037e90: 7928 7368 292f 322e 2d31 0a20 2020 2020  y(sh)/2.-1.     
-00037ea0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00037eb0: 2020 2020 2078 302c 2079 3020 3d20 6365       x0, y0 = ce
-00037ec0: 6e74 6572 0a0a 2020 2020 2020 2020 7864  nter..        xd
-00037ed0: 203d 2078 302b 6f72 6967 696e 5b31 5d0a   = x0+origin[1].
-00037ee0: 2020 2020 2020 2020 7964 203d 2079 302b          yd = y0+
-00037ef0: 6f72 6967 696e 5b30 5d0a 0a20 2020 2020  origin[0]..     
-00037f00: 2020 2078 632c 2079 6320 3d20 696e 7428     xc, yc = int(
-00037f10: 7830 292c 2069 6e74 2879 3029 0a0a 2020  x0), int(y0)..  
-00037f20: 2020 2020 2020 7073 665f 7879 203d 2073        psf_xy = s
-00037f30: 656c 662e 6765 745f 6174 5f70 6f73 6974  elf.get_at_posit
-00037f40: 696f 6e28 783d 7864 2c20 793d 7964 2c20  ion(x=xd, y=yd, 
-00037f50: 6669 6c74 6572 3d66 696c 7465 722c 2072  filter=filter, r
-00037f60: 6f74 3930 3d72 6f74 3930 290a 0a20 2020  ot90=rot90)..   
-00037f70: 2020 2020 2079 702c 2078 7020 3d20 6e70       yp, xp = np
-00037f80: 2e69 6e64 6963 6573 2873 6829 0a0a 2020  .indices(sh)..  
-00037f90: 2020 2020 2020 6966 2067 7565 7373 2069        if guess i
-00037fa0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00037fb0: 2020 2020 6966 206e 702e 6973 7363 616c      if np.isscal
-00037fc0: 6172 2869 7661 7229 3a0a 2020 2020 2020  ar(ivar):.      
-00037fd0: 2020 2020 2020 2020 2020 6978 203d 206e            ix = n
-00037fe0: 702e 6172 676d 6178 2873 6369 2e66 6c61  p.argmax(sci.fla
-00037ff0: 7474 656e 2829 290a 2020 2020 2020 2020  tten()).        
-00038000: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00038010: 2020 2020 2020 2020 2020 6978 203d 206e            ix = n
-00038020: 702e 6172 676d 6178 2828 7363 692a 2869  p.argmax((sci*(i
-00038030: 7661 7220 3e20 3029 292e 666c 6174 7465  var > 0)).flatte
-00038040: 6e28 2929 0a0a 2020 2020 2020 2020 2020  n())..          
-00038050: 2020 7867 7565 7373 203d 2078 702e 666c    xguess = xp.fl
-00038060: 6174 7465 6e28 295b 6978 5d0a 2020 2020  atten()[ix].    
-00038070: 2020 2020 2020 2020 7967 7565 7373 203d          yguess =
-00038080: 2079 702e 666c 6174 7465 6e28 295b 6978   yp.flatten()[ix
-00038090: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-000380a0: 2020 2020 2020 2020 2020 2020 7867 7565              xgue
-000380b0: 7373 2c20 7967 7565 7373 203d 2067 7565  ss, yguess = gue
-000380c0: 7373 0a0a 2020 2020 2020 2020 6d65 645f  ss..        med_
-000380d0: 626b 6720 3d20 6e70 2e6d 6564 6961 6e28  bkg = np.median(
-000380e0: 7363 6929 0a0a 2020 2020 2020 2020 6966  sci)..        if
-000380f0: 206f 6e6c 795f 6365 6e74 6572 696e 673a   only_centering:
-00038100: 0a20 2020 2020 2020 2020 2020 2023 204f  .            # O
-00038110: 6e6c 7920 6669 7420 666f 7220 6365 6e74  nly fit for cent
-00038120: 6572 696e 6720 616e 6420 636f 6d70 7574  ering and comput
-00038130: 6520 6e6f 726d 616c 697a 6174 696f 6e73  e normalizations
-00038140: 0a20 2020 2020 2020 2020 2020 2067 7565  .            gue
-00038150: 7373 203d 205b 7867 7565 7373 2c20 7967  ss = [xguess, yg
-00038160: 7565 7373 5d0a 2020 2020 2020 2020 2020  uess].          
-00038170: 2020 5f6f 626a 6675 6e20 3d20 7365 6c66    _objfun = self
-00038180: 2e6f 626a 6563 7469 7665 5f65 7073 665f  .objective_epsf_
-00038190: 6365 6e74 6572 0a20 2020 2020 2020 2065  center.        e
-000381a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000381b0: 2023 2046 6974 2066 6f72 2063 656e 7465   # Fit for cente
-000381c0: 7269 6e67 2061 6e64 206e 6f72 6d61 6c69  ring and normali
-000381d0: 7a61 7469 6f6e 0a20 2020 2020 2020 2020  zation.         
-000381e0: 2020 2067 7565 7373 203d 205b 2873 6369     guess = [(sci
-000381f0: 2d6d 6564 5f62 6b67 295b 7963 2d4e 3a79  -med_bkg)[yc-N:y
-00038200: 632b 4e2c 2078 632d 4e3a 7863 2b4e 5d2e  c+N, xc-N:xc+N].
-00038210: 7375 6d28 292c 2078 6775 6573 732c 2079  sum(), xguess, y
-00038220: 6775 6573 732c 206d 6564 5f62 6b67 2c20  guess, med_bkg, 
-00038230: 302c 2030 5d0a 2020 2020 2020 2020 2020  0, 0].          
-00038240: 2020 5f6f 626a 6675 6e20 3d20 7365 6c66    _objfun = self
-00038250: 2e6f 626a 6563 7469 7665 5f65 7073 660a  .objective_epsf.
-00038260: 0a20 2020 2020 2020 2073 6c79 203d 2073  .        sly = s
-00038270: 6c69 6365 2879 632d 4e2c 2079 632b 4e29  lice(yc-N, yc+N)
-00038280: 0a20 2020 2020 2020 2073 6c78 203d 2073  .        slx = s
-00038290: 6c69 6365 2878 632d 4e2c 2078 632b 4e29  lice(xc-N, xc+N)
-000382a0: 0a20 2020 2020 2020 2073 6c79 203d 2073  .        sly = s
-000382b0: 6c69 6365 2879 6775 6573 732d 4e2c 2079  lice(yguess-N, y
-000382c0: 6775 6573 732b 4e29 0a20 2020 2020 2020  guess+N).       
-000382d0: 2073 6c78 203d 2073 6c69 6365 2878 6775   slx = slice(xgu
-000382e0: 6573 732d 4e2c 2078 6775 6573 732b 4e29  ess-N, xguess+N)
-000382f0: 0a0a 2020 2020 2020 2020 6976 6172 5f6d  ..        ivar_m
-00038300: 6173 6b20 3d20 6e70 2e7a 6572 6f73 5f6c  ask = np.zeros_l
-00038310: 696b 6528 7363 6929 0a20 2020 2020 2020  ike(sci).       
-00038320: 2069 7661 725f 6d61 736b 5b73 6c79 2c20   ivar_mask[sly, 
-00038330: 736c 785d 203d 2031 0a20 2020 2020 2020  slx] = 1.       
-00038340: 2069 7661 725f 6d61 736b 202a 3d20 6976   ivar_mask *= iv
-00038350: 6172 0a0a 2020 2020 2020 2020 6966 2067  ar..        if g
-00038360: 6574 5f65 7874 656e 6465 643a 0a20 2020  et_extended:.   
-00038370: 2020 2020 2020 2020 2069 6620 6669 6c74           if filt
-00038380: 6572 2069 6e20 7365 6c66 2e65 7874 656e  er in self.exten
-00038390: 6465 645f 6570 7366 3a0a 2020 2020 2020  ded_epsf:.      
-000383a0: 2020 2020 2020 2020 2020 6578 7465 6e64            extend
-000383b0: 6564 5f64 6174 6120 3d20 7365 6c66 2e65  ed_data = self.e
-000383c0: 7874 656e 6465 645f 6570 7366 5b66 696c  xtended_epsf[fil
-000383d0: 7465 725d 0a20 2020 2020 2020 2020 2020  ter].           
-000383e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000383f0: 2020 2020 2020 2065 7874 656e 6465 645f         extended_
-00038400: 6461 7461 203d 204e 6f6e 650a 2020 2020  data = None.    
-00038410: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00038420: 2020 2020 2020 6578 7465 6e64 6564 5f64        extended_d
-00038430: 6174 6120 3d20 4e6f 6e65 0a0a 2020 2020  ata = None..    
-00038440: 2020 2020 2320 4765 7420 6d6f 6465 6c0a      # Get model.
-00038450: 2020 2020 2020 2020 6966 2070 7366 5f70          if psf_p
-00038460: 6172 616d 7320 6973 206e 6f74 204e 6f6e  arams is not Non
-00038470: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-00038480: 7820 3d20 7073 665f 7061 7261 6d73 2a31  x = psf_params*1
-00038490: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000384a0: 6c65 6e28 7078 2920 3d3d 2032 3a0a 2020  len(px) == 2:.  
-000384b0: 2020 2020 2020 2020 2020 2020 2020 5f6f                _o
-000384c0: 626a 6675 6e20 3d20 7365 6c66 2e6f 626a  bjfun = self.obj
-000384d0: 6563 7469 7665 5f65 7073 665f 6365 6e74  ective_epsf_cent
-000384e0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-000384f0: 2020 2070 785b 305d 202b 3d20 7830 0a20     px[0] += x0. 
-00038500: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00038510: 785b 315d 202b 3d20 7930 0a20 2020 2020  x[1] += y0.     
-00038520: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00038530: 2020 2020 2020 2020 2020 2020 205f 6f62               _ob
-00038540: 6a66 756e 203d 2073 656c 662e 6f62 6a65  jfun = self.obje
-00038550: 6374 6976 655f 6570 7366 0a20 2020 2020  ctive_epsf.     
-00038560: 2020 2020 2020 2020 2020 2070 785b 315d             px[1]
-00038570: 202b 3d20 7830 0a20 2020 2020 2020 2020   += x0.         
-00038580: 2020 2020 2020 2070 785b 325d 202b 3d20         px[2] += 
-00038590: 7930 0a0a 2020 2020 2020 2020 2020 2020  y0..            
-000385a0: 6172 6773 203d 2028 7365 6c66 2c20 7073  args = (self, ps
-000385b0: 665f 7879 2c20 7363 692c 2069 7661 725f  f_xy, sci, ivar_
-000385c0: 6d61 736b 2c20 7870 2c20 7970 2c20 6578  mask, xp, yp, ex
-000385d0: 7465 6e64 6564 5f64 6174 612c 2027 6d6f  tended_data, 'mo
-000385e0: 6465 6c27 2c20 6473 3929 0a20 2020 2020  del', ds9).     
-000385f0: 2020 2020 2020 2070 7366 5f6d 6f64 656c         psf_model
-00038600: 2c20 626b 672c 2041 2c20 636f 6566 6673  , bkg, A, coeffs
-00038610: 203d 205f 6f62 6a66 756e 2870 782c 202a   = _objfun(px, *
-00038620: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-00038630: 2020 7265 7475 726e 2070 7366 5f6d 6f64    return psf_mod
-00038640: 656c 2c20 626b 672c 2041 2c20 636f 6566  el, bkg, A, coef
-00038650: 6673 0a0a 2020 2020 2020 2020 6966 206d  fs..        if m
-00038660: 6574 686f 6420 3d3d 2027 6c6d 273a 0a20  ethod == 'lm':. 
-00038670: 2020 2020 2020 2020 2020 2061 7267 7320             args 
-00038680: 3d20 2873 656c 662c 2070 7366 5f78 792c  = (self, psf_xy,
-00038690: 2073 6369 2c20 6976 6172 5f6d 6173 6b2c   sci, ivar_mask,
-000386a0: 2078 702c 2079 702c 2065 7874 656e 6465   xp, yp, extende
-000386b0: 645f 6461 7461 2c20 276c 6d27 2c20 6473  d_data, 'lm', ds
-000386c0: 3929 0a0a 2020 2020 2020 2020 2020 2020  9)..            
-000386d0: 785f 7363 616c 6520 3d20 276a 6163 270a  x_scale = 'jac'.
-000386e0: 2020 2020 2020 2020 2020 2020 2378 5f73              #x_s
-000386f0: 6361 6c65 203d 205b 6775 6573 735b 305d  cale = [guess[0]
-00038700: 2c20 312c 2031 2c20 3130 2c20 3130 2c20  , 1, 1, 10, 10, 
-00038710: 3130 5d0a 2020 2020 2020 2020 2020 2020  10].            
-00038720: 236f 7574 203d 206c 6561 7374 5f73 7175  #out = least_squ
-00038730: 6172 6573 285f 6f62 6a66 756e 2c20 6775  ares(_objfun, gu
-00038740: 6573 732c 2061 7267 733d 6172 6773 2c20  ess, args=args, 
-00038750: 6d65 7468 6f64 3d27 7472 6627 2c20 785f  method='trf', x_
-00038760: 7363 616c 653d 785f 7363 616c 652c 206c  scale=x_scale, l
-00038770: 6f73 733d 2768 7562 6572 2729 0a20 2020  oss='huber').   
-00038780: 2020 2020 2020 2020 206f 7574 203d 206c           out = l
-00038790: 6561 7374 5f73 7175 6172 6573 285f 6f62  east_squares(_ob
-000387a0: 6a66 756e 2c20 6775 6573 732c 2061 7267  jfun, guess, arg
-000387b0: 733d 6172 6773 2c20 6d65 7468 6f64 3d27  s=args, method='
-000387c0: 6c6d 272c 2078 5f73 6361 6c65 3d78 5f73  lm', x_scale=x_s
-000387d0: 6361 6c65 2c20 6c6f 7373 3d27 6c69 6e65  cale, loss='line
-000387e0: 6172 2729 0a20 2020 2020 2020 2020 2020  ar').           
-000387f0: 2070 7366 5f70 6172 616d 7320 3d20 6f75   psf_params = ou
-00038800: 742e 782a 310a 2020 2020 2020 2020 656c  t.x*1.        el
-00038810: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00038820: 6172 6773 203d 2028 7365 6c66 2c20 7073  args = (self, ps
-00038830: 665f 7879 2c20 7363 692c 2069 7661 725f  f_xy, sci, ivar_
-00038840: 6d61 736b 2c20 7870 2c20 7970 2c20 6578  mask, xp, yp, ex
-00038850: 7465 6e64 6564 5f64 6174 612c 2027 6368  tended_data, 'ch
-00038860: 6932 272c 2064 7339 290a 2020 2020 2020  i2', ds9).      
-00038870: 2020 2020 2020 6f75 7420 3d20 6d69 6e69        out = mini
-00038880: 6d69 7a65 285f 6f62 6a66 756e 2c20 6775  mize(_objfun, gu
-00038890: 6573 732c 2061 7267 733d 6172 6773 2c20  ess, args=args, 
-000388a0: 6d65 7468 6f64 3d6d 6574 686f 642c 2074  method=method, t
-000388b0: 6f6c 3d74 6f6c 290a 2020 2020 2020 2020  ol=tol).        
-000388c0: 2020 2020 7073 665f 7061 7261 6d73 203d      psf_params =
-000388d0: 206f 7574 2e78 2a31 0a0a 2020 2020 2020   out.x*1..      
-000388e0: 2020 6966 206c 656e 2867 7565 7373 2920    if len(guess) 
-000388f0: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
-00038900: 2020 7073 665f 7061 7261 6d73 5b30 5d20    psf_params[0] 
-00038910: 2d3d 2078 300a 2020 2020 2020 2020 2020  -= x0.          
-00038920: 2020 7073 665f 7061 7261 6d73 5b31 5d20    psf_params[1] 
-00038930: 2d3d 2079 300a 2020 2020 2020 2020 656c  -= y0.        el
-00038940: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00038950: 7073 665f 7061 7261 6d73 5b31 5d20 2d3d  psf_params[1] -=
-00038960: 2078 300a 2020 2020 2020 2020 2020 2020   x0.            
-00038970: 7073 665f 7061 7261 6d73 5b32 5d20 2d3d  psf_params[2] -=
-00038980: 2079 300a 0a20 2020 2020 2020 2023 2069   y0..        # i
-00038990: 6620 4661 6c73 653a 0a20 2020 2020 2020  f False:.       
-000389a0: 2023 200a 2020 2020 2020 2020 2320 2020   # .        #   
-000389b0: 2020 7073 665f 6669 7420 3d20 6570 7366    psf_fit = epsf
-000389c0: 2e67 6574 5f65 5053 4628 7073 665f 7061  .get_ePSF(psf_pa
-000389d0: 7261 6d73 2c20 6f72 6967 696e 3d6f 7269  rams, origin=ori
-000389e0: 6769 6e2c 0a20 2020 2020 2020 2023 2020  gin,.        #  
-000389f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a00: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00038a10: 6c74 6572 3d66 696c 7465 722c 2073 6861  lter=filter, sha
-00038a20: 7065 3d73 682c 0a20 2020 2020 2020 2023  pe=sh,.        #
-00038a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038a50: 6765 745f 6578 7465 6e64 6564 3d67 6574  get_extended=get
-00038a60: 5f65 7874 656e 6465 6429 0a20 2020 2020  _extended).     
-00038a70: 2020 2023 200a 2020 2020 2020 2020 2320     # .        # 
-00038a80: 2020 2020 7861 7267 7320 3d20 2873 656c      xargs = (sel
-00038a90: 662c 2070 7366 5f78 792c 2073 6369 2c20  f, psf_xy, sci, 
-00038aa0: 6976 6172 5f6d 6173 6b2c 2078 702c 2079  ivar_mask, xp, y
-00038ab0: 702c 2065 7874 656e 6465 645f 6461 7461  p, extended_data
-00038ac0: 2c20 276c 6d27 2c20 4e6f 6e65 290a 2020  , 'lm', None).  
-00038ad0: 2020 2020 2020 2320 2020 2020 6c6d 203d        #     lm =
-00038ae0: 205f 6f62 6a66 756e 286f 7574 2e78 2c20   _objfun(out.x, 
-00038af0: 2a78 6172 6773 290a 2020 2020 2020 2020  *xargs).        
-00038b00: 2320 2020 2020 6361 7267 7320 3d20 2873  #     cargs = (s
-00038b10: 656c 662c 2070 7366 5f78 792c 2073 6369  elf, psf_xy, sci
-00038b20: 2c20 6976 6172 5f6d 6173 6b2c 2078 702c  , ivar_mask, xp,
-00038b30: 2079 702c 2065 7874 656e 6465 645f 6461   yp, extended_da
-00038b40: 7461 2c20 2763 6869 3227 2c20 4e6f 6e65  ta, 'chi2', None
-00038b50: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-00038b60: 6368 6932 203d 205f 6f62 6a66 756e 286f  chi2 = _objfun(o
-00038b70: 7574 2e78 2c20 2a63 6172 6773 290a 0a20  ut.x, *cargs).. 
-00038b80: 2020 2020 2020 2072 6574 7572 6e20 7073         return ps
-00038b90: 665f 7061 7261 6d73 0a0a 2020 2020 2020  f_params..      
-00038ba0: 2020 2320 6478 203d 2078 702d 7073 665f    # dx = xp-psf_
-00038bb0: 7061 7261 6d73 5b31 5d0a 2020 2020 2020  params[1].      
-00038bc0: 2020 2320 6479 203d 2079 702d 7073 665f    # dy = yp-psf_
-00038bd0: 7061 7261 6d73 5b32 5d0a 2020 2020 2020  params[2].      
-00038be0: 2020 2320 6f75 7470 7574 5f70 7366 203d    # output_psf =
-00038bf0: 2073 656c 662e 6576 616c 5f65 5053 4628   self.eval_ePSF(
-00038c00: 7073 665f 7879 2c20 6478 2c20 6479 292a  psf_xy, dx, dy)*
-00038c10: 7073 665f 7061 7261 6d73 5b30 5d0a 2020  psf_params[0].  
-00038c20: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-00038c30: 2320 7265 7475 726e 206f 7574 7075 745f  # return output_
-00038c40: 7073 662c 2070 7366 5f70 6172 616d 730a  psf, psf_params.
-00038c50: 0a20 2020 2064 6566 2067 6574 5f65 5053  .    def get_ePS
-00038c60: 4628 7365 6c66 2c20 7073 665f 7061 7261  F(self, psf_para
-00038c70: 6d73 2c20 7363 693d 4e6f 6e65 2c20 6976  ms, sci=None, iv
-00038c80: 6172 3d31 2c20 6f72 6967 696e 3d5b 302c  ar=1, origin=[0,
-00038c90: 2030 5d2c 2073 6861 7065 3d5b 3230 2c20   0], shape=[20, 
-00038ca0: 3230 5d2c 2066 696c 7465 723d 2746 3134  20], filter='F14
-00038cb0: 3057 272c 2067 6574 5f65 7874 656e 6465  0W', get_extende
-00038cc0: 643d 4661 6c73 652c 2067 6574 5f62 6163  d=False, get_bac
-00038cd0: 6b67 726f 756e 643d 4661 6c73 652c 2072  kground=False, r
-00038ce0: 6f74 3930 3d30 293a 0a20 2020 2020 2020  ot90=0):.       
-00038cf0: 2022 2222 0a20 2020 2020 2020 2045 7661   """.        Eva
-00038d00: 6c75 6174 6520 616e 2045 6666 6563 7469  luate an Effecti
-00038d10: 7665 2050 5346 0a20 2020 2020 2020 2022  ve PSF.        "
-00038d20: 2222 0a20 2020 2020 2020 2073 6820 3d20  "".        sh = 
-00038d30: 7368 6170 650a 2020 2020 2020 2020 7930  shape.        y0
-00038d40: 2c20 7830 203d 206e 702e 6172 7261 7928  , x0 = np.array(
-00038d50: 7368 292f 322e 2d31 0a0a 2020 2020 2020  sh)/2.-1..      
-00038d60: 2020 7864 203d 2078 302b 6f72 6967 696e    xd = x0+origin
-00038d70: 5b31 5d0a 2020 2020 2020 2020 7964 203d  [1].        yd =
-00038d80: 2079 302b 6f72 6967 696e 5b30 5d0a 0a20   y0+origin[0].. 
-00038d90: 2020 2020 2020 2078 632c 2079 6320 3d20         xc, yc = 
-00038da0: 696e 7428 7830 292c 2069 6e74 2879 3029  int(x0), int(y0)
-00038db0: 0a0a 2020 2020 2020 2020 7073 665f 7879  ..        psf_xy
-00038dc0: 203d 2073 656c 662e 6765 745f 6174 5f70   = self.get_at_p
-00038dd0: 6f73 6974 696f 6e28 783d 7864 2c20 793d  osition(x=xd, y=
-00038de0: 7964 2c20 6669 6c74 6572 3d66 696c 7465  yd, filter=filte
-00038df0: 722c 2072 6f74 3930 3d72 6f74 3930 290a  r, rot90=rot90).
-00038e00: 0a20 2020 2020 2020 2079 702c 2078 7020  .        yp, xp 
-00038e10: 3d20 6e70 2e69 6e64 6963 6573 2873 6829  = np.indices(sh)
-00038e20: 0a0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
-00038e30: 2870 7366 5f70 6172 616d 7329 203d 3d20  (psf_params) == 
-00038e40: 323a 0a20 2020 2020 2020 2020 2020 205f  2:.            _
-00038e50: 6f62 6a66 756e 203d 2073 656c 662e 6f62  objfun = self.ob
-00038e60: 6a65 6374 6976 655f 6570 7366 5f63 656e  jective_epsf_cen
-00038e70: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
-00038e80: 6478 203d 2078 702d 7073 665f 7061 7261  dx = xp-psf_para
-00038e90: 6d73 5b30 5d2d 7830 0a20 2020 2020 2020  ms[0]-x0.       
-00038ea0: 2020 2020 2064 7920 3d20 7970 2d70 7366       dy = yp-psf
-00038eb0: 5f70 6172 616d 735b 315d 2d79 300a 2020  _params[1]-y0.  
-00038ec0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00038ed0: 2020 2020 2020 2020 5f6f 626a 6675 6e20          _objfun 
-00038ee0: 3d20 7365 6c66 2e6f 626a 6563 7469 7665  = self.objective
-00038ef0: 5f65 7073 660a 2020 2020 2020 2020 2020  _epsf.          
-00038f00: 2020 6478 203d 2078 702d 7073 665f 7061    dx = xp-psf_pa
-00038f10: 7261 6d73 5b31 5d2d 7830 0a20 2020 2020  rams[1]-x0.     
-00038f20: 2020 2020 2020 2064 7920 3d20 7970 2d70         dy = yp-p
-00038f30: 7366 5f70 6172 616d 735b 325d 2d79 300a  sf_params[2]-y0.
-00038f40: 0a20 2020 2020 2020 2069 6620 6765 745f  .        if get_
-00038f50: 6578 7465 6e64 6564 3a0a 2020 2020 2020  extended:.      
-00038f60: 2020 2020 2020 6966 2066 696c 7465 7220        if filter 
-00038f70: 696e 2073 656c 662e 6578 7465 6e64 6564  in self.extended
-00038f80: 5f65 7073 663a 0a20 2020 2020 2020 2020  _epsf:.         
-00038f90: 2020 2020 2020 2065 7874 656e 6465 645f         extended_
-00038fa0: 6461 7461 203d 2073 656c 662e 6578 7465  data = self.exte
-00038fb0: 6e64 6564 5f65 7073 665b 6669 6c74 6572  nded_epsf[filter
-00038fc0: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
-00038fd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00038fe0: 2020 2020 6578 7465 6e64 6564 5f64 6174      extended_dat
-00038ff0: 6120 3d20 4e6f 6e65 0a20 2020 2020 2020  a = None.       
-00039000: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00039010: 2020 2065 7874 656e 6465 645f 6461 7461     extended_data
-00039020: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-00039030: 2069 6620 7363 6920 6973 206e 6f74 204e   if sci is not N
-00039040: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00039050: 2069 7661 725f 6d61 736b 203d 206e 702e   ivar_mask = np.
-00039060: 6f6e 6573 5f6c 696b 6528 7363 6929 0a20  ones_like(sci). 
-00039070: 2020 2020 2020 2020 2020 2069 7661 725f             ivar_
-00039080: 6d61 736b 202a 3d20 6976 6172 0a20 2020  mask *= ivar.   
-00039090: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000390a0: 2020 2020 2020 2073 6369 203d 206e 702e         sci = np.
-000390b0: 6f6e 6573 2873 682c 2064 7479 7065 3d66  ones(sh, dtype=f
-000390c0: 6c6f 6174 290a 2020 2020 2020 2020 2020  loat).          
-000390d0: 2020 6976 6172 5f6d 6173 6b20 3d20 7363    ivar_mask = sc
-000390e0: 692a 310a 0a20 2020 2020 2020 2061 7267  i*1..        arg
-000390f0: 7320 3d20 2873 656c 662c 2070 7366 5f78  s = (self, psf_x
-00039100: 792c 2073 6369 2c20 6976 6172 5f6d 6173  y, sci, ivar_mas
-00039110: 6b2c 2078 702d 7830 2c20 7970 2d79 302c  k, xp-x0, yp-y0,
-00039120: 2065 7874 656e 6465 645f 6461 7461 2c20   extended_data, 
-00039130: 276d 6f64 656c 272c 204e 6f6e 6529 0a20  'model', None). 
-00039140: 2020 2020 2020 206f 7574 7075 745f 7073         output_ps
-00039150: 662c 2062 6b67 2c20 5f61 2c20 5f62 203d  f, bkg, _a, _b =
-00039160: 205f 6f62 6a66 756e 2870 7366 5f70 6172   _objfun(psf_par
-00039170: 616d 732c 202a 6172 6773 290a 0a20 2020  ams, *args)..   
-00039180: 2020 2020 2023 6f75 7470 7574 5f70 7366       #output_psf
-00039190: 203d 2073 656c 662e 6576 616c 5f65 5053   = self.eval_ePS
-000391a0: 4628 7073 665f 7879 2c20 6478 2c20 6479  F(psf_xy, dx, dy
-000391b0: 2c20 6578 7465 6e64 6564 5f64 6174 613d  , extended_data=
-000391c0: 6578 7465 6e64 6564 5f64 6174 6129 2a70  extended_data)*p
-000391d0: 7366 5f70 6172 616d 735b 305d 0a0a 2020  sf_params[0]..  
-000391e0: 2020 2020 2020 6966 2067 6574 5f62 6163        if get_bac
-000391f0: 6b67 726f 756e 643a 0a20 2020 2020 2020  kground:.       
-00039200: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
-00039210: 7574 5f70 7366 2c20 626b 670a 2020 2020  ut_psf, bkg.    
-00039220: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00039230: 2020 2020 2020 7265 7475 726e 206f 7574        return out
-00039240: 7075 745f 7073 660a 0a0a 6465 6620 7265  put_psf...def re
-00039250: 6164 5f63 6174 616c 6f67 2866 696c 652c  ad_catalog(file,
-00039260: 2073 6578 7472 6163 746f 723d 4661 6c73   sextractor=Fals
-00039270: 652c 2066 6f72 6d61 743d 4e6f 6e65 293a  e, format=None):
-00039280: 0a20 2020 2022 2222 0a20 2020 2057 7261  .    """.    Wra
-00039290: 7070 6572 2061 726f 756e 6420 607e 6772  pper around `~gr
-000392a0: 697a 6c69 2e75 7469 6c73 2e47 7461 626c  izli.utils.Gtabl
-000392b0: 652e 6772 6561 6460 2e0a 0a20 2020 2041  e.gread`...    A
-000392c0: 7574 6f2d 6465 7465 6374 7320 666f 726d  uto-detects form
-000392d0: 6174 7320 2763 7376 2720 616e 6420 2766  ats 'csv' and 'f
-000392e0: 6974 7327 2061 6e64 2064 6566 6175 6c74  its' and default
-000392f0: 7320 746f 0a20 2020 2027 6173 6369 692e  s to.    'ascii.
-00039300: 636f 6d6d 656e 7465 645f 6865 6164 6572  commented_header
-00039310: 272e 0a20 2020 2022 2222 0a20 2020 2072  '..    """.    r
-00039320: 6574 7572 6e20 4754 6162 6c65 2e67 7265  eturn GTable.gre
-00039330: 6164 2866 696c 652c 2073 6578 7472 6163  ad(file, sextrac
-00039340: 746f 723d 7365 7874 7261 6374 6f72 2c20  tor=sextractor, 
-00039350: 666f 726d 6174 3d66 6f72 6d61 7429 0a0a  format=format)..
-00039360: 0a63 6c61 7373 2047 5461 626c 6528 6173  .class GTable(as
-00039370: 7472 6f70 792e 7461 626c 652e 5461 626c  tropy.table.Tabl
-00039380: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00039390: 4578 7465 6e64 2060 7e61 7374 726f 7079  Extend `~astropy
-000393a0: 2e74 6162 6c65 2e54 6162 6c65 6020 636c  .table.Table` cl
-000393b0: 6173 7320 7769 7468 206d 6f72 6520 6175  ass with more au
-000393c0: 746f 6d61 7469 6320 494f 2061 6e64 206f  tomatic IO and o
-000393d0: 7468 6572 0a20 2020 2068 656c 7065 7220  ther.    helper 
-000393e0: 6d65 7468 6f64 732e 0a20 2020 2022 2222  methods..    """
-000393f0: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-00039400: 640a 2020 2020 6465 6620 6772 6561 6428  d.    def gread(
-00039410: 636c 732c 2066 696c 652c 2073 6578 7472  cls, file, sextr
-00039420: 6163 746f 723d 4661 6c73 652c 2066 6f72  actor=False, for
-00039430: 6d61 743d 4e6f 6e65 293a 0a20 2020 2020  mat=None):.     
-00039440: 2020 2022 2222 4173 7375 6d65 2060 6173     """Assume `as
-00039450: 6369 692e 636f 6d6d 656e 7465 645f 6865  cii.commented_he
-00039460: 6164 6572 6020 6279 2064 6566 6175 6c74  ader` by default
-00039470: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-00039480: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-00039490: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-000394a0: 7365 7874 7261 6374 6f72 203a 2062 6f6f  sextractor : boo
-000394b0: 6c0a 2020 2020 2020 2020 2020 2020 5573  l.            Us
-000394c0: 6520 6066 6f72 6d61 743d 2761 7363 6969  e `format='ascii
-000394d0: 2e73 6578 7472 6163 746f 7227 602e 0a0a  .sextractor'`...
-000394e0: 2020 2020 2020 2020 666f 726d 6174 203a          format :
-000394f0: 204e 6f6e 6520 6f72 2073 7472 0a20 2020   None or str.   
-00039500: 2020 2020 2020 2020 204f 7665 7272 6964           Overrid
-00039510: 6520 666f 726d 6174 2070 6173 7365 6420  e format passed 
-00039520: 746f 2060 7e61 7374 726f 7079 2e74 6162  to `~astropy.tab
-00039530: 6c65 2e54 6162 6c65 2e72 6561 6460 2e0a  le.Table.read`..
-00039540: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00039550: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00039560: 0a20 2020 2020 2020 2074 6162 203a 2060  .        tab : `
-00039570: 7e61 7374 726f 7079 2e74 6162 6c65 2e54  ~astropy.table.T
-00039580: 6162 6c65 600a 2020 2020 2020 2020 2020  able`.          
-00039590: 2020 5461 626c 6520 6f62 6a65 6374 0a20    Table object. 
-000395a0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000395b0: 2020 2069 6d70 6f72 7420 6173 7472 6f70     import astrop
-000395c0: 792e 756e 6974 7320 6173 2075 0a0a 2020  y.units as u..  
-000395d0: 2020 2020 2020 6966 2066 6f72 6d61 7420        if format 
-000395e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000395f0: 2020 2020 2069 6620 7365 7874 7261 6374       if sextract
-00039600: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00039610: 2020 2020 666f 726d 6174 203d 2027 6173      format = 'as
-00039620: 6369 692e 7365 7874 7261 6374 6f72 270a  cii.sextractor'.
-00039630: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00039640: 2069 7369 6e73 7461 6e63 6528 6669 6c65   isinstance(file
-00039650: 2c20 7079 6669 7473 2e42 696e 5461 626c  , pyfits.BinTabl
-00039660: 6548 4455 293a 0a20 2020 2020 2020 2020  eHDU):.         
-00039670: 2020 2020 2020 2066 6f72 6d61 7420 3d20         format = 
-00039680: 2766 6974 7327 0a20 2020 2020 2020 2020  'fits'.         
-00039690: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000396a0: 2020 2020 2020 2020 2069 6620 6669 6c65           if file
-000396b0: 2e65 6e64 7377 6974 6828 272e 6669 7473  .endswith('.fits
-000396c0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-000396d0: 2020 2020 2020 2020 666f 726d 6174 203d          format =
-000396e0: 2027 6669 7473 270a 2020 2020 2020 2020   'fits'.        
-000396f0: 2020 2020 2020 2020 656c 6966 2066 696c          elif fil
-00039700: 652e 656e 6473 7769 7468 2827 2e63 7376  e.endswith('.csv
-00039710: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00039720: 2020 2020 2020 2020 666f 726d 6174 203d          format =
-00039730: 2027 6373 7627 0a20 2020 2020 2020 2020   'csv'.         
-00039740: 2020 2020 2020 2065 6c69 6620 6669 6c65         elif file
-00039750: 2e65 6e64 7377 6974 6828 272e 766f 7427  .endswith('.vot'
-00039760: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00039770: 2020 2020 2020 2066 6f72 6d61 7420 3d20         format = 
-00039780: 2776 6f74 6162 6c65 270a 2020 2020 2020  'votable'.      
-00039790: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000397a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397b0: 2020 2020 666f 726d 6174 203d 2027 6173      format = 'as
-000397c0: 6369 692e 636f 6d6d 656e 7465 645f 6865  cii.commented_he
-000397d0: 6164 6572 270a 0a20 2020 2020 2020 2023  ader'..        #
-000397e0: 7072 696e 7428 6669 6c65 2c20 666f 726d  print(file, form
-000397f0: 6174 290a 2020 2020 2020 2020 7461 6220  at).        tab 
-00039800: 3d20 636c 732e 7265 6164 2866 696c 652c  = cls.read(file,
-00039810: 2066 6f72 6d61 743d 666f 726d 6174 290a   format=format).
-00039820: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00039830: 7461 620a 0a20 2020 2064 6566 2067 7772  tab..    def gwr
-00039840: 6974 6528 7365 6c66 2c20 6f75 7470 7574  ite(self, output
-00039850: 2c20 666f 726d 6174 3d27 6173 6369 692e  , format='ascii.
-00039860: 636f 6d6d 656e 7465 645f 6865 6164 6572  commented_header
-00039870: 2729 3a0a 2020 2020 2020 2020 2222 2241  '):.        """A
-00039880: 7373 756d 6520 6120 666f 726d 6174 2066  ssume a format f
-00039890: 6f72 2074 6865 206f 7574 7075 7420 7461  or the output ta
-000398a0: 626c 650a 0a20 2020 2020 2020 2050 6172  ble..        Par
-000398b0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-000398c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-000398d0: 2020 206f 7574 7075 7420 3a20 7374 720a     output : str.
-000398e0: 2020 2020 2020 2020 2020 2020 4f75 7470              Outp
-000398f0: 7574 2066 696c 656e 616d 650a 0a20 2020  ut filename..   
-00039900: 2020 2020 2066 6f72 6d61 7420 3a20 7374       format : st
-00039910: 720a 2020 2020 2020 2020 2020 2020 466f  r.            Fo
-00039920: 726d 6174 2073 7472 696e 6720 7061 7373  rmat string pass
-00039930: 6564 2074 6f20 607e 6173 7472 6f70 792e  ed to `~astropy.
-00039940: 7461 626c 652e 5461 626c 652e 7772 6974  table.Table.writ
-00039950: 6560 2e0a 0a20 2020 2020 2020 2022 2222  e`...        """
-00039960: 0a20 2020 2020 2020 2073 656c 662e 7772  .        self.wr
-00039970: 6974 6528 6f75 7470 7574 2c20 666f 726d  ite(output, form
-00039980: 6174 3d66 6f72 6d61 7429 0a0a 2020 2020  at=format)..    
-00039990: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-000399a0: 2020 6465 6620 7061 7273 655f 7261 6465    def parse_rade
-000399b0: 635f 636f 6c75 6d6e 7328 7365 6c66 2c20  c_columns(self, 
-000399c0: 7264 5f70 6169 7273 3d4e 6f6e 6529 3a0a  rd_pairs=None):.
-000399d0: 2020 2020 2020 2020 2222 2250 6172 7365          """Parse
-000399e0: 2063 6f6c 756d 6e20 6e61 6d65 7320 666f   column names fo
-000399f0: 7220 5241 2f44 6563 2061 6e64 2073 6574  r RA/Dec and set
-00039a00: 2074 6f20 607e 6173 7472 6f70 792e 756e   to `~astropy.un
-00039a10: 6974 732e 6465 6772 6565 6020 756e 6974  its.degree` unit
-00039a20: 7320 6966 206e 6f74 2061 6c72 6561 6479  s if not already
-00039a30: 2073 6574 0a0a 2020 2020 2020 2020 5061   set..        Pa
-00039a40: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-00039a50: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00039a60: 2020 2020 7264 5f70 6169 7273 203a 2060      rd_pairs : `
-00039a70: 7e63 6f6c 6c65 6374 696f 6e73 2e4f 7264  ~collections.Ord
-00039a80: 6572 6564 4469 6374 6020 6f72 204e 6f6e  eredDict` or Non
-00039a90: 650a 2020 2020 2020 2020 2020 2020 5061  e.            Pa
-00039aa0: 6972 7320 6f66 207b 7261 3a64 6563 7d20  irs of {ra:dec} 
-00039ab0: 6e61 6d65 7320 746f 2073 6561 7263 6820  names to search 
-00039ac0: 696e 2074 6865 2063 6f6c 756d 6e20 6c69  in the column li
-00039ad0: 7374 2e20 4966 204e 6f6e 652c 0a20 2020  st. If None,.   
-00039ae0: 2020 2020 2020 2020 2074 6865 6e20 7573           then us
-00039af0: 6573 2074 6865 2066 6f6c 6c6f 7769 6e67  es the following
-00039b00: 2062 7920 6465 6661 756c 742e 0a0a 2020   by default...  
-00039b10: 2020 2020 2020 2020 2020 2020 2020 3e3e                >>
-00039b20: 3e20 7264 5f70 6169 7273 203d 204f 7264  > rd_pairs = Ord
-00039b30: 6572 6564 4469 6374 2829 0a20 2020 2020  eredDict().     
-00039b40: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
-00039b50: 645f 7061 6972 735b 2772 6127 5d20 3d20  d_pairs['ra'] = 
-00039b60: 2764 6563 270a 2020 2020 2020 2020 2020  'dec'.          
-00039b70: 2020 2020 2020 3e3e 3e20 7264 5f70 6169        >>> rd_pai
-00039b80: 7273 5b27 414c 5048 415f 4a32 3030 3027  rs['ALPHA_J2000'
-00039b90: 5d20 3d20 2744 454c 5441 5f4a 3230 3030  ] = 'DELTA_J2000
-00039ba0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00039bb0: 2020 3e3e 3e20 7264 5f70 6169 7273 5b27    >>> rd_pairs['
-00039bc0: 585f 574f 524c 4427 5d20 3d20 2759 5f57  X_WORLD'] = 'Y_W
-00039bd0: 4f52 4c44 270a 0a20 2020 2020 2020 2020  ORLD'..         
-00039be0: 2020 204e 423a 2073 6561 7263 6820 6973     NB: search is
-00039bf0: 2070 6572 666f 726d 6564 2069 6e20 6f72   performed in or
-00039c00: 6465 7220 6f66 2060 6072 645f 7061 6972  der of ``rd_pair
-00039c10: 732e 6b65 7973 2829 6060 2061 6e64 2073  s.keys()`` and s
-00039c20: 746f 7073 0a20 2020 2020 2020 2020 2020  tops.           
-00039c30: 2069 662f 7768 656e 2061 206d 6174 6368   if/when a match
-00039c40: 2069 7320 666f 756e 642e 0a0a 2020 2020   is found...    
-00039c50: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00039c60: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00039c70: 2020 2020 7264 5f70 6169 7220 3a20 5b73      rd_pair : [s
-00039c80: 7472 2c20 7374 725d 0a20 2020 2020 2020  tr, str].       
-00039c90: 2020 2020 2043 6f6c 756d 6e20 6e61 6d65       Column name
-00039ca0: 7320 6173 736f 6369 6174 6564 2077 6974  s associated wit
-00039cb0: 6820 5241 2f44 6563 2e20 2052 6574 7572  h RA/Dec.  Retur
-00039cc0: 6e73 2046 616c 7365 2069 6620 6e6f 2063  ns False if no c
-00039cd0: 6f6c 756d 6e0a 2020 2020 2020 2020 2020  olumn.          
-00039ce0: 2020 7061 6972 7320 666f 756e 6420 6261    pairs found ba
-00039cf0: 7365 6420 6f6e 2060 7264 5f70 6169 7273  sed on `rd_pairs
-00039d00: 602e 0a0a 2020 2020 2020 2020 2222 220a  `...        """.
-00039d10: 2020 2020 2020 2020 6672 6f6d 2063 6f6c          from col
-00039d20: 6c65 6374 696f 6e73 2069 6d70 6f72 7420  lections import 
-00039d30: 4f72 6465 7265 6444 6963 740a 2020 2020  OrderedDict.    
-00039d40: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
-00039d50: 7079 2e75 6e69 7473 2061 7320 750a 0a20  py.units as u.. 
-00039d60: 2020 2020 2020 2069 6620 7264 5f70 6169         if rd_pai
-00039d70: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
-00039d80: 2020 2020 2020 2020 7264 5f70 6169 7273          rd_pairs
-00039d90: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
-00039da0: 0a20 2020 2020 2020 2020 2020 2072 645f  .            rd_
-00039db0: 7061 6972 735b 2752 4127 5d20 3d20 2744  pairs['RA'] = 'D
-00039dc0: 4543 270a 2020 2020 2020 2020 2020 2020  EC'.            
-00039dd0: 7264 5f70 6169 7273 5b27 414c 5048 415f  rd_pairs['ALPHA_
-00039de0: 4a32 3030 3027 5d20 3d20 2744 454c 5441  J2000'] = 'DELTA
-00039df0: 5f4a 3230 3030 270a 2020 2020 2020 2020  _J2000'.        
-00039e00: 2020 2020 7264 5f70 6169 7273 5b27 585f      rd_pairs['X_
-00039e10: 574f 524c 4427 5d20 3d20 2759 5f57 4f52  WORLD'] = 'Y_WOR
-00039e20: 4c44 270a 2020 2020 2020 2020 2020 2020  LD'.            
-00039e30: 7264 5f70 6169 7273 5b27 414c 5048 415f  rd_pairs['ALPHA_
-00039e40: 534b 5927 5d20 3d20 2744 454c 5441 5f53  SKY'] = 'DELTA_S
-00039e50: 4b59 270a 2020 2020 2020 2020 2020 2020  KY'.            
-00039e60: 7264 5f70 6169 7273 5b27 5f52 414a 3230  rd_pairs['_RAJ20
-00039e70: 3030 275d 203d 2027 5f44 454a 3230 3030  00'] = '_DEJ2000
-00039e80: 270a 0a20 2020 2020 2020 2020 2020 2066  '..            f
-00039e90: 6f72 206b 2069 6e20 6c69 7374 2872 645f  or k in list(rd_
-00039ea0: 7061 6972 732e 6b65 7973 2829 293a 0a20  pairs.keys()):. 
-00039eb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00039ec0: 645f 7061 6972 735b 6b2e 6c6f 7765 7228  d_pairs[k.lower(
-00039ed0: 295d 203d 2072 645f 7061 6972 735b 6b5d  )] = rd_pairs[k]
-00039ee0: 2e6c 6f77 6572 2829 0a0a 2020 2020 2020  .lower()..      
-00039ef0: 2020 7264 5f70 6169 7220 3d20 4e6f 6e65    rd_pair = None
-00039f00: 0a20 2020 2020 2020 2066 6f72 2063 2069  .        for c i
-00039f10: 6e20 7264 5f70 6169 7273 3a0a 2020 2020  n rd_pairs:.    
-00039f20: 2020 2020 2020 2020 6966 2063 2069 6e20          if c in 
-00039f30: 7365 6c66 2e63 6f6c 6e61 6d65 733a 0a20  self.colnames:. 
-00039f40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00039f50: 645f 7061 6972 203d 205b 632c 2072 645f  d_pair = [c, rd_
-00039f60: 7061 6972 735b 635d 5d0a 2020 2020 2020  pairs[c]].      
-00039f70: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00039f80: 0a20 2020 2020 2020 2069 6620 7264 5f70  .        if rd_p
-00039f90: 6169 7220 6973 204e 6f6e 653a 0a20 2020  air is None:.   
-00039fa0: 2020 2020 2020 2020 2023 7072 696e 7428           #print(
-00039fb0: 274e 6f20 5241 2f44 6563 2e20 636f 6c75  'No RA/Dec. colu
-00039fc0: 6d6e 7320 666f 756e 6420 696e 2069 6e70  mns found in inp
-00039fd0: 7574 2074 6162 6c65 2e27 290a 2020 2020  ut table.').    
-00039fe0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00039ff0: 616c 7365 0a0a 2020 2020 2020 2020 666f  alse..        fo
-0003a000: 7220 6320 696e 2072 645f 7061 6972 3a0a  r c in rd_pair:.
-0003a010: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0003a020: 656c 665b 635d 2e75 6e69 7420 6973 204e  elf[c].unit is N
-0003a030: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003a040: 2020 2020 2073 656c 665b 635d 2e75 6e69       self[c].uni
-0003a050: 7420 3d20 752e 6465 6772 6565 0a0a 2020  t = u.degree..  
-0003a060: 2020 2020 2020 7265 7475 726e 2072 645f        return rd_
-0003a070: 7061 6972 0a0a 2020 2020 6465 6620 6d61  pair..    def ma
-0003a080: 7463 685f 746f 5f63 6174 616c 6f67 5f73  tch_to_catalog_s
-0003a090: 6b79 2873 656c 662c 206f 7468 6572 2c20  ky(self, other, 
-0003a0a0: 7365 6c66 5f72 6164 6563 3d4e 6f6e 652c  self_radec=None,
-0003a0b0: 206f 7468 6572 5f72 6164 6563 3d4e 6f6e   other_radec=Non
-0003a0c0: 652c 206e 7468 6e65 6967 6862 6f72 3d31  e, nthneighbor=1
-0003a0d0: 2c20 6765 745f 3264 5f6f 6666 7365 743d  , get_2d_offset=
-0003a0e0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-0003a0f0: 2222 2243 6f6d 7075 7465 2060 7e61 7374  """Compute `~ast
-0003a100: 726f 7079 2e63 6f6f 7264 696e 6174 6573  ropy.coordinates
-0003a110: 2e53 6b79 436f 6f72 6460 2070 726f 6a65  .SkyCoord` proje
-0003a120: 6374 6564 206d 6174 6368 6573 2062 6574  cted matches bet
-0003a130: 7765 656e 2074 776f 2060 4754 6162 6c65  ween two `GTable
-0003a140: 6020 7461 626c 6573 2e0a 0a20 2020 2020  ` tables...     
-0003a150: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0003a160: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-0003a170: 0a20 2020 2020 2020 206f 7468 6572 203a  .        other :
-0003a180: 2060 7e61 7374 726f 7079 2e74 6162 6c65   `~astropy.table
-0003a190: 2e54 6162 6c65 602c 2060 4754 6162 6c65  .Table`, `GTable
-0003a1a0: 602c 206f 7220 606c 6973 7460 2e0a 2020  `, or `list`..  
-0003a1b0: 2020 2020 2020 2020 2020 4f74 6865 7220            Other 
-0003a1c0: 7461 626c 6520 746f 206d 6174 6368 2070  table to match p
-0003a1d0: 6f73 6974 696f 6e73 2066 726f 6d2e 0a0a  ositions from...
-0003a1e0: 2020 2020 2020 2020 7365 6c66 5f72 6164          self_rad
-0003a1f0: 6563 2c20 6f74 6865 725f 7261 6465 6320  ec, other_radec 
-0003a200: 3a20 4e6f 6e65 206f 7220 5b73 7472 2c20  : None or [str, 
-0003a210: 7374 725d 0a20 2020 2020 2020 2020 2020  str].           
-0003a220: 2043 6f6c 756d 6e20 6e61 6d65 7320 666f   Column names fo
-0003a230: 7220 5241 2061 6e64 2044 6563 2e20 2049  r RA and Dec.  I
-0003a240: 6620 4e6f 6e65 2c20 7468 656e 2074 7279  f None, then try
-0003a250: 2074 6865 2066 6f6c 6c6f 7769 6e67 0a20   the following. 
-0003a260: 2020 2020 2020 2020 2020 2070 6169 7273             pairs
-0003a270: 2028 696e 2074 6869 7320 6f72 6465 7229   (in this order)
-0003a280: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
-0003a290: 2020 203e 3e3e 2072 645f 7061 6972 7320     >>> rd_pairs 
-0003a2a0: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
-0003a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a2c0: 3e3e 3e20 7264 5f70 6169 7273 5b27 7261  >>> rd_pairs['ra
-0003a2d0: 275d 203d 2027 6465 6327 0a20 2020 2020  '] = 'dec'.     
-0003a2e0: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
-0003a2f0: 645f 7061 6972 735b 2741 4c50 4841 5f4a  d_pairs['ALPHA_J
-0003a300: 3230 3030 275d 203d 2027 4445 4c54 415f  2000'] = 'DELTA_
-0003a310: 4a32 3030 3027 0a20 2020 2020 2020 2020  J2000'.         
-0003a320: 2020 2020 2020 203e 3e3e 2072 645f 7061         >>> rd_pa
-0003a330: 6972 735b 2758 5f57 4f52 4c44 275d 203d  irs['X_WORLD'] =
-0003a340: 2027 595f 574f 524c 4427 0a0a 2020 2020   'Y_WORLD'..    
-0003a350: 2020 2020 6e74 686e 6569 6768 626f 7220      nthneighbor 
-0003a360: 3a20 696e 740a 2020 2020 2020 2020 2020  : int.          
-0003a370: 2020 5365 6520 607e 6173 7472 6f70 792e    See `~astropy.
-0003a380: 636f 6f72 6469 6e61 7465 732e 536b 7943  coordinates.SkyC
-0003a390: 6f6f 7264 2e63 6f6f 2e6d 6174 6368 5f74  oord.coo.match_t
-0003a3a0: 6f5f 6361 7461 6c6f 675f 736b 7960 2e0a  o_catalog_sky`..
-0003a3b0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0003a3c0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0003a3d0: 0a20 2020 2020 2020 2069 6478 203a 2069  .        idx : i
-0003a3e0: 6e74 2061 7272 6179 0a20 2020 2020 2020  nt array.       
-0003a3f0: 2020 2020 2049 6e64 6963 6573 206f 6620       Indices of 
-0003a400: 7468 6520 6d61 7463 6865 7320 6173 2069  the matches as i
-0003a410: 6e0a 0a20 2020 2020 2020 2020 2020 2020  n..             
-0003a420: 2020 203e 3e3e 206d 6174 6368 6564 203d     >>> matched =
-0003a430: 2073 656c 665b 6964 785d 0a20 2020 2020   self[idx].     
-0003a440: 2020 2020 2020 2020 2020 203e 3e3e 206c             >>> l
-0003a450: 656e 286d 6174 6368 6564 2920 3d3d 206c  en(matched) == l
-0003a460: 656e 286f 7468 6572 290a 0a20 2020 2020  en(other)..     
-0003a470: 2020 2064 7220 3a20 666c 6f61 7420 6172     dr : float ar
-0003a480: 7261 790a 2020 2020 2020 2020 2020 2020  ray.            
-0003a490: 5072 6f6a 6563 7465 6420 7365 7061 7261  Projected separa
-0003a4a0: 7469 6f6e 206f 6620 636c 6f73 6573 7420  tion of closest 
-0003a4b0: 6d61 7463 682e 0a0a 2020 2020 2020 2020  match...        
-0003a4c0: 4578 616d 706c 6573 0a20 2020 2020 2020  Examples.       
-0003a4d0: 202d 2d2d 2d2d 2d2d 2d0a 0a20 2020 2020   --------..     
-0003a4e0: 2020 2020 2020 2020 2020 203e 3e3e 2069             >>> i
-0003a4f0: 6d70 6f72 7420 6173 7472 6f70 792e 756e  mport astropy.un
-0003a500: 6974 7320 6173 2075 0a0a 2020 2020 2020  its as u..      
-0003a510: 2020 2020 2020 2020 2020 3e3e 3e20 7265            >>> re
-0003a520: 6620 3d20 4754 6162 6c65 2e67 7265 6164  f = GTable.gread
-0003a530: 2827 696e 7075 742e 6361 7427 290a 2020  ('input.cat').  
-0003a540: 2020 2020 2020 2020 2020 2020 2020 3e3e                >>
-0003a550: 3e20 6761 6961 203d 2047 5461 626c 652e  > gaia = GTable.
-0003a560: 6772 6561 6428 2767 6169 612e 6361 7427  gread('gaia.cat'
-0003a570: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003a580: 2020 3e3e 3e20 6964 782c 2064 7220 3d20    >>> idx, dr = 
-0003a590: 7265 662e 6d61 7463 685f 746f 5f63 6174  ref.match_to_cat
-0003a5a0: 616c 6f67 5f73 6b79 2867 6169 6129 0a20  alog_sky(gaia). 
-0003a5b0: 2020 2020 2020 2020 2020 2020 2020 203e                 >
-0003a5c0: 3e3e 2063 6c6f 7365 203d 2064 7220 3c20  >> close = dr < 
-0003a5d0: 312a 752e 6172 6373 6563 0a0a 2020 2020  1*u.arcsec..    
-0003a5e0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-0003a5f0: 7265 665f 6d61 7463 6820 3d20 7265 665b  ref_match = ref[
-0003a600: 6964 785d 5b63 6c6f 7365 5d0a 2020 2020  idx][close].    
-0003a610: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-0003a620: 6761 6961 5f6d 6174 6368 203d 2067 6169  gaia_match = gai
-0003a630: 615b 636c 6f73 655d 0a0a 2020 2020 2020  a[close]..      
-0003a640: 2020 2222 220a 2020 2020 2020 2020 6672    """.        fr
-0003a650: 6f6d 2061 7374 726f 7079 2e63 6f6f 7264  om astropy.coord
-0003a660: 696e 6174 6573 2069 6d70 6f72 7420 536b  inates import Sk
-0003a670: 7943 6f6f 7264 0a0a 2020 2020 2020 2020  yCoord..        
-0003a680: 6966 2073 656c 665f 7261 6465 6320 6973  if self_radec is
-0003a690: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003a6a0: 2020 2072 6420 3d20 7365 6c66 2e70 6172     rd = self.par
-0003a6b0: 7365 5f72 6164 6563 5f63 6f6c 756d 6e73  se_radec_columns
-0003a6c0: 2873 656c 6629 0a20 2020 2020 2020 2065  (self).        e
-0003a6d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003a6e0: 2072 6420 3d20 7365 6c66 2e70 6172 7365   rd = self.parse
-0003a6f0: 5f72 6164 6563 5f63 6f6c 756d 6e73 2873  _radec_columns(s
-0003a700: 656c 662c 2072 645f 7061 6972 733d 7b73  elf, rd_pairs={s
-0003a710: 656c 665f 7261 6465 635b 305d 3a20 7365  elf_radec[0]: se
-0003a720: 6c66 5f72 6164 6563 5b31 5d7d 290a 0a20  lf_radec[1]}).. 
-0003a730: 2020 2020 2020 2069 6620 7264 2069 7320         if rd is 
-0003a740: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-0003a750: 2020 2070 7269 6e74 2827 4e6f 2052 412f     print('No RA/
-0003a760: 4465 632e 2063 6f6c 756d 6e73 2066 6f75  Dec. columns fou
-0003a770: 6e64 2069 6e20 696e 7075 7420 7461 626c  nd in input tabl
-0003a780: 652e 2729 0a20 2020 2020 2020 2020 2020  e.').           
-0003a790: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-0003a7a0: 2020 2020 2020 2073 656c 665f 636f 6f20         self_coo 
-0003a7b0: 3d20 536b 7943 6f6f 7264 2872 613d 7365  = SkyCoord(ra=se
-0003a7c0: 6c66 5b72 645b 305d 5d2c 2064 6563 3d73  lf[rd[0]], dec=s
-0003a7d0: 656c 665b 7264 5b31 5d5d 2c20 0a20 2020  elf[rd[1]], .   
-0003a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a7f0: 2020 2020 2020 2020 2066 7261 6d65 3d27           frame='
-0003a800: 6963 7273 2729 0a0a 2020 2020 2020 2020  icrs')..        
-0003a810: 6966 2069 7369 6e73 7461 6e63 6528 6f74  if isinstance(ot
-0003a820: 6865 722c 206c 6973 7429 207c 2069 7369  her, list) | isi
-0003a830: 6e73 7461 6e63 6528 6f74 6865 722c 2074  nstance(other, t
-0003a840: 7570 6c65 293a 0a20 2020 2020 2020 2020  uple):.         
-0003a850: 2020 2072 6420 3d20 5b73 6c69 6365 2830     rd = [slice(0
-0003a860: 2c20 3129 2c20 736c 6963 6528 312c 2032  , 1), slice(1, 2
-0003a870: 295d 0a0a 2020 2020 2020 2020 656c 7365  )]..        else
-0003a880: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0003a890: 206f 7468 6572 5f72 6164 6563 2069 7320   other_radec is 
-0003a8a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003a8b0: 2020 2020 2020 7264 203d 2073 656c 662e        rd = self.
-0003a8c0: 7061 7273 655f 7261 6465 635f 636f 6c75  parse_radec_colu
-0003a8d0: 6d6e 7328 6f74 6865 7229 0a20 2020 2020  mns(other).     
-0003a8e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003a8f0: 2020 2020 2020 2020 2020 2020 2072 6420               rd 
-0003a900: 3d20 7365 6c66 2e70 6172 7365 5f72 6164  = self.parse_rad
-0003a910: 6563 5f63 6f6c 756d 6e73 286f 7468 6572  ec_columns(other
-0003a920: 2c20 7264 5f70 6169 7273 3d7b 6f74 6865  , rd_pairs={othe
-0003a930: 725f 7261 6465 635b 305d 3a20 6f74 6865  r_radec[0]: othe
-0003a940: 725f 7261 6465 635b 315d 7d29 0a0a 2020  r_radec[1]})..  
-0003a950: 2020 2020 2020 2020 2020 6966 2072 6420            if rd 
-0003a960: 6973 2046 616c 7365 3a0a 2020 2020 2020  is False:.      
-0003a970: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0003a980: 274e 6f20 5241 2f44 6563 2e20 636f 6c75  'No RA/Dec. colu
-0003a990: 6d6e 7320 666f 756e 6420 696e 2060 6f74  mns found in `ot
-0003a9a0: 6865 7260 2074 6162 6c65 2e27 290a 2020  her` table.').  
-0003a9b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0003a9c0: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-0003a9d0: 2020 2020 6f74 6865 725f 636f 6f20 3d20      other_coo = 
-0003a9e0: 536b 7943 6f6f 7264 2872 613d 6f74 6865  SkyCoord(ra=othe
-0003a9f0: 725b 7264 5b30 5d5d 2c20 6465 633d 6f74  r[rd[0]], dec=ot
-0003aa00: 6865 725b 7264 5b31 5d5d 2c0a 2020 2020  her[rd[1]],.    
-0003aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa20: 2020 2020 2020 2020 2066 7261 6d65 3d27           frame='
-0003aa30: 6963 7273 2729 0a0a 2020 2020 2020 2020  icrs')..        
-0003aa40: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0003aa50: 2069 6478 2c20 6432 642c 2064 3364 203d   idx, d2d, d3d =
-0003aa60: 206f 7468 6572 5f63 6f6f 2e6d 6174 6368   other_coo.match
-0003aa70: 5f74 6f5f 6361 7461 6c6f 675f 736b 7928  _to_catalog_sky(
-0003aa80: 7365 6c66 5f63 6f6f 2c20 6e74 686e 6569  self_coo, nthnei
-0003aa90: 6768 626f 723d 6e74 686e 6569 6768 626f  ghbor=nthneighbo
-0003aaa0: 7229 0a20 2020 2020 2020 2065 7863 6570  r).        excep
-0003aab0: 743a 0a20 2020 2020 2020 2020 2020 2070  t:.            p
-0003aac0: 7269 6e74 2827 436f 756c 646e 5c27 7420  rint('Couldn\'t 
-0003aad0: 7275 6e20 536b 7943 6f6f 7264 2e6d 6174  run SkyCoord.mat
-0003aae0: 6368 5f74 6f5f 6361 7461 6c6f 675f 736b  ch_to_catalog_sk
-0003aaf0: 7920 7769 7468 270a 2020 2020 2020 2020  y with'.        
-0003ab00: 2020 2020 2020 2020 2020 276e 7468 6e65            'nthne
-0003ab10: 6967 6862 6f72 2729 0a0a 2020 2020 2020  ighbor')..      
-0003ab20: 2020 2020 2020 6964 782c 2064 3264 2c20        idx, d2d, 
-0003ab30: 6433 6420 3d20 6f74 6865 725f 636f 6f2e  d3d = other_coo.
-0003ab40: 6d61 7463 685f 746f 5f63 6174 616c 6f67  match_to_catalog
-0003ab50: 5f73 6b79 2873 656c 665f 636f 6f29 0a20  _sky(self_coo). 
-0003ab60: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0003ab70: 6966 2067 6574 5f32 645f 6f66 6673 6574  if get_2d_offset
-0003ab80: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-0003ab90: 7364 203d 206e 702e 636f 7328 7365 6c66  sd = np.cos(self
-0003aba0: 5f63 6f6f 2e64 6563 2e64 6567 2f31 3830  _coo.dec.deg/180
-0003abb0: 2a6e 702e 7069 290a 2020 2020 2020 2020  *np.pi).        
-0003abc0: 2020 2020 6472 6120 3d20 286f 7468 6572      dra = (other
-0003abd0: 5f63 6f6f 2e72 612e 6465 6720 2d20 7365  _coo.ra.deg - se
-0003abe0: 6c66 5f63 6f6f 2e72 612e 6465 675b 6964  lf_coo.ra.deg[id
-0003abf0: 785d 292a 636f 7364 5b69 6478 5d0a 2020  x])*cosd[idx].  
-0003ac00: 2020 2020 2020 2020 2020 6464 6520 3d20            dde = 
-0003ac10: 286f 7468 6572 5f63 6f6f 2e64 6563 2e64  (other_coo.dec.d
-0003ac20: 6567 202d 2073 656c 665f 636f 6f2e 6465  eg - self_coo.de
-0003ac30: 632e 6465 675b 6964 785d 290a 2020 2020  c.deg[idx]).    
-0003ac40: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-0003ac50: 6478 2c20 6432 642e 746f 2875 2e61 7263  dx, d2d.to(u.arc
-0003ac60: 7365 6329 2c20 6472 612a 3336 3030 2a75  sec), dra*3600*u
-0003ac70: 2e61 7263 7365 632c 2064 6465 2a33 3630  .arcsec, dde*360
-0003ac80: 302a 752e 6172 6373 6563 0a20 2020 2020  0*u.arcsec.     
-0003ac90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003aca0: 2020 2020 2072 6574 7572 6e20 6964 782c       return idx,
-0003acb0: 2064 3264 2e74 6f28 752e 6172 6373 6563   d2d.to(u.arcsec
-0003acc0: 290a 0a20 2020 2064 6566 206d 6174 6368  )..    def match
-0003acd0: 5f74 7269 616e 676c 6573 2873 656c 662c  _triangles(self,
-0003ace0: 206f 7468 6572 2c20 7365 6c66 5f77 6373   other, self_wcs
-0003acf0: 3d4e 6f6e 652c 2078 5f63 6f6c 756d 6e3d  =None, x_column=
-0003ad00: 2758 5f49 4d41 4745 272c 2079 5f63 6f6c  'X_IMAGE', y_col
-0003ad10: 756d 6e3d 2759 5f49 4d41 4745 272c 206d  umn='Y_IMAGE', m
-0003ad20: 6167 5f63 6f6c 756d 6e3d 274d 4147 5f41  ag_column='MAG_A
-0003ad30: 5554 4f27 2c20 6f74 6865 725f 7261 3d27  UTO', other_ra='
-0003ad40: 585f 574f 524c 4427 2c20 6f74 6865 725f  X_WORLD', other_
-0003ad50: 6465 633d 2759 5f57 4f52 4c44 272c 2070  dec='Y_WORLD', p
-0003ad60: 6978 656c 5f69 6e64 6578 3d31 2c20 6d61  ixel_index=1, ma
-0003ad70: 7463 685f 6b77 6172 6773 3d7b 7d2c 2070  tch_kwargs={}, p
-0003ad80: 6164 3d31 3030 2c20 7368 6f77 5f64 6961  ad=100, show_dia
-0003ad90: 676e 6f73 7469 633d 4661 6c73 652c 2061  gnostic=False, a
-0003ada0: 7574 6f5f 6b65 6570 3d33 2c20 6d61 784b  uto_keep=3, maxK
-0003adb0: 6565 703d 3130 2c20 6175 746f 5f6c 696d  eep=10, auto_lim
-0003adc0: 6974 3d33 2c20 6261 5f6d 6178 3d30 2e39  it=3, ba_max=0.9
-0003add0: 392c 2073 6361 6c65 5f64 656e 7369 7479  9, scale_density
-0003ade0: 3d31 3029 3a0a 2020 2020 2020 2020 2222  =10):.        ""
-0003adf0: 220a 0a20 2020 2020 2020 2078 5f63 6f6c  "..        x_col
-0003ae00: 756d 6e20 3d20 2758 5f49 4d41 4745 270a  umn = 'X_IMAGE'.
-0003ae10: 2020 2020 2020 2020 795f 636f 6c75 6d6e          y_column
-0003ae20: 203d 2027 595f 494d 4147 4527 0a20 2020   = 'Y_IMAGE'.   
-0003ae30: 2020 2020 206d 6167 5f63 6f6c 756d 6e20       mag_column 
-0003ae40: 3d20 274d 4147 5f41 5554 4f27 0a20 2020  = 'MAG_AUTO'.   
-0003ae50: 2020 2020 2070 6978 656c 5f69 6e64 6578       pixel_index
-0003ae60: 3d31 0a20 2020 2020 2020 2070 6164 3d31  =1.        pad=1
-0003ae70: 3030 0a0a 2020 2020 2020 2020 6175 746f  00..        auto
-0003ae80: 5f6b 6565 703d 330a 2020 2020 2020 2020  _keep=3.        
-0003ae90: 6d61 784b 6565 703d 3130 0a20 2020 2020  maxKeep=10.     
-0003aea0: 2020 2061 7574 6f5f 6c69 6d69 743d 330a     auto_limit=3.
-0003aeb0: 2020 2020 2020 2020 6261 5f6d 6178 203d          ba_max =
-0003aec0: 2030 2e39 390a 0a20 2020 2020 2020 2022   0.99..        "
-0003aed0: 2222 0a20 2020 2020 2020 2066 726f 6d20  "".        from 
-0003aee0: 7472 6973 7461 7273 2069 6d70 6f72 7420  tristars import 
-0003aef0: 6d61 7463 680a 0a20 2020 2020 2020 2069  match..        i
-0003af00: 6620 6861 7361 7474 7228 6f74 6865 722c  f hasattr(other,
-0003af10: 2027 7368 6170 6527 293a 0a20 2020 2020   'shape'):.     
-0003af20: 2020 2020 2020 206f 7468 6572 5f72 6164         other_rad
-0003af30: 6563 203d 206f 7468 6572 2a31 2e0a 2020  ec = other*1..  
-0003af40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0003af50: 2020 2020 2020 2020 6f74 6865 725f 7261          other_ra
-0003af60: 6465 6320 3d20 6e70 2e61 7272 6179 285b  dec = np.array([
-0003af70: 6f74 6865 725b 6f74 6865 725f 7261 5d2c  other[other_ra],
-0003af80: 206f 7468 6572 5b6f 7468 6572 5f64 6563   other[other_dec
-0003af90: 5d5d 292e 540a 0a20 2020 2020 2020 2073  ]]).T..        s
-0003afa0: 656c 665f 7879 203d 206e 702e 6172 7261  elf_xy = np.arra
-0003afb0: 7928 5b73 656c 665b 785f 636f 6c75 6d6e  y([self[x_column
-0003afc0: 5d2c 2073 656c 665b 795f 636f 6c75 6d6e  ], self[y_column
-0003afd0: 5d5d 292e 540a 0a20 2020 2020 2020 2023  ]]).T..        #
-0003afe0: 7879 5f64 727a 203d 206e 702e 6172 7261  xy_drz = np.arra
-0003aff0: 7928 5b63 6174 5b27 585f 494d 4147 4527  y([cat['X_IMAGE'
-0003b000: 5d5b 6f6b 5d2c 2063 6174 5b27 595f 494d  ][ok], cat['Y_IM
-0003b010: 4147 4527 5d5b 6f6b 5d5d 292e 540a 0a20  AGE'][ok]]).T.. 
-0003b020: 2020 2020 2020 2069 6620 7365 6c66 5f77         if self_w
-0003b030: 6373 2069 7320 4e6f 6e65 3a0a 2020 2020  cs is None:.    
-0003b040: 2020 2020 2020 2020 6f74 6865 725f 7879          other_xy
-0003b050: 203d 206f 7468 6572 5f72 6164 6563 0a20   = other_radec. 
-0003b060: 2020 2020 2020 2020 2020 2063 7574 203d             cut =
-0003b070: 2028 6f74 6865 725f 7879 5b3a 2c20 305d   (other_xy[:, 0]
-0003b080: 203e 202d 7061 6429 2026 2028 6f74 6865   > -pad) & (othe
-0003b090: 725f 7879 5b3a 2c20 305d 203c 2073 656c  r_xy[:, 0] < sel
-0003b0a0: 665f 7879 5b3a 2c20 305d 2e6d 6178 2829  f_xy[:, 0].max()
-0003b0b0: 2b70 6164 2920 2620 286f 7468 6572 5f78  +pad) & (other_x
-0003b0c0: 795b 3a2c 2031 5d20 3e20 2d70 6164 2920  y[:, 1] > -pad) 
-0003b0d0: 2620 286f 7468 6572 5f78 795b 3a2c 2030  & (other_xy[:, 0
-0003b0e0: 5d20 3c20 7365 6c66 5f78 795b 3a2c 2031  ] < self_xy[:, 1
-0003b0f0: 5d2e 6d61 7828 292b 7061 6429 0a20 2020  ].max()+pad).   
-0003b100: 2020 2020 2020 2020 206f 7468 6572 5f78           other_x
-0003b110: 7920 3d20 6f74 6865 725f 7879 5b63 7574  y = other_xy[cut
-0003b120: 2c20 3a5d 0a0a 2020 2020 2020 2020 2020  , :]..          
-0003b130: 2020 7879 5f63 656e 7465 7220 3d20 6e70    xy_center = np
-0003b140: 2e7a 6572 6f73 2832 290a 0a20 2020 2020  .zeros(2)..     
-0003b150: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003b160: 2020 2020 206f 7468 6572 5f78 7920 3d20       other_xy = 
-0003b170: 7365 6c66 5f77 6373 2e61 6c6c 5f77 6f72  self_wcs.all_wor
-0003b180: 6c64 3270 6978 286f 7468 6572 5f72 6164  ld2pix(other_rad
-0003b190: 6563 2c20 7069 7865 6c5f 696e 6465 7829  ec, pixel_index)
-0003b1a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003b1b0: 6861 7361 7474 7228 7365 6c66 5f77 6373  hasattr(self_wcs
-0003b1c0: 2c20 2770 6978 656c 5f73 6861 7065 2729  , 'pixel_shape')
-0003b1d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003b1e0: 2020 5f6e 6178 6973 312c 205f 6e61 7869    _naxis1, _naxi
-0003b1f0: 7332 203d 2073 656c 665f 7763 732e 5f6e  s2 = self_wcs._n
-0003b200: 6178 6973 0a20 2020 2020 2020 2020 2020  axis.           
-0003b210: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003b220: 2020 2020 2020 205f 6e61 7869 7331 2c20         _naxis1, 
-0003b230: 5f6e 6178 6973 3220 3d20 7365 6c66 5f77  _naxis2 = self_w
-0003b240: 6373 2e5f 6e61 7869 7331 2c20 7365 6c66  cs._naxis1, self
-0003b250: 5f77 6373 2e5f 6e61 7869 7332 0a0a 2020  _wcs._naxis2..  
-0003b260: 2020 2020 2020 2020 2020 6375 7420 3d20            cut = 
-0003b270: 286f 7468 6572 5f78 795b 3a2c 2030 5d20  (other_xy[:, 0] 
-0003b280: 3e20 2d70 6164 2920 2620 286f 7468 6572  > -pad) & (other
-0003b290: 5f78 795b 3a2c 2030 5d20 3c20 5f6e 6178  _xy[:, 0] < _nax
-0003b2a0: 6973 312b 7061 6429 0a20 2020 2020 2020  is1+pad).       
-0003b2b0: 2020 2020 2063 7574 2026 3d20 286f 7468       cut &= (oth
-0003b2c0: 6572 5f78 795b 3a2c 2031 5d20 3e20 2d70  er_xy[:, 1] > -p
-0003b2d0: 6164 2920 2620 286f 7468 6572 5f78 795b  ad) & (other_xy[
-0003b2e0: 3a2c 2031 5d20 3c20 5f6e 6178 6973 322b  :, 1] < _naxis2+
-0003b2f0: 7061 6429 0a0a 2020 2020 2020 2020 2020  pad)..          
-0003b300: 2020 6f74 6865 725f 7879 203d 206f 7468    other_xy = oth
-0003b310: 6572 5f78 795b 6375 742c 203a 5d0a 2020  er_xy[cut, :].  
-0003b320: 2020 2020 2020 2020 2020 7879 5f63 656e            xy_cen
-0003b330: 7465 7220 3d20 7365 6c66 5f77 6373 2e77  ter = self_wcs.w
-0003b340: 6373 2e63 7270 6978 2a31 0a0a 2020 2020  cs.crpix*1..    
-0003b350: 2020 2020 6966 206c 656e 286f 7468 6572      if len(other
-0003b360: 5f78 7929 203c 2033 3a0a 2020 2020 2020  _xy) < 3:.      
-0003b370: 2020 2020 2020 7072 696e 7428 274e 6f74        print('Not
-0003b380: 2065 6e6f 7567 6820 736f 7572 6365 7320   enough sources 
-0003b390: 696e 206d 6174 6368 2063 6174 616c 6f67  in match catalog
-0003b3a0: 2729 0a20 2020 2020 2020 2020 2020 2072  ').            r
-0003b3b0: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-0003b3c0: 2020 2020 2073 656c 665f 7879 202d 3d20       self_xy -= 
-0003b3d0: 7879 5f63 656e 7465 720a 2020 2020 2020  xy_center.      
-0003b3e0: 2020 6f74 6865 725f 7879 202d 3d20 7879    other_xy -= xy
-0003b3f0: 5f63 656e 7465 720a 0a20 2020 2020 2020  _center..       
-0003b400: 2023 2323 2323 2323 230a 2020 2020 2020   ########.      
-0003b410: 2020 2320 4d61 7463 6820 7375 7266 6163    # Match surfac
-0003b420: 6520 6465 6e73 6974 7920 6f66 2064 7269  e density of dri
-0003b430: 7a7a 6c65 6420 616e 6420 7265 6665 7265  zzled and refere
-0003b440: 6e63 6520 6361 7461 6c6f 6773 0a20 2020  nce catalogs.   
-0003b450: 2020 2020 2069 6620 6d61 675f 636f 6c75       if mag_colu
-0003b460: 6d6e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  mn is not None:.
-0003b470: 2020 2020 2020 2020 2020 2020 6963 7574              icut
-0003b480: 203d 206e 702e 6d69 6e69 6d75 6d28 6c65   = np.minimum(le
-0003b490: 6e28 7365 6c66 292d 322c 2069 6e74 2873  n(self)-2, int(s
-0003b4a0: 6361 6c65 5f64 656e 7369 7479 2a6f 7468  cale_density*oth
-0003b4b0: 6572 5f78 792e 7368 6170 655b 305d 2929  er_xy.shape[0]))
-0003b4c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0003b4d0: 665f 6978 203d 206e 702e 6172 6773 6f72  f_ix = np.argsor
-0003b4e0: 7428 7365 6c66 5b6d 6167 5f63 6f6c 756d  t(self[mag_colum
-0003b4f0: 6e5d 295b 3a69 6375 745d 0a20 2020 2020  n])[:icut].     
-0003b500: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003b510: 2020 2020 2073 656c 665f 6978 203d 206e       self_ix = n
-0003b520: 702e 6172 616e 6765 2873 656c 665f 7879  p.arange(self_xy
-0003b530: 2e73 6861 7065 5b30 5d29 0a0a 2020 2020  .shape[0])..    
-0003b540: 2020 2020 7365 6c66 5f78 7920 3d20 7365      self_xy = se
-0003b550: 6c66 5f78 795b 7365 6c66 5f69 782c 203a  lf_xy[self_ix, :
-0003b560: 5d0a 0a20 2020 2020 2020 2070 6169 725f  ]..        pair_
-0003b570: 6978 203d 206d 6174 6368 2e6d 6174 6368  ix = match.match
-0003b580: 5f63 6174 616c 6f67 5f74 7269 2873 656c  _catalog_tri(sel
-0003b590: 665f 7879 2c20 6f74 6865 725f 7879 2c20  f_xy, other_xy, 
-0003b5a0: 6d61 784b 6565 703d 6d61 784b 6565 702c  maxKeep=maxKeep,
-0003b5b0: 2061 7574 6f5f 6b65 6570 3d61 7574 6f5f   auto_keep=auto_
-0003b5c0: 6b65 6570 2c20 6175 746f 5f74 7261 6e73  keep, auto_trans
-0003b5d0: 666f 726d 3d4e 6f6e 652c 2061 7574 6f5f  form=None, auto_
-0003b5e0: 6c69 6d69 743d 6175 746f 5f6c 696d 6974  limit=auto_limit
-0003b5f0: 2c20 7369 7a65 5f6c 696d 6974 3d5b 352c  , size_limit=[5,
-0003b600: 2031 3030 305d 2c20 6967 6e6f 7265 5f72   1000], ignore_r
-0003b610: 6f74 3d46 616c 7365 2c20 6967 6e6f 7265  ot=False, ignore
-0003b620: 5f73 6361 6c65 3d54 7275 652c 2062 615f  _scale=True, ba_
-0003b630: 6d61 783d 6261 5f6d 6178 290a 0a20 2020  max=ba_max)..   
-0003b640: 2020 2020 2069 6620 6c65 6e28 7061 6972       if len(pair
-0003b650: 5f69 7829 203d 3d20 303a 0a20 2020 2020  _ix) == 0:.     
-0003b660: 2020 2020 2020 2070 7269 6e74 2827 4e6f         print('No
-0003b670: 206d 6174 6368 6573 2729 0a20 2020 2020   matches').     
-0003b680: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0003b690: 6c73 650a 0a20 2020 2020 2020 2074 662c  lse..        tf,
-0003b6a0: 2064 782c 2072 6d73 203d 206d 6174 6368   dx, rms = match
-0003b6b0: 2e67 6574 5f74 7261 6e73 666f 726d 2873  .get_transform(s
-0003b6c0: 656c 665f 7879 2c20 6f74 6865 725f 7879  elf_xy, other_xy
-0003b6d0: 2c20 7061 6972 5f69 782c 2074 7261 6e73  , pair_ix, trans
-0003b6e0: 666f 726d 3d4e 6f6e 652c 2075 7365 5f72  form=None, use_r
-0003b6f0: 616e 7361 633d 5472 7565 290a 0a20 2020  ansac=True)..   
-0003b700: 2020 2020 206d 6174 6368 5f69 7820 3d20       match_ix = 
-0003b710: 7061 6972 5f69 782a 310a 2020 2020 2020  pair_ix*1.      
-0003b720: 2020 6d61 7463 685f 6978 5b3a 2c20 305d    match_ix[:, 0]
-0003b730: 203d 2073 656c 665f 6978 5b70 6169 725f   = self_ix[pair_
-0003b740: 6978 5b3a 2c20 305d 5d0a 0a20 2020 2020  ix[:, 0]]..     
-0003b750: 2020 2069 6620 7368 6f77 5f64 6961 676e     if show_diagn
-0003b760: 6f73 7469 633a 0a20 2020 2020 2020 2020  ostic:.         
-0003b770: 2020 2066 6967 203d 206d 6174 6368 2e6d     fig = match.m
-0003b780: 6174 6368 5f64 6961 676e 6f73 7469 635f  atch_diagnostic_
-0003b790: 706c 6f74 2873 656c 665f 7879 2c20 6f74  plot(self_xy, ot
-0003b7a0: 6865 725f 7879 2c20 7061 6972 5f69 782c  her_xy, pair_ix,
-0003b7b0: 2074 663d 4e6f 6e65 2c20 6e65 775f 6669   tf=None, new_fi
-0003b7c0: 6775 7265 3d54 7275 6529 0a20 2020 2020  gure=True).     
-0003b7d0: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
-0003b7e0: 7463 685f 6978 2c20 7466 2c20 6478 2c20  tch_ix, tf, dx, 
-0003b7f0: 726d 732c 2066 6967 0a20 2020 2020 2020  rms, fig.       
-0003b800: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003b810: 2020 2072 6574 7572 6e20 6d61 7463 685f     return match_
-0003b820: 6978 2c20 7466 2c20 6478 2c20 726d 730a  ix, tf, dx, rms.
-0003b830: 0a20 2020 2064 6566 2061 6464 5f61 6c61  .    def add_ala
-0003b840: 6464 696e 2873 656c 662c 2072 645f 636f  ddin(self, rd_co
-0003b850: 6c73 3d5b 2772 6127 2c20 2764 6563 275d  ls=['ra', 'dec']
-0003b860: 2c20 666f 763d 302e 352c 2073 697a 653d  , fov=0.5, size=
-0003b870: 2834 3030 2c20 3230 3029 2c20 6465 6661  (400, 200), defa
-0003b880: 756c 745f 7669 6577 3d22 502f 4453 5332  ult_view="P/DSS2
-0003b890: 2f63 6f6c 6f72 2229 3a0a 2020 2020 2020  /color"):.      
-0003b8a0: 2020 2222 220a 2020 2020 2020 2020 4164    """.        Ad
-0003b8b0: 6420 416c 6164 696e 4c69 7465 2044 4956  d AladinLite DIV
-0003b8c0: 2063 6f6c 756d 6e20 746f 2074 6865 2074   column to the t
-0003b8d0: 6162 6c65 0a0a 2020 2020 2020 2020 666f  able..        fo
-0003b8e0: 7620 3a20 666f 7620 696e 2064 6567 7265  v : fov in degre
-0003b8f0: 6573 0a20 2020 2020 2020 2073 697a 6520  es.        size 
-0003b900: 3a20 7369 7a65 206f 6620 4449 5673 2028  : size of DIVs (
-0003b910: 772c 2068 2920 696e 2070 6978 656c 7320  w, h) in pixels 
-0003b920: 2877 2c20 6829 0a0a 2020 2020 2020 2020  (w, h)..        
-0003b930: 2222 220a 2020 2020 2020 2020 2320 3c21  """.        # <!
-0003b940: 2d2d 2069 6e63 6c75 6465 2041 6c61 6469  -- include Aladi
-0003b950: 6e20 4c69 7465 2043 5353 2066 696c 6520  n Lite CSS file 
-0003b960: 696e 2074 6865 2068 6561 6420 7365 6374  in the head sect
-0003b970: 696f 6e20 6f66 2079 6f75 7220 7061 6765  ion of your page
-0003b980: 202d 2d3e 0a20 2020 2020 2020 2023 203c   -->.        # <
-0003b990: 6c69 6e6b 2072 656c 3d22 7374 796c 6573  link rel="styles
-0003b9a0: 6865 6574 2220 6872 6566 3d22 2f2f 616c  heet" href="//al
-0003b9b0: 6164 696e 2e75 2d73 7472 6173 6267 2e66  adin.u-strasbg.f
-0003b9c0: 722f 416c 6164 696e 4c69 7465 2f61 7069  r/AladinLite/api
-0003b9d0: 2f76 322f 6c61 7465 7374 2f61 6c61 6469  /v2/latest/aladi
-0003b9e0: 6e2e 6d69 6e2e 6373 7322 202f 3e0a 2020  n.min.css" />.  
-0003b9f0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-0003ba00: 2320 3c21 2d2d 2079 6f75 2063 616e 2073  # <!-- you can s
-0003ba10: 6b69 7020 7468 6520 666f 6c6c 6f77 696e  kip the followin
-0003ba20: 6720 6c69 6e65 2069 6620 796f 7572 2070  g line if your p
-0003ba30: 6167 6520 616c 7265 6164 7920 696e 7465  age already inte
-0003ba40: 6772 6174 6573 2074 6865 206a 5175 6572  grates the jQuer
-0003ba50: 7920 6c69 6272 6172 7920 2d2d 3e0a 2020  y library -->.  
-0003ba60: 2020 2020 2020 2320 3c73 6372 6970 7420        # <script 
-0003ba70: 7479 7065 3d22 7465 7874 2f6a 6176 6173  type="text/javas
-0003ba80: 6372 6970 7422 2073 7263 3d22 2f2f 636f  cript" src="//co
-0003ba90: 6465 2e6a 7175 6572 792e 636f 6d2f 6a71  de.jquery.com/jq
-0003baa0: 7565 7279 2d31 2e31 322e 312e 6d69 6e2e  uery-1.12.1.min.
-0003bab0: 6a73 2220 6368 6172 7365 743d 2275 7466  js" charset="utf
-0003bac0: 2d38 223e 3c2f 7363 7269 7074 3e0a 0a20  -8"></script>.. 
-0003bad0: 2020 2020 2020 2061 6c61 203d 205b 2222         ala = [""
-0003bae0: 2220 2020 203c 6469 7620 6964 3d22 616c  "    <div id="al
-0003baf0: 6164 696e 2d6c 6974 652d 6469 762d 7b69  adin-lite-div-{i
-0003bb00: 7d22 2073 7479 6c65 3d22 7769 6474 683a  }" style="width:
-0003bb10: 7b77 7369 7a65 7d70 783b 6865 6967 6874  {wsize}px;height
-0003bb20: 3a7b 6873 697a 657d 7078 3b22 3e3c 2f64  :{hsize}px;"></d
-0003bb30: 6976 3e0a 2020 2020 2020 2020 3c73 6372  iv>.        <scr
-0003bb40: 6970 7420 7479 7065 3d22 7465 7874 2f6a  ipt type="text/j
-0003bb50: 6176 6173 6372 6970 7422 2073 7263 3d22  avascript" src="
-0003bb60: 6874 7470 3a2f 2f61 6c61 6469 6e2e 752d  http://aladin.u-
-0003bb70: 7374 7261 7362 672e 6672 2f41 6c61 6469  strasbg.fr/Aladi
-0003bb80: 6e4c 6974 652f 6170 692f 7632 2f6c 6174  nLite/api/v2/lat
-0003bb90: 6573 742f 616c 6164 696e 2e6d 696e 2e6a  est/aladin.min.j
-0003bba0: 7322 2063 6861 7273 6574 3d22 7574 662d  s" charset="utf-
-0003bbb0: 3822 3e3c 2f73 6372 6970 743e 0a20 2020  8"></script>.   
-0003bbc0: 2020 2020 203c 7363 7269 7074 2074 7970       <script typ
-0003bbd0: 653d 2274 6578 742f 6a61 7661 7363 7269  e="text/javascri
-0003bbe0: 7074 223e 0a20 2020 2020 2020 2020 2020  pt">.           
-0003bbf0: 2076 6172 2061 6c61 6469 6e20 3d20 412e   var aladin = A.
-0003bc00: 616c 6164 696e 2827 2361 6c61 6469 6e2d  aladin('#aladin-
-0003bc10: 6c69 7465 2d64 6976 2d7b 697d 272c 2078  lite-div-{i}', x
-0003bc20: 7878 7375 7276 6579 3a20 227b 7375 7276  xxsurvey: "{surv
-0003bc30: 6579 7d22 2c20 666f 763a 7b66 6f76 7d2c  ey}", fov:{fov},
-0003bc40: 2074 6172 6765 743a 2022 7b72 617d 207b   target: "{ra} {
-0003bc50: 6465 637d 2279 7979 293b 0a20 2020 2020  dec}"yyy);.     
-0003bc60: 2020 203c 2f73 6372 6970 743e 3c2f 6469     </script></di
-0003bc70: 763e 2222 222e 666f 726d 6174 2869 3d69  v>""".format(i=i
-0003bc80: 2c20 7261 3d72 6f77 5b72 645f 636f 6c73  , ra=row[rd_cols
-0003bc90: 5b30 5d5d 2c20 6465 633d 726f 775b 7264  [0]], dec=row[rd
-0003bca0: 5f63 6f6c 735b 315d 5d2c 2073 7572 7665  _cols[1]], surve
-0003bcb0: 793d 6465 6661 756c 745f 7669 6577 2c20  y=default_view, 
-0003bcc0: 666f 763d 666f 762c 2068 7369 7a65 3d73  fov=fov, hsize=s
-0003bcd0: 697a 655b 315d 2c20 7773 697a 653d 7369  ize[1], wsize=si
-0003bce0: 7a65 5b30 5d29 2e72 6570 6c61 6365 2827  ze[0]).replace('
-0003bcf0: 7878 7827 2c20 277b 2729 2e72 6570 6c61  xxx', '{').repla
-0003bd00: 6365 2827 7979 7927 2c20 277d 2729 2066  ce('yyy', '}') f
-0003bd10: 6f72 2069 2c20 726f 7720 696e 2065 6e75  or i, row in enu
-0003bd20: 6d65 7261 7465 2873 656c 6629 5d0a 0a20  merate(self)].. 
-0003bd30: 2020 2020 2020 2073 656c 665b 2761 6c61         self['ala
-0003bd40: 6469 6e27 5d20 3d20 616c 610a 0a20 2020  din'] = ala..   
-0003bd50: 2064 6566 2077 7269 7465 5f73 6f72 7461   def write_sorta
-0003bd60: 626c 655f 6874 6d6c 2873 656c 662c 206f  ble_html(self, o
-0003bd70: 7574 7075 742c 2072 6570 6c61 6365 5f62  utput, replace_b
-0003bd80: 7261 6365 733d 5472 7565 2c20 6c6f 6361  races=True, loca
-0003bd90: 6c68 6f73 743d 5472 7565 2c20 6d61 785f  lhost=True, max_
-0003bda0: 6c69 6e65 733d 3530 2c20 7461 626c 655f  lines=50, table_
-0003bdb0: 6964 3d4e 6f6e 652c 2074 6162 6c65 5f63  id=None, table_c
-0003bdc0: 6c61 7373 3d22 6469 7370 6c61 7920 636f  lass="display co
-0003bdd0: 6d70 6163 7422 2c20 6373 733d 4e6f 6e65  mpact", css=None
-0003bde0: 2c20 6669 6c74 6572 5f63 6f6c 756d 6e73  , filter_columns
-0003bdf0: 3d5b 5d2c 2062 7574 746f 6e73 3d5b 2763  =[], buttons=['c
-0003be00: 7376 275d 2c20 746f 6767 6c65 3d54 7275  sv'], toggle=Tru
-0003be10: 652c 2075 7365 5f6a 736f 6e3d 4661 6c73  e, use_json=Fals
-0003be20: 6529 3a0a 2020 2020 2020 2020 2222 2257  e):.        """W
-0003be30: 7261 7070 6572 2061 726f 756e 6420 607e  rapper around `~
-0003be40: 6173 7472 6f70 792e 7461 626c 652e 5461  astropy.table.Ta
-0003be50: 626c 652e 7772 6974 6528 666f 726d 6174  ble.write(format
-0003be60: 3d27 6a73 7669 6577 6572 2729 602e 0a0a  ='jsviewer')`...
-0003be70: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-0003be80: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-0003be90: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6f75  -----.        ou
-0003bea0: 7470 7574 203a 2073 7472 0a20 2020 2020  tput : str.     
-0003beb0: 2020 2020 2020 204f 7574 7075 7420 6669         Output fi
-0003bec0: 6c65 6e61 6d65 2e0a 0a20 2020 2020 2020  lename...       
-0003bed0: 2072 6570 6c61 6365 5f62 7261 6365 7320   replace_braces 
-0003bee0: 3a20 626f 6f6c 0a20 2020 2020 2020 2020  : bool.         
-0003bef0: 2020 2052 6570 6c61 6365 2027 266c 743b     Replace '&lt;
-0003bf00: 2720 616e 6420 2726 6774 3b27 2063 6861  ' and '&gt;' cha
-0003bf10: 7261 6374 6572 7320 7468 6174 2061 7265  racters that are
-0003bf20: 2063 6f6e 7665 7274 6564 0a20 2020 2020   converted.     
-0003bf30: 2020 2020 2020 2061 7574 6f6d 6174 6963         automatic
-0003bf40: 616c 6c79 2066 726f 6d20 223c 3e22 2062  ally from "<>" b
-0003bf50: 7920 7468 6520 607e 6173 7472 6f70 792e  y the `~astropy.
-0003bf60: 7461 626c 652e 5461 626c 652e 7772 6974  table.Table.writ
-0003bf70: 6560 0a20 2020 2020 2020 2020 2020 206d  e`.            m
-0003bf80: 6574 686f 642e 2054 6865 7265 2061 7265  ethod. There are
-0003bf90: 2070 6172 616d 6574 6572 7320 666f 7220   parameters for 
-0003bfa0: 646f 696e 6720 7468 6973 2061 7574 6f6d  doing this autom
-0003bfb0: 6174 6963 616c 6c79 2077 6974 680a 2020  atically with.  
-0003bfc0: 2020 2020 2020 2020 2020 6077 7269 7465            `write
-0003bfd0: 2866 6f72 6d61 743d 2768 746d 6c27 2960  (format='html')`
-0003bfe0: 2062 7574 2074 6861 7420 646f 6e27 7420   but that don't 
-0003bff0: 6170 7065 6172 2074 6f20 6265 2061 7661  appear to be ava
-0003c000: 696c 6162 6c65 2077 6974 680a 2020 2020  ilable with.    
-0003c010: 2020 2020 2020 2020 6077 7269 7465 2866          `write(f
-0003c020: 6f72 6d61 743d 276a 7376 6965 7765 7227  ormat='jsviewer'
-0003c030: 2960 2e0a 0a20 2020 2020 2020 206c 6f63  )`...        loc
-0003c040: 616c 686f 7374 203a 2062 6f6f 6c0a 2020  alhost : bool.  
-0003c050: 2020 2020 2020 2020 2020 5573 6520 6c6f            Use lo
-0003c060: 6361 6c20 4a53 2066 696c 6573 2e20 4f74  cal JS files. Ot
-0003c070: 6865 7277 6973 6520 7573 6520 6669 6c65  herwise use file
-0003c080: 7320 686f 7374 6564 2065 7874 6572 6e61  s hosted externa
-0003c090: 6c6c 792e 0a0a 2020 2020 2020 2020 6669  lly...        fi
-0003c0a0: 6c74 6572 5f63 6f6c 756d 6e73 203a 206c  lter_columns : l
-0003c0b0: 6973 740a 2020 2020 2020 2020 2020 2020  ist.            
-0003c0c0: 4164 6420 6f70 7469 6f6e 2074 6f20 6c69  Add option to li
-0003c0d0: 6d69 7420 6d69 6e2f 6d61 7820 7661 6c75  mit min/max valu
-0003c0e0: 6573 206f 6620 636f 6c75 6d6e 2064 6174  es of column dat
-0003c0f0: 610a 0a20 2020 2020 2020 2062 7574 746f  a..        butto
-0003c100: 6e73 203a 206c 6973 740a 2020 2020 2020  ns : list.      
-0003c110: 2020 2020 2020 4164 6420 6275 7474 6f6e        Add button
-0003c120: 7320 666f 7220 6578 706f 7274 696e 6720  s for exporting 
-0003c130: 6461 7461 2e20 2041 6c6c 6f77 6564 206f  data.  Allowed o
-0003c140: 7074 696f 6e73 2061 7265 0a20 2020 2020  ptions are.     
-0003c150: 2020 2020 2020 2027 636f 7079 272c 2027         'copy', '
-0003c160: 6373 7627 2c20 2765 7863 656c 272c 2027  csv', 'excel', '
-0003c170: 7064 6627 2c20 2770 7269 6e74 272e 0a0a  pdf', 'print'...
-0003c180: 2020 2020 2020 2020 746f 6767 6c65 203a          toggle :
-0003c190: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
-0003c1a0: 2020 4164 6420 6c69 6e6b 7320 6174 2074    Add links at t
-0003c1b0: 6f70 206f 6620 7061 6765 2066 6f72 2074  op of page for t
-0003c1c0: 6f67 676c 696e 6720 636f 6c75 6d6e 7320  oggling columns 
-0003c1d0: 6f6e 2f6f 6666 0a0a 2020 2020 2020 2020  on/off..        
-0003c1e0: 7573 655f 6a73 6f6e 203a 2062 6f6f 6c0a  use_json : bool.
-0003c1f0: 2020 2020 2020 2020 2020 2020 5772 6974              Writ
-0003c200: 6520 7468 6520 6461 7461 2074 6f20 6120  e the data to a 
-0003c210: 4a53 4f4e 2066 696c 6520 616e 6420 7374  JSON file and st
-0003c220: 7269 7020 6f75 7420 6f66 2074 6865 2048  rip out of the H
-0003c230: 544d 4c20 6865 6164 6572 2e0a 2020 2020  TML header..    
-0003c240: 2020 2020 2020 2020 5573 6520 7468 6973          Use this
-0003c250: 2066 6f72 206c 6172 6765 2064 6174 6173   for large datas
-0003c260: 6574 7320 6f72 2069 6620 636f 6c75 6d6e  ets or if column
-0003c270: 7320 696e 636c 7564 6520 7265 6e64 6572  s include render
-0003c280: 6564 0a20 2020 2020 2020 2020 2020 2069  ed.            i
-0003c290: 6d61 6765 732e 0a0a 2020 2020 2020 2020  mages...        
-0003c2a0: 6574 6320 3a20 2e2e 2e0a 2020 2020 2020  etc : ....      
-0003c2b0: 2020 2020 2020 4164 6469 7469 6f6e 616c        Additional
-0003c2c0: 2070 6172 616d 6574 6572 7320 7061 7373   parameters pass
-0003c2d0: 6564 2074 6872 6f75 6768 2074 6f20 6077  ed through to `w
-0003c2e0: 7269 7465 602e 0a20 2020 2020 2020 2022  rite`..        "
-0003c2f0: 2222 0a20 2020 2020 2020 2023 6672 6f6d  "".        #from
-0003c300: 2061 7374 726f 7079 2e74 6162 6c65 2e6a   astropy.table.j
-0003c310: 7376 6965 7765 7220 696d 706f 7274 2044  sviewer import D
-0003c320: 4546 4155 4c54 5f43 5353 0a20 2020 2020  EFAULT_CSS.     
-0003c330: 2020 2044 4546 4155 4c54 5f43 5353 203d     DEFAULT_CSS =
-0003c340: 2022 2222 0a62 6f64 7920 7b66 6f6e 742d   """.body {font-
-0003c350: 6661 6d69 6c79 3a20 7361 6e73 2d73 6572  family: sans-ser
-0003c360: 6966 3b7d 0a74 6162 6c65 2e64 6174 6154  if;}.table.dataT
-0003c370: 6162 6c65 207b 7769 6474 683a 2061 7574  able {width: aut
-0003c380: 6f20 2169 6d70 6f72 7461 6e74 3b20 6d61  o !important; ma
-0003c390: 7267 696e 3a20 3020 2169 6d70 6f72 7461  rgin: 0 !importa
-0003c3a0: 6e74 3b7d 0a2e 6461 7461 5461 626c 6573  nt;}..dataTables
-0003c3b0: 5f66 696c 7465 722c 202e 6461 7461 5461  _filter, .dataTa
-0003c3c0: 626c 6573 5f70 6167 696e 6174 6520 7b66  bles_paginate {f
-0003c3d0: 6c6f 6174 3a20 6c65 6674 2021 696d 706f  loat: left !impo
-0003c3e0: 7274 616e 743b 206d 6172 6769 6e2d 6c65  rtant; margin-le
-0003c3f0: 6674 3a31 656d 7d0a 7464 207b 666f 6e74  ft:1em}.td {font
-0003c400: 2d73 697a 653a 2031 3070 743b 7d0a 2020  -size: 10pt;}.  
-0003c410: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003c420: 2020 6966 2063 7373 2069 7320 6e6f 7420    if css is not 
-0003c430: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003c440: 2020 4445 4641 554c 545f 4353 5320 2b3d    DEFAULT_CSS +=
-0003c450: 2063 7373 0a0a 2020 2020 2020 2020 6966   css..        if
-0003c460: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-0003c470: 6f75 7470 7574 293a 0a20 2020 2020 2020  output):.       
-0003c480: 2020 2020 206f 732e 7265 6d6f 7665 286f       os.remove(o
-0003c490: 7574 7075 7429 0a0a 2020 2020 2020 2020  utput)..        
-0003c4a0: 7365 6c66 2e77 7269 7465 286f 7574 7075  self.write(outpu
-0003c4b0: 742c 2066 6f72 6d61 743d 276a 7376 6965  t, format='jsvie
-0003c4c0: 7765 7227 2c20 6373 733d 4445 4641 554c  wer', css=DEFAUL
-0003c4d0: 545f 4353 532c 0a20 2020 2020 2020 2020  T_CSS,.         
-0003c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c4f0: 2020 206d 6178 5f6c 696e 6573 3d6d 6178     max_lines=max
-0003c500: 5f6c 696e 6573 2c0a 2020 2020 2020 2020  _lines,.        
-0003c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c520: 2020 2020 6a73 6b77 6172 6773 3d7b 2775      jskwargs={'u
-0003c530: 7365 5f6c 6f63 616c 5f66 696c 6573 273a  se_local_files':
-0003c540: 206c 6f63 616c 686f 7374 7d2c 0a20 2020   localhost},.   
-0003c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c560: 2020 2020 2020 2020 2074 6162 6c65 5f69           table_i
-0003c570: 643d 4e6f 6e65 2c20 7461 626c 655f 636c  d=None, table_cl
-0003c580: 6173 733d 7461 626c 655f 636c 6173 7329  ass=table_class)
-0003c590: 0a0a 2020 2020 2020 2020 6966 2072 6570  ..        if rep
-0003c5a0: 6c61 6365 5f62 7261 6365 733a 0a20 2020  lace_braces:.   
-0003c5b0: 2020 2020 2020 2020 206c 696e 6573 203d           lines =
-0003c5c0: 206f 7065 6e28 6f75 7470 7574 292e 7265   open(output).re
-0003c5d0: 6164 6c69 6e65 7328 290a 2020 2020 2020  adlines().      
-0003c5e0: 2020 2020 2020 6966 2072 6570 6c61 6365        if replace
-0003c5f0: 5f62 7261 6365 733a 0a20 2020 2020 2020  _braces:.       
-0003c600: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-0003c610: 6e20 7261 6e67 6528 6c65 6e28 6c69 6e65  n range(len(line
-0003c620: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
-0003c630: 2020 2020 2020 2020 206c 696e 6573 5b69           lines[i
-0003c640: 5d20 3d20 6c69 6e65 735b 695d 2e72 6570  ] = lines[i].rep
-0003c650: 6c61 6365 2827 266c 743b 272c 2027 3c27  lace('&lt;', '<'
-0003c660: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003c670: 2020 2020 2020 6c69 6e65 735b 695d 203d        lines[i] =
-0003c680: 206c 696e 6573 5b69 5d2e 7265 706c 6163   lines[i].replac
-0003c690: 6528 2726 6774 3b27 2c20 273e 2729 0a0a  e('&gt;', '>')..
-0003c6a0: 2020 2020 2020 2020 2020 2020 6670 203d              fp =
-0003c6b0: 206f 7065 6e28 6f75 7470 7574 2c20 2777   open(output, 'w
-0003c6c0: 2729 0a20 2020 2020 2020 2020 2020 2066  ').            f
-0003c6d0: 702e 7772 6974 656c 696e 6573 286c 696e  p.writelines(lin
-0003c6e0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-0003c6f0: 6670 2e63 6c6f 7365 2829 0a0a 2020 2020  fp.close()..    
-0003c700: 2020 2020 2320 5265 6164 2061 6c6c 206c      # Read all l
-0003c710: 696e 6573 0a20 2020 2020 2020 206c 696e  ines.        lin
-0003c720: 6573 203d 206f 7065 6e28 6f75 7470 7574  es = open(output
-0003c730: 292e 7265 6164 6c69 6e65 7328 290a 0a20  ).readlines().. 
-0003c740: 2020 2020 2020 2069 6620 2761 6c61 6469         if 'aladi
-0003c750: 6e27 2069 6e20 7365 6c66 2e63 6f6c 6e61  n' in self.colna
-0003c760: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
-0003c770: 2023 2049 6e73 6572 7420 416c 6164 696e   # Insert Aladin
-0003c780: 2043 5353 0a20 2020 2020 2020 2020 2020   CSS.           
-0003c790: 2061 6c61 6469 6e5f 6373 7320 3d20 273c   aladin_css = '<
-0003c7a0: 6c69 6e6b 2072 656c 3d22 7374 796c 6573  link rel="styles
-0003c7b0: 6865 6574 2220 6872 6566 3d22 6874 7470  heet" href="http
-0003c7c0: 733a 2f2f 616c 6164 696e 2e75 2d73 7472  s://aladin.u-str
-0003c7d0: 6173 6267 2e66 722f 416c 6164 696e 4c69  asbg.fr/AladinLi
-0003c7e0: 7465 2f61 7069 2f76 322f 6c61 7465 7374  te/api/v2/latest
-0003c7f0: 2f61 6c61 6469 6e2e 6d69 6e2e 6373 7322  /aladin.min.css"
-0003c800: 202f 3e5c 6e27 0a0a 2020 2020 2020 2020   />\n'..        
-0003c810: 2020 2020 666f 7220 696c 2c20 6c69 6e65      for il, line
-0003c820: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
-0003c830: 6e65 7329 3a0a 2020 2020 2020 2020 2020  nes):.          
-0003c840: 2020 2020 2020 6966 2027 3c6c 696e 6b20        if '<link 
-0003c850: 6872 6566 3d27 2069 6e20 6c69 6e65 3a0a  href=' in line:.
-0003c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c870: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0003c880: 2020 2020 2020 206c 696e 6573 2e69 6e73         lines.ins
-0003c890: 6572 7428 696c 2b31 2c20 616c 6164 696e  ert(il+1, aladin
-0003c8a0: 5f63 7373 290a 0a20 2020 2020 2020 2023  _css)..        #
-0003c8b0: 2045 7870 6f72 7420 6275 7474 6f6e 730a   Export buttons.
-0003c8c0: 2020 2020 2020 2020 6966 2062 7574 746f          if butto
-0003c8d0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0003c8e0: 2320 4353 530a 2020 2020 2020 2020 2020  # CSS.          
-0003c8f0: 2020 6373 735f 7363 7269 7074 203d 2027    css_script = '
-0003c900: 3c6c 696e 6b20 7265 6c3d 2273 7479 6c65  <link rel="style
-0003c910: 7368 6565 7422 2074 7970 653d 2274 6578  sheet" type="tex
-0003c920: 742f 6373 7322 2068 7265 663d 2268 7474  t/css" href="htt
-0003c930: 7073 3a2f 2f63 646e 2e64 6174 6174 6162  ps://cdn.datatab
-0003c940: 6c65 732e 6e65 742f 6275 7474 6f6e 732f  les.net/buttons/
-0003c950: 312e 352e 312f 6373 732f 6275 7474 6f6e  1.5.1/css/button
-0003c960: 732e 6461 7461 5461 626c 6573 2e6d 696e  s.dataTables.min
-0003c970: 2e63 7373 223e 5c6e 270a 2020 2020 2020  .css">\n'.      
-0003c980: 2020 2020 2020 666f 7220 696c 2c20 6c69        for il, li
-0003c990: 6e65 2069 6e20 656e 756d 6572 6174 6528  ne in enumerate(
-0003c9a0: 6c69 6e65 7329 3a0a 2020 2020 2020 2020  lines):.        
-0003c9b0: 2020 2020 2020 2020 6966 2027 6373 732f          if 'css/
-0003c9c0: 6a71 7565 7279 2e64 6174 6154 6162 6c65  jquery.dataTable
-0003c9d0: 2720 696e 206c 696e 653a 0a20 2020 2020  ' in line:.     
-0003c9e0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0003c9f0: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
-0003ca00: 2020 6c69 6e65 732e 696e 7365 7274 2869    lines.insert(i
-0003ca10: 6c2b 312c 2063 7373 5f73 6372 6970 7429  l+1, css_script)
-0003ca20: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0003ca30: 4a53 206c 6962 7261 7269 6573 0a20 2020  JS libraries.   
-0003ca40: 2020 2020 2020 2020 206a 735f 7363 7269           js_scri
-0003ca50: 7074 7320 3d20 2222 220a 2020 2020 2020  pts = """.      
-0003ca60: 2020 2020 2020 3c73 6372 6970 7420 7479        <script ty
-0003ca70: 7065 3d22 7465 7874 2f6a 6176 6173 6372  pe="text/javascr
-0003ca80: 6970 7422 206c 616e 6775 6167 653d 226a  ipt" language="j
-0003ca90: 6176 6173 6372 6970 7422 2073 7263 3d22  avascript" src="
-0003caa0: 6874 7470 733a 2f2f 6364 6e2e 6461 7461  https://cdn.data
-0003cab0: 7461 626c 6573 2e6e 6574 2f62 7574 746f  tables.net/butto
-0003cac0: 6e73 2f31 2e35 2e31 2f6a 732f 6461 7461  ns/1.5.1/js/data
-0003cad0: 5461 626c 6573 2e62 7574 746f 6e73 2e6d  Tables.buttons.m
-0003cae0: 696e 2e6a 7322 3e3c 2f73 6372 6970 743e  in.js"></script>
-0003caf0: 0a20 2020 2020 2020 2020 2020 203c 7363  .            <sc
-0003cb00: 7269 7074 2074 7970 653d 2274 6578 742f  ript type="text/
-0003cb10: 6a61 7661 7363 7269 7074 2220 6c61 6e67  javascript" lang
-0003cb20: 7561 6765 3d22 6a61 7661 7363 7269 7074  uage="javascript
-0003cb30: 2220 7372 633d 2268 7474 7073 3a2f 2f63  " src="https://c
-0003cb40: 646e 2e64 6174 6174 6162 6c65 732e 6e65  dn.datatables.ne
-0003cb50: 742f 6275 7474 6f6e 732f 312e 352e 312f  t/buttons/1.5.1/
-0003cb60: 6a73 2f62 7574 746f 6e73 2e66 6c61 7368  js/buttons.flash
-0003cb70: 2e6d 696e 2e6a 7322 3e3c 2f73 6372 6970  .min.js"></scrip
-0003cb80: 743e 0a20 2020 2020 2020 2020 2020 203c  t>.            <
-0003cb90: 7363 7269 7074 2074 7970 653d 2274 6578  script type="tex
-0003cba0: 742f 6a61 7661 7363 7269 7074 2220 6c61  t/javascript" la
-0003cbb0: 6e67 7561 6765 3d22 6a61 7661 7363 7269  nguage="javascri
-0003cbc0: 7074 2220 7372 633d 2268 7474 7073 3a2f  pt" src="https:/
-0003cbd0: 2f63 646e 6a73 2e63 6c6f 7564 666c 6172  /cdnjs.cloudflar
-0003cbe0: 652e 636f 6d2f 616a 6178 2f6c 6962 732f  e.com/ajax/libs/
-0003cbf0: 6a73 7a69 702f 332e 312e 332f 6a73 7a69  jszip/3.1.3/jszi
-0003cc00: 702e 6d69 6e2e 6a73 223e 3c2f 7363 7269  p.min.js"></scri
-0003cc10: 7074 3e0a 2020 2020 2020 2020 2020 2020  pt>.            
-0003cc20: 3c73 6372 6970 7420 7479 7065 3d22 7465  <script type="te
-0003cc30: 7874 2f6a 6176 6173 6372 6970 7422 206c  xt/javascript" l
-0003cc40: 616e 6775 6167 653d 226a 6176 6173 6372  anguage="javascr
-0003cc50: 6970 7422 2073 7263 3d22 6874 7470 733a  ipt" src="https:
-0003cc60: 2f2f 6364 6e6a 732e 636c 6f75 6466 6c61  //cdnjs.cloudfla
-0003cc70: 7265 2e63 6f6d 2f61 6a61 782f 6c69 6273  re.com/ajax/libs
-0003cc80: 2f70 6466 6d61 6b65 2f30 2e31 2e33 322f  /pdfmake/0.1.32/
-0003cc90: 7064 666d 616b 652e 6d69 6e2e 6a73 223e  pdfmake.min.js">
-0003cca0: 3c2f 7363 7269 7074 3e0a 2020 2020 2020  </script>.      
-0003ccb0: 2020 2020 2020 3c73 6372 6970 7420 7479        <script ty
-0003ccc0: 7065 3d22 7465 7874 2f6a 6176 6173 6372  pe="text/javascr
-0003ccd0: 6970 7422 206c 616e 6775 6167 653d 226a  ipt" language="j
-0003cce0: 6176 6173 6372 6970 7422 2073 7263 3d22  avascript" src="
-0003ccf0: 6874 7470 733a 2f2f 6364 6e6a 732e 636c  https://cdnjs.cl
-0003cd00: 6f75 6466 6c61 7265 2e63 6f6d 2f61 6a61  oudflare.com/aja
-0003cd10: 782f 6c69 6273 2f70 6466 6d61 6b65 2f30  x/libs/pdfmake/0
-0003cd20: 2e31 2e33 322f 7666 735f 666f 6e74 732e  .1.32/vfs_fonts.
-0003cd30: 6a73 223e 3c2f 7363 7269 7074 3e0a 2020  js"></script>.  
-0003cd40: 2020 2020 2020 2020 2020 3c73 6372 6970            <scrip
-0003cd50: 7420 7479 7065 3d22 7465 7874 2f6a 6176  t type="text/jav
-0003cd60: 6173 6372 6970 7422 206c 616e 6775 6167  ascript" languag
-0003cd70: 653d 226a 6176 6173 6372 6970 7422 2073  e="javascript" s
-0003cd80: 7263 3d22 6874 7470 733a 2f2f 6364 6e2e  rc="https://cdn.
-0003cd90: 6461 7461 7461 626c 6573 2e6e 6574 2f62  datatables.net/b
-0003cda0: 7574 746f 6e73 2f31 2e35 2e31 2f6a 732f  uttons/1.5.1/js/
-0003cdb0: 6275 7474 6f6e 732e 6874 6d6c 352e 6d69  buttons.html5.mi
-0003cdc0: 6e2e 6a73 223e 3c2f 7363 7269 7074 3e0a  n.js"></script>.
-0003cdd0: 2020 2020 2020 2020 2020 2020 3c73 6372              <scr
-0003cde0: 6970 7420 7479 7065 3d22 7465 7874 2f6a  ipt type="text/j
-0003cdf0: 6176 6173 6372 6970 7422 206c 616e 6775  avascript" langu
-0003ce00: 6167 653d 226a 6176 6173 6372 6970 7422  age="javascript"
-0003ce10: 2073 7263 3d22 6874 7470 733a 2f2f 6364   src="https://cd
-0003ce20: 6e2e 6461 7461 7461 626c 6573 2e6e 6574  n.datatables.net
-0003ce30: 2f62 7574 746f 6e73 2f31 2e35 2e31 2f6a  /buttons/1.5.1/j
-0003ce40: 732f 6275 7474 6f6e 732e 7072 696e 742e  s/buttons.print.
-0003ce50: 6d69 6e2e 6a73 223e 3c2f 7363 7269 7074  min.js"></script
-0003ce60: 3e0a 2020 2020 2020 2020 2020 2020 2222  >.            ""
-0003ce70: 220a 0a20 2020 2020 2020 2020 2020 2066  "..            f
-0003ce80: 6f72 2069 6c2c 206c 696e 6520 696e 2065  or il, line in e
-0003ce90: 6e75 6d65 7261 7465 286c 696e 6573 293a  numerate(lines):
-0003cea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ceb0: 2069 6620 276a 732f 6a71 7565 7279 2e64   if 'js/jquery.d
-0003cec0: 6174 6154 6162 6c65 2720 696e 206c 696e  ataTable' in lin
-0003ced0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003cee0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-0003cef0: 2020 2020 2020 2020 206c 696e 6573 2e69           lines.i
-0003cf00: 6e73 6572 7428 696c 2b32 2c20 6a73 5f73  nsert(il+2, js_s
-0003cf10: 6372 6970 7473 290a 0a20 2020 2020 2020  cripts)..       
-0003cf20: 2020 2020 2066 6f72 2069 6c2c 206c 696e       for il, lin
-0003cf30: 6520 696e 2065 6e75 6d65 7261 7465 286c  e in enumerate(l
-0003cf40: 696e 6573 293a 0a20 2020 2020 2020 2020  ines):.         
-0003cf50: 2020 2020 2020 2069 6620 2770 6167 654c         if 'pageL
-0003cf60: 656e 6774 6827 2069 6e20 6c69 6e65 3a0a  ength' in line:.
-0003cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cf80: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0003cf90: 2020 2020 2020 2062 7574 746f 6e5f 6f70         button_op
-0003cfa0: 7469 6f6e 203d 2027 7b73 7061 6365 727d  tion = '{spacer}
-0003cfb0: 646f 6d3a 205c 2742 6c66 7274 6970 5c27  dom: \'Blfrtip\'
-0003cfc0: 2c5c 6e7b 7370 6163 6572 7d62 7574 746f  ,\n{spacer}butto
-0003cfd0: 6e73 3a20 7b62 7374 727d 2c5c 6e27 2e66  ns: {bstr},\n'.f
-0003cfe0: 6f72 6d61 7428 7370 6163 6572 3d27 2027  ormat(spacer=' '
-0003cff0: 2a38 2c20 6273 7472 3d62 7574 746f 6e73  *8, bstr=buttons
-0003d000: 2e5f 5f72 6570 725f 5f28 2929 0a20 2020  .__repr__()).   
-0003d010: 2020 2020 2020 2020 206c 696e 6573 2e69           lines.i
-0003d020: 6e73 6572 7428 696c 2b31 2c20 6275 7474  nsert(il+1, butt
-0003d030: 6f6e 5f6f 7074 696f 6e29 0a0a 2020 2020  on_option)..    
-0003d040: 2020 2020 2320 5261 6e67 6520 636f 6c75      # Range colu
-0003d050: 6d6e 730a 2020 2020 2020 2020 6963 5f6c  mns.        ic_l
-0003d060: 6973 7420 3d20 5b5d 0a0a 2020 2020 2020  ist = []..      
-0003d070: 2020 6669 6c74 6572 5f6c 696e 6573 203d    filter_lines =
-0003d080: 205b 223c 7461 626c 653e 5c6e 225d 0a20   ["<table>\n"]. 
-0003d090: 2020 2020 2020 2064 6573 6372 5f70 6164         descr_pad
-0003d0a0: 203d 2027 203c 7370 616e 2073 7479 6c65   = ' <span style
-0003d0b0: 3d22 6469 7370 6c61 793a 696e 6c69 6e65  ="display:inline
-0003d0c0: 2d62 6c6f 636b 3b20 7769 6474 683a 3130  -block; width:10
-0003d0d0: 3b22 3e3c 2f73 7061 6e3e 2027 0a0a 2020  ;"></span> '..  
-0003d0e0: 2020 2020 2020 666f 7220 6963 2c20 636f        for ic, co
-0003d0f0: 6c20 696e 2065 6e75 6d65 7261 7465 2873  l in enumerate(s
-0003d100: 656c 662e 636f 6c6e 616d 6573 293a 0a20  elf.colnames):. 
-0003d110: 2020 2020 2020 2020 2020 2069 6620 636f             if co
-0003d120: 6c20 696e 2066 696c 7465 725f 636f 6c75  l in filter_colu
-0003d130: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
-0003d140: 2020 2020 2066 6f75 6e64 203d 2046 616c       found = Fal
-0003d150: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0003d160: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0003d170: 6528 6c65 6e28 6c69 6e65 7329 293a 0a20  e(len(lines)):. 
-0003d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d190: 2020 2069 6620 273c 7468 3e7b 307d 272e     if '<th>{0}'.
-0003d1a0: 666f 726d 6174 2863 6f6c 2920 696e 206c  format(col) in l
-0003d1b0: 696e 6573 5b69 5d3a 0a20 2020 2020 2020  ines[i]:.       
-0003d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d1d0: 2066 6f75 6e64 203d 2054 7275 650a 2020   found = True.  
-0003d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d1f0: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
-0003d200: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003d210: 666f 756e 643a 0a20 2020 2020 2020 2020  found:.         
-0003d220: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-0003d230: 6e74 2863 6f6c 290a 2020 2020 2020 2020  nt(col).        
-0003d240: 2020 2020 2020 2020 2020 2020 6963 5f6c              ic_l
-0003d250: 6973 742e 6170 7065 6e64 2869 6329 0a20  ist.append(ic). 
-0003d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d270: 2020 2023 6c69 6e65 735b 695d 203d 206c     #lines[i] = l
-0003d280: 696e 6573 5b69 5d2e 7265 706c 6163 6528  ines[i].replace(
-0003d290: 636f 6c2c 2027 7b30 7d20 3c62 723e 203c  col, '{0} <br> <
-0003d2a0: 696e 7075 7420 7479 7065 3d22 7465 7874  input type="text
-0003d2b0: 2220 6964 3d22 7b30 7d5f 6d69 6e22 206e  " id="{0}_min" n
-0003d2c0: 616d 653d 227b 307d 5f6d 696e 2220 7374  ame="{0}_min" st
-0003d2d0: 796c 653d 2277 6964 7468 3a33 3070 783b  yle="width:30px;
-0003d2e0: 223e 203c 696e 7075 7420 7479 7065 3d22  "> <input type="
-0003d2f0: 7465 7874 2220 6964 3d22 7b30 7d5f 6d61  text" id="{0}_ma
-0003d300: 7822 206e 616d 653d 227b 307d 5f6d 6178  x" name="{0}_max
-0003d310: 2220 7374 796c 653d 2277 6964 7468 3a33  " style="width:3
-0003d320: 3070 783b 223e 272e 666f 726d 6174 2863  0px;">'.format(c
-0003d330: 6f6c 2929 0a0a 2020 2020 2020 2020 2020  ol))..          
-0003d340: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
-0003d350: 5f6c 696e 6573 202b 3d20 273c 7472 3e20  _lines += '<tr> 
-0003d360: 3c74 643e 203c 696e 7075 7420 7479 7065  <td> <input type
-0003d370: 3d22 7465 7874 2220 6964 3d22 7b30 7d5f  ="text" id="{0}_
-0003d380: 6d69 6e22 206e 616d 653d 227b 307d 5f6d  min" name="{0}_m
-0003d390: 696e 2220 7374 796c 653d 2277 6964 7468  in" style="width
-0003d3a0: 3a34 3070 783b 223e 2026 2336 303b 203c  :40px;"> &#60; <
-0003d3b0: 2f74 643e 203c 7464 3e20 7b30 7d20 3c2f  /td> <td> {0} </
-0003d3c0: 7464 3e20 3c74 643e 2020 2623 3630 3b20  td> <td>  &#60; 
-0003d3d0: 3c69 6e70 7574 2074 7970 653d 2274 6578  <input type="tex
-0003d3e0: 7422 2069 643d 227b 307d 5f6d 6178 2220  t" id="{0}_max" 
-0003d3f0: 6e61 6d65 3d22 7b30 7d5f 6d61 7822 2073  name="{0}_max" s
-0003d400: 7479 6c65 3d22 7769 6474 683a 3430 7078  tyle="width:40px
-0003d410: 3b22 3e27 2e66 6f72 6d61 7428 636f 6c29  ;">'.format(col)
-0003d420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d430: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0003d440: 2020 2020 2020 2020 2020 6465 7363 7220            descr 
-0003d450: 3d20 275c 6e27 0a20 2020 2020 2020 2020  = '\n'.         
-0003d460: 2020 2020 2020 2020 2020 2069 6620 6861             if ha
-0003d470: 7361 7474 7228 7365 6c66 2e63 6f6c 756d  sattr(self.colum
-0003d480: 6e73 5b63 6f6c 5d2c 2027 6465 7363 7269  ns[col], 'descri
-0003d490: 7074 696f 6e27 293a 0a20 2020 2020 2020  ption'):.       
-0003d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d4b0: 2069 6620 7365 6c66 2e63 6f6c 756d 6e73   if self.columns
-0003d4c0: 5b63 6f6c 5d2e 6465 7363 7269 7074 696f  [col].descriptio
-0003d4d0: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
-0003d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d4f0: 2020 2020 2020 2020 2020 2064 6573 6372             descr
-0003d500: 203d 2027 7b30 7d20 7b31 7d5c 6e27 2e66   = '{0} {1}\n'.f
-0003d510: 6f72 6d61 7428 6465 7363 725f 7061 642c  ormat(descr_pad,
-0003d520: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0003d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d540: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003d550: 6c66 2e63 6f6c 756d 6e73 5b63 6f6c 5d2e  lf.columns[col].
-0003d560: 6465 7363 7269 7074 696f 6e29 0a20 2020  description).   
-0003d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d5a0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-0003d5b0: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
-0003d5c0: 5f6c 696e 6573 202b 3d20 6465 7363 720a  _lines += descr.
-0003d5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d5e0: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-0003d5f0: 6963 5f6c 6973 743a 0a20 2020 2020 2020  ic_list:.       
-0003d600: 2020 2020 2023 2049 6e73 6572 7420 696e       # Insert in
-0003d610: 7075 7420 6c69 6e65 730a 0a20 2020 2020  put lines..     
-0003d620: 2020 2020 2020 2066 6f72 2069 6c2c 206c         for il, l
-0003d630: 696e 6520 696e 2065 6e75 6d65 7261 7465  ine in enumerate
-0003d640: 286c 696e 6573 293a 0a20 2020 2020 2020  (lines):.       
-0003d650: 2020 2020 2020 2020 2069 6620 277d 2029           if '} )
-0003d660: 3b20 203c 2f73 6372 6970 743e 2720 696e  ;  </script>' in
-0003d670: 206c 696e 653a 0a20 2020 2020 2020 2020   line:.         
-0003d680: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0003d690: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-0003d6a0: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
-0003d6b0: 5f72 6f77 203d 2027 3c74 723e 203c 7464  _row = '<tr> <td
-0003d6c0: 3e20 3c69 6e70 7574 2074 7970 653d 2274  > <input type="t
-0003d6d0: 6578 7422 2069 643d 227b 307d 5f6d 696e  ext" id="{0}_min
-0003d6e0: 2220 6e61 6d65 3d22 7b30 7d5f 6d69 6e22  " name="{0}_min"
-0003d6f0: 2073 7479 6c65 3d22 7769 6474 683a 3430   style="width:40
-0003d700: 7078 3b22 3e20 2623 3630 3b20 3c2f 7464  px;"> &#60; </td
-0003d710: 3e20 3c74 6420 7374 796c 653d 2261 6c69  > <td style="ali
-0003d720: 676e 3a63 656e 7465 723b 223e 203c 7474  gn:center;"> <tt
-0003d730: 3e7b 307d 3c2f 7474 3e20 3c2f 7464 3e20  >{0}</tt> </td> 
-0003d740: 3c74 643e 2020 2623 3630 3b20 3c69 6e70  <td>  &#60; <inp
-0003d750: 7574 2074 7970 653d 2274 6578 7422 2069  ut type="text" i
-0003d760: 643d 227b 307d 5f6d 6178 2220 6e61 6d65  d="{0}_max" name
-0003d770: 3d22 7b30 7d5f 6d61 7822 2073 7479 6c65  ="{0}_max" style
-0003d780: 3d22 7769 6474 683a 3430 7078 3b22 3e27  ="width:40px;">'
-0003d790: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-0003d7a0: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
-0003d7b0: 5f72 6f77 7320 3d20 5b5d 0a20 2020 2020  _rows = [].     
-0003d7c0: 2020 2020 2020 2066 6f72 2069 6320 696e         for ic in
-0003d7d0: 2069 635f 6c69 7374 3a0a 2020 2020 2020   ic_list:.      
-0003d7e0: 2020 2020 2020 2020 2020 636f 6c20 3d20            col = 
-0003d7f0: 7365 6c66 2e63 6f6c 6e61 6d65 735b 6963  self.colnames[ic
-0003d800: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003d810: 2020 726f 775f 6920 3d20 6669 6c74 6572    row_i = filter
-0003d820: 5f72 6f77 2e66 6f72 6d61 7428 636f 6c29  _row.format(col)
-0003d830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d840: 2064 6573 6372 203d 2027 5c6e 270a 2020   descr = '\n'.  
-0003d850: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003d860: 2068 6173 6174 7472 2873 656c 662e 636f   hasattr(self.co
-0003d870: 6c75 6d6e 735b 636f 6c5d 2c20 2764 6573  lumns[col], 'des
-0003d880: 6372 6970 7469 6f6e 2729 3a0a 2020 2020  cription'):.    
-0003d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d8a0: 6966 2073 656c 662e 636f 6c75 6d6e 735b  if self.columns[
-0003d8b0: 636f 6c5d 2e64 6573 6372 6970 7469 6f6e  col].description
-0003d8c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0003d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d8e0: 2020 2020 2020 6465 7363 7220 3d20 277b        descr = '{
-0003d8f0: 307d 207b 317d 5c6e 272e 666f 726d 6174  0} {1}\n'.format
-0003d900: 2864 6573 6372 5f70 6164 2c20 0a20 2020  (descr_pad, .   
-0003d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d930: 2020 2020 2073 656c 662e 636f 6c75 6d6e       self.column
-0003d940: 735b 636f 6c5d 2e64 6573 6372 6970 7469  s[col].descripti
-0003d950: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-0003d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d980: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0003d990: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
-0003d9a0: 726f 7773 2e61 7070 656e 6428 726f 775f  rows.append(row_
-0003d9b0: 6920 2b20 6465 7363 7229 0a20 2020 2020  i + descr).     
-0003d9c0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0003d9d0: 2020 2020 2020 2020 6669 6c74 6572 5f69          filter_i
-0003d9e0: 6e70 7574 203d 2022 2222 0a0a 3c64 6976  nput = """..<div
-0003d9f0: 2073 7479 6c65 3d22 626f 7264 6572 3a31   style="border:1
-0003da00: 7078 2073 6f6c 6964 2062 6c61 636b 3b20  px solid black; 
-0003da10: 7061 6464 696e 673a 3130 7078 3b20 6d61  padding:10px; ma
-0003da20: 7267 696e 3a31 3070 7822 3e0a 3c62 3e20  rgin:10px">.<b> 
-0003da30: 4669 6c74 6572 3a20 3c2f 623e 0a20 2020  Filter: </b>.   
-0003da40: 203c 7461 626c 653e 0a20 2020 2020 207b   <table>.      {
-0003da50: 307d 0a20 2020 203c 2f74 6162 6c65 3e0a  0}.    </table>.
-0003da60: 3c2f 6469 763e 0a0a 2222 222e 666f 726d  </div>..""".form
-0003da70: 6174 2827 5c6e 272e 6a6f 696e 2866 696c  at('\n'.join(fil
-0003da80: 7465 725f 726f 7773 2929 0a0a 2020 2020  ter_rows))..    
-0003da90: 2020 2020 2020 2020 6c69 6e65 732e 696e          lines.in
-0003daa0: 7365 7274 2869 6c2b 312c 2066 696c 7465  sert(il+1, filte
-0003dab0: 725f 696e 7075 7429 0a0a 2020 2020 2020  r_input)..      
-0003dac0: 2020 2020 2020 2320 4a61 7661 7363 7269        # Javascri
-0003dad0: 7074 2070 7573 6820 6675 6e63 7469 6f6e  pt push function
-0003dae0: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
-0003daf0: 6465 725f 6c69 6e65 7320 3d20 2222 0a20  der_lines = "". 
-0003db00: 2020 2020 2020 2020 2020 2074 6573 7465             teste
-0003db10: 7220 3d20 5b5d 0a0a 2020 2020 2020 2020  r = []..        
-0003db20: 2020 2020 666f 7220 6963 2069 6e20 6963      for ic in ic
-0003db30: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
-0003db40: 2020 2020 2020 2068 6561 6465 725f 6c69         header_li
-0003db50: 6e65 7320 2b3d 2022 2222 0a20 2020 2020  nes += """.     
-0003db60: 2020 2076 6172 206d 696e 5f7b 307d 203d     var min_{0} =
-0003db70: 2070 6172 7365 466c 6f61 7428 2024 2827   parseFloat( $('
-0003db80: 237b 307d 5f6d 696e 2729 2e76 616c 2829  #{0}_min').val()
-0003db90: 2920 7c7c 202d 3165 3330 3b0a 2020 2020  ) || -1e30;.    
-0003dba0: 2020 2020 7661 7220 6d61 785f 7b30 7d20      var max_{0} 
-0003dbb0: 3d20 7061 7273 6546 6c6f 6174 2820 2428  = parseFloat( $(
-0003dbc0: 2723 7b30 7d5f 6d61 7827 292e 7661 6c28  '#{0}_max').val(
-0003dbd0: 2929 207c 7c20 2031 6533 303b 0a20 2020  )) ||  1e30;.   
-0003dbe0: 2020 2020 2076 6172 2064 6174 615f 7b30       var data_{0
-0003dbf0: 7d20 3d20 7061 7273 6546 6c6f 6174 2820  } = parseFloat( 
-0003dc00: 6461 7461 5b7b 317d 5d20 2920 7c7c 2030  data[{1}] ) || 0
-0003dc10: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0003dc20: 2020 2222 222e 666f 726d 6174 2873 656c    """.format(sel
-0003dc30: 662e 636f 6c6e 616d 6573 5b69 635d 2c20  f.colnames[ic], 
-0003dc40: 6963 290a 0a20 2020 2020 2020 2020 2020  ic)..           
-0003dc50: 2020 2020 2074 6573 7465 722e 6170 7065       tester.appe
-0003dc60: 6e64 2822 2222 2820 2820 6973 4e61 4e28  nd("""( ( isNaN(
-0003dc70: 206d 696e 5f7b 307d 2029 2026 2620 6973   min_{0} ) && is
-0003dc80: 4e61 4e28 206d 6178 5f7b 307d 2029 2029  NaN( max_{0} ) )
-0003dc90: 207c 7c20 2820 6973 4e61 4e28 206d 696e   || ( isNaN( min
-0003dca0: 5f7b 307d 2029 2026 2620 6461 7461 5f7b  _{0} ) && data_{
-0003dcb0: 307d 203c 3d20 6d61 785f 7b30 7d20 2920  0} <= max_{0} ) 
-0003dcc0: 7c7c 2028 206d 696e 5f7b 307d 203c 3d20  || ( min_{0} <= 
-0003dcd0: 6461 7461 5f7b 307d 2020 2626 2069 734e  data_{0}  && isN
-0003dce0: 614e 2820 6d61 785f 7b30 7d20 2920 2920  aN( max_{0} ) ) 
-0003dcf0: 7c7c 2028 206d 696e 5f7b 307d 203c 3d20  || ( min_{0} <= 
-0003dd00: 6461 7461 5f7b 307d 2020 2626 2064 6174  data_{0}  && dat
-0003dd10: 615f 7b30 7d20 3c3d 206d 6178 5f7b 307d  a_{0} <= max_{0}
-0003dd20: 2029 2029 2222 222e 666f 726d 6174 2873   ) )""".format(s
-0003dd30: 656c 662e 636f 6c6e 616d 6573 5b69 635d  elf.colnames[ic]
-0003dd40: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-0003dd50: 2320 4a61 7661 7363 7269 7074 2066 696c  # Javascript fil
-0003dd60: 7465 7220 6675 6e63 7469 6f6e 0a20 2020  ter function.   
-0003dd70: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
-0003dd80: 6675 6e63 7469 6f6e 203d 2022 2222 0a0a  function = """..
-0003dd90: 2f2f 2f2f 2050 6172 7365 720a 2f2f 2068  //// Parser.// h
-0003dda0: 7474 7073 3a2f 2f73 7461 636b 6f76 6572  ttps://stackover
-0003ddb0: 666c 6f77 2e63 6f6d 2f71 7565 7374 696f  flow.com/questio
-0003ddc0: 6e73 2f31 3934 3931 3333 362f 6765 742d  ns/19491336/get-
-0003ddd0: 7572 6c2d 7061 7261 6d65 7465 722d 6a71  url-parameter-jq
-0003dde0: 7565 7279 2d6f 722d 686f 772d 746f 2d67  uery-or-how-to-g
-0003ddf0: 6574 2d71 7565 7279 2d73 7472 696e 672d  et-query-string-
-0003de00: 7661 6c75 6573 2d69 6e2d 6a73 2040 2052  values-in-js @ R
-0003de10: 657a 6120 4261 7261 6461 7261 6e0a 242e  eza Baradaran.$.
-0003de20: 7572 6c50 6172 616d 203d 2066 756e 6374  urlParam = funct
-0003de30: 696f 6e28 6e61 6d65 297b 7b0a 2020 2020  ion(name){{.    
-0003de40: 7661 7220 7265 7375 6c74 7320 3d20 6e65  var results = ne
-0003de50: 7720 5265 6745 7870 2827 5b5c 3f26 5d27  w RegExp('[\?&]'
-0003de60: 202b 206e 616d 6520 2b20 273d 285b 5e26   + name + '=([^&
-0003de70: 235d 2a29 2729 2e65 7865 6328 7769 6e64  #]*)').exec(wind
-0003de80: 6f77 2e6c 6f63 6174 696f 6e2e 6872 6566  ow.location.href
-0003de90: 293b 0a20 2020 2069 6620 2872 6573 756c  );.    if (resul
-0003dea0: 7473 3d3d 6e75 6c6c 297b 7b0a 2020 2020  ts==null){{.    
-0003deb0: 2020 2072 6574 7572 6e20 6e75 6c6c 3b0a     return null;.
-0003dec0: 2020 2020 7d7d 0a20 2020 2065 6c73 657b      }}.    else{
-0003ded0: 7b0a 2020 2020 2020 2072 6574 7572 6e20  {.       return 
-0003dee0: 6465 636f 6465 5552 4928 7265 7375 6c74  decodeURI(result
-0003def0: 735b 315d 2920 7c7c 2030 3b0a 2020 2020  s[1]) || 0;.    
-0003df00: 7d7d 0a7d 7d0a 0a24 2e66 6e2e 6461 7461  }}.}}..$.fn.data
-0003df10: 5461 626c 652e 6578 742e 7365 6172 6368  Table.ext.search
-0003df20: 2e70 7573 6828 0a20 2020 2066 756e 6374  .push(.    funct
-0003df30: 696f 6e28 2073 6574 7469 6e67 732c 2064  ion( settings, d
-0003df40: 6174 612c 2064 6174 6149 6e64 6578 2029  ata, dataIndex )
-0003df50: 207b 7b0a 7b30 7d0a 0a20 2020 2020 2020   {{.{0}..       
-0003df60: 2069 6620 2820 7b31 7d20 290a 2020 2020   if ( {1} ).    
-0003df70: 2020 2020 7b7b 0a20 2020 2020 2020 2020      {{.         
-0003df80: 2020 2072 6574 7572 6e20 7472 7565 3b0a     return true;.
-0003df90: 2020 2020 2020 2020 7d7d 0a20 2020 2020          }}.     
-0003dfa0: 2020 2072 6574 7572 6e20 6661 6c73 653b     return false;
-0003dfb0: 0a20 2020 207d 7d0a 293b 0a0a 2f2f 2f2f  .    }}.);..////
-0003dfc0: 2055 7064 6174 6520 5552 4c20 7769 7468   Update URL with
-0003dfd0: 2066 696c 7465 7220 7061 7261 6d65 7465   filter paramete
-0003dfe0: 7273 0a76 6172 2066 696c 7465 725f 7061  rs.var filter_pa
-0003dff0: 7261 6d73 203d 207b 327d 3b0a 0a24 2e55  rams = {2};..$.U
-0003e000: 7064 6174 6546 696c 7465 7255 524c 203d  pdateFilterURL =
-0003e010: 2066 756e 6374 696f 6e20 2829 207b 7b0a   function () {{.
-0003e020: 2020 2020 7661 7220 693b 0a20 2020 2076      var i;.    v
-0003e030: 6172 2066 696c 7465 725f 7572 6c20 3d20  ar filter_url = 
-0003e040: 2222 3b0a 2020 2020 666f 7220 2869 203d  "";.    for (i =
-0003e050: 2030 3b20 6920 3c20 6669 6c74 6572 5f70   0; i < filter_p
-0003e060: 6172 616d 732e 6c65 6e67 7468 3b20 692b  arams.length; i+
-0003e070: 2b29 207b 7b0a 2020 2020 2020 2020 6966  +) {{.        if
-0003e080: 2028 2428 2723 272b 6669 6c74 6572 5f70   ($('#'+filter_p
-0003e090: 6172 616d 735b 695d 2b27 5f6d 696e 2729  arams[i]+'_min')
-0003e0a0: 2e76 616c 2829 2021 3d20 2222 2920 7b7b  .val() != "") {{
-0003e0b0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-0003e0c0: 7465 725f 7572 6c20 2b3d 2027 2627 2b66  ter_url += '&'+f
-0003e0d0: 696c 7465 725f 7061 7261 6d73 5b69 5d2b  ilter_params[i]+
-0003e0e0: 275f 6d69 6e3d 272b 0a20 2020 2020 2020  '_min='+.       
-0003e0f0: 2020 2020 2020 2020 2020 2020 2024 2827               $('
-0003e100: 2327 2b66 696c 7465 725f 7061 7261 6d73  #'+filter_params
-0003e110: 5b69 5d2b 275f 6d69 6e27 292e 7661 6c28  [i]+'_min').val(
-0003e120: 293b 0a20 2020 2020 2020 207d 7d0a 2020  );.        }}.  
-0003e130: 2020 2020 2020 6966 2028 2428 2723 272b        if ($('#'+
-0003e140: 6669 6c74 6572 5f70 6172 616d 735b 695d  filter_params[i]
-0003e150: 2b27 5f6d 6178 2729 2e76 616c 2829 2021  +'_max').val() !
-0003e160: 3d20 2222 2920 7b7b 0a20 2020 2020 2020  = "") {{.       
-0003e170: 2020 2020 2066 696c 7465 725f 7572 6c20       filter_url 
-0003e180: 2b3d 2027 2627 2b66 696c 7465 725f 7061  += '&'+filter_pa
-0003e190: 7261 6d73 5b69 5d2b 275f 6d61 783d 272b  rams[i]+'_max='+
-0003e1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e1b0: 2020 2020 2024 2827 2327 2b66 696c 7465       $('#'+filte
-0003e1c0: 725f 7061 7261 6d73 5b69 5d2b 275f 6d61  r_params[i]+'_ma
-0003e1d0: 7827 292e 7661 6c28 293b 0a20 2020 2020  x').val();.     
-0003e1e0: 2020 207d 7d0a 2020 2020 7d7d 0a0a 2020     }}.    }}..  
-0003e1f0: 2020 6966 2028 6669 6c74 6572 5f75 726c    if (filter_url
-0003e200: 2021 3d20 2222 2920 7b7b 0a20 2020 2020   != "") {{.     
-0003e210: 2020 2076 6172 2066 696c 7465 7265 645f     var filtered_
-0003e220: 7572 6c20 3d20 7769 6e64 6f77 2e6c 6f63  url = window.loc
-0003e230: 6174 696f 6e2e 6872 6566 2e73 706c 6974  ation.href.split
-0003e240: 2827 3f27 295b 305d 202b 2027 3f27 202b  ('?')[0] + '?' +
-0003e250: 2066 696c 7465 725f 7572 6c3b 0a20 2020   filter_url;.   
-0003e260: 2020 2020 2077 696e 646f 772e 6869 7374       window.hist
-0003e270: 6f72 792e 7075 7368 5374 6174 6528 2727  ory.pushState(''
-0003e280: 2c20 2727 2c20 6669 6c74 6572 6564 5f75  , '', filtered_u
-0003e290: 726c 293b 0a20 2020 207d 7d0a 7d7d 5c6e  rl);.    }}.}}\n
-0003e2a0: 5c6e 2222 222e 666f 726d 6174 2868 6561  \n""".format(hea
-0003e2b0: 6465 725f 6c69 6e65 732c 2022 5c6e 2026  der_lines, "\n &
-0003e2c0: 2620 222e 6a6f 696e 2874 6573 7465 7229  & ".join(tester)
-0003e2d0: 2c20 5b73 656c 662e 636f 6c6e 616d 6573  , [self.colnames
-0003e2e0: 5b69 635d 2066 6f72 2069 6320 696e 2069  [ic] for ic in i
-0003e2f0: 635f 6c69 7374 5d2e 5f5f 7265 7072 5f5f  c_list].__repr__
-0003e300: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
-0003e310: 2066 6f72 2069 2c20 6c69 6e65 2069 6e20   for i, line in 
-0003e320: 656e 756d 6572 6174 6528 6c69 6e65 7329  enumerate(lines)
-0003e330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003e340: 2020 6966 2022 2428 646f 6375 6d65 6e74    if "$(document
-0003e350: 292e 7265 6164 7928 6675 6e63 7469 6f6e  ).ready(function
-0003e360: 2829 2220 696e 206c 696e 653a 0a20 2020  ()" in line:.   
-0003e370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e380: 2069 7374 6172 7420 3d20 690a 2020 2020   istart = i.    
-0003e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e3a0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
-0003e3b0: 2020 206c 696e 6573 2e69 6e73 6572 7428     lines.insert(
-0003e3c0: 6973 7461 7274 2c20 6669 6c74 6572 5f66  istart, filter_f
-0003e3d0: 756e 6374 696f 6e29 0a0a 2020 2020 2020  unction)..      
-0003e3e0: 2020 2020 2020 2320 5061 7273 6520 6164        # Parse ad
-0003e3f0: 6472 6573 7320 6261 720a 2020 2020 2020  dress bar.      
-0003e400: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
-0003e410: 7274 2869 7374 6172 742b 322c 2022 5c6e  rt(istart+2, "\n
-0003e420: 2229 0a20 2020 2020 2020 2020 2020 2066  ").            f
-0003e430: 6f72 2069 6320 696e 2069 635f 6c69 7374  or ic in ic_list
-0003e440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003e450: 2020 6c69 6e65 732e 696e 7365 7274 2869    lines.insert(i
-0003e460: 7374 6172 742b 322c 2022 7b31 7d24 2827  start+2, "{1}$('
-0003e470: 237b 307d 5f6d 6178 2729 2e76 616c 2824  #{0}_max').val($
-0003e480: 2e75 726c 5061 7261 6d28 277b 307d 5f6d  .urlParam('{0}_m
-0003e490: 6178 2729 293b 5c6e 222e 666f 726d 6174  ax'));\n".format
-0003e4a0: 2873 656c 662e 636f 6c6e 616d 6573 5b69  (self.colnames[i
-0003e4b0: 635d 2c20 2720 272a 3329 290a 2020 2020  c], ' '*3)).    
-0003e4c0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-0003e4d0: 732e 696e 7365 7274 2869 7374 6172 742b  s.insert(istart+
-0003e4e0: 322c 2022 7b31 7d24 2827 237b 307d 5f6d  2, "{1}$('#{0}_m
-0003e4f0: 696e 2729 2e76 616c 2824 2e75 726c 5061  in').val($.urlPa
-0003e500: 7261 6d28 277b 307d 5f6d 696e 2729 293b  ram('{0}_min'));
-0003e510: 5c6e 222e 666f 726d 6174 2873 656c 662e  \n".format(self.
-0003e520: 636f 6c6e 616d 6573 5b69 635d 2c20 2720  colnames[ic], ' 
-0003e530: 272a 3329 290a 2020 2020 2020 2020 2020  '*3)).          
-0003e540: 2020 6c69 6e65 732e 696e 7365 7274 2869    lines.insert(i
-0003e550: 7374 6172 742b 322c 2022 5c6e 2229 0a0a  start+2, "\n")..
-0003e560: 2020 2020 2020 2020 2020 2020 2320 496e              # In
-0003e570: 7075 7420 6c69 7374 656e 6572 0a20 2020  put listener.   
-0003e580: 2020 2020 2020 2020 206c 6973 7465 6e65           listene
-0003e590: 7220 3d20 2222 220a 2020 2020 2f2f 2045  r = """.    // E
-0003e5a0: 7665 6e74 206c 6973 7465 6e65 7220 746f  vent listener to
-0003e5b0: 2074 6865 2074 776f 2072 616e 6765 2066   the two range f
-0003e5c0: 696c 7465 7269 6e67 2069 6e70 7574 7320  iltering inputs 
-0003e5d0: 746f 2072 6564 7261 7720 6f6e 2069 6e70  to redraw on inp
-0003e5e0: 7574 0a20 2020 2024 2827 7b30 7d27 292e  ut.    $('{0}').
-0003e5f0: 6b65 7975 7028 2066 756e 6374 696f 6e28  keyup( function(
-0003e600: 2920 7b7b 0a20 2020 2020 2020 2074 6162  ) {{.        tab
-0003e610: 6c65 2e64 7261 7728 293b 0a20 2020 2020  le.draw();.     
-0003e620: 2020 2024 2e55 7064 6174 6546 696c 7465     $.UpdateFilte
-0003e630: 7255 524c 2829 3b0a 2020 2020 7d7d 2029  rURL();.    }} )
-0003e640: 3b0a 2020 2020 2020 2020 2020 2020 2222  ;.            ""
-0003e650: 222e 666f 726d 6174 2827 2c20 272e 6a6f  ".format(', '.jo
-0003e660: 696e 285b 2723 7b30 7d5f 6d69 6e2c 2023  in(['#{0}_min, #
-0003e670: 7b30 7d5f 6d61 7827 2e66 6f72 6d61 7428  {0}_max'.format(
-0003e680: 7365 6c66 2e63 6f6c 6e61 6d65 735b 6963  self.colnames[ic
-0003e690: 5d29 2066 6f72 2069 6320 696e 2069 635f  ]) for ic in ic_
-0003e6a0: 6c69 7374 5d29 290a 0a20 2020 2020 2020  list]))..       
-0003e6b0: 2020 2020 2066 6f72 2069 6c2c 206c 696e       for il, lin
-0003e6c0: 6520 696e 2065 6e75 6d65 7261 7465 286c  e in enumerate(l
-0003e6d0: 696e 6573 293a 0a20 2020 2020 2020 2020  ines):.         
-0003e6e0: 2020 2020 2020 2069 6620 277d 2029 3b20         if '} ); 
-0003e6f0: 203c 2f73 6372 6970 743e 2720 696e 206c   </script>' in l
-0003e700: 696e 653a 0a20 2020 2020 2020 2020 2020  ine:.           
-0003e710: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-0003e720: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-0003e730: 732e 696e 7365 7274 2869 6c2c 206c 6973  s.insert(il, lis
-0003e740: 7465 6e65 7229 0a0a 2020 2020 2020 2020  tener)..        
-0003e750: 2020 2020 6670 203d 206f 7065 6e28 6f75      fp = open(ou
-0003e760: 7470 7574 2c20 2777 2729 0a20 2020 2020  tput, 'w').     
-0003e770: 2020 2020 2020 2066 702e 7772 6974 656c         fp.writel
-0003e780: 696e 6573 286c 696e 6573 290a 2020 2020  ines(lines).    
-0003e790: 2020 2020 2020 2020 6670 2e63 6c6f 7365          fp.close
-0003e7a0: 2829 0a0a 2020 2020 2020 2020 6966 2074  ()..        if t
-0003e7b0: 6f67 676c 653a 0a20 2020 2020 2020 2020  oggle:.         
-0003e7c0: 2020 206c 696e 6573 203d 206f 7065 6e28     lines = open(
-0003e7d0: 6f75 7470 7574 292e 7265 6164 6c69 6e65  output).readline
-0003e7e0: 7328 290a 0a20 2020 2020 2020 2020 2020  s()..           
-0003e7f0: 2023 2043 6861 6e67 6520 6361 6c6c 2074   # Change call t
-0003e800: 6f20 4461 7461 5461 626c 650a 2020 2020  o DataTable.    
-0003e810: 2020 2020 2020 2020 666f 7220 696c 2c20          for il, 
-0003e820: 6c69 6e65 2069 6e20 656e 756d 6572 6174  line in enumerat
-0003e830: 6528 6c69 6e65 7329 3a0a 2020 2020 2020  e(lines):.      
-0003e840: 2020 2020 2020 2020 2020 6966 2027 6461            if 'da
-0003e850: 7461 5461 626c 6528 2720 696e 206c 696e  taTable(' in lin
-0003e860: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003e870: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-0003e880: 2020 2020 2020 2020 2020 6c69 6e65 735b            lines[
-0003e890: 696c 5d20 3d20 2220 2020 7661 7220 7461  il] = "   var ta
-0003e8a0: 626c 6520 3d20 7b30 7d5c 6e22 2e66 6f72  ble = {0}\n".for
-0003e8b0: 6d61 7428 6c69 6e65 735b 696c 5d2e 7374  mat(lines[il].st
-0003e8c0: 7269 7028 292e 7265 706c 6163 6528 2764  rip().replace('d
-0003e8d0: 6174 6154 6162 6c65 272c 2027 4461 7461  ataTable', 'Data
-0003e8e0: 5461 626c 6527 2929 0a0a 2020 2020 2020  Table'))..      
-0003e8f0: 2020 2020 2020 2320 4164 6420 6675 6e63        # Add func
-0003e900: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-0003e910: 2066 6f72 2069 6c2c 206c 696e 6520 696e   for il, line in
-0003e920: 2065 6e75 6d65 7261 7465 286c 696e 6573   enumerate(lines
-0003e930: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003e940: 2020 2069 6620 277d 2029 3b20 203c 2f73     if '} );  </s
-0003e950: 6372 6970 743e 2720 696e 206c 696e 653a  cript>' in line:
-0003e960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e970: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-0003e980: 2020 2020 2020 2020 746f 6767 6c65 7220          toggler 
-0003e990: 3d20 2222 220a 2020 2020 2428 2761 2e74  = """.    $('a.t
-0003e9a0: 6f67 676c 652d 7669 7327 292e 6f6e 2820  oggle-vis').on( 
-0003e9b0: 2763 6c69 636b 272c 2066 756e 6374 696f  'click', functio
-0003e9c0: 6e20 2865 2920 7b0a 2020 2020 2020 2020  n (e) {.        
-0003e9d0: 652e 7072 6576 656e 7444 6566 6175 6c74  e.preventDefault
-0003e9e0: 2829 3b0a 0a20 2020 2020 2020 202f 2f20  ();..        // 
-0003e9f0: 4765 7420 7468 6520 636f 6c75 6d6e 2041  Get the column A
-0003ea00: 5049 206f 626a 6563 740a 2020 2020 2020  PI object.      
-0003ea10: 2020 7661 7220 636f 6c75 6d6e 203d 2074    var column = t
-0003ea20: 6162 6c65 2e63 6f6c 756d 6e28 2024 2874  able.column( $(t
-0003ea30: 6869 7329 2e61 7474 7228 2764 6174 612d  his).attr('data-
-0003ea40: 636f 6c75 6d6e 2729 2029 3b0a 0a20 2020  column') );..   
-0003ea50: 2020 2020 202f 2f20 546f 6767 6c65 2074       // Toggle t
-0003ea60: 6865 2076 6973 6962 696c 6974 790a 2020  he visibility.  
-0003ea70: 2020 2020 2020 636f 6c75 6d6e 2e76 6973        column.vis
-0003ea80: 6962 6c65 2820 2120 636f 6c75 6d6e 2e76  ible( ! column.v
-0003ea90: 6973 6962 6c65 2829 2029 3b0a 2020 2020  isible() );.    
-0003eaa0: 7d20 293b 0a0a 2020 2020 2020 2020 2020  } );..          
-0003eab0: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
-0003eac0: 2020 6c69 6e65 732e 696e 7365 7274 2869    lines.insert(i
-0003ead0: 6c2c 2074 6f67 676c 6572 290a 0a20 2020  l, toggler)..   
-0003eae0: 2020 2020 2020 2020 2074 6f67 676c 655f           toggle_
-0003eaf0: 6469 7620 3d20 2222 220a 3c64 6976 2073  div = """.<div s
-0003eb00: 7479 6c65 3d22 626f 7264 6572 3a31 7078  tyle="border:1px
-0003eb10: 2073 6f6c 6964 2062 6c61 636b 3b20 7061   solid black; pa
-0003eb20: 6464 696e 673a 3130 7078 3b20 6d61 7267  dding:10px; marg
-0003eb30: 696e 3a31 3070 7822 3e0a 2020 2020 3c62  in:10px">.    <b
-0003eb40: 3e54 6f67 676c 6520 636f 6c75 6d6e 3a3c  >Toggle column:<
-0003eb50: 2f62 3e3c 2f62 723e 207b 307d 0a3c 2f64  /b></br> {0}.</d
-0003eb60: 6976 3e0a 0a20 2020 2020 2020 2020 2020  iv>..           
-0003eb70: 2022 2222 2e66 6f72 6d61 7428 2720 3c62   """.format(' <b
-0003eb80: 3e2f 3c2f 623e 2027 2e6a 6f69 6e28 5b27  >/</b> '.join(['
-0003eb90: 3c61 2063 6c61 7373 3d22 746f 6767 6c65  <a class="toggle
-0003eba0: 2d76 6973 2220 6461 7461 2d63 6f6c 756d  -vis" data-colum
-0003ebb0: 6e3d 227b 307d 223e 203c 7474 3e7b 317d  n="{0}"> <tt>{1}
-0003ebc0: 3c2f 7474 3e20 3c2f 613e 272e 666f 726d  </tt> </a>'.form
-0003ebd0: 6174 2869 632c 2063 6f6c 2920 666f 7220  at(ic, col) for 
-0003ebe0: 6963 2c20 636f 6c20 696e 2065 6e75 6d65  ic, col in enume
-0003ebf0: 7261 7465 2873 656c 662e 636f 6c6e 616d  rate(self.colnam
-0003ec00: 6573 295d 2929 0a0a 2020 2020 2020 2020  es)]))..        
-0003ec10: 2020 2020 6c69 6e65 732e 696e 7365 7274      lines.insert
-0003ec20: 2869 6c2b 322c 2074 6f67 676c 655f 6469  (il+2, toggle_di
-0003ec30: 7629 0a0a 2020 2020 2020 2020 2020 2020  v)..            
-0003ec40: 6670 203d 206f 7065 6e28 6f75 7470 7574  fp = open(output
-0003ec50: 2c20 2777 2729 0a20 2020 2020 2020 2020  , 'w').         
-0003ec60: 2020 2066 702e 7772 6974 656c 696e 6573     fp.writelines
-0003ec70: 286c 696e 6573 290a 2020 2020 2020 2020  (lines).        
-0003ec80: 2020 2020 6670 2e63 6c6f 7365 2829 0a0a      fp.close()..
-0003ec90: 2020 2020 2020 2020 6966 2075 7365 5f6a          if use_j
-0003eca0: 736f 6e3a 0a20 2020 2020 2020 2020 2020  son:.           
-0003ecb0: 2023 2057 7269 7465 2061 7320 6a73 6f6e   # Write as json
-0003ecc0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0003ecd0: 576f 726b 6172 6f75 6e64 2074 6f20 6765  Workaround to ge
-0003ece0: 7420 6173 6369 6920 666f 726d 6174 7469  t ascii formatti
-0003ecf0: 6e67 0a20 2020 2020 2020 2020 2020 2023  ng.            #
-0003ed00: 7064 203d 2073 656c 662e 746f 5f70 616e  pd = self.to_pan
-0003ed10: 6461 7328 290a 2020 2020 2020 2020 2020  das().          
-0003ed20: 2020 6e65 7720 3d20 4754 6162 6c65 2829    new = GTable()
-0003ed30: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0003ed40: 2063 2069 6e20 7365 6c66 2e63 6f6c 6e61   c in self.colna
-0003ed50: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
-0003ed60: 2020 2020 206e 6577 5b63 5d20 3d20 7365       new[c] = se
-0003ed70: 6c66 5b63 5d0a 0a20 2020 2020 2020 2020  lf[c]..         
-0003ed80: 2020 2069 6620 2761 6c61 6469 6e27 2069     if 'aladin' i
-0003ed90: 6e20 7365 6c66 2e63 6f6c 6e61 6d65 733a  n self.colnames:
-0003eda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003edb0: 2070 6420 3d20 4754 6162 6c65 286e 6577   pd = GTable(new
-0003edc0: 292e 746f 5f70 616e 6461 7328 290a 2020  ).to_pandas().  
-0003edd0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0003ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003edf0: 6e65 772e 7772 6974 6528 272f 746d 702f  new.write('/tmp/
-0003ee00: 7461 626c 652e 6373 7627 2c20 666f 726d  table.csv', form
-0003ee10: 6174 3d27 6373 7627 2c20 6f76 6572 7772  at='csv', overwr
-0003ee20: 6974 653d 5472 7565 290a 2020 2020 2020  ite=True).      
-0003ee30: 2020 2020 2020 2020 2020 7064 203d 2047            pd = G
-0003ee40: 5461 626c 652e 6772 6561 6428 272f 746d  Table.gread('/tm
-0003ee50: 702f 7461 626c 652e 6373 7627 292e 746f  p/table.csv').to
-0003ee60: 5f70 616e 6461 7328 290a 0a20 2020 2020  _pandas()..     
-0003ee70: 2020 2020 2020 2023 2052 6566 6f72 6d61         # Reforma
-0003ee80: 7420 746f 206a 736f 6e0a 2020 2020 2020  t to json.      
-0003ee90: 2020 2020 2020 6a73 6f6e 5f64 6174 6120        json_data 
-0003eea0: 3d20 2720 2020 2020 2020 2027 202b 2070  = '        ' + p
-0003eeb0: 642e 746f 5f6a 736f 6e28 6f72 6965 6e74  d.to_json(orient
-0003eec0: 3d27 7661 6c75 6573 2729 2e72 6570 6c61  ='values').repla
-0003eed0: 6365 2827 5d2c 5b27 2c20 275c 6e20 2020  ce('],[', '\n   
-0003eee0: 205d 7878 7878 7878 5c6e 2020 2020 5b5c   ]xxxxxx\n    [\
-0003eef0: 6e20 2020 2020 2020 2027 292e 7265 706c  n        ').repl
-0003ef00: 6163 6528 272c 2027 2c20 2778 636f 6d6d  ace(', ', 'xcomm
-0003ef10: 6173 7061 6365 7827 292e 7265 706c 6163  aspacex').replac
-0003ef20: 6528 272c 272c 2027 2c5c 6e20 2020 2020  e(',', ',\n     
-0003ef30: 2020 2027 292e 7265 706c 6163 6528 2778     ').replace('x
-0003ef40: 7878 7878 7827 2c20 272c 2729 2e72 6570  xxxxx', ',').rep
-0003ef50: 6c61 6365 2827 7863 6f6d 6d61 7370 6163  lace('xcommaspac
-0003ef60: 6578 272c 2027 2c20 2729 0a20 2020 2020  ex', ', ').     
-0003ef70: 2020 2020 2020 206a 736f 6e5f 7374 7220         json_str 
-0003ef80: 3d20 2222 227b 7b0a 2020 2264 6174 6122  = """{{.  "data"
-0003ef90: 3a0a 7b30 7d0a 0a7d 7d0a 2222 222e 666f  :.{0}..}}.""".fo
-0003efa0: 726d 6174 286a 736f 6e5f 6461 7461 2e72  rmat(json_data.r
-0003efb0: 6570 6c61 6365 2827 5c5c 2222 272c 2027  eplace('\\""', '
-0003efc0: 2227 2929 0a0a 2020 2020 2020 2020 2020  "'))..          
-0003efd0: 2020 6670 203d 206f 7065 6e28 6f75 7470    fp = open(outp
-0003efe0: 7574 2e72 6570 6c61 6365 2827 2e68 746d  ut.replace('.htm
-0003eff0: 6c27 2c20 272e 6a73 6f6e 2729 2c20 2777  l', '.json'), 'w
-0003f000: 2729 0a20 2020 2020 2020 2020 2020 2066  ').            f
-0003f010: 702e 7772 6974 6528 6a73 6f6e 5f73 7472  p.write(json_str
-0003f020: 290a 2020 2020 2020 2020 2020 2020 6670  ).            fp
-0003f030: 2e63 6c6f 7365 2829 0a0a 2020 2020 2020  .close()..      
-0003f040: 2020 2020 2020 2320 4564 6974 2048 544d        # Edit HTM
-0003f050: 4c20 6669 6c65 0a20 2020 2020 2020 2020  L file.         
-0003f060: 2020 206c 696e 6573 203d 206f 7065 6e28     lines = open(
-0003f070: 6f75 7470 7574 292e 7265 6164 6c69 6e65  output).readline
-0003f080: 7328 290a 0a20 2020 2020 2020 2020 2020  s()..           
-0003f090: 2023 2041 6464 2061 6a61 7820 6361 6c6c   # Add ajax call
-0003f0a0: 2074 6f20 4461 7461 5461 626c 650a 2020   to DataTable.  
-0003f0b0: 2020 2020 2020 2020 2020 666f 7220 696c            for il
-0003f0c0: 2c20 6c69 6e65 2069 6e20 656e 756d 6572  , line in enumer
-0003f0d0: 6174 6528 6c69 6e65 7329 3a0a 2020 2020  ate(lines):.    
-0003f0e0: 2020 2020 2020 2020 2020 2020 6966 2027              if '
-0003f0f0: 7061 6765 4c65 6e67 7468 2720 696e 206c  pageLength' in l
-0003f100: 696e 653a 0a20 2020 2020 2020 2020 2020  ine:.           
-0003f110: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-0003f120: 2020 2020 2020 2020 2020 2020 616a 6178              ajax
-0003f130: 5f63 616c 6c20 3d20 277b 7370 6163 6572  _call = '{spacer
-0003f140: 7d22 616a 6178 223a 2022 7b6a 736f 6e7d  }"ajax": "{json}
-0003f150: 222c 5c6e 7b73 7061 6365 727d 2264 6566  ",\n{spacer}"def
-0003f160: 6572 5265 6e64 6572 223a 2074 7275 652c  erRender": true,
-0003f170: 5c6e 272e 666f 726d 6174 2873 7061 6365  \n'.format(space
-0003f180: 723d 2720 272a 382c 206a 736f 6e3d 6f75  r=' '*8, json=ou
-0003f190: 7470 7574 2e72 6570 6c61 6365 2827 2e68  tput.replace('.h
-0003f1a0: 746d 6c27 2c20 272e 6a73 6f6e 2729 290a  tml', '.json')).
-0003f1b0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-0003f1c0: 732e 696e 7365 7274 2869 6c2b 312c 2061  s.insert(il+1, a
-0003f1d0: 6a61 785f 6361 6c6c 290a 0a20 2020 2020  jax_call)..     
-0003f1e0: 2020 2020 2020 2023 2053 7472 6970 206f         # Strip o
-0003f1f0: 7574 2074 6162 6c65 2062 6f64 790a 2020  ut table body.  
-0003f200: 2020 2020 2020 2020 2020 666f 7220 6968            for ih
-0003f210: 6561 642c 206c 696e 6520 696e 2065 6e75  ead, line in enu
-0003f220: 6d65 7261 7465 286c 696e 6573 293a 0a20  merate(lines):. 
-0003f230: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003f240: 6620 273c 2f74 6865 6164 3e27 2069 6e20  f '</thead>' in 
-0003f250: 6c69 6e65 3a0a 2020 2020 2020 2020 2020  line:.          
-0003f260: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0003f270: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0003f280: 2069 7461 696c 2c20 6c69 6e65 2069 6e20   itail, line in 
-0003f290: 656e 756d 6572 6174 6528 6c69 6e65 735b  enumerate(lines[
-0003f2a0: 3a3a 2d31 5d29 3a0a 2020 2020 2020 2020  ::-1]):.        
-0003f2b0: 2020 2020 2020 2020 6966 2027 3c2f 7472          if '</tr
-0003f2c0: 3e27 2069 6e20 6c69 6e65 3a0a 2020 2020  >' in line:.    
-0003f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f2e0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
-0003f2f0: 2020 2066 7020 3d20 6f70 656e 286f 7574     fp = open(out
-0003f300: 7075 742c 2027 7727 290a 2020 2020 2020  put, 'w').      
-0003f310: 2020 2020 2020 6670 2e77 7269 7465 6c69        fp.writeli
-0003f320: 6e65 7328 6c69 6e65 735b 3a69 6865 6164  nes(lines[:ihead
-0003f330: 2b31 5d29 0a20 2020 2020 2020 2020 2020  +1]).           
-0003f340: 2066 702e 7772 6974 656c 696e 6573 286c   fp.writelines(l
-0003f350: 696e 6573 5b2d 6974 6169 6c3a 5d29 0a20  ines[-itail:]). 
-0003f360: 2020 2020 2020 2020 2020 2066 702e 636c             fp.cl
-0003f370: 6f73 6528 290a 0a0a 6465 6620 636f 6c75  ose()...def colu
-0003f380: 6d6e 5f73 7472 696e 675f 6f70 6572 6174  mn_string_operat
-0003f390: 696f 6e28 636f 6c2c 2074 6573 742c 206d  ion(col, test, m
-0003f3a0: 6574 686f 643d 2763 6f6e 7461 696e 7327  ethod='contains'
-0003f3b0: 2c20 6c6f 6769 6361 6c3d 276f 7227 293a  , logical='or'):
-0003f3c0: 0a20 2020 2022 2222 0a20 2020 2041 6e61  .    """.    Ana
-0003f3d0: 6c6f 676f 7573 2074 6f20 6060 7374 722e  logous to ``str.
-0003f3e0: 636f 6e74 6169 6e73 6060 2062 7574 2066  contains`` but f
-0003f3f0: 6f72 2074 6162 6c65 2063 6f6c 756d 6e2e  or table column.
-0003f400: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-0003f410: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-0003f420: 2020 2020 636f 6c20 3a20 6974 6572 6162      col : iterab
-0003f430: 6c65 206c 6973 7420 6f66 2073 7472 696e  le list of strin
-0003f440: 6773 0a20 2020 2020 2020 204c 6973 7420  gs.        List 
-0003f450: 6f66 2073 7472 696e 6773 2074 6f20 7465  of strings to te
-0003f460: 7374 2e20 2041 6e79 7468 696e 6720 6974  st.  Anything it
-0003f470: 6572 6162 6c65 2c20 652e 672e 2c20 6c69  erable, e.g., li
-0003f480: 7374 206f 7220 0a20 2020 2020 2020 2060  st or .        `
-0003f490: 7e61 7374 726f 7079 2e74 6162 6c65 2e63  ~astropy.table.c
-0003f4a0: 6f6c 756d 6e2e 436f 6c75 6d6e 602e 0a0a  olumn.Column`...
-0003f4b0: 2020 2020 7465 7374 203a 2073 7472 2c20      test : str, 
-0003f4c0: 6c69 7374 206f 6620 7374 7269 6e67 732c  list of strings,
-0003f4d0: 204e 6f6e 652c 206f 7220 736c 6963 650a   None, or slice.
-0003f4e0: 0a20 2020 2020 2020 2049 6620 6060 7465  .        If ``te
-0003f4f0: 7374 6060 2069 7320 6120 7374 7269 6e67  st`` is a string
-0003f500: 2c20 6f72 206c 6973 7420 6f66 2073 7472  , or list of str
-0003f510: 696e 6773 2c20 7468 656e 2072 756e 2074  ings, then run t
-0003f520: 6865 2073 7472 696e 670a 2020 2020 2020  he string.      
-0003f530: 2020 6060 6d65 7468 6f64 6060 206f 6e20    ``method`` on 
-0003f540: 6561 6368 2065 6e74 7279 206f 6620 6060  each entry of ``
-0003f550: 636f 6c60 6020 7769 7468 2060 6074 6573  col`` with ``tes
-0003f560: 7460 6020 6173 2074 6865 2061 7267 756d  t`` as the argum
-0003f570: 656e 7420 6f72 0a20 2020 2020 2020 2065  ent or.        e
-0003f580: 6163 6820 656c 656d 656e 7420 6f66 2074  ach element of t
-0003f590: 6865 2060 6074 6573 7460 6020 6c69 7374  he ``test`` list
-0003f5a0: 2061 7320 6172 6775 6d65 6e74 732e 0a0a   as arguments...
-0003f5b0: 2020 2020 2020 2020 4966 2060 6074 6573          If ``tes
-0003f5c0: 7460 6020 6973 204e 6f6e 652c 2072 756e  t`` is None, run
-0003f5d0: 2060 6d65 7468 6f64 6020 6f6e 2065 6163   `method` on eac
-0003f5e0: 6820 656e 7472 7920 7769 7468 206e 6f20  h entry with no 
-0003f5f0: 6172 6775 6d65 6e74 732c 200a 2020 2020  arguments, .    
-0003f600: 2020 2020 652e 672e 2c20 2775 7070 6572      e.g., 'upper
-0003f610: 272e 0a0a 2020 2020 2020 2020 4966 2060  '...        If `
-0003f620: 6074 6573 7460 6020 6973 2061 2060 6073  `test`` is a ``s
-0003f630: 6c69 6365 6060 2c20 7265 7475 726e 2073  lice``, return s
-0003f640: 6c69 6365 6420 7374 7269 6e67 7320 666f  liced strings fo
-0003f650: 7220 6561 6368 2065 6e74 7279 2e0a 0a20  r each entry... 
-0003f660: 2020 206d 6574 686f 6420 3a20 7374 720a     method : str.
-0003f670: 2020 2020 2020 2020 5374 7269 6e67 206d          String m
-0003f680: 6574 686f 6420 746f 2061 7070 6c79 2074  ethod to apply t
-0003f690: 6f20 6561 6368 2065 6e74 7279 206f 6620  o each entry of 
-0003f6a0: 6060 636f 6c60 602e 2020 452e 672e 2c20  ``col``.  E.g., 
-0003f6b0: 2763 6f6e 7461 696e 7327 2c0a 2020 2020  'contains',.    
-0003f6c0: 2020 2020 2773 7461 7274 7377 6974 6827      'startswith'
-0003f6d0: 2c20 2765 6e64 7377 6974 6827 2c20 2769  , 'endswith', 'i
-0003f6e0: 6e64 6578 272e 0a0a 2020 2020 6c6f 6769  ndex'...    logi
-0003f6f0: 6361 6c20 3a20 5b27 6f72 272c 2761 6e64  cal : ['or','and
-0003f700: 272c 276e 6f74 275d 0a20 2020 2020 2020  ','not'].       
-0003f710: 204c 6f67 6963 616c 2074 6573 7420 746f   Logical test to
-0003f720: 2075 7365 2077 6865 6e20 6060 7465 7374   use when ``test
-0003f730: 6060 2069 7320 6120 6c69 7374 206f 6620  `` is a list of 
-0003f740: 7374 7269 6e67 732e 2020 466f 7220 6578  strings.  For ex
-0003f750: 616d 706c 652c 0a20 2020 2020 2020 2069  ample,.        i
-0003f760: 6620 796f 7520 7761 6e74 2074 6f20 7465  f you want to te
-0003f770: 7374 2069 6620 7468 6520 636f 6c75 6d6e  st if the column
-0003f780: 2068 6173 2076 616c 7565 7320 7468 6174   has values that
-0003f790: 206d 6174 6368 2065 6974 6865 720a 2020   match either.  
-0003f7a0: 2020 2020 2020 2776 616c 7565 3127 206f        'value1' o
-0003f7b0: 7220 2776 616c 7565 3227 2c20 7468 656e  r 'value2', then
-0003f7c0: 2072 756e 2077 6974 680a 0a20 2020 2020   run with..     
-0003f7d0: 2020 2020 2020 203e 3e3e 2072 6573 203d         >>> res =
-0003f7e0: 2063 6f6c 756d 6e5f 746f 5f73 7472 696e   column_to_strin
-0003f7f0: 675f 6f70 6572 6174 696f 6e28 636f 6c2c  g_operation(col,
-0003f800: 205b 2776 616c 7565 3127 2c27 7661 6c75   ['value1','valu
-0003f810: 6532 275d 2c20 6d65 7468 6f64 3d27 636f  e2'], method='co
-0003f820: 6e74 6169 6e73 272c 206c 6f67 6963 616c  ntains', logical
-0003f830: 3d27 6f72 2729 0a0a 2020 2020 5265 7475  ='or')..    Retu
-0003f840: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-0003f850: 2020 2020 7265 7375 6c74 203a 206c 6973      result : lis
-0003f860: 740a 2020 2020 2020 2020 4c69 7374 206f  t.        List o
-0003f870: 6620 6974 6572 6174 6564 2072 6573 756c  f iterated resul
-0003f880: 7473 206f 6e20 7468 6520 656e 7472 6965  ts on the entrie
-0003f890: 7320 6f66 2060 6063 6f6c 6060 2c20 652e  s of ``col``, e.
-0003f8a0: 672e 2c20 6c69 7374 206f 6620 0a20 2020  g., list of .   
-0003f8b0: 2020 2020 2060 6062 6f6f 6c60 6020 6f72       ``bool`` or
-0003f8c0: 2060 6073 7472 696e 6760 602e 0a0a 2020   ``string``...  
-0003f8d0: 2020 2222 220a 2020 2020 6966 2069 7369    """.    if isi
-0003f8e0: 6e73 7461 6e63 6528 7465 7374 2c20 6c69  nstance(test, li
-0003f8f0: 7374 293a 0a20 2020 2020 2020 2074 6573  st):.        tes
-0003f900: 745f 6c69 7374 203d 2074 6573 740a 2020  t_list = test.  
-0003f910: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0003f920: 7465 7374 5f6c 6973 7420 3d20 5b74 6573  test_list = [tes
-0003f930: 745d 0a0a 2020 2020 6f75 745f 7465 7374  t]..    out_test
-0003f940: 203d 205b 5d0a 0a20 2020 2066 6f72 2069   = []..    for i
-0003f950: 2c20 635f 6920 696e 2065 6e75 6d65 7261  , c_i in enumera
-0003f960: 7465 2863 6f6c 293a 0a20 2020 2020 2020  te(col):.       
-0003f970: 2069 6620 6973 696e 7374 616e 6365 2874   if isinstance(t
-0003f980: 6573 742c 2073 6c69 6365 293a 0a20 2020  est, slice):.   
-0003f990: 2020 2020 2020 2020 206f 7574 5f74 6573           out_tes
-0003f9a0: 742e 6170 7065 6e64 2863 5f69 5b74 6573  t.append(c_i[tes
-0003f9b0: 745d 290a 2020 2020 2020 2020 2020 2020  t]).            
-0003f9c0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-0003f9d0: 2020 6675 6e63 203d 2067 6574 6174 7472    func = getattr
-0003f9e0: 2863 5f69 2c20 6d65 7468 6f64 290a 2020  (c_i, method).  
-0003f9f0: 2020 2020 2020 6966 2074 6573 7420 6973        if test is
-0003fa00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003fa10: 2020 206f 7574 5f74 6573 742e 6170 7065     out_test.appe
-0003fa20: 6e64 2866 756e 6328 2929 0a20 2020 2020  nd(func()).     
-0003fa30: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0003fa40: 0a20 2020 2020 2020 206c 6973 745f 6920  .        list_i 
-0003fa50: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0003fa60: 2074 5f69 2069 6e20 7465 7374 5f6c 6973   t_i in test_lis
-0003fa70: 743a 0a20 2020 2020 2020 2020 2020 2074  t:.            t
-0003fa80: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0003fa90: 2020 2020 6c69 7374 5f69 2e61 7070 656e      list_i.appen
-0003faa0: 6428 6675 6e63 2874 5f69 2929 0a20 2020  d(func(t_i)).   
-0003fab0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-0003fac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003fad0: 206c 6973 745f 692e 6170 7065 6e64 2846   list_i.append(F
-0003fae0: 616c 7365 290a 0a20 2020 2020 2020 206f  alse)..        o
-0003faf0: 7574 5f74 6573 742e 6170 7065 6e64 286c  ut_test.append(l
-0003fb00: 6973 745f 6929 0a0a 2020 2020 6172 7220  ist_i)..    arr 
-0003fb10: 3d20 6e70 2e61 7272 6179 286f 7574 5f74  = np.array(out_t
-0003fb20: 6573 7429 0a20 2020 2073 6820 3d20 6172  est).    sh = ar
-0003fb30: 722e 7368 6170 650a 0a20 2020 2069 6620  r.shape..    if 
-0003fb40: 6c6f 6769 6361 6c20 6973 204e 6f6e 653a  logical is None:
-0003fb50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0003fb60: 6e70 2e73 7175 6565 7a65 2861 7272 290a  np.squeeze(arr).
-0003fb70: 2020 2020 656c 6966 206c 6f67 6963 616c      elif logical
-0003fb80: 2e75 7070 6572 2829 203d 3d20 2741 4e44  .upper() == 'AND
-0003fb90: 273a 0a20 2020 2020 2020 2072 6574 7572  ':.        retur
-0003fba0: 6e20 6e70 2e73 756d 2861 7272 2c20 6178  n np.sum(arr, ax
-0003fbb0: 6973 3d31 2920 3e3d 2073 685b 315d 0a20  is=1) >= sh[1]. 
-0003fbc0: 2020 2065 6c69 6620 6c6f 6769 6361 6c2e     elif logical.
-0003fbd0: 7570 7065 7228 2920 3d3d 2027 4e4f 5427  upper() == 'NOT'
-0003fbe0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0003fbf0: 206e 702e 7375 6d28 6172 722c 2061 7869   np.sum(arr, axi
-0003fc00: 733d 3129 203d 3d20 300a 2020 2020 656c  s=1) == 0.    el
-0003fc10: 7365 3a20 2023 204f 520a 2020 2020 2020  se:  # OR.      
-0003fc20: 2020 7265 7475 726e 206e 702e 7375 6d28    return np.sum(
-0003fc30: 6172 722c 2061 7869 733d 3129 203e 2030  arr, axis=1) > 0
-0003fc40: 0a0a 0a64 6566 2063 6f6c 756d 6e5f 7661  ...def column_va
-0003fc50: 6c75 6573 5f69 6e5f 6c69 7374 2863 6f6c  lues_in_list(col
-0003fc60: 2c20 7465 7374 5f6c 6973 7429 3a0a 2020  , test_list):.  
-0003fc70: 2020 2222 2254 6573 7420 6966 2063 6f6c    """Test if col
-0003fc80: 756d 6e20 656c 656d 656e 7473 2022 696e  umn elements "in
-0003fc90: 2220 616e 2069 7465 7261 626c 6520 2865  " an iterable (e
-0003fca0: 2e67 2e2c 2061 206c 6973 7420 6f66 2073  .g., a list of s
-0003fcb0: 7472 696e 6773 290a 0a20 2020 2050 6172  trings)..    Par
-0003fcc0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-0003fcd0: 2d2d 2d2d 2d2d 0a20 2020 2063 6f6c 203a  ------.    col :
-0003fce0: 2060 6173 7472 6f70 792e 7461 626c 652e   `astropy.table.
-0003fcf0: 436f 6c75 6d6e 6020 6f72 206f 7468 6572  Column` or other
-0003fd00: 2069 7465 7261 626c 650a 2020 2020 2020   iterable.      
-0003fd10: 2020 4772 6f75 7020 6f66 2065 6e74 7269    Group of entri
-0003fd20: 6573 2074 6f20 7465 7374 0a0a 2020 2020  es to test..    
-0003fd30: 7465 7374 5f6c 6973 7420 3a20 6974 6572  test_list : iter
-0003fd40: 6162 6c65 0a20 2020 2020 2020 204c 6973  able.        Lis
-0003fd50: 7420 6f66 2076 616c 7565 7320 746f 2073  t of values to s
-0003fd60: 6561 7263 680a 0a20 2020 2052 6574 7572  earch..    Retur
-0003fd70: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0003fd80: 2020 2074 6573 7420 3a20 626f 6f6c 2061     test : bool a
-0003fd90: 7272 6179 0a20 2020 2020 2020 2053 696d  rray.        Sim
-0003fda0: 706c 6520 7465 7374 3a0a 2020 2020 2020  ple test:.      
-0003fdb0: 2020 2020 2020 3e3e 3e20 5b63 5f69 2069        >>> [c_i i
-0003fdc0: 6e20 7465 7374 5f6c 6973 7420 666f 7220  n test_list for 
-0003fdd0: 635f 6920 696e 2063 6f6c 5d0a 2020 2020  c_i in col].    
-0003fde0: 2222 220a 2020 2020 7465 7374 203d 206e  """.    test = n
-0003fdf0: 702e 6172 7261 7928 5b63 5f69 2069 6e20  p.array([c_i in 
-0003fe00: 7465 7374 5f6c 6973 7420 666f 7220 635f  test_list for c_
-0003fe10: 6920 696e 2063 6f6c 5d29 0a20 2020 2072  i in col]).    r
-0003fe20: 6574 7572 6e20 7465 7374 0a0a 0a64 6566  eturn test...def
-0003fe30: 2066 696c 6c5f 6265 7477 6565 6e5f 7374   fill_between_st
-0003fe40: 6570 7328 782c 2079 302c 2079 312c 2061  eps(x, y0, y1, a
-0003fe50: 783d 4e6f 6e65 2c20 2a61 7267 732c 202a  x=None, *args, *
-0003fe60: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-0003fe70: 220a 2020 2020 4d61 6b65 2060 6669 6c6c  ".    Make `fill
-0003fe80: 5f62 6574 7765 656e 6020 776f 726b 206c  _between` work l
-0003fe90: 696b 6520 6c69 6e65 7374 796c 653d 2773  ike linestyle='s
-0003fea0: 7465 7073 2d6d 6964 272e 0a20 2020 2022  teps-mid'..    "
-0003feb0: 2222 0a20 2020 2069 6d70 6f72 7420 6d61  "".    import ma
-0003fec0: 7470 6c6f 746c 6962 2e70 7970 6c6f 7420  tplotlib.pyplot 
-0003fed0: 6173 2070 6c74 0a20 2020 200a 2020 2020  as plt.    .    
-0003fee0: 736f 203d 206e 702e 6172 6773 6f72 7428  so = np.argsort(
-0003fef0: 7829 0a20 2020 2064 7820 3d20 6e70 2e64  x).    dx = np.d
-0003ff00: 6966 6628 785b 736f 5d29 2f32 2e0a 2020  iff(x[so])/2..  
-0003ff10: 2020 6d69 6420 3d20 785b 736f 5d5b 3a2d    mid = x[so][:-
-0003ff20: 315d 202b 2064 780a 2020 2020 0a20 2020  1] + dx.    .   
-0003ff30: 2078 6675 6c6c 203d 206e 702e 6873 7461   xfull = np.hsta
-0003ff40: 636b 285b 785b 736f 5d5b 305d 2d64 785b  ck([x[so][0]-dx[
-0003ff50: 305d 2c20 6d69 642c 206d 6964 2b64 782a  0], mid, mid+dx*
-0003ff60: 322f 312e 6536 2c20 785b 736f 5d5b 2d31  2/1.e6, x[so][-1
-0003ff70: 5d2b 6478 5b2d 315d 5d29 0a20 2020 2079  ]+dx[-1]]).    y
-0003ff80: 3066 756c 6c20 3d20 6e70 2e68 7374 6163  0full = np.hstac
-0003ff90: 6b28 5b79 305b 305d 2c20 7930 5b3a 2d31  k([y0[0], y0[:-1
-0003ffa0: 5d2c 2079 305b 313a 5d2c 2079 305b 2d31  ], y0[1:], y0[-1
-0003ffb0: 5d5d 290a 2020 2020 7931 6675 6c6c 203d  ]]).    y1full =
-0003ffc0: 206e 702e 6873 7461 636b 285b 7931 5b30   np.hstack([y1[0
-0003ffd0: 5d2c 2079 315b 3a2d 315d 2c20 7931 5b31  ], y1[:-1], y1[1
-0003ffe0: 3a5d 2c20 7931 5b2d 315d 5d29 0a20 2020  :], y1[-1]]).   
-0003fff0: 200a 2020 2020 2320 7866 756c 6c20 3d20   .    # xfull = 
-00040000: 6e70 2e61 7070 656e 6428 6e70 2e61 7070  np.append(np.app
-00040010: 656e 6428 782c 206d 6964 292c 206d 6964  end(x, mid), mid
-00040020: 2b6e 702e 6469 6666 2878 5b73 6f5d 292f  +np.diff(x[so])/
-00040030: 312e 6536 290a 2020 2020 2320 7930 6675  1.e6).    # y0fu
-00040040: 6c6c 203d 206e 702e 6170 7065 6e64 286e  ll = np.append(n
-00040050: 702e 6170 7065 6e64 2879 302c 2079 305b  p.append(y0, y0[
-00040060: 3a2d 315d 292c 2079 305b 313a 5d29 0a20  :-1]), y0[1:]). 
-00040070: 2020 2023 2079 3166 756c 6c20 3d20 6e70     # y1full = np
-00040080: 2e61 7070 656e 6428 6e70 2e61 7070 656e  .append(np.appen
-00040090: 6428 7931 2c20 7931 5b3a 2d31 5d29 2c20  d(y1, y1[:-1]), 
-000400a0: 7931 5b31 3a5d 290a 0a20 2020 2073 6f20  y1[1:])..    so 
-000400b0: 3d20 6e70 2e61 7267 736f 7274 2878 6675  = np.argsort(xfu
-000400c0: 6c6c 290a 2020 2020 6966 2061 7820 6973  ll).    if ax is
-000400d0: 204e 6f6e 653a 0a20 2020 2020 2020 2061   None:.        a
-000400e0: 7820 3d20 706c 742e 6763 6128 290a 0a20  x = plt.gca().. 
-000400f0: 2020 2061 782e 6669 6c6c 5f62 6574 7765     ax.fill_betwe
-00040100: 656e 2878 6675 6c6c 5b73 6f5d 2c20 7930  en(xfull[so], y0
-00040110: 6675 6c6c 5b73 6f5d 2c20 7931 6675 6c6c  full[so], y1full
-00040120: 5b73 6f5d 2c20 2a61 7267 732c 202a 2a6b  [so], *args, **k
-00040130: 7761 7267 7329 0a0a 0a64 6566 2066 696c  wargs)...def fil
-00040140: 6c5f 6d61 736b 6564 5f63 6f76 6172 2863  l_masked_covar(c
-00040150: 6f76 6172 2c20 6d61 736b 293a 0a20 2020  ovar, mask):.   
-00040160: 2022 2222 4669 6c6c 2061 2063 6f76 6172   """Fill a covar
-00040170: 6961 6e63 6520 6d61 7472 6978 2069 6e20  iance matrix in 
-00040180: 6120 6c61 7267 6572 2061 7272 6179 2074  a larger array t
-00040190: 6861 7420 6861 6420 6d61 736b 6564 2076  hat had masked v
-000401a0: 616c 7565 730a 0a20 2020 2050 6172 616d  alues..    Param
-000401b0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-000401c0: 2d2d 2d2d 0a20 2020 2063 6f76 6172 203a  ----.    covar :
-000401d0: 2060 284d 2c4d 2960 2073 7175 6172 6520   `(M,M)` square 
-000401e0: 607e 6e70 2e6e 6461 7272 6179 600a 2020  `~np.ndarray`.  
-000401f0: 2020 2020 2020 4d61 736b 6564 2063 6f76        Masked cov
-00040200: 6172 6961 6e63 6520 6172 7261 792e 0a0a  ariance array...
-00040210: 2020 2020 6d61 736b 203a 2062 6f6f 6c20      mask : bool 
-00040220: 6d61 736b 2c20 604e 3e4d 600a 2020 2020  mask, `N>M`.    
-00040230: 2020 2020 5468 6520 6f72 6967 696e 616c      The original
-00040240: 206d 6173 6b2e 0a0a 2020 2020 5265 7475   mask...    Retu
-00040250: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00040260: 2020 2020 636f 7661 725f 6675 6c6c 203a      covar_full :
-00040270: 2060 7e6e 702e 6e64 6172 7261 7960 0a20   `~np.ndarray`. 
-00040280: 2020 2020 2020 2046 756c 6c20 636f 7661         Full cova
-00040290: 7269 616e 6365 2061 7272 6179 2077 6974  riance array wit
-000402a0: 6820 6469 6d65 6e73 696f 6e73 2060 284e  h dimensions `(N
-000402b0: 2c4e 2960 2e0a 0a20 2020 2022 2222 0a20  ,N)`...    """. 
-000402c0: 2020 204e 203d 206d 6173 6b2e 7368 6170     N = mask.shap
-000402d0: 655b 305d 0a20 2020 2069 6478 203d 206e  e[0].    idx = n
-000402e0: 702e 6172 616e 6765 284e 295b 6d61 736b  p.arange(N)[mask
-000402f0: 5d0a 2020 2020 636f 7661 725f 6675 6c6c  ].    covar_full
-00040300: 203d 206e 702e 7a65 726f 7328 284e 2c20   = np.zeros((N, 
-00040310: 4e29 2c20 6474 7970 653d 636f 7661 722e  N), dtype=covar.
-00040320: 6474 7970 6529 0a20 2020 2066 6f72 2069  dtype).    for i
-00040330: 2c20 6969 2069 6e20 656e 756d 6572 6174  , ii in enumerat
-00040340: 6528 6964 7829 3a0a 2020 2020 2020 2020  e(idx):.        
-00040350: 666f 7220 6a2c 206a 6a20 696e 2065 6e75  for j, jj in enu
-00040360: 6d65 7261 7465 2869 6478 293a 0a20 2020  merate(idx):.   
-00040370: 2020 2020 2020 2020 2063 6f76 6172 5f66           covar_f
-00040380: 756c 6c5b 6969 2c20 6a6a 5d20 3d20 636f  ull[ii, jj] = co
-00040390: 7661 725b 692c 206a 5d0a 0a20 2020 2072  var[i, j]..    r
-000403a0: 6574 7572 6e20 636f 7661 725f 6675 6c6c  eturn covar_full
-000403b0: 0a0a 0a64 6566 206c 6f67 5f73 6361 6c65  ...def log_scale
-000403c0: 5f64 7339 2869 6d2c 206c 6578 703d 312e  _ds9(im, lexp=1.
-000403d0: 6531 322c 2063 6d61 703d 5b37 2e39 3739  e12, cmap=[7.979
-000403e0: 3137 2c20 302e 3837 3830 3439 335d 2c20  17, 0.8780493], 
-000403f0: 7363 616c 653d 5b2d 302e 312c 2031 305d  scale=[-0.1, 10]
-00040400: 293a 0a20 2020 2022 2222 0a20 2020 2053  ):.    """.    S
-00040410: 6361 6c65 2061 6e20 6172 7261 7920 6c69  cale an array li
-00040420: 6b65 2064 7339 206c 6f67 2073 6361 6c69  ke ds9 log scali
-00040430: 6e67 0a20 2020 2022 2222 0a20 2020 2069  ng.    """.    i
-00040440: 6d70 6f72 7420 6e75 6d70 7920 6173 206e  mport numpy as n
-00040450: 700a 0a20 2020 2063 6f6e 7472 6173 742c  p..    contrast,
-00040460: 2062 6961 7320 3d20 636d 6170 0a20 2020   bias = cmap.   
-00040470: 2063 6c69 7020 3d20 286e 702e 636c 6970   clip = (np.clip
-00040480: 2869 6d2c 2073 6361 6c65 5b30 5d2c 2073  (im, scale[0], s
-00040490: 6361 6c65 5b31 5d29 2d73 6361 6c65 5b30  cale[1])-scale[0
-000404a0: 5d29 2f28 7363 616c 655b 315d 2d73 6361  ])/(scale[1]-sca
-000404b0: 6c65 5b30 5d29 0a20 2020 2063 6c69 705f  le[0]).    clip_
-000404c0: 6c6f 6720 3d20 6e70 2e63 6c69 7028 286e  log = np.clip((n
-000404d0: 702e 6c6f 6731 3028 6c65 7870 2a63 6c69  p.log10(lexp*cli
-000404e0: 702b 3129 2f6e 702e 6c6f 6731 3028 6c65  p+1)/np.log10(le
-000404f0: 7870 292d 6269 6173 292a 636f 6e74 7261  xp)-bias)*contra
-00040500: 7374 2b30 2e35 2c20 302c 2031 290a 0a20  st+0.5, 0, 1).. 
-00040510: 2020 2072 6574 7572 6e20 636c 6970 5f6c     return clip_l
-00040520: 6f67 0a0a 0a64 6566 206d 6f64 655f 7374  og...def mode_st
-00040530: 6174 6973 7469 6328 6461 7461 2c20 7065  atistic(data, pe
-00040540: 7263 656e 7469 6c65 733d 7261 6e67 6528  rcentiles=range(
-00040550: 3130 2c20 3931 2c20 3130 2929 3a0a 2020  10, 91, 10)):.  
-00040560: 2020 2222 220a 2020 2020 4765 7420 6d6f    """.    Get mo
-00040570: 6461 6c20 7661 6c75 6520 6f66 2061 2064  dal value of a d
-00040580: 6973 7472 6962 7574 696f 6e20 6f66 2064  istribution of d
-00040590: 6174 6120 666f 6c6c 6f77 696e 6720 436f  ata following Co
-000405a0: 6e6e 6f72 2065 7420 616c 2e20 3230 3137  nnor et al. 2017
-000405b0: 0a20 2020 2068 7474 7073 3a2f 2f61 7278  .    https://arx
-000405c0: 6976 2e6f 7267 2f70 6466 2f31 3730 392e  iv.org/pdf/1709.
-000405d0: 3031 3932 352e 7064 660a 0a20 2020 2048  01925.pdf..    H
-000405e0: 6572 6520 7765 2066 6974 2061 2073 706c  ere we fit a spl
-000405f0: 696e 6520 746f 2074 6865 2063 756d 756c  ine to the cumul
-00040600: 6174 6976 6520 6469 7374 7269 6275 7469  ative distributi
-00040610: 6f6e 2065 7661 6c75 6174 6564 2061 7420  on evaluated at 
-00040620: 6b6e 6f74 730a 2020 2020 7365 7420 746f  knots.    set to
-00040630: 2074 6865 2060 7065 7263 656e 7469 6c65   the `percentile
-00040640: 7360 206f 6620 7468 6520 6469 7374 7269  s` of the distri
-00040650: 6275 7469 6f6e 2074 6f20 696d 7072 6f76  bution to improv
-00040660: 6520 736d 6f6f 7468 6e65 7373 2e0a 2020  e smoothness..  
-00040670: 2020 2222 220a 2020 2020 6672 6f6d 2073    """.    from s
-00040680: 6369 7079 2e69 6e74 6572 706f 6c61 7465  cipy.interpolate
-00040690: 2069 6d70 6f72 7420 556e 6976 6172 6961   import Univaria
-000406a0: 7465 5370 6c69 6e65 2c20 4c53 5155 6e69  teSpline, LSQUni
-000406b0: 7661 7269 6174 6553 706c 696e 650a 0a20  variateSpline.. 
-000406c0: 2020 2073 6f20 3d20 6e70 2e61 7267 736f     so = np.argso
-000406d0: 7274 2864 6174 6129 0a20 2020 206f 7264  rt(data).    ord
-000406e0: 6572 203d 206e 702e 6172 616e 6765 286c  er = np.arange(l
-000406f0: 656e 2864 6174 6129 290a 2020 2020 2373  en(data)).    #s
-00040700: 706c 203d 2055 6e69 7661 7269 6174 6553  pl = UnivariateS
-00040710: 706c 696e 6528 6461 7461 5b73 6f5d 2c20  pline(data[so], 
-00040720: 6f72 6465 7229 0a0a 2020 2020 6b6e 6f74  order)..    knot
-00040730: 7320 3d20 6e70 2e70 6572 6365 6e74 696c  s = np.percentil
-00040740: 6528 6461 7461 2c20 7065 7263 656e 7469  e(data, percenti
-00040750: 6c65 7329 0a20 2020 2064 7820 3d20 6e70  les).    dx = np
-00040760: 2e64 6966 6628 6b6e 6f74 7329 0a20 2020  .diff(knots).   
-00040770: 206d 6173 6b20 3d20 2864 6174 615b 736f   mask = (data[so
-00040780: 5d20 3e3d 206b 6e6f 7473 5b30 5d2d 6478  ] >= knots[0]-dx
-00040790: 5b30 5d29 2026 2028 6461 7461 5b73 6f5d  [0]) & (data[so]
-000407a0: 203c 3d20 6b6e 6f74 735b 2d31 5d2b 6478   <= knots[-1]+dx
-000407b0: 5b2d 315d 290a 2020 2020 7370 6c20 3d20  [-1]).    spl = 
-000407c0: 4c53 5155 6e69 7661 7269 6174 6553 706c  LSQUnivariateSpl
-000407d0: 696e 6528 6461 7461 5b73 6f5d 5b6d 6173  ine(data[so][mas
-000407e0: 6b5d 2c20 6f72 6465 725b 6d61 736b 5d2c  k], order[mask],
-000407f0: 206b 6e6f 7473 2c20 6578 743d 277a 6572   knots, ext='zer
-00040800: 6f73 2729 0a0a 2020 2020 6d61 736b 203d  os')..    mask =
-00040810: 2028 6461 7461 5b73 6f5d 203e 3d20 6b6e   (data[so] >= kn
-00040820: 6f74 735b 305d 2920 2620 2864 6174 615b  ots[0]) & (data[
-00040830: 736f 5d20 3c3d 206b 6e6f 7473 5b2d 315d  so] <= knots[-1]
-00040840: 290a 2020 2020 6978 203d 2028 7370 6c28  ).    ix = (spl(
-00040850: 6461 7461 5b73 6f5d 2c20 6e75 3d31 2c20  data[so], nu=1, 
-00040860: 6578 743d 277a 6572 6f73 2729 2a6d 6173  ext='zeros')*mas
-00040870: 6b29 2e61 7267 6d61 7828 290a 2020 2020  k).argmax().    
-00040880: 6d6f 6465 203d 2064 6174 615b 736f 5d5b  mode = data[so][
-00040890: 6978 5d0a 2020 2020 7265 7475 726e 206d  ix].    return m
-000408a0: 6f64 650a 0a0a 6465 6620 6d61 6b65 5f61  ode...def make_a
-000408b0: 6c66 5f74 656d 706c 6174 6528 293a 0a20  lf_template():. 
-000408c0: 2020 2022 2222 0a20 2020 204d 616b 6520     """.    Make 
-000408d0: 416c 6620 2b20 4653 5053 2074 656d 706c  Alf + FSPS templ
-000408e0: 6174 650a 2020 2020 2222 220a 2020 2020  ate.    """.    
-000408f0: 696d 706f 7274 2061 6c66 2e61 6c66 0a20  import alf.alf. 
-00040900: 2020 2069 6d70 6f72 7420 6673 7073 0a0a     import fsps..
-00040910: 2020 2020 7373 7020 3d20 616c 662e 616c      ssp = alf.al
-00040920: 662e 416c 6628 290a 0a20 2020 2073 7020  f.Alf()..    sp 
-00040930: 3d20 6673 7073 2e53 7465 6c6c 6172 506f  = fsps.StellarPo
-00040940: 7075 6c61 7469 6f6e 287a 636f 6e74 696e  pulation(zcontin
-00040950: 756f 7573 3d31 290a 2020 2020 7370 2e70  uous=1).    sp.p
-00040960: 6172 616d 735b 276c 6f67 7a73 6f6c 275d  arams['logzsol']
-00040970: 203d 2030 2e32 0a0a 2020 2020 2320 416c   = 0.2..    # Al
-00040980: 660a 2020 2020 6d20 3d20 7373 702e 6765  f.    m = ssp.ge
-00040990: 745f 6d6f 6465 6c28 696e 5f70 6c61 6365  t_model(in_place
-000409a0: 3d46 616c 7365 2c20 6c6f 6761 6765 3d30  =False, logage=0
-000409b0: 2e39 362c 207a 683d 302e 322c 206d 6768  .96, zh=0.2, mgh
-000409c0: 3d30 2e32 290a 0a20 2020 2023 2046 5350  =0.2)..    # FSP
-000409d0: 530a 2020 2020 772c 2073 7065 6320 3d20  S.    w, spec = 
-000409e0: 7370 2e67 6574 5f73 7065 6374 7275 6d28  sp.get_spectrum(
-000409f0: 7461 6765 3d31 302a 2a30 2e39 362c 2070  tage=10**0.96, p
-00040a00: 6572 6161 3d54 7275 6529 0a0a 2020 2020  eraa=True)..    
-00040a10: 2320 626c 7565 0a20 2020 2062 6c75 655f  # blue.    blue_
-00040a20: 6e6f 726d 203d 2073 7065 635b 7720 3e20  norm = spec[w > 
-00040a30: 3336 3030 5d5b 305d 202f 206d 5b73 7370  3600][0] / m[ssp
-00040a40: 2e77 6176 6520 3e20 3336 3030 5d5b 305d  .wave > 3600][0]
-00040a50: 0a20 2020 2072 6564 5f6e 6f72 6d20 3d20  .    red_norm = 
-00040a60: 7370 6563 5b77 203e 2031 2e37 6534 5d5b  spec[w > 1.7e4][
-00040a70: 305d 202f 206d 5b73 7370 2e77 6176 6520  0] / m[ssp.wave 
-00040a80: 3e20 312e 3765 345d 5b30 5d0a 0a20 2020  > 1.7e4][0]..   
-00040a90: 2074 656d 706c 7820 3d20 6e70 2e68 7374   templx = np.hst
-00040aa0: 6163 6b28 5b77 5b77 203c 2033 3630 305d  ack([w[w < 3600]
-00040ab0: 2c20 7373 702e 7761 7665 5b28 7373 702e  , ssp.wave[(ssp.
-00040ac0: 7761 7665 203e 2033 3630 3029 2026 2028  wave > 3600) & (
-00040ad0: 7373 702e 7761 7665 203c 2031 2e37 6534  ssp.wave < 1.7e4
-00040ae0: 295d 2c20 775b 7720 3e20 312e 3765 345d  )], w[w > 1.7e4]
-00040af0: 5d29 0a20 2020 2074 656d 706c 7920 3d20  ]).    temply = 
-00040b00: 6e70 2e68 7374 6163 6b28 5b73 7065 635b  np.hstack([spec[
-00040b10: 7720 3c20 3336 3030 5d2f 626c 7565 5f6e  w < 3600]/blue_n
-00040b20: 6f72 6d2c 206d 5b28 7373 702e 7761 7665  orm, m[(ssp.wave
-00040b30: 203e 2033 3630 3029 2026 2028 7373 702e   > 3600) & (ssp.
-00040b40: 7761 7665 203c 2031 2e37 6534 295d 2c20  wave < 1.7e4)], 
-00040b50: 7370 6563 5b77 203e 2031 2e37 6534 5d2f  spec[w > 1.7e4]/
-00040b60: 7265 645f 6e6f 726d 5d29 0a0a 2020 2020  red_norm])..    
-00040b70: 6e70 2e73 6176 6574 7874 2827 616c 665f  np.savetxt('alf_
-00040b80: 5353 502e 6461 7427 2c20 6e70 2e61 7272  SSP.dat', np.arr
-00040b90: 6179 285b 7465 6d70 6c78 2c20 7465 6d70  ay([templx, temp
-00040ba0: 6c79 5d29 2e54 2c20 666d 743d 2725 2e35  ly]).T, fmt='%.5
-00040bb0: 6527 2c20 6865 6164 6572 3d27 7761 7665  e', header='wave
-00040bc0: 2066 6c75 785c 6e6c 6f67 6167 6520 3d20   flux\nlogage = 
-00040bd0: 302e 3936 5c6e 7a68 3d30 2e32 5c6e 6d67  0.96\nzh=0.2\nmg
-00040be0: 683d 302e 325c 6e66 7370 733a 2077 203c  h=0.2\nfsps: w <
-00040bf0: 2033 3630 302c 2077 203e 2031 2e37 6534   3600, w > 1.7e4
-00040c00: 2729 0a0a 0a64 6566 2063 6174 616c 6f67  ')...def catalog
-00040c10: 5f61 7265 6128 7261 3d5b 5d2c 2064 6563  _area(ra=[], dec
-00040c20: 3d5b 5d2c 206d 616b 655f 706c 6f74 3d54  =[], make_plot=T
-00040c30: 7275 652c 204e 4d41 583d 3530 3030 2c20  rue, NMAX=5000, 
-00040c40: 6275 6666 3d30 2e38 2c20 7665 7262 6f73  buff=0.8, verbos
-00040c50: 653d 5472 7565 293a 0a20 2020 2022 2222  e=True):.    """
-00040c60: 436f 6d70 7574 6520 7468 6520 7375 7266  Compute the surf
-00040c70: 6163 6520 6172 6561 206f 6620 6120 6c69  ace area of a li
-00040c80: 7374 206f 6620 5241 2f44 4543 2063 6f6f  st of RA/DEC coo
-00040c90: 7264 696e 6174 6573 0a0a 2020 2020 5061  rdinates..    Pa
-00040ca0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00040cb0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7261 2c20  -------.    ra, 
-00040cc0: 6465 6320 3a20 607e 6e75 6d70 792e 6e64  dec : `~numpy.nd
-00040cd0: 6172 7261 7960 0a20 2020 2020 2020 2052  array`.        R
-00040ce0: 4120 616e 6420 4465 632e 2063 6f6f 7264  A and Dec. coord
-00040cf0: 696e 6174 6573 2069 6e20 6465 6369 6d61  inates in decima
-00040d00: 6c20 6465 6772 6565 730a 0a20 2020 206d  l degrees..    m
-00040d10: 616b 655f 706c 6f74 203a 2062 6f6f 6c0a  ake_plot : bool.
-00040d20: 2020 2020 2020 2020 4d61 6b65 2061 2066          Make a f
-00040d30: 6967 7572 652e 0a0a 2020 2020 4e4d 4158  igure...    NMAX
-00040d40: 203a 2069 6e74 0a20 2020 2020 2020 2049   : int.        I
-00040d50: 6620 7468 6520 6361 7461 6c6f 6720 6861  f the catalog ha
-00040d60: 7320 6d6f 7265 2074 6865 6e20 604e 4d41  s more then `NMA
-00040d70: 5860 2065 6e74 7269 6573 2c20 6472 6177  X` entries, draw
-00040d80: 2060 4e4d 4158 6020 7261 6e64 6f6d 0a20   `NMAX` random. 
-00040d90: 2020 2020 2020 2073 616d 706c 6573 2e0a         samples..
-00040da0: 0a20 2020 2062 7566 6620 3a20 666c 6f61  .    buff : floa
-00040db0: 740a 2020 2020 2020 2020 4275 6666 6572  t.        Buffer
-00040dc0: 2069 6e20 6172 636d 696e 2074 6f20 6164   in arcmin to ad
-00040dd0: 6420 6172 6f75 6e64 2065 6163 6820 6361  d around each ca
-00040de0: 7461 6c6f 6720 706f 696e 742e 0a0a 0a20  talog point.... 
-00040df0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-00040e00: 2d2d 2d2d 2d2d 0a20 2020 2061 7265 6120  ------.    area 
-00040e10: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-00040e20: 436f 6d70 7574 6564 2063 6174 616c 6f67  Computed catalog
-00040e30: 2061 7265 6120 696e 2073 7175 6172 6520   area in square 
-00040e40: 6172 636d 696e 7574 6573 0a0a 2020 2020  arcminutes..    
-00040e50: 6669 6720 3a20 607e 6d61 7470 6c6f 746c  fig : `~matplotl
-00040e60: 6962 2e66 6967 7572 652e 4669 6775 7265  ib.figure.Figure
-00040e70: 600a 2020 2020 2020 2020 4669 6775 7265  `.        Figure
-00040e80: 206f 626a 6563 7420 7265 7475 726e 6564   object returned
-00040e90: 2069 6620 606d 616b 655f 706c 6f74 3d3d   if `make_plot==
-00040ea0: 5472 7565 602e 0a0a 2020 2020 2222 220a  True`...    """.
-00040eb0: 2020 2020 696d 706f 7274 206d 6174 706c      import matpl
-00040ec0: 6f74 6c69 622e 7079 706c 6f74 2061 7320  otlib.pyplot as 
-00040ed0: 706c 740a 2020 2020 6672 6f6d 2073 6861  plt.    from sha
-00040ee0: 7065 6c79 2e67 656f 6d65 7472 7920 696d  pely.geometry im
-00040ef0: 706f 7274 2050 6f6c 7967 6f6e 2c20 506f  port Polygon, Po
-00040f00: 696e 742c 204d 756c 7469 506f 6c79 676f  int, MultiPolygo
-00040f10: 6e2c 204d 756c 7469 4c69 6e65 5374 7269  n, MultiLineStri
-00040f20: 6e67 0a20 2020 2066 726f 6d20 7363 6970  ng.    from scip
-00040f30: 7920 696d 706f 7274 2073 7061 7469 616c  y import spatial
-00040f40: 0a0a 2020 2020 706f 696e 7473 203d 206e  ..    points = n
-00040f50: 702e 6172 7261 7928 5b72 612c 2064 6563  p.array([ra, dec
-00040f60: 5d29 2a31 2e0a 2020 2020 6365 6e74 6572  ])*1..    center
-00040f70: 203d 206e 702e 6d65 616e 2870 6f69 6e74   = np.mean(point
-00040f80: 732c 2061 7869 733d 3129 0a20 2020 2070  s, axis=1).    p
-00040f90: 6f69 6e74 7320 3d20 2870 6f69 6e74 732e  oints = (points.
-00040fa0: 5420 2d20 6365 6e74 6572 292a 3630 2e20  T - center)*60. 
-00040fb0: 2023 2061 7263 6d69 6e0a 2020 2020 706f   # arcmin.    po
-00040fc0: 696e 7473 5b3a 2c20 305d 202a 3d20 6e70  ints[:, 0] *= np
-00040fd0: 2e63 6f73 2863 656e 7465 725b 315d 2f31  .cos(center[1]/1
-00040fe0: 3830 2a6e 702e 7069 290a 0a20 2020 2068  80*np.pi)..    h
-00040ff0: 756c 6c20 3d20 7370 6174 6961 6c2e 436f  ull = spatial.Co
-00041000: 6e76 6578 4875 6c6c 2870 6f69 6e74 7329  nvexHull(points)
-00041010: 0a20 2020 2065 6467 6520 3d20 706f 696e  .    edge = poin
-00041020: 7473 5b68 756c 6c2e 7665 7274 6963 6573  ts[hull.vertices
-00041030: 2c20 3a5d 0a0a 2020 2020 2370 6275 6666  , :]..    #pbuff
-00041040: 203d 2031 0a0a 2020 2020 6966 206c 656e   = 1..    if len
-00041050: 2872 6129 203e 204e 4d41 583a 0a20 2020  (ra) > NMAX:.   
-00041060: 2020 2020 2072 6e64 5f69 6478 203d 206e       rnd_idx = n
-00041070: 702e 756e 6971 7565 286e 702e 6361 7374  p.unique(np.cast
-00041080: 5b69 6e74 5d28 6e70 2e72 6f75 6e64 286e  [int](np.round(n
-00041090: 702e 7261 6e64 6f6d 2e72 616e 6428 4e4d  p.random.rand(NM
-000410a0: 4158 292a 6c65 6e28 7261 2929 2929 0a20  AX)*len(ra)))). 
-000410b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000410c0: 2072 6e64 5f69 6478 203d 206e 702e 6172   rnd_idx = np.ar
-000410d0: 616e 6765 286c 656e 2872 6129 290a 0a20  ange(len(ra)).. 
-000410e0: 2020 2070 6f6c 7920 3d20 506f 696e 7428     poly = Point(
-000410f0: 706f 696e 7473 5b72 6e64 5f69 6478 5b30  points[rnd_idx[0
-00041100: 5d2c 203a 5d29 2e62 7566 6665 7228 6275  ], :]).buffer(bu
-00041110: 6666 290a 2020 2020 666f 7220 692c 2069  ff).    for i, i
-00041120: 7820 696e 2065 6e75 6d65 7261 7465 2872  x in enumerate(r
-00041130: 6e64 5f69 6478 293a 0a20 2020 2020 2020  nd_idx):.       
-00041140: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-00041150: 2020 2020 2020 2020 2070 7269 6e74 284e           print(N
-00041160: 4f5f 4e45 574c 494e 4520 2b20 277b 307d  O_NEWLINE + '{0}
-00041170: 207b 317d 272e 666f 726d 6174 2869 2c20   {1}'.format(i, 
-00041180: 6978 2929 0a0a 2020 2020 2020 2020 706f  ix))..        po
-00041190: 6c79 203d 2070 6f6c 792e 756e 696f 6e28  ly = poly.union(
-000411a0: 506f 696e 7428 706f 696e 7473 5b69 782c  Point(points[ix,
-000411b0: 203a 5d29 2e62 7566 6665 7228 6275 6666   :]).buffer(buff
-000411c0: 2929 0a0a 2020 2020 2320 4669 6e61 6c20  ))..    # Final 
-000411d0: 286d 756c 7469 2950 6f6c 7967 6f6e 0a20  (multi)Polygon. 
-000411e0: 2020 2070 6a6f 696e 203d 2070 6f6c 792e     pjoin = poly.
-000411f0: 6275 6666 6572 282d 6275 6666 290a 0a20  buffer(-buff).. 
-00041200: 2020 2069 6620 6d61 6b65 5f70 6c6f 743a     if make_plot:
-00041210: 0a0a 2020 2020 2020 2020 6669 6720 3d20  ..        fig = 
-00041220: 706c 742e 6669 6775 7265 2829 0a20 2020  plt.figure().   
-00041230: 2020 2020 2061 7820 3d20 6669 672e 6164       ax = fig.ad
-00041240: 645f 7375 6270 6c6f 7428 3131 3129 0a0a  d_subplot(111)..
-00041250: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00041260: 7461 6e63 6528 706a 6f69 6e2c 204d 756c  tance(pjoin, Mul
-00041270: 7469 506f 6c79 676f 6e29 3a0a 2020 2020  tiPolygon):.    
-00041280: 2020 2020 2020 2020 666f 7220 705f 6920          for p_i 
-00041290: 696e 2070 6a6f 696e 3a0a 2020 2020 2020  in pjoin:.      
-000412a0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-000412b0: 6e73 7461 6e63 6528 705f 692e 626f 756e  nstance(p_i.boun
-000412c0: 6461 7279 2c20 4d75 6c74 694c 696e 6553  dary, MultiLineS
-000412d0: 7472 696e 6729 3a0a 2020 2020 2020 2020  tring):.        
-000412e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000412f0: 7320 696e 2070 5f69 2e62 6f75 6e64 6172  s in p_i.boundar
-00041300: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00041310: 2020 2020 2020 2020 2020 2070 203d 2073             p = s
-00041320: 2e78 790a 2020 2020 2020 2020 2020 2020  .xy.            
-00041330: 2020 2020 2020 2020 2020 2020 6178 2e70              ax.p
-00041340: 6c6f 7428 705b 305d 2c20 705b 315d 290a  lot(p[0], p[1]).
-00041350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041360: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00041370: 2020 2020 2020 2020 2020 7020 3d20 705f            p = p_
-00041380: 692e 626f 756e 6461 7279 2e78 790a 2020  i.boundary.xy.  
-00041390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000413a0: 2020 6178 2e70 6c6f 7428 705b 305d 2c20    ax.plot(p[0], 
-000413b0: 705b 315d 290a 2020 2020 2020 2020 656c  p[1]).        el
-000413c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000413d0: 705f 6920 3d20 706a 6f69 6e0a 2020 2020  p_i = pjoin.    
-000413e0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-000413f0: 7461 6e63 6528 705f 692e 626f 756e 6461  tance(p_i.bounda
-00041400: 7279 2c20 4d75 6c74 694c 696e 6553 7472  ry, MultiLineStr
-00041410: 696e 6729 3a0a 2020 2020 2020 2020 2020  ing):.          
-00041420: 2020 2020 2020 666f 7220 7320 696e 2070        for s in p
-00041430: 5f69 2e62 6f75 6e64 6172 793a 0a20 2020  _i.boundary:.   
-00041440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041450: 2070 203d 2073 2e78 790a 2020 2020 2020   p = s.xy.      
-00041460: 2020 2020 2020 2020 2020 2020 2020 6178                ax
-00041470: 2e70 6c6f 7428 705b 305d 2c20 705b 315d  .plot(p[0], p[1]
-00041480: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00041490: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000414a0: 2020 2020 7020 3d20 705f 692e 626f 756e      p = p_i.boun
-000414b0: 6461 7279 2e78 790a 2020 2020 2020 2020  dary.xy.        
-000414c0: 2020 2020 2020 2020 6178 2e70 6c6f 7428          ax.plot(
-000414d0: 705b 305d 2c20 705b 315d 290a 0a20 2020  p[0], p[1])..   
-000414e0: 2020 2020 2061 782e 7363 6174 7465 7228       ax.scatter(
-000414f0: 706f 696e 7473 5b72 6e64 5f69 6478 2c20  points[rnd_idx, 
-00041500: 305d 2c20 706f 696e 7473 5b72 6e64 5f69  0], points[rnd_i
-00041510: 6478 2c20 315d 2c20 616c 7068 613d 302e  dx, 1], alpha=0.
-00041520: 312c 206d 6172 6b65 723d 272b 2729 0a0a  1, marker='+')..
-00041530: 2020 2020 2020 2020 6178 2e73 6574 5f78          ax.set_x
-00041540: 6c69 6d28 6178 2e67 6574 5f78 6c69 6d28  lim(ax.get_xlim(
-00041550: 295b 3a3a 2d31 5d29 0a20 2020 2020 2020  )[::-1]).       
-00041560: 2061 782e 7365 745f 786c 6162 656c 2872   ax.set_xlabel(r
-00041570: 2724 5c44 656c 7461 2452 4120 287b 303a  '$\Delta$RA ({0:
-00041580: 2e35 667d 2927 2e66 6f72 6d61 7428 6365  .5f})'.format(ce
-00041590: 6e74 6572 5b30 5d29 290a 2020 2020 2020  nter[0])).      
-000415a0: 2020 6178 2e73 6574 5f79 6c61 6265 6c28    ax.set_ylabel(
-000415b0: 7227 245c 4465 6c74 6124 4465 632e 2028  r'$\Delta$Dec. (
-000415c0: 7b30 3a2e 3566 7d29 272e 666f 726d 6174  {0:.5f})'.format
-000415d0: 2863 656e 7465 725b 315d 2929 0a20 2020  (center[1])).   
-000415e0: 2020 2020 2061 782e 7365 745f 7469 746c       ax.set_titl
-000415f0: 6528 2754 6f74 616c 2061 7265 613a 207b  e('Total area: {
-00041600: 303a 2e31 667d 2061 7263 6d69 6e24 5e32  0:.1f} arcmin$^2
-00041610: 2427 2e66 6f72 6d61 7428 706a 6f69 6e2e  $'.format(pjoin.
-00041620: 6172 6561 2929 0a20 2020 2020 2020 2061  area)).        a
-00041630: 782e 6772 6964 2829 0a20 2020 2020 2020  x.grid().       
-00041640: 2066 6967 2e74 6967 6874 5f6c 6179 6f75   fig.tight_layou
-00041650: 7428 7061 643d 302e 3129 0a0a 2020 2020  t(pad=0.1)..    
-00041660: 2020 2020 7265 7475 726e 2070 6a6f 696e      return pjoin
-00041670: 2e61 7265 612c 2066 6967 0a0a 2020 2020  .area, fig..    
-00041680: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-00041690: 7475 726e 2070 6a6f 696e 2e61 7265 610a  turn pjoin.area.
-000416a0: 0a0a 6465 6620 6669 785f 666c 745f 6e61  ..def fix_flt_na
-000416b0: 6e28 666c 745f 6669 6c65 2c20 6261 645f  n(flt_file, bad_
-000416c0: 6269 743d 3430 3936 2c20 7665 7262 6f73  bit=4096, verbos
-000416d0: 653d 5472 7565 293a 0a20 2020 2022 2222  e=True):.    """
-000416e0: 0a20 2020 2046 6978 204e 614e 2076 616c  .    Fix NaN val
-000416f0: 7565 7320 696e 2046 4c54 2066 696c 6573  ues in FLT files
-00041700: 0a20 2020 2022 2222 0a20 2020 2069 6d20  .    """.    im 
-00041710: 3d20 7079 6669 7473 2e6f 7065 6e28 666c  = pyfits.open(fl
-00041720: 745f 6669 6c65 2c20 6d6f 6465 3d27 7570  t_file, mode='up
-00041730: 6461 7465 2729 0a20 2020 2066 6f72 2065  date').    for e
-00041740: 7874 2069 6e20 7261 6e67 6528 312c 2035  xt in range(1, 5
-00041750: 293a 0a20 2020 2020 2020 2069 6620 2827  ):.        if ('
-00041760: 5343 4927 2c20 6578 7429 2069 6e20 696d  SCI', ext) in im
-00041770: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
-00041780: 736b 203d 207e 6e70 2e69 7366 696e 6974  sk = ~np.isfinit
-00041790: 6528 696d 5b27 5343 4927 2c20 6578 745d  e(im['SCI', ext]
-000417a0: 2e64 6174 6129 0a20 2020 2020 2020 2020  .data).         
-000417b0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-000417c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000417d0: 6162 656c 203d 2027 7574 696c 732e 6669  abel = 'utils.fi
-000417e0: 785f 666c 745f 6e61 6e3a 207b 307d 5b53  x_flt_nan: {0}[S
-000417f0: 4349 2c7b 317d 5d20 4e61 4e50 6978 656c  CI,{1}] NaNPixel
-00041800: 733d 7b32 7d27 0a20 2020 2020 2020 2020  s={2}'.         
-00041810: 2020 2020 2020 2070 7269 6e74 286c 6162         print(lab
-00041820: 656c 2e66 6f72 6d61 7428 666c 745f 6669  el.format(flt_fi
-00041830: 6c65 2c20 6578 742c 206d 6173 6b2e 7375  le, ext, mask.su
-00041840: 6d28 2929 290a 0a20 2020 2020 2020 2020  m()))..         
-00041850: 2020 2069 6620 6d61 736b 2e73 756d 2829     if mask.sum()
-00041860: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00041870: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00041880: 0a20 2020 2020 2020 2020 2020 2069 6d5b  .            im[
-00041890: 2753 4349 272c 2065 7874 5d2e 6461 7461  'SCI', ext].data
-000418a0: 5b6d 6173 6b5d 203d 2030 0a20 2020 2020  [mask] = 0.     
-000418b0: 2020 2020 2020 2069 6d5b 2744 5127 2c20         im['DQ', 
-000418c0: 6578 745d 2e64 6174 615b 6d61 736b 5d20  ext].data[mask] 
-000418d0: 7c3d 2062 6164 5f62 6974 0a0a 2020 2020  |= bad_bit..    
-000418e0: 696d 2e66 6c75 7368 2829 0a20 2020 2069  im.flush().    i
-000418f0: 6d2e 636c 6f73 6528 290a 0a0a 6465 6620  m.close()...def 
-00041900: 6475 6d70 5f66 6c74 5f64 7128 6669 6c65  dump_flt_dq(file
-00041910: 6e61 6d65 2c20 7265 706c 6163 653d 2827  name, replace=('
-00041920: 2e66 6974 7327 2c20 272e 6471 2e66 6974  .fits', '.dq.fit
-00041930: 732e 677a 2729 2c20 7665 7262 6f73 653d  s.gz'), verbose=
-00041940: 5472 7565 293a 0a20 2020 2022 2222 4475  True):.    """Du
-00041950: 6d70 2046 4c54 2f46 4c43 2068 6561 6465  mp FLT/FLC heade
-00041960: 7220 2620 4451 2065 7874 656e 7369 6f6e  r & DQ extension
-00041970: 7320 746f 2061 2063 6f6d 7061 6374 2066  s to a compact f
-00041980: 696c 650a 0a20 2020 2050 6172 616d 6574  ile..    Paramet
-00041990: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-000419a0: 2d2d 0a20 2020 2066 696c 656e 616d 6520  --.    filename 
-000419b0: 3a20 7374 720a 2020 2020 2020 2020 464c  : str.        FL
-000419c0: 542f 464c 4320 6669 6c65 6e61 6d65 2e0a  T/FLC filename..
-000419d0: 0a20 2020 2072 6570 6c61 6365 203a 2028  .    replace : (
-000419e0: 7374 722c 2073 7472 290a 2020 2020 2020  str, str).      
-000419f0: 2020 5265 706c 6163 6520 6172 6775 6d65    Replace argume
-00041a00: 6e74 7320 666f 7220 6f75 7470 7574 2066  nts for output f
-00041a10: 696c 656e 616d 653a 0a0a 2020 2020 2020  ilename:..      
-00041a20: 2020 3e3e 3e20 6f75 7470 7574 5f66 696c    >>> output_fil
-00041a30: 656e 616d 6520 3d20 6669 6c65 6e61 6d65  ename = filename
-00041a40: 2e72 6570 6c61 6365 2872 6570 6c61 6365  .replace(replace
-00041a50: 5b30 5d2c 2072 6570 6c61 6365 5b31 5d29  [0], replace[1])
-00041a60: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-00041a70: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5772    -------.    Wr
-00041a80: 6974 6573 2068 6561 6465 7220 616e 6420  ites header and 
-00041a90: 636f 6d70 6163 7420 4451 2061 7272 6179  compact DQ array
-00041aa0: 2074 6f20 606f 7574 7075 745f 6669 6c65   to `output_file
-00041ab0: 6e61 6d65 602e 0a0a 2020 2020 2222 220a  name`...    """.
-00041ac0: 2020 2020 696d 203d 2070 7966 6974 732e      im = pyfits.
-00041ad0: 6f70 656e 2866 696c 656e 616d 6529 0a20  open(filename). 
-00041ae0: 2020 2068 6475 7320 3d20 5b5d 0a20 2020     hdus = [].   
-00041af0: 2066 6f72 2069 2069 6e20 5b31 2c20 322c   for i in [1, 2,
-00041b00: 2033 2c20 345d 3a0a 2020 2020 2020 2020   3, 4]:.        
-00041b10: 6966 2028 2753 4349 272c 2069 2920 696e  if ('SCI', i) in
-00041b20: 2069 6d3a 0a20 2020 2020 2020 2020 2020   im:.           
-00041b30: 2068 6561 6465 7220 3d20 696d 5b27 5343   header = im['SC
-00041b40: 4927 2c20 695d 2e68 6561 6465 720a 2020  I', i].header.  
-00041b50: 2020 2020 2020 2020 2020 6471 203d 2069            dq = i
-00041b60: 6d5b 2744 5127 2c20 695d 2e64 6174 610a  m['DQ', i].data.
-00041b70: 2020 2020 2020 2020 2020 2020 6e7a 203d              nz =
-00041b80: 206e 702e 7768 6572 6528 6471 203e 2030   np.where(dq > 0
-00041b90: 290a 2020 2020 2020 2020 2020 2020 6471  ).            dq
-00041ba0: 5f64 6174 6120 3d20 6e70 2e61 7272 6179  _data = np.array
-00041bb0: 285b 6e7a 5b30 5d2c 206e 7a5b 315d 2c20  ([nz[0], nz[1], 
-00041bc0: 6471 5b64 7120 3e20 305d 5d2c 2064 7479  dq[dq > 0]], dty
-00041bd0: 7065 3d6e 702e 696e 7431 3629 0a20 2020  pe=np.int16).   
-00041be0: 2020 2020 2020 2020 2068 6475 203d 2070           hdu = p
-00041bf0: 7966 6974 732e 496d 6167 6548 4455 2868  yfits.ImageHDU(h
-00041c00: 6561 6465 723d 6865 6164 6572 2c20 6461  eader=header, da
-00041c10: 7461 3d64 715f 6461 7461 290a 2020 2020  ta=dq_data).    
-00041c20: 2020 2020 2020 2020 6864 7573 2e61 7070          hdus.app
-00041c30: 656e 6428 6864 7529 0a0a 2020 2020 6f75  end(hdu)..    ou
-00041c40: 7470 7574 5f66 696c 656e 616d 6520 3d20  tput_filename = 
-00041c50: 6669 6c65 6e61 6d65 2e72 6570 6c61 6365  filename.replace
-00041c60: 2872 6570 6c61 6365 5b30 5d2c 2072 6570  (replace[0], rep
-00041c70: 6c61 6365 5b31 5d29 0a0a 2020 2020 6d73  lace[1])..    ms
-00041c80: 6720 3d20 2723 2064 756d 705f 666c 745f  g = '# dump_flt_
-00041c90: 6471 3a20 7b30 7d20 3e20 7b31 7d27 2e66  dq: {0} > {1}'.f
-00041ca0: 6f72 6d61 7428 6669 6c65 6e61 6d65 2c20  ormat(filename, 
-00041cb0: 6f75 7470 7574 5f66 696c 656e 616d 6529  output_filename)
-00041cc0: 0a20 2020 206c 6f67 5f63 6f6d 6d65 6e74  .    log_comment
-00041cd0: 284c 4f47 4649 4c45 2c20 6d73 672c 2076  (LOGFILE, msg, v
-00041ce0: 6572 626f 7365 3d76 6572 626f 7365 2c20  erbose=verbose, 
-00041cf0: 7368 6f77 5f64 6174 653d 5472 7565 290a  show_date=True).
-00041d00: 0a20 2020 2070 7966 6974 732e 4844 554c  .    pyfits.HDUL
-00041d10: 6973 7428 6864 7573 292e 7772 6974 6574  ist(hdus).writet
-00041d20: 6f28 6f75 7470 7574 5f66 696c 656e 616d  o(output_filenam
-00041d30: 652c 206f 7665 7277 7269 7465 3d54 7275  e, overwrite=Tru
-00041d40: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00041d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041d60: 2020 2020 6f75 7470 7574 5f76 6572 6966      output_verif
-00041d70: 793d 2766 6978 2729 0a20 2020 200a 2020  y='fix').    .  
-00041d80: 2020 696d 2e63 6c6f 7365 2829 0a0a 0a64    im.close()...d
-00041d90: 6566 2061 7070 6c79 5f66 6c74 5f64 7128  ef apply_flt_dq(
-00041da0: 6669 6c65 6e61 6d65 2c20 7265 706c 6163  filename, replac
-00041db0: 653d 2827 2e66 6974 7327 2c20 272e 6471  e=('.fits', '.dq
-00041dc0: 2e66 6974 732e 677a 2729 2c20 7665 7262  .fits.gz'), verb
-00041dd0: 6f73 653d 5472 7565 2c20 6f72 5f63 6f6d  ose=True, or_com
-00041de0: 6269 6e65 3d46 616c 7365 293a 0a20 2020  bine=False):.   
-00041df0: 2022 2222 0a20 2020 2052 6561 6420 616e   """.    Read an
-00041e00: 6420 6170 706c 7920 7468 6520 636f 6d70  d apply the comp
-00041e10: 6163 7420 6578 706f 7375 7265 2069 6e66  act exposure inf
-00041e20: 6f72 6d61 7469 6f6e 2066 696c 650a 0a20  ormation file.. 
-00041e30: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00041e40: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00041e50: 2066 696c 656e 616d 6520 3a20 7374 720a   filename : str.
-00041e60: 2020 2020 2020 2020 464c 542f 464c 4320          FLT/FLC 
-00041e70: 6669 6c65 6e61 6d65 2e0a 0a20 2020 2072  filename...    r
-00041e80: 6570 6c61 6365 203a 2028 7374 722c 2073  eplace : (str, s
-00041e90: 7472 290a 2020 2020 2020 2020 5265 706c  tr).        Repl
-00041ea0: 6163 6520 6172 6775 6d65 6e74 7320 666f  ace arguments fo
-00041eb0: 7220 6f75 7470 7574 2044 5120 6669 6c65  r output DQ file
-00041ec0: 6e61 6d65 3a0a 0a20 2020 2020 2020 203e  name:..        >
-00041ed0: 3e3e 206f 7574 7075 745f 6669 6c65 6e61  >> output_filena
-00041ee0: 6d65 203d 2066 696c 656e 616d 652e 7265  me = filename.re
-00041ef0: 706c 6163 6528 7265 706c 6163 655b 305d  place(replace[0]
-00041f00: 2c20 7265 706c 6163 655b 315d 290a 0a20  , replace[1]).. 
-00041f10: 2020 206f 725f 636f 6d62 696e 6520 3a20     or_combine : 
-00041f20: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
-00041f30: 5472 7565 2c20 7468 656e 2061 7070 6c79  True, then apply
-00041f40: 2044 5120 6461 7461 2069 6e20 606f 7574   DQ data in `out
-00041f50: 7075 745f 6669 6c65 6e61 6d65 6020 7769  put_filename` wi
-00041f60: 7468 204f 5220 6c6f 6769 632e 0a0a 2020  th OR logic...  
-00041f70: 2020 2020 2020 4966 2046 616c 7365 2c20        If False, 
-00041f80: 7468 656e 2072 6573 6574 2074 6865 2044  then reset the D
-00041f90: 5120 6578 7465 6e73 696f 6e73 2074 6f20  Q extensions to 
-00041fa0: 6265 2065 7861 6374 6c79 2074 686f 7365  be exactly those
-00041fb0: 2069 6e0a 2020 2020 2020 2020 606f 7574   in.        `out
-00041fc0: 7075 745f 6669 6c65 6e61 6d65 602e 0a0a  put_filename`...
-00041fd0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00041fe0: 2d2d 2d2d 2d2d 2d0a 2020 2020 5772 6974  -------.    Writ
-00041ff0: 6573 2068 6561 6465 7220 616e 6420 636f  es header and co
-00042000: 6d70 6163 7420 4451 2061 7272 6179 2074  mpact DQ array t
-00042010: 6f20 606f 7574 7075 745f 6669 6c65 6e61  o `output_filena
-00042020: 6d65 602e 0a0a 2020 2020 2222 220a 0a20  me`...    """.. 
-00042030: 2020 206f 7574 7075 745f 6669 6c65 6e61     output_filena
-00042040: 6d65 203d 2066 696c 656e 616d 652e 7265  me = filename.re
-00042050: 706c 6163 6528 7265 706c 6163 655b 305d  place(replace[0]
-00042060: 2c20 7265 706c 6163 655b 315d 290a 0a20  , replace[1]).. 
-00042070: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
-00042080: 682e 6578 6973 7473 286f 7574 7075 745f  h.exists(output_
-00042090: 6669 6c65 6e61 6d65 293a 0a20 2020 2020  filename):.     
-000420a0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-000420b0: 0a20 2020 2069 6d20 3d20 7079 6669 7473  .    im = pyfits
-000420c0: 2e6f 7065 6e28 6669 6c65 6e61 6d65 2c20  .open(filename, 
-000420d0: 6d6f 6465 3d27 7570 6461 7465 2729 0a0a  mode='update')..
-000420e0: 2020 2020 6d73 6720 3d20 2723 2061 7070      msg = '# app
-000420f0: 6c79 5f66 6c74 5f64 713a 207b 317d 203e  ly_flt_dq: {1} >
-00042100: 207b 307d 272e 666f 726d 6174 2866 696c   {0}'.format(fil
-00042110: 656e 616d 652c 206f 7574 7075 745f 6669  ename, output_fi
-00042120: 6c65 6e61 6d65 290a 2020 2020 6c6f 675f  lename).    log_
-00042130: 636f 6d6d 656e 7428 4c4f 4746 494c 452c  comment(LOGFILE,
-00042140: 206d 7367 2c20 7665 7262 6f73 653d 7665   msg, verbose=ve
-00042150: 7262 6f73 652c 2073 686f 775f 6461 7465  rbose, show_date
-00042160: 3d54 7275 6529 0a0a 2020 2020 6471 203d  =True)..    dq =
-00042170: 2070 7966 6974 732e 6f70 656e 286f 7574   pyfits.open(out
-00042180: 7075 745f 6669 6c65 6e61 6d65 290a 2020  put_filename).  
-00042190: 2020 666f 7220 6578 7420 696e 205b 312c    for ext in [1,
-000421a0: 2032 2c20 332c 2034 5d3a 0a20 2020 2020   2, 3, 4]:.     
-000421b0: 2020 2069 6620 2828 2753 4349 272c 2065     if (('SCI', e
-000421c0: 7874 2920 696e 2069 6d29 2026 2028 2827  xt) in im) & (('
-000421d0: 5343 4927 2c20 6578 7429 2069 6e20 6471  SCI', ext) in dq
-000421e0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000421f0: 6820 3d20 6471 5b27 5343 4927 2c20 6578  h = dq['SCI', ex
-00042200: 745d 2e64 6174 612e 7368 6170 650a 2020  t].data.shape.  
-00042210: 2020 2020 2020 2020 2020 6966 2073 685b            if sh[
-00042220: 305d 203d 3d20 333a 0a20 2020 2020 2020  0] == 3:.       
-00042230: 2020 2020 2020 2020 2069 2c20 6a2c 2064           i, j, d
-00042240: 715f 6920 3d20 6471 5b27 5343 4927 2c20  q_i = dq['SCI', 
-00042250: 6578 745d 2e64 6174 610a 2020 2020 2020  ext].data.      
-00042260: 2020 2020 2020 656c 6966 2073 685b 315d        elif sh[1]
-00042270: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-00042280: 2020 2020 2020 206e 7a2c 2064 715f 6920         nz, dq_i 
-00042290: 3d20 6471 5b27 5343 4927 2c20 6578 745d  = dq['SCI', ext]
-000422a0: 2e64 6174 610a 2020 2020 2020 2020 2020  .data.          
-000422b0: 2020 2020 2020 692c 206a 203d 206e 702e        i, j = np.
-000422c0: 756e 7261 7665 6c5f 696e 6465 7828 6e7a  unravel_index(nz
-000422d0: 2c20 7368 290a 2020 2020 2020 2020 2020  , sh).          
-000422e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000422f0: 2020 2020 2020 2020 7261 6973 6520 494f          raise IO
-00042300: 4572 726f 7228 2764 715b 7b30 7d5d 2073  Error('dq[{0}] s
-00042310: 6861 7065 207b 317d 206e 6f74 2072 6563  hape {1} not rec
-00042320: 6f67 6e69 7a65 6427 2e66 6f72 6d61 7428  ognized'.format(
-00042330: 6578 742c 2073 6829 290a 2020 2020 2020  ext, sh)).      
-00042340: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00042350: 2020 2020 2020 2023 2041 7070 6c79 2044         # Apply D
-00042360: 510a 2020 2020 2020 2020 2020 2020 6966  Q.            if
-00042370: 206f 725f 636f 6d62 696e 653a 0a20 2020   or_combine:.   
-00042380: 2020 2020 2020 2020 2020 2020 2069 6d5b               im[
-00042390: 2744 5127 2c20 6578 745d 2e64 6174 615b  'DQ', ext].data[
-000423a0: 692c 206a 5d20 213d 2064 715f 690a 2020  i, j] != dq_i.  
-000423b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000423c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000423d0: 696d 5b27 4451 272c 2065 7874 5d2e 6461  im['DQ', ext].da
-000423e0: 7461 202a 3d20 300a 2020 2020 2020 2020  ta *= 0.        
-000423f0: 2020 2020 2020 2020 696d 5b27 4451 272c          im['DQ',
-00042400: 2065 7874 5d2e 6461 7461 5b69 2c20 6a5d   ext].data[i, j]
-00042410: 203d 2064 715f 690a 0a20 2020 2020 2020   = dq_i..       
-00042420: 2020 2020 2023 2043 6f70 7920 6865 6164       # Copy head
-00042430: 6572 0a20 2020 2020 2020 2020 2020 2068  er.            h
-00042440: 6173 5f62 6c6f 7473 6b79 203d 2027 424c  as_blotsky = 'BL
-00042450: 4f54 534b 5927 2069 6e20 696d 5b27 5343  OTSKY' in im['SC
-00042460: 4927 2c20 6578 745d 2e68 6561 6465 720a  I', ext].header.
-00042470: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00042480: 6b20 696e 2064 715b 2753 4349 272c 2065  k in dq['SCI', e
-00042490: 7874 5d2e 6865 6164 6572 3a0a 2020 2020  xt].header:.    
-000424a0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-000424b0: 2069 6e20 5b27 4249 5450 4958 272c 2027   in ['BITPIX', '
-000424c0: 4e41 5849 5331 272c 2027 4e41 5849 5332  NAXIS1', 'NAXIS2
-000424d0: 272c 2027 272c 2027 4849 5354 4f52 5927  ', '', 'HISTORY'
-000424e0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-000424f0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00042500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042510: 2069 6d5b 2753 4349 272c 2065 7874 5d2e   im['SCI', ext].
-00042520: 6865 6164 6572 5b6b 5d20 3d20 6471 5b27  header[k] = dq['
-00042530: 5343 4927 2c20 6578 745d 2e68 6561 6465  SCI', ext].heade
-00042540: 725b 6b5d 0a0a 2020 2020 2020 2020 2020  r[k]..          
-00042550: 2020 6966 2028 6e6f 7420 6861 735f 626c    if (not has_bl
-00042560: 6f74 736b 7929 2026 2028 2742 4c4f 5453  otsky) & ('BLOTS
-00042570: 4b59 2720 696e 2064 715b 2753 4349 272c  KY' in dq['SCI',
-00042580: 2065 7874 5d2e 6865 6164 6572 293a 0a20   ext].header):. 
-00042590: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000425a0: 6d5b 2753 4349 272c 2065 7874 5d2e 6865  m['SCI', ext].he
-000425b0: 6164 6572 5b27 424c 4f54 534b 5927 5d20  ader['BLOTSKY'] 
-000425c0: 3d20 4661 6c73 650a 0a20 2020 2069 6d2e  = False..    im.
-000425d0: 666c 7573 6828 290a 2020 2020 696d 2e63  flush().    im.c
-000425e0: 6c6f 7365 2829 0a0a 0a64 6566 2052 4742  lose()...def RGB
-000425f0: 746f 4865 7828 7661 6c73 2c20 7267 6274  toHex(vals, rgbt
-00042600: 7970 653d 3129 3a0a 2020 2020 2222 2243  ype=1):.    """C
-00042610: 6f6e 7665 7274 7320 5247 4220 7661 6c75  onverts RGB valu
-00042620: 6573 2069 6e20 6120 7661 7269 6574 7920  es in a variety 
-00042630: 6f66 2066 6f72 6d61 7473 2074 6f20 4865  of formats to He
-00042640: 7820 7661 6c75 6573 2e0a 0a20 2020 2050  x values...    P
-00042650: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00042660: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2076 616c  --------.    val
-00042670: 7320 3a20 7475 706c 650a 2020 2020 2020  s : tuple.      
-00042680: 2020 2041 6e20 5247 422f 5247 4241 2074     An RGB/RGBA t
-00042690: 7570 6c65 0a0a 2020 2020 7267 625f 7479  uple..    rgb_ty
-000426a0: 7065 203a 2069 6e74 0a20 2020 2020 2020  pe : int.       
-000426b0: 2056 616c 6964 2076 616c 7573 2061 7265   Valid valus are
-000426c0: 3a0a 2020 2020 2020 2020 202d 2031 203d  :.         - 1 =
-000426d0: 2049 6e70 7574 7320 6172 6520 696e 2074   Inputs are in t
-000426e0: 6865 2072 616e 6765 2030 2074 6f20 310a  he range 0 to 1.
-000426f0: 2020 2020 2020 2020 202d 2032 3536 203d           - 256 =
-00042700: 2049 6e70 7574 7320 6172 6520 696e 2074   Inputs are in t
-00042710: 6865 2072 616e 6765 2030 2074 6f20 3235  he range 0 to 25
-00042720: 350a 200a 2020 2020 5265 7475 726e 730a  5. .    Returns.
-00042730: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00042740: 6865 7874 7374 7220 3a20 7374 720a 2020  hextstr : str.  
-00042750: 2020 2020 2020 4120 6865 7820 7374 7269        A hex stri
-00042760: 6e67 2069 6e20 7468 6520 666f 726d 2027  ng in the form '
-00042770: 2352 5247 4742 4227 206f 7220 2723 5252  #RRGGBB' or '#RR
-00042780: 4747 4242 4141 270a 0a20 2020 2052 6566  GGBBAA'..    Ref
-00042790: 6572 656e 6365 730a 2020 2020 2d2d 2d2d  erences.    ----
-000427a0: 2d2d 2d2d 2d2d 0a20 2020 2028 6372 6564  ------.    (cred
-000427b0: 6974 3a20 5279 6368 6172 6420 4020 6874  it: Rychard @ ht
-000427c0: 7470 733a 2f2f 7374 6163 6b6f 7665 7266  tps://stackoverf
-000427d0: 6c6f 772e 636f 6d2f 612f 3438 3238 3831  low.com/a/482881
-000427e0: 3733 290a 0a20 2020 2022 2222 0a0a 2020  73)..    """..  
-000427f0: 2020 6d73 6720 3d20 2252 4742 206f 7220    msg = "RGB or 
-00042800: 5247 4241 2069 6e70 7574 7320 746f 2052  RGBA inputs to R
-00042810: 4742 746f 4865 7820 6d75 7374 2068 6176  GBtoHex must hav
-00042820: 6520 7468 7265 6520 6f72 2066 6f75 7220  e three or four 
-00042830: 656c 656d 656e 7473 2122 0a20 2020 2069  elements!".    i
-00042840: 6620 286c 656e 2876 616c 7329 2021 3d20  f (len(vals) != 
-00042850: 3329 2026 2028 6c65 6e28 7661 6c73 2920  3) & (len(vals) 
-00042860: 213d 2034 293a 0a20 2020 2020 2020 2072  != 4):.        r
-00042870: 6169 7365 2045 7863 6570 7469 6f6e 286d  aise Exception(m
-00042880: 7367 290a 0a20 2020 2069 6620 2872 6762  sg)..    if (rgb
-00042890: 7479 7065 2021 3d20 3129 2026 2028 7267  type != 1) & (rg
-000428a0: 6274 7970 6520 213d 2032 3536 293a 0a20  btype != 256):. 
-000428b0: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-000428c0: 6570 7469 6f6e 2822 7267 6274 7970 6520  eption("rgbtype 
-000428d0: 6d75 7374 2062 6520 3120 6f72 2032 3536  must be 1 or 256
-000428e0: 2122 290a 0a20 2020 2023 2043 6f6e 7665  !")..    # Conve
-000428f0: 7274 2066 726f 6d20 302d 3120 5247 422f  rt from 0-1 RGB/
-00042900: 5247 4241 2074 6f20 302d 3235 3520 5247  RGBA to 0-255 RG
-00042910: 422f 5247 4241 0a20 2020 2069 6620 7267  B/RGBA.    if rg
-00042920: 6274 7970 6520 3d3d 2031 3a0a 2020 2020  btype == 1:.    
-00042930: 2020 2020 7661 6c73 203d 205b 3235 352a      vals = [255*
-00042940: 7820 666f 7220 7820 696e 2076 616c 735b  x for x in vals[
-00042950: 3a33 5d5d 0a0a 2020 2020 2320 456e 7375  :3]]..    # Ensu
-00042960: 7265 2076 616c 7565 7320 6172 6520 726f  re values are ro
-00042970: 756e 6465 6420 696e 7465 6765 7273 2c20  unded integers, 
-00042980: 636f 6e76 6572 7420 746f 2068 6578 2c20  convert to hex, 
-00042990: 616e 6420 636f 6e63 6174 656e 6174 650a  and concatenate.
-000429a0: 2020 2020 7265 7475 726e 2027 2327 202b      return '#' +
-000429b0: 2027 272e 6a6f 696e 285b 277b 3a30 3258   ''.join(['{:02X
-000429c0: 7d27 2e66 6f72 6d61 7428 696e 7428 726f  }'.format(int(ro
-000429d0: 756e 6428 7829 2929 2066 6f72 2078 2069  und(x))) for x i
-000429e0: 6e20 7661 6c73 5d29 0a0a 0a64 6566 2063  n vals])...def c
-000429f0: 6174 616c 6f67 5f6d 6173 6b28 6361 742c  atalog_mask(cat,
-00042a00: 2065 636f 6c3d 2746 4c55 5845 5252 5f41   ecol='FLUXERR_A
-00042a10: 5045 525f 3027 2c20 6d61 785f 6572 725f  PER_0', max_err_
-00042a20: 7065 7263 656e 7469 6c65 3d39 302c 2070  percentile=90, p
-00042a30: 6164 3d30 2e30 352c 2070 6164 5f69 735f  ad=0.05, pad_is_
-00042a40: 6162 736f 6c75 7465 3d46 616c 7365 2c20  absolute=False, 
-00042a50: 6d69 6e5f 666c 7578 5f72 6164 6975 733d  min_flux_radius=
-00042a60: 312e 293a 0a20 2020 2022 2222 0a20 2020  1.):.    """.   
-00042a70: 2043 6f6d 7075 7465 2061 2063 6174 616c   Compute a catal
-00042a80: 6f67 206d 6173 6b20 666f 720a 2020 2020  og mask for.    
-00042a90: 2020 3129 204f 626a 6563 7473 2077 6974    1) Objects wit
-00042aa0: 6869 6e20 6070 6164 6020 6f66 2074 6865  hin `pad` of the
-00042ab0: 2065 6467 6520 6f66 2074 6865 2063 6174   edge of the cat
-00042ac0: 616c 6f67 2063 6f6e 7665 7820 6875 6c6c  alog convex hull
-00042ad0: 0a20 2020 2020 2032 2920 556e 6365 7274  .      2) Uncert
-00042ae0: 6169 6e74 6965 7320 3c20 606d 6178 5f65  ainties < `max_e
-00042af0: 7272 5f70 6572 6365 6e74 696c 6560 0a0a  rr_percentile`..
-00042b00: 2020 2020 2222 220a 2020 2020 7465 7374      """.    test
-00042b10: 203d 206e 702e 6973 6669 6e69 7465 2863   = np.isfinite(c
-00042b20: 6174 5b27 464c 5558 5f41 5554 4f27 5d29  at['FLUX_AUTO'])
-00042b30: 0a20 2020 2069 6620 2746 4c55 585f 5241  .    if 'FLUX_RA
-00042b40: 4449 5553 2720 696e 2063 6174 2e63 6f6c  DIUS' in cat.col
-00042b50: 6e61 6d65 733a 0a20 2020 2020 2020 2074  names:.        t
-00042b60: 6573 7420 263d 2063 6174 5b27 464c 5558  est &= cat['FLUX
-00042b70: 5f52 4144 4955 5327 5d20 3e20 6d69 6e5f  _RADIUS'] > min_
-00042b80: 666c 7578 5f72 6164 6975 730a 0a20 2020  flux_radius..   
-00042b90: 2074 6573 7420 263d 2028 6361 745b 2754   test &= (cat['T
-00042ba0: 4852 4553 4827 5d20 3e20 3029 2026 2028  HRESH'] > 0) & (
-00042bb0: 6361 745b 2754 4852 4553 4827 5d20 3c20  cat['THRESH'] < 
-00042bc0: 3165 3238 290a 0a20 2020 206e 6f74 5f65  1e28)..    not_e
-00042bd0: 6467 6520 3d20 6875 6c6c 5f65 6467 655f  dge = hull_edge_
-00042be0: 6d61 736b 2863 6174 5b27 585f 494d 4147  mask(cat['X_IMAG
-00042bf0: 4527 5d2c 2063 6174 5b27 595f 494d 4147  E'], cat['Y_IMAG
-00042c00: 4527 5d2c 0a20 2020 2020 2020 2020 2020  E'],.           
-00042c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042c20: 2020 2070 6164 3d70 6164 2c20 7061 645f     pad=pad, pad_
-00042c30: 6973 5f61 6273 6f6c 7574 653d 7061 645f  is_absolute=pad_
-00042c40: 6973 5f61 6273 6f6c 7574 6529 0a0a 2020  is_absolute)..  
-00042c50: 2020 7465 7374 2026 3d20 6e6f 745f 6564    test &= not_ed
-00042c60: 6765 0a0a 2020 2020 6966 2065 636f 6c20  ge..    if ecol 
-00042c70: 696e 2063 6174 2e63 6f6c 6e61 6d65 733a  in cat.colnames:
-00042c80: 0a20 2020 2020 2020 2076 616c 6964 203d  .        valid =
-00042c90: 206e 702e 6973 6669 6e69 7465 2863 6174   np.isfinite(cat
-00042ca0: 5b65 636f 6c5d 290a 2020 2020 2020 2020  [ecol]).        
-00042cb0: 6966 206d 6178 5f65 7272 5f70 6572 6365  if max_err_perce
-00042cc0: 6e74 696c 6520 3c20 3130 303a 0a20 2020  ntile < 100:.   
-00042cd0: 2020 2020 2020 2020 2074 6573 7420 263d           test &=
-00042ce0: 2063 6174 5b65 636f 6c5d 203c 206e 702e   cat[ecol] < np.
-00042cf0: 7065 7263 656e 7469 6c65 2863 6174 5b65  percentile(cat[e
-00042d00: 636f 6c5d 5b28 7e6e 6f74 5f65 6467 6529  col][(~not_edge)
-00042d10: 2026 2076 616c 6964 5d2c 0a20 2020 2020   & valid],.     
-00042d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042d40: 2020 2020 206d 6178 5f65 7272 5f70 6572       max_err_per
-00042d50: 6365 6e74 696c 6529 0a0a 2020 2020 7265  centile)..    re
-00042d60: 7475 726e 2074 6573 740a 0a0a 6465 6620  turn test...def 
-00042d70: 6875 6c6c 5f65 6467 655f 6d61 736b 2878  hull_edge_mask(x
-00042d80: 2c20 792c 2070 6164 3d31 3030 2c20 7061  , y, pad=100, pa
-00042d90: 645f 6973 5f61 6273 6f6c 7574 653d 5472  d_is_absolute=Tr
-00042da0: 7565 2c20 6d61 736b 3d4e 6f6e 6529 3a0a  ue, mask=None):.
-00042db0: 2020 2020 2222 220a 2020 2020 436f 6d70      """.    Comp
-00042dc0: 7574 6520 6765 6f6d 6574 7269 6361 6c20  ute geometrical 
-00042dd0: 6564 6765 206d 6173 6b20 666f 7220 706f  edge mask for po
-00042de0: 696e 7473 2077 6974 6869 6e20 6120 636f  ints within a co
-00042df0: 6e76 6578 2068 756c 6c0a 0a20 2020 2050  nvex hull..    P
-00042e00: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00042e10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2078 2c20  --------.    x, 
-00042e20: 7920 3a20 6172 7261 790a 2020 2020 2020  y : array.      
-00042e30: 2020 436f 6f72 6469 6e61 7465 7320 6f66    Coordinates of
-00042e40: 2074 6865 2063 6174 616c 6f67 0a0a 2020   the catalog..  
-00042e50: 2020 7061 6420 3a20 666c 6f61 740a 2020    pad : float.  
-00042e60: 2020 2020 2020 4275 6666 6572 2070 6164        Buffer pad
-00042e70: 6469 6e67 0a0a 2020 2020 7061 645f 6973  ding..    pad_is
-00042e80: 5f61 6273 6f6c 7574 6520 3a20 626f 6f6c  _absolute : bool
-00042e90: 0a20 2020 2020 2020 2049 6620 5472 7565  .        If True
-00042ea0: 2c20 7468 656e 2074 6865 2062 7566 6665  , then the buffe
-00042eb0: 7220 6973 2074 616b 656e 2066 726f 6d20  r is taken from 
-00042ec0: 6070 6164 6020 2865 2e67 2e2c 2070 6978  `pad` (e.g., pix
-00042ed0: 656c 7329 2e20 2049 660a 2020 2020 2020  els).  If.      
-00042ee0: 2020 4661 6c73 652c 2074 6865 6e20 6070    False, then `p
-00042ef0: 6164 6020 6973 2074 7265 6174 6564 2061  ad` is treated a
-00042f00: 7320 6120 6672 6163 7469 6f6e 206f 6620  s a fraction of 
-00042f10: 7468 6520 6c69 6e65 6172 2064 696d 656e  the linear dimen
-00042f20: 7369 6f6e 0a20 2020 2020 2020 206f 6620  sion.        of 
-00042f30: 7468 6520 6361 7461 6c6f 6720 2860 7e73  the catalog (`~s
-00042f40: 7172 7428 6875 6c6c 2061 7265 6129 6029  qrt(hull area)`)
-00042f50: 2e0a 0a20 2020 206d 6173 6b20 3a20 626f  ...    mask : bo
-00042f60: 6f6c 2061 7272 6179 0a20 2020 2020 2020  ol array.       
-00042f70: 204d 6173 6b20 746f 2061 7070 6c79 2074   Mask to apply t
-00042f80: 6f20 782f 7920 6265 666f 7265 2063 6f6d  o x/y before com
-00042f90: 7075 7469 6e67 2074 6865 2063 6f6e 7665  puting the conve
-00042fa0: 7820 6875 6c6c 0a0a 2020 2020 5265 7475  x hull..    Retu
-00042fb0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00042fc0: 2020 2020 6d61 736b 203a 2062 6f6f 6c20      mask : bool 
-00042fd0: 6172 7261 790a 2020 2020 2020 2020 5472  array.        Tr
-00042fe0: 7565 2069 6620 706f 696e 7473 2077 6974  ue if points wit
-00042ff0: 6869 6e20 7468 6520 6275 6666 6572 6564  hin the buffered
-00043000: 2068 756c 6c0a 0a20 2020 2022 2222 0a0a   hull..    """..
-00043010: 2020 2020 6672 6f6d 2073 6369 7079 2e73      from scipy.s
-00043020: 7061 7469 616c 2069 6d70 6f72 7420 436f  patial import Co
-00043030: 6e76 6578 4875 6c6c 0a20 2020 2066 726f  nvexHull.    fro
-00043040: 6d20 7368 6170 656c 792e 6765 6f6d 6574  m shapely.geomet
-00043050: 7279 2069 6d70 6f72 7420 506f 6c79 676f  ry import Polygo
-00043060: 6e2c 2050 6f69 6e74 0a0a 2020 2020 7879  n, Point..    xy
-00043070: 203d 206e 702e 6172 7261 7928 5b78 2c20   = np.array([x, 
-00043080: 795d 292e 540a 0a20 2020 2069 6620 6d61  y]).T..    if ma
-00043090: 736b 2069 7320 4e6f 6e65 3a0a 2020 2020  sk is None:.    
-000430a0: 2020 2020 6875 6c6c 203d 2043 6f6e 7665      hull = Conve
-000430b0: 7848 756c 6c28 7879 290a 2020 2020 656c  xHull(xy).    el
-000430c0: 7365 3a0a 2020 2020 2020 2020 6875 6c6c  se:.        hull
-000430d0: 203d 2043 6f6e 7665 7848 756c 6c28 7879   = ConvexHull(xy
-000430e0: 5b6d 6173 6b2c 203a 5d29 0a0a 2020 2020  [mask, :])..    
-000430f0: 7078 7920 3d20 7879 5b68 756c 6c2e 7665  pxy = xy[hull.ve
-00043100: 7274 6963 6573 2c20 3a5d 0a20 2020 2070  rtices, :].    p
-00043110: 6f6c 7920 3d20 506f 6c79 676f 6e28 7078  oly = Polygon(px
-00043120: 7929 0a0a 2020 2020 6966 2070 6164 5f69  y)..    if pad_i
-00043130: 735f 6162 736f 6c75 7465 3a0a 2020 2020  s_absolute:.    
-00043140: 2020 2020 6275 6666 203d 202d 7061 640a      buff = -pad.
-00043150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00043160: 2020 2320 6c69 6e65 6172 2064 696d 656e    # linear dimen
-00043170: 7369 6f6e 207e 2073 7172 7428 6172 6561  sion ~ sqrt(area
-00043180: 290a 2020 2020 2020 2020 6275 6666 203d  ).        buff =
-00043190: 202d 7061 642a 6e70 2e73 7172 7428 706f   -pad*np.sqrt(po
-000431a0: 6c79 2e61 7265 6129 0a0a 2020 2020 7062  ly.area)..    pb
-000431b0: 7566 6620 3d20 706f 6c79 2e62 7566 6665  uff = poly.buffe
-000431c0: 7228 6275 6666 290a 2020 2020 696e 5f62  r(buff).    in_b
-000431d0: 7566 6620 3d20 6e70 2e61 7272 6179 285b  uff = np.array([
-000431e0: 7062 7566 662e 636f 6e74 6169 6e73 2850  pbuff.contains(P
-000431f0: 6f69 6e74 285b 785b 695d 2c20 795b 695d  oint([x[i], y[i]
-00043200: 5d29 2920 666f 7220 6920 696e 2072 616e  ])) for i in ran
-00043210: 6765 286c 656e 2878 2929 5d29 0a0a 2020  ge(len(x))])..  
-00043220: 2020 7265 7475 726e 2069 6e5f 6275 6666    return in_buff
-00043230: 0a0a 0a64 6566 2063 6f6e 7665 785f 6875  ...def convex_hu
-00043240: 6c6c 5f77 7261 7070 6572 2878 2c20 7929  ll_wrapper(x, y)
-00043250: 3a0a 2020 2020 2222 220a 2020 2020 4765  :.    """.    Ge
-00043260: 6e65 7261 7465 2061 2063 6f6e 7665 7820  nerate a convex 
-00043270: 6875 6c6c 2066 726f 6d20 6120 6c69 7374  hull from a list
-00043280: 206f 6620 706f 696e 7473 0a20 2020 200a   of points.    .
-00043290: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-000432a0: 200a 2020 2020 7078 7920 3a20 2861 7272   .    pxy : (arr
-000432b0: 6179 2c20 6172 7261 7929 0a20 2020 2020  ay, array).     
-000432c0: 2020 2054 7570 6c65 206f 6620 6875 6c6c     Tuple of hull
-000432d0: 2076 6572 7469 6365 730a 2020 2020 0a20   vertices.    . 
-000432e0: 2020 2070 6f6c 7920 3a20 607e 7368 6170     poly : `~shap
-000432f0: 656c 792e 6765 6f6d 6574 7279 2e50 6f6c  ely.geometry.Pol
-00043300: 7967 6f6e 600a 2020 2020 2020 2020 506f  ygon`.        Po
-00043310: 6c79 676f 6e20 6f62 6a65 6374 2e0a 2020  lygon object..  
-00043320: 2020 0a20 2020 2068 756c 6c20 3a20 607e    .    hull : `~
-00043330: 7363 6970 792e 7370 6174 6961 6c2e 436f  scipy.spatial.Co
-00043340: 6e76 6578 4875 6c6c 600a 2020 2020 2020  nvexHull`.      
-00043350: 2020 5468 6520 6875 6c6c 206f 626a 6563    The hull objec
-00043360: 742e 0a20 2020 2020 2020 200a 2020 2020  t..        .    
-00043370: 2222 220a 2020 2020 6672 6f6d 2073 6369  """.    from sci
-00043380: 7079 2e73 7061 7469 616c 2069 6d70 6f72  py.spatial impor
-00043390: 7420 436f 6e76 6578 4875 6c6c 0a20 2020  t ConvexHull.   
-000433a0: 2066 726f 6d20 7368 6170 656c 792e 6765   from shapely.ge
-000433b0: 6f6d 6574 7279 2069 6d70 6f72 7420 506f  ometry import Po
-000433c0: 6c79 676f 6e2c 2050 6f69 6e74 0a0a 2020  lygon, Point..  
-000433d0: 2020 7879 203d 206e 702e 6172 7261 7928    xy = np.array(
-000433e0: 5b78 2c20 795d 292e 540a 2020 2020 6875  [x, y]).T.    hu
-000433f0: 6c6c 203d 2043 6f6e 7665 7848 756c 6c28  ll = ConvexHull(
-00043400: 7879 290a 2020 2020 7078 7920 3d20 7879  xy).    pxy = xy
-00043410: 5b68 756c 6c2e 7665 7274 6963 6573 2c20  [hull.vertices, 
-00043420: 3a5d 0a20 2020 2070 6f6c 7920 3d20 506f  :].    poly = Po
-00043430: 6c79 676f 6e28 7078 7929 0a20 2020 200a  lygon(pxy).    .
-00043440: 2020 2020 7265 7475 726e 2070 7879 2c20      return pxy, 
-00043450: 706f 6c79 2c20 6875 6c6c 0a0a 0a64 6566  poly, hull...def
-00043460: 2068 756c 6c5f 6172 6561 2878 2c20 7929   hull_area(x, y)
-00043470: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
-00043480: 7475 726e 2074 6865 2061 7265 6120 6f66  turn the area of
-00043490: 2061 2063 6f6e 7665 7820 6875 6c6c 206f   a convex hull o
-000434a0: 6620 6120 6c69 7374 206f 6620 706f 696e  f a list of poin
-000434b0: 7473 0a20 2020 2022 2222 0a20 2020 2070  ts.    """.    p
-000434c0: 7879 2c20 706f 6c79 2c20 6875 6c6c 203d  xy, poly, hull =
-000434d0: 2063 6f6e 7665 785f 6875 6c6c 5f77 7261   convex_hull_wra
-000434e0: 7070 6572 2878 2c20 7929 0a0a 2020 2020  pper(x, y)..    
-000434f0: 7265 7475 726e 2070 6f6c 792e 6172 6561  return poly.area
-00043500: 0a20 2020 200a 2020 2020 0a64 6566 2072  .    .    .def r
-00043510: 656d 6f76 655f 7465 7874 5f6c 6162 656c  emove_text_label
-00043520: 7328 6669 6729 3a0a 2020 2020 2222 220a  s(fig):.    """.
-00043530: 2020 2020 5265 6d6f 7665 2061 6c6c 2054      Remove all T
-00043540: 6578 7420 616e 6e6f 7461 7469 6f6e 7320  ext annotations 
-00043550: 6672 6f6d 2060 6066 6967 2e61 7865 7360  from ``fig.axes`
-00043560: 602e 0a20 2020 2022 2222 0a20 2020 2069  `..    """.    i
-00043570: 6d70 6f72 7420 6d61 7470 6c6f 746c 6962  mport matplotlib
-00043580: 0a20 2020 200a 2020 2020 666f 7220 6178  .    .    for ax
-00043590: 2069 6e20 6669 672e 6178 6573 3a0a 2020   in fig.axes:.  
-000435a0: 2020 2020 2020 666f 7220 6368 696c 6420        for child 
-000435b0: 696e 2061 782e 6765 745f 6368 696c 6472  in ax.get_childr
-000435c0: 656e 2829 3a0a 2020 2020 2020 2020 2020  en():.          
-000435d0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000435e0: 6368 696c 642c 206d 6174 706c 6f74 6c69  child, matplotli
-000435f0: 622e 7465 7874 2e54 6578 7429 3a0a 2020  b.text.Text):.  
-00043600: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00043610: 2063 6869 6c64 2e67 6574 5f74 6578 7428   child.get_text(
-00043620: 293a 2023 2044 6f6e 2774 2072 656d 6f76  ): # Don't remov
-00043630: 6520 656d 7074 7920 6c61 6265 6c73 0a20  e empty labels. 
-00043640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043650: 2020 2063 6869 6c64 2e73 6574 5f76 6973     child.set_vis
-00043660: 6962 6c65 2846 616c 7365 290a 0a20 2020  ible(False)..   
-00043670: 200a 4c4f 4746 494c 4520 3d20 272f 746d   .LOGFILE = '/tm
-00043680: 702f 6772 697a 6c69 2e6c 6f67 270a 0a0a  p/grizli.log'...
-00043690: 6465 6620 6c6f 675f 6675 6e63 7469 6f6e  def log_function
-000436a0: 5f61 7267 756d 656e 7473 284c 4f47 4649  _arguments(LOGFI
-000436b0: 4c45 2c20 6672 616d 652c 2066 756e 633d  LE, frame, func=
-000436c0: 2766 756e 6327 2c20 6967 6e6f 7265 3d5b  'func', ignore=[
-000436d0: 5d2c 2076 6572 626f 7365 3d54 7275 6529  ], verbose=True)
-000436e0: 3a0a 2020 2020 2222 220a 2020 2020 4c6f  :.    """.    Lo
-000436f0: 6720 6c6f 6361 6c20 7661 7269 6162 6c65  g local variable
-00043700: 732c 2065 2e67 2e2c 2070 6172 616d 6574  s, e.g., paramet
-00043710: 6572 2061 7267 7565 6d65 6e74 7320 746f  er arguements to
-00043720: 2061 2066 696c 650a 0a20 2020 2050 6172   a file..    Par
-00043730: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00043740: 2d2d 2d2d 2d2d 0a20 2020 204c 4f47 4649  ------.    LOGFI
-00043750: 4c45 203a 2073 7472 206f 7220 4e6f 6e65  LE : str or None
-00043760: 0a20 2020 2020 2020 204f 7574 7075 7420  .        Output 
-00043770: 6669 6c65 2e20 2049 6620 604e 6f6e 6560  file.  If `None`
-00043780: 2c20 7468 656e 2066 6f72 6365 2060 7665  , then force `ve
-00043790: 7262 6f73 653d 5472 7565 602e 0a0a 2020  rbose=True`...  
-000437a0: 2020 6672 616d 6520 3a20 607e 696e 7370    frame : `~insp
-000437b0: 6563 742e 6375 7272 656e 7466 7261 6d65  ect.currentframe
-000437c0: 2829 600a 2020 2020 2020 2020 4e61 6d65  ()`.        Name
-000437d0: 7370 6163 6520 6f62 6a65 6374 2e0a 0a20  space object... 
-000437e0: 2020 2066 756e 6320 3a20 7374 720a 2020     func : str.  
-000437f0: 2020 2020 2020 4675 6e63 7469 6f6e 206e        Function n
-00043800: 616d 6520 746f 2075 7365 0a20 2020 200a  ame to use.    .
-00043810: 2020 2020 6967 6e6f 7265 203a 206c 6973      ignore : lis
-00043820: 740a 2020 2020 2020 2020 5661 7269 6162  t.        Variab
-00043830: 6c65 206e 616d 6573 2074 6f20 6967 6e6f  le names to igno
-00043840: 7265 0a20 2020 200a 2020 2020 7665 7262  re.    .    verb
-00043850: 6f73 6520 3a20 626f 6f6c 0a20 2020 2020  ose : bool.     
-00043860: 2020 2050 7269 6e74 206d 6573 7361 6167     Print messaag
-00043870: 6520 746f 2073 7464 6f75 742e 0a0a 2020  e to stdout...  
-00043880: 2020 2222 220a 2020 2020 6172 6773 203d    """.    args =
-00043890: 2069 6e73 7065 6374 2e67 6574 6172 6776   inspect.getargv
-000438a0: 616c 7565 7328 6672 616d 6529 2e6c 6f63  alues(frame).loc
-000438b0: 616c 730a 2020 2020 6172 6773 2e70 6f70  als.    args.pop
-000438c0: 2827 6672 616d 6527 290a 2020 2020 666f  ('frame').    fo
-000438d0: 7220 6b20 696e 206c 6973 7428 6172 6773  r k in list(args
-000438e0: 2e6b 6579 7328 2929 3a0a 2020 2020 2020  .keys()):.      
-000438f0: 2020 6966 2068 6173 6174 7472 2861 7267    if hasattr(arg
-00043900: 735b 6b5d 2c20 275f 5f62 7569 6c74 696e  s[k], '__builtin
-00043910: 735f 5f27 293a 0a20 2020 2020 2020 2020  s__'):.         
-00043920: 2020 2061 7267 732e 706f 7028 6b29 0a20     args.pop(k). 
-00043930: 2020 200a 2020 2020 666f 7220 6b20 696e     .    for k in
-00043940: 2069 676e 6f72 653a 0a20 2020 2020 2020   ignore:.       
-00043950: 2069 6620 6b20 696e 2061 7267 733a 0a20   if k in args:. 
-00043960: 2020 2020 2020 2020 2020 2061 7267 732e             args.
-00043970: 706f 7028 6b29 0a20 2020 2020 2020 2020  pop(k).         
-00043980: 2020 200a 2020 2020 6966 2066 756e 6320     .    if func 
-00043990: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000439a0: 2020 2020 206c 6f67 7374 7220 3d20 275c       logstr = '\
-000439b0: 6e7b 307d 282a 2a7b 317d 295c 6e27 0a20  n{0}(**{1})\n'. 
-000439c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000439d0: 206c 6f67 7374 7220 3d20 275c 6e7b 317d   logstr = '\n{1}
-000439e0: 270a 0a20 2020 206c 6f67 7374 7220 3d20  '..    logstr = 
-000439f0: 6c6f 6773 7472 2e66 6f72 6d61 7428 6675  logstr.format(fu
-00043a00: 6e63 2c20 6172 6773 290a 2020 2020 6d73  nc, args).    ms
-00043a10: 6720 3d20 6c6f 675f 636f 6d6d 656e 7428  g = log_comment(
-00043a20: 4c4f 4746 494c 452c 206c 6f67 7374 722c  LOGFILE, logstr,
-00043a30: 2076 6572 626f 7365 3d76 6572 626f 7365   verbose=verbose
-00043a40: 2c20 7368 6f77 5f64 6174 653d 5472 7565  , show_date=True
-00043a50: 290a 0a20 2020 2072 6574 7572 6e20 6d73  )..    return ms
-00043a60: 670a 0a0a 6465 6620 6374 696d 655f 746f  g...def ctime_to
-00043a70: 5f69 736f 286d 7469 6d65 2c20 666f 726d  _iso(mtime, form
-00043a80: 6174 3d27 2561 2025 6220 2564 2025 483a  at='%a %b %d %H:
-00043a90: 254d 3a25 5320 2559 272c 2073 7472 6970  %M:%S %Y', strip
-00043aa0: 5f64 6563 696d 616c 3d54 7275 652c 2076  _decimal=True, v
-00043ab0: 6572 626f 7365 3d54 7275 6529 3a0a 2020  erbose=True):.  
-00043ac0: 2020 2222 220a 2020 2020 436f 6e76 6572    """.    Conver
-00043ad0: 7420 6074 696d 652e 6374 696d 6560 2073  t `time.ctime` s
-00043ae0: 7472 696e 6773 2074 6f20 4953 4f20 6461  trings to ISO da
-00043af0: 7465 730a 0a20 2020 2050 6172 616d 6574  tes..    Paramet
-00043b00: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00043b10: 2d2d 0a20 2020 206d 7469 6d65 203a 2073  --.    mtime : s
-00043b20: 7472 0a20 2020 2020 2020 2054 696d 6520  tr.        Time 
-00043b30: 7374 7269 6e67 2c20 6765 6e65 7261 6c6c  string, generall
-00043b40: 7920 6173 206f 7574 7075 7420 6672 6f6d  y as output from
-00043b50: 2060 7469 6d65 2e63 7469 6d65 602c 2065   `time.ctime`, e
-00043b60: 2e67 2e2c 200a 2020 2020 2020 2020 6060  .g., .        ``
-00043b70: 274d 6f6e 2053 6570 2031 3620 3131 3a32  'Mon Sep 16 11:2
-00043b80: 333a 3237 2032 3031 3927 6060 0a0a 2020  3:27 2019'``..  
-00043b90: 2020 666f 726d 6174 203a 2073 7472 0a20    format : str. 
-00043ba0: 2020 2020 2020 2060 6461 7465 7469 6d65         `datetime
-00043bb0: 2e73 7472 7074 696d 6560 2066 6f72 6d61  .strptime` forma
-00043bc0: 7420 7374 7269 6e67 2c20 636f 6465 7320  t string, codes 
-00043bd0: 6174 200a 2020 2020 2020 2020 6874 7470  at .        http
-00043be0: 733a 2f2f 7777 772e 7072 6f67 7261 6d69  s://www.programi
-00043bf0: 7a2e 636f 6d2f 7079 7468 6f6e 2d70 726f  z.com/python-pro
-00043c00: 6772 616d 6d69 6e67 2f64 6174 6574 696d  gramming/datetim
-00043c10: 652f 7374 7270 7469 6d65 0a0a 2020 2020  e/strptime..    
-00043c20: 7374 7269 705f 6465 6369 6d61 6c20 3a20  strip_decimal : 
-00043c30: 626f 6f6c 0a20 2020 2020 2020 2053 7472  bool.        Str
-00043c40: 6970 2064 6563 696d 616c 2073 6563 6f6e  ip decimal secon
-00043c50: 6473 2066 726f 6d20 656e 6420 6f66 2049  ds from end of I
-00043c60: 534f 2073 7472 696e 670a 0a20 2020 2076  SO string..    v
-00043c70: 6572 626f 7365 203a 2062 6f6f 6c0a 2020  erbose : bool.  
-00043c80: 2020 2020 2020 5072 696e 7420 6120 6d65        Print a me
-00043c90: 7373 6167 6520 6966 2063 6f6e 7665 7273  ssage if convers
-00043ca0: 696f 6e20 6661 696c 730a 0a20 2020 2052  ion fails..    R
-00043cb0: 6574 7572 6e73 200a 2020 2020 2d2d 2d2d  eturns .    ----
-00043cc0: 2d2d 2d0a 2020 2020 6973 6f20 3a20 7374  ---.    iso : st
-00043cd0: 720a 2020 2020 2020 2020 5374 7269 6e67  r.        String
-00043ce0: 2069 6e20 2873 6f72 7461 626c 6529 2049   in (sortable) I
-00043cf0: 534f 2066 6f72 6d61 742c 2065 2e67 2e2c  SO format, e.g.,
-00043d00: 2060 6027 3230 3139 2d30 392d 3136 2031   ``'2019-09-16 1
-00043d10: 313a 3233 3a32 372e 3030 3027 6060 0a0a  1:23:27.000'``..
-00043d20: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
-00043d30: 2061 7374 726f 7079 2e74 696d 6520 696d   astropy.time im
-00043d40: 706f 7274 2054 696d 650a 2020 2020 6672  port Time.    fr
-00043d50: 6f6d 2064 6174 6574 696d 6520 696d 706f  om datetime impo
-00043d60: 7274 2064 6174 6574 696d 650a 0a20 2020  rt datetime..   
-00043d70: 2023 2049 7320 616c 7265 6164 7920 4953   # Is already IS
-00043d80: 4f20 666f 726d 6174 0a20 2020 2069 6620  O format.    if 
-00043d90: 6d74 696d 652e 636f 756e 7428 272d 2729  mtime.count('-')
-00043da0: 203d 3d20 323a 0a20 2020 2020 2020 2069   == 2:.        i
-00043db0: 736f 203d 206d 7469 6d65 202b 2027 270a  so = mtime + ''.
-00043dc0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00043dd0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00043de0: 2020 2020 6973 6f20 3d20 5469 6d65 2864      iso = Time(d
-00043df0: 6174 6574 696d 652e 7374 7270 7469 6d65  atetime.strptime
-00043e00: 286d 7469 6d65 2c20 666f 726d 6174 292c  (mtime, format),
-00043e10: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00043e20: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
-00043e30: 2764 6174 6574 696d 6527 292e 6973 6f0a  'datetime').iso.
-00043e40: 2020 2020 2020 2020 6578 6365 7074 2056          except V
-00043e50: 616c 7565 4572 726f 723a 0a20 2020 2020  alueError:.     
-00043e60: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00043e70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00043e80: 2020 2070 7269 6e74 2866 2743 6f75 6c64     print(f'Could
-00043e90: 6e5c 2774 2063 6f6e 7665 7274 205c 277b  n\'t convert \'{
-00043ea0: 6d74 696d 657d 5c27 2077 6974 6820 270a  mtime}\' with '.
-00043eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043ec0: 2020 2020 2020 6627 666f 726d 6174 205c        f'format \
-00043ed0: 277b 666f 726d 6174 7d5c 2727 290a 0a20  '{format}\'').. 
-00043ee0: 2020 2020 2020 2020 2020 2069 736f 203d             iso =
-00043ef0: 206d 7469 6d65 202b 2027 270a 0a20 2020   mtime + ''..   
-00043f00: 2069 6620 7374 7269 705f 6465 6369 6d61   if strip_decima
-00043f10: 6c3a 0a20 2020 2020 2020 2069 736f 203d  l:.        iso =
-00043f20: 2069 736f 2e73 706c 6974 2827 2e27 295b   iso.split('.')[
-00043f30: 305d 0a0a 2020 2020 7265 7475 726e 2069  0]..    return i
-00043f40: 736f 0a0a 0a64 6566 206e 6f77 7469 6d65  so...def nowtime
-00043f50: 2869 736f 3d54 7275 6529 3a0a 2020 2020  (iso=True):.    
-00043f60: 2222 220a 2020 2020 5772 6170 7065 7220  """.    Wrapper 
-00043f70: 666f 7220 6061 7374 726f 7079 2e74 696d  for `astropy.tim
-00043f80: 652e 6e6f 7760 0a0a 2020 2020 5061 7261  e.now`..    Para
-00043f90: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00043fa0: 2d2d 2d2d 2d0a 2020 2020 6973 6f20 3a20  -----.    iso : 
-00043fb0: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
-00043fc0: 5472 7565 2c20 7265 7475 726e 2074 696d  True, return tim
-00043fd0: 6520 696e 2049 534f 2073 7472 696e 672c  e in ISO string,
-00043fe0: 2065 6c73 6520 7265 7475 726e 2054 696d   else return Tim
-00043ff0: 6520 6f62 6a65 6374 0a0a 2020 2020 5265  e object..    Re
-00044000: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00044010: 2d0a 2020 2020 746e 6f77 203a 2073 7472  -.    tnow : str
-00044020: 0a20 2020 2020 2020 2053 6565 2060 6973  .        See `is
-00044030: 6f60 0a0a 2020 2020 2222 220a 2020 2020  o`..    """.    
-00044040: 6672 6f6d 2061 7374 726f 7079 2e74 696d  from astropy.tim
-00044050: 6520 696d 706f 7274 2054 696d 650a 2020  e import Time.  
-00044060: 2020 746e 6f77 203d 2054 696d 652e 6e6f    tnow = Time.no
-00044070: 7728 290a 2020 2020 6966 2069 736f 3a0a  w().    if iso:.
-00044080: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-00044090: 6e6f 772e 6973 6f0a 2020 2020 656c 7365  now.iso.    else
-000440a0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000440b0: 2074 6e6f 770a 0a0a 6465 6620 6c6f 675f   tnow...def log_
-000440c0: 636f 6d6d 656e 7428 4c4f 4746 494c 452c  comment(LOGFILE,
-000440d0: 2063 6f6d 6d65 6e74 2c20 7665 7262 6f73   comment, verbos
-000440e0: 653d 4661 6c73 652c 2073 686f 775f 6461  e=False, show_da
-000440f0: 7465 3d46 616c 7365 2c20 6d6f 6465 3d27  te=False, mode='
-00044100: 6127 293a 0a20 2020 2022 2222 0a20 2020  a'):.    """.   
-00044110: 204c 6f67 2061 206d 6573 7361 6765 2074   Log a message t
-00044120: 6f20 6120 6669 6c65 2c20 6f70 7469 6f6e  o a file, option
-00044130: 616c 6c79 2069 6e63 6c75 6469 6e67 2061  ally including a
-00044140: 2064 6174 6520 7461 670a 2020 2020 2222   date tag.    ""
-00044150: 220a 2020 2020 696d 706f 7274 2074 696d  ".    import tim
-00044160: 650a 0a20 2020 2069 6620 7368 6f77 5f64  e..    if show_d
-00044170: 6174 653a 0a20 2020 2020 2020 206d 7367  ate:.        msg
-00044180: 203d 2027 2320 287b 307d 295c 6e27 2e66   = '# ({0})\n'.f
-00044190: 6f72 6d61 7428 6e6f 7774 696d 6528 2929  ormat(nowtime())
-000441a0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-000441b0: 2020 206d 7367 203d 2027 270a 0a20 2020     msg = ''..   
-000441c0: 206d 7367 202b 3d20 277b 307d 5c6e 272e   msg += '{0}\n'.
-000441d0: 666f 726d 6174 2863 6f6d 6d65 6e74 290a  format(comment).
-000441e0: 0a20 2020 2069 6620 4c4f 4746 494c 4520  .    if LOGFILE 
-000441f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00044200: 2020 2020 2066 7020 3d20 6f70 656e 284c       fp = open(L
-00044210: 4f47 4649 4c45 2c20 6d6f 6465 290a 2020  OGFILE, mode).  
-00044220: 2020 2020 2020 6670 2e77 7269 7465 286d        fp.write(m
-00044230: 7367 290a 2020 2020 2020 2020 6670 2e63  sg).        fp.c
-00044240: 6c6f 7365 2829 0a0a 2020 2020 6966 2076  lose()..    if v
-00044250: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-00044260: 7072 696e 7428 6d73 675b 3a2d 315d 290a  print(msg[:-1]).
-00044270: 0a20 2020 2072 6574 7572 6e20 6d73 670a  .    return msg.
-00044280: 0a0a 6465 6620 6c6f 675f 6578 6365 7074  ..def log_except
-00044290: 696f 6e28 4c4f 4746 494c 452c 2074 7261  ion(LOGFILE, tra
-000442a0: 6365 6261 636b 2c20 7665 7262 6f73 653d  ceback, verbose=
-000442b0: 5472 7565 2c20 6d6f 6465 3d27 6127 293a  True, mode='a'):
-000442c0: 0a20 2020 2022 2222 0a20 2020 204c 6f67  .    """.    Log
-000442d0: 2065 7863 6570 7469 6f6e 2069 6e66 6f72   exception infor
-000442e0: 6d61 7469 6f6e 2074 6f20 6120 6669 6c65  mation to a file
-000442f0: 2c20 6f72 2070 7269 6e74 2074 6f20 7363  , or print to sc
-00044300: 7265 656e 0a0a 2020 2020 5061 7261 6d65  reen..    Parame
-00044310: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00044320: 2d2d 2d0a 2020 2020 4c4f 4746 494c 4520  ---.    LOGFILE 
-00044330: 3a20 7374 7220 6f72 204e 6f6e 650a 2020  : str or None.  
-00044340: 2020 2020 2020 4f75 7470 7574 2066 696c        Output fil
-00044350: 652e 2020 4966 2060 4e6f 6e65 602c 2074  e.  If `None`, t
-00044360: 6865 6e20 666f 7263 6520 6076 6572 626f  hen force `verbo
-00044370: 7365 3d54 7275 6560 2e0a 0a20 2020 2074  se=True`...    t
-00044380: 7261 6365 6261 636b 203a 2062 7569 6c74  raceback : built
-00044390: 696e 2074 7261 6365 6261 636b 206d 6f64  in traceback mod
-000443a0: 756c 650a 2020 2020 2020 2020 4578 6365  ule.        Exce
-000443b0: 7074 696f 6e20 7472 6163 6562 6163 6b2c  ption traceback,
-000443c0: 2066 726f 6d20 676c 6f62 616c 2060 696d   from global `im
-000443d0: 706f 7274 2074 7261 6365 6261 636b 602e  port traceback`.
-000443e0: 0a0a 2020 2020 7665 7262 6f73 6520 3a20  ..    verbose : 
-000443f0: 626f 6f6c 0a20 2020 2020 2020 2050 7269  bool.        Pri
-00044400: 6e74 2065 7863 6570 7469 6f6e 2074 6f20  nt exception to 
-00044410: 7374 646f 7574 2e0a 0a20 2020 206d 6f64  stdout...    mod
-00044420: 6520 3a20 2761 272c 2027 7727 0a20 2020  e : 'a', 'w'.   
-00044430: 2020 2020 2046 696c 6520 6d6f 6465 206f       File mode o
-00044440: 6e20 606f 7065 6e28 4c4f 4746 494c 452c  n `open(LOGFILE,
-00044450: 206d 6f64 6529 602c 2069 2e65 2e2c 2061   mode)`, i.e., a
-00044460: 7070 656e 6420 6f72 2077 7269 7465 2e0a  ppend or write..
-00044470: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-00044480: 6f72 7420 7469 6d65 0a0a 2020 2020 7472  ort time..    tr
-00044490: 6163 6520 3d20 7472 6163 6562 6163 6b2e  ace = traceback.
-000444a0: 666f 726d 6174 5f65 7863 286c 696d 6974  format_exc(limit
-000444b0: 3d32 290a 2020 2020 6c6f 6720 3d20 275c  =2).    log = '\
-000444c0: 6e23 2323 2323 2323 2323 2323 2323 2323  n###############
-000444d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000444e0: 2323 2323 2323 2323 2323 2320 5c6e 270a  ########### \n'.
-000444f0: 2020 2020 6c6f 6720 2b3d 2027 2320 2120      log += '# ! 
-00044500: 4578 6365 7074 696f 6e20 287b 307d 295c  Exception ({0})\
-00044510: 6e27 2e66 6f72 6d61 7428 6e6f 7774 696d  n'.format(nowtim
-00044520: 6528 2929 0a20 2020 206c 6f67 202b 3d20  e()).    log += 
-00044530: 2723 5c6e 2320 2127 2b27 5c6e 2320 2127  '#\n# !'+'\n# !'
-00044540: 2e6a 6f69 6e28 7472 6163 652e 7370 6c69  .join(trace.spli
-00044550: 7428 275c 6e27 2929 0a20 2020 206c 6f67  t('\n')).    log
-00044560: 202b 3d20 275c 6e23 2323 2323 2323 2323   += '\n#########
-00044570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00044580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00044590: 205c 6e5c 6e27 0a20 2020 2069 6620 7665   \n\n'.    if ve
-000445a0: 7262 6f73 6520 7c20 284c 4f47 4649 4c45  rbose | (LOGFILE
-000445b0: 2069 7320 4e6f 6e65 293a 0a20 2020 2020   is None):.     
-000445c0: 2020 2070 7269 6e74 286c 6f67 290a 0a20     print(log).. 
-000445d0: 2020 2069 6620 4c4f 4746 494c 4520 6973     if LOGFILE is
-000445e0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000445f0: 2020 2066 7020 3d20 6f70 656e 284c 4f47     fp = open(LOG
-00044600: 4649 4c45 2c20 6d6f 6465 290a 2020 2020  FILE, mode).    
-00044610: 2020 2020 6670 2e77 7269 7465 286c 6f67      fp.write(log
-00044620: 290a 2020 2020 2020 2020 6670 2e63 6c6f  ).        fp.clo
-00044630: 7365 2829 0a0a 6465 6620 7369 6d70 6c65  se()..def simple
-00044640: 5f4c 4344 4d28 4f6d 303d 302e 332c 204f  _LCDM(Om0=0.3, O
-00044650: 6465 303d 302e 372c 2048 303d 3730 2c20  de0=0.7, H0=70, 
-00044660: 4f62 303d 302e 3034 3633 2c20 5463 6d62  Ob0=0.0463, Tcmb
-00044670: 303d 322e 3732 352c 206e 616d 653d 4e6f  0=2.725, name=No
-00044680: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
-00044690: 2053 696d 706c 6520 4c61 6d62 6461 4344   Simple LambdaCD
-000446a0: 4d20 636f 736d 6f6c 6f67 790a 2020 2020  M cosmology.    
-000446b0: 0a20 2020 2050 6172 616d 6574 6572 7320  .    Parameters 
-000446c0: 6172 6520 6465 6669 6e65 6420 6173 2069  are defined as i
-000446d0: 6e20 607e 6173 7472 6f70 792e 636f 736d  n `~astropy.cosm
-000446e0: 6f6c 6f67 792e 4c61 6d62 6461 4344 4d60  ology.LambdaCDM`
-000446f0: 2e0a 2020 2020 0a20 2020 2022 2222 0a20  ..    .    """. 
-00044700: 2020 2066 726f 6d20 6173 7472 6f70 792e     from astropy.
-00044710: 636f 736d 6f6c 6f67 7920 696d 706f 7274  cosmology import
-00044720: 204c 616d 6264 6143 444d 0a20 2020 2063   LambdaCDM.    c
-00044730: 6f73 6d6f 6c6f 6779 203d 204c 616d 6264  osmology = Lambd
-00044740: 6143 444d 2848 302c 204f 6d30 2c20 4f64  aCDM(H0, Om0, Od
-00044750: 6530 2c20 5463 6d62 303d 5463 6d62 302c  e0, Tcmb0=Tcmb0,
-00044760: 206e 616d 653d 6e61 6d65 290a 2020 2020   name=name).    
-00044770: 7265 7475 726e 2063 6f73 6d6f 6c6f 6779  return cosmology
-00044780: 0a0a 0a64 6566 2070 6978 656c 5f70 6f6c  ...def pixel_pol
-00044790: 7967 6f6e 5f6d 6173 6b28 706f 6c79 676f  ygon_mask(polygo
-000447a0: 6e2c 2073 6861 7065 2c20 7763 733d 4e6f  n, shape, wcs=No
-000447b0: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
-000447c0: 204d 616b 6520 6120 6d61 736b 2070 6f69   Make a mask poi
-000447d0: 6e74 7320 696e 2061 2032 4420 6172 7261  nts in a 2D arra
-000447e0: 7920 696e 7369 6465 2061 2070 6f6c 7967  y inside a polyg
-000447f0: 6f6e 0a20 2020 200a 2020 2020 5061 7261  on.    .    Para
-00044800: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00044810: 2d2d 2d2d 2d0a 2020 2020 706f 6c79 676f  -----.    polygo
-00044820: 6e20 3a20 7374 722c 2028 322c 4d29 2061  n : str, (2,M) a
-00044830: 7272 6179 0a20 2020 2020 2020 2053 6f6d  rray.        Som
-00044840: 6574 6869 6e67 2074 6861 7420 6067 7269  ething that `gri
-00044850: 7a6c 692e 7574 696c 732e 5352 6567 696f  zli.utils.SRegio
-00044860: 6e60 2063 616e 2070 6172 7365 2061 7320  n` can parse as 
-00044870: 6120 706f 6c79 676f 6e0a 2020 2020 0a20  a polygon.    . 
-00044880: 2020 2073 6861 7065 203a 2074 7570 6c65     shape : tuple
-00044890: 0a20 2020 2020 2020 2032 2d74 7570 6c65  .        2-tuple
-000448a0: 206f 6620 696d 6167 6520 6469 6d65 6e73   of image dimens
-000448b0: 696f 6e73 0a20 2020 200a 2020 2020 7763  ions.    .    wc
-000448c0: 7320 3a20 6061 7374 726f 7079 2e77 6373  s : `astropy.wcs
-000448d0: 2e57 4353 600a 2020 2020 2020 2020 4966  .WCS`.        If
-000448e0: 2073 7065 6369 6669 6564 2c20 6173 7375   specified, assu
-000448f0: 6d65 2060 6070 6f6c 7967 6f6e 6060 2069  me ``polygon`` i
-00044900: 7320 736b 7920 636f 6f72 6469 6e61 7465  s sky coordinate
-00044910: 7320 616e 6420 7472 616e 7366 6f72 6d20  s and transform 
-00044920: 746f 0a20 2020 2020 2020 2069 6d61 6765  to.        image
-00044930: 2e0a 2020 2020 0a20 2020 2052 6574 7572  ..    .    Retur
-00044940: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00044950: 2020 206d 6173 6b20 3a20 6172 7261 790a     mask : array.
-00044960: 2020 2020 2020 2020 6060 626f 6f6c 6060          ``bool``
-00044970: 2061 7272 6179 2077 6974 6820 6060 7368   array with ``sh
-00044980: 6170 6560 6020 7468 6174 2069 7320 6054  ape`` that is `T
-00044990: 7275 6560 2069 6e73 6964 6520 6070 6f6c  rue` inside `pol
-000449a0: 7967 6f6e 600a 2020 2020 2222 220a 2020  ygon`.    """.  
-000449b0: 2020 7372 203d 2053 5265 6769 6f6e 2870    sr = SRegion(p
-000449c0: 6f6c 7967 6f6e 2c20 7772 6170 3d46 616c  olygon, wrap=Fal
-000449d0: 7365 290a 2020 2020 0a20 2020 2079 702c  se).    .    yp,
-000449e0: 2078 7020 3d20 6e70 2e69 6e64 6963 6573   xp = np.indices
-000449f0: 2873 6861 7065 290a 2020 2020 7074 7320  (shape).    pts 
-00044a00: 3d20 6e70 2e61 7272 6179 285b 7870 2e66  = np.array([xp.f
-00044a10: 6c61 7474 656e 2829 2c20 7970 2e66 6c61  latten(), yp.fla
-00044a20: 7474 656e 2829 5d29 2e54 0a20 2020 200a  tten()]).T.    .
-00044a30: 2020 2020 6966 2077 6373 2069 7320 6e6f      if wcs is no
-00044a40: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00044a50: 7074 7320 3d20 7763 732e 616c 6c5f 7069  pts = wcs.all_pi
-00044a60: 7832 776f 726c 6428 7074 732c 2030 290a  x2world(pts, 0).
-00044a70: 2020 2020 2020 2020 0a20 2020 206d 6173          .    mas
-00044a80: 6b20 3d20 6e70 2e7a 6572 6f73 2873 6861  k = np.zeros(sha
-00044a90: 7065 2c20 6474 7970 653d 626f 6f6c 292e  pe, dtype=bool).
-00044aa0: 666c 6174 7465 6e28 290a 2020 2020 666f  flatten().    fo
-00044ab0: 7220 7020 696e 2073 722e 7061 7468 3a0a  r p in sr.path:.
-00044ac0: 2020 2020 2020 2020 6d61 736b 207c 3d20          mask |= 
-00044ad0: 702e 636f 6e74 6169 6e73 5f70 6f69 6e74  p.contains_point
-00044ae0: 7328 7074 7329 0a20 2020 200a 2020 2020  s(pts).    .    
-00044af0: 7265 7475 726e 206d 6173 6b2e 7265 7368  return mask.resh
-00044b00: 6170 6528 7368 6170 6529 0a0a 0a64 6566  ape(shape)...def
-00044b10: 206d 616b 655f 6669 6c74 6572 5f66 6f6f   make_filter_foo
-00044b20: 7470 7269 6e74 2866 696c 7465 725f 7369  tprint(filter_si
-00044b30: 7a65 3d37 312c 2066 696c 7465 725f 6365  ze=71, filter_ce
-00044b40: 6e74 7261 6c3d 302c 202a 2a6b 7761 7267  ntral=0, **kwarg
-00044b50: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
-00044b60: 4d61 6b65 2061 2066 6f6f 7470 7269 6e74  Make a footprint
-00044b70: 2066 6f72 2069 6d61 6765 2066 696c 7465   for image filte
-00044b80: 7269 6e67 0a20 2020 2022 2222 0a20 2020  ring.    """.   
-00044b90: 2066 696c 7465 725f 666f 6f74 7072 696e   filter_footprin
-00044ba0: 7420 3d20 6e70 2e6f 6e65 7328 6669 6c74  t = np.ones(filt
-00044bb0: 6572 5f73 697a 652c 2064 7479 7065 3d69  er_size, dtype=i
-00044bc0: 6e74 290a 2020 2020 0a20 2020 2069 6620  nt).    .    if 
-00044bd0: 6669 6c74 6572 5f63 656e 7472 616c 203e  filter_central >
-00044be0: 2030 3a0a 2020 2020 2020 2020 6630 203d   0:.        f0 =
-00044bf0: 2028 6669 6c74 6572 5f73 697a 652d 3129   (filter_size-1)
-00044c00: 2f2f 320a 2020 2020 2020 2020 6669 6c74  //2.        filt
-00044c10: 6572 5f66 6f6f 7470 7269 6e74 5b66 302d  er_footprint[f0-
-00044c20: 6669 6c74 6572 5f63 656e 7472 616c 3a66  filter_central:f
-00044c30: 302b 6669 6c74 6572 5f63 656e 7472 616c  0+filter_central
-00044c40: 5d20 3d20 300a 2020 2020 0a20 2020 2072  ] = 0.    .    r
-00044c50: 6574 7572 6e20 6669 6c74 6572 5f66 6f6f  eturn filter_foo
-00044c60: 7470 7269 6e74 0a0a 0a64 6566 2073 6166  tprint...def saf
-00044c70: 655f 6e61 6e6d 6564 6961 6e5f 6669 6c74  e_nanmedian_filt
-00044c80: 6572 2864 6174 612c 2066 696c 7465 725f  er(data, filter_
-00044c90: 6b77 6172 6773 3d7b 7d2c 2066 696c 7465  kwargs={}, filte
-00044ca0: 725f 666f 6f74 7072 696e 743d 4e6f 6e65  r_footprint=None
-00044cb0: 2c20 6178 6973 3d31 2c20 636c 6561 6e3d  , axis=1, clean=
-00044cc0: 5472 7565 2c20 6376 616c 3d30 2e30 293a  True, cval=0.0):
-00044cd0: 0a20 2020 2022 2222 0a20 2020 2052 756e  .    """.    Run
-00044ce0: 206e 616e 6d65 6469 616e 2066 696c 7465   nanmedian filte
-00044cf0: 7220 6f6e 2060 6461 7461 600a 2020 2020  r on `data`.    
-00044d00: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-00044d10: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00044d20: 2020 2064 6174 6120 3a20 6172 7261 792d     data : array-
-00044d30: 6c69 6b65 0a20 2020 2020 2020 2054 6865  like.        The
-00044d40: 2032 4420 6461 7461 2074 6f20 6669 6c74   2D data to filt
-00044d50: 6572 0a20 2020 200a 2020 2020 6669 6c74  er.    .    filt
-00044d60: 6572 5f6b 7761 7267 7320 3a20 6469 6374  er_kwargs : dict
-00044d70: 0a20 2020 2020 2020 2041 7267 756d 656e  .        Argumen
-00044d80: 7473 2074 6f20 607e 6772 697a 6c69 2e75  ts to `~grizli.u
-00044d90: 7469 6c73 2e6d 616b 655f 6669 6c74 6572  tils.make_filter
-00044da0: 5f66 6f6f 7470 7269 6e74 6020 746f 206d  _footprint` to m
-00044db0: 616b 6520 6120 3144 2066 696c 7465 720a  ake a 1D filter.
-00044dc0: 2020 2020 0a20 2020 2066 696c 7465 725f      .    filter_
-00044dd0: 666f 6f74 7072 696e 7420 3a20 6172 7261  footprint : arra
-00044de0: 792d 6c69 6b65 0a20 2020 2020 2020 2053  y-like.        S
-00044df0: 7065 6369 6679 2074 6865 2066 696c 7465  pecify the filte
-00044e00: 7220 6578 706c 6963 6974 6c79 2e20 2049  r explicitly.  I
-00044e10: 6620 3144 2c20 7468 656e 2077 696c 6c20  f 1D, then will 
-00044e20: 6170 706c 7920 7468 6520 6669 6c74 6572  apply the filter
-00044e30: 206f 7665 720a 2020 2020 2020 2020 6061   over.        `a
-00044e40: 7869 733d 3160 2028 692e 652e 2c20 6078  xis=1` (i.e., `x
-00044e50: 6029 206f 6620 6060 6461 7461 6060 0a20  `) of ``data``. 
-00044e60: 2020 200a 2020 2020 6178 6973 203a 2030     .    axis : 0
-00044e70: 206f 7220 310a 2020 2020 2020 2020 2041   or 1.         A
-00044e80: 7869 7320 6f76 6572 2077 6869 6368 2074  xis over which t
-00044e90: 6f20 6170 706c 7920 7468 6520 6669 6c74  o apply the filt
-00044ea0: 6572 2028 6060 6178 6973 3d31 6060 2066  er (``axis=1`` f
-00044eb0: 696c 7465 7273 206f 6e20 726f 7773 290a  ilters on rows).
-00044ec0: 2020 2020 0a20 2020 2063 6c65 616e 2c20      .    clean, 
-00044ed0: 6376 616c 203a 2062 6f6f 6c2c 2073 6361  cval : bool, sca
-00044ee0: 6c61 720a 2020 2020 2020 2020 5265 706c  lar.        Repl
-00044ef0: 6163 6520 607e 6e75 6d70 792e 6e61 6e60  ace `~numpy.nan`
-00044f00: 2069 6e20 7468 6520 6f75 7470 7574 2077   in the output w
-00044f10: 6974 6820 6060 6376 616c 6060 0a20 2020  ith ``cval``.   
-00044f20: 200a 2020 2020 5265 7475 726e 730a 2020   .    Returns.  
-00044f30: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 6669    -------.    fi
-00044f40: 6c74 6572 5f64 6174 6120 3a20 6172 7261  lter_data : arra
-00044f50: 792d 6c69 6b65 0a20 2020 2020 2020 2046  y-like.        F
-00044f60: 696c 7465 7265 6420 6461 7461 0a20 2020  iltered data.   
-00044f70: 200a 2020 2020 6669 6c74 6572 5f6e 616d   .    filter_nam
-00044f80: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
-00044f90: 5468 6520 7479 7065 206f 6620 6669 6c74  The type of filt
-00044fa0: 6572 2074 6861 7420 7761 7320 6170 706c  er that was appl
-00044fb0: 6965 643a 2060 6e62 7574 696c 732e 6e61  ied: `nbutils.na
-00044fc0: 6e6d 6564 6961 6e60 2069 6620 0a20 2020  nmedian` if .   
-00044fd0: 2020 2020 2060 7e67 7269 7a6c 692e 6e62       `~grizli.nb
-00044fe0: 7574 696c 732e 6e61 6e6d 6564 6961 6e60  utils.nanmedian`
-00044ff0: 2077 6173 2069 6d70 6f72 7465 6420 7375   was imported su
-00045000: 6363 6573 7366 756c 6c79 2061 6e64 200a  ccessfully and .
-00045010: 2020 2020 2020 2020 606d 6564 6961 6e5f          `median_
-00045020: 6669 6c74 6572 6020 666f 7220 7468 6520  filter` for the 
-00045030: 6661 6c6c 6261 636b 2074 6f20 6073 6369  fallback to `sci
-00045040: 702e 6e64 696d 6167 652e 6d65 6469 616e  p.ndimage.median
-00045050: 5f66 696c 7465 7260 200a 2020 2020 2020  _filter` .      
-00045060: 2020 6f74 6865 7277 6973 652e 0a20 2020    otherwise..   
-00045070: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
-00045080: 7363 6970 792e 6e64 696d 6167 6520 6173  scipy.ndimage as
-00045090: 206e 640a 2020 2020 0a20 2020 2074 7279   nd.    .    try
-000450a0: 3a0a 2020 2020 2020 2020 6672 6f6d 202e  :.        from .
-000450b0: 2069 6d70 6f72 7420 6e62 7574 696c 730a   import nbutils.
-000450c0: 2020 2020 2020 2020 5f66 696c 7465 725f          _filter_
-000450d0: 6e61 6d65 203d 2027 6e62 7574 696c 732e  name = 'nbutils.
-000450e0: 6e61 6e6d 6564 6961 6e27 0a20 2020 2065  nanmedian'.    e
-000450f0: 7863 6570 743a 0a20 2020 2020 2020 206e  xcept:.        n
-00045100: 6275 7469 6c73 203d 204e 6f6e 650a 2020  butils = None.  
-00045110: 2020 2020 2020 5f66 696c 7465 725f 6e61        _filter_na
-00045120: 6d65 203d 2027 6d65 6469 616e 5f66 696c  me = 'median_fil
-00045130: 7465 7227 0a20 2020 200a 2020 2020 6966  ter'.    .    if
-00045140: 2066 696c 7465 725f 666f 6f74 7072 696e   filter_footprin
-00045150: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
-00045160: 2020 205f 6669 6c74 6572 5f66 6f6f 7470     _filter_footp
-00045170: 7269 6e74 203d 206d 616b 655f 6669 6c74  rint = make_filt
-00045180: 6572 5f66 6f6f 7470 7269 6e74 282a 2a66  er_footprint(**f
-00045190: 696c 7465 725f 6b77 6172 6773 290a 2020  ilter_kwargs).  
-000451a0: 2020 2020 2020 6966 2061 7869 7320 3d3d        if axis ==
-000451b0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-000451c0: 5f66 696c 7465 725f 666f 6f74 7072 696e  _filter_footprin
-000451d0: 7420 3d20 5f66 696c 7465 725f 666f 6f74  t = _filter_foot
-000451e0: 7072 696e 745b 4e6f 6e65 2c3a 5d0a 2020  print[None,:].  
-000451f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00045200: 2020 2020 2020 2020 5f66 696c 7465 725f          _filter_
-00045210: 666f 6f74 7072 696e 7420 3d20 5f66 696c  footprint = _fil
-00045220: 7465 725f 666f 6f74 7072 696e 745b 3a2c  ter_footprint[:,
-00045230: 4e6f 6e65 5d0a 2020 2020 656c 7365 3a0a  None].    else:.
-00045240: 2020 2020 2020 2020 6966 2066 696c 7465          if filte
-00045250: 725f 666f 6f74 7072 696e 742e 6e64 696d  r_footprint.ndim
-00045260: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-00045270: 2020 2069 6620 6178 6973 203d 3d20 313a     if axis == 1:
-00045280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045290: 205f 6669 6c74 6572 5f66 6f6f 7470 7269   _filter_footpri
-000452a0: 6e74 203d 2066 696c 7465 725f 666f 6f74  nt = filter_foot
-000452b0: 7072 696e 745b 4e6f 6e65 2c3a 5d0a 2020  print[None,:].  
-000452c0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000452d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000452e0: 5f66 696c 7465 725f 666f 6f74 7072 696e  _filter_footprin
-000452f0: 7420 3d20 6669 6c74 6572 5f66 6f6f 7470  t = filter_footp
-00045300: 7269 6e74 5b3a 2c4e 6f6e 655d 0a20 2020  rint[:,None].   
-00045310: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00045320: 2020 2020 2020 205f 6669 6c74 6572 5f66         _filter_f
-00045330: 6f6f 7470 7269 6e74 203d 2066 696c 7465  ootprint = filte
-00045340: 725f 666f 6f74 7072 696e 740a 2020 2020  r_footprint.    
-00045350: 0a20 2020 2069 6620 6e62 7574 696c 7320  .    if nbutils 
-00045360: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00045370: 2066 696c 7465 725f 6461 7461 203d 206e   filter_data = n
-00045380: 642e 6d65 6469 616e 5f66 696c 7465 7228  d.median_filter(
-00045390: 6461 7461 2c20 666f 6f74 7072 696e 743d  data, footprint=
-000453a0: 5f66 696c 7465 725f 666f 6f74 7072 696e  _filter_footprin
-000453b0: 7429 0a20 2020 2065 6c73 653a 0a20 2020  t).    else:.   
-000453c0: 2020 2020 2066 696c 7465 725f 6461 7461       filter_data
-000453d0: 203d 206e 642e 6765 6e65 7269 635f 6669   = nd.generic_fi
-000453e0: 6c74 6572 2864 6174 612c 206e 6275 7469  lter(data, nbuti
-000453f0: 6c73 2e6e 616e 6d65 6469 616e 2c0a 2020  ls.nanmedian,.  
-00045400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045420: 2020 2020 2020 666f 6f74 7072 696e 743d        footprint=
-00045430: 5f66 696c 7465 725f 666f 6f74 7072 696e  _filter_footprin
-00045440: 7429 0a20 2020 2020 2020 2069 6620 636c  t).        if cl
-00045450: 6561 6e3a 0a20 2020 2020 2020 2020 2020  ean:.           
-00045460: 2066 696c 7465 725f 6461 7461 5b7e 6e70   filter_data[~np
-00045470: 2e69 7366 696e 6974 6528 6669 6c74 6572  .isfinite(filter
-00045480: 5f64 6174 6129 5d20 3d20 6376 616c 0a20  _data)] = cval. 
-00045490: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-000454a0: 7265 7475 726e 2066 696c 7465 725f 6461  return filter_da
-000454b0: 7461 2c20 5f66 696c 7465 725f 6e61 6d65  ta, _filter_name
-000454c0: 0a0a 0a64 6566 2061 7267 765f 746f 5f64  ...def argv_to_d
-000454d0: 6963 7428 6172 6776 2c20 6465 6661 756c  ict(argv, defaul
-000454e0: 7473 3d7b 7d2c 2064 6f74 5f64 6963 743d  ts={}, dot_dict=
-000454f0: 5472 7565 293a 0a20 2020 2022 2222 0a20  True):.    """. 
-00045500: 2020 2043 6f6e 7665 7274 2061 206c 6973     Convert a lis
-00045510: 7420 6f66 2028 7369 6d70 6c65 2920 636f  t of (simple) co
-00045520: 6d6d 616e 642d 6c69 6e65 2061 7267 756d  mmand-line argum
-00045530: 656e 7473 2074 6f20 6120 6469 6374 696f  ents to a dictio
-00045540: 6e61 7279 2e0a 2020 2020 0a20 2020 2050  nary..    .    P
-00045550: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00045560: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2061 7267  --------.    arg
-00045570: 7620 3a20 6c69 7374 206f 6620 7374 7269  v : list of stri
-00045580: 6e67 730a 2020 2020 2020 2020 452e 672e  ngs.        E.g.
-00045590: 2c20 6060 7379 732e 6172 6776 5b31 3a5d  , ``sys.argv[1:]
-000455a0: 6060 2e0a 2020 2020 0a20 2020 2064 6566  ``..    .    def
-000455b0: 6175 6c74 7320 3a20 6469 6374 0a20 2020  aults : dict.   
-000455c0: 2020 2020 2044 6566 6175 6c74 2064 6963       Default dic
-000455d0: 7469 6f6e 6172 790a 2020 2020 0a20 2020  tionary.    .   
-000455e0: 2064 6f74 5f64 6963 7420 3a20 626f 6f6c   dot_dict : bool
-000455f0: 0a20 2020 2020 2020 2049 6620 7472 7565  .        If true
-00045600: 2c20 7468 656e 2069 6e74 6570 7265 7420  , then intepret 
-00045610: 6b65 7977 6f72 6473 2077 6974 6820 272e  keywords with '.
-00045620: 2720 6173 206e 6573 7465 6420 6469 6374  ' as nested dict
-00045630: 696f 6e61 7279 206b 6579 732c 200a 2020  ionary keys, .  
-00045640: 2020 2020 2020 652e 672e 2c20 6060 2d2d        e.g., ``--
-00045650: 642e 6b65 793d 7661 6c60 6020 3e3e 207b  d.key=val`` >> {
-00045660: 2764 273a 207b 276b 6579 273a 2027 7661  'd': {'key': 'va
-00045670: 6c27 7d7d 0a20 2020 2020 2020 200a 2020  l'}}.        .  
-00045680: 2020 4578 616d 706c 6573 0a20 2020 202d    Examples.    -
-00045690: 2d2d 2d2d 2d2d 2d0a 2020 2020 0a20 2020  -------.    .   
-000456a0: 2020 2020 2023 2024 206d 7966 756e 6320       # $ myfunc 
-000456b0: 6172 6731 202d 2d70 313d 3120 2d2d 6c31  arg1 --p1=1 --l1
-000456c0: 3d31 2c32 2c33 202d 2d70 6469 6374 2e6b  =1,2,3 --pdict.k
-000456d0: 313d 3120 2d66 6c61 670a 2020 2020 2020  1=1 -flag.      
-000456e0: 2020 3e3e 3e20 6172 6776 203d 2027 6172    >>> argv = 'ar
-000456f0: 6731 202d 2d70 313d 3120 2d2d 6c31 3d31  g1 --p1=1 --l1=1
-00045700: 2c32 2c33 202d 2d70 6469 6374 2e6b 313d  ,2,3 --pdict.k1=
-00045710: 3120 2d66 6c61 6727 2e73 706c 6974 2829  1 -flag'.split()
-00045720: 0a20 2020 2020 2020 203e 3e3e 2061 7267  .        >>> arg
-00045730: 732c 206b 7761 7267 7320 3d20 6172 6776  s, kwargs = argv
-00045740: 5f74 6f5f 6469 6374 2861 7267 7629 0a20  _to_dict(argv). 
-00045750: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
-00045760: 2861 7267 7329 0a20 2020 2020 2020 205b  (args).        [
-00045770: 2761 7267 3127 5d0a 2020 2020 2020 2020  'arg1'].        
-00045780: 3e3e 3e20 7072 696e 7428 6b77 6172 6773  >>> print(kwargs
-00045790: 290a 2020 2020 2020 2020 7b27 7031 273a  ).        {'p1':
-000457a0: 2031 2c20 276c 3127 3a20 5b31 2c20 322c   1, 'l1': [1, 2,
-000457b0: 2033 5d2c 2027 7064 6963 7427 3a20 7b27   3], 'pdict': {'
-000457c0: 6b31 273a 2031 7d2c 2027 666c 6167 273a  k1': 1}, 'flag':
-000457d0: 2054 7275 657d 0a20 2020 2020 2020 200a   True}.        .
-000457e0: 2020 2020 2020 2020 2320 5769 7468 2064          # With d
-000457f0: 6566 6175 6c74 730a 2020 2020 2020 2020  efaults.        
-00045800: 6465 6661 756c 7473 203d 207b 2770 6469  defaults = {'pdi
-00045810: 6374 273a 7b27 6b32 273a 322e 307d 2c20  ct':{'k2':2.0}, 
-00045820: 2770 3227 3a32 2e30 7d0a 2020 2020 2020  'p2':2.0}.      
-00045830: 2020 3e3e 3e20 6172 6773 2c20 6b77 6172    >>> args, kwar
-00045840: 6773 203d 2061 7267 765f 746f 5f64 6963  gs = argv_to_dic
-00045850: 7428 6172 6776 2c20 6465 6661 756c 7473  t(argv, defaults
-00045860: 3d64 6566 6175 6c74 7329 0a20 2020 2020  =defaults).     
-00045870: 2020 203e 3e3e 2070 7269 6e74 286b 7761     >>> print(kwa
-00045880: 7267 7329 0a20 2020 2020 2020 207b 2770  rgs).        {'p
-00045890: 6469 6374 273a 207b 276b 3227 3a20 322e  dict': {'k2': 2.
-000458a0: 302c 2027 6b31 273a 2031 7d2c 2027 7032  0, 'k1': 1}, 'p2
-000458b0: 273a 2032 2e30 2c20 2770 3127 3a20 312c  ': 2.0, 'p1': 1,
-000458c0: 2027 6c31 273a 205b 312c 2032 2c20 335d   'l1': [1, 2, 3]
-000458d0: 2c20 2766 6c61 6727 3a20 5472 7565 7d0a  , 'flag': True}.
-000458e0: 2020 2020 2020 2020 0a20 2020 2022 2222          .    """
-000458f0: 0a20 2020 2069 6d70 6f72 7420 636f 7079  .    import copy
-00045900: 0a20 2020 2069 6d70 6f72 7420 6a73 6f6e  .    import json
-00045910: 0a20 2020 200a 2020 2020 6b77 6172 6773  .    .    kwargs
-00045920: 203d 2063 6f70 792e 6465 6570 636f 7079   = copy.deepcopy
-00045930: 2864 6566 6175 6c74 7329 0a20 2020 2061  (defaults).    a
-00045940: 7267 7320 3d20 5b5d 0a20 2020 200a 2020  rgs = [].    .  
-00045950: 2020 666f 7220 692c 2061 7267 2069 6e20    for i, arg in 
-00045960: 656e 756d 6572 6174 6528 6172 6776 293a  enumerate(argv):
-00045970: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00045980: 2069 6620 6e6f 7420 6172 672e 7374 6172   if not arg.star
-00045990: 7473 7769 7468 2827 2d27 293a 0a20 2020  tswith('-'):.   
-000459a0: 2020 2020 2020 2020 2023 2041 7267 756d           # Argum
-000459b0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
-000459c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000459d0: 2020 2020 2020 6172 6773 2e61 7070 656e        args.appen
-000459e0: 6428 6a73 6f6e 2e6c 6f61 6473 2861 7267  d(json.loads(arg
-000459f0: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-00045a00: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-00045a10: 2020 2020 2020 2061 7267 732e 6170 7065         args.appe
-00045a20: 6e64 286a 736f 6e2e 6c6f 6164 7328 6627  nd(json.loads(f'
-00045a30: 227b 6172 677d 2227 2929 0a20 2020 2020  "{arg}"')).     
-00045a40: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00045a50: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00045a60: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-00045a70: 2020 2020 2020 7370 6c20 3d20 6172 672e        spl = arg.
-00045a80: 7374 7269 7028 272d 2d27 292e 7370 6c69  strip('--').spli
-00045a90: 7428 273d 2729 0a20 2020 2020 2020 2069  t('=').        i
-00045aa0: 6620 6c65 6e28 7370 6c29 203e 2031 3a0a  f len(spl) > 1:.
-00045ab0: 2020 2020 2020 2020 2020 2020 2320 5061              # Pa
-00045ac0: 7261 6d65 7465 7220 7661 6c75 6573 0a20  rameter values. 
-00045ad0: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
-00045ae0: 7661 6c20 3d20 7370 6c0a 2020 2020 2020  val = spl.      
-00045af0: 2020 2020 2020 7661 6c20 3d20 7661 6c2e        val = val.
-00045b00: 7265 706c 6163 6528 2754 7275 6527 2c27  replace('True','
-00045b10: 7472 7565 2729 2e72 6570 6c61 6365 2827  true').replace('
-00045b20: 4661 6c73 6527 2c27 6661 6c73 6527 290a  False','false').
-00045b30: 2020 2020 2020 2020 2020 2020 7661 6c20              val 
-00045b40: 3d20 7661 6c2e 7265 706c 6163 6528 274e  = val.replace('N
-00045b50: 6f6e 6527 2c27 6e75 6c6c 2729 0a20 2020  one','null').   
-00045b60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00045b70: 2020 2020 2020 2023 2050 6172 616d 6574         # Paramet
-00045b80: 6572 732c 2073 6574 2074 6f20 7472 7565  ers, set to true
-00045b90: 2c20 652e 672e 2c20 2d73 6574 5f66 6c61  , e.g., -set_fla
-00045ba0: 670a 2020 2020 2020 2020 2020 2020 6b65  g.            ke
-00045bb0: 792c 2076 616c 203d 2073 706c 5b30 5d2c  y, val = spl[0],
-00045bc0: 2027 7472 7565 270a 2020 2020 2020 2020   'true'.        
-00045bd0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-00045be0: 2023 2073 696e 676c 6520 2d0a 2020 2020   # single -.    
-00045bf0: 2020 2020 2020 2020 6966 206b 6579 2e73          if key.s
-00045c00: 7461 7274 7377 6974 6828 272d 2729 3a0a  tartswith('-'):.
-00045c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045c20: 6b65 7920 3d20 6b65 795b 313a 5d0a 2020  key = key[1:].  
-00045c30: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
-00045c40: 204c 6973 7420 7661 6c75 6573 2020 2020   List values    
-00045c50: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-00045c60: 272c 2720 696e 2076 616c 3a0a 2020 2020  ',' in val:.    
-00045c70: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00045c80: 2020 2020 2020 2020 2020 2020 2023 2054               # T
-00045c90: 7279 2070 6172 7369 6e67 2077 6974 6820  ry parsing with 
-00045ca0: 4a53 4f4e 0a20 2020 2020 2020 2020 2020  JSON.           
-00045cb0: 2020 2020 206a 7661 6c20 3d20 6a73 6f6e       jval = json
-00045cc0: 2e6c 6f61 6473 2866 275b 7b76 616c 7d5d  .loads(f'[{val}]
-00045cd0: 2729 0a20 2020 2020 2020 2020 2020 2065  ').            e
-00045ce0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-00045cf0: 2020 2020 2020 2023 2041 7373 756d 6520         # Assume 
-00045d00: 7374 7269 6e67 730a 2020 2020 2020 2020  strings.        
-00045d10: 2020 2020 2020 2020 7374 725f 7661 6c20          str_val 
-00045d20: 3d20 272c 272e 6a6f 696e 285b 6627 227b  = ','.join([f'"{
-00045d30: 767d 2227 2066 6f72 2076 2069 6e20 7661  v}"' for v in va
-00045d40: 6c2e 7370 6c69 7428 272c 2729 5d29 0a20  l.split(',')]). 
-00045d50: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00045d60: 7661 6c20 3d20 6a73 6f6e 2e6c 6f61 6473  val = json.loads
-00045d70: 2866 275b 7b73 7472 5f76 616c 7d5d 2729  (f'[{str_val}]')
-00045d80: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00045d90: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00045da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045db0: 6a76 616c 203d 206a 736f 6e2e 6c6f 6164  jval = json.load
-00045dc0: 7328 7661 6c29 0a20 2020 2020 2020 2020  s(val).         
-00045dd0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00045de0: 2020 2020 2020 2020 2020 2023 2053 7472             # Str
-00045df0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-00045e00: 2020 2020 6a76 616c 203d 2076 616c 0a20      jval = val. 
-00045e10: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00045e20: 2320 4469 6374 206b 6579 732c 2070 6f74  # Dict keys, pot
-00045e30: 656e 7469 616c 6c79 206e 6573 7465 6420  entially nested 
-00045e40: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00045e50: 6966 2064 6f74 5f64 6963 7420 2620 2827  if dot_dict & ('
-00045e60: 2e27 2069 6e20 6b65 7929 3a0a 2020 2020  .' in key):.    
-00045e70: 2020 2020 2020 2020 6b65 7973 203d 206b          keys = k
-00045e80: 6579 2e73 706c 6974 2827 2e27 290a 2020  ey.split('.').  
-00045e90: 2020 2020 2020 2020 2020 6420 3d20 6b77            d = kw
-00045ea0: 6172 6773 0a20 2020 2020 2020 2020 2020  args.           
-00045eb0: 2066 6f72 206b 2069 6e20 6b65 7973 5b3a   for k in keys[:
-00045ec0: 2d31 5d3a 0a20 2020 2020 2020 2020 2020  -1]:.           
-00045ed0: 2020 2020 2069 6620 6b20 6e6f 7420 696e       if k not in
-00045ee0: 2064 3a0a 2020 2020 2020 2020 2020 2020   d:.            
-00045ef0: 2020 2020 2020 2020 645b 6b5d 203d 207b          d[k] = {
-00045f00: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00045f10: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-00045f20: 2020 2064 203d 2064 5b6b 5d0a 2020 2020     d = d[k].    
-00045f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045f40: 0a20 2020 2020 2020 2020 2020 2064 5b6b  .            d[k
-00045f50: 6579 735b 2d31 5d5d 203d 206a 7661 6c0a  eys[-1]] = jval.
-00045f60: 2020 2020 2020 2020 656c 7365 3a20 2020          else:   
-00045f70: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00045f80: 2020 2020 2020 6b77 6172 6773 5b6b 6579        kwargs[key
-00045f90: 5d20 3d20 6a76 616c 0a20 2020 2020 2020  ] = jval.       
-00045fa0: 2020 2020 200a 2020 2020 0a20 2020 2072       .    .    r
-00045fb0: 6574 7572 6e20 6172 6773 2c20 6b77 6172  eturn args, kwar
-00045fc0: 6773 0a0a 0a63 6c61 7373 2055 6e69 7175  gs...class Uniqu
-00045fd0: 6528 6f62 6a65 6374 293a 0a20 2020 2064  e(object):.    d
-00045fe0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00045ff0: 2c20 6172 7261 792c 2076 6572 626f 7365  , array, verbose
-00046000: 3d54 7275 6529 3a0a 2020 2020 2020 2020  =True):.        
-00046010: 2222 220a 2020 2020 2020 2020 4865 6c70  """.        Help
-00046020: 6572 2066 6f72 2075 6e69 7175 6520 6974  er for unique it
-00046030: 656d 7320 696e 2061 6e20 6172 7261 790a  ems in an array.
-00046040: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00046050: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00046060: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00046070: 2020 2020 2020 2061 7272 6179 203a 2061         array : a
-00046080: 7272 6179 2d6c 696b 650a 2020 2020 2020  rray-like.      
-00046090: 2020 2020 2020 4461 7461 2074 6f20 7061        Data to pa
-000460a0: 7273 652c 2067 656e 6572 616c 6c79 2073  rse, generally s
-000460b0: 7472 696e 6773 2062 7574 2063 616e 2062  trings but can b
-000460c0: 6520 616e 7974 6869 6e67 2074 6861 7420  e anything that 
-000460d0: 6361 6e20 0a20 2020 2020 2020 2020 2020  can .           
-000460e0: 2062 6520 7061 7273 6564 2062 7920 606e   be parsed by `n
-000460f0: 756d 7079 2e75 6e69 7175 6560 0a0a 0a20  umpy.unique`... 
-00046100: 2020 2020 2020 2041 7474 7269 6275 7465         Attribute
-00046110: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00046120: 2d2d 2d2d 0a20 2020 2020 2020 2064 696d  ----.        dim
-00046130: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
-00046140: 2020 2060 6073 697a 6560 6020 6f66 2069     ``size`` of i
-00046150: 6e70 7574 2060 6061 7272 6179 6060 0a20  nput ``array``. 
-00046160: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00046170: 7661 6c75 6573 203a 206c 6973 740a 2020  values : list.  
-00046180: 2020 2020 2020 2020 2020 556e 6971 7565            Unique
-00046190: 2065 6c65 6d65 6e74 7320 6f66 2060 6061   elements of ``a
-000461a0: 7272 6179 6060 0a20 2020 2020 2020 200a  rray``.        .
-000461b0: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
-000461c0: 3a20 6c69 7374 0a20 2020 2020 2020 2020  : list.         
-000461d0: 2020 2049 6e74 6567 6572 206c 6973 7420     Integer list 
-000461e0: 6c65 6e67 7468 206f 6620 6060 6172 7261  length of ``arra
-000461f0: 7960 6020 7769 7468 2074 6865 2069 6e64  y`` with the ind
-00046200: 6963 6573 206f 6620 6060 7661 6c75 6573  ices of ``values
-00046210: 6060 0a20 2020 2020 2020 2020 2020 2066  ``.            f
-00046220: 6f72 2065 6163 6820 656c 656d 656e 740a  or each element.
-00046230: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00046240: 2063 6f75 6e74 7320 3a20 6c69 7374 0a20   counts : list. 
-00046250: 2020 2020 2020 2020 2020 2043 6f75 6e74             Count
-00046260: 7320 6f66 2065 6163 6820 656c 656d 656e  s of each elemen
-00046270: 7420 6f66 2060 6076 616c 7565 7360 600a  t of ``values``.
-00046280: 2020 2020 2020 2020 0a0a 2020 2020 2020          ..      
-00046290: 2020 4d65 7468 6f64 730a 2020 2020 2020    Methods.      
-000462a0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 2020    -------.      
-000462b0: 2020 5f5f 6765 745f 5f28 6b65 7929 0a20    __get__(key). 
-000462c0: 2020 2020 2020 2020 2020 2052 6574 7572             Retur
-000462d0: 6e20 6120 6062 6f6f 6c60 2061 7272 6179  n a `bool` array
-000462e0: 2077 6865 7265 2065 6e74 7269 6573 206f   where entries o
-000462f0: 6620 6060 6172 7261 7960 6020 6d61 7463  f ``array`` matc
-00046300: 6820 7468 6520 0a20 2020 2020 2020 2020  h the .         
-00046310: 2020 2073 7065 6369 6669 6564 2060 606b     specified ``k
-00046320: 6579 6060 0a20 2020 2020 2020 200a 2020  ey``.        .  
-00046330: 2020 2020 2020 5f5f 6974 6572 5f5f 0a20        __iter__. 
-00046340: 2020 2020 2020 2020 2020 2049 7465 7261             Itera
-00046350: 746f 7220 6f76 6572 2060 6076 616c 7565  tor over ``value
-00046360: 7360 600a 2020 2020 2020 2020 0a20 2020  s``.        .   
-00046370: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00046380: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
-00046390: 7272 6179 2c20 6c69 7374 293a 0a20 2020  rray, list):.   
-000463a0: 2020 2020 2020 2020 2073 656c 662e 6172           self.ar
-000463b0: 7261 7920 3d20 6e70 2e61 7272 6179 2861  ray = np.array(a
-000463c0: 7272 6179 290a 2020 2020 2020 2020 656c  rray).        el
-000463d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000463e0: 7365 6c66 2e61 7272 6179 203d 2061 7272  self.array = arr
-000463f0: 6179 0a20 2020 2020 2020 200a 2020 2020  ay.        .    
-00046400: 2020 2020 5f20 3d20 6e70 2e75 6e69 7175      _ = np.uniqu
-00046410: 6528 7365 6c66 2e61 7272 6179 2c20 7265  e(self.array, re
-00046420: 7475 726e 5f63 6f75 6e74 733d 5472 7565  turn_counts=True
-00046430: 2c20 7265 7475 726e 5f69 6e76 6572 7365  , return_inverse
-00046440: 3d54 7275 6529 0a20 2020 2020 2020 2073  =True).        s
-00046450: 656c 662e 6469 6d20 3d20 7365 6c66 2e61  elf.dim = self.a
-00046460: 7272 6179 2e73 697a 650a 2020 2020 2020  rray.size.      
-00046470: 2020 7365 6c66 2e7a 6572 6f73 203d 206e    self.zeros = n
-00046480: 702e 7a65 726f 7328 7365 6c66 2e61 7272  p.zeros(self.arr
-00046490: 6179 2e73 6861 7065 2c20 6474 7970 653d  ay.shape, dtype=
-000464a0: 626f 6f6c 290a 2020 2020 2020 2020 0a20  bool).        . 
-000464b0: 2020 2020 2020 2073 656c 662e 7661 6c75         self.valu
-000464c0: 6573 203d 205b 6c20 666f 7220 6c20 696e  es = [l for l in
-000464d0: 205f 5b30 5d5d 0a20 2020 2020 2020 2073   _[0]].        s
-000464e0: 656c 662e 696e 6469 6365 7320 3d20 5f5b  elf.indices = _[
-000464f0: 315d 0a20 2020 2020 2020 2073 656c 662e  1].        self.
-00046500: 636f 756e 7473 203d 205f 5b32 5d0a 2020  counts = _[2].  
-00046510: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-00046520: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00046530: 6c66 2e69 6e66 6f28 736f 7274 5f63 6f75  lf.info(sort_cou
-00046540: 6e74 733d 7665 7262 6f73 6529 0a20 2020  nts=verbose).   
-00046550: 200a 2020 2020 4070 726f 7065 7274 790a   .    @property.
-00046560: 2020 2020 6465 6620 4e28 7365 6c66 293a      def N(self):
-00046570: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00046580: 2020 2020 204e 756d 6265 7220 6f66 2075       Number of u
-00046590: 6e69 7175 6520 6060 7661 6c75 6573 6060  nique ``values``
-000465a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000465b0: 2020 2020 2072 6574 7572 6e20 6c65 6e28       return len(
-000465c0: 7365 6c66 2e76 616c 7565 7329 0a0a 0a20  self.values)... 
-000465d0: 2020 2064 6566 2069 6e66 6f28 7365 6c66     def info(self
-000465e0: 2c20 736f 7274 5f63 6f75 6e74 733d 2d31  , sort_counts=-1
-000465f0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00046600: 2020 2020 2020 2050 7269 6e74 2061 2073         Print a s
-00046610: 756d 6d61 7279 0a20 2020 2020 2020 2022  ummary.        "
-00046620: 2222 0a20 2020 2020 2020 2070 7269 6e74  "".        print
-00046630: 2866 277b 224e 223a 3e34 7d20 207b 2276  (f'{"N":>4}  {"v
-00046640: 616c 7565 223a 3130 7d27 290a 2020 2020  alue":10}').    
-00046650: 2020 2020 7072 696e 7428 273d 3d3d 3d20      print('==== 
-00046660: 203d 3d3d 3d3d 3d3d 3d3d 3d27 290a 2020   ==========').  
-00046670: 2020 2020 2020 6966 2073 6f72 745f 636f        if sort_co
-00046680: 756e 7473 3a0a 2020 2020 2020 2020 2020  unts:.          
-00046690: 2020 736f 203d 206e 702e 6172 6773 6f72    so = np.argsor
-000466a0: 7428 7365 6c66 2e63 6f75 6e74 7329 5b3a  t(self.counts)[:
-000466b0: 3a69 6e74 2873 6f72 745f 636f 756e 7473  :int(sort_counts
-000466c0: 295d 0a20 2020 2020 2020 2065 6c73 653a  )].        else:
-000466d0: 0a20 2020 2020 2020 2020 2020 2073 6f20  .            so 
-000466e0: 3d20 6e70 2e61 7261 6e67 6528 7365 6c66  = np.arange(self
-000466f0: 2e4e 290a 2020 2020 2020 2020 2020 2020  .N).            
-00046700: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
-00046710: 6e20 736f 3a0a 2020 2020 2020 2020 2020  n so:.          
-00046720: 2020 762c 2063 203d 2073 656c 662e 7661    v, c = self.va
-00046730: 6c75 6573 5b69 5d2c 2073 656c 662e 636f  lues[i], self.co
-00046740: 756e 7473 5b69 5d0a 2020 2020 2020 2020  unts[i].        
-00046750: 2020 2020 7072 696e 7428 6627 7b63 3a3e      print(f'{c:>
-00046760: 347d 2020 7b76 3a31 307d 2729 0a0a 0a20  4}  {v:10}')... 
-00046770: 2020 2064 6566 2063 6f75 6e74 2873 656c     def count(sel
-00046780: 662c 206b 6579 293a 0a20 2020 2020 2020  f, key):.       
-00046790: 2022 2222 0a20 2020 2020 2020 2047 6574   """.        Get
-000467a0: 206f 6363 7572 7265 6e63 6573 2063 6f75   occurrences cou
-000467b0: 6e74 206f 6620 6120 7061 7274 6963 756c  nt of a particul
-000467c0: 6172 2060 6076 616c 7565 6060 0a20 2020  ar ``value``.   
-000467d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000467e0: 2069 6620 6b65 7920 696e 2073 656c 662e   if key in self.
-000467f0: 7661 6c75 6573 3a0a 2020 2020 2020 2020  values:.        
-00046800: 2020 2020 6978 203d 2073 656c 662e 7661      ix = self.va
-00046810: 6c75 6573 2e69 6e64 6578 286b 6579 290a  lues.index(key).
-00046820: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00046830: 726e 2073 656c 662e 636f 756e 7473 5b69  rn self.counts[i
-00046840: 785d 0a20 2020 2020 2020 2065 6c73 653a  x].        else:
-00046850: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00046860: 7572 6e20 300a 0a0a 2020 2020 6465 6620  urn 0...    def 
-00046870: 5f5f 6974 6572 5f5f 2873 656c 6629 3a0a  __iter__(self):.
-00046880: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00046890: 2020 2020 4974 6572 6162 6c65 206f 7665      Iterable ove
-000468a0: 7220 6076 616c 7565 7360 2061 7474 7269  r `values` attri
-000468b0: 6275 7465 0a20 2020 2020 2020 200a 2020  bute.        .  
-000468c0: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
-000468d0: 7475 706c 6520 6f66 2074 6865 2076 616c  tuple of the val
-000468e0: 7565 2061 6e64 2074 6865 2062 6f6f 6c65  ue and the boole
-000468f0: 616e 2073 656c 6563 7469 6f6e 2061 7272  an selection arr
-00046900: 6179 2066 6f72 2074 6861 7420 0a20 2020  ay for that .   
-00046910: 2020 2020 2076 616c 7565 2e0a 2020 2020       value..    
-00046920: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00046930: 6920 3d20 300a 2020 2020 2020 2020 7768  i = 0.        wh
-00046940: 696c 6520 6920 3c20 7365 6c66 2e4e 3a0a  ile i < self.N:.
-00046950: 2020 2020 2020 2020 2020 2020 7669 203d              vi =
-00046960: 2073 656c 662e 7661 6c75 6573 5b69 5d0a   self.values[i].
-00046970: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-00046980: 6420 2876 692c 2073 656c 665b 7669 5d29  d (vi, self[vi])
-00046990: 0a20 2020 2020 2020 2020 2020 2069 202b  .            i +
-000469a0: 3d20 310a 0a0a 2020 2020 6465 6620 5f5f  = 1...    def __
-000469b0: 6765 7469 7465 6d5f 5f28 7365 6c66 2c20  getitem__(self, 
-000469c0: 6b65 7929 3a0a 2020 2020 2020 2020 6966  key):.        if
-000469d0: 206b 6579 2069 6e20 7365 6c66 2e76 616c   key in self.val
-000469e0: 7565 733a 0a20 2020 2020 2020 2020 2020  ues:.           
-000469f0: 2069 7820 3d20 7365 6c66 2e76 616c 7565   ix = self.value
-00046a00: 732e 696e 6465 7828 6b65 7929 0a20 2020  s.index(key).   
-00046a10: 2020 2020 2020 2020 2074 6573 7420 3d20           test = 
-00046a20: 7365 6c66 2e69 6e64 6963 6573 203d 3d20  self.indices == 
-00046a30: 6978 0a20 2020 2020 2020 2020 2020 2072  ix.            r
-00046a40: 6574 7572 6e20 7465 7374 0a20 2020 2020  eturn test.     
-00046a50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00046a60: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00046a70: 2e7a 6572 6f73 0a0a 0a20 2020 2023 2064  .zeros...    # d
-00046a80: 6566 205f 5f69 7465 725f 5f28 7365 6c66  ef __iter__(self
-00046a90: 293a 0a20 2020 2023 2020 2020 2066 6f72  ):.    #     for
-00046aa0: 2069 6478 2069 6e20 6974 6572 746f 6f6c   idx in itertool
-00046ab0: 732e 636f 756e 7428 293a 0a20 2020 2023  s.count():.    #
-00046ac0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00046ad0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-00046ae0: 7969 656c 6420 7365 6c66 2e76 616c 7565  yield self.value
-00046af0: 735b 6964 785d 0a20 2020 2023 2020 2020  s[idx].    #    
-00046b00: 2020 2020 2065 7863 6570 7420 496e 6465       except Inde
-00046b10: 7845 7272 6f72 3a0a 2020 2020 2320 2020  xError:.    #   
-00046b20: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00046b30: 0a20 2020 2064 6566 205f 5f6c 656e 5f5f  .    def __len__
-00046b40: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00046b50: 7265 7475 726e 2073 656c 662e 4e0a 0a0a  return self.N...
-00046b60: 636c 6173 7320 4875 6262 6c65 5859 5a28  class HubbleXYZ(
-00046b70: 6f62 6a65 6374 293a 0a20 2020 2064 6566  object):.    def
-00046b80: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00046b90: 7370 745f 6669 6c65 3d27 272c 2070 6172  spt_file='', par
-00046ba0: 616d 5f64 6963 743d 7b7d 293a 0a20 2020  am_dict={}):.   
-00046bb0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00046bc0: 2048 656c 7065 7220 746f 2063 6f6d 7075   Helper to compu
-00046bd0: 7465 2048 5354 2067 656f 6365 6e74 7269  te HST geocentri
-00046be0: 6320 636f 6f72 6469 6e61 7465 7320 6672  c coordinates fr
-00046bf0: 6f6d 206f 7262 6974 616c 2070 6172 616d  om orbital param
-00046c00: 6574 6572 730a 2020 2020 2020 2020 0a20  eters.        . 
-00046c10: 2020 2020 2020 2028 7465 7374 696e 6729         (testing)
-00046c20: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00046c30: 2020 4261 7365 6420 6f6e 2068 7474 703a    Based on http:
-00046c40: 2f2f 6172 7469 636c 6573 2e61 6473 6162  //articles.adsab
-00046c50: 732e 6861 7276 6172 642e 6564 752f 2f66  s.harvard.edu//f
-00046c60: 756c 6c2f 3139 3935 4153 5043 2e2e 2e37  ull/1995ASPC...7
-00046c70: 372e 2e34 3634 412f 0a20 2020 2020 2020  7..464A/.       
-00046c80: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00046c90: 7370 745f 6669 6c65 3a0a 2020 2020 2020  spt_file:.      
-00046ca0: 2020 2020 2020 7365 6c66 2e70 6172 616d        self.param
-00046cb0: 5f64 6963 7420 3d20 7365 6c66 2e70 6172  _dict = self.par
-00046cc0: 7365 5f66 726f 6d5f 7370 7428 7370 745f  se_from_spt(spt_
-00046cd0: 6669 6c65 290a 2020 2020 2020 2020 0a20  file).        . 
-00046ce0: 2020 2020 2020 2065 6c69 6620 7061 7261         elif para
-00046cf0: 6d5f 6469 6374 3a0a 2020 2020 2020 2020  m_dict:.        
-00046d00: 2020 2020 7365 6c66 2e70 6172 616d 5f64      self.param_d
-00046d10: 6963 7420 3d20 7061 7261 6d5f 6469 6374  ict = param_dict
-00046d20: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00046d30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00046d40: 2020 2020 7365 6c66 2e70 6172 616d 5f64      self.param_d
-00046d50: 6963 7420 3d20 7b7d 0a20 2020 2020 2020  ict = {}.       
-00046d60: 200a 2020 2020 2020 2020 7365 6c66 2e63   .        self.c
-00046d70: 6f6d 7075 7465 6420 3d20 7b7d 0a0a 0a20  omputed = {}... 
-00046d80: 2020 2040 7072 6f70 6572 7479 200a 2020     @property .  
-00046d90: 2020 6465 6620 5f74 3139 3835 2873 656c    def _t1985(sel
-00046da0: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-00046db0: 2020 2020 2020 2020 5265 6665 7265 6e63          Referenc
-00046dc0: 6520 7469 6d65 0a20 2020 2020 2020 2022  e time.        "
-00046dd0: 2222 0a20 2020 2020 2020 2069 6d70 6f72  "".        impor
-00046de0: 7420 6173 7472 6f70 792e 7469 6d65 0a20  t astropy.time. 
-00046df0: 2020 2020 2020 2074 3020 3d20 6173 7472         t0 = astr
-00046e00: 6f70 792e 7469 6d65 2e54 696d 6528 2731  opy.time.Time('1
-00046e10: 3938 352d 3031 2d30 3154 3030 3a30 303a  985-01-01T00:00:
-00046e20: 3030 5a27 290a 2020 2020 2020 2020 7265  00Z').        re
-00046e30: 7475 726e 2074 300a 0a0a 2020 2020 6465  turn t0...    de
-00046e40: 6620 5f5f 6361 6c6c 5f5f 2873 656c 662c  f __call__(self,
-00046e50: 2074 5f69 6e2c 202a 2a6b 7761 7267 7329   t_in, **kwargs)
-00046e60: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00046e70: 2020 2020 2020 436f 6e76 6572 7420 696e        Convert in
-00046e80: 7075 7420 7469 6d65 2060 6074 5f69 6e60  put time ``t_in`
-00046e90: 6020 746f 2073 6563 6f6e 6473 2073 696e  ` to seconds sin
-00046ea0: 6365 2031 2f31 2f38 3520 616e 6420 6060  ce 1/1/85 and ``
-00046eb0: 6576 616c 7561 7465 6060 2e0a 2020 2020  evaluate``..    
-00046ec0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00046ed0: 696d 706f 7274 2061 7374 726f 7079 2e74  import astropy.t
-00046ee0: 696d 650a 2020 2020 2020 2020 6966 206e  ime.        if n
-00046ef0: 6f74 2069 7369 6e73 7461 6e63 6528 745f  ot isinstance(t_
-00046f00: 696e 2c20 6173 7472 6f70 792e 7469 6d65  in, astropy.time
-00046f10: 2e54 696d 6529 3a0a 2020 2020 2020 2020  .Time):.        
-00046f20: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00046f30: 7272 6f72 2827 745f 696e 206d 7573 7420  rror('t_in must 
-00046f40: 6265 2061 7374 726f 7079 2e74 696d 652e  be astropy.time.
-00046f50: 5469 6d65 206f 626a 6563 7427 290a 0a20  Time object').. 
-00046f60: 2020 2020 2020 2064 7420 3d20 745f 696e         dt = t_in
-00046f70: 202d 2073 656c 662e 5f74 3139 3835 0a20   - self._t1985. 
-00046f80: 2020 2020 2020 2078 797a 203d 2073 656c         xyz = sel
-00046f90: 662e 6576 616c 7561 7465 2864 742e 7365  f.evaluate(dt.se
-00046fa0: 632c 202a 2a6b 7761 7267 7329 0a20 2020  c, **kwargs).   
-00046fb0: 2020 2020 2069 6620 2761 735f 7461 626c       if 'as_tabl
-00046fc0: 6527 2069 6e20 6b77 6172 6773 3a0a 2020  e' in kwargs:.  
-00046fd0: 2020 2020 2020 2020 2020 6966 206b 7761            if kwa
-00046fe0: 7267 735b 2761 735f 7461 626c 6527 5d3a  rgs['as_table']:
-00046ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047000: 2078 797a 5b27 7469 6d65 275d 203d 2074   xyz['time'] = t
-00047010: 5f69 6e0a 2020 2020 2020 2020 2020 2020  _in.            
-00047020: 2020 2020 0a20 2020 2020 2020 2072 6574      .        ret
-00047030: 7572 6e20 7879 7a0a 0a0a 2020 2020 6465  urn xyz...    de
-00047040: 6620 5f5f 6765 7469 7465 6d5f 5f28 7365  f __getitem__(se
-00047050: 6c66 2c20 6b65 7929 3a0a 2020 2020 2020  lf, key):.      
-00047060: 2020 7265 7475 726e 2073 656c 662e 7061    return self.pa
-00047070: 7261 6d5f 6469 6374 5b6b 6579 5d0a 0a0a  ram_dict[key]...
-00047080: 2020 2020 6465 6620 6576 616c 7561 7465      def evaluate
-00047090: 2873 656c 662c 2064 742c 2075 6e69 743d  (self, dt, unit=
-000470a0: 4e6f 6e65 2c20 6173 5f74 6162 6c65 3d46  None, as_table=F
-000470b0: 616c 7365 293a 0a20 2020 2020 2020 2022  alse):.        "
-000470c0: 2222 0a20 2020 2020 2020 2045 7661 6c75  "".        Evalu
-000470d0: 6174 6520 6571 7561 7469 6f6e 7320 746f  ate equations to
-000470e0: 2067 6574 2070 6f73 6974 696f 6e73 0a20   get positions. 
-000470f0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00047100: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-00047110: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00047120: 782c 2079 2c20 7a2c 2072 3a20 666c 6f61  x, y, z, r: floa
-00047130: 740a 2020 2020 2020 2020 2020 2020 436f  t.            Co
-00047140: 6f72 6469 6e61 7465 732c 2069 6e20 6b6d  ordinates, in km
-00047150: 206f 7220 6060 756e 6974 6060 2e0a 2020   or ``unit``..  
-00047160: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00047170: 2020 2022 2222 0a20 2020 2020 2020 200a     """.        .
-00047180: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00047190: 656c 662e 7061 7261 6d5f 6469 6374 3a0a  elf.param_dict:.
-000471a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000471b0: 6520 5661 6c75 6545 7272 6f72 2827 4f72  e ValueError('Or
-000471c0: 6269 7461 6c20 7061 7261 6d65 7465 7273  bital parameters
-000471d0: 206e 6f74 2064 6566 696e 6564 2069 6e20   not defined in 
-000471e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000471f0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00047200: 7365 6c66 2e70 6172 616d 5f64 6963 7427  self.param_dict'
-00047210: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00047220: 2020 2020 2020 0a20 2020 2020 2020 2070        .        p
-00047230: 203d 2073 656c 662e 7061 7261 6d5f 6469   = self.param_di
-00047240: 6374 0a20 2020 2020 2020 200a 2020 2020  ct.        .    
-00047250: 2020 2020 7420 3d20 6e70 2e61 746c 6561      t = np.atlea
-00047260: 7374 5f31 6428 6474 290a 2020 2020 2020  st_1d(dt).      
-00047270: 2020 0a20 2020 2020 2020 2023 2045 712e    .        # Eq.
-00047280: 2031 0a20 2020 2020 2020 2062 7261 636b   1.        brack
-00047290: 6574 203d 2070 5b27 4d2e 275d 2a28 742d  et = p['M.']*(t-
-000472a0: 705b 2774 6175 275d 2920 2b20 302e 352a  p['tau']) + 0.5*
-000472b0: 705b 274d 2e2e 275d 2a28 742d 705b 2774  p['M..']*(t-p['t
-000472c0: 6175 275d 292a 2a32 0a20 2020 2020 2020  au'])**2.       
-000472d0: 204d 203d 2070 5b27 4d30 275d 202b 2032   M = p['M0'] + 2
-000472e0: 2a6e 702e 7069 2a62 7261 636b 6574 0a20  *np.pi*bracket. 
-000472f0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00047300: 2320 4571 2e20 320a 2020 2020 2020 2020  # Eq. 2.        
-00047310: 7369 6e4d 203d 206e 702e 7369 6e28 4d29  sinM = np.sin(M)
-00047320: 0a20 2020 2020 2020 2063 6f73 4d20 3d20  .        cosM = 
-00047330: 6e70 2e63 6f73 284d 290a 2020 2020 2020  np.cos(M).      
-00047340: 2020 6520 3d20 705b 2765 275d 0a20 2020    e = p['e'].   
-00047350: 2020 2020 206e 7520 3d20 4d20 2b20 7369       nu = M + si
-00047360: 6e4d 2a28 322a 6520 2b20 332a 652a 2a33  nM*(2*e + 3*e**3
-00047370: 2a63 6f73 4d2a 2a32 202d 2034 2e2f 332a  *cosM**2 - 4./3*
-00047380: 652a 2a33 2a73 696e 4d2a 2a32 200a 2020  e**3*sinM**2 .  
-00047390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000473a0: 2020 2020 202b 2035 2e2f 322a 652a 2a32       + 5./2*e**2
-000473b0: 2a63 6f73 4d29 0a20 2020 2020 2020 200a  *cosM).        .
-000473c0: 2020 2020 2020 2020 2320 4571 2e20 330a          # Eq. 3.
-000473d0: 2020 2020 2020 2020 7220 3d20 705b 2761          r = p['a
-000473e0: 2831 2d65 2a2a 3229 275d 2f28 312b 652a  (1-e**2)']/(1+e*
-000473f0: 6e70 2e63 6f73 286e 7529 290a 2020 2020  np.cos(nu)).    
-00047400: 2020 2020 2320 546f 206b 6d0a 2020 2020      # To km.    
-00047410: 2020 2020 7220 2f3d 2031 3030 302e 0a20      r /= 1000.. 
-00047420: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00047430: 2320 4571 2e20 340a 2020 2020 2020 2020  # Eq. 4.        
-00047440: 4f6d 203d 2032 2a6e 702e 7069 2a28 705b  Om = 2*np.pi*(p[
-00047450: 274f 6d30 275d 202b 2070 5b27 4f6d 2e27  'Om0'] + p['Om.'
-00047460: 5d2a 2874 2d70 5b27 7461 7527 5d29 290a  ]*(t-p['tau'])).
-00047470: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00047480: 2023 2045 712e 2035 0a20 2020 2020 2020   # Eq. 5.       
-00047490: 2077 203d 2032 2a6e 702e 7069 2a28 705b   w = 2*np.pi*(p[
-000474a0: 2777 3027 5d20 2b20 705b 2777 2e27 5d2a  'w0'] + p['w.']*
-000474b0: 2874 2d70 5b27 7461 7527 5d29 290a 2020  (t-p['tau'])).  
-000474c0: 2020 2020 2020 0a20 2020 2020 2020 2073        .        s
-000474d0: 656c 662e 6361 6c63 5f64 6963 7420 3d20  elf.calc_dict = 
-000474e0: 7b27 4d27 3a4d 2c20 276e 7527 3a6e 752c  {'M':M, 'nu':nu,
-000474f0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00047500: 2020 2020 2020 2020 2020 2020 2761 273a              'a':
-00047510: 705b 2761 275d 2c20 0a20 2020 2020 2020  p['a'], .       
-00047520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047530: 2020 2027 6927 3a6e 702e 6172 6373 696e     'i':np.arcsin
-00047540: 2870 5b27 7369 6e69 275d 292c 200a 2020  (p['sini']), .  
-00047550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047560: 2020 2020 2020 2020 274f 6d27 3a4f 6d2c          'Om':Om,
-00047570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047580: 2020 2020 2020 2020 2020 2027 7727 3a77             'w':w
-00047590: 7d0a 2020 2020 2020 2020 0a20 2020 2020  }.        .     
-000475a0: 2020 2023 2045 712e 2036 0a20 2020 2020     # Eq. 6.     
-000475b0: 2020 2063 6f73 4f6d 203d 206e 702e 636f     cosOm = np.co
-000475c0: 7328 4f6d 290a 2020 2020 2020 2020 7369  s(Om).        si
-000475d0: 6e4f 6d20 3d20 6e70 2e73 696e 284f 6d29  nOm = np.sin(Om)
-000475e0: 0a20 2020 2020 2020 2063 6f73 7776 203d  .        coswv =
-000475f0: 206e 702e 636f 7328 772b 6e75 290a 2020   np.cos(w+nu).  
-00047600: 2020 2020 2020 7369 6e77 7620 3d20 6e70        sinwv = np
-00047610: 2e73 696e 2877 2b6e 7529 0a20 2020 2020  .sin(w+nu).     
-00047620: 2020 200a 2020 2020 2020 2020 6966 2075     .        if u
-00047630: 6e69 7420 6973 206e 6f74 204e 6f6e 653a  nit is not None:
-00047640: 0a20 2020 2020 2020 2020 2020 2072 203d  .            r =
-00047650: 2028 722a 752e 6b6d 292e 746f 2875 6e69   (r*u.km).to(uni
-00047660: 7429 0a20 2020 2020 2020 2020 2020 200a  t).            .
-00047670: 2020 2020 2020 2020 7820 3d20 722a 2863          x = r*(c
-00047680: 6f73 4f6d 2a63 6f73 7776 202d 2070 5b27  osOm*coswv - p['
-00047690: 636f 7369 275d 2a73 696e 4f6d 2a73 696e  cosi']*sinOm*sin
-000476a0: 7776 290a 2020 2020 2020 2020 7920 3d20  wv).        y = 
-000476b0: 722a 2873 696e 4f6d 2a63 6f73 7776 202b  r*(sinOm*coswv +
-000476c0: 2070 5b27 636f 7369 275d 2a63 6f73 4f6d   p['cosi']*cosOm
-000476d0: 2a73 696e 7776 290a 2020 2020 2020 2020  *sinwv).        
-000476e0: 7a20 3d20 722a 705b 2773 696e 6927 5d2a  z = r*p['sini']*
-000476f0: 7369 6e77 760a 2020 2020 2020 2020 0a20  sinwv.        . 
-00047700: 2020 2020 2020 2069 6620 6173 5f74 6162         if as_tab
-00047710: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00047720: 7461 6220 3d20 4754 6162 6c65 2829 0a20  tab = GTable(). 
-00047730: 2020 2020 2020 2020 2020 2074 6162 5b27             tab['
-00047740: 6474 275d 203d 2074 0a20 2020 2020 2020  dt'] = t.       
-00047750: 2020 2020 2074 6162 5b27 7827 5d20 3d20       tab['x'] = 
-00047760: 780a 2020 2020 2020 2020 2020 2020 7461  x.            ta
-00047770: 625b 2779 275d 203d 2079 0a20 2020 2020  b['y'] = y.     
-00047780: 2020 2020 2020 2074 6162 5b27 7a27 5d20         tab['z'] 
-00047790: 3d20 7a0a 2020 2020 2020 2020 2020 2020  = z.            
-000477a0: 7461 625b 2772 275d 203d 2072 0a20 2020  tab['r'] = r.   
-000477b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000477c0: 7461 620a 2020 2020 2020 2020 656c 7365  tab.        else
-000477d0: 3a20 0a20 2020 2020 2020 2020 2020 2072  : .            r
-000477e0: 6574 7572 6e20 782c 2079 2c20 7a2c 2072  eturn x, y, z, r
-000477f0: 0a0a 0a20 2020 2064 6566 2066 726f 6d5f  ...    def from_
-00047800: 666c 7428 7365 6c66 2c20 666c 745f 6669  flt(self, flt_fi
-00047810: 6c65 2c20 2a2a 6b77 6172 6773 293a 0a20  le, **kwargs):. 
-00047820: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00047830: 2020 2043 6f6d 7075 7465 2070 6f73 6974     Compute posit
-00047840: 696f 6e73 2061 7420 6578 7073 7461 7274  ions at expstart
-00047850: 2c20 6578 706d 6964 2c20 6578 7065 6e64  , expmid, expend
-00047860: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00047870: 2020 2020 2069 6d70 6f72 7420 6173 7472       import astr
-00047880: 6f70 792e 7469 6d65 0a20 2020 2020 2020  opy.time.       
-00047890: 200a 2020 2020 2020 2020 666c 7420 3d20   .        flt = 
-000478a0: 7079 6669 7473 2e6f 7065 6e28 666c 745f  pyfits.open(flt_
-000478b0: 6669 6c65 290a 2020 2020 2020 2020 6578  file).        ex
-000478c0: 7073 7461 7274 203d 2066 6c74 5b30 5d2e  pstart = flt[0].
-000478d0: 6865 6164 6572 5b27 4558 5053 5441 5254  header['EXPSTART
-000478e0: 275d 0a20 2020 2020 2020 2065 7870 656e  '].        expen
-000478f0: 6420 3d20 666c 745b 305d 2e68 6561 6465  d = flt[0].heade
-00047900: 725b 2745 5850 454e 4427 5d0a 2020 2020  r['EXPEND'].    
-00047910: 2020 2020 6578 706d 6964 203d 2028 6578      expmid = (ex
-00047920: 7073 7461 7274 2b65 7870 656e 6429 2f32  pstart+expend)/2
-00047930: 2e0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
-00047940: 2020 2074 5f69 6e20 3d20 6173 7472 6f70     t_in = astrop
-00047950: 792e 7469 6d65 2e54 696d 6528 5b65 7870  y.time.Time([exp
-00047960: 7374 6172 742c 2065 7870 6d69 642c 2065  start, expmid, e
-00047970: 7870 656e 645d 2c20 666f 726d 6174 3d27  xpend], format='
-00047980: 6d6a 6427 290a 2020 2020 2020 2020 666c  mjd').        fl
-00047990: 742e 636c 6f73 6528 290a 2020 2020 2020  t.close().      
-000479a0: 2020 0a20 2020 2020 2020 2072 6574 7572    .        retur
-000479b0: 6e20 7365 6c66 2874 5f69 6e2c 202a 2a6b  n self(t_in, **k
-000479c0: 7761 7267 7329 0a0a 0a20 2020 2064 6566  wargs)...    def
-000479d0: 2064 656c 7461 7428 7365 6c66 2c20 6474   deltat(self, dt
-000479e0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-000479f0: 2020 2020 2020 2043 6f6e 7665 7274 2061         Convert a
-00047a00: 2074 696d 6520 6060 7460 6020 696e 2073   time ``t`` in s
-00047a10: 6563 6f6e 6473 2066 726f 6d20 312f 312f  econds from 1/1/
-00047a20: 3835 2074 6f20 616e 2049 534f 2074 696d  85 to an ISO tim
-00047a30: 650a 2020 2020 2020 2020 2222 2220 2020  e.        """   
-00047a40: 200a 2020 2020 2020 2020 6966 206e 6f74   .        if not
-00047a50: 2068 6173 6174 7472 2864 742c 2027 756e   hasattr(dt, 'un
-00047a60: 6974 2729 3a0a 2020 2020 2020 2020 2020  it'):.          
-00047a70: 2020 6474 7365 6320 3d20 6474 2a75 2e73    dtsec = dt*u.s
-00047a80: 6563 6f6e 640a 2020 2020 2020 2020 656c  econd.        el
-00047a90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00047aa0: 6474 7365 6320 3d20 6474 0a20 2020 2020  dtsec = dt.     
-00047ab0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00047ac0: 7420 3d20 7365 6c66 2e5f 7431 3938 3520  t = self._t1985 
-00047ad0: 2b20 6474 7365 630a 2020 2020 2020 2020  + dtsec.        
-00047ae0: 7265 7475 726e 2074 0a0a 0a20 2020 2064  return t...    d
-00047af0: 6566 2070 6172 7365 5f66 726f 6d5f 7370  ef parse_from_sp
-00047b00: 7428 7365 6c66 2c20 7370 745f 6669 6c65  t(self, spt_file
-00047b10: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00047b20: 2020 2020 2020 2047 6574 206f 7262 6974         Get orbit
-00047b30: 616c 2065 6c65 6d65 6e74 7320 6672 6f6d  al elements from
-00047b40: 2053 5054 2068 6561 6465 720a 2020 2020   SPT header.    
-00047b50: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00047b60: 696d 706f 7274 2061 7374 726f 7079 2e69  import astropy.i
-00047b70: 6f2e 6669 7473 2061 7320 7079 6669 7473  o.fits as pyfits
-00047b80: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
-00047b90: 6173 7472 6f70 792e 7469 6d65 0a20 2020  astropy.time.   
-00047ba0: 2020 2020 200a 2020 2020 2020 2020 7769       .        wi
-00047bb0: 7468 2070 7966 6974 732e 6f70 656e 2873  th pyfits.open(s
-00047bc0: 7074 5f66 696c 6529 2061 7320 5f69 6d3a  pt_file) as _im:
-00047bd0: 0a20 2020 2020 2020 2020 2020 2073 7074  .            spt
-00047be0: 203d 205f 696d 5b30 5d2e 6865 6164 6572   = _im[0].header
-00047bf0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-00047c00: 0a20 2020 2020 2020 2070 6172 616d 5f64  .        param_d
-00047c10: 6963 7420 3d20 7b7d 0a20 2020 2020 2020  ict = {}.       
-00047c20: 2070 6172 616d 5f64 6963 745b 2774 6175   param_dict['tau
-00047c30: 275d 203d 2073 7074 5b27 4550 4348 5449  '] = spt['EPCHTI
-00047c40: 4d45 275d 0a20 2020 2020 2020 2070 6172  ME'].        par
-00047c50: 616d 5f64 6963 745b 274d 3027 5d20 3d20  am_dict['M0'] = 
-00047c60: 7370 745b 274d 4541 4e41 4e4f 4d27 5d0a  spt['MEANANOM'].
-00047c70: 2020 2020 2020 2020 7061 7261 6d5f 6469          param_di
-00047c80: 6374 5b27 4d2e 275d 203d 2073 7074 5b27  ct['M.'] = spt['
-00047c90: 4644 4d45 414e 414e 275d 0a20 2020 2020  FDMEANAN'].     
-00047ca0: 2020 2070 6172 616d 5f64 6963 745b 274d     param_dict['M
-00047cb0: 2e2e 275d 203d 2073 7074 5b27 5344 4d45  ..'] = spt['SDME
-00047cc0: 414e 414e 275d 0a20 2020 2020 2020 2070  ANAN'].        p
-00047cd0: 6172 616d 5f64 6963 745b 2765 275d 203d  aram_dict['e'] =
-00047ce0: 2073 7074 5b27 4543 4345 4e54 5259 275d   spt['ECCENTRY']
-00047cf0: 0a20 2020 2020 2020 2070 6172 616d 5f64  .        param_d
-00047d00: 6963 745b 2761 2831 2d65 2a2a 3229 275d  ict['a(1-e**2)']
-00047d10: 203d 2073 7074 5b27 5345 4d49 4c52 4543   = spt['SEMILREC
-00047d20: 275d 0a20 2020 2020 2020 2070 6172 616d  '].        param
-00047d30: 5f64 6963 745b 2761 275d 203d 2070 6172  _dict['a'] = par
-00047d40: 616d 5f64 6963 745b 2761 2831 2d65 2a2a  am_dict['a(1-e**
-00047d50: 3229 275d 202f 2028 312d 7061 7261 6d5f  2)'] / (1-param_
-00047d60: 6469 6374 5b27 6527 5d2a 2a32 290a 2020  dict['e']**2).  
-00047d70: 2020 2020 2020 7061 7261 6d5f 6469 6374        param_dict
-00047d80: 5b27 4f6d 3027 5d20 3d20 7370 745b 2752  ['Om0'] = spt['R
-00047d90: 4153 4341 5343 4e27 5d0a 2020 2020 2020  ASCASCN'].      
-00047da0: 2020 7061 7261 6d5f 6469 6374 5b27 4f6d    param_dict['Om
-00047db0: 2e27 5d20 3d20 7370 745b 2752 4341 5343  .'] = spt['RCASC
-00047dc0: 4e52 5627 5d0a 2020 2020 2020 2020 7061  NRV'].        pa
-00047dd0: 7261 6d5f 6469 6374 5b27 7730 275d 203d  ram_dict['w0'] =
-00047de0: 2073 7074 5b27 4152 4750 4552 4947 275d   spt['ARGPERIG']
-00047df0: 0a20 2020 2020 2020 2070 6172 616d 5f64  .        param_d
-00047e00: 6963 745b 2777 2e27 5d20 3d20 7370 745b  ict['w.'] = spt[
-00047e10: 2752 4341 5247 5045 5227 5d0a 2020 2020  'RCARGPER'].    
-00047e20: 2020 2020 7061 7261 6d5f 6469 6374 5b27      param_dict['
-00047e30: 636f 7369 275d 203d 2073 7074 5b27 434f  cosi'] = spt['CO
-00047e40: 5349 4e43 4c49 275d 0a20 2020 2020 2020  SINCLI'].       
-00047e50: 2070 6172 616d 5f64 6963 745b 2773 696e   param_dict['sin
-00047e60: 6927 5d20 3d20 7370 745b 2753 494e 4549  i'] = spt['SINEI
-00047e70: 4e43 4c27 5d0a 2020 2020 2020 2020 7061  NCL'].        pa
-00047e80: 7261 6d5f 6469 6374 5b27 5663 275d 203d  ram_dict['Vc'] =
-00047e90: 2073 7074 5b27 4349 5256 454c 4f43 275d   spt['CIRVELOC']
-00047ea0: 0a20 2020 2020 2020 2070 6172 616d 5f64  .        param_d
-00047eb0: 6963 745b 2774 696d 6566 6665 6327 5d20  ict['timeffec'] 
-00047ec0: 3d20 7370 745b 2754 494d 4546 4645 4327  = spt['TIMEFFEC'
-00047ed0: 5d0a 2020 2020 2020 2020 7061 7261 6d5f  ].        param_
-00047ee0: 6469 6374 5b27 546f 7262 275d 203d 2073  dict['Torb'] = s
-00047ef0: 7074 5b27 4853 5448 4f52 4227 5d2a 320a  pt['HSTHORB']*2.
-00047f00: 2020 2020 2020 2020 7061 7261 6d5f 6469          param_di
-00047f10: 6374 5b27 7473 7461 7274 275d 203d 2073  ct['tstart'] = s
-00047f20: 7074 5b27 4f42 5353 5452 5454 275d 0a20  pt['OBSSTRTT']. 
-00047f30: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00047f40: 7061 7261 6d5f 6469 6374 5b27 7461 755f  param_dict['tau_
-00047f50: 7469 6d65 275d 203d 2073 656c 662e 6465  time'] = self.de
-00047f60: 6c74 6174 2870 6172 616d 5f64 6963 745b  ltat(param_dict[
-00047f70: 2774 6175 275d 290a 2020 2020 2020 2020  'tau']).        
-00047f80: 7061 7261 6d5f 6469 6374 5b27 7473 7461  param_dict['tsta
-00047f90: 7274 5f74 696d 6527 5d20 3d20 7365 6c66  rt_time'] = self
-00047fa0: 2e64 656c 7461 7428 7061 7261 6d5f 6469  .deltat(param_di
-00047fb0: 6374 5b27 7473 7461 7274 275d 290a 2020  ct['tstart']).  
-00047fc0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-00047fd0: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-00047fe0: 7261 6d5f 6469 6374 0a20 2020 200a 2020  ram_dict.    .  
-00047ff0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-00048000: 2020 2020 6465 6620 7879 7a5f 746f 5f6c      def xyz_to_l
-00048010: 6f6e 6c61 7428 7365 6c66 2c20 782c 2079  onlat(self, x, y
-00048020: 2c20 7a2c 2072 6164 6961 6e73 3d46 616c  , z, radians=Fal
-00048030: 7365 293a 0a20 2020 2020 2020 2022 2222  se):.        """
-00048040: 0a20 2020 2020 2020 2043 6f6d 7075 7465  .        Compute
-00048050: 2073 7562 6c6f 6e2c 2073 7562 6c61 742c   sublon, sublat,
-00048060: 2061 6c74 2066 726f 6d20 7879 7a20 636f   alt from xyz co
-00048070: 6f72 6473 2077 6974 6820 7079 7072 6f6a  ords with pyproj
-00048080: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00048090: 2020 7879 7a20 6d75 7374 2062 6520 696e    xyz must be in
-000480a0: 206d 6574 6572 730a 2020 2020 2020 2020   meters.        
-000480b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000480c0: 2020 2020 2069 6d70 6f72 7420 7079 7072       import pypr
-000480d0: 6f6a 0a20 2020 2020 2020 2065 6365 6620  oj.        ecef 
-000480e0: 3d20 7079 7072 6f6a 2e50 726f 6a28 7072  = pyproj.Proj(pr
-000480f0: 6f6a 3d27 6765 6f63 656e 7427 2c20 656c  oj='geocent', el
-00048100: 6c70 733d 2757 4753 3834 272c 2064 6174  lps='WGS84', dat
-00048110: 756d 3d27 5747 5338 3427 290a 2020 2020  um='WGS84').    
-00048120: 2020 2020 6c6c 6120 3d20 7079 7072 6f6a      lla = pyproj
-00048130: 2e50 726f 6a28 7072 6f6a 3d27 6c61 746c  .Proj(proj='latl
-00048140: 6f6e 6727 2c20 656c 6c70 733d 2757 4753  ong', ellps='WGS
-00048150: 3834 272c 2064 6174 756d 3d27 5747 5338  84', datum='WGS8
-00048160: 3427 290a 2020 2020 2020 2020 6c6f 6e2c  4').        lon,
-00048170: 206c 6174 2c20 616c 7420 3d20 7079 7072   lat, alt = pypr
-00048180: 6f6a 2e74 7261 6e73 666f 726d 2865 6365  oj.transform(ece
-00048190: 662c 206c 6c61 2c20 782c 2079 2c20 7a2c  f, lla, x, y, z,
-000481a0: 2072 6164 6961 6e73 3d72 6164 6961 6e73   radians=radians
-000481b0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000481c0: 206c 6f6e 2c20 6c61 742c 2061 6c74 0a0a   lon, lat, alt..
-000481d0: 0a64 6566 2070 6174 6368 5f70 686f 7475  .def patch_photu
-000481e0: 7469 6c73 2829 3a0a 2020 2020 2222 220a  tils():.    """.
-000481f0: 2020 2020 5061 7463 6820 746f 2066 6978      Patch to fix
-00048200: 2069 6e63 6f6e 7369 7374 656e 6379 2077   inconsistency w
-00048210: 6974 6820 6472 697a 7a6c 6570 6163 3d33  ith drizzlepac=3
-00048220: 2e32 2e31 2061 6e64 2070 686f 7475 7469  .2.1 and photuti
-00048230: 6c73 3e31 2e30 2c20 7768 6572 6520 0a20  ls>1.0, where . 
-00048240: 2020 2054 6865 206c 6174 7465 7220 6973     The latter is
-00048250: 206e 6565 6465 6420 666f 7220 6a77 7374   needed for jwst
-00048260: 3d31 2e33 2e32 0a20 2020 2022 2222 0a20  =1.3.2.    """. 
-00048270: 2020 2069 6d70 6f72 7420 6f73 0a0a 2020     import os..  
-00048280: 2020 7472 793a 0a20 2020 2020 2020 2069    try:.        i
-00048290: 6d70 6f72 7420 6472 697a 7a6c 6570 6163  mport drizzlepac
-000482a0: 0a20 2020 2065 7863 6570 7420 4174 7472  .    except Attr
-000482b0: 6962 7574 6545 7272 6f72 3a0a 2020 2020  ibuteError:.    
-000482c0: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
-000482d0: 7068 6f74 7574 696c 730a 2020 2020 2020  photutils.      
-000482e0: 2020 7369 7465 5f70 6163 6b61 6765 7320    site_packages 
-000482f0: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-00048300: 6528 7068 6f74 7574 696c 732e 5f5f 6669  e(photutils.__fi
-00048310: 6c65 5f5f 290a 2020 2020 2020 2020 2320  le__).        # 
-00048320: 6d61 6e75 616c 2061 7070 6c79 2070 6174  manual apply pat
-00048330: 6368 0a20 2020 2020 2020 2074 6865 5f66  ch.        the_f
-00048340: 696c 6520 3d20 6627 7b73 6974 655f 7061  ile = f'{site_pa
-00048350: 636b 6167 6573 7d2f 2e2e 2f64 7269 7a7a  ckages}/../drizz
-00048360: 6c65 7061 632f 6861 7075 7469 6c73 2f61  lepac/haputils/a
-00048370: 6c69 676e 5f75 7469 6c73 2e70 7927 0a20  lign_utils.py'. 
-00048380: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
-00048390: 2874 6865 5f66 696c 652c 2772 2729 2061  (the_file,'r') a
-000483a0: 7320 6670 3a0a 2020 2020 2020 2020 2020  s fp:.          
-000483b0: 2020 6c69 6e65 7320 3d20 6670 2e72 6561    lines = fp.rea
-000483c0: 646c 696e 6573 2829 0a20 2020 200a 2020  dlines().    .  
-000483d0: 2020 2020 2020 7072 696e 7428 7369 7465        print(site
-000483e0: 5f70 6163 6b61 6765 732c 206c 656e 286c  _packages, len(l
-000483f0: 696e 6573 2929 0a20 2020 2020 2020 2066  ines)).        f
-00048400: 6f72 2069 2c20 6c69 6e65 2069 6e20 656e  or i, line in en
-00048410: 756d 6572 6174 6528 6c69 6e65 7329 3a0a  umerate(lines):.
-00048420: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00048430: 696e 652e 7374 6172 7473 7769 7468 2827  ine.startswith('
-00048440: 4e6f 4465 7465 6374 696f 6e73 5761 726e  NoDetectionsWarn
-00048450: 696e 6727 293a 0a20 2020 2020 2020 2020  ing'):.         
-00048460: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-00048470: 200a 2020 2020 2020 2020 6966 2027 6861   .        if 'ha
-00048480: 7361 7474 7228 7068 6f74 7574 696c 732e  sattr(photutils.
-00048490: 6669 6e64 7374 6172 7327 2069 6e20 6c69  findstars' in li
-000484a0: 6e65 735b 692b 315d 3a0a 2020 2020 2020  nes[i+1]:.      
-000484b0: 2020 2020 2020 7072 696e 7428 6627 4920        print(f'I 
-000484c0: 666f 756e 6420 7468 6520 7072 6f62 6c65  found the proble
-000484d0: 6d20 6f6e 206c 696e 6573 207b 697d 2d7b  m on lines {i}-{
-000484e0: 692b 327d 3a20 2729 0a20 2020 2020 2020  i+2}: ').       
-000484f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00048500: 2020 206d 7367 203d 2022 2222 0a4c 696e     msg = """.Lin
-00048510: 6573 207b 307d 2d7b 317d 2069 6e20 7b32  es {0}-{1} in {2
-00048520: 7d20 696d 706f 7274 696e 6720 7068 6f74  } importing phot
-00048530: 7574 696c 7320 7765 7265 206e 6f74 2061  utils were not a
-00048540: 7320 6578 7065 6374 6564 2e20 2049 2066  s expected.  I f
-00048550: 6f75 6e64 200a 0a7b 337d 0a0a 6275 7420  ound ..{3}..but 
-00048560: 6578 7065 6374 6564 200a 0a20 2020 4e6f  expected ..   No
-00048570: 4465 7465 6374 696f 6e73 5761 726e 696e  DetectionsWarnin
-00048580: 6720 3d20 7068 6f74 7574 696c 732e 6669  g = photutils.fi
-00048590: 6e64 7374 6172 732e 4e6f 4465 7465 6374  ndstars.NoDetect
-000485a0: 696f 6e73 5761 726e 696e 6720 6966 205c  ionsWarning if \
-000485b0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-000485c0: 2020 2020 2020 2020 2020 2020 2068 6173               has
-000485d0: 6174 7472 2870 686f 7475 7469 6c73 2e66  attr(photutils.f
-000485e0: 696e 6473 7461 7273 2c20 274e 6f44 6574  indstars, 'NoDet
-000485f0: 6563 7469 6f6e 7357 6172 6e69 6e67 2729  ectionsWarning')
-00048600: 2065 6c73 6520 5c5c 0a20 2020 2020 2020   else \\.       
-00048610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048620: 2020 2020 7068 6f74 7574 696c 732e 7574      photutils.ut
-00048630: 696c 732e 4e6f 4465 7465 6374 696f 6e73  ils.NoDetections
-00048640: 5761 726e 696e 670a 0a0a 2020 2020 2222  Warning...    ""
-00048650: 222e 666f 726d 6174 2869 2c20 692b 322c  ".format(i, i+2,
-00048660: 2074 6865 5f66 696c 652c 206c 696e 6573   the_file, lines
-00048670: 5b69 3a69 2b33 5d29 0a20 2020 2020 2020  [i:i+3]).       
-00048680: 200a 2020 2020 2020 2020 2020 2020 7261   .            ra
-00048690: 6973 6520 5661 6c75 6545 7272 6f72 286d  ise ValueError(m
-000486a0: 7367 290a 2020 2020 2020 2020 0a20 2020  sg).        .   
-000486b0: 2020 2020 2062 6164 203d 205b 2720 2020       bad = ['   
-000486c0: 272b 6c69 6e65 732e 706f 7028 692b 322d  '+lines.pop(i+2-
-000486d0: 6a29 2066 6f72 206a 2069 6e20 7261 6e67  j) for j in rang
-000486e0: 6528 3329 5d0a 2020 2020 2020 2020 7072  e(3)].        pr
-000486f0: 696e 7428 2727 2e6a 6f69 6e28 6261 645b  int(''.join(bad[
-00048700: 3a3a 2d31 5d29 290a 0a20 2020 2020 2020  ::-1]))..       
-00048710: 2023 2049 6e73 6572 7420 7468 6520 6669   # Insert the fi
-00048720: 780a 2020 2020 2020 2020 6c69 6e65 735b  x.        lines[
-00048730: 695d 203d 2027 6672 6f6d 2070 686f 7475  i] = 'from photu
-00048740: 7469 6c73 2e75 7469 6c73 2e65 7863 6570  tils.utils.excep
-00048750: 7469 6f6e 7320 696d 706f 7274 204e 6f44  tions import NoD
-00048760: 6574 6563 7469 6f6e 7357 6172 6e69 6e67  etectionsWarning
-00048770: 5c6e 5c6e 270a 2020 2020 2020 2020 2320  \n\n'.        # 
-00048780: 5265 7772 6974 6520 7468 6520 6669 650a  Rewrite the fie.
-00048790: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
-000487a0: 6e28 6627 7b73 6974 655f 7061 636b 6167  n(f'{site_packag
-000487b0: 6573 7d2f 2e2e 2f64 7269 7a7a 6c65 7061  es}/../drizzlepa
-000487c0: 632f 6861 7075 7469 6c73 2f61 6c69 676e  c/haputils/align
-000487d0: 5f75 7469 6c73 2e70 7927 2c27 7727 2920  _utils.py','w') 
-000487e0: 6173 2066 703a 0a20 2020 2020 2020 2020  as fp:.         
-000487f0: 2020 2066 702e 7772 6974 656c 696e 6573     fp.writelines
-00048800: 286c 696e 6573 290a 2020 2020 0a20 2020  (lines).    .   
-00048810: 2020 2020 2070 7269 6e74 2866 2750 6174       print(f'Pat
-00048820: 6368 2061 7070 6c69 6564 2074 6f20 7b74  ch applied to {t
-00048830: 6865 5f66 696c 657d 2127 290a            he_file}!').
+00034e90: 2020 2020 2750 5346 5354 445f 4143 5357      'PSFSTD_ACSW
+00034ea0: 4643 2a2e 6669 7473 2729 290a 2020 2020  FC*.fits')).    
+00034eb0: 2020 2020 6669 6c74 6572 5f66 696c 6573      filter_files
+00034ec0: 2e73 6f72 7428 290a 2020 2020 2020 2020  .sort().        
+00034ed0: 666f 7220 6669 6c65 2069 6e20 6669 6c74  for file in filt
+00034ee0: 6572 5f66 696c 6573 3a0a 2020 2020 2020  er_files:.      
+00034ef0: 2020 2020 2020 7769 7468 2070 7966 6974        with pyfit
+00034f00: 732e 6f70 656e 2866 696c 652c 2069 676e  s.open(file, ign
+00034f10: 6f72 655f 6d69 7373 696e 675f 656e 643d  ore_missing_end=
+00034f20: 5472 7565 2920 6173 205f 696d 3a0a 2020  True) as _im:.  
+00034f30: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00034f40: 7461 203d 205f 696d 5b30 5d2e 6461 7461  ta = _im[0].data
+00034f50: 2e54 2a31 2e0a 2020 2020 2020 2020 2020  .T*1..          
+00034f60: 2020 2020 2020 6461 7461 5b64 6174 6120        data[data 
+00034f70: 3c20 305d 203d 2030 0a20 2020 2020 2020  < 0] = 0.       
+00034f80: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00034f90: 2020 2020 2020 6669 6c74 203d 2027 5f27        filt = '_'
+00034fa0: 2e6a 6f69 6e28 6669 6c65 2e73 7472 6970  .join(file.strip
+00034fb0: 2827 2e66 6974 7327 292e 7370 6c69 7428  ('.fits').split(
+00034fc0: 275f 2729 5b32 3a5d 290a 2020 2020 2020  '_')[2:]).      
+00034fd0: 2020 2020 2020 7365 6c66 2e65 7073 665b        self.epsf[
+00034fe0: 6669 6c74 5d20 3d20 6461 7461 0a20 2020  filt] = data.   
+00034ff0: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
+00035000: 4a57 5354 0a20 2020 2020 2020 2066 696c  JWST.        fil
+00035010: 7465 725f 6669 6c65 7320 3d20 676c 6f62  ter_files = glob
+00035020: 2e67 6c6f 6228 6f73 2e70 6174 682e 6a6f  .glob(os.path.jo
+00035030: 696e 2847 5249 5a4c 495f 5041 5448 2c20  in(GRIZLI_PATH, 
+00035040: 2743 4f4e 462f 4a57 5354 6550 5346 272c  'CONF/JWSTePSF',
+00035050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035060: 2020 2020 2020 2020 2020 2020 2027 6e69               'ni
+00035070: 7263 616d 2a2e 6669 7473 2729 290a 2020  rcam*.fits')).  
+00035080: 2020 2020 2020 6669 6c74 6572 5f66 696c        filter_fil
+00035090: 6573 202b 3d20 676c 6f62 2e67 6c6f 6228  es += glob.glob(
+000350a0: 6f73 2e70 6174 682e 6a6f 696e 2847 5249  os.path.join(GRI
+000350b0: 5a4c 495f 5041 5448 2c20 2743 4f4e 462f  ZLI_PATH, 'CONF/
+000350c0: 4a57 5354 6550 5346 272c 0a20 2020 2020  JWSTePSF',.     
+000350d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000350e0: 2020 2020 2020 2027 6e69 7269 7373 2a2e         'niriss*.
+000350f0: 6669 7473 2729 290a 2020 2020 2020 2020  fits')).        
+00035100: 6669 6c74 6572 5f66 696c 6573 202b 3d20  filter_files += 
+00035110: 676c 6f62 2e67 6c6f 6228 6f73 2e70 6174  glob.glob(os.pat
+00035120: 682e 6a6f 696e 2847 5249 5a4c 495f 5041  h.join(GRIZLI_PA
+00035130: 5448 2c20 2743 4f4e 462f 4a57 5354 6550  TH, 'CONF/JWSTeP
+00035140: 5346 272c 0a20 2020 2020 2020 2020 2020  SF',.           
+00035150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035160: 2027 6d69 7269 2a2e 6669 7473 2729 290a   'miri*.fits')).
+00035170: 2020 2020 2020 2020 6669 6c74 6572 5f66          filter_f
+00035180: 696c 6573 2e73 6f72 7428 290a 2020 2020  iles.sort().    
+00035190: 2020 2020 666f 7220 6669 6c65 2069 6e20      for file in 
+000351a0: 6669 6c74 6572 5f66 696c 6573 3a0a 2020  filter_files:.  
+000351b0: 2020 2020 2020 2020 2020 7769 7468 2070            with p
+000351c0: 7966 6974 732e 6f70 656e 2866 696c 652c  yfits.open(file,
+000351d0: 2069 676e 6f72 655f 6d69 7373 696e 675f   ignore_missing_
+000351e0: 656e 643d 5472 7565 2920 6173 205f 696d  end=True) as _im
+000351f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035200: 2020 6461 7461 203d 205f 696d 5b30 5d2e    data = _im[0].
+00035210: 6461 7461 2a31 2023 205b 3a3a 2d31 2c3a  data*1 # [::-1,:
+00035220: 2c3a 5d23 5b3a 2c3a 3a2d 312c 3a5d 0a20  ,:]#[:,::-1,:]. 
+00035230: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00035240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035250: 6461 7461 5b64 6174 6120 3c20 305d 203d  data[data < 0] =
+00035260: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+00035270: 2020 206b 6579 203d 2027 7b30 7d2d 7b31     key = '{0}-{1
+00035280: 7d27 2e66 6f72 6d61 7428 5f69 6d5b 305d  }'.format(_im[0]
+00035290: 2e68 6561 6465 725b 2744 4554 4543 544f  .header['DETECTO
+000352a0: 5227 5d2e 7570 7065 7228 292c 0a20 2020  R'].upper(),.   
+000352b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000352c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000352d0: 2020 2020 5f69 6d5b 305d 2e68 6561 6465      _im[0].heade
+000352e0: 725b 2746 494c 5445 5227 5d29 0a20 2020  r['FILTER']).   
+000352f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00035300: 2020 2020 2020 2020 2020 6966 2027 4c41            if 'LA
+00035310: 4245 4c27 2069 6e20 5f69 6d5b 305d 2e68  BEL' in _im[0].h
+00035320: 6561 6465 723a 0a20 2020 2020 2020 2020  eader:.         
+00035330: 2020 2020 2020 2020 2020 206b 6579 202b             key +
+00035340: 3d20 272d 2720 2b20 5f69 6d5b 305d 2e68  = '-' + _im[0].h
+00035350: 6561 6465 725b 274c 4142 454c 275d 0a20  eader['LABEL']. 
+00035360: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00035370: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00035380: 2e65 7073 665b 6b65 795d 203d 2064 6174  .epsf[key] = dat
+00035390: 610a 2020 2020 2020 2020 0a20 2020 2020  a.        .     
+000353a0: 2020 2023 2044 756d 6d79 2c20 7573 6520     # Dummy, use 
+000353b0: 4631 3035 5720 6550 5346 2066 6f72 2046  F105W ePSF for F
+000353c0: 3039 384d 2061 6e64 2046 3131 3057 0a20  098M and F110W. 
+000353d0: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
+000353e0: 5b27 4630 3938 4d27 5d20 3d20 7365 6c66  ['F098M'] = self
+000353f0: 2e65 7073 665b 2746 3130 3557 275d 0a20  .epsf['F105W']. 
+00035400: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
+00035410: 5b27 4631 3238 4e27 5d20 3d20 7365 6c66  ['F128N'] = self
+00035420: 2e65 7073 665b 2746 3132 3557 275d 0a20  .epsf['F125W']. 
+00035430: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
+00035440: 5b27 4631 3330 4e27 5d20 3d20 7365 6c66  ['F130N'] = self
+00035450: 2e65 7073 665b 2746 3132 3557 275d 0a20  .epsf['F125W']. 
+00035460: 2020 2020 2020 2073 656c 662e 6570 7366         self.epsf
+00035470: 5b27 4631 3332 4e27 5d20 3d20 7365 6c66  ['F132N'] = self
+00035480: 2e65 7073 665b 2746 3132 3557 275d 0a20  .epsf['F125W']. 
+00035490: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+000354a0: 2320 4475 6d6d 7920 6669 6c74 6572 7320  # Dummy filters 
+000354b0: 666f 7220 4952 2067 7269 736d 730a 2020  for IR grisms.  
+000354c0: 2020 2020 2020 7365 6c66 2e65 7073 665b        self.epsf[
+000354d0: 2747 3134 3127 5d20 3d20 7365 6c66 2e65  'G141'] = self.e
+000354e0: 7073 665b 2746 3134 3057 275d 0a20 2020  psf['F140W'].   
+000354f0: 2020 2020 2073 656c 662e 6570 7366 5b27       self.epsf['
+00035500: 4731 3032 275d 203d 2073 656c 662e 6570  G102'] = self.ep
+00035510: 7366 5b27 4631 3035 5727 5d0a 2020 2020  sf['F105W'].    
+00035520: 2020 2020 0a20 2020 2020 2020 2023 2045      .        # E
+00035530: 7874 656e 6465 640a 2020 2020 2020 2020  xtended.        
+00035540: 7365 6c66 2e65 7874 656e 6465 645f 6570  self.extended_ep
+00035550: 7366 203d 207b 7d0a 2020 2020 2020 2020  sf = {}.        
+00035560: 666f 7220 6669 6c74 6572 2069 6e20 5b27  for filter in ['
+00035570: 4631 3035 5727 2c20 2746 3132 3557 272c  F105W', 'F125W',
+00035580: 2027 4631 3430 5727 2c20 2746 3136 3057   'F140W', 'F160W
+00035590: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
+000355a0: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
+000355b0: 6f69 6e28 4752 495a 4c49 5f50 4154 482c  oin(GRIZLI_PATH,
+000355c0: 2027 434f 4e46 272c 0a20 2020 2020 2020   'CONF',.       
+000355d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000355e0: 2020 2020 2020 2020 2027 6578 7465 6e64           'extend
+000355f0: 6564 5f50 5346 5f7b 307d 2e66 6974 7327  ed_PSF_{0}.fits'
+00035600: 2e66 6f72 6d61 7428 6669 6c74 6572 2929  .format(filter))
+00035610: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00035620: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
+00035630: 7374 7328 6669 6c65 293a 0a20 2020 2020  sts(file):.     
+00035640: 2020 2020 2020 2020 2020 2023 4241 5345             #BASE
+00035650: 5552 4c20 3d20 2768 7474 7073 3a2f 2f65  URL = 'https://e
+00035660: 7264 612e 6b75 2e64 6b2f 7667 7269 642f  rda.ku.dk/vgrid/
+00035670: 4761 6272 6965 6c25 3230 4272 616d 6d65  Gabriel%20Bramme
+00035680: 722f 434f 4e46 2f27 0a20 2020 2020 2020  r/CONF/'.       
+00035690: 2020 2020 2020 2020 2042 4153 4555 524c           BASEURL
+000356a0: 203d 2028 2768 7474 7073 3a2f 2f72 6177   = ('https://raw
+000356b0: 2e67 6974 6875 6275 7365 7263 6f6e 7465  .githubuserconte
+000356c0: 6e74 2e63 6f6d 2f67 6272 616d 6d65 722f  nt.com/gbrammer/
+000356d0: 2720 2b0a 2020 2020 2020 2020 2020 2020  ' +.            
+000356e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000356f0: 6772 697a 6c69 2d63 6f6e 6669 672f 6d61  grizli-config/ma
+00035700: 7374 6572 2729 0a0a 2020 2020 2020 2020  ster')..        
+00035710: 2020 2020 2020 2020 6d73 6720 3d20 2745          msg = 'E
+00035720: 7874 656e 6465 6420 5053 4620 6669 6c65  xtended PSF file
+00035730: 205c 277b 307d 5c27 206e 6f74 2066 6f75   \'{0}\' not fou
+00035740: 6e64 2e27 2e66 6f72 6d61 7428 6669 6c65  nd.'.format(file
+00035750: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00035760: 2020 6d73 6720 2b3d 2027 4765 7420 7468    msg += 'Get th
+00035770: 6520 6172 6368 6976 6520 6672 6f6d 2027  e archive from '
+00035780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035790: 206d 7367 202b 3d20 6627 207b 4241 5345   msg += f' {BASE
+000357a0: 5552 4c7d 2f57 4643 3349 525f 6578 7465  URL}/WFC3IR_exte
+000357b0: 6e64 6564 5f50 5346 2e76 312e 7461 722e  nded_PSF.v1.tar.
+000357c0: 677a 270a 2020 2020 2020 2020 2020 2020  gz'.            
+000357d0: 2020 2020 6d73 6720 2b3d 2027 2061 6e64      msg += ' and
+000357e0: 2075 6e70 6163 6b20 696e 2024 7b47 5249   unpack in ${GRI
+000357f0: 5a4c 497d 2f43 4f4e 462f 270a 2020 2020  ZLI}/CONF/'.    
+00035800: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00035810: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
+00035820: 726f 7228 6d73 6729 0a0a 2020 2020 2020  ror(msg)..      
+00035830: 2020 2020 2020 7769 7468 2070 7966 6974        with pyfit
+00035840: 732e 6f70 656e 2866 696c 6529 2061 7320  s.open(file) as 
+00035850: 5f69 6d3a 0a20 2020 2020 2020 2020 2020  _im:.           
+00035860: 2020 2020 2064 6174 6120 3d20 5f69 6d5b       data = _im[
+00035870: 305d 2e64 6174 612a 310a 2020 2020 2020  0].data*1.      
+00035880: 2020 2020 2020 2020 2020 6461 7461 5b64            data[d
+00035890: 6174 6120 3c20 305d 203d 2030 0a0a 2020  ata < 0] = 0..  
+000358a0: 2020 2020 2020 2020 2020 2320 4d61 736b            # Mask
+000358b0: 2063 656e 7465 720a 2020 2020 2020 2020   center.        
+000358c0: 2020 2020 4e58 203d 2064 6174 612e 7368      NX = data.sh
+000358d0: 6170 655b 305d 2f32 2d31 0a20 2020 2020  ape[0]/2-1.     
+000358e0: 2020 2020 2020 2079 702c 2078 7020 3d20         yp, xp = 
+000358f0: 6e70 2e69 6e64 6963 6573 2864 6174 612e  np.indices(data.
+00035900: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
+00035910: 2020 2052 203d 206e 702e 7371 7274 2828     R = np.sqrt((
+00035920: 7870 2d4e 5829 2a2a 322b 2879 702d 4e58  xp-NX)**2+(yp-NX
+00035930: 292a 2a32 290a 2020 2020 2020 2020 2020  )**2).          
+00035940: 2020 6461 7461 5b52 203c 3d20 345d 203d    data[R <= 4] =
+00035950: 2030 2e0a 0a20 2020 2020 2020 2020 2020   0...           
+00035960: 2073 656c 662e 6578 7465 6e64 6564 5f65   self.extended_e
+00035970: 7073 665b 6669 6c74 6572 5d20 3d20 6461  psf[filter] = da
+00035980: 7461 0a20 2020 2020 2020 2020 2020 2073  ta.            s
+00035990: 656c 662e 6578 7465 6e64 6564 5f4e 203d  elf.extended_N =
+000359a0: 2069 6e74 284e 5829 0a0a 2020 2020 2020   int(NX)..      
+000359b0: 2020 7365 6c66 2e65 7874 656e 6465 645f    self.extended_
+000359c0: 6570 7366 5b27 4630 3938 4d27 5d20 3d20  epsf['F098M'] = 
+000359d0: 7365 6c66 2e65 7874 656e 6465 645f 6570  self.extended_ep
+000359e0: 7366 5b27 4631 3035 5727 5d0a 2020 2020  sf['F105W'].    
+000359f0: 2020 2020 7365 6c66 2e65 7874 656e 6465      self.extende
+00035a00: 645f 6570 7366 5b27 4631 3130 5727 5d20  d_epsf['F110W'] 
+00035a10: 3d20 7365 6c66 2e65 7874 656e 6465 645f  = self.extended_
+00035a20: 6570 7366 5b27 4631 3035 5727 5d0a 2020  epsf['F105W'].  
+00035a30: 2020 2020 2020 7365 6c66 2e65 7874 656e        self.exten
+00035a40: 6465 645f 6570 7366 5b27 4631 3238 4e27  ded_epsf['F128N'
+00035a50: 5d20 3d20 7365 6c66 2e65 7874 656e 6465  ] = self.extende
+00035a60: 645f 6570 7366 5b27 4631 3235 5727 5d0a  d_epsf['F125W'].
+00035a70: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
+00035a80: 656e 6465 645f 6570 7366 5b27 4631 3330  ended_epsf['F130
+00035a90: 4e27 5d20 3d20 7365 6c66 2e65 7874 656e  N'] = self.exten
+00035aa0: 6465 645f 6570 7366 5b27 4631 3235 5727  ded_epsf['F125W'
+00035ab0: 5d0a 2020 2020 2020 2020 7365 6c66 2e65  ].        self.e
+00035ac0: 7874 656e 6465 645f 6570 7366 5b27 4631  xtended_epsf['F1
+00035ad0: 3332 4e27 5d20 3d20 7365 6c66 2e65 7874  32N'] = self.ext
+00035ae0: 656e 6465 645f 6570 7366 5b27 4631 3235  ended_epsf['F125
+00035af0: 5727 5d0a 2020 2020 2020 2020 7365 6c66  W'].        self
+00035b00: 2e65 7874 656e 6465 645f 6570 7366 5b27  .extended_epsf['
+00035b10: 4731 3032 275d 203d 2073 656c 662e 6578  G102'] = self.ex
+00035b20: 7465 6e64 6564 5f65 7073 665b 2746 3130  tended_epsf['F10
+00035b30: 3557 275d 0a20 2020 2020 2020 2073 656c  5W'].        sel
+00035b40: 662e 6578 7465 6e64 6564 5f65 7073 665b  f.extended_epsf[
+00035b50: 2747 3134 3127 5d20 3d20 7365 6c66 2e65  'G141'] = self.e
+00035b60: 7874 656e 6465 645f 6570 7366 5b27 4631  xtended_epsf['F1
+00035b70: 3430 5727 5d0a 0a0a 2020 2020 6465 6620  40W']...    def 
+00035b80: 6765 745f 6174 5f70 6f73 6974 696f 6e28  get_at_position(
+00035b90: 7365 6c66 2c20 783d 3530 372c 2079 3d35  self, x=507, y=5
+00035ba0: 3037 2c20 6669 6c74 6572 3d27 4631 3430  07, filter='F140
+00035bb0: 5727 2c20 726f 7439 303d 3029 3a0a 2020  W', rot90=0):.  
+00035bc0: 2020 2020 2020 2222 2245 7661 6c75 6174        """Evaluat
+00035bd0: 6520 6550 5346 2061 7420 6465 7465 6374  e ePSF at detect
+00035be0: 6f72 2063 6f6f 7264 696e 6174 6573 0a20  or coordinates. 
+00035bf0: 2020 2020 2020 2054 4244 0a20 2020 2020         TBD.     
+00035c00: 2020 2022 2222 0a20 2020 2020 2020 2065     """.        e
+00035c10: 7073 6620 3d20 7365 6c66 2e65 7073 665b  psf = self.epsf[
+00035c20: 6669 6c74 6572 5d0a 2020 2020 2020 2020  filter].        
+00035c30: 0a20 2020 2020 2020 2070 7366 5f74 7970  .        psf_typ
+00035c40: 6520 3d20 2748 5354 2f4f 7074 6963 616c  e = 'HST/Optical
+00035c50: 270a 2020 2020 2020 2020 0a20 2020 2020  '.        .     
+00035c60: 2020 2069 6620 6669 6c74 6572 2069 6e20     if filter in 
+00035c70: 5b27 4630 3938 4d27 2c20 2746 3131 3057  ['F098M', 'F110W
+00035c80: 272c 2027 4631 3035 5727 2c20 2746 3132  ', 'F105W', 'F12
+00035c90: 3557 272c 2027 4631 3430 5727 2c20 2746  5W', 'F140W', 'F
+00035ca0: 3136 3057 272c 0a20 2020 2020 2020 2020  160W',.         
+00035cb0: 2020 2020 2020 2020 2020 2020 2027 4731               'G1
+00035cc0: 3032 272c 2747 3134 3127 2c27 4631 3238  02','G141','F128
+00035cd0: 4e27 2c27 4631 3330 4e27 2c27 4631 3332  N','F130N','F132
+00035ce0: 4e27 5d3a 0a20 2020 2020 2020 2020 2020  N']:.           
+00035cf0: 2070 7366 5f74 7970 6520 3d20 2757 4643   psf_type = 'WFC
+00035d00: 332f 4952 270a 2020 2020 2020 2020 2020  3/IR'.          
+00035d10: 2020 0a20 2020 2020 2020 2065 6c69 6620    .        elif 
+00035d20: 6669 6c74 6572 2e73 7461 7274 7377 6974  filter.startswit
+00035d30: 6828 274e 5243 2729 207c 2066 696c 7465  h('NRC') | filte
+00035d40: 722e 7374 6172 7473 7769 7468 2827 4e49  r.startswith('NI
+00035d50: 5327 293a 0a20 2020 2020 2020 2020 2020  S'):.           
+00035d60: 2023 204e 4952 4953 532c 204e 4952 4361   # NIRISS, NIRCa
+00035d70: 6d20 324b 0a20 2020 2020 2020 2020 2020  m 2K.           
+00035d80: 2070 7366 5f74 7970 6520 3d20 274a 5753   psf_type = 'JWS
+00035d90: 542f 324b 270a 2020 2020 2020 2020 2020  T/2K'.          
+00035da0: 2020 0a20 2020 2020 2020 2065 6c69 6620    .        elif 
+00035db0: 6669 6c74 6572 2e73 7461 7274 7377 6974  filter.startswit
+00035dc0: 6828 274d 4952 4927 293a 0a20 2020 2020  h('MIRI'):.     
+00035dd0: 2020 2020 2020 2070 7366 5f74 7970 6520         psf_type 
+00035de0: 3d20 274a 5753 542f 4d49 5249 270a 2020  = 'JWST/MIRI'.  
+00035df0: 2020 2020 2020 0a20 2020 2020 2020 2073        .        s
+00035e00: 656c 662e 6576 616c 5f70 7366 5f74 7970  elf.eval_psf_typ
+00035e10: 6520 3d20 7073 665f 7479 7065 0a20 2020  e = psf_type.   
+00035e20: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00035e30: 2070 7366 5f74 7970 6520 3d3d 2027 5746   psf_type == 'WF
+00035e40: 4333 2f49 5227 3a0a 2020 2020 2020 2020  C3/IR':.        
+00035e50: 2020 2020 2320 2049 5220 6465 7465 6374      #  IR detect
+00035e60: 6f72 0a20 2020 2020 2020 2020 2020 2072  or.            r
+00035e70: 7820 3d20 312b 286e 702e 636c 6970 2878  x = 1+(np.clip(x
+00035e80: 2c20 312c 2031 3031 3329 2d30 292f 3530  , 1, 1013)-0)/50
+00035e90: 372e 0a20 2020 2020 2020 2020 2020 2072  7..            r
+00035ea0: 7920 3d20 312b 286e 702e 636c 6970 2879  y = 1+(np.clip(y
+00035eb0: 2c20 312c 2031 3031 3329 2d30 292f 3530  , 1, 1013)-0)/50
+00035ec0: 372e 0a0a 2020 2020 2020 2020 2020 2020  7...            
+00035ed0: 2320 7a65 726f 2069 6e64 6578 0a20 2020  # zero index.   
+00035ee0: 2020 2020 2020 2020 2072 7820 2d3d 2031           rx -= 1
+00035ef0: 0a20 2020 2020 2020 2020 2020 2072 7920  .            ry 
+00035f00: 2d3d 2031 0a0a 2020 2020 2020 2020 2020  -= 1..          
+00035f10: 2020 6e78 203d 206e 702e 636c 6970 2869    nx = np.clip(i
+00035f20: 6e74 2872 7829 2c20 302c 2032 290a 2020  nt(rx), 0, 2).  
+00035f30: 2020 2020 2020 2020 2020 6e79 203d 206e            ny = n
+00035f40: 702e 636c 6970 2869 6e74 2872 7929 2c20  p.clip(int(ry), 
+00035f50: 302c 2032 290a 0a20 2020 2020 2020 2020  0, 2)..         
+00035f60: 2020 2023 2070 7269 6e74 2078 2c20 792c     # print x, y,
+00035f70: 2072 782c 2072 792c 206e 782c 206e 790a   rx, ry, nx, ny.
+00035f80: 0a20 2020 2020 2020 2020 2020 2066 7820  .            fx 
+00035f90: 3d20 7278 2d6e 780a 2020 2020 2020 2020  = rx-nx.        
+00035fa0: 2020 2020 6679 203d 2072 792d 6e79 0a0a      fy = ry-ny..
+00035fb0: 2020 2020 2020 2020 2020 2020 7073 665f              psf_
+00035fc0: 7879 203d 2028 312d 6678 292a 2831 2d66  xy = (1-fx)*(1-f
+00035fd0: 7929 2a65 7073 665b 3a2c 203a 2c20 6e78  y)*epsf[:, :, nx
+00035fe0: 2b6e 792a 335d 0a20 2020 2020 2020 2020  +ny*3].         
+00035ff0: 2020 2070 7366 5f78 7920 2b3d 2066 782a     psf_xy += fx*
+00036000: 2831 2d66 7929 2a65 7073 665b 3a2c 203a  (1-fy)*epsf[:, :
+00036010: 2c20 286e 782b 3129 2b6e 792a 335d 0a20  , (nx+1)+ny*3]. 
+00036020: 2020 2020 2020 2020 2020 2070 7366 5f78             psf_x
+00036030: 7920 2b3d 2028 312d 6678 292a 6679 2a65  y += (1-fx)*fy*e
+00036040: 7073 665b 3a2c 203a 2c20 6e78 2b28 6e79  psf[:, :, nx+(ny
+00036050: 2b31 292a 335d 0a20 2020 2020 2020 2020  +1)*3].         
+00036060: 2020 2070 7366 5f78 7920 2b3d 2066 782a     psf_xy += fx*
+00036070: 6679 2a65 7073 665b 3a2c 203a 2c20 286e  fy*epsf[:, :, (n
+00036080: 782b 3129 2b28 6e79 2b31 292a 335d 0a20  x+1)+(ny+1)*3]. 
+00036090: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+000360a0: 2020 2020 2020 2020 7365 6c66 2e65 7661          self.eva
+000360b0: 6c5f 6669 6c74 6572 203d 2066 696c 7465  l_filter = filte
+000360c0: 720a 2020 2020 2020 2020 0a20 2020 2020  r.        .     
+000360d0: 2020 2069 6620 7073 665f 7479 7065 203d     if psf_type =
+000360e0: 3d20 274a 5753 542f 4d49 5249 273a 0a20  = 'JWST/MIRI':. 
+000360f0: 2020 2020 2020 2020 2020 2023 2020 4952             #  IR
+00036100: 2064 6574 6563 746f 720a 2020 2020 2020   detector.      
+00036110: 2020 2020 2020 4e44 4554 203d 2069 6e74        NDET = int
+00036120: 286e 702e 7371 7274 2865 7073 662e 7368  (np.sqrt(epsf.sh
+00036130: 6170 655b 325d 2929 0a20 2020 2020 2020  ape[2])).       
+00036140: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00036150: 2020 7278 203d 2031 2b28 6e70 2e63 6c69    rx = 1+(np.cli
+00036160: 7028 782c 2031 2c20 3130 3233 292d 3029  p(x, 1, 1023)-0)
+00036170: 2f35 3132 2e0a 2020 2020 2020 2020 2020  /512..          
+00036180: 2020 7279 203d 2031 2b28 6e70 2e63 6c69    ry = 1+(np.cli
+00036190: 7028 792c 2031 2c20 3130 3233 292d 3029  p(y, 1, 1023)-0)
+000361a0: 2f35 3132 2e0a 0a20 2020 2020 2020 2020  /512...         
+000361b0: 2020 2023 207a 6572 6f20 696e 6465 780a     # zero index.
+000361c0: 2020 2020 2020 2020 2020 2020 7278 202d              rx -
+000361d0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+000361e0: 7279 202d 3d20 310a 0a20 2020 2020 2020  ry -= 1..       
+000361f0: 2020 2020 2023 206e 7820 3d20 6e70 2e63       # nx = np.c
+00036200: 6c69 7028 696e 7428 7278 292c 2030 2c20  lip(int(rx), 0, 
+00036210: 3229 0a20 2020 2020 2020 2020 2020 2023  2).            #
+00036220: 206e 7920 3d20 6e70 2e63 6c69 7028 696e   ny = np.clip(in
+00036230: 7428 7279 292c 2030 2c20 3229 0a20 2020  t(ry), 0, 2).   
+00036240: 2020 2020 2020 2020 206e 7820 3d20 6e70           nx = np
+00036250: 2e63 6c69 7028 696e 7428 7278 292c 2030  .clip(int(rx), 0
+00036260: 2c20 4e44 4554 2d31 290a 2020 2020 2020  , NDET-1).      
+00036270: 2020 2020 2020 6e79 203d 206e 702e 636c        ny = np.cl
+00036280: 6970 2869 6e74 2872 7929 2c20 302c 204e  ip(int(ry), 0, N
+00036290: 4445 542d 3129 0a20 2020 2020 2020 2020  DET-1).         
+000362a0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+000362b0: 2320 7072 696e 7420 782c 2079 2c20 7278  # print x, y, rx
+000362c0: 2c20 7279 2c20 6e78 2c20 6e79 0a0a 2020  , ry, nx, ny..  
+000362d0: 2020 2020 2020 2020 2020 6678 203d 2072            fx = r
+000362e0: 782d 6e78 0a20 2020 2020 2020 2020 2020  x-nx.           
+000362f0: 2066 7920 3d20 7279 2d6e 790a 0a20 2020   fy = ry-ny..   
+00036300: 2020 2020 2020 2020 2023 2070 7366 5f78           # psf_x
+00036310: 7920 3d20 2831 2d66 7829 2a28 312d 6679  y = (1-fx)*(1-fy
+00036320: 292a 6570 7366 5b3a 2c20 3a2c 206e 782b  )*epsf[:, :, nx+
+00036330: 6e79 2a33 5d0a 2020 2020 2020 2020 2020  ny*3].          
+00036340: 2020 2320 7073 665f 7879 202b 3d20 6678    # psf_xy += fx
+00036350: 2a28 312d 6679 292a 6570 7366 5b3a 2c20  *(1-fy)*epsf[:, 
+00036360: 3a2c 2028 6e78 2b31 292b 6e79 2a33 5d0a  :, (nx+1)+ny*3].
+00036370: 2020 2020 2020 2020 2020 2020 2320 7073              # ps
+00036380: 665f 7879 202b 3d20 2831 2d66 7829 2a66  f_xy += (1-fx)*f
+00036390: 792a 6570 7366 5b3a 2c20 3a2c 206e 782b  y*epsf[:, :, nx+
+000363a0: 286e 792b 3129 2a33 5d0a 2020 2020 2020  (ny+1)*3].      
+000363b0: 2020 2020 2020 2320 7073 665f 7879 202b        # psf_xy +
+000363c0: 3d20 6678 2a66 792a 6570 7366 5b3a 2c20  = fx*fy*epsf[:, 
+000363d0: 3a2c 2028 6e78 2b31 292b 286e 792b 3129  :, (nx+1)+(ny+1)
+000363e0: 2a33 5d0a 0a20 2020 2020 2020 2020 2020  *3]..           
+000363f0: 2069 6620 4e44 4554 203d 3d20 313a 0a20   if NDET == 1:. 
+00036400: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00036410: 7366 5f78 7920 3d20 6570 7366 5b3a 2c3a  sf_xy = epsf[:,:
+00036420: 2c30 5d0a 2020 2020 2020 2020 2020 2020  ,0].            
+00036430: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00036440: 2020 2020 2020 7073 665f 7879 203d 2028        psf_xy = (
+00036450: 312d 6678 292a 2831 2d66 7929 2a65 7073  1-fx)*(1-fy)*eps
+00036460: 665b 3a2c 203a 2c20 6e78 2b6e 792a 4e44  f[:, :, nx+ny*ND
+00036470: 4554 5d0a 2020 2020 2020 2020 2020 2020  ET].            
+00036480: 2020 2020 7073 665f 7879 202b 3d20 6678      psf_xy += fx
+00036490: 2a28 312d 6679 292a 6570 7366 5b3a 2c20  *(1-fy)*epsf[:, 
+000364a0: 3a2c 2028 6e78 2b31 292b 6e79 2a4e 4445  :, (nx+1)+ny*NDE
+000364b0: 545d 0a20 2020 2020 2020 2020 2020 2020  T].             
+000364c0: 2020 2070 7366 5f78 7920 2b3d 2028 312d     psf_xy += (1-
+000364d0: 6678 292a 6679 2a65 7073 665b 3a2c 203a  fx)*fy*epsf[:, :
+000364e0: 2c20 6e78 2b28 6e79 2b31 292a 4e44 4554  , nx+(ny+1)*NDET
+000364f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00036500: 2020 7073 665f 7879 202b 3d20 6678 2a66    psf_xy += fx*f
+00036510: 792a 6570 7366 5b3a 2c20 3a2c 2028 6e78  y*epsf[:, :, (nx
+00036520: 2b31 292b 286e 792b 3129 2a4e 4445 545d  +1)+(ny+1)*NDET]
+00036530: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+00036540: 2020 2020 2020 2020 2020 2320 7073 665f            # psf_
+00036550: 7879 203d 206e 702e 726f 7439 3028 7073  xy = np.rot90(ps
+00036560: 665f 7879 2e54 2c20 3229 0a20 2020 2020  f_xy.T, 2).     
+00036570: 2020 2020 2020 2070 7366 5f78 7920 3d20         psf_xy = 
+00036580: 7073 665f 7879 2e54 0a20 2020 2020 2020  psf_xy.T.       
+00036590: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+000365a0: 2020 7365 6c66 2e65 7661 6c5f 6669 6c74    self.eval_filt
+000365b0: 6572 203d 2066 696c 7465 720a 2020 2020  er = filter.    
+000365c0: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
+000365d0: 7073 665f 7479 7065 203d 3d20 274a 5753  psf_type == 'JWS
+000365e0: 542f 324b 273a 0a20 2020 2020 2020 2020  T/2K':.         
+000365f0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00036600: 4e44 4554 203d 2069 6e74 286e 702e 7371  NDET = int(np.sq
+00036610: 7274 2865 7073 662e 7368 6170 655b 325d  rt(epsf.shape[2]
+00036620: 2929 0a20 2020 2020 2020 2020 2020 200a  )).            .
+00036630: 2020 2020 2020 2020 2020 2020 2320 2049              #  I
+00036640: 5220 6465 7465 6374 6f72 0a20 2020 2020  R detector.     
+00036650: 2020 2020 2020 2072 7820 3d20 312b 286e         rx = 1+(n
+00036660: 702e 636c 6970 2878 2c20 312c 2032 3034  p.clip(x, 1, 204
+00036670: 3729 2d30 292f 3130 3234 2e0a 2020 2020  7)-0)/1024..    
+00036680: 2020 2020 2020 2020 7279 203d 2031 2b28          ry = 1+(
+00036690: 6e70 2e63 6c69 7028 792c 2031 2c20 3230  np.clip(y, 1, 20
+000366a0: 3437 292d 3029 2f31 3032 342e 0a0a 2020  47)-0)/1024...  
+000366b0: 2020 2020 2020 2020 2020 2320 7a65 726f            # zero
+000366c0: 2069 6e64 6578 0a20 2020 2020 2020 2020   index.         
+000366d0: 2020 2072 7820 2d3d 2031 0a20 2020 2020     rx -= 1.     
+000366e0: 2020 2020 2020 2072 7920 2d3d 2031 0a0a         ry -= 1..
+000366f0: 2020 2020 2020 2020 2020 2020 6e78 203d              nx =
+00036700: 206e 702e 636c 6970 2869 6e74 2872 7829   np.clip(int(rx)
+00036710: 2c20 302c 204e 4445 542d 3129 0a20 2020  , 0, NDET-1).   
+00036720: 2020 2020 2020 2020 206e 7920 3d20 6e70           ny = np
+00036730: 2e63 6c69 7028 696e 7428 7279 292c 2030  .clip(int(ry), 0
+00036740: 2c20 4e44 4554 2d31 290a 0a20 2020 2020  , NDET-1)..     
+00036750: 2020 2020 2020 2023 2070 7269 6e74 2078         # print x
+00036760: 2c20 792c 2072 782c 2072 792c 206e 782c  , y, rx, ry, nx,
+00036770: 206e 790a 0a20 2020 2020 2020 2020 2020   ny..           
+00036780: 2066 7820 3d20 7278 2d6e 780a 2020 2020   fx = rx-nx.    
+00036790: 2020 2020 2020 2020 6679 203d 2072 792d          fy = ry-
+000367a0: 6e79 0a20 2020 2020 2020 2020 2020 200a  ny.            .
+000367b0: 2020 2020 2020 2020 2020 2020 6966 204e              if N
+000367c0: 4445 5420 3d3d 2031 3a0a 2020 2020 2020  DET == 1:.      
+000367d0: 2020 2020 2020 2020 2020 7073 665f 7879            psf_xy
+000367e0: 203d 2065 7073 665b 3a2c 3a2c 305d 0a20   = epsf[:,:,0]. 
+000367f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00036800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036810: 2070 7366 5f78 7920 3d20 2831 2d66 7829   psf_xy = (1-fx)
+00036820: 2a28 312d 6679 292a 6570 7366 5b3a 2c20  *(1-fy)*epsf[:, 
+00036830: 3a2c 206e 782b 6e79 2a4e 4445 545d 0a20  :, nx+ny*NDET]. 
+00036840: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00036850: 7366 5f78 7920 2b3d 2066 782a 2831 2d66  sf_xy += fx*(1-f
+00036860: 7929 2a65 7073 665b 3a2c 203a 2c20 286e  y)*epsf[:, :, (n
+00036870: 782b 3129 2b6e 792a 4e44 4554 5d0a 2020  x+1)+ny*NDET].  
+00036880: 2020 2020 2020 2020 2020 2020 2020 7073                ps
+00036890: 665f 7879 202b 3d20 2831 2d66 7829 2a66  f_xy += (1-fx)*f
+000368a0: 792a 6570 7366 5b3a 2c20 3a2c 206e 782b  y*epsf[:, :, nx+
+000368b0: 286e 792b 3129 2a4e 4445 545d 0a20 2020  (ny+1)*NDET].   
+000368c0: 2020 2020 2020 2020 2020 2020 2070 7366               psf
+000368d0: 5f78 7920 2b3d 2066 782a 6679 2a65 7073  _xy += fx*fy*eps
+000368e0: 665b 3a2c 203a 2c20 286e 782b 3129 2b28  f[:, :, (nx+1)+(
+000368f0: 6e79 2b31 292a 4e44 4554 5d0a 2020 2020  ny+1)*NDET].    
+00036900: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00036910: 2020 2020 2070 7366 5f78 7920 3d20 7073       psf_xy = ps
+00036920: 665f 7879 2e54 0a20 2020 2020 2020 2020  f_xy.T.         
+00036930: 2020 2023 2070 7366 5f78 7920 3d20 6e70     # psf_xy = np
+00036940: 2e72 6f74 3930 2870 7366 5f78 792e 542c  .rot90(psf_xy.T,
+00036950: 2032 290a 2020 2020 2020 2020 2020 2020   2).            
+00036960: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00036970: 662e 6576 616c 5f66 696c 7465 7220 3d20  f.eval_filter = 
+00036980: 6669 6c74 6572 0a20 2020 2020 2020 200a  filter.        .
+00036990: 2020 2020 2020 2020 656c 6966 2070 7366          elif psf
+000369a0: 5f74 7970 6520 3d3d 2027 4853 542f 4f70  _type == 'HST/Op
+000369b0: 7469 6361 6c27 3a0a 0a20 2020 2020 2020  tical':..       
+000369c0: 2020 2020 2073 6820 3d20 6570 7366 2e73       sh = epsf.s
+000369d0: 6861 7065 0a0a 2020 2020 2020 2020 2020  hape..          
+000369e0: 2020 6966 2073 685b 325d 203d 3d20 3930    if sh[2] == 90
+000369f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00036a00: 2020 2320 4143 5320 5746 430a 2020 2020    # ACS WFC.    
+00036a10: 2020 2020 2020 2020 2020 2020 6958 2c20              iX, 
+00036a20: 6959 203d 2039 2c20 3130 2020 2320 392c  iY = 9, 10  # 9,
+00036a30: 2031 300a 2020 2020 2020 2020 2020 2020   10.            
+00036a40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00036a50: 2020 2020 2020 2320 5556 4953 0a20 2020        # UVIS.   
+00036a60: 2020 2020 2020 2020 2020 2020 2069 582c               iX,
+00036a70: 2069 5920 3d20 372c 2038 0a0a 2020 2020   iY = 7, 8..    
+00036a80: 2020 2020 2020 2020 7278 203d 2031 2b28          rx = 1+(
+00036a90: 6e70 2e63 6c69 7028 782c 2031 2c20 3430  np.clip(x, 1, 40
+00036aa0: 3935 292d 3029 2f28 3430 3936 2f28 6958  95)-0)/(4096/(iX
+00036ab0: 2d31 2929 0a20 2020 2020 2020 2020 2020  -1)).           
+00036ac0: 2072 7920 3d20 312b 286e 702e 636c 6970   ry = 1+(np.clip
+00036ad0: 2879 2c20 312c 2034 3039 3529 2d30 292f  (y, 1, 4095)-0)/
+00036ae0: 2834 3039 362f 2869 592d 3129 290a 0a20  (4096/(iY-1)).. 
+00036af0: 2020 2020 2020 2020 2020 2023 207a 6572             # zer
+00036b00: 6f20 696e 6465 780a 2020 2020 2020 2020  o index.        
+00036b10: 2020 2020 7278 202d 3d20 310a 2020 2020      rx -= 1.    
+00036b20: 2020 2020 2020 2020 7279 202d 3d20 310a          ry -= 1.
+00036b30: 0a20 2020 2020 2020 2020 2020 206e 7820  .            nx 
+00036b40: 3d20 6e70 2e63 6c69 7028 6e70 2e63 6173  = np.clip(np.cas
+00036b50: 745b 696e 745d 2872 7829 2c20 302c 2069  t[int](rx), 0, i
+00036b60: 582d 3129 0a20 2020 2020 2020 2020 2020  X-1).           
+00036b70: 206e 7920 3d20 6e70 2e63 6c69 7028 6e70   ny = np.clip(np
+00036b80: 2e63 6173 745b 696e 745d 2872 7929 2c20  .cast[int](ry), 
+00036b90: 302c 2069 592d 3129 0a0a 2020 2020 2020  0, iY-1)..      
+00036ba0: 2020 2020 2020 2320 7072 696e 7420 782c        # print x,
+00036bb0: 2079 2c20 7278 2c20 7279 2c20 6e78 2c20   y, rx, ry, nx, 
+00036bc0: 6e79 0a0a 2020 2020 2020 2020 2020 2020  ny..            
+00036bd0: 6678 203d 2072 782d 6e78 0a20 2020 2020  fx = rx-nx.     
+00036be0: 2020 2020 2020 2066 7920 3d20 7279 2d6e         fy = ry-n
+00036bf0: 790a 0a20 2020 2020 2020 2020 2020 2070  y..            p
+00036c00: 7366 5f78 7920 3d20 2831 2d66 7829 2a28  sf_xy = (1-fx)*(
+00036c10: 312d 6679 292a 6570 7366 5b3a 2c20 3a2c  1-fy)*epsf[:, :,
+00036c20: 206e 782b 6e79 2a69 585d 0a20 2020 2020   nx+ny*iX].     
+00036c30: 2020 2020 2020 2070 7366 5f78 7920 2b3d         psf_xy +=
+00036c40: 2066 782a 2831 2d66 7929 2a65 7073 665b   fx*(1-fy)*epsf[
+00036c50: 3a2c 203a 2c20 286e 782b 3129 2b6e 792a  :, :, (nx+1)+ny*
+00036c60: 6958 5d0a 2020 2020 2020 2020 2020 2020  iX].            
+00036c70: 7073 665f 7879 202b 3d20 2831 2d66 7829  psf_xy += (1-fx)
+00036c80: 2a66 792a 6570 7366 5b3a 2c20 3a2c 206e  *fy*epsf[:, :, n
+00036c90: 782b 286e 792b 3129 2a69 585d 0a20 2020  x+(ny+1)*iX].   
+00036ca0: 2020 2020 2020 2020 2070 7366 5f78 7920           psf_xy 
+00036cb0: 2b3d 2066 782a 6679 2a65 7073 665b 3a2c  += fx*fy*epsf[:,
+00036cc0: 203a 2c20 286e 782b 3129 2b28 6e79 2b31   :, (nx+1)+(ny+1
+00036cd0: 292a 6958 5d0a 0a20 2020 2020 2020 2020  )*iX]..         
+00036ce0: 2020 2073 656c 662e 6576 616c 5f66 696c     self.eval_fil
+00036cf0: 7465 7220 3d20 6669 6c74 6572 0a20 2020  ter = filter.   
+00036d00: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+00036d10: 2072 6f74 3930 2021 3d20 303a 0a20 2020   rot90 != 0:.   
+00036d20: 2020 2020 2020 2020 2073 656c 662e 7073           self.ps
+00036d30: 665f 7879 5f72 6f74 3930 203d 2072 6f74  f_xy_rot90 = rot
+00036d40: 3930 0a20 2020 2020 2020 2020 2020 2070  90.            p
+00036d50: 7366 5f78 7920 3d20 6e70 2e72 6f74 3930  sf_xy = np.rot90
+00036d60: 2870 7366 5f78 792c 2072 6f74 3930 290a  (psf_xy, rot90).
+00036d70: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00036d80: 2020 2020 2072 6574 7572 6e20 7073 665f       return psf_
+00036d90: 7879 0a0a 2020 2020 6465 6620 6576 616c  xy..    def eval
+00036da0: 5f65 5053 4628 7365 6c66 2c20 7073 665f  _ePSF(self, psf_
+00036db0: 7879 2c20 6478 2c20 6479 2c20 726f 7439  xy, dx, dy, rot9
+00036dc0: 303d 302c 2065 7874 656e 6465 645f 6461  0=0, extended_da
+00036dd0: 7461 3d4e 6f6e 6529 3a0a 2020 2020 2020  ta=None):.      
+00036de0: 2020 2222 2245 7661 6c75 6174 6520 5053    """Evaluate PS
+00036df0: 4620 6174 2064 782c 6479 2063 6f6f 7264  F at dx,dy coord
+00036e00: 696e 6174 6573 0a0a 2020 2020 2020 2020  inates..        
+00036e10: 5442 440a 2020 2020 2020 2020 2222 220a  TBD.        """.
+00036e20: 2020 2020 2020 2020 2320 536f 206d 7563          # So muc
+00036e30: 6820 6661 7374 6572 2074 6861 6e20 7363  h faster than sc
+00036e40: 6970 792e 696e 7465 7270 6f6c 6174 652e  ipy.interpolate.
+00036e50: 6772 6964 6461 7461 210a 2020 2020 2020  griddata!.      
+00036e60: 2020 6672 6f6d 2073 6369 7079 2e6e 6469    from scipy.ndi
+00036e70: 6d61 6765 2069 6d70 6f72 7420 6d61 705f  mage import map_
+00036e80: 636f 6f72 6469 6e61 7465 730a 0a20 2020  coordinates..   
+00036e90: 2020 2020 2023 2065 5053 4620 6f6e 6c79       # ePSF only
+00036ea0: 2064 6566 696e 6564 2074 6f20 3132 2e35   defined to 12.5
+00036eb0: 2070 6978 656c 730a 2020 2020 2020 2020   pixels.        
+00036ec0: 6966 2073 656c 662e 6576 616c 5f70 7366  if self.eval_psf
+00036ed0: 5f74 7970 6520 696e 205b 2757 4643 332f  _type in ['WFC3/
+00036ee0: 4952 272c 2748 5354 2f4f 7074 6963 616c  IR','HST/Optical
+00036ef0: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
+00036f00: 6f6b 203d 2028 6e70 2e61 6273 2864 7829  ok = (np.abs(dx)
+00036f10: 203c 3d20 3132 2e35 2920 2620 286e 702e   <= 12.5) & (np.
+00036f20: 6162 7328 6479 2920 3c3d 2031 322e 3529  abs(dy) <= 12.5)
+00036f30: 0a20 2020 2020 2020 2020 2020 2063 6f6f  .            coo
+00036f40: 7264 7320 3d20 6e70 2e61 7272 6179 285b  rds = np.array([
+00036f50: 3530 2b34 2a64 785b 6f6b 5d2c 2035 302b  50+4*dx[ok], 50+
+00036f60: 342a 6479 5b6f 6b5d 5d29 0a20 2020 2020  4*dy[ok]]).     
+00036f70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00036f80: 2020 2020 2023 204a 5753 5420 6172 6520       # JWST are 
+00036f90: 2b2f 2d20 3332 2070 6978 656c 730a 2020  +/- 32 pixels.  
+00036fa0: 2020 2020 2020 2020 2020 7368 203d 2070            sh = p
+00036fb0: 7366 5f78 792e 7368 6170 650a 2020 2020  sf_xy.shape.    
+00036fc0: 2020 2020 2020 2020 5f73 697a 6520 3d20          _size = 
+00036fd0: 2873 685b 305d 2d31 292f 2f34 0a20 2020  (sh[0]-1)//4.   
+00036fe0: 2020 2020 2020 2020 205f 7830 203d 205f           _x0 = _
+00036ff0: 7369 7a65 2a32 0a20 2020 2020 2020 2020  size*2.         
+00037000: 2020 205f 6365 6e20 3d20 285f 7830 2d31     _cen = (_x0-1
+00037010: 292f 2f32 0a20 2020 2020 2020 2020 2020  )//2.           
+00037020: 206f 6b20 3d20 286e 702e 6162 7328 6478   ok = (np.abs(dx
+00037030: 2920 3c3d 205f 6365 6e29 2026 2028 6e70  ) <= _cen) & (np
+00037040: 2e61 6273 2864 7929 203c 3d20 5f63 656e  .abs(dy) <= _cen
+00037050: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+00037060: 6f72 6473 203d 206e 702e 6172 7261 7928  ords = np.array(
+00037070: 5b5f 7830 2b34 2a64 785b 6f6b 5d2c 205f  [_x0+4*dx[ok], _
+00037080: 7830 2b34 2a64 795b 6f6b 5d5d 290a 0a20  x0+4*dy[ok]]).. 
+00037090: 2020 2020 2020 2023 2044 6f20 7468 6520         # Do the 
+000370a0: 696e 7465 7270 6f6c 6174 696f 6e0a 2020  interpolation.  
+000370b0: 2020 2020 2020 696e 7465 7270 5f6d 6170        interp_map
+000370c0: 203d 206d 6170 5f63 6f6f 7264 696e 6174   = map_coordinat
+000370d0: 6573 2870 7366 5f78 792c 2063 6f6f 7264  es(psf_xy, coord
+000370e0: 732c 206f 7264 6572 3d33 290a 0a20 2020  s, order=3)..   
+000370f0: 2020 2020 2023 2046 696c 6c20 6f75 7470       # Fill outp
+00037100: 7574 2064 6174 610a 2020 2020 2020 2020  ut data.        
+00037110: 6f75 7420 3d20 6e70 2e7a 6572 6f73 5f6c  out = np.zeros_l
+00037120: 696b 6528 6478 2c20 6474 7970 653d 6e70  ike(dx, dtype=np
+00037130: 2e66 6c6f 6174 3332 290a 2020 2020 2020  .float32).      
+00037140: 2020 6f75 745b 6f6b 5d20 3d20 696e 7465    out[ok] = inte
+00037150: 7270 5f6d 6170 0a0a 2020 2020 2020 2020  rp_map..        
+00037160: 2320 4578 7465 6e64 6564 2050 5346 0a20  # Extended PSF. 
+00037170: 2020 2020 2020 2069 6620 6578 7465 6e64         if extend
+00037180: 6564 5f64 6174 6120 6973 206e 6f74 204e  ed_data is not N
+00037190: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000371a0: 206f 6b20 3d20 286e 702e 6162 7328 6478   ok = (np.abs(dx
+000371b0: 2920 3c20 7365 6c66 2e65 7874 656e 6465  ) < self.extende
+000371c0: 645f 4e29 200a 2020 2020 2020 2020 2020  d_N) .          
+000371d0: 2020 6f6b 2026 3d20 286e 702e 6162 7328    ok &= (np.abs(
+000371e0: 6479 2920 3c20 7365 6c66 2e65 7874 656e  dy) < self.exten
+000371f0: 6465 645f 4e29 0a20 2020 2020 2020 2020  ded_N).         
+00037200: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00037210: 7830 203d 2073 656c 662e 6578 7465 6e64  x0 = self.extend
+00037220: 6564 5f4e 0a20 2020 2020 2020 2020 2020  ed_N.           
+00037230: 2063 6f6f 7264 7320 3d20 6e70 2e61 7272   coords = np.arr
+00037240: 6179 285b 7830 2b64 795b 6f6b 5d2b 302c  ay([x0+dy[ok]+0,
+00037250: 2078 302b 6478 5b6f 6b5d 5d29 0a20 2020   x0+dx[ok]]).   
+00037260: 2020 2020 2020 2020 2069 6e74 6572 705f           interp_
+00037270: 6d61 7020 3d20 6d61 705f 636f 6f72 6469  map = map_coordi
+00037280: 6e61 7465 7328 6578 7465 6e64 6564 5f64  nates(extended_d
+00037290: 6174 612c 2063 6f6f 7264 732c 206f 7264  ata, coords, ord
+000372a0: 6572 3d30 290a 2020 2020 2020 2020 2020  er=0).          
+000372b0: 2020 6f75 745b 6f6b 5d20 2b3d 2069 6e74    out[ok] += int
+000372c0: 6572 705f 6d61 700a 0a20 2020 2020 2020  erp_map..       
+000372d0: 2072 6574 7572 6e20 6f75 740a 0a20 2020   return out..   
+000372e0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+000372f0: 2020 2064 6566 206f 626a 6563 7469 7665     def objective
+00037300: 5f65 7073 665f 6365 6e74 6572 2870 6172  _epsf_center(par
+00037310: 616d 732c 2073 656c 662c 2070 7366 5f78  ams, self, psf_x
+00037320: 792c 2073 6369 2c20 6976 6172 2c20 7870  y, sci, ivar, xp
+00037330: 2c20 7970 2c20 6578 7465 6e64 6564 5f64  , yp, extended_d
+00037340: 6174 612c 2072 6574 2c20 6473 3929 3a0a  ata, ret, ds9):.
+00037350: 2020 2020 2020 2020 2222 224f 626a 6563          """Objec
+00037360: 7469 7665 2066 756e 6374 696f 6e20 666f  tive function fo
+00037370: 7220 6669 7474 696e 6720 6550 5346 730a  r fitting ePSFs.
+00037380: 0a20 2020 2020 2020 2054 4244 0a0a 2020  .        TBD..  
+00037390: 2020 2020 2020 7061 7261 6d73 203d 205b        params = [
+000373a0: 6e6f 726d 616c 697a 6174 696f 6e2c 2078  normalization, x
+000373b0: 632c 2079 632c 2062 6163 6b67 726f 756e  c, yc, backgroun
+000373c0: 645d 0a20 2020 2020 2020 2022 2222 0a20  d].        """. 
+000373d0: 2020 2020 2020 2066 726f 6d20 6e75 6d70         from nump
+000373e0: 792e 6c69 6e61 6c67 2069 6d70 6f72 7420  y.linalg import 
+000373f0: 6c73 7473 710a 0a20 2020 2020 2020 2073  lstsq..        s
+00037400: 6820 3d20 7363 692e 7368 6170 650a 2020  h = sci.shape.  
+00037410: 2020 2020 2020 7930 2c20 7830 203d 206e        y0, x0 = n
+00037420: 702e 6172 7261 7928 7368 292f 322e 2d31  p.array(sh)/2.-1
+00037430: 0a0a 2020 2020 2020 2020 6478 203d 2078  ..        dx = x
+00037440: 702d 7061 7261 6d73 5b30 5d0a 2020 2020  p-params[0].    
+00037450: 2020 2020 6479 203d 2079 702d 7061 7261      dy = yp-para
+00037460: 6d73 5b31 5d0a 0a20 2020 2020 2020 2064  ms[1]..        d
+00037470: 6478 203d 2078 7020 2023 202d 7830 0a20  dx = xp  # -x0. 
+00037480: 2020 2020 2020 2064 6479 203d 2079 7020         ddy = yp 
+00037490: 2023 202d 7930 0a0a 2020 2020 2020 2020   # -y0..        
+000374a0: 6464 7820 3d20 6464 782f 6464 782e 6d61  ddx = ddx/ddx.ma
+000374b0: 7828 290a 2020 2020 2020 2020 6464 7920  x().        ddy 
+000374c0: 3d20 6464 792f 6464 792e 6d61 7828 290a  = ddy/ddy.max().
+000374d0: 0a20 2020 2020 2020 2023 2062 6b67 203d  .        # bkg =
+000374e0: 2070 6172 616d 735b 335d 202b 2070 6172   params[3] + par
+000374f0: 616d 735b 345d 2a64 6478 202b 2070 6172  ams[4]*ddx + par
+00037500: 616d 735b 355d 2a64 6479 2023 2b20 7061  ams[5]*ddy #+ pa
+00037510: 7261 6d73 5b36 5d2a 6464 782a 6464 790a  rams[6]*ddx*ddy.
+00037520: 0a20 2020 2020 2020 2070 7366 5f6f 6666  .        psf_off
+00037530: 7365 7420 3d20 7365 6c66 2e65 7661 6c5f  set = self.eval_
+00037540: 6550 5346 2870 7366 5f78 792c 2064 782c  ePSF(psf_xy, dx,
+00037550: 2064 792c 2065 7874 656e 6465 645f 6461   dy, extended_da
+00037560: 7461 3d65 7874 656e 6465 645f 6461 7461  ta=extended_data
+00037570: 2920 2023 202a 7061 7261 6d73 5b30 5d0a  )  # *params[0].
+00037580: 0a20 2020 2020 2020 2041 203d 2028 6e70  .        A = (np
+00037590: 2e61 7272 6179 285b 7073 665f 6f66 6673  .array([psf_offs
+000375a0: 6574 2c20 6e70 2e6f 6e65 735f 6c69 6b65  et, np.ones_like
+000375b0: 2873 6369 292c 2064 6478 2c20 6464 795d  (sci), ddx, ddy]
+000375c0: 292a 6e70 2e73 7172 7428 6976 6172 2929  )*np.sqrt(ivar))
+000375d0: 2e72 6573 6861 7065 2828 342c 202d 3129  .reshape((4, -1)
+000375e0: 290a 2020 2020 2020 2020 7363 6966 203d  ).        scif =
+000375f0: 2028 7363 692a 6e70 2e73 7172 7428 6976   (sci*np.sqrt(iv
+00037600: 6172 2929 2e66 6c61 7474 656e 2829 0a20  ar)).flatten(). 
+00037610: 2020 2020 2020 206d 6173 6b20 3d20 2873         mask = (s
+00037620: 6369 6620 213d 2030 290a 2020 2020 2020  cif != 0).      
+00037630: 2020 636f 6566 6673 2c20 5f72 6573 6964    coeffs, _resid
+00037640: 2c20 5f72 616e 6b2c 205f 7320 3d20 6c73  , _rank, _s = ls
+00037650: 7473 7128 415b 3a2c 206d 6173 6b5d 2e54  tsq(A[:, mask].T
+00037660: 2c20 7363 6966 5b6d 6173 6b5d 2c20 0a20  , scif[mask], . 
+00037670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037690: 2020 2020 2020 2020 2072 636f 6e64 3d4c           rcond=L
+000376a0: 5354 5351 5f52 434f 4e44 290a 2020 2020  STSQ_RCOND).    
+000376b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000376c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000376d0: 2020 2020 2020 0a20 2020 2020 2020 2072        .        r
+000376e0: 6573 6964 203d 2028 7363 6966 202d 206e  esid = (scif - n
+000376f0: 702e 646f 7428 636f 6566 6673 2c20 4129  p.dot(coeffs, A)
+00037700: 290a 0a20 2020 2020 2020 2069 6620 6473  )..        if ds
+00037710: 393a 0a20 2020 2020 2020 2020 2020 2041  9:.            A
+00037720: 7820 3d20 286e 702e 6172 7261 7928 5b70  x = (np.array([p
+00037730: 7366 5f6f 6666 7365 742c 206e 702e 6f6e  sf_offset, np.on
+00037740: 6573 5f6c 696b 6528 7363 6929 2c20 6464  es_like(sci), dd
+00037750: 782c 2064 6479 5d29 292e 7265 7368 6170  x, ddy])).reshap
+00037760: 6528 2834 2c20 2d31 2929 0a20 2020 2020  e((4, -1)).     
+00037770: 2020 2020 2020 2070 7366 5f6d 6f64 656c         psf_model
+00037780: 203d 206e 702e 646f 7428 636f 6566 6673   = np.dot(coeffs
+00037790: 5b3a 315d 2c20 4178 5b3a 312c 203a 5d29  [:1], Ax[:1, :])
+000377a0: 2e72 6573 6861 7065 2873 6369 2e73 6861  .reshape(sci.sha
+000377b0: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+000377c0: 626b 6720 3d20 6e70 2e64 6f74 2863 6f65  bkg = np.dot(coe
+000377d0: 6666 735b 313a 5d2c 2041 785b 313a 2c20  ffs[1:], Ax[1:, 
+000377e0: 3a5d 292e 7265 7368 6170 6528 7363 692e  :]).reshape(sci.
+000377f0: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
+00037800: 2020 2064 7339 2e76 6965 7728 2873 6369     ds9.view((sci
+00037810: 2d70 7366 5f6d 6f64 656c 2d62 6b67 292a  -psf_model-bkg)*
+00037820: 6d61 736b 2e72 6573 6861 7065 2873 6369  mask.reshape(sci
+00037830: 2e73 6861 7065 2929 0a0a 2020 2020 2020  .shape))..      
+00037840: 2020 6966 2072 6574 203d 3d20 2772 6573    if ret == 'res
+00037850: 6964 273a 0a20 2020 2020 2020 2020 2020  id':.           
+00037860: 2072 6574 7572 6e20 7265 7369 640a 2020   return resid.  
+00037870: 2020 2020 2020 656c 6966 2072 6574 203d        elif ret =
+00037880: 3d20 276c 6d27 3a0a 2020 2020 2020 2020  = 'lm':.        
+00037890: 2020 2020 2320 6d61 736b 6564 2072 6573      # masked res
+000378a0: 6964 7561 6c73 2066 6f72 204c 4d20 6f70  iduals for LM op
+000378b0: 7469 6d69 7a61 7469 6f6e 0a20 2020 2020  timization.     
+000378c0: 2020 2020 2020 2069 6620 4661 6c73 653a         if False:
+000378d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000378e0: 2070 7269 6e74 2870 6172 616d 732c 2028   print(params, (
+000378f0: 7265 7369 642a 2a32 292e 7375 6d28 292c  resid**2).sum(),
+00037900: 2063 6f65 6666 735b 305d 290a 0a20 2020   coeffs[0])..   
+00037910: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00037920: 7265 7369 645b 7265 7369 6420 213d 2030  resid[resid != 0
+00037930: 5d0a 2020 2020 2020 2020 656c 6966 2072  ].        elif r
+00037940: 6574 203d 3d20 276d 6f64 656c 273a 0a20  et == 'model':. 
+00037950: 2020 2020 2020 2020 2020 2041 7820 3d20             Ax = 
+00037960: 286e 702e 6172 7261 7928 5b70 7366 5f6f  (np.array([psf_o
+00037970: 6666 7365 742c 206e 702e 6f6e 6573 5f6c  ffset, np.ones_l
+00037980: 696b 6528 7363 6929 2c20 6464 782c 2064  ike(sci), ddx, d
+00037990: 6479 5d29 292e 7265 7368 6170 6528 2834  dy])).reshape((4
+000379a0: 2c20 2d31 2929 0a20 2020 2020 2020 2020  , -1)).         
+000379b0: 2020 2070 7366 5f6d 6f64 656c 203d 206e     psf_model = n
+000379c0: 702e 646f 7428 636f 6566 6673 5b3a 315d  p.dot(coeffs[:1]
+000379d0: 2c20 4178 5b3a 312c 203a 5d29 2e72 6573  , Ax[:1, :]).res
+000379e0: 6861 7065 2873 6369 2e73 6861 7065 290a  hape(sci.shape).
+000379f0: 2020 2020 2020 2020 2020 2020 626b 6720              bkg 
+00037a00: 3d20 6e70 2e64 6f74 2863 6f65 6666 735b  = np.dot(coeffs[
+00037a10: 313a 5d2c 2041 785b 313a 2c20 3a5d 292e  1:], Ax[1:, :]).
+00037a20: 7265 7368 6170 6528 7363 692e 7368 6170  reshape(sci.shap
+00037a30: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+00037a40: 6574 7572 6e20 7073 665f 6d6f 6465 6c2c  eturn psf_model,
+00037a50: 2062 6b67 2c20 4178 2c20 636f 6566 6673   bkg, Ax, coeffs
+00037a60: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00037a70: 2020 2020 2020 2020 2020 2063 6869 3220             chi2 
+00037a80: 3d20 2872 6573 6964 2a2a 3229 2e73 756d  = (resid**2).sum
+00037a90: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
+00037aa0: 7072 696e 7428 7061 7261 6d73 2c20 6368  print(params, ch
+00037ab0: 6932 2c20 636f 6566 6673 5b30 5d29 0a20  i2, coeffs[0]). 
+00037ac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00037ad0: 6e20 6368 6932 0a0a 2020 2020 4073 7461  n chi2..    @sta
+00037ae0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+00037af0: 6620 6f62 6a65 6374 6976 655f 6570 7366  f objective_epsf
+00037b00: 2870 6172 616d 732c 2073 656c 662c 2070  (params, self, p
+00037b10: 7366 5f78 792c 2073 6369 2c20 6976 6172  sf_xy, sci, ivar
+00037b20: 2c20 7870 2c20 7970 2c20 6578 7465 6e64  , xp, yp, extend
+00037b30: 6564 5f64 6174 612c 2072 6574 2c20 6473  ed_data, ret, ds
+00037b40: 3929 3a0a 2020 2020 2020 2020 2222 224f  9):.        """O
+00037b50: 626a 6563 7469 7665 2066 756e 6374 696f  bjective functio
+00037b60: 6e20 666f 7220 6669 7474 696e 6720 6550  n for fitting eP
+00037b70: 5346 730a 0a20 2020 2020 2020 2054 4244  SFs..        TBD
+00037b80: 0a0a 2020 2020 2020 2020 7061 7261 6d73  ..        params
+00037b90: 203d 205b 6e6f 726d 616c 697a 6174 696f   = [normalizatio
+00037ba0: 6e2c 2078 632c 2079 632c 2062 6163 6b67  n, xc, yc, backg
+00037bb0: 726f 756e 645d 0a20 2020 2020 2020 2022  round].        "
+00037bc0: 2222 0a20 2020 2020 2020 2064 7820 3d20  "".        dx = 
+00037bd0: 7870 2d70 6172 616d 735b 315d 0a20 2020  xp-params[1].   
+00037be0: 2020 2020 2064 7920 3d20 7970 2d70 6172       dy = yp-par
+00037bf0: 616d 735b 325d 0a0a 2020 2020 2020 2020  ams[2]..        
+00037c00: 6464 7820 3d20 7870 2d78 702e 6d69 6e28  ddx = xp-xp.min(
+00037c10: 290a 2020 2020 2020 2020 6464 7920 3d20  ).        ddy = 
+00037c20: 7970 2d79 702e 6d69 6e28 290a 0a20 2020  yp-yp.min()..   
+00037c30: 2020 2020 2064 6478 203d 2064 6478 2f64       ddx = ddx/d
+00037c40: 6478 2e6d 6178 2829 0a20 2020 2020 2020  dx.max().       
+00037c50: 2064 6479 203d 2064 6479 2f64 6479 2e6d   ddy = ddy/ddy.m
+00037c60: 6178 2829 0a0a 2020 2020 2020 2020 626b  ax()..        bk
+00037c70: 6720 3d20 7061 7261 6d73 5b33 5d20 2b20  g = params[3] + 
+00037c80: 7061 7261 6d73 5b34 5d2a 6464 7820 2b20  params[4]*ddx + 
+00037c90: 7061 7261 6d73 5b35 5d2a 6464 7920 2023  params[5]*ddy  #
+00037ca0: 202b 2070 6172 616d 735b 365d 2a64 6478   + params[6]*ddx
+00037cb0: 2a64 6479 0a0a 2020 2020 2020 2020 7073  *ddy..        ps
+00037cc0: 665f 6f66 6673 6574 203d 2073 656c 662e  f_offset = self.
+00037cd0: 6576 616c 5f65 5053 4628 7073 665f 7879  eval_ePSF(psf_xy
+00037ce0: 2c20 6478 2c20 6479 2c20 6578 7465 6e64  , dx, dy, extend
+00037cf0: 6564 5f64 6174 613d 6578 7465 6e64 6564  ed_data=extended
+00037d00: 5f64 6174 6129 2a70 6172 616d 735b 305d  _data)*params[0]
+00037d10: 0a0a 2020 2020 2020 2020 7265 7369 6420  ..        resid 
+00037d20: 3d20 2873 6369 2d70 7366 5f6f 6666 7365  = (sci-psf_offse
+00037d30: 742d 626b 6729 2a6e 702e 7371 7274 2869  t-bkg)*np.sqrt(i
+00037d40: 7661 7229 0a0a 2020 2020 2020 2020 6966  var)..        if
+00037d50: 2064 7339 3a0a 2020 2020 2020 2020 2020   ds9:.          
+00037d60: 2020 6473 392e 7669 6577 2873 6369 2d70    ds9.view(sci-p
+00037d70: 7366 5f6f 6666 7365 742d 626b 6729 0a0a  sf_offset-bkg)..
+00037d80: 2020 2020 2020 2020 6966 2072 6574 203d          if ret =
+00037d90: 3d20 2772 6573 6964 273a 0a20 2020 2020  = 'resid':.     
+00037da0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00037db0: 7369 640a 2020 2020 2020 2020 656c 6966  sid.        elif
+00037dc0: 2072 6574 203d 3d20 276c 6d27 3a0a 2020   ret == 'lm':.  
+00037dd0: 2020 2020 2020 2020 2020 2320 6d61 736b            # mask
+00037de0: 6564 2072 6573 6964 7561 6c73 2066 6f72  ed residuals for
+00037df0: 204c 4d20 6f70 7469 6d69 7a61 7469 6f6e   LM optimization
+00037e00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00037e10: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
+00037e20: 2020 2020 2020 2070 7269 6e74 2870 6172         print(par
+00037e30: 616d 732c 2028 7265 7369 642a 2a32 292e  ams, (resid**2).
+00037e40: 7375 6d28 2929 0a0a 2020 2020 2020 2020  sum())..        
+00037e50: 2020 2020 7265 7475 726e 2072 6573 6964      return resid
+00037e60: 5b72 6573 6964 2021 3d20 305d 0a20 2020  [resid != 0].   
+00037e70: 2020 2020 2065 6c69 6620 7265 7420 3d3d       elif ret ==
+00037e80: 2027 6d6f 6465 6c27 3a0a 2020 2020 2020   'model':.      
+00037e90: 2020 2020 2020 7265 7475 726e 2070 7366        return psf
+00037ea0: 5f6f 6666 7365 742c 2062 6b67 2c20 4e6f  _offset, bkg, No
+00037eb0: 6e65 2c20 4e6f 6e65 0a20 2020 2020 2020  ne, None.       
+00037ec0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00037ed0: 2020 2063 6869 3220 3d20 2872 6573 6964     chi2 = (resid
+00037ee0: 2a2a 3229 2e73 756d 2829 0a20 2020 2020  **2).sum().     
+00037ef0: 2020 2020 2020 2023 7072 696e 7428 7061         #print(pa
+00037f00: 7261 6d73 2c20 6368 6932 290a 2020 2020  rams, chi2).    
+00037f10: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00037f20: 6869 320a 0a20 2020 2064 6566 2066 6974  hi2..    def fit
+00037f30: 5f65 5053 4628 7365 6c66 2c20 7363 692c  _ePSF(self, sci,
+00037f40: 2063 656e 7465 723d 4e6f 6e65 2c20 6f72   center=None, or
+00037f50: 6967 696e 3d5b 302c 2030 5d2c 2069 7661  igin=[0, 0], iva
+00037f60: 723d 312c 204e 3d37 2c0a 2020 2020 2020  r=1, N=7,.      
+00037f70: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+00037f80: 723d 2746 3134 3057 272c 2074 6f6c 3d31  r='F140W', tol=1
+00037f90: 2e65 2d34 2c20 6775 6573 733d 4e6f 6e65  .e-4, guess=None
+00037fa0: 2c20 6765 745f 6578 7465 6e64 6564 3d46  , get_extended=F
+00037fb0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00037fc0: 2020 2020 2020 206d 6574 686f 643d 276c         method='l
+00037fd0: 6d27 2c20 6473 393d 4e6f 6e65 2c20 7073  m', ds9=None, ps
+00037fe0: 665f 7061 7261 6d73 3d4e 6f6e 652c 206f  f_params=None, o
+00037ff0: 6e6c 795f 6365 6e74 6572 696e 673d 5472  nly_centering=Tr
+00038000: 7565 2c20 0a20 2020 2020 2020 2020 2020  ue, .           
+00038010: 2020 2020 2020 726f 7439 303d 3029 3a0a        rot90=0):.
+00038020: 2020 2020 2020 2020 2222 2246 6974 2065          """Fit e
+00038030: 5053 4620 746f 2069 6e70 7574 2064 6174  PSF to input dat
+00038040: 610a 2020 2020 2020 2020 5442 440a 2020  a.        TBD.  
+00038050: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00038060: 2020 6672 6f6d 2073 6369 7079 2e6f 7074    from scipy.opt
+00038070: 696d 697a 6520 696d 706f 7274 206d 696e  imize import min
+00038080: 696d 697a 652c 206c 6561 7374 5f73 7175  imize, least_squ
+00038090: 6172 6573 0a0a 2020 2020 2020 2020 7368  ares..        sh
+000380a0: 203d 2073 6369 2e73 6861 7065 0a20 2020   = sci.shape.   
+000380b0: 2020 2020 2069 6620 6365 6e74 6572 2069       if center i
+000380c0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000380d0: 2020 2020 7930 2c20 7830 203d 206e 702e      y0, x0 = np.
+000380e0: 6172 7261 7928 7368 292f 322e 2d31 0a20  array(sh)/2.-1. 
+000380f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00038100: 2020 2020 2020 2020 2078 302c 2079 3020           x0, y0 
+00038110: 3d20 6365 6e74 6572 0a0a 2020 2020 2020  = center..      
+00038120: 2020 7864 203d 2078 302b 6f72 6967 696e    xd = x0+origin
+00038130: 5b31 5d0a 2020 2020 2020 2020 7964 203d  [1].        yd =
+00038140: 2079 302b 6f72 6967 696e 5b30 5d0a 0a20   y0+origin[0].. 
+00038150: 2020 2020 2020 2078 632c 2079 6320 3d20         xc, yc = 
+00038160: 696e 7428 7830 292c 2069 6e74 2879 3029  int(x0), int(y0)
+00038170: 0a0a 2020 2020 2020 2020 7073 665f 7879  ..        psf_xy
+00038180: 203d 2073 656c 662e 6765 745f 6174 5f70   = self.get_at_p
+00038190: 6f73 6974 696f 6e28 783d 7864 2c20 793d  osition(x=xd, y=
+000381a0: 7964 2c20 6669 6c74 6572 3d66 696c 7465  yd, filter=filte
+000381b0: 722c 2072 6f74 3930 3d72 6f74 3930 290a  r, rot90=rot90).
+000381c0: 0a20 2020 2020 2020 2079 702c 2078 7020  .        yp, xp 
+000381d0: 3d20 6e70 2e69 6e64 6963 6573 2873 6829  = np.indices(sh)
+000381e0: 0a0a 2020 2020 2020 2020 6966 2067 7565  ..        if gue
+000381f0: 7373 2069 7320 4e6f 6e65 3a0a 2020 2020  ss is None:.    
+00038200: 2020 2020 2020 2020 6966 206e 702e 6973          if np.is
+00038210: 7363 616c 6172 2869 7661 7229 3a0a 2020  scalar(ivar):.  
+00038220: 2020 2020 2020 2020 2020 2020 2020 6978                ix
+00038230: 203d 206e 702e 6172 676d 6178 2873 6369   = np.argmax(sci
+00038240: 2e66 6c61 7474 656e 2829 290a 2020 2020  .flatten()).    
+00038250: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00038260: 2020 2020 2020 2020 2020 2020 2020 6978                ix
+00038270: 203d 206e 702e 6172 676d 6178 2828 7363   = np.argmax((sc
+00038280: 692a 2869 7661 7220 3e20 3029 292e 666c  i*(ivar > 0)).fl
+00038290: 6174 7465 6e28 2929 0a0a 2020 2020 2020  atten())..      
+000382a0: 2020 2020 2020 7867 7565 7373 203d 2078        xguess = x
+000382b0: 702e 666c 6174 7465 6e28 295b 6978 5d0a  p.flatten()[ix].
+000382c0: 2020 2020 2020 2020 2020 2020 7967 7565              ygue
+000382d0: 7373 203d 2079 702e 666c 6174 7465 6e28  ss = yp.flatten(
+000382e0: 295b 6978 5d0a 2020 2020 2020 2020 656c  )[ix].        el
+000382f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00038300: 7867 7565 7373 2c20 7967 7565 7373 203d  xguess, yguess =
+00038310: 2067 7565 7373 0a0a 2020 2020 2020 2020   guess..        
+00038320: 6d65 645f 626b 6720 3d20 6e70 2e6d 6564  med_bkg = np.med
+00038330: 6961 6e28 7363 6929 0a0a 2020 2020 2020  ian(sci)..      
+00038340: 2020 6966 206f 6e6c 795f 6365 6e74 6572    if only_center
+00038350: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00038360: 2023 204f 6e6c 7920 6669 7420 666f 7220   # Only fit for 
+00038370: 6365 6e74 6572 696e 6720 616e 6420 636f  centering and co
+00038380: 6d70 7574 6520 6e6f 726d 616c 697a 6174  mpute normalizat
+00038390: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
+000383a0: 2067 7565 7373 203d 205b 7867 7565 7373   guess = [xguess
+000383b0: 2c20 7967 7565 7373 5d0a 2020 2020 2020  , yguess].      
+000383c0: 2020 2020 2020 5f6f 626a 6675 6e20 3d20        _objfun = 
+000383d0: 7365 6c66 2e6f 626a 6563 7469 7665 5f65  self.objective_e
+000383e0: 7073 665f 6365 6e74 6572 0a20 2020 2020  psf_center.     
+000383f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00038400: 2020 2020 2023 2046 6974 2066 6f72 2063       # Fit for c
+00038410: 656e 7465 7269 6e67 2061 6e64 206e 6f72  entering and nor
+00038420: 6d61 6c69 7a61 7469 6f6e 0a20 2020 2020  malization.     
+00038430: 2020 2020 2020 2067 7565 7373 203d 205b         guess = [
+00038440: 2873 6369 2d6d 6564 5f62 6b67 295b 7963  (sci-med_bkg)[yc
+00038450: 2d4e 3a79 632b 4e2c 2078 632d 4e3a 7863  -N:yc+N, xc-N:xc
+00038460: 2b4e 5d2e 7375 6d28 292c 2078 6775 6573  +N].sum(), xgues
+00038470: 732c 2079 6775 6573 732c 206d 6564 5f62  s, yguess, med_b
+00038480: 6b67 2c20 302c 2030 5d0a 2020 2020 2020  kg, 0, 0].      
+00038490: 2020 2020 2020 5f6f 626a 6675 6e20 3d20        _objfun = 
+000384a0: 7365 6c66 2e6f 626a 6563 7469 7665 5f65  self.objective_e
+000384b0: 7073 660a 0a20 2020 2020 2020 2073 6c79  psf..        sly
+000384c0: 203d 2073 6c69 6365 2879 632d 4e2c 2079   = slice(yc-N, y
+000384d0: 632b 4e29 0a20 2020 2020 2020 2073 6c78  c+N).        slx
+000384e0: 203d 2073 6c69 6365 2878 632d 4e2c 2078   = slice(xc-N, x
+000384f0: 632b 4e29 0a20 2020 2020 2020 2073 6c79  c+N).        sly
+00038500: 203d 2073 6c69 6365 2879 6775 6573 732d   = slice(yguess-
+00038510: 4e2c 2079 6775 6573 732b 4e29 0a20 2020  N, yguess+N).   
+00038520: 2020 2020 2073 6c78 203d 2073 6c69 6365       slx = slice
+00038530: 2878 6775 6573 732d 4e2c 2078 6775 6573  (xguess-N, xgues
+00038540: 732b 4e29 0a0a 2020 2020 2020 2020 6976  s+N)..        iv
+00038550: 6172 5f6d 6173 6b20 3d20 6e70 2e7a 6572  ar_mask = np.zer
+00038560: 6f73 5f6c 696b 6528 7363 6929 0a20 2020  os_like(sci).   
+00038570: 2020 2020 2069 7661 725f 6d61 736b 5b73       ivar_mask[s
+00038580: 6c79 2c20 736c 785d 203d 2031 0a20 2020  ly, slx] = 1.   
+00038590: 2020 2020 2069 7661 725f 6d61 736b 202a       ivar_mask *
+000385a0: 3d20 6976 6172 0a0a 2020 2020 2020 2020  = ivar..        
+000385b0: 6966 2067 6574 5f65 7874 656e 6465 643a  if get_extended:
+000385c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000385d0: 6669 6c74 6572 2069 6e20 7365 6c66 2e65  filter in self.e
+000385e0: 7874 656e 6465 645f 6570 7366 3a0a 2020  xtended_epsf:.  
+000385f0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00038600: 7465 6e64 6564 5f64 6174 6120 3d20 7365  tended_data = se
+00038610: 6c66 2e65 7874 656e 6465 645f 6570 7366  lf.extended_epsf
+00038620: 5b66 696c 7465 725d 0a20 2020 2020 2020  [filter].       
+00038630: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00038640: 2020 2020 2020 2020 2020 2065 7874 656e             exten
+00038650: 6465 645f 6461 7461 203d 204e 6f6e 650a  ded_data = None.
+00038660: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00038670: 2020 2020 2020 2020 2020 6578 7465 6e64            extend
+00038680: 6564 5f64 6174 6120 3d20 4e6f 6e65 0a0a  ed_data = None..
+00038690: 2020 2020 2020 2020 2320 4765 7420 6d6f          # Get mo
+000386a0: 6465 6c0a 2020 2020 2020 2020 6966 2070  del.        if p
+000386b0: 7366 5f70 6172 616d 7320 6973 206e 6f74  sf_params is not
+000386c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000386d0: 2020 2070 7820 3d20 7073 665f 7061 7261     px = psf_para
+000386e0: 6d73 2a31 0a20 2020 2020 2020 2020 2020  ms*1.           
+000386f0: 2069 6620 6c65 6e28 7078 2920 3d3d 2032   if len(px) == 2
+00038700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00038710: 2020 5f6f 626a 6675 6e20 3d20 7365 6c66    _objfun = self
+00038720: 2e6f 626a 6563 7469 7665 5f65 7073 665f  .objective_epsf_
+00038730: 6365 6e74 6572 0a20 2020 2020 2020 2020  center.         
+00038740: 2020 2020 2020 2070 785b 305d 202b 3d20         px[0] += 
+00038750: 7830 0a20 2020 2020 2020 2020 2020 2020  x0.             
+00038760: 2020 2070 785b 315d 202b 3d20 7930 0a20     px[1] += y0. 
+00038770: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00038780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038790: 205f 6f62 6a66 756e 203d 2073 656c 662e   _objfun = self.
+000387a0: 6f62 6a65 6374 6976 655f 6570 7366 0a20  objective_epsf. 
+000387b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000387c0: 785b 315d 202b 3d20 7830 0a20 2020 2020  x[1] += x0.     
+000387d0: 2020 2020 2020 2020 2020 2070 785b 325d             px[2]
+000387e0: 202b 3d20 7930 0a0a 2020 2020 2020 2020   += y0..        
+000387f0: 2020 2020 6172 6773 203d 2028 7365 6c66      args = (self
+00038800: 2c20 7073 665f 7879 2c20 7363 692c 2069  , psf_xy, sci, i
+00038810: 7661 725f 6d61 736b 2c20 7870 2c20 7970  var_mask, xp, yp
+00038820: 2c20 6578 7465 6e64 6564 5f64 6174 612c  , extended_data,
+00038830: 2027 6d6f 6465 6c27 2c20 6473 3929 0a20   'model', ds9). 
+00038840: 2020 2020 2020 2020 2020 2070 7366 5f6d             psf_m
+00038850: 6f64 656c 2c20 626b 672c 2041 2c20 636f  odel, bkg, A, co
+00038860: 6566 6673 203d 205f 6f62 6a66 756e 2870  effs = _objfun(p
+00038870: 782c 202a 6172 6773 290a 2020 2020 2020  x, *args).      
+00038880: 2020 2020 2020 7265 7475 726e 2070 7366        return psf
+00038890: 5f6d 6f64 656c 2c20 626b 672c 2041 2c20  _model, bkg, A, 
+000388a0: 636f 6566 6673 0a0a 2020 2020 2020 2020  coeffs..        
+000388b0: 6966 206d 6574 686f 6420 3d3d 2027 6c6d  if method == 'lm
+000388c0: 273a 0a20 2020 2020 2020 2020 2020 2061  ':.            a
+000388d0: 7267 7320 3d20 2873 656c 662c 2070 7366  rgs = (self, psf
+000388e0: 5f78 792c 2073 6369 2c20 6976 6172 5f6d  _xy, sci, ivar_m
+000388f0: 6173 6b2c 2078 702c 2079 702c 2065 7874  ask, xp, yp, ext
+00038900: 656e 6465 645f 6461 7461 2c20 276c 6d27  ended_data, 'lm'
+00038910: 2c20 6473 3929 0a0a 2020 2020 2020 2020  , ds9)..        
+00038920: 2020 2020 785f 7363 616c 6520 3d20 276a      x_scale = 'j
+00038930: 6163 270a 2020 2020 2020 2020 2020 2020  ac'.            
+00038940: 2378 5f73 6361 6c65 203d 205b 6775 6573  #x_scale = [gues
+00038950: 735b 305d 2c20 312c 2031 2c20 3130 2c20  s[0], 1, 1, 10, 
+00038960: 3130 2c20 3130 5d0a 2020 2020 2020 2020  10, 10].        
+00038970: 2020 2020 236f 7574 203d 206c 6561 7374      #out = least
+00038980: 5f73 7175 6172 6573 285f 6f62 6a66 756e  _squares(_objfun
+00038990: 2c20 6775 6573 732c 2061 7267 733d 6172  , guess, args=ar
+000389a0: 6773 2c20 6d65 7468 6f64 3d27 7472 6627  gs, method='trf'
+000389b0: 2c20 785f 7363 616c 653d 785f 7363 616c  , x_scale=x_scal
+000389c0: 652c 206c 6f73 733d 2768 7562 6572 2729  e, loss='huber')
+000389d0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+000389e0: 203d 206c 6561 7374 5f73 7175 6172 6573   = least_squares
+000389f0: 285f 6f62 6a66 756e 2c20 6775 6573 732c  (_objfun, guess,
+00038a00: 2061 7267 733d 6172 6773 2c20 6d65 7468   args=args, meth
+00038a10: 6f64 3d27 6c6d 272c 2078 5f73 6361 6c65  od='lm', x_scale
+00038a20: 3d78 5f73 6361 6c65 2c20 6c6f 7373 3d27  =x_scale, loss='
+00038a30: 6c69 6e65 6172 2729 0a20 2020 2020 2020  linear').       
+00038a40: 2020 2020 2070 7366 5f70 6172 616d 7320       psf_params 
+00038a50: 3d20 6f75 742e 782a 310a 2020 2020 2020  = out.x*1.      
+00038a60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00038a70: 2020 2020 6172 6773 203d 2028 7365 6c66      args = (self
+00038a80: 2c20 7073 665f 7879 2c20 7363 692c 2069  , psf_xy, sci, i
+00038a90: 7661 725f 6d61 736b 2c20 7870 2c20 7970  var_mask, xp, yp
+00038aa0: 2c20 6578 7465 6e64 6564 5f64 6174 612c  , extended_data,
+00038ab0: 2027 6368 6932 272c 2064 7339 290a 2020   'chi2', ds9).  
+00038ac0: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+00038ad0: 6d69 6e69 6d69 7a65 285f 6f62 6a66 756e  minimize(_objfun
+00038ae0: 2c20 6775 6573 732c 2061 7267 733d 6172  , guess, args=ar
+00038af0: 6773 2c20 6d65 7468 6f64 3d6d 6574 686f  gs, method=metho
+00038b00: 642c 2074 6f6c 3d74 6f6c 290a 2020 2020  d, tol=tol).    
+00038b10: 2020 2020 2020 2020 7073 665f 7061 7261          psf_para
+00038b20: 6d73 203d 206f 7574 2e78 2a31 0a0a 2020  ms = out.x*1..  
+00038b30: 2020 2020 2020 6966 206c 656e 2867 7565        if len(gue
+00038b40: 7373 2920 3d3d 2032 3a0a 2020 2020 2020  ss) == 2:.      
+00038b50: 2020 2020 2020 7073 665f 7061 7261 6d73        psf_params
+00038b60: 5b30 5d20 2d3d 2078 300a 2020 2020 2020  [0] -= x0.      
+00038b70: 2020 2020 2020 7073 665f 7061 7261 6d73        psf_params
+00038b80: 5b31 5d20 2d3d 2079 300a 2020 2020 2020  [1] -= y0.      
+00038b90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00038ba0: 2020 2020 7073 665f 7061 7261 6d73 5b31      psf_params[1
+00038bb0: 5d20 2d3d 2078 300a 2020 2020 2020 2020  ] -= x0.        
+00038bc0: 2020 2020 7073 665f 7061 7261 6d73 5b32      psf_params[2
+00038bd0: 5d20 2d3d 2079 300a 0a20 2020 2020 2020  ] -= y0..       
+00038be0: 2023 2069 6620 4661 6c73 653a 0a20 2020   # if False:.   
+00038bf0: 2020 2020 2023 200a 2020 2020 2020 2020       # .        
+00038c00: 2320 2020 2020 7073 665f 6669 7420 3d20  #     psf_fit = 
+00038c10: 6570 7366 2e67 6574 5f65 5053 4628 7073  epsf.get_ePSF(ps
+00038c20: 665f 7061 7261 6d73 2c20 6f72 6967 696e  f_params, origin
+00038c30: 3d6f 7269 6769 6e2c 0a20 2020 2020 2020  =origin,.       
+00038c40: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00038c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038c60: 2020 6669 6c74 6572 3d66 696c 7465 722c    filter=filter,
+00038c70: 2073 6861 7065 3d73 682c 0a20 2020 2020   shape=sh,.     
+00038c80: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+00038c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038ca0: 2020 2020 6765 745f 6578 7465 6e64 6564      get_extended
+00038cb0: 3d67 6574 5f65 7874 656e 6465 6429 0a20  =get_extended). 
+00038cc0: 2020 2020 2020 2023 200a 2020 2020 2020         # .      
+00038cd0: 2020 2320 2020 2020 7861 7267 7320 3d20    #     xargs = 
+00038ce0: 2873 656c 662c 2070 7366 5f78 792c 2073  (self, psf_xy, s
+00038cf0: 6369 2c20 6976 6172 5f6d 6173 6b2c 2078  ci, ivar_mask, x
+00038d00: 702c 2079 702c 2065 7874 656e 6465 645f  p, yp, extended_
+00038d10: 6461 7461 2c20 276c 6d27 2c20 4e6f 6e65  data, 'lm', None
+00038d20: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
+00038d30: 6c6d 203d 205f 6f62 6a66 756e 286f 7574  lm = _objfun(out
+00038d40: 2e78 2c20 2a78 6172 6773 290a 2020 2020  .x, *xargs).    
+00038d50: 2020 2020 2320 2020 2020 6361 7267 7320      #     cargs 
+00038d60: 3d20 2873 656c 662c 2070 7366 5f78 792c  = (self, psf_xy,
+00038d70: 2073 6369 2c20 6976 6172 5f6d 6173 6b2c   sci, ivar_mask,
+00038d80: 2078 702c 2079 702c 2065 7874 656e 6465   xp, yp, extende
+00038d90: 645f 6461 7461 2c20 2763 6869 3227 2c20  d_data, 'chi2', 
+00038da0: 4e6f 6e65 290a 2020 2020 2020 2020 2320  None).        # 
+00038db0: 2020 2020 6368 6932 203d 205f 6f62 6a66      chi2 = _objf
+00038dc0: 756e 286f 7574 2e78 2c20 2a63 6172 6773  un(out.x, *cargs
+00038dd0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00038de0: 6e20 7073 665f 7061 7261 6d73 0a0a 2020  n psf_params..  
+00038df0: 2020 2020 2020 2320 6478 203d 2078 702d        # dx = xp-
+00038e00: 7073 665f 7061 7261 6d73 5b31 5d0a 2020  psf_params[1].  
+00038e10: 2020 2020 2020 2320 6479 203d 2079 702d        # dy = yp-
+00038e20: 7073 665f 7061 7261 6d73 5b32 5d0a 2020  psf_params[2].  
+00038e30: 2020 2020 2020 2320 6f75 7470 7574 5f70        # output_p
+00038e40: 7366 203d 2073 656c 662e 6576 616c 5f65  sf = self.eval_e
+00038e50: 5053 4628 7073 665f 7879 2c20 6478 2c20  PSF(psf_xy, dx, 
+00038e60: 6479 292a 7073 665f 7061 7261 6d73 5b30  dy)*psf_params[0
+00038e70: 5d0a 2020 2020 2020 2020 230a 2020 2020  ].        #.    
+00038e80: 2020 2020 2320 7265 7475 726e 206f 7574      # return out
+00038e90: 7075 745f 7073 662c 2070 7366 5f70 6172  put_psf, psf_par
+00038ea0: 616d 730a 0a20 2020 2064 6566 2067 6574  ams..    def get
+00038eb0: 5f65 5053 4628 7365 6c66 2c20 7073 665f  _ePSF(self, psf_
+00038ec0: 7061 7261 6d73 2c20 7363 693d 4e6f 6e65  params, sci=None
+00038ed0: 2c20 6976 6172 3d31 2c20 6f72 6967 696e  , ivar=1, origin
+00038ee0: 3d5b 302c 2030 5d2c 2073 6861 7065 3d5b  =[0, 0], shape=[
+00038ef0: 3230 2c20 3230 5d2c 2066 696c 7465 723d  20, 20], filter=
+00038f00: 2746 3134 3057 272c 2067 6574 5f65 7874  'F140W', get_ext
+00038f10: 656e 6465 643d 4661 6c73 652c 2067 6574  ended=False, get
+00038f20: 5f62 6163 6b67 726f 756e 643d 4661 6c73  _background=Fals
+00038f30: 652c 2072 6f74 3930 3d30 293a 0a20 2020  e, rot90=0):.   
+00038f40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00038f50: 2045 7661 6c75 6174 6520 616e 2045 6666   Evaluate an Eff
+00038f60: 6563 7469 7665 2050 5346 0a20 2020 2020  ective PSF.     
+00038f70: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
+00038f80: 6820 3d20 7368 6170 650a 2020 2020 2020  h = shape.      
+00038f90: 2020 7930 2c20 7830 203d 206e 702e 6172    y0, x0 = np.ar
+00038fa0: 7261 7928 7368 292f 322e 2d31 0a0a 2020  ray(sh)/2.-1..  
+00038fb0: 2020 2020 2020 7864 203d 2078 302b 6f72        xd = x0+or
+00038fc0: 6967 696e 5b31 5d0a 2020 2020 2020 2020  igin[1].        
+00038fd0: 7964 203d 2079 302b 6f72 6967 696e 5b30  yd = y0+origin[0
+00038fe0: 5d0a 0a20 2020 2020 2020 2078 632c 2079  ]..        xc, y
+00038ff0: 6320 3d20 696e 7428 7830 292c 2069 6e74  c = int(x0), int
+00039000: 2879 3029 0a0a 2020 2020 2020 2020 7073  (y0)..        ps
+00039010: 665f 7879 203d 2073 656c 662e 6765 745f  f_xy = self.get_
+00039020: 6174 5f70 6f73 6974 696f 6e28 783d 7864  at_position(x=xd
+00039030: 2c20 793d 7964 2c20 6669 6c74 6572 3d66  , y=yd, filter=f
+00039040: 696c 7465 722c 2072 6f74 3930 3d72 6f74  ilter, rot90=rot
+00039050: 3930 290a 0a20 2020 2020 2020 2079 702c  90)..        yp,
+00039060: 2078 7020 3d20 6e70 2e69 6e64 6963 6573   xp = np.indices
+00039070: 2873 6829 0a0a 2020 2020 2020 2020 6966  (sh)..        if
+00039080: 206c 656e 2870 7366 5f70 6172 616d 7329   len(psf_params)
+00039090: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+000390a0: 2020 205f 6f62 6a66 756e 203d 2073 656c     _objfun = sel
+000390b0: 662e 6f62 6a65 6374 6976 655f 6570 7366  f.objective_epsf
+000390c0: 5f63 656e 7465 720a 2020 2020 2020 2020  _center.        
+000390d0: 2020 2020 6478 203d 2078 702d 7073 665f      dx = xp-psf_
+000390e0: 7061 7261 6d73 5b30 5d2d 7830 0a20 2020  params[0]-x0.   
+000390f0: 2020 2020 2020 2020 2064 7920 3d20 7970           dy = yp
+00039100: 2d70 7366 5f70 6172 616d 735b 315d 2d79  -psf_params[1]-y
+00039110: 300a 2020 2020 2020 2020 656c 7365 3a0a  0.        else:.
+00039120: 2020 2020 2020 2020 2020 2020 5f6f 626a              _obj
+00039130: 6675 6e20 3d20 7365 6c66 2e6f 626a 6563  fun = self.objec
+00039140: 7469 7665 5f65 7073 660a 2020 2020 2020  tive_epsf.      
+00039150: 2020 2020 2020 6478 203d 2078 702d 7073        dx = xp-ps
+00039160: 665f 7061 7261 6d73 5b31 5d2d 7830 0a20  f_params[1]-x0. 
+00039170: 2020 2020 2020 2020 2020 2064 7920 3d20             dy = 
+00039180: 7970 2d70 7366 5f70 6172 616d 735b 325d  yp-psf_params[2]
+00039190: 2d79 300a 0a20 2020 2020 2020 2069 6620  -y0..        if 
+000391a0: 6765 745f 6578 7465 6e64 6564 3a0a 2020  get_extended:.  
+000391b0: 2020 2020 2020 2020 2020 6966 2066 696c            if fil
+000391c0: 7465 7220 696e 2073 656c 662e 6578 7465  ter in self.exte
+000391d0: 6e64 6564 5f65 7073 663a 0a20 2020 2020  nded_epsf:.     
+000391e0: 2020 2020 2020 2020 2020 2065 7874 656e             exten
+000391f0: 6465 645f 6461 7461 203d 2073 656c 662e  ded_data = self.
+00039200: 6578 7465 6e64 6564 5f65 7073 665b 6669  extended_epsf[fi
+00039210: 6c74 6572 5d0a 2020 2020 2020 2020 2020  lter].          
+00039220: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00039230: 2020 2020 2020 2020 6578 7465 6e64 6564          extended
+00039240: 5f64 6174 6120 3d20 4e6f 6e65 0a20 2020  _data = None.   
+00039250: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00039260: 2020 2020 2020 2065 7874 656e 6465 645f         extended_
+00039270: 6461 7461 203d 204e 6f6e 650a 0a20 2020  data = None..   
+00039280: 2020 2020 2069 6620 7363 6920 6973 206e       if sci is n
+00039290: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000392a0: 2020 2020 2069 7661 725f 6d61 736b 203d       ivar_mask =
+000392b0: 206e 702e 6f6e 6573 5f6c 696b 6528 7363   np.ones_like(sc
+000392c0: 6929 0a20 2020 2020 2020 2020 2020 2069  i).            i
+000392d0: 7661 725f 6d61 736b 202a 3d20 6976 6172  var_mask *= ivar
+000392e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000392f0: 2020 2020 2020 2020 2020 2073 6369 203d             sci =
+00039300: 206e 702e 6f6e 6573 2873 682c 2064 7479   np.ones(sh, dty
+00039310: 7065 3d66 6c6f 6174 290a 2020 2020 2020  pe=float).      
+00039320: 2020 2020 2020 6976 6172 5f6d 6173 6b20        ivar_mask 
+00039330: 3d20 7363 692a 310a 0a20 2020 2020 2020  = sci*1..       
+00039340: 2061 7267 7320 3d20 2873 656c 662c 2070   args = (self, p
+00039350: 7366 5f78 792c 2073 6369 2c20 6976 6172  sf_xy, sci, ivar
+00039360: 5f6d 6173 6b2c 2078 702d 7830 2c20 7970  _mask, xp-x0, yp
+00039370: 2d79 302c 2065 7874 656e 6465 645f 6461  -y0, extended_da
+00039380: 7461 2c20 276d 6f64 656c 272c 204e 6f6e  ta, 'model', Non
+00039390: 6529 0a20 2020 2020 2020 206f 7574 7075  e).        outpu
+000393a0: 745f 7073 662c 2062 6b67 2c20 5f61 2c20  t_psf, bkg, _a, 
+000393b0: 5f62 203d 205f 6f62 6a66 756e 2870 7366  _b = _objfun(psf
+000393c0: 5f70 6172 616d 732c 202a 6172 6773 290a  _params, *args).
+000393d0: 0a20 2020 2020 2020 2023 6f75 7470 7574  .        #output
+000393e0: 5f70 7366 203d 2073 656c 662e 6576 616c  _psf = self.eval
+000393f0: 5f65 5053 4628 7073 665f 7879 2c20 6478  _ePSF(psf_xy, dx
+00039400: 2c20 6479 2c20 6578 7465 6e64 6564 5f64  , dy, extended_d
+00039410: 6174 613d 6578 7465 6e64 6564 5f64 6174  ata=extended_dat
+00039420: 6129 2a70 7366 5f70 6172 616d 735b 305d  a)*psf_params[0]
+00039430: 0a0a 2020 2020 2020 2020 6966 2067 6574  ..        if get
+00039440: 5f62 6163 6b67 726f 756e 643a 0a20 2020  _background:.   
+00039450: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00039460: 6f75 7470 7574 5f70 7366 2c20 626b 670a  output_psf, bkg.
+00039470: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00039480: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00039490: 206f 7574 7075 745f 7073 660a 0a0a 6465   output_psf...de
+000394a0: 6620 7265 6164 5f63 6174 616c 6f67 2866  f read_catalog(f
+000394b0: 696c 652c 2073 6578 7472 6163 746f 723d  ile, sextractor=
+000394c0: 4661 6c73 652c 2066 6f72 6d61 743d 4e6f  False, format=No
+000394d0: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
+000394e0: 2057 7261 7070 6572 2061 726f 756e 6420   Wrapper around 
+000394f0: 607e 6772 697a 6c69 2e75 7469 6c73 2e47  `~grizli.utils.G
+00039500: 7461 626c 652e 6772 6561 6460 2e0a 0a20  table.gread`... 
+00039510: 2020 2041 7574 6f2d 6465 7465 6374 7320     Auto-detects 
+00039520: 666f 726d 6174 7320 2763 7376 2720 616e  formats 'csv' an
+00039530: 6420 2766 6974 7327 2061 6e64 2064 6566  d 'fits' and def
+00039540: 6175 6c74 7320 746f 0a20 2020 2027 6173  aults to.    'as
+00039550: 6369 692e 636f 6d6d 656e 7465 645f 6865  cii.commented_he
+00039560: 6164 6572 272e 0a20 2020 2022 2222 0a20  ader'..    """. 
+00039570: 2020 2072 6574 7572 6e20 4754 6162 6c65     return GTable
+00039580: 2e67 7265 6164 2866 696c 652c 2073 6578  .gread(file, sex
+00039590: 7472 6163 746f 723d 7365 7874 7261 6374  tractor=sextract
+000395a0: 6f72 2c20 666f 726d 6174 3d66 6f72 6d61  or, format=forma
+000395b0: 7429 0a0a 0a63 6c61 7373 2047 5461 626c  t)...class GTabl
+000395c0: 6528 6173 7472 6f70 792e 7461 626c 652e  e(astropy.table.
+000395d0: 5461 626c 6529 3a0a 2020 2020 2222 220a  Table):.    """.
+000395e0: 2020 2020 4578 7465 6e64 2060 7e61 7374      Extend `~ast
+000395f0: 726f 7079 2e74 6162 6c65 2e54 6162 6c65  ropy.table.Table
+00039600: 6020 636c 6173 7320 7769 7468 206d 6f72  ` class with mor
+00039610: 6520 6175 746f 6d61 7469 6320 494f 2061  e automatic IO a
+00039620: 6e64 206f 7468 6572 0a20 2020 2068 656c  nd other.    hel
+00039630: 7065 7220 6d65 7468 6f64 732e 0a20 2020  per methods..   
+00039640: 2022 2222 0a20 2020 2040 636c 6173 736d   """.    @classm
+00039650: 6574 686f 640a 2020 2020 6465 6620 6772  ethod.    def gr
+00039660: 6561 6428 636c 732c 2066 696c 652c 2073  ead(cls, file, s
+00039670: 6578 7472 6163 746f 723d 4661 6c73 652c  extractor=False,
+00039680: 2066 6f72 6d61 743d 4e6f 6e65 293a 0a20   format=None):. 
+00039690: 2020 2020 2020 2022 2222 4173 7375 6d65         """Assume
+000396a0: 2060 6173 6369 692e 636f 6d6d 656e 7465   `ascii.commente
+000396b0: 645f 6865 6164 6572 6020 6279 2064 6566  d_header` by def
+000396c0: 6175 6c74 0a0a 2020 2020 2020 2020 5061  ault..        Pa
+000396d0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+000396e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+000396f0: 2020 2020 7365 7874 7261 6374 6f72 203a      sextractor :
+00039700: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
+00039710: 2020 5573 6520 6066 6f72 6d61 743d 2761    Use `format='a
+00039720: 7363 6969 2e73 6578 7472 6163 746f 7227  scii.sextractor'
+00039730: 602e 0a0a 2020 2020 2020 2020 666f 726d  `...        form
+00039740: 6174 203a 204e 6f6e 6520 6f72 2073 7472  at : None or str
+00039750: 0a20 2020 2020 2020 2020 2020 204f 7665  .            Ove
+00039760: 7272 6964 6520 666f 726d 6174 2070 6173  rride format pas
+00039770: 7365 6420 746f 2060 7e61 7374 726f 7079  sed to `~astropy
+00039780: 2e74 6162 6c65 2e54 6162 6c65 2e72 6561  .table.Table.rea
+00039790: 6460 2e0a 0a20 2020 2020 2020 2052 6574  d`...        Ret
+000397a0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
+000397b0: 2d2d 2d2d 0a20 2020 2020 2020 2074 6162  ----.        tab
+000397c0: 203a 2060 7e61 7374 726f 7079 2e74 6162   : `~astropy.tab
+000397d0: 6c65 2e54 6162 6c65 600a 2020 2020 2020  le.Table`.      
+000397e0: 2020 2020 2020 5461 626c 6520 6f62 6a65        Table obje
+000397f0: 6374 0a20 2020 2020 2020 2022 2222 0a20  ct.        """. 
+00039800: 2020 2020 2020 2069 6d70 6f72 7420 6173         import as
+00039810: 7472 6f70 792e 756e 6974 7320 6173 2075  tropy.units as u
+00039820: 0a0a 2020 2020 2020 2020 6966 2066 6f72  ..        if for
+00039830: 6d61 7420 6973 204e 6f6e 653a 0a20 2020  mat is None:.   
+00039840: 2020 2020 2020 2020 2069 6620 7365 7874           if sext
+00039850: 7261 6374 6f72 3a0a 2020 2020 2020 2020  ractor:.        
+00039860: 2020 2020 2020 2020 666f 726d 6174 203d          format =
+00039870: 2027 6173 6369 692e 7365 7874 7261 6374   'ascii.sextract
+00039880: 6f72 270a 2020 2020 2020 2020 2020 2020  or'.            
+00039890: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+000398a0: 6669 6c65 2c20 7079 6669 7473 2e42 696e  file, pyfits.Bin
+000398b0: 5461 626c 6548 4455 293a 0a20 2020 2020  TableHDU):.     
+000398c0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+000398d0: 7420 3d20 2766 6974 7327 0a20 2020 2020  t = 'fits'.     
+000398e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000398f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00039900: 6669 6c65 2e65 6e64 7377 6974 6828 272e  file.endswith('.
+00039910: 6669 7473 2729 3a0a 2020 2020 2020 2020  fits'):.        
+00039920: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00039930: 6174 203d 2027 6669 7473 270a 2020 2020  at = 'fits'.    
+00039940: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00039950: 2066 696c 652e 656e 6473 7769 7468 2827   file.endswith('
+00039960: 2e63 7376 2729 3a0a 2020 2020 2020 2020  .csv'):.        
+00039970: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00039980: 6174 203d 2027 6373 7627 0a20 2020 2020  at = 'csv'.     
+00039990: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000399a0: 6669 6c65 2e65 6e64 7377 6974 6828 272e  file.endswith('.
+000399b0: 766f 7427 293a 0a20 2020 2020 2020 2020  vot'):.         
+000399c0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+000399d0: 7420 3d20 2776 6f74 6162 6c65 270a 2020  t = 'votable'.  
+000399e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000399f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00039a00: 2020 2020 2020 2020 666f 726d 6174 203d          format =
+00039a10: 2027 6173 6369 692e 636f 6d6d 656e 7465   'ascii.commente
+00039a20: 645f 6865 6164 6572 270a 0a20 2020 2020  d_header'..     
+00039a30: 2020 2023 7072 696e 7428 6669 6c65 2c20     #print(file, 
+00039a40: 666f 726d 6174 290a 2020 2020 2020 2020  format).        
+00039a50: 7461 6220 3d20 636c 732e 7265 6164 2866  tab = cls.read(f
+00039a60: 696c 652c 2066 6f72 6d61 743d 666f 726d  ile, format=form
+00039a70: 6174 290a 0a20 2020 2020 2020 2072 6574  at)..        ret
+00039a80: 7572 6e20 7461 620a 0a20 2020 2064 6566  urn tab..    def
+00039a90: 2067 7772 6974 6528 7365 6c66 2c20 6f75   gwrite(self, ou
+00039aa0: 7470 7574 2c20 666f 726d 6174 3d27 6173  tput, format='as
+00039ab0: 6369 692e 636f 6d6d 656e 7465 645f 6865  cii.commented_he
+00039ac0: 6164 6572 2729 3a0a 2020 2020 2020 2020  ader'):.        
+00039ad0: 2222 2241 7373 756d 6520 6120 666f 726d  """Assume a form
+00039ae0: 6174 2066 6f72 2074 6865 206f 7574 7075  at for the outpu
+00039af0: 7420 7461 626c 650a 0a20 2020 2020 2020  t table..       
+00039b00: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00039b10: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00039b20: 2020 2020 2020 206f 7574 7075 7420 3a20         output : 
+00039b30: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
+00039b40: 4f75 7470 7574 2066 696c 656e 616d 650a  Output filename.
+00039b50: 0a20 2020 2020 2020 2066 6f72 6d61 7420  .        format 
+00039b60: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
+00039b70: 2020 466f 726d 6174 2073 7472 696e 6720    Format string 
+00039b80: 7061 7373 6564 2074 6f20 607e 6173 7472  passed to `~astr
+00039b90: 6f70 792e 7461 626c 652e 5461 626c 652e  opy.table.Table.
+00039ba0: 7772 6974 6560 2e0a 0a20 2020 2020 2020  write`...       
+00039bb0: 2022 2222 0a20 2020 2020 2020 2073 656c   """.        sel
+00039bc0: 662e 7772 6974 6528 6f75 7470 7574 2c20  f.write(output, 
+00039bd0: 666f 726d 6174 3d66 6f72 6d61 7429 0a0a  format=format)..
+00039be0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+00039bf0: 640a 2020 2020 6465 6620 7061 7273 655f  d.    def parse_
+00039c00: 7261 6465 635f 636f 6c75 6d6e 7328 7365  radec_columns(se
+00039c10: 6c66 2c20 7264 5f70 6169 7273 3d4e 6f6e  lf, rd_pairs=Non
+00039c20: 6529 3a0a 2020 2020 2020 2020 2222 2250  e):.        """P
+00039c30: 6172 7365 2063 6f6c 756d 6e20 6e61 6d65  arse column name
+00039c40: 7320 666f 7220 5241 2f44 6563 2061 6e64  s for RA/Dec and
+00039c50: 2073 6574 2074 6f20 607e 6173 7472 6f70   set to `~astrop
+00039c60: 792e 756e 6974 732e 6465 6772 6565 6020  y.units.degree` 
+00039c70: 756e 6974 7320 6966 206e 6f74 2061 6c72  units if not alr
+00039c80: 6561 6479 2073 6574 0a0a 2020 2020 2020  eady set..      
+00039c90: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00039ca0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+00039cb0: 2020 2020 2020 2020 7264 5f70 6169 7273          rd_pairs
+00039cc0: 203a 2060 7e63 6f6c 6c65 6374 696f 6e73   : `~collections
+00039cd0: 2e4f 7264 6572 6564 4469 6374 6020 6f72  .OrderedDict` or
+00039ce0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00039cf0: 2020 5061 6972 7320 6f66 207b 7261 3a64    Pairs of {ra:d
+00039d00: 6563 7d20 6e61 6d65 7320 746f 2073 6561  ec} names to sea
+00039d10: 7263 6820 696e 2074 6865 2063 6f6c 756d  rch in the colum
+00039d20: 6e20 6c69 7374 2e20 4966 204e 6f6e 652c  n list. If None,
+00039d30: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+00039d40: 6e20 7573 6573 2074 6865 2066 6f6c 6c6f  n uses the follo
+00039d50: 7769 6e67 2062 7920 6465 6661 756c 742e  wing by default.
+00039d60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039d70: 2020 3e3e 3e20 7264 5f70 6169 7273 203d    >>> rd_pairs =
+00039d80: 204f 7264 6572 6564 4469 6374 2829 0a20   OrderedDict(). 
+00039d90: 2020 2020 2020 2020 2020 2020 2020 203e                 >
+00039da0: 3e3e 2072 645f 7061 6972 735b 2772 6127  >> rd_pairs['ra'
+00039db0: 5d20 3d20 2764 6563 270a 2020 2020 2020  ] = 'dec'.      
+00039dc0: 2020 2020 2020 2020 2020 3e3e 3e20 7264            >>> rd
+00039dd0: 5f70 6169 7273 5b27 414c 5048 415f 4a32  _pairs['ALPHA_J2
+00039de0: 3030 3027 5d20 3d20 2744 454c 5441 5f4a  000'] = 'DELTA_J
+00039df0: 3230 3030 270a 2020 2020 2020 2020 2020  2000'.          
+00039e00: 2020 2020 2020 3e3e 3e20 7264 5f70 6169        >>> rd_pai
+00039e10: 7273 5b27 585f 574f 524c 4427 5d20 3d20  rs['X_WORLD'] = 
+00039e20: 2759 5f57 4f52 4c44 270a 0a20 2020 2020  'Y_WORLD'..     
+00039e30: 2020 2020 2020 204e 423a 2073 6561 7263         NB: searc
+00039e40: 6820 6973 2070 6572 666f 726d 6564 2069  h is performed i
+00039e50: 6e20 6f72 6465 7220 6f66 2060 6072 645f  n order of ``rd_
+00039e60: 7061 6972 732e 6b65 7973 2829 6060 2061  pairs.keys()`` a
+00039e70: 6e64 2073 746f 7073 0a20 2020 2020 2020  nd stops.       
+00039e80: 2020 2020 2069 662f 7768 656e 2061 206d       if/when a m
+00039e90: 6174 6368 2069 7320 666f 756e 642e 0a0a  atch is found...
+00039ea0: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
+00039eb0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
+00039ec0: 2020 2020 2020 2020 7264 5f70 6169 7220          rd_pair 
+00039ed0: 3a20 5b73 7472 2c20 7374 725d 0a20 2020  : [str, str].   
+00039ee0: 2020 2020 2020 2020 2043 6f6c 756d 6e20           Column 
+00039ef0: 6e61 6d65 7320 6173 736f 6369 6174 6564  names associated
+00039f00: 2077 6974 6820 5241 2f44 6563 2e20 2052   with RA/Dec.  R
+00039f10: 6574 7572 6e73 2046 616c 7365 2069 6620  eturns False if 
+00039f20: 6e6f 2063 6f6c 756d 6e0a 2020 2020 2020  no column.      
+00039f30: 2020 2020 2020 7061 6972 7320 666f 756e        pairs foun
+00039f40: 6420 6261 7365 6420 6f6e 2060 7264 5f70  d based on `rd_p
+00039f50: 6169 7273 602e 0a0a 2020 2020 2020 2020  airs`...        
+00039f60: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
+00039f70: 2063 6f6c 6c65 6374 696f 6e73 2069 6d70   collections imp
+00039f80: 6f72 7420 4f72 6465 7265 6444 6963 740a  ort OrderedDict.
+00039f90: 2020 2020 2020 2020 696d 706f 7274 2061          import a
+00039fa0: 7374 726f 7079 2e75 6e69 7473 2061 7320  stropy.units as 
+00039fb0: 750a 0a20 2020 2020 2020 2069 6620 7264  u..        if rd
+00039fc0: 5f70 6169 7273 2069 7320 4e6f 6e65 3a0a  _pairs is None:.
+00039fd0: 2020 2020 2020 2020 2020 2020 7264 5f70              rd_p
+00039fe0: 6169 7273 203d 204f 7264 6572 6564 4469  airs = OrderedDi
+00039ff0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+0003a000: 2072 645f 7061 6972 735b 2752 4127 5d20   rd_pairs['RA'] 
+0003a010: 3d20 2744 4543 270a 2020 2020 2020 2020  = 'DEC'.        
+0003a020: 2020 2020 7264 5f70 6169 7273 5b27 414c      rd_pairs['AL
+0003a030: 5048 415f 4a32 3030 3027 5d20 3d20 2744  PHA_J2000'] = 'D
+0003a040: 454c 5441 5f4a 3230 3030 270a 2020 2020  ELTA_J2000'.    
+0003a050: 2020 2020 2020 2020 7264 5f70 6169 7273          rd_pairs
+0003a060: 5b27 585f 574f 524c 4427 5d20 3d20 2759  ['X_WORLD'] = 'Y
+0003a070: 5f57 4f52 4c44 270a 2020 2020 2020 2020  _WORLD'.        
+0003a080: 2020 2020 7264 5f70 6169 7273 5b27 414c      rd_pairs['AL
+0003a090: 5048 415f 534b 5927 5d20 3d20 2744 454c  PHA_SKY'] = 'DEL
+0003a0a0: 5441 5f53 4b59 270a 2020 2020 2020 2020  TA_SKY'.        
+0003a0b0: 2020 2020 7264 5f70 6169 7273 5b27 5f52      rd_pairs['_R
+0003a0c0: 414a 3230 3030 275d 203d 2027 5f44 454a  AJ2000'] = '_DEJ
+0003a0d0: 3230 3030 270a 0a20 2020 2020 2020 2020  2000'..         
+0003a0e0: 2020 2066 6f72 206b 2069 6e20 6c69 7374     for k in list
+0003a0f0: 2872 645f 7061 6972 732e 6b65 7973 2829  (rd_pairs.keys()
+0003a100: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003a110: 2020 2072 645f 7061 6972 735b 6b2e 6c6f     rd_pairs[k.lo
+0003a120: 7765 7228 295d 203d 2072 645f 7061 6972  wer()] = rd_pair
+0003a130: 735b 6b5d 2e6c 6f77 6572 2829 0a0a 2020  s[k].lower()..  
+0003a140: 2020 2020 2020 7264 5f70 6169 7220 3d20        rd_pair = 
+0003a150: 4e6f 6e65 0a20 2020 2020 2020 2066 6f72  None.        for
+0003a160: 2063 2069 6e20 7264 5f70 6169 7273 3a0a   c in rd_pairs:.
+0003a170: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0003a180: 2069 6e20 7365 6c66 2e63 6f6c 6e61 6d65   in self.colname
+0003a190: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0003a1a0: 2020 2072 645f 7061 6972 203d 205b 632c     rd_pair = [c,
+0003a1b0: 2072 645f 7061 6972 735b 635d 5d0a 2020   rd_pairs[c]].  
+0003a1c0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+0003a1d0: 6561 6b0a 0a20 2020 2020 2020 2069 6620  eak..        if 
+0003a1e0: 7264 5f70 6169 7220 6973 204e 6f6e 653a  rd_pair is None:
+0003a1f0: 0a20 2020 2020 2020 2020 2020 2023 7072  .            #pr
+0003a200: 696e 7428 274e 6f20 5241 2f44 6563 2e20  int('No RA/Dec. 
+0003a210: 636f 6c75 6d6e 7320 666f 756e 6420 696e  columns found in
+0003a220: 2069 6e70 7574 2074 6162 6c65 2e27 290a   input table.').
+0003a230: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003a240: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
+0003a250: 2020 666f 7220 6320 696e 2072 645f 7061    for c in rd_pa
+0003a260: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
+0003a270: 6966 2073 656c 665b 635d 2e75 6e69 7420  if self[c].unit 
+0003a280: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0003a290: 2020 2020 2020 2020 2073 656c 665b 635d           self[c]
+0003a2a0: 2e75 6e69 7420 3d20 752e 6465 6772 6565  .unit = u.degree
+0003a2b0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0003a2c0: 2072 645f 7061 6972 0a0a 2020 2020 6465   rd_pair..    de
+0003a2d0: 6620 6d61 7463 685f 746f 5f63 6174 616c  f match_to_catal
+0003a2e0: 6f67 5f73 6b79 2873 656c 662c 206f 7468  og_sky(self, oth
+0003a2f0: 6572 2c20 7365 6c66 5f72 6164 6563 3d4e  er, self_radec=N
+0003a300: 6f6e 652c 206f 7468 6572 5f72 6164 6563  one, other_radec
+0003a310: 3d4e 6f6e 652c 206e 7468 6e65 6967 6862  =None, nthneighb
+0003a320: 6f72 3d31 2c20 6765 745f 3264 5f6f 6666  or=1, get_2d_off
+0003a330: 7365 743d 4661 6c73 6529 3a0a 2020 2020  set=False):.    
+0003a340: 2020 2020 2222 2243 6f6d 7075 7465 2060      """Compute `
+0003a350: 7e61 7374 726f 7079 2e63 6f6f 7264 696e  ~astropy.coordin
+0003a360: 6174 6573 2e53 6b79 436f 6f72 6460 2070  ates.SkyCoord` p
+0003a370: 726f 6a65 6374 6564 206d 6174 6368 6573  rojected matches
+0003a380: 2062 6574 7765 656e 2074 776f 2060 4754   between two `GT
+0003a390: 6162 6c65 6020 7461 626c 6573 2e0a 0a20  able` tables... 
+0003a3a0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+0003a3b0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+0003a3c0: 2d2d 2d2d 0a20 2020 2020 2020 206f 7468  ----.        oth
+0003a3d0: 6572 203a 2060 7e61 7374 726f 7079 2e74  er : `~astropy.t
+0003a3e0: 6162 6c65 2e54 6162 6c65 602c 2060 4754  able.Table`, `GT
+0003a3f0: 6162 6c65 602c 206f 7220 606c 6973 7460  able`, or `list`
+0003a400: 2e0a 2020 2020 2020 2020 2020 2020 4f74  ..            Ot
+0003a410: 6865 7220 7461 626c 6520 746f 206d 6174  her table to mat
+0003a420: 6368 2070 6f73 6974 696f 6e73 2066 726f  ch positions fro
+0003a430: 6d2e 0a0a 2020 2020 2020 2020 7365 6c66  m...        self
+0003a440: 5f72 6164 6563 2c20 6f74 6865 725f 7261  _radec, other_ra
+0003a450: 6465 6320 3a20 4e6f 6e65 206f 7220 5b73  dec : None or [s
+0003a460: 7472 2c20 7374 725d 0a20 2020 2020 2020  tr, str].       
+0003a470: 2020 2020 2043 6f6c 756d 6e20 6e61 6d65       Column name
+0003a480: 7320 666f 7220 5241 2061 6e64 2044 6563  s for RA and Dec
+0003a490: 2e20 2049 6620 4e6f 6e65 2c20 7468 656e  .  If None, then
+0003a4a0: 2074 7279 2074 6865 2066 6f6c 6c6f 7769   try the followi
+0003a4b0: 6e67 0a20 2020 2020 2020 2020 2020 2070  ng.            p
+0003a4c0: 6169 7273 2028 696e 2074 6869 7320 6f72  airs (in this or
+0003a4d0: 6465 7229 3a0a 0a20 2020 2020 2020 2020  der):..         
+0003a4e0: 2020 2020 2020 203e 3e3e 2072 645f 7061         >>> rd_pa
+0003a4f0: 6972 7320 3d20 4f72 6465 7265 6444 6963  irs = OrderedDic
+0003a500: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0003a510: 2020 2020 3e3e 3e20 7264 5f70 6169 7273      >>> rd_pairs
+0003a520: 5b27 7261 275d 203d 2027 6465 6327 0a20  ['ra'] = 'dec'. 
+0003a530: 2020 2020 2020 2020 2020 2020 2020 203e                 >
+0003a540: 3e3e 2072 645f 7061 6972 735b 2741 4c50  >> rd_pairs['ALP
+0003a550: 4841 5f4a 3230 3030 275d 203d 2027 4445  HA_J2000'] = 'DE
+0003a560: 4c54 415f 4a32 3030 3027 0a20 2020 2020  LTA_J2000'.     
+0003a570: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
+0003a580: 645f 7061 6972 735b 2758 5f57 4f52 4c44  d_pairs['X_WORLD
+0003a590: 275d 203d 2027 595f 574f 524c 4427 0a0a  '] = 'Y_WORLD'..
+0003a5a0: 2020 2020 2020 2020 6e74 686e 6569 6768          nthneigh
+0003a5b0: 626f 7220 3a20 696e 740a 2020 2020 2020  bor : int.      
+0003a5c0: 2020 2020 2020 5365 6520 607e 6173 7472        See `~astr
+0003a5d0: 6f70 792e 636f 6f72 6469 6e61 7465 732e  opy.coordinates.
+0003a5e0: 536b 7943 6f6f 7264 2e63 6f6f 2e6d 6174  SkyCoord.coo.mat
+0003a5f0: 6368 5f74 6f5f 6361 7461 6c6f 675f 736b  ch_to_catalog_sk
+0003a600: 7960 2e0a 0a20 2020 2020 2020 2052 6574  y`...        Ret
+0003a610: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
+0003a620: 2d2d 2d2d 0a20 2020 2020 2020 2069 6478  ----.        idx
+0003a630: 203a 2069 6e74 2061 7272 6179 0a20 2020   : int array.   
+0003a640: 2020 2020 2020 2020 2049 6e64 6963 6573           Indices
+0003a650: 206f 6620 7468 6520 6d61 7463 6865 7320   of the matches 
+0003a660: 6173 2069 6e0a 0a20 2020 2020 2020 2020  as in..         
+0003a670: 2020 2020 2020 203e 3e3e 206d 6174 6368         >>> match
+0003a680: 6564 203d 2073 656c 665b 6964 785d 0a20  ed = self[idx]. 
+0003a690: 2020 2020 2020 2020 2020 2020 2020 203e                 >
+0003a6a0: 3e3e 206c 656e 286d 6174 6368 6564 2920  >> len(matched) 
+0003a6b0: 3d3d 206c 656e 286f 7468 6572 290a 0a20  == len(other).. 
+0003a6c0: 2020 2020 2020 2064 7220 3a20 666c 6f61         dr : floa
+0003a6d0: 7420 6172 7261 790a 2020 2020 2020 2020  t array.        
+0003a6e0: 2020 2020 5072 6f6a 6563 7465 6420 7365      Projected se
+0003a6f0: 7061 7261 7469 6f6e 206f 6620 636c 6f73  paration of clos
+0003a700: 6573 7420 6d61 7463 682e 0a0a 2020 2020  est match...    
+0003a710: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
+0003a720: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 0a20       --------.. 
+0003a730: 2020 2020 2020 2020 2020 2020 2020 203e                 >
+0003a740: 3e3e 2069 6d70 6f72 7420 6173 7472 6f70  >> import astrop
+0003a750: 792e 756e 6974 7320 6173 2075 0a0a 2020  y.units as u..  
+0003a760: 2020 2020 2020 2020 2020 2020 2020 3e3e                >>
+0003a770: 3e20 7265 6620 3d20 4754 6162 6c65 2e67  > ref = GTable.g
+0003a780: 7265 6164 2827 696e 7075 742e 6361 7427  read('input.cat'
+0003a790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003a7a0: 2020 3e3e 3e20 6761 6961 203d 2047 5461    >>> gaia = GTa
+0003a7b0: 626c 652e 6772 6561 6428 2767 6169 612e  ble.gread('gaia.
+0003a7c0: 6361 7427 290a 2020 2020 2020 2020 2020  cat').          
+0003a7d0: 2020 2020 2020 3e3e 3e20 6964 782c 2064        >>> idx, d
+0003a7e0: 7220 3d20 7265 662e 6d61 7463 685f 746f  r = ref.match_to
+0003a7f0: 5f63 6174 616c 6f67 5f73 6b79 2867 6169  _catalog_sky(gai
+0003a800: 6129 0a20 2020 2020 2020 2020 2020 2020  a).             
+0003a810: 2020 203e 3e3e 2063 6c6f 7365 203d 2064     >>> close = d
+0003a820: 7220 3c20 312a 752e 6172 6373 6563 0a0a  r < 1*u.arcsec..
+0003a830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a840: 3e3e 3e20 7265 665f 6d61 7463 6820 3d20  >>> ref_match = 
+0003a850: 7265 665b 6964 785d 5b63 6c6f 7365 5d0a  ref[idx][close].
+0003a860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a870: 3e3e 3e20 6761 6961 5f6d 6174 6368 203d  >>> gaia_match =
+0003a880: 2067 6169 615b 636c 6f73 655d 0a0a 2020   gaia[close]..  
+0003a890: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0003a8a0: 2020 6672 6f6d 2061 7374 726f 7079 2e63    from astropy.c
+0003a8b0: 6f6f 7264 696e 6174 6573 2069 6d70 6f72  oordinates impor
+0003a8c0: 7420 536b 7943 6f6f 7264 0a0a 2020 2020  t SkyCoord..    
+0003a8d0: 2020 2020 6966 2073 656c 665f 7261 6465      if self_rade
+0003a8e0: 6320 6973 204e 6f6e 653a 0a20 2020 2020  c is None:.     
+0003a8f0: 2020 2020 2020 2072 6420 3d20 7365 6c66         rd = self
+0003a900: 2e70 6172 7365 5f72 6164 6563 5f63 6f6c  .parse_radec_col
+0003a910: 756d 6e73 2873 656c 6629 0a20 2020 2020  umns(self).     
+0003a920: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003a930: 2020 2020 2072 6420 3d20 7365 6c66 2e70       rd = self.p
+0003a940: 6172 7365 5f72 6164 6563 5f63 6f6c 756d  arse_radec_colum
+0003a950: 6e73 2873 656c 662c 2072 645f 7061 6972  ns(self, rd_pair
+0003a960: 733d 7b73 656c 665f 7261 6465 635b 305d  s={self_radec[0]
+0003a970: 3a20 7365 6c66 5f72 6164 6563 5b31 5d7d  : self_radec[1]}
+0003a980: 290a 0a20 2020 2020 2020 2069 6620 7264  )..        if rd
+0003a990: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
+0003a9a0: 2020 2020 2020 2070 7269 6e74 2827 4e6f         print('No
+0003a9b0: 2052 412f 4465 632e 2063 6f6c 756d 6e73   RA/Dec. columns
+0003a9c0: 2066 6f75 6e64 2069 6e20 696e 7075 7420   found in input 
+0003a9d0: 7461 626c 652e 2729 0a20 2020 2020 2020  table.').       
+0003a9e0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0003a9f0: 650a 0a20 2020 2020 2020 2073 656c 665f  e..        self_
+0003aa00: 636f 6f20 3d20 536b 7943 6f6f 7264 2872  coo = SkyCoord(r
+0003aa10: 613d 7365 6c66 5b72 645b 305d 5d2c 2064  a=self[rd[0]], d
+0003aa20: 6563 3d73 656c 665b 7264 5b31 5d5d 2c20  ec=self[rd[1]], 
+0003aa30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003aa40: 2020 2020 2020 2020 2020 2020 2066 7261               fra
+0003aa50: 6d65 3d27 6963 7273 2729 0a0a 2020 2020  me='icrs')..    
+0003aa60: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0003aa70: 6528 6f74 6865 722c 206c 6973 7429 207c  e(other, list) |
+0003aa80: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
+0003aa90: 722c 2074 7570 6c65 293a 0a20 2020 2020  r, tuple):.     
+0003aaa0: 2020 2020 2020 2072 6420 3d20 5b73 6c69         rd = [sli
+0003aab0: 6365 2830 2c20 3129 2c20 736c 6963 6528  ce(0, 1), slice(
+0003aac0: 312c 2032 295d 0a0a 2020 2020 2020 2020  1, 2)]..        
+0003aad0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003aae0: 2020 6966 206f 7468 6572 5f72 6164 6563    if other_radec
+0003aaf0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0003ab00: 2020 2020 2020 2020 2020 7264 203d 2073            rd = s
+0003ab10: 656c 662e 7061 7273 655f 7261 6465 635f  elf.parse_radec_
+0003ab20: 636f 6c75 6d6e 7328 6f74 6865 7229 0a20  columns(other). 
+0003ab30: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0003ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ab50: 2072 6420 3d20 7365 6c66 2e70 6172 7365   rd = self.parse
+0003ab60: 5f72 6164 6563 5f63 6f6c 756d 6e73 286f  _radec_columns(o
+0003ab70: 7468 6572 2c20 7264 5f70 6169 7273 3d7b  ther, rd_pairs={
+0003ab80: 6f74 6865 725f 7261 6465 635b 305d 3a20  other_radec[0]: 
+0003ab90: 6f74 6865 725f 7261 6465 635b 315d 7d29  other_radec[1]})
+0003aba0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0003abb0: 2072 6420 6973 2046 616c 7365 3a0a 2020   rd is False:.  
+0003abc0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0003abd0: 696e 7428 274e 6f20 5241 2f44 6563 2e20  int('No RA/Dec. 
+0003abe0: 636f 6c75 6d6e 7320 666f 756e 6420 696e  columns found in
+0003abf0: 2060 6f74 6865 7260 2074 6162 6c65 2e27   `other` table.'
+0003ac00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003ac10: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+0003ac20: 2020 2020 2020 2020 6f74 6865 725f 636f          other_co
+0003ac30: 6f20 3d20 536b 7943 6f6f 7264 2872 613d  o = SkyCoord(ra=
+0003ac40: 6f74 6865 725b 7264 5b30 5d5d 2c20 6465  other[rd[0]], de
+0003ac50: 633d 6f74 6865 725b 7264 5b31 5d5d 2c0a  c=other[rd[1]],.
+0003ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac70: 2020 2020 2020 2020 2020 2020 2066 7261               fra
+0003ac80: 6d65 3d27 6963 7273 2729 0a0a 2020 2020  me='icrs')..    
+0003ac90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0003aca0: 2020 2020 2069 6478 2c20 6432 642c 2064       idx, d2d, d
+0003acb0: 3364 203d 206f 7468 6572 5f63 6f6f 2e6d  3d = other_coo.m
+0003acc0: 6174 6368 5f74 6f5f 6361 7461 6c6f 675f  atch_to_catalog_
+0003acd0: 736b 7928 7365 6c66 5f63 6f6f 2c20 6e74  sky(self_coo, nt
+0003ace0: 686e 6569 6768 626f 723d 6e74 686e 6569  hneighbor=nthnei
+0003acf0: 6768 626f 7229 0a20 2020 2020 2020 2065  ghbor).        e
+0003ad00: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+0003ad10: 2020 2070 7269 6e74 2827 436f 756c 646e     print('Couldn
+0003ad20: 5c27 7420 7275 6e20 536b 7943 6f6f 7264  \'t run SkyCoord
+0003ad30: 2e6d 6174 6368 5f74 6f5f 6361 7461 6c6f  .match_to_catalo
+0003ad40: 675f 736b 7920 7769 7468 270a 2020 2020  g_sky with'.    
+0003ad50: 2020 2020 2020 2020 2020 2020 2020 276e                'n
+0003ad60: 7468 6e65 6967 6862 6f72 2729 0a0a 2020  thneighbor')..  
+0003ad70: 2020 2020 2020 2020 2020 6964 782c 2064            idx, d
+0003ad80: 3264 2c20 6433 6420 3d20 6f74 6865 725f  2d, d3d = other_
+0003ad90: 636f 6f2e 6d61 7463 685f 746f 5f63 6174  coo.match_to_cat
+0003ada0: 616c 6f67 5f73 6b79 2873 656c 665f 636f  alog_sky(self_co
+0003adb0: 6f29 0a20 2020 2020 2020 200a 2020 2020  o).        .    
+0003adc0: 2020 2020 6966 2067 6574 5f32 645f 6f66      if get_2d_of
+0003add0: 6673 6574 3a0a 2020 2020 2020 2020 2020  fset:.          
+0003ade0: 2020 636f 7364 203d 206e 702e 636f 7328    cosd = np.cos(
+0003adf0: 7365 6c66 5f63 6f6f 2e64 6563 2e64 6567  self_coo.dec.deg
+0003ae00: 2f31 3830 2a6e 702e 7069 290a 2020 2020  /180*np.pi).    
+0003ae10: 2020 2020 2020 2020 6472 6120 3d20 286f          dra = (o
+0003ae20: 7468 6572 5f63 6f6f 2e72 612e 6465 6720  ther_coo.ra.deg 
+0003ae30: 2d20 7365 6c66 5f63 6f6f 2e72 612e 6465  - self_coo.ra.de
+0003ae40: 675b 6964 785d 292a 636f 7364 5b69 6478  g[idx])*cosd[idx
+0003ae50: 5d0a 2020 2020 2020 2020 2020 2020 6464  ].            dd
+0003ae60: 6520 3d20 286f 7468 6572 5f63 6f6f 2e64  e = (other_coo.d
+0003ae70: 6563 2e64 6567 202d 2073 656c 665f 636f  ec.deg - self_co
+0003ae80: 6f2e 6465 632e 6465 675b 6964 785d 290a  o.dec.deg[idx]).
+0003ae90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003aea0: 726e 2069 6478 2c20 6432 642e 746f 2875  rn idx, d2d.to(u
+0003aeb0: 2e61 7263 7365 6329 2c20 6472 612a 3336  .arcsec), dra*36
+0003aec0: 3030 2a75 2e61 7263 7365 632c 2064 6465  00*u.arcsec, dde
+0003aed0: 2a33 3630 302a 752e 6172 6373 6563 0a20  *3600*u.arcsec. 
+0003aee0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003aef0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003af00: 6964 782c 2064 3264 2e74 6f28 752e 6172  idx, d2d.to(u.ar
+0003af10: 6373 6563 290a 0a20 2020 2064 6566 206d  csec)..    def m
+0003af20: 6174 6368 5f74 7269 616e 676c 6573 2873  atch_triangles(s
+0003af30: 656c 662c 206f 7468 6572 2c20 7365 6c66  elf, other, self
+0003af40: 5f77 6373 3d4e 6f6e 652c 2078 5f63 6f6c  _wcs=None, x_col
+0003af50: 756d 6e3d 2758 5f49 4d41 4745 272c 2079  umn='X_IMAGE', y
+0003af60: 5f63 6f6c 756d 6e3d 2759 5f49 4d41 4745  _column='Y_IMAGE
+0003af70: 272c 206d 6167 5f63 6f6c 756d 6e3d 274d  ', mag_column='M
+0003af80: 4147 5f41 5554 4f27 2c20 6f74 6865 725f  AG_AUTO', other_
+0003af90: 7261 3d27 585f 574f 524c 4427 2c20 6f74  ra='X_WORLD', ot
+0003afa0: 6865 725f 6465 633d 2759 5f57 4f52 4c44  her_dec='Y_WORLD
+0003afb0: 272c 2070 6978 656c 5f69 6e64 6578 3d31  ', pixel_index=1
+0003afc0: 2c20 6d61 7463 685f 6b77 6172 6773 3d7b  , match_kwargs={
+0003afd0: 7d2c 2070 6164 3d31 3030 2c20 7368 6f77  }, pad=100, show
+0003afe0: 5f64 6961 676e 6f73 7469 633d 4661 6c73  _diagnostic=Fals
+0003aff0: 652c 2061 7574 6f5f 6b65 6570 3d33 2c20  e, auto_keep=3, 
+0003b000: 6d61 784b 6565 703d 3130 2c20 6175 746f  maxKeep=10, auto
+0003b010: 5f6c 696d 6974 3d33 2c20 6261 5f6d 6178  _limit=3, ba_max
+0003b020: 3d30 2e39 392c 2073 6361 6c65 5f64 656e  =0.99, scale_den
+0003b030: 7369 7479 3d31 3029 3a0a 2020 2020 2020  sity=10):.      
+0003b040: 2020 2222 220a 0a20 2020 2020 2020 2078    """..        x
+0003b050: 5f63 6f6c 756d 6e20 3d20 2758 5f49 4d41  _column = 'X_IMA
+0003b060: 4745 270a 2020 2020 2020 2020 795f 636f  GE'.        y_co
+0003b070: 6c75 6d6e 203d 2027 595f 494d 4147 4527  lumn = 'Y_IMAGE'
+0003b080: 0a20 2020 2020 2020 206d 6167 5f63 6f6c  .        mag_col
+0003b090: 756d 6e20 3d20 274d 4147 5f41 5554 4f27  umn = 'MAG_AUTO'
+0003b0a0: 0a20 2020 2020 2020 2070 6978 656c 5f69  .        pixel_i
+0003b0b0: 6e64 6578 3d31 0a20 2020 2020 2020 2070  ndex=1.        p
+0003b0c0: 6164 3d31 3030 0a0a 2020 2020 2020 2020  ad=100..        
+0003b0d0: 6175 746f 5f6b 6565 703d 330a 2020 2020  auto_keep=3.    
+0003b0e0: 2020 2020 6d61 784b 6565 703d 3130 0a20      maxKeep=10. 
+0003b0f0: 2020 2020 2020 2061 7574 6f5f 6c69 6d69         auto_limi
+0003b100: 743d 330a 2020 2020 2020 2020 6261 5f6d  t=3.        ba_m
+0003b110: 6178 203d 2030 2e39 390a 0a20 2020 2020  ax = 0.99..     
+0003b120: 2020 2022 2222 0a20 2020 2020 2020 2066     """.        f
+0003b130: 726f 6d20 7472 6973 7461 7273 2069 6d70  rom tristars imp
+0003b140: 6f72 7420 6d61 7463 680a 0a20 2020 2020  ort match..     
+0003b150: 2020 2069 6620 6861 7361 7474 7228 6f74     if hasattr(ot
+0003b160: 6865 722c 2027 7368 6170 6527 293a 0a20  her, 'shape'):. 
+0003b170: 2020 2020 2020 2020 2020 206f 7468 6572             other
+0003b180: 5f72 6164 6563 203d 206f 7468 6572 2a31  _radec = other*1
+0003b190: 2e0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
+0003b1a0: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
+0003b1b0: 725f 7261 6465 6320 3d20 6e70 2e61 7272  r_radec = np.arr
+0003b1c0: 6179 285b 6f74 6865 725b 6f74 6865 725f  ay([other[other_
+0003b1d0: 7261 5d2c 206f 7468 6572 5b6f 7468 6572  ra], other[other
+0003b1e0: 5f64 6563 5d5d 292e 540a 0a20 2020 2020  _dec]]).T..     
+0003b1f0: 2020 2073 656c 665f 7879 203d 206e 702e     self_xy = np.
+0003b200: 6172 7261 7928 5b73 656c 665b 785f 636f  array([self[x_co
+0003b210: 6c75 6d6e 5d2c 2073 656c 665b 795f 636f  lumn], self[y_co
+0003b220: 6c75 6d6e 5d5d 292e 540a 0a20 2020 2020  lumn]]).T..     
+0003b230: 2020 2023 7879 5f64 727a 203d 206e 702e     #xy_drz = np.
+0003b240: 6172 7261 7928 5b63 6174 5b27 585f 494d  array([cat['X_IM
+0003b250: 4147 4527 5d5b 6f6b 5d2c 2063 6174 5b27  AGE'][ok], cat['
+0003b260: 595f 494d 4147 4527 5d5b 6f6b 5d5d 292e  Y_IMAGE'][ok]]).
+0003b270: 540a 0a20 2020 2020 2020 2069 6620 7365  T..        if se
+0003b280: 6c66 5f77 6373 2069 7320 4e6f 6e65 3a0a  lf_wcs is None:.
+0003b290: 2020 2020 2020 2020 2020 2020 6f74 6865              othe
+0003b2a0: 725f 7879 203d 206f 7468 6572 5f72 6164  r_xy = other_rad
+0003b2b0: 6563 0a20 2020 2020 2020 2020 2020 2063  ec.            c
+0003b2c0: 7574 203d 2028 6f74 6865 725f 7879 5b3a  ut = (other_xy[:
+0003b2d0: 2c20 305d 203e 202d 7061 6429 2026 2028  , 0] > -pad) & (
+0003b2e0: 6f74 6865 725f 7879 5b3a 2c20 305d 203c  other_xy[:, 0] <
+0003b2f0: 2073 656c 665f 7879 5b3a 2c20 305d 2e6d   self_xy[:, 0].m
+0003b300: 6178 2829 2b70 6164 2920 2620 286f 7468  ax()+pad) & (oth
+0003b310: 6572 5f78 795b 3a2c 2031 5d20 3e20 2d70  er_xy[:, 1] > -p
+0003b320: 6164 2920 2620 286f 7468 6572 5f78 795b  ad) & (other_xy[
+0003b330: 3a2c 2030 5d20 3c20 7365 6c66 5f78 795b  :, 0] < self_xy[
+0003b340: 3a2c 2031 5d2e 6d61 7828 292b 7061 6429  :, 1].max()+pad)
+0003b350: 0a20 2020 2020 2020 2020 2020 206f 7468  .            oth
+0003b360: 6572 5f78 7920 3d20 6f74 6865 725f 7879  er_xy = other_xy
+0003b370: 5b63 7574 2c20 3a5d 0a0a 2020 2020 2020  [cut, :]..      
+0003b380: 2020 2020 2020 7879 5f63 656e 7465 7220        xy_center 
+0003b390: 3d20 6e70 2e7a 6572 6f73 2832 290a 0a20  = np.zeros(2).. 
+0003b3a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003b3b0: 2020 2020 2020 2020 206f 7468 6572 5f78           other_x
+0003b3c0: 7920 3d20 7365 6c66 5f77 6373 2e61 6c6c  y = self_wcs.all
+0003b3d0: 5f77 6f72 6c64 3270 6978 286f 7468 6572  _world2pix(other
+0003b3e0: 5f72 6164 6563 2c20 7069 7865 6c5f 696e  _radec, pixel_in
+0003b3f0: 6465 7829 0a20 2020 2020 2020 2020 2020  dex).           
+0003b400: 2069 6620 6861 7361 7474 7228 7365 6c66   if hasattr(self
+0003b410: 5f77 6373 2c20 2770 6978 656c 5f73 6861  _wcs, 'pixel_sha
+0003b420: 7065 2729 3a0a 2020 2020 2020 2020 2020  pe'):.          
+0003b430: 2020 2020 2020 5f6e 6178 6973 312c 205f        _naxis1, _
+0003b440: 6e61 7869 7332 203d 2073 656c 665f 7763  naxis2 = self_wc
+0003b450: 732e 5f6e 6178 6973 0a20 2020 2020 2020  s._naxis.       
+0003b460: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003b470: 2020 2020 2020 2020 2020 205f 6e61 7869             _naxi
+0003b480: 7331 2c20 5f6e 6178 6973 3220 3d20 7365  s1, _naxis2 = se
+0003b490: 6c66 5f77 6373 2e5f 6e61 7869 7331 2c20  lf_wcs._naxis1, 
+0003b4a0: 7365 6c66 5f77 6373 2e5f 6e61 7869 7332  self_wcs._naxis2
+0003b4b0: 0a0a 2020 2020 2020 2020 2020 2020 6375  ..            cu
+0003b4c0: 7420 3d20 286f 7468 6572 5f78 795b 3a2c  t = (other_xy[:,
+0003b4d0: 2030 5d20 3e20 2d70 6164 2920 2620 286f   0] > -pad) & (o
+0003b4e0: 7468 6572 5f78 795b 3a2c 2030 5d20 3c20  ther_xy[:, 0] < 
+0003b4f0: 5f6e 6178 6973 312b 7061 6429 0a20 2020  _naxis1+pad).   
+0003b500: 2020 2020 2020 2020 2063 7574 2026 3d20           cut &= 
+0003b510: 286f 7468 6572 5f78 795b 3a2c 2031 5d20  (other_xy[:, 1] 
+0003b520: 3e20 2d70 6164 2920 2620 286f 7468 6572  > -pad) & (other
+0003b530: 5f78 795b 3a2c 2031 5d20 3c20 5f6e 6178  _xy[:, 1] < _nax
+0003b540: 6973 322b 7061 6429 0a0a 2020 2020 2020  is2+pad)..      
+0003b550: 2020 2020 2020 6f74 6865 725f 7879 203d        other_xy =
+0003b560: 206f 7468 6572 5f78 795b 6375 742c 203a   other_xy[cut, :
+0003b570: 5d0a 2020 2020 2020 2020 2020 2020 7879  ].            xy
+0003b580: 5f63 656e 7465 7220 3d20 7365 6c66 5f77  _center = self_w
+0003b590: 6373 2e77 6373 2e63 7270 6978 2a31 0a0a  cs.wcs.crpix*1..
+0003b5a0: 2020 2020 2020 2020 6966 206c 656e 286f          if len(o
+0003b5b0: 7468 6572 5f78 7929 203c 2033 3a0a 2020  ther_xy) < 3:.  
+0003b5c0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0003b5d0: 274e 6f74 2065 6e6f 7567 6820 736f 7572  'Not enough sour
+0003b5e0: 6365 7320 696e 206d 6174 6368 2063 6174  ces in match cat
+0003b5f0: 616c 6f67 2729 0a20 2020 2020 2020 2020  alog').         
+0003b600: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0003b610: 0a20 2020 2020 2020 2073 656c 665f 7879  .        self_xy
+0003b620: 202d 3d20 7879 5f63 656e 7465 720a 2020   -= xy_center.  
+0003b630: 2020 2020 2020 6f74 6865 725f 7879 202d        other_xy -
+0003b640: 3d20 7879 5f63 656e 7465 720a 0a20 2020  = xy_center..   
+0003b650: 2020 2020 2023 2323 2323 2323 230a 2020       ########.  
+0003b660: 2020 2020 2020 2320 4d61 7463 6820 7375        # Match su
+0003b670: 7266 6163 6520 6465 6e73 6974 7920 6f66  rface density of
+0003b680: 2064 7269 7a7a 6c65 6420 616e 6420 7265   drizzled and re
+0003b690: 6665 7265 6e63 6520 6361 7461 6c6f 6773  ference catalogs
+0003b6a0: 0a20 2020 2020 2020 2069 6620 6d61 675f  .        if mag_
+0003b6b0: 636f 6c75 6d6e 2069 7320 6e6f 7420 4e6f  column is not No
+0003b6c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003b6d0: 6963 7574 203d 206e 702e 6d69 6e69 6d75  icut = np.minimu
+0003b6e0: 6d28 6c65 6e28 7365 6c66 292d 322c 2069  m(len(self)-2, i
+0003b6f0: 6e74 2873 6361 6c65 5f64 656e 7369 7479  nt(scale_density
+0003b700: 2a6f 7468 6572 5f78 792e 7368 6170 655b  *other_xy.shape[
+0003b710: 305d 2929 0a20 2020 2020 2020 2020 2020  0])).           
+0003b720: 2073 656c 665f 6978 203d 206e 702e 6172   self_ix = np.ar
+0003b730: 6773 6f72 7428 7365 6c66 5b6d 6167 5f63  gsort(self[mag_c
+0003b740: 6f6c 756d 6e5d 295b 3a69 6375 745d 0a20  olumn])[:icut]. 
+0003b750: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003b760: 2020 2020 2020 2020 2073 656c 665f 6978           self_ix
+0003b770: 203d 206e 702e 6172 616e 6765 2873 656c   = np.arange(sel
+0003b780: 665f 7879 2e73 6861 7065 5b30 5d29 0a0a  f_xy.shape[0])..
+0003b790: 2020 2020 2020 2020 7365 6c66 5f78 7920          self_xy 
+0003b7a0: 3d20 7365 6c66 5f78 795b 7365 6c66 5f69  = self_xy[self_i
+0003b7b0: 782c 203a 5d0a 0a20 2020 2020 2020 2070  x, :]..        p
+0003b7c0: 6169 725f 6978 203d 206d 6174 6368 2e6d  air_ix = match.m
+0003b7d0: 6174 6368 5f63 6174 616c 6f67 5f74 7269  atch_catalog_tri
+0003b7e0: 2873 656c 665f 7879 2c20 6f74 6865 725f  (self_xy, other_
+0003b7f0: 7879 2c20 6d61 784b 6565 703d 6d61 784b  xy, maxKeep=maxK
+0003b800: 6565 702c 2061 7574 6f5f 6b65 6570 3d61  eep, auto_keep=a
+0003b810: 7574 6f5f 6b65 6570 2c20 6175 746f 5f74  uto_keep, auto_t
+0003b820: 7261 6e73 666f 726d 3d4e 6f6e 652c 2061  ransform=None, a
+0003b830: 7574 6f5f 6c69 6d69 743d 6175 746f 5f6c  uto_limit=auto_l
+0003b840: 696d 6974 2c20 7369 7a65 5f6c 696d 6974  imit, size_limit
+0003b850: 3d5b 352c 2031 3030 305d 2c20 6967 6e6f  =[5, 1000], igno
+0003b860: 7265 5f72 6f74 3d46 616c 7365 2c20 6967  re_rot=False, ig
+0003b870: 6e6f 7265 5f73 6361 6c65 3d54 7275 652c  nore_scale=True,
+0003b880: 2062 615f 6d61 783d 6261 5f6d 6178 290a   ba_max=ba_max).
+0003b890: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0003b8a0: 7061 6972 5f69 7829 203d 3d20 303a 0a20  pair_ix) == 0:. 
+0003b8b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0003b8c0: 2827 4e6f 206d 6174 6368 6573 2729 0a20  ('No matches'). 
+0003b8d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003b8e0: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
+0003b8f0: 2074 662c 2064 782c 2072 6d73 203d 206d   tf, dx, rms = m
+0003b900: 6174 6368 2e67 6574 5f74 7261 6e73 666f  atch.get_transfo
+0003b910: 726d 2873 656c 665f 7879 2c20 6f74 6865  rm(self_xy, othe
+0003b920: 725f 7879 2c20 7061 6972 5f69 782c 2074  r_xy, pair_ix, t
+0003b930: 7261 6e73 666f 726d 3d4e 6f6e 652c 2075  ransform=None, u
+0003b940: 7365 5f72 616e 7361 633d 5472 7565 290a  se_ransac=True).
+0003b950: 0a20 2020 2020 2020 206d 6174 6368 5f69  .        match_i
+0003b960: 7820 3d20 7061 6972 5f69 782a 310a 2020  x = pair_ix*1.  
+0003b970: 2020 2020 2020 6d61 7463 685f 6978 5b3a        match_ix[:
+0003b980: 2c20 305d 203d 2073 656c 665f 6978 5b70  , 0] = self_ix[p
+0003b990: 6169 725f 6978 5b3a 2c20 305d 5d0a 0a20  air_ix[:, 0]].. 
+0003b9a0: 2020 2020 2020 2069 6620 7368 6f77 5f64         if show_d
+0003b9b0: 6961 676e 6f73 7469 633a 0a20 2020 2020  iagnostic:.     
+0003b9c0: 2020 2020 2020 2066 6967 203d 206d 6174         fig = mat
+0003b9d0: 6368 2e6d 6174 6368 5f64 6961 676e 6f73  ch.match_diagnos
+0003b9e0: 7469 635f 706c 6f74 2873 656c 665f 7879  tic_plot(self_xy
+0003b9f0: 2c20 6f74 6865 725f 7879 2c20 7061 6972  , other_xy, pair
+0003ba00: 5f69 782c 2074 663d 4e6f 6e65 2c20 6e65  _ix, tf=None, ne
+0003ba10: 775f 6669 6775 7265 3d54 7275 6529 0a20  w_figure=True). 
+0003ba20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003ba30: 6e20 6d61 7463 685f 6978 2c20 7466 2c20  n match_ix, tf, 
+0003ba40: 6478 2c20 726d 732c 2066 6967 0a20 2020  dx, rms, fig.   
+0003ba50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003ba60: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
+0003ba70: 7463 685f 6978 2c20 7466 2c20 6478 2c20  tch_ix, tf, dx, 
+0003ba80: 726d 730a 0a20 2020 2064 6566 2061 6464  rms..    def add
+0003ba90: 5f61 6c61 6464 696e 2873 656c 662c 2072  _aladdin(self, r
+0003baa0: 645f 636f 6c73 3d5b 2772 6127 2c20 2764  d_cols=['ra', 'd
+0003bab0: 6563 275d 2c20 666f 763d 302e 352c 2073  ec'], fov=0.5, s
+0003bac0: 697a 653d 2834 3030 2c20 3230 3029 2c20  ize=(400, 200), 
+0003bad0: 6465 6661 756c 745f 7669 6577 3d22 502f  default_view="P/
+0003bae0: 4453 5332 2f63 6f6c 6f72 2229 3a0a 2020  DSS2/color"):.  
+0003baf0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0003bb00: 2020 4164 6420 416c 6164 696e 4c69 7465    Add AladinLite
+0003bb10: 2044 4956 2063 6f6c 756d 6e20 746f 2074   DIV column to t
+0003bb20: 6865 2074 6162 6c65 0a0a 2020 2020 2020  he table..      
+0003bb30: 2020 666f 7620 3a20 666f 7620 696e 2064    fov : fov in d
+0003bb40: 6567 7265 6573 0a20 2020 2020 2020 2073  egrees.        s
+0003bb50: 697a 6520 3a20 7369 7a65 206f 6620 4449  ize : size of DI
+0003bb60: 5673 2028 772c 2068 2920 696e 2070 6978  Vs (w, h) in pix
+0003bb70: 656c 7320 2877 2c20 6829 0a0a 2020 2020  els (w, h)..    
+0003bb80: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0003bb90: 2320 3c21 2d2d 2069 6e63 6c75 6465 2041  # <!-- include A
+0003bba0: 6c61 6469 6e20 4c69 7465 2043 5353 2066  ladin Lite CSS f
+0003bbb0: 696c 6520 696e 2074 6865 2068 6561 6420  ile in the head 
+0003bbc0: 7365 6374 696f 6e20 6f66 2079 6f75 7220  section of your 
+0003bbd0: 7061 6765 202d 2d3e 0a20 2020 2020 2020  page -->.       
+0003bbe0: 2023 203c 6c69 6e6b 2072 656c 3d22 7374   # <link rel="st
+0003bbf0: 796c 6573 6865 6574 2220 6872 6566 3d22  ylesheet" href="
+0003bc00: 2f2f 616c 6164 696e 2e75 2d73 7472 6173  //aladin.u-stras
+0003bc10: 6267 2e66 722f 416c 6164 696e 4c69 7465  bg.fr/AladinLite
+0003bc20: 2f61 7069 2f76 322f 6c61 7465 7374 2f61  /api/v2/latest/a
+0003bc30: 6c61 6469 6e2e 6d69 6e2e 6373 7322 202f  ladin.min.css" /
+0003bc40: 3e0a 2020 2020 2020 2020 230a 2020 2020  >.        #.    
+0003bc50: 2020 2020 2320 3c21 2d2d 2079 6f75 2063      # <!-- you c
+0003bc60: 616e 2073 6b69 7020 7468 6520 666f 6c6c  an skip the foll
+0003bc70: 6f77 696e 6720 6c69 6e65 2069 6620 796f  owing line if yo
+0003bc80: 7572 2070 6167 6520 616c 7265 6164 7920  ur page already 
+0003bc90: 696e 7465 6772 6174 6573 2074 6865 206a  integrates the j
+0003bca0: 5175 6572 7920 6c69 6272 6172 7920 2d2d  Query library --
+0003bcb0: 3e0a 2020 2020 2020 2020 2320 3c73 6372  >.        # <scr
+0003bcc0: 6970 7420 7479 7065 3d22 7465 7874 2f6a  ipt type="text/j
+0003bcd0: 6176 6173 6372 6970 7422 2073 7263 3d22  avascript" src="
+0003bce0: 2f2f 636f 6465 2e6a 7175 6572 792e 636f  //code.jquery.co
+0003bcf0: 6d2f 6a71 7565 7279 2d31 2e31 322e 312e  m/jquery-1.12.1.
+0003bd00: 6d69 6e2e 6a73 2220 6368 6172 7365 743d  min.js" charset=
+0003bd10: 2275 7466 2d38 223e 3c2f 7363 7269 7074  "utf-8"></script
+0003bd20: 3e0a 0a20 2020 2020 2020 2061 6c61 203d  >..        ala =
+0003bd30: 205b 2222 2220 2020 203c 6469 7620 6964   ["""    <div id
+0003bd40: 3d22 616c 6164 696e 2d6c 6974 652d 6469  ="aladin-lite-di
+0003bd50: 762d 7b69 7d22 2073 7479 6c65 3d22 7769  v-{i}" style="wi
+0003bd60: 6474 683a 7b77 7369 7a65 7d70 783b 6865  dth:{wsize}px;he
+0003bd70: 6967 6874 3a7b 6873 697a 657d 7078 3b22  ight:{hsize}px;"
+0003bd80: 3e3c 2f64 6976 3e0a 2020 2020 2020 2020  ></div>.        
+0003bd90: 3c73 6372 6970 7420 7479 7065 3d22 7465  <script type="te
+0003bda0: 7874 2f6a 6176 6173 6372 6970 7422 2073  xt/javascript" s
+0003bdb0: 7263 3d22 6874 7470 3a2f 2f61 6c61 6469  rc="http://aladi
+0003bdc0: 6e2e 752d 7374 7261 7362 672e 6672 2f41  n.u-strasbg.fr/A
+0003bdd0: 6c61 6469 6e4c 6974 652f 6170 692f 7632  ladinLite/api/v2
+0003bde0: 2f6c 6174 6573 742f 616c 6164 696e 2e6d  /latest/aladin.m
+0003bdf0: 696e 2e6a 7322 2063 6861 7273 6574 3d22  in.js" charset="
+0003be00: 7574 662d 3822 3e3c 2f73 6372 6970 743e  utf-8"></script>
+0003be10: 0a20 2020 2020 2020 203c 7363 7269 7074  .        <script
+0003be20: 2074 7970 653d 2274 6578 742f 6a61 7661   type="text/java
+0003be30: 7363 7269 7074 223e 0a20 2020 2020 2020  script">.       
+0003be40: 2020 2020 2076 6172 2061 6c61 6469 6e20       var aladin 
+0003be50: 3d20 412e 616c 6164 696e 2827 2361 6c61  = A.aladin('#ala
+0003be60: 6469 6e2d 6c69 7465 2d64 6976 2d7b 697d  din-lite-div-{i}
+0003be70: 272c 2078 7878 7375 7276 6579 3a20 227b  ', xxxsurvey: "{
+0003be80: 7375 7276 6579 7d22 2c20 666f 763a 7b66  survey}", fov:{f
+0003be90: 6f76 7d2c 2074 6172 6765 743a 2022 7b72  ov}, target: "{r
+0003bea0: 617d 207b 6465 637d 2279 7979 293b 0a20  a} {dec}"yyy);. 
+0003beb0: 2020 2020 2020 203c 2f73 6372 6970 743e         </script>
+0003bec0: 3c2f 6469 763e 2222 222e 666f 726d 6174  </div>""".format
+0003bed0: 2869 3d69 2c20 7261 3d72 6f77 5b72 645f  (i=i, ra=row[rd_
+0003bee0: 636f 6c73 5b30 5d5d 2c20 6465 633d 726f  cols[0]], dec=ro
+0003bef0: 775b 7264 5f63 6f6c 735b 315d 5d2c 2073  w[rd_cols[1]], s
+0003bf00: 7572 7665 793d 6465 6661 756c 745f 7669  urvey=default_vi
+0003bf10: 6577 2c20 666f 763d 666f 762c 2068 7369  ew, fov=fov, hsi
+0003bf20: 7a65 3d73 697a 655b 315d 2c20 7773 697a  ze=size[1], wsiz
+0003bf30: 653d 7369 7a65 5b30 5d29 2e72 6570 6c61  e=size[0]).repla
+0003bf40: 6365 2827 7878 7827 2c20 277b 2729 2e72  ce('xxx', '{').r
+0003bf50: 6570 6c61 6365 2827 7979 7927 2c20 277d  eplace('yyy', '}
+0003bf60: 2729 2066 6f72 2069 2c20 726f 7720 696e  ') for i, row in
+0003bf70: 2065 6e75 6d65 7261 7465 2873 656c 6629   enumerate(self)
+0003bf80: 5d0a 0a20 2020 2020 2020 2073 656c 665b  ]..        self[
+0003bf90: 2761 6c61 6469 6e27 5d20 3d20 616c 610a  'aladin'] = ala.
+0003bfa0: 0a20 2020 2064 6566 2077 7269 7465 5f73  .    def write_s
+0003bfb0: 6f72 7461 626c 655f 6874 6d6c 2873 656c  ortable_html(sel
+0003bfc0: 662c 206f 7574 7075 742c 2072 6570 6c61  f, output, repla
+0003bfd0: 6365 5f62 7261 6365 733d 5472 7565 2c20  ce_braces=True, 
+0003bfe0: 6c6f 6361 6c68 6f73 743d 5472 7565 2c20  localhost=True, 
+0003bff0: 6d61 785f 6c69 6e65 733d 3530 2c20 7461  max_lines=50, ta
+0003c000: 626c 655f 6964 3d4e 6f6e 652c 2074 6162  ble_id=None, tab
+0003c010: 6c65 5f63 6c61 7373 3d22 6469 7370 6c61  le_class="displa
+0003c020: 7920 636f 6d70 6163 7422 2c20 6373 733d  y compact", css=
+0003c030: 4e6f 6e65 2c20 6669 6c74 6572 5f63 6f6c  None, filter_col
+0003c040: 756d 6e73 3d5b 5d2c 2062 7574 746f 6e73  umns=[], buttons
+0003c050: 3d5b 2763 7376 275d 2c20 746f 6767 6c65  =['csv'], toggle
+0003c060: 3d54 7275 652c 2075 7365 5f6a 736f 6e3d  =True, use_json=
+0003c070: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
+0003c080: 2222 2257 7261 7070 6572 2061 726f 756e  """Wrapper aroun
+0003c090: 6420 607e 6173 7472 6f70 792e 7461 626c  d `~astropy.tabl
+0003c0a0: 652e 5461 626c 652e 7772 6974 6528 666f  e.Table.write(fo
+0003c0b0: 726d 6174 3d27 6a73 7669 6577 6572 2729  rmat='jsviewer')
+0003c0c0: 602e 0a0a 2020 2020 2020 2020 5061 7261  `...        Para
+0003c0d0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
+0003c0e0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
+0003c0f0: 2020 6f75 7470 7574 203a 2073 7472 0a20    output : str. 
+0003c100: 2020 2020 2020 2020 2020 204f 7574 7075             Outpu
+0003c110: 7420 6669 6c65 6e61 6d65 2e0a 0a20 2020  t filename...   
+0003c120: 2020 2020 2072 6570 6c61 6365 5f62 7261       replace_bra
+0003c130: 6365 7320 3a20 626f 6f6c 0a20 2020 2020  ces : bool.     
+0003c140: 2020 2020 2020 2052 6570 6c61 6365 2027         Replace '
+0003c150: 266c 743b 2720 616e 6420 2726 6774 3b27  &lt;' and '&gt;'
+0003c160: 2063 6861 7261 6374 6572 7320 7468 6174   characters that
+0003c170: 2061 7265 2063 6f6e 7665 7274 6564 0a20   are converted. 
+0003c180: 2020 2020 2020 2020 2020 2061 7574 6f6d             autom
+0003c190: 6174 6963 616c 6c79 2066 726f 6d20 223c  atically from "<
+0003c1a0: 3e22 2062 7920 7468 6520 607e 6173 7472  >" by the `~astr
+0003c1b0: 6f70 792e 7461 626c 652e 5461 626c 652e  opy.table.Table.
+0003c1c0: 7772 6974 6560 0a20 2020 2020 2020 2020  write`.         
+0003c1d0: 2020 206d 6574 686f 642e 2054 6865 7265     method. There
+0003c1e0: 2061 7265 2070 6172 616d 6574 6572 7320   are parameters 
+0003c1f0: 666f 7220 646f 696e 6720 7468 6973 2061  for doing this a
+0003c200: 7574 6f6d 6174 6963 616c 6c79 2077 6974  utomatically wit
+0003c210: 680a 2020 2020 2020 2020 2020 2020 6077  h.            `w
+0003c220: 7269 7465 2866 6f72 6d61 743d 2768 746d  rite(format='htm
+0003c230: 6c27 2960 2062 7574 2074 6861 7420 646f  l')` but that do
+0003c240: 6e27 7420 6170 7065 6172 2074 6f20 6265  n't appear to be
+0003c250: 2061 7661 696c 6162 6c65 2077 6974 680a   available with.
+0003c260: 2020 2020 2020 2020 2020 2020 6077 7269              `wri
+0003c270: 7465 2866 6f72 6d61 743d 276a 7376 6965  te(format='jsvie
+0003c280: 7765 7227 2960 2e0a 0a20 2020 2020 2020  wer')`...       
+0003c290: 206c 6f63 616c 686f 7374 203a 2062 6f6f   localhost : boo
+0003c2a0: 6c0a 2020 2020 2020 2020 2020 2020 5573  l.            Us
+0003c2b0: 6520 6c6f 6361 6c20 4a53 2066 696c 6573  e local JS files
+0003c2c0: 2e20 4f74 6865 7277 6973 6520 7573 6520  . Otherwise use 
+0003c2d0: 6669 6c65 7320 686f 7374 6564 2065 7874  files hosted ext
+0003c2e0: 6572 6e61 6c6c 792e 0a0a 2020 2020 2020  ernally...      
+0003c2f0: 2020 6669 6c74 6572 5f63 6f6c 756d 6e73    filter_columns
+0003c300: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+0003c310: 2020 2020 4164 6420 6f70 7469 6f6e 2074      Add option t
+0003c320: 6f20 6c69 6d69 7420 6d69 6e2f 6d61 7820  o limit min/max 
+0003c330: 7661 6c75 6573 206f 6620 636f 6c75 6d6e  values of column
+0003c340: 2064 6174 610a 0a20 2020 2020 2020 2062   data..        b
+0003c350: 7574 746f 6e73 203a 206c 6973 740a 2020  uttons : list.  
+0003c360: 2020 2020 2020 2020 2020 4164 6420 6275            Add bu
+0003c370: 7474 6f6e 7320 666f 7220 6578 706f 7274  ttons for export
+0003c380: 696e 6720 6461 7461 2e20 2041 6c6c 6f77  ing data.  Allow
+0003c390: 6564 206f 7074 696f 6e73 2061 7265 0a20  ed options are. 
+0003c3a0: 2020 2020 2020 2020 2020 2027 636f 7079             'copy
+0003c3b0: 272c 2027 6373 7627 2c20 2765 7863 656c  ', 'csv', 'excel
+0003c3c0: 272c 2027 7064 6627 2c20 2770 7269 6e74  ', 'pdf', 'print
+0003c3d0: 272e 0a0a 2020 2020 2020 2020 746f 6767  '...        togg
+0003c3e0: 6c65 203a 2062 6f6f 6c0a 2020 2020 2020  le : bool.      
+0003c3f0: 2020 2020 2020 4164 6420 6c69 6e6b 7320        Add links 
+0003c400: 6174 2074 6f70 206f 6620 7061 6765 2066  at top of page f
+0003c410: 6f72 2074 6f67 676c 696e 6720 636f 6c75  or toggling colu
+0003c420: 6d6e 7320 6f6e 2f6f 6666 0a0a 2020 2020  mns on/off..    
+0003c430: 2020 2020 7573 655f 6a73 6f6e 203a 2062      use_json : b
+0003c440: 6f6f 6c0a 2020 2020 2020 2020 2020 2020  ool.            
+0003c450: 5772 6974 6520 7468 6520 6461 7461 2074  Write the data t
+0003c460: 6f20 6120 4a53 4f4e 2066 696c 6520 616e  o a JSON file an
+0003c470: 6420 7374 7269 7020 6f75 7420 6f66 2074  d strip out of t
+0003c480: 6865 2048 544d 4c20 6865 6164 6572 2e0a  he HTML header..
+0003c490: 2020 2020 2020 2020 2020 2020 5573 6520              Use 
+0003c4a0: 7468 6973 2066 6f72 206c 6172 6765 2064  this for large d
+0003c4b0: 6174 6173 6574 7320 6f72 2069 6620 636f  atasets or if co
+0003c4c0: 6c75 6d6e 7320 696e 636c 7564 6520 7265  lumns include re
+0003c4d0: 6e64 6572 6564 0a20 2020 2020 2020 2020  ndered.         
+0003c4e0: 2020 2069 6d61 6765 732e 0a0a 2020 2020     images...    
+0003c4f0: 2020 2020 6574 6320 3a20 2e2e 2e0a 2020      etc : ....  
+0003c500: 2020 2020 2020 2020 2020 4164 6469 7469            Additi
+0003c510: 6f6e 616c 2070 6172 616d 6574 6572 7320  onal parameters 
+0003c520: 7061 7373 6564 2074 6872 6f75 6768 2074  passed through t
+0003c530: 6f20 6077 7269 7465 602e 0a20 2020 2020  o `write`..     
+0003c540: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+0003c550: 6672 6f6d 2061 7374 726f 7079 2e74 6162  from astropy.tab
+0003c560: 6c65 2e6a 7376 6965 7765 7220 696d 706f  le.jsviewer impo
+0003c570: 7274 2044 4546 4155 4c54 5f43 5353 0a20  rt DEFAULT_CSS. 
+0003c580: 2020 2020 2020 2044 4546 4155 4c54 5f43         DEFAULT_C
+0003c590: 5353 203d 2022 2222 0a62 6f64 7920 7b66  SS = """.body {f
+0003c5a0: 6f6e 742d 6661 6d69 6c79 3a20 7361 6e73  ont-family: sans
+0003c5b0: 2d73 6572 6966 3b7d 0a74 6162 6c65 2e64  -serif;}.table.d
+0003c5c0: 6174 6154 6162 6c65 207b 7769 6474 683a  ataTable {width:
+0003c5d0: 2061 7574 6f20 2169 6d70 6f72 7461 6e74   auto !important
+0003c5e0: 3b20 6d61 7267 696e 3a20 3020 2169 6d70  ; margin: 0 !imp
+0003c5f0: 6f72 7461 6e74 3b7d 0a2e 6461 7461 5461  ortant;}..dataTa
+0003c600: 626c 6573 5f66 696c 7465 722c 202e 6461  bles_filter, .da
+0003c610: 7461 5461 626c 6573 5f70 6167 696e 6174  taTables_paginat
+0003c620: 6520 7b66 6c6f 6174 3a20 6c65 6674 2021  e {float: left !
+0003c630: 696d 706f 7274 616e 743b 206d 6172 6769  important; margi
+0003c640: 6e2d 6c65 6674 3a31 656d 7d0a 7464 207b  n-left:1em}.td {
+0003c650: 666f 6e74 2d73 697a 653a 2031 3070 743b  font-size: 10pt;
+0003c660: 7d0a 2020 2020 2020 2020 2222 220a 2020  }.        """.  
+0003c670: 2020 2020 2020 6966 2063 7373 2069 7320        if css is 
+0003c680: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0003c690: 2020 2020 2020 4445 4641 554c 545f 4353        DEFAULT_CS
+0003c6a0: 5320 2b3d 2063 7373 0a0a 2020 2020 2020  S += css..      
+0003c6b0: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
+0003c6c0: 7374 7328 6f75 7470 7574 293a 0a20 2020  sts(output):.   
+0003c6d0: 2020 2020 2020 2020 206f 732e 7265 6d6f           os.remo
+0003c6e0: 7665 286f 7574 7075 7429 0a0a 2020 2020  ve(output)..    
+0003c6f0: 2020 2020 7365 6c66 2e77 7269 7465 286f      self.write(o
+0003c700: 7574 7075 742c 2066 6f72 6d61 743d 276a  utput, format='j
+0003c710: 7376 6965 7765 7227 2c20 6373 733d 4445  sviewer', css=DE
+0003c720: 4641 554c 545f 4353 532c 0a20 2020 2020  FAULT_CSS,.     
+0003c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c740: 2020 2020 2020 206d 6178 5f6c 696e 6573         max_lines
+0003c750: 3d6d 6178 5f6c 696e 6573 2c0a 2020 2020  =max_lines,.    
+0003c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c770: 2020 2020 2020 2020 6a73 6b77 6172 6773          jskwargs
+0003c780: 3d7b 2775 7365 5f6c 6f63 616c 5f66 696c  ={'use_local_fil
+0003c790: 6573 273a 206c 6f63 616c 686f 7374 7d2c  es': localhost},
+0003c7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003c7b0: 2020 2020 2020 2020 2020 2020 2074 6162               tab
+0003c7c0: 6c65 5f69 643d 4e6f 6e65 2c20 7461 626c  le_id=None, tabl
+0003c7d0: 655f 636c 6173 733d 7461 626c 655f 636c  e_class=table_cl
+0003c7e0: 6173 7329 0a0a 2020 2020 2020 2020 6966  ass)..        if
+0003c7f0: 2072 6570 6c61 6365 5f62 7261 6365 733a   replace_braces:
+0003c800: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+0003c810: 6573 203d 206f 7065 6e28 6f75 7470 7574  es = open(output
+0003c820: 292e 7265 6164 6c69 6e65 7328 290a 2020  ).readlines().  
+0003c830: 2020 2020 2020 2020 2020 6966 2072 6570            if rep
+0003c840: 6c61 6365 5f62 7261 6365 733a 0a20 2020  lace_braces:.   
+0003c850: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003c860: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
+0003c870: 6c69 6e65 7329 293a 0a20 2020 2020 2020  lines)):.       
+0003c880: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+0003c890: 6573 5b69 5d20 3d20 6c69 6e65 735b 695d  es[i] = lines[i]
+0003c8a0: 2e72 6570 6c61 6365 2827 266c 743b 272c  .replace('&lt;',
+0003c8b0: 2027 3c27 290a 2020 2020 2020 2020 2020   '<').          
+0003c8c0: 2020 2020 2020 2020 2020 6c69 6e65 735b            lines[
+0003c8d0: 695d 203d 206c 696e 6573 5b69 5d2e 7265  i] = lines[i].re
+0003c8e0: 706c 6163 6528 2726 6774 3b27 2c20 273e  place('&gt;', '>
+0003c8f0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+0003c900: 6670 203d 206f 7065 6e28 6f75 7470 7574  fp = open(output
+0003c910: 2c20 2777 2729 0a20 2020 2020 2020 2020  , 'w').         
+0003c920: 2020 2066 702e 7772 6974 656c 696e 6573     fp.writelines
+0003c930: 286c 696e 6573 290a 2020 2020 2020 2020  (lines).        
+0003c940: 2020 2020 6670 2e63 6c6f 7365 2829 0a0a      fp.close()..
+0003c950: 2020 2020 2020 2020 2320 5265 6164 2061          # Read a
+0003c960: 6c6c 206c 696e 6573 0a20 2020 2020 2020  ll lines.       
+0003c970: 206c 696e 6573 203d 206f 7065 6e28 6f75   lines = open(ou
+0003c980: 7470 7574 292e 7265 6164 6c69 6e65 7328  tput).readlines(
+0003c990: 290a 0a20 2020 2020 2020 2069 6620 2761  )..        if 'a
+0003c9a0: 6c61 6469 6e27 2069 6e20 7365 6c66 2e63  ladin' in self.c
+0003c9b0: 6f6c 6e61 6d65 733a 0a20 2020 2020 2020  olnames:.       
+0003c9c0: 2020 2020 2023 2049 6e73 6572 7420 416c       # Insert Al
+0003c9d0: 6164 696e 2043 5353 0a20 2020 2020 2020  adin CSS.       
+0003c9e0: 2020 2020 2061 6c61 6469 6e5f 6373 7320       aladin_css 
+0003c9f0: 3d20 273c 6c69 6e6b 2072 656c 3d22 7374  = '<link rel="st
+0003ca00: 796c 6573 6865 6574 2220 6872 6566 3d22  ylesheet" href="
+0003ca10: 6874 7470 733a 2f2f 616c 6164 696e 2e75  https://aladin.u
+0003ca20: 2d73 7472 6173 6267 2e66 722f 416c 6164  -strasbg.fr/Alad
+0003ca30: 696e 4c69 7465 2f61 7069 2f76 322f 6c61  inLite/api/v2/la
+0003ca40: 7465 7374 2f61 6c61 6469 6e2e 6d69 6e2e  test/aladin.min.
+0003ca50: 6373 7322 202f 3e5c 6e27 0a0a 2020 2020  css" />\n'..    
+0003ca60: 2020 2020 2020 2020 666f 7220 696c 2c20          for il, 
+0003ca70: 6c69 6e65 2069 6e20 656e 756d 6572 6174  line in enumerat
+0003ca80: 6528 6c69 6e65 7329 3a0a 2020 2020 2020  e(lines):.      
+0003ca90: 2020 2020 2020 2020 2020 6966 2027 3c6c            if '<l
+0003caa0: 696e 6b20 6872 6566 3d27 2069 6e20 6c69  ink href=' in li
+0003cab0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003cac0: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0003cad0: 2020 2020 2020 2020 2020 206c 696e 6573             lines
+0003cae0: 2e69 6e73 6572 7428 696c 2b31 2c20 616c  .insert(il+1, al
+0003caf0: 6164 696e 5f63 7373 290a 0a20 2020 2020  adin_css)..     
+0003cb00: 2020 2023 2045 7870 6f72 7420 6275 7474     # Export butt
+0003cb10: 6f6e 730a 2020 2020 2020 2020 6966 2062  ons.        if b
+0003cb20: 7574 746f 6e73 3a0a 2020 2020 2020 2020  uttons:.        
+0003cb30: 2020 2020 2320 4353 530a 2020 2020 2020      # CSS.      
+0003cb40: 2020 2020 2020 6373 735f 7363 7269 7074        css_script
+0003cb50: 203d 2027 3c6c 696e 6b20 7265 6c3d 2273   = '<link rel="s
+0003cb60: 7479 6c65 7368 6565 7422 2074 7970 653d  tylesheet" type=
+0003cb70: 2274 6578 742f 6373 7322 2068 7265 663d  "text/css" href=
+0003cb80: 2268 7474 7073 3a2f 2f63 646e 2e64 6174  "https://cdn.dat
+0003cb90: 6174 6162 6c65 732e 6e65 742f 6275 7474  atables.net/butt
+0003cba0: 6f6e 732f 312e 352e 312f 6373 732f 6275  ons/1.5.1/css/bu
+0003cbb0: 7474 6f6e 732e 6461 7461 5461 626c 6573  ttons.dataTables
+0003cbc0: 2e6d 696e 2e63 7373 223e 5c6e 270a 2020  .min.css">\n'.  
+0003cbd0: 2020 2020 2020 2020 2020 666f 7220 696c            for il
+0003cbe0: 2c20 6c69 6e65 2069 6e20 656e 756d 6572  , line in enumer
+0003cbf0: 6174 6528 6c69 6e65 7329 3a0a 2020 2020  ate(lines):.    
+0003cc00: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+0003cc10: 6373 732f 6a71 7565 7279 2e64 6174 6154  css/jquery.dataT
+0003cc20: 6162 6c65 2720 696e 206c 696e 653a 0a20  able' in line:. 
+0003cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cc40: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+0003cc50: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
+0003cc60: 7274 2869 6c2b 312c 2063 7373 5f73 6372  rt(il+1, css_scr
+0003cc70: 6970 7429 0a0a 2020 2020 2020 2020 2020  ipt)..          
+0003cc80: 2020 2320 4a53 206c 6962 7261 7269 6573    # JS libraries
+0003cc90: 0a20 2020 2020 2020 2020 2020 206a 735f  .            js_
+0003cca0: 7363 7269 7074 7320 3d20 2222 220a 2020  scripts = """.  
+0003ccb0: 2020 2020 2020 2020 2020 3c73 6372 6970            <scrip
+0003ccc0: 7420 7479 7065 3d22 7465 7874 2f6a 6176  t type="text/jav
+0003ccd0: 6173 6372 6970 7422 206c 616e 6775 6167  ascript" languag
+0003cce0: 653d 226a 6176 6173 6372 6970 7422 2073  e="javascript" s
+0003ccf0: 7263 3d22 6874 7470 733a 2f2f 6364 6e2e  rc="https://cdn.
+0003cd00: 6461 7461 7461 626c 6573 2e6e 6574 2f62  datatables.net/b
+0003cd10: 7574 746f 6e73 2f31 2e35 2e31 2f6a 732f  uttons/1.5.1/js/
+0003cd20: 6461 7461 5461 626c 6573 2e62 7574 746f  dataTables.butto
+0003cd30: 6e73 2e6d 696e 2e6a 7322 3e3c 2f73 6372  ns.min.js"></scr
+0003cd40: 6970 743e 0a20 2020 2020 2020 2020 2020  ipt>.           
+0003cd50: 203c 7363 7269 7074 2074 7970 653d 2274   <script type="t
+0003cd60: 6578 742f 6a61 7661 7363 7269 7074 2220  ext/javascript" 
+0003cd70: 6c61 6e67 7561 6765 3d22 6a61 7661 7363  language="javasc
+0003cd80: 7269 7074 2220 7372 633d 2268 7474 7073  ript" src="https
+0003cd90: 3a2f 2f63 646e 2e64 6174 6174 6162 6c65  ://cdn.datatable
+0003cda0: 732e 6e65 742f 6275 7474 6f6e 732f 312e  s.net/buttons/1.
+0003cdb0: 352e 312f 6a73 2f62 7574 746f 6e73 2e66  5.1/js/buttons.f
+0003cdc0: 6c61 7368 2e6d 696e 2e6a 7322 3e3c 2f73  lash.min.js"></s
+0003cdd0: 6372 6970 743e 0a20 2020 2020 2020 2020  cript>.         
+0003cde0: 2020 203c 7363 7269 7074 2074 7970 653d     <script type=
+0003cdf0: 2274 6578 742f 6a61 7661 7363 7269 7074  "text/javascript
+0003ce00: 2220 6c61 6e67 7561 6765 3d22 6a61 7661  " language="java
+0003ce10: 7363 7269 7074 2220 7372 633d 2268 7474  script" src="htt
+0003ce20: 7073 3a2f 2f63 646e 6a73 2e63 6c6f 7564  ps://cdnjs.cloud
+0003ce30: 666c 6172 652e 636f 6d2f 616a 6178 2f6c  flare.com/ajax/l
+0003ce40: 6962 732f 6a73 7a69 702f 332e 312e 332f  ibs/jszip/3.1.3/
+0003ce50: 6a73 7a69 702e 6d69 6e2e 6a73 223e 3c2f  jszip.min.js"></
+0003ce60: 7363 7269 7074 3e0a 2020 2020 2020 2020  script>.        
+0003ce70: 2020 2020 3c73 6372 6970 7420 7479 7065      <script type
+0003ce80: 3d22 7465 7874 2f6a 6176 6173 6372 6970  ="text/javascrip
+0003ce90: 7422 206c 616e 6775 6167 653d 226a 6176  t" language="jav
+0003cea0: 6173 6372 6970 7422 2073 7263 3d22 6874  ascript" src="ht
+0003ceb0: 7470 733a 2f2f 6364 6e6a 732e 636c 6f75  tps://cdnjs.clou
+0003cec0: 6466 6c61 7265 2e63 6f6d 2f61 6a61 782f  dflare.com/ajax/
+0003ced0: 6c69 6273 2f70 6466 6d61 6b65 2f30 2e31  libs/pdfmake/0.1
+0003cee0: 2e33 322f 7064 666d 616b 652e 6d69 6e2e  .32/pdfmake.min.
+0003cef0: 6a73 223e 3c2f 7363 7269 7074 3e0a 2020  js"></script>.  
+0003cf00: 2020 2020 2020 2020 2020 3c73 6372 6970            <scrip
+0003cf10: 7420 7479 7065 3d22 7465 7874 2f6a 6176  t type="text/jav
+0003cf20: 6173 6372 6970 7422 206c 616e 6775 6167  ascript" languag
+0003cf30: 653d 226a 6176 6173 6372 6970 7422 2073  e="javascript" s
+0003cf40: 7263 3d22 6874 7470 733a 2f2f 6364 6e6a  rc="https://cdnj
+0003cf50: 732e 636c 6f75 6466 6c61 7265 2e63 6f6d  s.cloudflare.com
+0003cf60: 2f61 6a61 782f 6c69 6273 2f70 6466 6d61  /ajax/libs/pdfma
+0003cf70: 6b65 2f30 2e31 2e33 322f 7666 735f 666f  ke/0.1.32/vfs_fo
+0003cf80: 6e74 732e 6a73 223e 3c2f 7363 7269 7074  nts.js"></script
+0003cf90: 3e0a 2020 2020 2020 2020 2020 2020 3c73  >.            <s
+0003cfa0: 6372 6970 7420 7479 7065 3d22 7465 7874  cript type="text
+0003cfb0: 2f6a 6176 6173 6372 6970 7422 206c 616e  /javascript" lan
+0003cfc0: 6775 6167 653d 226a 6176 6173 6372 6970  guage="javascrip
+0003cfd0: 7422 2073 7263 3d22 6874 7470 733a 2f2f  t" src="https://
+0003cfe0: 6364 6e2e 6461 7461 7461 626c 6573 2e6e  cdn.datatables.n
+0003cff0: 6574 2f62 7574 746f 6e73 2f31 2e35 2e31  et/buttons/1.5.1
+0003d000: 2f6a 732f 6275 7474 6f6e 732e 6874 6d6c  /js/buttons.html
+0003d010: 352e 6d69 6e2e 6a73 223e 3c2f 7363 7269  5.min.js"></scri
+0003d020: 7074 3e0a 2020 2020 2020 2020 2020 2020  pt>.            
+0003d030: 3c73 6372 6970 7420 7479 7065 3d22 7465  <script type="te
+0003d040: 7874 2f6a 6176 6173 6372 6970 7422 206c  xt/javascript" l
+0003d050: 616e 6775 6167 653d 226a 6176 6173 6372  anguage="javascr
+0003d060: 6970 7422 2073 7263 3d22 6874 7470 733a  ipt" src="https:
+0003d070: 2f2f 6364 6e2e 6461 7461 7461 626c 6573  //cdn.datatables
+0003d080: 2e6e 6574 2f62 7574 746f 6e73 2f31 2e35  .net/buttons/1.5
+0003d090: 2e31 2f6a 732f 6275 7474 6f6e 732e 7072  .1/js/buttons.pr
+0003d0a0: 696e 742e 6d69 6e2e 6a73 223e 3c2f 7363  int.min.js"></sc
+0003d0b0: 7269 7074 3e0a 2020 2020 2020 2020 2020  ript>.          
+0003d0c0: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
+0003d0d0: 2020 2066 6f72 2069 6c2c 206c 696e 6520     for il, line 
+0003d0e0: 696e 2065 6e75 6d65 7261 7465 286c 696e  in enumerate(lin
+0003d0f0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
+0003d100: 2020 2020 2069 6620 276a 732f 6a71 7565       if 'js/jque
+0003d110: 7279 2e64 6174 6154 6162 6c65 2720 696e  ry.dataTable' in
+0003d120: 206c 696e 653a 0a20 2020 2020 2020 2020   line:.         
+0003d130: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0003d140: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+0003d150: 6573 2e69 6e73 6572 7428 696c 2b32 2c20  es.insert(il+2, 
+0003d160: 6a73 5f73 6372 6970 7473 290a 0a20 2020  js_scripts)..   
+0003d170: 2020 2020 2020 2020 2066 6f72 2069 6c2c           for il,
+0003d180: 206c 696e 6520 696e 2065 6e75 6d65 7261   line in enumera
+0003d190: 7465 286c 696e 6573 293a 0a20 2020 2020  te(lines):.     
+0003d1a0: 2020 2020 2020 2020 2020 2069 6620 2770             if 'p
+0003d1b0: 6167 654c 656e 6774 6827 2069 6e20 6c69  ageLength' in li
+0003d1c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003d1d0: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0003d1e0: 2020 2020 2020 2020 2020 2062 7574 746f             butto
+0003d1f0: 6e5f 6f70 7469 6f6e 203d 2027 7b73 7061  n_option = '{spa
+0003d200: 6365 727d 646f 6d3a 205c 2742 6c66 7274  cer}dom: \'Blfrt
+0003d210: 6970 5c27 2c5c 6e7b 7370 6163 6572 7d62  ip\',\n{spacer}b
+0003d220: 7574 746f 6e73 3a20 7b62 7374 727d 2c5c  uttons: {bstr},\
+0003d230: 6e27 2e66 6f72 6d61 7428 7370 6163 6572  n'.format(spacer
+0003d240: 3d27 2027 2a38 2c20 6273 7472 3d62 7574  =' '*8, bstr=but
+0003d250: 746f 6e73 2e5f 5f72 6570 725f 5f28 2929  tons.__repr__())
+0003d260: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+0003d270: 6573 2e69 6e73 6572 7428 696c 2b31 2c20  es.insert(il+1, 
+0003d280: 6275 7474 6f6e 5f6f 7074 696f 6e29 0a0a  button_option)..
+0003d290: 2020 2020 2020 2020 2320 5261 6e67 6520          # Range 
+0003d2a0: 636f 6c75 6d6e 730a 2020 2020 2020 2020  columns.        
+0003d2b0: 6963 5f6c 6973 7420 3d20 5b5d 0a0a 2020  ic_list = []..  
+0003d2c0: 2020 2020 2020 6669 6c74 6572 5f6c 696e        filter_lin
+0003d2d0: 6573 203d 205b 223c 7461 626c 653e 5c6e  es = ["<table>\n
+0003d2e0: 225d 0a20 2020 2020 2020 2064 6573 6372  "].        descr
+0003d2f0: 5f70 6164 203d 2027 203c 7370 616e 2073  _pad = ' <span s
+0003d300: 7479 6c65 3d22 6469 7370 6c61 793a 696e  tyle="display:in
+0003d310: 6c69 6e65 2d62 6c6f 636b 3b20 7769 6474  line-block; widt
+0003d320: 683a 3130 3b22 3e3c 2f73 7061 6e3e 2027  h:10;"></span> '
+0003d330: 0a0a 2020 2020 2020 2020 666f 7220 6963  ..        for ic
+0003d340: 2c20 636f 6c20 696e 2065 6e75 6d65 7261  , col in enumera
+0003d350: 7465 2873 656c 662e 636f 6c6e 616d 6573  te(self.colnames
+0003d360: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0003d370: 6620 636f 6c20 696e 2066 696c 7465 725f  f col in filter_
+0003d380: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
+0003d390: 2020 2020 2020 2020 2066 6f75 6e64 203d           found =
+0003d3a0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+0003d3b0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0003d3c0: 7261 6e67 6528 6c65 6e28 6c69 6e65 7329  range(len(lines)
+0003d3d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003d3e0: 2020 2020 2020 2069 6620 273c 7468 3e7b         if '<th>{
+0003d3f0: 307d 272e 666f 726d 6174 2863 6f6c 2920  0}'.format(col) 
+0003d400: 696e 206c 696e 6573 5b69 5d3a 0a20 2020  in lines[i]:.   
+0003d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d420: 2020 2020 2066 6f75 6e64 203d 2054 7275       found = Tru
+0003d430: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0003d440: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0003d450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d460: 2069 6620 666f 756e 643a 0a20 2020 2020   if found:.     
+0003d470: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003d480: 2070 7269 6e74 2863 6f6c 290a 2020 2020   print(col).    
+0003d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d4a0: 6963 5f6c 6973 742e 6170 7065 6e64 2869  ic_list.append(i
+0003d4b0: 6329 0a20 2020 2020 2020 2020 2020 2020  c).             
+0003d4c0: 2020 2020 2020 2023 6c69 6e65 735b 695d         #lines[i]
+0003d4d0: 203d 206c 696e 6573 5b69 5d2e 7265 706c   = lines[i].repl
+0003d4e0: 6163 6528 636f 6c2c 2027 7b30 7d20 3c62  ace(col, '{0} <b
+0003d4f0: 723e 203c 696e 7075 7420 7479 7065 3d22  r> <input type="
+0003d500: 7465 7874 2220 6964 3d22 7b30 7d5f 6d69  text" id="{0}_mi
+0003d510: 6e22 206e 616d 653d 227b 307d 5f6d 696e  n" name="{0}_min
+0003d520: 2220 7374 796c 653d 2277 6964 7468 3a33  " style="width:3
+0003d530: 3070 783b 223e 203c 696e 7075 7420 7479  0px;"> <input ty
+0003d540: 7065 3d22 7465 7874 2220 6964 3d22 7b30  pe="text" id="{0
+0003d550: 7d5f 6d61 7822 206e 616d 653d 227b 307d  }_max" name="{0}
+0003d560: 5f6d 6178 2220 7374 796c 653d 2277 6964  _max" style="wid
+0003d570: 7468 3a33 3070 783b 223e 272e 666f 726d  th:30px;">'.form
+0003d580: 6174 2863 6f6c 2929 0a0a 2020 2020 2020  at(col))..      
+0003d590: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0003d5a0: 6c74 6572 5f6c 696e 6573 202b 3d20 273c  lter_lines += '<
+0003d5b0: 7472 3e20 3c74 643e 203c 696e 7075 7420  tr> <td> <input 
+0003d5c0: 7479 7065 3d22 7465 7874 2220 6964 3d22  type="text" id="
+0003d5d0: 7b30 7d5f 6d69 6e22 206e 616d 653d 227b  {0}_min" name="{
+0003d5e0: 307d 5f6d 696e 2220 7374 796c 653d 2277  0}_min" style="w
+0003d5f0: 6964 7468 3a34 3070 783b 223e 2026 2336  idth:40px;"> &#6
+0003d600: 303b 203c 2f74 643e 203c 7464 3e20 7b30  0; </td> <td> {0
+0003d610: 7d20 3c2f 7464 3e20 3c74 643e 2020 2623  } </td> <td>  &#
+0003d620: 3630 3b20 3c69 6e70 7574 2074 7970 653d  60; <input type=
+0003d630: 2274 6578 7422 2069 643d 227b 307d 5f6d  "text" id="{0}_m
+0003d640: 6178 2220 6e61 6d65 3d22 7b30 7d5f 6d61  ax" name="{0}_ma
+0003d650: 7822 2073 7479 6c65 3d22 7769 6474 683a  x" style="width:
+0003d660: 3430 7078 3b22 3e27 2e66 6f72 6d61 7428  40px;">'.format(
+0003d670: 636f 6c29 0a20 2020 2020 2020 2020 2020  col).           
+0003d680: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0003d690: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0003d6a0: 7363 7220 3d20 275c 6e27 0a20 2020 2020  scr = '\n'.     
+0003d6b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003d6c0: 6620 6861 7361 7474 7228 7365 6c66 2e63  f hasattr(self.c
+0003d6d0: 6f6c 756d 6e73 5b63 6f6c 5d2c 2027 6465  olumns[col], 'de
+0003d6e0: 7363 7269 7074 696f 6e27 293a 0a20 2020  scription'):.   
+0003d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d700: 2020 2020 2069 6620 7365 6c66 2e63 6f6c       if self.col
+0003d710: 756d 6e73 5b63 6f6c 5d2e 6465 7363 7269  umns[col].descri
+0003d720: 7074 696f 6e20 6973 206e 6f74 204e 6f6e  ption is not Non
+0003d730: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003d740: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0003d750: 6573 6372 203d 2027 7b30 7d20 7b31 7d5c  escr = '{0} {1}\
+0003d760: 6e27 2e66 6f72 6d61 7428 6465 7363 725f  n'.format(descr_
+0003d770: 7061 642c 200a 2020 2020 2020 2020 2020  pad, .          
+0003d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d7a0: 2020 7365 6c66 2e63 6f6c 756d 6e73 5b63    self.columns[c
+0003d7b0: 6f6c 5d2e 6465 7363 7269 7074 696f 6e29  ol].description)
+0003d7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d7f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0003d800: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0003d810: 6c74 6572 5f6c 696e 6573 202b 3d20 6465  lter_lines += de
+0003d820: 7363 720a 2020 2020 2020 2020 2020 2020  scr.            
+0003d830: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0003d840: 2069 6620 6963 5f6c 6973 743a 0a20 2020   if ic_list:.   
+0003d850: 2020 2020 2020 2020 2023 2049 6e73 6572           # Inser
+0003d860: 7420 696e 7075 7420 6c69 6e65 730a 0a20  t input lines.. 
+0003d870: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0003d880: 6c2c 206c 696e 6520 696e 2065 6e75 6d65  l, line in enume
+0003d890: 7261 7465 286c 696e 6573 293a 0a20 2020  rate(lines):.   
+0003d8a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0003d8b0: 277d 2029 3b20 203c 2f73 6372 6970 743e  '} );  </script>
+0003d8c0: 2720 696e 206c 696e 653a 0a20 2020 2020  ' in line:.     
+0003d8d0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0003d8e0: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+0003d8f0: 200a 2020 2020 2020 2020 2020 2020 6669   .            fi
+0003d900: 6c74 6572 5f72 6f77 203d 2027 3c74 723e  lter_row = '<tr>
+0003d910: 203c 7464 3e20 3c69 6e70 7574 2074 7970   <td> <input typ
+0003d920: 653d 2274 6578 7422 2069 643d 227b 307d  e="text" id="{0}
+0003d930: 5f6d 696e 2220 6e61 6d65 3d22 7b30 7d5f  _min" name="{0}_
+0003d940: 6d69 6e22 2073 7479 6c65 3d22 7769 6474  min" style="widt
+0003d950: 683a 3430 7078 3b22 3e20 2623 3630 3b20  h:40px;"> &#60; 
+0003d960: 3c2f 7464 3e20 3c74 6420 7374 796c 653d  </td> <td style=
+0003d970: 2261 6c69 676e 3a63 656e 7465 723b 223e  "align:center;">
+0003d980: 203c 7474 3e7b 307d 3c2f 7474 3e20 3c2f   <tt>{0}</tt> </
+0003d990: 7464 3e20 3c74 643e 2020 2623 3630 3b20  td> <td>  &#60; 
+0003d9a0: 3c69 6e70 7574 2074 7970 653d 2274 6578  <input type="tex
+0003d9b0: 7422 2069 643d 227b 307d 5f6d 6178 2220  t" id="{0}_max" 
+0003d9c0: 6e61 6d65 3d22 7b30 7d5f 6d61 7822 2073  name="{0}_max" s
+0003d9d0: 7479 6c65 3d22 7769 6474 683a 3430 7078  tyle="width:40px
+0003d9e0: 3b22 3e27 0a20 2020 2020 2020 2020 2020  ;">'.           
+0003d9f0: 200a 2020 2020 2020 2020 2020 2020 6669   .            fi
+0003da00: 6c74 6572 5f72 6f77 7320 3d20 5b5d 0a20  lter_rows = []. 
+0003da10: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0003da20: 6320 696e 2069 635f 6c69 7374 3a0a 2020  c in ic_list:.  
+0003da30: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0003da40: 6c20 3d20 7365 6c66 2e63 6f6c 6e61 6d65  l = self.colname
+0003da50: 735b 6963 5d0a 2020 2020 2020 2020 2020  s[ic].          
+0003da60: 2020 2020 2020 726f 775f 6920 3d20 6669        row_i = fi
+0003da70: 6c74 6572 5f72 6f77 2e66 6f72 6d61 7428  lter_row.format(
+0003da80: 636f 6c29 0a20 2020 2020 2020 2020 2020  col).           
+0003da90: 2020 2020 2064 6573 6372 203d 2027 5c6e       descr = '\n
+0003daa0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0003dab0: 2020 6966 2068 6173 6174 7472 2873 656c    if hasattr(sel
+0003dac0: 662e 636f 6c75 6d6e 735b 636f 6c5d 2c20  f.columns[col], 
+0003dad0: 2764 6573 6372 6970 7469 6f6e 2729 3a0a  'description'):.
+0003dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003daf0: 2020 2020 6966 2073 656c 662e 636f 6c75      if self.colu
+0003db00: 6d6e 735b 636f 6c5d 2e64 6573 6372 6970  mns[col].descrip
+0003db10: 7469 6f6e 2069 7320 6e6f 7420 4e6f 6e65  tion is not None
+0003db20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003db30: 2020 2020 2020 2020 2020 6465 7363 7220            descr 
+0003db40: 3d20 277b 307d 207b 317d 5c6e 272e 666f  = '{0} {1}\n'.fo
+0003db50: 726d 6174 2864 6573 6372 5f70 6164 2c20  rmat(descr_pad, 
+0003db60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003db80: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+0003db90: 6c75 6d6e 735b 636f 6c5d 2e64 6573 6372  lumns[col].descr
+0003dba0: 6970 7469 6f6e 290a 2020 2020 2020 2020  iption).        
+0003dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dbd0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0003dbe0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0003dbf0: 7465 725f 726f 7773 2e61 7070 656e 6428  ter_rows.append(
+0003dc00: 726f 775f 6920 2b20 6465 7363 7229 0a20  row_i + descr). 
+0003dc10: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+0003dc20: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
+0003dc30: 6572 5f69 6e70 7574 203d 2022 2222 0a0a  er_input = """..
+0003dc40: 3c64 6976 2073 7479 6c65 3d22 626f 7264  <div style="bord
+0003dc50: 6572 3a31 7078 2073 6f6c 6964 2062 6c61  er:1px solid bla
+0003dc60: 636b 3b20 7061 6464 696e 673a 3130 7078  ck; padding:10px
+0003dc70: 3b20 6d61 7267 696e 3a31 3070 7822 3e0a  ; margin:10px">.
+0003dc80: 3c62 3e20 4669 6c74 6572 3a20 3c2f 623e  <b> Filter: </b>
+0003dc90: 0a20 2020 203c 7461 626c 653e 0a20 2020  .    <table>.   
+0003dca0: 2020 207b 307d 0a20 2020 203c 2f74 6162     {0}.    </tab
+0003dcb0: 6c65 3e0a 3c2f 6469 763e 0a0a 2222 222e  le>.</div>..""".
+0003dcc0: 666f 726d 6174 2827 5c6e 272e 6a6f 696e  format('\n'.join
+0003dcd0: 2866 696c 7465 725f 726f 7773 2929 0a0a  (filter_rows))..
+0003dce0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+0003dcf0: 732e 696e 7365 7274 2869 6c2b 312c 2066  s.insert(il+1, f
+0003dd00: 696c 7465 725f 696e 7075 7429 0a0a 2020  ilter_input)..  
+0003dd10: 2020 2020 2020 2020 2020 2320 4a61 7661            # Java
+0003dd20: 7363 7269 7074 2070 7573 6820 6675 6e63  script push func
+0003dd30: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+0003dd40: 2068 6561 6465 725f 6c69 6e65 7320 3d20   header_lines = 
+0003dd50: 2222 0a20 2020 2020 2020 2020 2020 2074  "".            t
+0003dd60: 6573 7465 7220 3d20 5b5d 0a0a 2020 2020  ester = []..    
+0003dd70: 2020 2020 2020 2020 666f 7220 6963 2069          for ic i
+0003dd80: 6e20 6963 5f6c 6973 743a 0a20 2020 2020  n ic_list:.     
+0003dd90: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+0003dda0: 725f 6c69 6e65 7320 2b3d 2022 2222 0a20  r_lines += """. 
+0003ddb0: 2020 2020 2020 2076 6172 206d 696e 5f7b         var min_{
+0003ddc0: 307d 203d 2070 6172 7365 466c 6f61 7428  0} = parseFloat(
+0003ddd0: 2024 2827 237b 307d 5f6d 696e 2729 2e76   $('#{0}_min').v
+0003dde0: 616c 2829 2920 7c7c 202d 3165 3330 3b0a  al()) || -1e30;.
+0003ddf0: 2020 2020 2020 2020 7661 7220 6d61 785f          var max_
+0003de00: 7b30 7d20 3d20 7061 7273 6546 6c6f 6174  {0} = parseFloat
+0003de10: 2820 2428 2723 7b30 7d5f 6d61 7827 292e  ( $('#{0}_max').
+0003de20: 7661 6c28 2929 207c 7c20 2031 6533 303b  val()) ||  1e30;
+0003de30: 0a20 2020 2020 2020 2076 6172 2064 6174  .        var dat
+0003de40: 615f 7b30 7d20 3d20 7061 7273 6546 6c6f  a_{0} = parseFlo
+0003de50: 6174 2820 6461 7461 5b7b 317d 5d20 2920  at( data[{1}] ) 
+0003de60: 7c7c 2030 3b0a 2020 2020 2020 2020 2020  || 0;.          
+0003de70: 2020 2020 2020 2222 222e 666f 726d 6174        """.format
+0003de80: 2873 656c 662e 636f 6c6e 616d 6573 5b69  (self.colnames[i
+0003de90: 635d 2c20 6963 290a 0a20 2020 2020 2020  c], ic)..       
+0003dea0: 2020 2020 2020 2020 2074 6573 7465 722e           tester.
+0003deb0: 6170 7065 6e64 2822 2222 2820 2820 6973  append("""( ( is
+0003dec0: 4e61 4e28 206d 696e 5f7b 307d 2029 2026  NaN( min_{0} ) &
+0003ded0: 2620 6973 4e61 4e28 206d 6178 5f7b 307d  & isNaN( max_{0}
+0003dee0: 2029 2029 207c 7c20 2820 6973 4e61 4e28   ) ) || ( isNaN(
+0003def0: 206d 696e 5f7b 307d 2029 2026 2620 6461   min_{0} ) && da
+0003df00: 7461 5f7b 307d 203c 3d20 6d61 785f 7b30  ta_{0} <= max_{0
+0003df10: 7d20 2920 7c7c 2028 206d 696e 5f7b 307d  } ) || ( min_{0}
+0003df20: 203c 3d20 6461 7461 5f7b 307d 2020 2626   <= data_{0}  &&
+0003df30: 2069 734e 614e 2820 6d61 785f 7b30 7d20   isNaN( max_{0} 
+0003df40: 2920 2920 7c7c 2028 206d 696e 5f7b 307d  ) ) || ( min_{0}
+0003df50: 203c 3d20 6461 7461 5f7b 307d 2020 2626   <= data_{0}  &&
+0003df60: 2064 6174 615f 7b30 7d20 3c3d 206d 6178   data_{0} <= max
+0003df70: 5f7b 307d 2029 2029 2222 222e 666f 726d  _{0} ) )""".form
+0003df80: 6174 2873 656c 662e 636f 6c6e 616d 6573  at(self.colnames
+0003df90: 5b69 635d 2929 0a0a 2020 2020 2020 2020  [ic]))..        
+0003dfa0: 2020 2020 2320 4a61 7661 7363 7269 7074      # Javascript
+0003dfb0: 2066 696c 7465 7220 6675 6e63 7469 6f6e   filter function
+0003dfc0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0003dfd0: 7465 725f 6675 6e63 7469 6f6e 203d 2022  ter_function = "
+0003dfe0: 2222 0a0a 2f2f 2f2f 2050 6172 7365 720a  ""..//// Parser.
+0003dff0: 2f2f 2068 7474 7073 3a2f 2f73 7461 636b  // https://stack
+0003e000: 6f76 6572 666c 6f77 2e63 6f6d 2f71 7565  overflow.com/que
+0003e010: 7374 696f 6e73 2f31 3934 3931 3333 362f  stions/19491336/
+0003e020: 6765 742d 7572 6c2d 7061 7261 6d65 7465  get-url-paramete
+0003e030: 722d 6a71 7565 7279 2d6f 722d 686f 772d  r-jquery-or-how-
+0003e040: 746f 2d67 6574 2d71 7565 7279 2d73 7472  to-get-query-str
+0003e050: 696e 672d 7661 6c75 6573 2d69 6e2d 6a73  ing-values-in-js
+0003e060: 2040 2052 657a 6120 4261 7261 6461 7261   @ Reza Baradara
+0003e070: 6e0a 242e 7572 6c50 6172 616d 203d 2066  n.$.urlParam = f
+0003e080: 756e 6374 696f 6e28 6e61 6d65 297b 7b0a  unction(name){{.
+0003e090: 2020 2020 7661 7220 7265 7375 6c74 7320      var results 
+0003e0a0: 3d20 6e65 7720 5265 6745 7870 2827 5b5c  = new RegExp('[\
+0003e0b0: 3f26 5d27 202b 206e 616d 6520 2b20 273d  ?&]' + name + '=
+0003e0c0: 285b 5e26 235d 2a29 2729 2e65 7865 6328  ([^&#]*)').exec(
+0003e0d0: 7769 6e64 6f77 2e6c 6f63 6174 696f 6e2e  window.location.
+0003e0e0: 6872 6566 293b 0a20 2020 2069 6620 2872  href);.    if (r
+0003e0f0: 6573 756c 7473 3d3d 6e75 6c6c 297b 7b0a  esults==null){{.
+0003e100: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
+0003e110: 6c6c 3b0a 2020 2020 7d7d 0a20 2020 2065  ll;.    }}.    e
+0003e120: 6c73 657b 7b0a 2020 2020 2020 2072 6574  lse{{.       ret
+0003e130: 7572 6e20 6465 636f 6465 5552 4928 7265  urn decodeURI(re
+0003e140: 7375 6c74 735b 315d 2920 7c7c 2030 3b0a  sults[1]) || 0;.
+0003e150: 2020 2020 7d7d 0a7d 7d0a 0a24 2e66 6e2e      }}.}}..$.fn.
+0003e160: 6461 7461 5461 626c 652e 6578 742e 7365  dataTable.ext.se
+0003e170: 6172 6368 2e70 7573 6828 0a20 2020 2066  arch.push(.    f
+0003e180: 756e 6374 696f 6e28 2073 6574 7469 6e67  unction( setting
+0003e190: 732c 2064 6174 612c 2064 6174 6149 6e64  s, data, dataInd
+0003e1a0: 6578 2029 207b 7b0a 7b30 7d0a 0a20 2020  ex ) {{.{0}..   
+0003e1b0: 2020 2020 2069 6620 2820 7b31 7d20 290a       if ( {1} ).
+0003e1c0: 2020 2020 2020 2020 7b7b 0a20 2020 2020          {{.     
+0003e1d0: 2020 2020 2020 2072 6574 7572 6e20 7472         return tr
+0003e1e0: 7565 3b0a 2020 2020 2020 2020 7d7d 0a20  ue;.        }}. 
+0003e1f0: 2020 2020 2020 2072 6574 7572 6e20 6661         return fa
+0003e200: 6c73 653b 0a20 2020 207d 7d0a 293b 0a0a  lse;.    }}.);..
+0003e210: 2f2f 2f2f 2055 7064 6174 6520 5552 4c20  //// Update URL 
+0003e220: 7769 7468 2066 696c 7465 7220 7061 7261  with filter para
+0003e230: 6d65 7465 7273 0a76 6172 2066 696c 7465  meters.var filte
+0003e240: 725f 7061 7261 6d73 203d 207b 327d 3b0a  r_params = {2};.
+0003e250: 0a24 2e55 7064 6174 6546 696c 7465 7255  .$.UpdateFilterU
+0003e260: 524c 203d 2066 756e 6374 696f 6e20 2829  RL = function ()
+0003e270: 207b 7b0a 2020 2020 7661 7220 693b 0a20   {{.    var i;. 
+0003e280: 2020 2076 6172 2066 696c 7465 725f 7572     var filter_ur
+0003e290: 6c20 3d20 2222 3b0a 2020 2020 666f 7220  l = "";.    for 
+0003e2a0: 2869 203d 2030 3b20 6920 3c20 6669 6c74  (i = 0; i < filt
+0003e2b0: 6572 5f70 6172 616d 732e 6c65 6e67 7468  er_params.length
+0003e2c0: 3b20 692b 2b29 207b 7b0a 2020 2020 2020  ; i++) {{.      
+0003e2d0: 2020 6966 2028 2428 2723 272b 6669 6c74    if ($('#'+filt
+0003e2e0: 6572 5f70 6172 616d 735b 695d 2b27 5f6d  er_params[i]+'_m
+0003e2f0: 696e 2729 2e76 616c 2829 2021 3d20 2222  in').val() != ""
+0003e300: 2920 7b7b 0a20 2020 2020 2020 2020 2020  ) {{.           
+0003e310: 2066 696c 7465 725f 7572 6c20 2b3d 2027   filter_url += '
+0003e320: 2627 2b66 696c 7465 725f 7061 7261 6d73  &'+filter_params
+0003e330: 5b69 5d2b 275f 6d69 6e3d 272b 0a20 2020  [i]+'_min='+.   
+0003e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e350: 2024 2827 2327 2b66 696c 7465 725f 7061   $('#'+filter_pa
+0003e360: 7261 6d73 5b69 5d2b 275f 6d69 6e27 292e  rams[i]+'_min').
+0003e370: 7661 6c28 293b 0a20 2020 2020 2020 207d  val();.        }
+0003e380: 7d0a 2020 2020 2020 2020 6966 2028 2428  }.        if ($(
+0003e390: 2723 272b 6669 6c74 6572 5f70 6172 616d  '#'+filter_param
+0003e3a0: 735b 695d 2b27 5f6d 6178 2729 2e76 616c  s[i]+'_max').val
+0003e3b0: 2829 2021 3d20 2222 2920 7b7b 0a20 2020  () != "") {{.   
+0003e3c0: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
+0003e3d0: 7572 6c20 2b3d 2027 2627 2b66 696c 7465  url += '&'+filte
+0003e3e0: 725f 7061 7261 6d73 5b69 5d2b 275f 6d61  r_params[i]+'_ma
+0003e3f0: 783d 272b 0a20 2020 2020 2020 2020 2020  x='+.           
+0003e400: 2020 2020 2020 2020 2024 2827 2327 2b66           $('#'+f
+0003e410: 696c 7465 725f 7061 7261 6d73 5b69 5d2b  ilter_params[i]+
+0003e420: 275f 6d61 7827 292e 7661 6c28 293b 0a20  '_max').val();. 
+0003e430: 2020 2020 2020 207d 7d0a 2020 2020 7d7d         }}.    }}
+0003e440: 0a0a 2020 2020 6966 2028 6669 6c74 6572  ..    if (filter
+0003e450: 5f75 726c 2021 3d20 2222 2920 7b7b 0a20  _url != "") {{. 
+0003e460: 2020 2020 2020 2076 6172 2066 696c 7465         var filte
+0003e470: 7265 645f 7572 6c20 3d20 7769 6e64 6f77  red_url = window
+0003e480: 2e6c 6f63 6174 696f 6e2e 6872 6566 2e73  .location.href.s
+0003e490: 706c 6974 2827 3f27 295b 305d 202b 2027  plit('?')[0] + '
+0003e4a0: 3f27 202b 2066 696c 7465 725f 7572 6c3b  ?' + filter_url;
+0003e4b0: 0a20 2020 2020 2020 2077 696e 646f 772e  .        window.
+0003e4c0: 6869 7374 6f72 792e 7075 7368 5374 6174  history.pushStat
+0003e4d0: 6528 2727 2c20 2727 2c20 6669 6c74 6572  e('', '', filter
+0003e4e0: 6564 5f75 726c 293b 0a20 2020 207d 7d0a  ed_url);.    }}.
+0003e4f0: 7d7d 5c6e 5c6e 2222 222e 666f 726d 6174  }}\n\n""".format
+0003e500: 2868 6561 6465 725f 6c69 6e65 732c 2022  (header_lines, "
+0003e510: 5c6e 2026 2620 222e 6a6f 696e 2874 6573  \n && ".join(tes
+0003e520: 7465 7229 2c20 5b73 656c 662e 636f 6c6e  ter), [self.coln
+0003e530: 616d 6573 5b69 635d 2066 6f72 2069 6320  ames[ic] for ic 
+0003e540: 696e 2069 635f 6c69 7374 5d2e 5f5f 7265  in ic_list].__re
+0003e550: 7072 5f5f 2829 290a 0a20 2020 2020 2020  pr__())..       
+0003e560: 2020 2020 2066 6f72 2069 2c20 6c69 6e65       for i, line
+0003e570: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
+0003e580: 6e65 7329 3a0a 2020 2020 2020 2020 2020  nes):.          
+0003e590: 2020 2020 2020 6966 2022 2428 646f 6375        if "$(docu
+0003e5a0: 6d65 6e74 292e 7265 6164 7928 6675 6e63  ment).ready(func
+0003e5b0: 7469 6f6e 2829 2220 696e 206c 696e 653a  tion()" in line:
+0003e5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e5d0: 2020 2020 2069 7374 6172 7420 3d20 690a       istart = i.
+0003e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e5f0: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+0003e600: 2020 2020 2020 206c 696e 6573 2e69 6e73         lines.ins
+0003e610: 6572 7428 6973 7461 7274 2c20 6669 6c74  ert(istart, filt
+0003e620: 6572 5f66 756e 6374 696f 6e29 0a0a 2020  er_function)..  
+0003e630: 2020 2020 2020 2020 2020 2320 5061 7273            # Pars
+0003e640: 6520 6164 6472 6573 7320 6261 720a 2020  e address bar.  
+0003e650: 2020 2020 2020 2020 2020 6c69 6e65 732e            lines.
+0003e660: 696e 7365 7274 2869 7374 6172 742b 322c  insert(istart+2,
+0003e670: 2022 5c6e 2229 0a20 2020 2020 2020 2020   "\n").         
+0003e680: 2020 2066 6f72 2069 6320 696e 2069 635f     for ic in ic_
+0003e690: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+0003e6a0: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
+0003e6b0: 7274 2869 7374 6172 742b 322c 2022 7b31  rt(istart+2, "{1
+0003e6c0: 7d24 2827 237b 307d 5f6d 6178 2729 2e76  }$('#{0}_max').v
+0003e6d0: 616c 2824 2e75 726c 5061 7261 6d28 277b  al($.urlParam('{
+0003e6e0: 307d 5f6d 6178 2729 293b 5c6e 222e 666f  0}_max'));\n".fo
+0003e6f0: 726d 6174 2873 656c 662e 636f 6c6e 616d  rmat(self.colnam
+0003e700: 6573 5b69 635d 2c20 2720 272a 3329 290a  es[ic], ' '*3)).
+0003e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e720: 6c69 6e65 732e 696e 7365 7274 2869 7374  lines.insert(ist
+0003e730: 6172 742b 322c 2022 7b31 7d24 2827 237b  art+2, "{1}$('#{
+0003e740: 307d 5f6d 696e 2729 2e76 616c 2824 2e75  0}_min').val($.u
+0003e750: 726c 5061 7261 6d28 277b 307d 5f6d 696e  rlParam('{0}_min
+0003e760: 2729 293b 5c6e 222e 666f 726d 6174 2873  '));\n".format(s
+0003e770: 656c 662e 636f 6c6e 616d 6573 5b69 635d  elf.colnames[ic]
+0003e780: 2c20 2720 272a 3329 290a 2020 2020 2020  , ' '*3)).      
+0003e790: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
+0003e7a0: 7274 2869 7374 6172 742b 322c 2022 5c6e  rt(istart+2, "\n
+0003e7b0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+0003e7c0: 2320 496e 7075 7420 6c69 7374 656e 6572  # Input listener
+0003e7d0: 0a20 2020 2020 2020 2020 2020 206c 6973  .            lis
+0003e7e0: 7465 6e65 7220 3d20 2222 220a 2020 2020  tener = """.    
+0003e7f0: 2f2f 2045 7665 6e74 206c 6973 7465 6e65  // Event listene
+0003e800: 7220 746f 2074 6865 2074 776f 2072 616e  r to the two ran
+0003e810: 6765 2066 696c 7465 7269 6e67 2069 6e70  ge filtering inp
+0003e820: 7574 7320 746f 2072 6564 7261 7720 6f6e  uts to redraw on
+0003e830: 2069 6e70 7574 0a20 2020 2024 2827 7b30   input.    $('{0
+0003e840: 7d27 292e 6b65 7975 7028 2066 756e 6374  }').keyup( funct
+0003e850: 696f 6e28 2920 7b7b 0a20 2020 2020 2020  ion() {{.       
+0003e860: 2074 6162 6c65 2e64 7261 7728 293b 0a20   table.draw();. 
+0003e870: 2020 2020 2020 2024 2e55 7064 6174 6546         $.UpdateF
+0003e880: 696c 7465 7255 524c 2829 3b0a 2020 2020  ilterURL();.    
+0003e890: 7d7d 2029 3b0a 2020 2020 2020 2020 2020  }} );.          
+0003e8a0: 2020 2222 222e 666f 726d 6174 2827 2c20    """.format(', 
+0003e8b0: 272e 6a6f 696e 285b 2723 7b30 7d5f 6d69  '.join(['#{0}_mi
+0003e8c0: 6e2c 2023 7b30 7d5f 6d61 7827 2e66 6f72  n, #{0}_max'.for
+0003e8d0: 6d61 7428 7365 6c66 2e63 6f6c 6e61 6d65  mat(self.colname
+0003e8e0: 735b 6963 5d29 2066 6f72 2069 6320 696e  s[ic]) for ic in
+0003e8f0: 2069 635f 6c69 7374 5d29 290a 0a20 2020   ic_list]))..   
+0003e900: 2020 2020 2020 2020 2066 6f72 2069 6c2c           for il,
+0003e910: 206c 696e 6520 696e 2065 6e75 6d65 7261   line in enumera
+0003e920: 7465 286c 696e 6573 293a 0a20 2020 2020  te(lines):.     
+0003e930: 2020 2020 2020 2020 2020 2069 6620 277d             if '}
+0003e940: 2029 3b20 203c 2f73 6372 6970 743e 2720   );  </script>' 
+0003e950: 696e 206c 696e 653a 0a20 2020 2020 2020  in line:.       
+0003e960: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0003e970: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
+0003e980: 6c69 6e65 732e 696e 7365 7274 2869 6c2c  lines.insert(il,
+0003e990: 206c 6973 7465 6e65 7229 0a0a 2020 2020   listener)..    
+0003e9a0: 2020 2020 2020 2020 6670 203d 206f 7065          fp = ope
+0003e9b0: 6e28 6f75 7470 7574 2c20 2777 2729 0a20  n(output, 'w'). 
+0003e9c0: 2020 2020 2020 2020 2020 2066 702e 7772             fp.wr
+0003e9d0: 6974 656c 696e 6573 286c 696e 6573 290a  itelines(lines).
+0003e9e0: 2020 2020 2020 2020 2020 2020 6670 2e63              fp.c
+0003e9f0: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
+0003ea00: 6966 2074 6f67 676c 653a 0a20 2020 2020  if toggle:.     
+0003ea10: 2020 2020 2020 206c 696e 6573 203d 206f         lines = o
+0003ea20: 7065 6e28 6f75 7470 7574 292e 7265 6164  pen(output).read
+0003ea30: 6c69 6e65 7328 290a 0a20 2020 2020 2020  lines()..       
+0003ea40: 2020 2020 2023 2043 6861 6e67 6520 6361       # Change ca
+0003ea50: 6c6c 2074 6f20 4461 7461 5461 626c 650a  ll to DataTable.
+0003ea60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003ea70: 696c 2c20 6c69 6e65 2069 6e20 656e 756d  il, line in enum
+0003ea80: 6572 6174 6528 6c69 6e65 7329 3a0a 2020  erate(lines):.  
+0003ea90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003eaa0: 2027 6461 7461 5461 626c 6528 2720 696e   'dataTable(' in
+0003eab0: 206c 696e 653a 0a20 2020 2020 2020 2020   line:.         
+0003eac0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0003ead0: 0a0a 2020 2020 2020 2020 2020 2020 6c69  ..            li
+0003eae0: 6e65 735b 696c 5d20 3d20 2220 2020 7661  nes[il] = "   va
+0003eaf0: 7220 7461 626c 6520 3d20 7b30 7d5c 6e22  r table = {0}\n"
+0003eb00: 2e66 6f72 6d61 7428 6c69 6e65 735b 696c  .format(lines[il
+0003eb10: 5d2e 7374 7269 7028 292e 7265 706c 6163  ].strip().replac
+0003eb20: 6528 2764 6174 6154 6162 6c65 272c 2027  e('dataTable', '
+0003eb30: 4461 7461 5461 626c 6527 2929 0a0a 2020  DataTable'))..  
+0003eb40: 2020 2020 2020 2020 2020 2320 4164 6420            # Add 
+0003eb50: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
+0003eb60: 2020 2020 2066 6f72 2069 6c2c 206c 696e       for il, lin
+0003eb70: 6520 696e 2065 6e75 6d65 7261 7465 286c  e in enumerate(l
+0003eb80: 696e 6573 293a 0a20 2020 2020 2020 2020  ines):.         
+0003eb90: 2020 2020 2020 2069 6620 277d 2029 3b20         if '} ); 
+0003eba0: 203c 2f73 6372 6970 743e 2720 696e 206c   </script>' in l
+0003ebb0: 696e 653a 0a20 2020 2020 2020 2020 2020  ine:.           
+0003ebc0: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
+0003ebd0: 2020 2020 2020 2020 2020 2020 746f 6767              togg
+0003ebe0: 6c65 7220 3d20 2222 220a 2020 2020 2428  ler = """.    $(
+0003ebf0: 2761 2e74 6f67 676c 652d 7669 7327 292e  'a.toggle-vis').
+0003ec00: 6f6e 2820 2763 6c69 636b 272c 2066 756e  on( 'click', fun
+0003ec10: 6374 696f 6e20 2865 2920 7b0a 2020 2020  ction (e) {.    
+0003ec20: 2020 2020 652e 7072 6576 656e 7444 6566      e.preventDef
+0003ec30: 6175 6c74 2829 3b0a 0a20 2020 2020 2020  ault();..       
+0003ec40: 202f 2f20 4765 7420 7468 6520 636f 6c75   // Get the colu
+0003ec50: 6d6e 2041 5049 206f 626a 6563 740a 2020  mn API object.  
+0003ec60: 2020 2020 2020 7661 7220 636f 6c75 6d6e        var column
+0003ec70: 203d 2074 6162 6c65 2e63 6f6c 756d 6e28   = table.column(
+0003ec80: 2024 2874 6869 7329 2e61 7474 7228 2764   $(this).attr('d
+0003ec90: 6174 612d 636f 6c75 6d6e 2729 2029 3b0a  ata-column') );.
+0003eca0: 0a20 2020 2020 2020 202f 2f20 546f 6767  .        // Togg
+0003ecb0: 6c65 2074 6865 2076 6973 6962 696c 6974  le the visibilit
+0003ecc0: 790a 2020 2020 2020 2020 636f 6c75 6d6e  y.        column
+0003ecd0: 2e76 6973 6962 6c65 2820 2120 636f 6c75  .visible( ! colu
+0003ece0: 6d6e 2e76 6973 6962 6c65 2829 2029 3b0a  mn.visible() );.
+0003ecf0: 2020 2020 7d20 293b 0a0a 2020 2020 2020      } );..      
+0003ed00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0003ed10: 2020 2020 2020 6c69 6e65 732e 696e 7365        lines.inse
+0003ed20: 7274 2869 6c2c 2074 6f67 676c 6572 290a  rt(il, toggler).
+0003ed30: 0a20 2020 2020 2020 2020 2020 2074 6f67  .            tog
+0003ed40: 676c 655f 6469 7620 3d20 2222 220a 3c64  gle_div = """.<d
+0003ed50: 6976 2073 7479 6c65 3d22 626f 7264 6572  iv style="border
+0003ed60: 3a31 7078 2073 6f6c 6964 2062 6c61 636b  :1px solid black
+0003ed70: 3b20 7061 6464 696e 673a 3130 7078 3b20  ; padding:10px; 
+0003ed80: 6d61 7267 696e 3a31 3070 7822 3e0a 2020  margin:10px">.  
+0003ed90: 2020 3c62 3e54 6f67 676c 6520 636f 6c75    <b>Toggle colu
+0003eda0: 6d6e 3a3c 2f62 3e3c 2f62 723e 207b 307d  mn:</b></br> {0}
+0003edb0: 0a3c 2f64 6976 3e0a 0a20 2020 2020 2020  .</div>..       
+0003edc0: 2020 2020 2022 2222 2e66 6f72 6d61 7428       """.format(
+0003edd0: 2720 3c62 3e2f 3c2f 623e 2027 2e6a 6f69  ' <b>/</b> '.joi
+0003ede0: 6e28 5b27 3c61 2063 6c61 7373 3d22 746f  n(['<a class="to
+0003edf0: 6767 6c65 2d76 6973 2220 6461 7461 2d63  ggle-vis" data-c
+0003ee00: 6f6c 756d 6e3d 227b 307d 223e 203c 7474  olumn="{0}"> <tt
+0003ee10: 3e7b 317d 3c2f 7474 3e20 3c2f 613e 272e  >{1}</tt> </a>'.
+0003ee20: 666f 726d 6174 2869 632c 2063 6f6c 2920  format(ic, col) 
+0003ee30: 666f 7220 6963 2c20 636f 6c20 696e 2065  for ic, col in e
+0003ee40: 6e75 6d65 7261 7465 2873 656c 662e 636f  numerate(self.co
+0003ee50: 6c6e 616d 6573 295d 2929 0a0a 2020 2020  lnames)]))..    
+0003ee60: 2020 2020 2020 2020 6c69 6e65 732e 696e          lines.in
+0003ee70: 7365 7274 2869 6c2b 322c 2074 6f67 676c  sert(il+2, toggl
+0003ee80: 655f 6469 7629 0a0a 2020 2020 2020 2020  e_div)..        
+0003ee90: 2020 2020 6670 203d 206f 7065 6e28 6f75      fp = open(ou
+0003eea0: 7470 7574 2c20 2777 2729 0a20 2020 2020  tput, 'w').     
+0003eeb0: 2020 2020 2020 2066 702e 7772 6974 656c         fp.writel
+0003eec0: 696e 6573 286c 696e 6573 290a 2020 2020  ines(lines).    
+0003eed0: 2020 2020 2020 2020 6670 2e63 6c6f 7365          fp.close
+0003eee0: 2829 0a0a 2020 2020 2020 2020 6966 2075  ()..        if u
+0003eef0: 7365 5f6a 736f 6e3a 0a20 2020 2020 2020  se_json:.       
+0003ef00: 2020 2020 2023 2057 7269 7465 2061 7320       # Write as 
+0003ef10: 6a73 6f6e 0a0a 2020 2020 2020 2020 2020  json..          
+0003ef20: 2020 2320 576f 726b 6172 6f75 6e64 2074    # Workaround t
+0003ef30: 6f20 6765 7420 6173 6369 6920 666f 726d  o get ascii form
+0003ef40: 6174 7469 6e67 0a20 2020 2020 2020 2020  atting.         
+0003ef50: 2020 2023 7064 203d 2073 656c 662e 746f     #pd = self.to
+0003ef60: 5f70 616e 6461 7328 290a 2020 2020 2020  _pandas().      
+0003ef70: 2020 2020 2020 6e65 7720 3d20 4754 6162        new = GTab
+0003ef80: 6c65 2829 0a20 2020 2020 2020 2020 2020  le().           
+0003ef90: 2066 6f72 2063 2069 6e20 7365 6c66 2e63   for c in self.c
+0003efa0: 6f6c 6e61 6d65 733a 0a20 2020 2020 2020  olnames:.       
+0003efb0: 2020 2020 2020 2020 206e 6577 5b63 5d20           new[c] 
+0003efc0: 3d20 7365 6c66 5b63 5d0a 0a20 2020 2020  = self[c]..     
+0003efd0: 2020 2020 2020 2069 6620 2761 6c61 6469         if 'aladi
+0003efe0: 6e27 2069 6e20 7365 6c66 2e63 6f6c 6e61  n' in self.colna
+0003eff0: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
+0003f000: 2020 2020 2070 6420 3d20 4754 6162 6c65       pd = GTable
+0003f010: 286e 6577 292e 746f 5f70 616e 6461 7328  (new).to_pandas(
+0003f020: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0003f030: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003f040: 2020 2020 6e65 772e 7772 6974 6528 272f      new.write('/
+0003f050: 746d 702f 7461 626c 652e 6373 7627 2c20  tmp/table.csv', 
+0003f060: 666f 726d 6174 3d27 6373 7627 2c20 6f76  format='csv', ov
+0003f070: 6572 7772 6974 653d 5472 7565 290a 2020  erwrite=True).  
+0003f080: 2020 2020 2020 2020 2020 2020 2020 7064                pd
+0003f090: 203d 2047 5461 626c 652e 6772 6561 6428   = GTable.gread(
+0003f0a0: 272f 746d 702f 7461 626c 652e 6373 7627  '/tmp/table.csv'
+0003f0b0: 292e 746f 5f70 616e 6461 7328 290a 0a20  ).to_pandas().. 
+0003f0c0: 2020 2020 2020 2020 2020 2023 2052 6566             # Ref
+0003f0d0: 6f72 6d61 7420 746f 206a 736f 6e0a 2020  ormat to json.  
+0003f0e0: 2020 2020 2020 2020 2020 6a73 6f6e 5f64            json_d
+0003f0f0: 6174 6120 3d20 2720 2020 2020 2020 2027  ata = '        '
+0003f100: 202b 2070 642e 746f 5f6a 736f 6e28 6f72   + pd.to_json(or
+0003f110: 6965 6e74 3d27 7661 6c75 6573 2729 2e72  ient='values').r
+0003f120: 6570 6c61 6365 2827 5d2c 5b27 2c20 275c  eplace('],[', '\
+0003f130: 6e20 2020 205d 7878 7878 7878 5c6e 2020  n    ]xxxxxx\n  
+0003f140: 2020 5b5c 6e20 2020 2020 2020 2027 292e    [\n        ').
+0003f150: 7265 706c 6163 6528 272c 2027 2c20 2778  replace(', ', 'x
+0003f160: 636f 6d6d 6173 7061 6365 7827 292e 7265  commaspacex').re
+0003f170: 706c 6163 6528 272c 272c 2027 2c5c 6e20  place(',', ',\n 
+0003f180: 2020 2020 2020 2027 292e 7265 706c 6163         ').replac
+0003f190: 6528 2778 7878 7878 7827 2c20 272c 2729  e('xxxxxx', ',')
+0003f1a0: 2e72 6570 6c61 6365 2827 7863 6f6d 6d61  .replace('xcomma
+0003f1b0: 7370 6163 6578 272c 2027 2c20 2729 0a20  spacex', ', '). 
+0003f1c0: 2020 2020 2020 2020 2020 206a 736f 6e5f             json_
+0003f1d0: 7374 7220 3d20 2222 227b 7b0a 2020 2264  str = """{{.  "d
+0003f1e0: 6174 6122 3a0a 7b30 7d0a 0a7d 7d0a 2222  ata":.{0}..}}.""
+0003f1f0: 222e 666f 726d 6174 286a 736f 6e5f 6461  ".format(json_da
+0003f200: 7461 2e72 6570 6c61 6365 2827 5c5c 2222  ta.replace('\\""
+0003f210: 272c 2027 2227 2929 0a0a 2020 2020 2020  ', '"'))..      
+0003f220: 2020 2020 2020 6670 203d 206f 7065 6e28        fp = open(
+0003f230: 6f75 7470 7574 2e72 6570 6c61 6365 2827  output.replace('
+0003f240: 2e68 746d 6c27 2c20 272e 6a73 6f6e 2729  .html', '.json')
+0003f250: 2c20 2777 2729 0a20 2020 2020 2020 2020  , 'w').         
+0003f260: 2020 2066 702e 7772 6974 6528 6a73 6f6e     fp.write(json
+0003f270: 5f73 7472 290a 2020 2020 2020 2020 2020  _str).          
+0003f280: 2020 6670 2e63 6c6f 7365 2829 0a0a 2020    fp.close()..  
+0003f290: 2020 2020 2020 2020 2020 2320 4564 6974            # Edit
+0003f2a0: 2048 544d 4c20 6669 6c65 0a20 2020 2020   HTML file.     
+0003f2b0: 2020 2020 2020 206c 696e 6573 203d 206f         lines = o
+0003f2c0: 7065 6e28 6f75 7470 7574 292e 7265 6164  pen(output).read
+0003f2d0: 6c69 6e65 7328 290a 0a20 2020 2020 2020  lines()..       
+0003f2e0: 2020 2020 2023 2041 6464 2061 6a61 7820       # Add ajax 
+0003f2f0: 6361 6c6c 2074 6f20 4461 7461 5461 626c  call to DataTabl
+0003f300: 650a 2020 2020 2020 2020 2020 2020 666f  e.            fo
+0003f310: 7220 696c 2c20 6c69 6e65 2069 6e20 656e  r il, line in en
+0003f320: 756d 6572 6174 6528 6c69 6e65 7329 3a0a  umerate(lines):.
+0003f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f340: 6966 2027 7061 6765 4c65 6e67 7468 2720  if 'pageLength' 
+0003f350: 696e 206c 696e 653a 0a20 2020 2020 2020  in line:.       
+0003f360: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0003f370: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
+0003f380: 616a 6178 5f63 616c 6c20 3d20 277b 7370  ajax_call = '{sp
+0003f390: 6163 6572 7d22 616a 6178 223a 2022 7b6a  acer}"ajax": "{j
+0003f3a0: 736f 6e7d 222c 5c6e 7b73 7061 6365 727d  son}",\n{spacer}
+0003f3b0: 2264 6566 6572 5265 6e64 6572 223a 2074  "deferRender": t
+0003f3c0: 7275 652c 5c6e 272e 666f 726d 6174 2873  rue,\n'.format(s
+0003f3d0: 7061 6365 723d 2720 272a 382c 206a 736f  pacer=' '*8, jso
+0003f3e0: 6e3d 6f75 7470 7574 2e72 6570 6c61 6365  n=output.replace
+0003f3f0: 2827 2e68 746d 6c27 2c20 272e 6a73 6f6e  ('.html', '.json
+0003f400: 2729 290a 2020 2020 2020 2020 2020 2020  ')).            
+0003f410: 6c69 6e65 732e 696e 7365 7274 2869 6c2b  lines.insert(il+
+0003f420: 312c 2061 6a61 785f 6361 6c6c 290a 0a20  1, ajax_call).. 
+0003f430: 2020 2020 2020 2020 2020 2023 2053 7472             # Str
+0003f440: 6970 206f 7574 2074 6162 6c65 2062 6f64  ip out table bod
+0003f450: 790a 2020 2020 2020 2020 2020 2020 666f  y.            fo
+0003f460: 7220 6968 6561 642c 206c 696e 6520 696e  r ihead, line in
+0003f470: 2065 6e75 6d65 7261 7465 286c 696e 6573   enumerate(lines
+0003f480: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003f490: 2020 2069 6620 273c 2f74 6865 6164 3e27     if '</thead>'
+0003f4a0: 2069 6e20 6c69 6e65 3a0a 2020 2020 2020   in line:.      
+0003f4b0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+0003f4c0: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
+0003f4d0: 2066 6f72 2069 7461 696c 2c20 6c69 6e65   for itail, line
+0003f4e0: 2069 6e20 656e 756d 6572 6174 6528 6c69   in enumerate(li
+0003f4f0: 6e65 735b 3a3a 2d31 5d29 3a0a 2020 2020  nes[::-1]):.    
+0003f500: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+0003f510: 3c2f 7472 3e27 2069 6e20 6c69 6e65 3a0a  </tr>' in line:.
+0003f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f530: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+0003f540: 2020 2020 2020 2066 7020 3d20 6f70 656e         fp = open
+0003f550: 286f 7574 7075 742c 2027 7727 290a 2020  (output, 'w').  
+0003f560: 2020 2020 2020 2020 2020 6670 2e77 7269            fp.wri
+0003f570: 7465 6c69 6e65 7328 6c69 6e65 735b 3a69  telines(lines[:i
+0003f580: 6865 6164 2b31 5d29 0a20 2020 2020 2020  head+1]).       
+0003f590: 2020 2020 2066 702e 7772 6974 656c 696e       fp.writelin
+0003f5a0: 6573 286c 696e 6573 5b2d 6974 6169 6c3a  es(lines[-itail:
+0003f5b0: 5d29 0a20 2020 2020 2020 2020 2020 2066  ]).            f
+0003f5c0: 702e 636c 6f73 6528 290a 0a0a 6465 6620  p.close()...def 
+0003f5d0: 636f 6c75 6d6e 5f73 7472 696e 675f 6f70  column_string_op
+0003f5e0: 6572 6174 696f 6e28 636f 6c2c 2074 6573  eration(col, tes
+0003f5f0: 742c 206d 6574 686f 643d 2763 6f6e 7461  t, method='conta
+0003f600: 696e 7327 2c20 6c6f 6769 6361 6c3d 276f  ins', logical='o
+0003f610: 7227 293a 0a20 2020 2022 2222 0a20 2020  r'):.    """.   
+0003f620: 2041 6e61 6c6f 676f 7573 2074 6f20 6060   Analogous to ``
+0003f630: 7374 722e 636f 6e74 6169 6e73 6060 2062  str.contains`` b
+0003f640: 7574 2066 6f72 2074 6162 6c65 2063 6f6c  ut for table col
+0003f650: 756d 6e2e 0a0a 2020 2020 5061 7261 6d65  umn...    Parame
+0003f660: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+0003f670: 2d2d 2d0a 2020 2020 636f 6c20 3a20 6974  ---.    col : it
+0003f680: 6572 6162 6c65 206c 6973 7420 6f66 2073  erable list of s
+0003f690: 7472 696e 6773 0a20 2020 2020 2020 204c  trings.        L
+0003f6a0: 6973 7420 6f66 2073 7472 696e 6773 2074  ist of strings t
+0003f6b0: 6f20 7465 7374 2e20 2041 6e79 7468 696e  o test.  Anythin
+0003f6c0: 6720 6974 6572 6162 6c65 2c20 652e 672e  g iterable, e.g.
+0003f6d0: 2c20 6c69 7374 206f 7220 0a20 2020 2020  , list or .     
+0003f6e0: 2020 2060 7e61 7374 726f 7079 2e74 6162     `~astropy.tab
+0003f6f0: 6c65 2e63 6f6c 756d 6e2e 436f 6c75 6d6e  le.column.Column
+0003f700: 602e 0a0a 2020 2020 7465 7374 203a 2073  `...    test : s
+0003f710: 7472 2c20 6c69 7374 206f 6620 7374 7269  tr, list of stri
+0003f720: 6e67 732c 204e 6f6e 652c 206f 7220 736c  ngs, None, or sl
+0003f730: 6963 650a 0a20 2020 2020 2020 2049 6620  ice..        If 
+0003f740: 6060 7465 7374 6060 2069 7320 6120 7374  ``test`` is a st
+0003f750: 7269 6e67 2c20 6f72 206c 6973 7420 6f66  ring, or list of
+0003f760: 2073 7472 696e 6773 2c20 7468 656e 2072   strings, then r
+0003f770: 756e 2074 6865 2073 7472 696e 670a 2020  un the string.  
+0003f780: 2020 2020 2020 6060 6d65 7468 6f64 6060        ``method``
+0003f790: 206f 6e20 6561 6368 2065 6e74 7279 206f   on each entry o
+0003f7a0: 6620 6060 636f 6c60 6020 7769 7468 2060  f ``col`` with `
+0003f7b0: 6074 6573 7460 6020 6173 2074 6865 2061  `test`` as the a
+0003f7c0: 7267 756d 656e 7420 6f72 0a20 2020 2020  rgument or.     
+0003f7d0: 2020 2065 6163 6820 656c 656d 656e 7420     each element 
+0003f7e0: 6f66 2074 6865 2060 6074 6573 7460 6020  of the ``test`` 
+0003f7f0: 6c69 7374 2061 7320 6172 6775 6d65 6e74  list as argument
+0003f800: 732e 0a0a 2020 2020 2020 2020 4966 2060  s...        If `
+0003f810: 6074 6573 7460 6020 6973 204e 6f6e 652c  `test`` is None,
+0003f820: 2072 756e 2060 6d65 7468 6f64 6020 6f6e   run `method` on
+0003f830: 2065 6163 6820 656e 7472 7920 7769 7468   each entry with
+0003f840: 206e 6f20 6172 6775 6d65 6e74 732c 200a   no arguments, .
+0003f850: 2020 2020 2020 2020 652e 672e 2c20 2775          e.g., 'u
+0003f860: 7070 6572 272e 0a0a 2020 2020 2020 2020  pper'...        
+0003f870: 4966 2060 6074 6573 7460 6020 6973 2061  If ``test`` is a
+0003f880: 2060 6073 6c69 6365 6060 2c20 7265 7475   ``slice``, retu
+0003f890: 726e 2073 6c69 6365 6420 7374 7269 6e67  rn sliced string
+0003f8a0: 7320 666f 7220 6561 6368 2065 6e74 7279  s for each entry
+0003f8b0: 2e0a 0a20 2020 206d 6574 686f 6420 3a20  ...    method : 
+0003f8c0: 7374 720a 2020 2020 2020 2020 5374 7269  str.        Stri
+0003f8d0: 6e67 206d 6574 686f 6420 746f 2061 7070  ng method to app
+0003f8e0: 6c79 2074 6f20 6561 6368 2065 6e74 7279  ly to each entry
+0003f8f0: 206f 6620 6060 636f 6c60 602e 2020 452e   of ``col``.  E.
+0003f900: 672e 2c20 2763 6f6e 7461 696e 7327 2c0a  g., 'contains',.
+0003f910: 2020 2020 2020 2020 2773 7461 7274 7377          'startsw
+0003f920: 6974 6827 2c20 2765 6e64 7377 6974 6827  ith', 'endswith'
+0003f930: 2c20 2769 6e64 6578 272e 0a0a 2020 2020  , 'index'...    
+0003f940: 6c6f 6769 6361 6c20 3a20 5b27 6f72 272c  logical : ['or',
+0003f950: 2761 6e64 272c 276e 6f74 275d 0a20 2020  'and','not'].   
+0003f960: 2020 2020 204c 6f67 6963 616c 2074 6573       Logical tes
+0003f970: 7420 746f 2075 7365 2077 6865 6e20 6060  t to use when ``
+0003f980: 7465 7374 6060 2069 7320 6120 6c69 7374  test`` is a list
+0003f990: 206f 6620 7374 7269 6e67 732e 2020 466f   of strings.  Fo
+0003f9a0: 7220 6578 616d 706c 652c 0a20 2020 2020  r example,.     
+0003f9b0: 2020 2069 6620 796f 7520 7761 6e74 2074     if you want t
+0003f9c0: 6f20 7465 7374 2069 6620 7468 6520 636f  o test if the co
+0003f9d0: 6c75 6d6e 2068 6173 2076 616c 7565 7320  lumn has values 
+0003f9e0: 7468 6174 206d 6174 6368 2065 6974 6865  that match eithe
+0003f9f0: 720a 2020 2020 2020 2020 2776 616c 7565  r.        'value
+0003fa00: 3127 206f 7220 2776 616c 7565 3227 2c20  1' or 'value2', 
+0003fa10: 7468 656e 2072 756e 2077 6974 680a 0a20  then run with.. 
+0003fa20: 2020 2020 2020 2020 2020 203e 3e3e 2072             >>> r
+0003fa30: 6573 203d 2063 6f6c 756d 6e5f 746f 5f73  es = column_to_s
+0003fa40: 7472 696e 675f 6f70 6572 6174 696f 6e28  tring_operation(
+0003fa50: 636f 6c2c 205b 2776 616c 7565 3127 2c27  col, ['value1','
+0003fa60: 7661 6c75 6532 275d 2c20 6d65 7468 6f64  value2'], method
+0003fa70: 3d27 636f 6e74 6169 6e73 272c 206c 6f67  ='contains', log
+0003fa80: 6963 616c 3d27 6f72 2729 0a0a 2020 2020  ical='or')..    
+0003fa90: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+0003faa0: 2d2d 2d0a 2020 2020 7265 7375 6c74 203a  ---.    result :
+0003fab0: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
+0003fac0: 7374 206f 6620 6974 6572 6174 6564 2072  st of iterated r
+0003fad0: 6573 756c 7473 206f 6e20 7468 6520 656e  esults on the en
+0003fae0: 7472 6965 7320 6f66 2060 6063 6f6c 6060  tries of ``col``
+0003faf0: 2c20 652e 672e 2c20 6c69 7374 206f 6620  , e.g., list of 
+0003fb00: 0a20 2020 2020 2020 2060 6062 6f6f 6c60  .        ``bool`
+0003fb10: 6020 6f72 2060 6073 7472 696e 6760 602e  ` or ``string``.
+0003fb20: 0a0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+0003fb30: 2069 7369 6e73 7461 6e63 6528 7465 7374   isinstance(test
+0003fb40: 2c20 6c69 7374 293a 0a20 2020 2020 2020  , list):.       
+0003fb50: 2074 6573 745f 6c69 7374 203d 2074 6573   test_list = tes
+0003fb60: 740a 2020 2020 656c 7365 3a0a 2020 2020  t.    else:.    
+0003fb70: 2020 2020 7465 7374 5f6c 6973 7420 3d20      test_list = 
+0003fb80: 5b74 6573 745d 0a0a 2020 2020 6f75 745f  [test]..    out_
+0003fb90: 7465 7374 203d 205b 5d0a 0a20 2020 2066  test = []..    f
+0003fba0: 6f72 2069 2c20 635f 6920 696e 2065 6e75  or i, c_i in enu
+0003fbb0: 6d65 7261 7465 2863 6f6c 293a 0a20 2020  merate(col):.   
+0003fbc0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0003fbd0: 6365 2874 6573 742c 2073 6c69 6365 293a  ce(test, slice):
+0003fbe0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0003fbf0: 5f74 6573 742e 6170 7065 6e64 2863 5f69  _test.append(c_i
+0003fc00: 5b74 6573 745d 290a 2020 2020 2020 2020  [test]).        
+0003fc10: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0003fc20: 2020 2020 2020 6675 6e63 203d 2067 6574        func = get
+0003fc30: 6174 7472 2863 5f69 2c20 6d65 7468 6f64  attr(c_i, method
+0003fc40: 290a 2020 2020 2020 2020 6966 2074 6573  ).        if tes
+0003fc50: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
+0003fc60: 2020 2020 2020 206f 7574 5f74 6573 742e         out_test.
+0003fc70: 6170 7065 6e64 2866 756e 6328 2929 0a20  append(func()). 
+0003fc80: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0003fc90: 6e75 650a 0a20 2020 2020 2020 206c 6973  nue..        lis
+0003fca0: 745f 6920 3d20 5b5d 0a20 2020 2020 2020  t_i = [].       
+0003fcb0: 2066 6f72 2074 5f69 2069 6e20 7465 7374   for t_i in test
+0003fcc0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
+0003fcd0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0003fce0: 2020 2020 2020 2020 6c69 7374 5f69 2e61          list_i.a
+0003fcf0: 7070 656e 6428 6675 6e63 2874 5f69 2929  ppend(func(t_i))
+0003fd00: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0003fd10: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+0003fd20: 2020 2020 206c 6973 745f 692e 6170 7065       list_i.appe
+0003fd30: 6e64 2846 616c 7365 290a 0a20 2020 2020  nd(False)..     
+0003fd40: 2020 206f 7574 5f74 6573 742e 6170 7065     out_test.appe
+0003fd50: 6e64 286c 6973 745f 6929 0a0a 2020 2020  nd(list_i)..    
+0003fd60: 6172 7220 3d20 6e70 2e61 7272 6179 286f  arr = np.array(o
+0003fd70: 7574 5f74 6573 7429 0a20 2020 2073 6820  ut_test).    sh 
+0003fd80: 3d20 6172 722e 7368 6170 650a 0a20 2020  = arr.shape..   
+0003fd90: 2069 6620 6c6f 6769 6361 6c20 6973 204e   if logical is N
+0003fda0: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
+0003fdb0: 7572 6e20 6e70 2e73 7175 6565 7a65 2861  urn np.squeeze(a
+0003fdc0: 7272 290a 2020 2020 656c 6966 206c 6f67  rr).    elif log
+0003fdd0: 6963 616c 2e75 7070 6572 2829 203d 3d20  ical.upper() == 
+0003fde0: 2741 4e44 273a 0a20 2020 2020 2020 2072  'AND':.        r
+0003fdf0: 6574 7572 6e20 6e70 2e73 756d 2861 7272  eturn np.sum(arr
+0003fe00: 2c20 6178 6973 3d31 2920 3e3d 2073 685b  , axis=1) >= sh[
+0003fe10: 315d 0a20 2020 2065 6c69 6620 6c6f 6769  1].    elif logi
+0003fe20: 6361 6c2e 7570 7065 7228 2920 3d3d 2027  cal.upper() == '
+0003fe30: 4e4f 5427 3a0a 2020 2020 2020 2020 7265  NOT':.        re
+0003fe40: 7475 726e 206e 702e 7375 6d28 6172 722c  turn np.sum(arr,
+0003fe50: 2061 7869 733d 3129 203d 3d20 300a 2020   axis=1) == 0.  
+0003fe60: 2020 656c 7365 3a20 2023 204f 520a 2020    else:  # OR.  
+0003fe70: 2020 2020 2020 7265 7475 726e 206e 702e        return np.
+0003fe80: 7375 6d28 6172 722c 2061 7869 733d 3129  sum(arr, axis=1)
+0003fe90: 203e 2030 0a0a 0a64 6566 2063 6f6c 756d   > 0...def colum
+0003fea0: 6e5f 7661 6c75 6573 5f69 6e5f 6c69 7374  n_values_in_list
+0003feb0: 2863 6f6c 2c20 7465 7374 5f6c 6973 7429  (col, test_list)
+0003fec0: 3a0a 2020 2020 2222 2254 6573 7420 6966  :.    """Test if
+0003fed0: 2063 6f6c 756d 6e20 656c 656d 656e 7473   column elements
+0003fee0: 2022 696e 2220 616e 2069 7465 7261 626c   "in" an iterabl
+0003fef0: 6520 2865 2e67 2e2c 2061 206c 6973 7420  e (e.g., a list 
+0003ff00: 6f66 2073 7472 696e 6773 290a 0a20 2020  of strings)..   
+0003ff10: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0003ff20: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
+0003ff30: 6f6c 203a 2060 6173 7472 6f70 792e 7461  ol : `astropy.ta
+0003ff40: 626c 652e 436f 6c75 6d6e 6020 6f72 206f  ble.Column` or o
+0003ff50: 7468 6572 2069 7465 7261 626c 650a 2020  ther iterable.  
+0003ff60: 2020 2020 2020 4772 6f75 7020 6f66 2065        Group of e
+0003ff70: 6e74 7269 6573 2074 6f20 7465 7374 0a0a  ntries to test..
+0003ff80: 2020 2020 7465 7374 5f6c 6973 7420 3a20      test_list : 
+0003ff90: 6974 6572 6162 6c65 0a20 2020 2020 2020  iterable.       
+0003ffa0: 204c 6973 7420 6f66 2076 616c 7565 7320   List of values 
+0003ffb0: 746f 2073 6561 7263 680a 0a20 2020 2052  to search..    R
+0003ffc0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+0003ffd0: 2d2d 0a20 2020 2074 6573 7420 3a20 626f  --.    test : bo
+0003ffe0: 6f6c 2061 7272 6179 0a20 2020 2020 2020  ol array.       
+0003fff0: 2053 696d 706c 6520 7465 7374 3a0a 2020   Simple test:.  
+00040000: 2020 2020 2020 2020 2020 3e3e 3e20 5b63            >>> [c
+00040010: 5f69 2069 6e20 7465 7374 5f6c 6973 7420  _i in test_list 
+00040020: 666f 7220 635f 6920 696e 2063 6f6c 5d0a  for c_i in col].
+00040030: 2020 2020 2222 220a 2020 2020 7465 7374      """.    test
+00040040: 203d 206e 702e 6172 7261 7928 5b63 5f69   = np.array([c_i
+00040050: 2069 6e20 7465 7374 5f6c 6973 7420 666f   in test_list fo
+00040060: 7220 635f 6920 696e 2063 6f6c 5d29 0a20  r c_i in col]). 
+00040070: 2020 2072 6574 7572 6e20 7465 7374 0a0a     return test..
+00040080: 0a64 6566 2066 696c 6c5f 6265 7477 6565  .def fill_betwee
+00040090: 6e5f 7374 6570 7328 782c 2079 302c 2079  n_steps(x, y0, y
+000400a0: 312c 2061 783d 4e6f 6e65 2c20 2a61 7267  1, ax=None, *arg
+000400b0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+000400c0: 2020 2222 220a 2020 2020 4d61 6b65 2060    """.    Make `
+000400d0: 6669 6c6c 5f62 6574 7765 656e 6020 776f  fill_between` wo
+000400e0: 726b 206c 696b 6520 6c69 6e65 7374 796c  rk like linestyl
+000400f0: 653d 2773 7465 7073 2d6d 6964 272e 0a20  e='steps-mid'.. 
+00040100: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
+00040110: 7420 6d61 7470 6c6f 746c 6962 2e70 7970  t matplotlib.pyp
+00040120: 6c6f 7420 6173 2070 6c74 0a20 2020 200a  lot as plt.    .
+00040130: 2020 2020 736f 203d 206e 702e 6172 6773      so = np.args
+00040140: 6f72 7428 7829 0a20 2020 2064 7820 3d20  ort(x).    dx = 
+00040150: 6e70 2e64 6966 6628 785b 736f 5d29 2f32  np.diff(x[so])/2
+00040160: 2e0a 2020 2020 6d69 6420 3d20 785b 736f  ..    mid = x[so
+00040170: 5d5b 3a2d 315d 202b 2064 780a 2020 2020  ][:-1] + dx.    
+00040180: 0a20 2020 2078 6675 6c6c 203d 206e 702e  .    xfull = np.
+00040190: 6873 7461 636b 285b 785b 736f 5d5b 305d  hstack([x[so][0]
+000401a0: 2d64 785b 305d 2c20 6d69 642c 206d 6964  -dx[0], mid, mid
+000401b0: 2b64 782a 322f 312e 6536 2c20 785b 736f  +dx*2/1.e6, x[so
+000401c0: 5d5b 2d31 5d2b 6478 5b2d 315d 5d29 0a20  ][-1]+dx[-1]]). 
+000401d0: 2020 2079 3066 756c 6c20 3d20 6e70 2e68     y0full = np.h
+000401e0: 7374 6163 6b28 5b79 305b 305d 2c20 7930  stack([y0[0], y0
+000401f0: 5b3a 2d31 5d2c 2079 305b 313a 5d2c 2079  [:-1], y0[1:], y
+00040200: 305b 2d31 5d5d 290a 2020 2020 7931 6675  0[-1]]).    y1fu
+00040210: 6c6c 203d 206e 702e 6873 7461 636b 285b  ll = np.hstack([
+00040220: 7931 5b30 5d2c 2079 315b 3a2d 315d 2c20  y1[0], y1[:-1], 
+00040230: 7931 5b31 3a5d 2c20 7931 5b2d 315d 5d29  y1[1:], y1[-1]])
+00040240: 0a20 2020 200a 2020 2020 2320 7866 756c  .    .    # xful
+00040250: 6c20 3d20 6e70 2e61 7070 656e 6428 6e70  l = np.append(np
+00040260: 2e61 7070 656e 6428 782c 206d 6964 292c  .append(x, mid),
+00040270: 206d 6964 2b6e 702e 6469 6666 2878 5b73   mid+np.diff(x[s
+00040280: 6f5d 292f 312e 6536 290a 2020 2020 2320  o])/1.e6).    # 
+00040290: 7930 6675 6c6c 203d 206e 702e 6170 7065  y0full = np.appe
+000402a0: 6e64 286e 702e 6170 7065 6e64 2879 302c  nd(np.append(y0,
+000402b0: 2079 305b 3a2d 315d 292c 2079 305b 313a   y0[:-1]), y0[1:
+000402c0: 5d29 0a20 2020 2023 2079 3166 756c 6c20  ]).    # y1full 
+000402d0: 3d20 6e70 2e61 7070 656e 6428 6e70 2e61  = np.append(np.a
+000402e0: 7070 656e 6428 7931 2c20 7931 5b3a 2d31  ppend(y1, y1[:-1
+000402f0: 5d29 2c20 7931 5b31 3a5d 290a 0a20 2020  ]), y1[1:])..   
+00040300: 2073 6f20 3d20 6e70 2e61 7267 736f 7274   so = np.argsort
+00040310: 2878 6675 6c6c 290a 2020 2020 6966 2061  (xfull).    if a
+00040320: 7820 6973 204e 6f6e 653a 0a20 2020 2020  x is None:.     
+00040330: 2020 2061 7820 3d20 706c 742e 6763 6128     ax = plt.gca(
+00040340: 290a 0a20 2020 2061 782e 6669 6c6c 5f62  )..    ax.fill_b
+00040350: 6574 7765 656e 2878 6675 6c6c 5b73 6f5d  etween(xfull[so]
+00040360: 2c20 7930 6675 6c6c 5b73 6f5d 2c20 7931  , y0full[so], y1
+00040370: 6675 6c6c 5b73 6f5d 2c20 2a61 7267 732c  full[so], *args,
+00040380: 202a 2a6b 7761 7267 7329 0a0a 0a64 6566   **kwargs)...def
+00040390: 2066 696c 6c5f 6d61 736b 6564 5f63 6f76   fill_masked_cov
+000403a0: 6172 2863 6f76 6172 2c20 6d61 736b 293a  ar(covar, mask):
+000403b0: 0a20 2020 2022 2222 4669 6c6c 2061 2063  .    """Fill a c
+000403c0: 6f76 6172 6961 6e63 6520 6d61 7472 6978  ovariance matrix
+000403d0: 2069 6e20 6120 6c61 7267 6572 2061 7272   in a larger arr
+000403e0: 6179 2074 6861 7420 6861 6420 6d61 736b  ay that had mask
+000403f0: 6564 2076 616c 7565 730a 0a20 2020 2050  ed values..    P
+00040400: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00040410: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6f76  --------.    cov
+00040420: 6172 203a 2060 284d 2c4d 2960 2073 7175  ar : `(M,M)` squ
+00040430: 6172 6520 607e 6e70 2e6e 6461 7272 6179  are `~np.ndarray
+00040440: 600a 2020 2020 2020 2020 4d61 736b 6564  `.        Masked
+00040450: 2063 6f76 6172 6961 6e63 6520 6172 7261   covariance arra
+00040460: 792e 0a0a 2020 2020 6d61 736b 203a 2062  y...    mask : b
+00040470: 6f6f 6c20 6d61 736b 2c20 604e 3e4d 600a  ool mask, `N>M`.
+00040480: 2020 2020 2020 2020 5468 6520 6f72 6967          The orig
+00040490: 696e 616c 206d 6173 6b2e 0a0a 2020 2020  inal mask...    
+000404a0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+000404b0: 2d2d 2d0a 2020 2020 636f 7661 725f 6675  ---.    covar_fu
+000404c0: 6c6c 203a 2060 7e6e 702e 6e64 6172 7261  ll : `~np.ndarra
+000404d0: 7960 0a20 2020 2020 2020 2046 756c 6c20  y`.        Full 
+000404e0: 636f 7661 7269 616e 6365 2061 7272 6179  covariance array
+000404f0: 2077 6974 6820 6469 6d65 6e73 696f 6e73   with dimensions
+00040500: 2060 284e 2c4e 2960 2e0a 0a20 2020 2022   `(N,N)`...    "
+00040510: 2222 0a20 2020 204e 203d 206d 6173 6b2e  "".    N = mask.
+00040520: 7368 6170 655b 305d 0a20 2020 2069 6478  shape[0].    idx
+00040530: 203d 206e 702e 6172 616e 6765 284e 295b   = np.arange(N)[
+00040540: 6d61 736b 5d0a 2020 2020 636f 7661 725f  mask].    covar_
+00040550: 6675 6c6c 203d 206e 702e 7a65 726f 7328  full = np.zeros(
+00040560: 284e 2c20 4e29 2c20 6474 7970 653d 636f  (N, N), dtype=co
+00040570: 7661 722e 6474 7970 6529 0a20 2020 2066  var.dtype).    f
+00040580: 6f72 2069 2c20 6969 2069 6e20 656e 756d  or i, ii in enum
+00040590: 6572 6174 6528 6964 7829 3a0a 2020 2020  erate(idx):.    
+000405a0: 2020 2020 666f 7220 6a2c 206a 6a20 696e      for j, jj in
+000405b0: 2065 6e75 6d65 7261 7465 2869 6478 293a   enumerate(idx):
+000405c0: 0a20 2020 2020 2020 2020 2020 2063 6f76  .            cov
+000405d0: 6172 5f66 756c 6c5b 6969 2c20 6a6a 5d20  ar_full[ii, jj] 
+000405e0: 3d20 636f 7661 725b 692c 206a 5d0a 0a20  = covar[i, j].. 
+000405f0: 2020 2072 6574 7572 6e20 636f 7661 725f     return covar_
+00040600: 6675 6c6c 0a0a 0a64 6566 206c 6f67 5f73  full...def log_s
+00040610: 6361 6c65 5f64 7339 2869 6d2c 206c 6578  cale_ds9(im, lex
+00040620: 703d 312e 6531 322c 2063 6d61 703d 5b37  p=1.e12, cmap=[7
+00040630: 2e39 3739 3137 2c20 302e 3837 3830 3439  .97917, 0.878049
+00040640: 335d 2c20 7363 616c 653d 5b2d 302e 312c  3], scale=[-0.1,
+00040650: 2031 305d 293a 0a20 2020 2022 2222 0a20   10]):.    """. 
+00040660: 2020 2053 6361 6c65 2061 6e20 6172 7261     Scale an arra
+00040670: 7920 6c69 6b65 2064 7339 206c 6f67 2073  y like ds9 log s
+00040680: 6361 6c69 6e67 0a20 2020 2022 2222 0a20  caling.    """. 
+00040690: 2020 2069 6d70 6f72 7420 6e75 6d70 7920     import numpy 
+000406a0: 6173 206e 700a 0a20 2020 2063 6f6e 7472  as np..    contr
+000406b0: 6173 742c 2062 6961 7320 3d20 636d 6170  ast, bias = cmap
+000406c0: 0a20 2020 2063 6c69 7020 3d20 286e 702e  .    clip = (np.
+000406d0: 636c 6970 2869 6d2c 2073 6361 6c65 5b30  clip(im, scale[0
+000406e0: 5d2c 2073 6361 6c65 5b31 5d29 2d73 6361  ], scale[1])-sca
+000406f0: 6c65 5b30 5d29 2f28 7363 616c 655b 315d  le[0])/(scale[1]
+00040700: 2d73 6361 6c65 5b30 5d29 0a20 2020 2063  -scale[0]).    c
+00040710: 6c69 705f 6c6f 6720 3d20 6e70 2e63 6c69  lip_log = np.cli
+00040720: 7028 286e 702e 6c6f 6731 3028 6c65 7870  p((np.log10(lexp
+00040730: 2a63 6c69 702b 3129 2f6e 702e 6c6f 6731  *clip+1)/np.log1
+00040740: 3028 6c65 7870 292d 6269 6173 292a 636f  0(lexp)-bias)*co
+00040750: 6e74 7261 7374 2b30 2e35 2c20 302c 2031  ntrast+0.5, 0, 1
+00040760: 290a 0a20 2020 2072 6574 7572 6e20 636c  )..    return cl
+00040770: 6970 5f6c 6f67 0a0a 0a64 6566 206d 6f64  ip_log...def mod
+00040780: 655f 7374 6174 6973 7469 6328 6461 7461  e_statistic(data
+00040790: 2c20 7065 7263 656e 7469 6c65 733d 7261  , percentiles=ra
+000407a0: 6e67 6528 3130 2c20 3931 2c20 3130 2929  nge(10, 91, 10))
+000407b0: 3a0a 2020 2020 2222 220a 2020 2020 4765  :.    """.    Ge
+000407c0: 7420 6d6f 6461 6c20 7661 6c75 6520 6f66  t modal value of
+000407d0: 2061 2064 6973 7472 6962 7574 696f 6e20   a distribution 
+000407e0: 6f66 2064 6174 6120 666f 6c6c 6f77 696e  of data followin
+000407f0: 6720 436f 6e6e 6f72 2065 7420 616c 2e20  g Connor et al. 
+00040800: 3230 3137 0a20 2020 2068 7474 7073 3a2f  2017.    https:/
+00040810: 2f61 7278 6976 2e6f 7267 2f70 6466 2f31  /arxiv.org/pdf/1
+00040820: 3730 392e 3031 3932 352e 7064 660a 0a20  709.01925.pdf.. 
+00040830: 2020 2048 6572 6520 7765 2066 6974 2061     Here we fit a
+00040840: 2073 706c 696e 6520 746f 2074 6865 2063   spline to the c
+00040850: 756d 756c 6174 6976 6520 6469 7374 7269  umulative distri
+00040860: 6275 7469 6f6e 2065 7661 6c75 6174 6564  bution evaluated
+00040870: 2061 7420 6b6e 6f74 730a 2020 2020 7365   at knots.    se
+00040880: 7420 746f 2074 6865 2060 7065 7263 656e  t to the `percen
+00040890: 7469 6c65 7360 206f 6620 7468 6520 6469  tiles` of the di
+000408a0: 7374 7269 6275 7469 6f6e 2074 6f20 696d  stribution to im
+000408b0: 7072 6f76 6520 736d 6f6f 7468 6e65 7373  prove smoothness
+000408c0: 2e0a 2020 2020 2222 220a 2020 2020 6672  ..    """.    fr
+000408d0: 6f6d 2073 6369 7079 2e69 6e74 6572 706f  om scipy.interpo
+000408e0: 6c61 7465 2069 6d70 6f72 7420 556e 6976  late import Univ
+000408f0: 6172 6961 7465 5370 6c69 6e65 2c20 4c53  ariateSpline, LS
+00040900: 5155 6e69 7661 7269 6174 6553 706c 696e  QUnivariateSplin
+00040910: 650a 0a20 2020 2073 6f20 3d20 6e70 2e61  e..    so = np.a
+00040920: 7267 736f 7274 2864 6174 6129 0a20 2020  rgsort(data).   
+00040930: 206f 7264 6572 203d 206e 702e 6172 616e   order = np.aran
+00040940: 6765 286c 656e 2864 6174 6129 290a 2020  ge(len(data)).  
+00040950: 2020 2373 706c 203d 2055 6e69 7661 7269    #spl = Univari
+00040960: 6174 6553 706c 696e 6528 6461 7461 5b73  ateSpline(data[s
+00040970: 6f5d 2c20 6f72 6465 7229 0a0a 2020 2020  o], order)..    
+00040980: 6b6e 6f74 7320 3d20 6e70 2e70 6572 6365  knots = np.perce
+00040990: 6e74 696c 6528 6461 7461 2c20 7065 7263  ntile(data, perc
+000409a0: 656e 7469 6c65 7329 0a20 2020 2064 7820  entiles).    dx 
+000409b0: 3d20 6e70 2e64 6966 6628 6b6e 6f74 7329  = np.diff(knots)
+000409c0: 0a20 2020 206d 6173 6b20 3d20 2864 6174  .    mask = (dat
+000409d0: 615b 736f 5d20 3e3d 206b 6e6f 7473 5b30  a[so] >= knots[0
+000409e0: 5d2d 6478 5b30 5d29 2026 2028 6461 7461  ]-dx[0]) & (data
+000409f0: 5b73 6f5d 203c 3d20 6b6e 6f74 735b 2d31  [so] <= knots[-1
+00040a00: 5d2b 6478 5b2d 315d 290a 2020 2020 7370  ]+dx[-1]).    sp
+00040a10: 6c20 3d20 4c53 5155 6e69 7661 7269 6174  l = LSQUnivariat
+00040a20: 6553 706c 696e 6528 6461 7461 5b73 6f5d  eSpline(data[so]
+00040a30: 5b6d 6173 6b5d 2c20 6f72 6465 725b 6d61  [mask], order[ma
+00040a40: 736b 5d2c 206b 6e6f 7473 2c20 6578 743d  sk], knots, ext=
+00040a50: 277a 6572 6f73 2729 0a0a 2020 2020 6d61  'zeros')..    ma
+00040a60: 736b 203d 2028 6461 7461 5b73 6f5d 203e  sk = (data[so] >
+00040a70: 3d20 6b6e 6f74 735b 305d 2920 2620 2864  = knots[0]) & (d
+00040a80: 6174 615b 736f 5d20 3c3d 206b 6e6f 7473  ata[so] <= knots
+00040a90: 5b2d 315d 290a 2020 2020 6978 203d 2028  [-1]).    ix = (
+00040aa0: 7370 6c28 6461 7461 5b73 6f5d 2c20 6e75  spl(data[so], nu
+00040ab0: 3d31 2c20 6578 743d 277a 6572 6f73 2729  =1, ext='zeros')
+00040ac0: 2a6d 6173 6b29 2e61 7267 6d61 7828 290a  *mask).argmax().
+00040ad0: 2020 2020 6d6f 6465 203d 2064 6174 615b      mode = data[
+00040ae0: 736f 5d5b 6978 5d0a 2020 2020 7265 7475  so][ix].    retu
+00040af0: 726e 206d 6f64 650a 0a0a 6465 6620 6d61  rn mode...def ma
+00040b00: 6b65 5f61 6c66 5f74 656d 706c 6174 6528  ke_alf_template(
+00040b10: 293a 0a20 2020 2022 2222 0a20 2020 204d  ):.    """.    M
+00040b20: 616b 6520 416c 6620 2b20 4653 5053 2074  ake Alf + FSPS t
+00040b30: 656d 706c 6174 650a 2020 2020 2222 220a  emplate.    """.
+00040b40: 2020 2020 696d 706f 7274 2061 6c66 2e61      import alf.a
+00040b50: 6c66 0a20 2020 2069 6d70 6f72 7420 6673  lf.    import fs
+00040b60: 7073 0a0a 2020 2020 7373 7020 3d20 616c  ps..    ssp = al
+00040b70: 662e 616c 662e 416c 6628 290a 0a20 2020  f.alf.Alf()..   
+00040b80: 2073 7020 3d20 6673 7073 2e53 7465 6c6c   sp = fsps.Stell
+00040b90: 6172 506f 7075 6c61 7469 6f6e 287a 636f  arPopulation(zco
+00040ba0: 6e74 696e 756f 7573 3d31 290a 2020 2020  ntinuous=1).    
+00040bb0: 7370 2e70 6172 616d 735b 276c 6f67 7a73  sp.params['logzs
+00040bc0: 6f6c 275d 203d 2030 2e32 0a0a 2020 2020  ol'] = 0.2..    
+00040bd0: 2320 416c 660a 2020 2020 6d20 3d20 7373  # Alf.    m = ss
+00040be0: 702e 6765 745f 6d6f 6465 6c28 696e 5f70  p.get_model(in_p
+00040bf0: 6c61 6365 3d46 616c 7365 2c20 6c6f 6761  lace=False, loga
+00040c00: 6765 3d30 2e39 362c 207a 683d 302e 322c  ge=0.96, zh=0.2,
+00040c10: 206d 6768 3d30 2e32 290a 0a20 2020 2023   mgh=0.2)..    #
+00040c20: 2046 5350 530a 2020 2020 772c 2073 7065   FSPS.    w, spe
+00040c30: 6320 3d20 7370 2e67 6574 5f73 7065 6374  c = sp.get_spect
+00040c40: 7275 6d28 7461 6765 3d31 302a 2a30 2e39  rum(tage=10**0.9
+00040c50: 362c 2070 6572 6161 3d54 7275 6529 0a0a  6, peraa=True)..
+00040c60: 2020 2020 2320 626c 7565 0a20 2020 2062      # blue.    b
+00040c70: 6c75 655f 6e6f 726d 203d 2073 7065 635b  lue_norm = spec[
+00040c80: 7720 3e20 3336 3030 5d5b 305d 202f 206d  w > 3600][0] / m
+00040c90: 5b73 7370 2e77 6176 6520 3e20 3336 3030  [ssp.wave > 3600
+00040ca0: 5d5b 305d 0a20 2020 2072 6564 5f6e 6f72  ][0].    red_nor
+00040cb0: 6d20 3d20 7370 6563 5b77 203e 2031 2e37  m = spec[w > 1.7
+00040cc0: 6534 5d5b 305d 202f 206d 5b73 7370 2e77  e4][0] / m[ssp.w
+00040cd0: 6176 6520 3e20 312e 3765 345d 5b30 5d0a  ave > 1.7e4][0].
+00040ce0: 0a20 2020 2074 656d 706c 7820 3d20 6e70  .    templx = np
+00040cf0: 2e68 7374 6163 6b28 5b77 5b77 203c 2033  .hstack([w[w < 3
+00040d00: 3630 305d 2c20 7373 702e 7761 7665 5b28  600], ssp.wave[(
+00040d10: 7373 702e 7761 7665 203e 2033 3630 3029  ssp.wave > 3600)
+00040d20: 2026 2028 7373 702e 7761 7665 203c 2031   & (ssp.wave < 1
+00040d30: 2e37 6534 295d 2c20 775b 7720 3e20 312e  .7e4)], w[w > 1.
+00040d40: 3765 345d 5d29 0a20 2020 2074 656d 706c  7e4]]).    templ
+00040d50: 7920 3d20 6e70 2e68 7374 6163 6b28 5b73  y = np.hstack([s
+00040d60: 7065 635b 7720 3c20 3336 3030 5d2f 626c  pec[w < 3600]/bl
+00040d70: 7565 5f6e 6f72 6d2c 206d 5b28 7373 702e  ue_norm, m[(ssp.
+00040d80: 7761 7665 203e 2033 3630 3029 2026 2028  wave > 3600) & (
+00040d90: 7373 702e 7761 7665 203c 2031 2e37 6534  ssp.wave < 1.7e4
+00040da0: 295d 2c20 7370 6563 5b77 203e 2031 2e37  )], spec[w > 1.7
+00040db0: 6534 5d2f 7265 645f 6e6f 726d 5d29 0a0a  e4]/red_norm])..
+00040dc0: 2020 2020 6e70 2e73 6176 6574 7874 2827      np.savetxt('
+00040dd0: 616c 665f 5353 502e 6461 7427 2c20 6e70  alf_SSP.dat', np
+00040de0: 2e61 7272 6179 285b 7465 6d70 6c78 2c20  .array([templx, 
+00040df0: 7465 6d70 6c79 5d29 2e54 2c20 666d 743d  temply]).T, fmt=
+00040e00: 2725 2e35 6527 2c20 6865 6164 6572 3d27  '%.5e', header='
+00040e10: 7761 7665 2066 6c75 785c 6e6c 6f67 6167  wave flux\nlogag
+00040e20: 6520 3d20 302e 3936 5c6e 7a68 3d30 2e32  e = 0.96\nzh=0.2
+00040e30: 5c6e 6d67 683d 302e 325c 6e66 7370 733a  \nmgh=0.2\nfsps:
+00040e40: 2077 203c 2033 3630 302c 2077 203e 2031   w < 3600, w > 1
+00040e50: 2e37 6534 2729 0a0a 0a64 6566 2063 6174  .7e4')...def cat
+00040e60: 616c 6f67 5f61 7265 6128 7261 3d5b 5d2c  alog_area(ra=[],
+00040e70: 2064 6563 3d5b 5d2c 206d 616b 655f 706c   dec=[], make_pl
+00040e80: 6f74 3d54 7275 652c 204e 4d41 583d 3530  ot=True, NMAX=50
+00040e90: 3030 2c20 6275 6666 3d30 2e38 2c20 7665  00, buff=0.8, ve
+00040ea0: 7262 6f73 653d 5472 7565 293a 0a20 2020  rbose=True):.   
+00040eb0: 2022 2222 436f 6d70 7574 6520 7468 6520   """Compute the 
+00040ec0: 7375 7266 6163 6520 6172 6561 206f 6620  surface area of 
+00040ed0: 6120 6c69 7374 206f 6620 5241 2f44 4543  a list of RA/DEC
+00040ee0: 2063 6f6f 7264 696e 6174 6573 0a0a 2020   coordinates..  
+00040ef0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00040f00: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00040f10: 7261 2c20 6465 6320 3a20 607e 6e75 6d70  ra, dec : `~nump
+00040f20: 792e 6e64 6172 7261 7960 0a20 2020 2020  y.ndarray`.     
+00040f30: 2020 2052 4120 616e 6420 4465 632e 2063     RA and Dec. c
+00040f40: 6f6f 7264 696e 6174 6573 2069 6e20 6465  oordinates in de
+00040f50: 6369 6d61 6c20 6465 6772 6565 730a 0a20  cimal degrees.. 
+00040f60: 2020 206d 616b 655f 706c 6f74 203a 2062     make_plot : b
+00040f70: 6f6f 6c0a 2020 2020 2020 2020 4d61 6b65  ool.        Make
+00040f80: 2061 2066 6967 7572 652e 0a0a 2020 2020   a figure...    
+00040f90: 4e4d 4158 203a 2069 6e74 0a20 2020 2020  NMAX : int.     
+00040fa0: 2020 2049 6620 7468 6520 6361 7461 6c6f     If the catalo
+00040fb0: 6720 6861 7320 6d6f 7265 2074 6865 6e20  g has more then 
+00040fc0: 604e 4d41 5860 2065 6e74 7269 6573 2c20  `NMAX` entries, 
+00040fd0: 6472 6177 2060 4e4d 4158 6020 7261 6e64  draw `NMAX` rand
+00040fe0: 6f6d 0a20 2020 2020 2020 2073 616d 706c  om.        sampl
+00040ff0: 6573 2e0a 0a20 2020 2062 7566 6620 3a20  es...    buff : 
+00041000: 666c 6f61 740a 2020 2020 2020 2020 4275  float.        Bu
+00041010: 6666 6572 2069 6e20 6172 636d 696e 2074  ffer in arcmin t
+00041020: 6f20 6164 6420 6172 6f75 6e64 2065 6163  o add around eac
+00041030: 6820 6361 7461 6c6f 6720 706f 696e 742e  h catalog point.
+00041040: 0a0a 0a20 2020 2052 6574 7572 6e73 0a20  ...    Returns. 
+00041050: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2061     -------.    a
+00041060: 7265 6120 3a20 666c 6f61 740a 2020 2020  rea : float.    
+00041070: 2020 2020 436f 6d70 7574 6564 2063 6174      Computed cat
+00041080: 616c 6f67 2061 7265 6120 696e 2073 7175  alog area in squ
+00041090: 6172 6520 6172 636d 696e 7574 6573 0a0a  are arcminutes..
+000410a0: 2020 2020 6669 6720 3a20 607e 6d61 7470      fig : `~matp
+000410b0: 6c6f 746c 6962 2e66 6967 7572 652e 4669  lotlib.figure.Fi
+000410c0: 6775 7265 600a 2020 2020 2020 2020 4669  gure`.        Fi
+000410d0: 6775 7265 206f 626a 6563 7420 7265 7475  gure object retu
+000410e0: 726e 6564 2069 6620 606d 616b 655f 706c  rned if `make_pl
+000410f0: 6f74 3d3d 5472 7565 602e 0a0a 2020 2020  ot==True`...    
+00041100: 2222 220a 2020 2020 696d 706f 7274 206d  """.    import m
+00041110: 6174 706c 6f74 6c69 622e 7079 706c 6f74  atplotlib.pyplot
+00041120: 2061 7320 706c 740a 2020 2020 6672 6f6d   as plt.    from
+00041130: 2073 6861 7065 6c79 2e67 656f 6d65 7472   shapely.geometr
+00041140: 7920 696d 706f 7274 2050 6f6c 7967 6f6e  y import Polygon
+00041150: 2c20 506f 696e 742c 204d 756c 7469 506f  , Point, MultiPo
+00041160: 6c79 676f 6e2c 204d 756c 7469 4c69 6e65  lygon, MultiLine
+00041170: 5374 7269 6e67 0a20 2020 2066 726f 6d20  String.    from 
+00041180: 7363 6970 7920 696d 706f 7274 2073 7061  scipy import spa
+00041190: 7469 616c 0a0a 2020 2020 706f 696e 7473  tial..    points
+000411a0: 203d 206e 702e 6172 7261 7928 5b72 612c   = np.array([ra,
+000411b0: 2064 6563 5d29 2a31 2e0a 2020 2020 6365   dec])*1..    ce
+000411c0: 6e74 6572 203d 206e 702e 6d65 616e 2870  nter = np.mean(p
+000411d0: 6f69 6e74 732c 2061 7869 733d 3129 0a20  oints, axis=1). 
+000411e0: 2020 2070 6f69 6e74 7320 3d20 2870 6f69     points = (poi
+000411f0: 6e74 732e 5420 2d20 6365 6e74 6572 292a  nts.T - center)*
+00041200: 3630 2e20 2023 2061 7263 6d69 6e0a 2020  60.  # arcmin.  
+00041210: 2020 706f 696e 7473 5b3a 2c20 305d 202a    points[:, 0] *
+00041220: 3d20 6e70 2e63 6f73 2863 656e 7465 725b  = np.cos(center[
+00041230: 315d 2f31 3830 2a6e 702e 7069 290a 0a20  1]/180*np.pi).. 
+00041240: 2020 2068 756c 6c20 3d20 7370 6174 6961     hull = spatia
+00041250: 6c2e 436f 6e76 6578 4875 6c6c 2870 6f69  l.ConvexHull(poi
+00041260: 6e74 7329 0a20 2020 2065 6467 6520 3d20  nts).    edge = 
+00041270: 706f 696e 7473 5b68 756c 6c2e 7665 7274  points[hull.vert
+00041280: 6963 6573 2c20 3a5d 0a0a 2020 2020 2370  ices, :]..    #p
+00041290: 6275 6666 203d 2031 0a0a 2020 2020 6966  buff = 1..    if
+000412a0: 206c 656e 2872 6129 203e 204e 4d41 583a   len(ra) > NMAX:
+000412b0: 0a20 2020 2020 2020 2072 6e64 5f69 6478  .        rnd_idx
+000412c0: 203d 206e 702e 756e 6971 7565 286e 702e   = np.unique(np.
+000412d0: 6361 7374 5b69 6e74 5d28 6e70 2e72 6f75  cast[int](np.rou
+000412e0: 6e64 286e 702e 7261 6e64 6f6d 2e72 616e  nd(np.random.ran
+000412f0: 6428 4e4d 4158 292a 6c65 6e28 7261 2929  d(NMAX)*len(ra))
+00041300: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
+00041310: 2020 2020 2072 6e64 5f69 6478 203d 206e       rnd_idx = n
+00041320: 702e 6172 616e 6765 286c 656e 2872 6129  p.arange(len(ra)
+00041330: 290a 0a20 2020 2070 6f6c 7920 3d20 506f  )..    poly = Po
+00041340: 696e 7428 706f 696e 7473 5b72 6e64 5f69  int(points[rnd_i
+00041350: 6478 5b30 5d2c 203a 5d29 2e62 7566 6665  dx[0], :]).buffe
+00041360: 7228 6275 6666 290a 2020 2020 666f 7220  r(buff).    for 
+00041370: 692c 2069 7820 696e 2065 6e75 6d65 7261  i, ix in enumera
+00041380: 7465 2872 6e64 5f69 6478 293a 0a20 2020  te(rnd_idx):.   
+00041390: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+000413a0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+000413b0: 6e74 284e 4f5f 4e45 574c 494e 4520 2b20  nt(NO_NEWLINE + 
+000413c0: 277b 307d 207b 317d 272e 666f 726d 6174  '{0} {1}'.format
+000413d0: 2869 2c20 6978 2929 0a0a 2020 2020 2020  (i, ix))..      
+000413e0: 2020 706f 6c79 203d 2070 6f6c 792e 756e    poly = poly.un
+000413f0: 696f 6e28 506f 696e 7428 706f 696e 7473  ion(Point(points
+00041400: 5b69 782c 203a 5d29 2e62 7566 6665 7228  [ix, :]).buffer(
+00041410: 6275 6666 2929 0a0a 2020 2020 2320 4669  buff))..    # Fi
+00041420: 6e61 6c20 286d 756c 7469 2950 6f6c 7967  nal (multi)Polyg
+00041430: 6f6e 0a20 2020 2070 6a6f 696e 203d 2070  on.    pjoin = p
+00041440: 6f6c 792e 6275 6666 6572 282d 6275 6666  oly.buffer(-buff
+00041450: 290a 0a20 2020 2069 6620 6d61 6b65 5f70  )..    if make_p
+00041460: 6c6f 743a 0a0a 2020 2020 2020 2020 6669  lot:..        fi
+00041470: 6720 3d20 706c 742e 6669 6775 7265 2829  g = plt.figure()
+00041480: 0a20 2020 2020 2020 2061 7820 3d20 6669  .        ax = fi
+00041490: 672e 6164 645f 7375 6270 6c6f 7428 3131  g.add_subplot(11
+000414a0: 3129 0a0a 2020 2020 2020 2020 6966 2069  1)..        if i
+000414b0: 7369 6e73 7461 6e63 6528 706a 6f69 6e2c  sinstance(pjoin,
+000414c0: 204d 756c 7469 506f 6c79 676f 6e29 3a0a   MultiPolygon):.
+000414d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000414e0: 705f 6920 696e 2070 6a6f 696e 3a0a 2020  p_i in pjoin:.  
+000414f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00041500: 2069 7369 6e73 7461 6e63 6528 705f 692e   isinstance(p_i.
+00041510: 626f 756e 6461 7279 2c20 4d75 6c74 694c  boundary, MultiL
+00041520: 696e 6553 7472 696e 6729 3a0a 2020 2020  ineString):.    
+00041530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041540: 666f 7220 7320 696e 2070 5f69 2e62 6f75  for s in p_i.bou
+00041550: 6e64 6172 793a 0a20 2020 2020 2020 2020  ndary:.         
+00041560: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00041570: 203d 2073 2e78 790a 2020 2020 2020 2020   = s.xy.        
+00041580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041590: 6178 2e70 6c6f 7428 705b 305d 2c20 705b  ax.plot(p[0], p[
+000415a0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+000415b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000415c0: 2020 2020 2020 2020 2020 2020 2020 7020                p 
+000415d0: 3d20 705f 692e 626f 756e 6461 7279 2e78  = p_i.boundary.x
+000415e0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+000415f0: 2020 2020 2020 6178 2e70 6c6f 7428 705b        ax.plot(p[
+00041600: 305d 2c20 705b 315d 290a 2020 2020 2020  0], p[1]).      
+00041610: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00041620: 2020 2020 705f 6920 3d20 706a 6f69 6e0a      p_i = pjoin.
+00041630: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00041640: 7369 6e73 7461 6e63 6528 705f 692e 626f  sinstance(p_i.bo
+00041650: 756e 6461 7279 2c20 4d75 6c74 694c 696e  undary, MultiLin
+00041660: 6553 7472 696e 6729 3a0a 2020 2020 2020  eString):.      
+00041670: 2020 2020 2020 2020 2020 666f 7220 7320            for s 
+00041680: 696e 2070 5f69 2e62 6f75 6e64 6172 793a  in p_i.boundary:
+00041690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000416a0: 2020 2020 2070 203d 2073 2e78 790a 2020       p = s.xy.  
+000416b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000416c0: 2020 6178 2e70 6c6f 7428 705b 305d 2c20    ax.plot(p[0], 
+000416d0: 705b 315d 290a 2020 2020 2020 2020 2020  p[1]).          
+000416e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000416f0: 2020 2020 2020 2020 7020 3d20 705f 692e          p = p_i.
+00041700: 626f 756e 6461 7279 2e78 790a 2020 2020  boundary.xy.    
+00041710: 2020 2020 2020 2020 2020 2020 6178 2e70              ax.p
+00041720: 6c6f 7428 705b 305d 2c20 705b 315d 290a  lot(p[0], p[1]).
+00041730: 0a20 2020 2020 2020 2061 782e 7363 6174  .        ax.scat
+00041740: 7465 7228 706f 696e 7473 5b72 6e64 5f69  ter(points[rnd_i
+00041750: 6478 2c20 305d 2c20 706f 696e 7473 5b72  dx, 0], points[r
+00041760: 6e64 5f69 6478 2c20 315d 2c20 616c 7068  nd_idx, 1], alph
+00041770: 613d 302e 312c 206d 6172 6b65 723d 272b  a=0.1, marker='+
+00041780: 2729 0a0a 2020 2020 2020 2020 6178 2e73  ')..        ax.s
+00041790: 6574 5f78 6c69 6d28 6178 2e67 6574 5f78  et_xlim(ax.get_x
+000417a0: 6c69 6d28 295b 3a3a 2d31 5d29 0a20 2020  lim()[::-1]).   
+000417b0: 2020 2020 2061 782e 7365 745f 786c 6162       ax.set_xlab
+000417c0: 656c 2872 2724 5c44 656c 7461 2452 4120  el(r'$\Delta$RA 
+000417d0: 287b 303a 2e35 667d 2927 2e66 6f72 6d61  ({0:.5f})'.forma
+000417e0: 7428 6365 6e74 6572 5b30 5d29 290a 2020  t(center[0])).  
+000417f0: 2020 2020 2020 6178 2e73 6574 5f79 6c61        ax.set_yla
+00041800: 6265 6c28 7227 245c 4465 6c74 6124 4465  bel(r'$\Delta$De
+00041810: 632e 2028 7b30 3a2e 3566 7d29 272e 666f  c. ({0:.5f})'.fo
+00041820: 726d 6174 2863 656e 7465 725b 315d 2929  rmat(center[1]))
+00041830: 0a20 2020 2020 2020 2061 782e 7365 745f  .        ax.set_
+00041840: 7469 746c 6528 2754 6f74 616c 2061 7265  title('Total are
+00041850: 613a 207b 303a 2e31 667d 2061 7263 6d69  a: {0:.1f} arcmi
+00041860: 6e24 5e32 2427 2e66 6f72 6d61 7428 706a  n$^2$'.format(pj
+00041870: 6f69 6e2e 6172 6561 2929 0a20 2020 2020  oin.area)).     
+00041880: 2020 2061 782e 6772 6964 2829 0a20 2020     ax.grid().   
+00041890: 2020 2020 2066 6967 2e74 6967 6874 5f6c       fig.tight_l
+000418a0: 6179 6f75 7428 7061 643d 302e 3129 0a0a  ayout(pad=0.1)..
+000418b0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+000418c0: 6a6f 696e 2e61 7265 612c 2066 6967 0a0a  join.area, fig..
+000418d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000418e0: 2020 7265 7475 726e 2070 6a6f 696e 2e61    return pjoin.a
+000418f0: 7265 610a 0a0a 6465 6620 6669 785f 666c  rea...def fix_fl
+00041900: 745f 6e61 6e28 666c 745f 6669 6c65 2c20  t_nan(flt_file, 
+00041910: 6261 645f 6269 743d 3430 3936 2c20 7665  bad_bit=4096, ve
+00041920: 7262 6f73 653d 5472 7565 293a 0a20 2020  rbose=True):.   
+00041930: 2022 2222 0a20 2020 2046 6978 204e 614e   """.    Fix NaN
+00041940: 2076 616c 7565 7320 696e 2046 4c54 2066   values in FLT f
+00041950: 696c 6573 0a20 2020 2022 2222 0a20 2020  iles.    """.   
+00041960: 2069 6d20 3d20 7079 6669 7473 2e6f 7065   im = pyfits.ope
+00041970: 6e28 666c 745f 6669 6c65 2c20 6d6f 6465  n(flt_file, mode
+00041980: 3d27 7570 6461 7465 2729 0a20 2020 2066  ='update').    f
+00041990: 6f72 2065 7874 2069 6e20 7261 6e67 6528  or ext in range(
+000419a0: 312c 2035 293a 0a20 2020 2020 2020 2069  1, 5):.        i
+000419b0: 6620 2827 5343 4927 2c20 6578 7429 2069  f ('SCI', ext) i
+000419c0: 6e20 696d 3a0a 2020 2020 2020 2020 2020  n im:.          
+000419d0: 2020 6d61 736b 203d 207e 6e70 2e69 7366    mask = ~np.isf
+000419e0: 696e 6974 6528 696d 5b27 5343 4927 2c20  inite(im['SCI', 
+000419f0: 6578 745d 2e64 6174 6129 0a20 2020 2020  ext].data).     
+00041a00: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00041a10: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00041a20: 2020 206c 6162 656c 203d 2027 7574 696c     label = 'util
+00041a30: 732e 6669 785f 666c 745f 6e61 6e3a 207b  s.fix_flt_nan: {
+00041a40: 307d 5b53 4349 2c7b 317d 5d20 4e61 4e50  0}[SCI,{1}] NaNP
+00041a50: 6978 656c 733d 7b32 7d27 0a20 2020 2020  ixels={2}'.     
+00041a60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00041a70: 286c 6162 656c 2e66 6f72 6d61 7428 666c  (label.format(fl
+00041a80: 745f 6669 6c65 2c20 6578 742c 206d 6173  t_file, ext, mas
+00041a90: 6b2e 7375 6d28 2929 290a 0a20 2020 2020  k.sum()))..     
+00041aa0: 2020 2020 2020 2069 6620 6d61 736b 2e73         if mask.s
+00041ab0: 756d 2829 203d 3d20 303a 0a20 2020 2020  um() == 0:.     
+00041ac0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00041ad0: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00041ae0: 2069 6d5b 2753 4349 272c 2065 7874 5d2e   im['SCI', ext].
+00041af0: 6461 7461 5b6d 6173 6b5d 203d 2030 0a20  data[mask] = 0. 
+00041b00: 2020 2020 2020 2020 2020 2069 6d5b 2744             im['D
+00041b10: 5127 2c20 6578 745d 2e64 6174 615b 6d61  Q', ext].data[ma
+00041b20: 736b 5d20 7c3d 2062 6164 5f62 6974 0a0a  sk] |= bad_bit..
+00041b30: 2020 2020 696d 2e66 6c75 7368 2829 0a20      im.flush(). 
+00041b40: 2020 2069 6d2e 636c 6f73 6528 290a 0a0a     im.close()...
+00041b50: 6465 6620 6475 6d70 5f66 6c74 5f64 7128  def dump_flt_dq(
+00041b60: 6669 6c65 6e61 6d65 2c20 7265 706c 6163  filename, replac
+00041b70: 653d 2827 2e66 6974 7327 2c20 272e 6471  e=('.fits', '.dq
+00041b80: 2e66 6974 732e 677a 2729 2c20 7665 7262  .fits.gz'), verb
+00041b90: 6f73 653d 5472 7565 293a 0a20 2020 2022  ose=True):.    "
+00041ba0: 2222 4475 6d70 2046 4c54 2f46 4c43 2068  ""Dump FLT/FLC h
+00041bb0: 6561 6465 7220 2620 4451 2065 7874 656e  eader & DQ exten
+00041bc0: 7369 6f6e 7320 746f 2061 2063 6f6d 7061  sions to a compa
+00041bd0: 6374 2066 696c 650a 0a20 2020 2050 6172  ct file..    Par
+00041be0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00041bf0: 2d2d 2d2d 2d2d 0a20 2020 2066 696c 656e  ------.    filen
+00041c00: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
+00041c10: 2020 464c 542f 464c 4320 6669 6c65 6e61    FLT/FLC filena
+00041c20: 6d65 2e0a 0a20 2020 2072 6570 6c61 6365  me...    replace
+00041c30: 203a 2028 7374 722c 2073 7472 290a 2020   : (str, str).  
+00041c40: 2020 2020 2020 5265 706c 6163 6520 6172        Replace ar
+00041c50: 6775 6d65 6e74 7320 666f 7220 6f75 7470  guments for outp
+00041c60: 7574 2066 696c 656e 616d 653a 0a0a 2020  ut filename:..  
+00041c70: 2020 2020 2020 3e3e 3e20 6f75 7470 7574        >>> output
+00041c80: 5f66 696c 656e 616d 6520 3d20 6669 6c65  _filename = file
+00041c90: 6e61 6d65 2e72 6570 6c61 6365 2872 6570  name.replace(rep
+00041ca0: 6c61 6365 5b30 5d2c 2072 6570 6c61 6365  lace[0], replace
+00041cb0: 5b31 5d29 0a0a 2020 2020 5265 7475 726e  [1])..    Return
+00041cc0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+00041cd0: 2020 5772 6974 6573 2068 6561 6465 7220    Writes header 
+00041ce0: 616e 6420 636f 6d70 6163 7420 4451 2061  and compact DQ a
+00041cf0: 7272 6179 2074 6f20 606f 7574 7075 745f  rray to `output_
+00041d00: 6669 6c65 6e61 6d65 602e 0a0a 2020 2020  filename`...    
+00041d10: 2222 220a 2020 2020 696d 203d 2070 7966  """.    im = pyf
+00041d20: 6974 732e 6f70 656e 2866 696c 656e 616d  its.open(filenam
+00041d30: 6529 0a20 2020 2068 6475 7320 3d20 5b5d  e).    hdus = []
+00041d40: 0a20 2020 2066 6f72 2069 2069 6e20 5b31  .    for i in [1
+00041d50: 2c20 322c 2033 2c20 345d 3a0a 2020 2020  , 2, 3, 4]:.    
+00041d60: 2020 2020 6966 2028 2753 4349 272c 2069      if ('SCI', i
+00041d70: 2920 696e 2069 6d3a 0a20 2020 2020 2020  ) in im:.       
+00041d80: 2020 2020 2068 6561 6465 7220 3d20 696d       header = im
+00041d90: 5b27 5343 4927 2c20 695d 2e68 6561 6465  ['SCI', i].heade
+00041da0: 720a 2020 2020 2020 2020 2020 2020 6471  r.            dq
+00041db0: 203d 2069 6d5b 2744 5127 2c20 695d 2e64   = im['DQ', i].d
+00041dc0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+00041dd0: 6e7a 203d 206e 702e 7768 6572 6528 6471  nz = np.where(dq
+00041de0: 203e 2030 290a 2020 2020 2020 2020 2020   > 0).          
+00041df0: 2020 6471 5f64 6174 6120 3d20 6e70 2e61    dq_data = np.a
+00041e00: 7272 6179 285b 6e7a 5b30 5d2c 206e 7a5b  rray([nz[0], nz[
+00041e10: 315d 2c20 6471 5b64 7120 3e20 305d 5d2c  1], dq[dq > 0]],
+00041e20: 2064 7479 7065 3d6e 702e 696e 7431 3629   dtype=np.int16)
+00041e30: 0a20 2020 2020 2020 2020 2020 2068 6475  .            hdu
+00041e40: 203d 2070 7966 6974 732e 496d 6167 6548   = pyfits.ImageH
+00041e50: 4455 2868 6561 6465 723d 6865 6164 6572  DU(header=header
+00041e60: 2c20 6461 7461 3d64 715f 6461 7461 290a  , data=dq_data).
+00041e70: 2020 2020 2020 2020 2020 2020 6864 7573              hdus
+00041e80: 2e61 7070 656e 6428 6864 7529 0a0a 2020  .append(hdu)..  
+00041e90: 2020 6f75 7470 7574 5f66 696c 656e 616d    output_filenam
+00041ea0: 6520 3d20 6669 6c65 6e61 6d65 2e72 6570  e = filename.rep
+00041eb0: 6c61 6365 2872 6570 6c61 6365 5b30 5d2c  lace(replace[0],
+00041ec0: 2072 6570 6c61 6365 5b31 5d29 0a0a 2020   replace[1])..  
+00041ed0: 2020 6d73 6720 3d20 2723 2064 756d 705f    msg = '# dump_
+00041ee0: 666c 745f 6471 3a20 7b30 7d20 3e20 7b31  flt_dq: {0} > {1
+00041ef0: 7d27 2e66 6f72 6d61 7428 6669 6c65 6e61  }'.format(filena
+00041f00: 6d65 2c20 6f75 7470 7574 5f66 696c 656e  me, output_filen
+00041f10: 616d 6529 0a20 2020 206c 6f67 5f63 6f6d  ame).    log_com
+00041f20: 6d65 6e74 284c 4f47 4649 4c45 2c20 6d73  ment(LOGFILE, ms
+00041f30: 672c 2076 6572 626f 7365 3d76 6572 626f  g, verbose=verbo
+00041f40: 7365 2c20 7368 6f77 5f64 6174 653d 5472  se, show_date=Tr
+00041f50: 7565 290a 0a20 2020 2070 7966 6974 732e  ue)..    pyfits.
+00041f60: 4844 554c 6973 7428 6864 7573 292e 7772  HDUList(hdus).wr
+00041f70: 6974 6574 6f28 6f75 7470 7574 5f66 696c  iteto(output_fil
+00041f80: 656e 616d 652c 206f 7665 7277 7269 7465  ename, overwrite
+00041f90: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00041fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041fb0: 2020 2020 2020 2020 6f75 7470 7574 5f76          output_v
+00041fc0: 6572 6966 793d 2766 6978 2729 0a20 2020  erify='fix').   
+00041fd0: 200a 2020 2020 696d 2e63 6c6f 7365 2829   .    im.close()
+00041fe0: 0a0a 0a64 6566 2061 7070 6c79 5f66 6c74  ...def apply_flt
+00041ff0: 5f64 7128 6669 6c65 6e61 6d65 2c20 7265  _dq(filename, re
+00042000: 706c 6163 653d 2827 2e66 6974 7327 2c20  place=('.fits', 
+00042010: 272e 6471 2e66 6974 732e 677a 2729 2c20  '.dq.fits.gz'), 
+00042020: 7665 7262 6f73 653d 5472 7565 2c20 6f72  verbose=True, or
+00042030: 5f63 6f6d 6269 6e65 3d46 616c 7365 293a  _combine=False):
+00042040: 0a20 2020 2022 2222 0a20 2020 2052 6561  .    """.    Rea
+00042050: 6420 616e 6420 6170 706c 7920 7468 6520  d and apply the 
+00042060: 636f 6d70 6163 7420 6578 706f 7375 7265  compact exposure
+00042070: 2069 6e66 6f72 6d61 7469 6f6e 2066 696c   information fil
+00042080: 650a 0a20 2020 2050 6172 616d 6574 6572  e..    Parameter
+00042090: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+000420a0: 0a20 2020 2066 696c 656e 616d 6520 3a20  .    filename : 
+000420b0: 7374 720a 2020 2020 2020 2020 464c 542f  str.        FLT/
+000420c0: 464c 4320 6669 6c65 6e61 6d65 2e0a 0a20  FLC filename... 
+000420d0: 2020 2072 6570 6c61 6365 203a 2028 7374     replace : (st
+000420e0: 722c 2073 7472 290a 2020 2020 2020 2020  r, str).        
+000420f0: 5265 706c 6163 6520 6172 6775 6d65 6e74  Replace argument
+00042100: 7320 666f 7220 6f75 7470 7574 2044 5120  s for output DQ 
+00042110: 6669 6c65 6e61 6d65 3a0a 0a20 2020 2020  filename:..     
+00042120: 2020 203e 3e3e 206f 7574 7075 745f 6669     >>> output_fi
+00042130: 6c65 6e61 6d65 203d 2066 696c 656e 616d  lename = filenam
+00042140: 652e 7265 706c 6163 6528 7265 706c 6163  e.replace(replac
+00042150: 655b 305d 2c20 7265 706c 6163 655b 315d  e[0], replace[1]
+00042160: 290a 0a20 2020 206f 725f 636f 6d62 696e  )..    or_combin
+00042170: 6520 3a20 626f 6f6c 0a20 2020 2020 2020  e : bool.       
+00042180: 2049 6620 5472 7565 2c20 7468 656e 2061   If True, then a
+00042190: 7070 6c79 2044 5120 6461 7461 2069 6e20  pply DQ data in 
+000421a0: 606f 7574 7075 745f 6669 6c65 6e61 6d65  `output_filename
+000421b0: 6020 7769 7468 204f 5220 6c6f 6769 632e  ` with OR logic.
+000421c0: 0a0a 2020 2020 2020 2020 4966 2046 616c  ..        If Fal
+000421d0: 7365 2c20 7468 656e 2072 6573 6574 2074  se, then reset t
+000421e0: 6865 2044 5120 6578 7465 6e73 696f 6e73  he DQ extensions
+000421f0: 2074 6f20 6265 2065 7861 6374 6c79 2074   to be exactly t
+00042200: 686f 7365 2069 6e0a 2020 2020 2020 2020  hose in.        
+00042210: 606f 7574 7075 745f 6669 6c65 6e61 6d65  `output_filename
+00042220: 602e 0a0a 2020 2020 5265 7475 726e 730a  `...    Returns.
+00042230: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00042240: 5772 6974 6573 2068 6561 6465 7220 616e  Writes header an
+00042250: 6420 636f 6d70 6163 7420 4451 2061 7272  d compact DQ arr
+00042260: 6179 2074 6f20 606f 7574 7075 745f 6669  ay to `output_fi
+00042270: 6c65 6e61 6d65 602e 0a0a 2020 2020 2222  lename`...    ""
+00042280: 220a 0a20 2020 206f 7574 7075 745f 6669  "..    output_fi
+00042290: 6c65 6e61 6d65 203d 2066 696c 656e 616d  lename = filenam
+000422a0: 652e 7265 706c 6163 6528 7265 706c 6163  e.replace(replac
+000422b0: 655b 305d 2c20 7265 706c 6163 655b 315d  e[0], replace[1]
+000422c0: 290a 0a20 2020 2069 6620 6e6f 7420 6f73  )..    if not os
+000422d0: 2e70 6174 682e 6578 6973 7473 286f 7574  .path.exists(out
+000422e0: 7075 745f 6669 6c65 6e61 6d65 293a 0a20  put_filename):. 
+000422f0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00042300: 6c73 650a 0a20 2020 2069 6d20 3d20 7079  lse..    im = py
+00042310: 6669 7473 2e6f 7065 6e28 6669 6c65 6e61  fits.open(filena
+00042320: 6d65 2c20 6d6f 6465 3d27 7570 6461 7465  me, mode='update
+00042330: 2729 0a0a 2020 2020 6d73 6720 3d20 2723  ')..    msg = '#
+00042340: 2061 7070 6c79 5f66 6c74 5f64 713a 207b   apply_flt_dq: {
+00042350: 317d 203e 207b 307d 272e 666f 726d 6174  1} > {0}'.format
+00042360: 2866 696c 656e 616d 652c 206f 7574 7075  (filename, outpu
+00042370: 745f 6669 6c65 6e61 6d65 290a 2020 2020  t_filename).    
+00042380: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
+00042390: 494c 452c 206d 7367 2c20 7665 7262 6f73  ILE, msg, verbos
+000423a0: 653d 7665 7262 6f73 652c 2073 686f 775f  e=verbose, show_
+000423b0: 6461 7465 3d54 7275 6529 0a0a 2020 2020  date=True)..    
+000423c0: 6471 203d 2070 7966 6974 732e 6f70 656e  dq = pyfits.open
+000423d0: 286f 7574 7075 745f 6669 6c65 6e61 6d65  (output_filename
+000423e0: 290a 2020 2020 666f 7220 6578 7420 696e  ).    for ext in
+000423f0: 205b 312c 2032 2c20 332c 2034 5d3a 0a20   [1, 2, 3, 4]:. 
+00042400: 2020 2020 2020 2069 6620 2828 2753 4349         if (('SCI
+00042410: 272c 2065 7874 2920 696e 2069 6d29 2026  ', ext) in im) &
+00042420: 2028 2827 5343 4927 2c20 6578 7429 2069   (('SCI', ext) i
+00042430: 6e20 6471 293a 0a20 2020 2020 2020 2020  n dq):.         
+00042440: 2020 2073 6820 3d20 6471 5b27 5343 4927     sh = dq['SCI'
+00042450: 2c20 6578 745d 2e64 6174 612e 7368 6170  , ext].data.shap
+00042460: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+00042470: 2073 685b 305d 203d 3d20 333a 0a20 2020   sh[0] == 3:.   
+00042480: 2020 2020 2020 2020 2020 2020 2069 2c20               i, 
+00042490: 6a2c 2064 715f 6920 3d20 6471 5b27 5343  j, dq_i = dq['SC
+000424a0: 4927 2c20 6578 745d 2e64 6174 610a 2020  I', ext].data.  
+000424b0: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
+000424c0: 685b 315d 203d 3d20 323a 0a20 2020 2020  h[1] == 2:.     
+000424d0: 2020 2020 2020 2020 2020 206e 7a2c 2064             nz, d
+000424e0: 715f 6920 3d20 6471 5b27 5343 4927 2c20  q_i = dq['SCI', 
+000424f0: 6578 745d 2e64 6174 610a 2020 2020 2020  ext].data.      
+00042500: 2020 2020 2020 2020 2020 692c 206a 203d            i, j =
+00042510: 206e 702e 756e 7261 7665 6c5f 696e 6465   np.unravel_inde
+00042520: 7828 6e7a 2c20 7368 290a 2020 2020 2020  x(nz, sh).      
+00042530: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00042540: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00042550: 6520 494f 4572 726f 7228 2764 715b 7b30  e IOError('dq[{0
+00042560: 7d5d 2073 6861 7065 207b 317d 206e 6f74  }] shape {1} not
+00042570: 2072 6563 6f67 6e69 7a65 6427 2e66 6f72   recognized'.for
+00042580: 6d61 7428 6578 742c 2073 6829 290a 2020  mat(ext, sh)).  
+00042590: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+000425a0: 2020 2020 2020 2020 2020 2023 2041 7070             # App
+000425b0: 6c79 2044 510a 2020 2020 2020 2020 2020  ly DQ.          
+000425c0: 2020 6966 206f 725f 636f 6d62 696e 653a    if or_combine:
+000425d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000425e0: 2069 6d5b 2744 5127 2c20 6578 745d 2e64   im['DQ', ext].d
+000425f0: 6174 615b 692c 206a 5d20 213d 2064 715f  ata[i, j] != dq_
+00042600: 690a 2020 2020 2020 2020 2020 2020 656c  i.            el
+00042610: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00042620: 2020 2020 696d 5b27 4451 272c 2065 7874      im['DQ', ext
+00042630: 5d2e 6461 7461 202a 3d20 300a 2020 2020  ].data *= 0.    
+00042640: 2020 2020 2020 2020 2020 2020 696d 5b27              im['
+00042650: 4451 272c 2065 7874 5d2e 6461 7461 5b69  DQ', ext].data[i
+00042660: 2c20 6a5d 203d 2064 715f 690a 0a20 2020  , j] = dq_i..   
+00042670: 2020 2020 2020 2020 2023 2043 6f70 7920           # Copy 
+00042680: 6865 6164 6572 0a20 2020 2020 2020 2020  header.         
+00042690: 2020 2068 6173 5f62 6c6f 7473 6b79 203d     has_blotsky =
+000426a0: 2027 424c 4f54 534b 5927 2069 6e20 696d   'BLOTSKY' in im
+000426b0: 5b27 5343 4927 2c20 6578 745d 2e68 6561  ['SCI', ext].hea
+000426c0: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
+000426d0: 666f 7220 6b20 696e 2064 715b 2753 4349  for k in dq['SCI
+000426e0: 272c 2065 7874 5d2e 6865 6164 6572 3a0a  ', ext].header:.
+000426f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042700: 6966 206b 2069 6e20 5b27 4249 5450 4958  if k in ['BITPIX
+00042710: 272c 2027 4e41 5849 5331 272c 2027 4e41  ', 'NAXIS1', 'NA
+00042720: 5849 5332 272c 2027 272c 2027 4849 5354  XIS2', '', 'HIST
+00042730: 4f52 5927 5d3a 0a20 2020 2020 2020 2020  ORY']:.         
+00042740: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00042750: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00042760: 2020 2020 2069 6d5b 2753 4349 272c 2065       im['SCI', e
+00042770: 7874 5d2e 6865 6164 6572 5b6b 5d20 3d20  xt].header[k] = 
+00042780: 6471 5b27 5343 4927 2c20 6578 745d 2e68  dq['SCI', ext].h
+00042790: 6561 6465 725b 6b5d 0a0a 2020 2020 2020  eader[k]..      
+000427a0: 2020 2020 2020 6966 2028 6e6f 7420 6861        if (not ha
+000427b0: 735f 626c 6f74 736b 7929 2026 2028 2742  s_blotsky) & ('B
+000427c0: 4c4f 5453 4b59 2720 696e 2064 715b 2753  LOTSKY' in dq['S
+000427d0: 4349 272c 2065 7874 5d2e 6865 6164 6572  CI', ext].header
+000427e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000427f0: 2020 2069 6d5b 2753 4349 272c 2065 7874     im['SCI', ext
+00042800: 5d2e 6865 6164 6572 5b27 424c 4f54 534b  ].header['BLOTSK
+00042810: 5927 5d20 3d20 4661 6c73 650a 0a20 2020  Y'] = False..   
+00042820: 2069 6d2e 666c 7573 6828 290a 2020 2020   im.flush().    
+00042830: 696d 2e63 6c6f 7365 2829 0a0a 0a64 6566  im.close()...def
+00042840: 2052 4742 746f 4865 7828 7661 6c73 2c20   RGBtoHex(vals, 
+00042850: 7267 6274 7970 653d 3129 3a0a 2020 2020  rgbtype=1):.    
+00042860: 2222 2243 6f6e 7665 7274 7320 5247 4220  """Converts RGB 
+00042870: 7661 6c75 6573 2069 6e20 6120 7661 7269  values in a vari
+00042880: 6574 7920 6f66 2066 6f72 6d61 7473 2074  ety of formats t
+00042890: 6f20 4865 7820 7661 6c75 6573 2e0a 0a20  o Hex values... 
+000428a0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+000428b0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+000428c0: 2076 616c 7320 3a20 7475 706c 650a 2020   vals : tuple.  
+000428d0: 2020 2020 2020 2041 6e20 5247 422f 5247         An RGB/RG
+000428e0: 4241 2074 7570 6c65 0a0a 2020 2020 7267  BA tuple..    rg
+000428f0: 625f 7479 7065 203a 2069 6e74 0a20 2020  b_type : int.   
+00042900: 2020 2020 2056 616c 6964 2076 616c 7573       Valid valus
+00042910: 2061 7265 3a0a 2020 2020 2020 2020 202d   are:.         -
+00042920: 2031 203d 2049 6e70 7574 7320 6172 6520   1 = Inputs are 
+00042930: 696e 2074 6865 2072 616e 6765 2030 2074  in the range 0 t
+00042940: 6f20 310a 2020 2020 2020 2020 202d 2032  o 1.         - 2
+00042950: 3536 203d 2049 6e70 7574 7320 6172 6520  56 = Inputs are 
+00042960: 696e 2074 6865 2072 616e 6765 2030 2074  in the range 0 t
+00042970: 6f20 3235 350a 200a 2020 2020 5265 7475  o 255. .    Retu
+00042980: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00042990: 2020 2020 6865 7874 7374 7220 3a20 7374      hextstr : st
+000429a0: 720a 2020 2020 2020 2020 4120 6865 7820  r.        A hex 
+000429b0: 7374 7269 6e67 2069 6e20 7468 6520 666f  string in the fo
+000429c0: 726d 2027 2352 5247 4742 4227 206f 7220  rm '#RRGGBB' or 
+000429d0: 2723 5252 4747 4242 4141 270a 0a20 2020  '#RRGGBBAA'..   
+000429e0: 2052 6566 6572 656e 6365 730a 2020 2020   References.    
+000429f0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2028  ----------.    (
+00042a00: 6372 6564 6974 3a20 5279 6368 6172 6420  credit: Rychard 
+00042a10: 4020 6874 7470 733a 2f2f 7374 6163 6b6f  @ https://stacko
+00042a20: 7665 7266 6c6f 772e 636f 6d2f 612f 3438  verflow.com/a/48
+00042a30: 3238 3831 3733 290a 0a20 2020 2022 2222  288173)..    """
+00042a40: 0a0a 2020 2020 6d73 6720 3d20 2252 4742  ..    msg = "RGB
+00042a50: 206f 7220 5247 4241 2069 6e70 7574 7320   or RGBA inputs 
+00042a60: 746f 2052 4742 746f 4865 7820 6d75 7374  to RGBtoHex must
+00042a70: 2068 6176 6520 7468 7265 6520 6f72 2066   have three or f
+00042a80: 6f75 7220 656c 656d 656e 7473 2122 0a20  our elements!". 
+00042a90: 2020 2069 6620 286c 656e 2876 616c 7329     if (len(vals)
+00042aa0: 2021 3d20 3329 2026 2028 6c65 6e28 7661   != 3) & (len(va
+00042ab0: 6c73 2920 213d 2034 293a 0a20 2020 2020  ls) != 4):.     
+00042ac0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+00042ad0: 6f6e 286d 7367 290a 0a20 2020 2069 6620  on(msg)..    if 
+00042ae0: 2872 6762 7479 7065 2021 3d20 3129 2026  (rgbtype != 1) &
+00042af0: 2028 7267 6274 7970 6520 213d 2032 3536   (rgbtype != 256
+00042b00: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
+00042b10: 2045 7863 6570 7469 6f6e 2822 7267 6274   Exception("rgbt
+00042b20: 7970 6520 6d75 7374 2062 6520 3120 6f72  ype must be 1 or
+00042b30: 2032 3536 2122 290a 0a20 2020 2023 2043   256!")..    # C
+00042b40: 6f6e 7665 7274 2066 726f 6d20 302d 3120  onvert from 0-1 
+00042b50: 5247 422f 5247 4241 2074 6f20 302d 3235  RGB/RGBA to 0-25
+00042b60: 3520 5247 422f 5247 4241 0a20 2020 2069  5 RGB/RGBA.    i
+00042b70: 6620 7267 6274 7970 6520 3d3d 2031 3a0a  f rgbtype == 1:.
+00042b80: 2020 2020 2020 2020 7661 6c73 203d 205b          vals = [
+00042b90: 3235 352a 7820 666f 7220 7820 696e 2076  255*x for x in v
+00042ba0: 616c 735b 3a33 5d5d 0a0a 2020 2020 2320  als[:3]]..    # 
+00042bb0: 456e 7375 7265 2076 616c 7565 7320 6172  Ensure values ar
+00042bc0: 6520 726f 756e 6465 6420 696e 7465 6765  e rounded intege
+00042bd0: 7273 2c20 636f 6e76 6572 7420 746f 2068  rs, convert to h
+00042be0: 6578 2c20 616e 6420 636f 6e63 6174 656e  ex, and concaten
+00042bf0: 6174 650a 2020 2020 7265 7475 726e 2027  ate.    return '
+00042c00: 2327 202b 2027 272e 6a6f 696e 285b 277b  #' + ''.join(['{
+00042c10: 3a30 3258 7d27 2e66 6f72 6d61 7428 696e  :02X}'.format(in
+00042c20: 7428 726f 756e 6428 7829 2929 2066 6f72  t(round(x))) for
+00042c30: 2078 2069 6e20 7661 6c73 5d29 0a0a 0a64   x in vals])...d
+00042c40: 6566 2063 6174 616c 6f67 5f6d 6173 6b28  ef catalog_mask(
+00042c50: 6361 742c 2065 636f 6c3d 2746 4c55 5845  cat, ecol='FLUXE
+00042c60: 5252 5f41 5045 525f 3027 2c20 6d61 785f  RR_APER_0', max_
+00042c70: 6572 725f 7065 7263 656e 7469 6c65 3d39  err_percentile=9
+00042c80: 302c 2070 6164 3d30 2e30 352c 2070 6164  0, pad=0.05, pad
+00042c90: 5f69 735f 6162 736f 6c75 7465 3d46 616c  _is_absolute=Fal
+00042ca0: 7365 2c20 6d69 6e5f 666c 7578 5f72 6164  se, min_flux_rad
+00042cb0: 6975 733d 312e 293a 0a20 2020 2022 2222  ius=1.):.    """
+00042cc0: 0a20 2020 2043 6f6d 7075 7465 2061 2063  .    Compute a c
+00042cd0: 6174 616c 6f67 206d 6173 6b20 666f 720a  atalog mask for.
+00042ce0: 2020 2020 2020 3129 204f 626a 6563 7473        1) Objects
+00042cf0: 2077 6974 6869 6e20 6070 6164 6020 6f66   within `pad` of
+00042d00: 2074 6865 2065 6467 6520 6f66 2074 6865   the edge of the
+00042d10: 2063 6174 616c 6f67 2063 6f6e 7665 7820   catalog convex 
+00042d20: 6875 6c6c 0a20 2020 2020 2032 2920 556e  hull.      2) Un
+00042d30: 6365 7274 6169 6e74 6965 7320 3c20 606d  certainties < `m
+00042d40: 6178 5f65 7272 5f70 6572 6365 6e74 696c  ax_err_percentil
+00042d50: 6560 0a0a 2020 2020 2222 220a 2020 2020  e`..    """.    
+00042d60: 7465 7374 203d 206e 702e 6973 6669 6e69  test = np.isfini
+00042d70: 7465 2863 6174 5b27 464c 5558 5f41 5554  te(cat['FLUX_AUT
+00042d80: 4f27 5d29 0a20 2020 2069 6620 2746 4c55  O']).    if 'FLU
+00042d90: 585f 5241 4449 5553 2720 696e 2063 6174  X_RADIUS' in cat
+00042da0: 2e63 6f6c 6e61 6d65 733a 0a20 2020 2020  .colnames:.     
+00042db0: 2020 2074 6573 7420 263d 2063 6174 5b27     test &= cat['
+00042dc0: 464c 5558 5f52 4144 4955 5327 5d20 3e20  FLUX_RADIUS'] > 
+00042dd0: 6d69 6e5f 666c 7578 5f72 6164 6975 730a  min_flux_radius.
+00042de0: 0a20 2020 2074 6573 7420 263d 2028 6361  .    test &= (ca
+00042df0: 745b 2754 4852 4553 4827 5d20 3e20 3029  t['THRESH'] > 0)
+00042e00: 2026 2028 6361 745b 2754 4852 4553 4827   & (cat['THRESH'
+00042e10: 5d20 3c20 3165 3238 290a 0a20 2020 206e  ] < 1e28)..    n
+00042e20: 6f74 5f65 6467 6520 3d20 6875 6c6c 5f65  ot_edge = hull_e
+00042e30: 6467 655f 6d61 736b 2863 6174 5b27 585f  dge_mask(cat['X_
+00042e40: 494d 4147 4527 5d2c 2063 6174 5b27 595f  IMAGE'], cat['Y_
+00042e50: 494d 4147 4527 5d2c 0a20 2020 2020 2020  IMAGE'],.       
+00042e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042e70: 2020 2020 2020 2070 6164 3d70 6164 2c20         pad=pad, 
+00042e80: 7061 645f 6973 5f61 6273 6f6c 7574 653d  pad_is_absolute=
+00042e90: 7061 645f 6973 5f61 6273 6f6c 7574 6529  pad_is_absolute)
+00042ea0: 0a0a 2020 2020 7465 7374 2026 3d20 6e6f  ..    test &= no
+00042eb0: 745f 6564 6765 0a0a 2020 2020 6966 2065  t_edge..    if e
+00042ec0: 636f 6c20 696e 2063 6174 2e63 6f6c 6e61  col in cat.colna
+00042ed0: 6d65 733a 0a20 2020 2020 2020 2076 616c  mes:.        val
+00042ee0: 6964 203d 206e 702e 6973 6669 6e69 7465  id = np.isfinite
+00042ef0: 2863 6174 5b65 636f 6c5d 290a 2020 2020  (cat[ecol]).    
+00042f00: 2020 2020 6966 206d 6178 5f65 7272 5f70      if max_err_p
+00042f10: 6572 6365 6e74 696c 6520 3c20 3130 303a  ercentile < 100:
+00042f20: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+00042f30: 7420 263d 2063 6174 5b65 636f 6c5d 203c  t &= cat[ecol] <
+00042f40: 206e 702e 7065 7263 656e 7469 6c65 2863   np.percentile(c
+00042f50: 6174 5b65 636f 6c5d 5b28 7e6e 6f74 5f65  at[ecol][(~not_e
+00042f60: 6467 6529 2026 2076 616c 6964 5d2c 0a20  dge) & valid],. 
+00042f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042f90: 2020 2020 2020 2020 206d 6178 5f65 7272           max_err
+00042fa0: 5f70 6572 6365 6e74 696c 6529 0a0a 2020  _percentile)..  
+00042fb0: 2020 7265 7475 726e 2074 6573 740a 0a0a    return test...
+00042fc0: 6465 6620 6875 6c6c 5f65 6467 655f 6d61  def hull_edge_ma
+00042fd0: 736b 2878 2c20 792c 2070 6164 3d31 3030  sk(x, y, pad=100
+00042fe0: 2c20 7061 645f 6973 5f61 6273 6f6c 7574  , pad_is_absolut
+00042ff0: 653d 5472 7565 2c20 6d61 736b 3d4e 6f6e  e=True, mask=Non
+00043000: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+00043010: 436f 6d70 7574 6520 6765 6f6d 6574 7269  Compute geometri
+00043020: 6361 6c20 6564 6765 206d 6173 6b20 666f  cal edge mask fo
+00043030: 7220 706f 696e 7473 2077 6974 6869 6e20  r points within 
+00043040: 6120 636f 6e76 6578 2068 756c 6c0a 0a20  a convex hull.. 
+00043050: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00043060: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00043070: 2078 2c20 7920 3a20 6172 7261 790a 2020   x, y : array.  
+00043080: 2020 2020 2020 436f 6f72 6469 6e61 7465        Coordinate
+00043090: 7320 6f66 2074 6865 2063 6174 616c 6f67  s of the catalog
+000430a0: 0a0a 2020 2020 7061 6420 3a20 666c 6f61  ..    pad : floa
+000430b0: 740a 2020 2020 2020 2020 4275 6666 6572  t.        Buffer
+000430c0: 2070 6164 6469 6e67 0a0a 2020 2020 7061   padding..    pa
+000430d0: 645f 6973 5f61 6273 6f6c 7574 6520 3a20  d_is_absolute : 
+000430e0: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
+000430f0: 5472 7565 2c20 7468 656e 2074 6865 2062  True, then the b
+00043100: 7566 6665 7220 6973 2074 616b 656e 2066  uffer is taken f
+00043110: 726f 6d20 6070 6164 6020 2865 2e67 2e2c  rom `pad` (e.g.,
+00043120: 2070 6978 656c 7329 2e20 2049 660a 2020   pixels).  If.  
+00043130: 2020 2020 2020 4661 6c73 652c 2074 6865        False, the
+00043140: 6e20 6070 6164 6020 6973 2074 7265 6174  n `pad` is treat
+00043150: 6564 2061 7320 6120 6672 6163 7469 6f6e  ed as a fraction
+00043160: 206f 6620 7468 6520 6c69 6e65 6172 2064   of the linear d
+00043170: 696d 656e 7369 6f6e 0a20 2020 2020 2020  imension.       
+00043180: 206f 6620 7468 6520 6361 7461 6c6f 6720   of the catalog 
+00043190: 2860 7e73 7172 7428 6875 6c6c 2061 7265  (`~sqrt(hull are
+000431a0: 6129 6029 2e0a 0a20 2020 206d 6173 6b20  a)`)...    mask 
+000431b0: 3a20 626f 6f6c 2061 7272 6179 0a20 2020  : bool array.   
+000431c0: 2020 2020 204d 6173 6b20 746f 2061 7070       Mask to app
+000431d0: 6c79 2074 6f20 782f 7920 6265 666f 7265  ly to x/y before
+000431e0: 2063 6f6d 7075 7469 6e67 2074 6865 2063   computing the c
+000431f0: 6f6e 7665 7820 6875 6c6c 0a0a 2020 2020  onvex hull..    
+00043200: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00043210: 2d2d 2d0a 2020 2020 6d61 736b 203a 2062  ---.    mask : b
+00043220: 6f6f 6c20 6172 7261 790a 2020 2020 2020  ool array.      
+00043230: 2020 5472 7565 2069 6620 706f 696e 7473    True if points
+00043240: 2077 6974 6869 6e20 7468 6520 6275 6666   within the buff
+00043250: 6572 6564 2068 756c 6c0a 0a20 2020 2022  ered hull..    "
+00043260: 2222 0a0a 2020 2020 6672 6f6d 2073 6369  ""..    from sci
+00043270: 7079 2e73 7061 7469 616c 2069 6d70 6f72  py.spatial impor
+00043280: 7420 436f 6e76 6578 4875 6c6c 0a20 2020  t ConvexHull.   
+00043290: 2066 726f 6d20 7368 6170 656c 792e 6765   from shapely.ge
+000432a0: 6f6d 6574 7279 2069 6d70 6f72 7420 506f  ometry import Po
+000432b0: 6c79 676f 6e2c 2050 6f69 6e74 0a0a 2020  lygon, Point..  
+000432c0: 2020 7879 203d 206e 702e 6172 7261 7928    xy = np.array(
+000432d0: 5b78 2c20 795d 292e 540a 0a20 2020 2069  [x, y]).T..    i
+000432e0: 6620 6d61 736b 2069 7320 4e6f 6e65 3a0a  f mask is None:.
+000432f0: 2020 2020 2020 2020 6875 6c6c 203d 2043          hull = C
+00043300: 6f6e 7665 7848 756c 6c28 7879 290a 2020  onvexHull(xy).  
+00043310: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00043320: 6875 6c6c 203d 2043 6f6e 7665 7848 756c  hull = ConvexHul
+00043330: 6c28 7879 5b6d 6173 6b2c 203a 5d29 0a0a  l(xy[mask, :])..
+00043340: 2020 2020 7078 7920 3d20 7879 5b68 756c      pxy = xy[hul
+00043350: 6c2e 7665 7274 6963 6573 2c20 3a5d 0a20  l.vertices, :]. 
+00043360: 2020 2070 6f6c 7920 3d20 506f 6c79 676f     poly = Polygo
+00043370: 6e28 7078 7929 0a0a 2020 2020 6966 2070  n(pxy)..    if p
+00043380: 6164 5f69 735f 6162 736f 6c75 7465 3a0a  ad_is_absolute:.
+00043390: 2020 2020 2020 2020 6275 6666 203d 202d          buff = -
+000433a0: 7061 640a 2020 2020 656c 7365 3a0a 2020  pad.    else:.  
+000433b0: 2020 2020 2020 2320 6c69 6e65 6172 2064        # linear d
+000433c0: 696d 656e 7369 6f6e 207e 2073 7172 7428  imension ~ sqrt(
+000433d0: 6172 6561 290a 2020 2020 2020 2020 6275  area).        bu
+000433e0: 6666 203d 202d 7061 642a 6e70 2e73 7172  ff = -pad*np.sqr
+000433f0: 7428 706f 6c79 2e61 7265 6129 0a0a 2020  t(poly.area)..  
+00043400: 2020 7062 7566 6620 3d20 706f 6c79 2e62    pbuff = poly.b
+00043410: 7566 6665 7228 6275 6666 290a 2020 2020  uffer(buff).    
+00043420: 696e 5f62 7566 6620 3d20 6e70 2e61 7272  in_buff = np.arr
+00043430: 6179 285b 7062 7566 662e 636f 6e74 6169  ay([pbuff.contai
+00043440: 6e73 2850 6f69 6e74 285b 785b 695d 2c20  ns(Point([x[i], 
+00043450: 795b 695d 5d29 2920 666f 7220 6920 696e  y[i]])) for i in
+00043460: 2072 616e 6765 286c 656e 2878 2929 5d29   range(len(x))])
+00043470: 0a0a 2020 2020 7265 7475 726e 2069 6e5f  ..    return in_
+00043480: 6275 6666 0a0a 0a64 6566 2063 6f6e 7665  buff...def conve
+00043490: 785f 6875 6c6c 5f77 7261 7070 6572 2878  x_hull_wrapper(x
+000434a0: 2c20 7929 3a0a 2020 2020 2222 220a 2020  , y):.    """.  
+000434b0: 2020 4765 6e65 7261 7465 2061 2063 6f6e    Generate a con
+000434c0: 7665 7820 6875 6c6c 2066 726f 6d20 6120  vex hull from a 
+000434d0: 6c69 7374 206f 6620 706f 696e 7473 0a20  list of points. 
+000434e0: 2020 200a 2020 2020 5265 7475 726e 733a     .    Returns:
+000434f0: 0a20 2020 200a 2020 2020 7078 7920 3a20  .    .    pxy : 
+00043500: 2861 7272 6179 2c20 6172 7261 7929 0a20  (array, array). 
+00043510: 2020 2020 2020 2054 7570 6c65 206f 6620         Tuple of 
+00043520: 6875 6c6c 2076 6572 7469 6365 730a 2020  hull vertices.  
+00043530: 2020 0a20 2020 2070 6f6c 7920 3a20 607e    .    poly : `~
+00043540: 7368 6170 656c 792e 6765 6f6d 6574 7279  shapely.geometry
+00043550: 2e50 6f6c 7967 6f6e 600a 2020 2020 2020  .Polygon`.      
+00043560: 2020 506f 6c79 676f 6e20 6f62 6a65 6374    Polygon object
+00043570: 2e0a 2020 2020 0a20 2020 2068 756c 6c20  ..    .    hull 
+00043580: 3a20 607e 7363 6970 792e 7370 6174 6961  : `~scipy.spatia
+00043590: 6c2e 436f 6e76 6578 4875 6c6c 600a 2020  l.ConvexHull`.  
+000435a0: 2020 2020 2020 5468 6520 6875 6c6c 206f        The hull o
+000435b0: 626a 6563 742e 0a20 2020 2020 2020 200a  bject..        .
+000435c0: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
+000435d0: 2073 6369 7079 2e73 7061 7469 616c 2069   scipy.spatial i
+000435e0: 6d70 6f72 7420 436f 6e76 6578 4875 6c6c  mport ConvexHull
+000435f0: 0a20 2020 2066 726f 6d20 7368 6170 656c  .    from shapel
+00043600: 792e 6765 6f6d 6574 7279 2069 6d70 6f72  y.geometry impor
+00043610: 7420 506f 6c79 676f 6e2c 2050 6f69 6e74  t Polygon, Point
+00043620: 0a0a 2020 2020 7879 203d 206e 702e 6172  ..    xy = np.ar
+00043630: 7261 7928 5b78 2c20 795d 292e 540a 2020  ray([x, y]).T.  
+00043640: 2020 6875 6c6c 203d 2043 6f6e 7665 7848    hull = ConvexH
+00043650: 756c 6c28 7879 290a 2020 2020 7078 7920  ull(xy).    pxy 
+00043660: 3d20 7879 5b68 756c 6c2e 7665 7274 6963  = xy[hull.vertic
+00043670: 6573 2c20 3a5d 0a20 2020 2070 6f6c 7920  es, :].    poly 
+00043680: 3d20 506f 6c79 676f 6e28 7078 7929 0a20  = Polygon(pxy). 
+00043690: 2020 200a 2020 2020 7265 7475 726e 2070     .    return p
+000436a0: 7879 2c20 706f 6c79 2c20 6875 6c6c 0a0a  xy, poly, hull..
+000436b0: 0a64 6566 2068 756c 6c5f 6172 6561 2878  .def hull_area(x
+000436c0: 2c20 7929 3a0a 2020 2020 2222 220a 2020  , y):.    """.  
+000436d0: 2020 5265 7475 726e 2074 6865 2061 7265    Return the are
+000436e0: 6120 6f66 2061 2063 6f6e 7665 7820 6875  a of a convex hu
+000436f0: 6c6c 206f 6620 6120 6c69 7374 206f 6620  ll of a list of 
+00043700: 706f 696e 7473 0a20 2020 2022 2222 0a20  points.    """. 
+00043710: 2020 2070 7879 2c20 706f 6c79 2c20 6875     pxy, poly, hu
+00043720: 6c6c 203d 2063 6f6e 7665 785f 6875 6c6c  ll = convex_hull
+00043730: 5f77 7261 7070 6572 2878 2c20 7929 0a0a  _wrapper(x, y)..
+00043740: 2020 2020 7265 7475 726e 2070 6f6c 792e      return poly.
+00043750: 6172 6561 0a20 2020 200a 2020 2020 0a64  area.    .    .d
+00043760: 6566 2072 656d 6f76 655f 7465 7874 5f6c  ef remove_text_l
+00043770: 6162 656c 7328 6669 6729 3a0a 2020 2020  abels(fig):.    
+00043780: 2222 220a 2020 2020 5265 6d6f 7665 2061  """.    Remove a
+00043790: 6c6c 2054 6578 7420 616e 6e6f 7461 7469  ll Text annotati
+000437a0: 6f6e 7320 6672 6f6d 2060 6066 6967 2e61  ons from ``fig.a
+000437b0: 7865 7360 602e 0a20 2020 2022 2222 0a20  xes``..    """. 
+000437c0: 2020 2069 6d70 6f72 7420 6d61 7470 6c6f     import matplo
+000437d0: 746c 6962 0a20 2020 200a 2020 2020 666f  tlib.    .    fo
+000437e0: 7220 6178 2069 6e20 6669 672e 6178 6573  r ax in fig.axes
+000437f0: 3a0a 2020 2020 2020 2020 666f 7220 6368  :.        for ch
+00043800: 696c 6420 696e 2061 782e 6765 745f 6368  ild in ax.get_ch
+00043810: 696c 6472 656e 2829 3a0a 2020 2020 2020  ildren():.      
+00043820: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00043830: 6e63 6528 6368 696c 642c 206d 6174 706c  nce(child, matpl
+00043840: 6f74 6c69 622e 7465 7874 2e54 6578 7429  otlib.text.Text)
+00043850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00043860: 2020 6966 2063 6869 6c64 2e67 6574 5f74    if child.get_t
+00043870: 6578 7428 293a 2023 2044 6f6e 2774 2072  ext(): # Don't r
+00043880: 656d 6f76 6520 656d 7074 7920 6c61 6265  emove empty labe
+00043890: 6c73 0a20 2020 2020 2020 2020 2020 2020  ls.             
+000438a0: 2020 2020 2020 2063 6869 6c64 2e73 6574         child.set
+000438b0: 5f76 6973 6962 6c65 2846 616c 7365 290a  _visible(False).
+000438c0: 0a20 2020 200a 4c4f 4746 494c 4520 3d20  .    .LOGFILE = 
+000438d0: 272f 746d 702f 6772 697a 6c69 2e6c 6f67  '/tmp/grizli.log
+000438e0: 270a 0a0a 6465 6620 6c6f 675f 6675 6e63  '...def log_func
+000438f0: 7469 6f6e 5f61 7267 756d 656e 7473 284c  tion_arguments(L
+00043900: 4f47 4649 4c45 2c20 6672 616d 652c 2066  OGFILE, frame, f
+00043910: 756e 633d 2766 756e 6327 2c20 6967 6e6f  unc='func', igno
+00043920: 7265 3d5b 5d2c 2076 6572 626f 7365 3d54  re=[], verbose=T
+00043930: 7275 6529 3a0a 2020 2020 2222 220a 2020  rue):.    """.  
+00043940: 2020 4c6f 6720 6c6f 6361 6c20 7661 7269    Log local vari
+00043950: 6162 6c65 732c 2065 2e67 2e2c 2070 6172  ables, e.g., par
+00043960: 616d 6574 6572 2061 7267 7565 6d65 6e74  ameter arguement
+00043970: 7320 746f 2061 2066 696c 650a 0a20 2020  s to a file..   
+00043980: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00043990: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 204c  ----------.    L
+000439a0: 4f47 4649 4c45 203a 2073 7472 206f 7220  OGFILE : str or 
+000439b0: 4e6f 6e65 0a20 2020 2020 2020 204f 7574  None.        Out
+000439c0: 7075 7420 6669 6c65 2e20 2049 6620 604e  put file.  If `N
+000439d0: 6f6e 6560 2c20 7468 656e 2066 6f72 6365  one`, then force
+000439e0: 2060 7665 7262 6f73 653d 5472 7565 602e   `verbose=True`.
+000439f0: 0a0a 2020 2020 6672 616d 6520 3a20 607e  ..    frame : `~
+00043a00: 696e 7370 6563 742e 6375 7272 656e 7466  inspect.currentf
+00043a10: 7261 6d65 2829 600a 2020 2020 2020 2020  rame()`.        
+00043a20: 4e61 6d65 7370 6163 6520 6f62 6a65 6374  Namespace object
+00043a30: 2e0a 0a20 2020 2066 756e 6320 3a20 7374  ...    func : st
+00043a40: 720a 2020 2020 2020 2020 4675 6e63 7469  r.        Functi
+00043a50: 6f6e 206e 616d 6520 746f 2075 7365 0a20  on name to use. 
+00043a60: 2020 200a 2020 2020 6967 6e6f 7265 203a     .    ignore :
+00043a70: 206c 6973 740a 2020 2020 2020 2020 5661   list.        Va
+00043a80: 7269 6162 6c65 206e 616d 6573 2074 6f20  riable names to 
+00043a90: 6967 6e6f 7265 0a20 2020 200a 2020 2020  ignore.    .    
+00043aa0: 7665 7262 6f73 6520 3a20 626f 6f6c 0a20  verbose : bool. 
+00043ab0: 2020 2020 2020 2050 7269 6e74 206d 6573         Print mes
+00043ac0: 7361 6167 6520 746f 2073 7464 6f75 742e  saage to stdout.
+00043ad0: 0a0a 2020 2020 2222 220a 2020 2020 6172  ..    """.    ar
+00043ae0: 6773 203d 2069 6e73 7065 6374 2e67 6574  gs = inspect.get
+00043af0: 6172 6776 616c 7565 7328 6672 616d 6529  argvalues(frame)
+00043b00: 2e6c 6f63 616c 730a 2020 2020 6172 6773  .locals.    args
+00043b10: 2e70 6f70 2827 6672 616d 6527 290a 2020  .pop('frame').  
+00043b20: 2020 666f 7220 6b20 696e 206c 6973 7428    for k in list(
+00043b30: 6172 6773 2e6b 6579 7328 2929 3a0a 2020  args.keys()):.  
+00043b40: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
+00043b50: 2861 7267 735b 6b5d 2c20 275f 5f62 7569  (args[k], '__bui
+00043b60: 6c74 696e 735f 5f27 293a 0a20 2020 2020  ltins__'):.     
+00043b70: 2020 2020 2020 2061 7267 732e 706f 7028         args.pop(
+00043b80: 6b29 0a20 2020 200a 2020 2020 666f 7220  k).    .    for 
+00043b90: 6b20 696e 2069 676e 6f72 653a 0a20 2020  k in ignore:.   
+00043ba0: 2020 2020 2069 6620 6b20 696e 2061 7267       if k in arg
+00043bb0: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+00043bc0: 7267 732e 706f 7028 6b29 0a20 2020 2020  rgs.pop(k).     
+00043bd0: 2020 2020 2020 200a 2020 2020 6966 2066         .    if f
+00043be0: 756e 6320 6973 206e 6f74 204e 6f6e 653a  unc is not None:
+00043bf0: 0a20 2020 2020 2020 206c 6f67 7374 7220  .        logstr 
+00043c00: 3d20 275c 6e7b 307d 282a 2a7b 317d 295c  = '\n{0}(**{1})\
+00043c10: 6e27 0a20 2020 2065 6c73 653a 0a20 2020  n'.    else:.   
+00043c20: 2020 2020 206c 6f67 7374 7220 3d20 275c       logstr = '\
+00043c30: 6e7b 317d 270a 0a20 2020 206c 6f67 7374  n{1}'..    logst
+00043c40: 7220 3d20 6c6f 6773 7472 2e66 6f72 6d61  r = logstr.forma
+00043c50: 7428 6675 6e63 2c20 6172 6773 290a 2020  t(func, args).  
+00043c60: 2020 6d73 6720 3d20 6c6f 675f 636f 6d6d    msg = log_comm
+00043c70: 656e 7428 4c4f 4746 494c 452c 206c 6f67  ent(LOGFILE, log
+00043c80: 7374 722c 2076 6572 626f 7365 3d76 6572  str, verbose=ver
+00043c90: 626f 7365 2c20 7368 6f77 5f64 6174 653d  bose, show_date=
+00043ca0: 5472 7565 290a 0a20 2020 2072 6574 7572  True)..    retur
+00043cb0: 6e20 6d73 670a 0a0a 6465 6620 6374 696d  n msg...def ctim
+00043cc0: 655f 746f 5f69 736f 286d 7469 6d65 2c20  e_to_iso(mtime, 
+00043cd0: 666f 726d 6174 3d27 2561 2025 6220 2564  format='%a %b %d
+00043ce0: 2025 483a 254d 3a25 5320 2559 272c 2073   %H:%M:%S %Y', s
+00043cf0: 7472 6970 5f64 6563 696d 616c 3d54 7275  trip_decimal=Tru
+00043d00: 652c 2076 6572 626f 7365 3d54 7275 6529  e, verbose=True)
+00043d10: 3a0a 2020 2020 2222 220a 2020 2020 436f  :.    """.    Co
+00043d20: 6e76 6572 7420 6074 696d 652e 6374 696d  nvert `time.ctim
+00043d30: 6560 2073 7472 696e 6773 2074 6f20 4953  e` strings to IS
+00043d40: 4f20 6461 7465 730a 0a20 2020 2050 6172  O dates..    Par
+00043d50: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00043d60: 2d2d 2d2d 2d2d 0a20 2020 206d 7469 6d65  ------.    mtime
+00043d70: 203a 2073 7472 0a20 2020 2020 2020 2054   : str.        T
+00043d80: 696d 6520 7374 7269 6e67 2c20 6765 6e65  ime string, gene
+00043d90: 7261 6c6c 7920 6173 206f 7574 7075 7420  rally as output 
+00043da0: 6672 6f6d 2060 7469 6d65 2e63 7469 6d65  from `time.ctime
+00043db0: 602c 2065 2e67 2e2c 200a 2020 2020 2020  `, e.g., .      
+00043dc0: 2020 6060 274d 6f6e 2053 6570 2031 3620    ``'Mon Sep 16 
+00043dd0: 3131 3a32 333a 3237 2032 3031 3927 6060  11:23:27 2019'``
+00043de0: 0a0a 2020 2020 666f 726d 6174 203a 2073  ..    format : s
+00043df0: 7472 0a20 2020 2020 2020 2060 6461 7465  tr.        `date
+00043e00: 7469 6d65 2e73 7472 7074 696d 6560 2066  time.strptime` f
+00043e10: 6f72 6d61 7420 7374 7269 6e67 2c20 636f  ormat string, co
+00043e20: 6465 7320 6174 200a 2020 2020 2020 2020  des at .        
+00043e30: 6874 7470 733a 2f2f 7777 772e 7072 6f67  https://www.prog
+00043e40: 7261 6d69 7a2e 636f 6d2f 7079 7468 6f6e  ramiz.com/python
+00043e50: 2d70 726f 6772 616d 6d69 6e67 2f64 6174  -programming/dat
+00043e60: 6574 696d 652f 7374 7270 7469 6d65 0a0a  etime/strptime..
+00043e70: 2020 2020 7374 7269 705f 6465 6369 6d61      strip_decima
+00043e80: 6c20 3a20 626f 6f6c 0a20 2020 2020 2020  l : bool.       
+00043e90: 2053 7472 6970 2064 6563 696d 616c 2073   Strip decimal s
+00043ea0: 6563 6f6e 6473 2066 726f 6d20 656e 6420  econds from end 
+00043eb0: 6f66 2049 534f 2073 7472 696e 670a 0a20  of ISO string.. 
+00043ec0: 2020 2076 6572 626f 7365 203a 2062 6f6f     verbose : boo
+00043ed0: 6c0a 2020 2020 2020 2020 5072 696e 7420  l.        Print 
+00043ee0: 6120 6d65 7373 6167 6520 6966 2063 6f6e  a message if con
+00043ef0: 7665 7273 696f 6e20 6661 696c 730a 0a20  version fails.. 
+00043f00: 2020 2052 6574 7572 6e73 200a 2020 2020     Returns .    
+00043f10: 2d2d 2d2d 2d2d 2d0a 2020 2020 6973 6f20  -------.    iso 
+00043f20: 3a20 7374 720a 2020 2020 2020 2020 5374  : str.        St
+00043f30: 7269 6e67 2069 6e20 2873 6f72 7461 626c  ring in (sortabl
+00043f40: 6529 2049 534f 2066 6f72 6d61 742c 2065  e) ISO format, e
+00043f50: 2e67 2e2c 2060 6027 3230 3139 2d30 392d  .g., ``'2019-09-
+00043f60: 3136 2031 313a 3233 3a32 372e 3030 3027  16 11:23:27.000'
+00043f70: 6060 0a0a 2020 2020 2222 220a 2020 2020  ``..    """.    
+00043f80: 6672 6f6d 2061 7374 726f 7079 2e74 696d  from astropy.tim
+00043f90: 6520 696d 706f 7274 2054 696d 650a 2020  e import Time.  
+00043fa0: 2020 6672 6f6d 2064 6174 6574 696d 6520    from datetime 
+00043fb0: 696d 706f 7274 2064 6174 6574 696d 650a  import datetime.
+00043fc0: 0a20 2020 2023 2049 7320 616c 7265 6164  .    # Is alread
+00043fd0: 7920 4953 4f20 666f 726d 6174 0a20 2020  y ISO format.   
+00043fe0: 2069 6620 6d74 696d 652e 636f 756e 7428   if mtime.count(
+00043ff0: 272d 2729 203d 3d20 323a 0a20 2020 2020  '-') == 2:.     
+00044000: 2020 2069 736f 203d 206d 7469 6d65 202b     iso = mtime +
+00044010: 2027 270a 0a20 2020 2065 6c73 653a 0a20   ''..    else:. 
+00044020: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00044030: 2020 2020 2020 2020 6973 6f20 3d20 5469          iso = Ti
+00044040: 6d65 2864 6174 6574 696d 652e 7374 7270  me(datetime.strp
+00044050: 7469 6d65 286d 7469 6d65 2c20 666f 726d  time(mtime, form
+00044060: 6174 292c 200a 2020 2020 2020 2020 2020  at), .          
+00044070: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00044080: 6d61 743d 2764 6174 6574 696d 6527 292e  mat='datetime').
+00044090: 6973 6f0a 2020 2020 2020 2020 6578 6365  iso.        exce
+000440a0: 7074 2056 616c 7565 4572 726f 723a 0a20  pt ValueError:. 
+000440b0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+000440c0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+000440d0: 2020 2020 2020 2070 7269 6e74 2866 2743         print(f'C
+000440e0: 6f75 6c64 6e5c 2774 2063 6f6e 7665 7274  ouldn\'t convert
+000440f0: 205c 277b 6d74 696d 657d 5c27 2077 6974   \'{mtime}\' wit
+00044100: 6820 270a 2020 2020 2020 2020 2020 2020  h '.            
+00044110: 2020 2020 2020 2020 2020 6627 666f 726d            f'form
+00044120: 6174 205c 277b 666f 726d 6174 7d5c 2727  at \'{format}\''
+00044130: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+00044140: 736f 203d 206d 7469 6d65 202b 2027 270a  so = mtime + ''.
+00044150: 0a20 2020 2069 6620 7374 7269 705f 6465  .    if strip_de
+00044160: 6369 6d61 6c3a 0a20 2020 2020 2020 2069  cimal:.        i
+00044170: 736f 203d 2069 736f 2e73 706c 6974 2827  so = iso.split('
+00044180: 2e27 295b 305d 0a0a 2020 2020 7265 7475  .')[0]..    retu
+00044190: 726e 2069 736f 0a0a 0a64 6566 206e 6f77  rn iso...def now
+000441a0: 7469 6d65 2869 736f 3d54 7275 6529 3a0a  time(iso=True):.
+000441b0: 2020 2020 2222 220a 2020 2020 5772 6170      """.    Wrap
+000441c0: 7065 7220 666f 7220 6061 7374 726f 7079  per for `astropy
+000441d0: 2e74 696d 652e 6e6f 7760 0a0a 2020 2020  .time.now`..    
+000441e0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+000441f0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6973  ---------.    is
+00044200: 6f20 3a20 626f 6f6c 0a20 2020 2020 2020  o : bool.       
+00044210: 2049 6620 5472 7565 2c20 7265 7475 726e   If True, return
+00044220: 2074 696d 6520 696e 2049 534f 2073 7472   time in ISO str
+00044230: 696e 672c 2065 6c73 6520 7265 7475 726e  ing, else return
+00044240: 2054 696d 6520 6f62 6a65 6374 0a0a 2020   Time object..  
+00044250: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00044260: 2d2d 2d2d 2d0a 2020 2020 746e 6f77 203a  -----.    tnow :
+00044270: 2073 7472 0a20 2020 2020 2020 2053 6565   str.        See
+00044280: 2060 6973 6f60 0a0a 2020 2020 2222 220a   `iso`..    """.
+00044290: 2020 2020 6672 6f6d 2061 7374 726f 7079      from astropy
+000442a0: 2e74 696d 6520 696d 706f 7274 2054 696d  .time import Tim
+000442b0: 650a 2020 2020 746e 6f77 203d 2054 696d  e.    tnow = Tim
+000442c0: 652e 6e6f 7728 290a 2020 2020 6966 2069  e.now().    if i
+000442d0: 736f 3a0a 2020 2020 2020 2020 7265 7475  so:.        retu
+000442e0: 726e 2074 6e6f 772e 6973 6f0a 2020 2020  rn tnow.iso.    
+000442f0: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
+00044300: 7475 726e 2074 6e6f 770a 0a0a 6465 6620  turn tnow...def 
+00044310: 6c6f 675f 636f 6d6d 656e 7428 4c4f 4746  log_comment(LOGF
+00044320: 494c 452c 2063 6f6d 6d65 6e74 2c20 7665  ILE, comment, ve
+00044330: 7262 6f73 653d 4661 6c73 652c 2073 686f  rbose=False, sho
+00044340: 775f 6461 7465 3d46 616c 7365 2c20 6d6f  w_date=False, mo
+00044350: 6465 3d27 6127 293a 0a20 2020 2022 2222  de='a'):.    """
+00044360: 0a20 2020 204c 6f67 2061 206d 6573 7361  .    Log a messa
+00044370: 6765 2074 6f20 6120 6669 6c65 2c20 6f70  ge to a file, op
+00044380: 7469 6f6e 616c 6c79 2069 6e63 6c75 6469  tionally includi
+00044390: 6e67 2061 2064 6174 6520 7461 670a 2020  ng a date tag.  
+000443a0: 2020 2222 220a 2020 2020 696d 706f 7274    """.    import
+000443b0: 2074 696d 650a 0a20 2020 2069 6620 7368   time..    if sh
+000443c0: 6f77 5f64 6174 653a 0a20 2020 2020 2020  ow_date:.       
+000443d0: 206d 7367 203d 2027 2320 287b 307d 295c   msg = '# ({0})\
+000443e0: 6e27 2e66 6f72 6d61 7428 6e6f 7774 696d  n'.format(nowtim
+000443f0: 6528 2929 0a20 2020 2065 6c73 653a 0a20  e()).    else:. 
+00044400: 2020 2020 2020 206d 7367 203d 2027 270a         msg = ''.
+00044410: 0a20 2020 206d 7367 202b 3d20 277b 307d  .    msg += '{0}
+00044420: 5c6e 272e 666f 726d 6174 2863 6f6d 6d65  \n'.format(comme
+00044430: 6e74 290a 0a20 2020 2069 6620 4c4f 4746  nt)..    if LOGF
+00044440: 494c 4520 6973 206e 6f74 204e 6f6e 653a  ILE is not None:
+00044450: 0a20 2020 2020 2020 2066 7020 3d20 6f70  .        fp = op
+00044460: 656e 284c 4f47 4649 4c45 2c20 6d6f 6465  en(LOGFILE, mode
+00044470: 290a 2020 2020 2020 2020 6670 2e77 7269  ).        fp.wri
+00044480: 7465 286d 7367 290a 2020 2020 2020 2020  te(msg).        
+00044490: 6670 2e63 6c6f 7365 2829 0a0a 2020 2020  fp.close()..    
+000444a0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+000444b0: 2020 2020 7072 696e 7428 6d73 675b 3a2d      print(msg[:-
+000444c0: 315d 290a 0a20 2020 2072 6574 7572 6e20  1])..    return 
+000444d0: 6d73 670a 0a0a 6465 6620 6c6f 675f 6578  msg...def log_ex
+000444e0: 6365 7074 696f 6e28 4c4f 4746 494c 452c  ception(LOGFILE,
+000444f0: 2074 7261 6365 6261 636b 2c20 7665 7262   traceback, verb
+00044500: 6f73 653d 5472 7565 2c20 6d6f 6465 3d27  ose=True, mode='
+00044510: 6127 293a 0a20 2020 2022 2222 0a20 2020  a'):.    """.   
+00044520: 204c 6f67 2065 7863 6570 7469 6f6e 2069   Log exception i
+00044530: 6e66 6f72 6d61 7469 6f6e 2074 6f20 6120  nformation to a 
+00044540: 6669 6c65 2c20 6f72 2070 7269 6e74 2074  file, or print t
+00044550: 6f20 7363 7265 656e 0a0a 2020 2020 5061  o screen..    Pa
+00044560: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00044570: 2d2d 2d2d 2d2d 2d0a 2020 2020 4c4f 4746  -------.    LOGF
+00044580: 494c 4520 3a20 7374 7220 6f72 204e 6f6e  ILE : str or Non
+00044590: 650a 2020 2020 2020 2020 4f75 7470 7574  e.        Output
+000445a0: 2066 696c 652e 2020 4966 2060 4e6f 6e65   file.  If `None
+000445b0: 602c 2074 6865 6e20 666f 7263 6520 6076  `, then force `v
+000445c0: 6572 626f 7365 3d54 7275 6560 2e0a 0a20  erbose=True`... 
+000445d0: 2020 2074 7261 6365 6261 636b 203a 2062     traceback : b
+000445e0: 7569 6c74 696e 2074 7261 6365 6261 636b  uiltin traceback
+000445f0: 206d 6f64 756c 650a 2020 2020 2020 2020   module.        
+00044600: 4578 6365 7074 696f 6e20 7472 6163 6562  Exception traceb
+00044610: 6163 6b2c 2066 726f 6d20 676c 6f62 616c  ack, from global
+00044620: 2060 696d 706f 7274 2074 7261 6365 6261   `import traceba
+00044630: 636b 602e 0a0a 2020 2020 7665 7262 6f73  ck`...    verbos
+00044640: 6520 3a20 626f 6f6c 0a20 2020 2020 2020  e : bool.       
+00044650: 2050 7269 6e74 2065 7863 6570 7469 6f6e   Print exception
+00044660: 2074 6f20 7374 646f 7574 2e0a 0a20 2020   to stdout...   
+00044670: 206d 6f64 6520 3a20 2761 272c 2027 7727   mode : 'a', 'w'
+00044680: 0a20 2020 2020 2020 2046 696c 6520 6d6f  .        File mo
+00044690: 6465 206f 6e20 606f 7065 6e28 4c4f 4746  de on `open(LOGF
+000446a0: 494c 452c 206d 6f64 6529 602c 2069 2e65  ILE, mode)`, i.e
+000446b0: 2e2c 2061 7070 656e 6420 6f72 2077 7269  ., append or wri
+000446c0: 7465 2e0a 0a20 2020 2022 2222 0a20 2020  te...    """.   
+000446d0: 2069 6d70 6f72 7420 7469 6d65 0a0a 2020   import time..  
+000446e0: 2020 7472 6163 6520 3d20 7472 6163 6562    trace = traceb
+000446f0: 6163 6b2e 666f 726d 6174 5f65 7863 286c  ack.format_exc(l
+00044700: 696d 6974 3d32 290a 2020 2020 6c6f 6720  imit=2).    log 
+00044710: 3d20 275c 6e23 2323 2323 2323 2323 2323  = '\n###########
+00044720: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00044730: 2323 2323 2323 2323 2323 2323 2323 2320  ############### 
+00044740: 5c6e 270a 2020 2020 6c6f 6720 2b3d 2027  \n'.    log += '
+00044750: 2320 2120 4578 6365 7074 696f 6e20 287b  # ! Exception ({
+00044760: 307d 295c 6e27 2e66 6f72 6d61 7428 6e6f  0})\n'.format(no
+00044770: 7774 696d 6528 2929 0a20 2020 206c 6f67  wtime()).    log
+00044780: 202b 3d20 2723 5c6e 2320 2127 2b27 5c6e   += '#\n# !'+'\n
+00044790: 2320 2127 2e6a 6f69 6e28 7472 6163 652e  # !'.join(trace.
+000447a0: 7370 6c69 7428 275c 6e27 2929 0a20 2020  split('\n')).   
+000447b0: 206c 6f67 202b 3d20 275c 6e23 2323 2323   log += '\n#####
+000447c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000447d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000447e0: 2323 2323 205c 6e5c 6e27 0a20 2020 2069  #### \n\n'.    i
+000447f0: 6620 7665 7262 6f73 6520 7c20 284c 4f47  f verbose | (LOG
+00044800: 4649 4c45 2069 7320 4e6f 6e65 293a 0a20  FILE is None):. 
+00044810: 2020 2020 2020 2070 7269 6e74 286c 6f67         print(log
+00044820: 290a 0a20 2020 2069 6620 4c4f 4746 494c  )..    if LOGFIL
+00044830: 4520 6973 206e 6f74 204e 6f6e 653a 0a20  E is not None:. 
+00044840: 2020 2020 2020 2066 7020 3d20 6f70 656e         fp = open
+00044850: 284c 4f47 4649 4c45 2c20 6d6f 6465 290a  (LOGFILE, mode).
+00044860: 2020 2020 2020 2020 6670 2e77 7269 7465          fp.write
+00044870: 286c 6f67 290a 2020 2020 2020 2020 6670  (log).        fp
+00044880: 2e63 6c6f 7365 2829 0a0a 6465 6620 7369  .close()..def si
+00044890: 6d70 6c65 5f4c 4344 4d28 4f6d 303d 302e  mple_LCDM(Om0=0.
+000448a0: 332c 204f 6465 303d 302e 372c 2048 303d  3, Ode0=0.7, H0=
+000448b0: 3730 2c20 4f62 303d 302e 3034 3633 2c20  70, Ob0=0.0463, 
+000448c0: 5463 6d62 303d 322e 3732 352c 206e 616d  Tcmb0=2.725, nam
+000448d0: 653d 4e6f 6e65 293a 0a20 2020 2022 2222  e=None):.    """
+000448e0: 0a20 2020 2053 696d 706c 6520 4c61 6d62  .    Simple Lamb
+000448f0: 6461 4344 4d20 636f 736d 6f6c 6f67 790a  daCDM cosmology.
+00044900: 2020 2020 0a20 2020 2050 6172 616d 6574      .    Paramet
+00044910: 6572 7320 6172 6520 6465 6669 6e65 6420  ers are defined 
+00044920: 6173 2069 6e20 607e 6173 7472 6f70 792e  as in `~astropy.
+00044930: 636f 736d 6f6c 6f67 792e 4c61 6d62 6461  cosmology.Lambda
+00044940: 4344 4d60 2e0a 2020 2020 0a20 2020 2022  CDM`..    .    "
+00044950: 2222 0a20 2020 2066 726f 6d20 6173 7472  "".    from astr
+00044960: 6f70 792e 636f 736d 6f6c 6f67 7920 696d  opy.cosmology im
+00044970: 706f 7274 204c 616d 6264 6143 444d 0a20  port LambdaCDM. 
+00044980: 2020 2063 6f73 6d6f 6c6f 6779 203d 204c     cosmology = L
+00044990: 616d 6264 6143 444d 2848 302c 204f 6d30  ambdaCDM(H0, Om0
+000449a0: 2c20 4f64 6530 2c20 5463 6d62 303d 5463  , Ode0, Tcmb0=Tc
+000449b0: 6d62 302c 206e 616d 653d 6e61 6d65 290a  mb0, name=name).
+000449c0: 2020 2020 7265 7475 726e 2063 6f73 6d6f      return cosmo
+000449d0: 6c6f 6779 0a0a 0a64 6566 2070 6978 656c  logy...def pixel
+000449e0: 5f70 6f6c 7967 6f6e 5f6d 6173 6b28 706f  _polygon_mask(po
+000449f0: 6c79 676f 6e2c 2073 6861 7065 2c20 7763  lygon, shape, wc
+00044a00: 733d 4e6f 6e65 293a 0a20 2020 2022 2222  s=None):.    """
+00044a10: 0a20 2020 204d 616b 6520 6120 6d61 736b  .    Make a mask
+00044a20: 2070 6f69 6e74 7320 696e 2061 2032 4420   points in a 2D 
+00044a30: 6172 7261 7920 696e 7369 6465 2061 2070  array inside a p
+00044a40: 6f6c 7967 6f6e 0a20 2020 200a 2020 2020  olygon.    .    
+00044a50: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00044a60: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 706f  ---------.    po
+00044a70: 6c79 676f 6e20 3a20 7374 722c 2028 322c  lygon : str, (2,
+00044a80: 4d29 2061 7272 6179 0a20 2020 2020 2020  M) array.       
+00044a90: 2053 6f6d 6574 6869 6e67 2074 6861 7420   Something that 
+00044aa0: 6067 7269 7a6c 692e 7574 696c 732e 5352  `grizli.utils.SR
+00044ab0: 6567 696f 6e60 2063 616e 2070 6172 7365  egion` can parse
+00044ac0: 2061 7320 6120 706f 6c79 676f 6e0a 2020   as a polygon.  
+00044ad0: 2020 0a20 2020 2073 6861 7065 203a 2074    .    shape : t
+00044ae0: 7570 6c65 0a20 2020 2020 2020 2032 2d74  uple.        2-t
+00044af0: 7570 6c65 206f 6620 696d 6167 6520 6469  uple of image di
+00044b00: 6d65 6e73 696f 6e73 0a20 2020 200a 2020  mensions.    .  
+00044b10: 2020 7763 7320 3a20 6061 7374 726f 7079    wcs : `astropy
+00044b20: 2e77 6373 2e57 4353 600a 2020 2020 2020  .wcs.WCS`.      
+00044b30: 2020 4966 2073 7065 6369 6669 6564 2c20    If specified, 
+00044b40: 6173 7375 6d65 2060 6070 6f6c 7967 6f6e  assume ``polygon
+00044b50: 6060 2069 7320 736b 7920 636f 6f72 6469  `` is sky coordi
+00044b60: 6e61 7465 7320 616e 6420 7472 616e 7366  nates and transf
+00044b70: 6f72 6d20 746f 0a20 2020 2020 2020 2069  orm to.        i
+00044b80: 6d61 6765 2e0a 2020 2020 0a20 2020 2052  mage..    .    R
+00044b90: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+00044ba0: 2d2d 0a20 2020 206d 6173 6b20 3a20 6172  --.    mask : ar
+00044bb0: 7261 790a 2020 2020 2020 2020 6060 626f  ray.        ``bo
+00044bc0: 6f6c 6060 2061 7272 6179 2077 6974 6820  ol`` array with 
+00044bd0: 6060 7368 6170 6560 6020 7468 6174 2069  ``shape`` that i
+00044be0: 7320 6054 7275 6560 2069 6e73 6964 6520  s `True` inside 
+00044bf0: 6070 6f6c 7967 6f6e 600a 2020 2020 2222  `polygon`.    ""
+00044c00: 220a 2020 2020 7372 203d 2053 5265 6769  ".    sr = SRegi
+00044c10: 6f6e 2870 6f6c 7967 6f6e 2c20 7772 6170  on(polygon, wrap
+00044c20: 3d46 616c 7365 290a 2020 2020 0a20 2020  =False).    .   
+00044c30: 2079 702c 2078 7020 3d20 6e70 2e69 6e64   yp, xp = np.ind
+00044c40: 6963 6573 2873 6861 7065 290a 2020 2020  ices(shape).    
+00044c50: 7074 7320 3d20 6e70 2e61 7272 6179 285b  pts = np.array([
+00044c60: 7870 2e66 6c61 7474 656e 2829 2c20 7970  xp.flatten(), yp
+00044c70: 2e66 6c61 7474 656e 2829 5d29 2e54 0a20  .flatten()]).T. 
+00044c80: 2020 200a 2020 2020 6966 2077 6373 2069     .    if wcs i
+00044c90: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00044ca0: 2020 2020 7074 7320 3d20 7763 732e 616c      pts = wcs.al
+00044cb0: 6c5f 7069 7832 776f 726c 6428 7074 732c  l_pix2world(pts,
+00044cc0: 2030 290a 2020 2020 2020 2020 0a20 2020   0).        .   
+00044cd0: 206d 6173 6b20 3d20 6e70 2e7a 6572 6f73   mask = np.zeros
+00044ce0: 2873 6861 7065 2c20 6474 7970 653d 626f  (shape, dtype=bo
+00044cf0: 6f6c 292e 666c 6174 7465 6e28 290a 2020  ol).flatten().  
+00044d00: 2020 666f 7220 7020 696e 2073 722e 7061    for p in sr.pa
+00044d10: 7468 3a0a 2020 2020 2020 2020 6d61 736b  th:.        mask
+00044d20: 207c 3d20 702e 636f 6e74 6169 6e73 5f70   |= p.contains_p
+00044d30: 6f69 6e74 7328 7074 7329 0a20 2020 200a  oints(pts).    .
+00044d40: 2020 2020 7265 7475 726e 206d 6173 6b2e      return mask.
+00044d50: 7265 7368 6170 6528 7368 6170 6529 0a0a  reshape(shape)..
+00044d60: 0a64 6566 206d 616b 655f 6669 6c74 6572  .def make_filter
+00044d70: 5f66 6f6f 7470 7269 6e74 2866 696c 7465  _footprint(filte
+00044d80: 725f 7369 7a65 3d37 312c 2066 696c 7465  r_size=71, filte
+00044d90: 725f 6365 6e74 7261 6c3d 302c 202a 2a6b  r_central=0, **k
+00044da0: 7761 7267 7329 3a0a 2020 2020 2222 220a  wargs):.    """.
+00044db0: 2020 2020 4d61 6b65 2061 2066 6f6f 7470      Make a footp
+00044dc0: 7269 6e74 2066 6f72 2069 6d61 6765 2066  rint for image f
+00044dd0: 696c 7465 7269 6e67 0a20 2020 2022 2222  iltering.    """
+00044de0: 0a20 2020 2066 696c 7465 725f 666f 6f74  .    filter_foot
+00044df0: 7072 696e 7420 3d20 6e70 2e6f 6e65 7328  print = np.ones(
+00044e00: 6669 6c74 6572 5f73 697a 652c 2064 7479  filter_size, dty
+00044e10: 7065 3d69 6e74 290a 2020 2020 0a20 2020  pe=int).    .   
+00044e20: 2069 6620 6669 6c74 6572 5f63 656e 7472   if filter_centr
+00044e30: 616c 203e 2030 3a0a 2020 2020 2020 2020  al > 0:.        
+00044e40: 6630 203d 2028 6669 6c74 6572 5f73 697a  f0 = (filter_siz
+00044e50: 652d 3129 2f2f 320a 2020 2020 2020 2020  e-1)//2.        
+00044e60: 6669 6c74 6572 5f66 6f6f 7470 7269 6e74  filter_footprint
+00044e70: 5b66 302d 6669 6c74 6572 5f63 656e 7472  [f0-filter_centr
+00044e80: 616c 3a66 302b 6669 6c74 6572 5f63 656e  al:f0+filter_cen
+00044e90: 7472 616c 5d20 3d20 300a 2020 2020 0a20  tral] = 0.    . 
+00044ea0: 2020 2072 6574 7572 6e20 6669 6c74 6572     return filter
+00044eb0: 5f66 6f6f 7470 7269 6e74 0a0a 0a64 6566  _footprint...def
+00044ec0: 2073 6166 655f 6e61 6e6d 6564 6961 6e5f   safe_nanmedian_
+00044ed0: 6669 6c74 6572 2864 6174 612c 2066 696c  filter(data, fil
+00044ee0: 7465 725f 6b77 6172 6773 3d7b 7d2c 2066  ter_kwargs={}, f
+00044ef0: 696c 7465 725f 666f 6f74 7072 696e 743d  ilter_footprint=
+00044f00: 4e6f 6e65 2c20 6178 6973 3d31 2c20 636c  None, axis=1, cl
+00044f10: 6561 6e3d 5472 7565 2c20 6376 616c 3d30  ean=True, cval=0
+00044f20: 2e30 293a 0a20 2020 2022 2222 0a20 2020  .0):.    """.   
+00044f30: 2052 756e 206e 616e 6d65 6469 616e 2066   Run nanmedian f
+00044f40: 696c 7465 7220 6f6e 2060 6461 7461 600a  ilter on `data`.
+00044f50: 2020 2020 0a20 2020 2050 6172 616d 6574      .    Paramet
+00044f60: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
+00044f70: 2d2d 0a20 2020 2064 6174 6120 3a20 6172  --.    data : ar
+00044f80: 7261 792d 6c69 6b65 0a20 2020 2020 2020  ray-like.       
+00044f90: 2054 6865 2032 4420 6461 7461 2074 6f20   The 2D data to 
+00044fa0: 6669 6c74 6572 0a20 2020 200a 2020 2020  filter.    .    
+00044fb0: 6669 6c74 6572 5f6b 7761 7267 7320 3a20  filter_kwargs : 
+00044fc0: 6469 6374 0a20 2020 2020 2020 2041 7267  dict.        Arg
+00044fd0: 756d 656e 7473 2074 6f20 607e 6772 697a  uments to `~griz
+00044fe0: 6c69 2e75 7469 6c73 2e6d 616b 655f 6669  li.utils.make_fi
+00044ff0: 6c74 6572 5f66 6f6f 7470 7269 6e74 6020  lter_footprint` 
+00045000: 746f 206d 616b 6520 6120 3144 2066 696c  to make a 1D fil
+00045010: 7465 720a 2020 2020 0a20 2020 2066 696c  ter.    .    fil
+00045020: 7465 725f 666f 6f74 7072 696e 7420 3a20  ter_footprint : 
+00045030: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
+00045040: 2020 2053 7065 6369 6679 2074 6865 2066     Specify the f
+00045050: 696c 7465 7220 6578 706c 6963 6974 6c79  ilter explicitly
+00045060: 2e20 2049 6620 3144 2c20 7468 656e 2077  .  If 1D, then w
+00045070: 696c 6c20 6170 706c 7920 7468 6520 6669  ill apply the fi
+00045080: 6c74 6572 206f 7665 720a 2020 2020 2020  lter over.      
+00045090: 2020 6061 7869 733d 3160 2028 692e 652e    `axis=1` (i.e.
+000450a0: 2c20 6078 6029 206f 6620 6060 6461 7461  , `x`) of ``data
+000450b0: 6060 0a20 2020 200a 2020 2020 6178 6973  ``.    .    axis
+000450c0: 203a 2030 206f 7220 310a 2020 2020 2020   : 0 or 1.      
+000450d0: 2020 2041 7869 7320 6f76 6572 2077 6869     Axis over whi
+000450e0: 6368 2074 6f20 6170 706c 7920 7468 6520  ch to apply the 
+000450f0: 6669 6c74 6572 2028 6060 6178 6973 3d31  filter (``axis=1
+00045100: 6060 2066 696c 7465 7273 206f 6e20 726f  `` filters on ro
+00045110: 7773 290a 2020 2020 0a20 2020 2063 6c65  ws).    .    cle
+00045120: 616e 2c20 6376 616c 203a 2062 6f6f 6c2c  an, cval : bool,
+00045130: 2073 6361 6c61 720a 2020 2020 2020 2020   scalar.        
+00045140: 5265 706c 6163 6520 607e 6e75 6d70 792e  Replace `~numpy.
+00045150: 6e61 6e60 2069 6e20 7468 6520 6f75 7470  nan` in the outp
+00045160: 7574 2077 6974 6820 6060 6376 616c 6060  ut with ``cval``
+00045170: 0a20 2020 200a 2020 2020 5265 7475 726e  .    .    Return
+00045180: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+00045190: 2020 6669 6c74 6572 5f64 6174 6120 3a20    filter_data : 
+000451a0: 6172 7261 792d 6c69 6b65 0a20 2020 2020  array-like.     
+000451b0: 2020 2046 696c 7465 7265 6420 6461 7461     Filtered data
+000451c0: 0a20 2020 200a 2020 2020 6669 6c74 6572  .    .    filter
+000451d0: 5f6e 616d 6520 3a20 7374 720a 2020 2020  _name : str.    
+000451e0: 2020 2020 5468 6520 7479 7065 206f 6620      The type of 
+000451f0: 6669 6c74 6572 2074 6861 7420 7761 7320  filter that was 
+00045200: 6170 706c 6965 643a 2060 6e62 7574 696c  applied: `nbutil
+00045210: 732e 6e61 6e6d 6564 6961 6e60 2069 6620  s.nanmedian` if 
+00045220: 0a20 2020 2020 2020 2060 7e67 7269 7a6c  .        `~grizl
+00045230: 692e 6e62 7574 696c 732e 6e61 6e6d 6564  i.nbutils.nanmed
+00045240: 6961 6e60 2077 6173 2069 6d70 6f72 7465  ian` was importe
+00045250: 6420 7375 6363 6573 7366 756c 6c79 2061  d successfully a
+00045260: 6e64 200a 2020 2020 2020 2020 606d 6564  nd .        `med
+00045270: 6961 6e5f 6669 6c74 6572 6020 666f 7220  ian_filter` for 
+00045280: 7468 6520 6661 6c6c 6261 636b 2074 6f20  the fallback to 
+00045290: 6073 6369 702e 6e64 696d 6167 652e 6d65  `scip.ndimage.me
+000452a0: 6469 616e 5f66 696c 7465 7260 200a 2020  dian_filter` .  
+000452b0: 2020 2020 2020 6f74 6865 7277 6973 652e        otherwise.
+000452c0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+000452d0: 6f72 7420 7363 6970 792e 6e64 696d 6167  ort scipy.ndimag
+000452e0: 6520 6173 206e 640a 2020 2020 0a20 2020  e as nd.    .   
+000452f0: 2074 7279 3a0a 2020 2020 2020 2020 6672   try:.        fr
+00045300: 6f6d 202e 2069 6d70 6f72 7420 6e62 7574  om . import nbut
+00045310: 696c 730a 2020 2020 2020 2020 5f66 696c  ils.        _fil
+00045320: 7465 725f 6e61 6d65 203d 2027 6e62 7574  ter_name = 'nbut
+00045330: 696c 732e 6e61 6e6d 6564 6961 6e27 0a20  ils.nanmedian'. 
+00045340: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+00045350: 2020 206e 6275 7469 6c73 203d 204e 6f6e     nbutils = Non
+00045360: 650a 2020 2020 2020 2020 5f66 696c 7465  e.        _filte
+00045370: 725f 6e61 6d65 203d 2027 6d65 6469 616e  r_name = 'median
+00045380: 5f66 696c 7465 7227 0a20 2020 200a 2020  _filter'.    .  
+00045390: 2020 6966 2066 696c 7465 725f 666f 6f74    if filter_foot
+000453a0: 7072 696e 7420 6973 204e 6f6e 653a 0a20  print is None:. 
+000453b0: 2020 2020 2020 205f 6669 6c74 6572 5f66         _filter_f
+000453c0: 6f6f 7470 7269 6e74 203d 206d 616b 655f  ootprint = make_
+000453d0: 6669 6c74 6572 5f66 6f6f 7470 7269 6e74  filter_footprint
+000453e0: 282a 2a66 696c 7465 725f 6b77 6172 6773  (**filter_kwargs
+000453f0: 290a 2020 2020 2020 2020 6966 2061 7869  ).        if axi
+00045400: 7320 3d3d 2031 3a0a 2020 2020 2020 2020  s == 1:.        
+00045410: 2020 2020 5f66 696c 7465 725f 666f 6f74      _filter_foot
+00045420: 7072 696e 7420 3d20 5f66 696c 7465 725f  print = _filter_
+00045430: 666f 6f74 7072 696e 745b 4e6f 6e65 2c3a  footprint[None,:
+00045440: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+00045450: 2020 2020 2020 2020 2020 2020 5f66 696c              _fil
+00045460: 7465 725f 666f 6f74 7072 696e 7420 3d20  ter_footprint = 
+00045470: 5f66 696c 7465 725f 666f 6f74 7072 696e  _filter_footprin
+00045480: 745b 3a2c 4e6f 6e65 5d0a 2020 2020 656c  t[:,None].    el
+00045490: 7365 3a0a 2020 2020 2020 2020 6966 2066  se:.        if f
+000454a0: 696c 7465 725f 666f 6f74 7072 696e 742e  ilter_footprint.
+000454b0: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+000454c0: 2020 2020 2020 2069 6620 6178 6973 203d         if axis =
+000454d0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+000454e0: 2020 2020 205f 6669 6c74 6572 5f66 6f6f       _filter_foo
+000454f0: 7470 7269 6e74 203d 2066 696c 7465 725f  tprint = filter_
+00045500: 666f 6f74 7072 696e 745b 4e6f 6e65 2c3a  footprint[None,:
+00045510: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+00045520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00045530: 2020 2020 5f66 696c 7465 725f 666f 6f74      _filter_foot
+00045540: 7072 696e 7420 3d20 6669 6c74 6572 5f66  print = filter_f
+00045550: 6f6f 7470 7269 6e74 5b3a 2c4e 6f6e 655d  ootprint[:,None]
+00045560: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00045570: 2020 2020 2020 2020 2020 205f 6669 6c74             _filt
+00045580: 6572 5f66 6f6f 7470 7269 6e74 203d 2066  er_footprint = f
+00045590: 696c 7465 725f 666f 6f74 7072 696e 740a  ilter_footprint.
+000455a0: 2020 2020 0a20 2020 2069 6620 6e62 7574      .    if nbut
+000455b0: 696c 7320 6973 204e 6f6e 653a 0a20 2020  ils is None:.   
+000455c0: 2020 2020 2066 696c 7465 725f 6461 7461       filter_data
+000455d0: 203d 206e 642e 6d65 6469 616e 5f66 696c   = nd.median_fil
+000455e0: 7465 7228 6461 7461 2c20 666f 6f74 7072  ter(data, footpr
+000455f0: 696e 743d 5f66 696c 7465 725f 666f 6f74  int=_filter_foot
+00045600: 7072 696e 7429 0a20 2020 2065 6c73 653a  print).    else:
+00045610: 0a20 2020 2020 2020 2066 696c 7465 725f  .        filter_
+00045620: 6461 7461 203d 206e 642e 6765 6e65 7269  data = nd.generi
+00045630: 635f 6669 6c74 6572 2864 6174 612c 206e  c_filter(data, n
+00045640: 6275 7469 6c73 2e6e 616e 6d65 6469 616e  butils.nanmedian
+00045650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00045660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045670: 2020 2020 2020 2020 2020 666f 6f74 7072            footpr
+00045680: 696e 743d 5f66 696c 7465 725f 666f 6f74  int=_filter_foot
+00045690: 7072 696e 7429 0a20 2020 2020 2020 2069  print).        i
+000456a0: 6620 636c 6561 6e3a 0a20 2020 2020 2020  f clean:.       
+000456b0: 2020 2020 2066 696c 7465 725f 6461 7461       filter_data
+000456c0: 5b7e 6e70 2e69 7366 696e 6974 6528 6669  [~np.isfinite(fi
+000456d0: 6c74 6572 5f64 6174 6129 5d20 3d20 6376  lter_data)] = cv
+000456e0: 616c 0a20 2020 2020 2020 2020 2020 200a  al.            .
+000456f0: 2020 2020 7265 7475 726e 2066 696c 7465      return filte
+00045700: 725f 6461 7461 2c20 5f66 696c 7465 725f  r_data, _filter_
+00045710: 6e61 6d65 0a0a 0a64 6566 2061 7267 765f  name...def argv_
+00045720: 746f 5f64 6963 7428 6172 6776 2c20 6465  to_dict(argv, de
+00045730: 6661 756c 7473 3d7b 7d2c 2064 6f74 5f64  faults={}, dot_d
+00045740: 6963 743d 5472 7565 293a 0a20 2020 2022  ict=True):.    "
+00045750: 2222 0a20 2020 2043 6f6e 7665 7274 2061  "".    Convert a
+00045760: 206c 6973 7420 6f66 2028 7369 6d70 6c65   list of (simple
+00045770: 2920 636f 6d6d 616e 642d 6c69 6e65 2061  ) command-line a
+00045780: 7267 756d 656e 7473 2074 6f20 6120 6469  rguments to a di
+00045790: 6374 696f 6e61 7279 2e0a 2020 2020 0a20  ctionary..    . 
+000457a0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+000457b0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+000457c0: 2061 7267 7620 3a20 6c69 7374 206f 6620   argv : list of 
+000457d0: 7374 7269 6e67 730a 2020 2020 2020 2020  strings.        
+000457e0: 452e 672e 2c20 6060 7379 732e 6172 6776  E.g., ``sys.argv
+000457f0: 5b31 3a5d 6060 2e0a 2020 2020 0a20 2020  [1:]``..    .   
+00045800: 2064 6566 6175 6c74 7320 3a20 6469 6374   defaults : dict
+00045810: 0a20 2020 2020 2020 2044 6566 6175 6c74  .        Default
+00045820: 2064 6963 7469 6f6e 6172 790a 2020 2020   dictionary.    
+00045830: 0a20 2020 2064 6f74 5f64 6963 7420 3a20  .    dot_dict : 
+00045840: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
+00045850: 7472 7565 2c20 7468 656e 2069 6e74 6570  true, then intep
+00045860: 7265 7420 6b65 7977 6f72 6473 2077 6974  ret keywords wit
+00045870: 6820 272e 2720 6173 206e 6573 7465 6420  h '.' as nested 
+00045880: 6469 6374 696f 6e61 7279 206b 6579 732c  dictionary keys,
+00045890: 200a 2020 2020 2020 2020 652e 672e 2c20   .        e.g., 
+000458a0: 6060 2d2d 642e 6b65 793d 7661 6c60 6020  ``--d.key=val`` 
+000458b0: 3e3e 207b 2764 273a 207b 276b 6579 273a  >> {'d': {'key':
+000458c0: 2027 7661 6c27 7d7d 0a20 2020 2020 2020   'val'}}.       
+000458d0: 200a 2020 2020 4578 616d 706c 6573 0a20   .    Examples. 
+000458e0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+000458f0: 0a20 2020 2020 2020 2023 2024 206d 7966  .        # $ myf
+00045900: 756e 6320 6172 6731 202d 2d70 313d 3120  unc arg1 --p1=1 
+00045910: 2d2d 6c31 3d31 2c32 2c33 202d 2d70 6469  --l1=1,2,3 --pdi
+00045920: 6374 2e6b 313d 3120 2d66 6c61 670a 2020  ct.k1=1 -flag.  
+00045930: 2020 2020 2020 3e3e 3e20 6172 6776 203d        >>> argv =
+00045940: 2027 6172 6731 202d 2d70 313d 3120 2d2d   'arg1 --p1=1 --
+00045950: 6c31 3d31 2c32 2c33 202d 2d70 6469 6374  l1=1,2,3 --pdict
+00045960: 2e6b 313d 3120 2d66 6c61 6727 2e73 706c  .k1=1 -flag'.spl
+00045970: 6974 2829 0a20 2020 2020 2020 203e 3e3e  it().        >>>
+00045980: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
+00045990: 6172 6776 5f74 6f5f 6469 6374 2861 7267  argv_to_dict(arg
+000459a0: 7629 0a20 2020 2020 2020 203e 3e3e 2070  v).        >>> p
+000459b0: 7269 6e74 2861 7267 7329 0a20 2020 2020  rint(args).     
+000459c0: 2020 205b 2761 7267 3127 5d0a 2020 2020     ['arg1'].    
+000459d0: 2020 2020 3e3e 3e20 7072 696e 7428 6b77      >>> print(kw
+000459e0: 6172 6773 290a 2020 2020 2020 2020 7b27  args).        {'
+000459f0: 7031 273a 2031 2c20 276c 3127 3a20 5b31  p1': 1, 'l1': [1
+00045a00: 2c20 322c 2033 5d2c 2027 7064 6963 7427  , 2, 3], 'pdict'
+00045a10: 3a20 7b27 6b31 273a 2031 7d2c 2027 666c  : {'k1': 1}, 'fl
+00045a20: 6167 273a 2054 7275 657d 0a20 2020 2020  ag': True}.     
+00045a30: 2020 200a 2020 2020 2020 2020 2320 5769     .        # Wi
+00045a40: 7468 2064 6566 6175 6c74 730a 2020 2020  th defaults.    
+00045a50: 2020 2020 6465 6661 756c 7473 203d 207b      defaults = {
+00045a60: 2770 6469 6374 273a 7b27 6b32 273a 322e  'pdict':{'k2':2.
+00045a70: 307d 2c20 2770 3227 3a32 2e30 7d0a 2020  0}, 'p2':2.0}.  
+00045a80: 2020 2020 2020 3e3e 3e20 6172 6773 2c20        >>> args, 
+00045a90: 6b77 6172 6773 203d 2061 7267 765f 746f  kwargs = argv_to
+00045aa0: 5f64 6963 7428 6172 6776 2c20 6465 6661  _dict(argv, defa
+00045ab0: 756c 7473 3d64 6566 6175 6c74 7329 0a20  ults=defaults). 
+00045ac0: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+00045ad0: 286b 7761 7267 7329 0a20 2020 2020 2020  (kwargs).       
+00045ae0: 207b 2770 6469 6374 273a 207b 276b 3227   {'pdict': {'k2'
+00045af0: 3a20 322e 302c 2027 6b31 273a 2031 7d2c  : 2.0, 'k1': 1},
+00045b00: 2027 7032 273a 2032 2e30 2c20 2770 3127   'p2': 2.0, 'p1'
+00045b10: 3a20 312c 2027 6c31 273a 205b 312c 2032  : 1, 'l1': [1, 2
+00045b20: 2c20 335d 2c20 2766 6c61 6727 3a20 5472  , 3], 'flag': Tr
+00045b30: 7565 7d0a 2020 2020 2020 2020 0a20 2020  ue}.        .   
+00045b40: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
+00045b50: 636f 7079 0a20 2020 2069 6d70 6f72 7420  copy.    import 
+00045b60: 6a73 6f6e 0a20 2020 200a 2020 2020 6b77  json.    .    kw
+00045b70: 6172 6773 203d 2063 6f70 792e 6465 6570  args = copy.deep
+00045b80: 636f 7079 2864 6566 6175 6c74 7329 0a20  copy(defaults). 
+00045b90: 2020 2061 7267 7320 3d20 5b5d 0a20 2020     args = [].   
+00045ba0: 200a 2020 2020 666f 7220 692c 2061 7267   .    for i, arg
+00045bb0: 2069 6e20 656e 756d 6572 6174 6528 6172   in enumerate(ar
+00045bc0: 6776 293a 2020 2020 2020 2020 0a20 2020  gv):        .   
+00045bd0: 2020 2020 2069 6620 6e6f 7420 6172 672e       if not arg.
+00045be0: 7374 6172 7473 7769 7468 2827 2d27 293a  startswith('-'):
+00045bf0: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
+00045c00: 7267 756d 656e 7473 0a20 2020 2020 2020  rguments.       
+00045c10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00045c20: 2020 2020 2020 2020 2020 6172 6773 2e61            args.a
+00045c30: 7070 656e 6428 6a73 6f6e 2e6c 6f61 6473  ppend(json.loads
+00045c40: 2861 7267 2929 0a20 2020 2020 2020 2020  (arg)).         
+00045c50: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+00045c60: 2020 2020 2020 2020 2020 2061 7267 732e             args.
+00045c70: 6170 7065 6e64 286a 736f 6e2e 6c6f 6164  append(json.load
+00045c80: 7328 6627 227b 6172 677d 2227 2929 0a20  s(f'"{arg}"')). 
+00045c90: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+00045ca0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00045cb0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00045cc0: 200a 2020 2020 2020 2020 7370 6c20 3d20   .        spl = 
+00045cd0: 6172 672e 7374 7269 7028 272d 2d27 292e  arg.strip('--').
+00045ce0: 7370 6c69 7428 273d 2729 0a20 2020 2020  split('=').     
+00045cf0: 2020 2069 6620 6c65 6e28 7370 6c29 203e     if len(spl) >
+00045d00: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00045d10: 2320 5061 7261 6d65 7465 7220 7661 6c75  # Parameter valu
+00045d20: 6573 0a20 2020 2020 2020 2020 2020 206b  es.            k
+00045d30: 6579 2c20 7661 6c20 3d20 7370 6c0a 2020  ey, val = spl.  
+00045d40: 2020 2020 2020 2020 2020 7661 6c20 3d20            val = 
+00045d50: 7661 6c2e 7265 706c 6163 6528 2754 7275  val.replace('Tru
+00045d60: 6527 2c27 7472 7565 2729 2e72 6570 6c61  e','true').repla
+00045d70: 6365 2827 4661 6c73 6527 2c27 6661 6c73  ce('False','fals
+00045d80: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
+00045d90: 7661 6c20 3d20 7661 6c2e 7265 706c 6163  val = val.replac
+00045da0: 6528 274e 6f6e 6527 2c27 6e75 6c6c 2729  e('None','null')
+00045db0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00045dc0: 2020 2020 2020 2020 2020 2023 2050 6172             # Par
+00045dd0: 616d 6574 6572 732c 2073 6574 2074 6f20  ameters, set to 
+00045de0: 7472 7565 2c20 652e 672e 2c20 2d73 6574  true, e.g., -set
+00045df0: 5f66 6c61 670a 2020 2020 2020 2020 2020  _flag.          
+00045e00: 2020 6b65 792c 2076 616c 203d 2073 706c    key, val = spl
+00045e10: 5b30 5d2c 2027 7472 7565 270a 2020 2020  [0], 'true'.    
+00045e20: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00045e30: 2020 2020 2023 2073 696e 676c 6520 2d0a       # single -.
+00045e40: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00045e50: 6579 2e73 7461 7274 7377 6974 6828 272d  ey.startswith('-
+00045e60: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00045e70: 2020 2020 6b65 7920 3d20 6b65 795b 313a      key = key[1:
+00045e80: 5d0a 2020 2020 2020 2020 0a20 2020 2020  ].        .     
+00045e90: 2020 2023 204c 6973 7420 7661 6c75 6573     # List values
+00045ea0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00045eb0: 2069 6620 272c 2720 696e 2076 616c 3a0a   if ',' in val:.
+00045ec0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00045ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045ee0: 2023 2054 7279 2070 6172 7369 6e67 2077   # Try parsing w
+00045ef0: 6974 6820 4a53 4f4e 0a20 2020 2020 2020  ith JSON.       
+00045f00: 2020 2020 2020 2020 206a 7661 6c20 3d20           jval = 
+00045f10: 6a73 6f6e 2e6c 6f61 6473 2866 275b 7b76  json.loads(f'[{v
+00045f20: 616c 7d5d 2729 0a20 2020 2020 2020 2020  al}]').         
+00045f30: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+00045f40: 2020 2020 2020 2020 2020 2023 2041 7373             # Ass
+00045f50: 756d 6520 7374 7269 6e67 730a 2020 2020  ume strings.    
+00045f60: 2020 2020 2020 2020 2020 2020 7374 725f              str_
+00045f70: 7661 6c20 3d20 272c 272e 6a6f 696e 285b  val = ','.join([
+00045f80: 6627 227b 767d 2227 2066 6f72 2076 2069  f'"{v}"' for v i
+00045f90: 6e20 7661 6c2e 7370 6c69 7428 272c 2729  n val.split(',')
+00045fa0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00045fb0: 2020 206a 7661 6c20 3d20 6a73 6f6e 2e6c     jval = json.l
+00045fc0: 6f61 6473 2866 275b 7b73 7472 5f76 616c  oads(f'[{str_val
+00045fd0: 7d5d 2729 0a20 2020 2020 2020 2065 6c73  }]').        els
+00045fe0: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+00045ff0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00046000: 2020 2020 6a76 616c 203d 206a 736f 6e2e      jval = json.
+00046010: 6c6f 6164 7328 7661 6c29 0a20 2020 2020  loads(val).     
+00046020: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+00046030: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00046040: 2053 7472 696e 670a 2020 2020 2020 2020   String.        
+00046050: 2020 2020 2020 2020 6a76 616c 203d 2076          jval = v
+00046060: 616c 0a20 2020 2020 2020 200a 2020 2020  al.        .    
+00046070: 2020 2020 2320 4469 6374 206b 6579 732c      # Dict keys,
+00046080: 2070 6f74 656e 7469 616c 6c79 206e 6573   potentially nes
+00046090: 7465 6420 2020 2020 2020 200a 2020 2020  ted        .    
+000460a0: 2020 2020 6966 2064 6f74 5f64 6963 7420      if dot_dict 
+000460b0: 2620 2827 2e27 2069 6e20 6b65 7929 3a0a  & ('.' in key):.
+000460c0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+000460d0: 203d 206b 6579 2e73 706c 6974 2827 2e27   = key.split('.'
+000460e0: 290a 2020 2020 2020 2020 2020 2020 6420  ).            d 
+000460f0: 3d20 6b77 6172 6773 0a20 2020 2020 2020  = kwargs.       
+00046100: 2020 2020 2066 6f72 206b 2069 6e20 6b65       for k in ke
+00046110: 7973 5b3a 2d31 5d3a 0a20 2020 2020 2020  ys[:-1]:.       
+00046120: 2020 2020 2020 2020 2069 6620 6b20 6e6f           if k no
+00046130: 7420 696e 2064 3a0a 2020 2020 2020 2020  t in d:.        
+00046140: 2020 2020 2020 2020 2020 2020 645b 6b5d              d[k]
+00046150: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+00046160: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00046170: 2020 2020 2020 2064 203d 2064 5b6b 5d0a         d = d[k].
+00046180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046190: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+000461a0: 2064 5b6b 6579 735b 2d31 5d5d 203d 206a   d[keys[-1]] = j
+000461b0: 7661 6c0a 2020 2020 2020 2020 656c 7365  val.        else
+000461c0: 3a20 2020 2020 2020 2020 2020 200a 2020  :            .  
+000461d0: 2020 2020 2020 2020 2020 6b77 6172 6773            kwargs
+000461e0: 5b6b 6579 5d20 3d20 6a76 616c 0a20 2020  [key] = jval.   
+000461f0: 2020 2020 2020 2020 200a 2020 2020 0a20           .    . 
+00046200: 2020 2072 6574 7572 6e20 6172 6773 2c20     return args, 
+00046210: 6b77 6172 6773 0a0a 0a63 6c61 7373 2055  kwargs...class U
+00046220: 6e69 7175 6528 6f62 6a65 6374 293a 0a20  nique(object):. 
+00046230: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00046240: 7365 6c66 2c20 6172 7261 792c 2076 6572  self, array, ver
+00046250: 626f 7365 3d54 7275 6529 3a0a 2020 2020  bose=True):.    
+00046260: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00046270: 4865 6c70 6572 2066 6f72 2075 6e69 7175  Helper for uniqu
+00046280: 6520 6974 656d 7320 696e 2061 6e20 6172  e items in an ar
+00046290: 7261 790a 2020 2020 2020 2020 0a20 2020  ray.        .   
+000462a0: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
+000462b0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+000462c0: 2d2d 0a20 2020 2020 2020 2061 7272 6179  --.        array
+000462d0: 203a 2061 7272 6179 2d6c 696b 650a 2020   : array-like.  
+000462e0: 2020 2020 2020 2020 2020 4461 7461 2074            Data t
+000462f0: 6f20 7061 7273 652c 2067 656e 6572 616c  o parse, general
+00046300: 6c79 2073 7472 696e 6773 2062 7574 2063  ly strings but c
+00046310: 616e 2062 6520 616e 7974 6869 6e67 2074  an be anything t
+00046320: 6861 7420 6361 6e20 0a20 2020 2020 2020  hat can .       
+00046330: 2020 2020 2062 6520 7061 7273 6564 2062       be parsed b
+00046340: 7920 606e 756d 7079 2e75 6e69 7175 6560  y `numpy.unique`
+00046350: 0a0a 0a20 2020 2020 2020 2041 7474 7269  ...        Attri
+00046360: 6275 7465 730a 2020 2020 2020 2020 2d2d  butes.        --
+00046370: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00046380: 2064 696d 203a 2069 6e74 0a20 2020 2020   dim : int.     
+00046390: 2020 2020 2020 2060 6073 697a 6560 6020         ``size`` 
+000463a0: 6f66 2069 6e70 7574 2060 6061 7272 6179  of input ``array
+000463b0: 6060 0a20 2020 2020 2020 200a 2020 2020  ``.        .    
+000463c0: 2020 2020 7661 6c75 6573 203a 206c 6973      values : lis
+000463d0: 740a 2020 2020 2020 2020 2020 2020 556e  t.            Un
+000463e0: 6971 7565 2065 6c65 6d65 6e74 7320 6f66  ique elements of
+000463f0: 2060 6061 7272 6179 6060 0a20 2020 2020   ``array``.     
+00046400: 2020 200a 2020 2020 2020 2020 696e 6469     .        indi
+00046410: 6365 7320 3a20 6c69 7374 0a20 2020 2020  ces : list.     
+00046420: 2020 2020 2020 2049 6e74 6567 6572 206c         Integer l
+00046430: 6973 7420 6c65 6e67 7468 206f 6620 6060  ist length of ``
+00046440: 6172 7261 7960 6020 7769 7468 2074 6865  array`` with the
+00046450: 2069 6e64 6963 6573 206f 6620 6060 7661   indices of ``va
+00046460: 6c75 6573 6060 0a20 2020 2020 2020 2020  lues``.         
+00046470: 2020 2066 6f72 2065 6163 6820 656c 656d     for each elem
+00046480: 656e 740a 2020 2020 2020 2020 0a20 2020  ent.        .   
+00046490: 2020 2020 2063 6f75 6e74 7320 3a20 6c69       counts : li
+000464a0: 7374 0a20 2020 2020 2020 2020 2020 2043  st.            C
+000464b0: 6f75 6e74 7320 6f66 2065 6163 6820 656c  ounts of each el
+000464c0: 656d 656e 7420 6f66 2060 6076 616c 7565  ement of ``value
+000464d0: 7360 600a 2020 2020 2020 2020 0a0a 2020  s``.        ..  
+000464e0: 2020 2020 2020 4d65 7468 6f64 730a 2020        Methods.  
+000464f0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
+00046500: 2020 2020 2020 5f5f 6765 745f 5f28 6b65        __get__(ke
+00046510: 7929 0a20 2020 2020 2020 2020 2020 2052  y).            R
+00046520: 6574 7572 6e20 6120 6062 6f6f 6c60 2061  eturn a `bool` a
+00046530: 7272 6179 2077 6865 7265 2065 6e74 7269  rray where entri
+00046540: 6573 206f 6620 6060 6172 7261 7960 6020  es of ``array`` 
+00046550: 6d61 7463 6820 7468 6520 0a20 2020 2020  match the .     
+00046560: 2020 2020 2020 2073 7065 6369 6669 6564         specified
+00046570: 2060 606b 6579 6060 0a20 2020 2020 2020   ``key``.       
+00046580: 200a 2020 2020 2020 2020 5f5f 6974 6572   .        __iter
+00046590: 5f5f 0a20 2020 2020 2020 2020 2020 2049  __.            I
+000465a0: 7465 7261 746f 7220 6f76 6572 2060 6076  terator over ``v
+000465b0: 616c 7565 7360 600a 2020 2020 2020 2020  alues``.        
+000465c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000465d0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+000465e0: 6365 2861 7272 6179 2c20 6c69 7374 293a  ce(array, list):
+000465f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00046600: 662e 6172 7261 7920 3d20 6e70 2e61 7272  f.array = np.arr
+00046610: 6179 2861 7272 6179 290a 2020 2020 2020  ay(array).      
+00046620: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00046630: 2020 2020 7365 6c66 2e61 7272 6179 203d      self.array =
+00046640: 2061 7272 6179 0a20 2020 2020 2020 200a   array.        .
+00046650: 2020 2020 2020 2020 5f20 3d20 6e70 2e75          _ = np.u
+00046660: 6e69 7175 6528 7365 6c66 2e61 7272 6179  nique(self.array
+00046670: 2c20 7265 7475 726e 5f63 6f75 6e74 733d  , return_counts=
+00046680: 5472 7565 2c20 7265 7475 726e 5f69 6e76  True, return_inv
+00046690: 6572 7365 3d54 7275 6529 0a20 2020 2020  erse=True).     
+000466a0: 2020 2073 656c 662e 6469 6d20 3d20 7365     self.dim = se
+000466b0: 6c66 2e61 7272 6179 2e73 697a 650a 2020  lf.array.size.  
+000466c0: 2020 2020 2020 7365 6c66 2e7a 6572 6f73        self.zeros
+000466d0: 203d 206e 702e 7a65 726f 7328 7365 6c66   = np.zeros(self
+000466e0: 2e61 7272 6179 2e73 6861 7065 2c20 6474  .array.shape, dt
+000466f0: 7970 653d 626f 6f6c 290a 2020 2020 2020  ype=bool).      
+00046700: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
+00046710: 7661 6c75 6573 203d 205b 6c20 666f 7220  values = [l for 
+00046720: 6c20 696e 205f 5b30 5d5d 0a20 2020 2020  l in _[0]].     
+00046730: 2020 2073 656c 662e 696e 6469 6365 7320     self.indices 
+00046740: 3d20 5f5b 315d 0a20 2020 2020 2020 2073  = _[1].        s
+00046750: 656c 662e 636f 756e 7473 203d 205f 5b32  elf.counts = _[2
+00046760: 5d0a 2020 2020 2020 2020 6966 2076 6572  ].        if ver
+00046770: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00046780: 2020 7365 6c66 2e69 6e66 6f28 736f 7274    self.info(sort
+00046790: 5f63 6f75 6e74 733d 7665 7262 6f73 6529  _counts=verbose)
+000467a0: 0a20 2020 200a 2020 2020 4070 726f 7065  .    .    @prope
+000467b0: 7274 790a 2020 2020 6465 6620 4e28 7365  rty.    def N(se
+000467c0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+000467d0: 0a20 2020 2020 2020 204e 756d 6265 7220  .        Number 
+000467e0: 6f66 2075 6e69 7175 6520 6060 7661 6c75  of unique ``valu
+000467f0: 6573 6060 0a20 2020 2020 2020 2022 2222  es``.        """
+00046800: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00046810: 6c65 6e28 7365 6c66 2e76 616c 7565 7329  len(self.values)
+00046820: 0a0a 0a20 2020 2064 6566 2069 6e66 6f28  ...    def info(
+00046830: 7365 6c66 2c20 736f 7274 5f63 6f75 6e74  self, sort_count
+00046840: 733d 2d31 293a 0a20 2020 2020 2020 2022  s=-1):.        "
+00046850: 2222 0a20 2020 2020 2020 2050 7269 6e74  "".        Print
+00046860: 2061 2073 756d 6d61 7279 0a20 2020 2020   a summary.     
+00046870: 2020 2022 2222 0a20 2020 2020 2020 2070     """.        p
+00046880: 7269 6e74 2866 277b 224e 223a 3e34 7d20  rint(f'{"N":>4} 
+00046890: 207b 2276 616c 7565 223a 3130 7d27 290a   {"value":10}').
+000468a0: 2020 2020 2020 2020 7072 696e 7428 273d          print('=
+000468b0: 3d3d 3d20 203d 3d3d 3d3d 3d3d 3d3d 3d27  ===  =========='
+000468c0: 290a 2020 2020 2020 2020 6966 2073 6f72  ).        if sor
+000468d0: 745f 636f 756e 7473 3a0a 2020 2020 2020  t_counts:.      
+000468e0: 2020 2020 2020 736f 203d 206e 702e 6172        so = np.ar
+000468f0: 6773 6f72 7428 7365 6c66 2e63 6f75 6e74  gsort(self.count
+00046900: 7329 5b3a 3a69 6e74 2873 6f72 745f 636f  s)[::int(sort_co
+00046910: 756e 7473 295d 0a20 2020 2020 2020 2065  unts)].        e
+00046920: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00046930: 2073 6f20 3d20 6e70 2e61 7261 6e67 6528   so = np.arange(
+00046940: 7365 6c66 2e4e 290a 2020 2020 2020 2020  self.N).        
+00046950: 2020 2020 0a20 2020 2020 2020 2066 6f72      .        for
+00046960: 2069 2069 6e20 736f 3a0a 2020 2020 2020   i in so:.      
+00046970: 2020 2020 2020 762c 2063 203d 2073 656c        v, c = sel
+00046980: 662e 7661 6c75 6573 5b69 5d2c 2073 656c  f.values[i], sel
+00046990: 662e 636f 756e 7473 5b69 5d0a 2020 2020  f.counts[i].    
+000469a0: 2020 2020 2020 2020 7072 696e 7428 6627          print(f'
+000469b0: 7b63 3a3e 347d 2020 7b76 3a31 307d 2729  {c:>4}  {v:10}')
+000469c0: 0a0a 0a20 2020 2064 6566 2063 6f75 6e74  ...    def count
+000469d0: 2873 656c 662c 206b 6579 293a 0a20 2020  (self, key):.   
+000469e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000469f0: 2047 6574 206f 6363 7572 7265 6e63 6573   Get occurrences
+00046a00: 2063 6f75 6e74 206f 6620 6120 7061 7274   count of a part
+00046a10: 6963 756c 6172 2060 6076 616c 7565 6060  icular ``value``
+00046a20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00046a30: 2020 2020 2069 6620 6b65 7920 696e 2073       if key in s
+00046a40: 656c 662e 7661 6c75 6573 3a0a 2020 2020  elf.values:.    
+00046a50: 2020 2020 2020 2020 6978 203d 2073 656c          ix = sel
+00046a60: 662e 7661 6c75 6573 2e69 6e64 6578 286b  f.values.index(k
+00046a70: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+00046a80: 7265 7475 726e 2073 656c 662e 636f 756e  return self.coun
+00046a90: 7473 5b69 785d 0a20 2020 2020 2020 2065  ts[ix].        e
+00046aa0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00046ab0: 2072 6574 7572 6e20 300a 0a0a 2020 2020   return 0...    
+00046ac0: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
+00046ad0: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
+00046ae0: 2020 2020 2020 2020 4974 6572 6162 6c65          Iterable
+00046af0: 206f 7665 7220 6076 616c 7565 7360 2061   over `values` a
+00046b00: 7474 7269 6275 7465 0a20 2020 2020 2020  ttribute.       
+00046b10: 200a 2020 2020 2020 2020 5265 7475 726e   .        Return
+00046b20: 7320 6120 7475 706c 6520 6f66 2074 6865  s a tuple of the
+00046b30: 2076 616c 7565 2061 6e64 2074 6865 2062   value and the b
+00046b40: 6f6f 6c65 616e 2073 656c 6563 7469 6f6e  oolean selection
+00046b50: 2061 7272 6179 2066 6f72 2074 6861 7420   array for that 
+00046b60: 0a20 2020 2020 2020 2076 616c 7565 2e0a  .        value..
+00046b70: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00046b80: 2020 2020 6920 3d20 300a 2020 2020 2020      i = 0.      
+00046b90: 2020 7768 696c 6520 6920 3c20 7365 6c66    while i < self
+00046ba0: 2e4e 3a0a 2020 2020 2020 2020 2020 2020  .N:.            
+00046bb0: 7669 203d 2073 656c 662e 7661 6c75 6573  vi = self.values
+00046bc0: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
+00046bd0: 7969 656c 6420 2876 692c 2073 656c 665b  yield (vi, self[
+00046be0: 7669 5d29 0a20 2020 2020 2020 2020 2020  vi]).           
+00046bf0: 2069 202b 3d20 310a 0a0a 2020 2020 6465   i += 1...    de
+00046c00: 6620 5f5f 6765 7469 7465 6d5f 5f28 7365  f __getitem__(se
+00046c10: 6c66 2c20 6b65 7929 3a0a 2020 2020 2020  lf, key):.      
+00046c20: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
+00046c30: 2e76 616c 7565 733a 0a20 2020 2020 2020  .values:.       
+00046c40: 2020 2020 2069 7820 3d20 7365 6c66 2e76       ix = self.v
+00046c50: 616c 7565 732e 696e 6465 7828 6b65 7929  alues.index(key)
+00046c60: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+00046c70: 7420 3d20 7365 6c66 2e69 6e64 6963 6573  t = self.indices
+00046c80: 203d 3d20 6978 0a20 2020 2020 2020 2020   == ix.         
+00046c90: 2020 2072 6574 7572 6e20 7465 7374 0a20     return test. 
+00046ca0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00046cb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00046cc0: 7365 6c66 2e7a 6572 6f73 0a0a 0a20 2020  self.zeros...   
+00046cd0: 2023 2064 6566 205f 5f69 7465 725f 5f28   # def __iter__(
+00046ce0: 7365 6c66 293a 0a20 2020 2023 2020 2020  self):.    #    
+00046cf0: 2066 6f72 2069 6478 2069 6e20 6974 6572   for idx in iter
+00046d00: 746f 6f6c 732e 636f 756e 7428 293a 0a20  tools.count():. 
+00046d10: 2020 2023 2020 2020 2020 2020 2074 7279     #         try
+00046d20: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
+00046d30: 2020 2020 7969 656c 6420 7365 6c66 2e76      yield self.v
+00046d40: 616c 7565 735b 6964 785d 0a20 2020 2023  alues[idx].    #
+00046d50: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00046d60: 496e 6465 7845 7272 6f72 3a0a 2020 2020  IndexError:.    
+00046d70: 2320 2020 2020 2020 2020 2020 2020 6272  #             br
+00046d80: 6561 6b0a 0a20 2020 2064 6566 205f 5f6c  eak..    def __l
+00046d90: 656e 5f5f 2873 656c 6629 3a0a 2020 2020  en__(self):.    
+00046da0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00046db0: 4e0a 0a0a 636c 6173 7320 4875 6262 6c65  N...class Hubble
+00046dc0: 5859 5a28 6f62 6a65 6374 293a 0a20 2020  XYZ(object):.   
+00046dd0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00046de0: 6c66 2c20 7370 745f 6669 6c65 3d27 272c  lf, spt_file='',
+00046df0: 2070 6172 616d 5f64 6963 743d 7b7d 293a   param_dict={}):
+00046e00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00046e10: 2020 2020 2048 656c 7065 7220 746f 2063       Helper to c
+00046e20: 6f6d 7075 7465 2048 5354 2067 656f 6365  ompute HST geoce
+00046e30: 6e74 7269 6320 636f 6f72 6469 6e61 7465  ntric coordinate
+00046e40: 7320 6672 6f6d 206f 7262 6974 616c 2070  s from orbital p
+00046e50: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+00046e60: 2020 0a20 2020 2020 2020 2028 7465 7374    .        (test
+00046e70: 696e 6729 0a20 2020 2020 2020 200a 2020  ing).        .  
+00046e80: 2020 2020 2020 4261 7365 6420 6f6e 2068        Based on h
+00046e90: 7474 703a 2f2f 6172 7469 636c 6573 2e61  ttp://articles.a
+00046ea0: 6473 6162 732e 6861 7276 6172 642e 6564  dsabs.harvard.ed
+00046eb0: 752f 2f66 756c 6c2f 3139 3935 4153 5043  u//full/1995ASPC
+00046ec0: 2e2e 2e37 372e 2e34 3634 412f 0a20 2020  ...77..464A/.   
+00046ed0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00046ee0: 2069 6620 7370 745f 6669 6c65 3a0a 2020   if spt_file:.  
+00046ef0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
+00046f00: 6172 616d 5f64 6963 7420 3d20 7365 6c66  aram_dict = self
+00046f10: 2e70 6172 7365 5f66 726f 6d5f 7370 7428  .parse_from_spt(
+00046f20: 7370 745f 6669 6c65 290a 2020 2020 2020  spt_file).      
+00046f30: 2020 0a20 2020 2020 2020 2065 6c69 6620    .        elif 
+00046f40: 7061 7261 6d5f 6469 6374 3a0a 2020 2020  param_dict:.    
+00046f50: 2020 2020 2020 2020 7365 6c66 2e70 6172          self.par
+00046f60: 616d 5f64 6963 7420 3d20 7061 7261 6d5f  am_dict = param_
+00046f70: 6469 6374 0a20 2020 2020 2020 200a 2020  dict.        .  
+00046f80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00046f90: 2020 2020 2020 2020 7365 6c66 2e70 6172          self.par
+00046fa0: 616d 5f64 6963 7420 3d20 7b7d 0a20 2020  am_dict = {}.   
+00046fb0: 2020 2020 200a 2020 2020 2020 2020 7365       .        se
+00046fc0: 6c66 2e63 6f6d 7075 7465 6420 3d20 7b7d  lf.computed = {}
+00046fd0: 0a0a 0a20 2020 2040 7072 6f70 6572 7479  ...    @property
+00046fe0: 200a 2020 2020 6465 6620 5f74 3139 3835   .    def _t1985
+00046ff0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00047000: 2222 220a 2020 2020 2020 2020 5265 6665  """.        Refe
+00047010: 7265 6e63 6520 7469 6d65 0a20 2020 2020  rence time.     
+00047020: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+00047030: 6d70 6f72 7420 6173 7472 6f70 792e 7469  mport astropy.ti
+00047040: 6d65 0a20 2020 2020 2020 2074 3020 3d20  me.        t0 = 
+00047050: 6173 7472 6f70 792e 7469 6d65 2e54 696d  astropy.time.Tim
+00047060: 6528 2731 3938 352d 3031 2d30 3154 3030  e('1985-01-01T00
+00047070: 3a30 303a 3030 5a27 290a 2020 2020 2020  :00:00Z').      
+00047080: 2020 7265 7475 726e 2074 300a 0a0a 2020    return t0...  
+00047090: 2020 6465 6620 5f5f 6361 6c6c 5f5f 2873    def __call__(s
+000470a0: 656c 662c 2074 5f69 6e2c 202a 2a6b 7761  elf, t_in, **kwa
+000470b0: 7267 7329 3a0a 2020 2020 2020 2020 2222  rgs):.        ""
+000470c0: 220a 2020 2020 2020 2020 436f 6e76 6572  ".        Conver
+000470d0: 7420 696e 7075 7420 7469 6d65 2060 6074  t input time ``t
+000470e0: 5f69 6e60 6020 746f 2073 6563 6f6e 6473  _in`` to seconds
+000470f0: 2073 696e 6365 2031 2f31 2f38 3520 616e   since 1/1/85 an
+00047100: 6420 6060 6576 616c 7561 7465 6060 2e0a  d ``evaluate``..
+00047110: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00047120: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
+00047130: 7079 2e74 696d 650a 2020 2020 2020 2020  py.time.        
+00047140: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+00047150: 6528 745f 696e 2c20 6173 7472 6f70 792e  e(t_in, astropy.
+00047160: 7469 6d65 2e54 696d 6529 3a0a 2020 2020  time.Time):.    
+00047170: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00047180: 6c75 6545 7272 6f72 2827 745f 696e 206d  lueError('t_in m
+00047190: 7573 7420 6265 2061 7374 726f 7079 2e74  ust be astropy.t
+000471a0: 696d 652e 5469 6d65 206f 626a 6563 7427  ime.Time object'
+000471b0: 290a 0a20 2020 2020 2020 2064 7420 3d20  )..        dt = 
+000471c0: 745f 696e 202d 2073 656c 662e 5f74 3139  t_in - self._t19
+000471d0: 3835 0a20 2020 2020 2020 2078 797a 203d  85.        xyz =
+000471e0: 2073 656c 662e 6576 616c 7561 7465 2864   self.evaluate(d
+000471f0: 742e 7365 632c 202a 2a6b 7761 7267 7329  t.sec, **kwargs)
+00047200: 0a20 2020 2020 2020 2069 6620 2761 735f  .        if 'as_
+00047210: 7461 626c 6527 2069 6e20 6b77 6172 6773  table' in kwargs
+00047220: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00047230: 206b 7761 7267 735b 2761 735f 7461 626c   kwargs['as_tabl
+00047240: 6527 5d3a 0a20 2020 2020 2020 2020 2020  e']:.           
+00047250: 2020 2020 2078 797a 5b27 7469 6d65 275d       xyz['time']
+00047260: 203d 2074 5f69 6e0a 2020 2020 2020 2020   = t_in.        
+00047270: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00047280: 2072 6574 7572 6e20 7879 7a0a 0a0a 2020   return xyz...  
+00047290: 2020 6465 6620 5f5f 6765 7469 7465 6d5f    def __getitem_
+000472a0: 5f28 7365 6c66 2c20 6b65 7929 3a0a 2020  _(self, key):.  
+000472b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000472c0: 662e 7061 7261 6d5f 6469 6374 5b6b 6579  f.param_dict[key
+000472d0: 5d0a 0a0a 2020 2020 6465 6620 6576 616c  ]...    def eval
+000472e0: 7561 7465 2873 656c 662c 2064 742c 2075  uate(self, dt, u
+000472f0: 6e69 743d 4e6f 6e65 2c20 6173 5f74 6162  nit=None, as_tab
+00047300: 6c65 3d46 616c 7365 293a 0a20 2020 2020  le=False):.     
+00047310: 2020 2022 2222 0a20 2020 2020 2020 2045     """.        E
+00047320: 7661 6c75 6174 6520 6571 7561 7469 6f6e  valuate equation
+00047330: 7320 746f 2067 6574 2070 6f73 6974 696f  s to get positio
+00047340: 6e73 0a20 2020 2020 2020 200a 2020 2020  ns.        .    
+00047350: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00047360: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00047370: 2020 2020 782c 2079 2c20 7a2c 2072 3a20      x, y, z, r: 
+00047380: 666c 6f61 740a 2020 2020 2020 2020 2020  float.          
+00047390: 2020 436f 6f72 6469 6e61 7465 732c 2069    Coordinates, i
+000473a0: 6e20 6b6d 206f 7220 6060 756e 6974 6060  n km or ``unit``
+000473b0: 2e0a 2020 2020 2020 2020 2020 2020 0a20  ..            . 
+000473c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000473d0: 2020 200a 2020 2020 2020 2020 6966 206e     .        if n
+000473e0: 6f74 2073 656c 662e 7061 7261 6d5f 6469  ot self.param_di
+000473f0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+00047400: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00047410: 2827 4f72 6269 7461 6c20 7061 7261 6d65  ('Orbital parame
+00047420: 7465 7273 206e 6f74 2064 6566 696e 6564  ters not defined
+00047430: 2069 6e20 270a 2020 2020 2020 2020 2020   in '.          
+00047440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047450: 2020 2027 7365 6c66 2e70 6172 616d 5f64     'self.param_d
+00047460: 6963 7427 290a 2020 2020 2020 2020 2020  ict').          
+00047470: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00047480: 2020 2070 203d 2073 656c 662e 7061 7261     p = self.para
+00047490: 6d5f 6469 6374 0a20 2020 2020 2020 200a  m_dict.        .
+000474a0: 2020 2020 2020 2020 7420 3d20 6e70 2e61          t = np.a
+000474b0: 746c 6561 7374 5f31 6428 6474 290a 2020  tleast_1d(dt).  
+000474c0: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
+000474d0: 2045 712e 2031 0a20 2020 2020 2020 2062   Eq. 1.        b
+000474e0: 7261 636b 6574 203d 2070 5b27 4d2e 275d  racket = p['M.']
+000474f0: 2a28 742d 705b 2774 6175 275d 2920 2b20  *(t-p['tau']) + 
+00047500: 302e 352a 705b 274d 2e2e 275d 2a28 742d  0.5*p['M..']*(t-
+00047510: 705b 2774 6175 275d 292a 2a32 0a20 2020  p['tau'])**2.   
+00047520: 2020 2020 204d 203d 2070 5b27 4d30 275d       M = p['M0']
+00047530: 202b 2032 2a6e 702e 7069 2a62 7261 636b   + 2*np.pi*brack
+00047540: 6574 0a20 2020 2020 2020 200a 2020 2020  et.        .    
+00047550: 2020 2020 2320 4571 2e20 320a 2020 2020      # Eq. 2.    
+00047560: 2020 2020 7369 6e4d 203d 206e 702e 7369      sinM = np.si
+00047570: 6e28 4d29 0a20 2020 2020 2020 2063 6f73  n(M).        cos
+00047580: 4d20 3d20 6e70 2e63 6f73 284d 290a 2020  M = np.cos(M).  
+00047590: 2020 2020 2020 6520 3d20 705b 2765 275d        e = p['e']
+000475a0: 0a20 2020 2020 2020 206e 7520 3d20 4d20  .        nu = M 
+000475b0: 2b20 7369 6e4d 2a28 322a 6520 2b20 332a  + sinM*(2*e + 3*
+000475c0: 652a 2a33 2a63 6f73 4d2a 2a32 202d 2034  e**3*cosM**2 - 4
+000475d0: 2e2f 332a 652a 2a33 2a73 696e 4d2a 2a32  ./3*e**3*sinM**2
+000475e0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+000475f0: 2020 2020 2020 2020 202b 2035 2e2f 322a           + 5./2*
+00047600: 652a 2a32 2a63 6f73 4d29 0a20 2020 2020  e**2*cosM).     
+00047610: 2020 200a 2020 2020 2020 2020 2320 4571     .        # Eq
+00047620: 2e20 330a 2020 2020 2020 2020 7220 3d20  . 3.        r = 
+00047630: 705b 2761 2831 2d65 2a2a 3229 275d 2f28  p['a(1-e**2)']/(
+00047640: 312b 652a 6e70 2e63 6f73 286e 7529 290a  1+e*np.cos(nu)).
+00047650: 2020 2020 2020 2020 2320 546f 206b 6d0a          # To km.
+00047660: 2020 2020 2020 2020 7220 2f3d 2031 3030          r /= 100
+00047670: 302e 0a20 2020 2020 2020 200a 2020 2020  0..        .    
+00047680: 2020 2020 2320 4571 2e20 340a 2020 2020      # Eq. 4.    
+00047690: 2020 2020 4f6d 203d 2032 2a6e 702e 7069      Om = 2*np.pi
+000476a0: 2a28 705b 274f 6d30 275d 202b 2070 5b27  *(p['Om0'] + p['
+000476b0: 4f6d 2e27 5d2a 2874 2d70 5b27 7461 7527  Om.']*(t-p['tau'
+000476c0: 5d29 290a 2020 2020 2020 2020 0a20 2020  ])).        .   
+000476d0: 2020 2020 2023 2045 712e 2035 0a20 2020       # Eq. 5.   
+000476e0: 2020 2020 2077 203d 2032 2a6e 702e 7069       w = 2*np.pi
+000476f0: 2a28 705b 2777 3027 5d20 2b20 705b 2777  *(p['w0'] + p['w
+00047700: 2e27 5d2a 2874 2d70 5b27 7461 7527 5d29  .']*(t-p['tau'])
+00047710: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+00047720: 2020 2073 656c 662e 6361 6c63 5f64 6963     self.calc_dic
+00047730: 7420 3d20 7b27 4d27 3a4d 2c20 276e 7527  t = {'M':M, 'nu'
+00047740: 3a6e 752c 200a 2020 2020 2020 2020 2020  :nu, .          
+00047750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047760: 2761 273a 705b 2761 275d 2c20 0a20 2020  'a':p['a'], .   
+00047770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047780: 2020 2020 2020 2027 6927 3a6e 702e 6172         'i':np.ar
+00047790: 6373 696e 2870 5b27 7369 6e69 275d 292c  csin(p['sini']),
+000477a0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+000477b0: 2020 2020 2020 2020 2020 2020 274f 6d27              'Om'
+000477c0: 3a4f 6d2c 0a20 2020 2020 2020 2020 2020  :Om,.           
+000477d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000477e0: 7727 3a77 7d0a 2020 2020 2020 2020 0a20  w':w}.        . 
+000477f0: 2020 2020 2020 2023 2045 712e 2036 0a20         # Eq. 6. 
+00047800: 2020 2020 2020 2063 6f73 4f6d 203d 206e         cosOm = n
+00047810: 702e 636f 7328 4f6d 290a 2020 2020 2020  p.cos(Om).      
+00047820: 2020 7369 6e4f 6d20 3d20 6e70 2e73 696e    sinOm = np.sin
+00047830: 284f 6d29 0a20 2020 2020 2020 2063 6f73  (Om).        cos
+00047840: 7776 203d 206e 702e 636f 7328 772b 6e75  wv = np.cos(w+nu
+00047850: 290a 2020 2020 2020 2020 7369 6e77 7620  ).        sinwv 
+00047860: 3d20 6e70 2e73 696e 2877 2b6e 7529 0a20  = np.sin(w+nu). 
+00047870: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00047880: 6966 2075 6e69 7420 6973 206e 6f74 204e  if unit is not N
+00047890: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000478a0: 2072 203d 2028 722a 752e 6b6d 292e 746f   r = (r*u.km).to
+000478b0: 2875 6e69 7429 0a20 2020 2020 2020 2020  (unit).         
+000478c0: 2020 200a 2020 2020 2020 2020 7820 3d20     .        x = 
+000478d0: 722a 2863 6f73 4f6d 2a63 6f73 7776 202d  r*(cosOm*coswv -
+000478e0: 2070 5b27 636f 7369 275d 2a73 696e 4f6d   p['cosi']*sinOm
+000478f0: 2a73 696e 7776 290a 2020 2020 2020 2020  *sinwv).        
+00047900: 7920 3d20 722a 2873 696e 4f6d 2a63 6f73  y = r*(sinOm*cos
+00047910: 7776 202b 2070 5b27 636f 7369 275d 2a63  wv + p['cosi']*c
+00047920: 6f73 4f6d 2a73 696e 7776 290a 2020 2020  osOm*sinwv).    
+00047930: 2020 2020 7a20 3d20 722a 705b 2773 696e      z = r*p['sin
+00047940: 6927 5d2a 7369 6e77 760a 2020 2020 2020  i']*sinwv.      
+00047950: 2020 0a20 2020 2020 2020 2069 6620 6173    .        if as
+00047960: 5f74 6162 6c65 3a0a 2020 2020 2020 2020  _table:.        
+00047970: 2020 2020 7461 6220 3d20 4754 6162 6c65      tab = GTable
+00047980: 2829 0a20 2020 2020 2020 2020 2020 2074  ().            t
+00047990: 6162 5b27 6474 275d 203d 2074 0a20 2020  ab['dt'] = t.   
+000479a0: 2020 2020 2020 2020 2074 6162 5b27 7827           tab['x'
+000479b0: 5d20 3d20 780a 2020 2020 2020 2020 2020  ] = x.          
+000479c0: 2020 7461 625b 2779 275d 203d 2079 0a20    tab['y'] = y. 
+000479d0: 2020 2020 2020 2020 2020 2074 6162 5b27             tab['
+000479e0: 7a27 5d20 3d20 7a0a 2020 2020 2020 2020  z'] = z.        
+000479f0: 2020 2020 7461 625b 2772 275d 203d 2072      tab['r'] = r
+00047a00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00047a10: 7572 6e20 7461 620a 2020 2020 2020 2020  urn tab.        
+00047a20: 656c 7365 3a20 0a20 2020 2020 2020 2020  else: .         
+00047a30: 2020 2072 6574 7572 6e20 782c 2079 2c20     return x, y, 
+00047a40: 7a2c 2072 0a0a 0a20 2020 2064 6566 2066  z, r...    def f
+00047a50: 726f 6d5f 666c 7428 7365 6c66 2c20 666c  rom_flt(self, fl
+00047a60: 745f 6669 6c65 2c20 2a2a 6b77 6172 6773  t_file, **kwargs
+00047a70: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00047a80: 2020 2020 2020 2043 6f6d 7075 7465 2070         Compute p
+00047a90: 6f73 6974 696f 6e73 2061 7420 6578 7073  ositions at exps
+00047aa0: 7461 7274 2c20 6578 706d 6964 2c20 6578  tart, expmid, ex
+00047ab0: 7065 6e64 0a20 2020 2020 2020 2022 2222  pend.        """
+00047ac0: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+00047ad0: 6173 7472 6f70 792e 7469 6d65 0a20 2020  astropy.time.   
+00047ae0: 2020 2020 200a 2020 2020 2020 2020 666c       .        fl
+00047af0: 7420 3d20 7079 6669 7473 2e6f 7065 6e28  t = pyfits.open(
+00047b00: 666c 745f 6669 6c65 290a 2020 2020 2020  flt_file).      
+00047b10: 2020 6578 7073 7461 7274 203d 2066 6c74    expstart = flt
+00047b20: 5b30 5d2e 6865 6164 6572 5b27 4558 5053  [0].header['EXPS
+00047b30: 5441 5254 275d 0a20 2020 2020 2020 2065  TART'].        e
+00047b40: 7870 656e 6420 3d20 666c 745b 305d 2e68  xpend = flt[0].h
+00047b50: 6561 6465 725b 2745 5850 454e 4427 5d0a  eader['EXPEND'].
+00047b60: 2020 2020 2020 2020 6578 706d 6964 203d          expmid =
+00047b70: 2028 6578 7073 7461 7274 2b65 7870 656e   (expstart+expen
+00047b80: 6429 2f32 2e0a 2020 2020 2020 2020 0a20  d)/2..        . 
+00047b90: 2020 2020 2020 2074 5f69 6e20 3d20 6173         t_in = as
+00047ba0: 7472 6f70 792e 7469 6d65 2e54 696d 6528  tropy.time.Time(
+00047bb0: 5b65 7870 7374 6172 742c 2065 7870 6d69  [expstart, expmi
+00047bc0: 642c 2065 7870 656e 645d 2c20 666f 726d  d, expend], form
+00047bd0: 6174 3d27 6d6a 6427 290a 2020 2020 2020  at='mjd').      
+00047be0: 2020 666c 742e 636c 6f73 6528 290a 2020    flt.close().  
+00047bf0: 2020 2020 2020 0a20 2020 2020 2020 2072        .        r
+00047c00: 6574 7572 6e20 7365 6c66 2874 5f69 6e2c  eturn self(t_in,
+00047c10: 202a 2a6b 7761 7267 7329 0a0a 0a20 2020   **kwargs)...   
+00047c20: 2064 6566 2064 656c 7461 7428 7365 6c66   def deltat(self
+00047c30: 2c20 6474 293a 0a20 2020 2020 2020 2022  , dt):.        "
+00047c40: 2222 0a20 2020 2020 2020 2043 6f6e 7665  "".        Conve
+00047c50: 7274 2061 2074 696d 6520 6060 7460 6020  rt a time ``t`` 
+00047c60: 696e 2073 6563 6f6e 6473 2066 726f 6d20  in seconds from 
+00047c70: 312f 312f 3835 2074 6f20 616e 2049 534f  1/1/85 to an ISO
+00047c80: 2074 696d 650a 2020 2020 2020 2020 2222   time.        ""
+00047c90: 2220 2020 200a 2020 2020 2020 2020 6966  "    .        if
+00047ca0: 206e 6f74 2068 6173 6174 7472 2864 742c   not hasattr(dt,
+00047cb0: 2027 756e 6974 2729 3a0a 2020 2020 2020   'unit'):.      
+00047cc0: 2020 2020 2020 6474 7365 6320 3d20 6474        dtsec = dt
+00047cd0: 2a75 2e73 6563 6f6e 640a 2020 2020 2020  *u.second.      
+00047ce0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00047cf0: 2020 2020 6474 7365 6320 3d20 6474 0a20      dtsec = dt. 
+00047d00: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00047d10: 2020 2020 7420 3d20 7365 6c66 2e5f 7431      t = self._t1
+00047d20: 3938 3520 2b20 6474 7365 630a 2020 2020  985 + dtsec.    
+00047d30: 2020 2020 7265 7475 726e 2074 0a0a 0a20      return t... 
+00047d40: 2020 2064 6566 2070 6172 7365 5f66 726f     def parse_fro
+00047d50: 6d5f 7370 7428 7365 6c66 2c20 7370 745f  m_spt(self, spt_
+00047d60: 6669 6c65 293a 0a20 2020 2020 2020 2022  file):.        "
+00047d70: 2222 0a20 2020 2020 2020 2047 6574 206f  "".        Get o
+00047d80: 7262 6974 616c 2065 6c65 6d65 6e74 7320  rbital elements 
+00047d90: 6672 6f6d 2053 5054 2068 6561 6465 720a  from SPT header.
+00047da0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00047db0: 2020 2020 696d 706f 7274 2061 7374 726f      import astro
+00047dc0: 7079 2e69 6f2e 6669 7473 2061 7320 7079  py.io.fits as py
+00047dd0: 6669 7473 0a20 2020 2020 2020 2069 6d70  fits.        imp
+00047de0: 6f72 7420 6173 7472 6f70 792e 7469 6d65  ort astropy.time
+00047df0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00047e00: 2020 7769 7468 2070 7966 6974 732e 6f70    with pyfits.op
+00047e10: 656e 2873 7074 5f66 696c 6529 2061 7320  en(spt_file) as 
+00047e20: 5f69 6d3a 0a20 2020 2020 2020 2020 2020  _im:.           
+00047e30: 2073 7074 203d 205f 696d 5b30 5d2e 6865   spt = _im[0].he
+00047e40: 6164 6572 2e63 6f70 7928 290a 2020 2020  ader.copy().    
+00047e50: 2020 2020 0a20 2020 2020 2020 2070 6172      .        par
+00047e60: 616d 5f64 6963 7420 3d20 7b7d 0a20 2020  am_dict = {}.   
+00047e70: 2020 2020 2070 6172 616d 5f64 6963 745b       param_dict[
+00047e80: 2774 6175 275d 203d 2073 7074 5b27 4550  'tau'] = spt['EP
+00047e90: 4348 5449 4d45 275d 0a20 2020 2020 2020  CHTIME'].       
+00047ea0: 2070 6172 616d 5f64 6963 745b 274d 3027   param_dict['M0'
+00047eb0: 5d20 3d20 7370 745b 274d 4541 4e41 4e4f  ] = spt['MEANANO
+00047ec0: 4d27 5d0a 2020 2020 2020 2020 7061 7261  M'].        para
+00047ed0: 6d5f 6469 6374 5b27 4d2e 275d 203d 2073  m_dict['M.'] = s
+00047ee0: 7074 5b27 4644 4d45 414e 414e 275d 0a20  pt['FDMEANAN']. 
+00047ef0: 2020 2020 2020 2070 6172 616d 5f64 6963         param_dic
+00047f00: 745b 274d 2e2e 275d 203d 2073 7074 5b27  t['M..'] = spt['
+00047f10: 5344 4d45 414e 414e 275d 0a20 2020 2020  SDMEANAN'].     
+00047f20: 2020 2070 6172 616d 5f64 6963 745b 2765     param_dict['e
+00047f30: 275d 203d 2073 7074 5b27 4543 4345 4e54  '] = spt['ECCENT
+00047f40: 5259 275d 0a20 2020 2020 2020 2070 6172  RY'].        par
+00047f50: 616d 5f64 6963 745b 2761 2831 2d65 2a2a  am_dict['a(1-e**
+00047f60: 3229 275d 203d 2073 7074 5b27 5345 4d49  2)'] = spt['SEMI
+00047f70: 4c52 4543 275d 0a20 2020 2020 2020 2070  LREC'].        p
+00047f80: 6172 616d 5f64 6963 745b 2761 275d 203d  aram_dict['a'] =
+00047f90: 2070 6172 616d 5f64 6963 745b 2761 2831   param_dict['a(1
+00047fa0: 2d65 2a2a 3229 275d 202f 2028 312d 7061  -e**2)'] / (1-pa
+00047fb0: 7261 6d5f 6469 6374 5b27 6527 5d2a 2a32  ram_dict['e']**2
+00047fc0: 290a 2020 2020 2020 2020 7061 7261 6d5f  ).        param_
+00047fd0: 6469 6374 5b27 4f6d 3027 5d20 3d20 7370  dict['Om0'] = sp
+00047fe0: 745b 2752 4153 4341 5343 4e27 5d0a 2020  t['RASCASCN'].  
+00047ff0: 2020 2020 2020 7061 7261 6d5f 6469 6374        param_dict
+00048000: 5b27 4f6d 2e27 5d20 3d20 7370 745b 2752  ['Om.'] = spt['R
+00048010: 4341 5343 4e52 5627 5d0a 2020 2020 2020  CASCNRV'].      
+00048020: 2020 7061 7261 6d5f 6469 6374 5b27 7730    param_dict['w0
+00048030: 275d 203d 2073 7074 5b27 4152 4750 4552  '] = spt['ARGPER
+00048040: 4947 275d 0a20 2020 2020 2020 2070 6172  IG'].        par
+00048050: 616d 5f64 6963 745b 2777 2e27 5d20 3d20  am_dict['w.'] = 
+00048060: 7370 745b 2752 4341 5247 5045 5227 5d0a  spt['RCARGPER'].
+00048070: 2020 2020 2020 2020 7061 7261 6d5f 6469          param_di
+00048080: 6374 5b27 636f 7369 275d 203d 2073 7074  ct['cosi'] = spt
+00048090: 5b27 434f 5349 4e43 4c49 275d 0a20 2020  ['COSINCLI'].   
+000480a0: 2020 2020 2070 6172 616d 5f64 6963 745b       param_dict[
+000480b0: 2773 696e 6927 5d20 3d20 7370 745b 2753  'sini'] = spt['S
+000480c0: 494e 4549 4e43 4c27 5d0a 2020 2020 2020  INEINCL'].      
+000480d0: 2020 7061 7261 6d5f 6469 6374 5b27 5663    param_dict['Vc
+000480e0: 275d 203d 2073 7074 5b27 4349 5256 454c  '] = spt['CIRVEL
+000480f0: 4f43 275d 0a20 2020 2020 2020 2070 6172  OC'].        par
+00048100: 616d 5f64 6963 745b 2774 696d 6566 6665  am_dict['timeffe
+00048110: 6327 5d20 3d20 7370 745b 2754 494d 4546  c'] = spt['TIMEF
+00048120: 4645 4327 5d0a 2020 2020 2020 2020 7061  FEC'].        pa
+00048130: 7261 6d5f 6469 6374 5b27 546f 7262 275d  ram_dict['Torb']
+00048140: 203d 2073 7074 5b27 4853 5448 4f52 4227   = spt['HSTHORB'
+00048150: 5d2a 320a 2020 2020 2020 2020 7061 7261  ]*2.        para
+00048160: 6d5f 6469 6374 5b27 7473 7461 7274 275d  m_dict['tstart']
+00048170: 203d 2073 7074 5b27 4f42 5353 5452 5454   = spt['OBSSTRTT
+00048180: 275d 0a20 2020 2020 2020 200a 2020 2020  '].        .    
+00048190: 2020 2020 7061 7261 6d5f 6469 6374 5b27      param_dict['
+000481a0: 7461 755f 7469 6d65 275d 203d 2073 656c  tau_time'] = sel
+000481b0: 662e 6465 6c74 6174 2870 6172 616d 5f64  f.deltat(param_d
+000481c0: 6963 745b 2774 6175 275d 290a 2020 2020  ict['tau']).    
+000481d0: 2020 2020 7061 7261 6d5f 6469 6374 5b27      param_dict['
+000481e0: 7473 7461 7274 5f74 696d 6527 5d20 3d20  tstart_time'] = 
+000481f0: 7365 6c66 2e64 656c 7461 7428 7061 7261  self.deltat(para
+00048200: 6d5f 6469 6374 5b27 7473 7461 7274 275d  m_dict['tstart']
+00048210: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00048220: 2020 0a20 2020 2020 2020 2072 6574 7572    .        retur
+00048230: 6e20 7061 7261 6d5f 6469 6374 0a20 2020  n param_dict.   
+00048240: 200a 2020 2020 4073 7461 7469 636d 6574   .    @staticmet
+00048250: 686f 640a 2020 2020 6465 6620 7879 7a5f  hod.    def xyz_
+00048260: 746f 5f6c 6f6e 6c61 7428 7365 6c66 2c20  to_lonlat(self, 
+00048270: 782c 2079 2c20 7a2c 2072 6164 6961 6e73  x, y, z, radians
+00048280: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+00048290: 2022 2222 0a20 2020 2020 2020 2043 6f6d   """.        Com
+000482a0: 7075 7465 2073 7562 6c6f 6e2c 2073 7562  pute sublon, sub
+000482b0: 6c61 742c 2061 6c74 2066 726f 6d20 7879  lat, alt from xy
+000482c0: 7a20 636f 6f72 6473 2077 6974 6820 7079  z coords with py
+000482d0: 7072 6f6a 0a20 2020 2020 2020 200a 2020  proj.        .  
+000482e0: 2020 2020 2020 7879 7a20 6d75 7374 2062        xyz must b
+000482f0: 6520 696e 206d 6574 6572 730a 2020 2020  e in meters.    
+00048300: 2020 2020 0a20 2020 2020 2020 2022 2222      .        """
+00048310: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+00048320: 7079 7072 6f6a 0a20 2020 2020 2020 2065  pyproj.        e
+00048330: 6365 6620 3d20 7079 7072 6f6a 2e50 726f  cef = pyproj.Pro
+00048340: 6a28 7072 6f6a 3d27 6765 6f63 656e 7427  j(proj='geocent'
+00048350: 2c20 656c 6c70 733d 2757 4753 3834 272c  , ellps='WGS84',
+00048360: 2064 6174 756d 3d27 5747 5338 3427 290a   datum='WGS84').
+00048370: 2020 2020 2020 2020 6c6c 6120 3d20 7079          lla = py
+00048380: 7072 6f6a 2e50 726f 6a28 7072 6f6a 3d27  proj.Proj(proj='
+00048390: 6c61 746c 6f6e 6727 2c20 656c 6c70 733d  latlong', ellps=
+000483a0: 2757 4753 3834 272c 2064 6174 756d 3d27  'WGS84', datum='
+000483b0: 5747 5338 3427 290a 2020 2020 2020 2020  WGS84').        
+000483c0: 6c6f 6e2c 206c 6174 2c20 616c 7420 3d20  lon, lat, alt = 
+000483d0: 7079 7072 6f6a 2e74 7261 6e73 666f 726d  pyproj.transform
+000483e0: 2865 6365 662c 206c 6c61 2c20 782c 2079  (ecef, lla, x, y
+000483f0: 2c20 7a2c 2072 6164 6961 6e73 3d72 6164  , z, radians=rad
+00048400: 6961 6e73 290a 2020 2020 2020 2020 7265  ians).        re
+00048410: 7475 726e 206c 6f6e 2c20 6c61 742c 2061  turn lon, lat, a
+00048420: 6c74 0a0a 0a64 6566 2070 6174 6368 5f70  lt...def patch_p
+00048430: 686f 7475 7469 6c73 2829 3a0a 2020 2020  hotutils():.    
+00048440: 2222 220a 2020 2020 5061 7463 6820 746f  """.    Patch to
+00048450: 2066 6978 2069 6e63 6f6e 7369 7374 656e   fix inconsisten
+00048460: 6379 2077 6974 6820 6472 697a 7a6c 6570  cy with drizzlep
+00048470: 6163 3d33 2e32 2e31 2061 6e64 2070 686f  ac=3.2.1 and pho
+00048480: 7475 7469 6c73 3e31 2e30 2c20 7768 6572  tutils>1.0, wher
+00048490: 6520 0a20 2020 2054 6865 206c 6174 7465  e .    The latte
+000484a0: 7220 6973 206e 6565 6465 6420 666f 7220  r is needed for 
+000484b0: 6a77 7374 3d31 2e33 2e32 0a20 2020 2022  jwst=1.3.2.    "
+000484c0: 2222 0a20 2020 2069 6d70 6f72 7420 6f73  "".    import os
+000484d0: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
+000484e0: 2020 2069 6d70 6f72 7420 6472 697a 7a6c     import drizzl
+000484f0: 6570 6163 0a20 2020 2065 7863 6570 7420  epac.    except 
+00048500: 4174 7472 6962 7574 6545 7272 6f72 3a0a  AttributeError:.
+00048510: 2020 2020 0a20 2020 2020 2020 2069 6d70      .        imp
+00048520: 6f72 7420 7068 6f74 7574 696c 730a 2020  ort photutils.  
+00048530: 2020 2020 2020 7369 7465 5f70 6163 6b61        site_packa
+00048540: 6765 7320 3d20 6f73 2e70 6174 682e 6469  ges = os.path.di
+00048550: 726e 616d 6528 7068 6f74 7574 696c 732e  rname(photutils.
+00048560: 5f5f 6669 6c65 5f5f 290a 2020 2020 2020  __file__).      
+00048570: 2020 2320 6d61 6e75 616c 2061 7070 6c79    # manual apply
+00048580: 2070 6174 6368 0a20 2020 2020 2020 2074   patch.        t
+00048590: 6865 5f66 696c 6520 3d20 6627 7b73 6974  he_file = f'{sit
+000485a0: 655f 7061 636b 6167 6573 7d2f 2e2e 2f64  e_packages}/../d
+000485b0: 7269 7a7a 6c65 7061 632f 6861 7075 7469  rizzlepac/haputi
+000485c0: 6c73 2f61 6c69 676e 5f75 7469 6c73 2e70  ls/align_utils.p
+000485d0: 7927 0a20 2020 2020 2020 2077 6974 6820  y'.        with 
+000485e0: 6f70 656e 2874 6865 5f66 696c 652c 2772  open(the_file,'r
+000485f0: 2729 2061 7320 6670 3a0a 2020 2020 2020  ') as fp:.      
+00048600: 2020 2020 2020 6c69 6e65 7320 3d20 6670        lines = fp
+00048610: 2e72 6561 646c 696e 6573 2829 0a20 2020  .readlines().   
+00048620: 200a 2020 2020 2020 2020 7072 696e 7428   .        print(
+00048630: 7369 7465 5f70 6163 6b61 6765 732c 206c  site_packages, l
+00048640: 656e 286c 696e 6573 2929 0a20 2020 2020  en(lines)).     
+00048650: 2020 2066 6f72 2069 2c20 6c69 6e65 2069     for i, line i
+00048660: 6e20 656e 756d 6572 6174 6528 6c69 6e65  n enumerate(line
+00048670: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00048680: 6966 206c 696e 652e 7374 6172 7473 7769  if line.startswi
+00048690: 7468 2827 4e6f 4465 7465 6374 696f 6e73  th('NoDetections
+000486a0: 5761 726e 696e 6727 293a 0a20 2020 2020  Warning'):.     
+000486b0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000486c0: 0a20 2020 200a 2020 2020 2020 2020 6966  .    .        if
+000486d0: 2027 6861 7361 7474 7228 7068 6f74 7574   'hasattr(photut
+000486e0: 696c 732e 6669 6e64 7374 6172 7327 2069  ils.findstars' i
+000486f0: 6e20 6c69 6e65 735b 692b 315d 3a0a 2020  n lines[i+1]:.  
+00048700: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00048710: 6627 4920 666f 756e 6420 7468 6520 7072  f'I found the pr
+00048720: 6f62 6c65 6d20 6f6e 206c 696e 6573 207b  oblem on lines {
+00048730: 697d 2d7b 692b 327d 3a20 2729 0a20 2020  i}-{i+2}: ').   
+00048740: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00048750: 2020 2020 2020 206d 7367 203d 2022 2222         msg = """
+00048760: 0a4c 696e 6573 207b 307d 2d7b 317d 2069  .Lines {0}-{1} i
+00048770: 6e20 7b32 7d20 696d 706f 7274 696e 6720  n {2} importing 
+00048780: 7068 6f74 7574 696c 7320 7765 7265 206e  photutils were n
+00048790: 6f74 2061 7320 6578 7065 6374 6564 2e20  ot as expected. 
+000487a0: 2049 2066 6f75 6e64 200a 0a7b 337d 0a0a   I found ..{3}..
+000487b0: 6275 7420 6578 7065 6374 6564 200a 0a20  but expected .. 
+000487c0: 2020 4e6f 4465 7465 6374 696f 6e73 5761    NoDetectionsWa
+000487d0: 726e 696e 6720 3d20 7068 6f74 7574 696c  rning = photutil
+000487e0: 732e 6669 6e64 7374 6172 732e 4e6f 4465  s.findstars.NoDe
+000487f0: 7465 6374 696f 6e73 5761 726e 696e 6720  tectionsWarning 
+00048800: 6966 205c 5c0a 2020 2020 2020 2020 2020  if \\.          
+00048810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048820: 2068 6173 6174 7472 2870 686f 7475 7469   hasattr(photuti
+00048830: 6c73 2e66 696e 6473 7461 7273 2c20 274e  ls.findstars, 'N
+00048840: 6f44 6574 6563 7469 6f6e 7357 6172 6e69  oDetectionsWarni
+00048850: 6e67 2729 2065 6c73 6520 5c5c 0a20 2020  ng') else \\.   
+00048860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048870: 2020 2020 2020 2020 7068 6f74 7574 696c          photutil
+00048880: 732e 7574 696c 732e 4e6f 4465 7465 6374  s.utils.NoDetect
+00048890: 696f 6e73 5761 726e 696e 670a 0a0a 2020  ionsWarning...  
+000488a0: 2020 2222 222e 666f 726d 6174 2869 2c20    """.format(i, 
+000488b0: 692b 322c 2074 6865 5f66 696c 652c 206c  i+2, the_file, l
+000488c0: 696e 6573 5b69 3a69 2b33 5d29 0a20 2020  ines[i:i+3]).   
+000488d0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+000488e0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000488f0: 6f72 286d 7367 290a 2020 2020 2020 2020  or(msg).        
+00048900: 0a20 2020 2020 2020 2062 6164 203d 205b  .        bad = [
+00048910: 2720 2020 272b 6c69 6e65 732e 706f 7028  '   '+lines.pop(
+00048920: 692b 322d 6a29 2066 6f72 206a 2069 6e20  i+2-j) for j in 
+00048930: 7261 6e67 6528 3329 5d0a 2020 2020 2020  range(3)].      
+00048940: 2020 7072 696e 7428 2727 2e6a 6f69 6e28    print(''.join(
+00048950: 6261 645b 3a3a 2d31 5d29 290a 0a20 2020  bad[::-1]))..   
+00048960: 2020 2020 2023 2049 6e73 6572 7420 7468       # Insert th
+00048970: 6520 6669 780a 2020 2020 2020 2020 6c69  e fix.        li
+00048980: 6e65 735b 695d 203d 2027 6672 6f6d 2070  nes[i] = 'from p
+00048990: 686f 7475 7469 6c73 2e75 7469 6c73 2e65  hotutils.utils.e
+000489a0: 7863 6570 7469 6f6e 7320 696d 706f 7274  xceptions import
+000489b0: 204e 6f44 6574 6563 7469 6f6e 7357 6172   NoDetectionsWar
+000489c0: 6e69 6e67 5c6e 5c6e 270a 2020 2020 2020  ning\n\n'.      
+000489d0: 2020 2320 5265 7772 6974 6520 7468 6520    # Rewrite the 
+000489e0: 6669 650a 2020 2020 2020 2020 7769 7468  fie.        with
+000489f0: 206f 7065 6e28 6627 7b73 6974 655f 7061   open(f'{site_pa
+00048a00: 636b 6167 6573 7d2f 2e2e 2f64 7269 7a7a  ckages}/../drizz
+00048a10: 6c65 7061 632f 6861 7075 7469 6c73 2f61  lepac/haputils/a
+00048a20: 6c69 676e 5f75 7469 6c73 2e70 7927 2c27  lign_utils.py','
+00048a30: 7727 2920 6173 2066 703a 0a20 2020 2020  w') as fp:.     
+00048a40: 2020 2020 2020 2066 702e 7772 6974 656c         fp.writel
+00048a50: 696e 6573 286c 696e 6573 290a 2020 2020  ines(lines).    
+00048a60: 0a20 2020 2020 2020 2070 7269 6e74 2866  .        print(f
+00048a70: 2750 6174 6368 2061 7070 6c69 6564 2074  'Patch applied t
+00048a80: 6f20 7b74 6865 5f66 696c 657d 2127 290a  o {the_file}!').
```

### Comparing `grizli-1.8.3/grizli/utils_c/disperse.c` & `grizli-1.8.4/grizli/utils_c/disperse.c`

 * *Files 2% similar despite different names*

```diff
@@ -1,27 +1,27 @@
-/* Generated by Cython 0.29.33 */
+/* Generated by Cython 0.29.34 */
 
 /* BEGIN: Cython Metadata
 {
     "distutils": {
         "define_macros": [
             [
                 "NPY_NO_DEPRECATED_API",
                 "NPY_1_7_API_VERSION"
             ]
         ],
         "depends": [
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
         ],
         "include_dirs": [
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include"
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include"
         ],
         "libraries": [
             "m"
         ],
         "name": "grizli.utils_c.disperse",
         "sources": [
             "grizli/utils_c/disperse.pyx"
@@ -36,16 +36,16 @@
 #endif /* PY_SSIZE_T_CLEAN */
 #include "Python.h"
 #ifndef Py_PYTHON_H
     #error Python headers needed to compile C extensions, please install development version of Python.
 #elif PY_VERSION_HEX < 0x02060000 || (0x03000000 <= PY_VERSION_HEX && PY_VERSION_HEX < 0x03030000)
     #error Cython requires Python 2.6+ or Python 3.3+.
 #else
-#define CYTHON_ABI "0_29_33"
-#define CYTHON_HEX_VERSION 0x001D21F0
+#define CYTHON_ABI "0_29_34"
+#define CYTHON_HEX_VERSION 0x001D22F0
 #define CYTHON_FUTURE_DIVISION 1
 #include <stddef.h>
 #ifndef offsetof
   #define offsetof(type, member) ( (size_t) & ((type*)0) -> member )
 #endif
 #if !defined(WIN32) && !defined(MS_WINDOWS)
   #ifndef __stdcall
@@ -230,15 +230,15 @@
   #elif !defined(CYTHON_USE_ASYNC_SLOTS)
     #define CYTHON_USE_ASYNC_SLOTS 1
   #endif
   #if PY_VERSION_HEX < 0x02070000
     #undef CYTHON_USE_PYLONG_INTERNALS
     #define CYTHON_USE_PYLONG_INTERNALS 0
   #elif !defined(CYTHON_USE_PYLONG_INTERNALS)
-    #define CYTHON_USE_PYLONG_INTERNALS 1
+    #define CYTHON_USE_PYLONG_INTERNALS (PY_VERSION_HEX < 0x030C00A5)
   #endif
   #ifndef CYTHON_USE_PYLIST_INTERNALS
     #define CYTHON_USE_PYLIST_INTERNALS 1
   #endif
   #ifndef CYTHON_USE_UNICODE_INTERNALS
     #define CYTHON_USE_UNICODE_INTERNALS 1
   #endif
@@ -269,15 +269,15 @@
   #ifndef CYTHON_PEP489_MULTI_PHASE_INIT
     #define CYTHON_PEP489_MULTI_PHASE_INIT (PY_VERSION_HEX >= 0x03050000)
   #endif
   #ifndef CYTHON_USE_TP_FINALIZE
     #define CYTHON_USE_TP_FINALIZE (PY_VERSION_HEX >= 0x030400a1)
   #endif
   #ifndef CYTHON_USE_DICT_VERSIONS
-    #define CYTHON_USE_DICT_VERSIONS (PY_VERSION_HEX >= 0x030600B1)
+    #define CYTHON_USE_DICT_VERSIONS ((PY_VERSION_HEX >= 0x030600B1) && (PY_VERSION_HEX < 0x030C00A5))
   #endif
   #if PY_VERSION_HEX >= 0x030B00A4
     #undef CYTHON_USE_EXC_INFO_STACK
     #define CYTHON_USE_EXC_INFO_STACK 0
   #elif !defined(CYTHON_USE_EXC_INFO_STACK)
     #define CYTHON_USE_EXC_INFO_STACK (PY_VERSION_HEX >= 0x030700A3)
   #endif
@@ -1051,195 +1051,195 @@
   char enc_type;
   char new_packmode;
   char enc_packmode;
   char is_valid_array;
 } __Pyx_BufFmt_Context;
 
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":690
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":690
  * # in Cython to enable them only on the right systems.
  * 
  * ctypedef npy_int8       int8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  */
 typedef npy_int8 __pyx_t_5numpy_int8_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":691
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":691
  * 
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t
  */
 typedef npy_int16 __pyx_t_5numpy_int16_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":692
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":692
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int64      int64_t
  * #ctypedef npy_int96      int96_t
  */
 typedef npy_int32 __pyx_t_5numpy_int32_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":693
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":693
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_int96      int96_t
  * #ctypedef npy_int128     int128_t
  */
 typedef npy_int64 __pyx_t_5numpy_int64_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":697
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":697
  * #ctypedef npy_int128     int128_t
  * 
  * ctypedef npy_uint8      uint8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  */
 typedef npy_uint8 __pyx_t_5numpy_uint8_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":698
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":698
  * 
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t
  */
 typedef npy_uint16 __pyx_t_5numpy_uint16_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":699
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":699
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint64     uint64_t
  * #ctypedef npy_uint96     uint96_t
  */
 typedef npy_uint32 __pyx_t_5numpy_uint32_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":700
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":700
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_uint96     uint96_t
  * #ctypedef npy_uint128    uint128_t
  */
 typedef npy_uint64 __pyx_t_5numpy_uint64_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":704
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":704
  * #ctypedef npy_uint128    uint128_t
  * 
  * ctypedef npy_float32    float32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_float64    float64_t
  * #ctypedef npy_float80    float80_t
  */
 typedef npy_float32 __pyx_t_5numpy_float32_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":705
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":705
  * 
  * ctypedef npy_float32    float32_t
  * ctypedef npy_float64    float64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_float80    float80_t
  * #ctypedef npy_float128   float128_t
  */
 typedef npy_float64 __pyx_t_5numpy_float64_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":714
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":714
  * # The int types are mapped a bit surprising --
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t
  */
 typedef npy_long __pyx_t_5numpy_int_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":715
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":715
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   longlong_t
  * 
  */
 typedef npy_longlong __pyx_t_5numpy_long_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":716
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":716
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_ulong      uint_t
  */
 typedef npy_longlong __pyx_t_5numpy_longlong_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":718
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":718
  * ctypedef npy_longlong   longlong_t
  * 
  * ctypedef npy_ulong      uint_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t
  */
 typedef npy_ulong __pyx_t_5numpy_uint_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":719
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":719
  * 
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulong_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":720
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":720
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_intp       intp_t
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulonglong_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":722
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":722
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  * ctypedef npy_intp       intp_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uintp      uintp_t
  * 
  */
 typedef npy_intp __pyx_t_5numpy_intp_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":723
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":723
  * 
  * ctypedef npy_intp       intp_t
  * ctypedef npy_uintp      uintp_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_double     float_t
  */
 typedef npy_uintp __pyx_t_5numpy_uintp_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":725
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":725
  * ctypedef npy_uintp      uintp_t
  * 
  * ctypedef npy_double     float_t             # <<<<<<<<<<<<<<
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t
  */
 typedef npy_double __pyx_t_5numpy_float_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":726
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":726
  * 
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longdouble longdouble_t
  * 
  */
 typedef npy_double __pyx_t_5numpy_double_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":727
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":727
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cfloat      cfloat_t
  */
 typedef npy_longdouble __pyx_t_5numpy_longdouble_t;
@@ -1320,42 +1320,42 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 
 /*--- Type declarations ---*/
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":729
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":729
  * ctypedef npy_longdouble longdouble_t
  * 
  * ctypedef npy_cfloat      cfloat_t             # <<<<<<<<<<<<<<
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t
  */
 typedef npy_cfloat __pyx_t_5numpy_cfloat_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":730
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":730
  * 
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t             # <<<<<<<<<<<<<<
  * ctypedef npy_clongdouble clongdouble_t
  * 
  */
 typedef npy_cdouble __pyx_t_5numpy_cdouble_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":731
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":731
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cdouble     complex_t
  */
 typedef npy_clongdouble __pyx_t_5numpy_clongdouble_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":733
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":733
  * ctypedef npy_clongdouble clongdouble_t
  * 
  * ctypedef npy_cdouble     complex_t             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  */
 typedef npy_cdouble __pyx_t_5numpy_complex_t;
@@ -1552,20 +1552,28 @@
 
 /* RaiseException.proto */
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
 
 /* TypeImport.proto */
 #ifndef __PYX_HAVE_RT_ImportType_proto
 #define __PYX_HAVE_RT_ImportType_proto
+#if __STDC_VERSION__ >= 201112L
+#include <stdalign.h>
+#endif
+#if __STDC_VERSION__ >= 201112L || __cplusplus >= 201103L
+#define __PYX_GET_STRUCT_ALIGNMENT(s) alignof(s)
+#else
+#define __PYX_GET_STRUCT_ALIGNMENT(s) sizeof(void*)
+#endif
 enum __Pyx_ImportType_CheckSize {
    __Pyx_ImportType_CheckSize_Error = 0,
    __Pyx_ImportType_CheckSize_Warn = 1,
    __Pyx_ImportType_CheckSize_Ignore = 2
 };
-static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, enum __Pyx_ImportType_CheckSize check_size);
+static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size);
 #endif
 
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* PyDictVersioning.proto */
 #if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
@@ -3490,15 +3498,15 @@
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ysens.rcbuffer->pybuffer);
   __pyx_L2:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":735
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -3507,29 +3515,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew1", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":736
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":736
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  *     return PyArray_MultiIterNew(1, <void*>a)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(1, ((void *)__pyx_v_a)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 736, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":735
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -3540,15 +3548,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":738
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -3557,29 +3565,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew2", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":739
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":739
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(2, ((void *)__pyx_v_a), ((void *)__pyx_v_b)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 739, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":738
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -3590,15 +3598,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":741
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -3607,29 +3615,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew3", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":742
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":742
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(3, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 742, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":741
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -3640,15 +3648,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":744
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -3657,29 +3665,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew4", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":745
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":745
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(4, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 745, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":744
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -3690,15 +3698,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":747
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -3707,29 +3715,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew5", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":748
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":748
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)             # <<<<<<<<<<<<<<
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(5, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d), ((void *)__pyx_v_e)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 748, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":747
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -3740,212 +3748,212 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":750
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyDataType_SHAPE(PyArray_Descr *__pyx_v_d) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("PyDataType_SHAPE", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":751
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   __pyx_t_1 = (PyDataType_HASSUBARRAY(__pyx_v_d) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":752
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":752
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape             # <<<<<<<<<<<<<<
  *     else:
  *         return ()
  */
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(((PyObject*)__pyx_v_d->subarray->shape));
     __pyx_r = ((PyObject*)__pyx_v_d->subarray->shape);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":751
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":754
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":754
  *         return <tuple>d.subarray.shape
  *     else:
  *         return ()             # <<<<<<<<<<<<<<
  * 
  * 
  */
   /*else*/ {
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(__pyx_empty_tuple);
     __pyx_r = __pyx_empty_tuple;
     goto __pyx_L0;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":750
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":929
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
 static CYTHON_INLINE void __pyx_f_5numpy_set_array_base(PyArrayObject *__pyx_v_arr, PyObject *__pyx_v_base) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("set_array_base", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":930
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":930
  * 
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!             # <<<<<<<<<<<<<<
  *     PyArray_SetBaseObject(arr, base)
  * 
  */
   Py_INCREF(__pyx_v_base);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":931
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":931
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object get_array_base(ndarray arr):
  */
   (void)(PyArray_SetBaseObject(__pyx_v_arr, __pyx_v_base));
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":929
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":933
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_get_array_base(PyArrayObject *__pyx_v_arr) {
   PyObject *__pyx_v_base;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("get_array_base", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":934
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":934
  * 
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)             # <<<<<<<<<<<<<<
  *     if base is NULL:
  *         return None
  */
   __pyx_v_base = PyArray_BASE(__pyx_v_arr);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":935
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   __pyx_t_1 = ((__pyx_v_base == NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":936
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":936
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  *         return None             # <<<<<<<<<<<<<<
  *     return <object>base
  * 
  */
     __Pyx_XDECREF(__pyx_r);
     __pyx_r = Py_None; __Pyx_INCREF(Py_None);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":935
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":937
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":937
  *     if base is NULL:
  *         return None
  *     return <object>base             # <<<<<<<<<<<<<<
  * 
  * # Versions of the import_* functions which are more suitable for
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(((PyObject *)__pyx_v_base));
   __pyx_r = ((PyObject *)__pyx_v_base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":933
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":941
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -3961,15 +3969,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_array", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":942
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
   {
@@ -3977,53 +3985,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":943
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":943
  * cdef inline int import_array() except -1:
  *     try:
  *         __pyx_import_array()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")
  */
       __pyx_t_4 = _import_array(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 943, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":942
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":944
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":944
  *     try:
  *         __pyx_import_array()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 944, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":945
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple_, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 945, __pyx_L5_except_error)
@@ -4031,30 +4039,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 945, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":942
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":941
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -4069,15 +4077,15 @@
   __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":947
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4093,15 +4101,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_umath", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":948
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -4109,53 +4117,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":949
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":949
  * cdef inline int import_umath() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 949, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":948
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":950
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":950
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 950, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":951
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 951, __pyx_L5_except_error)
@@ -4163,30 +4171,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 951, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":948
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":947
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4201,15 +4209,15 @@
   __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":953
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4225,15 +4233,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_ufunc", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":954
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -4241,53 +4249,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":955
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":955
  * cdef inline int import_ufunc() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 955, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":954
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":956
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":956
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 956, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":957
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":957
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef extern from *:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 957, __pyx_L5_except_error)
@@ -4295,30 +4303,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 957, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":954
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":953
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -4333,176 +4341,176 @@
   __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":967
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_timedelta64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_timedelta64_object", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":979
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":979
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyTimedeltaArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyTimedeltaArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":967
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":982
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_datetime64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_datetime64_object", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":994
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":994
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyDatetimeArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyDatetimeArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":982
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":997
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
 static CYTHON_INLINE npy_datetime __pyx_f_5numpy_get_datetime64_value(PyObject *__pyx_v_obj) {
   npy_datetime __pyx_r;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1004
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1004
  *     also needed.  That can be found using `get_datetime64_unit`.
  *     """
  *     return (<PyDatetimeScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyDatetimeScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":997
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
 static CYTHON_INLINE npy_timedelta __pyx_f_5numpy_get_timedelta64_value(PyObject *__pyx_v_obj) {
   npy_timedelta __pyx_r;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1011
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1011
  *     returns the int64 value underlying scalar numpy timedelta64 object
  *     """
  *     return (<PyTimedeltaScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyTimedeltaScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
 static CYTHON_INLINE NPY_DATETIMEUNIT __pyx_f_5numpy_get_datetime64_unit(PyObject *__pyx_v_obj) {
   NPY_DATETIMEUNIT __pyx_r;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1018
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1018
  *     returns the unit part of the dtype for a numpy datetime64 object.
  *     """
  *     return <NPY_DATETIMEUNIT>(<PyDatetimeScalarObject*>obj).obmeta.base             # <<<<<<<<<<<<<<
  */
   __pyx_r = ((NPY_DATETIMEUNIT)((PyDatetimeScalarObject *)__pyx_v_obj)->obmeta.base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -4617,26 +4625,26 @@
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_InitCachedConstants(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_InitCachedConstants", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":945
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
   __pyx_tuple_ = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple_)) __PYX_ERR(1, 945, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple_);
   __Pyx_GIVEREF(__pyx_tuple_);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":951
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
   __pyx_tuple__2 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(1, 951, __pyx_L1_error)
@@ -4739,52 +4747,67 @@
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_import_code", 0);
   /*--- Type import code ---*/
   __pyx_t_1 = PyImport_ImportModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_ptype_7cpython_4type_type = __Pyx_ImportType(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
   #if defined(PYPY_VERSION_NUM) && PYPY_VERSION_NUM < 0x050B0000
-  sizeof(PyTypeObject),
+  sizeof(PyTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyTypeObject),
   #else
-  sizeof(PyHeapTypeObject),
+  sizeof(PyHeapTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyHeapTypeObject),
   #endif
   __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_t_1 = PyImport_ImportModule("numpy"); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 200, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_5numpy_dtype = __Pyx_ImportType(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_dtype = __Pyx_ImportType(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __PYX_GET_STRUCT_ALIGNMENT(PyArray_Descr),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(1, 200, __pyx_L1_error)
-  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayIterObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(1, 223, __pyx_L1_error)
-  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayMultiIterObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(1, 227, __pyx_L1_error)
-  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(1, 239, __pyx_L1_error)
-  __pyx_ptype_5numpy_generic = __Pyx_ImportType(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_generic = __Pyx_ImportType(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_generic) __PYX_ERR(1, 771, __pyx_L1_error)
-  __pyx_ptype_5numpy_number = __Pyx_ImportType(__pyx_t_1, "numpy", "number", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_number = __Pyx_ImportType(__pyx_t_1, "numpy", "number", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_number) __PYX_ERR(1, 773, __pyx_L1_error)
-  __pyx_ptype_5numpy_integer = __Pyx_ImportType(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_integer = __Pyx_ImportType(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_integer) __PYX_ERR(1, 775, __pyx_L1_error)
-  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(1, 777, __pyx_L1_error)
-  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(1, 779, __pyx_L1_error)
-  __pyx_ptype_5numpy_inexact = __Pyx_ImportType(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_inexact = __Pyx_ImportType(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(1, 781, __pyx_L1_error)
-  __pyx_ptype_5numpy_floating = __Pyx_ImportType(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_floating = __Pyx_ImportType(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_floating) __PYX_ERR(1, 783, __pyx_L1_error)
-  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(1, 785, __pyx_L1_error)
-  __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(1, 787, __pyx_L1_error)
-  __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_character) __PYX_ERR(1, 789, __pyx_L1_error)
-  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __PYX_GET_STRUCT_ALIGNMENT(PyUFuncObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(1, 827, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_RefNannyFinishContext();
@@ -5092,15 +5115,15 @@
  * import numpy as np
  */
   __pyx_t_1 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_1) < 0) __PYX_ERR(0, 2, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -6230,70 +6253,88 @@
                             "BaseException");
             goto bad;
         }
         PyException_SetCause(value, fixed_cause);
     }
     PyErr_SetObject(type, value);
     if (tb) {
-#if CYTHON_COMPILING_IN_PYPY
-        PyObject *tmp_type, *tmp_value, *tmp_tb;
-        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
-        Py_INCREF(tb);
-        PyErr_Restore(tmp_type, tmp_value, tb);
-        Py_XDECREF(tmp_tb);
-#else
+#if CYTHON_FAST_THREAD_STATE
         PyThreadState *tstate = __Pyx_PyThreadState_Current;
         PyObject* tmp_tb = tstate->curexc_traceback;
         if (tb != tmp_tb) {
             Py_INCREF(tb);
             tstate->curexc_traceback = tb;
             Py_XDECREF(tmp_tb);
         }
+#else
+        PyObject *tmp_type, *tmp_value, *tmp_tb;
+        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
+        Py_INCREF(tb);
+        PyErr_Restore(tmp_type, tmp_value, tb);
+        Py_XDECREF(tmp_tb);
 #endif
     }
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
 
 /* TypeImport */
   #ifndef __PYX_HAVE_RT_ImportType
 #define __PYX_HAVE_RT_ImportType
 static PyTypeObject *__Pyx_ImportType(PyObject *module, const char *module_name, const char *class_name,
-    size_t size, enum __Pyx_ImportType_CheckSize check_size)
+    size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size)
 {
     PyObject *result = 0;
     char warning[200];
     Py_ssize_t basicsize;
+    Py_ssize_t itemsize;
 #ifdef Py_LIMITED_API
     PyObject *py_basicsize;
+    PyObject *py_itemsize;
 #endif
     result = PyObject_GetAttrString(module, class_name);
     if (!result)
         goto bad;
     if (!PyType_Check(result)) {
         PyErr_Format(PyExc_TypeError,
             "%.200s.%.200s is not a type object",
             module_name, class_name);
         goto bad;
     }
 #ifndef Py_LIMITED_API
     basicsize = ((PyTypeObject *)result)->tp_basicsize;
+    itemsize = ((PyTypeObject *)result)->tp_itemsize;
 #else
     py_basicsize = PyObject_GetAttrString(result, "__basicsize__");
     if (!py_basicsize)
         goto bad;
     basicsize = PyLong_AsSsize_t(py_basicsize);
     Py_DECREF(py_basicsize);
     py_basicsize = 0;
     if (basicsize == (Py_ssize_t)-1 && PyErr_Occurred())
         goto bad;
+    py_itemsize = PyObject_GetAttrString(result, "__itemsize__");
+    if (!py_itemsize)
+        goto bad;
+    itemsize = PyLong_AsSsize_t(py_itemsize);
+    Py_DECREF(py_itemsize);
+    py_itemsize = 0;
+    if (itemsize == (Py_ssize_t)-1 && PyErr_Occurred())
+        goto bad;
 #endif
-    if ((size_t)basicsize < size) {
+    if (itemsize) {
+        if (size % alignment) {
+            alignment = size % alignment;
+        }
+        if (itemsize < (Py_ssize_t)alignment)
+            itemsize = (Py_ssize_t)alignment;
+    }
+    if ((size_t)(basicsize + itemsize) < size) {
         PyErr_Format(PyExc_ValueError,
             "%.200s.%.200s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         goto bad;
     }
     if (check_size == __Pyx_ImportType_CheckSize_Error && (size_t)basicsize != size) {
```

### Comparing `grizli-1.8.3/grizli/utils_c/disperse.pyx` & `grizli-1.8.4/grizli/utils_c/disperse.pyx`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli/utils_c/interp.c` & `grizli-1.8.4/grizli/utils_c/interp.c`

 * *Files 2% similar despite different names*

```diff
@@ -1,27 +1,27 @@
-/* Generated by Cython 0.29.33 */
+/* Generated by Cython 0.29.34 */
 
 /* BEGIN: Cython Metadata
 {
     "distutils": {
         "define_macros": [
             [
                 "NPY_NO_DEPRECATED_API",
                 "NPY_1_7_API_VERSION"
             ]
         ],
         "depends": [
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/arrayobject.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/arrayscalars.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/ndarrayobject.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/ndarraytypes.h",
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include/numpy/ufuncobject.h"
         ],
         "include_dirs": [
-            "/tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/core/include"
+            "/tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/core/include"
         ],
         "libraries": [
             "m"
         ],
         "name": "grizli.utils_c.interp",
         "sources": [
             "grizli/utils_c/interp.pyx"
@@ -36,16 +36,16 @@
 #endif /* PY_SSIZE_T_CLEAN */
 #include "Python.h"
 #ifndef Py_PYTHON_H
     #error Python headers needed to compile C extensions, please install development version of Python.
 #elif PY_VERSION_HEX < 0x02060000 || (0x03000000 <= PY_VERSION_HEX && PY_VERSION_HEX < 0x03030000)
     #error Cython requires Python 2.6+ or Python 3.3+.
 #else
-#define CYTHON_ABI "0_29_33"
-#define CYTHON_HEX_VERSION 0x001D21F0
+#define CYTHON_ABI "0_29_34"
+#define CYTHON_HEX_VERSION 0x001D22F0
 #define CYTHON_FUTURE_DIVISION 1
 #include <stddef.h>
 #ifndef offsetof
   #define offsetof(type, member) ( (size_t) & ((type*)0) -> member )
 #endif
 #if !defined(WIN32) && !defined(MS_WINDOWS)
   #ifndef __stdcall
@@ -230,15 +230,15 @@
   #elif !defined(CYTHON_USE_ASYNC_SLOTS)
     #define CYTHON_USE_ASYNC_SLOTS 1
   #endif
   #if PY_VERSION_HEX < 0x02070000
     #undef CYTHON_USE_PYLONG_INTERNALS
     #define CYTHON_USE_PYLONG_INTERNALS 0
   #elif !defined(CYTHON_USE_PYLONG_INTERNALS)
-    #define CYTHON_USE_PYLONG_INTERNALS 1
+    #define CYTHON_USE_PYLONG_INTERNALS (PY_VERSION_HEX < 0x030C00A5)
   #endif
   #ifndef CYTHON_USE_PYLIST_INTERNALS
     #define CYTHON_USE_PYLIST_INTERNALS 1
   #endif
   #ifndef CYTHON_USE_UNICODE_INTERNALS
     #define CYTHON_USE_UNICODE_INTERNALS 1
   #endif
@@ -269,15 +269,15 @@
   #ifndef CYTHON_PEP489_MULTI_PHASE_INIT
     #define CYTHON_PEP489_MULTI_PHASE_INIT (PY_VERSION_HEX >= 0x03050000)
   #endif
   #ifndef CYTHON_USE_TP_FINALIZE
     #define CYTHON_USE_TP_FINALIZE (PY_VERSION_HEX >= 0x030400a1)
   #endif
   #ifndef CYTHON_USE_DICT_VERSIONS
-    #define CYTHON_USE_DICT_VERSIONS (PY_VERSION_HEX >= 0x030600B1)
+    #define CYTHON_USE_DICT_VERSIONS ((PY_VERSION_HEX >= 0x030600B1) && (PY_VERSION_HEX < 0x030C00A5))
   #endif
   #if PY_VERSION_HEX >= 0x030B00A4
     #undef CYTHON_USE_EXC_INFO_STACK
     #define CYTHON_USE_EXC_INFO_STACK 0
   #elif !defined(CYTHON_USE_EXC_INFO_STACK)
     #define CYTHON_USE_EXC_INFO_STACK (PY_VERSION_HEX >= 0x030700A3)
   #endif
@@ -1051,195 +1051,195 @@
   char enc_type;
   char new_packmode;
   char enc_packmode;
   char is_valid_array;
 } __Pyx_BufFmt_Context;
 
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":690
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":690
  * # in Cython to enable them only on the right systems.
  * 
  * ctypedef npy_int8       int8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  */
 typedef npy_int8 __pyx_t_5numpy_int8_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":691
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":691
  * 
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t
  */
 typedef npy_int16 __pyx_t_5numpy_int16_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":692
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":692
  * ctypedef npy_int8       int8_t
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_int64      int64_t
  * #ctypedef npy_int96      int96_t
  */
 typedef npy_int32 __pyx_t_5numpy_int32_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":693
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":693
  * ctypedef npy_int16      int16_t
  * ctypedef npy_int32      int32_t
  * ctypedef npy_int64      int64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_int96      int96_t
  * #ctypedef npy_int128     int128_t
  */
 typedef npy_int64 __pyx_t_5numpy_int64_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":697
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":697
  * #ctypedef npy_int128     int128_t
  * 
  * ctypedef npy_uint8      uint8_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  */
 typedef npy_uint8 __pyx_t_5numpy_uint8_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":698
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":698
  * 
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t
  */
 typedef npy_uint16 __pyx_t_5numpy_uint16_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":699
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":699
  * ctypedef npy_uint8      uint8_t
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uint64     uint64_t
  * #ctypedef npy_uint96     uint96_t
  */
 typedef npy_uint32 __pyx_t_5numpy_uint32_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":700
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":700
  * ctypedef npy_uint16     uint16_t
  * ctypedef npy_uint32     uint32_t
  * ctypedef npy_uint64     uint64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_uint96     uint96_t
  * #ctypedef npy_uint128    uint128_t
  */
 typedef npy_uint64 __pyx_t_5numpy_uint64_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":704
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":704
  * #ctypedef npy_uint128    uint128_t
  * 
  * ctypedef npy_float32    float32_t             # <<<<<<<<<<<<<<
  * ctypedef npy_float64    float64_t
  * #ctypedef npy_float80    float80_t
  */
 typedef npy_float32 __pyx_t_5numpy_float32_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":705
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":705
  * 
  * ctypedef npy_float32    float32_t
  * ctypedef npy_float64    float64_t             # <<<<<<<<<<<<<<
  * #ctypedef npy_float80    float80_t
  * #ctypedef npy_float128   float128_t
  */
 typedef npy_float64 __pyx_t_5numpy_float64_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":714
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":714
  * # The int types are mapped a bit surprising --
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t
  */
 typedef npy_long __pyx_t_5numpy_int_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":715
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":715
  * # numpy.int corresponds to 'l' and numpy.long to 'q'
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longlong   longlong_t
  * 
  */
 typedef npy_longlong __pyx_t_5numpy_long_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":716
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":716
  * ctypedef npy_long       int_t
  * ctypedef npy_longlong   long_t
  * ctypedef npy_longlong   longlong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_ulong      uint_t
  */
 typedef npy_longlong __pyx_t_5numpy_longlong_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":718
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":718
  * ctypedef npy_longlong   longlong_t
  * 
  * ctypedef npy_ulong      uint_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t
  */
 typedef npy_ulong __pyx_t_5numpy_uint_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":719
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":719
  * 
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t             # <<<<<<<<<<<<<<
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulong_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":720
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":720
  * ctypedef npy_ulong      uint_t
  * ctypedef npy_ulonglong  ulong_t
  * ctypedef npy_ulonglong  ulonglong_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_intp       intp_t
  */
 typedef npy_ulonglong __pyx_t_5numpy_ulonglong_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":722
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":722
  * ctypedef npy_ulonglong  ulonglong_t
  * 
  * ctypedef npy_intp       intp_t             # <<<<<<<<<<<<<<
  * ctypedef npy_uintp      uintp_t
  * 
  */
 typedef npy_intp __pyx_t_5numpy_intp_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":723
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":723
  * 
  * ctypedef npy_intp       intp_t
  * ctypedef npy_uintp      uintp_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_double     float_t
  */
 typedef npy_uintp __pyx_t_5numpy_uintp_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":725
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":725
  * ctypedef npy_uintp      uintp_t
  * 
  * ctypedef npy_double     float_t             # <<<<<<<<<<<<<<
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t
  */
 typedef npy_double __pyx_t_5numpy_float_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":726
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":726
  * 
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t             # <<<<<<<<<<<<<<
  * ctypedef npy_longdouble longdouble_t
  * 
  */
 typedef npy_double __pyx_t_5numpy_double_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":727
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":727
  * ctypedef npy_double     float_t
  * ctypedef npy_double     double_t
  * ctypedef npy_longdouble longdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cfloat      cfloat_t
  */
 typedef npy_longdouble __pyx_t_5numpy_longdouble_t;
@@ -1293,42 +1293,42 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 
 /*--- Type declarations ---*/
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":729
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":729
  * ctypedef npy_longdouble longdouble_t
  * 
  * ctypedef npy_cfloat      cfloat_t             # <<<<<<<<<<<<<<
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t
  */
 typedef npy_cfloat __pyx_t_5numpy_cfloat_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":730
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":730
  * 
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t             # <<<<<<<<<<<<<<
  * ctypedef npy_clongdouble clongdouble_t
  * 
  */
 typedef npy_cdouble __pyx_t_5numpy_cdouble_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":731
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":731
  * ctypedef npy_cfloat      cfloat_t
  * ctypedef npy_cdouble     cdouble_t
  * ctypedef npy_clongdouble clongdouble_t             # <<<<<<<<<<<<<<
  * 
  * ctypedef npy_cdouble     complex_t
  */
 typedef npy_clongdouble __pyx_t_5numpy_clongdouble_t;
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":733
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":733
  * ctypedef npy_clongdouble clongdouble_t
  * 
  * ctypedef npy_cdouble     complex_t             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  */
 typedef npy_cdouble __pyx_t_5numpy_complex_t;
@@ -1700,20 +1700,28 @@
 
 /* RaiseException.proto */
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
 
 /* TypeImport.proto */
 #ifndef __PYX_HAVE_RT_ImportType_proto
 #define __PYX_HAVE_RT_ImportType_proto
+#if __STDC_VERSION__ >= 201112L
+#include <stdalign.h>
+#endif
+#if __STDC_VERSION__ >= 201112L || __cplusplus >= 201103L
+#define __PYX_GET_STRUCT_ALIGNMENT(s) alignof(s)
+#else
+#define __PYX_GET_STRUCT_ALIGNMENT(s) sizeof(void*)
+#endif
 enum __Pyx_ImportType_CheckSize {
    __Pyx_ImportType_CheckSize_Error = 0,
    __Pyx_ImportType_CheckSize_Warn = 1,
    __Pyx_ImportType_CheckSize_Ignore = 2
 };
-static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, enum __Pyx_ImportType_CheckSize check_size);
+static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size);
 #endif
 
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* CLineInTraceback.proto */
 #ifdef CYTHON_CLINE_IN_TRACEBACK
@@ -9098,15 +9106,15 @@
   __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_zgrid.rcbuffer->pybuffer);
   __pyx_L2:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":735
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -9115,29 +9123,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew1", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":736
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":736
  * 
  * cdef inline object PyArray_MultiIterNew1(a):
  *     return PyArray_MultiIterNew(1, <void*>a)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(1, ((void *)__pyx_v_a)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 736, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":735
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":735
  * ctypedef npy_cdouble     complex_t
  * 
  * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  */
 
@@ -9148,15 +9156,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":738
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -9165,29 +9173,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew2", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":739
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":739
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(2, ((void *)__pyx_v_a), ((void *)__pyx_v_b)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 739, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":738
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":738
  *     return PyArray_MultiIterNew(1, <void*>a)
  * 
  * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  */
 
@@ -9198,15 +9206,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":741
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -9215,29 +9223,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew3", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":742
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":742
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(3, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 742, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":741
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":741
  *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
  * 
  * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  */
 
@@ -9248,15 +9256,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":744
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -9265,29 +9273,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew4", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":745
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":745
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(4, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 745, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":744
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":744
  *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
  * 
  * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  */
 
@@ -9298,15 +9306,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":747
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -9315,29 +9323,29 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("PyArray_MultiIterNew5", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":748
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":748
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)             # <<<<<<<<<<<<<<
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  */
   __Pyx_XDECREF(__pyx_r);
   __pyx_t_1 = PyArray_MultiIterNew(5, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d), ((void *)__pyx_v_e)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 748, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":747
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":747
  *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
  * 
  * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  */
 
@@ -9348,212 +9356,212 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":750
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyDataType_SHAPE(PyArray_Descr *__pyx_v_d) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("PyDataType_SHAPE", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":751
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   __pyx_t_1 = (PyDataType_HASSUBARRAY(__pyx_v_d) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":752
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":752
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape             # <<<<<<<<<<<<<<
  *     else:
  *         return ()
  */
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(((PyObject*)__pyx_v_d->subarray->shape));
     __pyx_r = ((PyObject*)__pyx_v_d->subarray->shape);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":751
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":751
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):
  *     if PyDataType_HASSUBARRAY(d):             # <<<<<<<<<<<<<<
  *         return <tuple>d.subarray.shape
  *     else:
  */
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":754
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":754
  *         return <tuple>d.subarray.shape
  *     else:
  *         return ()             # <<<<<<<<<<<<<<
  * 
  * 
  */
   /*else*/ {
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(__pyx_empty_tuple);
     __pyx_r = __pyx_empty_tuple;
     goto __pyx_L0;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":750
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":750
  *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
  * 
  * cdef inline tuple PyDataType_SHAPE(dtype d):             # <<<<<<<<<<<<<<
  *     if PyDataType_HASSUBARRAY(d):
  *         return <tuple>d.subarray.shape
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":929
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
 static CYTHON_INLINE void __pyx_f_5numpy_set_array_base(PyArrayObject *__pyx_v_arr, PyObject *__pyx_v_base) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("set_array_base", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":930
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":930
  * 
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!             # <<<<<<<<<<<<<<
  *     PyArray_SetBaseObject(arr, base)
  * 
  */
   Py_INCREF(__pyx_v_base);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":931
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":931
  * cdef inline void set_array_base(ndarray arr, object base):
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)             # <<<<<<<<<<<<<<
  * 
  * cdef inline object get_array_base(ndarray arr):
  */
   (void)(PyArray_SetBaseObject(__pyx_v_arr, __pyx_v_base));
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":929
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":929
  *     int _import_umath() except -1
  * 
  * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
  *     Py_INCREF(base) # important to do this before stealing the reference below!
  *     PyArray_SetBaseObject(arr, base)
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":933
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
 static CYTHON_INLINE PyObject *__pyx_f_5numpy_get_array_base(PyArrayObject *__pyx_v_arr) {
   PyObject *__pyx_v_base;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("get_array_base", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":934
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":934
  * 
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)             # <<<<<<<<<<<<<<
  *     if base is NULL:
  *         return None
  */
   __pyx_v_base = PyArray_BASE(__pyx_v_arr);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":935
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   __pyx_t_1 = ((__pyx_v_base == NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":936
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":936
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  *         return None             # <<<<<<<<<<<<<<
  *     return <object>base
  * 
  */
     __Pyx_XDECREF(__pyx_r);
     __pyx_r = Py_None; __Pyx_INCREF(Py_None);
     goto __pyx_L0;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":935
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":935
  * cdef inline object get_array_base(ndarray arr):
  *     base = PyArray_BASE(arr)
  *     if base is NULL:             # <<<<<<<<<<<<<<
  *         return None
  *     return <object>base
  */
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":937
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":937
  *     if base is NULL:
  *         return None
  *     return <object>base             # <<<<<<<<<<<<<<
  * 
  * # Versions of the import_* functions which are more suitable for
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(((PyObject *)__pyx_v_base));
   __pyx_r = ((PyObject *)__pyx_v_base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":933
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":933
  *     PyArray_SetBaseObject(arr, base)
  * 
  * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
  *     base = PyArray_BASE(arr)
  *     if base is NULL:
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":941
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -9569,15 +9577,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_array", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":942
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
   {
@@ -9585,53 +9593,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":943
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":943
  * cdef inline int import_array() except -1:
  *     try:
  *         __pyx_import_array()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")
  */
       __pyx_t_4 = _import_array(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 943, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":942
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":944
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":944
  *     try:
  *         __pyx_import_array()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 944, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":945
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__3, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 945, __pyx_L5_except_error)
@@ -9639,30 +9647,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 945, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":942
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":942
  * # Cython code.
  * cdef inline int import_array() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         __pyx_import_array()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":941
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":941
  * # Versions of the import_* functions which are more suitable for
  * # Cython code.
  * cdef inline int import_array() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         __pyx_import_array()
  */
 
@@ -9677,15 +9685,15 @@
   __Pyx_AddTraceback("numpy.import_array", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":947
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9701,15 +9709,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_umath", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":948
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -9717,53 +9725,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":949
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":949
  * cdef inline int import_umath() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 949, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":948
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":950
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":950
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 950, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":951
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__4, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 951, __pyx_L5_except_error)
@@ -9771,30 +9779,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 951, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":948
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":948
  * 
  * cdef inline int import_umath() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":947
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":947
  *         raise ImportError("numpy.core.multiarray failed to import")
  * 
  * cdef inline int import_umath() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9809,15 +9817,15 @@
   __Pyx_AddTraceback("numpy.import_umath", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":953
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9833,15 +9841,15 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_lineno = 0;
   const char *__pyx_filename = NULL;
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("import_ufunc", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":954
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
   {
@@ -9849,53 +9857,53 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_1, &__pyx_t_2, &__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_1);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     /*try:*/ {
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":955
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":955
  * cdef inline int import_ufunc() except -1:
  *     try:
  *         _import_umath()             # <<<<<<<<<<<<<<
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")
  */
       __pyx_t_4 = _import_umath(); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 955, __pyx_L3_error)
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":954
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     }
     __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
     goto __pyx_L8_try_end;
     __pyx_L3_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":956
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":956
  *     try:
  *         _import_umath()
  *     except Exception:             # <<<<<<<<<<<<<<
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  */
     __pyx_t_4 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
     if (__pyx_t_4) {
       __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
       if (__Pyx_GetException(&__pyx_t_5, &__pyx_t_6, &__pyx_t_7) < 0) __PYX_ERR(1, 956, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_GOTREF(__pyx_t_7);
 
-      /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":957
+      /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":957
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef extern from *:
  */
       __pyx_t_8 = __Pyx_PyObject_Call(__pyx_builtin_ImportError, __pyx_tuple__4, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 957, __pyx_L5_except_error)
@@ -9903,30 +9911,30 @@
       __Pyx_Raise(__pyx_t_8, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __PYX_ERR(1, 957, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":954
+    /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":954
  * 
  * cdef inline int import_ufunc() except -1:
  *     try:             # <<<<<<<<<<<<<<
  *         _import_umath()
  *     except Exception:
  */
     __Pyx_XGIVEREF(__pyx_t_1);
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_ExceptionReset(__pyx_t_1, __pyx_t_2, __pyx_t_3);
     goto __pyx_L1_error;
     __pyx_L8_try_end:;
   }
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":953
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":953
  *         raise ImportError("numpy.core.umath failed to import")
  * 
  * cdef inline int import_ufunc() except -1:             # <<<<<<<<<<<<<<
  *     try:
  *         _import_umath()
  */
 
@@ -9941,176 +9949,176 @@
   __Pyx_AddTraceback("numpy.import_ufunc", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":967
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_timedelta64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_timedelta64_object", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":979
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":979
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyTimedeltaArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyTimedeltaArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":967
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":967
  * 
  * 
  * cdef inline bint is_timedelta64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.timedelta64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":982
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
 static CYTHON_INLINE int __pyx_f_5numpy_is_datetime64_object(PyObject *__pyx_v_obj) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("is_datetime64_object", 0);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":994
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":994
  *     bool
  *     """
  *     return PyObject_TypeCheck(obj, &PyDatetimeArrType_Type)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = PyObject_TypeCheck(__pyx_v_obj, (&PyDatetimeArrType_Type));
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":982
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":982
  * 
  * 
  * cdef inline bint is_datetime64_object(object obj):             # <<<<<<<<<<<<<<
  *     """
  *     Cython equivalent of `isinstance(obj, np.datetime64)`
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":997
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
 static CYTHON_INLINE npy_datetime __pyx_f_5numpy_get_datetime64_value(PyObject *__pyx_v_obj) {
   npy_datetime __pyx_r;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1004
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1004
  *     also needed.  That can be found using `get_datetime64_unit`.
  *     """
  *     return (<PyDatetimeScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyDatetimeScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":997
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":997
  * 
  * 
  * cdef inline npy_datetime get_datetime64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy datetime64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
 static CYTHON_INLINE npy_timedelta __pyx_f_5numpy_get_timedelta64_value(PyObject *__pyx_v_obj) {
   npy_timedelta __pyx_r;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1011
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1011
  *     returns the int64 value underlying scalar numpy timedelta64 object
  *     """
  *     return (<PyTimedeltaScalarObject*>obj).obval             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((PyTimedeltaScalarObject *)__pyx_v_obj)->obval;
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1007
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1007
  * 
  * 
  * cdef inline npy_timedelta get_timedelta64_value(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the int64 value underlying scalar numpy timedelta64 object
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+/* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
 static CYTHON_INLINE NPY_DATETIMEUNIT __pyx_f_5numpy_get_datetime64_unit(PyObject *__pyx_v_obj) {
   NPY_DATETIMEUNIT __pyx_r;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1018
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1018
  *     returns the unit part of the dtype for a numpy datetime64 object.
  *     """
  *     return <NPY_DATETIMEUNIT>(<PyDatetimeScalarObject*>obj).obmeta.base             # <<<<<<<<<<<<<<
  */
   __pyx_r = ((NPY_DATETIMEUNIT)((PyDatetimeScalarObject *)__pyx_v_obj)->obmeta.base);
   goto __pyx_L0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -10324,26 +10332,26 @@
   __pyx_slice_ = PySlice_New(__pyx_int_1, Py_None, Py_None); if (unlikely(!__pyx_slice_)) __PYX_ERR(0, 121, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_slice_);
   __Pyx_GIVEREF(__pyx_slice_);
   __pyx_slice__2 = PySlice_New(Py_None, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__2)) __PYX_ERR(0, 121, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_slice__2);
   __Pyx_GIVEREF(__pyx_slice__2);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":945
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":945
  *         __pyx_import_array()
  *     except Exception:
  *         raise ImportError("numpy.core.multiarray failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_umath() except -1:
  */
   __pyx_tuple__3 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_multiarray_failed_to); if (unlikely(!__pyx_tuple__3)) __PYX_ERR(1, 945, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__3);
   __Pyx_GIVEREF(__pyx_tuple__3);
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":951
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":951
  *         _import_umath()
  *     except Exception:
  *         raise ImportError("numpy.core.umath failed to import")             # <<<<<<<<<<<<<<
  * 
  * cdef inline int import_ufunc() except -1:
  */
   __pyx_tuple__4 = PyTuple_Pack(1, __pyx_kp_u_numpy_core_umath_failed_to_impor); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(1, 951, __pyx_L1_error)
@@ -10560,52 +10568,67 @@
   int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_import_code", 0);
   /*--- Type import code ---*/
   __pyx_t_1 = PyImport_ImportModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_ptype_7cpython_4type_type = __Pyx_ImportType(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
   #if defined(PYPY_VERSION_NUM) && PYPY_VERSION_NUM < 0x050B0000
-  sizeof(PyTypeObject),
+  sizeof(PyTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyTypeObject),
   #else
-  sizeof(PyHeapTypeObject),
+  sizeof(PyHeapTypeObject), __PYX_GET_STRUCT_ALIGNMENT(PyHeapTypeObject),
   #endif
   __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(2, 9, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_t_1 = PyImport_ImportModule("numpy"); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 200, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_5numpy_dtype = __Pyx_ImportType(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_dtype = __Pyx_ImportType(__pyx_t_1, "numpy", "dtype", sizeof(PyArray_Descr), __PYX_GET_STRUCT_ALIGNMENT(PyArray_Descr),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_dtype) __PYX_ERR(1, 200, __pyx_L1_error)
-  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType(__pyx_t_1, "numpy", "flatiter", sizeof(PyArrayIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayIterObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_flatiter) __PYX_ERR(1, 223, __pyx_L1_error)
-  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType(__pyx_t_1, "numpy", "broadcast", sizeof(PyArrayMultiIterObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayMultiIterObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_broadcast) __PYX_ERR(1, 227, __pyx_L1_error)
-  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType(__pyx_t_1, "numpy", "ndarray", sizeof(PyArrayObject), __PYX_GET_STRUCT_ALIGNMENT(PyArrayObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_ndarray) __PYX_ERR(1, 239, __pyx_L1_error)
-  __pyx_ptype_5numpy_generic = __Pyx_ImportType(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_generic = __Pyx_ImportType(__pyx_t_1, "numpy", "generic", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_generic) __PYX_ERR(1, 771, __pyx_L1_error)
-  __pyx_ptype_5numpy_number = __Pyx_ImportType(__pyx_t_1, "numpy", "number", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_number = __Pyx_ImportType(__pyx_t_1, "numpy", "number", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_number) __PYX_ERR(1, 773, __pyx_L1_error)
-  __pyx_ptype_5numpy_integer = __Pyx_ImportType(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_integer = __Pyx_ImportType(__pyx_t_1, "numpy", "integer", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_integer) __PYX_ERR(1, 775, __pyx_L1_error)
-  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_signedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "signedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_signedinteger) __PYX_ERR(1, 777, __pyx_L1_error)
-  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_unsignedinteger = __Pyx_ImportType(__pyx_t_1, "numpy", "unsignedinteger", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_unsignedinteger) __PYX_ERR(1, 779, __pyx_L1_error)
-  __pyx_ptype_5numpy_inexact = __Pyx_ImportType(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_inexact = __Pyx_ImportType(__pyx_t_1, "numpy", "inexact", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_inexact) __PYX_ERR(1, 781, __pyx_L1_error)
-  __pyx_ptype_5numpy_floating = __Pyx_ImportType(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_floating = __Pyx_ImportType(__pyx_t_1, "numpy", "floating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_floating) __PYX_ERR(1, 783, __pyx_L1_error)
-  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_complexfloating = __Pyx_ImportType(__pyx_t_1, "numpy", "complexfloating", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_complexfloating) __PYX_ERR(1, 785, __pyx_L1_error)
-  __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_flexible = __Pyx_ImportType(__pyx_t_1, "numpy", "flexible", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_flexible) __PYX_ERR(1, 787, __pyx_L1_error)
-  __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __Pyx_ImportType_CheckSize_Warn);
+  __pyx_ptype_5numpy_character = __Pyx_ImportType(__pyx_t_1, "numpy", "character", sizeof(PyObject), __PYX_GET_STRUCT_ALIGNMENT(PyObject),
+  __Pyx_ImportType_CheckSize_Warn);
    if (!__pyx_ptype_5numpy_character) __PYX_ERR(1, 789, __pyx_L1_error)
-  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __Pyx_ImportType_CheckSize_Ignore);
+  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType(__pyx_t_1, "numpy", "ufunc", sizeof(PyUFuncObject), __PYX_GET_STRUCT_ALIGNMENT(PyUFuncObject),
+  __Pyx_ImportType_CheckSize_Ignore);
    if (!__pyx_ptype_5numpy_ufunc) __PYX_ERR(1, 827, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_RefNannyFinishContext();
@@ -11007,15 +11030,15 @@
  */
   __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_t_2, __pyx_kp_u_run_nmf_line_454, __pyx_kp_u_run_nmf_flux_variance_templates) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "../../../../../tmp/build-env-ziyf3ebm/lib/python3.10/site-packages/numpy/__init__.pxd":1014
+  /* "../../../../../tmp/build-env-48vasx7n/lib/python3.10/site-packages/numpy/__init__.pxd":1014
  * 
  * 
  * cdef inline NPY_DATETIMEUNIT get_datetime64_unit(object obj) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     returns the unit part of the dtype for a numpy datetime64 object.
  */
 
@@ -12875,70 +12898,88 @@
                             "BaseException");
             goto bad;
         }
         PyException_SetCause(value, fixed_cause);
     }
     PyErr_SetObject(type, value);
     if (tb) {
-#if CYTHON_COMPILING_IN_PYPY
-        PyObject *tmp_type, *tmp_value, *tmp_tb;
-        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
-        Py_INCREF(tb);
-        PyErr_Restore(tmp_type, tmp_value, tb);
-        Py_XDECREF(tmp_tb);
-#else
+#if CYTHON_FAST_THREAD_STATE
         PyThreadState *tstate = __Pyx_PyThreadState_Current;
         PyObject* tmp_tb = tstate->curexc_traceback;
         if (tb != tmp_tb) {
             Py_INCREF(tb);
             tstate->curexc_traceback = tb;
             Py_XDECREF(tmp_tb);
         }
+#else
+        PyObject *tmp_type, *tmp_value, *tmp_tb;
+        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
+        Py_INCREF(tb);
+        PyErr_Restore(tmp_type, tmp_value, tb);
+        Py_XDECREF(tmp_tb);
 #endif
     }
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
 
 /* TypeImport */
     #ifndef __PYX_HAVE_RT_ImportType
 #define __PYX_HAVE_RT_ImportType
 static PyTypeObject *__Pyx_ImportType(PyObject *module, const char *module_name, const char *class_name,
-    size_t size, enum __Pyx_ImportType_CheckSize check_size)
+    size_t size, size_t alignment, enum __Pyx_ImportType_CheckSize check_size)
 {
     PyObject *result = 0;
     char warning[200];
     Py_ssize_t basicsize;
+    Py_ssize_t itemsize;
 #ifdef Py_LIMITED_API
     PyObject *py_basicsize;
+    PyObject *py_itemsize;
 #endif
     result = PyObject_GetAttrString(module, class_name);
     if (!result)
         goto bad;
     if (!PyType_Check(result)) {
         PyErr_Format(PyExc_TypeError,
             "%.200s.%.200s is not a type object",
             module_name, class_name);
         goto bad;
     }
 #ifndef Py_LIMITED_API
     basicsize = ((PyTypeObject *)result)->tp_basicsize;
+    itemsize = ((PyTypeObject *)result)->tp_itemsize;
 #else
     py_basicsize = PyObject_GetAttrString(result, "__basicsize__");
     if (!py_basicsize)
         goto bad;
     basicsize = PyLong_AsSsize_t(py_basicsize);
     Py_DECREF(py_basicsize);
     py_basicsize = 0;
     if (basicsize == (Py_ssize_t)-1 && PyErr_Occurred())
         goto bad;
+    py_itemsize = PyObject_GetAttrString(result, "__itemsize__");
+    if (!py_itemsize)
+        goto bad;
+    itemsize = PyLong_AsSsize_t(py_itemsize);
+    Py_DECREF(py_itemsize);
+    py_itemsize = 0;
+    if (itemsize == (Py_ssize_t)-1 && PyErr_Occurred())
+        goto bad;
 #endif
-    if ((size_t)basicsize < size) {
+    if (itemsize) {
+        if (size % alignment) {
+            alignment = size % alignment;
+        }
+        if (itemsize < (Py_ssize_t)alignment)
+            itemsize = (Py_ssize_t)alignment;
+    }
+    if ((size_t)(basicsize + itemsize) < size) {
         PyErr_Format(PyExc_ValueError,
             "%.200s.%.200s size changed, may indicate binary incompatibility. "
             "Expected %zd from C header, got %zd from PyObject",
             module_name, class_name, size, basicsize);
         goto bad;
     }
     if (check_size == __Pyx_ImportType_CheckSize_Error && (size_t)basicsize != size) {
```

### Comparing `grizli-1.8.3/grizli/utils_c/interp.pyx` & `grizli-1.8.4/grizli/utils_c/interp.pyx`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/grizli.egg-info/PKG-INFO` & `grizli-1.8.4/grizli.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: grizli
-Version: 1.8.3
+Version: 1.8.4
 Summary: Grism redshift and line analysis software
 Home-page: https://github.com/gbrammer/grizli
 Author: G. Brammer
 Author-email: gbrammer@gmail.com
 License: MIT
 Project-URL: Documentation, https://grizli.readthedocs.io/
 Project-URL: Source, https://github.com/gbrammer/grizli
```

### Comparing `grizli-1.8.3/grizli.egg-info/SOURCES.txt` & `grizli-1.8.4/grizli.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/setup.cfg` & `grizli-1.8.4/setup.cfg`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/setup.py` & `grizli-1.8.4/setup.py`

 * *Files identical despite different names*

### Comparing `grizli-1.8.3/test_pipeline_hst.py` & `grizli-1.8.4/test_pipeline_hst.py`

 * *Files identical despite different names*

